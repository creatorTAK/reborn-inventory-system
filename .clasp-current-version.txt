@798 - デプロイ完了: feat(CHAT-007): Phase 1 - 個別チャット + LINE風アイコン表示 + メニュー整理

**デプロイ内容:**
- @797: 個別チャット（ダイレクトメッセージ）機能実装
- @798: メニュー整理（開発・デバッグ用項目削除）
- @799: LINE風アイコン表示機能実装

**デプロイ日時:** 2025-11-10
**デプロイID:** AKfycbx6ybbRLDqKQJ8IR-NPoVP8981Gtozzz0N3880XanEGRS4--iZtset8PFrVcD_u9YAHMA

---

@799 - feat(CHAT): LINE風アイコン表示機能実装

**実装内容:**
1. **menu.js (getUserListForUI関数)**
   - userIconUrl取得を追加（列9 = インデックス8）
   - FCM通知登録シートからアイコンURLを返すように修正

2. **chat_ui_firestore.html (LINE風アイコン表示)**
   - **CSS追加**:
     - .user-icon: 円形アイコン（32px）
     - .user-icon-placeholder: アイコンなし時のプレースホルダー
   
   - **JavaScript追加**:
     - usersCache: ユーザー一覧キャッシュ（アイコン表示用）
     - getUserIconUrl(): ユーザー名からアイコンURL取得
     - 初期化時にgetUserListForUI()呼び出してキャッシュ
   
   - **メッセージ表示**:
     - 送信者名の横にアイコン表示（LINE風）
     - 画像読み込みエラー時はプレースホルダーに自動切り替え
     - プレースホルダーはユーザー名の最初の1文字

3. **chat_rooms_list.html (個別チャット作成UI)**
   - **CSS追加**:
     - .user-icon img: 画像表示用スタイル
     - .user-icon-placeholder: プレースホルダー用スタイル（40px）
   
   - **loadUserList関数修正**:
     - userIconUrlがあれば画像表示
     - なければプレースホルダー表示（ユーザー名の1文字目）
     - 画像読み込みエラー時の自動フォールバック

**動作:**
- チャットメッセージの横にユーザーアイコンが円形で表示される（LINE風）
- 個別チャット作成時のユーザー一覧にもアイコン表示
- アイコン未設定ユーザーはプレースホルダー表示
- 基本設定で設定したアイコンが自動的に反映される

**次のステップ:**
- デプロイ後、基本設定でアイコンを設定して動作確認

---

@798 - feat(MENU): メニュー整理（開発・デバッグ用項目削除）

**削除内容:**
- **🧪 Webhookテスト** メニュー全体（10項目削除）
  - Script Properties確認
  - Webhook送信テスト
  - HMAC署名テスト
  - 署名デバッグ送信
  - 署名検証デバッグ（詳細）
  - シークレットキー確認
  - 固定ケース署名比較
  - テスト結果シートを開く

- **⚠️ 在庫アラート** メニュー全体（2項目削除）
  - ▶️ 在庫アラート実行（手動）
  - 🔓 在庫アラート設定の保護を解除

- **⚙️ 設定管理** から以下を削除（1項目）
  - 🔓 シート保護解除（デバッグ用）

**残ったメニュー（4つ、27項目）:**
1. 📝 商品管理（3項目）
2. 🔍 フィルタ・検索（8項目）
3. 🗂️ マスタ管理（3項目）
4. ⚙️ 設定管理（11項目）

**注意事項:**
- 在庫アラート設定は「⚙️ 設定管理 > ⚠️ 在庫アラート設定」から利用可能
- シート保護設定・確認機能は残っている
- 開発・デバッグ機能はGASエディタから直接実行可能

---

@797 - feat(CHAT-007): 個別チャット（ダイレクトメッセージ）機能実装

**実装内容:**
- **chat_rooms_list.html**
  1. **UI追加**
     - 「個別チャット作成」ボタン追加（緑色、👤アイコン）
     - ユーザー選択モーダル追加
     - ユーザーリストのスタイル追加
  
  2. **ロジック実装**
     - `createDirectChat()`: モーダルを開く + ユーザー一覧読み込み
     - `closeDirectChatModal()`: モーダルを閉じる
     - `loadUserList()`: GAS APIから全ユーザー取得、自分を除外して表示
     - `generateDirectRoomId()`: アルファベット順のroomId生成（dm_[user1]_[user2]）
     - `selectUserForDirectChat()`: ユーザー選択 → 既存ルームチェック → 新規作成 or 開く
     - `createDirectChatRoom()`: FirestoreにsetDoc()でカスタムIDルーム作成
  
  3. **Firebase SDKインポート**
     - `setDoc` を追加（カスタムドキュメントID作成用）

**roomId生成ルール:**
- 形式: `dm_[user1]_[user2]`
- アルファベット順でソート（例: `dm_オーナー_山田太郎`）
- 重複防止: 既存roomIdをチェック、存在すれば開くだけ

**期待される動作:**
1. 「個別チャット作成」ボタンをクリック
2. ユーザー一覧から相手を選択
3. 既存DMルームがあれば開く、なければ新規作成
4. チャット画面に自動遷移
5. 通知・バッジは既存インフラで自動動作

**次のステップ:**
1. デプロイ（clasp push + deploy）
2. 動作確認（3台の端末でテスト）
3. Issue CHAT-007 Phase 1完了マーク

---

@796 - fix(担当者名表示): PropertiesServiceフォールバック削除

**問題の背景:**
- オーナー端末をタスクキル/リロードすると担当者名が「田中花子」（3台目の外注端末）に変わる
- 初期設定時に一瞬前の端末の担当者名が表示される
- 全端末で同じGoogleアカウントを使用

**根本原因:**
- PropertiesService.getUserProperties()は同じGoogleアカウントで共有される
- getOperatorNameByTokenAPI()のフォールバックでPropertiesServiceから読み込み
- 最後に設定した担当者名（田中花子）が全端末で取得される

**修正内容:**
- **packaging_materials_manager.js:703-820 (getOperatorNameByTokenAPI関数)**
  - 全てのPropertiesServiceフォールバックを削除
  - FCMトークンまたはメールアドレスで見つからない場合は空文字を返す
  - success: false を返すことで、PWA側で適切に処理される

**期待される動作:**
- 各端末で正しい担当者名が表示される
- タスクキル/リロード後も担当者名が変わらない
- 初期設定時の一瞬表示される前の名前も消える

**次のステップ:**
1. 各端末で担当者名表示確認
2. タスクキル/リロード後の安定性確認
3. Phase 3通知テスト（10回以上連続）

---

@795 - fix(PROD-001): ハイブリッドアプローチ Phase 1（担当者フィールド活用）

**問題の背景:**
- スタッフ端末での商品登録時、通知送信者名が常に「オーナー」と判定
- Session.getEffectiveUser()はPWA実行時に常にGASオーナーを返す
- @792, @793, @794の3回の失敗を経て、第三者意見（ChatGPT）も参考に新アプローチを採用

**Phase 1実装内容（今回）:**
- **product.js:368-403 (sendProductRegistrationWebhook関数)**
  - 優先順位1: form['担当者']フィールドから取得（既存フィールド活用）
    - "スタッフの山田太郎" → "山田太郎"（プレフィックス除去）
  - 優先順位2: Session.getEffectiveUser()（フォールバック）
  - GAS側のみの変更で、PWA側は変更なし（安全性重視）

**Phase 2計画（将来）:**
- PWAのlocalStorageから`__reborn_registrant_email_v1`を送信
- 優先順位1: localStorage → 優先順位2: 担当者フィールド → 優先順位3: Session

**期待される動作:**
- スタッフ端末で商品登録 → 送信者名="山田太郎"
- オーナー端末のみ通知受信（スタッフは除外される）
- チャット機能に影響なし（GAS側のみの軽微な変更）

**次のステップ:**
1. スタッフ端末で商品登録テスト
2. オーナー端末の通知確認
3. チャット機能の動作確認

---

@794 - ROLLBACK: チャット通知・バッジ不具合のため緊急ロールバック

**ロールバック理由:**
- @794デプロイ後、チャット通知・バッジがおかしくなった
- 商品登録通知も依然として解決せず（オーナーのまま）
- チャット機能への影響を最小化するため緊急ロールバック

**ロールバックした変更:**
- sp_scripts.html: collect()関数のPWAユーザー情報追加を削除
- product.js: 3箇所の修正を元に戻す
  - saveProduct関数
  - recordUserActivity関数
  - sendProductRegistrationWebhook関数

**次のステップ:**
1. チャット通知・バッジの動作確認
2. PROD-001は別アプローチで再検討

---

@793 - fix(PROD-001): 商品登録通知のユーザー名取得を修正（第2回・失敗）

**@792の問題:**
- `form['登録者']`を参照していたが、form dataに該当フィールドが存在しない
- '登録者'はシートにのみ保存され、form objectには含まれていない
- 結果：@792でも依然としてSession.getEffectiveUser()にフォールバックし、常に「オーナー」と判定

**修正内容（失敗）:**
- getProductByManagementNumber()でシートから'登録者'を読み取る
- しかし、シートに保存される時点で既にオーナーのemailになっていた
- recordUserActivity()がSession.getEffectiveUser()を使用するため

**失敗理由:**
- シート読み取り時点で既に間違ったデータ（オーナーemail）が保存されている
- @794で試みたPWA側からの情報送信もチャット機能に悪影響を与えた

---

@792 - fix(PROD-001): 商品登録通知がオーナーに届かない問題を修正（第1回・失敗）

**根本原因（誤認）:**
- PWAから商品登録時、`Session.getEffectiveUser()`は常にGASオーナーを返す
- そのため`userName`が常に「オーナー」になり、通知対象から除外されていた
- 結果：オーナーに通知が届かない

**修正内容（失敗）:**
- **product.js:373-391 (sendProductRegistrationWebhook関数)**
  - userName取得ロジックを変更
  - 優先順位1: formデータの`登録者`フィールド（PWA登録時）← **存在しないフィールド**
  - 優先順位2: `Session.getEffectiveUser()`（GASエディタ直接実行時）
  - 結果：formに'登録者'が存在せず、常にSession経由でオーナーと判定

**失敗理由:**
- formデータには'登録者'フィールドが含まれていない
- '登録者'はシートにのみ保存される
- @793で正しく修正

---

@791 - feat(INV-006): 24時間制限削除（即時アラート対応）

**ビジネス要件:**
- 24時間制限により資材が不足する可能性がある
- 閾値に対して24時間後に通知が来て発注すると遅れる
- 即時通知が適切なタイミング

**修正内容:**
- **inventory_alert_manager.js:374-378 (shouldSendAlert関数)**
  - 24時間制限チェックを削除
  - 常に`return true;`に変更
  - 在庫が閾値以下の間は毎回通知を送信
  - 在庫が回復（> 閾値）すれば自動的に通知停止

**動作:**
- 在庫 <= 閾値 → 毎回アラート送信
- 在庫 > 閾値 → 自動的に通知停止
- テスト時の通知停止 → 「通知有効」チェックボックスをOFFにする

**次のステップ:**
1. E2セル（最終通知日時）を削除
2. 在庫アラート手動実行テスト
3. 全3バッジポイント動作確認

---

@787 - fix(INV-006): チェックボックス判定修正（通知有効フラグ）

**根本原因:**
- getInventoryAlertSettings関数で`data[i][3] === true`の厳密比較を使用
- Googleスプレッドシートのチェックボックスは`TRUE`（文字列）または`true`（boolean）になる
- 文字列"TRUE"と`true`が一致せず、通知有効フラグが常に`false`と判定されていた
- 結果：アラート対象が0件になっていた

**修正内容:**
- **inventory_alert_manager.js:316 (getInventoryAlertSettings関数)**
  - チェックボックス判定を修正
  - `data[i][3] === true || data[i][3] === 'TRUE' || data[i][3] === 'true'`
  - 文字列とbooleanの両方に対応
  - デバッグログ追加（元の値と型を出力）

**修正後の動作:**
- チェックボックスがONの場合、確実に`notificationEnabled = true`と判定
- アラート対象が正しく検出される

**次のステップ:**
在庫アラート手動実行テスト（再実行）

---

@786 - feat(INV-006): 在庫アラート専用チャットルーム対応（Webhook送信追加）

**実装内容:**
在庫アラート専用ルーム「⚠️ 在庫アラート」を新規作成し、Webhook経由でFirestoreにメッセージ投稿。

**修正箇所:**
1. **setup_chat_rooms.js:75-123**
   - 在庫アラートルーム（room_inventory_alert）の設定を追加
   - Firestoreコンソールでの手動作成手順を記載

2. **inventory_alert_manager.js:386-475 (sendInventoryAlertNotifications関数)**
   - Webhook送信処理を追加（product.jsと同じパターン）
   - オーナー権限のユーザーのみをtargetUsersに設定
   - notificationDataに`roomId: 'room_inventory_alert'`を指定
   - Webhook送信 → Firestoreの「在庫アラート」ルームにメッセージ投稿
   - FCM通知送信（オーナーのみ）

**通知フロー:**
```
在庫アラート検出
  ↓
Webhook送信 → Cloudflare Worker → Firestore「在庫アラート」ルームにメッセージ投稿
  ↓
FCMプッシュ通知送信（オーナーのみ）
  ↓
全3バッジポイント更新（アプリアイコン・ヘッダー・ルーム）
```

**通知対象:**
- オーナーのみ（Webhook、FCM両方）
- 「在庫アラート」ルーム専用（「システム通知」とは分離）

**次のステップ:**
1. Firestoreに「在庫アラート」ルーム（room_inventory_alert）を手動作成
2. 在庫アラート手動実行テスト
3. 全3バッジポイント動作確認

---
