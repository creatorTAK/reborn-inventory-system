@817 - feat(ARCH-001): Phase 1.5 Firestore移行 - マイグレーションスクリプト + API実装

**実装内容:**
- **migration_users_to_firestore.js**: ユーザーデータマイグレーションスクリプト
  - FCM通知登録シートから全ユーザー取得
  - 重複排除（最新データ優先）
  - Firestore REST APIで書き込み（users コレクション）
  - 成功/失敗カウント付き実行ログ

- **docs/js/firestore-api.js**: Firestore API wrapper
  - getUserListFromFirestore(): Firestore直接読み込み
  - getUserList(): 5分キャッシュ付き読み込み
  - getUserListHybrid(): Firestore失敗時GAS APIフォールバック
  - clearUserListCache(): キャッシュクリア
  - 期待パフォーマンス: GAS 3800ms → Firestore 50-300ms (10-70倍高速化)

- **docs/test-api.html**: Firestoreテスト追加
  - Test 4: Firestore直接読み込み
  - Test 5: Firestoreキャッシュ付き
  - Test 6: ハイブリッドモード
  - Test 7: キャッシュ効果確認
  - パフォーマンス比較レポート機能

**技術詳細:**
- Firebase Project: reborn-chat
- Collection: users
- Document ID: userName
- Cache: 5分（CACHE_DURATION = 300000ms）
- Firestore Rules: 既存のchat用ルールを使用

**次のステップ:**
1. GASエディタで `migrateUsersToFirestore()` 実行（OAuth承認必要）
2. Firestoreコンソールで users コレクション確認
3. PWA側デプロイ（git push）
4. test-api.html でパフォーマンステスト

**期待される改善:**
- 初回読み込み: 3800ms → 50-300ms (約19倍高速化)
- キャッシュヒット: 3800ms → <5ms (約7600倍高速化)
- ユーザー体験の劇的な改善

**デプロイ日時:** 2025-11-11
**デプロイID:** (次回デプロイ時に更新)

---

@816 - fix(ARCH-001): getUserListForUI最適化試行（効果なし - GAS起動時間が支配的）

**修正内容:**
- Logger.log()呼び出しを削除
- getDataRange()に戻す（個別getRange()は逆効果）
- コード整理・最適化

**結果:**
- 実行時間: 依然として3800ms前後
- 根本原因: GAS Web App起動時間（2.4秒）が支配的
- 結論: コード最適化では改善不可能

**次のアプローチ:**
- Firestore移行を推奨（ChatGPT専門家の提案）
- 期待改善: 3800ms → 50-300ms (10-70倍高速化)

---

@815 - fix(ARCH-001): getUserListForUI最適化試行（失敗 - さらに遅くなった）

**修正内容:**
- getDataRange()から個別getRange()に変更
- 各列を個別に取得（6回のAPI呼び出し）

**結果:**
- 実行時間: 3800ms → 4000ms以上に悪化
- 原因: Spreadsheet APIコール数が増加（1回 → 6回）
- 各API呼び出しに200-500msのオーバーヘッド

**教訓:**
- GASでは最小限のAPI呼び出しが重要
- 個別取得より一括取得の方が高速

---

@814 - fix(CHAT): 戻るボタン修正（parentOrigin取得ロジック修正）

**修正内容:**
- **chat_ui_firestore.html**:
  - **parentOriginデフォルト値追加**: URLパラメータから取得できない場合、安全なデフォルト値（Cloudflare Pages本番ドメイン）を使用
  - **詳細デバッグログ**: URL情報、hostname、originを全て出力
  - **バージョン表示**: v814

**問題の原因:**
- @813では `window.location.origin` をフォールバックとして使用していたが、これはGASのドメイン（`script.googleusercontent.com`）になってしまう
- 結果、遷移先URLが `https://n-fwcq5ggef...script.googleusercontent.com/?menu=chat_rooms` となり、404エラーが発生

**解決策:**
- 明示的に `https://reborn-inventory-system.pages.dev` をデフォルト値として設定
- これにより、URLパラメータから取得できない場合でも確実にPWAに戻れる

@813 - fix(CHAT): 戻るボタン修正（window.top.location方式）- GAS内部スクリプトpostMessageブロック対策

**修正内容:**
- **chat_ui_firestore.html**:
  - **window.top.location.href方式に変更**: GAS内部スクリプト（3016996794-mae_html_user_bin_i18n_mae_html_user__ja.js）がpostMessageをブロックするため
  - **parentOrigin自動推測**: URLパラメータから取得、なければホスト名から判断
  - **チャット一覧URLに直接遷移**: `${parentOrigin}/?menu=chat_rooms`
  - **エラーハンドリング**: top.location失敗時はhistory.back()にフォールバック
  - **バージョン表示**: v813

**技術的根拠:**
- コンソールログ分析により、postMessage失敗の原因はSafari PWAではなく**GAS内部フレームワーク**によるブロックと判明
- `dropping postMessage.. was from unexpected window`エラーは`3016996794-mae_html_user_bin_i18n_mae_html_user__ja.js:218`から発生
- postMessageはGASプラットフォームレベルで遮断されているため、代替手段として`window.top.location`ナビゲーションを採用
- トレードオフ: 全ページリロード（UX低下）だが、確実に動作する

**デプロイ日時:** 2025-11-11
**デプロイID:** AKfycbx6ybbRLDqKQJ8IR-NPoVP8981Gtozzz0N3880XanEGRS4--iZtset8PFrVcD_u9YAHMA

---
