<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
body { font-family: system-ui, sans-serif; padding: 12px; font-size: 13px; }
label { display: block; margin: 6px 0 2px; font-size: 12px; color: #374151; }
input, select, textarea { width: 100%; box-sizing: border-box; padding: 6px 8px; font-size: 13px; border: 1px solid #d1d5db; border-radius: 4px; }
input:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
.group { border: 1px solid #e5e7eb; background: #f8fafc; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
.group-title { font-size: 14px; font-weight: 700; color: #1f2937; margin-bottom: 8px; border-bottom: 1px solid #e5e7eb; padding-bottom: 4px; }
.row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.actions { margin-top: 16px; display: flex; gap: 8px; }
.btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; }
.btn-primary { background: #3b82f6; color: white; }
.btn-primary:hover { background: #2563eb; }
.btn-secondary { background: #6b7280; color: white; }
.btn-secondary:hover { background: #4b5563; }
.btn-success { background: #10b981; color: white; }
.btn-success:hover { background: #059669; }
.msg { margin-top: 12px; padding: 8px 12px; border-radius: 4px; font-size: 12px; white-space: pre-wrap; }
.msg.success { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
.msg.error { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
.product-info { background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 6px; padding: 10px; margin: 8px 0; }
.product-info .title { font-weight: 600; color: #0c4a6e; margin-bottom: 4px; }
.product-info .detail { font-size: 12px; color: #0369a1; margin: 2px 0; }
.search-section { background: #fefce8; border: 1px solid #eab308; }
.sale-section { background: #fef2f2; border: 1px solid #ef4444; }
.shipping-section { background: #f0fdf4; border: 1px solid #22c55e; }
</style>
</head>
<body>

<!-- 商品検索セクション -->
<div class="group search-section">
  <div class="group-title">🔍 商品検索</div>
  <label>管理番号</label>
  <input id="searchMgmtNo" type="text" placeholder="AA-1001" style="text-transform: uppercase;">
  <div class="actions">
    <button class="btn btn-primary" onclick="searchProduct()">検索・ジャンプ</button>
    <button class="btn btn-secondary" onclick="clearSearch()">クリア</button>
  </div>
  
  <!-- 商品情報表示エリア -->
  <div id="productInfoArea" style="display: none;">
    <div class="product-info">
      <div class="title" id="productTitle">商品情報</div>
      <div class="detail" id="productDetails"></div>
    </div>
  </div>
</div>

<!-- 販売情報セクション -->
<div class="group sale-section">
  <div class="group-title">💰 販売情報</div>
  
  <div class="row">
    <div>
      <label>販売日</label>
      <input id="saleDate" type="date">
    </div>
    <div>
      <label>販売先</label>
      <select id="saleDestination">
        <option value="">--選択してください--</option>
        <option value="メルカリ">メルカリ</option>
        <option value="Yahoo!オークション">Yahoo!オークション</option>
        <option value="Yahoo!フリマ">Yahoo!フリマ</option>
        <option value="ラクマ">ラクマ</option>
        <option value="その他">その他</option>
      </select>
    </div>
  </div>
  
  <label>販売金額</label>
  <input id="saleAmount" type="number" min="0" step="1" placeholder="0">
  
  <div class="actions">
    <button class="btn btn-success" onclick="updateSaleInfo()">販売情報更新</button>
  </div>
</div>

<!-- 発送・梱包情報セクション -->
<div class="group shipping-section">
  <div class="group-title">📦 発送・梱包情報</div>
  
  <div class="row">
    <div>
      <label>発送方法</label>
      <select id="shippingMethod">
        <option value="">--選択してください--</option>
        <option value="ゆうゆうメルカリ便">ゆうゆうメルカリ便</option>
        <option value="らくらくメルカリ便">らくらくメルカリ便</option>
        <option value="普通郵便">普通郵便</option>
        <option value="レターパック">レターパック</option>
        <option value="宅急便">宅急便</option>
        <option value="その他">その他</option>
      </select>
    </div>
    <div>
      <label>梱包資材</label>
      <select id="packagingMaterial">
        <option value="">--選択してください--</option>
        <option value="封筒">封筒</option>
        <option value="宅急便コンパクト">宅急便コンパクト</option>
        <option value="60サイズ段ボール">60サイズ段ボール</option>
        <option value="80サイズ段ボール">80サイズ段ボール</option>
        <option value="100サイズ段ボール">100サイズ段ボール</option>
        <option value="その他">その他</option>
      </select>
    </div>
  </div>
  
  <div class="row">
    <div>
      <label>梱包資材費</label>
      <input id="packagingCost" type="number" min="0" step="1" placeholder="0">
    </div>
    <div>
      <label>送料</label>
      <input id="shippingCost" type="number" min="0" step="1" placeholder="0">
    </div>
  </div>
  
  <div class="actions">
    <button class="btn btn-success" onclick="updateShippingInfo()">発送情報更新</button>
  </div>
</div>

<!-- ステータス更新セクション -->
<div class="group">
  <div class="group-title">📋 ステータス管理</div>
  
  <label>ステータス</label>
  <select id="productStatus">
    <option value="">--選択してください--</option>
    <option value="仕入完了">仕入完了</option>
    <option value="出品準備中">出品準備中</option>
    <option value="出品中">出品中</option>
    <option value="販売完了">販売完了</option>
    <option value="発送完了">発送完了</option>
    <option value="取引完了">取引完了</option>
  </select>
  
  <div class="actions">
    <button class="btn btn-secondary" onclick="updateStatus()">ステータス更新</button>
  </div>
</div>

<!-- メッセージ表示エリア -->
<div id="msg" class="msg" style="display: none;"></div>

<script>
let currentMgmtNo = '';

// 商品検索
function searchProduct() {
  const mgmtNo = document.getElementById('searchMgmtNo').value.trim();
  if (!mgmtNo) {
    showMessage('管理番号を入力してください', 'error');
    return;
  }
  
  showMessage('検索中...', '');
  
  // ジャンプ実行
  google.script.run
    .withSuccessHandler(handleSearchResult)
    .withFailureHandler(handleError)
    .jumpToRowByCode(mgmtNo);
  
  // 商品情報取得
  google.script.run
    .withSuccessHandler(displayProductInfo)
    .withFailureHandler(() => {})
    .getProductInfo(mgmtNo);
    
  currentMgmtNo = mgmtNo.toUpperCase();
}

function handleSearchResult(result) {
  if (result && result.startsWith('OK:')) {
    showMessage(result, 'success');
  } else {
    showMessage(result || 'エラーが発生しました', 'error');
  }
}

function displayProductInfo(result) {
  const infoArea = document.getElementById('productInfoArea');
  const title = document.getElementById('productTitle');
  const details = document.getElementById('productDetails');
  
  if (result.success && result.data) {
    const data = result.data;
    title.textContent = `${data.managementNumber} - ${data.brand || ''} ${data.itemName || ''}`;
    
    const detailText = [
      `分類: ${data.category || ''}`,
      `サイズ: ${data.size || ''}`,
      `状態: ${data.condition || ''}`,
      `仕入額: ¥${data.purchaseAmount || 0}`,
      `出品額: ¥${data.listingAmount || 0}`,
      `販売額: ¥${data.saleAmount || '未販売'}`,
      `利益: ¥${data.profit || 0}`
    ].join('\n');
    
    details.textContent = detailText;
    infoArea.style.display = 'block';
    
    // フォームに既存データを反映
    if (data.saleDate) document.getElementById('saleDate').value = data.saleDate;
    if (data.saleDestination) document.getElementById('saleDestination').value = data.saleDestination;
    if (data.saleAmount) document.getElementById('saleAmount').value = data.saleAmount;
    if (data.shippingMethod) document.getElementById('shippingMethod').value = data.shippingMethod;
    if (data.packagingMaterial) document.getElementById('packagingMaterial').value = data.packagingMaterial;
    if (data.packagingCost) document.getElementById('packagingCost').value = data.packagingCost;
    if (data.shippingCost) document.getElementById('shippingCost').value = data.shippingCost;
    
  } else {
    infoArea.style.display = 'none';
  }
}

function clearSearch() {
  document.getElementById('searchMgmtNo').value = '';
  document.getElementById('productInfoArea').style.display = 'none';
  currentMgmtNo = '';
  clearAllFields();
  showMessage('', '');
}

function clearAllFields() {
  ['saleDate', 'saleDestination', 'saleAmount', 'shippingMethod', 'packagingMaterial', 'packagingCost', 'shippingCost', 'productStatus']
    .forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
}

// 販売情報更新
function updateSaleInfo() {
  if (!currentMgmtNo) {
    showMessage('先に商品を検索してください', 'error');
    return;
  }
  
  const saleData = {
    saleDate: document.getElementById('saleDate').value,
    saleDestination: document.getElementById('saleDestination').value,
    saleAmount: document.getElementById('saleAmount').value
  };
  
  if (!saleData.saleAmount) {
    showMessage('販売金額を入力してください', 'error');
    return;
  }
  
  showMessage('更新中...', '');
  
  google.script.run
    .withSuccessHandler(handleUpdateResult)
    .withFailureHandler(handleError)
    .updateSaleInfo(currentMgmtNo, saleData);
}

// 発送情報更新
function updateShippingInfo() {
  if (!currentMgmtNo) {
    showMessage('先に商品を検索してください', 'error');
    return;
  }
  
  const shippingData = {
    shippingMethod: document.getElementById('shippingMethod').value,
    packagingMaterial: document.getElementById('packagingMaterial').value,
    packagingCost: document.getElementById('packagingCost').value,
    shippingCost: document.getElementById('shippingCost').value
  };
  
  showMessage('更新中...', '');
  
  google.script.run
    .withSuccessHandler(handleUpdateResult)
    .withFailureHandler(handleError)
    .updateShippingInfo(currentMgmtNo, shippingData);
}

// ステータス更新
function updateStatus() {
  if (!currentMgmtNo) {
    showMessage('先に商品を検索してください', 'error');
    return;
  }
  
  const status = document.getElementById('productStatus').value;
  if (!status) {
    showMessage('ステータスを選択してください', 'error');
    return;
  }
  
  showMessage('更新中...', '');
  
  google.script.run
    .withSuccessHandler(handleUpdateResult)
    .withFailureHandler(handleError)
    .updateProductStatus(currentMgmtNo, status);
}

function handleUpdateResult(result) {
  if (result && result.startsWith('OK:')) {
    showMessage(result, 'success');
    // 商品情報を再取得して表示更新
    if (currentMgmtNo) {
      google.script.run
        .withSuccessHandler(displayProductInfo)
        .withFailureHandler(() => {})
        .getProductInfo(currentMgmtNo);
    }
  } else {
    showMessage(result || '更新に失敗しました', 'error');
  }
}

function handleError(error) {
  showMessage(`エラー: ${error.message || error}`, 'error');
}

function showMessage(text, type = '') {
  const msgEl = document.getElementById('msg');
  msgEl.textContent = text;
  msgEl.className = 'msg';
  
  if (type === 'success') msgEl.classList.add('success');
  if (type === 'error') msgEl.classList.add('error');
  
  msgEl.style.display = text ? 'block' : 'none';
}

// 初期化
document.addEventListener('DOMContentLoaded', function() {
  // 今日の日付をデフォルト設定
  document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
});
</script>

</body>
</html>