<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>動的ブロックビルダー - テスト</title>

  <!-- Bootstrap (オプション) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .test-section h2 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #212529;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 8px;
    }
    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }
    .action-buttons button {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-primary {
      background: #3b82f6;
      color: white;
    }
    .btn-primary:hover {
      background: #2563eb;
    }
    .btn-secondary {
      background: #6b7280;
      color: white;
    }
    .btn-secondary:hover {
      background: #4b5563;
    }
    .btn-success {
      background: #10b981;
      color: white;
    }
    .btn-success:hover {
      background: #059669;
    }
    .output {
      background: #f3f4f6;
      padding: 12px;
      border-radius: 4px;
      margin-top: 12px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 style="margin-bottom: 24px;">動的ブロックビルダー - テスト</h1>

    <!-- テスト1: シンプルなテキスト入力 -->
    <div class="test-section">
      <h2>テスト1: シンプルなテキスト入力</h2>
      <div id="taskList"></div>
      <div class="action-buttons">
        <button class="btn-primary" onclick="taskBuilder.addItem()">+ タスクを追加</button>
        <button class="btn-secondary" onclick="showTaskData()">データを表示</button>
        <button class="btn-success" onclick="setTaskData()">サンプルデータをセット</button>
      </div>
      <div id="taskOutput" class="output" style="display: none;"></div>
    </div>

    <!-- テスト2: セレクトボックスと数値入力 -->
    <div class="test-section">
      <h2>テスト2: セレクトボックスと数値入力</h2>
      <div id="productList"></div>
      <div class="action-buttons">
        <button class="btn-primary" onclick="productBuilder.addItem()">+ 商品を追加</button>
        <button class="btn-secondary" onclick="showProductData()">データを表示</button>
        <button class="btn-success" onclick="setProductData()">サンプルデータをセット</button>
      </div>
      <div id="productOutput" class="output" style="display: none;"></div>
    </div>

    <!-- テスト3: カスタムレンダラー（複雑なUI） -->
    <div class="test-section">
      <h2>テスト3: カスタムレンダラー（素材ブロック）</h2>
      <div id="materialList"></div>
      <div class="action-buttons">
        <button class="btn-primary" onclick="materialBuilder.addItem()">+ 素材を追加</button>
        <button class="btn-secondary" onclick="showMaterialData()">データを表示</button>
        <button class="btn-success" onclick="setMaterialData()">サンプルデータをセット</button>
      </div>
      <div id="materialOutput" class="output" style="display: none;"></div>
    </div>
  </div>

  <!-- 動的ブロックビルダーのスクリプトとスタイル -->
  <script>
    // dynamic_block_builder.html の内容をここにコピー
    <?!= include('dynamic_block_builder'); ?>
  </script>

  <style>
    /* dynamic_block_builder_styles.html の内容をここにコピー */
    <?!= include('dynamic_block_builder_styles'); ?>
  </style>

  <script>
    // グローバル変数（テスト用）
    let CATEGORIES = ['カテゴリA', 'カテゴリB', 'カテゴリC', 'カテゴリD'];
    let MATERIAL_LOCATIONS = ['本体', '袖', '裏地', '襟'];
    let MATERIAL_TYPES = ['綿', 'ポリエステル', 'ナイロン', 'ウール', 'レーヨン'];

    let taskBuilder;
    let productBuilder;
    let materialBuilder;

    // ページ読み込み時に初期化
    window.addEventListener('DOMContentLoaded', () => {
      initializeTaskBuilder();
      initializeProductBuilder();
      initializeMaterialBuilder();
    });

    /**
     * テスト1: シンプルなタスクリスト
     */
    function initializeTaskBuilder() {
      taskBuilder = new DynamicBlockBuilder({
        containerId: 'taskList',
        itemLabel: 'タスク',
        minItems: 1,
        maxItems: 20,
        fields: [
          {
            id: 'title',
            type: 'text',
            label: 'タスク名',
            placeholder: 'タスクを入力してください'
          },
          {
            id: 'priority',
            type: 'select',
            label: '優先度',
            options: ['高', '中', '低']
          },
          {
            id: 'deadline',
            type: 'text',
            label: '期限',
            placeholder: 'YYYY-MM-DD'
          }
        ],
        onChange: () => {
          console.log('タスクが変更されました');
        }
      });
    }

    function showTaskData() {
      const data = taskBuilder.collectData();
      const output = document.getElementById('taskOutput');
      output.style.display = 'block';
      output.textContent = JSON.stringify(data, null, 2);
    }

    function setTaskData() {
      taskBuilder.setData([
        { title: 'プロジェクト企画書作成', priority: '高', deadline: '2025-01-15' },
        { title: 'ミーティング準備', priority: '中', deadline: '2025-01-10' },
        { title: 'メール返信', priority: '低', deadline: '2025-01-08' }
      ]);
    }

    /**
     * テスト2: 商品リスト
     */
    function initializeProductBuilder() {
      productBuilder = new DynamicBlockBuilder({
        containerId: 'productList',
        itemLabel: '商品',
        minItems: 1,
        maxItems: 10,
        fields: [
          {
            id: 'name',
            type: 'text',
            label: '商品名',
            placeholder: '商品名を入力'
          },
          {
            id: 'category',
            type: 'select',
            label: 'カテゴリ',
            options: 'CATEGORIES'  // グローバル変数名を指定
          },
          {
            id: 'price',
            type: 'number',
            label: '価格',
            placeholder: '0',
            min: 0,
            max: 1000000
          },
          {
            id: 'stock',
            type: 'number',
            label: '在庫数',
            placeholder: '0',
            min: 0,
            max: 9999
          }
        ],
        onChange: () => {
          console.log('商品が変更されました');
        }
      });
    }

    function showProductData() {
      const data = productBuilder.collectData();
      const output = document.getElementById('productOutput');
      output.style.display = 'block';
      output.textContent = JSON.stringify(data, null, 2);
    }

    function setProductData() {
      productBuilder.setData([
        { name: 'Tシャツ', category: 'カテゴリA', price: 2000, stock: 50 },
        { name: 'ジーンズ', category: 'カテゴリB', price: 5000, stock: 30 }
      ]);
    }

    /**
     * テスト3: 素材ブロック（カスタムレンダラー）
     */
    function initializeMaterialBuilder() {
      materialBuilder = new DynamicBlockBuilder({
        containerId: 'materialList',
        itemLabel: '素材',
        minItems: 1,
        maxItems: 10,
        itemClass: 'material-item',
        fields: [
          {
            id: '箇所',
            type: 'select',
            label: '箇所',
            className: 'material-location',
            options: 'MATERIAL_LOCATIONS'
          },
          {
            id: 'composition',
            type: 'custom',
            render: (index) => {
              const div = document.createElement('div');
              div.className = 'material-composition';
              div.innerHTML = `
                <div class="composition-row">
                  <label>種類:
                    <select id="素材${index}_種類1" class="material-type">
                      <option value="">--</option>
                    </select>
                  </label>
                  <label>割合:
                    <input type="number" id="素材${index}_％1" class="material-percent" min="0" max="100" placeholder="%">
                  </label>
                </div>
                <div class="composition-row">
                  <label>種類:
                    <select id="素材${index}_種類2" class="material-type">
                      <option value="">--</option>
                    </select>
                  </label>
                  <label>割合:
                    <input type="number" id="素材${index}_％2" class="material-percent" min="0" max="100" placeholder="%">
                  </label>
                </div>
              `;

              // オプションを追加
              const type1Select = div.querySelector(`#素材${index}_種類1`);
              const type2Select = div.querySelector(`#素材${index}_種類2`);

              MATERIAL_TYPES.forEach(type => {
                type1Select.insertAdjacentHTML('beforeend', `<option value="${type}">${type}</option>`);
                type2Select.insertAdjacentHTML('beforeend', `<option value="${type}">${type}</option>`);
              });

              return div;
            }
          }
        ],
        template: {
          headerClass: 'material-header',
          removeBtnClass: 'remove-material-btn',
          fieldsClass: 'material-fields'
        },
        onChange: () => {
          console.log('素材が変更されました');
        }
      });
    }

    function showMaterialData() {
      const data = materialBuilder.collectData();

      // カスタムレンダラーの値も手動で収集
      const items = document.querySelectorAll('.material-item');
      const fullData = [];

      items.forEach((item, i) => {
        const index = i + 1;
        const itemData = {
          箇所: data[i].箇所,
          種類1: document.getElementById(`素材${index}_種類1`)?.value || '',
          割合1: document.getElementById(`素材${index}_％1`)?.value || '',
          種類2: document.getElementById(`素材${index}_種類2`)?.value || '',
          割合2: document.getElementById(`素材${index}_％2`)?.value || ''
        };
        fullData.push(itemData);
      });

      const output = document.getElementById('materialOutput');
      output.style.display = 'block';
      output.textContent = JSON.stringify(fullData, null, 2);
    }

    function setMaterialData() {
      // 基本データをセット
      materialBuilder.setData([
        { 箇所: '本体' },
        { 箇所: '袖' }
      ]);

      // カスタムフィールドの値を手動でセット
      setTimeout(() => {
        document.getElementById('素材1_種類1').value = '綿';
        document.getElementById('素材1_％1').value = '80';
        document.getElementById('素材1_種類2').value = 'ポリエステル';
        document.getElementById('素材1_％2').value = '20';

        document.getElementById('素材2_種類1').value = 'ナイロン';
        document.getElementById('素材2_％1').value = '100';
      }, 100);
    }
  </script>
</body>
</html>
