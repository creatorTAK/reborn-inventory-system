<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      padding: 0;
      font-size: 13px;
      background: #f8fafc;
      margin: 0;
      min-height: 100vh;
    }

    /* PCç‰ˆï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ã®ã¿é€æ˜èƒŒæ™¯ */
    @media (min-width: 768px) {
      body {
        background: transparent;
      }
    }

    .container {
      max-width: 100%;
      padding: 0; /* ä½™ç™½ãªã— */
      margin: 0 auto;
    }

    @media (min-width: 768px) {
      .container {
        max-width: 800px;
        padding: 0; /* ä½™ç™½ãªã— */
      }
    }

    /* ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ« */
    .page-title {
      margin: 12px 12px 16px 12px; /* å·¦å³ã«ä½™ç™½è¿½åŠ  */
      font-size: 1.25rem;
      font-weight: 600;
      color: #212529;
    }

    /* PCç‰ˆ: ã‚¿ã‚¤ãƒˆãƒ«éè¡¨ç¤º */
    @media (min-width: 768px) {
      .page-title {
        display: none;
      }
    }

    .header {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      padding: 20px;
      margin: 12px 12px 20px 12px; /* ä¸Šå·¦å³ã«ä½™ç™½è¿½åŠ  */
      border-radius: 12px; /* ä¸Šä¸‹ä¸¡æ–¹è§’ä¸¸ */
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
    }

    .header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header p {
      margin: 8px 0 0 0;
      font-size: 13px;
      opacity: 0.9;
    }

    .section {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin: 0 12px 16px 12px; /* å·¦å³ä¸‹ã«ä½™ç™½è¿½åŠ  */
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border: 1px solid #e5e7eb;
    }

    .actions-bar {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin: 0 12px 16px 12px; /* å·¦å³ã«ä½™ç™½è¿½åŠ ï¼ˆã‚«ãƒ¼ãƒ‰ã¨æƒãˆã‚‹ï¼‰ */
    }

    @media (min-width: 768px) {
      .actions-bar {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    .btn {
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      min-height: 44px;
      white-space: nowrap;
    }

    @media (max-width: 767px) {
      .btn {
        font-size: 13px;
        padding: 10px 12px;
      }
    }

    .btn-primary {
      background: #f59e0b;
      color: white;
    }

    .btn-primary:hover {
      background: #d97706;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
      font-size: 13px;
      padding: 8px 14px;
      font-weight: 500;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-warning {
      background: #8b5cf6;
      color: white;
      font-size: 13px;
      padding: 8px 14px;
      font-weight: 500;
    }

    .btn-warning:hover {
      background: #7c3aed;
    }

    .card-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 12px 16px 16px 16px;
    }

    .material-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      transition: all 0.2s;
    }

    .material-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-color: #f59e0b;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .card-image {
      flex-shrink: 0;
      width: 100px;
      height: 100px;
      border-radius: 8px;
      overflow: hidden;
      background: #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .card-title-name {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
      padding-bottom: 10px;
      margin-bottom: 10px;
      border-bottom: 1px solid #e5e7eb;
    }

    .card-title-name span {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .card-title-category {
      font-size: 12px;
      color: #6b7280;
      flex: 1;
      min-width: 80px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .card-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex-shrink: 0;
      margin-left: auto;
    }

    .card-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .card-column {
      min-width: 0;
    }

    .card-field {
      margin-bottom: 6px;
    }

    .card-field:last-child {
      margin-bottom: 0;
    }

    .field-label {
      font-size: 10px;
      color: #6b7280;
      font-weight: 500;
      margin-bottom: 2px;
    }

    .field-value {
      font-size: 14px;
      color: #111827;
      font-weight: 500;
    }

    .field-value.price {
      color: #f59e0b;
      font-weight: 600;
      font-size: 16px;
    }

    .field-value.stock-warning {
      color: #ef4444;
      font-weight: 600;
    }

    .field-value.stock-ok {
      color: #10b981;
      font-weight: 600;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
    }

    .badge-primary {
      background-color: #dbeafe;
      color: #1e40af;
    }

    .badge-warning {
      background-color: #fef3c7;
      color: #92400e;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      overflow-x: hidden;
      position: relative;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      -webkit-overflow-scrolling: touch;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #111827;
    }

    .modal-body {
      padding: 20px;
      scroll-behavior: auto;
      overflow: visible;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®æ™‚ã¯å¼·åˆ¶çš„ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ */
    .modal:not(.active) .modal-body {
      overflow: hidden !important;
      height: 0 !important;
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-size: 13px;
      font-weight: 500;
      color: #374151;
    }

    .form-group label .required {
      color: #ef4444;
      margin-left: 2px;
    }

    .form-group label .hint {
      font-size: 11px;
      color: #9ca3af;
      font-weight: 400;
      margin-left: 4px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
      transition: all 0.2s;
      font-family: inherit;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 60px;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #f59e0b;
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
    }

    .form-group input[readonly] {
      background: #f9fafb;
      color: #6b7280;
    }

    /* å…¥åŠ›æ¬„ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .input-wrapper {
      position: relative;
      width: 100%;
    }

    .input-wrapper input {
      padding-right: 36px; /* Ã—ãƒœã‚¿ãƒ³åˆ†ã®ã‚¹ãƒšãƒ¼ã‚¹ç¢ºä¿ */
    }

    .input-clear-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: #9ca3af;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      display: none;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .input-clear-btn:hover {
      background: #6b7280;
    }

    .input-clear-btn.visible {
      display: flex;
    }

    .message {
      margin: 16px 0;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      display: none;
    }

    .message.active {
      display: block;
    }

    .message.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #10b981;
    }

    .message.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #ef4444;
    }

    .stats {
      background: #fef3c7;
      border: 1px solid #f59e0b;
      border-radius: 8px;
      padding: 12px 16px;
      margin: 0 12px 16px 12px; /* å·¦å³ã«ä½™ç™½è¿½åŠ  */
      font-size: 13px;
      color: #92400e;
      font-weight: 500;
    }

    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: #6b7280;
    }

    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .loading {
      text-align: center;
      padding: 32px;
      color: #6b7280;
    }

    .spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #f59e0b;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    .spinner-small {
      display: inline-block;
      border: 2px solid #ffffff;
      border-top: 2px solid transparent;
      border-radius: 50%;
      width: 14px;
      height: 14px;
      animation: spin 0.8s linear infinite;
      margin-right: 6px;
      vertical-align: middle;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-wrapper input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .delete-selected-btn {
      padding: 8px 16px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .delete-selected-btn:hover {
      background: #dc2626;
    }

    .delete-selected-btn:disabled {
      background: #d1d5db;
      color: #9ca3af;
      cursor: not-allowed;
    }

    /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ */
    .action-bar {
      padding: 12px 16px;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .action-bar-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .action-bar label {
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      cursor: pointer;
      user-select: none;
    }

    /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
    .category-accordion {
      margin: 0 12px 12px 12px; /* å·¦å³ã«ä½™ç™½è¿½åŠ  */
    }

    .category-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: #f8fafc;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .category-header:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }

    .category-header.active {
      background: #fef3c7;
      border-color: #f59e0b;
      border-bottom-color: #e5e7eb;
    }

    .category-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #111827;
    }

    .category-count {
      font-size: 12px;
      color: #6b7280;
      font-weight: 400;
    }

    .category-icon {
      transition: transform 0.2s;
      font-size: 12px;
      color: #6b7280;
    }

    .category-header.active .category-icon {
      transform: rotate(180deg);
    }

    .category-content {
      display: none;
      border: 1px solid #e5e7eb;
      border-top: none;
      border-radius: 0 0 8px 8px;
      overflow: hidden;
      margin-top: -1px;
    }

    .category-content.active {
      display: block;
    }

    .category-header.active {
      border-radius: 8px 8px 0 0;
    }

    /* ã‚«ãƒ†ã‚´ãƒªé †åºå¤‰æ›´ãƒœã‚¿ãƒ³ */
    .category-order-buttons {
      display: flex;
      gap: 4px;
      margin-right: 12px;
    }

    .order-btn {
      width: 28px;
      height: 28px;
      border: 1px solid #d1d5db;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #6b7280;
      transition: all 0.2s;
    }

    .order-btn:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
      color: #374151;
    }

    .order-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .order-btn:disabled:hover {
      background: white;
      border-color: #d1d5db;
    }

  </style>
</head>
<body>
  <div class="container">
  <h4 class="page-title">ğŸ“¦ æ¢±åŒ…è³‡æãƒã‚¹ã‚¿ç®¡ç†</h4>
  </div>

  <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
  <div id="message" class="message"></div>

  <!-- çµ±è¨ˆæƒ…å ± -->
  <div id="stats" class="stats" style="display: none;">
    ç™»éŒ²ä»¶æ•°: <span id="totalCount">0</span>ä»¶
  </div>

  <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
  <div class="actions-bar">
    <button class="btn btn-primary" onclick="openAddModal()">
      â• æ–°è¦è¿½åŠ 
    </button>
    <button class="btn" style="background: #10b981; color: white;" onclick="openInboundModal()">
      ğŸ“¥ å…¥åº«ç™»éŒ²
    </button>
    <button class="btn" style="background: #8b5cf6; color: white;" onclick="openPresetsModal()">
      ğŸ“‹ ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†
    </button>
    <button class="btn btn-info" onclick="loadData()">
      ğŸ”„ æ›´æ–°
    </button>
    <button class="btn btn-secondary" onclick="sortByCategory()">
      ğŸ“Š ã‚«ãƒ†ã‚´ãƒªã§ã‚½ãƒ¼ãƒˆ
    </button>
  </div>

  <!-- ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« -->
  <div id="tableContainer"></div>

  <!-- è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">æ¢±åŒ…è³‡æã®è¿½åŠ </h3>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>å•†å“å<span class="required">*</span></label>
          <div class="input-wrapper">
            <input type="text" id="productNameInput" placeholder="ä¾‹: é€æ˜OPPè¢‹ A4ã‚µã‚¤ã‚º 100æš">
            <button type="button" class="input-clear-btn" onclick="clearInput('productNameInput')">Ã—</button>
          </div>
        </div>
        <div class="form-group">
          <label>ã‚«ãƒ†ã‚´ãƒª</label>
          <select id="categorySelect" onchange="toggleCategoryCustomInput()">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="å°ç­’ãƒ»è¢‹é¡">å°ç­’ãƒ»è¢‹é¡</option>
            <option value="ç®±é¡">ç®±é¡</option>
            <option value="ç·©è¡æ">ç·©è¡æ</option>
            <option value="ãƒ†ãƒ¼ãƒ—ãƒ»æ¥ç€">ãƒ†ãƒ¼ãƒ—ãƒ»æ¥ç€</option>
            <option value="ãã®ä»–è³‡æ">ãã®ä»–è³‡æ</option>
            <option value="__custom__">ãã®ä»–ï¼ˆã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ï¼‰</option>
          </select>
          <div class="input-wrapper" style="margin-top: 8px;">
            <input type="text" id="categoryCustomInput" placeholder="ã‚«ãƒ†ã‚´ãƒªã‚’å…¥åŠ›" style="display: none;">
            <button type="button" class="input-clear-btn" onclick="clearInput('categoryCustomInput')">Ã—</button>
          </div>
        </div>
        <div class="form-group">
          <label>çµŒè²»åŒºåˆ†<span class="required">*</span></label>
          <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 8px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="radio" name="expenseType" value="å€‹åˆ¥åŸä¾¡" checked style="margin-right: 8px; width: 18px; height: 18px;">
              <span style="font-size: 16px;">å€‹åˆ¥åŸä¾¡</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="radio" name="expenseType" value="æœˆæ¬¡çµŒè²»" style="margin-right: 8px; width: 18px; height: 18px;">
              <span style="font-size: 16px;">æœˆæ¬¡çµŒè²»</span>
            </label>
          </div>
          <div style="font-size: 11px; color: #6b7280; margin-top: 8px; line-height: 1.5;">
            å€‹åˆ¥åŸä¾¡=è²©å£²æ™‚ã«åˆ©ç›Šè¨ˆç®—ã€æœˆæ¬¡çµŒè²»=è³¼å…¥æ™‚ã«çµŒè²»è¨ˆä¸Š
          </div>
        </div>
        <div class="form-group">
          <label>ç™ºæ³¨å…ˆ</label>
          <select id="supplierSelect" onchange="toggleSupplierCustomInput()">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="Amazon">Amazon</option>
            <option value="æ¥½å¤©å¸‚å ´">æ¥½å¤©å¸‚å ´</option>
            <option value="ãƒ¢ãƒã‚¿ãƒ­ã‚¦">ãƒ¢ãƒã‚¿ãƒ­ã‚¦</option>
            <option value="ãƒ¨ãƒ‰ãƒã‚·">ãƒ¨ãƒ‰ãƒã‚·</option>
            <option value="__custom__">ãã®ä»–ï¼ˆã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ï¼‰</option>
          </select>
          <div class="input-wrapper" style="margin-top: 8px;">
            <input type="text" id="supplierCustomInput" placeholder="ç™ºæ³¨å…ˆã‚’å…¥åŠ›" style="display: none;">
            <button type="button" class="input-clear-btn" onclick="clearInput('supplierCustomInput')">Ã—</button>
          </div>
        </div>
        <div class="form-group">
          <label>å•†å“ãƒªãƒ³ã‚¯</label>
          <div class="input-wrapper">
            <input type="url" id="productLinkInput" placeholder="https://...">
            <button type="button" class="input-clear-btn" onclick="clearInput('productLinkInput')">Ã—</button>
          </div>
        </div>
        <div class="form-group">
          <label>å•†å“ç”»åƒ</label>
          <input type="file" id="imageFileInput" accept="image/*" onchange="handleImageSelect(event)" style="display: none;">
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <button type="button" onclick="document.getElementById('imageFileInput').click()" style="width: 100%; padding: 10px 12px; border: 2px dashed #d1d5db; border-radius: 8px; background: white; color: #374151; font-size: 16px; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 8px;">
              ğŸ“· ç”»åƒã‚’é¸æŠ
            </button>
            <div id="imagePreview" style="display: none; position: relative;">
              <img id="previewImg" style="width: 100%; max-height: 200px; object-fit: contain; border-radius: 8px; border: 1px solid #e5e7eb;">
              <button type="button" onclick="clearImage()" style="position: absolute; top: 8px; right: 8px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 1;">Ã—</button>
            </div>
          </div>
          <input type="hidden" id="imageUrlInput">
        </div>
        <div class="form-group">
          <label>å€‹æ•°<span class="required">*</span><span class="hint">ï¼ˆ1ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å€‹æ•°ï¼‰</span></label>
          <div class="input-wrapper">
            <input type="number" id="quantityInput" placeholder="ä¾‹: 100" min="1" step="1" value="1">
            <button type="button" class="input-clear-btn" onclick="clearInput('quantityInput')">Ã—</button>
          </div>
        </div>
        <div class="form-group">
          <label>ä¾¡æ ¼ï¼ˆå††ï¼‰<span class="required">*</span><span class="hint">ï¼ˆ1ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ä¾¡æ ¼ï¼‰</span></label>
          <div class="input-wrapper">
            <input type="number" id="priceInput" placeholder="ä¾‹: 939" min="0" step="1" value="0">
            <button type="button" class="input-clear-btn" onclick="clearInput('priceInput')">Ã—</button>
          </div>
        </div>
        <div class="form-group">
          <label>å…¥åº«æ•°<span class="required">*</span><span class="hint">ï¼ˆåˆæœŸåœ¨åº«æ•°ï¼‰</span></label>
          <div class="input-wrapper">
            <input type="number" id="inStockInput" placeholder="ä¾‹: 100" min="0" step="1" value="0">
            <button type="button" class="input-clear-btn" onclick="clearInput('inStockInput')">Ã—</button>
          </div>
        </div>
        <div class="form-group" id="unitCostDisplay" style="display: none;">
          <label>1å€‹ã‚ãŸã‚Šã®å˜ä¾¡<span class="hint">ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</span></label>
          <input type="text" id="unitCostInput" readonly>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="saveData()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- å…¥åº«ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="inboundModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ğŸ“¥ å…¥åº«ç™»éŒ²</h3>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>ã‚«ãƒ†ã‚´ãƒª<span class="required">*</span></label>
          <select id="inboundCategorySelect" onchange="filterInboundMaterialsByCategory()">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>
        <div class="form-group">
          <label>æ¢±åŒ…è³‡æ<span class="required">*</span></label>
          <select id="inboundMaterialSelect" onchange="updateInboundStock()">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>
        <div class="form-group" id="currentStockDisplay" style="display: none;">
          <label>ç¾åœ¨ã®åœ¨åº«æ•°</label>
          <div style="padding: 12px; background: #f3f4f6; border-radius: 8px; font-size: 16px; font-weight: 600; color: #1f2937;">
            <span id="currentStockValue">-</span> å€‹
          </div>
        </div>
        <div class="form-group">
          <label>è³¼å…¥ä¾¡æ ¼ï¼ˆå††ï¼‰<span class="required">*</span></label>
          <div class="input-wrapper">
            <input type="number" id="inboundPriceInput" placeholder="ä¾‹: 939" min="0" step="1" oninput="calculateInboundUnitCost()">
            <button type="button" class="input-clear-btn" onclick="clearInput('inboundPriceInput')">Ã—</button>
          </div>
          <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
            1ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è³¼å…¥ä¾¡æ ¼
          </div>
        </div>
        <div class="form-group">
          <label>è³¼å…¥å€‹æ•°ï¼ˆå€‹ï¼‰<span class="required">*</span></label>
          <div class="input-wrapper">
            <input type="number" id="inboundPackageQuantityInput" placeholder="ä¾‹: 100" min="1" step="1" oninput="calculateInboundUnitCost(); syncInboundQuantity()">
            <button type="button" class="input-clear-btn" onclick="clearInput('inboundPackageQuantityInput')">Ã—</button>
          </div>
          <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
            1ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å€‹æ•°ï¼ˆãƒã‚¹ã‚¿ã‹ã‚‰è‡ªå‹•å…¥åŠ›ï¼‰
          </div>
        </div>
        <div class="form-group" id="inboundUnitCostDisplay" style="display: none;">
          <label>å˜ä¾¡ï¼ˆå††/å€‹ï¼‰</label>
          <div style="padding: 12px; background: #f3f4f6; border-radius: 8px; font-size: 16px; font-weight: 600; color: #1f2937;">
            <span id="inboundUnitCostValue">-</span>
          </div>
        </div>
        <div class="form-group">
          <label>å…¥åº«æ•°<span class="required">*</span></label>
          <div class="input-wrapper">
            <input type="number" id="inboundQuantityInput" placeholder="ä¾‹: 100" min="1" step="1" value="1">
            <button type="button" class="input-clear-btn" onclick="clearInput('inboundQuantityInput')">Ã—</button>
          </div>
          <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
            é€šå¸¸ã¯è³¼å…¥å€‹æ•°ã¨åŒã˜å€¤ï¼ˆè¤‡æ•°ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å ´åˆã¯æ‰‹å‹•ã§èª¿æ•´ï¼‰
          </div>
        </div>
        <div class="form-group">
          <label>ç†ç”±</label>
          <select id="inboundReasonSelect">
            <option value="è³¼å…¥">è³¼å…¥</option>
            <option value="åˆæœŸåœ¨åº«">åˆæœŸåœ¨åº«</option>
            <option value="è¿”å“">è¿”å“</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>
        <div class="form-group">
          <label>å‚™è€ƒ</label>
          <div class="input-wrapper">
            <textarea id="inboundNoteInput" placeholder="å‚™è€ƒã‚’å…¥åŠ›ï¼ˆä»»æ„ï¼‰"></textarea>
            <button type="button" class="input-clear-btn" onclick="clearInput('inboundNoteInput')">Ã—</button>
          </div>
        </div>
        <div class="form-group">
          <label>é–¢é€£è²©å£²è¨˜éŒ²ç•ªå·</label>
          <div class="input-wrapper">
            <input type="text" id="inboundRelatedRecordInput" placeholder="ä¾‹: AA-1001ï¼ˆä»»æ„ï¼‰">
            <button type="button" class="input-clear-btn" onclick="clearInput('inboundRelatedRecordInput')">Ã—</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeInboundModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="saveInboundRecord()">ç™»éŒ²</button>
      </div>
    </div>
  </div>

  <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="presetsModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3>ğŸ“‹ æ¢±åŒ…è³‡æãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†</h3>
      </div>
      <div class="modal-body">
        <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆä¸€è¦§ -->
        <div id="presetsList" style="margin-bottom: 20px;">
          <div style="text-align: center; padding: 40px; color: #000000; font-size: 18px; font-weight: bold; background: #fbbf24; border: 3px solid #d97706; border-radius: 8px;">
            â³ èª­ã¿è¾¼ã¿ä¸­...
          </div>
        </div>

        <!-- æ–°è¦ä½œæˆãƒœã‚¿ãƒ³ -->
        <button class="btn btn-primary" style="width: 100%;" onclick="openPresetEditModal()">
          â• æ–°è¦ãƒ—ãƒªã‚»ãƒƒãƒˆä½œæˆ
        </button>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closePresetsModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="presetEditModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3 id="presetEditModalTitle">æ–°è¦ãƒ—ãƒªã‚»ãƒƒãƒˆä½œæˆ</h3>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>ãƒ—ãƒªã‚»ãƒƒãƒˆå<span class="required">*</span></label>
          <div class="input-wrapper">
            <input type="text" id="presetNameInput" placeholder="ä¾‹: å°å‹è»½é‡ã‚»ãƒƒãƒˆ">
            <button type="button" class="input-clear-btn" onclick="clearInput('presetNameInput')">Ã—</button>
          </div>
        </div>

        <div class="form-group">
          <label>æ¢±åŒ…è³‡æ<span class="required">*</span></label>
          <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">
            ãƒ—ãƒªã‚»ãƒƒãƒˆã«å«ã‚ã‚‹æ¢±åŒ…è³‡æã‚’é¸æŠã—ã¦ãã ã•ã„
          </div>

          <!-- è³‡æè¿½åŠ ãƒœã‚¿ãƒ³ -->
          <button type="button" class="btn" style="background: #3b82f6; color: white; width: 100%; margin-bottom: 12px;" onclick="addPresetMaterialRow()">
            â• è³‡æã‚’è¿½åŠ 
          </button>

          <!-- è³‡æãƒªã‚¹ãƒˆ -->
          <div id="presetMaterialsList" style="display: flex; flex-direction: column; gap: 8px;">
            <!-- è³‡æè¡ŒãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closePresetEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="savePreset()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    let packagingMaterials = [];
    let packagingMaterialsByCategory = {}; // ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ‡ãƒ¼ã‚¿
    let categoryList = []; // ã‚«ãƒ†ã‚´ãƒªä¸€è¦§
    let editingRowIndex = null;
    let selectedImageData = null; // Base64ç”»åƒãƒ‡ãƒ¼ã‚¿
    let editingCategory = null; // ç·¨é›†ä¸­ã®ã‚«ãƒ†ã‚´ãƒªï¼ˆãƒªãƒ­ãƒ¼ãƒ‰å¾Œã«é–‹ããŸã‚ï¼‰

    // ãƒ—ãƒªã‚»ãƒƒãƒˆé–¢é€£
    let packagingPresets = []; // ãƒ—ãƒªã‚»ãƒƒãƒˆä¸€è¦§
    let editingPresetId = null; // ç·¨é›†ä¸­ã®ãƒ—ãƒªã‚»ãƒƒãƒˆID

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    window.addEventListener('DOMContentLoaded', function() {
      loadData();
    });

    // ä¾¡æ ¼ã¨å€‹æ•°ã®å¤‰æ›´ã‚’ç›£è¦–ã—ã¦ã€1å€‹ã‚ãŸã‚Šã‚’è¨ˆç®—
    document.addEventListener('DOMContentLoaded', function() {
      const quantityInput = document.getElementById('quantityInput');
      const priceInput = document.getElementById('priceInput');

      quantityInput.addEventListener('input', updateUnitCost);
      priceInput.addEventListener('input', updateUnitCost);

      // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®åˆæœŸåŒ–
      initClearButtons();
    });

    /**
     * 1å€‹ã‚ãŸã‚Šã®å˜ä¾¡ã‚’è¨ˆç®—
     */
    function updateUnitCost() {
      const quantity = parseFloat(document.getElementById('quantityInput').value) || 0;
      const price = parseFloat(document.getElementById('priceInput').value) || 0;

      if (quantity > 0) {
        const unitCost = price / quantity;
        document.getElementById('unitCostInput').value = 'Â¥' + unitCost.toFixed(2);
        document.getElementById('unitCostDisplay').style.display = 'block';
      } else {
        document.getElementById('unitCostDisplay').style.display = 'none';
      }
    }

    /**
     * ç”»åƒé¸æŠæ™‚ã®å‡¦ç†
     */
    function handleImageSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ5MBä»¥ä¸‹ï¼‰
      if (file.size > 5 * 1024 * 1024) {
        showMessage('error', 'ç”»åƒã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        selectedImageData = e.target.result; // Base64ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        document.getElementById('previewImg').src = selectedImageData;
        document.getElementById('imagePreview').style.display = 'block';
      };
      reader.readAsDataURL(file);
    }

    /**
     * ç”»åƒã‚¯ãƒªã‚¢
     */
    function clearImage() {
      selectedImageData = null;
      document.getElementById('imageFileInput').value = '';
      document.getElementById('imagePreview').style.display = 'none';
      document.getElementById('imageUrlInput').value = '';
    }

    /**
     * ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼‰
     */
    function loadData() {
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            packagingMaterialsByCategory = result.data || {}; // ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ‡ãƒ¼ã‚¿
            categoryList = result.categories || []; // ã‚«ãƒ†ã‚´ãƒªä¸€è¦§

            // ã‚«ãƒ†ã‚´ãƒªãƒ»è³‡æã®ä¸¦ã³é †ã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®é †åºã‚’ä½¿ç”¨ï¼ˆlocalStorageã¯ä½¿ç”¨ã—ãªã„ï¼‰

            // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ãƒ©ãƒƒãƒˆåŒ–ï¼ˆç·¨é›†ãƒ»å‰Šé™¤ç”¨ï¼‰
            packagingMaterials = [];
            Object.values(result.data).forEach(materials => {
              packagingMaterials.push(...materials);
            });
            renderTable();
            updateStats();
            // showMessage('success', result.message || 'ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ'); // ç”»é¢ã®ã‚«ã‚¯ã¤ãé˜²æ­¢ã®ãŸã‚éè¡¨ç¤º
          } else {
            showMessage('error', result.message || 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showMessage('error', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (error.message || error));
        })
        .getPackagingMaterialsByCategoryAPI();
    }

    /**
     * ãƒ†ãƒ¼ãƒ–ãƒ«æç”»ï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰
     */
    function renderTable() {
      const container = document.getElementById('tableContainer');

      if (packagingMaterials.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="icon">ğŸ“¦</div>
            <p>æ¢±åŒ…è³‡æãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
            <p style="font-size: 12px; color: #9ca3af;">ã€Œæ–°è¦è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰æ¢±åŒ…è³‡æã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
          </div>
        `;
        return;
      }

      let html = '';

      // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³è¡¨ç¤º
      categoryList.forEach((category, catIndex) => {
        const materials = packagingMaterialsByCategory[category] || [];
        if (materials.length === 0) return;

        // ç·¨é›†å¾Œã¯ç·¨é›†ã—ã¦ã„ãŸã‚«ãƒ†ã‚´ãƒªã‚’é–‹ãã€ãã‚Œä»¥å¤–ã¯å…¨ã¦é–‰ã˜ãŸçŠ¶æ…‹
        const isOpen = editingCategory && category === editingCategory;
        const activeClass = isOpen ? 'active' : '';

        html += `
          <div class="category-accordion">
            <div class="category-header ${activeClass}">
              <div class="category-title" onclick="toggleCategory(${catIndex})" style="flex: 1; cursor: pointer;">
                <span>${escapeHtml(category)}</span>
                <span class="category-count">${materials.length}ä»¶</span>
              </div>
              <div class="category-order-buttons" onclick="event.stopPropagation();">
                <button class="order-btn" onclick="moveCategoryUp(${catIndex})" ${catIndex === 0 ? 'disabled' : ''} title="ä¸Šã«ç§»å‹•">â†‘</button>
                <button class="order-btn" onclick="moveCategoryDown(${catIndex})" ${catIndex === categoryList.length - 1 ? 'disabled' : ''} title="ä¸‹ã«ç§»å‹•">â†“</button>
              </div>
              <span class="category-icon" onclick="toggleCategory(${catIndex})" style="cursor: pointer;">â–¼</span>
            </div>
            <div class="category-content ${activeClass}" id="category-${catIndex}">
              <div class="action-bar">
                <div class="action-bar-left">
                  <div class="checkbox-wrapper">
                    <input type="checkbox" id="selectAll-${catIndex}" onchange="toggleSelectAllCategory('${escapeJs(category)}', ${catIndex})">
                    <label for="selectAll-${catIndex}">å…¨é¸æŠ</label>
                  </div>
                </div>
                <button class="delete-selected-btn" id="deleteBtn-${catIndex}" onclick="deleteSelectedItems('${escapeJs(category)}');" disabled>é¸æŠå‰Šé™¤</button>
              </div>
              <div class="card-list">
        `;

        materials.forEach((item, matIndex) => {
          const stockClass = item.inventory <= 10 ? 'stock-warning' : 'stock-ok';
          const stockIcon = item.inventory <= 10 ? 'âš ï¸' : 'âœ…';

          // ç”»åƒéƒ¨åˆ†
          const imageHtml = item.imageUrl
            ? `<img src="${escapeHtml(item.imageUrl)}" alt="${escapeHtml(item.productName)}" onerror="this.parentElement.innerHTML='ğŸ“¦'">`
            : 'ğŸ“¦';

          html += `
            <div class="material-card">
              <!-- å•†å“å + ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ + ä¸Šä¸‹ãƒœã‚¿ãƒ³ -->
              <div class="card-title-name" style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" class="item-checkbox" data-category="${escapeHtml(category)}" data-row-index="${item.rowIndex}" onchange="updateDeleteButton('${escapeJs(category)}')">
                <span style="flex: 1;">${escapeHtml(item.productName)}</span>
                <div style="display: flex; gap: 4px;">
                  <button class="order-btn" onclick="moveMaterialUp('${escapeJs(category)}', ${matIndex})" ${matIndex === 0 ? 'disabled' : ''} title="ä¸Šã«ç§»å‹•">â†‘</button>
                  <button class="order-btn" onclick="moveMaterialDown('${escapeJs(category)}', ${matIndex})" ${matIndex === materials.length - 1 ? 'disabled' : ''} title="ä¸‹ã«ç§»å‹•">â†“</button>
                </div>
              </div>

              <!-- ãƒ˜ãƒƒãƒ€ãƒ¼: ç”»åƒ + ãƒœã‚¿ãƒ³ -->
              <div class="card-header">
                <div class="card-image">${imageHtml}</div>
                <div class="card-actions">
                  <button class="btn btn-warning" onclick="openEditModal(${item.rowIndex})">ç·¨é›†</button>
                  <button class="btn btn-danger" onclick="confirmDelete(${item.rowIndex}, '${escapeJs(item.productName)}')">å‰Šé™¤</button>
                </div>
              </div>

              <!-- ãƒœãƒ‡ã‚£: 2ã‚«ãƒ©ãƒ  -->
              <div class="card-body">
                <!-- å·¦ã‚«ãƒ©ãƒ : åŸºæœ¬æƒ…å ± -->
                <div class="card-column">
                  <div class="card-field">
                    <div class="field-label">çµŒè²»åŒºåˆ†</div>
                    <div class="field-value">
                      <span class="badge ${item.expenseType === 'æœˆæ¬¡çµŒè²»' ? 'badge-warning' : 'badge-primary'}">
                        ${escapeHtml(item.expenseType || 'å€‹åˆ¥åŸä¾¡')}
                      </span>
                    </div>
                  </div>
                  ${item.supplier ? `
                    <div class="card-field">
                      <div class="field-label">ç™ºæ³¨å…ˆ</div>
                      <div class="field-value">${escapeHtml(item.supplier)}</div>
                    </div>
                  ` : ''}
                  ${item.productLink ? `
                    <div class="card-field">
                      <div class="field-label">å•†å“ãƒªãƒ³ã‚¯</div>
                      <div class="field-value"><a href="${escapeHtml(item.productLink)}" target="_blank" style="color: #3b82f6; text-decoration: underline;">ğŸ”— å•†å“ãƒšãƒ¼ã‚¸</a></div>
                    </div>
                  ` : ''}
                </div>

                <!-- å³ã‚«ãƒ©ãƒ : æ•°å€¤æƒ…å ± -->
                <div class="card-column">
                  <div class="card-field">
                    <div class="field-label">ä¾¡æ ¼ / å€‹æ•°</div>
                    <div class="field-value">Â¥${item.price.toLocaleString()} / ${item.quantity.toLocaleString()}å€‹</div>
                  </div>
                  <div class="card-field">
                    <div class="field-label">å˜ä¾¡</div>
                    <div class="field-value">Â¥${item.unitCost.toFixed(2)}</div>
                  </div>
                  <div class="card-field">
                    <div class="field-label">å…¥åº« / å‡ºåº«</div>
                    <div class="field-value">${item.inStock.toLocaleString()} / ${item.outStock.toLocaleString()}</div>
                  </div>
                  <div class="card-field">
                    <div class="field-label">åœ¨åº« ${stockIcon}</div>
                    <div class="field-value ${stockClass}">${item.inventory.toLocaleString()}</div>
                  </div>
                </div>
              </div>
            </div>
          `;
        });

        html += `
              </div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;

      // ç·¨é›†å¾Œã®ã‚«ãƒ†ã‚´ãƒªè¡¨ç¤ºãŒå®Œäº†ã—ãŸã‚‰ã‚¯ãƒªã‚¢
      editingCategory = null;
    }

    /**
     * ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰
     */
    function toggleCategory(index) {
      const content = document.getElementById(`category-${index}`);
      const header = content.previousElementSibling;

      header.classList.toggle('active');
      content.classList.toggle('active');
    }

    /**
     * ã‚«ãƒ†ã‚´ãƒªå†…ã®å…¨é¸æŠ/å…¨è§£é™¤
     */
    function toggleSelectAllCategory(category, catIndex) {
      const selectAllCheckbox = document.getElementById(`selectAll-${catIndex}`);
      const checkboxes = document.querySelectorAll(`.item-checkbox[data-category="${category}"]`);

      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
      });

      updateDeleteButton(category);
    }

    /**
     * é¸æŠå‰Šé™¤ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’æ›´æ–°
     */
    function updateDeleteButton(category) {
      const checkboxes = document.querySelectorAll(`.item-checkbox[data-category="${category}"]`);
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;

      // ã‚«ãƒ†ã‚´ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
      const catIndex = categoryList.indexOf(category);
      const deleteBtn = document.getElementById(`deleteBtn-${catIndex}`);

      if (deleteBtn) {
        deleteBtn.disabled = checkedCount === 0;
        deleteBtn.textContent = checkedCount > 0 ? `é¸æŠå‰Šé™¤ (${checkedCount})` : 'é¸æŠå‰Šé™¤';
      }
    }

    /**
     * é¸æŠã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤
     */
    function deleteSelectedItems(category) {
      const checkboxes = document.querySelectorAll(`.item-checkbox[data-category="${category}"]:checked`);
      const rowIndexes = Array.from(checkboxes).map(cb => parseInt(cb.getAttribute('data-row-index')));

      if (rowIndexes.length === 0) {
        showMessage('error', 'å‰Šé™¤ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const message = rowIndexes.length === 1
        ? 'é¸æŠã—ãŸ1ä»¶ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ'
        : `é¸æŠã—ãŸ${rowIndexes.length}ä»¶ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;

      if (confirm(message)) {
        // å‰Šé™¤å‰ã«ã‚«ãƒ†ã‚´ãƒªã‚’è¨˜æ†¶
        editingCategory = category;
        deleteBulkData(rowIndexes);
      }
    }

    /**
     * ä¸€æ‹¬å‰Šé™¤å‡¦ç†
     */
    function deleteBulkData(rowIndexes) {
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            showMessage('success', result.message);
            loadData();
          } else {
            showMessage('error', result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showMessage('error', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (error.message || error));
        })
        .deleteBulkPackagingMaterialsAPI(rowIndexes);
    }

    /**
     * çµ±è¨ˆæƒ…å ±æ›´æ–°
     */
    function updateStats() {
      document.getElementById('totalCount').textContent = packagingMaterials.length;
      document.getElementById('stats').style.display = 'block';
    }

    /**
     * ã‚«ãƒ†ã‚´ãƒªé †ã«ã‚½ãƒ¼ãƒˆï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºé †ã§ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä¸¦ã³æ›¿ãˆï¼‰
     */
    function sortByCategory() {
      if (!confirm('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è¡Œã‚’ç¾åœ¨ã®è¡¨ç¤ºé †ï¼ˆã‚«ãƒ†ã‚´ãƒªï¼‹è³‡æã®ä¸¦ã³é †ï¼‰ã«ä¸¦ã³æ›¿ãˆã¾ã™ã‹ï¼Ÿ\n\nâ€»ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚\nâ€»ä¸¦ã³æ›¿ãˆãŸé †åºãŒã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚')) {
        return;
      }

      // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®è³‡æé †åºã‚’ä½œæˆ
      const materialOrderByCategory = {};
      categoryList.forEach(category => {
        const materials = packagingMaterialsByCategory[category] || [];
        materialOrderByCategory[category] = materials.map(m => m.productName);
      });

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            showMessage('success', result.message);
            loadData(); // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
          } else {
            showMessage('error', result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showMessage('error', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (error.message || error));
        })
        .sortPackagingMaterialsByCategoryAPI(categoryList, materialOrderByCategory); // ã‚«ãƒ†ã‚´ãƒªé † + è³‡æé †ã‚’æ¸¡ã™
    }

    /**
     * ã‚«ãƒ†ã‚´ãƒªé †åºã‚’localStorageã«ä¿å­˜
     */
    function saveCategoryOrder() {
      try {
        localStorage.setItem('packagingCategoryOrder', JSON.stringify(categoryList));
      } catch (error) {
        console.error('ã‚«ãƒ†ã‚´ãƒªé †åºã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    /**
     * ä¿å­˜ã•ã‚ŒãŸé †åºã‚’é©ç”¨
     */
    function applyCategoryOrder() {
      try {
        const savedOrder = localStorage.getItem('packagingCategoryOrder');
        if (!savedOrder) return;

        const savedList = JSON.parse(savedOrder);
        if (!Array.isArray(savedList)) return;

        // ä¿å­˜ã•ã‚ŒãŸé †åºã«å¾“ã£ã¦ä¸¦ã³æ›¿ãˆ
        // æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã¯æœ€å¾Œã«è¿½åŠ 
        const newCategoryList = [];
        const remainingCategories = [...categoryList];

        // ä¿å­˜ã•ã‚ŒãŸé †åºã§è¿½åŠ 
        savedList.forEach(savedCategory => {
          const index = remainingCategories.indexOf(savedCategory);
          if (index !== -1) {
            newCategoryList.push(savedCategory);
            remainingCategories.splice(index, 1);
          }
        });

        // æ–°è¦ã‚«ãƒ†ã‚´ãƒªã‚’æœ€å¾Œã«è¿½åŠ 
        newCategoryList.push(...remainingCategories);

        categoryList = newCategoryList;
      } catch (error) {
        console.error('ã‚«ãƒ†ã‚´ãƒªé †åºã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    /**
     * ã‚«ãƒ†ã‚´ãƒªã‚’ä¸Šã«ç§»å‹•
     */
    function moveCategoryUp(index) {
      if (index === 0) return;

      // é…åˆ—ã®è¦ç´ ã‚’å…¥ã‚Œæ›¿ãˆ
      [categoryList[index - 1], categoryList[index]] = [categoryList[index], categoryList[index - 1]];

      // ç§»å‹•ã—ãŸã‚«ãƒ†ã‚´ãƒªã‚’è¨˜æ†¶ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰å¾Œã«é–‹ããŸã‚ï¼‰
      editingCategory = categoryList[index - 1];

      // å†æç”»ï¼ˆé †åºã¯ã‚«ãƒ†ã‚´ãƒªã§ã‚½ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã•ã‚Œã‚‹ï¼‰
      renderTable();
    }

    /**
     * ã‚«ãƒ†ã‚´ãƒªã‚’ä¸‹ã«ç§»å‹•
     */
    function moveCategoryDown(index) {
      if (index === categoryList.length - 1) return;

      // é…åˆ—ã®è¦ç´ ã‚’å…¥ã‚Œæ›¿ãˆ
      [categoryList[index], categoryList[index + 1]] = [categoryList[index + 1], categoryList[index]];

      // ç§»å‹•ã—ãŸã‚«ãƒ†ã‚´ãƒªã‚’è¨˜æ†¶ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰å¾Œã«é–‹ããŸã‚ï¼‰
      editingCategory = categoryList[index + 1];

      // å†æç”»ï¼ˆé †åºã¯ã‚«ãƒ†ã‚´ãƒªã§ã‚½ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã•ã‚Œã‚‹ï¼‰
      renderTable();
    }

    /**
     * è³‡æã®ä¸¦ã³é †ã‚’ä¿å­˜
     */
    function saveMaterialOrder(category) {
      try {
        const materials = packagingMaterialsByCategory[category] || [];
        const productNames = materials.map(m => m.productName);
        const safeKey = `packagingMaterialOrder_${encodeURIComponent(category)}`;
        localStorage.setItem(safeKey, JSON.stringify(productNames));
        console.log('è³‡æé †åºã‚’ä¿å­˜:', category, productNames);
      } catch (error) {
        console.error('è³‡æé †åºã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    /**
     * ä¿å­˜ã•ã‚ŒãŸè³‡æã®ä¸¦ã³é †ã‚’é©ç”¨
     */
    function applyMaterialOrder() {
      try {
        categoryList.forEach(category => {
          const safeKey = `packagingMaterialOrder_${encodeURIComponent(category)}`;
          const savedOrder = localStorage.getItem(safeKey);
          if (!savedOrder) {
            console.log('ä¿å­˜ã•ã‚ŒãŸé †åºãªã—:', category);
            return;
          }

          const savedList = JSON.parse(savedOrder);
          if (!Array.isArray(savedList)) return;

          const materials = packagingMaterialsByCategory[category] || [];
          if (materials.length === 0) return;

          console.log('è³‡æé †åºã‚’é©ç”¨:', category, savedList);

          // ä¿å­˜ã•ã‚ŒãŸé †åºã«å¾“ã£ã¦ä¸¦ã³æ›¿ãˆ
          const orderedMaterials = [];
          const remainingMaterials = [...materials];

          // ä¿å­˜ã•ã‚ŒãŸé †åºã§è¿½åŠ 
          savedList.forEach(savedName => {
            const index = remainingMaterials.findIndex(m => m.productName === savedName);
            if (index !== -1) {
              orderedMaterials.push(remainingMaterials[index]);
              remainingMaterials.splice(index, 1);
            }
          });

          // æ–°è¦è³‡æã‚’æœ€å¾Œã«è¿½åŠ 
          orderedMaterials.push(...remainingMaterials);

          // ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
          packagingMaterialsByCategory[category] = orderedMaterials;
        });
      } catch (error) {
        console.error('è³‡æé †åºã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    /**
     * è³‡æã‚’ä¸Šã«ç§»å‹•
     */
    function moveMaterialUp(category, index) {
      if (index === 0) return;

      const materials = packagingMaterialsByCategory[category] || [];
      if (materials.length === 0) return;

      // é…åˆ—ã®è¦ç´ ã‚’å…¥ã‚Œæ›¿ãˆ
      [materials[index - 1], materials[index]] = [materials[index], materials[index - 1]];

      // ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
      packagingMaterialsByCategory[category] = materials;

      // ç§»å‹•ã—ãŸã‚«ãƒ†ã‚´ãƒªã‚’è¨˜æ†¶ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰å¾Œã«é–‹ããŸã‚ï¼‰
      editingCategory = category;

      // å†æç”»ï¼ˆé †åºã¯ã‚«ãƒ†ã‚´ãƒªã§ã‚½ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã•ã‚Œã‚‹ï¼‰
      renderTable();
    }

    /**
     * è³‡æã‚’ä¸‹ã«ç§»å‹•
     */
    function moveMaterialDown(category, index) {
      const materials = packagingMaterialsByCategory[category] || [];
      if (index === materials.length - 1) return;
      if (materials.length === 0) return;

      // é…åˆ—ã®è¦ç´ ã‚’å…¥ã‚Œæ›¿ãˆ
      [materials[index], materials[index + 1]] = [materials[index + 1], materials[index]];

      // ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
      packagingMaterialsByCategory[category] = materials;

      // ç§»å‹•ã—ãŸã‚«ãƒ†ã‚´ãƒªã‚’è¨˜æ†¶ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰å¾Œã«é–‹ããŸã‚ï¼‰
      editingCategory = category;

      // å†æç”»ï¼ˆé †åºã¯ã‚«ãƒ†ã‚´ãƒªã§ã‚½ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã•ã‚Œã‚‹ï¼‰
      renderTable();
    }

    /**
     * å…¥åŠ›æ¬„ã‚¯ãƒªã‚¢é–¢æ•°
     */
    function clearInput(inputId) {
      const input = document.getElementById(inputId);
      if (input) {
        input.value = '';
        input.focus();
        updateClearButton(inputId);
      }
    }

    /**
     * ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°
     */
    function updateClearButton(inputId) {
      const input = document.getElementById(inputId);
      if (!input) return;

      const wrapper = input.closest('.input-wrapper');
      if (!wrapper) return;

      const clearBtn = wrapper.querySelector('.input-clear-btn');
      if (!clearBtn) return;

      if (input.value && input.value.trim() !== '') {
        clearBtn.classList.add('visible');
      } else {
        clearBtn.classList.remove('visible');
      }
    }

    /**
     * å…¨å…¥åŠ›æ¬„ã«ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
     */
    function initClearButtons() {
      const inputIds = [
        'productNameInput',
        'categoryCustomInput',
        'supplierCustomInput',
        'productLinkInput',
        'quantityInput',
        'priceInput',
        'inStockInput',
        'inboundQuantityInput',
        'inboundPriceInput',
        'inboundPackageQuantityInput',
        'inboundNoteInput',
        'inboundRelatedRecordInput'
      ];

      inputIds.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
          // å…¥åŠ›æ™‚
          input.addEventListener('input', () => updateClearButton(inputId));
          // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚
          input.addEventListener('focus', () => updateClearButton(inputId));
          // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¢ã‚¦ãƒˆæ™‚ï¼ˆå°‘ã—é…å»¶ã•ã›ã¦è¡¨ç¤ºã‚’ç¶­æŒï¼‰
          input.addEventListener('blur', () => {
            setTimeout(() => updateClearButton(inputId), 200);
          });
        }
      });
    }

    /**
     * æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
     */
    /**
     * ã‚«ãƒ†ã‚´ãƒªãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’å‹•çš„ã«æ›´æ–°ï¼ˆå®Ÿéš›ã«ä½¿ç”¨ä¸­ã®ã‚«ãƒ†ã‚´ãƒªã®ã¿è¡¨ç¤ºï¼‰
     */
    function updateCategoryOptions() {
      const categorySelect = document.getElementById('categorySelect');
      const currentValue = categorySelect.value;

      // å®Ÿéš›ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚«ãƒ†ã‚´ãƒªã‚’æŠ½å‡ºï¼ˆäº”åéŸ³é †ï¼‰
      const usedCategories = new Set();
      packagingMaterials.forEach(item => {
        if (item.category) {
          usedCategories.add(item.category);
        }
      });

      // äº”åéŸ³é †ã«ã‚½ãƒ¼ãƒˆ
      const sortedCategories = Array.from(usedCategories).sort((a, b) => {
        return a.localeCompare(b, 'ja');
      });

      // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’å†ç”Ÿæˆ
      categorySelect.innerHTML = `
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        ${sortedCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
        <option value="__custom__">ãã®ä»–ï¼ˆã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ï¼‰</option>
      `;

      // å…ƒã®é¸æŠå€¤ã‚’å¾©å…ƒ
      if (currentValue) {
        categorySelect.value = currentValue;
      }
    }

    /**
     * ç™ºæ³¨å…ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’å‹•çš„ã«æ›´æ–°ï¼ˆå®Ÿéš›ã«ä½¿ç”¨ä¸­ã®ç™ºæ³¨å…ˆã®ã¿è¡¨ç¤ºï¼‰
     */
    function updateSupplierOptions() {
      const supplierSelect = document.getElementById('supplierSelect');
      const currentValue = supplierSelect.value;

      // å®Ÿéš›ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ç™ºæ³¨å…ˆã‚’æŠ½å‡ºï¼ˆäº”åéŸ³é †ï¼‰
      const usedSuppliers = new Set();
      packagingMaterials.forEach(item => {
        if (item.supplier) {
          usedSuppliers.add(item.supplier);
        }
      });

      // äº”åéŸ³é †ã«ã‚½ãƒ¼ãƒˆ
      const sortedSuppliers = Array.from(usedSuppliers).sort((a, b) => {
        return a.localeCompare(b, 'ja');
      });

      // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’å†ç”Ÿæˆ
      supplierSelect.innerHTML = `
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        ${sortedSuppliers.map(sup => `<option value="${sup}">${sup}</option>`).join('')}
        <option value="__custom__">ãã®ä»–ï¼ˆã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ï¼‰</option>
      `;

      // å…ƒã®é¸æŠå€¤ã‚’å¾©å…ƒ
      if (currentValue) {
        supplierSelect.value = currentValue;
      }
    }

    function openAddModal() {
      // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æœ€æ–°ã®çŠ¶æ…‹ã«æ›´æ–°
      updateCategoryOptions();
      updateSupplierOptions();

      editingRowIndex = null;
      document.getElementById('modalTitle').textContent = 'æ¢±åŒ…è³‡æã®è¿½åŠ ';
      document.getElementById('productNameInput').value = '';
      setCategoryValue('');
      setSupplierValue('');

      // çµŒè²»åŒºåˆ†ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆå€‹åˆ¥åŸä¾¡ï¼‰ã«ãƒªã‚»ãƒƒãƒˆ
      const expenseTypeRadios = document.querySelectorAll('input[name="expenseType"]');
      expenseTypeRadios.forEach(radio => {
        radio.checked = radio.value === 'å€‹åˆ¥åŸä¾¡';
      });

      document.getElementById('productLinkInput').value = '';
      clearImage(); // ç”»åƒã‚’ã‚¯ãƒªã‚¢
      document.getElementById('quantityInput').value = '1';
      document.getElementById('priceInput').value = '0';
      document.getElementById('inStockInput').value = '0';
      document.getElementById('unitCostDisplay').style.display = 'none';

      const modal = document.getElementById('editModal');
      const modalContent = modal.querySelector('.modal-content');
      const modalBody = modal.querySelector('.modal-body');

      // ã€æ–°ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã€‘DOMå†æç”»ã‚’å¼·åˆ¶ã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
      modalContent.style.display = 'none';
      modalContent.offsetHeight; // å¼·åˆ¶ãƒªãƒ•ãƒ­ãƒ¼
      modalContent.style.display = '';

      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ç¢ºå®Ÿã«ãƒªã‚»ãƒƒãƒˆ
      if (modalBody) modalBody.scrollTop = 0;
      if (modal) modal.scrollTop = 0;

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      modal.classList.add('active');

      // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºç›´å¾Œã«ã‚‚ãƒªã‚»ãƒƒãƒˆï¼ˆrequestAnimationFrameã§ç¢ºå®Ÿã«ï¼‰
      requestAnimationFrame(() => {
        if (modalBody) modalBody.scrollTop = 0;
        if (modal) modal.scrollTop = 0;

        requestAnimationFrame(() => {
          if (modalBody) modalBody.scrollTop = 0;
          if (modal) modal.scrollTop = 0;

          // ã•ã‚‰ã«é…å»¶å®Ÿè¡Œã§ã‚‚å¿µæŠ¼ã—
          setTimeout(() => {
            if (modalBody) modalBody.scrollTop = 0;
            if (modal) modal.scrollTop = 0;
          }, 10);

          setTimeout(() => {
            if (modalBody) modalBody.scrollTop = 0;
            if (modal) modal.scrollTop = 0;
          }, 50);

          setTimeout(() => {
            if (modalBody) modalBody.scrollTop = 0;
            if (modal) modal.scrollTop = 0;
          }, 100);

          setTimeout(() => {
            if (modalBody) modalBody.scrollTop = 0;
            if (modal) modal.scrollTop = 0;
          }, 200);
        });
      });
    }

    /**
     * ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
     */
    function openEditModal(rowIndex) {
      // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æœ€æ–°ã®çŠ¶æ…‹ã«æ›´æ–°
      updateCategoryOptions();
      updateSupplierOptions();

      const item = packagingMaterials.find(m => m.rowIndex === rowIndex);
      if (!item) {
        showMessage('error', 'ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      editingRowIndex = rowIndex;
      editingCategory = item.category || 'ãã®ä»–'; // ç·¨é›†ä¸­ã®ã‚«ãƒ†ã‚´ãƒªã‚’è¨˜æ†¶
      document.getElementById('modalTitle').textContent = 'æ¢±åŒ…è³‡æã®ç·¨é›†';
      document.getElementById('productNameInput').value = item.productName;
      setCategoryValue(item.category || '');

      // çµŒè²»åŒºåˆ†ã®è¨­å®š
      const expenseTypeRadios = document.querySelectorAll('input[name="expenseType"]');
      expenseTypeRadios.forEach(radio => {
        radio.checked = radio.value === (item.expenseType || 'å€‹åˆ¥åŸä¾¡');
      });

      setSupplierValue(item.supplier || '');
      document.getElementById('productLinkInput').value = item.productLink || '';

      // æ—¢å­˜ã®ç”»åƒURLãŒã‚ã‚‹å ´åˆã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
      if (item.imageUrl) {
        document.getElementById('imageUrlInput').value = item.imageUrl;
        document.getElementById('previewImg').src = item.imageUrl;
        document.getElementById('imagePreview').style.display = 'block';
        selectedImageData = null; // URLã®å ´åˆã¯Base64ãƒ‡ãƒ¼ã‚¿ã¯null
      } else {
        clearImage();
      }

      document.getElementById('quantityInput').value = item.quantity;
      document.getElementById('priceInput').value = item.price;
      document.getElementById('inStockInput').value = item.inStock;
      updateUnitCost();

      const modal = document.getElementById('editModal');
      const modalContent = modal.querySelector('.modal-content');
      const modalBody = modal.querySelector('.modal-body');

      // ã€æ–°ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã€‘DOMå†æç”»ã‚’å¼·åˆ¶ã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
      modalContent.style.display = 'none';
      modalContent.offsetHeight; // å¼·åˆ¶ãƒªãƒ•ãƒ­ãƒ¼
      modalContent.style.display = '';

      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ç¢ºå®Ÿã«ãƒªã‚»ãƒƒãƒˆ
      if (modalBody) modalBody.scrollTop = 0;
      if (modal) modal.scrollTop = 0;

      modal.classList.add('active');

      // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
      setTimeout(() => {
        updateClearButton('productNameInput');
        updateClearButton('categoryCustomInput');
        updateClearButton('supplierCustomInput');
        updateClearButton('productLinkInput');
        updateClearButton('quantityInput');
        updateClearButton('priceInput');
        updateClearButton('inStockInput');
      }, 0);

      requestAnimationFrame(() => {
        if (modalBody) modalBody.scrollTop = 0;
        if (modal) modal.scrollTop = 0;

        requestAnimationFrame(() => {
          if (modalBody) modalBody.scrollTop = 0;
          if (modal) modal.scrollTop = 0;

          // ã•ã‚‰ã«é…å»¶å®Ÿè¡Œã§ã‚‚å¿µæŠ¼ã—
          setTimeout(() => {
            if (modalBody) modalBody.scrollTop = 0;
            if (modal) modal.scrollTop = 0;
          }, 10);

          setTimeout(() => {
            if (modalBody) modalBody.scrollTop = 0;
            if (modal) modal.scrollTop = 0;
          }, 50);

          setTimeout(() => {
            if (modalBody) modalBody.scrollTop = 0;
            if (modal) modal.scrollTop = 0;
          }, 100);

          setTimeout(() => {
            if (modalBody) modalBody.scrollTop = 0;
            if (modal) modal.scrollTop = 0;
          }, 200);
        });
      });
    }

    /**
     * ä¿å­˜ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
     */
    function resetSaveButton() {
      const saveButton = document.querySelector('.modal-footer .btn-primary');
      if (saveButton) {
        saveButton.disabled = false;
        saveButton.innerHTML = 'ä¿å­˜';
        saveButton.style.cursor = 'pointer';
      }
    }

    /**
     * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
     */
    function closeModal() {
      const modal = document.getElementById('editModal');
      const modalContent = modal.querySelector('.modal-content');
      const modalBody = modal.querySelector('.modal-body');

      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å³åº§ã«ãƒªã‚»ãƒƒãƒˆ
      if (modalBody) modalBody.scrollTop = 0;
      if (modal) modal.scrollTop = 0;

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      modal.classList.remove('active');
      editingRowIndex = null;
      resetSaveButton();

      // ã€æ–°ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã€‘é–‰ã˜ãŸå¾Œã«DOMå†æç”»ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
      setTimeout(() => {
        modalContent.style.display = 'none';
        modalContent.offsetHeight; // å¼·åˆ¶ãƒªãƒ•ãƒ­ãƒ¼
        modalContent.style.display = '';
        if (modalBody) modalBody.scrollTop = 0;
        if (modal) modal.scrollTop = 0;
      }, 100);
    }

    /**
     * ãƒ‡ãƒ¼ã‚¿ä¿å­˜
     */
    function saveData() {
      const productName = document.getElementById('productNameInput').value.trim();
      const category = getCategoryValue();
      const expenseType = document.querySelector('input[name="expenseType"]:checked').value;
      const supplier = getSupplierValue();
      const productLink = document.getElementById('productLinkInput').value.trim();
      const quantity = parseFloat(document.getElementById('quantityInput').value);
      const price = parseFloat(document.getElementById('priceInput').value);
      const inStock = parseFloat(document.getElementById('inStockInput').value);

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!productName) {
        showMessage('error', 'å•†å“åã¯å¿…é ˆã§ã™');
        return;
      }

      if (isNaN(quantity) || quantity <= 0) {
        showMessage('error', 'å€‹æ•°ã¯1ä»¥ä¸Šã®æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      if (isNaN(price) || price < 0) {
        showMessage('error', 'ä¾¡æ ¼ã¯0ä»¥ä¸Šã®æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      if (isNaN(inStock) || inStock < 0) {
        showMessage('error', 'å…¥åº«æ•°ã¯0ä»¥ä¸Šã®æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      // ä¿å­˜å‡¦ç†é–‹å§‹ï¼ˆå³åº§ã«ãƒœã‚¿ãƒ³ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºï¼‰
      const saveButton = document.querySelector('.modal-footer .btn-primary');
      if (saveButton) {
        saveButton.disabled = true;
        saveButton.innerHTML = '<span class="spinner-small"></span> ä¿å­˜ä¸­...';
        saveButton.style.cursor = 'not-allowed';
      }

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚è¡¨ç¤º
      showMessage('info', 'ä¿å­˜ä¸­...');

      // ç·¨é›†ä¸­ã®ã‚«ãƒ†ã‚´ãƒªã‚’è¨˜æ†¶ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰å¾Œã«é–‹ããŸã‚ï¼‰
      editingCategory = category;

      // æ–°ã—ã„ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å…ˆã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      if (selectedImageData) {
        showMessage('info', 'ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');

        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success && result.urls && result.urls.length > 0) {
              // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸã€URLã‚’å–å¾—ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
              saveDataWithImageUrl(result.urls[0].url, productName, category, expenseType, supplier, productLink, quantity, price, inStock);
            } else {
              resetSaveButton();
              showMessage('error', 'ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
            }
          })
          .withFailureHandler(function(error) {
            resetSaveButton();
            showMessage('error', 'ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error));
          })
          .uploadImagesToR2({
            images: [{ data: selectedImageData, name: productName + '.jpg' }],
            productId: productName
          });
      } else {
        // ç”»åƒãŒãªã„ã€ã¾ãŸã¯æ—¢å­˜URLã‚’ä½¿ç”¨
        const imageUrl = document.getElementById('imageUrlInput').value.trim();
        saveDataWithImageUrl(imageUrl, productName, category, expenseType, supplier, productLink, quantity, price, inStock);
      }
    }

    /**
     * ç”»åƒURLä»˜ãã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
     */
    function saveDataWithImageUrl(imageUrl, productName, category, expenseType, supplier, productLink, quantity, price, inStock) {
      const params = {
        productName: productName,
        category: category,
        expenseType: expenseType,
        supplier: supplier,
        productLink: productLink,
        imageUrl: imageUrl,
        quantity: quantity,
        price: price,
        inStock: inStock
      };

      if (editingRowIndex) {
        // ç·¨é›†ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯æ—¢ã«è¡¨ç¤ºæ¸ˆã¿ï¼‰
        params.rowIndex = editingRowIndex;
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoading();
            closeModal();
            if (result.success) {
              showMessage('success', result.message);
              loadData();
            } else {
              showMessage('error', result.message);
            }
          })
          .withFailureHandler(function(error) {
            hideLoading();
            resetSaveButton();
            showMessage('error', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (error.message || error));
          })
          .updatePackagingMaterialAPI(params);
      } else {
        // æ–°è¦è¿½åŠ ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯æ—¢ã«è¡¨ç¤ºæ¸ˆã¿ï¼‰
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoading();
            closeModal();
            if (result.success) {
              showMessage('success', result.message);
              loadData();
            } else {
              showMessage('error', result.message);
            }
          })
          .withFailureHandler(function(error) {
            hideLoading();
            resetSaveButton();
            showMessage('error', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (error.message || error));
          })
          .addPackagingMaterialAPI(params);
      }
    }

    /**
     * å‰Šé™¤ç¢ºèª
     */
    function confirmDelete(rowIndex, label) {
      if (confirm(`ã€Œ${label}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
        // å‰Šé™¤å‰ã«ã‚«ãƒ†ã‚´ãƒªã‚’è¨˜æ†¶ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰å¾Œã«é–‹ããŸã‚ï¼‰
        const item = packagingMaterials.find(m => m.rowIndex === rowIndex);
        if (item) {
          editingCategory = item.category || 'ãã®ä»–';
        }
        deleteData(rowIndex);
      }
    }

    /**
     * ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
     */
    function deleteData(rowIndex) {
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            showMessage('success', result.message);
            loadData();
          } else {
            showMessage('error', result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showMessage('error', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (error.message || error));
        })
        .deletePackagingMaterialAPI(rowIndex);
    }

    /**
     * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
     */
    function showMessage(type, text) {
      const messageEl = document.getElementById('message');
      messageEl.className = `message ${type} active`;
      messageEl.textContent = text;
      setTimeout(() => {
        messageEl.classList.remove('active');
      }, 5000);
    }

    /**
     * ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
     */
    function showLoading() {
      const container = document.getElementById('tableContainer');
      container.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>å‡¦ç†ä¸­...</p>
        </div>
      `;
    }

    /**
     * ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
     */
    function hideLoading() {
      // renderTable()ã§ä¸Šæ›¸ãã•ã‚Œã‚‹ãŸã‚ç‰¹ã«å‡¦ç†ä¸è¦
    }

    /**
     * HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
     */
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    /**
     * JavaScriptæ–‡å­—åˆ—ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆonclickå±æ€§å†…ã§ä½¿ç”¨ï¼‰
     */
    function escapeJs(text) {
      if (!text) return '';
      return String(text)
        .replace(/\\/g, '\\\\')
        .replace(/'/g, "\\'")
        .replace(/"/g, '\\"')
        .replace(/\n/g, '\\n')
        .replace(/\r/g, '\\r');
    }

    // =============================================================================
    // å…¥åº«ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
    // =============================================================================

    /**
     * å…¥åº«ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
     */
    function openInboundModal() {
      // ã‚«ãƒ†ã‚´ãƒªãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
      const categorySelect = document.getElementById('inboundCategorySelect');
      categorySelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';

      // ã‚«ãƒ†ã‚´ãƒªãƒªã‚¹ãƒˆã¯ãƒˆãƒƒãƒ—ç”»é¢ã¨åŒã˜é †åºã‚’ä½¿ç”¨ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®é †åºï¼‰
      categoryList.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        categorySelect.appendChild(option);
      });

      // è³‡æãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã¯åˆæœŸçŠ¶æ…‹
      const materialSelect = document.getElementById('inboundMaterialSelect');
      materialSelect.innerHTML = '<option value="">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</option>';

      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      categorySelect.value = '';
      materialSelect.value = '';
      document.getElementById('inboundQuantityInput').value = '1';
      document.getElementById('inboundPriceInput').value = '';
      document.getElementById('inboundPackageQuantityInput').value = '';
      document.getElementById('inboundReasonSelect').value = 'è³¼å…¥';
      document.getElementById('inboundNoteInput').value = '';
      document.getElementById('inboundRelatedRecordInput').value = '';

      // åœ¨åº«æ•°è¡¨ç¤ºã‚’éè¡¨ç¤º
      document.getElementById('currentStockDisplay').style.display = 'none';
      document.getElementById('currentStockValue').textContent = '-';

      // å˜ä¾¡è¡¨ç¤ºã‚’éè¡¨ç¤º
      document.getElementById('inboundUnitCostDisplay').style.display = 'none';
      document.getElementById('inboundUnitCostValue').textContent = '-';

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      const modal = document.getElementById('inboundModal');
      const modalContent = modal.querySelector('.modal-content');
      const modalBody = modal.querySelector('.modal-body');

      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
      if (modalBody) modalBody.scrollTop = 0;
      if (modal) modal.scrollTop = 0;

      modal.classList.add('active');

      // è¡¨ç¤ºå¾Œã‚‚ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ç¢ºå®Ÿã«ãƒªã‚»ãƒƒãƒˆ
      requestAnimationFrame(() => {
        if (modalBody) modalBody.scrollTop = 0;
        if (modal) modal.scrollTop = 0;
      });
    }

    /**
     * ã‚«ãƒ†ã‚´ãƒªé¸æŠã«ã‚ˆã‚‹è³‡æãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
     */
    function filterInboundMaterialsByCategory() {
      const category = document.getElementById('inboundCategorySelect').value;
      const materialSelect = document.getElementById('inboundMaterialSelect');

      materialSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';

      if (!category) {
        materialSelect.innerHTML = '<option value="">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
        return;
      }

      // ã‚«ãƒ†ã‚´ãƒªã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦äº”åéŸ³é †
      const filtered = packagingMaterials.filter(m => m.category === category);
      filtered.sort((a, b) => a.productName.localeCompare(b.productName, 'ja'));

      filtered.forEach(material => {
        const option = document.createElement('option');
        option.value = material.productName;
        option.textContent = material.productName;
        materialSelect.appendChild(option);
      });

      // åœ¨åº«æ•°è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('currentStockDisplay').style.display = 'none';
      document.getElementById('currentStockValue').textContent = '-';
    }

    /**
     * å…¥åº«ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
     */
    function closeInboundModal() {
      const modal = document.getElementById('inboundModal');
      const modalBody = modal.querySelector('.modal-body');

      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
      if (modalBody) modalBody.scrollTop = 0;
      if (modal) modal.scrollTop = 0;

      modal.classList.remove('active');
      resetInboundSaveButton();
    }

    /**
     * é¸æŠã•ã‚ŒãŸè³‡æã®åœ¨åº«æ•°ã‚’è¡¨ç¤º
     */
    function updateInboundStock() {
      const materialName = document.getElementById('inboundMaterialSelect').value;
      const stockDisplay = document.getElementById('currentStockDisplay');
      const stockValue = document.getElementById('currentStockValue');
      const packageQuantityInput = document.getElementById('inboundPackageQuantityInput');

      if (!materialName) {
        stockDisplay.style.display = 'none';
        stockValue.textContent = '-';
        packageQuantityInput.value = '';
        return;
      }

      // é¸æŠã•ã‚ŒãŸè³‡æã‚’æ¤œç´¢
      const material = packagingMaterials.find(m => m.productName === materialName);
      if (material) {
        stockValue.textContent = material.inventory || 0;
        stockDisplay.style.display = 'block';

        // è³¼å…¥å€‹æ•°ã‚’è‡ªå‹•å…¥åŠ›ï¼ˆãƒã‚¹ã‚¿ã®å€‹æ•°ï¼‰
        packageQuantityInput.value = material.quantity || '';

        // å˜ä¾¡ã‚’å†è¨ˆç®—
        calculateInboundUnitCost();

        // å…¥åº«æ•°ã‚’è‡ªå‹•åŒæœŸ
        syncInboundQuantity();
      } else {
        stockDisplay.style.display = 'none';
        stockValue.textContent = '-';
        packageQuantityInput.value = '';
      }
    }

    /**
     * å…¥åº«ç™»éŒ²ã®å˜ä¾¡ã‚’è‡ªå‹•è¨ˆç®—
     */
    function calculateInboundUnitCost() {
      const price = parseFloat(document.getElementById('inboundPriceInput').value) || 0;
      const quantity = parseFloat(document.getElementById('inboundPackageQuantityInput').value) || 0;
      const unitCostDisplay = document.getElementById('inboundUnitCostDisplay');
      const unitCostValue = document.getElementById('inboundUnitCostValue');

      if (price > 0 && quantity > 0) {
        const unitCost = price / quantity;
        unitCostValue.textContent = 'Â¥' + unitCost.toFixed(2);
        unitCostDisplay.style.display = 'block';
      } else {
        unitCostValue.textContent = '-';
        unitCostDisplay.style.display = 'none';
      }
    }

    /**
     * è³¼å…¥å€‹æ•°ã‹ã‚‰å…¥åº«æ•°ã¸è‡ªå‹•åŒæœŸ
     */
    function syncInboundQuantity() {
      const packageQuantity = document.getElementById('inboundPackageQuantityInput').value;
      const inboundQuantityInput = document.getElementById('inboundQuantityInput');

      // è³¼å…¥å€‹æ•°ãŒå…¥åŠ›ã•ã‚Œã¦ã„ãŸã‚‰ã€å…¥åº«æ•°ã‚‚åŒã˜å€¤ã«ã™ã‚‹
      if (packageQuantity && parseFloat(packageQuantity) > 0) {
        inboundQuantityInput.value = packageQuantity;
      }
    }

    /**
     * å…¥åº«ç™»éŒ²ä¿å­˜ãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
     */
    function resetInboundSaveButton() {
      const saveButton = document.querySelector('#inboundModal .modal-footer .btn-primary');
      if (saveButton) {
        saveButton.disabled = false;
        saveButton.innerHTML = 'ç™»éŒ²';
        saveButton.style.cursor = 'pointer';
      }
    }

    /**
     * å…¥åº«è¨˜éŒ²ã‚’ä¿å­˜
     */
    function saveInboundRecord() {
      const materialName = document.getElementById('inboundMaterialSelect').value.trim();
      const quantity = parseInt(document.getElementById('inboundQuantityInput').value);
      const reason = document.getElementById('inboundReasonSelect').value;
      const note = document.getElementById('inboundNoteInput').value.trim();
      const relatedRecord = document.getElementById('inboundRelatedRecordInput').value.trim();

      // ä¾¡æ ¼æƒ…å ±ã‚’å–å¾—
      const purchasePrice = parseFloat(document.getElementById('inboundPriceInput').value) || null;
      const packageQuantity = parseFloat(document.getElementById('inboundPackageQuantityInput').value) || null;
      let unitCost = null;
      if (purchasePrice && packageQuantity && packageQuantity > 0) {
        unitCost = purchasePrice / packageQuantity;
      }

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!materialName) {
        showMessage('error', 'æ¢±åŒ…è³‡æã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      if (isNaN(quantity) || quantity <= 0) {
        showMessage('error', 'å…¥åº«æ•°ã¯1ä»¥ä¸Šã®æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      // ä¿å­˜å‡¦ç†é–‹å§‹
      const saveButton = document.querySelector('#inboundModal .modal-footer .btn-primary');
      if (saveButton) {
        saveButton.disabled = true;
        saveButton.innerHTML = '<span class="spinner-small"></span> ç™»éŒ²ä¸­...';
        saveButton.style.cursor = 'not-allowed';
      }

      showMessage('info', 'ç™»éŒ²ä¸­...');

      // ã¾ãšæ‹…å½“è€…åã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function(operatorResult) {
          const operatorName = (operatorResult.success && operatorResult.name) ? operatorResult.name : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';

          // å…¥åº«ç™»éŒ²APIã‚’å‘¼ã³å‡ºã—ï¼ˆå±¥æ­´è¨˜éŒ² + åœ¨åº«æ›´æ–°ï¼‰
          google.script.run
            .withSuccessHandler(function(result) {
              if (result.success) {
                closeInboundModal();
                showMessage('success', result.message || 'å…¥åº«è¨˜éŒ²ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºå¾Œã«ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿ï¼ˆ2ç§’å¾…ã¤ï¼‰
                setTimeout(() => {
                  loadData();
                }, 2000);
              } else {
                resetInboundSaveButton();
                showMessage('error', result.message || 'å…¥åº«è¨˜éŒ²ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
              }
            })
            .withFailureHandler(function(error) {
              resetInboundSaveButton();
              showMessage('error', 'å…¥åº«è¨˜éŒ²ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error));
            })
            .registerInboundAPI({
              materialName: materialName,
              quantity: quantity,
              reason: reason,
              relatedSalesRecord: relatedRecord,
              note: note,
              operator: operatorName,
              purchasePrice: purchasePrice,
              packageQuantity: packageQuantity,
              unitCost: unitCost
            });
        })
        .withFailureHandler(function(error) {
          console.error('æ‹…å½“è€…åå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§ç™»éŒ²
          google.script.run
            .withSuccessHandler(function(result) {
              if (result.success) {
                closeInboundModal();
                showMessage('success', result.message || 'å…¥åº«è¨˜éŒ²ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
                setTimeout(() => {
                  loadData();
                }, 2000);
              } else {
                resetInboundSaveButton();
                showMessage('error', result.message || 'å…¥åº«è¨˜éŒ²ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
              }
            })
            .withFailureHandler(function(error) {
              resetInboundSaveButton();
              showMessage('error', 'å…¥åº«è¨˜éŒ²ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error));
            })
            .registerInboundAPI({
              materialName: materialName,
              quantity: quantity,
              reason: reason,
              relatedSalesRecord: relatedRecord,
              note: note,
              operator: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼',
              purchasePrice: purchasePrice,
              packageQuantity: packageQuantity,
              unitCost: unitCost
            });
        })
        .getOperatorNameAPI();
    }

    /**
     * ã‚«ãƒ†ã‚´ãƒªã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ã®è¡¨ç¤ºåˆ‡æ›¿
     */
    function toggleCategoryCustomInput() {
      const select = document.getElementById('categorySelect');
      const customInput = document.getElementById('categoryCustomInput');

      if (select.value === '__custom__') {
        customInput.style.display = 'block';
      } else {
        customInput.style.display = 'none';
        customInput.value = '';
      }
    }

    /**
     * ç™ºæ³¨å…ˆã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ã®è¡¨ç¤ºåˆ‡æ›¿
     */
    function toggleSupplierCustomInput() {
      const select = document.getElementById('supplierSelect');
      const customInput = document.getElementById('supplierCustomInput');

      if (select.value === '__custom__') {
        customInput.style.display = 'block';
      } else {
        customInput.style.display = 'none';
        customInput.value = '';
      }
    }

    /**
     * ã‚«ãƒ†ã‚´ãƒªã®å€¤ã‚’å–å¾—
     */
    function getCategoryValue() {
      const select = document.getElementById('categorySelect');
      const customInput = document.getElementById('categoryCustomInput');

      if (select.value === '__custom__') {
        return customInput.value.trim();
      } else {
        return select.value;
      }
    }

    /**
     * ç™ºæ³¨å…ˆã®å€¤ã‚’å–å¾—
     */
    function getSupplierValue() {
      const select = document.getElementById('supplierSelect');
      const customInput = document.getElementById('supplierCustomInput');

      if (select.value === '__custom__') {
        return customInput.value.trim();
      } else {
        return select.value;
      }
    }

    /**
     * ã‚«ãƒ†ã‚´ãƒªã®å€¤ã‚’è¨­å®š
     */
    function setCategoryValue(value) {
      const select = document.getElementById('categorySelect');
      const customInput = document.getElementById('categoryCustomInput');

      // ãƒ—ãƒªã‚»ãƒƒãƒˆã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
      const options = Array.from(select.options).map(opt => opt.value);
      if (options.includes(value)) {
        select.value = value;
        customInput.style.display = 'none';
        customInput.value = '';
      } else if (value) {
        // ã‚«ã‚¹ã‚¿ãƒ å€¤
        select.value = '__custom__';
        customInput.value = value;
        customInput.style.display = 'block';
      } else {
        select.value = '';
        customInput.style.display = 'none';
        customInput.value = '';
      }
    }

    /**
     * ç™ºæ³¨å…ˆã®å€¤ã‚’è¨­å®š
     */
    function setSupplierValue(value) {
      const select = document.getElementById('supplierSelect');
      const customInput = document.getElementById('supplierCustomInput');

      // ãƒ—ãƒªã‚»ãƒƒãƒˆã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
      const options = Array.from(select.options).map(opt => opt.value);
      if (options.includes(value)) {
        select.value = value;
        customInput.style.display = 'none';
        customInput.value = '';
      } else if (value) {
        // ã‚«ã‚¹ã‚¿ãƒ å€¤
        select.value = '__custom__';
        customInput.value = value;
        customInput.style.display = 'block';
      } else {
        select.value = '';
        customInput.style.display = 'none';
        customInput.value = '';
      }
    }

    // ============================================================================
    // ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†æ©Ÿèƒ½
    // ============================================================================

    /**
     * ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
     */
    function openPresetsModal() {
      console.log('[DEBUG] openPresetsModal() called');
      const modal = document.getElementById('presetsModal');
      console.log('[DEBUG] modal element:', modal);

      if (!modal) {
        alert('ã‚¨ãƒ©ãƒ¼: ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      modal.style.display = 'flex';
      modal.classList.add('active'); // â† è¿½åŠ : activeã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸
      console.log('[DEBUG] modal displayed and activated, calling loadPresets()');
      loadPresets();
    }

    /**
     * ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
     */
    function closePresetsModal() {
      const modal = document.getElementById('presetsModal');
      modal.style.display = 'none';
      modal.classList.remove('active'); // â† è¿½åŠ : activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
    }

    /**
     * ãƒ—ãƒªã‚»ãƒƒãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
     */
    function loadPresets() {
      console.log('[DEBUG] loadPresets() called');
      const listContainer = document.getElementById('presetsList');
      console.log('[DEBUG] presetsList element:', listContainer);

      if (!listContainer) {
        alert('ã‚¨ãƒ©ãƒ¼: ãƒ—ãƒªã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      listContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #000000; font-size: 18px; font-weight: bold; background: #fbbf24; border: 3px solid #d97706; border-radius: 8px;">â³ èª­ã¿è¾¼ã¿ä¸­...</div>';
      console.log('[DEBUG] Loading indicator set, calling API...');

      google.script.run
        .withSuccessHandler(function(result) {
          console.log('[DEBUG] API Success:', result);
          if (result.success) {
            packagingPresets = result.data;
            console.log('[DEBUG] Presets data:', packagingPresets);
            renderPresetsList();
          } else {
            listContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #ffffff; font-size: 18px; font-weight: bold; background: #dc2626; border: 3px solid #991b1b; border-radius: 8px;">âŒ ã‚¨ãƒ©ãƒ¼: ' + result.message + '</div>';
            showMessage(result.message, 'error');
          }
        })
        .withFailureHandler(function(error) {
          console.log('[DEBUG] API Failure:', error);
          listContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #ffffff; font-size: 18px; font-weight: bold; background: #dc2626; border: 3px solid #991b1b; border-radius: 8px;">âŒ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message + '</div>';
          showMessage('ãƒ—ãƒªã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        })
        .getPackagingPresetsAPI();
    }

    /**
     * ãƒ—ãƒªã‚»ãƒƒãƒˆä¸€è¦§ã‚’è¡¨ç¤º
     */
    function renderPresetsList() {
      console.log('[DEBUG] renderPresetsList() called, presets count:', packagingPresets.length);
      const container = document.getElementById('presetsList');

      if (packagingPresets.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #ffffff; font-size: 18px; font-weight: bold; background: #1f2937; border: 3px solid #10b981; border-radius: 8px;">ğŸ“‹ ãƒ—ãƒªã‚»ãƒƒãƒˆãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“<br><br><small style="color: #d1d5db;">æ–°è¦ãƒ—ãƒªã‚»ãƒƒãƒˆä½œæˆãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„</small></div>';
        return;
      }

      let html = '';
      packagingPresets.forEach(preset => {
        const materialsText = preset.materialsList.map(m => m.productName).join(', ');

        html += `
          <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
              <div style="font-weight: 600; font-size: 14px; color: #111827;">${preset.presetName}</div>
              <div style="display: flex; gap: 4px;">
                <button class="btn" style="background: #3b82f6; color: white; padding: 6px 12px; font-size: 12px;" onclick="editPreset('${preset.presetId}')">
                  âœï¸ ç·¨é›†
                </button>
                <button class="btn" style="background: #ef4444; color: white; padding: 6px 12px; font-size: 12px;" onclick="deletePreset('${preset.presetId}', '${preset.presetName}')">
                  ğŸ—‘ï¸ å‰Šé™¤
                </button>
              </div>
            </div>
            <div style="font-size: 12px; color: #6b7280;">
              ${materialsText}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    /**
     * ãƒ—ãƒªã‚»ãƒƒãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆæ–°è¦ä½œæˆï¼‰
     */
    function openPresetEditModal() {
      editingPresetId = null;
      document.getElementById('presetEditModalTitle').textContent = 'æ–°è¦ãƒ—ãƒªã‚»ãƒƒãƒˆä½œæˆ';
      document.getElementById('presetNameInput').value = '';
      document.getElementById('presetMaterialsList').innerHTML = '';

      // 1è¡Œç›®ã‚’è¿½åŠ 
      addPresetMaterialRow();

      const modal = document.getElementById('presetEditModal');
      modal.style.display = 'flex';
      modal.classList.add('active'); // â† è¿½åŠ 
    }

    /**
     * ãƒ—ãƒªã‚»ãƒƒãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
     */
    function closePresetEditModal() {
      const modal = document.getElementById('presetEditModal');
      modal.style.display = 'none';
      modal.classList.remove('active'); // â† è¿½åŠ 
    }

    /**
     * ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ç·¨é›†
     */
    function editPreset(presetId) {
      const preset = packagingPresets.find(p => p.presetId === presetId);
      if (!preset) {
        showMessage('ãƒ—ãƒªã‚»ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
        return;
      }

      editingPresetId = presetId;
      document.getElementById('presetEditModalTitle').textContent = 'ãƒ—ãƒªã‚»ãƒƒãƒˆç·¨é›†';
      document.getElementById('presetNameInput').value = preset.presetName;

      // è³‡æãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¦å†æ§‹ç¯‰
      document.getElementById('presetMaterialsList').innerHTML = '';

      preset.materialsList.forEach(material => {
        addPresetMaterialRow(material.productName);
      });

      const modal = document.getElementById('presetEditModal');
      modal.style.display = 'flex';
      modal.classList.add('active'); // â† è¿½åŠ 
    }

    /**
     * ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å‰Šé™¤
     */
    function deletePreset(presetId, presetName) {
      if (!confirm(`ãƒ—ãƒªã‚»ãƒƒãƒˆã€Œ${presetName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showMessage(result.message, 'success');
            loadPresets(); // å†èª­ã¿è¾¼ã¿
          } else {
            showMessage(result.message, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        })
        .deletePackagingPresetAPI(presetId);
    }

    /**
     * ãƒ—ãƒªã‚»ãƒƒãƒˆè³‡æè¡Œã‚’è¿½åŠ 
     */
    function addPresetMaterialRow(productName = '') {
      const container = document.getElementById('presetMaterialsList');
      const rowId = `presetMaterialRow_${Date.now()}`;

      const rowHtml = `
        <div id="${rowId}" style="display: flex; gap: 8px; align-items: center; background: white; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px;">
          <select class="preset-material-select" style="flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            ${packagingMaterials.map(m => `<option value="${m.productName}" ${m.productName === productName ? 'selected' : ''}>${m.productName}</option>`).join('')}
          </select>
          <button type="button" class="btn" style="background: #ef4444; color: white; padding: 8px 12px; font-size: 12px;" onclick="removePresetMaterialRow('${rowId}')">
            å‰Šé™¤
          </button>
        </div>
      `;

      container.insertAdjacentHTML('beforeend', rowHtml);
    }

    /**
     * ãƒ—ãƒªã‚»ãƒƒãƒˆè³‡æè¡Œã‚’å‰Šé™¤
     */
    function removePresetMaterialRow(rowId) {
      document.getElementById(rowId).remove();
    }

    /**
     * ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä¿å­˜
     */
    function savePreset() {
      const presetName = document.getElementById('presetNameInput').value.trim();

      if (!presetName) {
        showMessage('ãƒ—ãƒªã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      // è³‡æãƒªã‚¹ãƒˆã‚’å–å¾—
      const materialSelects = document.querySelectorAll('.preset-material-select');

      const materialsList = [];
      for (let i = 0; i < materialSelects.length; i++) {
        const productName = materialSelects[i].value;

        if (productName) {
          materialsList.push({
            productName: productName
          });
        }
      }

      if (materialsList.length === 0) {
        showMessage('æ¢±åŒ…è³‡æã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }

      const params = {
        presetId: editingPresetId,
        presetName: presetName,
        materialsList: materialsList
      };

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showMessage(result.message, 'success');
            closePresetEditModal();
            loadPresets(); // å†èª­ã¿è¾¼ã¿
          } else {
            showMessage(result.message, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        })
        .savePackagingPresetAPI(params);
    }

  </script>
  </div><!-- /container -->
</body>
</html>
