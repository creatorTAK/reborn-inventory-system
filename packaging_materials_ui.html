<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      padding: 0;
      font-size: 13px;
      background: #f8fafc;
      margin: 0;
      min-height: 100vh;
    }

    .container {
      max-width: 100%;
      padding: 16px;
      margin: 0 auto;
    }

    @media (min-width: 768px) {
      .container {
        max-width: 800px;
        padding: 24px;
      }
    }

    .header {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      padding: 20px;
      margin: 0 0 20px 0;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
    }

    .header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header p {
      margin: 8px 0 0 0;
      font-size: 13px;
      opacity: 0.9;
    }

    .section {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border: 1px solid #e5e7eb;
    }

    .actions-bar {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 16px;
    }

    @media (min-width: 768px) {
      .actions-bar {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    .btn {
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      min-height: 44px;
      white-space: nowrap;
    }

    @media (max-width: 767px) {
      .btn {
        font-size: 13px;
        padding: 10px 12px;
      }
    }

    .btn-primary {
      background: #f59e0b;
      color: white;
    }

    .btn-primary:hover {
      background: #d97706;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
      font-size: 13px;
      padding: 8px 14px;
      font-weight: 500;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-warning {
      background: #8b5cf6;
      color: white;
      font-size: 13px;
      padding: 8px 14px;
      font-weight: 500;
    }

    .btn-warning:hover {
      background: #7c3aed;
    }

    .card-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 12px 16px 16px 16px;
    }

    .material-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      transition: all 0.2s;
    }

    .material-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-color: #f59e0b;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .card-image {
      flex-shrink: 0;
      width: 100px;
      height: 100px;
      border-radius: 8px;
      overflow: hidden;
      background: #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .card-title-name {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
      padding-bottom: 10px;
      margin-bottom: 10px;
      border-bottom: 1px solid #e5e7eb;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .card-title-category {
      font-size: 12px;
      color: #6b7280;
      flex: 1;
      min-width: 80px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .card-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex-shrink: 0;
      margin-left: auto;
    }

    .card-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .card-column {
      min-width: 0;
    }

    .card-field {
      margin-bottom: 6px;
    }

    .card-field:last-child {
      margin-bottom: 0;
    }

    .field-label {
      font-size: 10px;
      color: #6b7280;
      font-weight: 500;
      margin-bottom: 2px;
    }

    .field-value {
      font-size: 14px;
      color: #111827;
      font-weight: 500;
    }

    .field-value.price {
      color: #f59e0b;
      font-weight: 600;
      font-size: 16px;
    }

    .field-value.stock-warning {
      color: #ef4444;
      font-weight: 600;
    }

    .field-value.stock-ok {
      color: #10b981;
      font-weight: 600;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
    }

    .badge-primary {
      background-color: #dbeafe;
      color: #1e40af;
    }

    .badge-warning {
      background-color: #fef3c7;
      color: #92400e;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      overflow-x: hidden;
      position: relative;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      -webkit-overflow-scrolling: touch;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #111827;
    }

    .modal-body {
      padding: 20px;
      scroll-behavior: auto;
      overflow: visible;
    }

    /* モーダルが非アクティブの時は強制的にスクロール位置をリセット */
    .modal:not(.active) .modal-body {
      overflow: hidden !important;
      height: 0 !important;
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-size: 13px;
      font-weight: 500;
      color: #374151;
    }

    .form-group label .required {
      color: #ef4444;
      margin-left: 2px;
    }

    .form-group label .hint {
      font-size: 11px;
      color: #9ca3af;
      font-weight: 400;
      margin-left: 4px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
      transition: all 0.2s;
      font-family: inherit;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 60px;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #f59e0b;
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
    }

    .form-group input[readonly] {
      background: #f9fafb;
      color: #6b7280;
    }

    /* 入力欄クリアボタン用スタイル */
    .input-wrapper {
      position: relative;
      width: 100%;
    }

    .input-wrapper input {
      padding-right: 36px; /* ×ボタン分のスペース確保 */
    }

    .input-clear-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: #9ca3af;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      display: none;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .input-clear-btn:hover {
      background: #6b7280;
    }

    .input-clear-btn.visible {
      display: flex;
    }

    .message {
      margin: 16px 0;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      display: none;
    }

    .message.active {
      display: block;
    }

    .message.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #10b981;
    }

    .message.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #ef4444;
    }

    .stats {
      background: #fef3c7;
      border: 1px solid #f59e0b;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 16px;
      font-size: 13px;
      color: #92400e;
      font-weight: 500;
    }

    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: #6b7280;
    }

    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .loading {
      text-align: center;
      padding: 32px;
      color: #6b7280;
    }

    .spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #f59e0b;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    .spinner-small {
      display: inline-block;
      border: 2px solid #ffffff;
      border-top: 2px solid transparent;
      border-radius: 50%;
      width: 14px;
      height: 14px;
      animation: spin 0.8s linear infinite;
      margin-right: 6px;
      vertical-align: middle;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* チェックボックススタイル */
    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-wrapper input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .delete-selected-btn {
      padding: 8px 16px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .delete-selected-btn:hover {
      background: #dc2626;
    }

    .delete-selected-btn:disabled {
      background: #d1d5db;
      color: #9ca3af;
      cursor: not-allowed;
    }

    /* アクションバー */
    .action-bar {
      padding: 12px 16px;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .action-bar-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .action-bar label {
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      cursor: pointer;
      user-select: none;
    }

    /* アコーディオンスタイル */
    .category-accordion {
      margin-bottom: 12px;
    }

    .category-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: #f8fafc;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .category-header:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }

    .category-header.active {
      background: #fef3c7;
      border-color: #f59e0b;
      border-bottom-color: #e5e7eb;
    }

    .category-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #111827;
    }

    .category-count {
      font-size: 12px;
      color: #6b7280;
      font-weight: 400;
    }

    .category-icon {
      transition: transform 0.2s;
      font-size: 12px;
      color: #6b7280;
    }

    .category-header.active .category-icon {
      transform: rotate(180deg);
    }

    .category-content {
      display: none;
      border: 1px solid #e5e7eb;
      border-top: none;
      border-radius: 0 0 8px 8px;
      overflow: hidden;
      margin-top: -1px;
    }

    .category-content.active {
      display: block;
    }

    .category-header.active {
      border-radius: 8px 8px 0 0;
    }

    /* カテゴリ順序変更ボタン */
    .category-order-buttons {
      display: flex;
      gap: 4px;
      margin-right: 12px;
    }

    .order-btn {
      width: 28px;
      height: 28px;
      border: 1px solid #d1d5db;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #6b7280;
      transition: all 0.2s;
    }

    .order-btn:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
      color: #374151;
    }

    .order-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .order-btn:disabled:hover {
      background: white;
      border-color: #d1d5db;
    }
  </style>
</head>
<body>
  <div class="container">
  <div class="header">
    <h2>📦 梱包資材マスタ管理</h2>
    <p>販売記録で使用する梱包資材の情報と在庫を管理します</p>
  </div>

  <!-- メッセージ表示 -->
  <div id="message" class="message"></div>

  <!-- 統計情報 -->
  <div id="stats" class="stats" style="display: none;">
    登録件数: <span id="totalCount">0</span>件
  </div>

  <!-- アクションバー -->
  <div class="actions-bar">
    <button class="btn btn-primary" onclick="openAddModal()">
      ➕ 新規追加
    </button>
    <button class="btn btn-info" onclick="loadData()">
      🔄 更新
    </button>
    <button class="btn btn-secondary" onclick="sortByCategory()">
      📊 カテゴリでソート
    </button>
    <button class="btn" style="background: #10b981; color: white;" onclick="openInboundModal()">
      📥 入庫登録
    </button>
  </div>

  <!-- データテーブル -->
  <div class="section">
    <div id="tableContainer"></div>
  </div>

  <!-- 追加/編集モーダル -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">梱包資材の追加</h3>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>商品名<span class="required">*</span></label>
          <div class="input-wrapper">
            <input type="text" id="productNameInput" placeholder="例: 透明OPP袋 A4サイズ 100枚">
            <button type="button" class="input-clear-btn" onclick="clearInput('productNameInput')">×</button>
          </div>
        </div>
        <div class="form-group">
          <label>カテゴリ</label>
          <select id="categorySelect" onchange="toggleCategoryCustomInput()">
            <option value="">選択してください</option>
            <option value="封筒・袋類">封筒・袋類</option>
            <option value="箱類">箱類</option>
            <option value="緩衝材">緩衝材</option>
            <option value="テープ・接着">テープ・接着</option>
            <option value="その他資材">その他資材</option>
            <option value="__custom__">その他（カスタム入力）</option>
          </select>
          <div class="input-wrapper" style="margin-top: 8px;">
            <input type="text" id="categoryCustomInput" placeholder="カテゴリを入力" style="display: none;">
            <button type="button" class="input-clear-btn" onclick="clearInput('categoryCustomInput')">×</button>
          </div>
        </div>
        <div class="form-group">
          <label>経費区分<span class="required">*</span></label>
          <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 8px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="radio" name="expenseType" value="個別原価" checked style="margin-right: 8px; width: 18px; height: 18px;">
              <span style="font-size: 16px;">個別原価</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="radio" name="expenseType" value="月次経費" style="margin-right: 8px; width: 18px; height: 18px;">
              <span style="font-size: 16px;">月次経費</span>
            </label>
          </div>
          <div style="font-size: 11px; color: #6b7280; margin-top: 8px; line-height: 1.5;">
            個別原価=販売時に利益計算、月次経費=購入時に経費計上
          </div>
        </div>
        <div class="form-group">
          <label>発注先</label>
          <select id="supplierSelect" onchange="toggleSupplierCustomInput()">
            <option value="">選択してください</option>
            <option value="Amazon">Amazon</option>
            <option value="楽天市場">楽天市場</option>
            <option value="モノタロウ">モノタロウ</option>
            <option value="ヨドバシ">ヨドバシ</option>
            <option value="__custom__">その他（カスタム入力）</option>
          </select>
          <div class="input-wrapper" style="margin-top: 8px;">
            <input type="text" id="supplierCustomInput" placeholder="発注先を入力" style="display: none;">
            <button type="button" class="input-clear-btn" onclick="clearInput('supplierCustomInput')">×</button>
          </div>
        </div>
        <div class="form-group">
          <label>商品リンク</label>
          <div class="input-wrapper">
            <input type="url" id="productLinkInput" placeholder="https://...">
            <button type="button" class="input-clear-btn" onclick="clearInput('productLinkInput')">×</button>
          </div>
        </div>
        <div class="form-group">
          <label>商品画像</label>
          <input type="file" id="imageFileInput" accept="image/*" onchange="handleImageSelect(event)" style="display: none;">
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <button type="button" onclick="document.getElementById('imageFileInput').click()" style="width: 100%; padding: 10px 12px; border: 2px dashed #d1d5db; border-radius: 8px; background: white; color: #374151; font-size: 16px; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 8px;">
              📷 画像を選択
            </button>
            <div id="imagePreview" style="display: none; position: relative;">
              <img id="previewImg" style="width: 100%; max-height: 200px; object-fit: contain; border-radius: 8px; border: 1px solid #e5e7eb;">
              <button type="button" onclick="clearImage()" style="position: absolute; top: 8px; right: 8px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 1;">×</button>
            </div>
          </div>
          <input type="hidden" id="imageUrlInput">
        </div>
        <div class="form-group">
          <label>個数<span class="required">*</span><span class="hint">（1パッケージの個数）</span></label>
          <div class="input-wrapper">
            <input type="number" id="quantityInput" placeholder="例: 100" min="1" step="1" value="1">
            <button type="button" class="input-clear-btn" onclick="clearInput('quantityInput')">×</button>
          </div>
        </div>
        <div class="form-group">
          <label>価格（円）<span class="required">*</span><span class="hint">（1パッケージの価格）</span></label>
          <div class="input-wrapper">
            <input type="number" id="priceInput" placeholder="例: 939" min="0" step="1" value="0">
            <button type="button" class="input-clear-btn" onclick="clearInput('priceInput')">×</button>
          </div>
        </div>
        <div class="form-group">
          <label>入庫数<span class="required">*</span><span class="hint">（初期在庫数）</span></label>
          <div class="input-wrapper">
            <input type="number" id="inStockInput" placeholder="例: 100" min="0" step="1" value="0">
            <button type="button" class="input-clear-btn" onclick="clearInput('inStockInput')">×</button>
          </div>
        </div>
        <div class="form-group" id="unitCostDisplay" style="display: none;">
          <label>1個あたりの単価<span class="hint">（自動計算）</span></label>
          <input type="text" id="unitCostInput" readonly>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">キャンセル</button>
        <button class="btn btn-primary" onclick="saveData()">保存</button>
      </div>
    </div>
  </div>

  <!-- 入庫登録モーダル -->
  <div id="inboundModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>📥 入庫登録</h3>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>梱包資材<span class="required">*</span></label>
          <select id="inboundMaterialSelect">
            <option value="">選択してください</option>
          </select>
        </div>
        <div class="form-group">
          <label>入庫数<span class="required">*</span></label>
          <div class="input-wrapper">
            <input type="number" id="inboundQuantityInput" placeholder="例: 100" min="1" step="1" value="1">
            <button type="button" class="input-clear-btn" onclick="clearInput('inboundQuantityInput')">×</button>
          </div>
        </div>
        <div class="form-group">
          <label>理由</label>
          <select id="inboundReasonSelect">
            <option value="新規購入">新規購入</option>
            <option value="在庫補充">在庫補充</option>
            <option value="初期在庫">初期在庫</option>
            <option value="返品">返品</option>
            <option value="その他">その他</option>
          </select>
        </div>
        <div class="form-group">
          <label>備考</label>
          <div class="input-wrapper">
            <textarea id="inboundNoteInput" placeholder="備考を入力（任意）"></textarea>
          </div>
        </div>
        <div class="form-group">
          <label>関連販売記録番号</label>
          <div class="input-wrapper">
            <input type="text" id="inboundRelatedRecordInput" placeholder="例: AA-1001（任意）">
            <button type="button" class="input-clear-btn" onclick="clearInput('inboundRelatedRecordInput')">×</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeInboundModal()">キャンセル</button>
        <button class="btn btn-primary" onclick="saveInboundRecord()">登録</button>
      </div>
    </div>
  </div>

  <script>
    let packagingMaterials = [];
    let packagingMaterialsByCategory = {}; // カテゴリ別データ
    let categoryList = []; // カテゴリ一覧
    let editingRowIndex = null;
    let selectedImageData = null; // Base64画像データ
    let editingCategory = null; // 編集中のカテゴリ（リロード後に開くため）

    // ページ読み込み時にデータを取得
    window.addEventListener('DOMContentLoaded', function() {
      loadData();
    });

    // 価格と個数の変更を監視して、1個あたりを計算
    document.addEventListener('DOMContentLoaded', function() {
      const quantityInput = document.getElementById('quantityInput');
      const priceInput = document.getElementById('priceInput');

      quantityInput.addEventListener('input', updateUnitCost);
      priceInput.addEventListener('input', updateUnitCost);

      // クリアボタンの初期化
      initClearButtons();
    });

    /**
     * 1個あたりの単価を計算
     */
    function updateUnitCost() {
      const quantity = parseFloat(document.getElementById('quantityInput').value) || 0;
      const price = parseFloat(document.getElementById('priceInput').value) || 0;

      if (quantity > 0) {
        const unitCost = price / quantity;
        document.getElementById('unitCostInput').value = '¥' + unitCost.toFixed(2);
        document.getElementById('unitCostDisplay').style.display = 'block';
      } else {
        document.getElementById('unitCostDisplay').style.display = 'none';
      }
    }

    /**
     * 画像選択時の処理
     */
    function handleImageSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      // ファイルサイズチェック（5MB以下）
      if (file.size > 5 * 1024 * 1024) {
        showMessage('error', '画像サイズは5MB以下にしてください');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        selectedImageData = e.target.result; // Base64データを保存
        document.getElementById('previewImg').src = selectedImageData;
        document.getElementById('imagePreview').style.display = 'block';
      };
      reader.readAsDataURL(file);
    }

    /**
     * 画像クリア
     */
    function clearImage() {
      selectedImageData = null;
      document.getElementById('imageFileInput').value = '';
      document.getElementById('imagePreview').style.display = 'none';
      document.getElementById('imageUrlInput').value = '';
    }

    /**
     * データ読み込み（カテゴリ別）
     */
    function loadData() {
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            packagingMaterialsByCategory = result.data || {}; // カテゴリ別データ
            categoryList = result.categories || []; // カテゴリ一覧

            // カテゴリ・資材の並び順はスプレッドシートの順序を使用（localStorageは使用しない）

            // 全データをフラット化（編集・削除用）
            packagingMaterials = [];
            Object.values(result.data).forEach(materials => {
              packagingMaterials.push(...materials);
            });
            renderTable();
            updateStats();
            showMessage('success', result.message || 'データを読み込みました');
          } else {
            showMessage('error', result.message || 'データの読み込みに失敗しました');
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showMessage('error', 'エラーが発生しました: ' + (error.message || error));
        })
        .getPackagingMaterialsByCategoryAPI();
    }

    /**
     * テーブル描画（カテゴリ別アコーディオン）
     */
    function renderTable() {
      const container = document.getElementById('tableContainer');

      if (packagingMaterials.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="icon">📦</div>
            <p>梱包資材が登録されていません</p>
            <p style="font-size: 12px; color: #9ca3af;">「新規追加」ボタンから梱包資材を追加してください</p>
          </div>
        `;
        return;
      }

      let html = '';

      // カテゴリごとにアコーディオン表示
      categoryList.forEach((category, catIndex) => {
        const materials = packagingMaterialsByCategory[category] || [];
        if (materials.length === 0) return;

        // 編集後は編集していたカテゴリを開く、それ以外は全て閉じた状態
        const isOpen = editingCategory && category === editingCategory;
        const activeClass = isOpen ? 'active' : '';

        html += `
          <div class="category-accordion">
            <div class="category-header ${activeClass}">
              <div class="category-title" onclick="toggleCategory(${catIndex})" style="flex: 1; cursor: pointer;">
                <span>${escapeHtml(category)}</span>
                <span class="category-count">${materials.length}件</span>
              </div>
              <div class="category-order-buttons" onclick="event.stopPropagation();">
                <button class="order-btn" onclick="moveCategoryUp(${catIndex})" ${catIndex === 0 ? 'disabled' : ''} title="上に移動">↑</button>
                <button class="order-btn" onclick="moveCategoryDown(${catIndex})" ${catIndex === categoryList.length - 1 ? 'disabled' : ''} title="下に移動">↓</button>
              </div>
              <span class="category-icon" onclick="toggleCategory(${catIndex})" style="cursor: pointer;">▼</span>
            </div>
            <div class="category-content ${activeClass}" id="category-${catIndex}">
              <div class="action-bar">
                <div class="action-bar-left">
                  <div class="checkbox-wrapper">
                    <input type="checkbox" id="selectAll-${catIndex}" onchange="toggleSelectAllCategory('${escapeJs(category)}', ${catIndex})">
                    <label for="selectAll-${catIndex}">全選択</label>
                  </div>
                </div>
                <button class="delete-selected-btn" id="deleteBtn-${catIndex}" onclick="deleteSelectedItems('${escapeJs(category)}');" disabled>選択削除</button>
              </div>
              <div class="card-list">
        `;

        materials.forEach((item, matIndex) => {
          const stockClass = item.inventory <= 10 ? 'stock-warning' : 'stock-ok';
          const stockIcon = item.inventory <= 10 ? '⚠️' : '✅';

          // 画像部分
          const imageHtml = item.imageUrl
            ? `<img src="${escapeHtml(item.imageUrl)}" alt="${escapeHtml(item.productName)}" onerror="this.parentElement.innerHTML='📦'">`
            : '📦';

          html += `
            <div class="material-card">
              <!-- 商品名 + チェックボックス -->
              <div class="card-title-name" style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" class="item-checkbox" data-category="${escapeHtml(category)}" data-row-index="${item.rowIndex}" onchange="updateDeleteButton('${escapeJs(category)}')">
                <span>${escapeHtml(item.productName)}</span>
              </div>

              <!-- ヘッダー: 画像 + ボタン -->
              <div class="card-header">
                <div class="card-image">${imageHtml}</div>
                <div class="card-actions">
                  <div style="display: flex; gap: 4px; margin-bottom: 6px;">
                    <button class="order-btn" onclick="moveMaterialUp('${escapeJs(category)}', ${matIndex})" ${matIndex === 0 ? 'disabled' : ''} title="上に移動">↑</button>
                    <button class="order-btn" onclick="moveMaterialDown('${escapeJs(category)}', ${matIndex})" ${matIndex === materials.length - 1 ? 'disabled' : ''} title="下に移動">↓</button>
                  </div>
                  <button class="btn btn-warning" onclick="openEditModal(${item.rowIndex})">編集</button>
                  <button class="btn btn-danger" onclick="confirmDelete(${item.rowIndex}, '${escapeJs(item.productName)}')">削除</button>
                </div>
              </div>

              <!-- ボディ: 2カラム -->
              <div class="card-body">
                <!-- 左カラム: 基本情報 -->
                <div class="card-column">
                  <div class="card-field">
                    <div class="field-label">経費区分</div>
                    <div class="field-value">
                      <span class="badge ${item.expenseType === '月次経費' ? 'badge-warning' : 'badge-primary'}">
                        ${escapeHtml(item.expenseType || '個別原価')}
                      </span>
                    </div>
                  </div>
                  ${item.supplier ? `
                    <div class="card-field">
                      <div class="field-label">発注先</div>
                      <div class="field-value">${escapeHtml(item.supplier)}</div>
                    </div>
                  ` : ''}
                  ${item.productLink ? `
                    <div class="card-field">
                      <div class="field-label">商品リンク</div>
                      <div class="field-value"><a href="${escapeHtml(item.productLink)}" target="_blank" style="color: #3b82f6; text-decoration: underline;">🔗 商品ページ</a></div>
                    </div>
                  ` : ''}
                </div>

                <!-- 右カラム: 数値情報 -->
                <div class="card-column">
                  <div class="card-field">
                    <div class="field-label">価格 / 個数</div>
                    <div class="field-value">¥${item.price.toLocaleString()} / ${item.quantity.toLocaleString()}個</div>
                  </div>
                  <div class="card-field">
                    <div class="field-label">単価</div>
                    <div class="field-value">¥${item.unitCost.toFixed(2)}</div>
                  </div>
                  <div class="card-field">
                    <div class="field-label">入庫 / 出庫</div>
                    <div class="field-value">${item.inStock.toLocaleString()} / ${item.outStock.toLocaleString()}</div>
                  </div>
                  <div class="card-field">
                    <div class="field-label">在庫 ${stockIcon}</div>
                    <div class="field-value ${stockClass}">${item.inventory.toLocaleString()}</div>
                  </div>
                </div>
              </div>
            </div>
          `;
        });

        html += `
              </div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;

      // 編集後のカテゴリ表示が完了したらクリア
      editingCategory = null;
    }

    /**
     * アコーディオン開閉
     */
    function toggleCategory(index) {
      const content = document.getElementById(`category-${index}`);
      const header = content.previousElementSibling;

      header.classList.toggle('active');
      content.classList.toggle('active');
    }

    /**
     * カテゴリ内の全選択/全解除
     */
    function toggleSelectAllCategory(category, catIndex) {
      const selectAllCheckbox = document.getElementById(`selectAll-${catIndex}`);
      const checkboxes = document.querySelectorAll(`.item-checkbox[data-category="${category}"]`);

      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
      });

      updateDeleteButton(category);
    }

    /**
     * 選択削除ボタンの有効/無効を更新
     */
    function updateDeleteButton(category) {
      const checkboxes = document.querySelectorAll(`.item-checkbox[data-category="${category}"]`);
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;

      // カテゴリインデックスを取得
      const catIndex = categoryList.indexOf(category);
      const deleteBtn = document.getElementById(`deleteBtn-${catIndex}`);

      if (deleteBtn) {
        deleteBtn.disabled = checkedCount === 0;
        deleteBtn.textContent = checkedCount > 0 ? `選択削除 (${checkedCount})` : '選択削除';
      }
    }

    /**
     * 選択されたアイテムを削除
     */
    function deleteSelectedItems(category) {
      const checkboxes = document.querySelectorAll(`.item-checkbox[data-category="${category}"]:checked`);
      const rowIndexes = Array.from(checkboxes).map(cb => parseInt(cb.getAttribute('data-row-index')));

      if (rowIndexes.length === 0) {
        showMessage('error', '削除するアイテムを選択してください');
        return;
      }

      const message = rowIndexes.length === 1
        ? '選択した1件を削除してもよろしいですか？'
        : `選択した${rowIndexes.length}件を削除してもよろしいですか？`;

      if (confirm(message)) {
        // 削除前にカテゴリを記憶
        editingCategory = category;
        deleteBulkData(rowIndexes);
      }
    }

    /**
     * 一括削除処理
     */
    function deleteBulkData(rowIndexes) {
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            showMessage('success', result.message);
            loadData();
          } else {
            showMessage('error', result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showMessage('error', 'エラーが発生しました: ' + (error.message || error));
        })
        .deleteBulkPackagingMaterialsAPI(rowIndexes);
    }

    /**
     * 統計情報更新
     */
    function updateStats() {
      document.getElementById('totalCount').textContent = packagingMaterials.length;
      document.getElementById('stats').style.display = 'block';
    }

    /**
     * カテゴリ順にソート（モーダルの表示順でスプレッドシートを並び替え）
     */
    function sortByCategory() {
      if (!confirm('スプレッドシートの行を現在の表示順（カテゴリ＋資材の並び順）に並び替えますか？\n\n※この操作は元に戻せません。\n※並び替えた順序がスプレッドシートに保存されます。')) {
        return;
      }

      // カテゴリ別の資材順序を作成
      const materialOrderByCategory = {};
      categoryList.forEach(category => {
        const materials = packagingMaterialsByCategory[category] || [];
        materialOrderByCategory[category] = materials.map(m => m.productName);
      });

      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            showMessage('success', result.message);
            loadData(); // データ再読み込み
          } else {
            showMessage('error', result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showMessage('error', 'エラーが発生しました: ' + (error.message || error));
        })
        .sortPackagingMaterialsByCategoryAPI(categoryList, materialOrderByCategory); // カテゴリ順 + 資材順を渡す
    }

    /**
     * カテゴリ順序をlocalStorageに保存
     */
    function saveCategoryOrder() {
      try {
        localStorage.setItem('packagingCategoryOrder', JSON.stringify(categoryList));
      } catch (error) {
        console.error('カテゴリ順序の保存エラー:', error);
      }
    }

    /**
     * 保存された順序を適用
     */
    function applyCategoryOrder() {
      try {
        const savedOrder = localStorage.getItem('packagingCategoryOrder');
        if (!savedOrder) return;

        const savedList = JSON.parse(savedOrder);
        if (!Array.isArray(savedList)) return;

        // 保存された順序に従って並び替え
        // 新しいカテゴリは最後に追加
        const newCategoryList = [];
        const remainingCategories = [...categoryList];

        // 保存された順序で追加
        savedList.forEach(savedCategory => {
          const index = remainingCategories.indexOf(savedCategory);
          if (index !== -1) {
            newCategoryList.push(savedCategory);
            remainingCategories.splice(index, 1);
          }
        });

        // 新規カテゴリを最後に追加
        newCategoryList.push(...remainingCategories);

        categoryList = newCategoryList;
      } catch (error) {
        console.error('カテゴリ順序の読み込みエラー:', error);
      }
    }

    /**
     * カテゴリを上に移動
     */
    function moveCategoryUp(index) {
      if (index === 0) return;

      // 配列の要素を入れ替え
      [categoryList[index - 1], categoryList[index]] = [categoryList[index], categoryList[index - 1]];

      // 移動したカテゴリを記憶（リロード後に開くため）
      editingCategory = categoryList[index - 1];

      // 再描画（順序はカテゴリでソートボタンクリック時にスプレッドシートに保存される）
      renderTable();
    }

    /**
     * カテゴリを下に移動
     */
    function moveCategoryDown(index) {
      if (index === categoryList.length - 1) return;

      // 配列の要素を入れ替え
      [categoryList[index], categoryList[index + 1]] = [categoryList[index + 1], categoryList[index]];

      // 移動したカテゴリを記憶（リロード後に開くため）
      editingCategory = categoryList[index + 1];

      // 再描画（順序はカテゴリでソートボタンクリック時にスプレッドシートに保存される）
      renderTable();
    }

    /**
     * 資材の並び順を保存
     */
    function saveMaterialOrder(category) {
      try {
        const materials = packagingMaterialsByCategory[category] || [];
        const productNames = materials.map(m => m.productName);
        const safeKey = `packagingMaterialOrder_${encodeURIComponent(category)}`;
        localStorage.setItem(safeKey, JSON.stringify(productNames));
        console.log('資材順序を保存:', category, productNames);
      } catch (error) {
        console.error('資材順序の保存エラー:', error);
      }
    }

    /**
     * 保存された資材の並び順を適用
     */
    function applyMaterialOrder() {
      try {
        categoryList.forEach(category => {
          const safeKey = `packagingMaterialOrder_${encodeURIComponent(category)}`;
          const savedOrder = localStorage.getItem(safeKey);
          if (!savedOrder) {
            console.log('保存された順序なし:', category);
            return;
          }

          const savedList = JSON.parse(savedOrder);
          if (!Array.isArray(savedList)) return;

          const materials = packagingMaterialsByCategory[category] || [];
          if (materials.length === 0) return;

          console.log('資材順序を適用:', category, savedList);

          // 保存された順序に従って並び替え
          const orderedMaterials = [];
          const remainingMaterials = [...materials];

          // 保存された順序で追加
          savedList.forEach(savedName => {
            const index = remainingMaterials.findIndex(m => m.productName === savedName);
            if (index !== -1) {
              orderedMaterials.push(remainingMaterials[index]);
              remainingMaterials.splice(index, 1);
            }
          });

          // 新規資材を最後に追加
          orderedMaterials.push(...remainingMaterials);

          // カテゴリ別データを更新
          packagingMaterialsByCategory[category] = orderedMaterials;
        });
      } catch (error) {
        console.error('資材順序の読み込みエラー:', error);
      }
    }

    /**
     * 資材を上に移動
     */
    function moveMaterialUp(category, index) {
      if (index === 0) return;

      const materials = packagingMaterialsByCategory[category] || [];
      if (materials.length === 0) return;

      // 配列の要素を入れ替え
      [materials[index - 1], materials[index]] = [materials[index], materials[index - 1]];

      // カテゴリ別データを更新
      packagingMaterialsByCategory[category] = materials;

      // 移動したカテゴリを記憶（リロード後に開くため）
      editingCategory = category;

      // 再描画（順序はカテゴリでソートボタンクリック時にスプレッドシートに保存される）
      renderTable();
    }

    /**
     * 資材を下に移動
     */
    function moveMaterialDown(category, index) {
      const materials = packagingMaterialsByCategory[category] || [];
      if (index === materials.length - 1) return;
      if (materials.length === 0) return;

      // 配列の要素を入れ替え
      [materials[index], materials[index + 1]] = [materials[index + 1], materials[index]];

      // カテゴリ別データを更新
      packagingMaterialsByCategory[category] = materials;

      // 移動したカテゴリを記憶（リロード後に開くため）
      editingCategory = category;

      // 再描画（順序はカテゴリでソートボタンクリック時にスプレッドシートに保存される）
      renderTable();
    }

    /**
     * 入力欄クリア関数
     */
    function clearInput(inputId) {
      const input = document.getElementById(inputId);
      if (input) {
        input.value = '';
        input.focus();
        updateClearButton(inputId);
      }
    }

    /**
     * クリアボタンの表示/非表示を更新
     */
    function updateClearButton(inputId) {
      const input = document.getElementById(inputId);
      if (!input) return;

      const wrapper = input.closest('.input-wrapper');
      if (!wrapper) return;

      const clearBtn = wrapper.querySelector('.input-clear-btn');
      if (!clearBtn) return;

      if (input.value && input.value.trim() !== '') {
        clearBtn.classList.add('visible');
      } else {
        clearBtn.classList.remove('visible');
      }
    }

    /**
     * 全入力欄にクリアボタンのイベントリスナーを設定
     */
    function initClearButtons() {
      const inputIds = [
        'productNameInput',
        'categoryCustomInput',
        'supplierCustomInput',
        'productLinkInput',
        'quantityInput',
        'priceInput',
        'inStockInput'
      ];

      inputIds.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
          // 入力時
          input.addEventListener('input', () => updateClearButton(inputId));
          // フォーカス時
          input.addEventListener('focus', () => updateClearButton(inputId));
          // フォーカスアウト時（少し遅延させて表示を維持）
          input.addEventListener('blur', () => {
            setTimeout(() => updateClearButton(inputId), 200);
          });
        }
      });
    }

    /**
     * 新規追加モーダルを開く
     */
    /**
     * カテゴリプルダウンを動的に更新（実際に使用中のカテゴリのみ表示）
     */
    function updateCategoryOptions() {
      const categorySelect = document.getElementById('categorySelect');
      const currentValue = categorySelect.value;

      // 実際に使用されているカテゴリを抽出（五十音順）
      const usedCategories = new Set();
      packagingMaterials.forEach(item => {
        if (item.category) {
          usedCategories.add(item.category);
        }
      });

      // 五十音順にソート
      const sortedCategories = Array.from(usedCategories).sort((a, b) => {
        return a.localeCompare(b, 'ja');
      });

      // プルダウンを再生成
      categorySelect.innerHTML = `
        <option value="">選択してください</option>
        ${sortedCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
        <option value="__custom__">その他（カスタム入力）</option>
      `;

      // 元の選択値を復元
      if (currentValue) {
        categorySelect.value = currentValue;
      }
    }

    /**
     * 発注先プルダウンを動的に更新（実際に使用中の発注先のみ表示）
     */
    function updateSupplierOptions() {
      const supplierSelect = document.getElementById('supplierSelect');
      const currentValue = supplierSelect.value;

      // 実際に使用されている発注先を抽出（五十音順）
      const usedSuppliers = new Set();
      packagingMaterials.forEach(item => {
        if (item.supplier) {
          usedSuppliers.add(item.supplier);
        }
      });

      // 五十音順にソート
      const sortedSuppliers = Array.from(usedSuppliers).sort((a, b) => {
        return a.localeCompare(b, 'ja');
      });

      // プルダウンを再生成
      supplierSelect.innerHTML = `
        <option value="">選択してください</option>
        ${sortedSuppliers.map(sup => `<option value="${sup}">${sup}</option>`).join('')}
        <option value="__custom__">その他（カスタム入力）</option>
      `;

      // 元の選択値を復元
      if (currentValue) {
        supplierSelect.value = currentValue;
      }
    }

    function openAddModal() {
      // プルダウンを最新の状態に更新
      updateCategoryOptions();
      updateSupplierOptions();

      editingRowIndex = null;
      document.getElementById('modalTitle').textContent = '梱包資材の追加';
      document.getElementById('productNameInput').value = '';
      setCategoryValue('');
      setSupplierValue('');

      // 経費区分をデフォルト（個別原価）にリセット
      const expenseTypeRadios = document.querySelectorAll('input[name="expenseType"]');
      expenseTypeRadios.forEach(radio => {
        radio.checked = radio.value === '個別原価';
      });

      document.getElementById('productLinkInput').value = '';
      clearImage(); // 画像をクリア
      document.getElementById('quantityInput').value = '1';
      document.getElementById('priceInput').value = '0';
      document.getElementById('inStockInput').value = '0';
      document.getElementById('unitCostDisplay').style.display = 'none';

      const modal = document.getElementById('editModal');
      const modalContent = modal.querySelector('.modal-content');
      const modalBody = modal.querySelector('.modal-body');

      // 【新アプローチ】DOM再描画を強制してスクロール位置を完全リセット
      modalContent.style.display = 'none';
      modalContent.offsetHeight; // 強制リフロー
      modalContent.style.display = '';

      // スクロール位置を確実にリセット
      if (modalBody) modalBody.scrollTop = 0;
      if (modal) modal.scrollTop = 0;

      // モーダルを表示
      modal.classList.add('active');

      // モーダル表示直後にもリセット（requestAnimationFrameで確実に）
      requestAnimationFrame(() => {
        if (modalBody) modalBody.scrollTop = 0;
        if (modal) modal.scrollTop = 0;

        requestAnimationFrame(() => {
          if (modalBody) modalBody.scrollTop = 0;
          if (modal) modal.scrollTop = 0;

          // さらに遅延実行でも念押し
          setTimeout(() => {
            if (modalBody) modalBody.scrollTop = 0;
            if (modal) modal.scrollTop = 0;
          }, 10);

          setTimeout(() => {
            if (modalBody) modalBody.scrollTop = 0;
            if (modal) modal.scrollTop = 0;
          }, 50);

          setTimeout(() => {
            if (modalBody) modalBody.scrollTop = 0;
            if (modal) modal.scrollTop = 0;
          }, 100);

          setTimeout(() => {
            if (modalBody) modalBody.scrollTop = 0;
            if (modal) modal.scrollTop = 0;
          }, 200);
        });
      });
    }

    /**
     * 編集モーダルを開く
     */
    function openEditModal(rowIndex) {
      // プルダウンを最新の状態に更新
      updateCategoryOptions();
      updateSupplierOptions();

      const item = packagingMaterials.find(m => m.rowIndex === rowIndex);
      if (!item) {
        showMessage('error', 'データが見つかりません');
        return;
      }

      editingRowIndex = rowIndex;
      editingCategory = item.category || 'その他'; // 編集中のカテゴリを記憶
      document.getElementById('modalTitle').textContent = '梱包資材の編集';
      document.getElementById('productNameInput').value = item.productName;
      setCategoryValue(item.category || '');

      // 経費区分の設定
      const expenseTypeRadios = document.querySelectorAll('input[name="expenseType"]');
      expenseTypeRadios.forEach(radio => {
        radio.checked = radio.value === (item.expenseType || '個別原価');
      });

      setSupplierValue(item.supplier || '');
      document.getElementById('productLinkInput').value = item.productLink || '';

      // 既存の画像URLがある場合はプレビュー表示
      if (item.imageUrl) {
        document.getElementById('imageUrlInput').value = item.imageUrl;
        document.getElementById('previewImg').src = item.imageUrl;
        document.getElementById('imagePreview').style.display = 'block';
        selectedImageData = null; // URLの場合はBase64データはnull
      } else {
        clearImage();
      }

      document.getElementById('quantityInput').value = item.quantity;
      document.getElementById('priceInput').value = item.price;
      document.getElementById('inStockInput').value = item.inStock;
      updateUnitCost();

      const modal = document.getElementById('editModal');
      const modalContent = modal.querySelector('.modal-content');
      const modalBody = modal.querySelector('.modal-body');

      // 【新アプローチ】DOM再描画を強制してスクロール位置を完全リセット
      modalContent.style.display = 'none';
      modalContent.offsetHeight; // 強制リフロー
      modalContent.style.display = '';

      // スクロール位置を確実にリセット
      if (modalBody) modalBody.scrollTop = 0;
      if (modal) modal.scrollTop = 0;

      modal.classList.add('active');

      // クリアボタンの表示を更新
      setTimeout(() => {
        updateClearButton('productNameInput');
        updateClearButton('categoryCustomInput');
        updateClearButton('supplierCustomInput');
        updateClearButton('productLinkInput');
        updateClearButton('quantityInput');
        updateClearButton('priceInput');
        updateClearButton('inStockInput');
      }, 0);

      requestAnimationFrame(() => {
        if (modalBody) modalBody.scrollTop = 0;
        if (modal) modal.scrollTop = 0;

        requestAnimationFrame(() => {
          if (modalBody) modalBody.scrollTop = 0;
          if (modal) modal.scrollTop = 0;

          // さらに遅延実行でも念押し
          setTimeout(() => {
            if (modalBody) modalBody.scrollTop = 0;
            if (modal) modal.scrollTop = 0;
          }, 10);

          setTimeout(() => {
            if (modalBody) modalBody.scrollTop = 0;
            if (modal) modal.scrollTop = 0;
          }, 50);

          setTimeout(() => {
            if (modalBody) modalBody.scrollTop = 0;
            if (modal) modal.scrollTop = 0;
          }, 100);

          setTimeout(() => {
            if (modalBody) modalBody.scrollTop = 0;
            if (modal) modal.scrollTop = 0;
          }, 200);
        });
      });
    }

    /**
     * 保存ボタンを元に戻す
     */
    function resetSaveButton() {
      const saveButton = document.querySelector('.modal-footer .btn-primary');
      if (saveButton) {
        saveButton.disabled = false;
        saveButton.innerHTML = '保存';
        saveButton.style.cursor = 'pointer';
      }
    }

    /**
     * モーダルを閉じる
     */
    function closeModal() {
      const modal = document.getElementById('editModal');
      const modalContent = modal.querySelector('.modal-content');
      const modalBody = modal.querySelector('.modal-body');

      // スクロール位置を即座にリセット
      if (modalBody) modalBody.scrollTop = 0;
      if (modal) modal.scrollTop = 0;

      // モーダルを閉じる
      modal.classList.remove('active');
      editingRowIndex = null;
      resetSaveButton();

      // 【新アプローチ】閉じた後にDOM再描画でスクロール位置を完全リセット
      setTimeout(() => {
        modalContent.style.display = 'none';
        modalContent.offsetHeight; // 強制リフロー
        modalContent.style.display = '';
        if (modalBody) modalBody.scrollTop = 0;
        if (modal) modal.scrollTop = 0;
      }, 100);
    }

    /**
     * データ保存
     */
    function saveData() {
      const productName = document.getElementById('productNameInput').value.trim();
      const category = getCategoryValue();
      const expenseType = document.querySelector('input[name="expenseType"]:checked').value;
      const supplier = getSupplierValue();
      const productLink = document.getElementById('productLinkInput').value.trim();
      const quantity = parseFloat(document.getElementById('quantityInput').value);
      const price = parseFloat(document.getElementById('priceInput').value);
      const inStock = parseFloat(document.getElementById('inStockInput').value);

      // バリデーション
      if (!productName) {
        showMessage('error', '商品名は必須です');
        return;
      }

      if (isNaN(quantity) || quantity <= 0) {
        showMessage('error', '個数は1以上の数値で入力してください');
        return;
      }

      if (isNaN(price) || price < 0) {
        showMessage('error', '価格は0以上の数値で入力してください');
        return;
      }

      if (isNaN(inStock) || inStock < 0) {
        showMessage('error', '入庫数は0以上の数値で入力してください');
        return;
      }

      // 保存処理開始（即座にボタンにローディング表示）
      const saveButton = document.querySelector('.modal-footer .btn-primary');
      if (saveButton) {
        saveButton.disabled = true;
        saveButton.innerHTML = '<span class="spinner-small"></span> 保存中...';
        saveButton.style.cursor = 'not-allowed';
      }

      // メッセージも表示
      showMessage('info', '保存中...');

      // 編集中のカテゴリを記憶（リロード後に開くため）
      editingCategory = category;

      // 新しい画像が選択されている場合は先にアップロード
      if (selectedImageData) {
        showMessage('info', '画像をアップロード中...');

        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success && result.urls && result.urls.length > 0) {
              // アップロード成功、URLを取得してデータを保存
              saveDataWithImageUrl(result.urls[0].url, productName, category, expenseType, supplier, productLink, quantity, price, inStock);
            } else {
              resetSaveButton();
              showMessage('error', '画像のアップロードに失敗しました: ' + (result.error || '不明なエラー'));
            }
          })
          .withFailureHandler(function(error) {
            resetSaveButton();
            showMessage('error', '画像のアップロードに失敗しました: ' + (error.message || error));
          })
          .uploadImagesToR2({
            images: [{ data: selectedImageData, name: productName + '.jpg' }],
            productId: productName
          });
      } else {
        // 画像がない、または既存URLを使用
        const imageUrl = document.getElementById('imageUrlInput').value.trim();
        saveDataWithImageUrl(imageUrl, productName, category, expenseType, supplier, productLink, quantity, price, inStock);
      }
    }

    /**
     * 画像URL付きでデータを保存
     */
    function saveDataWithImageUrl(imageUrl, productName, category, expenseType, supplier, productLink, quantity, price, inStock) {
      const params = {
        productName: productName,
        category: category,
        expenseType: expenseType,
        supplier: supplier,
        productLink: productLink,
        imageUrl: imageUrl,
        quantity: quantity,
        price: price,
        inStock: inStock
      };

      if (editingRowIndex) {
        // 編集（ローディングは既に表示済み）
        params.rowIndex = editingRowIndex;
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoading();
            closeModal();
            if (result.success) {
              showMessage('success', result.message);
              loadData();
            } else {
              showMessage('error', result.message);
            }
          })
          .withFailureHandler(function(error) {
            hideLoading();
            resetSaveButton();
            showMessage('error', 'エラーが発生しました: ' + (error.message || error));
          })
          .updatePackagingMaterialAPI(params);
      } else {
        // 新規追加（ローディングは既に表示済み）
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoading();
            closeModal();
            if (result.success) {
              showMessage('success', result.message);
              loadData();
            } else {
              showMessage('error', result.message);
            }
          })
          .withFailureHandler(function(error) {
            hideLoading();
            resetSaveButton();
            showMessage('error', 'エラーが発生しました: ' + (error.message || error));
          })
          .addPackagingMaterialAPI(params);
      }
    }

    /**
     * 削除確認
     */
    function confirmDelete(rowIndex, label) {
      if (confirm(`「${label}」を削除してもよろしいですか？`)) {
        // 削除前にカテゴリを記憶（リロード後に開くため）
        const item = packagingMaterials.find(m => m.rowIndex === rowIndex);
        if (item) {
          editingCategory = item.category || 'その他';
        }
        deleteData(rowIndex);
      }
    }

    /**
     * データ削除
     */
    function deleteData(rowIndex) {
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            showMessage('success', result.message);
            loadData();
          } else {
            showMessage('error', result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showMessage('error', 'エラーが発生しました: ' + (error.message || error));
        })
        .deletePackagingMaterialAPI(rowIndex);
    }

    /**
     * メッセージ表示
     */
    function showMessage(type, text) {
      const messageEl = document.getElementById('message');
      messageEl.className = `message ${type} active`;
      messageEl.textContent = text;
      setTimeout(() => {
        messageEl.classList.remove('active');
      }, 5000);
    }

    /**
     * ローディング表示
     */
    function showLoading() {
      const container = document.getElementById('tableContainer');
      container.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>処理中...</p>
        </div>
      `;
    }

    /**
     * ローディング非表示
     */
    function hideLoading() {
      // renderTable()で上書きされるため特に処理不要
    }

    /**
     * HTMLエスケープ
     */
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    /**
     * JavaScript文字列エスケープ（onclick属性内で使用）
     */
    function escapeJs(text) {
      if (!text) return '';
      return String(text)
        .replace(/\\/g, '\\\\')
        .replace(/'/g, "\\'")
        .replace(/"/g, '\\"')
        .replace(/\n/g, '\\n')
        .replace(/\r/g, '\\r');
    }

    // =============================================================================
    // 入庫登録モーダル関連
    // =============================================================================

    /**
     * 入庫登録モーダルを開く
     */
    function openInboundModal() {
      // 資材プルダウンを更新
      const materialSelect = document.getElementById('inboundMaterialSelect');
      materialSelect.innerHTML = '<option value="">選択してください</option>';

      // 全資材を五十音順で追加
      packagingMaterials
        .sort((a, b) => a.productName.localeCompare(b.productName, 'ja'))
        .forEach(material => {
          const option = document.createElement('option');
          option.value = material.productName;
          option.textContent = `${material.productName}（在庫: ${material.inventory}）`;
          materialSelect.appendChild(option);
        });

      // フォームをリセット
      materialSelect.value = '';
      document.getElementById('inboundQuantityInput').value = '1';
      document.getElementById('inboundReasonSelect').value = '新規購入';
      document.getElementById('inboundNoteInput').value = '';
      document.getElementById('inboundRelatedRecordInput').value = '';

      // モーダルを表示
      const modal = document.getElementById('inboundModal');
      const modalContent = modal.querySelector('.modal-content');
      const modalBody = modal.querySelector('.modal-body');

      // スクロール位置をリセット
      if (modalBody) modalBody.scrollTop = 0;
      if (modal) modal.scrollTop = 0;

      modal.classList.add('active');

      // 表示後もスクロール位置を確実にリセット
      requestAnimationFrame(() => {
        if (modalBody) modalBody.scrollTop = 0;
        if (modal) modal.scrollTop = 0;
      });
    }

    /**
     * 入庫登録モーダルを閉じる
     */
    function closeInboundModal() {
      const modal = document.getElementById('inboundModal');
      const modalBody = modal.querySelector('.modal-body');

      // スクロール位置をリセット
      if (modalBody) modalBody.scrollTop = 0;
      if (modal) modal.scrollTop = 0;

      modal.classList.remove('active');
      resetInboundSaveButton();
    }

    /**
     * 入庫登録保存ボタンをリセット
     */
    function resetInboundSaveButton() {
      const saveButton = document.querySelector('#inboundModal .modal-footer .btn-primary');
      if (saveButton) {
        saveButton.disabled = false;
        saveButton.innerHTML = '登録';
        saveButton.style.cursor = 'pointer';
      }
    }

    /**
     * 入庫記録を保存
     */
    function saveInboundRecord() {
      const materialName = document.getElementById('inboundMaterialSelect').value.trim();
      const quantity = parseInt(document.getElementById('inboundQuantityInput').value);
      const reason = document.getElementById('inboundReasonSelect').value;
      const note = document.getElementById('inboundNoteInput').value.trim();
      const relatedRecord = document.getElementById('inboundRelatedRecordInput').value.trim();

      // バリデーション
      if (!materialName) {
        showMessage('error', '梱包資材を選択してください');
        return;
      }

      if (isNaN(quantity) || quantity <= 0) {
        showMessage('error', '入庫数は1以上の数値で入力してください');
        return;
      }

      // 保存処理開始
      const saveButton = document.querySelector('#inboundModal .modal-footer .btn-primary');
      if (saveButton) {
        saveButton.disabled = true;
        saveButton.innerHTML = '<span class="spinner-small"></span> 登録中...';
        saveButton.style.cursor = 'not-allowed';
      }

      showMessage('info', '登録中...');

      // 入庫登録APIを呼び出し（履歴記録 + 在庫更新）
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            closeInboundModal();
            showMessage('success', result.message || '入庫記録を登録しました');
            loadData(); // データ再読み込み
          } else {
            resetInboundSaveButton();
            showMessage('error', result.message || '入庫記録の登録に失敗しました');
          }
        })
        .withFailureHandler(function(error) {
          resetInboundSaveButton();
          showMessage('error', '入庫記録の登録に失敗しました: ' + (error.message || error));
        })
        .registerInboundAPI({
          materialName: materialName,
          quantity: quantity,
          reason: reason,
          relatedSalesRecord: relatedRecord,
          note: note,
          operator: 'ユーザー'
        });
    }

    /**
     * カテゴリカスタム入力の表示切替
     */
    function toggleCategoryCustomInput() {
      const select = document.getElementById('categorySelect');
      const customInput = document.getElementById('categoryCustomInput');

      if (select.value === '__custom__') {
        customInput.style.display = 'block';
      } else {
        customInput.style.display = 'none';
        customInput.value = '';
      }
    }

    /**
     * 発注先カスタム入力の表示切替
     */
    function toggleSupplierCustomInput() {
      const select = document.getElementById('supplierSelect');
      const customInput = document.getElementById('supplierCustomInput');

      if (select.value === '__custom__') {
        customInput.style.display = 'block';
      } else {
        customInput.style.display = 'none';
        customInput.value = '';
      }
    }

    /**
     * カテゴリの値を取得
     */
    function getCategoryValue() {
      const select = document.getElementById('categorySelect');
      const customInput = document.getElementById('categoryCustomInput');

      if (select.value === '__custom__') {
        return customInput.value.trim();
      } else {
        return select.value;
      }
    }

    /**
     * 発注先の値を取得
     */
    function getSupplierValue() {
      const select = document.getElementById('supplierSelect');
      const customInput = document.getElementById('supplierCustomInput');

      if (select.value === '__custom__') {
        return customInput.value.trim();
      } else {
        return select.value;
      }
    }

    /**
     * カテゴリの値を設定
     */
    function setCategoryValue(value) {
      const select = document.getElementById('categorySelect');
      const customInput = document.getElementById('categoryCustomInput');

      // プリセットに存在するか確認
      const options = Array.from(select.options).map(opt => opt.value);
      if (options.includes(value)) {
        select.value = value;
        customInput.style.display = 'none';
        customInput.value = '';
      } else if (value) {
        // カスタム値
        select.value = '__custom__';
        customInput.value = value;
        customInput.style.display = 'block';
      } else {
        select.value = '';
        customInput.style.display = 'none';
        customInput.value = '';
      }
    }

    /**
     * 発注先の値を設定
     */
    function setSupplierValue(value) {
      const select = document.getElementById('supplierSelect');
      const customInput = document.getElementById('supplierCustomInput');

      // プリセットに存在するか確認
      const options = Array.from(select.options).map(opt => opt.value);
      if (options.includes(value)) {
        select.value = value;
        customInput.style.display = 'none';
        customInput.value = '';
      } else if (value) {
        // カスタム値
        select.value = '__custom__';
        customInput.value = value;
        customInput.style.display = 'block';
      } else {
        select.value = '';
        customInput.style.display = 'none';
        customInput.value = '';
      }
    }

  </script>
  </div><!-- /container -->
</body>
</html>
