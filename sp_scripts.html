<script>
  // ==================== ãƒ‡ãƒãƒƒã‚°è¨­å®š ====================
  // æœ¬ç•ªç’°å¢ƒã§ã¯falseã«è¨­å®šã—ã¦ãƒ­ã‚°ã‚’ç„¡åŠ¹åŒ–
  const DEBUG_MODE = true;

  // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  const debug = {
    log: (...args) => { if (DEBUG_MODE) console.log(...args); },
    warn: (...args) => { if (DEBUG_MODE) console.warn(...args); },
    error: (...args) => { console.error(...args); }, // ã‚¨ãƒ©ãƒ¼ã¯å¸¸ã«è¡¨ç¤º
    info: (...args) => { if (DEBUG_MODE) console.info(...args); }
  };

  // ==================== å®šæ•°å®šç¾© ====================
  const NAME_LIMIT = 40;
  const NAME_LIMIT_MODE = 'warn';
  const DESC_LIMIT = 1000;
  const DESC_LIMIT_MODE = 'warn';

  // AIç”Ÿæˆæ–‡ã‚’ä¿å­˜ã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
  let AI_GENERATED_TEXT = '';

  // è¨­å®šãƒã‚¹ã‚¿å…¨ä½“ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  let CACHED_CONFIG = null;

  // ==================== ãƒ†ãƒ¼ãƒã®å³åº§é©ç”¨ï¼ˆã¡ã‚‰ã¤ãé˜²æ­¢ï¼‰ ====================
  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ç›´å¾Œã«LocalStorageã‹ã‚‰ãƒ†ãƒ¼ãƒã‚’å¾©å…ƒ
  (function() {
    try {
      const cachedTheme = localStorage.getItem('rebornTheme');
      if (cachedTheme && cachedTheme !== 'casual') {
        document.body.classList.add('theme-' + cachedTheme);
        console.log('ğŸš€ LocalStorageã‹ã‚‰ãƒ†ãƒ¼ãƒã‚’å³åº§ã«é©ç”¨:', cachedTheme);
      }
    } catch (e) {
      console.warn('LocalStorageã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼:', e);
    }
  })();

  // ãƒ†ãƒ¼ãƒã‚’LocalStorageã«ä¿å­˜
  function saveThemeToLocalStorage(theme) {
    try {
      localStorage.setItem('rebornTheme', theme);
      console.log('ğŸ’¾ ãƒ†ãƒ¼ãƒã‚’LocalStorageã«ä¿å­˜:', theme);
    } catch (e) {
      console.warn('LocalStorageä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
    }
  }

  // è¨­å®šãƒã‚¹ã‚¿å…¨ä½“ã‚’èª­ã¿è¾¼ã‚€
  function loadAllConfig() {
    if (google && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(config) {
          if (config) {
            CACHED_CONFIG = config;
            console.log('è¨­å®šãƒã‚¹ã‚¿å…¨ä½“ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', config);

            // ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ¼ãƒã‚’é©ç”¨
            if (config.ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ) {
              const theme = config.ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ;
              console.log('âœ… ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ¼ãƒã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', theme);

              // LocalStorageã«ä¿å­˜
              saveThemeToLocalStorage(theme);

              // ãƒ†ãƒ¼ãƒã‚¯ãƒ©ã‚¹ã‚’é©ç”¨ï¼ˆLocalStorageã¨ç•°ãªã‚‹å ´åˆã®ã¿ï¼‰
              if (theme !== 'casual') {
                const themeClass = 'theme-' + theme;
                if (!document.body.classList.contains(themeClass)) {
                  document.body.classList.add(themeClass);
                  console.log('âœ… ãƒ†ãƒ¼ãƒã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ :', themeClass);
                }
              } else {
                // ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ†ãƒ¼ãƒã«æˆ»ã™å ´åˆã¯å…¨ãƒ†ãƒ¼ãƒã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
                document.body.classList.remove('theme-modern');
                console.log('â„¹ï¸ ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ†ãƒ¼ãƒï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã‚’ä½¿ç”¨');
              }
            } else {
              console.log('âš ï¸ ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ¼ãƒè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆcasualï¼‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
            }
          }
        })
        .withFailureHandler(function(error) {
          console.error('è¨­å®šãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        })
        .loadConfigMaster();
    }
  }

  // é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼ˆè¨­å®šãƒã‚¹ã‚¿ã‹ã‚‰èª­ã¿è¾¼ã‚€ï¼‰
  let SHIPPING_DEFAULTS = {
    'é…é€æ–™ã®è² æ‹…': 'é€æ–™è¾¼ã¿(å‡ºå“è€…è² æ‹…)',
    'é…é€ã®æ–¹æ³•': 'ã‚†ã†ã‚†ã†ãƒ¡ãƒ«ã‚«ãƒªä¾¿',
    'ç™ºé€å…ƒã®åœ°åŸŸ': 'å²¡å±±çœŒ',
    'ç™ºé€ã¾ã§ã®æ—¥æ•°': '1~2æ—¥ã§ç™ºé€'
  };

  // è¨­å®šãƒã‚¹ã‚¿ã‹ã‚‰é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’èª­ã¿è¾¼ã‚€
  function loadShippingDefaults() {
    if (google && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(config) {
          if (config) {
            SHIPPING_DEFAULTS = config;
            console.log('é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', config);
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’é©ç”¨
            applyShippingDefaults();
          }
        })
        .withFailureHandler(function(error) {
          console.error('é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getShippingDefaults();
    }
  }

  // ä»•å…¥ãƒ»å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼ˆè¨­å®šãƒã‚¹ã‚¿ã‹ã‚‰èª­ã¿è¾¼ã‚€ï¼‰
  let PROCURE_LISTING_DEFAULTS = {
    'ä»•å…¥æ—¥_ä»Šæ—¥': false,
    'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥æ—¥': '',
    'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥å…ˆ': '',
    'å‡ºå“æ—¥_ä»Šæ—¥': false,
    'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“æ—¥': '',
    'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“å…ˆ': ''
  };

  // è¨­å®šãƒã‚¹ã‚¿ã‹ã‚‰ä»•å…¥ãƒ»å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’èª­ã¿è¾¼ã‚€
  function loadProcureListingDefaults() {
    if (google && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(config) {
          if (config) {
            PROCURE_LISTING_DEFAULTS = config;
            console.log('ä»•å…¥ãƒ»å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', config);
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’é©ç”¨
            applyProcureListingDefaults();
          }
        })
        .withFailureHandler(function(error) {
          console.error('ä»•å…¥ãƒ»å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getProcureListingDefaults();
    }
  }
  const REQUIRED = [];
  
  const FIELD_IDS = [
  'ç®¡ç†ç•ªå·','æ‹…å½“è€…',
  'ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰(ã‚«ãƒ†ã‚´ãƒª)','ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰',
  'ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)','ãƒ–ãƒ©ãƒ³ãƒ‰(ã‚«ãƒŠ)',
  'å•†å“å(ã‚¿ã‚¤ãƒˆãƒ«)',
  'å¤§åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)','ä¸­åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)','å°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)','ç´°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)','ç´°åˆ†é¡2',
  'ã‚µã‚¤ã‚º','å•†å“ã®çŠ¶æ…‹',
  'ã‚¢ã‚¤ãƒ†ãƒ å',
  // 'å•†å“ã®èª¬æ˜', // ãƒªã‚»ãƒƒãƒˆæ™‚ã«ã‚¯ãƒªã‚¢ã—ãªã„ï¼ˆupdateDescriptionFromDetailã§æ›´æ–°ï¼‰
  'å•†å“çŠ¶æ…‹è©³ç´°',
  'ã‚µã‚¤ã‚º(è¡¨è¨˜)','ã‚µã‚¤ã‚º(è¡¨è¨˜)_é´','ãã®ä»–ã®ã‚µã‚¤ã‚ºè¡¨è¨˜_é´','æ™®æ®µã®ã‚µã‚¤ã‚º_é´','ãƒ•ã‚£ãƒƒãƒˆæ„Ÿ_é´',
  'è‚©å¹…','èº«å¹…','è¢–ä¸ˆ','ç€ä¸ˆ','ã‚¦ã‚¨ã‚¹ãƒˆ','ãƒ’ãƒƒãƒ—','è‚¡ä¸Š','è‚¡ä¸‹',
  'ä»•å…¥æ—¥','ä»•å…¥å…ˆ','ä»•å…¥é‡‘é¡',
  'å‡ºå“æ—¥','å‡ºå“å…ˆ','å‡ºå“é‡‘é¡',
  'é…é€æ–™ã®è² æ‹…','é…é€ã®æ–¹æ³•','ç™ºé€å…ƒã®åœ°åŸŸ','ç™ºé€ã¾ã§ã®æ—¥æ•°'
];

  let CAT_ROWS = [];
  let BRAND_EN = [];
  let BRAND_KANA = [];
  let MASTER_OPTIONS = {}; // ãƒã‚¹ã‚¿ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä¿å­˜

  // ãƒ–ãƒ©ãƒ³ãƒ‰ãƒšã‚¢ãƒ‡ãƒ¼ã‚¿ï¼ˆè‹±èªåã¨ã‚«ãƒŠèª­ã¿ã®æ­£ç¢ºãªå¯¾å¿œé–¢ä¿‚ï¼‰
  let BRAND_PAIRS = [];

  // ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®é«˜é€Ÿæ¤œç´¢ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒãƒƒãƒ—ï¼ˆãƒšã‚¢ç”¨ï¼‰
  let BRAND_INDEX_MAP = new Map();

  // ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ä¿å­˜ç”¨
  let SALESWORD_DATA = {
    categories: [],
    wordsByCategory: {},
    allWords: []
  };

  // ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºå½¢å¼è¨­å®š
  let SALESWORD_FORMAT = {
    globalPrefix: 'ã€',
    globalSuffix: 'ã€‘',
    wordOverrides: []
  };

  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š
  let defaultSalesword = null;

  // å•†å“çŠ¶æ…‹å±¥æ­´ä¿æŒç”¨
  let CONDITION_HISTORY = [];

  // å•†å“ã®çŠ¶æ…‹åˆ¥ã®ã‚¯ã‚¤ãƒƒã‚¯æŒ¿å…¥ãƒœã‚¿ãƒ³å®šç¾©ï¼ˆè¨­å®šãƒã‚¹ã‚¿ã‹ã‚‰èª­ã¿è¾¼ã‚€ï¼‰
  let CONDITION_BUTTONS = {};

  // å•†å“åãƒ–ãƒ­ãƒƒã‚¯ã®ä¸¦ã³é †ï¼ˆè¨­å®šãƒã‚¹ã‚¿ã‹ã‚‰èª­ã¿è¾¼ã‚€ï¼‰
  let TITLE_BLOCK_ORDER = ['salesword', 'brand', 'item', 'attribute'];

  // è¨­å®šãƒã‚¹ã‚¿ã‹ã‚‰å•†å“åãƒ–ãƒ­ãƒƒã‚¯ã®ä¸¦ã³é †ã‚’èª­ã¿è¾¼ã‚€
  function loadTitleBlockOrder() {
    if (google && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(order) {
          if (order && Array.isArray(order)) {
            // 'item'ãŒå«ã¾ã‚Œã¦ã„ãªã„å¤ã„è¨­å®šã®å ´åˆã¯ã€brandã®å¾Œã«æŒ¿å…¥
            if (!order.includes('item')) {
              const brandIndex = order.indexOf('brand');
              if (brandIndex !== -1) {
                order.splice(brandIndex + 1, 0, 'item');
              } else {
                // brandã‚‚ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé †åºã‚’ä½¿ç”¨
                order = ['salesword', 'brand', 'item', 'attribute'];
              }
              console.log('å•†å“åãƒ–ãƒ­ãƒƒã‚¯ä¸¦ã³é †ã« item ã‚’è¿½åŠ ã—ã¾ã—ãŸ:', order);
              // æ›´æ–°ã—ãŸä¸¦ã³é †ã‚’ä¿å­˜
              saveTitleBlockOrder();
            }
            TITLE_BLOCK_ORDER = order;
            console.log('å•†å“åãƒ–ãƒ­ãƒƒã‚¯ã®ä¸¦ã³é †ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', order);
            applyTitleBlockOrder();
          }
        })
        .withFailureHandler(function(error) {
          console.error('å•†å“åãƒ–ãƒ­ãƒƒã‚¯ä¸¦ã³é †èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getTitleBlockOrder();
    }
  }

  // è¨­å®šãƒã‚¹ã‚¿ã‹ã‚‰å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³ã‚’èª­ã¿è¾¼ã‚€
  function loadConditionButtonsFromConfig() {
    if (google && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(buttons) {
          if (buttons) {
            CONDITION_BUTTONS = buttons;
            console.log('å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', Object.keys(CONDITION_BUTTONS).length, 'ç¨®é¡');
            // æ—¢ã«å•†å“ã®çŠ¶æ…‹ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
            updateConditionButtons();
          }
        })
        .withFailureHandler(function(error) {
          console.error('å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getConditionButtons();
    }
  }

  // ç´ æã‚·ã‚¹ãƒ†ãƒ ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
  let materialCount = 1;
  let MATERIAL_LOCATIONS = [];
  let MATERIAL_TYPES = [];

  // ã‚«ãƒ©ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
  let colorCount = 1;
  let COLOR_OPTIONS = [];

  // ç´ æãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¨è¨­å®š
  function initializeMaterialMasters() {
    if (google && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(opts) {
          MATERIAL_LOCATIONS = opts['ç´ æ(ç®‡æ‰€)'] || [];
          MATERIAL_TYPES = opts['ç´ æ(ç¨®é¡)'] || [];

          populateMaterialSelects(1);

          console.log('ç´ æãƒã‚¹ã‚¿å–å¾—å®Œäº† - ç®‡æ‰€:', MATERIAL_LOCATIONS.length, 'ç¨®é¡:', MATERIAL_TYPES.length);
        })
        .withFailureHandler(function(error) {
          console.error('ç´ æãƒã‚¹ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getMasterOptions();
    }
  }

  // ã‚«ãƒ©ãƒ¼ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¨è¨­å®š
  function initializeColorMasters() {
    if (google && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(opts) {
          COLOR_OPTIONS = opts['ã‚«ãƒ©ãƒ¼/é…è‰²/ãƒˆãƒ¼ãƒ³'] || [];

          populateColorSelect(1);

          console.log('ã‚«ãƒ©ãƒ¼ãƒã‚¹ã‚¿å–å¾—å®Œäº†:', COLOR_OPTIONS.length);
        })
        .withFailureHandler(function(error) {
          console.error('ã‚«ãƒ©ãƒ¼ãƒã‚¹ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getMasterOptions();
    }
  }

  // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
  function populateMaterialSelects(index) {
    const locationSelect = document.getElementById(`ç´ æ${index}_ç®‡æ‰€`);
    const type1Select = document.getElementById(`ç´ æ${index}_ç¨®é¡1`);
    const type2Select = document.getElementById(`ç´ æ${index}_ç¨®é¡2`);
    const percent1Select = document.getElementById(`ç´ æ${index}_ï¼…1`);
    const percent2Select = document.getElementById(`ç´ æ${index}_ï¼…2`);

    if (locationSelect) {
      locationSelect.innerHTML = '<option value="">--</option>';
      MATERIAL_LOCATIONS.forEach(loc => {
        locationSelect.insertAdjacentHTML('beforeend', `<option value="${loc}">${loc}</option>`);
      });
    }

    if (type1Select) {
      type1Select.innerHTML = '<option value="">--</option>';
      MATERIAL_TYPES.forEach(type => {
        type1Select.insertAdjacentHTML('beforeend', `<option value="${type}">${type}</option>`);
      });
    }

    if (type2Select) {
      type2Select.innerHTML = '<option value="">--</option>';
      MATERIAL_TYPES.forEach(type => {
        type2Select.insertAdjacentHTML('beforeend', `<option value="${type}">${type}</option>`);
      });
    }

    // å‰²åˆã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’0-100ã§åˆæœŸåŒ–
    if (percent1Select) {
      percent1Select.innerHTML = '<option value="">--%</option>';
      for (let i = 0; i <= 100; i++) {
        percent1Select.insertAdjacentHTML('beforeend', `<option value="${i}">${i}%</option>`);
      }
    }

    if (percent2Select) {
      percent2Select.innerHTML = '<option value="">--%</option>';
      for (let i = 0; i <= 100; i++) {
        percent2Select.insertAdjacentHTML('beforeend', `<option value="${i}">${i}%</option>`);
      }
    }
  }

  // ç´ æã‚»ãƒƒãƒˆã‚’è¿½åŠ 
  function addMaterial() {
    if (materialCount >= 10) {
      alert('ç´ æã¯æœ€å¤§10å€‹ã¾ã§è¿½åŠ ã§ãã¾ã™');
      return;
    }

    materialCount++;

    const materialList = document.getElementById('materialList');
    const newItem = document.createElement('div');
    newItem.className = 'material-item';
    newItem.setAttribute('data-index', materialCount);

    newItem.innerHTML = `
      <div class="material-header">
        <span>ç´ æ ${materialCount}</span>
        <button type="button" class="remove-material-btn" onclick="removeMaterial(${materialCount})">å‰Šé™¤</button>
      </div>
      
      <div class="material-fields">
        <label>ç®‡æ‰€:
          <select id="ç´ æ${materialCount}_ç®‡æ‰€" class="material-location">
            <option value="">--</option>
          </select>
        </label>
        
        <div class="material-composition">
          <div class="composition-row">
            <label>ç¨®é¡:
              <select id="ç´ æ${materialCount}_ç¨®é¡1" class="material-type">
                <option value="">--</option>
              </select>
            </label>
            <label>å‰²åˆ:
              <select id="ç´ æ${materialCount}_ï¼…1" class="material-percent">
                <option value="">--%</option>
              </select>
            </label>
          </div>

          <div class="composition-row">
            <label>ç¨®é¡:
              <select id="ç´ æ${materialCount}_ç¨®é¡2" class="material-type">
                <option value="">--</option>
              </select>
            </label>
            <label>å‰²åˆ:
              <select id="ç´ æ${materialCount}_ï¼…2" class="material-percent">
                <option value="">--%</option>
              </select>
            </label>
          </div>
        </div>
      </div>
    `;

    materialList.appendChild(newItem);
    populateMaterialSelects(materialCount);
    updateRemoveButtons();
  }

  // ç´ æã‚»ãƒƒãƒˆã‚’å‰Šé™¤
  function removeMaterial(index) {
    const item = document.querySelector(`.material-item[data-index="${index}"]`);
    if (item) {
      item.remove();

      const items = document.querySelectorAll('.material-item');
      materialCount = items.length;

      items.forEach((item, i) => {
        const newIndex = i + 1;
        item.setAttribute('data-index', newIndex);
        item.querySelector('.material-header span').textContent = `ç´ æ ${newIndex}`;

        // onclickã‚‚æ›´æ–°
        const removeBtn = item.querySelector('.remove-material-btn');
        if (removeBtn) {
          removeBtn.onclick = () => removeMaterial(newIndex);
        }
      });

      updateRemoveButtons();
      updateDescriptionFromDetail(); // ç´ ææƒ…å ±æ›´æ–°
    }
  }

  // å‰Šé™¤ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
  function updateRemoveButtons() {
    const items = document.querySelectorAll('.material-item');
    items.forEach(item => {
      const btn = item.querySelector('.remove-material-btn');
      if (btn) {
        btn.style.display = items.length > 1 ? 'block' : 'none';
      }
    });
  }

  // ========== ã‚«ãƒ©ãƒ¼å‹•çš„è¿½åŠ æ©Ÿèƒ½ ==========

  // ã‚«ãƒ©ãƒ¼ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
  function populateColorSelect(index) {
    const colorSelect = document.getElementById(`ã‚«ãƒ©ãƒ¼${index}`);

    if (colorSelect) {
      colorSelect.innerHTML = '<option value="">--</option>';
      COLOR_OPTIONS.forEach(color => {
        colorSelect.insertAdjacentHTML('beforeend', `<option value="${color}">${color}</option>`);
      });

      // å¤‰æ›´æ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
      colorSelect.addEventListener('change', updateDescriptionFromDetail);
    }
  }

  // ã‚«ãƒ©ãƒ¼ã‚’è¿½åŠ 
  function addColor() {
    if (colorCount >= 5) {
      alert('ã‚«ãƒ©ãƒ¼ã¯æœ€å¤§5å€‹ã¾ã§è¿½åŠ ã§ãã¾ã™');
      return;
    }

    colorCount++;

    const colorList = document.getElementById('colorList');
    const newItem = document.createElement('div');
    newItem.className = 'color-item';
    newItem.setAttribute('data-index', colorCount);

    newItem.innerHTML = `
      <div class="color-header">
        <span>ã‚«ãƒ©ãƒ¼ ${colorCount}</span>
        <button type="button" class="remove-color-btn" onclick="removeColor(${colorCount})">å‰Šé™¤</button>
      </div>

      <div class="color-fields">
        <label>è‰²:
          <select id="ã‚«ãƒ©ãƒ¼${colorCount}" class="color-select">
            <option value="">--</option>
          </select>
        </label>
      </div>
    `;

    colorList.appendChild(newItem);
    populateColorSelect(colorCount);
    updateColorRemoveButtons();
  }

  // ã‚«ãƒ©ãƒ¼ã‚’å‰Šé™¤
  function removeColor(index) {
    const item = document.querySelector(`.color-item[data-index="${index}"]`);
    if (item) {
      item.remove();

      const items = document.querySelectorAll('.color-item');
      colorCount = items.length;

      items.forEach((item, i) => {
        const newIndex = i + 1;
        item.setAttribute('data-index', newIndex);
        item.querySelector('.color-header span').textContent = `ã‚«ãƒ©ãƒ¼ ${newIndex}`;

        // onclickã‚‚æ›´æ–°
        const removeBtn = item.querySelector('.remove-color-btn');
        if (removeBtn) {
          removeBtn.onclick = () => removeColor(newIndex);
        }

        // selectã®IDã‚‚æ›´æ–°
        const select = item.querySelector('.color-select');
        if (select) {
          const oldId = select.id;
          const oldValue = select.value;
          select.id = `ã‚«ãƒ©ãƒ¼${newIndex}`;
          select.value = oldValue; // é¸æŠå€¤ã‚’ä¿æŒ
        }
      });

      updateColorRemoveButtons();
      updateDescriptionFromDetail(); // ã‚«ãƒ©ãƒ¼æƒ…å ±æ›´æ–°
    }
  }

  // ã‚«ãƒ©ãƒ¼å‰Šé™¤ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
  function updateColorRemoveButtons() {
    const items = document.querySelectorAll('.color-item');
    items.forEach(item => {
      const btn = item.querySelector('.remove-color-btn');
      if (btn) {
        btn.style.display = items.length > 1 ? 'block' : 'none';
      }
    });
  }

  // ========== å•†å“å±æ€§å‹•çš„è¿½åŠ æ©Ÿèƒ½ ==========
  let attributeCount = 1;

  // ã‚«ãƒ†ã‚´ãƒªã®é¸æŠè‚¢ã‚’ç”Ÿæˆ
  function getAttributeCategoryOptions() {
    const categories = [
      'ç”Ÿåœ°ãƒ»ç´ æãƒ»è³ªæ„Ÿç³»', 'å­£ç¯€æ„Ÿãƒ»æ©Ÿèƒ½æ€§', 'ç€ç”¨ã‚·ãƒ¼ãƒ³ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆ', 'è¦‹ãŸç›®ãƒ»å°è±¡',
      'ãƒˆãƒ¬ãƒ³ãƒ‰è¡¨ç¾', 'ã‚µã‚¤ã‚ºæ„Ÿãƒ»ä½“å‹ã‚«ãƒãƒ¼', 'å¹´ä»£ãƒ»ãƒ†ã‚¤ã‚¹ãƒˆãƒ»ã‚¹ã‚¿ã‚¤ãƒ«', 'ã‚«ãƒ©ãƒ¼/é…è‰²/ãƒˆãƒ¼ãƒ³',
      'æŸ„ãƒ»æ¨¡æ§˜', 'ãƒ‡ã‚£ãƒ†ãƒ¼ãƒ«ãƒ»ä»•æ§˜', 'ã‚·ãƒ«ã‚¨ãƒƒãƒˆ/ãƒ©ã‚¤ãƒ³', 'ãƒãƒƒã‚¯ãƒ©ã‚¤ãƒ³',
      'è¥Ÿãƒ»è¡¿', 'è¢–ãƒ»è¢–ä»˜ã‘', 'ä¸ˆ', 'é©/åŠ å·¥', 'æ¯›çš®/åŠ å·¥', 'ç”Ÿç”£å›½'
    ];
    let options = '<option value="">--é¸æŠã—ã¦ãã ã•ã„--</option>';
    categories.forEach(cat => {
      options += `<option value="${cat}">${cat}</option>`;
    });
    return options;
  }

  // å•†å“å±æ€§ã®ã‚«ãƒ†ã‚´ãƒªãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«é¸æŠè‚¢ã‚’è¨­å®š
  function populateAttributeCategory(index) {
    const categorySelect = document.getElementById(`å•†å“å±æ€§${index}_ã‚«ãƒ†ã‚´ãƒª`);
    if (categorySelect) {
      categorySelect.innerHTML = getAttributeCategoryOptions();
    }
  }

  // å•†å“å±æ€§ã‚»ãƒƒãƒˆã‚’è¿½åŠ 
  function addAttribute() {
    if (attributeCount >= 10) {
      alert('å•†å“å±æ€§ã¯æœ€å¤§10å€‹ã¾ã§è¿½åŠ ã§ãã¾ã™');
      return;
    }

    attributeCount++;

    const attributeList = document.getElementById('attributeList');
    const newItem = document.createElement('div');
    newItem.className = 'attribute-item';
    newItem.setAttribute('data-index', attributeCount);

    newItem.innerHTML = `
      <div class="attribute-header">
        <span>å±æ€§ ${attributeCount}</span>
        <button type="button" class="remove-attribute-btn" onclick="removeProductAttribute(${attributeCount})">å‰Šé™¤</button>
      </div>

      <div class="row" style="margin-top: 6px;">
        <div>
          <label>ã‚«ãƒ†ã‚´ãƒª</label>
          <select id="å•†å“å±æ€§${attributeCount}_ã‚«ãƒ†ã‚´ãƒª">
            <option value="">--é¸æŠã—ã¦ãã ã•ã„--</option>
          </select>
        </div>
        <div>
          <label>å€¤</label>
          <select id="å•†å“å±æ€§${attributeCount}_å€¤" disabled>
            <option value="">--ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„--</option>
          </select>
        </div>
      </div>
    `;

    attributeList.appendChild(newItem);
    populateAttributeCategory(attributeCount);
    setupAttributeSelector(attributeCount);
    updateAttributeRemoveButtons();
    updateAttributeFields();
  }

  // å•†å“å±æ€§ã‚»ãƒƒãƒˆã‚’å‰Šé™¤
  function removeProductAttribute(index) {
    const item = document.querySelector(`.attribute-item[data-index="${index}"]`);
    if (item) {
      item.remove();

      const items = document.querySelectorAll('.attribute-item');
      attributeCount = items.length;

      items.forEach((item, i) => {
        const newIndex = i + 1;
        item.setAttribute('data-index', newIndex);
        item.querySelector('.attribute-header span').textContent = `å±æ€§ ${newIndex}`;

        // onclickã‚‚æ›´æ–°
        const removeBtn = item.querySelector('.remove-attribute-btn');
        if (removeBtn) {
          removeBtn.onclick = () => removeProductAttribute(newIndex);
        }
      });

      updateAttributeRemoveButtons();
      updateAttributeFields();
      updateNamePreview();
    }
  }

  // å‰Šé™¤ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
  function updateAttributeRemoveButtons() {
    const items = document.querySelectorAll('.attribute-item');
    items.forEach(item => {
      const btn = item.querySelector('.remove-attribute-btn');
      if (btn) {
        btn.style.display = (items.length > 1) ? 'block' : 'none';
      }
    });
  }

  // NAME_REST_FIELDSé…åˆ—ã‚’æ›´æ–°ï¼ˆå•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ï¼‰
  function updateAttributeFields() {
    const items = document.querySelectorAll('.attribute-item');
    NAME_REST_FIELDS.length = 0; // é…åˆ—ã‚’ã‚¯ãƒªã‚¢
    items.forEach((item, i) => {
      NAME_REST_FIELDS.push(`å•†å“å±æ€§${i + 1}_å€¤`);
    });
  }

  // å˜ä¸€ã®å•†å“å±æ€§ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  function setupAttributeSelector(index) {
    const categorySelect = document.getElementById(`å•†å“å±æ€§${index}_ã‚«ãƒ†ã‚´ãƒª`);
    const valueSelect = document.getElementById(`å•†å“å±æ€§${index}_å€¤`);

    if (categorySelect && valueSelect) {
      categorySelect.addEventListener('change', function() {
        updateAttributeValues(`å•†å“å±æ€§${index}_ã‚«ãƒ†ã‚´ãƒª`, `å•†å“å±æ€§${index}_å€¤`);
      });

      valueSelect.addEventListener('change', updateNamePreview);
    }
  }

  // å•†å“ã®çŠ¶æ…‹ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºåˆ‡æ›¿
  function updateConditionButtons() {
    const conditionSelect = document.getElementById('å•†å“ã®çŠ¶æ…‹');
    const container = document.getElementById('quickInsertButtonsContainer');

    if (!conditionSelect || !container) {
      console.log('å•†å“ã®çŠ¶æ…‹ã¾ãŸã¯ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    const conditionValue = conditionSelect.value;
    const buttons = CONDITION_BUTTONS[conditionValue] || [];

    // ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
    container.innerHTML = '';

    // ãƒœã‚¿ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯éè¡¨ç¤º
    if (buttons.length === 0) {
      container.style.display = 'none';
      return;
    }

    container.style.display = '';

    // ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
    buttons.forEach(btn => {
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'quick-btn';
      button.textContent = btn.label;
      button.setAttribute('data-text', btn.text);

      // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
      button.addEventListener('click', function() {
        const textarea = document.getElementById('å•†å“çŠ¶æ…‹è©³ç´°');
        if (!textarea) return;

        const text = this.getAttribute('data-text');

        // ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨å¸¸ã«ç½®ãæ›ãˆï¼ˆä¸Šæ›¸ãï¼‰
        textarea.value = text;

        // å•†å“ã®èª¬æ˜ã‚’æ›´æ–°
        if (typeof updateDescriptionFromDetail === 'function') {
          updateDescriptionFromDetail();
        }
      });

      container.appendChild(button);
    });

    console.log('ã‚¯ã‚¤ãƒƒã‚¯æŒ¿å…¥ãƒœã‚¿ãƒ³è¡¨ç¤ºæ›´æ–°:', buttons.length, 'å€‹');
  }

  // ã‚¯ã‚¤ãƒƒã‚¯æŒ¿å…¥ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
  function setupQuickInsertButtons() {
    // åˆæœŸåŒ–æ™‚ã«å•†å“ã®çŠ¶æ…‹ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    updateConditionButtons();
    console.log('ã‚¯ã‚¤ãƒƒã‚¯æŒ¿å…¥ãƒœã‚¿ãƒ³åˆæœŸåŒ–å®Œäº†');
  }

  // å•†å“çŠ¶æ…‹è©³ç´°ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆæ©Ÿèƒ½
  function attachConditionSuggest(inputId, list) {
    const input = document.getElementById(inputId);
    const panel = document.getElementById('suggest-' + inputId);

    if (!input || !panel) {
      console.log(`å•†å“çŠ¶æ…‹è©³ç´°ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ: è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ ${inputId}`);
      return;
    }

    let activeIndex = -1;
    const limit = 10;

    const render = (items) => {
      panel.innerHTML = '';
      if (!items.length) {
        panel.innerHTML = '<div class="sug-empty">å€™è£œãªã—</div>';
        panel.hidden = false;
        return;
      }

      items.slice(0, limit).forEach((v, i) => {
        const div = document.createElement('div');
        div.className = 'sug-item';
        div.textContent = v;

        div.addEventListener('mousemove', () => {
          Array.from(panel.querySelectorAll('.sug-item')).forEach(x => x.classList.remove('active'));
          div.classList.add('active');
          activeIndex = i;
        });

        div.addEventListener('mousedown', (e) => {
          e.preventDefault();
        });

        div.addEventListener('click', () => {
          input.value = v;
          hide();
          if (typeof updateDescriptionFromDetail === 'function') {
            updateDescriptionFromDetail();
          }
        });

        panel.appendChild(div);
      });

      panel.hidden = false;
    };

    const hide = () => {
      panel.hidden = true;
      activeIndex = -1;
    };

    const hideLater = () => setTimeout(hide, 100);

    const doFilter = () => {
      const q = (input.value || '').trim();

      if (!Array.isArray(list) || list.length === 0 || !q || q.length < 2) {
        hide();
        return;
      }

      // éƒ¨åˆ†ä¸€è‡´æ¤œç´¢ï¼ˆå¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥ã—ãªã„ï¼‰
      const qq = q.toLowerCase();
      const filtered = list.filter(v => {
        const s = String(v).toLowerCase();
        return s.indexOf(qq) !== -1;
      });

      console.log(`å•†å“çŠ¶æ…‹è©³ç´°å€™è£œ: ${filtered.length}ä»¶`);
      render(filtered);
    };

    input.addEventListener('input', doFilter);
    input.addEventListener('focus', doFilter);
    input.addEventListener('blur', hideLater);

    input.addEventListener('keydown', (e) => {
      if (panel.hidden) return;
      const items = Array.from(panel.querySelectorAll('.sug-item'));
      if (!items.length) return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        activeIndex = (activeIndex + 1) % items.length;
        items.forEach(x => x.classList.remove('active'));
        items[activeIndex].classList.add('active');
        items[activeIndex].scrollIntoView({ block: 'nearest' });
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        activeIndex = (activeIndex - 1 + items.length) % items.length;
        items.forEach(x => x.classList.remove('active'));
        items[activeIndex].classList.add('active');
        items[activeIndex].scrollIntoView({ block: 'nearest' });
      } else if (e.key === 'Enter') {
        if (activeIndex >= 0) {
          e.preventDefault();
          input.value = items[activeIndex].textContent || '';
          hide();
          if (typeof updateDescriptionFromDetail === 'function') {
            updateDescriptionFromDetail();
          }
        }
      } else if (e.key === 'Escape') {
        hide();
      }
    });

    console.log('å•†å“çŠ¶æ…‹è©³ç´°ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆè¨­å®šå®Œäº†');
  }

  // ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°è¨­å®šï¼ˆè¨­å®šãƒã‚¹ã‚¿ã‹ã‚‰èª­ã¿è¾¼ã‚€ï¼‰
  let HASHTAG_CONFIG = {
    å…¨å•†å“ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹: '#REBORN_',
    å…¨å•†å“ãƒ†ã‚­ã‚¹ãƒˆ: 'å…¨å•†å“',
    ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹: '#REBORN_',
    ãƒ–ãƒ©ãƒ³ãƒ‰ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹: 'ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§',
    ã‚«ãƒ†ã‚´ãƒªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹: '#REBORN_',
    ã‚«ãƒ†ã‚´ãƒªã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹: 'ä¸€è¦§'
  };

  // è¨­å®šãƒã‚¹ã‚¿ã‹ã‚‰ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°è¨­å®šã‚’èª­ã¿è¾¼ã‚€
  function loadHashtagConfig() {
    if (google && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(config) {
          if (config) {
            HASHTAG_CONFIG = config;
            console.log('ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', config);
            // ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆ
            renderHashtagCheckboxes();
            // è¨­å®šèª­ã¿è¾¼ã¿å¾Œã€å•†å“ã®èª¬æ˜ã‚’æ›´æ–°
            if (typeof updateDescriptionFromDetail === 'function') {
              updateDescriptionFromDetail();
            }
          }
        })
        .withFailureHandler(function(error) {
          console.error('ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getHashtagConfig();
    }
  }

  /**
   * ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆ
   */
  function renderHashtagCheckboxes() {
    console.log('renderHashtagCheckboxes ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ');
    const container = document.getElementById('hashtagCheckboxContainer');
    if (!container) {
      console.error('hashtagCheckboxContainer ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    container.innerHTML = '';

    console.log('HASHTAG_CONFIG:', HASHTAG_CONFIG);
    if (!HASHTAG_CONFIG || !HASHTAG_CONFIG.hashtags || HASHTAG_CONFIG.hashtags.length === 0) {
      console.warn('ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°è¨­å®šãŒç©ºã§ã™');
      container.innerHTML = '<div style="font-size: 11px; color: #6b7280; text-align: center;">ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°è¨­å®šãŒã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }

    const hashtags = HASHTAG_CONFIG.hashtags;
    const commonPrefix = HASHTAG_CONFIG.commonPrefix || '#';

    hashtags.forEach((hashtag, index) => {
      const title = hashtag.title || '';
      const icon = hashtag.icon || 'ğŸ·ï¸';
      const suffix = hashtag.suffix || '';

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆï¼ˆå®Ÿéš›ã®å€¤ã¯å•†å“ç™»éŒ²æ™‚ã«å‹•çš„ã«å¤‰ã‚ã‚‹ï¼‰
      let previewText = '';
      if (title === 'å…¨å•†å“') {
        previewText = `${commonPrefix}${suffix}`;
      } else if (title === 'ãƒ–ãƒ©ãƒ³ãƒ‰') {
        previewText = `${commonPrefix}ãƒ–ãƒ©ãƒ³ãƒ‰å${suffix}`;
      } else if (title === 'ã‚«ãƒ†ã‚´ãƒª') {
        const categoryOptions = hashtag.categoryOptions || [];
        const categoryPreview = categoryOptions.join('+');
        previewText = `${commonPrefix}${categoryPreview}${suffix}`;
      } else {
        previewText = `${commonPrefix}${suffix}`;
      }

      const checkboxId = `hashtag-checkbox-${index}`;

      console.log(`Creating checkbox ${index}:`, {title, icon, previewText});

      // ã‚·ãƒ³ãƒ—ãƒ«ã«1è¡Œã§è¡¨ç¤º
      const label = document.createElement('label');
      label.style.cssText = 'display: block; cursor: pointer; padding: 6px 4px; border-bottom: 1px solid #e5e7eb;';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = checkboxId;
      checkbox.setAttribute('data-index', index);
      checkbox.checked = true;
      checkbox.onchange = updateDescriptionFromDetail;
      checkbox.style.cssText = 'cursor: pointer; margin-right: 6px; vertical-align: middle;';

      const textSpan = document.createElement('span');
      textSpan.style.cssText = 'font-size: 11px; color: #374151; vertical-align: middle;';
      textSpan.textContent = previewText;

      label.appendChild(checkbox);
      label.appendChild(textSpan);

      container.appendChild(label);
    });

    // ç”Ÿæˆå¾Œã®DOMã‚’ç¢ºèª
    console.log('ç”Ÿæˆã•ã‚ŒãŸHTML:', container.innerHTML);
    console.log('ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã®å­è¦ç´ æ•°:', container.children.length);
  }

  /**
   * æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½
   */
  function toggleCollapse(sectionId) {
    const section = document.getElementById(sectionId);
    const toggleIcon = document.getElementById(sectionId.replace('Section', 'Toggle'));

    if (section && toggleIcon) {
      const isHidden = section.style.display === 'none';
      section.style.display = isHidden ? 'block' : 'none';
      toggleIcon.textContent = isHidden ? 'â–²' : 'â–¼';
    }
  }

  /**
   * å‰²å¼•æƒ…å ±ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å‹•çš„ç”Ÿæˆ
   */
  function renderDiscountCheckboxes() {
    console.log('renderDiscountCheckboxes ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ');
    const container = document.getElementById('discountCheckboxContainer');
    if (!container) {
      console.error('discountCheckboxContainer ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    container.innerHTML = '';

    console.log('DISCOUNT_CONFIG:', DISCOUNT_CONFIG);
    if (!DISCOUNT_CONFIG) {
      console.warn('å‰²å¼•è¨­å®šãŒç©ºã§ã™');
      container.innerHTML = '<div style="font-size: 11px; color: #6b7280; text-align: center;">å‰²å¼•è¨­å®šãŒã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }

    const discounts = [];

    // ãƒ•ã‚©ãƒ­ãƒ¼å‰²
    if (DISCOUNT_CONFIG['ãƒ•ã‚©ãƒ­ãƒ¼å‰²'] && DISCOUNT_CONFIG['ãƒ•ã‚©ãƒ­ãƒ¼å‰²'].length > 0) {
      discounts.push({
        id: 'follow',
        label: 'ãƒ•ã‚©ãƒ­ãƒ¼å‰²',
        icon: 'ğŸ‘¥'
      });
    }

    // ãƒªãƒ”ãƒ¼ãƒˆå‰²
    if (DISCOUNT_CONFIG['ãƒªãƒ”ãƒ¼ãƒˆå‰²'] && DISCOUNT_CONFIG['ãƒªãƒ”ãƒ¼ãƒˆå‰²'].length > 0) {
      discounts.push({
        id: 'repeat',
        label: 'ãƒªãƒ”ãƒ¼ãƒˆå‰²',
        icon: 'ğŸ”'
      });
    }

    // ã¾ã¨ã‚å‰²
    if (DISCOUNT_CONFIG['ã¾ã¨ã‚å‰²'] && DISCOUNT_CONFIG['ã¾ã¨ã‚å‰²'].length > 0) {
      discounts.push({
        id: 'matome',
        label: 'ã¾ã¨ã‚å‰²',
        icon: 'ğŸ“¦'
      });
    }

    if (discounts.length === 0) {
      container.innerHTML = '<div style="font-size: 11px; color: #6b7280; text-align: center;">å‰²å¼•è¨­å®šãŒã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }

    // ãƒ†ãƒ¼ãƒãƒã‚§ãƒƒã‚¯: ãƒ¢ãƒ€ãƒ³ãƒ†ãƒ¼ãƒã®å ´åˆã¯çµµæ–‡å­—ã‚’è¡¨ç¤ºã—ãªã„
    const isModernTheme = document.body.classList.contains('theme-modern');

    discounts.forEach((discount, index) => {
      const checkboxId = `discount-checkbox-${discount.id}`;

      const label = document.createElement('label');
      label.style.cssText = 'display: block; cursor: pointer; padding: 6px 4px; border-bottom: 1px solid #e5e7eb;';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = checkboxId;
      checkbox.setAttribute('data-discount-type', discount.id);
      checkbox.checked = true;
      checkbox.onchange = updateDescriptionFromDetail;
      checkbox.style.cssText = 'cursor: pointer; margin-right: 6px; vertical-align: middle;';

      const textSpan = document.createElement('span');
      textSpan.style.cssText = 'font-size: 11px; color: #374151; vertical-align: middle;';
      textSpan.textContent = isModernTheme ? discount.label : `${discount.icon} ${discount.label}`;

      label.appendChild(checkbox);
      label.appendChild(textSpan);

      container.appendChild(label);
    });

    console.log('å‰²å¼•æƒ…å ±ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ç”Ÿæˆå®Œäº†:', discounts.length);
  }

  /**
   * ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
   */
  function updateHashtagCheckboxPreviews() {
    if (!HASHTAG_CONFIG || !HASHTAG_CONFIG.hashtags) return;

    const hashtags = HASHTAG_CONFIG.hashtags;
    const commonPrefix = HASHTAG_CONFIG.commonPrefix || '#';

    hashtags.forEach((hashtag, index) => {
      const previewElement = document.getElementById(`hashtag-preview-${index}`);
      if (!previewElement) return;

      const title = hashtag.title || '';
      const suffix = hashtag.suffix || '';
      let previewText = '';

      if (title === 'å…¨å•†å“') {
        previewText = `${commonPrefix}${suffix}`;
      } else if (title === 'ãƒ–ãƒ©ãƒ³ãƒ‰') {
        const brandEn = _val('ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)');
        const brandKana = _val('ãƒ–ãƒ©ãƒ³ãƒ‰(ã‚«ãƒŠ)');
        const brand = brandEn || brandKana;
        if (brand) {
          const cleanBrand = brand.replace(/\s+/g, '');
          previewText = `${commonPrefix}${cleanBrand}${suffix}`;
        } else {
          previewText = `${commonPrefix}ãƒ–ãƒ©ãƒ³ãƒ‰å${suffix}`;
        }
      } else if (title === 'ã‚«ãƒ†ã‚´ãƒª') {
        const categoryOptions = hashtag.categoryOptions || [];
        const categoryMap = {
          'å¤§åˆ†é¡': _val('å¤§åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)'),
          'ä¸­åˆ†é¡': _val('ä¸­åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)'),
          'å°åˆ†é¡': _val('å°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)'),
          'ç´°åˆ†é¡1': _val('ç´°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)'),
          'ç´°åˆ†é¡2': _val('ç´°åˆ†é¡2'),
          'ã‚¢ã‚¤ãƒ†ãƒ å': _val('ã‚¢ã‚¤ãƒ†ãƒ å')
        };

        const categoryParts = [];
        categoryOptions.forEach(optionName => {
          const value = categoryMap[optionName];
          if (value) {
            categoryParts.push(value);
          }
        });

        if (categoryParts.length > 0) {
          previewText = `${commonPrefix}${categoryParts.join('')}${suffix}`;
        } else {
          const categoryPreview = categoryOptions.join('+');
          previewText = `${commonPrefix}${categoryPreview}${suffix}`;
        }
      } else {
        previewText = `${commonPrefix}${suffix}`;
      }

      previewElement.textContent = previewText;
    });
  }

  // å‰²å¼•æƒ…å ±è¨­å®šï¼ˆè¨­å®šãƒã‚¹ã‚¿ã‹ã‚‰èª­ã¿è¾¼ã‚€ï¼‰
  let DISCOUNT_CONFIG = {
    'ãƒ•ã‚©ãƒ­ãƒ¼å‰²': [
      { ç¯„å›²: 'ã€œ2,999å††', å‰²å¼•é¡: '100å††å¼•' },
      { ç¯„å›²: 'ã€œ5,999å††', å‰²å¼•é¡: '200å††å¼•' },
      { ç¯„å›²: 'ã€œ8,999å††', å‰²å¼•é¡: '300å††å¼•' },
      { ç¯„å›²: '9,000å††ã€œ', å‰²å¼•é¡: '500å††å¼•' }
    ],
    'ãƒªãƒ”ãƒ¼ãƒˆå‰²': [
      { ç¯„å›²: '', å‰²å¼•é¡: '200å††å¼•' }
    ],
    'ã¾ã¨ã‚å‰²': [
      { ç¯„å›²: '2ç‚¹', å‰²å¼•é¡: '300å††' },
      { ç¯„å›²: '3ç‚¹', å‰²å¼•é¡: '500å††' },
      { ç¯„å›²: '4ç‚¹', å‰²å¼•é¡: '1,000å††' }
    ]
  };

  // è¨­å®šãƒã‚¹ã‚¿ã‹ã‚‰å‰²å¼•æƒ…å ±ã‚’èª­ã¿è¾¼ã‚€
  function loadDiscountConfig() {
    if (google && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(config) {
          if (config) {
            DISCOUNT_CONFIG = config;
            console.log('å‰²å¼•æƒ…å ±è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', Object.keys(config).length, 'ç¨®é¡');
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆ
            renderDiscountCheckboxes();
            // è¨­å®šèª­ã¿è¾¼ã¿å¾Œã€å•†å“ã®èª¬æ˜ã‚’æ›´æ–°
            if (typeof updateDescriptionFromDetail === 'function') {
              updateDescriptionFromDetail();
            }
          }
        })
        .withFailureHandler(function(error) {
          console.error('å‰²å¼•æƒ…å ±è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getDiscountConfig();
    }
  }

  // å‰²å¼•æƒ…å ±ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å¯¾å¿œç‰ˆï¼‰
  function generateDiscountInfo() {
    // å‰²å¼•æƒ…å ±ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const hasFollow = DISCOUNT_CONFIG['ãƒ•ã‚©ãƒ­ãƒ¼å‰²'] && DISCOUNT_CONFIG['ãƒ•ã‚©ãƒ­ãƒ¼å‰²'].length > 0;
    const hasRepeat = DISCOUNT_CONFIG['ãƒªãƒ”ãƒ¼ãƒˆå‰²'] && DISCOUNT_CONFIG['ãƒªãƒ”ãƒ¼ãƒˆå‰²'].length > 0;
    const hasMatome = DISCOUNT_CONFIG['ã¾ã¨ã‚å‰²'] && DISCOUNT_CONFIG['ã¾ã¨ã‚å‰²'].length > 0;

    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèª
    const followCheckbox = document.getElementById('discount-checkbox-follow');
    const repeatCheckbox = document.getElementById('discount-checkbox-repeat');
    const matomeCheckbox = document.getElementById('discount-checkbox-matome');

    const includeFollow = hasFollow && (!followCheckbox || followCheckbox.checked);
    const includeRepeat = hasRepeat && (!repeatCheckbox || repeatCheckbox.checked);
    const includeMatome = hasMatome && (!matomeCheckbox || matomeCheckbox.checked);

    // ã™ã¹ã¦ã®å‰²å¼•ãŒç©ºã¾ãŸã¯ãƒã‚§ãƒƒã‚¯ãªã—ã®å ´åˆã¯ç©ºæ–‡å­—ã‚’è¿”ã™
    if (!includeFollow && !includeRepeat && !includeMatome) {
      return '';
    }

    let text = '\nã€ãŠå¾—ãªå‰²å¼•æƒ…å ±ã€‘\n\n';

    // ãƒ†ãƒ¼ãƒãƒã‚§ãƒƒã‚¯: ãƒ¢ãƒ€ãƒ³ãƒ†ãƒ¼ãƒã®å ´åˆã¯çµµæ–‡å­—ã‚’è¡¨ç¤ºã—ãªã„
    const isModernTheme = document.body.classList.contains('theme-modern');
    const bullet = isModernTheme ? '' : 'â–  ';

    // ãƒ•ã‚©ãƒ­ãƒ¼å‰²
    if (includeFollow) {
      text += `${bullet}ãƒ•ã‚©ãƒ­ãƒ¼å‰²\n`;
      DISCOUNT_CONFIG['ãƒ•ã‚©ãƒ­ãƒ¼å‰²'].forEach(item => {
        text += `${item.ç¯„å›²} â‡’ ${item.å‰²å¼•é¡}\n`;
      });
      // èª¬æ˜æ–‡ãŒã‚ã‚Œã°è¿½åŠ 
      if (DISCOUNT_CONFIG['ãƒ•ã‚©ãƒ­ãƒ¼å‰²_èª¬æ˜æ–‡']) {
        text += `${DISCOUNT_CONFIG['ãƒ•ã‚©ãƒ­ãƒ¼å‰²_èª¬æ˜æ–‡']}\n`;
      }
      text += '\n';
    }

    // ãƒªãƒ”ãƒ¼ãƒˆå‰²
    if (includeRepeat) {
      const repeatDiscount = DISCOUNT_CONFIG['ãƒªãƒ”ãƒ¼ãƒˆå‰²'][0].å‰²å¼•é¡;
      text += `${bullet}ãƒªãƒ”ãƒ¼ãƒˆå‰²\n`;
      text += `æ¬¡å›è³¼å…¥æ™‚ã«${repeatDiscount}\n`;
      // èª¬æ˜æ–‡ãŒã‚ã‚Œã°è¿½åŠ 
      if (DISCOUNT_CONFIG['ãƒªãƒ”ãƒ¼ãƒˆå‰²_èª¬æ˜æ–‡']) {
        text += `${DISCOUNT_CONFIG['ãƒªãƒ”ãƒ¼ãƒˆå‰²_èª¬æ˜æ–‡']}\n`;
      }
      text += '\n';
    }

    // ã¾ã¨ã‚å‰²
    if (includeMatome) {
      text += `${bullet}ã¾ã¨ã‚å‰²\n`;
      DISCOUNT_CONFIG['ã¾ã¨ã‚å‰²'].forEach(item => {
        text += `${item.ç¯„å›²}â‡’${item.å‰²å¼•é¡}\n`;
      });
      // èª¬æ˜æ–‡ãŒã‚ã‚Œã°è¿½åŠ 
      if (DISCOUNT_CONFIG['ã¾ã¨ã‚å‰²_èª¬æ˜æ–‡']) {
        text += `${DISCOUNT_CONFIG['ã¾ã¨ã‚å‰²_èª¬æ˜æ–‡']}`;
      }
    }

    return text;
  }

  // ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ç”Ÿæˆé–¢æ•°ï¼ˆå‹•çš„è¨­å®šå¯¾å¿œç‰ˆãƒ»ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹é€£å‹•ï¼‰
  function generateHashtags() {
    const tags = [];

    // æ–°å½¢å¼ï¼ˆå‹•çš„ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°é…åˆ— + å…±é€šãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼‰ã«å¯¾å¿œ
    if (HASHTAG_CONFIG.hashtags && Array.isArray(HASHTAG_CONFIG.hashtags)) {
      const commonPrefix = HASHTAG_CONFIG.commonPrefix || '';

      HASHTAG_CONFIG.hashtags.forEach((hashtag, index) => {
        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèª
        const checkbox = document.getElementById(`hashtag-checkbox-${index}`);
        if (!checkbox || !checkbox.checked) {
          return; // ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        }

        const suffix = hashtag.suffix || '';
        const title = hashtag.title || '';

        // ã‚¿ã‚¤ãƒˆãƒ«ã«åŸºã¥ã„ã¦ä¸­é–“éƒ¨åˆ†ã‚’æ±ºå®š
        if (title === 'å…¨å•†å“') {
          // å…¨å•†å“ã‚¿ã‚°
          tags.push(`${commonPrefix}${suffix}`);
        } else if (title === 'ãƒ–ãƒ©ãƒ³ãƒ‰') {
          // ãƒ–ãƒ©ãƒ³ãƒ‰åˆ¥ã‚¿ã‚°ï¼ˆè‹±èªå„ªå…ˆã€ãªã‘ã‚Œã°ã‚«ãƒŠï¼‰
          const brandEn = _val('ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)');
          const brandKana = _val('ãƒ–ãƒ©ãƒ³ãƒ‰(ã‚«ãƒŠ)');
          const brand = brandEn || brandKana;
          if (brand) {
            const cleanBrand = brand.replace(/\s+/g, '');
            tags.push(`${commonPrefix}${cleanBrand}${suffix}`);
          }
        } else if (title === 'ã‚«ãƒ†ã‚´ãƒª') {
          // ã‚«ãƒ†ã‚´ãƒªã‚¿ã‚°ï¼ˆé¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªã‚’é€£çµï¼‰
          const categoryOptions = hashtag.categoryOptions || ['å¤§åˆ†é¡', 'ä¸­åˆ†é¡'];

          // ã‚«ãƒ†ã‚´ãƒªå€¤ã®ãƒãƒƒãƒ”ãƒ³ã‚°
          const categoryMap = {
            'å¤§åˆ†é¡': _val('å¤§åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)'),
            'ä¸­åˆ†é¡': _val('ä¸­åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)'),
            'å°åˆ†é¡': _val('å°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)'),
            'ç´°åˆ†é¡1': _val('ç´°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)'),
            'ç´°åˆ†é¡2': _val('ç´°åˆ†é¡2'),
            'ã‚¢ã‚¤ãƒ†ãƒ å': _val('ã‚¢ã‚¤ãƒ†ãƒ å')
          };

          // é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªã‚’é †ç•ªã«é€£çµ
          const categoryParts = [];
          categoryOptions.forEach(optionName => {
            const value = categoryMap[optionName];
            if (value) {
              categoryParts.push(value);
            }
          });

          // é€£çµã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªã§ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ç”Ÿæˆ
          if (categoryParts.length > 0) {
            const combinedCategory = categoryParts.join('');
            tags.push(`${commonPrefix}${combinedCategory}${suffix}`);
          }
        } else if (title === 'ã‚«ãƒ©ãƒ¼') {
          // ã‚«ãƒ©ãƒ¼ã‚¿ã‚°
          const colorValue = _val('ã‚«ãƒ©ãƒ¼');
          if (colorValue) {
            const cleanColor = colorValue.replace(/\s+/g, '');
            tags.push(`${commonPrefix}${cleanColor}${suffix}`);
          }
        } else if (title === 'ã‚µã‚¤ã‚º') {
          // ã‚µã‚¤ã‚ºã‚¿ã‚°
          const sizeValue = _val('ã‚µã‚¤ã‚º');
          if (sizeValue) {
            const cleanSize = sizeValue.replace(/\s+/g, '');
            tags.push(`${commonPrefix}${cleanSize}${suffix}`);
          }
        } else {
          // ã‚«ã‚¹ã‚¿ãƒ ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãŒç‰¹å®šã®ã‚‚ã®ã§ãªã„å ´åˆï¼‰
          // å…±é€šãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã¨ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®ã¿çµåˆ
          if (commonPrefix || suffix) {
            tags.push(`${commonPrefix}${suffix}`);
          }
        }
      });
    } else {
      // æ—§å½¢å¼ï¼ˆå›ºå®š3é …ç›®ï¼‰ã¨ã®å¾Œæ–¹äº’æ›æ€§
      // å…¨å•†å“ã‚¿ã‚°
      if (HASHTAG_CONFIG.å…¨å•†å“ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ || HASHTAG_CONFIG.å…¨å•†å“ãƒ†ã‚­ã‚¹ãƒˆ) {
        const allProductPrefix = HASHTAG_CONFIG.å…¨å•†å“ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ || '#REBORN_';
        const allProductText = HASHTAG_CONFIG.å…¨å•†å“ãƒ†ã‚­ã‚¹ãƒˆ || 'å…¨å•†å“';
        tags.push(`${allProductPrefix}${allProductText}`);
      }

      // ãƒ–ãƒ©ãƒ³ãƒ‰åˆ¥ã‚¿ã‚°
      const brandEn = _val('ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)');
      if (brandEn && (HASHTAG_CONFIG.ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ || HASHTAG_CONFIG.ãƒ–ãƒ©ãƒ³ãƒ‰ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹)) {
        const brandPrefix = HASHTAG_CONFIG.ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ || '#REBORN_';
        const brandSuffix = HASHTAG_CONFIG.ãƒ–ãƒ©ãƒ³ãƒ‰ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ || 'ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§';
        const cleanBrand = brandEn.replace(/\s+/g, '');
        tags.push(`${brandPrefix}${cleanBrand}${brandSuffix}`);
      }

      // ã‚«ãƒ†ã‚´ãƒªã‚¿ã‚°
      if (HASHTAG_CONFIG.ã‚«ãƒ†ã‚´ãƒªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ || HASHTAG_CONFIG.ã‚«ãƒ†ã‚´ãƒªã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹) {
        const categoryPrefix = HASHTAG_CONFIG.ã‚«ãƒ†ã‚´ãƒªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ || '#REBORN_';
        const categorySuffix = HASHTAG_CONFIG.ã‚«ãƒ†ã‚´ãƒªã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ || 'ä¸€è¦§';

        const category1 = _val('å¤§åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');
        const category2 = _val('ä¸­åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');

        if (category2) {
          tags.push(`${categoryPrefix}${category2}${categorySuffix}`);
        }
        if (category1) {
          tags.push(`${categoryPrefix}${category1}${categorySuffix}`);
        }
        if (category1 && category2) {
          tags.push(`${categoryPrefix}${category1}${category2}${categorySuffix}`);
        }
      }
    }

    // é‡è¤‡å‰Šé™¤
    return [...new Set(tags)];
  }

  function splitMulti(s) {
    return String(s||'').split(/[,\u3001\/\uFF0F\n]+/).map(v=>v.trim()).filter(v=>v.length>0);
  }

  function uniqKeepOrder(arr) {
    const s=new Set(), out=[];
    for(const x of arr||[]) {
      const v=(x??'').toString().trim();
      if(!v||s.has(v))continue;
      s.add(v);
      out.push(v);
    }
    return out;
  }

  // ãƒ–ãƒ©ãƒ³ãƒ‰ãƒšã‚¢ãƒ‡ãƒ¼ã‚¿ã®é«˜é€Ÿæ¤œç´¢ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒãƒƒãƒ—ã‚’æ§‹ç¯‰
  function buildBrandIndexMap() {
    BRAND_INDEX_MAP.clear();

    // ãƒšã‚¢ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è‹±èªåã‚’ã‚­ãƒ¼ã¨ã—ã¦ãƒãƒƒãƒ—ã‚’æ§‹ç¯‰
    BRAND_PAIRS.forEach((pair, index) => {
      if (pair && pair.english) {
        BRAND_INDEX_MAP.set(pair.english, index);
      }
    });

    console.log(`ãƒ–ãƒ©ãƒ³ãƒ‰ãƒšã‚¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒãƒƒãƒ—æ§‹ç¯‰å®Œäº†: ${BRAND_INDEX_MAP.size}ä»¶`);
    console.log('ãƒ–ãƒ©ãƒ³ãƒ‰ãƒšã‚¢ãƒ‡ãƒ¼ã‚¿æ•°:', BRAND_PAIRS.length);
  }

  function fillSelectSafe(sel, values) {
    if (!sel) return;
    if (Array.isArray(values) && values.length) {
      const prev = sel.value;
      sel.innerHTML = '<option value="">--</option>';
      values.forEach(v=> sel.insertAdjacentHTML('beforeend', `<option value="${v}">${v}</option>`));
      sel.disabled = false;
      if (prev && values.includes(prev)) sel.value = prev;
    }
  }

  function resetSelect(id, disable=true) {
    const sel = document.getElementById(id);
    if (!sel) return;
    sel.innerHTML = '<option value="">--</option>';
    sel.value = '';
    if (disable) sel.disabled = true;
  }

  function applyShippingDefaults() {
    for (const k of Object.keys(SHIPPING_DEFAULTS)) {
      const el = document.getElementById(k);
      if (!el) continue;
      const def = SHIPPING_DEFAULTS[k];
      const exists = Array.from(el.options).some(o => String(o.value) === def);
      if (!exists) el.insertAdjacentHTML('beforeend', `<option value="${def}">${def}</option>`);
      el.value = def;
    }
  }

  function applyProcureListingDefaults() {
    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DDå½¢å¼

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥æ—¥
    const procureDateField = document.getElementById('ä»•å…¥æ—¥');
    if (procureDateField) {
      if (PROCURE_LISTING_DEFAULTS['ä»•å…¥æ—¥_ä»Šæ—¥'] === true) {
        // ã€Œå¸¸ã«ä»Šæ—¥ã€ãŒãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ä»Šæ—¥ã®æ—¥ä»˜ã‚’ä½¿ç”¨
        procureDateField.value = today;
      } else {
        // å›ºå®šæ—¥ä»˜ã‚’ä½¿ç”¨
        const defaultProcureDate = PROCURE_LISTING_DEFAULTS['ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥æ—¥'];
        if (defaultProcureDate) {
          procureDateField.value = defaultProcureDate;
        }
      }
    }

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥å…ˆ
    const defaultProcureSource = PROCURE_LISTING_DEFAULTS['ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥å…ˆ'];
    if (defaultProcureSource) {
      const procureSourceField = document.getElementById('ä»•å…¥å…ˆ');
      if (procureSourceField) {
        // é¸æŠè‚¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
        const exists = Array.from(procureSourceField.options).some(o => String(o.value) === defaultProcureSource);
        if (!exists) {
          procureSourceField.insertAdjacentHTML('beforeend', `<option value="${defaultProcureSource}">${defaultProcureSource}</option>`);
        }
        procureSourceField.value = defaultProcureSource;
      }
    }

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“æ—¥
    const listingDateField = document.getElementById('å‡ºå“æ—¥');
    if (listingDateField) {
      if (PROCURE_LISTING_DEFAULTS['å‡ºå“æ—¥_ä»Šæ—¥'] === true) {
        // ã€Œå¸¸ã«ä»Šæ—¥ã€ãŒãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ä»Šæ—¥ã®æ—¥ä»˜ã‚’ä½¿ç”¨
        listingDateField.value = today;
      } else {
        // å›ºå®šæ—¥ä»˜ã‚’ä½¿ç”¨
        const defaultListingDate = PROCURE_LISTING_DEFAULTS['ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“æ—¥'];
        if (defaultListingDate) {
          listingDateField.value = defaultListingDate;
        }
      }
    }

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“å…ˆ
    const defaultListingDest = PROCURE_LISTING_DEFAULTS['ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“å…ˆ'];
    if (defaultListingDest) {
      const listingDestField = document.getElementById('å‡ºå“å…ˆ');
      if (listingDestField) {
        // é¸æŠè‚¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
        const exists = Array.from(listingDestField.options).some(o => String(o.value) === defaultListingDest);
        if (!exists) {
          listingDestField.insertAdjacentHTML('beforeend', `<option value="${defaultListingDest}">${defaultListingDest}</option>`);
        }
        listingDestField.value = defaultListingDest;
      }
    }
  }

  // ========== ç®¡ç†ç•ªå·ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ–¹å¼UI ==========

  // ç®¡ç†ç•ªå·ã‚»ã‚°ãƒ¡ãƒ³ãƒˆUIã‚’åˆæœŸåŒ–
  function initManagementNumberUI() {
    google.script.run
      .withSuccessHandler(function(segments) {
        if (!segments || segments.length === 0) {
          // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¨­å®šãŒãªã„å ´åˆã¯æ—§UIã‚’ä½¿ç”¨
          initLegacyManagementUI();
          return;
        }

        renderManagementSegmentUI(segments);
      })
      .withFailureHandler(function(e) {
        console.error('ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
        initLegacyManagementUI();
      })
      .getManagementNumberSegments();
  }

  // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆUIã‚’ç”Ÿæˆ
  function renderManagementSegmentUI(segments) {
    const container = document.getElementById('managementNumberFields');
    if (!container) return;

    container.innerHTML = '';

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãŒå¿…è¦ãªã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    let hasUserInput = false;

    segments.forEach((segment, index) => {
      const type = segment.type;
      const config = segment.config;

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãŒå¿…è¦ãªã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ã¿UIã‚’ç”Ÿæˆ
      switch (type) {
        case 'shelf':
          // æ£šç•ªå·é¸æŠï¼ˆ2æ®µéšé¸æŠ: é ­æ–‡å­— â†’ æ£šç•ªå·ï¼‰
          const shelfDiv = document.createElement('div');
          shelfDiv.style.marginBottom = '8px';

          // é ­æ–‡å­—ã®é¸æŠè‚¢ã‚’ç”Ÿæˆï¼ˆA-Zï¼‰
          let shelfFirstCharOptions = '<option value="">--é¸æŠ--</option>';
          for (let i = 65; i <= 90; i++) {
            const char = String.fromCharCode(i);
            shelfFirstCharOptions += `<option value="${char}">${char}</option>`;
          }

          shelfDiv.innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
              <div>
                <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">
                  é ­æ–‡å­—
                </label>
                <select id="mgmt_shelf_first" class="tight" style="width: 100%;">
                  ${shelfFirstCharOptions}
                </select>
              </div>
              <div>
                <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">
                  æ£šç•ªå·
                </label>
                <select id="mgmt_shelf_second" class="tight" style="width: 100%;">
                  <option value="">--é¸æŠ--</option>
                </select>
              </div>
            </div>
          `;
          container.appendChild(shelfDiv);

          // 2æ–‡å­—ç›®ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å…ˆã«è¨­å®š
          const shelfSecondSelect = document.getElementById('mgmt_shelf_second');
          const updateShelfHandler = function() {
            updateManagementNumberPreview();
          };
          shelfSecondSelect.addEventListener('change', updateShelfHandler);

          // é ­æ–‡å­—é¸æŠæ™‚ã«2æ–‡å­—ç›®ã‚’æ›´æ–°
          document.getElementById('mgmt_shelf_first').addEventListener('change', function() {
            const firstChar = this.value;

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ä¸€æ™‚çš„ã«å‰Šé™¤
            shelfSecondSelect.removeEventListener('change', updateShelfHandler);

            if (!firstChar) {
              shelfSecondSelect.innerHTML = '<option value="">--é¸æŠ--</option>';
              shelfSecondSelect.disabled = true;
              shelfSecondSelect.value = '';
              // é ­æ–‡å­—ãŒç©ºã®å ´åˆã¯ç®¡ç†ç•ªå·ã‚’ã‚¯ãƒªã‚¢
              setManagementNumber('', 'æœªé¸æŠ');
            } else {
              let secondOptions = '<option value="">--é¸æŠ--</option>';
              for (let i = 65; i <= 90; i++) {
                const char = String.fromCharCode(i);
                secondOptions += `<option value="${char}">${firstChar}${char}</option>`;
              }
              shelfSecondSelect.innerHTML = secondOptions;
              shelfSecondSelect.value = '';  // æ˜ç¤ºçš„ã«ç©ºæ¬„ã«è¨­å®š
              shelfSecondSelect.disabled = false;
              // é ­æ–‡å­—é¸æŠæ™‚ã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ã—ãªã„ï¼ˆ2æ–‡å­—ç›®é¸æŠã¾ã§å¾…ã¤ï¼‰
              setManagementNumber('', '');
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š
            shelfSecondSelect.addEventListener('change', updateShelfHandler);
          });
          hasUserInput = true;
          break;

        case 'category':
          // ã‚«ãƒ†ã‚´ãƒªã‚³ãƒ¼ãƒ‰é¸æŠï¼ˆAAã€œZZï¼‰
          const categoryDiv = document.createElement('div');
          categoryDiv.style.marginBottom = '8px';

          // AAã€œZZã®é¸æŠè‚¢ã‚’ç”Ÿæˆ
          let categoryOptions = '<option value="">--é¸æŠ--</option>';
          for (let i = 65; i <= 90; i++) { // A-Z
            for (let j = 65; j <= 90; j++) { // A-Z
              const code = String.fromCharCode(i) + String.fromCharCode(j);
              categoryOptions += `<option value="${code}">${code}</option>`;
            }
          }

          categoryDiv.innerHTML = `
            <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">
              ğŸ“ ã‚«ãƒ†ã‚´ãƒªã‚³ãƒ¼ãƒ‰
            </label>
            <select id="mgmt_category" class="tight" style="width: 100%;">
              ${categoryOptions}
            </select>
          `;
          container.appendChild(categoryDiv);

          // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
          document.getElementById('mgmt_category').addEventListener('change', updateManagementNumberPreview);
          hasUserInput = true;
          break;

        case 'rank':
          // å“è³ªãƒ©ãƒ³ã‚¯é¸æŠ
          const rankDiv = document.createElement('div');
          rankDiv.style.marginBottom = '8px';
          rankDiv.innerHTML = `
            <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">
              â­ å“è³ªãƒ©ãƒ³ã‚¯
            </label>
            <select id="mgmt_rank" class="tight" style="width: 100%;">
              <option value="">--é¸æŠ--</option>
              <option value="S">S (æœ€é«˜å“è³ª)</option>
              <option value="A">A (æ–°å“ãƒ»ç¾å“)</option>
              <option value="B">B (è‰¯å¥½)</option>
              <option value="C">C (ä½¿ç”¨æ„Ÿã‚ã‚Š)</option>
              <option value="D">D (é›£ã‚ã‚Š)</option>
              <option value="E">E (ã‚¸ãƒ£ãƒ³ã‚¯)</option>
            </select>
          `;
          container.appendChild(rankDiv);

          // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
          document.getElementById('mgmt_rank').addEventListener('change', updateManagementNumberPreview);
          hasUserInput = true;
          break;

        case 'size':
          // ã‚µã‚¤ã‚ºã‚³ãƒ¼ãƒ‰é¸æŠ
          const sizeDiv = document.createElement('div');
          sizeDiv.style.marginBottom = '8px';
          sizeDiv.innerHTML = `
            <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">
              ğŸ“ ã‚µã‚¤ã‚ºã‚³ãƒ¼ãƒ‰
            </label>
            <select id="mgmt_size" class="tight" style="width: 100%;">
              <option value="">--é¸æŠ--</option>
              <option value="XS">XS</option>
              <option value="S">S</option>
              <option value="M">M</option>
              <option value="L">L</option>
              <option value="XL">XL</option>
              <option value="XXL">XXL</option>
            </select>
          `;
          container.appendChild(sizeDiv);

          // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
          document.getElementById('mgmt_size').addEventListener('change', updateManagementNumberPreview);
          hasUserInput = true;
          break;

        case 'color':
          // è‰²ã‚³ãƒ¼ãƒ‰é¸æŠ
          const colorDiv = document.createElement('div');
          colorDiv.style.marginBottom = '8px';
          colorDiv.innerHTML = `
            <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">
              ğŸ¨ è‰²ã‚³ãƒ¼ãƒ‰
            </label>
            <select id="mgmt_color" class="tight" style="width: 100%;">
              <option value="">--é¸æŠ--</option>
              <option value="BK">BK (é»’)</option>
              <option value="W">W (ç™½)</option>
              <option value="R">R (èµ¤)</option>
              <option value="BL">BL (é’)</option>
              <option value="GR">GR (ç·‘)</option>
              <option value="Y">Y (é»„)</option>
              <option value="G">G (ã‚°ãƒ¬ãƒ¼)</option>
              <option value="BR">BR (èŒ¶)</option>
              <option value="BE">BE (ãƒ™ãƒ¼ã‚¸ãƒ¥)</option>
              <option value="P">P (ãƒ”ãƒ³ã‚¯)</option>
              <option value="O">O (ã‚ªãƒ¬ãƒ³ã‚¸)</option>
            </select>
          `;
          container.appendChild(colorDiv);

          // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
          document.getElementById('mgmt_color').addEventListener('change', updateManagementNumberPreview);
          hasUserInput = true;
          break;

        case 'custom':
          // ã‚«ã‚¹ã‚¿ãƒ å€¤ï¼ˆ2æ®µéšé¸æŠ: é ­æ–‡å­— â†’ æ£šç•ªå·ï¼‰
          const customDiv = document.createElement('div');
          customDiv.style.marginBottom = '8px';

          // é ­æ–‡å­—ã®é¸æŠè‚¢ã‚’ç”Ÿæˆï¼ˆA-Zï¼‰
          let firstCharOptions = '<option value="">--é¸æŠ--</option>';
          for (let i = 65; i <= 90; i++) {
            const char = String.fromCharCode(i);
            firstCharOptions += `<option value="${char}">${char}</option>`;
          }

          customDiv.innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
              <div>
                <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">
                  é ­æ–‡å­—
                </label>
                <select id="mgmt_custom_first" class="tight" style="width: 100%;">
                  ${firstCharOptions}
                </select>
              </div>
              <div>
                <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">
                  æ£šç•ªå·
                </label>
                <select id="mgmt_custom_second" class="tight" style="width: 100%;">
                  <option value="">--é¸æŠ--</option>
                </select>
              </div>
            </div>
          `;
          container.appendChild(customDiv);

          // 2æ–‡å­—ç›®ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å…ˆã«è¨­å®š
          const secondSelect = document.getElementById('mgmt_custom_second');
          const updateSecondHandler = function() {
            updateManagementNumberPreview();
          };
          secondSelect.addEventListener('change', updateSecondHandler);

          // é ­æ–‡å­—é¸æŠæ™‚ã«2æ–‡å­—ç›®ã‚’æ›´æ–°
          document.getElementById('mgmt_custom_first').addEventListener('change', function() {
            const firstChar = this.value;

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ä¸€æ™‚çš„ã«å‰Šé™¤
            secondSelect.removeEventListener('change', updateSecondHandler);

            if (!firstChar) {
              secondSelect.innerHTML = '<option value="">--é¸æŠ--</option>';
              secondSelect.disabled = true;
              secondSelect.value = '';
              // é ­æ–‡å­—ãŒç©ºã®å ´åˆã¯ç®¡ç†ç•ªå·ã‚’ã‚¯ãƒªã‚¢
              setManagementNumber('', 'æœªé¸æŠ');
            } else {
              let secondOptions = '<option value="">--é¸æŠ--</option>';
              for (let i = 65; i <= 90; i++) {
                const char = String.fromCharCode(i);
                secondOptions += `<option value="${char}">${firstChar}${char}</option>`;
              }
              secondSelect.innerHTML = secondOptions;
              secondSelect.value = '';  // æ˜ç¤ºçš„ã«ç©ºæ¬„ã«è¨­å®š
              secondSelect.disabled = false;
              // é ­æ–‡å­—é¸æŠæ™‚ã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ã—ãªã„ï¼ˆ2æ–‡å­—ç›®é¸æŠã¾ã§å¾…ã¤ï¼‰
              setManagementNumber('', '');
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š
            secondSelect.addEventListener('change', updateSecondHandler);
          });
          hasUserInput = true;
          break;

        case 'date':
        case 'sequence':
          // ã“ã‚Œã‚‰ã¯è‡ªå‹•ç”Ÿæˆãªã®ã§UIã¯ä¸è¦
          break;
      }
    });

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãŒä¸è¦ãªå ´åˆï¼ˆé€£ç•ªã®ã¿ãªã©ï¼‰ã¯è‡ªå‹•ã§ç®¡ç†ç•ªå·ã‚’ç”Ÿæˆ
    if (!hasUserInput) {
      updateManagementNumberPreview();
    } else {
      // åˆæœŸçŠ¶æ…‹ã§ã¯ç®¡ç†ç•ªå·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç©ºæ¬„ã«ã™ã‚‹
      setManagementNumber('', 'æœªé¸æŠ');
    }

    // UIç”Ÿæˆå®Œäº†å¾Œã€è¡¨ç¤ºã™ã‚‹
    container.style.display = 'block';
    const previewSection = document.getElementById('managementNumberPreview');
    if (previewSection) {
      previewSection.style.display = 'block';
    }
  }

  // ç®¡ç†ç•ªå·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
  function updateManagementNumberPreview() {
    // æ£šç•ªå·ã¯2æ®µéšé¸æŠã‹ã‚‰çµåˆ
    const shelfFirst = _val('mgmt_shelf_first');
    const shelfSecond = _val('mgmt_shelf_second');
    const shelfValue = (shelfFirst && shelfSecond) ? shelfFirst + shelfSecond : '';

    // ã‚«ã‚¹ã‚¿ãƒ å€¤ã¯2æ®µéšé¸æŠã‹ã‚‰çµåˆ
    const customFirst = _val('mgmt_custom_first');
    const customSecond = _val('mgmt_custom_second');
    const customValue = (customFirst && customSecond) ? customFirst + customSecond : '';

    // æ£šç•ªå·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€2æ–‡å­—ç›®ãŒæœªé¸æŠãªã‚‰æ¡ç•ªã—ãªã„
    const shelfFirstField = document.getElementById('mgmt_shelf_first');
    if (shelfFirstField && shelfFirst && !shelfSecond) {
      setManagementNumber('', '');
      return;
    }

    // ã‚«ã‚¹ã‚¿ãƒ å€¤ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€2æ–‡å­—ç›®ãŒæœªé¸æŠãªã‚‰æ¡ç•ªã—ãªã„
    const customFirstField = document.getElementById('mgmt_custom_first');
    if (customFirstField && customFirst && !customSecond) {
      setManagementNumber('', '');
      return;
    }

    const userInputs = {
      shelf: shelfValue,
      category: _val('mgmt_category'),
      rank: _val('mgmt_rank'),
      size: _val('mgmt_size'),
      color: _val('mgmt_color'),
      custom: customValue
    };

    // æ¡ç•ªä¸­ã‚’è¡¨ç¤º
    setManagementNumber('', 'æ¡ç•ªä¸­...');

    // è‡ªå‹•æ¡ç•ªã‚’å®Ÿè¡Œ
    google.script.run
      .withSuccessHandler(function(managementNumber) {
        if (typeof managementNumber === 'string' && managementNumber.startsWith('NG(')) {
          setManagementNumber('', managementNumber);
          return;
        }
        setManagementNumber(managementNumber, '');
      })
      .withFailureHandler(function(e) {
        console.error('ç®¡ç†ç•ªå·ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', e);
        setManagementNumber('', 'ã‚¨ãƒ©ãƒ¼');
      })
      .generateSegmentBasedManagementNumber(userInputs);
  }

  // ç®¡ç†ç•ªå·ã®é€£ç•ªã‚’èª¿æ•´ï¼ˆâ–²â–¼ãƒœã‚¿ãƒ³ç”¨ï¼‰
  function adjustManagementNumber(delta) {
    const input = document.getElementById('ç®¡ç†ç•ªå·');
    if (!input || !input.value) return;

    const currentValue = input.value;

    // ç®¡ç†ç•ªå·ã‚’åˆ†è§£ï¼ˆä¾‹ï¼šBB-1001 â†’ prefix: 'BB-', number: 1001ï¼‰
    const match = currentValue.match(/^(.*?)(\d+)$/);
    if (!match) return;

    const prefix = match[1]; // ä¾‹ï¼š'BB-'
    const currentNumber = parseInt(match[2], 10); // ä¾‹ï¼š1001
    const digits = match[2].length; // ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ç”¨

    // æ–°ã—ã„ç•ªå·ã‚’è¨ˆç®—
    let newNumber = currentNumber + delta;

    // ä¸‹ã’ã‚‹å ´åˆã¯ã€ã‚µãƒ¼ãƒãƒ¼ã«å•ã„åˆã‚ã›ã¦æœ€å°å€¤ã‚’ç¢ºèª
    if (delta < 0) {
      // ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ã—ã¦äºŒé‡ã‚¯ãƒªãƒƒã‚¯ã‚’é˜²æ­¢
      const buttons = document.querySelectorAll('button[onclick*="adjustManagementNumber"]');
      buttons.forEach(btn => btn.disabled = true);

      // ã‚µãƒ¼ãƒãƒ¼ã«å•ã„åˆã‚ã›
      google.script.run
        .withSuccessHandler(function(minAvailableNumber) {
          buttons.forEach(btn => btn.disabled = false);

          if (typeof minAvailableNumber === 'string' && minAvailableNumber.startsWith('NG(')) {
            console.error('æœ€å°ç•ªå·å–å¾—ã‚¨ãƒ©ãƒ¼:', minAvailableNumber);
            return;
          }

          // æœ€å°ä½¿ç”¨å¯èƒ½ç•ªå·ä»¥ä¸Šã«åˆ¶é™
          const finalNumber = Math.max(minAvailableNumber, newNumber);
          const paddedNumber = String(finalNumber).padStart(digits, '0');
          const newValue = prefix + paddedNumber;

          input.value = newValue;
          console.log(`ç®¡ç†ç•ªå·ã‚’èª¿æ•´: ${currentValue} â†’ ${newValue} (æœ€å°: ${minAvailableNumber})`);

          if (finalNumber === minAvailableNumber && newNumber < minAvailableNumber) {
            // æ—¢ã«æœ€å°å€¤ã«é”ã—ã¦ã„ã‚‹å ´åˆã¯é€šçŸ¥
            console.log('ã“ã‚Œä»¥ä¸Šä¸‹ã’ã‚‰ã‚Œã¾ã›ã‚“ï¼ˆä½¿ç”¨æ¸ˆã¿ã®ç•ªå·ã§ã™ï¼‰');
          }
        })
        .withFailureHandler(function(error) {
          buttons.forEach(btn => btn.disabled = false);
          console.error('æœ€å°ç•ªå·å–å¾—å¤±æ•—:', error);
        })
        .getMinAvailableNumber(prefix.replace(/-$/, ''), digits, parseInt(match[2]));
    } else {
      // ä¸Šã’ã‚‹å ´åˆã¯ãã®ã¾ã¾é©ç”¨
      newNumber = Math.max(1, newNumber);
      const paddedNumber = String(newNumber).padStart(digits, '0');
      const newValue = prefix + paddedNumber;
      input.value = newValue;
      console.log(`ç®¡ç†ç•ªå·ã‚’èª¿æ•´: ${currentValue} â†’ ${newValue}`);
    }
  }

  // æ—§UIåˆæœŸåŒ–ï¼ˆå¾Œæ–¹äº’æ›ç”¨ï¼‰
  function initLegacyManagementUI() {
    const container = document.getElementById('managementNumberFields');
    if (!container) return;

    container.innerHTML = `
      <div class="row3">
        <div>
          <span class="small">é ­æ–‡å­—</span>
          <select id="prefix1" class="tight">
            <option value="">--</option>
          </select>
        </div>
        <div>
          <span class="small">æ£šç•ªå·</span>
          <select id="æ£šç•ªå·" class="tight" disabled>
            <option value="">--</option>
          </select>
        </div>
        <div></div>
      </div>
    `;

    initPrefix1();
  }

  // ========== æ—§ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå¾Œæ–¹äº’æ›ç”¨ï¼‰ ==========

  // é ­æ–‡å­—ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’åˆæœŸåŒ–
  function initPrefix1() {
    const p1 = document.getElementById('prefix1');
    if (!p1) return;
    p1.innerHTML = '<option value="">--</option>';
    for (let c=65;c<=90;c++) {
      const v=String.fromCharCode(c);
      p1.insertAdjacentHTML('beforeend', `<option value="${v}">${v}</option>`);
    }
  }

  // æ£šç•ªå·ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ§‹ç¯‰
  function buildShelf() {
    const p1 = document.getElementById('prefix1');
    const shelf = document.getElementById('æ£šç•ªå·');
    if (!p1 || !shelf) return;
    const v1 = p1.value;
    shelf.innerHTML = '<option value="">--</option>';
    if (!v1) {
      shelf.disabled = true;
      setManagementNumber('', 'é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    shelf.disabled = false;
    for (let c=65;c<=90;c++) {
      const v=v1+String.fromCharCode(c);
      shelf.insertAdjacentHTML('beforeend', `<option value="${v}">${v}</option>`);
    }
    shelf.value = '';
    setManagementNumber('', 'é¸æŠã—ã¦ãã ã•ã„');
  }

  // æ£šç•ªå·é¸æŠæ™‚ã«ç®¡ç†ç•ªå·ã‚’å–å¾—
  function requestNextManagementNumber() {
    const shelfSel = document.getElementById('æ£šç•ªå·');
    if (!shelfSel) {
      setManagementNumber('', 'é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    const shelf = shelfSel.value;
    if (!shelf) {
      setManagementNumber('', 'é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    setManagementNumber('', 'æ¡ç•ªä¸­â€¦');
    if (!(google && google.script && google.script.run)) {
      setManagementNumber('', '');
      return;
    }
    google.script.run.withSuccessHandler(res=>{
      if (typeof res === 'string' && res.startsWith('NG(')) {
        show(res);
        setManagementNumber('', 'ã‚¨ãƒ©ãƒ¼');
        return;
      }
      setManagementNumber(res, '');
    }).withFailureHandler(e=> {
      show(`NG(UNKNOWN): ${e && e.message ? e.message : e}`);
      setManagementNumber('', 'ã‚¨ãƒ©ãƒ¼');
    }).getNextManagementNumber(shelf);
  }

  // ç®¡ç†ç•ªå·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¨­å®š
  function setManagementNumber(val, ph) {
    const el=document.getElementById('ç®¡ç†ç•ªå·');
    if (!el) return;
    el.value=val||'';
    el.placeholder=ph||'';

    // ç®¡ç†ç•ªå·ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚æ›´æ–°
    if (typeof updateNamePreview === 'function') {
      updateNamePreview();
    }
  }

  let NAME_REST_FIELDS = ['å•†å“å±æ€§1_å€¤'];

  // DOMè¦ç´ ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  const elementCache = new Map();

  function _val(id) {
    if (!elementCache.has(id)) {
      elementCache.set(id, document.getElementById(id));
    }
    const el = elementCache.get(id);
    return (el && (el.value||'').toString().trim()) || '';
  }

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢æ©Ÿèƒ½ï¼ˆå¿…è¦æ™‚ã®ãŸã‚ï¼‰
  function clearElementCache() {
    elementCache.clear();
  }

  function _truncateByCodePoints(str, limit) {
    const a = Array.from(str);
    return (a.length > limit) ? a.slice(0, limit).join('') : str;
  }

  function adjustPreviewHeight() {
    const ta = document.getElementById('å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼');
    if (!ta) return;
    ta.classList.remove('scroll');
    ta.style.height = 'auto';
    const sh = ta.scrollHeight;
    const max = 140;
    if (sh > max) {
      ta.style.height = max + 'px';
      ta.classList.add('scroll');
    } else {
      ta.style.height = sh + 'px';
    }
  }

  /**
   * ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«å½¢å¼ã‚’é©ç”¨
   */
  function applySaleswordFormat(salesword) {
    if (!salesword) return '';

    // ãƒ¯ãƒ¼ãƒ‰åˆ¥ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚’ç¢ºèª
    let prefix = SALESWORD_FORMAT.globalPrefix;
    let suffix = SALESWORD_FORMAT.globalSuffix;

    if (SALESWORD_FORMAT.wordOverrides) {
      const override = SALESWORD_FORMAT.wordOverrides.find(o => o.word === salesword);
      if (override) {
        prefix = override.prefix;
        suffix = override.suffix;
      }
    }

    return prefix + salesword + suffix;
  }

  // ========== å•†å“åãƒ–ãƒ­ãƒƒã‚¯ä¸¦ã³æ›¿ãˆæ©Ÿèƒ½ ==========

  /**
   * å•†å“åãƒ–ãƒ­ãƒƒã‚¯ã®ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚’åˆæœŸåŒ–ï¼ˆSortable.jsä½¿ç”¨ï¼‰
   * ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ï¼ˆã‚¹ãƒãƒ›ï¼‰ã§ã‚‚å‹•ä½œã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸ
   */
  function initTitleBlockDragDrop() {
    const container = document.getElementById('titleBlockContainer');
    if (!container) return;

    // Sortable.jsã‚’ä½¿ç”¨ã—ã¦ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚’åˆæœŸåŒ–
    // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã«è‡ªå‹•å¯¾å¿œ
    Sortable.create(container, {
      animation: 150,                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é€Ÿåº¦ï¼ˆãƒŸãƒªç§’ï¼‰
      handle: '.drag-handle',            // â‹®â‹® ã‚¢ã‚¤ã‚³ãƒ³ã®ã¿ã§ãƒ‰ãƒ©ãƒƒã‚°
      ghostClass: 'sortable-ghost',      // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦ç´ ã«é©ç”¨ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹
      chosenClass: 'sortable-chosen',    // é¸æŠä¸­ã®è¦ç´ ã«é©ç”¨ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹
      dragClass: 'sortable-drag',        // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦ç´ ã«é©ç”¨ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹
      onEnd: function() {
        // ãƒ‰ãƒ­ãƒƒãƒ—å¾Œã«ä¸¦ã³é †ã‚’ä¿å­˜
        saveTitleBlockOrder();
        updateNamePreview();
      }
    });
  }

  /**
   * ç¾åœ¨ã®å•†å“åãƒ–ãƒ­ãƒƒã‚¯ã®ä¸¦ã³é †ã‚’ä¿å­˜
   */
  function saveTitleBlockOrder() {
    const container = document.getElementById('titleBlockContainer');
    if (!container) return;

    const blocks = container.querySelectorAll('.title-draggable-block');
    TITLE_BLOCK_ORDER = Array.from(blocks).map(block => block.dataset.blockId);
    console.log('å•†å“åãƒ–ãƒ­ãƒƒã‚¯ã®ä¸¦ã³é †ã‚’æ›´æ–°:', TITLE_BLOCK_ORDER);

    // è¨­å®šãƒã‚¹ã‚¿ã«ä¿å­˜
    if (google && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('å•†å“åãƒ–ãƒ­ãƒƒã‚¯ã®ä¸¦ã³é †ã‚’è¨­å®šãƒã‚¹ã‚¿ã«ä¿å­˜ã—ã¾ã—ãŸ');
        })
        .withFailureHandler(function(error) {
          console.error('å•†å“åãƒ–ãƒ­ãƒƒã‚¯ä¸¦ã³é †ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        })
        .saveTitleBlockOrder(TITLE_BLOCK_ORDER);
    }
  }

  /**
   * ä¿å­˜ã•ã‚ŒãŸä¸¦ã³é †ã§ãƒ–ãƒ­ãƒƒã‚¯ã‚’å†é…ç½®
   */
  function applyTitleBlockOrder() {
    const container = document.getElementById('titleBlockContainer');
    if (!container || !TITLE_BLOCK_ORDER || TITLE_BLOCK_ORDER.length === 0) return;

    TITLE_BLOCK_ORDER.forEach(blockId => {
      const block = container.querySelector(`[data-block-id="${blockId}"]`);
      if (block) {
        container.appendChild(block);
      }
    });
  }

  /**
   * å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
   * ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ãƒ–ãƒ©ãƒ³ãƒ‰åã€ã‚¢ã‚¤ãƒ†ãƒ åã€å•†å“å±æ€§ã€ç®¡ç†ç•ªå·ã‚’çµ„ã¿ç«‹ã¦ã‚‹
   * TITLE_BLOCK_ORDERã®é †åºã«å¾“ã£ã¦è¡¨ç¤º
   * @throws {Error} å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆ
   */
  function updateNamePreview() {
    try {
      // å„ãƒ–ãƒ­ãƒƒã‚¯ã®å€¤ã‚’å–å¾—
      const kw = _val('ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰');
      const formattedKw = applySaleswordFormat(kw);

    // å•†å“åãƒ–ãƒ­ãƒƒã‚¯å†…ã®ãƒ–ãƒ©ãƒ³ãƒ‰ã‚’å‚ç…§ï¼ˆã©ã¡ã‚‰ã‹ç‰‡æ–¹ã§ã‚‚å¯ï¼‰
    const brandEn = _val('å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)');
    const brandKana = _val('å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(ã‚«ãƒŠ)');

    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèª
    const brandEnCheckbox = document.getElementById('å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)_ãƒã‚§ãƒƒã‚¯');
    const brandKanaCheckbox = document.getElementById('å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(ã‚«ãƒŠ)_ãƒã‚§ãƒƒã‚¯');
    const useBrandEn = brandEnCheckbox && brandEnCheckbox.checked && brandEn;
    const useBrandKana = brandKanaCheckbox && brandKanaCheckbox.checked && brandKana;

    // ãƒ–ãƒ©ãƒ³ãƒ‰åã®æ§‹ç¯‰ï¼ˆã‚«ãƒŠã®å‰ã«åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ï¼‰
    let brands = '';
    if (useBrandEn && useBrandKana) {
      brands = brandEn + ' ' + brandKana;
    } else if (useBrandEn) {
      brands = brandEn;
    } else if (useBrandKana) {
      brands = brandKana;
    }

    // å•†å“åãƒ–ãƒ­ãƒƒã‚¯å†…ã®ã‚¢ã‚¤ãƒ†ãƒ åï¼ˆç·¨é›†å¯èƒ½ï¼‰
    const itemNameInTitle = _val('å•†å“å_ã‚¢ã‚¤ãƒ†ãƒ å');
    const others = NAME_REST_FIELDS.map(_val).filter(Boolean);

    // ä¸¦ã³é †ã«åŸºã¥ã„ã¦å•†å“åã‚’æ§‹ç¯‰
    const parts = [];
    TITLE_BLOCK_ORDER.forEach(blockId => {
      if (blockId === 'salesword' && formattedKw) {
        parts.push(formattedKw);
      } else if (blockId === 'brand' && brands) {
        parts.push(brands);
      } else if (blockId === 'item' && itemNameInTitle) {
        // å•†å“åãƒ–ãƒ­ãƒƒã‚¯å†…ã®ã‚¢ã‚¤ãƒ†ãƒ åã‚’ä½¿ç”¨
        parts.push(itemNameInTitle);
      } else if (blockId === 'attribute') {
        // å•†å“å±æ€§ã®ã¿ã‚’è¿½åŠ ï¼ˆã‚¢ã‚¤ãƒ†ãƒ åã¯å«ã‚ãªã„ï¼‰
        if (others.length) parts.push(...others);
      }
    });

    let text = parts.join(' ');

    // ç®¡ç†ç•ªå·ã‚’å•†å“åã«è¿½åŠ ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒONã®å ´åˆï¼‰
    const mgmtNumberCheckbox = document.getElementById('å•†å“åã«ç®¡ç†ç•ªå·é…ç½®');
    if (mgmtNumberCheckbox && mgmtNumberCheckbox.checked) {
      const mgmtNumber = _val('ç®¡ç†ç•ªå·');
      if (mgmtNumber) {
        const format = _val('ç®¡ç†ç•ªå·å½¢å¼') || 'ã€ã€‘';
        let formattedMgmtNumber = '';

        switch (format) {
          case 'ã€ã€‘':
            formattedMgmtNumber = `ã€${mgmtNumber}ã€‘`;
            break;
          case '()':
            formattedMgmtNumber = `ï¼ˆ${mgmtNumber}ï¼‰`;
            break;
          case 'ï½œ':
            formattedMgmtNumber = `ï½œ${mgmtNumber}`;
            break;
          case '-':
            formattedMgmtNumber = `- ${mgmtNumber}`;
            break;
          case 'none':
            formattedMgmtNumber = mgmtNumber;
            break;
          default:
            formattedMgmtNumber = `ã€${mgmtNumber}ã€‘`;
        }

        // å•†å“åã®æœ€å¾Œã«ç®¡ç†ç•ªå·ã‚’è¿½åŠ ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰
        text = text ? `${text} ${formattedMgmtNumber}` : formattedMgmtNumber;
      }
    }

    const count = Array.from(text).length;
    const counterEl = document.getElementById('nameCounter');
    const nameCountEl = document.getElementById('nameCount');
    const nameMaxEl = document.getElementById('nameMax');
    if (nameCountEl) nameCountEl.textContent = count;
    if (nameMaxEl) nameMaxEl.textContent = NAME_LIMIT;
    if (counterEl) counterEl.classList.toggle('over', count > NAME_LIMIT);
    let saveText = text;
    if (NAME_LIMIT_MODE === 'truncate' && count > NAME_LIMIT) {
      saveText = _truncateByCodePoints(text, NAME_LIMIT);
    }
    const ta = document.getElementById('å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼');
    if (ta) {
      ta.value = text;
      adjustPreviewHeight();
    }
      const hidden = document.getElementById('å•†å“å(ã‚¿ã‚¤ãƒˆãƒ«)');
      if (hidden) hidden.value = saveText;

      // å½¢å¼é¸æŠãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã‚‚è¨­å®šã‚’ä¿å­˜
      saveManagementNumberPlacementSettings();
    } catch (error) {
      console.error('å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      debug.error('updateNamePreview ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  // ç®¡ç†ç•ªå·é…ç½®è¨­å®šã‚’ä¿å­˜
  function saveManagementNumberPlacementSettings() {
    const titleCheckbox = document.getElementById('å•†å“åã«ç®¡ç†ç•ªå·é…ç½®');
    const descCheckbox = document.getElementById('èª¬æ˜æ–‡ã«ç®¡ç†ç•ªå·é…ç½®');
    const formatSelect = document.getElementById('ç®¡ç†ç•ªå·å½¢å¼');

    const settings = {
      inTitle: titleCheckbox ? titleCheckbox.checked : false,
      inDesc: descCheckbox ? descCheckbox.checked : false,
      format: formatSelect ? formatSelect.value : 'ã€ã€‘'
    };

    try {
      localStorage.setItem('managementNumberPlacement', JSON.stringify(settings));
    } catch (e) {
      console.warn('LocalStorageä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
    }
  }

  // ç®¡ç†ç•ªå·é…ç½®è¨­å®šã‚’å¾©å…ƒ
  function restoreManagementNumberPlacementSettings() {
    try {
      const saved = localStorage.getItem('managementNumberPlacement');
      if (!saved) return;

      const settings = JSON.parse(saved);
      const titleCheckbox = document.getElementById('å•†å“åã«ç®¡ç†ç•ªå·é…ç½®');
      const descCheckbox = document.getElementById('èª¬æ˜æ–‡ã«ç®¡ç†ç•ªå·é…ç½®');
      const formatSelect = document.getElementById('ç®¡ç†ç•ªå·å½¢å¼');
      const formatSelector = document.getElementById('ç®¡ç†ç•ªå·å½¢å¼é¸æŠ');

      if (titleCheckbox) titleCheckbox.checked = settings.inTitle || false;
      if (descCheckbox) descCheckbox.checked = settings.inDesc || false;
      if (formatSelect) formatSelect.value = settings.format || 'ã€ã€‘';

      // å½¢å¼é¸æŠã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°
      if (formatSelector && titleCheckbox) {
        formatSelector.style.display = titleCheckbox.checked ? 'block' : 'none';
      }
    } catch (e) {
      console.warn('LocalStorageèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
    }
  }

  // ç®¡ç†ç•ªå·é…ç½®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
  function toggleManagementNumberOptions() {
    const titleCheckbox = document.getElementById('å•†å“åã«ç®¡ç†ç•ªå·é…ç½®');
    const descCheckbox = document.getElementById('èª¬æ˜æ–‡ã«ç®¡ç†ç•ªå·é…ç½®');
    const formatSelector = document.getElementById('ç®¡ç†ç•ªå·å½¢å¼é¸æŠ');

    // å•†å“åãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒONã®æ™‚ã ã‘å½¢å¼é¸æŠã‚’è¡¨ç¤º
    if (formatSelector) {
      if (titleCheckbox && titleCheckbox.checked) {
        formatSelector.style.display = 'block';
      } else {
        formatSelector.style.display = 'none';
      }
    }

    // è¨­å®šã®ä¿å­˜ã¯ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã«è¡Œã†

    // å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
    updateNamePreview();

    // å•†å“ã®èª¬æ˜ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
    if (typeof updateDescriptionFromDetail === 'function') {
      updateDescriptionFromDetail();
    }
  }

  // ã‚¢ã‚¤ãƒ†ãƒ åè¡¨ç¤ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ›´æ–°ï¼ˆåŸºæœ¬æƒ…å ±â†’å•†å“åãƒ–ãƒ­ãƒƒã‚¯ã¸è‡ªå‹•åæ˜ ï¼‰
  function updateItemNameDisplay() {
    try {
      console.log('â˜…â˜…â˜… updateItemNameDisplay() ãŒå‘¼ã°ã‚Œã¾ã—ãŸ');
      const basicItemName = _val('ã‚¢ã‚¤ãƒ†ãƒ å');
      const titleItemField = document.getElementById('å•†å“å_ã‚¢ã‚¤ãƒ†ãƒ å');

      if (titleItemField && basicItemName) {
        titleItemField.value = basicItemName;
        updateNamePreview();
      }

      // === ä¸­åˆ†é¡ã«å¿œã˜ã¦ã‚µã‚¤ã‚ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆ ===
      const chuBunrui = _val('ä¸­åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');
      console.log(`â˜…â˜…â˜… ä¸­åˆ†é¡ã‚’å–å¾—ã—ã¾ã—ãŸ: "${chuBunrui}"`);
      updateSizeSectionDisplay(chuBunrui);
    } catch (error) {
      console.error('updateItemNameDisplay ã‚¨ãƒ©ãƒ¼:', error);
      // ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦ã‚‚å‡¦ç†ã‚’ç¶šè¡Œ
    }
  }

  // ãƒ–ãƒ©ãƒ³ãƒ‰è¡¨ç¤ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ›´æ–°ï¼ˆåŸºæœ¬æƒ…å ±â†’å•†å“åãƒ–ãƒ­ãƒƒã‚¯ã¸è‡ªå‹•åæ˜ ï¼‰
  let updateBrandDisplayTimeout = null;
  function updateBrandDisplay() {
    // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†: 300mså¾…ã£ã¦ã‹ã‚‰å®Ÿè¡Œ
    clearTimeout(updateBrandDisplayTimeout);
    updateBrandDisplayTimeout = setTimeout(() => {
      const englishName = _val('ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)');
      const englishField = document.getElementById('å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)');
      const kanaField = document.getElementById('å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(ã‚«ãƒŠ)');
      const basicKanaField = document.getElementById('ãƒ–ãƒ©ãƒ³ãƒ‰(ã‚«ãƒŠ)');

      if (!englishField || !kanaField) return;

      if (englishName) {
        // å®Œå…¨ä¸€è‡´ã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒ‰ã®ã¿ã‚»ãƒƒãƒˆï¼ˆé€”ä¸­ã®æ–‡å­—åˆ—ã§ã¯åå¿œã—ãªã„ï¼‰
        const pairIndex = BRAND_INDEX_MAP.get(englishName);

        if (pairIndex !== undefined && BRAND_PAIRS[pairIndex]) {
          const kanaName = BRAND_PAIRS[pairIndex].kana;

          englishField.value = englishName;
          kanaField.value = kanaName;

          // åŸºæœ¬æƒ…å ±ãƒ–ãƒ­ãƒƒã‚¯ã®éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚‚ã‚«ãƒŠèª­ã¿ã‚’è¨­å®š
          if (basicKanaField) {
            basicKanaField.value = kanaName;
            console.log(`åŸºæœ¬æƒ…å ±ãƒ–ãƒ©ãƒ³ãƒ‰(ã‚«ãƒŠ)ã«è¨­å®š: "${kanaName}"`);
          }

          // å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
          updateNamePreview();
        }
      } else {
        // ç©ºã®å ´åˆã¯ã‚¯ãƒªã‚¢
        englishField.value = '';
        kanaField.value = '';
        englishField.placeholder = 'å…¥åŠ›ã™ã‚‹ã¨å€™è£œãŒè¡¨ç¤ºã•ã‚Œã¾ã™';
        kanaField.placeholder = 'å…¥åŠ›ã™ã‚‹ã¨å€™è£œãŒè¡¨ç¤ºã•ã‚Œã¾ã™';

        // åŸºæœ¬æƒ…å ±ãƒ–ãƒ­ãƒƒã‚¯ã®éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ã‚¯ãƒªã‚¢
        if (basicKanaField) {
          basicKanaField.value = '';
        }

        // å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
        updateNamePreview();
      }
    }, 300);
  }

  function wirePreviewWatchers() {
    const ids = new Set(['ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰','ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)','ã‚¢ã‚¤ãƒ†ãƒ å','ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰(ã‚«ãƒ†ã‚´ãƒª)',
  'å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)', 'å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(ã‚«ãƒŠ)', ...NAME_REST_FIELDS]);
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      const ev = (el.tagName === 'INPUT') ? 'input' : 'change';

      // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰è¿½åŠ 
      el.removeEventListener(ev, updateNamePreview);
      el.addEventListener(ev, updateNamePreview);

      // åŸºæœ¬æƒ…å ±ã®ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)ã®å ´åˆã¯ãƒ–ãƒ©ãƒ³ãƒ‰è¡¨ç¤ºã¨å•†å“èª¬æ˜ã‚‚æ›´æ–°
      if (id === 'ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)') {
        el.removeEventListener(ev, updateBrandDisplay);
        el.addEventListener(ev, updateBrandDisplay);
        el.removeEventListener(ev, updateDescriptionFromDetail);
        el.addEventListener(ev, updateDescriptionFromDetail);
      }
    });
  }

  function adjustDescHeight() {
    // ã“ã®é–¢æ•°ã¯ autoResizeTextarea() ã«ç½®ãæ›ãˆã‚‰ã‚Œã¾ã—ãŸ
    const ta = document.getElementById('å•†å“ã®èª¬æ˜');
    if (!ta) return;
    autoResizeTextarea(ta);
  }

  function updateDesc() {
    const ta = document.getElementById('å•†å“ã®èª¬æ˜');
    if (!ta) return;
    const text = (ta.value || '').toString();
    const count = Array.from(text).length;
    const counterEl = document.getElementById('descCounter');
    const descCountEl = document.getElementById('descCount');
    const descMaxEl = document.getElementById('descMax');
    if (descCountEl) descCountEl.textContent = count;
    if (descMaxEl) descMaxEl.textContent = DESC_LIMIT;
    if (counterEl) counterEl.classList.toggle('over', count > DESC_LIMIT);
    if (DESC_LIMIT_MODE === 'truncate' && count > DESC_LIMIT) {
      ta.value = Array.from(text).slice(0, DESC_LIMIT).join('');
    }
    adjustDescHeight();
  }

  function wireDescWatcher() {
    const ta = document.getElementById('å•†å“ã®èª¬æ˜');
    if (!ta) return;
    ta.addEventListener('input', updateDesc);
  }

  // ãƒ–ãƒ©ãƒ³ãƒ‰æƒ…å ±å–å¾—é–¢æ•°
  function getBrandInfo() {
    const englishName = _val('ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)');
    if (!englishName) return '';

    const pairIndex = BRAND_INDEX_MAP.get(englishName);
    const kanaName = pairIndex !== undefined && BRAND_PAIRS[pairIndex] ? BRAND_PAIRS[pairIndex].kana : '';
    return `ãƒ–ãƒ©ãƒ³ãƒ‰åï¼š${englishName}ï¼ˆ${kanaName}ï¼‰\n\n`;
  }

  // ã‚µã‚¤ã‚ºæƒ…å ±å–å¾—é–¢æ•°
  function getSizeInfo() {
    // ã‚µã‚¤ã‚º(è¡¨è¨˜)ã‚’å–å¾—ï¼ˆæœã¾ãŸã¯é´ï¼‰
    const sizeHyoki = _val('ã‚µã‚¤ã‚º(è¡¨è¨˜)_ãƒˆãƒƒãƒ—ã‚¹') || _val('ã‚µã‚¤ã‚º(è¡¨è¨˜)_ãƒœãƒˆãƒ ã‚¹') || _val('ã‚µã‚¤ã‚º(è¡¨è¨˜)_é´');

    // é´ã®è¿½åŠ æƒ…å ±ã‚’å–å¾—
    const shoesOtherSize = _val('ãã®ä»–ã®ã‚µã‚¤ã‚ºè¡¨è¨˜_é´');
    const shoesUsualSize = _val('æ™®æ®µã®ã‚µã‚¤ã‚º_é´');
    const shoesFit = _val('ãƒ•ã‚£ãƒƒãƒˆæ„Ÿ_é´');

    // ãƒ©ã‚°ãƒ©ãƒ³åˆ¤å®š
    const itemName = _val('ã‚¢ã‚¤ãƒ†ãƒ å');
    const isRaglan = itemName && itemName.includes('ãƒ©ã‚°ãƒ©ãƒ³');
    const shoulderLabel = isRaglan ? 'è£„ä¸ˆ' : 'è‚©å¹…';

    // ã‚µã‚¤ã‚º(å®Ÿå¯¸)ã‚’å–å¾—
    const sizeValues = {
      è‚©å¹…: _val('è‚©å¹…'),
      èº«å¹…: _val('èº«å¹…'),
      è¢–ä¸ˆ: _val('è¢–ä¸ˆ'),
      ç€ä¸ˆ: _val('ç€ä¸ˆ'),
      ã‚¦ã‚¨ã‚¹ãƒˆ: _val('ã‚¦ã‚¨ã‚¹ãƒˆ'),
      ãƒ’ãƒƒãƒ—: _val('ãƒ’ãƒƒãƒ—'),
      è‚¡ä¸Š: _val('è‚¡ä¸Š'),
      è‚¡ä¸‹: _val('è‚¡ä¸‹')
    };

    // é´ã¾ãŸã¯æœã®ã‚µã‚¤ã‚ºæƒ…å ±ãŒã‚ã‚‹ã‹ç¢ºèª
    const hasShoesSizeData = sizeHyoki && (_val('ã‚µã‚¤ã‚º(è¡¨è¨˜)_é´') !== '');
    const hasClothesSizeData = sizeHyoki && (Object.values(sizeValues).some(value => value) || _val('ã‚µã‚¤ã‚º(è¡¨è¨˜)_ãƒˆãƒƒãƒ—ã‚¹') || _val('ã‚µã‚¤ã‚º(è¡¨è¨˜)_ãƒœãƒˆãƒ ã‚¹'));

    if (!sizeHyoki && !shoesOtherSize && !shoesUsualSize && !shoesFit) return '';

    let sizeText = '';

    // ã‚µã‚¤ã‚º(è¡¨è¨˜)ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    if (sizeHyoki) {
      sizeText += `ã‚µã‚¤ã‚º(è¡¨è¨˜)ï¼š${sizeHyoki}\n`;
    }

    // é´ã®å ´åˆã®è¿½åŠ æƒ…å ±
    if (hasShoesSizeData || shoesOtherSize || shoesUsualSize || shoesFit) {
      if (shoesOtherSize) {
        sizeText += `ãã®ä»–ã®ã‚µã‚¤ã‚ºè¡¨è¨˜ï¼š${shoesOtherSize}\n`;
      }
      if (shoesUsualSize) {
        sizeText += `æ™®æ®µã®ã‚µã‚¤ã‚ºï¼š${shoesUsualSize}\n`;
      }
      if (shoesFit) {
        sizeText += `ãƒ•ã‚£ãƒƒãƒˆæ„Ÿï¼š${shoesFit}\n`;
      }
      sizeText += '\n';
      return sizeText; // é´ã®å ´åˆã¯å®Ÿå¯¸ã‚µã‚¤ã‚ºã‚’è¡¨ç¤ºã—ãªã„
    }

    // æœã®å ´åˆã®ã¿å®Ÿå¯¸ã‚µã‚¤ã‚ºã‚’è¡¨ç¤º
    if (sizeHyoki) {
      sizeText += '\n';
    }

    // ã‚µã‚¤ã‚º(å®Ÿå¯¸)ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    const hasJissunData = Object.values(sizeValues).some(value => value);
    if (hasJissunData) {
      sizeText += 'ã€ã‚µã‚¤ã‚º(å®Ÿå¯¸)ã€‘\n';
      if (sizeValues.è‚©å¹…) sizeText += `${shoulderLabel}ï¼š${sizeValues.è‚©å¹…}cm\n`;
      if (sizeValues.èº«å¹…) sizeText += `èº«å¹…ï¼š${sizeValues.èº«å¹…}cm\n`;
      if (sizeValues.è¢–ä¸ˆ) sizeText += `è¢–ä¸ˆï¼š${sizeValues.è¢–ä¸ˆ}cm\n`;
      if (sizeValues.ç€ä¸ˆ) sizeText += `ç€ä¸ˆï¼š${sizeValues.ç€ä¸ˆ}cm\n`;
      if (sizeValues.ã‚¦ã‚¨ã‚¹ãƒˆ) sizeText += `ã‚¦ã‚¨ã‚¹ãƒˆï¼š${sizeValues.ã‚¦ã‚¨ã‚¹ãƒˆ}cm\n`;
      if (sizeValues.ãƒ’ãƒƒãƒ—) sizeText += `ãƒ’ãƒƒãƒ—ï¼š${sizeValues.ãƒ’ãƒƒãƒ—}cm\n`;
      if (sizeValues.è‚¡ä¸Š) sizeText += `è‚¡ä¸Šï¼š${sizeValues.è‚¡ä¸Š}cm\n`;
      if (sizeValues.è‚¡ä¸‹) sizeText += `è‚¡ä¸‹ï¼š${sizeValues.è‚¡ä¸‹}cm\n`;
      sizeText += '\n';
    }

    return sizeText;
  }

  // ç´ ææƒ…å ±å–å¾—é–¢æ•°
  function getMaterialInfo() {
    let materialText = '';
    const items = document.querySelectorAll('.material-item');

    items.forEach((item, i) => {
      const index = i + 1;
      const location = _val(`ç´ æ${index}_ç®‡æ‰€`);
      const type1 = _val(`ç´ æ${index}_ç¨®é¡1`);
      const percent1 = _val(`ç´ æ${index}_ï¼…1`);
      const type2 = _val(`ç´ æ${index}_ç¨®é¡2`);
      const percent2 = _val(`ç´ æ${index}_ï¼…2`);

      if (location && type1) {
        materialText += `${location}: ${type1}`;
        if (percent1) materialText += ` ${percent1}%`;
        if (type2) {
          materialText += `, ${type2}`;
          if (percent2) materialText += ` ${percent2}%`;
        }
        materialText += '\n';
      }
    });

    if (materialText) {
      materialText = 'ã€ç´ æã€‘\n' + materialText + '\n';
    }

    return materialText;
  }

  function getColorInfo() {
    const items = document.querySelectorAll('.color-item');
    const colors = [];

    items.forEach((item, i) => {
      const index = i + 1;
      const colorValue = _val(`ã‚«ãƒ©ãƒ¼${index}`);
      if (colorValue) {
        colors.push(colorValue);
      }
    });

    if (colors.length > 0) {
      return 'ã‚«ãƒ©ãƒ¼(è©³ç´°)ï¼š' + colors.join('ã€') + '\n\n';
    }

    return '';
  }

  /**
   * é…ç½®é †åºã«å¾“ã£ã¦å•†å“èª¬æ˜ã‚’çµ„ã¿ç«‹ã¦ã‚‹
   * @param {Object} elements - å„è¦ç´ ã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆbrand, color, size, material, condition, ai, management, discount, hashtagï¼‰
   * @param {HTMLTextAreaElement} descTextarea - èª¬æ˜æ–‡ã‚’è¡¨ç¤ºã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢
   */
  function buildDescriptionByOrder(elements, descTextarea) {
    console.log('buildDescriptionByOrder é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ');

    // 1. HTMLè¦ç´ ã®å®Ÿéš›ã®é †åºã‚’å–å¾—ï¼ˆæœ€å„ªå…ˆï¼‰
    const actualBlocksOrder = getDescriptionBlocksOrder();
    console.log('å®Ÿéš›ã®ãƒ–ãƒ­ãƒƒã‚¯é †åº:', actualBlocksOrder);

    // 2. ãƒ–ãƒ­ãƒƒã‚¯ã‚¿ã‚¤ãƒ—ã¨elements[id]ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    const blockTypeToElementId = {
      'brandName': 'brand',
      'size': 'size',
      'color': 'color',
      'condition': 'condition',
      'material': 'material',
      'aiGeneration': 'aiGeneration',
      'discount': 'discount',
      'hashtag': 'hashtag'
    };

    // 3. å®Ÿéš›ã®é †åºã«åŸºã¥ã„ã¦é…ç½®é †åºã‚’æ§‹ç¯‰
    let order = [];
    if (actualBlocksOrder.length > 0) {
      order = actualBlocksOrder.map(blockType => ({
        id: blockTypeToElementId[blockType] || blockType,
        enabled: true
      }));
      console.log('å®Ÿéš›ã®ãƒ–ãƒ­ãƒƒã‚¯é †åºã‹ã‚‰é…ç½®é †åºã‚’ç”Ÿæˆ:', order);
    } else {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé †åº
      order = [
        { id: 'brand', enabled: true },
        { id: 'size', enabled: true },
        { id: 'color', enabled: true },
        { id: 'condition', enabled: true },
        { id: 'material', enabled: true },
        { id: 'ai', enabled: true },
        { id: 'discount', enabled: true },
        { id: 'hashtag', enabled: true }
      ];
      console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé †åºã‚’ä½¿ç”¨');
    }

    // 3. é…ç½®é †åºã«å¾“ã£ã¦èª¬æ˜æ–‡ã‚’çµ„ã¿ç«‹ã¦
    const parts = [];

    for (const item of order) {
      // ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹è¦ç´ ã¯ã‚¹ã‚­ãƒƒãƒ—
      if (item.enabled === false) {
        console.log(`è¦ç´  ${item.id} ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã‚¹ã‚­ãƒƒãƒ—`);
        continue;
      }

      // è¦ç´ ã®å†…å®¹ã‚’å–å¾—
      const content = elements[item.id];
      if (content && content.trim()) {
        parts.push(content.trim());
        console.log(`è¦ç´  ${item.id} ã‚’è¿½åŠ `);
      } else {
        console.log(`è¦ç´  ${item.id} ã¯ç©ºã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—`);
      }
    }

    // 4. å…¨è¦ç´ ã‚’çµåˆï¼ˆ2è¡Œã®ç©ºè¡Œã§åŒºåˆ‡ã‚‹ï¼‰
    const finalText = parts.join('\n\n');
    descTextarea.value = finalText;

    console.log('å•†å“èª¬æ˜ã‚’é…ç½®é †åºã«å¾“ã£ã¦ç”Ÿæˆã—ã¾ã—ãŸ:', finalText.length, 'æ–‡å­—');

    // 5. UIã‚’æ›´æ–°
    if (typeof updateDesc === 'function') {
      updateDesc();
    }
    autoResizeTextarea(descTextarea);
  }

  // ================= ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ =================

  // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒã‚’ä¿å­˜ã™ã‚‹é…åˆ—
  let uploadedImages = [];

  /**
   * ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
   * @param {Event} event - ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
   */
  function handleImageUpload(event) {
    const files = event.target.files;

    if (!files || files.length === 0) {
      return;
    }

    // æ—¢å­˜ã®ç”»åƒæ•°ã¨æ–°è¦ç”»åƒæ•°ã®åˆè¨ˆãŒ3ã‚’è¶…ãˆã‚‹å ´åˆã¯è­¦å‘Š
    if (uploadedImages.length + files.length > 3) {
      alert('ç”»åƒã¯æœ€å¤§3æšã¾ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™');
      return;
    }

    // å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã«å¤‰æ›
    Array.from(files).forEach((file, index) => {
      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ10MBåˆ¶é™ï¼‰
      if (file.size > 10 * 1024 * 1024) {
        alert(`${file.name}ã®ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆæœ€å¤§10MBï¼‰`);
        return;
      }

      // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‹ãƒã‚§ãƒƒã‚¯
      if (!file.type.startsWith('image/')) {
        alert(`${file.name}ã¯ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“`);
        return;
      }

      const reader = new FileReader();

      reader.onload = function(e) {
        const base64Data = e.target.result;

        uploadedImages.push({
          name: file.name,
          data: base64Data,
          mimeType: file.type
        });

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
        displayImagePreviews();

        debug.log(`ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ: ${file.name}`);
      };

      reader.onerror = function(error) {
        console.error('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        alert(`${file.name}ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ`);
      };

      reader.readAsDataURL(file);
    });
  }

  /**
   * ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
   */
  function displayImagePreviews() {
    const container = document.getElementById('imagePreviewContainer');
    const list = document.getElementById('imagePreviewList');
    const count = document.getElementById('imageCount');

    if (!container || !list || !count) {
      console.error('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    // ç”»åƒãŒãªã„å ´åˆã¯éè¡¨ç¤º
    if (uploadedImages.length === 0) {
      container.style.display = 'none';
      return;
    }

    // ç”»åƒãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
    container.style.display = 'block';
    count.textContent = uploadedImages.length;

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
    list.innerHTML = '';

    // å„ç”»åƒã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆ
    uploadedImages.forEach((image, index) => {
      const previewItem = document.createElement('div');
      previewItem.style.cssText = 'position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; border: 2px solid #e5e7eb;';

      previewItem.innerHTML = `
        <img src="${image.data}" alt="${image.name}" style="width: 100%; height: 100%; object-fit: cover;">
        <button
          type="button"
          onclick="removeImage(${index})"
          style="position: absolute; top: 4px; right: 4px; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0;"
          title="å‰Šé™¤"
        >Ã—</button>
      `;

      list.appendChild(previewItem);
    });
  }

  /**
   * ç”»åƒã‚’å‰Šé™¤
   * @param {number} index - å‰Šé™¤ã™ã‚‹ç”»åƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
   */
  function removeImage(index) {
    uploadedImages.splice(index, 1);
    displayImagePreviews();
    debug.log(`ç”»åƒã‚’å‰Šé™¤ã—ã¾ã—ãŸ (index: ${index})`);
  }

  /**
   * ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒã‚’å–å¾—
   * @returns {Array} Base64ç”»åƒãƒ‡ãƒ¼ã‚¿ã®é…åˆ—
   */
  function getUploadedImages() {
    return uploadedImages.map(img => ({
      data: img.data.split(',')[1], // Base64éƒ¨åˆ†ã®ã¿ï¼ˆdata:image/png;base64,ã‚’é™¤ãï¼‰
      mimeType: img.mimeType
    }));
  }

  // ================= AIç”Ÿæˆæ©Ÿèƒ½ =================

  /**
   * AIç”Ÿæˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
   * å•†å“æƒ…å ±ã‚’åé›†ã—ã¦Gemini APIã§èª¬æ˜æ–‡ã‚’ç”Ÿæˆ
   */
  function generateAiDescription() {
    try {
      debug.log('AIèª¬æ˜æ–‡ç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã™');

      // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’å¤‰æ›´ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºï¼‰
      const aiGenBtn = document.getElementById('aiGenBtn');
      if (!aiGenBtn) {
        console.error('AIç”Ÿæˆãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      // å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿å­˜
      const originalText = aiGenBtn.innerHTML;

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«å¤‰æ›´
      aiGenBtn.disabled = true;
      aiGenBtn.innerHTML = 'â³ ç”Ÿæˆä¸­...';
      aiGenBtn.style.opacity = '0.6';
      aiGenBtn.style.cursor = 'wait';

      // å•†å“æƒ…å ±ã‚’åé›†
      const productInfo = collectProductInfo();

      // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const images = getUploadedImages();

      debug.log('åé›†ã—ãŸå•†å“æƒ…å ±:', productInfo);
      debug.log('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒæ•°:', images.length);

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!productInfo.brandName || !productInfo.itemName) {
        alert('âŒ ãƒ–ãƒ©ãƒ³ãƒ‰åã¨ã‚¢ã‚¤ãƒ†ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        resetAiButton(aiGenBtn, originalText);
        return;
      }

      // ã‚µãƒ¼ãƒãƒ¼å´ã®APIå‘¼ã³å‡ºã—
      google.script.run
        .withSuccessHandler(function(generatedText) {
          debug.log('AIç”ŸæˆæˆåŠŸ:', generatedText);

          // AIç”Ÿæˆæ–‡ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
          AI_GENERATED_TEXT = generatedText;

          // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
          updateDescriptionFromDetail();

          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          alert(`âœ… AIèª¬æ˜æ–‡ã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼

å•†å“ã®èª¬æ˜ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºèªã—ã¦ã€å¿…è¦ã«å¿œã˜ã¦ç›´æ¥ç·¨é›†ã—ã¦ãã ã•ã„ã€‚

âš ï¸ æ³¨æ„äº‹é …
â€¢ å“ç•ªã‹ã‚‰å–å¾—ã—ãŸæƒ…å ±ã¯ã€Googleæ¤œç´¢çµæœã®å“è³ªã«ä¾å­˜ã—ã¾ã™
â€¢ ç”»åƒã‹ã‚‰å–å¾—ã—ãŸæƒ…å ±ã¯ã€AIã®åˆ¤æ–­ã«åŸºã¥ã„ã¦ã„ã¾ã™
â€¢ å¿…ãšå†…å®¹ã‚’ã”ç¢ºèªã®ä¸Šã€èª¤ã‚ŠãŒã‚ã‚Œã°ä¿®æ­£ã—ã¦ãã ã•ã„`);

          // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
          resetAiButton(aiGenBtn, originalText);

          // ç”»åƒãƒ‡ãƒ¼ã‚¿ã¯ã‚¯ãƒªã‚¢ã—ãªã„ï¼ˆä¿å­˜æ™‚ã«ç”»åƒURLã‚’è¨˜éŒ²ã™ã‚‹ãŸã‚ï¼‰
          debug.log('AIç”ŸæˆæˆåŠŸã€‚ç”»åƒãƒ‡ãƒ¼ã‚¿ã¯ä¿å­˜æ™‚ã¾ã§ä¿æŒã—ã¾ã™ã€‚');
        })
        .withFailureHandler(function(error) {
          console.error('AIç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);

          // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
          let errorMsg = 'AIèª¬æ˜æ–‡ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n';

          if (error.message && error.message.includes('NG(CONFIG)')) {
            errorMsg += 'APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\n';
            errorMsg += 'ã€è¨­å®šæ‰‹é †ã€‘\n';
            errorMsg += '1. Google Apps Scriptã‚¨ãƒ‡ã‚£ã‚¿ã‚’é–‹ã\n';
            errorMsg += '2. âš™ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®šã‚’é–‹ã\n';
            errorMsg += '3. ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«è¿½åŠ :\n';
            errorMsg += '   ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£: GEMINI_API_KEY\n';
            errorMsg += '   å€¤: ã‚ãªãŸã®APIã‚­ãƒ¼';
          } else if (error.message && error.message.includes('NG(API)')) {
            errorMsg += 'APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n';
            errorMsg += 'ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚\n\n';
            errorMsg += `ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.message}`;
          } else {
            errorMsg += `ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.message || 'Unknown error'}`;
          }

          alert('âŒ ' + errorMsg);

          // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
          resetAiButton(aiGenBtn, originalText);
        })
        .generateProductDescription(productInfo, images);

    } catch (error) {
      console.error('AIç”Ÿæˆå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
      alert('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);

      // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
      const aiGenBtn = document.getElementById('aiGenBtn');
      if (aiGenBtn) {
        resetAiButton(aiGenBtn, 'âœ¨ AIç”Ÿæˆ');
      }
    }
  }

  /**
   * å•†å“æƒ…å ±ã‚’åé›†ï¼ˆAIç”Ÿæˆç”¨ï¼‰
   * @returns {Object} å•†å“æƒ…å ±ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  function collectProductInfo() {
    const productInfo = {};

    // ãƒ–ãƒ©ãƒ³ãƒ‰åï¼ˆåŸºæœ¬æƒ…å ±ãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰å„ªå…ˆå–å¾—ï¼‰
    productInfo.brandName = _val('ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)') || _val('å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)') || '';
    productInfo.brandKana = _val('ãƒ–ãƒ©ãƒ³ãƒ‰(ã‚«ãƒŠ)') || _val('å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(ã‚«ãƒŠ)') || '';

    // ã‚¢ã‚¤ãƒ†ãƒ åï¼ˆåŸºæœ¬æƒ…å ±ãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰å„ªå…ˆå–å¾—ã€ãªã‘ã‚Œã°å•†å“åãƒ–ãƒ­ãƒƒã‚¯ï¼‰
    productInfo.itemName = _val('ã‚¢ã‚¤ãƒ†ãƒ å') || _val('å•†å“å_ã‚¢ã‚¤ãƒ†ãƒ å') || '';

    // ã‚«ãƒ†ã‚´ãƒªï¼ˆéšå±¤æƒ…å ±ã‚’çµ±åˆï¼‰
    const categories = [];
    const daiCategory = _val('å¤§åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');
    const chuCategory = _val('ä¸­åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');
    const shoCategory = _val('å°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');
    if (daiCategory) categories.push(daiCategory);
    if (chuCategory) categories.push(chuCategory);
    if (shoCategory) categories.push(shoCategory);
    productInfo.category = categories.join(' > ');

    // ã‚µã‚¤ã‚º
    productInfo.size = _val('ã‚µã‚¤ã‚º(è¡¨è¨˜)_ãƒˆãƒƒãƒ—ã‚¹') || _val('ã‚µã‚¤ã‚º(è¡¨è¨˜)_ãƒœãƒˆãƒ ã‚¹') || _val('ã‚µã‚¤ã‚º') || '';

    // å•†å“ã®çŠ¶æ…‹
    productInfo.condition = _val('å•†å“ã®çŠ¶æ…‹') || '';

    // ç´ ææƒ…å ±ã‚’åé›†
    const materials = [];
    for (let i = 1; i <= 10; i++) {
      const location = _val(`ç´ æ${i}_ç®‡æ‰€`);
      const type1 = _val(`ç´ æ${i}_ç¨®é¡1`);
      const percent1 = _val(`ç´ æ${i}_ï¼…1`);

      if (location || type1) {
        let materialStr = '';
        if (location) materialStr += location + ': ';
        if (type1) {
          materialStr += type1;
          if (percent1) materialStr += ` ${percent1}%`;
        }
        materials.push(materialStr);
      }
    }
    productInfo.material = materials.join(', ');

    // ã‚«ãƒ©ãƒ¼æƒ…å ±ã‚’åé›†ï¼ˆselectãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‹ã‚‰ï¼‰
    const colors = [];
    for (let i = 1; i <= 10; i++) {
      const colorValue = _val(`ã‚«ãƒ©ãƒ¼${i}`);
      if (colorValue) {
        colors.push(colorValue);
        debug.log(`ã‚«ãƒ©ãƒ¼${i}: ${colorValue}`);
      }
    }
    productInfo.color = colors.join(', ');
    debug.log(`åé›†ã—ãŸã‚«ãƒ©ãƒ¼æƒ…å ±: "${productInfo.color}"`);

    // å•†å“å±æ€§ã‚’åé›†ï¼ˆå•†å“åãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰ï¼‰
    const attributes = [];
    for (let i = 1; i <= 10; i++) {
      const attrValue = _val(`å•†å“å±æ€§${i}`);
      if (attrValue) {
        attributes.push(attrValue);
      }
    }

    // AIç”Ÿæˆç”¨ è¿½åŠ å±æ€§ã‚’åé›†ï¼ˆå•†å“ã®èª¬æ˜ãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰ï¼‰
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã‚ãšç›´æ¥å–å¾—ï¼ˆæœ€æ–°ã®å€¤ã‚’ç¢ºå®Ÿã«å–å¾—ã™ã‚‹ãŸã‚ï¼‰
    const aiAttributesElement = document.getElementById('AIç”¨å•†å“å±æ€§');
    const aiAttributesText = aiAttributesElement ? aiAttributesElement.value.trim() : '';

    debug.log(`AIç”¨å•†å“å±æ€§ã®å€¤: "${aiAttributesText}"`);

    if (aiAttributesText) {
      // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§åˆ†å‰²ã—ã¦è¿½åŠ 
      const aiAttributes = aiAttributesText.split(',').map(attr => attr.trim()).filter(attr => attr);
      attributes.push(...aiAttributes);
      debug.log(`AIç”¨å•†å“å±æ€§ã‚’è¿½åŠ ã—ã¾ã—ãŸ: ${aiAttributes.join(', ')}`);
    }

    productInfo.attributes = attributes.join(', ');
    debug.log(`æœ€çµ‚çš„ãªattributes: "${productInfo.attributes}"`);

    // å“ç•ªãƒ»å‹ç•ªã‚’åé›†ï¼ˆGoogle Search Groundingç”¨ï¼‰
    productInfo.modelNumber = _val('å“ç•ªå‹ç•ª') || '';

    return productInfo;
  }

  /**
   * AIç”Ÿæˆãƒœã‚¿ãƒ³ã‚’å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
   * @param {HTMLElement} button - ãƒœã‚¿ãƒ³è¦ç´ 
   * @param {string} originalText - å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ
   */
  function resetAiButton(button, originalText) {
    if (!button) return;

    button.disabled = false;
    button.innerHTML = originalText;
    button.style.opacity = '1';
    button.style.cursor = 'pointer';
  }

  // ================= å•†å“ã®èª¬æ˜ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ =================

  /**
   * å•†å“ã®èª¬æ˜ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
   * ãƒ–ãƒ©ãƒ³ãƒ‰ã€ã‚«ãƒ©ãƒ¼ã€ã‚µã‚¤ã‚ºã€ç´ æã€å•†å“çŠ¶æ…‹ã€ç®¡ç†ç•ªå·ã€å‰²å¼•æƒ…å ±ã€ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’çµ„ã¿ç«‹ã¦ã‚‹
   * @throws {Error} è¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã‚„å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆ
   */
  function updateDescriptionFromDetail() {
    try {
        console.log('updateDescriptionFromDetail é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ');
        const detailInput = document.getElementById('å•†å“çŠ¶æ…‹è©³ç´°');
        const descTextarea = document.getElementById('å•†å“ã®èª¬æ˜');
        if (!detailInput || !descTextarea) {
          console.error('è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', { detailInput, descTextarea });
          return;
        }

        // ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
        updateHashtagCheckboxPreviews();

        // ãƒ–ãƒ©ãƒ³ãƒ‰æƒ…å ±ã‚’å–å¾—
        const brandText = getBrandInfo();

        // ã‚«ãƒ©ãƒ¼æƒ…å ±ã‚’å–å¾—
        const colorText = getColorInfo();

        // ã‚µã‚¤ã‚ºæƒ…å ±ã‚’å–å¾—
        const sizeText = getSizeInfo();

          // ç´ ææƒ…å ±ã‚’åé›†
          const materialText = getMaterialInfo();

          // å•†å“ã®çŠ¶æ…‹ã‚’å–å¾—ï¼ˆåŸºæœ¬æƒ…å ±ãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰ï¼‰
          const conditionSelect = document.getElementById('å•†å“ã®çŠ¶æ…‹');
          const conditionValue = conditionSelect ? (conditionSelect.value || '').trim() : '';
          let conditionSection = '';
          if (conditionValue) {
            conditionSection = `å•†å“ã®çŠ¶æ…‹ï¼š${conditionValue}\n\n`;
          }

          // å•†å“çŠ¶æ…‹è©³ç´°ã‚’å–å¾—
          const detailText = (detailInput.value || '').trim();
          let detailSection = '';
          if (detailText) {
            detailSection = `å•†å“çŠ¶æ…‹(è©³ç´°)ï¼š\n${detailText}\n\n`;
          }

          // AIç”Ÿæˆæ–‡ã‚’å–å¾—
          let aiGenerationSection = '';
          if (AI_GENERATED_TEXT) {
            aiGenerationSection = `${AI_GENERATED_TEXT}\n\n`;
          }

        // ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ç”Ÿæˆ
          const hashtags = generateHashtags();
          const hashtagText = hashtags.join('\n');

          // ç®¡ç†ç•ªå·ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆèª¬æ˜æ–‡ã«é…ç½®ãŒONã®å ´åˆï¼‰
          let managementNumberSection = '';
          const mgmtDescCheckbox = document.getElementById('èª¬æ˜æ–‡ã«ç®¡ç†ç•ªå·é…ç½®');
          if (mgmtDescCheckbox && mgmtDescCheckbox.checked) {
            const mgmtNumber = _val('ç®¡ç†ç•ªå·');
            if (mgmtNumber) {
              managementNumberSection = `ç®¡ç†ç•ªå·ï¼š${mgmtNumber}\n\n`;
            }
          }

          // å‰²å¼•æ¡ˆå†…ãƒ†ã‚­ã‚¹ãƒˆï¼ˆè¨­å®šã‚·ãƒ¼ãƒˆå¯¾å¿œç‰ˆï¼‰
          const discountInfo = generateDiscountInfo();

          // é…ç½®é †åºã‚’å–å¾—ã—ã¦èª¬æ˜æ–‡ã‚’çµ„ã¿ç«‹ã¦
          buildDescriptionByOrder({
            brand: brandText,
            size: sizeText,
            color: colorText,
            condition: detailSection,
            material: materialText,
            aiGeneration: aiGenerationSection,
            discount: discountInfo,
            hashtag: hashtagText
          }, descTextarea);
    } catch (error) {
      console.error('å•†å“ã®èª¬æ˜æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      debug.error('updateDescriptionFromDetail ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  function setupDetailEventListener() {
    console.log('setupDetailEventListener é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ');
    const detailInput = document.getElementById('å•†å“çŠ¶æ…‹è©³ç´°');
    if (detailInput) {
      // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
      detailInput.removeEventListener('input', updateDescriptionFromDetail);
      // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      detailInput.addEventListener('input', updateDescriptionFromDetail);
      console.log('å•†å“çŠ¶æ…‹(è©³ç´°)ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');
      // ãƒ†ã‚¹ãƒˆç”¨: åˆå›å®Ÿè¡Œ
      updateDescriptionFromDetail();
    } else {
      console.error('å•†å“çŠ¶æ…‹è©³ç´°ã®è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }

    // é´ã®ã‚µã‚¤ã‚ºé–¢é€£é …ç›®ã«ã‚‚ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    const shoesFields = [
      'ã‚µã‚¤ã‚º(è¡¨è¨˜)_é´',
      'ãã®ä»–ã®ã‚µã‚¤ã‚ºè¡¨è¨˜_é´',
      'æ™®æ®µã®ã‚µã‚¤ã‚º_é´',
      'ãƒ•ã‚£ãƒƒãƒˆæ„Ÿ_é´'
    ];

    shoesFields.forEach(fieldId => {
      const element = document.getElementById(fieldId);
      if (element) {
        const eventType = element.tagName === 'SELECT' ? 'change' : 'input';
        element.removeEventListener(eventType, updateDescriptionFromDetail);
        element.addEventListener(eventType, updateDescriptionFromDetail);
        console.log(`${fieldId}ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†`);
      }
    });
  }

  // ================= æ–°ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ  =================
  function initializeSalesWords() {
    console.log('=== ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰åˆæœŸåŒ–é–‹å§‹ ===');
    if (!(google && google.script && google.script.run)) {
      console.log('google.script.run ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
      setupFallbackSalesWords();
      return;
    }

    // ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰å°‚ç”¨ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨è¨­å®šãƒã‚¹ã‚¿ã‹ã‚‰ã®ã€Œã‚ˆãä½¿ã†ã€èª­ã¿è¾¼ã¿ã‚’ä¸¦è¡Œå®Ÿè¡Œ
    let salesWordData = null;
    let favoriteSalesWords = [];
    // defaultSalesword ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å®£è¨€æ¸ˆã¿ï¼ˆ190è¡Œç›®ï¼‰

    google.script.run
      .withSuccessHandler(function(data) {
        console.log('ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', data);
        salesWordData = data;
        checkAndSetup();
      })
      .withFailureHandler(function(error) {
        console.error('ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        setupFallbackSalesWords();
      })
      .getSalesWordData();

    google.script.run
      .withSuccessHandler(function(config) {
        if (config && config.ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰) {
          // æ–°ã—ã„æ§‹é€ ï¼ˆã‚ˆãä½¿ã† + è¡¨ç¤ºå½¢å¼ + ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã«å¯¾å¿œ
          if (typeof config.ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ === 'object' && config.ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰.ã‚ˆãä½¿ã†) {
            favoriteSalesWords = config.ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰.ã‚ˆãä½¿ã† || [];
            // è¡¨ç¤ºå½¢å¼è¨­å®šã‚’èª­ã¿è¾¼ã¿
            if (config.ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰.è¡¨ç¤ºå½¢å¼) {
              SALESWORD_FORMAT = config.ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰.è¡¨ç¤ºå½¢å¼;
              console.log('ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºå½¢å¼å–å¾—æˆåŠŸ:', SALESWORD_FORMAT);
            }
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã‚’èª­ã¿è¾¼ã¿
            if (config.ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ) {
              defaultSalesword = config.ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ;
              console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰å–å¾—æˆåŠŸ:', defaultSalesword);
            }
          } else {
            // æ—§å½¢å¼ï¼ˆé…åˆ—ã®ã¿ï¼‰ã«å¯¾å¿œ
            favoriteSalesWords = config.ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰;
          }
          console.log('ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰å–å¾—æˆåŠŸ:', favoriteSalesWords);
        }
        checkAndSetup();
      })
      .withFailureHandler(function(error) {
        console.error('ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        checkAndSetup();
      })
      .loadConfigMaster();

    function checkAndSetup() {
      if (salesWordData !== null) {
        SALESWORD_DATA = salesWordData;

        // ã€Œã‚ˆãä½¿ã†ã€ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ 
        if (favoriteSalesWords.length > 0) {
          SALESWORD_DATA.wordsByCategory['ã‚ˆãä½¿ã†'] = favoriteSalesWords;
        }

        setupCategoryDropdown();

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’é©ç”¨
        applyDefaultSalesword(defaultSalesword);

        console.log('ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰åˆæœŸåŒ–å®Œäº†');
      }
    }
  }

  function setupCategoryDropdown() {
    const categorySelect = document.getElementById('ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰(ã‚«ãƒ†ã‚´ãƒª)');
    if (!categorySelect) {
      console.log('ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰(ã‚«ãƒ†ã‚´ãƒª)è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ã‚¯ãƒªã‚¢
    categorySelect.innerHTML = '<option value="">-- ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ --</option>';

    // ã€Œã‚ˆãä½¿ã†ã€ã‚«ãƒ†ã‚´ãƒªã‚’å…ˆé ­ã«è¿½åŠ 
    if (SALESWORD_DATA.wordsByCategory['ã‚ˆãä½¿ã†']) {
      const option = document.createElement('option');
      option.value = 'ã‚ˆãä½¿ã†';
      option.textContent = 'â­ ã‚ˆãä½¿ã†';
      categorySelect.appendChild(option);
    }

    // ãã®ä»–ã®ã‚«ãƒ†ã‚´ãƒªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
    SALESWORD_DATA.categories.forEach(category => {
      const option = document.createElement('option');
      option.value = category;
      option.textContent = category;
      categorySelect.appendChild(option);
    });

    const totalCategories = SALESWORD_DATA.categories.length + (SALESWORD_DATA.wordsByCategory['ã‚ˆãä½¿ã†'] ? 1 : 0);
    console.log(`ã‚«ãƒ†ã‚´ãƒªãƒ—ãƒ«ãƒ€ã‚¦ãƒ³è¨­å®šå®Œäº†: ${totalCategories}ä»¶`);
    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
    resetKeywordDropdown();
  }

  function resetKeywordDropdown() {
    const keywordSelect = document.getElementById('ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰');
    if (!keywordSelect) {
      console.log('ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    keywordSelect.innerHTML = '<option value="">-- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’é¸æŠ --</option>';
    keywordSelect.disabled = true;
  }

  function onSalesWordCategoryChanged() {
    const categorySelect = document.getElementById('ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰(ã‚«ãƒ†ã‚´ãƒª)');
    const keywordSelect = document.getElementById('ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰');
    if (!categorySelect || !keywordSelect) {
      console.log('ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      updateNamePreview();
      return;
    }
    const selectedCategory = categorySelect.value.trim();
    if (!selectedCategory) {
      resetKeywordDropdown();
      updateNamePreview();
      return;
    }
    console.log('ã‚«ãƒ†ã‚´ãƒªé¸æŠ:', selectedCategory);
    // é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—
    const categoryWords = SALESWORD_DATA.wordsByCategory[selectedCategory] || [];
    // é‡è¤‡ã‚’æ’é™¤
    const uniqueWords = [...new Set(categoryWords)];
    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
    keywordSelect.innerHTML = '<option value="">-- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’é¸æŠ --</option>';
    uniqueWords.forEach(word => {
      const option = document.createElement('option');
      option.value = word;
      // è¡¨ç¤ºã¯å…ƒã®å€¤ã®ã¾ã¾ï¼ˆå½¢å¼ã¯é©ç”¨ã—ãªã„ï¼‰
      option.textContent = word;
      keywordSelect.appendChild(option);
    });
    keywordSelect.disabled = categoryWords.length === 0;
    console.log(`ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¨­å®šå®Œäº†: ${categoryWords.length}ä»¶`);
    updateNamePreview();
  }

  function setupFallbackSalesWords() {
    console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š');
    const fallbackCategories = [
      'ä¾¡æ ¼ãƒ»ã‚»ãƒ¼ãƒ«', 'å¸Œå°‘æ€§ãƒ»åœ¨åº«çŠ¶æ³', 'çŠ¶æ…‹ãƒ»ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³',
      'å–å¼•ãƒ»é…é€æ–¹æ³•', 'å•†å“ã‚¿ã‚¤ãƒ—ãƒ»ã‚¸ãƒ£ãƒ³ãƒ«'
    ];
    const fallbackWords = {
      'ä¾¡æ ¼ãƒ»ã‚»ãƒ¼ãƒ«': ['ã€ã‚»ãƒ¼ãƒ«ã€‘', 'ã€ç‰¹ä¾¡ã€‘', 'ã€å€¤ä¸‹ã’ã€‘'],
      'å¸Œå°‘æ€§ãƒ»åœ¨åº«çŠ¶æ³': ['ã€ãƒ¬ã‚¢ã€‘', 'ã€é™å®šã€‘', 'ã€1ç‚¹ã‚‚ã®ã€‘'],
      'çŠ¶æ…‹ãƒ»ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³': ['ã€ç¾å“ã€‘', 'ã€æ–°å“åŒæ§˜ã€‘', 'ã€è‰¯å“ã€‘'],
      'å–å¼•ãƒ»é…é€æ–¹æ³•': ['ã€åŒ¿åé…é€ã€‘', 'ã€é€æ–™ç„¡æ–™ã€‘'],
      'å•†å“ã‚¿ã‚¤ãƒ—ãƒ»ã‚¸ãƒ£ãƒ³ãƒ«': ['ã€å¤ç€ã€‘', 'ã€ãƒ´ã‚£ãƒ³ãƒ†ãƒ¼ã‚¸ã€‘']
    };
    SALESWORD_DATA = {
      categories: fallbackCategories,
      wordsByCategory: fallbackWords,
      allWords: Object.values(fallbackWords).flat()
    };
    setupCategoryDropdown();
  }

  function setupSalesWordEventListeners() {
    const categorySelect = document.getElementById('ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰(ã‚«ãƒ†ã‚´ãƒª)');
    if (categorySelect) {
      // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
      categorySelect.removeEventListener('change', onSalesWordCategoryChanged);
      // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      categorySelect.addEventListener('change', onSalesWordCategoryChanged);
      console.log('ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');
    }
  }

  /**
   * ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’é©ç”¨
   */
  function applyDefaultSalesword(defaultConfig) {
    if (!defaultConfig || !defaultConfig.ã‚«ãƒ†ã‚´ãƒª || !defaultConfig.ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰) {
      console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }

    const categorySelect = document.getElementById('ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰(ã‚«ãƒ†ã‚´ãƒª)');
    const saleswordSelect = document.getElementById('ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰');

    if (!categorySelect || !saleswordSelect) {
      console.log('ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    // ã‚«ãƒ†ã‚´ãƒªã‚’è¨­å®š
    categorySelect.value = defaultConfig.ã‚«ãƒ†ã‚´ãƒª;
    console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ†ã‚´ãƒªã‚’è¨­å®š:', defaultConfig.ã‚«ãƒ†ã‚´ãƒª);

    // ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ï¼ˆã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°ï¼‰
    onSalesWordCategoryChanged();

    // ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³æ›´æ–°å¾Œã«è¨­å®šï¼‰
    setTimeout(() => {
      saleswordSelect.value = defaultConfig.ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰;
      console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š:', defaultConfig.ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰);

      // å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
      if (typeof updateNamePreview === 'function') {
        updateNamePreview();
      }
    }, 100);
  }

  // ================= ã‚«ãƒ†ã‚´ãƒªéšå±¤ =================
  function filterByCategory(rows) {
    const l1 = (document.getElementById('å¤§åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)')?.value||'').trim();
    const l2 = (document.getElementById('ä¸­åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)')?.value||'').trim();
    const l3 = (document.getElementById('å°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)')?.value||'').trim();
    const l4 = (document.getElementById('ç´°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)')?.value||'').trim();
    const l5 = (document.getElementById('ç´°åˆ†é¡2')?.value||'').trim();
    let r = rows.slice();
    if (l1) r = r.filter(x=> x.å¤§åˆ†é¡ === l1);
    if (l2) r = r.filter(x=> x.ä¸­åˆ†é¡ === l2);
    if (l3) r = r.filter(x=> x.å°åˆ†é¡ === l3);
    if (l4) r = r.filter(x=> x.ç´°åˆ†é¡ === l4);
    if (l5) r = r.filter(x=> x.ç´°åˆ†é¡2 === l5);
    return r;
  }

  function refreshItems() {
    const rows = filterByCategory(CAT_ROWS);
    fillSelectSafe(document.getElementById('ã‚¢ã‚¤ãƒ†ãƒ å'), uniqKeepOrder(rows.map(r=>r.ã‚¢ã‚¤ãƒ†ãƒ å)));
    updateItemNameDisplay();
    updateNamePreview();
  }

  /**
   * ä¸­åˆ†é¡ã«å¿œã˜ã¦ã‚µã‚¤ã‚ºãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®é¸æŠè‚¢ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
   * @param {string} chuBunrui - ä¸­åˆ†é¡ã®å€¤
   */
  function updateSizeOptions(chuBunrui) {
    try {
      debug.log(`updateSizeOptions() ãŒå‘¼ã°ã‚Œã¾ã—ãŸã€‚ä¸­åˆ†é¡: "${chuBunrui}"`);
      const sizeSelect = document.getElementById('ã‚µã‚¤ã‚º');
      if (!sizeSelect) {
        debug.log('ã‚µã‚¤ã‚ºãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      const currentValue = sizeSelect.value; // ç¾åœ¨ã®é¸æŠå€¤ã‚’ä¿æŒ

      // ä¸­åˆ†é¡ãŒã€Œé´ã€ã®å ´åˆã¯é´ç”¨ã‚µã‚¤ã‚ºã€ãã‚Œä»¥å¤–ã¯æœç”¨ã‚µã‚¤ã‚º
      if (chuBunrui === 'é´') {
        // å¤§åˆ†é¡ã§ãƒ¡ãƒ³ã‚º/ãƒ¬ãƒ‡ã‚£ãƒ¼ã‚¹ã‚’åˆ¤å®š
        const daiBunrui = _val('å¤§åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');
        const shoeSizes = [];

        if (daiBunrui === 'ãƒ¡ãƒ³ã‚º') {
          // ãƒ¡ãƒ³ã‚º: 23.5cmä»¥ä¸‹ã€24cmï½30.5cmã€31cmä»¥ä¸Š
          shoeSizes.push('23.5cmä»¥ä¸‹');
          for (let size = 24.0; size <= 30.5; size += 0.5) {
            shoeSizes.push(size.toFixed(1) + 'cm');
          }
          shoeSizes.push('31cmä»¥ä¸Š');
        } else if (daiBunrui === 'ãƒ¬ãƒ‡ã‚£ãƒ¼ã‚¹') {
          // ãƒ¬ãƒ‡ã‚£ãƒ¼ã‚¹: 20cmä»¥ä¸‹ã€20.5cmï½27cmã€27.5cmä»¥ä¸Š
          shoeSizes.push('20cmä»¥ä¸‹');
          for (let size = 20.5; size <= 27.0; size += 0.5) {
            shoeSizes.push(size.toFixed(1) + 'cm');
          }
          shoeSizes.push('27.5cmä»¥ä¸Š');
        } else {
          // ãã®ä»–ï¼ˆã‚­ãƒƒã‚ºãªã©ï¼‰: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
          for (let size = 22.0; size <= 30.0; size += 0.5) {
            shoeSizes.push(size.toFixed(1) + 'cm');
          }
        }

        fillSelectSafe(sizeSelect, shoeSizes);
        debug.log(`ã‚µã‚¤ã‚ºãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’é´ç”¨ã‚µã‚¤ã‚ºã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸï¼ˆ${daiBunrui}ï¼‰`);
      } else {
        // æœç”¨ã‚µã‚¤ã‚º: ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã¯ä½•ã‚‚ã—ãªã„ï¼‰
        try {
          const sizeOptions = MASTER_OPTIONS && MASTER_OPTIONS['ã‚µã‚¤ã‚º'] ? MASTER_OPTIONS['ã‚µã‚¤ã‚º'] : [];
          if (sizeOptions.length > 0) {
            fillSelectSafe(sizeSelect, sizeOptions);
            debug.log('ã‚µã‚¤ã‚ºãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æœç”¨ã‚µã‚¤ã‚ºã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ');
          } else {
            debug.log('ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã«æœç”¨ã‚µã‚¤ã‚ºãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          }
        } catch (e) {
          debug.log('ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚µã‚¤ã‚ºå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ä½•ã‚‚ã—ãªã„ï¼ˆæ—¢å­˜ã®é¸æŠè‚¢ã‚’ç¶­æŒï¼‰
        }
      }

      // ä»¥å‰ã®é¸æŠå€¤ãŒæ–°ã—ã„é¸æŠè‚¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯å¾©å…ƒ
      if (currentValue) {
        const options = Array.from(sizeSelect.options).map(opt => opt.value);
        if (options.includes(currentValue)) {
          sizeSelect.value = currentValue;
        }
      }
    } catch (error) {
      console.error('updateSizeOptions ã‚¨ãƒ©ãƒ¼:', error);
      // ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦ã‚‚å‡¦ç†ã‚’ç¶šè¡Œ
    }
  }

  /**
   * åŸºæœ¬æƒ…å ±ã®ã‚µã‚¤ã‚ºã‚’å•†å“ã®èª¬æ˜ãƒ–ãƒ­ãƒƒã‚¯ã«åŒæœŸ
   */
  function syncBasicSizeToDescription() {
    try {
      const chuBunrui = _val('ä¸­åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');
      const basicSize = _val('ã‚µã‚¤ã‚º');

      if (chuBunrui === 'é´' && basicSize) {
        const shoesSizeSelect = document.getElementById('ã‚µã‚¤ã‚º(è¡¨è¨˜)_é´');
        if (shoesSizeSelect) {
          shoesSizeSelect.value = basicSize;
          debug.log(`åŸºæœ¬æƒ…å ±ã®ã‚µã‚¤ã‚º(${basicSize})ã‚’å•†å“ã®èª¬æ˜ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆé´ï¼‰ã«åæ˜ ã—ã¾ã—ãŸ`);
          // èª¬æ˜æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
          updateDescriptionFromDetail();
        }
      }
    } catch (error) {
      console.error('syncBasicSizeToDescription ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  /**
   * ä¸­åˆ†é¡ã«å¿œã˜ã¦å•†å“ã®èª¬æ˜ãƒ–ãƒ­ãƒƒã‚¯ã®ã‚µã‚¤ã‚ºã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
   * @param {string} chuBunrui - ä¸­åˆ†é¡ã®å€¤
   */
  function updateSizeSectionDisplay(chuBunrui) {
    try {
      console.log(`â˜…â˜…â˜… updateSizeSectionDisplay() ãŒå‘¼ã°ã‚Œã¾ã—ãŸã€‚ä¸­åˆ†é¡: "${chuBunrui}"`);
      const sizeSection = document.getElementById('sizeSection');
      const topsSize = document.getElementById('topsSize');
      const bottomsSize = document.getElementById('bottomsSize');
      const shoesSize = document.getElementById('shoesSize');
      const sizeIconDisplay = document.getElementById('sizeIconDisplay');
      const sizeLabelDisplay = document.getElementById('sizeLabelDisplay');

      console.log('â˜…â˜…â˜… è¦ç´ ãƒã‚§ãƒƒã‚¯:', {sizeSection: !!sizeSection, topsSize: !!topsSize, bottomsSize: !!bottomsSize, shoesSize: !!shoesSize});

      if (!sizeSection || !topsSize || !bottomsSize || !shoesSize) {
        console.log('â˜…â˜…â˜… ã‚µã‚¤ã‚ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      // å…¨ã¦éè¡¨ç¤ºã«ã™ã‚‹
      topsSize.style.display = 'none';
      bottomsSize.style.display = 'none';
      shoesSize.style.display = 'none';

      if (chuBunrui === 'é´') {
        // é´ã®å ´åˆ
        console.log('â˜…â˜…â˜… é´ãƒ¢ãƒ¼ãƒ‰: displayã‚’è¨­å®šã™ã‚‹å‰ - sizeSection.style.display:', sizeSection.style.display);
        sizeSection.style.display = 'block';

        // æŠ˜ã‚ŠãŸãŸã¿ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚‚è¡¨ç¤ºã—ã€ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚‚æ›´æ–°ã™ã‚‹
        const sectionContent = sizeSection.querySelector('.section-content');
        const collapseBtn = sizeSection.querySelector('.collapse-btn');
        if (sectionContent) {
          sectionContent.style.display = 'block';
          if (collapseBtn) {
            collapseBtn.textContent = 'â–¼';
          }
          console.log('â˜…â˜…â˜… section-content ã¨ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºçŠ¶æ…‹ã«ã—ã¾ã—ãŸ');
        }

        shoesSize.style.display = 'block';
        console.log('â˜…â˜…â˜… é´ãƒ¢ãƒ¼ãƒ‰: displayã‚’è¨­å®šã—ãŸå¾Œ - sizeSection.style.display:', sizeSection.style.display);
        console.log('â˜…â˜…â˜… é´ãƒ¢ãƒ¼ãƒ‰: displayã‚’è¨­å®šã—ãŸå¾Œ - shoesSize.style.display:', shoesSize.style.display);

        // è¦ç´ ã®è©³ç´°æƒ…å ±ã‚’ãƒ­ã‚°å‡ºåŠ›
        const rect = sizeSection.getBoundingClientRect();
        console.log('â˜…â˜…â˜… sizeSection ã®ä½ç½®ã¨ã‚µã‚¤ã‚º:', {
          top: rect.top,
          left: rect.left,
          width: rect.width,
          height: rect.height,
          visible: rect.width > 0 && rect.height > 0
        });
        console.log('â˜…â˜…â˜… sizeSection ã®è¦ªè¦ç´ :', sizeSection.parentElement ? sizeSection.parentElement.tagName : 'ãªã—');
        console.log('â˜…â˜…â˜… sizeSection ã®è¦ªè¦ç´ ã® display:', sizeSection.parentElement ? window.getComputedStyle(sizeSection.parentElement).display : 'ãªã—');

        if (sizeIconDisplay) sizeIconDisplay.textContent = 'ğŸ‘Ÿ';
        if (sizeLabelDisplay) sizeLabelDisplay.textContent = 'ã‚µã‚¤ã‚ºï¼ˆé´ï¼‰';

        // é´ç”¨ã‚µã‚¤ã‚ºé¸æŠè‚¢ã‚’ç”Ÿæˆ
        const shoesSizeSelect = document.getElementById('ã‚µã‚¤ã‚º(è¡¨è¨˜)_é´');
        if (shoesSizeSelect) {
          const shoeSizes = [];
          for (let size = 22.0; size <= 30.0; size += 0.5) {
            shoeSizes.push(size.toFixed(1) + 'cm');
          }
          fillSelectSafe(shoesSizeSelect, shoeSizes);

          // åŸºæœ¬æƒ…å ±ã®ã‚µã‚¤ã‚ºã‚’é´ç”¨ã‚µã‚¤ã‚º(è¡¨è¨˜)ã«åŒæœŸ
          const basicSize = _val('ã‚µã‚¤ã‚º');
          if (basicSize) {
            shoesSizeSelect.value = basicSize;
            console.log(`â˜…â˜…â˜… åŸºæœ¬æƒ…å ±ã®ã‚µã‚¤ã‚º(${basicSize})ã‚’åæ˜ ã—ã¾ã—ãŸ`);
          }
        }
        console.log('â˜…â˜…â˜… ã‚µã‚¤ã‚ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é´ç”¨ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ');
      } else {
        // æœã®å ´åˆï¼ˆæ—¢å­˜ã®å‡¦ç†ï¼‰
        sizeSection.style.display = 'none'; // åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º
        console.log('â˜…â˜…â˜… ã‚µã‚¤ã‚ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸï¼ˆã‚¢ã‚¤ãƒ†ãƒ åé¸æŠå¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰');
      }
    } catch (error) {
      console.error('updateSizeSectionDisplay ã‚¨ãƒ©ãƒ¼:', error);
      // ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦ã‚‚å‡¦ç†ã‚’ç¶šè¡Œ
    }
  }

  function onL1Changed() {
    resetSelect('ä¸­åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');
    resetSelect('å°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');
    resetSelect('ç´°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');
    resetSelect('ç´°åˆ†é¡2');
    resetSelect('ã‚¢ã‚¤ãƒ†ãƒ å', false);
    // ç´°åˆ†é¡è¡Œã‚’éè¡¨ç¤º
    const saibunruiRow = document.getElementById('saibunruiRow');
    if (saibunruiRow) saibunruiRow.style.display = 'none';

    const l1 = (document.getElementById('å¤§åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)')?.value||'').trim();
    if (l1) {
      const mids = uniqKeepOrder(CAT_ROWS.filter(r=>r.å¤§åˆ†é¡===l1).map(r=>r.ä¸­åˆ†é¡));
      fillSelectSafe(document.getElementById('ä¸­åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)'), mids);
    }
    refreshItems();
  }

  function onL2Changed() {
    debug.log('onL2Changed() ãŒå‘¼ã°ã‚Œã¾ã—ãŸ');
    resetSelect('å°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');
    resetSelect('ç´°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');
    resetSelect('ç´°åˆ†é¡2');
    resetSelect('ã‚¢ã‚¤ãƒ†ãƒ å', false);
    // ç´°åˆ†é¡è¡Œã‚’éè¡¨ç¤º
    const saibunruiRow = document.getElementById('saibunruiRow');
    if (saibunruiRow) saibunruiRow.style.display = 'none';

    const l1 = (document.getElementById('å¤§åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)')?.value||'').trim();
    const l2 = (document.getElementById('ä¸­åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)')?.value||'').trim();
    debug.log(`ä¸­åˆ†é¡ã®å€¤: "${l2}"`);
    if (l2) {
      const smalls = uniqKeepOrder(CAT_ROWS.filter(r=>r.å¤§åˆ†é¡===l1 && r.ä¸­åˆ†é¡===l2).map(r=>r.å°åˆ†é¡));
      fillSelectSafe(document.getElementById('å°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)'), smalls);
    }

    // === é´ã®å ´åˆã€ã‚µã‚¤ã‚ºãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’é´ç”¨ã‚µã‚¤ã‚ºã«åˆ‡ã‚Šæ›¿ãˆ ===
    updateSizeOptions(l2);

    refreshItems();
  }

  function onL3Changed() {
    resetSelect('ç´°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');
    resetSelect('ç´°åˆ†é¡2');
    resetSelect('ã‚¢ã‚¤ãƒ†ãƒ å', false);
    const l1 = (document.getElementById('å¤§åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)')?.value||'').trim();
    const l2 = (document.getElementById('ä¸­åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)')?.value||'').trim();
    const l3 = (document.getElementById('å°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)')?.value||'').trim();
    const saibunruiRow = document.getElementById('saibunruiRow');

    if (l3) {
      const mins = uniqKeepOrder(CAT_ROWS.filter(r=>r.å¤§åˆ†é¡===l1 && r.ä¸­åˆ†é¡===l2 && r.å°åˆ†é¡===l3).map(r=>r.ç´°åˆ†é¡));
      fillSelectSafe(document.getElementById('ç´°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)'), mins);

      // ç´°åˆ†é¡ã®é¸æŠè‚¢ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤º
      if (mins.length > 0 && saibunruiRow) {
        saibunruiRow.style.display = '';
      } else if (saibunruiRow) {
        saibunruiRow.style.display = 'none';
      }
    } else {
      // å°åˆ†é¡ãŒæœªé¸æŠã®å ´åˆã¯éè¡¨ç¤º
      if (saibunruiRow) saibunruiRow.style.display = 'none';
    }
    refreshItems();
  }

  function onL4Changed() {
    resetSelect('ç´°åˆ†é¡2');
    resetSelect('ã‚¢ã‚¤ãƒ†ãƒ å', false);
    const l1 = (document.getElementById('å¤§åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)')?.value||'').trim();
    const l2 = (document.getElementById('ä¸­åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)')?.value||'').trim();
    const l3 = (document.getElementById('å°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)')?.value||'').trim();
    const l4 = (document.getElementById('ç´°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)')?.value||'').trim();
    if (l4) {
      const fin2 = uniqKeepOrder(CAT_ROWS.filter(r=>r.å¤§åˆ†é¡===l1 && r.ä¸­åˆ†é¡===l2 && r.å°åˆ†é¡===l3 && r.ç´°åˆ†é¡===l4).map(r=>r.ç´°åˆ†é¡2));
      fillSelectSafe(document.getElementById('ç´°åˆ†é¡2'), fin2);
    }
    refreshItems();
  }

  function onL5Changed() {
    refreshItems();
  }

  function collect() {
    const d={};
    FIELD_IDS.forEach(k=>{
      const el = document.getElementById(k);
      if (!el) return;
      const v=(el.value||'').trim();
      if (v !== '') d[k]=v;
    });

    // ã‚µã‚¤ã‚º(è¡¨è¨˜)ã®ç‰¹æ®Šå‡¦ç†: ãƒˆãƒƒãƒ—ã‚¹ã€ãƒœãƒˆãƒ ã‚¹ã€é´ã®ã„ãšã‚Œã‹ã®å€¤ã‚’ä½¿ç”¨
    const sizeHyokiTop = _val('ã‚µã‚¤ã‚º(è¡¨è¨˜)_ãƒˆãƒƒãƒ—ã‚¹');
    const sizeHyokiBottom = _val('ã‚µã‚¤ã‚º(è¡¨è¨˜)_ãƒœãƒˆãƒ ã‚¹');
    const sizeHyokiShoes = _val('ã‚µã‚¤ã‚º(è¡¨è¨˜)_é´');
    const sizeHyoki = sizeHyokiTop || sizeHyokiBottom || sizeHyokiShoes;
    if (sizeHyoki) {
      d['ã‚µã‚¤ã‚º(è¡¨è¨˜)'] = sizeHyoki;
    }

    // === ç”»åƒURLã‚’è¿½åŠ ï¼ˆæœ€å¤§3æšï¼‰ ===
    if (uploadedImages && uploadedImages.length > 0) {
      uploadedImages.forEach((img, index) => {
        if (index < 3) {
          d[`ç”»åƒURL${index + 1}`] = img.data; // data URLã‚’ãã®ã¾ã¾ä¿å­˜
        }
      });
      debug.log(`ç”»åƒURLã‚’è¿½åŠ ã—ã¾ã—ãŸ: ${uploadedImages.length}æš`);
    }

    // === AIç”Ÿæˆå±¥æ­´ã‚’è¿½åŠ  ===
    debug.log(`AI_GENERATED_TEXT: "${AI_GENERATED_TEXT ? AI_GENERATED_TEXT.substring(0, 50) + '...' : '(ç©º)'}"`);
    if (AI_GENERATED_TEXT && AI_GENERATED_TEXT.trim() !== '') {
      const aiHistory = {
        timestamp: new Date().toISOString(),
        text: AI_GENERATED_TEXT,
        imageCount: uploadedImages ? uploadedImages.length : 0,
        brandName: _val('ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)') || _val('å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)') || '',
        itemName: _val('ã‚¢ã‚¤ãƒ†ãƒ å') || ''
      };
      const historyJson = JSON.stringify(aiHistory);
      d['AIç”Ÿæˆå±¥æ­´'] = historyJson;
      debug.log(`AIç”Ÿæˆå±¥æ­´ã‚’è¿½åŠ ã—ã¾ã—ãŸ (${historyJson.length}æ–‡å­—)`);
    } else {
      debug.log('AIç”Ÿæˆå±¥æ­´ã¯ç©ºã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ');
    }

    return d;
  }

  function frontValidate(d) {
    const name = d['å•†å“å(ã‚¿ã‚¤ãƒˆãƒ«)'] || '';
    const len = Array.from(name).length;
    if (NAME_LIMIT_MODE === 'block' && len > NAME_LIMIT) {
      return `NG(NAME): å•†å“å(ã‚¿ã‚¤ãƒˆãƒ«)ã¯${NAME_LIMIT}æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„ï¼ˆç¾åœ¨${len}æ–‡å­—ï¼‰`;
    }
    const desc = d['å•†å“ã®èª¬æ˜'] || '';
    const dlen = Array.from(desc).length;
    if (DESC_LIMIT_MODE === 'block' && dlen > DESC_LIMIT) {
      return `NG(DESC): å•†å“ã®èª¬æ˜ã¯${DESC_LIMIT}æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„ï¼ˆç¾åœ¨${dlen}æ–‡å­—ï¼‰`;
    }
    if (d['ä»•å…¥é‡‘é¡'] && isNaN(Number(d['ä»•å…¥é‡‘é¡']))) return "NG(FORMAT): ä»•å…¥é‡‘é¡ã¯æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„";
    if (d['å‡ºå“é‡‘é¡'] && isNaN(Number(d['å‡ºå“é‡‘é¡']))) return "NG(FORMAT): å‡ºå“é‡‘é¡ã¯æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„";
    return '';
  }

  function onSave() {
    updateNamePreview();
    updateDesc();
    const d = collect();
    const ng = frontValidate(d);
    if (ng) {
      return show(ng);
    }
    show('é€ä¿¡ä¸­â€¦');

    if (!(google && google.script && google.script.run)) {
      show('NG(ENV): google.script.run ãŒç„¡åŠ¹ã§ã™');
      return;
    }
    google.script.run
      .withSuccessHandler(function(result) {
        show(result);
        // ä¿å­˜æˆåŠŸå¾Œã‚‚å•†å“ã®èª¬æ˜ã‚¨ãƒªã‚¢ã®é«˜ã•ã‚’ä¿æŒ
        const descTextarea = document.getElementById('å•†å“ã®èª¬æ˜');
        if (descTextarea) {
          autoResizeTextarea(descTextarea);
        }
        // ä¿å­˜æˆåŠŸå¾Œã«é–‹é–‰çŠ¶æ…‹ã¨ç®¡ç†ç•ªå·é…ç½®ã‚’ä¿å­˜
        saveDescriptionBlocksCollapseState();
        saveTitleBlocksCollapseState();
        saveManagementNumberPlacementSettings();
        console.log('ä¿å­˜æˆåŠŸï¼šé–‹é–‰çŠ¶æ…‹ã¨ç®¡ç†ç•ªå·é…ç½®ã‚’ä¿å­˜ã—ã¾ã—ãŸ');

        // === ä¿å­˜æˆåŠŸå¾Œã«ç”»åƒãƒ‡ãƒ¼ã‚¿ã¨AIç”Ÿæˆãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ ===
        if (uploadedImages && uploadedImages.length > 0) {
          uploadedImages = [];
          // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚éè¡¨ç¤º
          const container = document.getElementById('imagePreviewContainer');
          if (container) {
            container.style.display = 'none';
          }
          // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚‚ãƒªã‚»ãƒƒãƒˆ
          const fileInput = document.getElementById('productImages');
          if (fileInput) {
            fileInput.value = '';
          }
          debug.log('ä¿å­˜æˆåŠŸå¾Œã«ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        }
        if (AI_GENERATED_TEXT) {
          AI_GENERATED_TEXT = '';
          debug.log('ä¿å­˜æˆåŠŸå¾Œã«AIç”Ÿæˆãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        }
      })
      .withFailureHandler(function(error) {
        show(`NG(UNKNOWN): ${error && error.message ? error.message : error}`);
      })
      .saveProduct(d);
  }

  /**
   * ãƒ•ã‚©ãƒ¼ãƒ å…¨ä½“ã‚’ãƒªã‚»ãƒƒãƒˆ
   * ã™ã¹ã¦ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢ã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆé…é€æƒ…å ±ã€ä»•å…¥ãƒ»å‡ºå“æƒ…å ±ï¼‰ã‚’å†é©ç”¨
   * ç®¡ç†ç•ªå·ã®é…ç½®è¨­å®šã¨å½¢å¼ã¯ä¿æŒã•ã‚Œã‚‹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é‹ç”¨æ–¹é‡ã®ãŸã‚ï¼‰
   * @throws {Error} ãƒªã‚»ãƒƒãƒˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆ
   */
  function onReset() {
    try {
      console.log('=== ãƒªã‚»ãƒƒãƒˆé–‹å§‹ ===');

      // 0. AIç”Ÿæˆæ–‡ã‚’ã‚¯ãƒªã‚¢
      AI_GENERATED_TEXT = '';

      // 0-1. ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
      if (uploadedImages && uploadedImages.length > 0) {
        uploadedImages = [];
        const container = document.getElementById('imagePreviewContainer');
        if (container) {
          container.style.display = 'none';
        }
        // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚‚ãƒªã‚»ãƒƒãƒˆ
        const fileInput = document.getElementById('productImages');
        if (fileInput) {
          fileInput.value = '';
        }
        console.log('ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
      }

      // 1. ã™ã¹ã¦ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
      FIELD_IDS.forEach(k=>{
        const el=document.getElementById(k);
        if(el) {
          el.value='';
          console.log(`ã‚¯ãƒªã‚¢: ${k}`);
        }
      });

    // 2. ã‚«ãƒ†ã‚´ãƒªãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
    ['ä¸­åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)','å°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)','ç´°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)','ç´°åˆ†é¡2'].forEach(id=> resetSelect(id, true));
    const l1 = document.getElementById('å¤§åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');
    if (l1) l1.value='';

    // ç´°åˆ†é¡è¡Œã‚’éè¡¨ç¤º
    const saibunruiRow = document.getElementById('saibunruiRow');
    if (saibunruiRow) saibunruiRow.style.display = 'none';

    // 3. ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
    ['ã‚µã‚¤ã‚º','å•†å“ã®çŠ¶æ…‹','ã‚¢ã‚¤ãƒ†ãƒ å','å•†å“å_ã‚¢ã‚¤ãƒ†ãƒ å',
     'å•†å“å±æ€§1_ã‚«ãƒ†ã‚´ãƒª','å•†å“å±æ€§1_å€¤','å•†å“å±æ€§2_ã‚«ãƒ†ã‚´ãƒª','å•†å“å±æ€§2_å€¤',
     'å•†å“å±æ€§3_ã‚«ãƒ†ã‚´ãƒª','å•†å“å±æ€§3_å€¤']
    .forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.value = '';
    });

    // 4. ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
    try {
      resetKeywordDropdown();
      const categorySelect = document.getElementById('ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰(ã‚«ãƒ†ã‚´ãƒª)');
      if (categorySelect) categorySelect.value = '';

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†é©ç”¨
      if (typeof defaultSalesword !== 'undefined' && defaultSalesword && defaultSalesword.ã‚«ãƒ†ã‚´ãƒª && defaultSalesword.ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰) {
        setTimeout(() => {
          applyDefaultSalesword(defaultSalesword);
          console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†é©ç”¨ã—ã¾ã—ãŸ');
        }, 100);
      }
    } catch (error) {
      console.error('ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
    }

    // 5. å•†å“çŠ¶æ…‹(è©³ç´°)ã‚’ãƒªã‚»ãƒƒãƒˆ
    const detailInput = document.getElementById('å•†å“çŠ¶æ…‹è©³ç´°');
    if (detailInput) detailInput.value = '';

    // 6. ç´ æãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
    const materialItems = document.querySelectorAll('.material-item');
    materialItems.forEach((item, index) => {
      if (index === 0) {
        const locationSelect = item.querySelector(`#ç´ æ1_ç®‡æ‰€`);
        const type1Select = item.querySelector(`#ç´ æ1_ç¨®é¡1`);
        const percent1Input = item.querySelector(`#ç´ æ1_ï¼…1`);
        const type2Select = item.querySelector(`#ç´ æ1_ç¨®é¡2`);
        const percent2Input = item.querySelector(`#ç´ æ1_ï¼…2`);
        if (locationSelect) locationSelect.value = '';
        if (type1Select) type1Select.value = '';
        if (percent1Input) percent1Input.value = '';
        if (type2Select) type2Select.value = '';
        if (percent2Input) percent2Input.value = '';
      } else {
        item.remove();
      }
    });
    materialCount = 1;
    updateRemoveButtons();

    // 6.5. ã‚«ãƒ©ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
    const colorItems = document.querySelectorAll('.color-item');
    colorItems.forEach((item, index) => {
      if (index === 0) {
        const colorSelect = item.querySelector(`#ã‚«ãƒ©ãƒ¼1`);
        if (colorSelect) colorSelect.value = '';
      } else {
        item.remove();
      }
    });
    colorCount = 1;
    updateColorRemoveButtons();

    // 6.6. å•†å“å±æ€§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
    const attributeItems = document.querySelectorAll('.attribute-item');
    attributeItems.forEach((item, index) => {
      if (index === 0) {
        // 1å€‹ç›®ã¯ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
        const categorySelect = item.querySelector(`#å•†å“å±æ€§1_ã‚«ãƒ†ã‚´ãƒª`);
        const valueSelect = item.querySelector(`#å•†å“å±æ€§1_å€¤`);
        if (categorySelect) categorySelect.value = '';
        if (valueSelect) {
          valueSelect.value = '';
          valueSelect.disabled = true;
        }
      } else {
        // 2å€‹ç›®ä»¥é™ã¯å‰Šé™¤
        item.remove();
      }
    });
    attributeCount = 1;
    updateAttributeRemoveButtons();
    updateAttributeFields();

    // 6.7. AIç”¨å•†å“å±æ€§ã‚’ã‚¯ãƒªã‚¢
    const aiAttributesField = document.getElementById('AIç”¨å•†å“å±æ€§');
    if (aiAttributesField) aiAttributesField.value = '';

    // 6.8. å“ç•ªãƒ»å‹ç•ªã‚’ã‚¯ãƒªã‚¢
    const modelNumberField = document.getElementById('å“ç•ªå‹ç•ª');
    if (modelNumberField) modelNumberField.value = '';

    // 7. ã‚µã‚¤ã‚ºé–¢é€£ã‚’ãƒªã‚»ãƒƒãƒˆ
    const shoulderLabel = document.getElementById('shoulderWidthLabel');
    if (shoulderLabel) shoulderLabel.textContent = 'è‚©å¹…';

    const sizeHyokiTop = document.getElementById('ã‚µã‚¤ã‚º(è¡¨è¨˜)_ãƒˆãƒƒãƒ—ã‚¹');
    const sizeHyokiBottom = document.getElementById('ã‚µã‚¤ã‚º(è¡¨è¨˜)_ãƒœãƒˆãƒ ã‚¹');
    const sizeHyokiShoes = document.getElementById('ã‚µã‚¤ã‚º(è¡¨è¨˜)_é´');
    const otherSizeShoes = document.getElementById('ãã®ä»–ã®ã‚µã‚¤ã‚ºè¡¨è¨˜_é´');
    const usualSizeShoes = document.getElementById('æ™®æ®µã®ã‚µã‚¤ã‚º_é´');
    const fitShoes = document.getElementById('ãƒ•ã‚£ãƒƒãƒˆæ„Ÿ_é´');

    if (sizeHyokiTop) sizeHyokiTop.value = '';
    if (sizeHyokiBottom) sizeHyokiBottom.value = '';
    if (sizeHyokiShoes) sizeHyokiShoes.value = '';
    if (otherSizeShoes) otherSizeShoes.value = '';
    if (usualSizeShoes) usualSizeShoes.value = '';
    if (fitShoes) fitShoes.value = '';

    const sizeSection = document.getElementById('sizeSection');
    if (sizeSection) sizeSection.style.display = 'none';

    const sizeIconDisplay = document.getElementById('sizeIconDisplay');
    const sizeLabelDisplay = document.getElementById('sizeLabelDisplay');
    if (sizeIconDisplay) sizeIconDisplay.textContent = 'ğŸ‘•';
    if (sizeLabelDisplay) sizeLabelDisplay.textContent = 'ã‚µã‚¤ã‚º';

    // 8. é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’é©ç”¨
    applyShippingDefaults();

    // 8-2. ä»•å…¥ãƒ»å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’é©ç”¨
    applyProcureListingDefaults();

    // 9. ç®¡ç†ç•ªå·é–¢é€£ã‚’ãƒªã‚»ãƒƒãƒˆ
    const p1 = document.getElementById('prefix1');
    if (p1) {
      p1.value = '';
      console.log('prefix1ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
    }
    const shelfField = document.getElementById('æ£šç•ªå·');
    if (shelfField) {
      shelfField.value = '';
      console.log('æ£šç•ªå·ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
    }

    // å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ç®¡ç†ç•ªå·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
    const mgmtShelfFirst = document.getElementById('mgmt_shelf_first');
    const mgmtShelfSecond = document.getElementById('mgmt_shelf_second');
    const mgmtCustomFirst = document.getElementById('mgmt_custom_first');
    const mgmtCustomSecond = document.getElementById('mgmt_custom_second');
    if (mgmtShelfFirst) mgmtShelfFirst.value = '';
    if (mgmtShelfSecond) mgmtShelfSecond.value = '';
    if (mgmtCustomFirst) mgmtCustomFirst.value = '';
    if (mgmtCustomSecond) mgmtCustomSecond.value = '';

    // ç®¡ç†ç•ªå·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
    const mgmtNumberField = document.getElementById('ç®¡ç†ç•ªå·');
    if (mgmtNumberField) mgmtNumberField.value = '';

    // ç®¡ç†ç•ªå·ã®é…ç½®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¨å½¢å¼ã¯ä¿æŒï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¥½ã¿ãªã®ã§ï¼‰

    // buildShelf()ã‚’å‘¼ã¶ã¨å€¤ãŒæˆ»ã•ã‚Œã‚‹ã®ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
    // buildShelf();

    // 10. ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
    const brandEnBasic = document.getElementById('ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)');
    if (brandEnBasic) brandEnBasic.value = '';

    const brandEn = document.getElementById('å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)');
    const brandKana = document.getElementById('å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(ã‚«ãƒŠ)');
    if (brandEn) brandEn.value = '';
    if (brandKana) brandKana.value = '';

    // ãƒ–ãƒ©ãƒ³ãƒ‰ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã«æˆ»ã™
    const brandEnCheckbox = document.getElementById('å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)_ãƒã‚§ãƒƒã‚¯');
    const brandKanaCheckbox = document.getElementById('å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(ã‚«ãƒŠ)_ãƒã‚§ãƒƒã‚¯');
    if (brandEnCheckbox) brandEnCheckbox.checked = true;
    if (brandKanaCheckbox) brandKanaCheckbox.checked = true;

    hideSuggest('ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)');
    hideSuggest('å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)');
    hideSuggest('å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(ã‚«ãƒŠ)');

    // 11. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
    const namePreview = document.getElementById('å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼');
    if (namePreview) {
      namePreview.value = '';
      console.log('å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢');
    }

    const descPreview = document.getElementById('å•†å“ã®èª¬æ˜');
    if (descPreview) {
      descPreview.value = '';
      console.log('å•†å“ã®èª¬æ˜ã‚’ã‚¯ãƒªã‚¢ï¼ˆå¾Œã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤å¾©æ´»ï¼‰');
    }

    // 12. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
    show('');

    // 13. ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ãƒ»å‰²å¼•æƒ…å ±ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å…¨ã¦ãƒã‚§ãƒƒã‚¯
    document.querySelectorAll('input[id^="hashtag-checkbox-"]').forEach(cb => {
      cb.checked = true;
    });
    document.querySelectorAll('input[id^="discount-checkbox-"]').forEach(cb => {
      cb.checked = true;
    });

    // 14. æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆé–‰ã˜ã‚‹ï¼‰
    const hashtagSection = document.getElementById('hashtagSection');
    const hashtagToggle = document.getElementById('hashtagToggle');
    if (hashtagSection && hashtagToggle) {
      hashtagSection.style.display = 'none';
      hashtagToggle.textContent = 'â–¼';
    }

    const discountSection = document.getElementById('discountSection');
    const discountToggle = document.getElementById('discountToggle');
    if (discountSection && discountToggle) {
      discountSection.style.display = 'none';
      discountToggle.textContent = 'â–¼';
    }

    // 15. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å†æ§‹ç¯‰ï¼ˆå•†å“åã¯ç©ºã€å•†å“ã®èª¬æ˜ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
    console.log('ãƒ–ãƒ©ãƒ³ãƒ‰è¡¨ç¤ºã‚’æ›´æ–°');
    updateBrandDisplay(); // ãƒ–ãƒ©ãƒ³ãƒ‰æƒ…å ±ã‚’ã‚¯ãƒªã‚¢

    console.log('å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†æ§‹ç¯‰');
    // updateBrandDisplay()ãŒéåŒæœŸãªã®ã§ã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
    setTimeout(() => {
      updateNamePreview();
      console.log('å•†å“ã®èª¬æ˜ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤å¾©æ´»');
      updateDescriptionFromDetail();
    }, 100);

    // 16. ç”»åƒã‚’ã‚¯ãƒªã‚¢
    uploadedImages = [];
    const imageInput = document.getElementById('productImages');
    if (imageInput) imageInput.value = '';
    displayImagePreviews();
    console.log('ç”»åƒã‚’ã‚¯ãƒªã‚¢');

      console.log('=== ãƒªã‚»ãƒƒãƒˆå®Œäº† ===');
    } catch (error) {
      console.error('ãƒªã‚»ãƒƒãƒˆå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
      debug.error('onReset ã‚¨ãƒ©ãƒ¼:', error);
      alert('ãƒªã‚»ãƒƒãƒˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
    }
  }

  // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
  function copyToClipboard(fieldId, buttonId) {
    const field = document.getElementById(fieldId);
    const button = document.getElementById(buttonId);

    if (!field || !field.value.trim()) {
      alert('ã‚³ãƒ”ãƒ¼ã™ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }

    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
    navigator.clipboard.writeText(field.value).then(function() {
      // ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€Œâœ“ ã‚³ãƒ”ãƒ¼æ¸ˆã¿ã€ã«å¤‰æ›´
      const originalText = button.innerHTML;
      button.innerHTML = 'âœ“ ã‚³ãƒ”ãƒ¼æ¸ˆã¿';
      button.style.background = '#c8e6c9';
      button.style.borderColor = '#81c784';
      button.style.color = '#2e7d32';

      // 1ç§’å¾Œã«å…ƒã«æˆ»ã™
      setTimeout(function() {
        button.innerHTML = originalText;
        button.style.background = '#e3f2fd';
        button.style.borderColor = '#90caf9';
        button.style.color = '#1976d2';
      }, 1000);
    }).catch(function(err) {
      console.error('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
      alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    });
  }

  // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®é«˜ã•ã‚’è‡ªå‹•èª¿æ•´
  function autoResizeTextarea(textarea) {
    if (!textarea) return;

    // DOMã®æ›´æ–°ã‚’å¾…ã£ã¦ã‹ã‚‰å®Ÿè¡Œ
    setTimeout(function() {
      console.log('autoResizeTextarea å®Ÿè¡Œé–‹å§‹');
      console.log('ç¾åœ¨ã®å€¤ã®é•·ã•:', textarea.value.length);
      console.log('ç¾åœ¨ã®é«˜ã•:', textarea.style.height);

      // ä¸€æ—¦é«˜ã•ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦scrollHeightã‚’æ­£ã—ãå–å¾—
      textarea.style.height = 'auto';

      // scrollHeightã‚’å–å¾—
      const scrollHeight = textarea.scrollHeight;
      console.log('scrollHeight:', scrollHeight);

      // scrollHeightã«åŸºã¥ã„ã¦é«˜ã•ã‚’è¨­å®šï¼ˆpadding + borderåˆ†ã‚’è€ƒæ…®ï¼‰
      const newHeight = Math.max(120, scrollHeight + 10);
      textarea.style.height = newHeight + 'px';

      console.log('æ–°ã—ã„é«˜ã•:', newHeight + 'px');
    }, 50);
  }

  function show(t) {
    const el=document.getElementById('msg');
    if (el) el.textContent = t;
  }

  function unifyConditionList(list) {
    const arr = (list||[]).map(v => (v??'').toString().trim()).filter(v=>v);
    const hasCombined = arr.includes('æ–°å“ã€æœªä½¿ç”¨');
    const idxNew = arr.indexOf('æ–°å“');
    const idxUnused = arr.indexOf('æœªä½¿ç”¨');
    if (hasCombined && idxNew === -1 && idxUnused === -1) return arr;
    const earliest = Math.min(
      idxNew === -1 ? Infinity : idxNew,
      idxUnused === -1 ? Infinity : idxUnused
    );
    const out = [];
    let combinedInserted = false;
    for (let i=0; i<arr.length; i++) {
      const v = arr[i];
      if (i === earliest && (idxNew !== -1 || idxUnused !== -1)) {
        if (!combinedInserted) {
          out.push('æ–°å“ã€æœªä½¿ç”¨');
          combinedInserted = true;
        }
        continue;
      }
      if (v === 'æ–°å“' || v === 'æœªä½¿ç”¨') continue;
      if (v === 'æ–°å“ã€æœªä½¿ç”¨') {
        if (!combinedInserted) {
          out.push(v);
          combinedInserted = true;
        }
        continue;
      }
      out.push(v);
    }
    if (!combinedInserted && (idxNew !== -1 || idxUnused !== -1)) out.unshift('æ–°å“ã€æœªä½¿ç”¨');
    return out;
  }

  /**
   * ã²ã‚‰ãŒãªã‚’ã‚«ã‚¿ã‚«ãƒŠã«å¤‰æ›ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰
   * ä¾‹: "ãªã„ã" â†’ "ãƒŠã‚¤ã‚­"
   */
  function hiraganaToKatakana(str) {
    return str.replace(/[\u3041-\u3096]/g, function(match) {
      var chr = match.charCodeAt(0) + 0x60;
      return String.fromCharCode(chr);
    });
  }

  function attachBrandSuggest(inputId, list) {
    console.log(`attachBrandSuggest called for ${inputId} with list length:`, list ? list.length : 'undefined');
    const input = document.getElementById(inputId);
    const panel = document.getElementById('suggest-' + inputId);
    if (!input || !panel) {
      console.log(`Missing elements for ${inputId}: input=${!!input}, panel=${!!panel}`);
      return;
    }
    let activeIndex = -1;
    const limit = 15;
    const render = (items) => {
      panel.innerHTML = '';
      if (!items.length) {
        panel.innerHTML = '<div class="sug-empty">å€™è£œãªã—</div>';
        panel.hidden = false;
        return;
      }

      // ãƒ–ãƒ©ãƒ³ãƒ‰å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã©ã†ã‹ã‚’åˆ¤å®š
      const isBrandField = inputId === 'ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)' || inputId === 'å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)';

      items.slice(0, limit).forEach((v, i)=>{
        const div = document.createElement('div');

if (isBrandField) {
            // ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)ã®å ´åˆã¯2è¡Œè¡¨ç¤º
            div.className = 'sug-item brand-item';

            const englishName = v;
            // ãƒšã‚¢ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ­£ç¢ºãªã‚«ãƒŠèª­ã¿ã‚’å–å¾—
            const pairIndex = BRAND_INDEX_MAP.get(englishName);
            const kanaName = pairIndex !== undefined && BRAND_PAIRS[pairIndex] ? BRAND_PAIRS[pairIndex].kana : '';

            const escapedEnglishName = String(englishName).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g,
  '&gt;').replace(/"/g, '&quot;');
            const escapedKanaName = String(kanaName).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g,
  '&gt;').replace(/"/g, '&quot;');

            div.innerHTML = `
              <div class="brand-english">${escapedEnglishName}</div>
              <div class="brand-kana">${escapedKanaName}</div>
            `;
          } else {
          // ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å¾“æ¥é€šã‚Š1è¡Œè¡¨ç¤º
          div.className = 'sug-item';
          div.textContent = v;
        }

        div.addEventListener('mousemove', ()=> {
          Array.from(panel.querySelectorAll('.sug-item')).forEach(x=> x.classList.remove('active'));
          div.classList.add('active');
          activeIndex = i;
        });
        div.addEventListener('mousedown', (e)=> {
          e.preventDefault();
        });
        div.addEventListener('click', ()=> {
            // ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)ã®2è¡Œè¡¨ç¤ºã®å ´åˆã¯è‹±èªåã®ã¿ã‚’å–å¾—
            if ((inputId === 'ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)' || inputId === 'å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)') &&
  div.classList.contains('brand-item')) {
              const englishDiv = div.querySelector('.brand-english');
              input.value = englishDiv ? englishDiv.textContent : '';
            } else {
              input.value = v;
            }
            hide();
            // åŸºæœ¬æƒ…å ±ã®ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)é¸æŠæ™‚ã¯ã€å…ˆã«å•†å“åãƒ–ãƒ­ãƒƒã‚¯ã«åæ˜ ã—ã¦ã‹ã‚‰å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
            if (inputId === 'ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)') {
              updateBrandDisplay();
              updateNamePreview();
              updateDescriptionFromDetail();
            } else {
              updateNamePreview();
              updateDescriptionFromDetail();
            }
          });
        panel.appendChild(div);
      });
      panel.hidden = false;
    };
    const hide = ()=>{
      panel.hidden = true;
      activeIndex = -1;
    };
    const hideLater = ()=> setTimeout(hide, 100);
    const doFilter = ()=>{
      let q = (input.value || '').trim();

      // ã²ã‚‰ãŒãªã‚’ã‚«ã‚¿ã‚«ãƒŠã«å¤‰æ›ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰
      // ä¾‹: "ãªã„ã" â†’ "ãƒŠã‚¤ã‚­"
      if (inputId === 'ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)' || inputId === 'å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)') {
        q = hiraganaToKatakana(q);
      }

      // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
      console.log(`doFilter called for ${inputId}, query: "${q}", list length: ${list ? list.length : 'undefined'}`);

      // ãƒªã‚¹ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
      if (!Array.isArray(list) || list.length === 0) {
        console.log(`No data available for ${inputId}`);
        hide();
        return;
      }

      if (!q) {
        hide();
        return;
      }

      // çŸ­ã™ãã‚‹æ¤œç´¢æ–‡å­—åˆ—ã®å ´åˆã¯å‡¦ç†ã‚’åˆ¶é™ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šï¼‰
      if (inputId === 'ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)' && q.length < 2 && list.length > 10000) {
        hide();
        return;
      }

      let filtered;

if (inputId === 'å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)' || inputId === 'ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)') {
        // ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)ã®å ´åˆã¯è‹±èªåã¨ã‚«ãƒŠèª­ã¿ä¸¡æ–¹ã§æ¤œç´¢ï¼ˆãƒšã‚¢ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ï¼‰
        const qq = q.toLowerCase();
        filtered = list.filter(v=>{
          const englishName = String(v).toLowerCase();

          // å®Œå…¨ä¸€è‡´æ¤œç´¢
          if (englishName.indexOf(qq) !== -1) {
            return true;
          }

          // å˜èªå¢ƒç•Œã§ã®éƒ¨åˆ†ä¸€è‡´æ¤œç´¢ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰
          const words = englishName.split(/\s+/);
          if (words.some(word => word.startsWith(qq))) {
            return true;
          }

          // ã‚«ãƒŠèª­ã¿æ¤œç´¢ï¼ˆãƒšã‚¢ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ­£ç¢ºã«å–å¾—ï¼‰
          const pairIndex = BRAND_INDEX_MAP.get(v);
          if (pairIndex !== undefined && BRAND_PAIRS[pairIndex]) {
            const kanaName = String(BRAND_PAIRS[pairIndex].kana || '').toLowerCase();

            // ã‚«ãƒŠèª­ã¿å®Œå…¨ä¸€è‡´
            if (kanaName.indexOf(qq) !== -1) {
              return true;
            }

            // ã‚«ãƒŠèª­ã¿å˜èªå¢ƒç•Œã§ã®éƒ¨åˆ†ä¸€è‡´
            const kanaWords = kanaName.split(/[\sãƒ»]+/);
            if (kanaWords.some(word => word.startsWith(qq))) {
              return true;
            }
          }

          return false;
        });
        } else if (inputId === 'ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)') {
          // åŸºæœ¬æƒ…å ±ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)ã®å ´åˆã‚‚åŒæ§˜ã®æŸ”è»Ÿæ¤œç´¢
          const qq = q.toLowerCase();
          filtered = list.filter(v=>{
            const englishName = String(v).toLowerCase();

            // å®Œå…¨ä¸€è‡´æ¤œç´¢
            if (englishName.indexOf(qq) !== -1) {
              return true;
            }

            // å˜èªå¢ƒç•Œã§ã®éƒ¨åˆ†ä¸€è‡´æ¤œç´¢ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰
            const words = englishName.split(/\s+/);
            if (words.some(word => word.startsWith(qq))) {
              return true;
            }

            // ã‚«ãƒŠèª­ã¿æ¤œç´¢ï¼ˆãƒšã‚¢ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ­£ç¢ºã«å–å¾—ï¼‰
            const pairIndex = BRAND_INDEX_MAP.get(v);
            if (pairIndex !== undefined && BRAND_PAIRS[pairIndex]) {
              const kanaName = String(BRAND_PAIRS[pairIndex].kana || '').toLowerCase();

              // ã‚«ãƒŠèª­ã¿å®Œå…¨ä¸€è‡´
              if (kanaName.indexOf(qq) !== -1) {
                return true;
              }

              // ã‚«ãƒŠèª­ã¿å˜èªå¢ƒç•Œã§ã®éƒ¨åˆ†ä¸€è‡´
              const kanaWords = kanaName.split(/[\sãƒ»]+/);
              if (kanaWords.some(word => word.startsWith(qq))) {
                return true;
              }
            }

            return false;
          });
        } else {
          // ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å¾“æ¥é€šã‚Šï¼ˆcase-insensitiveå¯¾å¿œï¼‰
          const qq = q.toLowerCase();
          filtered = list.filter(v=>{
            const s = String(v).toLowerCase();
            return s.indexOf(qq) !== -1;
          });
        }

      console.log(`Filtered results for ${inputId}: ${filtered.length} items`);
      render(filtered);
    };
    input.addEventListener('input', () => {
      doFilter();
      // å•†å“åãƒ–ãƒ­ãƒƒã‚¯ã®ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å ´åˆã€å¸¸ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°ï¼ˆç©ºã®å ´åˆã‚‚å«ã‚€ï¼‰
      if (inputId === 'å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)' || inputId === 'å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(ã‚«ãƒŠ)') {
        updateNamePreview();
      }
    });
    input.addEventListener('focus', doFilter);
    input.addEventListener('blur', hideLater);
    input.addEventListener('keydown', (e)=>{
      if (panel.hidden) return;
      const items = Array.from(panel.querySelectorAll('.sug-item'));
      if (!items.length) return;
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        activeIndex = (activeIndex + 1) % items.length;
        items.forEach(x=>x.classList.remove('active'));
        items[activeIndex].classList.add('active');
        items[activeIndex].scrollIntoView({ block:'nearest' });
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        activeIndex = (activeIndex - 1 + items.length) % items.length;
        items.forEach(x=>x.classList.remove('active'));
        items[activeIndex].classList.add('active');
        items[activeIndex].scrollIntoView({ block:'nearest' });
      } else if (e.key === 'Enter') {
        if (activeIndex >= 0) {
          e.preventDefault();
          const selectedItem = items[activeIndex];

          // ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)ã®2è¡Œè¡¨ç¤ºã®å ´åˆã¯è‹±èªåã®ã¿ã‚’å–å¾—
          if ((inputId === 'ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)' || inputId === 'å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)') &&
  selectedItem.classList.contains('brand-item')) {
            const englishDiv = selectedItem.querySelector('.brand-english');
            input.value = englishDiv ? englishDiv.textContent : '';
          } else {
            input.value = selectedItem.textContent || '';
          }

          hide();
          updateNamePreview();

          // ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)ã®å ´åˆã¯è¿½åŠ ã®æ›´æ–°å‡¦ç†
          if (inputId === 'ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)') {
            updateBrandDisplay();
            updateDescriptionFromDetail();
          }
        }
      } else if (e.key === 'Escape') {
        hide();
      }
    });
    function hideExternal() {
      hide();
    }
    input._hideSuggest = hideExternal;
  }

  function hideSuggest(inputId) {
    const input = document.getElementById(inputId);
    if (input && input._hideSuggest) input._hideSuggest();
  }

  // ================= åˆæœŸåŒ–å‡¦ç† =================
  (function init() {
    // é ­æ–‡å­—ãƒ»æ£šç•ªå·ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’åˆæœŸåŒ–
    initPrefix1();
    buildShelf();
    const p1 = document.getElementById('prefix1');
    if (p1) p1.addEventListener('change', buildShelf);
    const sh = document.getElementById('æ£šç•ªå·');
    if (sh) sh.addEventListener('change', requestNextManagementNumber);

    // ã‚«ãƒ†ã‚´ãƒªãƒã‚¹ã‚¿å–å¾—
    if (google && google.script && google.script.run && google.script.run.getCategoryRows) {
      google.script.run.withSuccessHandler(res=>{
        if (!res || !res.ok) {
          show(res && res.msg ? res.msg : 'NG(MASTER): ãƒã‚¹ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
          return;
        }
        CAT_ROWS = (res.rows || []).map(r=>({
          å¤§åˆ†é¡:String(r.å¤§åˆ†é¡||'').trim(),
          ä¸­åˆ†é¡:String(r.ä¸­åˆ†é¡||'').trim(),
          å°åˆ†é¡:String(r.å°åˆ†é¡||'').trim(),
          ç´°åˆ†é¡:String(r.ç´°åˆ†é¡||'').trim(),
          ç´°åˆ†é¡2:String(r.ç´°åˆ†é¡2||'').trim(),
          ã‚¢ã‚¤ãƒ†ãƒ å:String(r.ã‚¢ã‚¤ãƒ†ãƒ å||'').trim(),
        }));
        const l1s = uniqKeepOrder(CAT_ROWS.map(r=>r.å¤§åˆ†é¡));
        fillSelectSafe(document.getElementById('å¤§åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)'), l1s);

        // ã‚«ãƒ†ã‚´ãƒªãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        const l1Select = document.getElementById('å¤§åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');
        const l2Select = document.getElementById('ä¸­åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');
        const l3Select = document.getElementById('å°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');
        const l4Select = document.getElementById('ç´°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');
        const l5Select = document.getElementById('ç´°åˆ†é¡2');
        const itemSelect = document.getElementById('ã‚¢ã‚¤ãƒ†ãƒ å');
        if (l1Select) {
          l1Select.addEventListener('change', onL1Changed);
          debug.log('å¤§åˆ†é¡ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ');
        }
        if (l2Select) {
          l2Select.addEventListener('change', onL2Changed);
          debug.log('ä¸­åˆ†é¡ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ');
        }
        if (l3Select) {
          l3Select.addEventListener('change', onL3Changed);
          debug.log('å°åˆ†é¡ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ');
        }
        if (l4Select) l4Select.addEventListener('change', onL4Changed);
        if (l5Select) l5Select.addEventListener('change', onL5Changed);
        if (itemSelect) itemSelect.addEventListener('change', updateItemNameDisplay);

        // åŸºæœ¬æƒ…å ±ã®ã‚µã‚¤ã‚ºãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šï¼ˆå•†å“ã®èª¬æ˜ãƒ–ãƒ­ãƒƒã‚¯ã«é€£å‹•ï¼‰
        const sizeSelect = document.getElementById('ã‚µã‚¤ã‚º');
        if (sizeSelect) {
          sizeSelect.addEventListener('change', syncBasicSizeToDescription);
          debug.log('ã‚µã‚¤ã‚ºãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ');
        }

        wirePreviewWatchers();
        updateNamePreview();
        adjustPreviewHeight();
      }).withFailureHandler(e=> show(`NG(MASTER): ${e && e.message ? e.message : e}`)).getCategoryRows();
    }

    // ãƒã‚¹ã‚¿ã‚ªãƒ—ã‚·ãƒ§ãƒ³å–å¾—
    if (google && google.script && google.script.run && google.script.run.getMasterOptions) {
      google.script.run.withSuccessHandler(opts=>{
        if (!opts || typeof opts !== 'object') {
          show('NG(MASTER): ç©ºã®å¿œç­”');
          return;
        }

        // ãƒã‚¹ã‚¿ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
        MASTER_OPTIONS = opts;

        const fillSel=(id,arr)=>{
          const sel=document.getElementById(id);
          if(!sel) return;
          sel.innerHTML='<option value="">--</option>';
          (arr||[]).forEach(v=> sel.insertAdjacentHTML('beforeend', `<option value="${v}">${v}</option>`));
        };

        // åŸºæœ¬ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
        fillSel('æ‹…å½“è€…', opts['æ‹…å½“è€…']||[]);
        fillSel('ä»•å…¥å…ˆ', opts['ä»•å…¥å…ˆ']||[]);
        fillSel('ç”Ÿåœ°ãƒ»ç´ æãƒ»è³ªæ„Ÿç³»', opts['ç”Ÿåœ°ãƒ»ç´ æãƒ»è³ªæ„Ÿç³»']||[]);
        fillSel('ã‚µã‚¤ã‚º', opts['ã‚µã‚¤ã‚º']||[]);
        fillSel('å•†å“ã®çŠ¶æ…‹', unifyConditionList(opts['å•†å“ã®çŠ¶æ…‹']||[]));

        // ã‚µã‚¤ã‚º(è¡¨è¨˜)ã®é¸æŠè‚¢ã‚’è¨­å®š
        fillSel('ã‚µã‚¤ã‚º(è¡¨è¨˜)_ãƒˆãƒƒãƒ—ã‚¹', opts['ã‚µã‚¤ã‚º(è¡¨è¨˜)']||[]);
        fillSel('ã‚µã‚¤ã‚º(è¡¨è¨˜)_ãƒœãƒˆãƒ ã‚¹', opts['ã‚µã‚¤ã‚º(è¡¨è¨˜)']||[]);

// ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ï¼ˆå¾“æ¥ã®é…åˆ—å½¢å¼ã¯äº’æ›æ€§ã®ãŸã‚ä¿æŒï¼‰
        BRAND_EN = Array.isArray(opts['ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)']) ? opts['ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)'] : [];
        BRAND_KANA = Array.isArray(opts['ãƒ–ãƒ©ãƒ³ãƒ‰(ã‚«ãƒŠ)']) ? opts['ãƒ–ãƒ©ãƒ³ãƒ‰(ã‚«ãƒŠ)'] : [];

        // ãƒ–ãƒ©ãƒ³ãƒ‰ãƒšã‚¢ãƒ‡ãƒ¼ã‚¿ã‚’åˆ¥é€”å–å¾—
        google.script.run
          .withSuccessHandler(function(pairs) {
            console.log('ãƒ–ãƒ©ãƒ³ãƒ‰ãƒšã‚¢ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', pairs.length, 'ä»¶');
            BRAND_PAIRS = pairs || [];

            // ãƒšã‚¢ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è‹±èªã¨ã‚«ãƒŠã®é…åˆ—ã‚’å†æ§‹ç¯‰
            BRAND_EN = BRAND_PAIRS.map(pair => pair.english);
            BRAND_KANA = BRAND_PAIRS.map(pair => pair.kana);

            // ãƒšã‚¢ãƒ‡ãƒ¼ã‚¿ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒãƒƒãƒ—ã‚’æ§‹ç¯‰
            buildBrandIndexMap();

            // ãƒ–ãƒ©ãƒ³ãƒ‰å€™è£œã‚’å†è¨­å®šï¼ˆãƒšã‚¢ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ï¼‰
  attachBrandSuggest('ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)', BRAND_EN);

  // å•†å“åãƒ–ãƒ­ãƒƒã‚¯ç”¨ã®ãƒ–ãƒ©ãƒ³ãƒ‰å€™è£œã‚’è¨­å®š
  attachBrandSuggest('å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)', BRAND_EN);
  attachBrandSuggest('å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(ã‚«ãƒŠ)', BRAND_KANA);

            console.log('ãƒ–ãƒ©ãƒ³ãƒ‰ãƒšã‚¢ãƒ‡ãƒ¼ã‚¿è¨­å®šå®Œäº† - EN:', BRAND_EN.length, 'KANA:', BRAND_KANA.length);
          })
          .withFailureHandler(function(error) {
            console.error('ãƒ–ãƒ©ãƒ³ãƒ‰ãƒšã‚¢ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å¾“æ¥ã®é…åˆ—æ–¹å¼ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  buildBrandIndexMap();
  attachBrandSuggest('ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)', BRAND_EN);
  attachBrandSuggest('å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)', BRAND_EN);
  attachBrandSuggest('å•†å“å_ãƒ–ãƒ©ãƒ³ãƒ‰(ã‚«ãƒŠ)', BRAND_KANA);
          })
          .getBrandPairs();

        // ã‚¿ã‚¤ãƒˆãƒ«æƒ…å ±ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
        [
          'å­£ç¯€æ„Ÿãƒ»æ©Ÿèƒ½æ€§','ç€ç”¨ã‚·ãƒ¼ãƒ³ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆ','è¦‹ãŸç›®ãƒ»å°è±¡','ãƒˆãƒ¬ãƒ³ãƒ‰è¡¨ç¾',
          'ã‚µã‚¤ã‚ºæ„Ÿãƒ»ä½“å‹ã‚«ãƒãƒ¼','å¹´ä»£ãƒ»ãƒ†ã‚¤ã‚¹ãƒˆãƒ»ã‚¹ã‚¿ã‚¤ãƒ«','ã‚«ãƒ©ãƒ¼/é…è‰²/ãƒˆãƒ¼ãƒ³','æŸ„ãƒ»æ¨¡æ§˜',
          'ãƒ‡ã‚£ãƒ†ãƒ¼ãƒ«ãƒ»ä»•æ§˜','ã‚·ãƒ«ã‚¨ãƒƒãƒˆ/ãƒ©ã‚¤ãƒ³','ãƒãƒƒã‚¯ãƒ©ã‚¤ãƒ³','è¥Ÿãƒ»è¡¿',
          'è¢–ãƒ»è¢–ä»˜ã‘','ä¸ˆ','é©/åŠ å·¥','æ¯›çš®/åŠ å·¥','ç”Ÿç”£å›½'
        ].forEach(name => fillSel(name, opts[name]||[]));

        // å‡ºå“ãƒ»é…é€é–¢é€£
        fillSel('å‡ºå“å…ˆ', opts['å‡ºå“å…ˆ']||[]);
        fillSel('é…é€æ–™ã®è² æ‹…', opts['é…é€æ–™ã®è² æ‹…']||[]);
        fillSel('é…é€ã®æ–¹æ³•', opts['é…é€ã®æ–¹æ³•']||[]);
        fillSel('ç™ºé€å…ƒã®åœ°åŸŸ', opts['ç™ºé€å…ƒã®åœ°åŸŸ']||[]);
        fillSel('ç™ºé€ã¾ã§ã®æ—¥æ•°', opts['ç™ºé€ã¾ã§ã®æ—¥æ•°']||[]);

applyShippingDefaults();
applyProcureListingDefaults();

// â˜…â˜…â˜… ã“ã“ã‹ã‚‰è¿½åŠ  â˜…â˜…â˜…
// ã‚µã‚¤ã‚ºãƒ»å•†å“ã®çŠ¶æ…‹ãªã©ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
const sizeSelect = document.getElementById('ã‚µã‚¤ã‚º');
if (sizeSelect) {
  sizeSelect.removeEventListener('change', updateNamePreview);
  sizeSelect.addEventListener('change', updateNamePreview);
  console.log('ã‚µã‚¤ã‚ºãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');
}

const conditionSelect = document.getElementById('å•†å“ã®çŠ¶æ…‹');
if (conditionSelect) {
  conditionSelect.removeEventListener('change', updateDescriptionFromDetail);
  conditionSelect.addEventListener('change', updateDescriptionFromDetail);
  conditionSelect.removeEventListener('change', updateConditionButtons);
  conditionSelect.addEventListener('change', updateConditionButtons);
  console.log('å•†å“ã®çŠ¶æ…‹ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');
}

const staffSelect = document.getElementById('æ‹…å½“è€…');
if (staffSelect) {
  staffSelect.removeEventListener('change', updateNamePreview);
  staffSelect.addEventListener('change', updateNamePreview);
  console.log('æ‹…å½“è€…ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');
}

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ãƒã‚¹ã‚¿ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä¿å­˜ï¼ˆéšå±¤å¼ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ç”¨ï¼‰
  window.globalMasterOptions = opts;

  // ãƒ–ãƒ©ãƒ³ãƒ‰å€™è£œè¨­å®šã¯ getBrandPairs() ã®æˆåŠŸæ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹

        wirePreviewWatchers();
        updateNamePreview();
        adjustPreviewHeight();

      }).withFailureHandler(e=> show(`NG(MASTER): ${e && e.message ? e.message : e}`)).getMasterOptions();
    }

// éšå±¤å¼å•†å“å±æ€§ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼è¨­å®š
  setupAttributeSelectors();

  // å‹•çš„ã‚µã‚¤ã‚ºã‚·ã‚¹ãƒ†ãƒ è¨­å®š
  setupSizeSystem();

    // ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰å°‚ç”¨åˆæœŸåŒ–
    initializeSalesWords();

    // è¨­å®šãƒã‚¹ã‚¿å…¨ä½“ã‚’èª­ã¿è¾¼ã¿ï¼ˆé…ç½®é †åºã‚’å«ã‚€ï¼‰
    loadAllConfig();

    // è¨­å®šãƒã‚¹ã‚¿ã‹ã‚‰å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³ã‚’èª­ã¿è¾¼ã¿
    loadConditionButtonsFromConfig();

    // è¨­å®šãƒã‚¹ã‚¿ã‹ã‚‰ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°è¨­å®šã‚’èª­ã¿è¾¼ã¿
    loadHashtagConfig();

    // è¨­å®šãƒã‚¹ã‚¿ã‹ã‚‰å‰²å¼•æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
    loadDiscountConfig();

    // è¨­å®šãƒã‚¹ã‚¿ã‹ã‚‰é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’èª­ã¿è¾¼ã¿
    loadShippingDefaults();

    // è¨­å®šãƒã‚¹ã‚¿ã‹ã‚‰ä»•å…¥ãƒ»å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’èª­ã¿è¾¼ã¿
    loadProcureListingDefaults();

    // è¨­å®šãƒã‚¹ã‚¿ã‹ã‚‰å•†å“åãƒ–ãƒ­ãƒƒã‚¯ä¸¦ã³é †ã‚’èª­ã¿è¾¼ã¿
    loadTitleBlockOrder();

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    const l1=document.getElementById('å¤§åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');
    if (l1) l1.addEventListener('change', onL1Changed);
    const l2=document.getElementById('ä¸­åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');
    if (l2) l2.addEventListener('change', onL2Changed);
    const l3=document.getElementById('å°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');
    if (l3) l3.addEventListener('change', onL3Changed);
    const l4=document.getElementById('ç´°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');
    if (l4) l4.addEventListener('change', onL4Changed);
    const l5=document.getElementById('ç´°åˆ†é¡2');
    if (l5) l5.addEventListener('change', onL5Changed);
    const itemName=document.getElementById('ã‚¢ã‚¤ãƒ†ãƒ å');
    if (itemName) itemName.addEventListener('change', updateItemNameDisplay);

    // ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰å°‚ç”¨ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    setupSalesWordEventListeners();

    wireDescWatcher();

    // å•†å“çŠ¶æ…‹(è©³ç´°)ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šã‚’è¿½åŠ 
    setupDetailEventListener();

    // ã‚¯ã‚¤ãƒƒã‚¯æŒ¿å…¥ãƒœã‚¿ãƒ³è¨­å®š
    setupQuickInsertButtons();

    // ç´ æãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–
    initializeMaterialMasters();

    // ã‚«ãƒ©ãƒ¼ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–
    initializeColorMasters();

    // ç®¡ç†ç•ªå·UIåˆæœŸåŒ–ï¼ˆå‹•çš„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå¯¾å¿œï¼‰
    initManagementNumberUI();

    // ç´ æè¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    const addBtn = document.getElementById('addMaterialBtn');
    if (addBtn) {
      addBtn.addEventListener('click', addMaterial);
    }

    // ã‚«ãƒ©ãƒ¼è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    const addColorBtnEl = document.getElementById('addColorBtn');
    if (addColorBtnEl) {
      addColorBtnEl.addEventListener('click', addColor);
    }

    // å•†å“å±æ€§è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    const addAttributeBtn = document.getElementById('addAttributeBtn');
    if (addAttributeBtn) {
      addAttributeBtn.addEventListener('click', addAttribute);
    }

    // åˆæœŸã®å•†å“å±æ€§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    populateAttributeCategory(1);
    setupAttributeSelector(1);
    updateAttributeRemoveButtons();

    // ç´ æå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´ç›£è¦–
    document.addEventListener('change', function(e) {
      if (e.target.classList.contains('material-location') ||
          e.target.classList.contains('material-type') ||
          e.target.classList.contains('material-percent')) {
        updateDescriptionFromDetail();
      }
    });

    // å•†å“çŠ¶æ…‹å±¥æ­´ã‚’å–å¾—ã—ã¦ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆè¨­å®š
    if (google && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(history) {
          CONDITION_HISTORY = history || [];
          console.log('å•†å“çŠ¶æ…‹å±¥æ­´å–å¾—å®Œäº†:', CONDITION_HISTORY.length, 'ä»¶');

          // ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã‚’è¨­å®š
          attachConditionSuggest('å•†å“çŠ¶æ…‹è©³ç´°', CONDITION_HISTORY);
        })
        .withFailureHandler(function(error) {
          console.error('å•†å“çŠ¶æ…‹å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒœã‚¿ãƒ³ã¯ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
          attachConditionSuggest('å•†å“çŠ¶æ…‹è©³ç´°', []);
        })
        .getProductConditionHistory();
    }

    window.addEventListener('resize', ()=>{
      adjustPreviewHeight();
      adjustDescHeight();
    });
  })();

  // ================= å‹•çš„ã‚µã‚¤ã‚ºæ©Ÿèƒ½ =================
  function setupSizeSystem() {
    // ã‚µã‚¤ã‚ºãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«æ•°å€¤é¸æŠè‚¢ã‚’è¨­å®š
    const sizeFields = ['è‚©å¹…', 'èº«å¹…', 'è¢–ä¸ˆ', 'ç€ä¸ˆ', 'ã‚¦ã‚¨ã‚¹ãƒˆ', 'ãƒ’ãƒƒãƒ—', 'è‚¡ä¸Š', 'è‚¡ä¸‹'];

    sizeFields.forEach(fieldId => {
      const select = document.getElementById(fieldId);
      if (select) {
        // 20cmã€œ120cmã¾ã§1cmåˆ»ã¿ã§é¸æŠè‚¢ã‚’ç”Ÿæˆ
  for (let i = 20; i <= 120; i += 1) {
    const option = document.createElement('option');
    option.value = i.toString();
    option.textContent = i.toString();
    select.appendChild(option);
  }

        // ã‚µã‚¤ã‚ºé¸æŠæ™‚ã«èª¬æ˜æ–‡ã‚’æ›´æ–°
        select.addEventListener('change', updateDescriptionFromDetail);
      }
    });

    // å°åˆ†é¡å¤‰æ›´æ™‚ã®ã‚µã‚¤ã‚ºè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    const subcategorySelect = document.getElementById('å°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');
    if (subcategorySelect) {
      subcategorySelect.addEventListener('change', updateSizeDisplay);
    }

    // åˆæœŸè¡¨ç¤ºè¨­å®š
    updateSizeDisplay();
  }

  // ã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ãŸã‚¢ã‚¤ã‚³ãƒ³ã¨ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
  function getSizeIconAndLabel(subcategory) {
    // ã‚¢ã‚¤ã‚³ãƒ³ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆå¤§åˆ†é¡ãƒ»ä¸­åˆ†é¡ãƒ»ã‚¢ã‚¤ãƒ†ãƒ åã«å¯¾å¿œï¼‰
    const iconMap = {
      // ãƒˆãƒƒãƒ—ã‚¹ç³»
      'Tã‚·ãƒ£ãƒ„': { icon: 'ğŸ‘•', label: 'Tã‚·ãƒ£ãƒ„' },
      'ã‚·ãƒ£ãƒ„': { icon: 'ğŸ‘”', label: 'ã‚·ãƒ£ãƒ„' },
      'ãƒ‹ãƒƒãƒˆ': { icon: 'ğŸ‘•', label: 'ãƒ‹ãƒƒãƒˆ' },
      'ã‚»ãƒ¼ã‚¿ãƒ¼': { icon: 'ğŸ‘•', label: 'ã‚»ãƒ¼ã‚¿ãƒ¼' },
      'ãƒ‘ãƒ¼ã‚«ãƒ¼': { icon: 'ğŸ§¥', label: 'ãƒ‘ãƒ¼ã‚«ãƒ¼' },
      'ã‚¹ã‚¦ã‚§ãƒƒãƒˆ': { icon: 'ğŸ‘•', label: 'ã‚¹ã‚¦ã‚§ãƒƒãƒˆ' },
      'ã‚¸ãƒ£ã‚±ãƒƒãƒˆ': { icon: 'ğŸ§¥', label: 'ã‚¸ãƒ£ã‚±ãƒƒãƒˆ' },
      'ãƒ–ãƒ¬ã‚¶ãƒ¼': { icon: 'ğŸ§¥', label: 'ãƒ–ãƒ¬ã‚¶ãƒ¼' },
      'ã‚«ãƒ¼ãƒ‡ã‚£ã‚¬ãƒ³': { icon: 'ğŸ§¥', label: 'ã‚«ãƒ¼ãƒ‡ã‚£ã‚¬ãƒ³' },
      'ãƒ™ã‚¹ãƒˆ': { icon: 'ğŸ¦º', label: 'ãƒ™ã‚¹ãƒˆ' },
      'ã‚¿ãƒ³ã‚¯ãƒˆãƒƒãƒ—': { icon: 'ğŸ½', label: 'ã‚¿ãƒ³ã‚¯ãƒˆãƒƒãƒ—' },
      'ã‚­ãƒ£ãƒŸã‚½ãƒ¼ãƒ«': { icon: 'ğŸ‘—', label: 'ã‚­ãƒ£ãƒŸã‚½ãƒ¼ãƒ«' },
      'ãƒ–ãƒ©ã‚¦ã‚¹': { icon: 'ğŸ‘š', label: 'ãƒ–ãƒ©ã‚¦ã‚¹' },
      'ãƒãƒ¥ãƒ‹ãƒƒã‚¯': { icon: 'ğŸ‘š', label: 'ãƒãƒ¥ãƒ‹ãƒƒã‚¯' },
      'ãƒ¯ãƒ³ãƒ”ãƒ¼ã‚¹': { icon: 'ğŸ‘—', label: 'ãƒ¯ãƒ³ãƒ”ãƒ¼ã‚¹' },
      'ã‚³ãƒ¼ãƒˆ': { icon: 'ğŸ§¥', label: 'ã‚³ãƒ¼ãƒˆ' },
      'ãƒ€ã‚¦ãƒ³ã‚¸ãƒ£ã‚±ãƒƒãƒˆ': { icon: 'ğŸ§¥', label: 'ãƒ€ã‚¦ãƒ³ã‚¸ãƒ£ã‚±ãƒƒãƒˆ' },
      'ã‚¢ã‚¦ã‚¿ãƒ¼': { icon: 'ğŸ§¥', label: 'ã‚¢ã‚¦ã‚¿ãƒ¼' },
      'ã‚¸ãƒ£ãƒ³ãƒ‘ãƒ¼': { icon: 'ğŸ§¥', label: 'ã‚¸ãƒ£ãƒ³ãƒ‘ãƒ¼' },

      // ãƒœãƒˆãƒ ã‚¹ç³»
      'ãƒ‘ãƒ³ãƒ„': { icon: 'ğŸ‘–', label: 'ãƒ‘ãƒ³ãƒ„' },
      'ã‚¸ãƒ¼ãƒ³ã‚º': { icon: 'ğŸ‘–', label: 'ã‚¸ãƒ¼ãƒ³ã‚º' },
      'ãƒ‡ãƒ‹ãƒ ': { icon: 'ğŸ‘–', label: 'ãƒ‡ãƒ‹ãƒ ' },
      'ãƒãƒãƒ‘ãƒ³': { icon: 'ğŸ‘–', label: 'ãƒãƒãƒ‘ãƒ³' },
      'ã‚¹ãƒ©ãƒƒã‚¯ã‚¹': { icon: 'ğŸ‘”', label: 'ã‚¹ãƒ©ãƒƒã‚¯ã‚¹' },
      'ã‚·ãƒ§ãƒ¼ãƒˆãƒ‘ãƒ³ãƒ„': { icon: 'ğŸ©³', label: 'ã‚·ãƒ§ãƒ¼ãƒˆãƒ‘ãƒ³ãƒ„' },
      'ãƒãƒ¼ãƒ•ãƒ‘ãƒ³ãƒ„': { icon: 'ğŸ©³', label: 'ãƒãƒ¼ãƒ•ãƒ‘ãƒ³ãƒ„' },
      'ãƒ¬ã‚®ãƒ³ã‚¹': { icon: 'ğŸ‘–', label: 'ãƒ¬ã‚®ãƒ³ã‚¹' },
      'ã‚¹ãƒ‘ãƒƒãƒ„': { icon: 'ğŸ‘–', label: 'ã‚¹ãƒ‘ãƒƒãƒ„' },
      'ã‚¸ãƒ§ã‚¬ãƒ¼ãƒ‘ãƒ³ãƒ„': { icon: 'ğŸ‘–', label: 'ã‚¸ãƒ§ã‚¬ãƒ¼ãƒ‘ãƒ³ãƒ„' },
      'ã‚«ãƒ¼ã‚´ãƒ‘ãƒ³ãƒ„': { icon: 'ğŸ‘–', label: 'ã‚«ãƒ¼ã‚´ãƒ‘ãƒ³ãƒ„' },
      'ã‚¹ã‚«ãƒ¼ãƒˆ': { icon: 'ğŸ‘—', label: 'ã‚¹ã‚«ãƒ¼ãƒˆ' },
      'ãƒŸãƒ‹ã‚¹ã‚«ãƒ¼ãƒˆ': { icon: 'ğŸ‘—', label: 'ãƒŸãƒ‹ã‚¹ã‚«ãƒ¼ãƒˆ' },
      'ãƒã‚­ã‚·ã‚¹ã‚«ãƒ¼ãƒˆ': { icon: 'ğŸ‘—', label: 'ãƒã‚­ã‚·ã‚¹ã‚«ãƒ¼ãƒˆ' },
      'ãƒ—ãƒªãƒ¼ãƒ„ã‚¹ã‚«ãƒ¼ãƒˆ': { icon: 'ğŸ‘—', label: 'ãƒ—ãƒªãƒ¼ãƒ„ã‚¹ã‚«ãƒ¼ãƒˆ' }
    };

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³
    const defaultTops = { icon: 'ğŸ‘•', label: 'ãƒˆãƒƒãƒ—ã‚¹' };
    const defaultBottoms = { icon: 'ğŸ‘–', label: 'ãƒ‘ãƒ³ãƒ„' };

    // éƒ¨åˆ†ä¸€è‡´ã§ãƒãƒƒãƒ”ãƒ³ã‚°æ¤œç´¢
    for (const [key, value] of Object.entries(iconMap)) {
      if (subcategory && subcategory.includes(key)) {
        return value;
      }
    }

    // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    return null;
  }

  function updateSizeDisplay() {
    const subcategory = _val('å°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)');
    const sizeSection = document.getElementById('sizeSection');
    const topsSize = document.getElementById('topsSize');
    const bottomsSize = document.getElementById('bottomsSize');
    const shoesSize = document.getElementById('shoesSize');
    const sizeIconDisplay = document.getElementById('sizeIconDisplay');
    const sizeLabelDisplay = document.getElementById('sizeLabelDisplay');

    if (!sizeSection || !topsSize || !bottomsSize || !shoesSize) return;

    // ã‚«ãƒ†ã‚´ãƒªãƒãƒƒãƒ”ãƒ³ã‚°
    const topsCategories = [
      'Tã‚·ãƒ£ãƒ„', 'ã‚·ãƒ£ãƒ„', 'ãƒ‹ãƒƒãƒˆ', 'ã‚»ãƒ¼ã‚¿ãƒ¼', 'ãƒ‘ãƒ¼ã‚«ãƒ¼', 'ã‚¹ã‚¦ã‚§ãƒƒãƒˆ',
      'ã‚¸ãƒ£ã‚±ãƒƒãƒˆ', 'ãƒ–ãƒ¬ã‚¶ãƒ¼', 'ã‚«ãƒ¼ãƒ‡ã‚£ã‚¬ãƒ³', 'ãƒ™ã‚¹ãƒˆ', 'ã‚¿ãƒ³ã‚¯ãƒˆãƒƒãƒ—',
      'ã‚­ãƒ£ãƒŸã‚½ãƒ¼ãƒ«', 'ãƒ–ãƒ©ã‚¦ã‚¹', 'ãƒãƒ¥ãƒ‹ãƒƒã‚¯', 'ãƒ¯ãƒ³ãƒ”ãƒ¼ã‚¹',
      'ã‚³ãƒ¼ãƒˆ', 'ãƒ€ã‚¦ãƒ³ã‚¸ãƒ£ã‚±ãƒƒãƒˆ', 'ã‚¢ã‚¦ã‚¿ãƒ¼', 'ã‚¸ãƒ£ãƒ³ãƒ‘ãƒ¼'
    ];

    const bottomsCategories = [
      'ãƒ‘ãƒ³ãƒ„', 'ã‚¸ãƒ¼ãƒ³ã‚º', 'ãƒ‡ãƒ‹ãƒ ', 'ãƒãƒãƒ‘ãƒ³', 'ã‚¹ãƒ©ãƒƒã‚¯ã‚¹', 'ã‚·ãƒ§ãƒ¼ãƒˆãƒ‘ãƒ³ãƒ„',
      'ãƒãƒ¼ãƒ•ãƒ‘ãƒ³ãƒ„', 'ãƒ¬ã‚®ãƒ³ã‚¹', 'ã‚¹ãƒ‘ãƒƒãƒ„', 'ã‚¸ãƒ§ã‚¬ãƒ¼ãƒ‘ãƒ³ãƒ„', 'ã‚«ãƒ¼ã‚´ãƒ‘ãƒ³ãƒ„',
      'ã‚¹ã‚«ãƒ¼ãƒˆ', 'ãƒŸãƒ‹ã‚¹ã‚«ãƒ¼ãƒˆ', 'ãƒã‚­ã‚·ã‚¹ã‚«ãƒ¼ãƒˆ', 'ãƒ—ãƒªãƒ¼ãƒ„ã‚¹ã‚«ãƒ¼ãƒˆ'
    ];

    const setCategories = [
      'ã‚¹ãƒ¼ãƒ„', 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—', 'ãƒ‘ã‚¸ãƒ£ãƒ', 'ãƒ«ãƒ¼ãƒ ã‚¦ã‚§ã‚¢', 'ã‚¸ãƒ£ãƒ¼ã‚¸',
      'ãƒˆãƒ©ãƒƒã‚¯ã‚¹ãƒ¼ãƒ„', 'ã‚¹ãƒãƒ¼ãƒ„ã‚¦ã‚§ã‚¢', 'ä½œæ¥­ç€', 'ã¤ãªã'
    ];

    const shoesCategories = [
      'ã‚¹ãƒ‹ãƒ¼ã‚«ãƒ¼', 'ãƒ­ãƒ¼ãƒ•ã‚¡ãƒ¼', 'ãƒ–ãƒ¼ãƒ„', 'ã‚µãƒ³ãƒ€ãƒ«', 'ãƒ‘ãƒ³ãƒ—ã‚¹',
      'ãƒ¬ã‚¶ãƒ¼ã‚·ãƒ¥ãƒ¼ã‚º', 'ã‚¹ãƒãƒ¼ãƒ„ã‚·ãƒ¥ãƒ¼ã‚º', 'ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚·ãƒ¥ãƒ¼ã‚º',
      'ãƒã‚¹ã‚±ãƒƒãƒˆã‚·ãƒ¥ãƒ¼ã‚º', 'ã‚¹ã‚±ãƒ¼ãƒˆã‚·ãƒ¥ãƒ¼ã‚º', 'ãƒã‚¤ã‚«ãƒƒãƒˆã‚¹ãƒ‹ãƒ¼ã‚«ãƒ¼',
      'ãƒ­ãƒ¼ã‚«ãƒƒãƒˆã‚¹ãƒ‹ãƒ¼ã‚«ãƒ¼', 'ã‚¹ãƒªãƒƒãƒãƒ³', 'ãƒ¢ã‚«ã‚·ãƒ³', 'ãƒ‡ãƒƒã‚­ã‚·ãƒ¥ãƒ¼ã‚º'
    ];

    // è¡¨ç¤ºçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
    sizeSection.style.display = 'none';
    topsSize.style.display = 'none';
    bottomsSize.style.display = 'none';
    shoesSize.style.display = 'none';

    if (!subcategory) return;

    // ã‚¢ã‚¤ã‚³ãƒ³ã¨ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
    const iconData = getSizeIconAndLabel(subcategory);

    // ãƒ©ã‚°ãƒ©ãƒ³åˆ¤å®šï¼ˆã‚¢ã‚¤ãƒ†ãƒ åã§åˆ¤å®šï¼‰
    const itemName = _val('ã‚¢ã‚¤ãƒ†ãƒ å');
    const isRaglan = itemName && itemName.includes('ãƒ©ã‚°ãƒ©ãƒ³');

    // ã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ã¦è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆï¼†ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°
    if (topsCategories.some(cat => subcategory.includes(cat))) {
      sizeSection.style.display = 'block';
      topsSize.style.display = 'block';
      if (iconData && sizeIconDisplay && sizeLabelDisplay) {
        sizeIconDisplay.textContent = iconData.icon;
        sizeLabelDisplay.textContent = iconData.label;
      }
      // ãƒ©ã‚°ãƒ©ãƒ³ä¾‹å¤–å‡¦ç†: è‚©å¹…â†’è£„ä¸ˆ
      const shoulderLabel = document.getElementById('shoulderWidthLabel');
      if (shoulderLabel) {
        shoulderLabel.textContent = isRaglan ? 'è£„ä¸ˆ' : 'è‚©å¹…';
      }
    } else if (bottomsCategories.some(cat => subcategory.includes(cat))) {
      sizeSection.style.display = 'block';
      bottomsSize.style.display = 'block';
      if (iconData && sizeIconDisplay && sizeLabelDisplay) {
        sizeIconDisplay.textContent = iconData.icon;
        sizeLabelDisplay.textContent = iconData.label;
      }
    } else if (setCategories.some(cat => subcategory.includes(cat))) {
      sizeSection.style.display = 'block';
      topsSize.style.display = 'block';
      bottomsSize.style.display = 'block';
      if (iconData && sizeIconDisplay && sizeLabelDisplay) {
        sizeIconDisplay.textContent = iconData.icon;
        sizeLabelDisplay.textContent = iconData.label;
      }
      // ãƒ©ã‚°ãƒ©ãƒ³ä¾‹å¤–å‡¦ç†: è‚©å¹…â†’è£„ä¸ˆ
      const shoulderLabel = document.getElementById('shoulderWidthLabel');
      if (shoulderLabel) {
        shoulderLabel.textContent = isRaglan ? 'è£„ä¸ˆ' : 'è‚©å¹…';
      }
    } else if (shoesCategories.some(cat => subcategory.includes(cat))) {
      // é´ã®å ´åˆ
      sizeSection.style.display = 'block';
      shoesSize.style.display = 'block';
      if (sizeIconDisplay && sizeLabelDisplay) {
        sizeIconDisplay.textContent = 'ğŸ‘Ÿ';
        sizeLabelDisplay.textContent = 'ã‚µã‚¤ã‚ºï¼ˆé´ï¼‰';
      }

      // ã‚µã‚¤ã‚º(è¡¨è¨˜)_é´ã®selectã«é¸æŠè‚¢ã‚’è¨­å®š
      const shoesSizeSelect = document.getElementById('ã‚µã‚¤ã‚º(è¡¨è¨˜)_é´');
      const basicSizeSelect = document.getElementById('ã‚µã‚¤ã‚º');
      if (shoesSizeSelect && basicSizeSelect) {
        // åŸºæœ¬æƒ…å ±ã®ã‚µã‚¤ã‚ºãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®é¸æŠè‚¢ã‚’ã‚³ãƒ”ãƒ¼
        const currentValue = shoesSizeSelect.value;
        shoesSizeSelect.innerHTML = '';

        // åŸºæœ¬æƒ…å ±ã®å…¨é¸æŠè‚¢ã‚’ã‚³ãƒ”ãƒ¼
        Array.from(basicSizeSelect.options).forEach(option => {
          const newOption = document.createElement('option');
          newOption.value = option.value;
          newOption.textContent = option.textContent;
          shoesSizeSelect.appendChild(newOption);
        });

        // åŸºæœ¬æƒ…å ±ã§é¸æŠã•ã‚Œã¦ã„ã‚‹å€¤ãŒã‚ã‚Œã°åŒæœŸ
        const basicSize = basicSizeSelect.value;
        if (basicSize) {
          shoesSizeSelect.value = basicSize;
        } else if (currentValue) {
          // ä»¥å‰ã®é¸æŠå€¤ã‚’å¾©å…ƒ
          shoesSizeSelect.value = currentValue;
        }
      }

      console.log('â˜…â˜…â˜… updateSizeDisplay() ã§é´ã®ã‚µã‚¤ã‚ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
    }

    // èª¬æ˜æ–‡ã‚’æ›´æ–°
    updateDescriptionFromDetail();
  }

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°è¨­å®š
  window.onSave = onSave;
  window.onReset = onReset;
  window.initPrefix1 = initPrefix1;
  window.buildShelf = buildShelf;
  window.requestNextManagementNumber = requestNextManagementNumber;
  window.updateDescriptionFromDetail = updateDescriptionFromDetail;
  window.setupDetailEventListener = setupDetailEventListener;

  // ================= éšå±¤å¼å•†å“å±æ€§ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ =================
  function setupAttributeSelectors() {
    // å•†å“å±æ€§1
    const category1 = document.getElementById('å•†å“å±æ€§1_ã‚«ãƒ†ã‚´ãƒª');
    const value1 = document.getElementById('å•†å“å±æ€§1_å€¤');
    if (category1 && value1) {
      category1.addEventListener('change', function() {
        updateAttributeValues('å•†å“å±æ€§1_ã‚«ãƒ†ã‚´ãƒª', 'å•†å“å±æ€§1_å€¤');
      });
    }

    // å•†å“å±æ€§2
    const category2 = document.getElementById('å•†å“å±æ€§2_ã‚«ãƒ†ã‚´ãƒª');
    const value2 = document.getElementById('å•†å“å±æ€§2_å€¤');
    if (category2 && value2) {
      category2.addEventListener('change', function() {
        updateAttributeValues('å•†å“å±æ€§2_ã‚«ãƒ†ã‚´ãƒª', 'å•†å“å±æ€§2_å€¤');
      });
    }

    // å•†å“å±æ€§3
    const category3 = document.getElementById('å•†å“å±æ€§3_ã‚«ãƒ†ã‚´ãƒª');
    const value3 = document.getElementById('å•†å“å±æ€§3_å€¤');
    if (category3 && value3) {
      category3.addEventListener('change', function() {
        updateAttributeValues('å•†å“å±æ€§3_ã‚«ãƒ†ã‚´ãƒª', 'å•†å“å±æ€§3_å€¤');
      });
    }
  }

  function updateAttributeValues(categoryId, valueId) {
    const categorySelect = document.getElementById(categoryId);
    const valueSelect = document.getElementById(valueId);

    if (!categorySelect || !valueSelect) return;

    const selectedCategory = categorySelect.value;

    // å€¤ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
    valueSelect.innerHTML = '<option value="">--ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„--</option>';
    valueSelect.disabled = true;

    if (!selectedCategory) {
      updateNamePreview();
      return;
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªãƒã‚¹ã‚¿ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‹ã‚‰å€¤ã‚’å–å¾—
    if (window.globalMasterOptions && window.globalMasterOptions[selectedCategory]) {
      const values = window.globalMasterOptions[selectedCategory];

      if (values && values.length > 0) {
        valueSelect.innerHTML = '<option value="">--é¸æŠã—ã¦ãã ã•ã„--</option>';
        values.forEach(value => {
          const option = document.createElement('option');
          option.value = value;
          option.textContent = value;
          valueSelect.appendChild(option);
        });
        valueSelect.disabled = false;

        // å€¤é¸æŠæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šï¼ˆé‡è¤‡å›é¿ã®ãŸã‚ä¸€åº¦å‰Šé™¤ï¼‰
        valueSelect.removeEventListener('change', updateNamePreview);
        valueSelect.addEventListener('change', updateNamePreview);
      }
    }

    updateNamePreview();
  }

  // åŸºæœ¬æƒ…å ±ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¤‰æ›´æ™‚ã«ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
  function setupHashtagPreviewListeners() {
    const fieldsToWatch = [
      'ãƒ–ãƒ©ãƒ³ãƒ‰(è‹±èª)', 'ãƒ–ãƒ©ãƒ³ãƒ‰(ã‚«ãƒŠ)',
      'å¤§åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)', 'ä¸­åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)', 'å°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)',
      'ç´°åˆ†é¡(ã‚«ãƒ†ã‚´ãƒª)', 'ç´°åˆ†é¡2', 'ã‚¢ã‚¤ãƒ†ãƒ å'
    ];

    fieldsToWatch.forEach(fieldId => {
      const element = document.getElementById(fieldId);
      if (element) {
        element.addEventListener('change', function() {
          updateHashtagCheckboxPreviews();
        });
      }
    });
  }

  // ã‚µã‚¤ã‚º(è¡¨è¨˜)ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
  function setupSizeHyokiListeners() {
    const sizeHyokiTop = document.getElementById('ã‚µã‚¤ã‚º(è¡¨è¨˜)_ãƒˆãƒƒãƒ—ã‚¹');
    const sizeHyokiBottom = document.getElementById('ã‚µã‚¤ã‚º(è¡¨è¨˜)_ãƒœãƒˆãƒ ã‚¹');

    if (sizeHyokiTop) {
      sizeHyokiTop.addEventListener('change', updateDescriptionFromDetail);
    }
    if (sizeHyokiBottom) {
      sizeHyokiBottom.addEventListener('change', updateDescriptionFromDetail);
    }
  }

  // ãƒ©ã‚°ãƒ©ãƒ³åˆ¤å®šã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
  function setupRaglanListener() {
    const itemNameField = document.getElementById('ã‚¢ã‚¤ãƒ†ãƒ å');
    if (itemNameField) {
      itemNameField.addEventListener('change', updateSizeDisplay);
    }
  }

  /**
   * å•†å“ã®èª¬æ˜ãƒ–ãƒ­ãƒƒã‚¯ã®ç¾åœ¨ã®é †åºã‚’å–å¾—
   * @returns {Array} ãƒ–ãƒ­ãƒƒã‚¯ã‚¿ã‚¤ãƒ—ã®é…åˆ—
   */
  function getDescriptionBlocksOrder() {
    const container = document.getElementById('descriptionBlocksContainer');
    if (!container) return [];

    const blocks = container.querySelectorAll('.desc-draggable-block');
    return Array.from(blocks).map(block => block.dataset.blockType);
  }

  /**
   * å•†å“ã®èª¬æ˜ãƒ–ãƒ­ãƒƒã‚¯ã®é–‹é–‰ãƒˆã‚°ãƒ«
   * @param {HTMLElement} button - ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸé–‹é–‰ãƒœã‚¿ãƒ³
   */
  function toggleDescBlock(button) {
    const block = button.closest('.desc-draggable-block');
    if (!block) return;

    const content = block.querySelector('.section-content');
    if (!content) return;

    const isOpen = content.style.display !== 'none';

    if (isOpen) {
      content.style.display = 'none';
      button.textContent = 'â–¶';
    } else {
      content.style.display = 'block';
      button.textContent = 'â–¼';
    }

    // é–‹é–‰çŠ¶æ…‹ã®ä¿å­˜ã¯ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã«è¡Œã†
  }

  /**
   * å•†å“åãƒ–ãƒ­ãƒƒã‚¯ã®é–‹é–‰ãƒˆã‚°ãƒ«
   * @param {HTMLElement} button - ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸé–‹é–‰ãƒœã‚¿ãƒ³
   */
  function toggleTitleBlock(button) {
    const block = button.closest('.title-draggable-block');
    if (!block) return;

    const content = block.querySelector('.section-content');
    if (!content) return;

    const isOpen = content.style.display !== 'none';

    if (isOpen) {
      content.style.display = 'none';
      button.textContent = 'â–¶';
    } else {
      content.style.display = 'block';
      button.textContent = 'â–¼';
    }

    // é–‹é–‰çŠ¶æ…‹ã®ä¿å­˜ã¯ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã«è¡Œã†
  }

  /**
   * å•†å“ã®èª¬æ˜ãƒ–ãƒ­ãƒƒã‚¯ã®ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚’åˆæœŸåŒ–
   */
  function initDescriptionBlocksDragDrop() {
    const container = document.getElementById('descriptionBlocksContainer');
    if (!container) return;

    // Sortable.jsã‚’ä½¿ç”¨ã—ã¦ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚’åˆæœŸåŒ–
    Sortable.create(container, {
      animation: 150,
      handle: '.drag-handle',
      ghostClass: 'sortable-ghost',
      chosenClass: 'sortable-chosen',
      dragClass: 'sortable-drag',
      onEnd: function() {
        // ãƒ‰ãƒ­ãƒƒãƒ—å¾Œã«ä¸¦ã³é †ã‚’ä¿å­˜
        saveDescriptionBlocksOrder();
      }
    });

    console.log('å•†å“ã®èª¬æ˜ãƒ–ãƒ­ãƒƒã‚¯ã®ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ');
  }

  /**
   * å•†å“ã®èª¬æ˜ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸¦ã³é †ã‚’ä¿å­˜
   */
  function saveDescriptionBlocksOrder() {
    const container = document.getElementById('descriptionBlocksContainer');
    if (!container) return;

    const blocks = container.querySelectorAll('.desc-draggable-block');
    const order = Array.from(blocks).map(block => block.dataset.blockType);

    console.log('å•†å“ã®èª¬æ˜ãƒ–ãƒ­ãƒƒã‚¯ä¸¦ã³é †ã‚’ä¿å­˜:', order);

    // è¨­å®šãƒã‚¹ã‚¿ã«ä¿å­˜ï¼ˆTODO: config_loader.jsã«ä¿å­˜æ©Ÿèƒ½ã‚’è¿½åŠ ï¼‰
    // ä»Šã¯ä¸€æ—¦localStorageã«ä¿å­˜
    localStorage.setItem('descriptionBlocksOrder', JSON.stringify(order));
  }

  /**
   * å•†å“ã®èª¬æ˜ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸¦ã³é †ã‚’èª­ã¿è¾¼ã¿
   */
  function loadDescriptionBlocksOrder() {
    const savedOrder = localStorage.getItem('descriptionBlocksOrder');
    if (!savedOrder) return;

    try {
      const order = JSON.parse(savedOrder);
      const container = document.getElementById('descriptionBlocksContainer');
      if (!container) return;

      // ä¸¦ã³é †ã«å¿œã˜ã¦ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä¸¦ã³æ›¿ãˆ
      order.forEach(blockType => {
        const block = container.querySelector(`[data-block-type="${blockType}"]`);
        if (block) {
          container.appendChild(block);
        }
      });

      console.log('å•†å“ã®èª¬æ˜ãƒ–ãƒ­ãƒƒã‚¯ä¸¦ã³é †ã‚’å¾©å…ƒã—ã¾ã—ãŸ:', order);
    } catch (error) {
      console.error('å•†å“ã®èª¬æ˜ãƒ–ãƒ­ãƒƒã‚¯ä¸¦ã³é †ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  /**
   * å•†å“ã®èª¬æ˜ãƒ–ãƒ­ãƒƒã‚¯ã®é–‹é–‰çŠ¶æ…‹ã‚’ä¿å­˜
   */
  function saveDescriptionBlocksCollapseState() {
    const container = document.getElementById('descriptionBlocksContainer');
    if (!container) return;

    const blocks = container.querySelectorAll('.desc-draggable-block');
    const state = {};

    blocks.forEach(block => {
      const content = block.querySelector('.section-content');
      if (content) {
        const blockType = block.dataset.blockType;
        state[blockType] = content.style.display !== 'none';
      }
    });

    console.log('å•†å“ã®èª¬æ˜ãƒ–ãƒ­ãƒƒã‚¯é–‹é–‰çŠ¶æ…‹ã‚’ä¿å­˜:', state);

    // ä»Šã¯ä¸€æ—¦localStorageã«ä¿å­˜
    localStorage.setItem('descriptionBlocksCollapseState', JSON.stringify(state));
  }

  /**
   * å•†å“åãƒ–ãƒ­ãƒƒã‚¯ã®é–‹é–‰çŠ¶æ…‹ã‚’ä¿å­˜
   */
  function saveTitleBlocksCollapseState() {
    const container = document.getElementById('titleBlockContainer');
    if (!container) return;

    const blocks = container.querySelectorAll('.title-draggable-block');
    const state = {};

    blocks.forEach(block => {
      const content = block.querySelector('.section-content');
      if (content) {
        const blockId = block.dataset.blockId;
        state[blockId] = content.style.display !== 'none';
      }
    });

    console.log('å•†å“åãƒ–ãƒ­ãƒƒã‚¯é–‹é–‰çŠ¶æ…‹ã‚’ä¿å­˜:', state);

    // localStorageã«ä¿å­˜
    localStorage.setItem('titleBlocksCollapseState', JSON.stringify(state));
  }

  /**
   * å•†å“ã®èª¬æ˜ãƒ–ãƒ­ãƒƒã‚¯ã®é–‹é–‰çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã¿
   */
  function loadDescriptionBlocksCollapseState() {
    const container = document.getElementById('descriptionBlocksContainer');
    if (!container) return;

    const savedState = localStorage.getItem('descriptionBlocksCollapseState');

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é–‰ã˜ã‚‹ãƒ–ãƒ­ãƒƒã‚¯
    const defaultClosedBlocks = ['discount', 'hashtag'];

    let state = {};

    if (savedState) {
      try {
        state = JSON.parse(savedState);
        console.log('å•†å“ã®èª¬æ˜ãƒ–ãƒ­ãƒƒã‚¯é–‹é–‰çŠ¶æ…‹ã‚’å¾©å…ƒã—ã¾ã—ãŸ:', state);
      } catch (error) {
        console.error('å•†å“ã®èª¬æ˜ãƒ–ãƒ­ãƒƒã‚¯é–‹é–‰çŠ¶æ…‹ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçŠ¶æ…‹ã‚’ä½¿ç”¨
        defaultClosedBlocks.forEach(blockType => {
          state[blockType] = false;
        });
      }
    } else {
      // åˆå›èª­ã¿è¾¼ã¿æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é–‰ã˜ã‚‹
      defaultClosedBlocks.forEach(blockType => {
        state[blockType] = false;
      });
      console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé–‹é–‰çŠ¶æ…‹ã‚’é©ç”¨ã—ã¾ã—ãŸ:', state);
    }

    // ã™ã¹ã¦ã®ãƒ–ãƒ­ãƒƒã‚¯ã«é–‹é–‰çŠ¶æ…‹ã‚’é©ç”¨
    const blocks = container.querySelectorAll('.desc-draggable-block');
    blocks.forEach(block => {
      const blockType = block.dataset.blockType;
      const content = block.querySelector('.section-content');
      const button = block.querySelector('.collapse-btn');

      if (!content || !button) return;

      // stateã«å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã®çŠ¶æ…‹ã‚’ä½¿ç”¨ã€å«ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯é–‹ã„ãŸçŠ¶æ…‹
      const isOpen = state[blockType] !== undefined ? state[blockType] : true;

      if (isOpen) {
        content.style.display = 'block';
        button.textContent = 'â–¼';
      } else {
        content.style.display = 'none';
        button.textContent = 'â–¶';
      }
    });
  }

  /**
   * å•†å“åãƒ–ãƒ­ãƒƒã‚¯ã®é–‹é–‰çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã¿
   */
  function loadTitleBlocksCollapseState() {
    const container = document.getElementById('titleBlockContainer');
    if (!container) return;

    const savedState = localStorage.getItem('titleBlocksCollapseState');

    let state = {};

    if (savedState) {
      try {
        state = JSON.parse(savedState);
        console.log('å•†å“åãƒ–ãƒ­ãƒƒã‚¯é–‹é–‰çŠ¶æ…‹ã‚’å¾©å…ƒã—ã¾ã—ãŸ:', state);
      } catch (error) {
        console.error('å•†å“åãƒ–ãƒ­ãƒƒã‚¯é–‹é–‰çŠ¶æ…‹ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã™ã¹ã¦ã®ãƒ–ãƒ­ãƒƒã‚¯ã«é–‹é–‰çŠ¶æ…‹ã‚’é©ç”¨
    const blocks = container.querySelectorAll('.title-draggable-block');
    blocks.forEach(block => {
      const blockId = block.dataset.blockId;
      const content = block.querySelector('.section-content');
      const button = block.querySelector('.collapse-btn');

      if (!content || !button) return;

      // stateã«å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã®çŠ¶æ…‹ã‚’ä½¿ç”¨ã€å«ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯é–‹ã„ãŸçŠ¶æ…‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
      const isOpen = state[blockId] !== undefined ? state[blockId] : true;

      if (isOpen) {
        content.style.display = 'block';
        button.textContent = 'â–¼';
      } else {
        content.style.display = 'none';
        button.textContent = 'â–¶';
      }
    });
  }

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
  setTimeout(() => {
    setupHashtagPreviewListeners();
    setupSizeHyokiListeners();
    setupRaglanListener();
    initTitleBlockDragDrop();
    applyTitleBlockOrder();
    restoreManagementNumberPlacementSettings();
    initDescriptionBlocksDragDrop();
    loadDescriptionBlocksOrder();
    loadDescriptionBlocksCollapseState();
    loadTitleBlocksCollapseState();
  }, 1000);

</script>

<!-- Firebase Cloud Messaging - ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰é€šçŸ¥å¯¾å¿œ -->
<script type="module">
  // Firebaseè¨­å®š
  const firebaseConfig = {
    apiKey: "AIzaSyAwJKTz1gm3CIz_R4YTlbQopgaBq1ULt1A",
    authDomain: "reborn-pwa.firebaseapp.com",
    projectId: "reborn-pwa",
    storageBucket: "reborn-pwa.firebasestorage.app",
    messagingSenderId: "345653439471",
    appId: "1:345653439471:web:7620819ce3f022d9cd241a",
    measurementId: "G-SX48K45X75"
  };

  // FirebaseåˆæœŸåŒ–
  async function initFirebaseMessaging() {
    try {
      // Firebase App ã¨ Messaging ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
      const { initializeApp, getApps, getApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
      const { getMessaging, onMessage } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js');

      // æ—¢ã«åˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      let app;
      if (getApps().length === 0) {
        app = initializeApp(firebaseConfig);
        console.log('âœ… Firebase AppåˆæœŸåŒ–ï¼ˆå•†å“ç™»éŒ²ãƒšãƒ¼ã‚¸ï¼‰');
      } else {
        app = getApp();
        console.log('âœ… æ—¢å­˜ã®Firebase Appã‚’ä½¿ç”¨ï¼ˆå•†å“ç™»éŒ²ãƒšãƒ¼ã‚¸ï¼‰');
      }

      const messaging = getMessaging(app);
      console.log('âœ… Firebase Messagingå–å¾—å®Œäº†ï¼ˆå•†å“ç™»éŒ²ãƒšãƒ¼ã‚¸ï¼‰');

      // ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ï¼ˆã‚¢ãƒ—ãƒªãŒé–‹ã„ã¦ã„ã‚‹æ™‚ï¼‰
      onMessage(messaging, (payload) => {
        console.log('ğŸ“¨ ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ï¼ˆå•†å“ç™»éŒ²ãƒšãƒ¼ã‚¸ï¼‰:', payload);

        // é€šçŸ¥ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const notificationTitle = payload.data?.title || payload.notification?.title || 'REBORN';
        const notificationBody = payload.data?.body || payload.notification?.body || 'æ–°ã—ã„é€šçŸ¥ãŒã‚ã‚Šã¾ã™';

        // ãƒãƒƒã‚¸ã‚’æ›´æ–°
        incrementBadgeIfAvailable();

        // ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’è¡¨ç¤º
        if (Notification.permission === 'granted') {
          new Notification(notificationTitle, {
            body: notificationBody,
            icon: '/reborn-inventory-system/icon-180.png',
            badge: '/reborn-inventory-system/icon-192.png',
            tag: 'reborn-notification-product-page',
            requireInteraction: false  // è‡ªå‹•ã§æ¶ˆãˆã‚‹
          });
          console.log('ğŸ”” ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’è¡¨ç¤ºã—ã¾ã—ãŸï¼ˆå•†å“ç™»éŒ²ãƒšãƒ¼ã‚¸ï¼‰');
        }
      });

    } catch (error) {
      // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒšãƒ¼ã‚¸ã®ä»–ã®æ©Ÿèƒ½ã«å½±éŸ¿ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
      console.error('âŒ Firebase MessagingåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      console.log('âš ï¸ é€šçŸ¥æ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ãŒã€ä»–ã®æ©Ÿèƒ½ã¯æ­£å¸¸ã«å‹•ä½œã—ã¾ã™');
    }
  }

  // ãƒãƒƒã‚¸ã‚«ã‚¦ãƒ³ãƒˆã‚’å¢—ã‚„ã™ï¼ˆåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
  function incrementBadgeIfAvailable() {
    try {
      // localStorageã‹ã‚‰ç¾åœ¨ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’å–å¾—
      const currentCount = parseInt(localStorage.getItem('badgeCount') || '0', 10);
      const newCount = currentCount + 1;

      // localStorageã«ä¿å­˜
      localStorage.setItem('badgeCount', newCount.toString());
      console.log('ğŸ“› ãƒãƒƒã‚¸ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°:', newCount);

      // Badge APIã§æ›´æ–°ï¼ˆå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿ï¼‰
      if ('setAppBadge' in navigator) {
        navigator.setAppBadge(newCount)
          .then(() => console.log('âœ… Badge APIæ›´æ–°æˆåŠŸ:', newCount))
          .catch(err => console.error('âŒ Badge APIã‚¨ãƒ©ãƒ¼:', err));
      }
    } catch (error) {
      console.error('âŒ ãƒãƒƒã‚¸æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã€å°‘ã—é…å»¶ã•ã›ã¦ã‹ã‚‰Firebase Messagingã‚’åˆæœŸåŒ–
  // ï¼ˆä»–ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚Œã‚‹ã®ã‚’å¾…ã¤ï¼‰
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initFirebaseMessaging, 2000);
    });
  } else {
    setTimeout(initFirebaseMessaging, 2000);
  }
</script>