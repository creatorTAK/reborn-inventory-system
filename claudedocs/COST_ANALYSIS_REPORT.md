# REBORN システム コスト分析レポート

作成日: 2026-01-02

---

## 1. 使用サービス一覧と料金体系

### 1.1 Firebase（Google Cloud）

| サービス | 用途 | 無料枠 | 超過料金 | 現在の状態 |
|---------|------|--------|----------|-----------|
| **Firestore** | データベース | 50,000読/日、20,000書/日 | $0.18/10万読、$0.18/10万書 | 要注意 |
| **Firebase Functions** | バックエンド処理 | 200万回/月 | $0.40/100万回 | 正常 |
| **Firebase Storage** | 画像保存 | 5GB | $0.026/GB | 使用中 |
| **Firebase Auth** | 認証 | 50,000MAU | $0.0055/MAU超過 | 正常 |
| **Firebase Hosting** | (旧) ウェブホスティング | 10GB | $0.026/GB | 不要→削除推奨 |
| **Cloud Messaging** | プッシュ通知 | 完全無料 | - | 正常 |

**Blazeプラン必須理由**: Firebase Functionsを使用（スケジュール実行、Firestoreトリガー）

### 1.2 Cloudflare

| サービス | 用途 | 無料枠 | 超過料金 | 現在の状態 |
|---------|------|--------|----------|-----------|
| **Pages** | ウェブホスティング | 無制限 | - | メイン使用中 |
| **Workers** | エッジ処理 | 100,000リクエスト/日 | $0.50/100万 | 4つ稼働中 |
| **R2** | オブジェクトストレージ | 10GB、100万リクエスト | $0.015/GB | 未移行 |

### 1.3 外部API

| サービス | 用途 | 無料枠 | 超過料金 | 現在の状態 |
|---------|------|--------|----------|-----------|
| **Algolia** | ブランド検索 | 10,000リクエスト/月 | $0.50/1,000リクエスト | 使用中 |
| **OpenAI Whisper** | 音声文字起こし | なし | $0.006/分 | 使用中 |
| **Google Gemini** | AIチャットボット | あり（詳細要確認） | 従量課金 | ヘルプで使用 |
| **Resend** | メール送信 | 3,000通/月 | $20/月〜 | 使用中 |
| **Agora** | 音声通話 | 10,000分/月 | $0.99/1,000分〜 | 計画中 |
| **Google Apps Script** | バックエンドAPI | 無制限 | - | メイン使用中 |

### 1.4 その他（無料）

| サービス | 用途 |
|---------|------|
| 郵便番号API (Zipcloud) | 住所自動入力 |
| 銀行コードAPI | 銀行・支店検索 |
| CDN（Bootstrap, jsDelivr等） | UIライブラリ |

---

## 2. 問題点と改善提案

### 2.1 Firestore読み取りコスト（優先度: 高）

**問題**:
- 1日で2.4万回の読み取り（無料枠5万回の48%を1-2日で消費）
- onSnapshotリスナーが画面を開いているだけで継続的に読み取りを発生

**本日実施した対策**:
- index.html: 7リスナー削減
- menu_home.html: 3リスナー削減
- help.html: 1リスナー削減

**残存リスナー（必須）**:
| ファイル | リスナー数 | 用途 |
|---------|-----------|------|
| chat_rooms_list.html | 2 | ルーム一覧、未読バッジ |
| chat_ui_firestore.html | 3 | メッセージ、通話監視 |
| index.html | 4 | チャットFABバッジ、承認待ち監視 |

**追加改善案**:
1. index.htmlのチャットFABバッジをポーリング方式（30秒間隔）に変更
2. チャット機能を使わないユーザーはリスナー起動しない

---

### 2.2 画像ストレージ二重化（優先度: 中）

**問題**:
- Firebase Storage と Cloudflare R2 が両方存在
- 現在は Firebase Storage をメインで使用
- R2は転送料無料、無料枠が大きい

**現状**:
```
Firebase Storage: 使用中（product.html等）
Cloudflare R2: Worker設定済みだが未移行
```

**改善案**:
1. 新規画像はR2にアップロード
2. 既存画像はそのまま（コスト影響小）
3. 長期的にR2に一本化

**期待効果**: 転送料完全無料化

---

### 2.3 バックエンドの二重構造（優先度: 低）

**問題**:
- Google Apps Script（GAS）とFirebase Functionsが両方存在
- 機能が分散して保守性が低下

**現状の役割分担**:
| 機能 | GAS | Firebase Functions |
|------|-----|-------------------|
| ユーザー管理 | ○ | - |
| 商品管理 | ○ | トリガー通知 |
| 在庫検索 | ○ | - |
| チャット | ○ | 通知送信 |
| プッシュ通知 | - | ○ |
| スケジュール実行 | - | ○ |
| サムネイル生成 | - | ○ |

**評価**:
- 現状は適切な役割分担
- GAS: 無料・無制限のCRUD処理
- Functions: リアルタイム処理・スケジュール実行
- 統合のメリットより現状維持のコストメリットが大きい

---

### 2.4 Algolia検索コスト（優先度: 中）

**問題**:
- 無料枠: 10,000リクエスト/月
- ブランド検索で使用（インクリメンタル検索＝キー入力ごとにリクエスト）

**改善案**:
1. デバウンス処理の追加（300ms待機後にリクエスト）
2. 最低3文字以上で検索開始
3. ローカルキャッシュの活用

**期待効果**: リクエスト数を50-70%削減

---

### 2.5 OpenAI Whisper（優先度: 低）

**問題**:
- 無料枠なし（$0.006/分）
- iOS Safari対応のため必要

**現状評価**:
- 音声入力は任意機能
- 使用頻度は低いと想定
- コスト影響は限定的

**代替案**:
- Web Speech API（ブラウザ標準）への移行検討
- ただしiOS Safariでは制限あり

---

### 2.6 Firebase Hosting（優先度: 即時）

**問題**:
- Cloudflare Pagesに移行済みなのに残存
- ストレージ56.1%使用（古いデプロイ履歴）

**対策**: 本日実施中（古いリリース削除）

---

## 3. コスト予測シミュレーション

### 3.1 現在（開発中・テスト）

| サービス | 月額予測 |
|---------|---------|
| Firebase Blaze基本 | $0（無料枠内） |
| Firestore超過 | $0〜$5 |
| その他 | $0 |
| **合計** | **$0〜$5/月** |

### 3.2 本番運用（5ユーザー・100商品/月）

| サービス | 月額予測 |
|---------|---------|
| Firestore | $0〜$10 |
| Firebase Storage | $0〜$5 |
| Algolia | $0（無料枠内） |
| Resend | $0（無料枠内） |
| **合計** | **$0〜$15/月** |

### 3.3 スケール時（20ユーザー・500商品/月）

| サービス | 月額予測 |
|---------|---------|
| Firestore | $10〜$30 |
| Firebase Storage | $5〜$15 |
| Algolia | $0〜$20 |
| Resend | $0〜$20 |
| Functions | $0〜$5 |
| **合計** | **$15〜$90/月** |

---

## 4. 推奨アクションプラン

### 即時対応（本日）
- [x] Firebase Hosting古いリリース削除
- [x] Firestore onSnapshotリスナー最適化

### 短期対応（1週間以内）
- [ ] Algoliaデバウンス処理追加
- [ ] index.htmlチャットバッジのポーリング化検討

### 中期対応（1ヶ月以内）
- [ ] 画像アップロードのR2移行
- [ ] Firebase使用状況の継続監視

### 長期対応（必要に応じて）
- [ ] Web Speech API移行検討（Whisper代替）
- [ ] Agoraコスト評価（音声通話実装時）

---

## 5. 監視すべき指標

| 指標 | 確認場所 | 警告ライン |
|------|---------|-----------|
| Firestore読み取り/日 | Firebase Console | 40,000回超 |
| Firestore書き込み/日 | Firebase Console | 15,000回超 |
| Storage使用量 | Firebase Console | 4GB超 |
| Algoliaリクエスト/月 | Algolia Dashboard | 8,000回超 |
| Workers実行/日 | Cloudflare Dashboard | 80,000回超 |

---

## 6. 結論

**現在の設計は概ね適切です。**

主な懸念点:
1. **Firestore読み取りコスト**: 本日の最適化で大幅改善見込み
2. **Firebase Hosting**: 不要なので削除（実施中）
3. **画像ストレージ**: R2移行でさらなるコスト削減可能

**スタート前の状態で月額費用がかかる可能性は低い**です。
ただし、Firestoreの使用状況は継続的に監視することを推奨します。

---

## 参考リンク

- [Firebase Pricing](https://firebase.google.com/pricing)
- [Cloudflare R2 Pricing](https://developers.cloudflare.com/r2/pricing/)
- [Algolia Pricing](https://www.algolia.com/pricing)
- [OpenAI Whisper Pricing](https://platform.openai.com/docs/pricing)
- [Resend Pricing](https://resend.com/pricing)
