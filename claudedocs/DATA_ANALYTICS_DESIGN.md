# データ分析基盤設計書

**作成日**: 2025-12-30
**目的**: REBORNシステムのデータ分析機能強化とオークファン連携設計

---

## 1. 現状分析

### 1.1 現在の売上分析機能（sales-analysis.html）

| カテゴリ | 指標 | 状態 |
|---------|------|------|
| **KPI** | 売上高、粗利益、営業利益、粗利益率、営業利益率、成約率 | 実装済 |
| **仕入/出品/販売** | 件数、金額、平均単価 | 実装済 |
| **経費詳細** | 売上原価、販売手数料、送料、梱包資材費 | 実装済 |
| **在庫状況** | 現在庫数、現在庫額、平均在庫日数 | 実装済 |
| **ブランド分析** | - | **未実装** |
| **カテゴリ分析** | - | **未実装** |
| **トレンド分析** | - | **未実装** |
| **仕入判断支援** | - | **未実装** |

### 1.2 現在のデータ構造

**products コレクション**
```javascript
{
  // 基本情報
  managementNumber: "R001234",
  brand: "NIKE",           // ブランド名（テキスト）
  brandId: "xxx",          // ブランドID（Firestore参照用）
  category: "ファッション > メンズ > トップス",

  // 仕入情報
  purchase: {
    date: "2025-01-15",
    amount: 3000,          // 仕入価格
    supplier: "xxx"
  },

  // 出品情報
  listing: {
    date: "2025-01-16",
    amount: 8000,          // 出品価格
    platform: "mercari"
  },

  // 販売情報
  saleDate: "2025-01-20",
  saleAmount: 7500,
  platformFee: 750,
  shippingFee: 700,
  finalProfit: 3050,

  status: "販売済"
}
```

**brands コレクション**
```javascript
{
  id: "xxx",
  nameEn: "NIKE",
  nameKana: "ナイキ",
  usageCount: 10,          // 仕入回数（今回実装）
  createdAt: timestamp,
  updatedAt: timestamp
}
```

### 1.3 現在の課題

1. **ブランド別分析がない**
   - 仕入回数 vs 販売数の比較ができない
   - ブランド別の利益率が見えない
   - 売れ筋/不人気ブランドの判別ができない

2. **外部市場データがない**
   - 適正価格の判断ができない
   - 市場トレンドが把握できない
   - 仕入判断が勘に頼っている

3. **予測機能がない**
   - 売れるまでの日数予測
   - 適正価格の推定
   - 在庫回転率の予測

---

## 2. オークファン連携

### 2.1 オークファンの提供データ（700億件）

| データ種別 | 内容 | 活用方法 |
|-----------|------|---------|
| **過去取引データ** | 10年分の落札価格履歴 | 適正価格設定、仕入判断 |
| **市場トレンド** | 価格推移、需要変動 | 出品タイミング最適化 |
| **カテゴリ別統計** | 落札率、平均落札額 | カテゴリ別戦略立案 |
| **ブランド別統計** | ブランド人気度、価格帯 | 仕入ブランド選定 |

### 2.2 連携方法の選択肢

#### Option A: MCP（Model Context Protocol）サーバー連携
**2025年12月公開予定**

```
メリット:
- 自然言語でクエリ可能
- Claude/ChatGPTから直接アクセス
- 実装コストが低い

デメリット:
- 自動化には不向き
- バッチ処理ができない
- リアルタイム連携に制限
```

#### Option B: 法人向けAPI連携
**要問い合わせ**

```
メリット:
- システム間自動連携
- バッチ処理可能
- カスタマイズ性が高い

デメリット:
- 契約・費用が必要
- 開発コストが高い
```

#### Option C: ハイブリッド方式（推奨）

```
Phase 1: MCPサーバーで概念実証（PoC）
  - まずMCPサーバーで効果検証
  - 必要な分析パターンを特定

Phase 2: 必要に応じてAPI連携
  - 効果が確認できた機能をAPI化
  - 自動化が必要な部分のみAPI契約
```

### 2.3 オークファン連携で実現できる分析

| 分析項目 | 内部データ | オークファンデータ | 統合分析 |
|---------|-----------|------------------|---------|
| ブランド評価 | 仕入回数、販売実績 | 市場人気度、平均価格 | 仕入優先度スコア |
| 価格設定 | 仕入価格、希望利益率 | 相場価格、落札率 | 最適出品価格 |
| 在庫判断 | 在庫日数、回転率 | 市場需要、季節性 | 値下げタイミング |
| 仕入判断 | 過去利益率 | 市場トレンド、供給量 | 仕入可否判定 |

---

## 3. 提案：データ分析機能拡張

### 3.1 Phase 1: ブランド別分析（内部データ活用）

**必要なデータ追加**
```javascript
// brands コレクションに追加
{
  usageCount: 10,        // 仕入回数（実装済）
  salesCount: 8,         // 販売回数（追加）
  totalPurchaseAmount: 30000,  // 総仕入額（追加）
  totalSalesAmount: 60000,     // 総売上額（追加）
  totalProfit: 24000,          // 総利益（追加）
  lastUpdated: timestamp
}
```

**ブランド分析ダッシュボード**
```
┌────────────────────────────────────────────────────┐
│ ブランド別パフォーマンス                              │
├─────────┬──────┬──────┬──────┬──────┬──────────────┤
│ ブランド │ 仕入 │ 販売 │ 消化率│ 利益率│ 評価        │
├─────────┼──────┼──────┼──────┼──────┼──────────────┤
│ NIKE    │  10  │  8   │ 80%  │ 35%  │ ★★★★☆ 継続 │
│ GUCCI   │   5  │  5   │100%  │ 45%  │ ★★★★★ 強化 │
│ XXX     │  10  │  1   │ 10%  │ 15%  │ ★☆☆☆☆ 停止 │
└─────────┴──────┴──────┴──────┴──────┴──────────────┘
```

### 3.2 Phase 2: カテゴリ別分析

**分析項目**
- カテゴリ別消化率
- カテゴリ別利益率
- カテゴリ別在庫日数
- カテゴリ × ブランド クロス分析

### 3.3 Phase 3: オークファン連携

**価格査定支援**
```
仕入検討商品: NIKE Air Jordan 1
├─ 仕入価格: ¥15,000
├─ オークファン相場: ¥22,000〜¥28,000
├─ 推奨出品価格: ¥25,000
├─ 想定利益: ¥7,000（手数料・送料差引後）
└─ 判定: ✅ 仕入推奨（利益率47%）
```

**市場トレンドアラート**
```
📈 トレンド上昇アラート
- NIKE Dunk Low: 相場+15%（直近30日）
- Supreme Box Logo: 相場+22%（直近30日）

📉 トレンド下降アラート
- XXXブランド: 相場-20%（直近30日）
  → 在庫3点あり、早期出品推奨
```

---

## 4. データ設計変更案

### 4.1 ブランド分析用データ拡張

**Option A: brands コレクション拡張**
```javascript
// brands/{brandId}
{
  nameEn: "NIKE",
  nameKana: "ナイキ",
  usageCount: 10,           // 仕入回数
  // 以下追加
  analytics: {
    salesCount: 8,          // 販売回数
    totalPurchase: 30000,   // 総仕入額
    totalSales: 60000,      // 総売上額
    totalProfit: 24000,     // 総利益
    avgProfitRate: 0.35,    // 平均利益率
    avgStockDays: 12,       // 平均在庫日数
    lastSaleDate: "2025-01-20"
  }
}
```

**Option B: 別コレクション（brandAnalytics）作成**
```javascript
// brandAnalytics/{brandId}_{period}
{
  brandId: "xxx",
  period: "2025-01",        // 月次集計
  purchaseCount: 5,
  salesCount: 4,
  totalPurchase: 15000,
  totalSales: 32000,
  totalProfit: 13000,
  avgProfitRate: 0.41
}
```

**推奨: Option A（シンプル）+ 必要に応じてOption B（履歴保持）**

### 4.2 オークファン連携用データ構造

**将来的に追加**
```javascript
// products/{productId} に追加
{
  // 既存フィールド
  ...

  // オークファン連携データ
  marketData: {
    aucfanId: "xxx",           // オークファン商品ID
    marketPrice: {
      low: 18000,
      mid: 22000,
      high: 28000,
      fetchedAt: timestamp
    },
    trendScore: 75,            // トレンドスコア（0-100）
    demandLevel: "high",       // 需要レベル
    suggestedPrice: 25000      // 推奨出品価格
  }
}
```

---

## 5. 実装ロードマップ

### Phase 1: 内部データ分析強化（1-2週間）
```
□ ブランド別販売カウント機能追加
□ ブランド分析ダッシュボード作成
□ 消化率・利益率の自動計算
□ 仕入推奨/停止アラート
```

### Phase 2: カテゴリ分析（1週間）
```
□ カテゴリ別集計機能
□ クロス分析（ブランド×カテゴリ）
□ 在庫日数分析
```

### Phase 3: オークファンMCP連携PoC（2025年12月以降）
```
□ MCPサーバー接続設定
□ 価格査定機能プロトタイプ
□ 効果検証・必要機能特定
```

### Phase 4: オークファンAPI本格連携（要検討）
```
□ 法人契約・API取得
□ 自動価格取得機能
□ トレンドアラート機能
□ 仕入判断支援AI
```

---

## 6. 結論と推奨事項

### 6.1 今すぐやるべきこと

1. **ブランド別販売カウントの実装**
   - 販売完了時に brands.salesCount をインクリメント
   - これにより「仕入回数 vs 販売回数」の分析が可能に

2. **ブランド分析ダッシュボードの作成**
   - 既存の売上分析画面に「ブランド別」タブを追加
   - 消化率、利益率でソート可能に

### 6.2 オークファン連携の準備

1. **2025年12月のMCPサーバー公開を待つ**
   - まずは手動でのPoC（概念実証）
   - 必要な分析パターンを特定

2. **データ構造の拡張性を確保**
   - products.marketData フィールドを予約
   - 将来のAPI連携に備えた設計

### 6.3 最重要ポイント

```
内部データ分析（Phase 1-2）× 外部市場データ（Phase 3-4）
         ↓
    統合された仕入判断支援システム
         ↓
    利益最大化・在庫最適化
```

---

## 参考リンク

- [オークファン法人向けAPI](https://topics.aucfan.com/release/aucfan-api/)
- [オークファンMCPサーバー発表（2025年12月公開予定）](https://aucfan.co.jp/press/release/2025/7084/)
- [オークファンプロPlus](https://pro.aucfan.com/)
