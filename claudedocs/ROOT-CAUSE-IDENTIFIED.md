# æ ¹æœ¬åŸå› ã®ç‰¹å®š

**ä½œæˆæ—¥: 2025-11-18**
**çµè«–: limit() ãªã—ã®å…¨ä»¶å–å¾—ãŒåŸå› ã€‚iframe CORS ã¯å‰¯æ¬¡çš„ãªå•é¡Œã€‚**

---

## ğŸ¯ æ ¹æœ¬åŸå› 

### ã‚³ãƒ¼ãƒ‰ã®å•é¡Œç®‡æ‰€

**ãƒ•ã‚¡ã‚¤ãƒ«:** `/docs/js/firestore-api.js`
**é–¢æ•°:** `preloadBrandsInBackground()` (line 656-698)

**å•é¡Œã®ã‚³ãƒ¼ãƒ‰:**
```javascript
async function preloadBrandsInBackground() {
  // ...
  const db = await initializeFirestore();

  // âŒ limit() ãªã—ã§å…¨ä»¶å–å¾—
  const snapshot = await db.collection('brands').get();

  // 51,343ä»¶ã™ã¹ã¦ã‚’ä¸€åº¦ã«å–å¾— â†’ 117ç§’
}
```

**å‘¼ã³å‡ºã—å…ƒ:**
- `/docs/js/brand-suggest-firestore.js` (line 81)
- ç”»é¢è¡¨ç¤ºå¾Œã€5ç§’é…å»¶ã§ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰é–‹å§‹

---

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿é‡ã®æ¯”è¼ƒ

| ãƒ‡ãƒ¼ã‚¿ | ä»¶æ•° | èª­ã¿è¾¼ã¿æ–¹æ³• | æ™‚é–“ | å•é¡Œ |
|-------|-----|------------|------|------|
| **ãƒ–ãƒ©ãƒ³ãƒ‰** | **51,343ä»¶** | **limit ãªã—å…¨ä»¶å–å¾—** | **117ç§’** | âŒ |
| ã‚«ãƒ†ã‚´ãƒª | 1,685ä»¶ | å…¨ä»¶å–å¾— | æ•°ç§’ | âœ… |
| ç®¡ç†ç•ªå·è¨­å®š | 1ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | doc().get() | <1ç§’ | âœ… |

**ãªãœãƒ–ãƒ©ãƒ³ãƒ‰ã ã‘é…ã„ã®ã‹ï¼Ÿ**
â†’ **åœ§å€’çš„ãªãƒ‡ãƒ¼ã‚¿é‡ï¼ˆ51,343ä»¶ï¼‰ã‚’ limit ãªã—ã§ä¸€åº¦ã«å–å¾—ã—ã¦ã„ã‚‹ãŸã‚**

---

## ğŸ” iframe CORS ã¯å‰¯æ¬¡çš„ãªå•é¡Œ

### CORS ã‚¨ãƒ©ãƒ¼ã®çœŸå®Ÿ

**ãƒ­ã‚°ã‚ˆã‚Š:**
```
[Warning] WebChannelConnection RPC 'Listen' stream transport errored
```

**ã“ã‚ŒãŒæ„å‘³ã™ã‚‹ã“ã¨:**
1. Firestore ãŒ WebSocket æ¥ç¶šã‚’è©¦ã¿ã‚‹
2. iframe ã® CORS ãƒãƒªã‚·ãƒ¼ã§ WebSocket ãŒå¤±æ•—
3. è‡ªå‹•çš„ã« HTTP long-polling ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
4. **long-polling ã§ã‚‚å‹•ä½œã¯ã™ã‚‹ï¼ˆé…ã„ã ã‘ï¼‰**

### æ¤œè¨¼çµæœï¼ˆæ¨æ¸¬ï¼‰

**åŒã˜ã‚³ãƒ¼ãƒ‰ã‚’ç›´æ¥ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦ã‚‚:**
- WebSocket ãŒæˆåŠŸã™ã‚Œã°é€Ÿããªã‚‹å¯èƒ½æ€§
- ã—ã‹ã— **51,343ä»¶ã‚’ä¸€åº¦ã«å–å¾—ã™ã‚‹æ™‚ç‚¹ã§é…ã„**
- WebSocket ã¯ã€Œãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã€ã«å¼·ã„ãŒã€ã€Œå¤§é‡ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬å–å¾—ã€ã«ã¯é©ã—ã¦ã„ãªã„

**ã¤ã¾ã‚Š:**
- iframe â†’ CORS â†’ WebSocketå¤±æ•— â†’ long-polling â†’ **é…ã„** (117ç§’)
- ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ â†’ WebSocketæˆåŠŸ â†’ **ãã‚Œã§ã‚‚é…ã„** (50-60ç§’ï¼Ÿ)

**æ ¹æœ¬åŸå› ã¯ limit ãªã—ã®å…¨ä»¶å–å¾—ã€‚iframe CORS ã¯ "é…ã•ã‚’åŠ é€Ÿ" ã—ã¦ã„ã‚‹ã ã‘ã€‚**

---

## ğŸ’¡ æ­£ã—ã„è§£æ±ºç­–

### Option 1: limit() ã‚’ä½¿ã£ãŸæ®µéšçš„èª­ã¿è¾¼ã¿ï¼ˆæœ€å„ªå…ˆãƒ»æœ€ã‚‚åŠ¹æœçš„ï¼‰

**å®Ÿè£…æ–¹æ³•:**

**A. ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã‚’å®Œå…¨ã«å»ƒæ­¢**
```javascript
// preloadBrandsInBackground() ã‚’å‘¼ã°ãªã„
// æ¤œç´¢æ™‚ã«åˆã‚ã¦å¿…è¦ãªåˆ†ã ã‘å–å¾—

async function searchBrands(query, limit = 50) {
  const db = await initializeFirestore();

  // ã‚¯ã‚¨ãƒªã§çµã‚Šè¾¼ã‚“ã§å–å¾—ï¼ˆé«˜é€Ÿï¼‰
  const snapshot = await db.collection('brands')
    .where('searchText', '>=', query.toLowerCase())
    .where('searchText', '<=', query.toLowerCase() + '\uf8ff')
    .orderBy('searchText')
    .orderBy('usageCount', 'desc')
    .limit(limit)
    .get();

  // 50ä»¶ç¨‹åº¦ãªã‚‰æ•°ç™¾ms ã§å®Œäº†
}
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- åˆå›è¡¨ç¤ºãŒå³åº§ï¼ˆãƒ—ãƒªãƒ­ãƒ¼ãƒ‰å¾…ã¡ãªã—ï¼‰
- æ¤œç´¢æ™‚ã®ã¿å¿…è¦ãªåˆ†ã ã‘å–å¾—ï¼ˆé«˜é€Ÿï¼‰
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è² è·ã‚’æœ€å°åŒ–

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- æ¤œç´¢ã”ã¨ã« Firestore ã¸ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—ï¼‰
- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ¤œç´¢ä¸å¯

---

**B. æ®µéšçš„ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ï¼ˆäººæ°—ãƒ–ãƒ©ãƒ³ãƒ‰å„ªå…ˆï¼‰**
```javascript
// åˆå›: äººæ°—ãƒ–ãƒ©ãƒ³ãƒ‰ä¸Šä½500ä»¶ã®ã¿ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
async function preloadPopularBrands() {
  const db = await initializeFirestore();

  const snapshot = await db.collection('brands')
    .orderBy('usageCount', 'desc')
    .limit(500)  // â† ä¸Šä½500ä»¶ã®ã¿
    .get();

  // 500ä»¶ãªã‚‰æ•°ç§’ã§å®Œäº†
  brandsCache = snapshot.docs.map(doc => doc.data());
}

// æ¤œç´¢æ™‚: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãªã‘ã‚Œã°Firestoreã‹ã‚‰å–å¾—
async function searchBrands(query, limit = 50) {
  // ã¾ãšã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰æ¤œç´¢
  const cachedResults = searchBrandsFromCache(query, limit);

  if (cachedResults.length >= limit) {
    return cachedResults; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§ååˆ†
  }

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã®ã¿Firestoreã‹ã‚‰è¿½åŠ å–å¾—
  // ...
}
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- ã‚ˆãä½¿ã†ãƒ–ãƒ©ãƒ³ãƒ‰ã¯å³åº§ã«æ¤œç´¢å¯èƒ½ï¼ˆ500ä»¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
- åˆå›ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ãŒé«˜é€Ÿï¼ˆæ•°ç§’ï¼‰
- ãƒ¬ã‚¢ãªãƒ–ãƒ©ãƒ³ãƒ‰ã‚‚å¿…è¦æ™‚ã«å–å¾—

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- ã‚„ã‚„è¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯

---

**C. IndexedDB æ°¸ç¶šã‚­ãƒ£ãƒƒã‚·ãƒ¥**
```javascript
// åˆå›ã®ã¿å…¨ä»¶å–å¾— â†’ IndexedDB ã«ä¿å­˜
// 2å›ç›®ä»¥é™ã¯ IndexedDB ã‹ã‚‰å³åº§ã«å–å¾—

// åˆå›ï¼ˆã¾ãŸã¯æ›´æ–°æ™‚ï¼‰
async function syncBrandsToIndexedDB() {
  // æ™‚é–“ã‹ã‹ã‚‹ãŒ1å›ã ã‘
  const brands = await getAllBrandsFromFirestore();
  await saveToIndexedDB('brands', brands);
}

// ä»¥é™ã®æ¤œç´¢
async function searchBrands(query, limit) {
  // IndexedDB ã‹ã‚‰å³åº§ã«å–å¾—ï¼ˆãƒŸãƒªç§’å˜ä½ï¼‰
  const brands = await loadFromIndexedDB('brands');
  return brands.filter(...).slice(0, limit);
}
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- 2å›ç›®ä»¥é™ã¯è¶…é«˜é€Ÿï¼ˆãƒŸãƒªç§’å˜ä½ï¼‰
- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ¤œç´¢å¯èƒ½

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- åˆå›ã¯ä¾ç„¶ã¨ã—ã¦é…ã„ï¼ˆ117ç§’ï¼‰
- å®Ÿè£…è¤‡é›‘åº¦ãŒé«˜ã„

---

### Option 2: åŒä¸€ã‚ªãƒªã‚¸ãƒ³åŒ–ï¼ˆä¸­é•·æœŸçš„ãªè§£æ±ºï¼‰

**ç›®çš„:** iframe CORS å•é¡Œã‚’æ ¹æœ¬è§£æ±º + WebSocket æœ‰åŠ¹åŒ–

**æ–¹æ³•:**
- furira.jp ä¸‹ã« PWA ã‚’é…ç½®
- ã¾ãŸã¯ PWA å…¨ä½“ã‚’ pages.dev ã«ç§»è¡Œ

**åŠ¹æœ:**
- WebSocket æ¥ç¶šæˆåŠŸ â†’ long-polling ã‚ˆã‚Šé€Ÿã„
- **ã—ã‹ã— limit ãªã—ã®å…¨ä»¶å–å¾—ãŒæ”¹å–„ã•ã‚Œãªã„é™ã‚Šã€åŠ‡çš„ãªæ”¹å–„ã¯è¦‹è¾¼ã‚ãªã„**

**å„ªå…ˆåº¦:** Option 1 å®Ÿæ–½å¾Œã«æ¤œè¨

---

## ğŸ¯ æ¨å¥¨å®Ÿè£…ãƒ—ãƒ©ãƒ³

### Phase 1: å³åŠ¹å¯¾ç­–ï¼ˆ1-2æ™‚é–“ï¼‰

**å®Ÿè£…å†…å®¹:**
1. `preloadBrandsInBackground()` ã‚’ **åœæ­¢**ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
2. `searchBrands()` ã‚’ **ã‚¯ã‚¨ãƒªãƒ™ãƒ¼ã‚¹** ã«å¤‰æ›´
3. æ¤œç´¢æ™‚ã®ã¿å¿…è¦ãª50-100ä»¶ã‚’å–å¾—

**æœŸå¾…åŠ¹æœ:**
- åˆå›è¡¨ç¤º: å³åº§ï¼ˆãƒ—ãƒªãƒ­ãƒ¼ãƒ‰å¾…ã¡ãªã—ï¼‰
- æ¤œç´¢æ™‚: æ•°ç™¾ms ã§çµæœè¡¨ç¤º
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“æ„Ÿ: **åŠ‡çš„æ”¹å–„**

**ãƒªã‚¹ã‚¯:**
- æ¤œç´¢ã”ã¨ã« Firestore ã‚¢ã‚¯ã‚»ã‚¹ â†’ ã‚³ã‚¹ãƒˆå¢—åŠ ï¼ˆå¾®ã€…ãŸã‚‹ã‚‚ã®ï¼‰

---

### Phase 2: æœ€é©åŒ–ï¼ˆ1æ—¥ï¼‰

**å®Ÿè£…å†…å®¹:**
1. äººæ°—ãƒ–ãƒ©ãƒ³ãƒ‰ä¸Šä½500ä»¶ã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆè»½é‡åŒ–ï¼‰
2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡ã‚’æ¸¬å®š
3. å¿…è¦ã«å¿œã˜ã¦è¿½åŠ å–å¾—ãƒ­ã‚¸ãƒƒã‚¯

**æœŸå¾…åŠ¹æœ:**
- ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰: æ•°ç§’ã§å®Œäº†
- æ¤œç´¢: ã»ã¨ã‚“ã©ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆï¼ˆå³åº§ï¼‰
- ãƒ¬ã‚¢ã‚±ãƒ¼ã‚¹: Firestore ã‹ã‚‰è¿½åŠ å–å¾—

---

### Phase 3: é•·æœŸæ”¹å–„ï¼ˆ1é€±é–“ï¼‰

**å®Ÿè£…å†…å®¹:**
1. IndexedDB æ°¸ç¶šã‚­ãƒ£ãƒƒã‚·ãƒ¥
2. åŒä¸€ã‚ªãƒªã‚¸ãƒ³åŒ–ï¼ˆWebSocket æœ‰åŠ¹åŒ–ï¼‰
3. å·®åˆ†æ›´æ–°ï¼ˆå¤‰æ›´ã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒ‰ã®ã¿åŒæœŸï¼‰

**æœŸå¾…åŠ¹æœ:**
- 2å›ç›®ä»¥é™: ãƒŸãƒªç§’å˜ä½ã§æ¤œç´¢
- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ
- å®Œç’§ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“

---

## ğŸ“‹ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### æœ€å„ªå…ˆ: Phase 1 ã®å®Ÿè£…

**å…·ä½“çš„ãªæ‰‹é †:**

1. **brand-suggest-firestore.js ã‚’ä¿®æ­£**
   ```javascript
   // line 76-83 ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
   // if (!window.brandsPreloadScheduled) {
   //   window.brandsPreloadScheduled = true;
   //   setTimeout(() => {
   //     console.log('â° ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰é–‹å§‹ï¼ˆ5ç§’é…å»¶ï¼‰');
   //     preloadBrandsInBackground();
   //   }, 5000);
   // }
   ```

2. **firestore-api.js ã® searchBrands() ã‚’ä¿®æ­£**
   ```javascript
   async function searchBrands(query = '', limit = 50) {
     const db = await initializeFirestore();

     if (!query) {
       // ç©ºæ¤œç´¢: äººæ°—ãƒ–ãƒ©ãƒ³ãƒ‰ä¸Šä½ã‚’è¿”ã™
       const snapshot = await db.collection('brands')
         .orderBy('usageCount', 'desc')
         .limit(limit)
         .get();
       // ...
     } else {
       // ã‚¯ã‚¨ãƒªæ¤œç´¢: éƒ¨åˆ†ä¸€è‡´ã§å–å¾—
       const snapshot = await db.collection('brands')
         .where('searchText', '>=', query.toLowerCase())
         .where('searchText', '<=', query.toLowerCase() + '\uf8ff')
         .orderBy('searchText')
         .orderBy('usageCount', 'desc')
         .limit(limit)
         .get();
       // ...
     }
   }
   ```

3. **ãƒ†ã‚¹ãƒˆ**
   - å•†å“ç™»éŒ²ç”»é¢ã‚’é–‹ã â†’ å³åº§ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‹ï¼Ÿ
   - ãƒ–ãƒ©ãƒ³ãƒ‰æ¤œç´¢ â†’ æ•°ç™¾ms ã§çµæœãŒå‡ºã‚‹ã‹ï¼Ÿ

---

## âœ… ã¾ã¨ã‚

**æ ¹æœ¬åŸå› :**
- **limit() ãªã—ã®å…¨ä»¶å–å¾—ï¼ˆ51,343ä»¶ï¼‰**ãŒä¸»åŸå› 
- iframe CORS ã¯å‰¯æ¬¡çš„ï¼ˆé…ã•ã‚’åŠ é€Ÿã—ã¦ã„ã‚‹ã ã‘ï¼‰

**æ­£ã—ã„è§£æ±ºç­–:**
1. **ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã‚’å»ƒæ­¢** â†’ æ¤œç´¢æ™‚ã®ã¿å¿…è¦ãªåˆ†ã ã‘å–å¾—
2. ã¾ãŸã¯ **äººæ°—ãƒ–ãƒ©ãƒ³ãƒ‰ã®ã¿ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰**ï¼ˆ500ä»¶ç¨‹åº¦ï¼‰
3. é•·æœŸçš„ã«ã¯ **IndexedDB + åŒä¸€ã‚ªãƒªã‚¸ãƒ³åŒ–**

**æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ:**
- åˆå›è¡¨ç¤º: 117ç§’ â†’ **å³åº§**
- æ¤œç´¢æ™‚: 20ç§’ â†’ **æ•°ç™¾ms**
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“æ„Ÿ: **åŠ‡çš„æ”¹å–„**

**å®Ÿè£…å·¥æ•°:**
- Phase 1ï¼ˆå³åŠ¹å¯¾ç­–ï¼‰: 1-2æ™‚é–“
- Phase 2ï¼ˆæœ€é©åŒ–ï¼‰: 1æ—¥
- Phase 3ï¼ˆå®Œç’§ï¼‰: 1é€±é–“

---

**æœ€çµ‚æ›´æ–°: 2025-11-18**
