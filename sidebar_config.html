<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>設定管理</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f8f9fa;
    }
    .config-container {
      padding: 16px;
    }
    .nav-tabs {
      margin-bottom: 20px;
      flex-wrap: nowrap;
      overflow-x: auto;
      border-bottom: 2px solid #dee2e6;
    }
    .nav-tabs .nav-link {
      font-size: 13px;
      padding: 8px 12px;
      white-space: nowrap;
      border: none;
      border-bottom: 3px solid transparent;
      color: #6c757d;
    }
    .nav-tabs .nav-link.active {
      color: #0d6efd;
      border-bottom-color: #0d6efd;
      background-color: transparent;
      font-weight: 600;
    }
    .tab-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #212529;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 8px;
    }
    .form-label {
      font-weight: 500;
      font-size: 13px;
      color: #495057;
      margin-bottom: 4px;
    }
    .form-control, .form-select {
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #ced4da;
    }
    .form-control:focus, .form-select:focus {
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    .btn-group-sm .btn {
      font-size: 12px;
      padding: 4px 8px;
    }
    .save-btn {
      position: sticky;
      bottom: 0;
      background: white;
      padding: 12px 16px;
      border-top: 1px solid #dee2e6;
      margin: -16px -16px 0 -16px;
      z-index: 10;
    }
    .button-config-item {
      background: #f8f9fa;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 6px;
      border: 1px solid #e9ecef;
    }
    .button-config-item .form-label {
      margin-bottom: 6px;
    }
    .add-btn {
      font-size: 13px;
      padding: 6px 12px;
    }
    .remove-btn {
      font-size: 12px;
      padding: 2px 8px;
    }
    .discount-group {
      background: #f8f9fa;
      padding: 16px;
      margin-bottom: 16px;
      border-radius: 6px;
      border: 1px solid #e9ecef;
    }
    .discount-range-item {
      background: white;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 4px;
      border: 1px solid #dee2e6;
    }
    .alert {
      font-size: 13px;
      padding: 10px 14px;
      margin-bottom: 16px;
    }
    .input-group-text {
      font-size: 13px;
    }
    .condition-group {
      margin-bottom: 24px;
    }
    .condition-group-title {
      font-size: 14px;
      font-weight: 600;
      color: #495057;
      margin-bottom: 12px;
      padding: 8px 12px;
      background: #e9ecef;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div class="config-container">
    <!-- タブナビゲーション -->
    <ul class="nav nav-tabs" id="configTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="condition-tab" data-bs-toggle="tab" data-bs-target="#condition" type="button" role="tab">商品状態ボタン</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="hashtag-tab" data-bs-toggle="tab" data-bs-target="#hashtag" type="button" role="tab">ハッシュタグ</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="discount-tab" data-bs-toggle="tab" data-bs-target="#discount" type="button" role="tab">割引情報</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="shipping-tab" data-bs-toggle="tab" data-bs-target="#shipping" type="button" role="tab">配送デフォルト</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="management-tab" data-bs-toggle="tab" data-bs-target="#management" type="button" role="tab">管理番号設定</button>
      </li>
    </ul>

    <!-- タブコンテンツ -->
    <div class="tab-content" id="configTabContent">

      <!-- 商品状態ボタン設定 -->
      <div class="tab-pane fade show active" id="condition" role="tabpanel">
        <div class="section-title">商品状態ボタン設定</div>
        <div id="conditionButtonsContainer">
          <!-- 動的に生成 -->
        </div>
      </div>

      <!-- ハッシュタグ設定 -->
      <div class="tab-pane fade" id="hashtag" role="tabpanel">
        <div class="section-title">ハッシュタグ設定</div>

        <div class="mb-3">
          <label class="form-label">全商品プレフィックス</label>
          <input type="text" class="form-control" id="全商品プレフィックス" placeholder="#REBORN_">
        </div>

        <div class="mb-3">
          <label class="form-label">全商品テキスト</label>
          <input type="text" class="form-control" id="全商品テキスト" placeholder="全商品">
        </div>

        <div class="mb-3">
          <label class="form-label">ブランドプレフィックス</label>
          <input type="text" class="form-control" id="ブランドプレフィックス" placeholder="#REBORN_">
        </div>

        <div class="mb-3">
          <label class="form-label">ブランドサフィックス</label>
          <input type="text" class="form-control" id="ブランドサフィックス" placeholder="アイテム一覧">
        </div>

        <div class="mb-3">
          <label class="form-label">カテゴリプレフィックス</label>
          <input type="text" class="form-control" id="カテゴリプレフィックス" placeholder="#REBORN_">
        </div>

        <div class="mb-3">
          <label class="form-label">カテゴリサフィックス</label>
          <input type="text" class="form-control" id="カテゴリサフィックス" placeholder="一覧">
        </div>
      </div>

      <!-- 割引情報設定 -->
      <div class="tab-pane fade" id="discount" role="tabpanel">
        <div class="section-title">割引情報設定</div>

        <!-- フォロー割 -->
        <div class="discount-group">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <strong>フォロー割</strong>
            <button type="button" class="btn btn-sm btn-primary add-btn" onclick="addDiscountRange('フォロー割')">+ 範囲追加</button>
          </div>
          <div id="フォロー割Container">
            <!-- 動的に生成 -->
          </div>
          <div class="mt-2">
            <label class="form-label" style="font-size: 12px;">説明文（任意）</label>
            <textarea class="form-control" id="フォロー割_説明文" rows="2" placeholder="例: フォローしてコメントください" style="font-size: 13px;"></textarea>
          </div>
        </div>

        <!-- リピート割 -->
        <div class="discount-group">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <strong>リピート割</strong>
            <button type="button" class="btn btn-sm btn-primary add-btn" onclick="addDiscountRange('リピート割')">+ 範囲追加</button>
          </div>
          <div id="リピート割Container">
            <!-- 動的に生成 -->
          </div>
          <div class="mt-2">
            <label class="form-label" style="font-size: 12px;">説明文（任意）</label>
            <textarea class="form-control" id="リピート割_説明文" rows="2" placeholder="例: 「リピート割希望」とコメントにてお知らせください。" style="font-size: 13px;"></textarea>
          </div>
        </div>

        <!-- まとめ割 -->
        <div class="discount-group">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <strong>まとめ割</strong>
            <button type="button" class="btn btn-sm btn-primary add-btn" onclick="addDiscountRange('まとめ割')">+ 範囲追加</button>
          </div>
          <div id="まとめ割Container">
            <!-- 動的に生成 -->
          </div>
          <div class="mt-2">
            <label class="form-label" style="font-size: 12px;">説明文（任意）</label>
            <textarea class="form-control" id="まとめ割_説明文" rows="2" placeholder="例: 購入したい商品が複数ある場合、コメントにてお知らせください。" style="font-size: 13px;"></textarea>
          </div>
        </div>
      </div>

      <!-- 配送デフォルト設定 -->
      <div class="tab-pane fade" id="shipping" role="tabpanel">
        <div class="section-title">配送デフォルト設定</div>

        <div class="mb-3">
          <label class="form-label">配送料の負担</label>
          <select class="form-select" id="配送料の負担">
            <option value="">--</option>
            <option value="送料込み(出品者負担)">送料込み(出品者負担)</option>
            <option value="着払い(購入者負担)">着払い(購入者負担)</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">配送の方法</label>
          <select class="form-select" id="配送の方法">
            <option value="">--</option>
            <option value="未定">未定</option>
            <option value="らくらくメルカリ便">らくらくメルカリ便</option>
            <option value="ゆうゆうメルカリ便">ゆうゆうメルカリ便</option>
            <option value="ゆうメール">ゆうメール</option>
            <option value="レターパック">レターパック</option>
            <option value="普通郵便(定形、定形外)">普通郵便(定形、定形外)</option>
            <option value="クロネコヤマト">クロネコヤマト</option>
            <option value="ゆうパック">ゆうパック</option>
            <option value="クリックポスト">クリックポスト</option>
            <option value="ゆうパケット">ゆうパケット</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">発送元の地域</label>
          <select class="form-select" id="発送元の地域">
            <option value="">--</option>
            <option value="北海道">北海道</option>
            <option value="青森県">青森県</option>
            <option value="岩手県">岩手県</option>
            <option value="宮城県">宮城県</option>
            <option value="秋田県">秋田県</option>
            <option value="山形県">山形県</option>
            <option value="福島県">福島県</option>
            <option value="茨城県">茨城県</option>
            <option value="栃木県">栃木県</option>
            <option value="群馬県">群馬県</option>
            <option value="埼玉県">埼玉県</option>
            <option value="千葉県">千葉県</option>
            <option value="東京都">東京都</option>
            <option value="神奈川県">神奈川県</option>
            <option value="新潟県">新潟県</option>
            <option value="富山県">富山県</option>
            <option value="石川県">石川県</option>
            <option value="福井県">福井県</option>
            <option value="山梨県">山梨県</option>
            <option value="長野県">長野県</option>
            <option value="岐阜県">岐阜県</option>
            <option value="静岡県">静岡県</option>
            <option value="愛知県">愛知県</option>
            <option value="三重県">三重県</option>
            <option value="滋賀県">滋賀県</option>
            <option value="京都府">京都府</option>
            <option value="大阪府">大阪府</option>
            <option value="兵庫県">兵庫県</option>
            <option value="奈良県">奈良県</option>
            <option value="和歌山県">和歌山県</option>
            <option value="鳥取県">鳥取県</option>
            <option value="島根県">島根県</option>
            <option value="岡山県">岡山県</option>
            <option value="広島県">広島県</option>
            <option value="山口県">山口県</option>
            <option value="徳島県">徳島県</option>
            <option value="香川県">香川県</option>
            <option value="愛媛県">愛媛県</option>
            <option value="高知県">高知県</option>
            <option value="福岡県">福岡県</option>
            <option value="佐賀県">佐賀県</option>
            <option value="長崎県">長崎県</option>
            <option value="熊本県">熊本県</option>
            <option value="大分県">大分県</option>
            <option value="宮崎県">宮崎県</option>
            <option value="鹿児島県">鹿児島県</option>
            <option value="沖縄県">沖縄県</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">発送までの日数</label>
          <select class="form-select" id="発送までの日数">
            <option value="">--</option>
            <option value="1~2日で発送">1~2日で発送</option>
            <option value="2~3日で発送">2~3日で発送</option>
            <option value="4~7日で発送">4~7日で発送</option>
          </select>
        </div>
      </div>

      <!-- 管理番号設定 -->
      <div class="tab-pane fade" id="management" role="tabpanel">
        <div class="section-title">管理番号設定</div>

        <div class="alert alert-info">
          管理番号のフォーマットを柔軟に設定できます。<br>
          例: 「AA-0001」「A_001」「RACK-A-0001」「0001」（棚番号なし）
        </div>

        <!-- 棚番号の使用 -->
        <div class="mb-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="管理番号_棚番号使用" checked>
            <label class="form-check-label" for="管理番号_棚番号使用">
              <strong>棚番号を使用する</strong>
            </label>
          </div>
        </div>

        <!-- 棚番号設定（棚番号使用時のみ表示） -->
        <div id="shelfNumberSection">
          <div class="mb-3">
            <label class="form-label">棚番号の形式</label>
            <select class="form-select" id="管理番号_棚番号形式">
              <option value="A">アルファベット1文字 (A-Z)</option>
              <option value="AA">アルファベット2文字 (AA-ZZ)</option>
              <option value="01">数字2桁 (01-99)</option>
              <option value="001">数字3桁 (001-999)</option>
              <option value="custom">自由入力</option>
            </select>
          </div>

          <!-- 自由入力の場合のサンプル値 -->
          <div class="mb-3" id="shelfCustomSection" style="display: none;">
            <label class="form-label">棚番号のサンプル値</label>
            <input type="text" class="form-control" id="管理番号_棚番号サンプル" placeholder="RACK-A">
          </div>

          <div class="mb-3">
            <label class="form-label">区切り文字</label>
            <select class="form-select" id="管理番号_区切り文字">
              <option value="-">- (ハイフン)</option>
              <option value="_">_ (アンダースコア)</option>
              <option value="">（区切りなし）</option>
              <option value=".">. (ドット)</option>
              <option value=" ">　(スペース)</option>
            </select>
          </div>
        </div>

        <!-- 商品番号設定 -->
        <div class="mb-3">
          <label class="form-label">商品番号桁数</label>
          <select class="form-select" id="管理番号_商品番号桁数">
            <option value="3">3桁 (例: 001)</option>
            <option value="4" selected>4桁 (例: 0001)</option>
            <option value="5">5桁 (例: 00001)</option>
            <option value="6">6桁 (例: 000001)</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">商品番号開始値</label>
          <input type="number" class="form-control" id="管理番号_商品番号開始値" placeholder="1" min="1">
          <small class="text-muted">例: 1, 100, 1001</small>
        </div>

        <!-- プレビュー -->
        <div class="mb-3">
          <label class="form-label">プレビュー</label>
          <div class="input-group">
            <span class="input-group-text" id="previewLabel">例:</span>
            <input type="text" class="form-control" id="管理番号プレビュー" readonly style="background-color: #e9ecef; font-weight: 600; font-size: 16px;">
          </div>
        </div>
      </div>

    </div>

    <!-- 保存ボタン -->
    <div class="save-btn">
      <button type="button" class="btn btn-primary w-100" onclick="saveConfig()">設定を保存</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // グローバル変数
    let currentConfig = null;
    const CONDITION_STATES = [
      '新品、未使用',
      '未使用に近い',
      '目立った傷や汚れなし',
      'やや傷や汚れあり',
      '傷や汚れあり',
      '全体的に状態が悪い'
    ];

    // 初期化
    window.onload = function() {
      loadAllConfig();
      setupManagementNumberPreview();
    };

    /**
     * 全設定を読み込み
     */
    function loadAllConfig() {
      if (google && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function(config) {
            if (config) {
              currentConfig = config;
              renderAllConfig(config);
            }
          })
          .withFailureHandler(function(error) {
            alert('設定の読み込みに失敗しました: ' + error);
          })
          .loadConfigMaster();
      }
    }

    /**
     * 全設定を画面に反映
     */
    function renderAllConfig(config) {
      renderConditionButtons(config.商品状態ボタン || []);
      renderHashtagConfig(config.ハッシュタグ || {});
      renderDiscountConfig(config.割引情報 || {});
      renderShippingDefaults(config.配送デフォルト || {});
      renderManagementConfig(config.管理番号設定 || {});
    }

    /**
     * 商品状態ボタン設定を表示
     */
    function renderConditionButtons(buttons) {
      const container = document.getElementById('conditionButtonsContainer');
      container.innerHTML = '';

      CONDITION_STATES.forEach(state => {
        const stateButtons = buttons.filter(b => b.商品の状態 === state);

        const groupDiv = document.createElement('div');
        groupDiv.className = 'condition-group';

        const titleDiv = document.createElement('div');
        titleDiv.className = 'condition-group-title';
        titleDiv.textContent = state;
        groupDiv.appendChild(titleDiv);

        const buttonsContainer = document.createElement('div');
        buttonsContainer.id = `condition-${state}`;

        stateButtons.forEach((btn, idx) => {
          buttonsContainer.appendChild(createButtonConfigItem(state, idx, btn.ボタンラベル, btn.ボタンテキスト));
        });

        groupDiv.appendChild(buttonsContainer);

        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'btn btn-sm btn-outline-primary add-btn mt-2';
        addBtn.textContent = '+ ボタン追加';
        addBtn.onclick = () => addConditionButton(state);
        groupDiv.appendChild(addBtn);

        container.appendChild(groupDiv);
      });
    }

    /**
     * ボタン設定項目を作成
     */
    function createButtonConfigItem(state, index, label, text) {
      const div = document.createElement('div');
      div.className = 'button-config-item';
      div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
          <strong style="font-size: 13px;">ボタン ${index + 1}</strong>
          <button type="button" class="btn btn-sm btn-outline-danger remove-btn" onclick="removeConditionButton('${state}', ${index})">削除</button>
        </div>
        <div class="mb-2">
          <label class="form-label">ボタンラベル</label>
          <input type="text" class="form-control" data-state="${state}" data-index="${index}" data-field="label" value="${label}">
        </div>
        <div>
          <label class="form-label">ボタンテキスト</label>
          <textarea class="form-control" rows="2" data-state="${state}" data-index="${index}" data-field="text">${text}</textarea>
        </div>
      `;
      return div;
    }

    /**
     * 商品状態ボタンを追加
     */
    function addConditionButton(state) {
      const container = document.getElementById(`condition-${state}`);
      const index = container.children.length;
      container.appendChild(createButtonConfigItem(state, index, '', ''));
    }

    /**
     * 商品状態ボタンを削除
     */
    function removeConditionButton(state, index) {
      const container = document.getElementById(`condition-${state}`);
      if (container.children.length > 1) {
        container.children[index].remove();
        // インデックスを再計算
        Array.from(container.children).forEach((child, newIndex) => {
          const inputs = child.querySelectorAll('[data-index]');
          inputs.forEach(input => input.setAttribute('data-index', newIndex));
          child.querySelector('strong').textContent = `ボタン ${newIndex + 1}`;
          child.querySelector('.remove-btn').onclick = () => removeConditionButton(state, newIndex);
        });
      } else {
        alert('最低1つのボタンは必要です');
      }
    }

    /**
     * ハッシュタグ設定を表示
     */
    function renderHashtagConfig(config) {
      document.getElementById('全商品プレフィックス').value = config.全商品プレフィックス || '#REBORN_';
      document.getElementById('全商品テキスト').value = config.全商品テキスト || '全商品';
      document.getElementById('ブランドプレフィックス').value = config.ブランドプレフィックス || '#REBORN_';
      document.getElementById('ブランドサフィックス').value = config.ブランドサフィックス || 'アイテム一覧';
      document.getElementById('カテゴリプレフィックス').value = config.カテゴリプレフィックス || '#REBORN_';
      document.getElementById('カテゴリサフィックス').value = config.カテゴリサフィックス || '一覧';
    }

    /**
     * 割引情報設定を表示
     */
    function renderDiscountConfig(config) {
      // デフォルト説明文
      const defaultDescriptions = {
        'フォロー割': '',
        'リピート割': '「リピート割希望」とコメントにてお知らせください。',
        'まとめ割': '購入したい商品が複数ある場合、コメントにてお知らせください。'
      };

      ['フォロー割', 'リピート割', 'まとめ割'].forEach(type => {
        const container = document.getElementById(`${type}Container`);
        container.innerHTML = '';
        const ranges = config[type] || [];
        ranges.forEach((range, idx) => {
          container.appendChild(createDiscountRangeItem(type, idx, range.範囲, range.割引額));
        });

        // 説明文を設定（設定値があればそれを使用、なければデフォルト値）
        const descField = document.getElementById(`${type}_説明文`);
        if (descField) {
          descField.value = config[`${type}_説明文`] || defaultDescriptions[type] || '';
        }
      });
    }

    /**
     * 割引範囲項目を作成
     */
    function createDiscountRangeItem(type, index, range, amount) {
      const div = document.createElement('div');
      div.className = 'discount-range-item';
      div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
          <strong style="font-size: 13px;">範囲 ${index + 1}</strong>
          <button type="button" class="btn btn-sm btn-outline-danger remove-btn" onclick="removeDiscountRange('${type}', ${index})">削除</button>
        </div>
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label">範囲</label>
            <input type="text" class="form-control" data-discount="${type}" data-index="${index}" data-field="range" value="${range}" placeholder="〜2,999円">
          </div>
          <div class="col-6">
            <label class="form-label">割引額</label>
            <input type="text" class="form-control" data-discount="${type}" data-index="${index}" data-field="amount" value="${amount}" placeholder="100円引">
          </div>
        </div>
      `;
      return div;
    }

    /**
     * 割引範囲を追加
     */
    function addDiscountRange(type) {
      const container = document.getElementById(`${type}Container`);
      const index = container.children.length;
      container.appendChild(createDiscountRangeItem(type, index, '', ''));
    }

    /**
     * 割引範囲を削除
     */
    function removeDiscountRange(type, index) {
      const container = document.getElementById(`${type}Container`);
      if (container.children.length > 1) {
        container.children[index].remove();
        // インデックスを再計算
        Array.from(container.children).forEach((child, newIndex) => {
          const inputs = child.querySelectorAll('[data-index]');
          inputs.forEach(input => input.setAttribute('data-index', newIndex));
          child.querySelector('strong').textContent = `範囲 ${newIndex + 1}`;
          child.querySelector('.remove-btn').onclick = () => removeDiscountRange(type, newIndex);
        });
      } else {
        alert('最低1つの範囲は必要です');
      }
    }

    /**
     * 配送デフォルト設定を表示
     */
    function renderShippingDefaults(config) {
      document.getElementById('配送料の負担').value = config.配送料の負担 || '送料込み(出品者負担)';
      document.getElementById('配送の方法').value = config.配送の方法 || 'ゆうゆうメルカリ便';
      document.getElementById('発送元の地域').value = config.発送元の地域 || '岡山県';
      document.getElementById('発送までの日数').value = config.発送までの日数 || '1~2日で発送';
    }

    /**
     * 管理番号設定を表示
     */
    function renderManagementConfig(config) {
      // 棚番号使用
      const useShelf = config.棚番号使用 !== 'false' && config.棚番号使用 !== false;
      document.getElementById('管理番号_棚番号使用').checked = useShelf;

      // 棚番号形式
      document.getElementById('管理番号_棚番号形式').value = config.棚番号形式 || 'AA';

      // 棚番号サンプル
      document.getElementById('管理番号_棚番号サンプル').value = config.棚番号サンプル || 'RACK-A';

      // 区切り文字
      document.getElementById('管理番号_区切り文字').value = config.区切り文字 || '-';

      // 商品番号桁数
      document.getElementById('管理番号_商品番号桁数').value = config.商品番号桁数 || '4';

      // 商品番号開始値
      document.getElementById('管理番号_商品番号開始値').value = config.商品番号開始値 || '1001';

      // UI更新
      toggleShelfNumberSection();
      toggleShelfCustomSection();
      updateManagementNumberPreview();
    }

    /**
     * 管理番号プレビューの設定
     */
    function setupManagementNumberPreview() {
      document.getElementById('管理番号_棚番号使用').addEventListener('change', () => {
        toggleShelfNumberSection();
        updateManagementNumberPreview();
      });
      document.getElementById('管理番号_棚番号形式').addEventListener('change', () => {
        toggleShelfCustomSection();
        updateManagementNumberPreview();
      });
      document.getElementById('管理番号_棚番号サンプル').addEventListener('input', updateManagementNumberPreview);
      document.getElementById('管理番号_区切り文字').addEventListener('input', updateManagementNumberPreview);
      document.getElementById('管理番号_商品番号桁数').addEventListener('change', updateManagementNumberPreview);
      document.getElementById('管理番号_商品番号開始値').addEventListener('input', updateManagementNumberPreview);
    }

    /**
     * 棚番号セクションの表示切替
     */
    function toggleShelfNumberSection() {
      const useShelf = document.getElementById('管理番号_棚番号使用').checked;
      document.getElementById('shelfNumberSection').style.display = useShelf ? 'block' : 'none';
    }

    /**
     * 棚番号カスタム入力の表示切替
     */
    function toggleShelfCustomSection() {
      const format = document.getElementById('管理番号_棚番号形式').value;
      document.getElementById('shelfCustomSection').style.display = format === 'custom' ? 'block' : 'none';
    }

    /**
     * 管理番号プレビューを更新
     */
    function updateManagementNumberPreview() {
      const useShelf = document.getElementById('管理番号_棚番号使用').checked;
      const format = document.getElementById('管理番号_棚番号形式').value;
      const customSample = document.getElementById('管理番号_棚番号サンプル').value;
      const separator = document.getElementById('管理番号_区切り文字').value;
      const width = parseInt(document.getElementById('管理番号_商品番号桁数').value) || 4;
      const startNum = parseInt(document.getElementById('管理番号_商品番号開始値').value) || 1;

      let shelfPart = '';
      if (useShelf) {
        // 棚番号のサンプル値を決定
        switch (format) {
          case 'AA':
            shelfPart = 'AA';
            break;
          case 'A':
            shelfPart = 'A';
            break;
          case '01':
            shelfPart = '01';
            break;
          case '001':
            shelfPart = '001';
            break;
          case 'custom':
            shelfPart = customSample || 'RACK-A';
            break;
          default:
            shelfPart = 'AA';
        }
      }

      // 商品番号部分
      const itemPart = String(startNum).padStart(width, '0');

      // 管理番号を生成
      let preview = '';
      if (useShelf && shelfPart) {
        // 区切り文字が空の場合はそのまま連結
        preview = separator ? `${shelfPart}${separator}${itemPart}` : `${shelfPart}${itemPart}`;
      } else {
        preview = itemPart;
      }

      document.getElementById('管理番号プレビュー').value = preview;
    }

    /**
     * 設定を保存
     */
    function saveConfig() {
      const newConfig = {
        商品状態ボタン: collectConditionButtons(),
        ハッシュタグ: collectHashtagConfig(),
        割引情報: collectDiscountConfig(),
        配送デフォルト: collectShippingDefaults(),
        管理番号設定: collectManagementConfig()
      };

      if (google && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              alert('設定を保存しました');
              // キャッシュをクリア
              google.script.run.clearConfigCache();
            } else {
              alert('保存に失敗しました: ' + result.error);
            }
          })
          .withFailureHandler(function(error) {
            alert('保存中にエラーが発生しました: ' + error);
          })
          .saveConfigMaster(newConfig);
      }
    }

    /**
     * 商品状態ボタン設定を収集
     */
    function collectConditionButtons() {
      const buttons = [];
      CONDITION_STATES.forEach(state => {
        const container = document.getElementById(`condition-${state}`);
        Array.from(container.children).forEach((item, index) => {
          const label = item.querySelector('[data-field="label"]').value;
          const text = item.querySelector('[data-field="text"]').value;
          if (label || text) {
            buttons.push({
              商品の状態: state,
              ボタンラベル: label,
              ボタンテキスト: text
            });
          }
        });
      });
      return buttons;
    }

    /**
     * ハッシュタグ設定を収集
     */
    function collectHashtagConfig() {
      return {
        全商品プレフィックス: document.getElementById('全商品プレフィックス').value,
        全商品テキスト: document.getElementById('全商品テキスト').value,
        ブランドプレフィックス: document.getElementById('ブランドプレフィックス').value,
        ブランドサフィックス: document.getElementById('ブランドサフィックス').value,
        カテゴリプレフィックス: document.getElementById('カテゴリプレフィックス').value,
        カテゴリサフィックス: document.getElementById('カテゴリサフィックス').value
      };
    }

    /**
     * 割引情報設定を収集
     */
    function collectDiscountConfig() {
      const config = {};
      ['フォロー割', 'リピート割', 'まとめ割'].forEach(type => {
        config[type] = [];
        const container = document.getElementById(`${type}Container`);
        Array.from(container.children).forEach(item => {
          const range = item.querySelector('[data-field="range"]').value;
          const amount = item.querySelector('[data-field="amount"]').value;
          if (range || amount) {
            config[type].push({ 範囲: range, 割引額: amount });
          }
        });

        // 説明文を収集
        const descField = document.getElementById(`${type}_説明文`);
        if (descField) {
          config[`${type}_説明文`] = descField.value;
        }
      });
      return config;
    }

    /**
     * 配送デフォルト設定を収集
     */
    function collectShippingDefaults() {
      return {
        配送料の負担: document.getElementById('配送料の負担').value,
        配送の方法: document.getElementById('配送の方法').value,
        発送元の地域: document.getElementById('発送元の地域').value,
        発送までの日数: document.getElementById('発送までの日数').value
      };
    }

    /**
     * 管理番号設定を収集
     */
    function collectManagementConfig() {
      return {
        棚番号使用: document.getElementById('管理番号_棚番号使用').checked ? 'true' : 'false',
        棚番号形式: document.getElementById('管理番号_棚番号形式').value,
        棚番号サンプル: document.getElementById('管理番号_棚番号サンプル').value,
        区切り文字: document.getElementById('管理番号_区切り文字').value,
        商品番号桁数: document.getElementById('管理番号_商品番号桁数').value,
        商品番号開始値: document.getElementById('管理番号_商品番号開始値').value
      };
    }
  </script>
</body>
</html>
