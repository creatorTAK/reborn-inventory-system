<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>設定管理</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f8f9fa;
    }
    .config-container {
      padding: 16px;
    }
    .nav-tabs {
      margin-bottom: 0;
      flex-wrap: nowrap;
      overflow-x: auto;
      border-bottom: none;
      background: #f8f9fa;
      padding: 8px 8px 0 8px;
      border-radius: 8px 8px 0 0;
    }
    .nav-tabs .nav-link {
      font-size: 13px;
      padding: 10px 16px;
      white-space: nowrap;
      border: 1px solid transparent;
      border-radius: 6px 6px 0 0;
      color: #6c757d;
      background: transparent;
      margin-right: 4px;
      transition: all 0.2s;
    }
    .nav-tabs .nav-link:hover {
      background: #e9ecef;
      color: #495057;
    }
    .nav-tabs .nav-link.active {
      color: #212529;
      background: white;
      border-color: #dee2e6 #dee2e6 white;
      font-weight: 600;
    }
    .tab-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #212529;
    }
    .form-label {
      font-weight: 500;
      font-size: 13px;
      color: #495057;
      margin-bottom: 4px;
    }
    .form-control, .form-select {
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #ced4da;
    }
    .form-control:focus, .form-select:focus {
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    .btn-group-sm .btn {
      font-size: 12px;
      padding: 4px 8px;
    }
    .save-btn {
      position: sticky;
      bottom: 0;
      background: white;
      padding: 12px 16px;
      border-top: 1px solid #dee2e6;
      margin: -16px -16px 0 -16px;
      z-index: 10;
    }
    .button-config-item {
      background: #f8f9fa;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 6px;
      border: 1px solid #e9ecef;
    }
    .button-config-item .form-label {
      margin-bottom: 6px;
    }
    .add-btn {
      background: white;
      color: #3b82f6;
      border: 2px dashed #3b82f6;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .add-btn:hover {
      background: #eff6ff;
    }
    .remove-btn {
      font-size: 12px;
      padding: 2px 8px;
    }
    .discount-group {
      background: white;
      padding: 12px;
      margin-bottom: 16px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .discount-range-item {
      background: #f9fafb;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 4px;
      border: 1px solid #dee2e6;
    }
    .alert {
      font-size: 13px;
      padding: 10px 14px;
      margin-bottom: 16px;
    }
    .input-group-text {
      font-size: 13px;
    }
    .condition-group {
      margin-bottom: 24px;
    }
    .condition-group-title {
      font-size: 14px;
      font-weight: 600;
      color: #495057;
      margin-bottom: 12px;
      padding: 8px 12px;
      background: #e9ecef;
      border-radius: 6px;
    }

  </style>
</head>
<body>
  <div class="config-container">
    <!-- タブナビゲーション -->
    <ul class="nav nav-tabs" id="configTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="management-tab" data-bs-toggle="tab" data-bs-target="#management" type="button" role="tab">🔢 管理番号設定</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="salesword-tab" data-bs-toggle="tab" data-bs-target="#salesword" type="button" role="tab">💬 セールスワード</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="condition-tab" data-bs-toggle="tab" data-bs-target="#condition" type="button" role="tab">🔘 商品状態ボタン</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="discount-tab" data-bs-toggle="tab" data-bs-target="#discount" type="button" role="tab">💰 割引情報</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="hashtag-tab" data-bs-toggle="tab" data-bs-target="#hashtag" type="button" role="tab">🏷️ ハッシュタグ</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="shipping-tab" data-bs-toggle="tab" data-bs-target="#shipping" type="button" role="tab">📦 配送デフォルト</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="procure-listing-tab" data-bs-toggle="tab" data-bs-target="#procure-listing" type="button" role="tab">💼 仕入・出品デフォルト</button>
      </li>
    </ul>

    <!-- タブコンテンツ -->
    <div class="tab-content" id="configTabContent">

      <!-- 商品状態ボタン設定 -->
      <div class="tab-pane fade" id="condition" role="tabpanel">
        <div class="section-title">🔘 商品状態ボタン設定</div>

        <!-- ヒント -->
        <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
          <div style="margin-bottom: 8px;">💡 商品登録時に「商品状態(詳細)」欄へワンクリックで説明文を挿入できるボタンを設定できます</div>
          <div style="color: #3b82f6; font-weight: 600; margin-bottom: 4px;">📌 使い方:</div>
          <div style="padding-left: 12px;">
            1. 🔘 各商品の状態カテゴリごとに表示される編集画面で設定<br>
            2. ➕ 「+ ボタンを追加」をクリックしてボタンを追加<br>
            3. 🏷️ ボタンラベル（ボタンに表示される名前）とボタンテキスト（挿入される説明文）を入力<br>
            4. 「削除」ボタンで不要なボタンを削除
          </div>
        </div>

        <div id="conditionButtonsContainer">
          <!-- 動的に生成 -->
        </div>
      </div>

      <!-- ハッシュタグ設定 -->
      <div class="tab-pane fade" id="hashtag" role="tabpanel">
        <div class="section-title">🏷️ ハッシュタグ設定</div>

        <!-- ヒント -->
        <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
          <div style="margin-bottom: 8px;">💡 ハッシュタグは商品説明の最後に自動で追加されます（例: #REBORN_全商品）</div>
          <div style="color: #3b82f6; font-weight: 600; margin-bottom: 4px;">📌 使い方:</div>
          <div style="padding-left: 12px;">
            1. ⚙️ 「共通設定」でショップ名を入力（例: REBORN_）<br>
            2. ➕ 「+ ハッシュタグを追加」からタイプを選択（全商品、ブランド、カテゴリなど）<br>
            3. ⋮⋮ 左側の6つボタンをドラッグして順番を並び替え<br>
            4. 「削除」ボタンまたは「🗑️ すべてクリア」で削除
          </div>
        </div>

        <!-- 共通プレフィックス設定 -->
        <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
          <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
            <span style="font-size: 16px;">⚙️</span>
            <label style="font-size: 13px; font-weight: 600; color: #374151;">
              共通設定
            </label>
          </div>
          <div style="display: flex; align-items: stretch;">
            <span style="width: 32px; padding: 8px 0; border: 2px solid #d1d5db; border-right: none; border-radius: 6px 0 0 6px; background: #f9fafb; font-size: 14px; font-weight: 500; color: #374151; display: flex; align-items: center; justify-content: center;">#</span>
            <input type="text" id="commonHashtagPrefix" placeholder="ショップ名_" style="width: calc(100% - 32px); padding: 8px 10px; border: 2px solid #d1d5db; border-radius: 0 6px 6px 0; font-size: 13px; transition: all 0.2s; box-sizing: border-box;" onfocus="this.style.borderColor='#3b82f6';" onblur="this.style.borderColor='#d1d5db';" oninput="updateAllHashtagPreviews()">
          </div>
          <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">
            💡 ショップ名やアカウント名を入力してください（例: Shop〇〇_）
          </div>
        </div>

        <!-- 動的に生成されるハッシュタグ項目 -->
        <div id="hashtagItemsContainer"></div>

        <!-- 追加ボタン -->
        <button type="button" onclick="showHashtagTypeSelector()" style="width: 100%; padding: 10px; background: white; border: 2px dashed #3b82f6; border-radius: 8px; color: #3b82f6; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 8px; transition: all 0.2s;" onmouseover="this.style.background='#eff6ff';" onmouseout="this.style.background='white';">
          + ハッシュタグを追加
        </button>

        <!-- クリアボタン -->
        <button type="button" onclick="clearAllHashtags()" style="width: 100%; padding: 10px; background: white; border: 2px solid #ef4444; border-radius: 8px; color: #ef4444; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 16px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
          🗑️ すべてクリア
        </button>

        <!-- ハッシュタグタイプ選択メニュー -->
        <div id="hashtagTypeSelectorMenu" style="display: none; margin-bottom: 16px; padding: 12px; background: white; border: 2px solid #3b82f6; border-radius: 8px;">
          <div style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">追加するハッシュタグのタイプを選択:</div>
          <div style="display: flex; flex-direction: column; gap: 6px;">
            <button type="button" onclick="addHashtagItemByType('全商品')" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; transition: all 0.2s; text-align: left;" onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#3b82f6';" onmouseout="this.style.background='white'; this.style.borderColor='#d1d5db';">
              <span style="font-size: 18px;">🌐</span>
              <span style="font-size: 13px; font-weight: 500; color: #374151;">全商品</span>
            </button>
            <button type="button" onclick="addHashtagItemByType('ブランド')" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; transition: all 0.2s; text-align: left;" onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#3b82f6';" onmouseout="this.style.background='white'; this.style.borderColor='#d1d5db';">
              <span style="font-size: 18px;">👔</span>
              <span style="font-size: 13px; font-weight: 500; color: #374151;">ブランド</span>
            </button>
            <button type="button" onclick="addHashtagItemByType('カテゴリ')" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; transition: all 0.2s; text-align: left;" onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#3b82f6';" onmouseout="this.style.background='white'; this.style.borderColor='#d1d5db';">
              <span style="font-size: 18px;">📁</span>
              <span style="font-size: 13px; font-weight: 500; color: #374151;">カテゴリ</span>
            </button>
            <button type="button" onclick="addHashtagItemByType('カラー')" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; transition: all 0.2s; text-align: left;" onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#3b82f6';" onmouseout="this.style.background='white'; this.style.borderColor='#d1d5db';">
              <span style="font-size: 18px;">🎨</span>
              <span style="font-size: 13px; font-weight: 500; color: #374151;">カラー</span>
            </button>
            <button type="button" onclick="addHashtagItemByType('サイズ')" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; transition: all 0.2s; text-align: left;" onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#3b82f6';" onmouseout="this.style.background='white'; this.style.borderColor='#d1d5db';">
              <span style="font-size: 18px;">📏</span>
              <span style="font-size: 13px; font-weight: 500; color: #374151;">サイズ</span>
            </button>
            <button type="button" onclick="hideHashtagTypeSelector()" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 12px; color: #6b7280; margin-top: 4px;" onmouseover="this.style.background='#e5e7eb';" onmouseout="this.style.background='#f3f4f6';">
              キャンセル
            </button>
          </div>
        </div>
      </div>

      <!-- 割引情報設定 -->
      <div class="tab-pane fade" id="discount" role="tabpanel">
        <div class="section-title">💰 割引設定</div>

        <!-- ヒント -->
        <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
          <div style="margin-bottom: 8px;">💡 設定した割引情報が商品説明に自動で追加されます（フォロー割、リピート割、まとめ割）</div>
          <div style="color: #3b82f6; font-weight: 600; margin-bottom: 4px;">📌 使い方:</div>
          <div style="padding-left: 12px;">
            1. 💰 各割引タイプ（フォロー割・リピート割・まとめ割）の割引額や範囲を設定<br>
            2. ➕ 「+ 範囲を追加」ボタンで複数の価格帯に対応（フォロー割・まとめ割）<br>
            3. 📝 説明文テキストエリアで購入者向けのメッセージを自由に編集<br>
            4. 🗑️ すべての割引を削除すると、商品説明から割引情報セクション全体が非表示になります
          </div>
        </div>

        <!-- タイトル設定 -->
        <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
          <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px; display: block;">
            📌 タイトル
          </label>
          <select id="割引情報タイトル選択" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 13px; background: white; cursor: pointer; transition: all 0.2s; margin-bottom: 8px;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';" onchange="handleDiscountTitleChange()">
            <option value="【お得な割引情報】">【お得な割引情報】</option>
            <option value="【割引について】">【割引について】</option>
            <option value="【お値引き情報】">【お値引き情報】</option>
            <option value="【特別割引】">【特別割引】</option>
            <option value="【キャンペーン情報】">【キャンペーン情報】</option>
            <option value="">（タイトルなし）</option>
            <option value="custom">✏️ カスタム入力</option>
          </select>
          <input type="text" id="割引情報タイトルカスタム" placeholder="カスタムタイトルを入力" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 13px; display: none; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6';" onblur="this.style.borderColor='#d1d5db';" oninput="updateDiscountPreview()">
        </div>

        <!-- 割引タイプリスト（動的に生成） -->
        <div id="discountTypesList">
          <!-- 動的に生成される -->
        </div>

        <!-- 割引追加ボタン -->
        <button type="button" onclick="addDiscountType()" style="width: 100%; margin-bottom: 16px; background: white; color: #10b981; border: 2px solid #10b981; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#f0fdf4';" onmouseout="this.style.background='white';">+ 割引を追加</button>

        <!-- すべてクリアボタン -->
        <div style="text-align: center; margin-bottom: 16px;">
          <button type="button" onclick="clearAllDiscounts()" style="width: 100%; padding: 8px 16px; background: white; color: #ef4444; border: 2px solid #ef4444; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
            🗑️ すべてクリア
          </button>
        </div>

        <!-- プレビュー -->
        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px;">
          <div style="font-size: 11px; color: #6b7280; margin-bottom: 8px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">プレビュー</div>
          <div id="discountPreview" style="padding: 6px 10px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 11px; color: #1e40af; font-weight: 500; white-space: pre-line; line-height: 1.6;">
            プレビューを生成中...
          </div>
        </div>
      </div>

      <!-- 配送デフォルト設定 -->
      <div class="tab-pane fade" id="shipping" role="tabpanel">
        <div class="section-title">📦 配送デフォルト設定</div>

        <!-- ヒント -->
        <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
          <div style="margin-bottom: 8px;">💡 ここで設定したデフォルト値が商品登録時に自動で適用されます（配送料の負担、配送の方法、発送元の地域、発送までの日数）</div>
          <div style="color: #3b82f6; font-weight: 600; margin-bottom: 4px;">📌 使い方:</div>
          <div style="padding-left: 12px;">
            1. 💰 配送料の負担を選択（送料込み/着払い）<br>
            2. 📦 配送の方法を選択（ゆうゆうメルカリ便、らくらくメルカリ便など）<br>
            3. 🏠 発送元の地域を選択（都道府県）<br>
            4. ⏱️ 発送までの日数を選択（1~2日、2~3日など）
          </div>
        </div>

        <!-- 配送料の負担 -->
        <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
          <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px; display: block;">
            💰 配送料の負担
          </label>
          <select id="配送料の負担" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 13px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
            <option value="">-- 選択してください --</option>
            <option value="送料込み(出品者負担)">送料込み(出品者負担)</option>
            <option value="着払い(購入者負担)">着払い(購入者負担)</option>
          </select>
        </div>

        <!-- 配送の方法 -->
        <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
          <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px; display: block;">
            📮 配送の方法
          </label>
          <select id="配送の方法" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 13px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
            <option value="">-- 選択してください --</option>
            <option value="未定">未定</option>
            <option value="らくらくメルカリ便">らくらくメルカリ便</option>
            <option value="ゆうゆうメルカリ便">ゆうゆうメルカリ便</option>
            <option value="ゆうメール">ゆうメール</option>
            <option value="レターパック">レターパック</option>
            <option value="普通郵便(定形、定形外)">普通郵便(定形、定形外)</option>
            <option value="クロネコヤマト">クロネコヤマト</option>
            <option value="ゆうパック">ゆうパック</option>
            <option value="クリックポスト">クリックポスト</option>
            <option value="ゆうパケット">ゆうパケット</option>
          </select>
        </div>

        <!-- 発送元の地域 -->
        <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
          <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px; display: block;">
            📍 発送元の地域
          </label>
          <select id="発送元の地域" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 13px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
            <option value="">-- 選択してください --</option>
            <option value="北海道">北海道</option>
            <option value="青森県">青森県</option>
            <option value="岩手県">岩手県</option>
            <option value="宮城県">宮城県</option>
            <option value="秋田県">秋田県</option>
            <option value="山形県">山形県</option>
            <option value="福島県">福島県</option>
            <option value="茨城県">茨城県</option>
            <option value="栃木県">栃木県</option>
            <option value="群馬県">群馬県</option>
            <option value="埼玉県">埼玉県</option>
            <option value="千葉県">千葉県</option>
            <option value="東京都">東京都</option>
            <option value="神奈川県">神奈川県</option>
            <option value="新潟県">新潟県</option>
            <option value="富山県">富山県</option>
            <option value="石川県">石川県</option>
            <option value="福井県">福井県</option>
            <option value="山梨県">山梨県</option>
            <option value="長野県">長野県</option>
            <option value="岐阜県">岐阜県</option>
            <option value="静岡県">静岡県</option>
            <option value="愛知県">愛知県</option>
            <option value="三重県">三重県</option>
            <option value="滋賀県">滋賀県</option>
            <option value="京都府">京都府</option>
            <option value="大阪府">大阪府</option>
            <option value="兵庫県">兵庫県</option>
            <option value="奈良県">奈良県</option>
            <option value="和歌山県">和歌山県</option>
            <option value="鳥取県">鳥取県</option>
            <option value="島根県">島根県</option>
            <option value="岡山県">岡山県</option>
            <option value="広島県">広島県</option>
            <option value="山口県">山口県</option>
            <option value="徳島県">徳島県</option>
            <option value="香川県">香川県</option>
            <option value="愛媛県">愛媛県</option>
            <option value="高知県">高知県</option>
            <option value="福岡県">福岡県</option>
            <option value="佐賀県">佐賀県</option>
            <option value="長崎県">長崎県</option>
            <option value="熊本県">熊本県</option>
            <option value="大分県">大分県</option>
            <option value="宮崎県">宮崎県</option>
            <option value="鹿児島県">鹿児島県</option>
            <option value="沖縄県">沖縄県</option>
          </select>
        </div>

        <!-- 発送までの日数 -->
        <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
          <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px; display: block;">
            ⏱️ 発送までの日数
          </label>
          <select id="発送までの日数" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 13px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
            <option value="">-- 選択してください --</option>
            <option value="1~2日で発送">1~2日で発送</option>
            <option value="2~3日で発送">2~3日で発送</option>
            <option value="4~7日で発送">4~7日で発送</option>
          </select>
        </div>

        <!-- すべてクリアボタン -->
        <button type="button" onclick="clearShippingDefaults()" style="width: 100%; padding: 10px; background: white; border: 2px solid #ef4444; border-radius: 8px; color: #ef4444; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 16px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
          🗑️ すべてクリア
        </button>
      </div>

      <!-- 仕入・出品デフォルト設定 -->
      <div class="tab-pane fade" id="procure-listing" role="tabpanel">
        <div class="section-title">💼 仕入・出品デフォルト設定</div>

        <!-- ヒント -->
        <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
          <div style="margin-bottom: 8px;">💡 ここで設定したデフォルト値が商品登録時に自動で適用されます（仕入日・仕入先、出品日・出品先）</div>
          <div style="color: #3b82f6; font-weight: 600; margin-bottom: 4px;">📌 使い方:</div>
          <div style="padding-left: 12px;">
            1. 📅 仕入日・出品日：「✓ 常に今日の日付を使用」をチェック → 毎日自動更新<br>
            2. 📅 仕入日・出品日：チェックを外す → 固定日付を設定（一括仕入れに便利）<br>
            3. 🏪 仕入先・出品先：プルダウンから選択（メルカリ、リサイクルショップなど）<br>
            4. 🗑️ 「すべてクリア」ボタンでリセット
          </div>
        </div>

        <!-- 仕入情報セクション -->
        <div style="margin-bottom: 24px; padding: 16px; background: #fefce8; border-radius: 8px; border: 2px solid #fef08a;">
          <div style="font-size: 14px; font-weight: 600; color: #854d0e; margin-bottom: 16px;">
            💰 仕入情報
          </div>

          <!-- デフォルト仕入日 -->
          <div style="margin-bottom: 16px;">
            <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">
              📅 デフォルトの仕入日
            </label>
            <!-- 常に今日チェックボックス -->
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 8px;">
              <input type="checkbox" id="仕入日_今日" onchange="toggleProcureDateField()" style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px; font-weight: 500; color: #374151;">
                常に今日の日付を使用
              </span>
            </label>
            <!-- 日付入力フィールド -->
            <input type="date" id="デフォルト仕入日" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 13px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
              空欄の場合は自動入力されません。まとめて仕入れた日付を設定すると便利です
            </div>
          </div>

          <!-- 仕入先 -->
          <div style="margin-bottom: 12px;">
            <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">
              🏪 デフォルトの仕入先
            </label>
            <select id="デフォルト仕入先" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 13px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
              <option value="">-- 選択してください --</option>
            </select>
            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
              よく使う仕入先を選択（空欄も可）
            </div>
          </div>
        </div>

        <!-- 出品情報セクション -->
        <div style="margin-bottom: 16px; padding: 16px; background: #eff6ff; border-radius: 8px; border: 2px solid #bfdbfe;">
          <div style="font-size: 14px; font-weight: 600; color: #1e40af; margin-bottom: 16px;">
            📤 出品情報
          </div>

          <!-- デフォルト出品日 -->
          <div style="margin-bottom: 16px;">
            <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">
              📅 デフォルトの出品日 ★推奨
            </label>
            <!-- 常に今日チェックボックス -->
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 8px;">
              <input type="checkbox" id="出品日_今日" onchange="toggleListingDateField()" style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px; font-weight: 500; color: #374151;">
                常に今日の日付を使用
              </span>
            </label>
            <!-- 日付入力フィールド -->
            <input type="date" id="デフォルト出品日" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 13px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
              「常に今日」をチェックすると毎日自動で今日の日付が入ります。固定日付にする場合はチェックを外してください
            </div>
          </div>

          <!-- 出品先 -->
          <div style="margin-bottom: 12px;">
            <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">
              🛒 デフォルトの出品先
            </label>
            <select id="デフォルト出品先" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 13px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
              <option value="">-- 選択してください --</option>
            </select>
            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
              よく使う出品先を選択（空欄も可）
            </div>
          </div>
        </div>

        <!-- すべてクリアボタン -->
        <button type="button" onclick="clearProcureListingDefaults()" style="width: 100%; padding: 10px; background: white; border: 2px solid #ef4444; border-radius: 8px; color: #ef4444; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 16px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
          🗑️ すべてクリア
        </button>
      </div>

      <!-- 管理番号設定 -->
      <div class="tab-pane fade show active" id="management" role="tabpanel">
        <!-- 動的ブロックビルダー -->
        <?!= include('management_number_builder'); ?>
      </div>

      <!-- よく使うセールスワード -->
      <div class="tab-pane fade" id="salesword" role="tabpanel">
        <div class="section-title">💬 よく使うセールスワード設定</div>

        <!-- ヒント -->
        <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
          <div style="margin-bottom: 8px;">💡 商品登録時に「よく使う」カテゴリから素早く選択できます</div>
          <div style="color: #3b82f6; font-weight: 600; margin-bottom: 4px;">📌 使い方:</div>
          <div style="padding-left: 12px;">
            1. 📁 カテゴリプルダウンからカテゴリを選択<br>
            2. 💬 セールスワードプルダウンから追加したいワードを選択<br>
            3. ➕ 「+ 追加」ボタンをクリックして登録（重複チェック付き）<br>
            4. 「削除」ボタンで不要なワードを削除
          </div>
        </div>

        <!-- 登録済みセールスワードリスト -->
        <div id="saleswordList" style="margin-bottom: 16px;">
          <!-- 動的に生成される登録済みセールスワード -->
        </div>

        <!-- 2段式プルダウン -->
        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
          <div style="font-weight: 600; margin-bottom: 12px; font-size: 14px;">➕ セールスワードを追加</div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
            <div>
              <label style="font-size: 11px; margin-bottom: 4px; display: block; color: #6b7280;">カテゴリ</label>
              <select id="saleswordCategorySelect" class="form-select form-select-sm" onchange="updateSaleswordOptions()">
                <option value="">--選択--</option>
              </select>
            </div>
            <div>
              <label style="font-size: 11px; margin-bottom: 4px; display: block; color: #6b7280;">セールスワード</label>
              <select id="saleswordSelect" class="form-select form-select-sm" disabled>
                <option value="">--選択--</option>
              </select>
            </div>
          </div>

          <button type="button" onclick="addSaleswordFromDropdown()" style="width: 100%; padding: 8px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#2563eb';" onmouseout="this.style.background='#3b82f6';">
            + 追加
          </button>
        </div>

        <!-- セールスワード表示形式設定 -->
        <div style="margin-top: 32px; padding-top: 24px; border-top: 2px solid #e9ecef;">
          <div class="section-title">🎨 セールスワード表示形式</div>
          <div style="font-size: 13px; color: #6c757d; margin-bottom: 16px;">
            セールスワードの前後に付ける文字をカスタマイズできます。<br>
            例：【美品】、『匿名配送』、送料無料★など
          </div>

          <!-- グローバル設定 -->
          <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <div style="font-weight: 600; margin-bottom: 12px; font-size: 14px;">📌 すべてのワードに適用</div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
              <div>
                <label style="font-size: 11px; margin-bottom: 4px; display: block;">前に付ける文字</label>
                <select id="saleswordPrefixGlobalSelect" class="form-select form-select-sm" onchange="handlePrefixChange()">
                  <option value="">なし</option>
                  <option value="【">【</option>
                  <option value="『">『</option>
                  <option value="「">「</option>
                  <option value="(">（</option>
                  <option value="★">★</option>
                  <option value="☆">☆</option>
                  <option value="◆">◆</option>
                  <option value="●">●</option>
                  <option value="■">■</option>
                  <option value="♡">♡</option>
                  <option value="✨">✨</option>
                  <option value="※">※</option>
                  <option value="custom">カスタム入力</option>
                </select>
                <input type="text" id="saleswordPrefixGlobalCustom" class="form-control form-control-sm" placeholder="自由に入力" maxlength="5" style="margin-top: 4px; display: none;" oninput="updateSaleswordFormatPreview()">
              </div>
              <div>
                <label style="font-size: 11px; margin-bottom: 4px; display: block;">後ろに付ける文字</label>
                <select id="saleswordSuffixGlobalSelect" class="form-select form-select-sm" onchange="handleSuffixChange()">
                  <option value="">なし</option>
                  <option value="】">】</option>
                  <option value="』">』</option>
                  <option value="」">」</option>
                  <option value=")">）</option>
                  <option value="!">！</option>
                  <option value="★">★</option>
                  <option value="☆">☆</option>
                  <option value="◆">◆</option>
                  <option value="●">●</option>
                  <option value="■">■</option>
                  <option value="♡">♡</option>
                  <option value="✨">✨</option>
                  <option value="※">※</option>
                  <option value="custom">カスタム入力</option>
                </select>
                <input type="text" id="saleswordSuffixGlobalCustom" class="form-control form-control-sm" placeholder="自由に入力" maxlength="5" style="margin-top: 4px; display: none;" oninput="updateSaleswordFormatPreview()">
              </div>
            </div>

            <!-- プレビュー -->
            <div style="background: white; padding: 8px 12px; border-radius: 4px; border: 1px solid #dee2e6;">
              <div style="font-size: 11px; color: #6c757d; margin-bottom: 4px;">プレビュー:</div>
              <div id="saleswordFormatPreview" style="font-size: 14px; color: #212529; font-weight: 500;">【美品】</div>
            </div>
          </div>

          <!-- ワードごとに個別設定 -->
          <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #dee2e6;">
            <div style="font-weight: 600; margin-bottom: 12px; font-size: 14px;">
              🏷️ ワードごとに個別設定
            </div>

            <div style="font-size: 12px; color: #6c757d; margin-bottom: 12px;">
              特定のセールスワードだけ異なる形式を使いたい場合に設定します。<br>
              例：「匿名配送」だけ★で囲む、「送料無料」だけ『』で囲むなど
            </div>

            <div id="wordOverrideList" style="margin-bottom: 12px;">
              <!-- 動的に生成されるワード別設定 -->
            </div>

            <button type="button" onclick="addWordOverride()" style="width: 100%; padding: 10px; background: white; border: 2px dashed #3b82f6; border-radius: 8px; color: #3b82f6; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 8px; transition: all 0.2s;" onmouseover="this.style.background='#eff6ff';" onmouseout="this.style.background='white';">
              + ワード別設定を追加
            </button>

            <button type="button" onclick="clearAllSaleswordSettings()" style="width: 100%; padding: 10px; background: white; border: 2px solid #ef4444; border-radius: 8px; color: #ef4444; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 16px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
              🗑️ すべてクリア
            </button>
          </div>
        </div>
      </div>


    </div>

    <!-- 保存ボタン -->
    <div class="save-btn" style="display: flex; justify-content: center;">
      <button type="button" onclick="saveConfig()" style="background: #10b981; color: white; border: none; padding: 12px 48px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
        ✓ 設定を保存
      </button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // セールスワードマスタデータを読み込み
      loadSaleswordMasterData();

      // 仕入・出品のプルダウンを初期化
      initProcureListingDropdowns();
    });

    // グローバル変数
    let currentConfig = null;
    const CONDITION_STATES = [
      '新品、未使用',
      '未使用に近い',
      '目立った傷や汚れなし',
      'やや傷や汚れあり',
      '傷や汚れあり',
      '全体的に状態が悪い'
    ];

    // 商品状態ボタンのプリセット
    const CONDITION_BUTTON_PRESETS = {
      '新品、未使用': [
        { label: 'タグ付き未使用', text: 'タグ付き未使用品です。' },
        { label: '新品未開封', text: '新品未開封です。' },
        { label: '試着のみ', text: '試着のみの未使用品です。' }
      ],
      '未使用に近い': [
        { label: '数回着用', text: '数回のみ着用の美品です。' },
        { label: 'ほぼ未使用', text: 'ほぼ未使用に近い状態です。' },
        { label: '室内試着のみ', text: '室内で試着したのみです。' }
      ],
      '目立った傷や汚れなし': [
        { label: '美品', text: 'ほとんど使用感がなく、とても綺麗な状態です。' },
        { label: '保管時のシワ', text: '保管時の小さなシワがありますが、着用には問題ありません。' },
        { label: '着用感少ない', text: '着用感が少なく、まだまだご使用いただけます。' }
      ],
      'やや傷や汚れあり': [
        { label: '使用感あり', text: '若干の使用感がありますが、着用に問題ありません。' },
        { label: '小さな汚れ', text: '目立たない程度の小さな汚れがあります。' },
        { label: '毛玉あり', text: '若干の毛玉がございますが、まだまだご使用いただけます。' },
        { label: '色褪せあり', text: '若干の色褪せがありますが、着用には問題ありません。' }
      ],
      '傷や汚れあり': [
        { label: '使用感強い', text: '使用感が強めですが、まだご使用いただけます。' },
        { label: '汚れあり', text: '汚れがございます。写真でご確認ください。' },
        { label: '傷あり', text: '傷がございます。写真でご確認ください。' }
      ],
      '全体的に状態が悪い': [
        { label: '全体的に傷あり', text: '全体的に傷や汚れがあります。ご了承の上ご購入ください。' },
        { label: '目立つ汚れ', text: '目立つ汚れがあります。写真をよくご確認ください。' }
      ]
    };

    // 初期化
    window.onload = function() {
      loadAllConfig();
    };

    /**
     * 全設定を読み込み
     */
    function loadAllConfig() {
      if (google && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function(config) {
            if (config) {
              currentConfig = config;
              renderAllConfig(config);
            }
          })
          .withFailureHandler(function(error) {
            alert('設定の読み込みに失敗しました: ' + error);
          })
          .loadConfigMaster();
      }
    }

    /**
     * 全設定を画面に反映
     */
    function renderAllConfig(config) {
      renderConditionButtons(config.商品状態ボタン || []);
      renderHashtagConfig(config.ハッシュタグ || {});
      renderDiscountConfig(config.割引情報 || {});
      renderShippingDefaults(config.配送デフォルト || {});
      renderProcureListingDefaults(config.仕入出品デフォルト || {});
      renderManagementConfig(config.管理番号設定 || {});

      // セールスワード設定を読み込み
      if (config.よく使うセールスワード) {
        // 新しい構造（よく使う + 表示形式）に対応
        if (typeof config.よく使うセールスワード === 'object' && config.よく使うセールスワード.よく使う) {
          SALESWORD_LIST = config.よく使うセールスワード.よく使う || [];
          renderSaleswordList();
          renderSaleswordFormat(config.よく使うセールスワード.表示形式 || {});
        } else {
          // 旧形式（配列のみ）に対応
          SALESWORD_LIST = config.よく使うセールスワード;
          renderSaleswordList();
          renderSaleswordFormat({ globalPrefix: '【', globalSuffix: '】', categoryOverrides: [] });
        }
      }
    }

    /**
     * 商品状態ボタン設定を表示
     */
    function renderConditionButtons(buttons) {
      const container = document.getElementById('conditionButtonsContainer');
      container.innerHTML = '';

      CONDITION_STATES.forEach((state, stateIndex) => {
        const stateButtons = buttons.filter(b => b.商品の状態 === state);

        const groupDiv = document.createElement('div');
        groupDiv.style.cssText = 'background: white; margin-bottom: 12px; border-radius: 8px; border: 1px solid #e5e7eb; overflow: hidden;';

        // アコーディオンヘッダー（クリックで開閉）
        const headerDiv = document.createElement('div');
        headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px; cursor: pointer; background: #f9fafb; transition: background 0.2s;';
        headerDiv.onclick = () => toggleAccordion(stateIndex);
        headerDiv.onmouseover = () => headerDiv.style.background = '#f3f4f6';
        headerDiv.onmouseout = () => headerDiv.style.background = '#f9fafb';

        headerDiv.innerHTML = `
          <strong style="font-size: 14px; color: #1f2937;">${state}</strong>
          <span id="accordion-icon-${stateIndex}" style="font-size: 18px; color: #6b7280; transition: transform 0.3s;">▼</span>
        `;
        groupDiv.appendChild(headerDiv);

        // アコーディオンコンテンツ（デフォルトで非表示）
        const contentDiv = document.createElement('div');
        contentDiv.id = `accordion-content-${stateIndex}`;
        contentDiv.style.cssText = 'display: none; padding: 12px; border-top: 1px solid #e5e7eb;';

        const buttonsContainer = document.createElement('div');
        buttonsContainer.id = `condition-${state}`;

        stateButtons.forEach((btn, idx) => {
          buttonsContainer.appendChild(createButtonConfigItem(state, idx, btn.ボタンラベル, btn.ボタンテキスト));
        });

        contentDiv.appendChild(buttonsContainer);

        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'add-btn';
        addBtn.style.cssText = 'width: 100%; margin-top: 8px;';
        addBtn.textContent = '+ ボタン追加';
        addBtn.onclick = () => addConditionButton(state);
        contentDiv.appendChild(addBtn);

        groupDiv.appendChild(contentDiv);
        container.appendChild(groupDiv);
      });
    }

    /**
     * アコーディオンの開閉
     */
    function toggleAccordion(index) {
      const content = document.getElementById(`accordion-content-${index}`);
      const icon = document.getElementById(`accordion-icon-${index}`);

      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';

        // アコーディオンを開いた時に全テキストエリアのサイズを調整
        setTimeout(() => {
          const textareas = content.querySelectorAll('textarea.auto-resize');
          textareas.forEach(textarea => {
            if (textarea.value) {
              autoResizeTextarea(textarea);
            }
          });
        }, 0);
      } else {
        content.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
      }
    }

    /**
     * ボタン設定項目を作成
     */
    function createButtonConfigItem(state, index, label, text) {
      const div = document.createElement('div');
      div.className = 'condition-button-item';
      div.style.cssText = 'background: #f9fafb; padding: 10px; margin-bottom: 8px; border-radius: 4px; border: 1px solid #dee2e6;';

      // プリセット取得
      const presets = CONDITION_BUTTON_PRESETS[state] || [];

      // プルダウンの選択肢を生成
      let selectOptions = '<option value="">-- 選択してください --</option>';
      presets.forEach(preset => {
        const selected = label === preset.label ? 'selected' : '';
        selectOptions += `<option value="${preset.label}" ${selected}>${preset.label}</option>`;
      });
      selectOptions += '<option value="custom">✏️ カスタム入力</option>';

      // カスタム入力かどうかを判定
      const isCustom = label && !presets.find(p => p.label === label);
      const selectedValue = isCustom ? 'custom' : (label || '');

      div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
          <strong style="font-size: 13px;">ボタン ${index + 1}</strong>
          <button type="button" class="btn btn-sm btn-outline-danger remove-btn" onclick="removeConditionButton('${state}', ${index})">削除</button>
        </div>
        <div class="mb-2">
          <label style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">ボタンラベル</label>
          <select class="form-control label-preset-select" data-state="${state}" data-index="${index}" data-field="label-select" onchange="handleLabelPresetChange(this, '${state}', ${index})" style="font-size: 13px; margin-bottom: 4px; appearance: auto; -webkit-appearance: menulist; -moz-appearance: menulist; background-color: white; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 6px; cursor: pointer;">
            ${selectOptions}
          </select>
          <input type="text" class="form-control label-custom-input" data-state="${state}" data-index="${index}" data-field="label" value="${label || ''}" placeholder="カスタムラベルを入力" style="font-size: 13px; display: none;">
        </div>
        <div>
          <label style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">ボタンテキスト</label>
          <textarea class="form-control auto-resize" rows="2" data-state="${state}" data-index="${index}" data-field="text" placeholder="クリック時に挿入されるテキストを入力" style="font-size: 13px; resize: none; overflow: hidden;" oninput="autoResizeTextarea(this)">${text}</textarea>
        </div>
      `;

      // プルダウンの値を設定
      setTimeout(() => {
        const select = div.querySelector('[data-field="label-select"]');
        const customInput = div.querySelector('[data-field="label"]');

        if (select) {
          select.value = selectedValue;

          // カスタム入力欄の表示/非表示を制御
          if (selectedValue === 'custom') {
            customInput.style.display = 'block';
          } else {
            customInput.style.display = 'none';
          }
        }

        // テキストエリアの初期サイズ調整
        const textarea = div.querySelector('textarea');
        if (textarea && textarea.value) {
          autoResizeTextarea(textarea);
        }
      }, 0);

      return div;
    }

    /**
     * ラベルプリセット変更時の処理
     */
    function handleLabelPresetChange(selectElement, state, index) {
      const selectedValue = selectElement.value;

      // data属性を使って同じstate/indexの要素を直接取得
      const containerId = `condition-${state}`;
      const container = document.getElementById(containerId);
      const items = container.querySelectorAll('.condition-button-item');
      const targetItem = items[index];

      if (!targetItem) {
        console.error('ボタンアイテムが見つかりません:', { state, index });
        return;
      }

      const labelInput = targetItem.querySelector('[data-field="label"]');
      const textArea = targetItem.querySelector('[data-field="text"]');

      console.log('handleLabelPresetChange:', { selectedValue, state, index, targetItem });

      if (selectedValue === 'custom') {
        // カスタム入力を表示
        labelInput.style.display = 'block';
        labelInput.value = '';
        textArea.value = '';
        labelInput.focus();
        setTimeout(() => autoResizeTextarea(textArea), 0);
      } else if (selectedValue === '') {
        // 未選択
        labelInput.style.display = 'none';
        labelInput.value = '';
        textArea.value = '';
        setTimeout(() => autoResizeTextarea(textArea), 0);
      } else {
        // プリセット選択
        labelInput.style.display = 'none';
        const presets = CONDITION_BUTTON_PRESETS[state] || [];
        const preset = presets.find(p => p.label === selectedValue);
        console.log('プリセット検索結果:', preset);
        if (preset) {
          labelInput.value = preset.label;
          textArea.value = preset.text;
          console.log('テキストエリアに設定:', preset.text);
          setTimeout(() => autoResizeTextarea(textArea), 0);
        } else {
          console.warn('プリセットが見つかりません:', selectedValue, state);
        }
      }
    }

    /**
     * 商品状態ボタンを追加
     */
    function addConditionButton(state) {
      const container = document.getElementById(`condition-${state}`);
      const index = container.children.length;
      container.appendChild(createButtonConfigItem(state, index, '', ''));
    }

    /**
     * 商品状態ボタンを削除
     */
    function removeConditionButton(state, index) {
      const container = document.getElementById(`condition-${state}`);
      if (container.children.length > 1) {
        container.children[index].remove();
        // インデックスを再計算
        Array.from(container.children).forEach((child, newIndex) => {
          const inputs = child.querySelectorAll('[data-index]');
          inputs.forEach(input => input.setAttribute('data-index', newIndex));
          child.querySelector('strong').textContent = `ボタン ${newIndex + 1}`;
          child.querySelector('.remove-btn').onclick = () => removeConditionButton(state, newIndex);
        });
      } else {
        alert('最低1つのボタンは必要です');
      }
    }

    /**
     * ハッシュタグ設定を表示
     */
    function renderHashtagConfig(config) {
      const container = document.getElementById('hashtagItemsContainer');
      container.innerHTML = '';

      // 共通プレフィックスを設定
      const removeHash = (value) => {
        if (!value) return '';
        return value.startsWith('#') ? value.substring(1) : value;
      };

      let commonPrefix = '';
      let hashtags = [];

      if (config.hashtags && Array.isArray(config.hashtags)) {
        // 新形式: 動的配列
        commonPrefix = removeHash(config.commonPrefix || 'REBORN_');
        hashtags = config.hashtags;
      } else if (config.全商品プレフィックス || config.ブランドプレフィックス || config.カテゴリプレフィックス) {
        // 旧形式: 固定3項目から変換（最初のプレフィックスを共通として使用）
        commonPrefix = removeHash(config.全商品プレフィックス || config.ブランドプレフィックス || config.カテゴリプレフィックス || 'REBORN_');

        if (config.全商品プレフィックス || config.全商品テキスト) {
          hashtags.push({
            title: '全商品',
            icon: '🌐',
            suffix: config.全商品テキスト || '全商品',
            suffixOptions: ['全商品', '全アイテム', '商品一覧', 'アイテム一覧']
          });
        }
        if (config.ブランドプレフィックス || config.ブランドサフィックス) {
          hashtags.push({
            title: 'ブランド',
            icon: '👔',
            suffix: config.ブランドサフィックス || 'アイテム一覧',
            suffixOptions: ['アイテム一覧', '商品一覧', 'コレクション', 'ブランド商品']
          });
        }
        if (config.カテゴリプレフィックス || config.カテゴリサフィックス) {
          hashtags.push({
            title: 'カテゴリ',
            icon: '📂',
            suffix: config.カテゴリサフィックス || '一覧',
            suffixOptions: ['一覧', 'アイテム一覧', '商品一覧', 'コレクション']
          });
        }
      }

      // 共通プレフィックスを設定
      document.getElementById('commonHashtagPrefix').value = commonPrefix;

      // ハッシュタグ項目をレンダリング
      hashtags.forEach((item, index) => {
        container.appendChild(createHashtagItem(index, item));
      });

      // ドラッグ&ドロップをセットアップ
      setupHashtagDragAndDrop();
    }

    /**
     * ハッシュタグ項目のドラッグ&ドロップをセットアップ
     */
    function setupHashtagDragAndDrop() {
      const container = document.getElementById('hashtagItemsContainer');
      let draggedElement = null;
      let draggedIndex = null;

      container.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('hashtag-item')) {
          draggedElement = e.target;
          draggedIndex = parseInt(e.target.getAttribute('data-index'));
          e.target.style.opacity = '0.5';
        }
      });

      container.addEventListener('dragend', (e) => {
        if (e.target.classList.contains('hashtag-item')) {
          e.target.style.opacity = '1';
        }
      });

      container.addEventListener('dragover', (e) => {
        e.preventDefault();
        const afterElement = getDragAfterElement(container, e.clientY);

        if (afterElement == null) {
          container.appendChild(draggedElement);
        } else {
          container.insertBefore(draggedElement, afterElement);
        }
      });

      container.addEventListener('drop', (e) => {
        e.preventDefault();
        reindexHashtagItems();
      });
    }

    /**
     * ドラッグ位置を計算
     */
    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.hashtag-item:not([style*="opacity: 0.5"])')];

      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;

        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    /**
     * ハッシュタグ項目を作成
     */
    function createHashtagItem(index, data = {}) {
      const title = data.title || '';
      const icon = data.icon || '🏷️';
      const suffix = data.suffix || '';
      const suffixOptions = data.suffixOptions || ['全商品', '全アイテム', '商品一覧', 'アイテム一覧'];

      const div = document.createElement('div');
      div.className = 'hashtag-item';
      div.setAttribute('data-index', index);
      div.setAttribute('draggable', 'true');
      div.style.cssText = 'margin-bottom: 12px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb; cursor: move; transition: all 0.2s;';

      // プレビュー用の中間部分を決定（具体例を表示）
      let previewMiddle = '';
      if (title === 'ブランド') {
        previewMiddle = 'UNIQLO';
      } else if (title === 'カテゴリ') {
        // 選択されたカテゴリの具体例を表示
        const categoryOptions = data.categoryOptions || ['大分類', '中分類'];
        const exampleMap = {
          '大分類': 'メンズ',
          '中分類': 'トップス',
          '小分類': 'シャツ',
          '細分類1': '半袖シャツ',
          '細分類2': 'アロハシャツ・かりゆしウェア',
          'アイテム名': 'アロハシャツ'
        };
        const examples = categoryOptions.map(opt => exampleMap[opt] || opt);
        previewMiddle = examples.join('');
      } else if (title === 'カラー') {
        previewMiddle = '黒';
      } else if (title === 'サイズ') {
        previewMiddle = 'M';
      }

      // プレビューテキストを生成
      const commonPrefix = document.getElementById('commonHashtagPrefix')?.value || 'REBORN_';
      const previewText = `#${commonPrefix}${previewMiddle}${suffixOptions.includes(suffix) ? suffix : (!suffixOptions.includes(suffix) && suffix ? suffix : '')}`;

      // カテゴリハッシュタグの場合、チェックボックスを追加
      const isCategoryHashtag = title === 'カテゴリ';
      const categoryOptions = data.categoryOptions || ['大分類', '中分類'];

      const categoryCheckboxesHtml = isCategoryHashtag ? `
        <div style="margin-bottom: 8px; padding: 8px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
          <div style="font-size: 11px; font-weight: 600; color: #6b7280; margin-bottom: 6px;">連結するカテゴリを選択（複数可）:</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px;">
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
              <input type="checkbox" class="category-option" data-option="大分類" ${categoryOptions.includes('大分類') ? 'checked' : ''} onchange="updateHashtagItemPreview(${index})" style="cursor: pointer;">
              <span>大分類</span>
            </label>
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
              <input type="checkbox" class="category-option" data-option="中分類" ${categoryOptions.includes('中分類') ? 'checked' : ''} onchange="updateHashtagItemPreview(${index})" style="cursor: pointer;">
              <span>中分類</span>
            </label>
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
              <input type="checkbox" class="category-option" data-option="小分類" ${categoryOptions.includes('小分類') ? 'checked' : ''} onchange="updateHashtagItemPreview(${index})" style="cursor: pointer;">
              <span>小分類</span>
            </label>
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
              <input type="checkbox" class="category-option" data-option="細分類1" ${categoryOptions.includes('細分類1') ? 'checked' : ''} onchange="updateHashtagItemPreview(${index})" style="cursor: pointer;">
              <span>細分類1</span>
            </label>
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
              <input type="checkbox" class="category-option" data-option="細分類2" ${categoryOptions.includes('細分類2') ? 'checked' : ''} onchange="updateHashtagItemPreview(${index})" style="cursor: pointer;">
              <span>細分類2</span>
            </label>
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
              <input type="checkbox" class="category-option" data-option="アイテム名" ${categoryOptions.includes('アイテム名') ? 'checked' : ''} onchange="updateHashtagItemPreview(${index})" style="cursor: pointer;">
              <span>アイテム名</span>
            </label>
          </div>
        </div>
      ` : '';

      div.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
          <span class="hashtag-drag-handle" style="font-size: 16px; color: #9ca3af; cursor: grab; user-select: none; flex-shrink: 0;" title="ドラッグして並び替え">⋮⋮</span>
          <span class="hashtag-icon-display" style="font-size: 18px; user-select: none; flex-shrink: 0;">${icon}</span>
          <input type="hidden" class="hashtag-icon" value="${icon}">
          <input type="hidden" class="hashtag-title" value="${title}">
          <div style="flex: 1; font-size: 14px; font-weight: 600; color: #374151;">${title}</div>
        </div>

        ${categoryCheckboxesHtml}

        <div style="margin-bottom: 8px;">
          <select class="hashtag-suffix-select" style="width: 100%; padding: 6px 8px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 12px; transition: all 0.2s; background: white; cursor: pointer;" onfocus="this.style.borderColor='#3b82f6';" onblur="this.style.borderColor='#d1d5db';" onchange="handleHashtagItemSuffixChange(${index})">
            ${suffixOptions.map(opt => `<option value="${opt}"${opt === suffix ? ' selected' : ''}>${opt}</option>`).join('')}
            <option value="custom"${!suffixOptions.includes(suffix) && suffix ? ' selected' : ''}>カスタム...</option>
          </select>
          <input type="text" class="hashtag-suffix-custom" value="${!suffixOptions.includes(suffix) && suffix ? suffix : ''}" placeholder="カスタム値を入力" style="width: 100%; padding: 6px 8px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 12px; transition: all 0.2s; margin-top: 6px; display: ${!suffixOptions.includes(suffix) && suffix ? 'block' : 'none'};" onfocus="this.style.borderColor='#3b82f6';" onblur="this.style.borderColor='#d1d5db';" oninput="updateHashtagItemPreview(${index})">
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
          <div style="flex: 1;">
            <div style="font-size: 10px; color: #6b7280; margin-bottom: 2px;">プレビュー:</div>
            <div class="hashtag-preview" style="padding: 6px 10px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 11px; color: #1e40af; font-weight: 500;">
              ${previewText}
            </div>
          </div>
          <button type="button" onclick="removeHashtagItem(${index})" style="padding: 4px 8px; background: white; border: 1px solid #ef4444; color: #ef4444; border-radius: 4px; font-size: 10px; cursor: pointer; transition: all 0.2s; white-space: nowrap; flex-shrink: 0;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
            削除
          </button>
        </div>
      `;

      return div;
    }

    /**
     * ハッシュタグタイプ選択メニューを表示
     */
    function showHashtagTypeSelector() {
      const menu = document.getElementById('hashtagTypeSelectorMenu');
      menu.style.display = 'block';
    }

    /**
     * ハッシュタグタイプ選択メニューを非表示
     */
    function hideHashtagTypeSelector() {
      const menu = document.getElementById('hashtagTypeSelectorMenu');
      menu.style.display = 'none';
    }

    /**
     * タイプを指定してハッシュタグ項目を追加
     */
    function addHashtagItemByType(type) {
      const container = document.getElementById('hashtagItemsContainer');
      const index = container.children.length;

      let newItem = {};

      if (type === '全商品') {
        newItem = {
          title: '全商品',
          icon: '🌐',
          suffix: '全商品',
          suffixOptions: ['全商品', '全アイテム', '商品一覧', 'アイテム一覧']
        };
      } else if (type === 'ブランド') {
        newItem = {
          title: 'ブランド',
          icon: '👔',
          suffix: 'アイテム一覧',
          suffixOptions: ['一覧', 'アイテム一覧', '商品一覧', '全商品', 'コレクション']
        };
      } else if (type === 'カテゴリ') {
        newItem = {
          title: 'カテゴリ',
          icon: '📁',
          suffix: '一覧',
          suffixOptions: ['一覧', 'アイテム一覧', '商品一覧', 'コレクション'],
          categoryOptions: ['大分類']
        };
      } else if (type === 'カラー') {
        newItem = {
          title: 'カラー',
          icon: '🎨',
          suffix: '一覧',
          suffixOptions: ['一覧', 'アイテム一覧', '商品一覧', 'コレクション']
        };
      } else if (type === 'サイズ') {
        newItem = {
          title: 'サイズ',
          icon: '📏',
          suffix: '一覧',
          suffixOptions: ['一覧', 'アイテム一覧', '商品一覧', 'コレクション']
        };
      }

      container.appendChild(createHashtagItem(index, newItem));
      hideHashtagTypeSelector();
    }

    /**
     * ハッシュタグ項目を追加（旧関数・互換性のため残す）
     */
    function addHashtagItem() {
      showHashtagTypeSelector();
    }

    /**
     * ハッシュタグ項目を削除
     */
    function removeHashtagItem(index) {
      const container = document.getElementById('hashtagItemsContainer');

      // 項目を削除
      if (container.children[index]) {
        container.children[index].remove();
      }

      // インデックスを再割り当て
      Array.from(container.children).forEach((item, newIndex) => {
        item.setAttribute('data-index', newIndex);

        // 各ボタンとイベントハンドラーのインデックスを更新
        const deleteBtn = item.querySelector('button[onclick*="removeHashtagItem"]');
        if (deleteBtn) {
          deleteBtn.setAttribute('onclick', `removeHashtagItem(${newIndex})`);
        }

        const suffixSelect = item.querySelector('.hashtag-suffix-select');
        if (suffixSelect) {
          suffixSelect.setAttribute('onchange', `handleHashtagItemSuffixChange(${newIndex})`);
        }

        const suffixCustom = item.querySelector('.hashtag-suffix-custom');
        if (suffixCustom) {
          suffixCustom.setAttribute('oninput', `updateHashtagItemPreview(${newIndex})`);
        }
      });
    }

    /**
     * すべてのハッシュタグをクリア
     */
    function clearAllHashtags() {
      if (!confirm('すべてのハッシュタグをクリアしてよろしいですか？\nこの操作は取り消せません。')) {
        return;
      }

      const container = document.getElementById('hashtagItemsContainer');
      container.innerHTML = '';

      alert('すべてのハッシュタグをクリアしました。\n変更を保存するには「保存」ボタンをクリックしてください。');
    }

    /**
     * ハッシュタグ項目のインデックスを再割り当て
     */
    function reindexHashtagItems() {
      const container = document.getElementById('hashtagItemsContainer');
      Array.from(container.children).forEach((item, newIndex) => {
        item.setAttribute('data-index', newIndex);

        const deleteBtn = item.querySelector('button[onclick*="removeHashtagItem"]');
        if (deleteBtn) {
          deleteBtn.setAttribute('onclick', `removeHashtagItem(${newIndex})`);
        }

        const suffixSelect = item.querySelector('.hashtag-suffix-select');
        if (suffixSelect) {
          suffixSelect.setAttribute('onchange', `handleHashtagItemSuffixChange(${newIndex})`);
        }

        const suffixCustom = item.querySelector('.hashtag-suffix-custom');
        if (suffixCustom) {
          suffixCustom.setAttribute('oninput', `updateHashtagItemPreview(${newIndex})`);
        }

        const categoryOptions = item.querySelectorAll('.category-option');
        categoryOptions.forEach(checkbox => {
          checkbox.setAttribute('onchange', `updateHashtagItemPreview(${newIndex})`);
        });
      });
    }

    /**
     * ハッシュタグ項目のプレビューを更新
     */
    function updateHashtagItemPreview(index) {
      const container = document.getElementById('hashtagItemsContainer');
      const item = container.children[index];
      if (!item) return;

      const commonPrefix = document.getElementById('commonHashtagPrefix').value || '';
      const titleInput = item.querySelector('.hashtag-title');
      const title = titleInput ? titleInput.value || '' : '';
      const suffixSelect = item.querySelector('.hashtag-suffix-select');
      const suffixCustom = item.querySelector('.hashtag-suffix-custom');

      let suffix = '';
      if (suffixSelect.value === 'custom') {
        suffix = suffixCustom.value || '';
      } else {
        suffix = suffixSelect.value || '';
      }

      // プレビュー用の中間部分を決定（具体例を表示）
      let previewMiddle = '';
      if (title === 'ブランド') {
        previewMiddle = 'UNIQLO';
      } else if (title === 'カテゴリ') {
        // 選択されたカテゴリオプションの具体例を表示
        const categoryCheckboxes = item.querySelectorAll('.category-option:checked');
        const selectedCategories = Array.from(categoryCheckboxes).map(cb => cb.getAttribute('data-option'));
        const exampleMap = {
          '大分類': 'メンズ',
          '中分類': 'トップス',
          '小分類': 'シャツ',
          '細分類1': '半袖シャツ',
          '細分類2': 'アロハシャツ・かりゆしウェア',
          'アイテム名': 'アロハシャツ'
        };
        const examples = selectedCategories.map(opt => exampleMap[opt] || opt);
        previewMiddle = examples.length > 0 ? examples.join('') : 'カテゴリ';
      } else if (title === 'カラー') {
        previewMiddle = '黒';
      } else if (title === 'サイズ') {
        previewMiddle = 'M';
      }

      const preview = `#${commonPrefix}${previewMiddle}${suffix}`;
      const previewDiv = item.querySelector('.hashtag-preview');
      if (previewDiv) {
        previewDiv.textContent = preview;
      }
    }

    /**
     * すべてのハッシュタグプレビューを更新
     */
    function updateAllHashtagPreviews() {
      const container = document.getElementById('hashtagItemsContainer');
      for (let i = 0; i < container.children.length; i++) {
        updateHashtagItemPreview(i);
      }
    }

    /**
     * ハッシュタグ項目のサフィックス変更処理
     */
    function handleHashtagItemSuffixChange(index) {
      const container = document.getElementById('hashtagItemsContainer');
      const item = container.children[index];
      if (!item) return;

      const suffixSelect = item.querySelector('.hashtag-suffix-select');
      const suffixCustom = item.querySelector('.hashtag-suffix-custom');

      if (suffixSelect.value === 'custom') {
        suffixCustom.style.display = 'block';
        suffixCustom.focus();
      } else {
        suffixCustom.style.display = 'none';
        suffixCustom.value = '';
      }

      updateHashtagItemPreview(index);
    }


    /**
     * ハッシュタグサフィックスのセットアップ（選択肢とカスタム値の処理）
     */
    function setupHashtagSuffix(type, value, options) {
      const selectId = type === '全商品' ? '全商品テキスト_select' : `${type}サフィックス_select`;
      const inputId = type === '全商品' ? '全商品テキスト' : `${type}サフィックス`;

      const select = document.getElementById(selectId);
      const input = document.getElementById(inputId);

      if (options.includes(value)) {
        // プリセット値の場合
        select.value = value;
        input.style.display = 'none';
        input.value = '';
      } else {
        // カスタム値の場合
        select.value = 'custom';
        input.style.display = 'block';
        input.value = value;
      }
    }

    /**
     * ハッシュタグプレビュー更新
     */
    function updateHashtagPreview(type) {
      const prefixId = type === '全商品' ? '全商品プレフィックス' : `${type}プレフィックス`;
      const selectId = type === '全商品' ? '全商品テキスト_select' : `${type}サフィックス_select`;
      const inputId = type === '全商品' ? '全商品テキスト' : `${type}サフィックス`;
      const previewId = `${type}プレビュー`;

      const prefix = document.getElementById(prefixId).value || '';
      const select = document.getElementById(selectId);
      const input = document.getElementById(inputId);

      let suffix = '';
      if (select.value === 'custom') {
        suffix = input.value || '';
      } else {
        suffix = select.value || '';
      }

      // ブランドの場合は例としてUNIQLOを表示
      const middlePart = type === 'ブランド' ? 'UNIQLO' : (type === 'カテゴリ' ? 'トップス' : '');

      const preview = `#${prefix}${middlePart}${suffix}`;
      document.getElementById(previewId).textContent = preview;
    }

    /**
     * ハッシュタグサフィックス変更処理
     */
    function handleHashtagSuffixChange(type) {
      const selectId = type === '全商品' ? '全商品テキスト_select' : `${type}サフィックス_select`;
      const inputId = type === '全商品' ? '全商品テキスト' : `${type}サフィックス`;

      const select = document.getElementById(selectId);
      const input = document.getElementById(inputId);

      if (select.value === 'custom') {
        input.style.display = 'block';
        input.focus();
      } else {
        input.style.display = 'none';
        input.value = '';
      }

      updateHashtagPreview(type);
    }

    // 割引タイプのアイコンマッピング
    const DISCOUNT_ICONS = {
      'フォロー割': '👥',
      'リピート割': '🔄',
      'まとめ割': '📦',
      '学割': '🎓',
      'セット割': '🎁',
      'クーポン割': '🎫',
      '新規会員割': '✨',
      '期間限定割': '⏰'
    };

    // デフォルトの割引タイプ
    const DEFAULT_DISCOUNT_TYPES = ['フォロー割', 'リピート割', 'まとめ割'];

    /**
     * 割引タイプを追加
     */
    function addDiscountType() {
      const typesList = document.getElementById('discountTypesList');

      // プリセット選択UI
      const selectorDiv = document.createElement('div');
      selectorDiv.style.cssText = 'background: white; padding: 12px; margin-bottom: 16px; border-radius: 8px; border: 2px solid #3b82f6;';
      selectorDiv.innerHTML = `
        <div style="margin-bottom: 8px; font-size: 13px; font-weight: 600; color: #374151;">割引タイプを選択</div>
        <select id="newDiscountTypeSelect" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 8px; font-size: 13px;">
          <option value="">-- 選択してください --</option>
          <option value="フォロー割">👥 フォロー割</option>
          <option value="リピート割">🔄 リピート割</option>
          <option value="まとめ割">📦 まとめ割</option>
          <option value="学割">🎓 学割</option>
          <option value="セット割">🎁 セット割</option>
          <option value="クーポン割">🎫 クーポン割</option>
          <option value="新規会員割">✨ 新規会員割</option>
          <option value="期間限定割">⏰ 期間限定割</option>
          <option value="custom">✏️ カスタム入力</option>
        </select>
        <input type="text" id="newDiscountTypeCustom" placeholder="カスタム割引名を入力（例: 誕生日割）" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 8px; font-size: 13px; display: none;">
        <input type="text" id="newDiscountTypeIcon" placeholder="アイコンを入力（例: 🎂）" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 8px; font-size: 13px; display: none;">
        <div style="display: flex; gap: 8px;">
          <button type="button" onclick="confirmAddDiscountType()" style="flex: 1; padding: 8px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">追加</button>
          <button type="button" onclick="cancelAddDiscountType()" style="flex: 1; padding: 8px; background: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 13px;">キャンセル</button>
        </div>
      `;

      typesList.appendChild(selectorDiv);

      // セレクト変更時のハンドラー
      document.getElementById('newDiscountTypeSelect').addEventListener('change', function() {
        const customInput = document.getElementById('newDiscountTypeCustom');
        const iconInput = document.getElementById('newDiscountTypeIcon');
        if (this.value === 'custom') {
          customInput.style.display = 'block';
          iconInput.style.display = 'block';
        } else {
          customInput.style.display = 'none';
          iconInput.style.display = 'none';
        }
      });
    }

    /**
     * 割引タイプ追加を確定
     */
    function confirmAddDiscountType() {
      const select = document.getElementById('newDiscountTypeSelect');
      const customInput = document.getElementById('newDiscountTypeCustom');
      const iconInput = document.getElementById('newDiscountTypeIcon');

      let typeName, icon;

      if (select.value === 'custom') {
        typeName = customInput.value.trim();
        icon = iconInput.value.trim() || '💰';
        if (!typeName) {
          alert('割引名を入力してください');
          return;
        }
      } else if (select.value) {
        typeName = select.value;
        icon = DISCOUNT_ICONS[typeName] || '💰';
      } else {
        alert('割引タイプを選択してください');
        return;
      }

      // 既存チェック
      if (document.getElementById(`${typeName}Group`)) {
        alert('同じ名前の割引が既に存在します');
        return;
      }

      // 選択UIを削除
      cancelAddDiscountType();

      // 新しい割引タイプを作成
      createDiscountTypeBlock(typeName, icon);

      updateDiscountPreview();
    }

    /**
     * 割引タイプ追加をキャンセル
     */
    function cancelAddDiscountType() {
      const typesList = document.getElementById('discountTypesList');
      const selector = typesList.querySelector('[id="newDiscountTypeSelect"]')?.closest('div');
      if (selector) {
        selector.remove();
      }
    }

    /**
     * 割引タイプブロックを作成
     */
    function createDiscountTypeBlock(typeName, icon, ranges = [], description = '') {
      const typesList = document.getElementById('discountTypesList');

      const groupDiv = document.createElement('div');
      groupDiv.id = `${typeName}Group`;
      groupDiv.className = 'discount-group';

      groupDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <strong style="font-size: 14px; color: #1f2937;">${icon} ${typeName}</strong>
          <button type="button" onclick="removeDiscountType('${typeName}')" style="padding: 4px 12px; background: white; color: #ef4444; border: 1px solid #ef4444; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">削除</button>
        </div>
        <div id="${typeName}Container">
          <!-- 動的に生成 -->
        </div>
        <button type="button" class="btn btn-sm btn-primary add-btn" onclick="addDiscountRange('${typeName}')" style="width: 100%; margin-bottom: 12px;">+ 範囲追加</button>
        <div>
          <label class="form-label" style="font-size: 12px;">説明文（任意）</label>
          <textarea class="form-control auto-resize" id="${typeName}_説明文" placeholder="説明文を入力" style="font-size: 13px; resize: none; overflow: hidden; min-height: 100px;" oninput="autoResizeTextarea(this); updateDiscountPreview();">${description}</textarea>
        </div>
      `;

      typesList.appendChild(groupDiv);

      const container = document.getElementById(`${typeName}Container`);
      ranges.forEach((range, idx) => {
        container.appendChild(createDiscountRangeItem(typeName, idx, range.範囲, range.割引額));
      });

      // 説明文textareaの初期サイズ調整
      setTimeout(() => {
        const textarea = document.getElementById(`${typeName}_説明文`);
        if (textarea && textarea.value) {
          autoResizeTextarea(textarea);
        }
      }, 0);
    }

    /**
     * 割引タイプを削除
     */
    function removeDiscountType(typeName) {
      if (!confirm(`「${typeName}」を削除しますか？`)) {
        return;
      }

      const group = document.getElementById(`${typeName}Group`);
      if (group) {
        group.remove();
      }

      updateDiscountPreview();
    }

    /**
     * 割引情報設定を表示
     */
    function renderDiscountConfig(config) {
      // タイトルを設定
      const select = document.getElementById('割引情報タイトル選択');
      const customInput = document.getElementById('割引情報タイトルカスタム');

      if (select) {
        const titleSelection = config['タイトル選択'] || config['タイトル'] || '【お得な割引情報】';

        // カスタム入力の場合
        if (titleSelection === 'custom') {
          select.value = 'custom';
          customInput.value = config['タイトル'] || '';
          customInput.style.display = 'block';
        } else {
          // プリセット選択の場合
          select.value = titleSelection;
          customInput.style.display = 'none';
        }
      }

      // 既存の割引タイプをクリア
      const typesList = document.getElementById('discountTypesList');
      typesList.innerHTML = '';

      // デフォルト説明文
      const defaultDescriptions = {
        'フォロー割': '',
        'リピート割': '「リピート割希望」とコメントにてお知らせください。',
        'まとめ割': '購入したい商品が複数ある場合、コメントにてお知らせください。'
      };

      // 設定から割引タイプを取得（保存されている順序を維持）
      const savedTypes = config['割引タイプ順序'] || DEFAULT_DISCOUNT_TYPES;

      savedTypes.forEach(typeName => {
        const ranges = config[typeName] || [];
        const description = config[`${typeName}_説明文`] || defaultDescriptions[typeName] || '';
        const icon = config[`${typeName}_アイコン`] || DISCOUNT_ICONS[typeName] || '💰';

        createDiscountTypeBlock(typeName, icon, ranges, description);
      });

      // 全ての割引タイプ作成後、説明文テキストエリアのサイズを調整
      setTimeout(() => {
        const textareas = typesList.querySelectorAll('textarea.auto-resize');
        textareas.forEach(textarea => {
          if (textarea.value) {
            autoResizeTextarea(textarea);
          }
        });
      }, 100);

      // プレビューを更新
      updateDiscountPreview();
    }

    /**
     * 割引範囲項目を作成
     */
    function createDiscountRangeItem(type, index, range, amount) {
      const div = document.createElement('div');
      div.className = 'discount-range-item';
      div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
          <strong style="font-size: 13px;">範囲 ${index + 1}</strong>
          <button type="button" class="btn btn-sm btn-outline-danger remove-btn" onclick="removeDiscountRange('${type}', ${index})">削除</button>
        </div>
        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
          <div style="writing-mode: vertical-rl; font-size: 9px; font-weight: 600; color: #6b7280; display: flex; align-items: center; justify-content: center; padding: 4px 2px; background: #f3f4f6; border-radius: 4px;">範囲</div>
          <input type="text" class="form-control" data-discount="${type}" data-index="${index}" data-field="range" value="${range}" placeholder="空欄可（例: 〜2,999円）" style="flex: 1;" oninput="updateDiscountPreview()">
        </div>
        <div style="display: flex; gap: 8px;">
          <div style="writing-mode: vertical-rl; font-size: 9px; font-weight: 600; color: #6b7280; display: flex; align-items: center; justify-content: center; padding: 4px 2px; background: #f3f4f6; border-radius: 4px;">割引</div>
          <input type="text" class="form-control" data-discount="${type}" data-index="${index}" data-field="amount" value="${amount}" placeholder="100円引" style="flex: 1;" oninput="updateDiscountPreview()">
        </div>
      `;
      return div;
    }

    /**
     * 割引範囲を追加
     */
    function addDiscountRange(type) {
      const container = document.getElementById(`${type}Container`);
      const index = container.children.length;
      container.appendChild(createDiscountRangeItem(type, index, '', ''));
      updateDiscountPreview();
    }

    /**
     * 割引範囲を削除
     */
    function removeDiscountRange(type, index) {
      const container = document.getElementById(`${type}Container`);
      if (container.children.length > 1) {
        container.children[index].remove();
        // インデックスを再計算
        Array.from(container.children).forEach((child, newIndex) => {
          const inputs = child.querySelectorAll('[data-index]');
          inputs.forEach(input => input.setAttribute('data-index', newIndex));
          child.querySelector('strong').textContent = `範囲 ${newIndex + 1}`;
          child.querySelector('.remove-btn').onclick = () => removeDiscountRange(type, newIndex);
        });
        updateDiscountPreview();
      } else {
        alert('最低1つの範囲は必要です');
      }
    }

    /**
     * 割引情報タイトルの変更を処理
     */
    function handleDiscountTitleChange() {
      const select = document.getElementById('割引情報タイトル選択');
      const customInput = document.getElementById('割引情報タイトルカスタム');

      if (select.value === 'custom') {
        customInput.style.display = 'block';
        customInput.focus();
      } else {
        customInput.style.display = 'none';
      }

      updateDiscountPreview();
    }

    /**
     * 割引情報プレビューを更新
     */
    function updateDiscountPreview() {
      const preview = document.getElementById('discountPreview');
      if (!preview) return;

      const select = document.getElementById('割引情報タイトル選択');
      const customInput = document.getElementById('割引情報タイトルカスタム');
      const title = select?.value === 'custom' ? customInput?.value : select?.value || '【お得な割引情報】';
      const discountConfig = collectDiscountConfig();
      let previewText = title ? title + '\n\n' : '';

      // 現在表示されている全ての割引タイプを処理
      const typesList = document.getElementById('discountTypesList');
      const discountGroups = typesList?.querySelectorAll('.discount-group') || [];

      discountGroups.forEach(group => {
        const typeName = group.id.replace('Group', '');
        const ranges = discountConfig[typeName] || [];

        if (ranges.length > 0) {
          previewText += `■ ${typeName}\n`;
          ranges.forEach(item => {
            // 範囲が空欄の場合は割引額のみ表示
            if (item.範囲) {
              previewText += `${item.範囲} ⇒ ${item.割引額}\n`;
            } else {
              previewText += `${item.割引額}\n`;
            }
          });
          const desc = document.getElementById(`${typeName}_説明文`)?.value;
          if (desc) previewText += desc + '\n';
          previewText += '\n';
        }
      });

      preview.textContent = previewText.trim() || '割引情報が設定されていません';
    }

    /**
     * 割引設定をすべてクリア
     */
    function clearAllDiscounts() {
      if (!confirm('すべての割引設定をクリアしますか？')) {
        return;
      }

      // タイトルをデフォルトに戻す
      const select = document.getElementById('割引情報タイトル選択');
      const customInput = document.getElementById('割引情報タイトルカスタム');
      if (select) {
        select.value = '【お得な割引情報】';
      }
      if (customInput) {
        customInput.value = '';
        customInput.style.display = 'none';
      }

      // すべての割引タイプを削除
      const typesList = document.getElementById('discountTypesList');
      if (typesList) {
        typesList.innerHTML = '';
      }

      // プレビュー更新
      updateDiscountPreview();
    }

    /**
     * 配送デフォルト設定をすべてクリア
     */
    function clearShippingDefaults() {
      if (!confirm('配送デフォルト設定をすべてクリアしますか？')) {
        return;
      }

      // すべてのフィールドを空欄に戻す
      document.getElementById('配送料の負担').value = '';
      document.getElementById('配送の方法').value = '';
      document.getElementById('発送元の地域').value = '';
      document.getElementById('発送までの日数').value = '';

      alert('配送デフォルト設定をクリアしました。\n変更を保存するには「設定を保存」ボタンをクリックしてください。');
    }

    /**
     * 配送デフォルト設定を表示
     */
    function renderShippingDefaults(config) {
      document.getElementById('配送料の負担').value = config.配送料の負担 || '送料込み(出品者負担)';
      document.getElementById('配送の方法').value = config.配送の方法 || 'ゆうゆうメルカリ便';
      document.getElementById('発送元の地域').value = config.発送元の地域 || '岡山県';
      document.getElementById('発送までの日数').value = config.発送までの日数 || '1~2日で発送';
    }

    /**
     * 管理番号設定を表示
     */
    function renderManagementConfig(config) {
      // 新しい管理番号ビルダーにデータをセット
      if (typeof ManagementNumberBuilder !== 'undefined' && config.segments) {
        ManagementNumberBuilder.setData(config);
      }
    }

    /**
     * 管理番号プレビューの設定
     */
    function setupManagementNumberPreview() {
      document.getElementById('管理番号_棚番号使用').addEventListener('change', () => {
        toggleShelfNumberSection();
        updateManagementNumberPreview();
      });
      document.getElementById('管理番号_棚番号形式').addEventListener('change', () => {
        toggleShelfCustomSection();
        updateManagementNumberPreview();
      });
      document.getElementById('管理番号_棚番号サンプル').addEventListener('input', updateManagementNumberPreview);
      document.getElementById('管理番号_区切り文字').addEventListener('input', updateManagementNumberPreview);
      document.getElementById('管理番号_商品番号桁数').addEventListener('change', updateManagementNumberPreview);
      document.getElementById('管理番号_商品番号開始値').addEventListener('input', updateManagementNumberPreview);
    }

    /**
     * 棚番号セクションの表示切替
     */
    function toggleShelfNumberSection() {
      const useShelf = document.getElementById('管理番号_棚番号使用').checked;
      document.getElementById('shelfNumberSection').style.display = useShelf ? 'block' : 'none';
    }

    /**
     * 棚番号カスタム入力の表示切替
     */
    function toggleShelfCustomSection() {
      const format = document.getElementById('管理番号_棚番号形式').value;
      document.getElementById('shelfCustomSection').style.display = format === 'custom' ? 'block' : 'none';
    }

    /**
     * 管理番号プレビューを更新
     */
    function updateManagementNumberPreview() {
      const useShelf = document.getElementById('管理番号_棚番号使用').checked;
      const format = document.getElementById('管理番号_棚番号形式').value;
      const customSample = document.getElementById('管理番号_棚番号サンプル').value;
      const separator = document.getElementById('管理番号_区切り文字').value;
      const width = parseInt(document.getElementById('管理番号_商品番号桁数').value) || 4;
      const startNum = parseInt(document.getElementById('管理番号_商品番号開始値').value) || 1;

      let shelfPart = '';
      if (useShelf) {
        // 棚番号のサンプル値を決定
        switch (format) {
          case 'AA':
            shelfPart = 'AA';
            break;
          case 'A':
            shelfPart = 'A';
            break;
          case '01':
            shelfPart = '01';
            break;
          case '001':
            shelfPart = '001';
            break;
          case 'custom':
            shelfPart = customSample || 'RACK-A';
            break;
          default:
            shelfPart = 'AA';
        }
      }

      // 商品番号部分
      const itemPart = String(startNum).padStart(width, '0');

      // 管理番号を生成
      let preview = '';
      if (useShelf && shelfPart) {
        // 区切り文字が空の場合はそのまま連結
        preview = separator ? `${shelfPart}${separator}${itemPart}` : `${shelfPart}${itemPart}`;
      } else {
        preview = itemPart;
      }

      document.getElementById('管理番号プレビュー').value = preview;
    }

    /**
     * 設定を保存
     */
    function saveConfig() {
      console.log('=== saveConfig 開始 ===');
      const managementConfig = collectManagementConfig();
      console.log('管理番号設定:', managementConfig);

      const newConfig = {
        商品状態ボタン: collectConditionButtons(),
        ハッシュタグ: collectHashtagConfig(),
        割引情報: collectDiscountConfig(),
        配送デフォルト: collectShippingDefaults(),
        仕入出品デフォルト: collectProcureListingDefaults(),
        管理番号設定: managementConfig,
        よく使うセールスワード: collectSaleswordConfig()
      };

      console.log('保存する設定全体:', newConfig);

      if (google && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function(result) {
            console.log('保存結果:', result);
            if (result.success) {
              alert('設定を保存しました');
              // キャッシュをクリア
              google.script.run.clearConfigCache();
            } else {
              alert('保存に失敗しました: ' + result.error);
            }
          })
          .withFailureHandler(function(error) {
            console.error('保存エラー:', error);
            alert('保存中にエラーが発生しました: ' + error);
          })
          .saveConfigMaster(newConfig);
      } else {
        console.error('google.script.run が利用できません');
      }
    }

    /**
     * 商品状態ボタン設定を収集
     */
    function collectConditionButtons() {
      const buttons = [];
      CONDITION_STATES.forEach(state => {
        const container = document.getElementById(`condition-${state}`);
        Array.from(container.children).forEach((item, index) => {
          const labelSelect = item.querySelector('[data-field="label-select"]');
          const labelInput = item.querySelector('[data-field="label"]');
          const text = item.querySelector('[data-field="text"]').value;

          // プルダウンがカスタムまたは未選択の場合はinputから、それ以外はselectから取得
          let label = '';
          if (labelSelect && labelSelect.value === 'custom') {
            label = labelInput.value;
          } else if (labelSelect && labelSelect.value) {
            label = labelSelect.value;
          } else {
            label = labelInput.value;
          }

          if (label || text) {
            buttons.push({
              商品の状態: state,
              ボタンラベル: label,
              ボタンテキスト: text
            });
          }
        });
      });
      return buttons;
    }

    /**
     * ハッシュタグ設定を収集
     */
    function collectHashtagConfig() {
      const container = document.getElementById('hashtagItemsContainer');
      const hashtags = [];

      // 保存時に # を自動で付ける
      const addHash = (value) => {
        const trimmed = (value || '').trim();
        if (!trimmed) return '';
        return trimmed.startsWith('#') ? trimmed : '#' + trimmed;
      };

      // 共通プレフィックスを取得
      const commonPrefix = addHash(document.getElementById('commonHashtagPrefix').value || '');

      Array.from(container.children).forEach(item => {
        const title = item.querySelector('.hashtag-title').value || '';
        const icon = item.querySelector('.hashtag-icon').value || '🏷️';
        const suffixSelect = item.querySelector('.hashtag-suffix-select');
        const suffixCustom = item.querySelector('.hashtag-suffix-custom');

        let suffix = '';
        if (suffixSelect.value === 'custom') {
          suffix = suffixCustom.value || '';
        } else {
          suffix = suffixSelect.value || '';
        }

        // サフィックスオプションを収集
        const suffixOptions = Array.from(suffixSelect.options)
          .filter(opt => opt.value !== 'custom')
          .map(opt => opt.value);

        // カテゴリオプションを収集（カテゴリハッシュタグの場合のみ）
        let categoryOptions = null;
        if (title === 'カテゴリ') {
          categoryOptions = [];
          const checkboxes = item.querySelectorAll('.category-option');
          checkboxes.forEach(cb => {
            if (cb.checked) {
              categoryOptions.push(cb.getAttribute('data-option'));
            }
          });
        }

        // タイトルが入力されている場合のみ保存
        if (title) {
          const hashtagData = {
            title: title,
            icon: icon,
            suffix: suffix,
            suffixOptions: suffixOptions
          };
          if (categoryOptions) {
            hashtagData.categoryOptions = categoryOptions;
          }
          hashtags.push(hashtagData);
        }
      });

      return {
        commonPrefix: commonPrefix,
        hashtags: hashtags
      };
    }

    /**
     * 割引情報設定を収集
     */
    function collectDiscountConfig() {
      const config = {};

      // タイトルを収集
      const select = document.getElementById('割引情報タイトル選択');
      const customInput = document.getElementById('割引情報タイトルカスタム');
      if (select) {
        if (select.value === 'custom') {
          config['タイトル'] = customInput?.value || '';
          config['タイトル選択'] = 'custom';
        } else {
          config['タイトル'] = select.value;
          config['タイトル選択'] = select.value;
        }
      }

      // 現在表示されている全ての割引タイプを収集
      const typesList = document.getElementById('discountTypesList');
      const discountGroups = typesList?.querySelectorAll('.discount-group') || [];
      const discountTypes = [];

      discountGroups.forEach(group => {
        const typeName = group.id.replace('Group', '');
        discountTypes.push(typeName);

        // アイコンを取得
        const iconElement = group.querySelector('strong');
        const iconText = iconElement?.textContent || '';
        const icon = iconText.split(' ')[0] || '💰'; // アイコン部分を抽出
        config[`${typeName}_アイコン`] = icon;

        // 範囲を収集
        config[typeName] = [];
        const container = document.getElementById(`${typeName}Container`);
        if (container) {
          Array.from(container.children).forEach(item => {
            const range = item.querySelector('[data-field="range"]')?.value || '';
            const amount = item.querySelector('[data-field="amount"]')?.value || '';
            if (range || amount) {
              config[typeName].push({ 範囲: range, 割引額: amount });
            }
          });
        }

        // 説明文を収集
        const descField = document.getElementById(`${typeName}_説明文`);
        if (descField) {
          config[`${typeName}_説明文`] = descField.value;
        }
      });

      // 割引タイプの順序を保存
      config['割引タイプ順序'] = discountTypes;

      return config;
    }

    /**
     * テキストエリアを自動リサイズ
     */
    function autoResizeTextarea(textarea) {
      // 高さをリセット
      textarea.style.height = 'auto';
      // スクロール高さに合わせる
      textarea.style.height = textarea.scrollHeight + 'px';
    }

    /**
     * 配送デフォルト設定を収集
     */
    function collectShippingDefaults() {
      return {
        配送料の負担: document.getElementById('配送料の負担').value,
        配送の方法: document.getElementById('配送の方法').value,
        発送元の地域: document.getElementById('発送元の地域').value,
        発送までの日数: document.getElementById('発送までの日数').value
      };
    }

    /**
     * 管理番号設定を収集
     */
    function collectManagementConfig() {
      // 新しい管理番号ビルダーからデータを取得
      try {
        if (typeof ManagementNumberBuilder !== 'undefined' && ManagementNumberBuilder) {
          const data = ManagementNumberBuilder.getData();
          console.log('ManagementNumberBuilderからデータ取得:', data);
          return data;
        } else {
          console.warn('ManagementNumberBuilderが未定義です');
          return { segments: [] };
        }
      } catch (e) {
        console.error('collectManagementConfig エラー:', e);
        return { segments: [] };
      }
    }

    // ========================================
    // セールスワード設定
    // ========================================

    let SALESWORD_LIST = [];

    /**
     * セールスワードリストを表示（読み取り専用 + 削除ボタン）
     */
    function renderSaleswordList() {
      const container = document.getElementById('saleswordList');
      if (!container) return;

      container.innerHTML = '';

      // SALESWORD_LISTが配列であることを保証
      if (!Array.isArray(SALESWORD_LIST)) {
        console.warn('SALESWORD_LISTが配列ではありません。空配列に初期化します。', SALESWORD_LIST);
        SALESWORD_LIST = [];
      }

      if (SALESWORD_LIST.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 16px; font-size: 13px;">登録されているセールスワードはありません</div>';
        return;
      }

      SALESWORD_LIST.forEach((word, index) => {
        const item = document.createElement('div');
        item.style.display = 'flex';
        item.style.alignItems = 'center';
        item.style.gap = '8px';
        item.style.padding = '8px';
        item.style.background = 'white';
        item.style.border = '1px solid #e5e7eb';
        item.style.borderRadius = '6px';
        item.style.marginBottom = '8px';

        item.innerHTML = `
          <span style="color: #6c757d; font-size: 12px; min-width: 30px;">${index + 1}.</span>
          <span style="flex: 1; font-size: 13px; color: #374151;">${word}</span>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSalesword(${index})" style="font-size: 11px; padding: 4px 12px;">削除</button>
        `;

        container.appendChild(item);
      });
    }

    /**
     * セールスワードを削除
     */
    function removeSalesword(index) {
      SALESWORD_LIST.splice(index, 1);
      renderSaleswordList();
    }

    /**
     * セールスワードマスタデータ（グローバル変数）
     */
    let SALESWORD_MASTER = {};

    /**
     * セールスワードマスタデータを読み込み
     */
    function loadSaleswordMasterData() {
      google.script.run
        .withSuccessHandler(function(data) {
          SALESWORD_MASTER = data;
          initSaleswordDropdowns();
        })
        .withFailureHandler(function(error) {
          console.error('セールスワードマスタデータ取得エラー:', error);
        })
        .getSaleswordHierarchy();
    }

    /**
     * 2段式プルダウンを初期化
     */
    function initSaleswordDropdowns() {
      const categorySelect = document.getElementById('saleswordCategorySelect');
      if (!categorySelect || !SALESWORD_MASTER) return;

      categorySelect.innerHTML = '<option value="">--選択--</option>';

      Object.keys(SALESWORD_MASTER).sort().forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
      });
    }

    /**
     * カテゴリ選択時にセールスワードプルダウンを更新
     */
    function updateSaleswordOptions() {
      const categorySelect = document.getElementById('saleswordCategorySelect');
      const saleswordSelect = document.getElementById('saleswordSelect');

      if (!categorySelect || !saleswordSelect) return;

      const category = categorySelect.value;
      saleswordSelect.innerHTML = '<option value="">--選択--</option>';

      if (!category || !SALESWORD_MASTER[category]) {
        saleswordSelect.disabled = true;
        return;
      }

      SALESWORD_MASTER[category].forEach(word => {
        const option = document.createElement('option');
        option.value = word;
        option.textContent = word;
        saleswordSelect.appendChild(option);
      });

      saleswordSelect.disabled = false;
    }

    /**
     * プルダウンからセールスワードを追加
     */
    function addSaleswordFromDropdown() {
      const saleswordSelect = document.getElementById('saleswordSelect');
      if (!saleswordSelect) return;

      const word = saleswordSelect.value.trim();
      if (!word) {
        alert('セールスワードを選択してください');
        return;
      }

      // 重複チェック
      if (SALESWORD_LIST.includes(word)) {
        alert('このセールスワードは既に登録されています');
        return;
      }

      SALESWORD_LIST.push(word);  // 配列の末尾に追加（追加した順に表示される）
      renderSaleswordList();

      // プルダウンをリセット
      document.getElementById('saleswordCategorySelect').value = '';
      saleswordSelect.value = '';
      saleswordSelect.disabled = true;
    }

    /**
     * セールスワード設定を収集
     */
    function collectSaleswordConfig() {
      // SALESWORD_LISTが配列であることを保証
      const saleswordList = Array.isArray(SALESWORD_LIST) ? SALESWORD_LIST : [];

      const result = {
        よく使う: saleswordList.filter(word => word.trim() !== ''),
        表示形式: collectSaleswordFormat()
      };
      console.log('collectSaleswordConfig 結果:', result);
      return result;
    }

    // ========================================
    // セールスワード表示形式設定
    // ========================================

    let WORD_OVERRIDES = [];

    /**
     * 前に付ける文字のプルダウン変更時
     */
    function handlePrefixChange() {
      const select = document.getElementById('saleswordPrefixGlobalSelect');
      const customInput = document.getElementById('saleswordPrefixGlobalCustom');

      if (select.value === 'custom') {
        customInput.style.display = 'block';
      } else {
        customInput.style.display = 'none';
        customInput.value = '';
      }

      updateSaleswordFormatPreview();
    }

    /**
     * 後ろに付ける文字のプルダウン変更時
     */
    function handleSuffixChange() {
      const select = document.getElementById('saleswordSuffixGlobalSelect');
      const customInput = document.getElementById('saleswordSuffixGlobalCustom');

      if (select.value === 'custom') {
        customInput.style.display = 'block';
      } else {
        customInput.style.display = 'none';
        customInput.value = '';
      }

      updateSaleswordFormatPreview();
    }

    /**
     * プレビューを更新
     */
    function updateSaleswordFormatPreview() {
      const prefixSelect = document.getElementById('saleswordPrefixGlobalSelect');
      const prefixCustom = document.getElementById('saleswordPrefixGlobalCustom');
      const suffixSelect = document.getElementById('saleswordSuffixGlobalSelect');
      const suffixCustom = document.getElementById('saleswordSuffixGlobalCustom');

      let prefix = '';
      let suffix = '';

      if (prefixSelect.value === 'custom') {
        prefix = prefixCustom.value || '';
      } else {
        prefix = prefixSelect.value || '';
      }

      if (suffixSelect.value === 'custom') {
        suffix = suffixCustom.value || '';
      } else {
        suffix = suffixSelect.value || '';
      }

      const preview = document.getElementById('saleswordFormatPreview');
      if (preview) {
        preview.textContent = `${prefix}美品${suffix}`;
      }
    }

    /**
     * ワード別設定を追加
     */
    function addWordOverride() {
      WORD_OVERRIDES.push({
        word: '',
        prefix: '',
        suffix: ''
      });
      renderWordOverrides();
    }

    /**
     * ワード別設定を削除
     */
    function removeWordOverride(index) {
      WORD_OVERRIDES.splice(index, 1);
      renderWordOverrides();
    }

    /**
     * ワード別設定を更新
     */
    function updateWordOverride(index, field, value) {
      WORD_OVERRIDES[index][field] = value;
    }

    /**
     * ワード別設定の前に付ける文字プルダウン変更時
     */
    function handleWordPrefixChange(index) {
      const select = document.getElementById(`wordPrefixSelect_${index}`);
      const customInput = document.getElementById(`wordPrefixCustom_${index}`);

      if (select.value === 'custom') {
        customInput.style.display = 'block';
      } else {
        customInput.style.display = 'none';
        customInput.value = '';
      }

      updateWordOverrideFromInput(index);
    }

    /**
     * ワード別設定の後ろに付ける文字プルダウン変更時
     */
    function handleWordSuffixChange(index) {
      const select = document.getElementById(`wordSuffixSelect_${index}`);
      const customInput = document.getElementById(`wordSuffixCustom_${index}`);

      if (select.value === 'custom') {
        customInput.style.display = 'block';
      } else {
        customInput.style.display = 'none';
        customInput.value = '';
      }

      updateWordOverrideFromInput(index);
    }

    /**
     * ワード別設定の入力フィールドから値を更新
     */
    function updateWordOverrideFromInput(index) {
      const prefixSelect = document.getElementById(`wordPrefixSelect_${index}`);
      const prefixCustom = document.getElementById(`wordPrefixCustom_${index}`);
      const suffixSelect = document.getElementById(`wordSuffixSelect_${index}`);
      const suffixCustom = document.getElementById(`wordSuffixCustom_${index}`);

      let prefix = '';
      let suffix = '';

      if (prefixSelect && prefixSelect.value === 'custom') {
        prefix = prefixCustom ? (prefixCustom.value || '').trim() : '';
      } else if (prefixSelect) {
        prefix = (prefixSelect.value || '').trim();
      }

      if (suffixSelect && suffixSelect.value === 'custom') {
        suffix = suffixCustom ? (suffixCustom.value || '').trim() : '';
      } else if (suffixSelect) {
        suffix = (suffixSelect.value || '').trim();
      }

      WORD_OVERRIDES[index].prefix = prefix;
      WORD_OVERRIDES[index].suffix = suffix;
    }

    /**
     * ワード別設定をレンダリング
     */
    function renderWordOverrides() {
      const container = document.getElementById('wordOverrideList');
      if (!container) return;

      container.innerHTML = '';

      WORD_OVERRIDES.forEach((override, index) => {
        const item = document.createElement('div');
        item.style.background = '#f8f9fa';
        item.style.padding = '12px';
        item.style.borderRadius = '6px';
        item.style.marginBottom = '8px';
        item.style.border = '1px solid #dee2e6';

        // プルダウンの選択肢を作成（前と後ろで分ける）
        const prefixSelectOptions = `
          <option value="">なし</option>
          <option value="【">【</option>
          <option value="『">『</option>
          <option value="「">「</option>
          <option value="（">（</option>
          <option value="★">★</option>
          <option value="☆">☆</option>
          <option value="◆">◆</option>
          <option value="●">●</option>
          <option value="■">■</option>
          <option value="♡">♡</option>
          <option value="✨">✨</option>
          <option value="※">※</option>
          <option value="custom">カスタム入力</option>
        `;

        const suffixSelectOptions = `
          <option value="">なし</option>
          <option value="】">】</option>
          <option value="』">』</option>
          <option value="」">」</option>
          <option value="）">）</option>
          <option value="！">！</option>
          <option value="★">★</option>
          <option value="☆">☆</option>
          <option value="◆">◆</option>
          <option value="●">●</option>
          <option value="■">■</option>
          <option value="♡">♡</option>
          <option value="✨">✨</option>
          <option value="※">※</option>
          <option value="custom">カスタム入力</option>
        `;

        // 前に付ける文字の初期値を判定
        const prefixValue = override.prefix || '';
        const prefixIsCustom = prefixValue && !['', '【', '『', '「', '（', '★', '☆', '◆', '●', '■', '♡', '✨', '※'].includes(prefixValue);
        const prefixSelectValue = prefixIsCustom ? 'custom' : prefixValue;

        // 後ろに付ける文字の初期値を判定
        const suffixValue = override.suffix || '';
        const suffixIsCustom = suffixValue && !['', '】', '』', '」', '）', '！', '★', '☆', '◆', '●', '■', '♡', '✨', '※'].includes(suffixValue);
        const suffixSelectValue = suffixIsCustom ? 'custom' : suffixValue;

        item.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span style="font-size: 13px; font-weight: 500;">設定 ${index + 1}</span>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeWordOverride(${index})">削除</button>
          </div>
          <div style="margin-bottom: 8px;">
            <label style="font-size: 12px; margin-bottom: 4px; display: block;">セールスワード</label>
            <input type="text" class="form-control form-control-sm" value="${override.word || ''}"
                   onchange="updateWordOverride(${index}, 'word', this.value)"
                   placeholder="例: 匿名配送">
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <div>
              <label style="font-size: 12px; margin-bottom: 4px; display: block;">前に付ける文字</label>
              <select id="wordPrefixSelect_${index}" class="form-select form-select-sm" onchange="handleWordPrefixChange(${index})" style="margin-bottom: 4px;">
                ${prefixSelectOptions}
              </select>
              <input type="text" id="wordPrefixCustom_${index}" class="form-control form-control-sm"
                     value="${prefixIsCustom ? prefixValue : ''}"
                     onchange="updateWordOverrideFromInput(${index})"
                     placeholder="カスタム入力" maxlength="5"
                     style="display: ${prefixIsCustom ? 'block' : 'none'};">
            </div>
            <div>
              <label style="font-size: 12px; margin-bottom: 4px; display: block;">後ろに付ける文字</label>
              <select id="wordSuffixSelect_${index}" class="form-select form-select-sm" onchange="handleWordSuffixChange(${index})" style="margin-bottom: 4px;">
                ${suffixSelectOptions}
              </select>
              <input type="text" id="wordSuffixCustom_${index}" class="form-control form-control-sm"
                     value="${suffixIsCustom ? suffixValue : ''}"
                     onchange="updateWordOverrideFromInput(${index})"
                     placeholder="カスタム入力" maxlength="5"
                     style="display: ${suffixIsCustom ? 'block' : 'none'};">
            </div>
          </div>
        `;

        container.appendChild(item);

        // プルダウンの値を設定
        const prefixSelect = document.getElementById(`wordPrefixSelect_${index}`);
        const suffixSelect = document.getElementById(`wordSuffixSelect_${index}`);
        if (prefixSelect) prefixSelect.value = prefixSelectValue;
        if (suffixSelect) suffixSelect.value = suffixSelectValue;
      });
    }

    /**
     * セールスワード表示形式設定を収集
     */
    function collectSaleswordFormat() {
      const prefixSelect = document.getElementById('saleswordPrefixGlobalSelect');
      const prefixCustom = document.getElementById('saleswordPrefixGlobalCustom');
      const suffixSelect = document.getElementById('saleswordSuffixGlobalSelect');
      const suffixCustom = document.getElementById('saleswordSuffixGlobalCustom');

      let prefix = '';
      let suffix = '';

      if (prefixSelect && prefixSelect.value === 'custom') {
        prefix = prefixCustom ? (prefixCustom.value || '').trim() : '';
      } else if (prefixSelect) {
        prefix = (prefixSelect.value || '').trim();
      }

      if (suffixSelect && suffixSelect.value === 'custom') {
        suffix = suffixCustom ? (suffixCustom.value || '').trim() : '';
      } else if (suffixSelect) {
        suffix = (suffixSelect.value || '').trim();
      }

      // ワード別設定の最新値を収集
      WORD_OVERRIDES.forEach((override, index) => {
        updateWordOverrideFromInput(index);
      });

      const result = {
        globalPrefix: prefix,
        globalSuffix: suffix,
        wordOverrides: WORD_OVERRIDES.filter(o => o.word.trim() !== '')
      };

      console.log('collectSaleswordFormat 結果:', result);
      return result;
    }

    /**
     * セールスワード表示形式設定を読み込み
     */
    function renderSaleswordFormat(config) {
      console.log('renderSaleswordFormat 受信データ:', config);

      if (!config) config = { globalPrefix: '【', globalSuffix: '】', wordOverrides: [] };

      // 旧データ（categoryOverrides）から新データ（wordOverrides）への変換
      if (config.categoryOverrides && !config.wordOverrides) {
        config.wordOverrides = [];
      }

      const prefixSelect = document.getElementById('saleswordPrefixGlobalSelect');
      const prefixCustom = document.getElementById('saleswordPrefixGlobalCustom');
      const suffixSelect = document.getElementById('saleswordSuffixGlobalSelect');
      const suffixCustom = document.getElementById('saleswordSuffixGlobalCustom');

      console.log('prefix設定値:', config.globalPrefix, 'suffix設定値:', config.globalSuffix);

      // 前に付ける文字を設定
      const prefix = config.globalPrefix || '【';
      const prefixOption = Array.from(prefixSelect.options).find(opt => opt.value === prefix);

      console.log('prefix:', prefix, 'prefixOption:', prefixOption);

      if (prefixOption && prefix !== '') {
        prefixSelect.value = prefix;
        prefixCustom.style.display = 'none';
        prefixCustom.value = '';
        console.log('prefixをプルダウンに設定:', prefix);
      } else if (prefix === '') {
        prefixSelect.value = '';
        prefixCustom.style.display = 'none';
        prefixCustom.value = '';
        console.log('prefixを空に設定');
      } else {
        prefixSelect.value = 'custom';
        prefixCustom.style.display = 'block';
        prefixCustom.value = prefix;
        console.log('prefixをカスタム入力に設定:', prefix);
      }

      // 後ろに付ける文字を設定
      const suffix = config.globalSuffix || '】';
      const suffixOption = Array.from(suffixSelect.options).find(opt => opt.value === suffix);

      console.log('suffix:', suffix, 'suffixOption:', suffixOption);

      if (suffixOption && suffix !== '') {
        suffixSelect.value = suffix;
        suffixCustom.style.display = 'none';
        suffixCustom.value = '';
        console.log('suffixをプルダウンに設定:', suffix);
      } else if (suffix === '') {
        suffixSelect.value = '';
        suffixCustom.style.display = 'none';
        suffixCustom.value = '';
        console.log('suffixを空に設定');
      } else {
        suffixSelect.value = 'custom';
        suffixCustom.style.display = 'block';
        suffixCustom.value = suffix;
        console.log('suffixをカスタム入力に設定:', suffix);
      }

      // ワード別設定
      WORD_OVERRIDES = config.wordOverrides || [];
      renderWordOverrides();

      // プレビュー更新
      updateSaleswordFormatPreview();
    }

    /**
     * セールスワード設定を読み込み
     */
    function loadSaleswordConfig() {
      if (google && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function(config) {
            console.log('セールスワード設定を読み込みました:', config);
            if (config && config.よく使うセールスワード) {
              // 新しい構造（よく使う + 表示形式）に対応
              if (typeof config.よく使うセールスワード === 'object' && config.よく使うセールスワード.よく使う) {
                SALESWORD_LIST = config.よく使うセールスワード.よく使う || [];
                renderSaleswordList();
                renderSaleswordFormat(config.よく使うセールスワード.表示形式 || {});
              } else if (Array.isArray(config.よく使うセールスワード)) {
                // 旧形式（配列のみ）に対応
                SALESWORD_LIST = config.よく使うセールスワード;
                renderSaleswordList();
                renderSaleswordFormat({ globalPrefix: '【', globalSuffix: '】', wordOverrides: [] });
              } else {
                // 空オブジェクトの場合はデフォルト値を使用
                console.log('よく使うセールスワードが空です。デフォルト値を使用します。');
                SALESWORD_LIST = [];
                renderSaleswordList();
                renderSaleswordFormat({ globalPrefix: '【', globalSuffix: '】', wordOverrides: [] });
              }
            }
          })
          .withFailureHandler(function(error) {
            console.error('セールスワード設定読み込みエラー:', error);
          })
          .loadConfigMaster();
      }
    }

    /**
     * セールスワード設定をすべてクリア
     */
    function clearAllSaleswordSettings() {
      if (!confirm('セールスワード設定をすべてクリアしますか？\n\n・グローバル設定がデフォルト値（【】）に戻ります\n・ワード別設定がすべて削除されます')) {
        return;
      }

      // グローバル設定をデフォルト値に戻す
      const prefixSelect = document.getElementById('saleswordPrefixGlobalSelect');
      const prefixCustom = document.getElementById('saleswordPrefixGlobalCustom');
      const suffixSelect = document.getElementById('saleswordSuffixGlobalSelect');
      const suffixCustom = document.getElementById('saleswordSuffixGlobalCustom');

      if (prefixSelect) {
        prefixSelect.value = '【';
        prefixCustom.style.display = 'none';
        prefixCustom.value = '';
      }

      if (suffixSelect) {
        suffixSelect.value = '】';
        suffixCustom.style.display = 'none';
        suffixCustom.value = '';
      }

      // ワード別設定をすべて削除
      WORD_OVERRIDES = [];
      renderWordOverrides();

      // プレビュー更新
      updateSaleswordFormatPreview();

      console.log('セールスワード設定をクリアしました');
    }

    // ========================================
    // 仕入・出品デフォルト設定
    // ========================================

    /**
     * 仕入・出品のプルダウンを初期化（マスタデータから取得）
     */
    function initProcureListingDropdowns() {
      if (google && google.script && google.script.run) {
        // 仕入先を取得
        google.script.run
          .withSuccessHandler(function(options) {
            const select = document.getElementById('デフォルト仕入先');
            if (select && options) {
              select.innerHTML = '<option value="">-- 選択してください --</option>';
              options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
              });

              // プルダウン初期化後、現在の設定値を適用
              if (currentConfig && currentConfig.仕入出品デフォルト) {
                const defaultValue = currentConfig.仕入出品デフォルト.デフォルト仕入先;
                if (defaultValue) {
                  select.value = defaultValue;
                }
              }
            }
          })
          .withFailureHandler(function(error) {
            console.error('仕入先データ取得エラー:', error);
          })
          .getMasterData('仕入先');

        // 出品先を取得
        google.script.run
          .withSuccessHandler(function(options) {
            const select = document.getElementById('デフォルト出品先');
            if (select && options) {
              select.innerHTML = '<option value="">-- 選択してください --</option>';
              options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
              });

              // プルダウン初期化後、現在の設定値を適用
              if (currentConfig && currentConfig.仕入出品デフォルト) {
                const defaultValue = currentConfig.仕入出品デフォルト.デフォルト出品先;
                if (defaultValue) {
                  select.value = defaultValue;
                }
              }
            }
          })
          .withFailureHandler(function(error) {
            console.error('出品先データ取得エラー:', error);
          })
          .getMasterData('出品先');
      }
    }

    /**
     * 仕入日の「常に今日」チェックボックス切り替え時の処理
     */
    function toggleProcureDateField() {
      const checkbox = document.getElementById('仕入日_今日');
      const dateField = document.getElementById('デフォルト仕入日');
      if (checkbox && dateField) {
        dateField.disabled = checkbox.checked;
        if (checkbox.checked) {
          dateField.style.background = '#f3f4f6';
          dateField.style.cursor = 'not-allowed';
        } else {
          dateField.style.background = 'white';
          dateField.style.cursor = 'pointer';
        }
      }
    }

    /**
     * 出品日の「常に今日」チェックボックス切り替え時の処理
     */
    function toggleListingDateField() {
      const checkbox = document.getElementById('出品日_今日');
      const dateField = document.getElementById('デフォルト出品日');
      if (checkbox && dateField) {
        dateField.disabled = checkbox.checked;
        if (checkbox.checked) {
          dateField.style.background = '#f3f4f6';
          dateField.style.cursor = 'not-allowed';
        } else {
          dateField.style.background = 'white';
          dateField.style.cursor = 'pointer';
        }
      }
    }

    /**
     * 仕入・出品デフォルト設定を表示
     */
    function renderProcureListingDefaults(config) {
      console.log('仕入・出品デフォルト設定を表示:', config);

      // 仕入日_今日チェックボックス
      const procureTodayCheckbox = document.getElementById('仕入日_今日');
      if (procureTodayCheckbox) {
        procureTodayCheckbox.checked = config.仕入日_今日 === true;
      }

      // デフォルト仕入日
      const procureDate = document.getElementById('デフォルト仕入日');
      if (procureDate) {
        procureDate.value = config.デフォルト仕入日 || '';
      }

      // デフォルト仕入先
      const procureSource = document.getElementById('デフォルト仕入先');
      if (procureSource) {
        procureSource.value = config.デフォルト仕入先 || '';
      }

      // 出品日_今日チェックボックス
      const listingTodayCheckbox = document.getElementById('出品日_今日');
      if (listingTodayCheckbox) {
        listingTodayCheckbox.checked = config.出品日_今日 === true;
      }

      // デフォルト出品日
      const listingDate = document.getElementById('デフォルト出品日');
      if (listingDate) {
        listingDate.value = config.デフォルト出品日 || '';
      }

      // デフォルト出品先
      const listingDest = document.getElementById('デフォルト出品先');
      if (listingDest) {
        listingDest.value = config.デフォルト出品先 || '';
      }

      // チェックボックスの状態に応じて日付フィールドを無効化
      toggleProcureDateField();
      toggleListingDateField();
    }

    /**
     * 仕入・出品デフォルト設定を収集
     */
    function collectProcureListingDefaults() {
      const result = {
        仕入日_今日: document.getElementById('仕入日_今日')?.checked || false,
        デフォルト仕入日: document.getElementById('デフォルト仕入日')?.value || '',
        デフォルト仕入先: document.getElementById('デフォルト仕入先')?.value || '',
        出品日_今日: document.getElementById('出品日_今日')?.checked || false,
        デフォルト出品日: document.getElementById('デフォルト出品日')?.value || '',
        デフォルト出品先: document.getElementById('デフォルト出品先')?.value || ''
      };
      console.log('仕入・出品デフォルト設定を収集:', result);
      return result;
    }

    /**
     * 仕入・出品デフォルト設定をすべてクリア
     */
    function clearProcureListingDefaults() {
      if (!confirm('仕入・出品デフォルト設定をすべてクリアしますか？')) {
        return;
      }

      document.getElementById('仕入日_今日').checked = false;
      document.getElementById('デフォルト仕入日').value = '';
      document.getElementById('デフォルト仕入先').value = '';
      document.getElementById('出品日_今日').checked = false;
      document.getElementById('デフォルト出品日').value = '';
      document.getElementById('デフォルト出品先').value = '';

      // チェックボックスをクリアしたので日付フィールドを有効化
      toggleProcureDateField();
      toggleListingDateField();

      alert('仕入・出品デフォルト設定をクリアしました。\n変更を保存するには「設定を保存」ボタンをクリックしてください。');
    }
  </script>
</body>
</html>
