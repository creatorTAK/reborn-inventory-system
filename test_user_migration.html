<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ç®¡ç† - Phase 1 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body {
      padding: 20px;
      background-color: #f8f9fa;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .log-output {
      background-color: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .log-success { color: #4ec9b0; }
    .log-error { color: #f48771; }
    .log-info { color: #9cdcfe; }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h2>
    <p class="text-muted">Phase 1: FCMé€šçŸ¥ç™»éŒ²ã‚·ãƒ¼ãƒˆã«æ¨©é™ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã—ã€åˆæœŸæ¨©é™ã‚’è¨­å®š</p>

    <hr>

    <div class="mb-4">
      <h5>Phase 1 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h5>
      <p class="small text-muted">
        1. æ¨©é™ã‚«ãƒ©ãƒ ï¼ˆLåˆ—ï¼‰ã‚’è¿½åŠ <br>
        2. å‚™è€ƒã‚«ãƒ©ãƒ ï¼ˆMåˆ—ï¼‰ã‚’è¿½åŠ <br>
        3. ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒªã‚¹ãƒˆï¼ˆã‚ªãƒ¼ãƒŠãƒ¼/ã‚¹ã‚¿ãƒƒãƒ•/å¤–æ³¨ï¼‰ã‚’è¨­å®š<br>
        4. å®‰å»£æ‹“å¿—ã‚’ã‚ªãƒ¼ãƒŠãƒ¼ã«è¨­å®š<br>
        5. ãã®ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚¹ã‚¿ãƒƒãƒ•ã«è¨­å®š
      </p>
      <button id="btnMigrate" class="btn btn-primary">Phase 1 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ</button>
    </div>

    <hr>

    <div class="mb-4">
      <h5>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ç¢ºèª</h5>
      <button id="btnGetUsers" class="btn btn-secondary">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—</button>
      <div id="userListOutput" class="mt-3"></div>
    </div>

    <hr>

    <div class="mb-4">
      <h5>Phase 4: å‚™å“åœ¨åº«ãƒªã‚¹ãƒˆã«æ‹…å½“è€…ã‚«ãƒ©ãƒ è¿½åŠ </h5>
      <p class="small text-muted">
        å‚™å“åœ¨åº«ãƒªã‚¹ãƒˆï¼ˆMåˆ—ï¼‰ã«æ‹…å½“è€…ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã—ã€ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’è¨­å®šã—ã¾ã™ã€‚
      </p>
      <button id="btnPhase4" class="btn btn-success">Phase 4 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ</button>
    </div>

    <div class="log-output" id="logOutput"></div>
  </div>

  <script>
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbx6ybbRLDqKQJ8IR-NPoVP8981Gtozzz0N3880XanEGRS4--iZtset8PFrVcD_u9YAHMA/exec';

    // ãƒ­ã‚°å‡ºåŠ›é–¢æ•°
    function log(message, type = 'info') {
      const output = document.getElementById('logOutput');
      const timestamp = new Date().toLocaleTimeString('ja-JP');
      const className = type === 'success' ? 'log-success' : type === 'error' ? 'log-error' : 'log-info';
      output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      output.scrollTop = output.scrollHeight;
    }

    // Phase 1 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
    document.getElementById('btnMigrate').addEventListener('click', async function() {
      const btn = this;
      btn.disabled = true;
      btn.textContent = 'å®Ÿè¡Œä¸­...';

      log('=== Phase 1 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ ===', 'info');

      try {
        const url = `${GAS_API_URL}?action=executePhase1Migration`;
        log(`ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡: ${url}`, 'info');

        const response = await fetch(url);
        const result = await response.json();

        log(`ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡: ${JSON.stringify(result)}`, 'info');

        if (result.success) {
          log('âœ… ' + result.message, 'success');

          if (result.migration) {
            log(`ã‚«ãƒ©ãƒ è¿½åŠ : ${result.migration.message}`, 'success');
          }

          if (result.permissions) {
            log(`æ¨©é™è¨­å®š: ${result.permissions.message}`, 'success');
          }

          log(`ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${result.userCount}äºº`, 'info');
          log('=== Phase 1 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº† ===', 'success');

          // è‡ªå‹•çš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—
          setTimeout(() => {
            document.getElementById('btnGetUsers').click();
          }, 500);
        } else {
          log('âŒ ' + result.message, 'error');
        }
      } catch (error) {
        log('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        console.error(error);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Phase 1 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ';
      }
    });

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—
    document.getElementById('btnGetUsers').addEventListener('click', async function() {
      const btn = this;
      btn.disabled = true;
      btn.textContent = 'å–å¾—ä¸­...';

      log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—ä¸­...', 'info');

      try {
        const url = `${GAS_API_URL}?action=getUserList`;
        const response = await fetch(url);
        const result = await response.json();

        if (result.success && result.users) {
          log(`âœ… ${result.users.length}äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã—ã¾ã—ãŸ`, 'success');

          // ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
          let tableHTML = `
            <table class="table table-striped table-sm">
              <thead>
                <tr>
                  <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                  <th>æ¨©é™</th>
                  <th>ãƒ¡ãƒ¼ãƒ«</th>
                  <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                  <th>ç™»éŒ²æ—¥æ™‚</th>
                </tr>
              </thead>
              <tbody>
          `;

          result.users.forEach(user => {
            const permissionBadge =
              user.permission === 'ã‚ªãƒ¼ãƒŠãƒ¼' ? 'badge bg-danger' :
              user.permission === 'ã‚¹ã‚¿ãƒƒãƒ•' ? 'badge bg-primary' :
              user.permission === 'å¤–æ³¨' ? 'badge bg-secondary' : 'badge bg-light';

            tableHTML += `
              <tr>
                <td><strong>${user.userName || ''}</strong></td>
                <td><span class="${permissionBadge}">${user.permission || 'æœªè¨­å®š'}</span></td>
                <td class="small text-muted">${user.email || ''}</td>
                <td class="small">${user.status || ''}</td>
                <td class="small text-muted">${user.registeredAt || ''}</td>
              </tr>
            `;

            log(`  - ${user.userName}: ${user.permission || 'æœªè¨­å®š'} (${user.email})`, 'info');
          });

          tableHTML += '</tbody></table>';
          document.getElementById('userListOutput').innerHTML = tableHTML;
        } else {
          log('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
      } catch (error) {
        log('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        console.error(error);
      } finally {
        btn.disabled = false;
        btn.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—';
      }
    });

    // Phase 4 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
    document.getElementById('btnPhase4').addEventListener('click', async function() {
      const btn = this;
      btn.disabled = true;
      btn.textContent = 'å®Ÿè¡Œä¸­...';

      log('=== Phase 4 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ ===', 'info');

      try {
        const url = `${GAS_API_URL}?action=migrateAddManagerColumn`;
        log(`ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡: ${url}`, 'info');

        const response = await fetch(url);
        const result = await response.json();

        log(`ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡: ${JSON.stringify(result)}`, 'info');

        if (result.success) {
          if (result.alreadyExists) {
            log('âœ… ' + result.message + 'ï¼ˆæ—¢ã«è¿½åŠ æ¸ˆã¿ï¼‰', 'info');
          } else {
            log('âœ… ' + result.message, 'success');
            log('å‚™å“åœ¨åº«ãƒªã‚¹ãƒˆã®Måˆ—ã«ã€Œæ‹…å½“è€…ã€ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
            log('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒªã‚¹ãƒˆã‚’è¨­å®šã—ã¾ã—ãŸ', 'success');
          }
          log('=== Phase 4 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº† ===', 'success');
        } else {
          log('âŒ ' + result.message, 'error');
        }
      } catch (error) {
        log('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        console.error(error);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Phase 4 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ';
      }
    });

    // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ­ã‚°ã‚’è¡¨ç¤º
    log('ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’èµ·å‹•ã—ã¾ã—ãŸ', 'success');
    log('Phase 1 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æº–å‚™ãŒã§ãã¾ã—ãŸ', 'info');
    log('Phase 4 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æº–å‚™ãŒã§ãã¾ã—ãŸ', 'info');
  </script>
</body>
</html>
