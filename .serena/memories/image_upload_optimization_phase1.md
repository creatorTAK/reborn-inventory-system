# 画像アップロード最適化 Phase 1 実装記録

## 実施日：2025年10月22日

## 実施した最適化内容

### 1. 画像リサイズの強化
**変更箇所**: `sp_scripts.html` (resizeImage関数)

**変更内容**:
- 横幅: 1200px → 800px
- JPEG品質: 80% → 70%

**効果**: ファイルサイズ約50%削減（400KB → 150-200KB）

### 2. サーバー側の不要処理削除
**変更箇所**: `image_upload.js`

**削除した処理**:
```javascript
// 削除: Logger.log（画像アップロード成功）
// 削除: Logger.log（画像アップロードエラー）
// 削除: uploadedAt（タイムスタンプ生成）
```

**効果**: 処理時間短縮

### 3. クライアント側の不要処理削除
**変更箇所**: `sp_scripts.html`

**削除した処理**:
```javascript
// 削除: console.log（画像リサイズログ）
// 削除: debug.log（商品画像アップロード）
```

### 4. フォルダ名のシンプル化
**変更箇所**: `image_upload.js` (getOrCreateProductFolder_関数)

**変更内容**:
- 変更前: `商品_AA-1013_1761117039815`
- 変更後: `AA-1013`
- 重複時: `AA-1013_2`, `AA-1013_3`

**効果**: Google Drive UIでの視認性向上

### 5. 管理番号の柔軟な対応
**変更箇所**: `sp_scripts.html` (collect関数内)

**変更内容**:
```javascript
// 変更前: d['棚番号']（固定）
// 変更後: d['管理番号']（ユーザー設定に対応）
```

**効果**: ユーザーの管理番号設定（棚番号/ブランド/日付など）に対応

### 6. 共有設定の最適化
**変更箇所**: `image_upload.js`

**変更内容**:
- ファイル単位の共有設定 → フォルダレベルの共有設定
- N回のAPI呼び出し → 1回のAPI呼び出し

```javascript
// フォルダ作成時に1回だけ実行
newFolder.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

// ファイルアップロード時は共有設定不要（フォルダの設定を継承）
const file = folder.createFile(blob);
```

**効果**: 処理時間大幅短縮

### 7. 登録完了メッセージの改善
**変更箇所**: 
- `product.js` (メッセージ生成)
- `sp_scripts.html` (表示方法)

**変更内容**:
```javascript
// product.js
// 変更前: `OK: 管理番号='${mgmtKey}' を登録しました ※商品状態(詳細)も保存`
// 変更後: '登録完了しました'

// sp_scripts.html
// 変更前: show(result); // 画面下部にテキスト表示
// 変更後: alert(result); // ポップアップ表示
```

**効果**: UXの向上、完了が明確に

---

## パフォーマンス改善結果

### アップロード速度
- **開始時**: 30秒（3枚）
- **第1段階（共有設定最適化後）**: 20秒
- **第2段階（画像圧縮＋ログ削除後）**: 15-18秒

**総合改善率: 約40%短縮**

### ファイルサイズ
- **変更前**: 1.2-2.6MB/枚
- **変更後**: 150-200KB/枚（平均400KB）

**圧縮率: 約75-85%削減**

### ストレージ容量試算
- 平均ファイルサイズ: 400KB/枚
- 平均5枚/商品: 2MB/商品
- **15GBで約7,500商品保存可能**（圧縮前の5倍）

---

## 変更ファイル一覧

### 修正したファイル
1. `sp_scripts.html`
   - resizeImage関数: 800px、品質70%
   - 不要なログ削除
   - 管理番号の参照修正

2. `image_upload.js`
   - フォルダ名をシンプル化
   - 共有設定をフォルダレベルに移動
   - 不要なLogger.log削除
   - uploadedAtフィールド削除

3. `product.js`
   - 登録完了メッセージをシンプル化
   - 商品状態詳細の追加メッセージ削除

---

## 課題と限界

### 残存する課題
1. **アップロード速度**: 15-18秒は許容範囲ギリギリ
2. **容量制限**: 15GBは将来的に不足する可能性
3. **Base64エンコーディング**: 約33%のオーバーヘッド
4. **GAS制限**: 6分の実行時間、50MBのリクエストサイズ

### Google Driveの根本的な制約
- Base64エンコーディングが必須（GASの制約）
- Drive APIの速度は改善不可
- 1日あたり750GBのアップロード制限
- エンタープライズ向けではない

→ **次のステップ: Cloudflare R2への移行が必要**

---

## 学んだこと

### パフォーマンス最適化の順序
1. ✅ API呼び出し回数の削減（最も効果大）
2. ✅ ファイルサイズの削減
3. ✅ 不要な処理の削除
4. ❌ 基盤技術の制約は改善不可

### Google Drive vs オブジェクトストレージ
- **Drive**: チーム共有に優れるが、APIパフォーマンスは低い
- **R2/S3**: 高速・大容量だが、管理UIは自作が必要
- **ハイブリッド**: 複雑すぎて推奨されない

---

## 次のアクション

Phase 1の最適化は完了。次はCloudflare R2への移行準備。

詳細は `cloudflare_r2_migration_plan` メモリを参照。
