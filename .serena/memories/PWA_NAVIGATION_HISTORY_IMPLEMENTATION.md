# PWA ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ç®¡ç†ã®å®Ÿè£…

## æ¦‚è¦

PWAã§iframeå†…ã«ãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚€æ§‹é€ ã§ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨™æº–å±¥æ­´æ©Ÿèƒ½ãŒä½¿ãˆãªã„ãŸã‚ã€è‡ªå‰ã§å±¥æ­´ç®¡ç†ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

## å•é¡Œã®èƒŒæ™¯

### é€šå¸¸ã®Webã‚µã‚¤ãƒˆ
- ãƒ–ãƒ©ã‚¦ã‚¶ãŒè‡ªå‹•ã§å±¥æ­´ç®¡ç† â†’ é–‹ç™ºè€…ã¯ä½•ã‚‚ã—ãªãã¦OK
- æˆ»ã‚‹ãƒœã‚¿ãƒ³ã§è‡ªç„¶ã«å‰ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã‚Œã‚‹

### PWAï¼ˆiframeæ§‹é€ ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ index.html (è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦)    â”‚  â† ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰è¦‹ã‚‹ã¨ã€Œ1ãƒšãƒ¼ã‚¸ã€
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ iframe (å­ãƒšãƒ¼ã‚¸)      â”‚  â”‚  â† ä¸­èº«ãŒå¤‰ã‚ã£ã¦ã‚‚ãƒ–ãƒ©ã‚¦ã‚¶ã¯
â”‚  â”‚ å•†å“ç™»éŒ²/ãƒãƒ£ãƒƒãƒˆ/etc  â”‚  â”‚     ã€ŒåŒã˜ãƒšãƒ¼ã‚¸ã€ã¨èªè­˜
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
- ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰è¦‹ã‚‹ã¨ã€Œãšã£ã¨åŒã˜1ãƒšãƒ¼ã‚¸ã€
- æ¨™æº–ã®å±¥æ­´æ©Ÿèƒ½ãŒä½¿ãˆãªã„ â†’ è‡ªå‰å®Ÿè£…ãŒå¿…è¦

## æ¡ç”¨ã—ãŸè§£æ±ºç­–ï¼šã‚¹ã‚¿ãƒƒã‚¯æ–¹å¼ï¼ˆæœ€å¤§3ä»¶ï¼‰

### å®Ÿè£…ã‚³ãƒ¼ãƒ‰ï¼ˆindex.htmlï¼‰

```javascript
// ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ç®¡ç†ï¼ˆã‚¹ã‚¿ãƒƒã‚¯æ–¹å¼ï¼šæœ€å¤§3ä»¶ï¼‰
const navHistory = ['home'];  // å±¥æ­´ã‚¹ã‚¿ãƒƒã‚¯

// å±¥æ­´ã«è¿½åŠ ï¼ˆé€²ã‚€æ™‚ï¼‰
function pushHistory(page) {
  // åŒã˜ãƒšãƒ¼ã‚¸ã¸ã®é€£ç¶šé·ç§»ã¯ç„¡è¦–
  if (navHistory[navHistory.length - 1] === page) return;
  
  navHistory.push(page);
  // æœ€å¤§3ä»¶ã«åˆ¶é™
  if (navHistory.length > 3) {
    navHistory.shift();
  }
  console.log('ğŸ“š [å±¥æ­´] push:', page, 'â†’', navHistory);
}

// æˆ»ã‚‹å‡¦ç†
function goBackInHistory() {
  console.log('ğŸ“š [å±¥æ­´] goBackå‘¼ã³å‡ºã— - ç¾åœ¨:', navHistory);
  
  // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‚’å‰Šé™¤
  if (navHistory.length > 1) {
    navHistory.pop();
  }
  
  // 1ã¤å‰ã®ãƒšãƒ¼ã‚¸ã«é·ç§»ï¼ˆãªã‘ã‚Œã°ãƒ›ãƒ¼ãƒ ï¼‰
  const destination = navHistory[navHistory.length - 1] || 'home';
  console.log('ğŸ“š [å±¥æ­´] æˆ»ã‚Šå…ˆ:', destination, 'â†’', navHistory);
  
  navigateToPage(destination, { skipHistory: true, skipSkeleton: true });
}
```

### navigateToPageé–¢æ•°ã§ã®å±¥æ­´ç®¡ç†

```javascript
function navigateToPage(page, options = {}) {
  const skipHistory = options.skipHistory || false;

  // ğŸ“š å±¥æ­´ç®¡ç†ï¼ˆã‚¹ã‚¿ãƒƒã‚¯æ–¹å¼ï¼‰
  if (!skipHistory) {
    pushHistory(page);
  }
  
  // ... iframeèª­ã¿è¾¼ã¿å‡¦ç†
}
```

### ç›´æ¥iframeæ“ä½œã™ã‚‹é–¢æ•°ã§ã®å±¥æ­´ç®¡ç†

`navigateToPage`ã‚’çµŒç”±ã›ãšç›´æ¥iframeã‚’æ“ä½œã™ã‚‹é–¢æ•°ï¼ˆopenChatRooms, openTodoListç­‰ï¼‰ã§ã¯ã€æ˜ç¤ºçš„ã«`pushHistory`ã‚’å‘¼ã¶ï¼š

```javascript
function openChatRooms() {
  // ğŸ“š å±¥æ­´ç®¡ç†ï¼šãƒãƒ£ãƒƒãƒˆã«é·ç§»
  pushHistory('chat');
  
  // ... iframe.srcè¨­å®š
}

function openTodoList() {
  // ğŸ“š å±¥æ­´ç®¡ç†ï¼šTodoã«é·ç§»
  pushHistory('todo');
  
  // ... iframe.srcè¨­å®š
}
```

## å­ãƒšãƒ¼ã‚¸ï¼ˆiframeå†…ï¼‰ã‹ã‚‰ã®æˆ»ã‚‹å®Ÿè£…

### å­ãƒšãƒ¼ã‚¸å´ï¼ˆä¾‹ï¼šproduct-scripts.js, todo_list.htmlï¼‰

```javascript
function goBack() {
  if (window.parent && window.parent !== window) {
    // è¦ªã«ã€Œæˆ»ã‚ŠãŸã„ã€ã¨ã„ã†è¦æ±‚ã‚’é€ã‚‹ï¼ˆè¦ªãŒå±¥æ­´ã‚’è¦‹ã¦åˆ¤æ–­ï¼‰
    window.parent.postMessage({
      type: 'requestBack',
      pmToken: pmToken
    }, parentOrigin);
    console.log('[child] requestBack sent to parent');
  } else {
    history.back();
  }
}
```

### è¦ªãƒšãƒ¼ã‚¸å´ï¼ˆindex.htmlï¼‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ³ãƒ‰ãƒ©

```javascript
// EARLYãƒªã‚¹ãƒŠãƒ¼å†…ã§å‡¦ç†ï¼ˆDOMContentLoadedå‰ã«ç™»éŒ²ï¼‰
if (payload.type === 'requestBack') {
  console.log('[parent] requestBackå‡¦ç†é–‹å§‹');
  
  var tryGoBack = function(attempt) {
    if (typeof goBackInHistory === 'function') {
      goBackInHistory();
    } else if (attempt < 5) {
      setTimeout(function() { tryGoBack(attempt + 1); }, 100);
    } else {
      window.location.href = '/?page=home&t=' + Date.now();
    }
  };
  tryGoBack(0);
  return;
}
```

## é‡è¦ãªæ³¨æ„ç‚¹

### 1. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ³ãƒ‰ãƒ©ã®é‡è¤‡ã«æ³¨æ„

`window.addEventListener('message', ...)` ãŒè¤‡æ•°ç®‡æ‰€ã«ã‚ã‚‹å ´åˆã€åŒã˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ã®ãƒãƒ³ãƒ‰ãƒ©ãŒé‡è¤‡ã™ã‚‹ã¨**é–¢æ•°ãŒè¤‡æ•°å›å‘¼ã°ã‚Œã‚‹**ã€‚

**å•é¡Œä¾‹**ï¼š
- EARLYãƒªã‚¹ãƒŠãƒ¼ã¨MAINãƒªã‚¹ãƒŠãƒ¼ã®ä¸¡æ–¹ã§`requestBack`ã‚’å‡¦ç†
- â†’ `goBackInHistory`ãŒ2å›å‘¼ã°ã‚Œã‚‹
- â†’ å±¥æ­´ãŒ2å›popã•ã‚Œã¦ã—ã¾ã†

**è§£æ±ºç­–**ï¼š1ç®‡æ‰€ã§ã®ã¿å‡¦ç†ã—ã€ä»–ã¯å‰Šé™¤ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ

### 2. skipHistoryã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ä½¿ç”¨

æˆ»ã‚‹æ“ä½œã§`navigateToPage`ã‚’å‘¼ã¶æ™‚ã¯å¿…ãš`skipHistory: true`ã‚’æ¸¡ã™ã€‚
ã•ã‚‚ãªã„ã¨æˆ»ã‚Šå…ˆã®ãƒšãƒ¼ã‚¸ãŒå†åº¦å±¥æ­´ã«è¿½åŠ ã•ã‚Œã¦ã—ã¾ã†ã€‚

### 3. ç›´æ¥iframeæ“ä½œã™ã‚‹é–¢æ•°

`openChatRooms`ã€`openTodoList`ãªã©`navigateToPage`ã‚’çµŒç”±ã—ãªã„é–¢æ•°ã§ã¯ã€æ˜ç¤ºçš„ã«`pushHistory`ã‚’å‘¼ã¶å¿…è¦ãŒã‚ã‚‹ã€‚

## å‹•ä½œç¢ºèªæ¸ˆã¿ãƒ‘ã‚¿ãƒ¼ãƒ³

- âœ… ãƒ›ãƒ¼ãƒ  â†’ å•†å“ç™»éŒ² â†’ æˆ»ã‚‹ â†’ ãƒ›ãƒ¼ãƒ 
- âœ… ãƒ›ãƒ¼ãƒ  â†’ å•†å“ç™»éŒ² â†’ ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆ â†’ æˆ»ã‚‹ â†’ å•†å“ç™»éŒ² â†’ æˆ»ã‚‹ â†’ ãƒ›ãƒ¼ãƒ 
- âœ… ãƒ›ãƒ¼ãƒ  â†’ å•†å“ç™»éŒ² â†’ ãƒãƒ£ãƒƒãƒˆ â†’ æˆ»ã‚‹ â†’ å•†å“ç™»éŒ² â†’ æˆ»ã‚‹ â†’ ãƒ›ãƒ¼ãƒ 
- âœ… ãƒãƒ£ãƒƒãƒˆä¸€è¦§ â†’ ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ  â†’ æˆ»ã‚‹ â†’ ãƒãƒ£ãƒƒãƒˆä¸€è¦§
- âœ… ãƒã‚¤ãƒšãƒ¼ã‚¸ â†’ åŸºæœ¬æƒ…å ± â†’ æˆ»ã‚‹ â†’ ãƒã‚¤ãƒšãƒ¼ã‚¸ â†’ æˆ»ã‚‹ â†’ ãƒ›ãƒ¼ãƒ 

## æ¤œè¨ã—ãŸä»–ã®æ–¹å¼

### 1. ãƒ«ãƒ¼ã‚¿ãƒ¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆReact Router, Vue Routerç­‰ï¼‰
- å¤§è¦æ¨¡ãªæ”¹ä¿®ãŒå¿…è¦
- æ—¢å­˜ã®Vanilla JSæ§‹é€ ã«ã¯ä¸å‘ã

### 2. History API
- ä¸­è¦æ¨¡ã®æ”¹ä¿®ãŒå¿…è¦
- URLã®ãƒãƒƒã‚·ãƒ¥ç®¡ç†ãŒå¿…è¦

### 3. 2å¤‰æ•°æ–¹å¼ï¼ˆpreviousPage / currentPageï¼‰
- æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«
- ã—ã‹ã—ã€Œæˆ»ã£ãŸå¾Œã®ã•ã‚‰ã«1ã¤å‰ã€ãŒç®¡ç†ã§ããªã„
- Aâ†’Bâ†’æˆ»ã‚‹â†’Aâ†’æˆ»ã‚‹â†’??? ã®å•é¡Œ

### 4. ã‚¹ã‚¿ãƒƒã‚¯æ–¹å¼ï¼ˆæ¡ç”¨ï¼‰âœ…
- ã‚·ãƒ³ãƒ—ãƒ«ã‹ã¤å¿…è¦ååˆ†
- ãƒ–ãƒ©ã‚¦ã‚¶ã®æˆ»ã‚‹ãƒœã‚¿ãƒ³ã¨åŒã˜å‹•ä½œ
- æœ€å¤§ä»¶æ•°åˆ¶é™ã§ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã‚‚è‰¯ã„

## å®Ÿè£…æ—¥

2025-12-12 (v237ã€œv244)
