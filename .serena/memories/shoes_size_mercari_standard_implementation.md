# 靴サイズ機能 - メルカリ基準対応実装完了

## 実装日
2025-10-20

## 概要
靴カテゴリ（スニーカーなど）の登録時に、メルカリの基準に準拠した靴サイズ機能を実装しました。性別に応じたサイズ範囲、追加情報入力、リアルタイムプレビュー更新の全機能が完成しました。

## 実装内容

### 1. 性別に応じたサイズ範囲（sp_scripts.html: line 3309-3337）

**機能**: `updateSizeOptions()` 関数
- 中分類が「靴」の場合、大分類（メンズ/レディース）に応じて適切なサイズ範囲を表示
- **メンズ**: 23.5cm以下、24.0cm～30.5cm（0.5cm刻み）、31cm以上
- **レディース**: 20cm以下、20.5cm～27.0cm（0.5cm刻み）、27.5cm以上
- **その他（キッズなど）**: 22.0cm～30.0cm（0.5cm刻み）

### 2. サイズの自動連動（sp_scripts.html: line 4799-4823）

**機能**: `updateSizeDisplay()` 関数内の靴セクション処理
- 基本情報ブロックのサイズプルダウンの選択肢を商品の説明ブロックの「サイズ(表記)_靴」に自動コピー
- 基本情報で選択されているサイズがあれば自動的に反映
- 入力の手間を省き、ミスを防止

**機能**: `syncBasicSizeToDescription()` 関数（line 3369-3386）
- 基本情報のサイズ変更時に商品の説明ブロックのサイズを自動更新
- 同時に `updateDescriptionFromDetail()` を呼び出してプレビューも更新

### 3. 追加情報フィールド（sp_block_description.html: line 167-198）

靴カテゴリ選択時に以下の項目が表示：
- **サイズ(表記)**: 基本情報から自動反映（24.5cm など）
- **その他のサイズ表記**: US8、EU38 などの補足情報（text input）
- **普段のサイズ**: 参考サイズ情報（text input）
- **フィット感・注意点**: サイズ感のアドバイス（textarea）

### 4. 商品の説明プレビューへの反映（sp_scripts.html: line 2437-2512）

**機能**: `getSizeInfo()` 関数を拡張
- `サイズ(表記)_靴`、`その他のサイズ表記_靴`、`普段のサイズ_靴`、`フィット感_靴` を取得
- 靴の場合は以下の形式でプレビューに表示：
  ```
  サイズ(表記)：25.0cm
  その他のサイズ表記：US8, EU38
  普段のサイズ：普段は25.0cmを履いています
  フィット感：細めの作りです。普段より0.5cm大きめをおすすめします
  ```
- 靴の場合は実寸サイズ（肩幅、身幅など）を表示しない

### 5. リアルタイムプレビュー更新（sp_scripts.html: line 3080-3096）

**機能**: `setupDetailEventListener()` 関数を拡張
- 以下の項目にイベントリスナーを追加：
  - サイズ(表記)_靴（select → change イベント）
  - その他のサイズ表記_靴（input → input イベント）
  - 普段のサイズ_靴（input → input イベント）
  - フィット感_靴（textarea → input イベント）
- 各項目変更時に自動的に `updateDescriptionFromDetail()` を呼び出してプレビュー更新

### 6. データ収集（sp_scripts.html: line 158）

**FIELD_IDS配列に追加**:
- `サイズ(表記)_靴`
- `その他のサイズ表記_靴`
- `普段のサイズ_靴`
- `フィット感_靴`

これらのフィールドは `collect()` 関数で自動的に収集され、スプレッドシートに保存されます。

## アーキテクチャの重要ポイント

### サイズセクション表示のメカニズム
**重要**: サイズセクションの表示は `updateSizeDisplay()` 関数（line 4705-4830）で制御されます。

- この関数は `updateItemNameDisplay()` から呼び出され、アイテム名選択時に実行されます
- `小分類(カテゴリ)` の値を各カテゴリ配列（`topsCategories`, `bottomsCategories`, `setCategories`, `shoesCategories`）と照合
- 一致するカテゴリがあれば対応するサイズセクション（`topsSize`, `bottomsSize`, `shoesSize`）を表示

**靴の場合の特別処理**:
```javascript
else if (shoesCategories.some(cat => subcategory.includes(cat))) {
  sizeSection.style.display = 'block';
  shoesSize.style.display = 'block';
  // サイズ(表記)_靴に選択肢をコピー
  // 基本情報のサイズを自動反映
}
```

### イベントフロー
1. ユーザーがカテゴリを選択
2. `onL2Changed()` → `updateSizeOptions()` で基本情報のサイズプルダウンを靴用に切り替え
3. ユーザーがアイテム名を選択
4. `updateItemNameDisplay()` → `updateSizeDisplay()` で商品の説明ブロックの靴セクションを表示
5. `updateSizeDisplay()` 内で基本情報のサイズを `サイズ(表記)_靴` に自動反映
6. ユーザーがサイズや追加情報を入力
7. イベントリスナーが `updateDescriptionFromDetail()` を呼び出し
8. `getSizeInfo()` が靴の全情報を収集してプレビューに反映

## テスト結果

✅ メンズ/レディースに応じたサイズ範囲の表示
✅ 基本情報のサイズと商品の説明ブロックのサイズの自動連動
✅ 商品の説明プレビューへの靴サイズ情報の反映
✅ その他のサイズ表記、普段のサイズ、フィット感のプレビュー反映
✅ リアルタイムプレビュー更新

全ての機能が正常に動作することを確認。

## 今後の展開

この実装により、メルカリ基準に準拠した靴の登録が可能になりました。購入者がサイズ感を正確に把握できる情報を提供できます。

次のステップ:
- 画像なしでAI生成テスト（AI追加属性が反映されるか確認）
- 画像ありでAI生成テスト（画像URL、AI生成履歴が保存されるか確認）
