# Cloudflare R2移行計画 - 画像ストレージ最適化

## 実施日：2025年10月22日

## 背景

### 現状の課題
- **Google Drive使用**: 画像アップロードが3枚で15-18秒と遅い
- **容量制限**: 15GB（約7,500商品分）
- **アップロード方式**: Base64エンコード → GAS → Drive API（非効率）

### 実施した最適化（Phase 1）
1. ✅ 画像サイズ縮小: 1200px → 800px
2. ✅ JPEG品質低減: 80% → 70%
3. ✅ 共有設定最適化: ファイル単位 → フォルダ単位
4. ✅ 不要ログ削除: Logger.log、console.log削除
5. ✅ 登録完了メッセージ: シンプル化＋ポップアップ表示

**結果**: 30秒 → 15-18秒（約40%改善）

---

## 調査結果サマリー

### ChatGPTエージェントモード調査（2024-2025年最新動向）

**結論: Cloudflare R2単体が最適解**

### コスト比較（1,000店舗規模）
| ストレージ | 月額コスト | 速度 | 備考 |
|---|---|---|---|
| **Cloudflare R2** | **150 USD** | 5-8秒 | エグレス無料 |
| Google Drive | 16,800 USD | 15-18秒 | ユーザー課金 |
| AWS S3 | 2,030 USD | 5-8秒 | エグレス高額 |
| Supabase | 2,000 USD | 5-8秒 | エグレス課金 |

**R2はGoogle Driveの1/100以下のコスト！**

### 重要な発見：R2-Explorer

**R2-Explorer** = Google DriveライクなOSS管理UI
- ドラッグ&ドロップアップロード
- フォルダ作成・管理
- サムネイル一覧表示
- 画像・PDF・CSVプレビュー
- メタデータ編集
- Cloudflare Accessで権限管理

→ **Google Driveの使い勝手をR2で実現可能！**

---

## 実装プラン

### Phase 1: R2小規模テスト（明日から開始）

**目的**: R2の速度とUIを実際に検証

**作業内容**:
1. Cloudflareアカウント作成
2. R2バケット作成（テスト用）
3. 少量画像でアップロード速度テスト
4. R2-Explorerのセットアップと評価

**所要時間**: 2-3時間

**検証項目**:
- [ ] アップロード速度は5-8秒で実現できるか？
- [ ] R2-ExplorerのUIは使いやすいか？
- [ ] チーム共有機能は十分か？

---

### Phase 2: 本実装（テスト後判断）

#### 2-1. アップロード処理の変更（2-3日）
```
変更内容:
- Google Drive API削除
- Cloudflare Workers実装
- 署名付きURL発行
- クライアントから直接R2アップロード
- JSON_データにR2 URL保存

期待効果: 15-18秒 → 5-8秒（3倍速）
```

#### 2-2. R2-Explorer本番環境構築（1-2日）
```
- Cloudflare Pagesにデプロイ
- Cloudflare Accessで認証
- チームメンバーへアクセス権付与
```

#### 2-3. Photoroom API連携（2-3日）
```
- 背景除去ボタン実装
- Workers経由でPhotoroom API呼び出し
- 処理済み画像をR2保存
- 元画像と処理済み画像の管理
```

#### 2-4. メルカリAPI対応（将来）
```
- R2公開URL設定
- メルカリAPIへ画像URL送信
- 自動出品機能
```

---

## ハイブリッド構成（R2 + Drive）の評価

**結論: 不要**

調査レポートより：
> 「ハイブリッド構成ではストレージを二重に消費し、同期ロジックの実装が複雑になるため、SaaS化後に必ずしも必要ではない」

**理由**:
- R2-ExplorerでGoogle Driveの代替可能
- ストレージ2倍消費は無駄
- 同期処理の実装・運用が複雑
- バックアップは定期的に手動コピーで十分

**→ R2単体で進める**

---

## 技術的詳細

### アップロード方式の変更

**現在（Google Drive）**:
```
スマホ → Base64エンコード → GAS → Drive API → ファイル保存
問題点: Base64で33%肥大化、GASの6分制限、Drive APIの遅延
```

**変更後（Cloudflare R2）**:
```
スマホ → Workers（署名付きURL取得） → R2へ直接アップロード
メリット: Base64不要、GAS経由不要、高速、並列処理可能
```

### セキュリティ設計

**マルチテナント分離**:
- テナントごとにプレフィックス分離（例: `tenant-001/`, `tenant-002/`）
- Workersで署名付きURL発行時にテナントIDを検証
- 他テナントのデータへアクセス不可

**アクセス制御**:
- 公開URL: メルカリ等への出品用
- 署名付きURL: アプリ内での一時的なアクセス用（有効期限付き）

### 画像最適化

**形式**:
- WebP（25-30%削減、ブラウザ対応95%）
- AVIF（最大50%削減、ブラウザ対応80%）
- フォールバック用にJPEG/PNG

**処理フロー**:
1. アップロード時に自動変換
2. サムネイル生成
3. メタデータをD1/KVに保存

---

## SaaS化時の料金プラン案

### フリープラン
- 画像: 5枚/商品
- ストレージ: 1GB
- Photoroom: なし

### ベーシック（月額3,000円）
- 画像: 10枚/商品
- ストレージ: 5GB
- Photoroom: 100枚/月

### プロ（月額5,000円）
- 画像: 20枚/商品
- ストレージ: 無制限
- Photoroom: 500枚/月
- メルカリAPI連携

**R2コスト**: 売上の0.03〜0.05%程度（ほぼ無視できる）

---

## 実装時の注意点

1. **権限設定**: プレフィックス分離を厳密に実装（他テナントへの漏洩防止）
2. **GAS制限**: 6分・50MB制限に注意。署名付きURLで直接アップロード
3. **メルカリAPI**: 画像は直接アップロード不可、R2の公開URLを指定（最大10MB）
4. **画像変換コスト**: AVIFはエンコード時間が長い。バックグラウンド処理推奨
5. **Drive API制限**: バックアップ時は1日750GB上限を考慮

---

## 次のステップ（明日から）

### Step 1: Cloudflareアカウント準備
- [ ] Cloudflareアカウント作成
- [ ] 支払い方法登録（R2は従量課金）

### Step 2: R2バケット作成
- [ ] テスト用バケット作成
- [ ] 公開アクセス設定
- [ ] API認証情報取得

### Step 3: アップロードテスト
- [ ] Workers実装（署名付きURL発行）
- [ ] クライアント側のアップロード処理実装
- [ ] 3枚の画像でスピードテスト

### Step 4: R2-Explorer評価
- [ ] R2-Explorerのセットアップ
- [ ] UIの使い勝手確認
- [ ] チーム共有機能の確認

**テスト完了後、本実装へ進むか最終判断**

---

## 参考リンク

- Cloudflare R2ドキュメント: https://developers.cloudflare.com/r2/
- R2-Explorer: https://github.com/G4brym/R2-Explorer
- Photoroom API: https://docs.photoroom.com/
- メルカリShops API: https://api.mercari-shops.com/

---

## 備考

- Google Driveの既存画像はそのまま残す（後方互換性）
- 新規登録分からR2へ切り替え
- 移行期間中はJSON_データにストレージ種別を記録
