<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      background-color: #f8f9fa;
      display: flex;
      flex-direction: column;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .chat-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      flex-shrink: 0;
    }
    .chat-header h1 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
    }
    .chat-header .channel-info {
      font-size: 0.875rem;
      opacity: 0.9;
      margin-top: 4px;
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background-color: #f8f9fa;
      position: relative;
    }

    /* Pull-to-Refresh */
    .pull-to-refresh {
      position: absolute;
      top: -60px;
      left: 0;
      right: 0;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #667eea;
      font-size: 0.875rem;
      transition: top 0.3s;
    }
    .pull-to-refresh.visible {
      top: 0;
    }
    .message-item {
      margin-bottom: 16px;
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .message-header {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
    .message-sender {
      font-weight: 600;
      margin-right: 8px;
      color: #2d3748;
    }
    .message-permission {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 12px;
      margin-right: 8px;
    }
    .permission-owner {
      background-color: #fef3c7;
      color: #92400e;
    }
    .permission-staff {
      background-color: #dbeafe;
      color: #1e40af;
    }
    .permission-outsource {
      background-color: #e0e7ff;
      color: #4338ca;
    }
    .permission-system {
      background-color: #f3f4f6;
      color: #6b7280;
    }
    .message-timestamp {
      font-size: 0.75rem;
      color: #9ca3af;
    }
    .message-body {
      background-color: white;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      word-wrap: break-word;
      white-space: pre-wrap;
      line-height: 1.5;
    }

    /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
    .input-container {
      background-color: white;
      padding: 16px;
      border-top: 1px solid #e5e7eb;
      flex-shrink: 0;
    }
    .input-row {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    .message-input {
      flex: 1;
      resize: none;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 12px;
      font-size: 16px;
      max-height: 120px;
    }
    .message-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .send-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .send-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .char-counter {
      font-size: 0.75rem;
      color: #9ca3af;
      text-align: right;
      margin-top: 4px;
    }
    .char-counter.warning {
      color: #f59e0b;
    }
    .char-counter.error {
      color: #ef4444;
    }

    /* ç©ºçŠ¶æ…‹ */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #9ca3af;
    }
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 16px;
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .spinner-border {
      width: 3rem;
      height: 3rem;
    }

    /* Toast Notification */
    .toast-container {
      position: fixed;
      top: 80px;
      right: 16px;
      z-index: 9998;
    }

    /* iOSè‡ªå‹•ã‚ºãƒ¼ãƒ é˜²æ­¢ */
    input, textarea {
      font-size: 16px !important;
    }

    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆWebkitï¼‰ */
    .messages-container::-webkit-scrollbar {
      width: 8px;
    }
    .messages-container::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    .messages-container::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }
    .messages-container::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container">
    <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="errorToastBody">
          ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Header -->
  <div class="chat-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1 style="margin: 0;">ğŸ’¬ ãƒãƒ¼ãƒ  ãƒãƒ£ãƒƒãƒˆ</h1>
        <div class="channel-info">
          ğŸ“¢ å…¨ä½“ãƒãƒ£ãƒ³ãƒãƒ«
          <span id="debugInfo" style="font-size: 10px; opacity: 0.7; margin-left: 8px;"></span>
        </div>
        <!-- GASç‰ˆã®ã¿ï¼šé€ä¿¡è€…åé¸æŠ -->
        <div id="userSelectContainer" style="display: none; margin-top: 8px;">
          <label style="font-size: 12px; opacity: 0.9; margin-right: 4px;">é€ä¿¡è€…:</label>
          <select id="userSelect" style="background: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.5); padding: 4px 8px; border-radius: 4px; font-size: 12px;">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>
      </div>
      <button id="refreshButton" style="background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s;">
        <span id="refreshIcon">ğŸ”„</span> <span id="refreshText">æ›´æ–°</span>
      </button>
    </div>
  </div>

  <!-- Messages Container -->
  <div class="messages-container" id="messagesContainer">
    <div class="pull-to-refresh" id="pullToRefresh">
      â†“ é›¢ã—ã¦æ›´æ–°
    </div>
    <div class="empty-state" id="emptyState">
      <div class="empty-state-icon">ğŸ’¬</div>
      <p>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>
      <p class="text-muted" style="font-size: 0.875rem;">æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
    </div>
  </div>

  <!-- Input Container -->
  <div class="input-container">
    <div class="input-row">
      <textarea
        class="message-input"
        id="messageInput"
        placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
        rows="1"
        maxlength="1000"></textarea>
      <button class="send-button" id="sendButton" onclick="sendMessage()">
        é€ä¿¡
      </button>
    </div>
    <div class="char-counter" id="charCounter">0 / 1000</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let currentChannel = 'å…¨ä½“';
    let pollingInterval = null;
    let lastMessageId = null;
    let fcmToken = '<?= fcmToken ?>'; // GASãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ã‹ã‚‰å–å¾—
    let userName = null; // GASç‰ˆã§é¸æŠã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼å
    const BASE_URL = '<?= GAS_BASE_URL ?>'; // PWAç‰ˆAPIå‘¼ã³å‡ºã—ç”¨ã®GAS Web App URL

    // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šBASE_URLã®å€¤ã‚’ç¢ºèª
    console.log('[Chat UI] BASE_URL:', BASE_URL);
    console.log('[Chat UI] BASE_URL type:', typeof BASE_URL);
    console.log('[Chat UI] BASE_URL length:', BASE_URL ? BASE_URL.length : 0);

    // BASE_URLãŒæœªå®šç¾©ã¾ãŸã¯ç©ºã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
    if (!BASE_URL || BASE_URL === '' || BASE_URL === 'undefined') {
      const errorMsg = 'ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ: GAS_BASE_URL is not defined';
      console.error('[Chat UI] ' + errorMsg);
      alert(errorMsg);
      throw new Error(errorMsg);
    }

    // Pull-to-Refreshç”¨
    let touchStartY = 0;
    let isPulling = false;

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼åé¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºï¼ˆGASç‰ˆã®ã¿ï¼‰
    // GASç‰ˆï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è¡¨ç¤º
    function loadUserList() {
      console.log('[loadUserList] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿é–‹å§‹');

      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’è¡¨ç¤º
      const userSelectContainer = document.getElementById('userSelectContainer');
      const userSelect = document.getElementById('userSelect');

      if (userSelectContainer) {
        userSelectContainer.style.display = 'block';
      }

      // localStorageã‹ã‚‰å‰å›é¸æŠã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
      const savedUserName = localStorage.getItem('reborn_chat_user_name');

      // FCMé€šçŸ¥ç™»éŒ²ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function(users) {
          console.log('[loadUserList] ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—æˆåŠŸ:', users);

          if (!users || users.length === 0) {
            console.error('[loadUserList] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
          }

          // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è¿½åŠ 
          userSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
          users.forEach(function(user) {
            const option = document.createElement('option');
            option.value = user.userName;
            option.textContent = user.userName + ' (' + user.permission + ')';

            // å‰å›é¸æŠã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è‡ªå‹•é¸æŠ
            if (savedUserName && user.userName === savedUserName) {
              option.selected = true;
              userName = user.userName;
              console.log('[loadUserList] å‰å›é¸æŠã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è‡ªå‹•é¸æŠ:', userName);
            }

            userSelect.appendChild(option);
          });

          // é¸æŠå¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
          userSelect.addEventListener('change', function() {
            userName = this.value;
            localStorage.setItem('reborn_chat_user_name', userName);
            console.log('[loadUserList] ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’é¸æŠ:', userName);
          });
        })
        .withFailureHandler(function(error) {
          console.error('[loadUserList] ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getActiveUsers();
    }

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[Chat UI] åˆæœŸåŒ–é–‹å§‹');
      console.log('[Chat UI] FCMãƒˆãƒ¼ã‚¯ãƒ³:', fcmToken ? fcmToken.substring(0, 20) + '...' : 'ãªã—');

      // GASç‰ˆã®å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’è¡¨ç¤º
      if (!fcmToken) {
        console.log('[Chat UI] GASç‰ˆã¨ã—ã¦åˆæœŸåŒ– - ãƒ¦ãƒ¼ã‚¶ãƒ¼åé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¡¨ç¤º');
        loadUserList();
        initializeChat();
        return;
      }

      // PWAç‰ˆã®å ´åˆã€ãã®ã¾ã¾åˆæœŸåŒ–
      console.log('[Chat UI] PWAç‰ˆã¨ã—ã¦åˆæœŸåŒ–');
      initializeChat();
    });

    // ãƒãƒ£ãƒƒãƒˆåˆæœŸåŒ–å‡¦ç†
    function initializeChat() {
      console.log('[Chat UI] ãƒãƒ£ãƒƒãƒˆåˆæœŸåŒ–é–‹å§‹');

      // æ›´æ–°ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²
      const refreshButton = document.getElementById('refreshButton');
      if (refreshButton) {
        refreshButton.addEventListener('click', function() {
          console.log('[Refresh Button] ã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
          manualRefresh();
        });
        console.log('[Chat UI] æ›´æ–°ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²å®Œäº†');
      } else {
        console.error('[Chat UI] æ›´æ–°ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }

      // Pull-to-Refreshè¨­å®š
      // ä¸€æ—¦ç„¡åŠ¹åŒ–ï¼štouchã‚¤ãƒ™ãƒ³ãƒˆãŒå•é¡Œã‚’èµ·ã“ã™å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚
      // setupPullToRefresh();
      console.log('[Chat UI] Pull-to-Refreshã¯ç„¡åŠ¹åŒ–ï¼ˆæ›´æ–°ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ï¼‰');

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ã®è‡ªå‹•ãƒªã‚µã‚¤ã‚º
      const messageInput = document.getElementById('messageInput');
      messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        updateCharCounter();
      });

      // Enterã‚­ãƒ¼ã§é€ä¿¡ï¼ˆShift+Enterã§æ”¹è¡Œï¼‰
      messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èª­ã¿è¾¼ã¿
      loadMessages(false); // ã‚¨ãƒ©ãƒ¼æ™‚ã¯è¡¨ç¤º

      // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹ï¼ˆ10ç§’ã”ã¨ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ7ç§’ï¼‰
      startPolling();
      console.log('[Chat UI] ãƒãƒ¼ãƒªãƒ³ã‚°æœ‰åŠ¹åŒ–ï¼ˆ10ç§’ã”ã¨è‡ªå‹•æ›´æ–°ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ7ç§’ï¼‰');

      console.log('[Chat UI] åˆæœŸåŒ–å®Œäº†');
    }

    // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°
    function updateCharCounter() {
      const messageInput = document.getElementById('messageInput');
      const charCounter = document.getElementById('charCounter');
      const length = messageInput.value.length;

      charCounter.textContent = `${length} / 1000`;

      if (length > 950) {
        charCounter.classList.add('error');
        charCounter.classList.remove('warning');
      } else if (length > 800) {
        charCounter.classList.add('warning');
        charCounter.classList.remove('error');
      } else {
        charCounter.classList.remove('warning', 'error');
      }
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    function sendMessage() {
      const messageInput = document.getElementById('messageInput');
      const message = messageInput.value.trim();

      if (!message) {
        return;
      }

      if (message.length > 1000) {
        showError('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé•·ã™ãã¾ã™ï¼ˆæœ€å¤§1000æ–‡å­—ï¼‰');
        return;
      }

      // GASç‰ˆï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
      if (!fcmToken && !userName) {
        showError('é€ä¿¡è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      console.log('[sendMessage] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡: ' + message);
      console.log('[sendMessage] é€ä¿¡è€…: ' + userName);
      showLoading(true);
      disableSendButton(true);

      google.script.run
        .withSuccessHandler(function(result) {
          console.log('[sendMessage] é€ä¿¡æˆåŠŸ:', result);
          showLoading(false);
          disableSendButton(false);

          if (result.success) {
            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            messageInput.value = '';
            messageInput.style.height = 'auto';
            updateCharCounter();

            // ã™ãã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å†èª­è¾¼
            loadMessages(false); // ã‚¨ãƒ©ãƒ¼æ™‚ã¯è¡¨ç¤º
          } else {
            showError(result.message || 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(function(error) {
          console.error('[sendMessage] ã‚¨ãƒ©ãƒ¼:', error);
          showLoading(false);
          disableSendButton(false);
          showError('ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .sendMessage(message, currentChannel, fcmToken, userName);
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èª­ã¿è¾¼ã¿
    function loadMessages(silent, callback) {
      const timestamp = new Date().toLocaleTimeString();
      const callId = 'load_' + Date.now();
      console.log('[loadMessages] (' + callId + ') ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—é–‹å§‹ @ ' + timestamp + ' (silent=' + silent + ', callback=' + (callback ? 'ã‚ã‚Š' : 'ãªã—') + ')');
      console.log('[loadMessages] (' + callId + ') google.script.run exists:', typeof google !== 'undefined' && typeof google.script !== 'undefined' && typeof google.script.run !== 'undefined');
      console.log('[loadMessages] (' + callId + ') currentChannel:', currentChannel);

      // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
      const debugInfo = document.getElementById('debugInfo');
      if (debugInfo) {
        debugInfo.textContent = 'èª­è¾¼ä¸­ ' + timestamp;
      }

      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼ˆ7ç§’ï¼‰
      const timeoutId = setTimeout(function() {
        console.error('[loadMessages] (' + callId + ') â° ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ7ç§’çµŒéï¼‰');
        if (debugInfo) {
          debugInfo.textContent = 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ ' + new Date().toLocaleTimeString();
          debugInfo.style.color = '#ff6b6b';
        }
        if (!silent) {
          showError('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆ7ç§’ï¼‰');
        }
        if (callback) {
          console.log('[loadMessages] (' + callId + ') ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¾Œã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ');
          callback();
        }
      }, 7000);

      try {
        google.script.run
          .withSuccessHandler(function(messages) {
            clearTimeout(timeoutId);
            console.log('[loadMessages] (' + callId + ') âœ… å–å¾—æˆåŠŸ @ ' + timestamp + ':', messages ? messages.length : 0, 'ä»¶');
            console.log('[loadMessages] (' + callId + ') messages type:', typeof messages);
            console.log('[loadMessages] (' + callId + ') messages:', JSON.stringify(messages).substring(0, 200));

            if (debugInfo) {
              debugInfo.textContent = 'âœ… ' + (messages ? messages.length : 0) + 'ä»¶ ' + new Date().toLocaleTimeString();
              debugInfo.style.color = '#51cf66';
            }

            displayMessages(messages);
            if (callback) {
              console.log('[loadMessages] (' + callId + ') æˆåŠŸã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ');
              callback();
            }
          })
          .withFailureHandler(function(error) {
            clearTimeout(timeoutId);
            console.error('[loadMessages] (' + callId + ') âŒ ã‚¨ãƒ©ãƒ¼ @ ' + timestamp + ':', error);
            console.error('[loadMessages] (' + callId + ') ã‚¨ãƒ©ãƒ¼è©³ç´°:', JSON.stringify(error));
            console.error('[loadMessages] (' + callId + ') ã‚¨ãƒ©ãƒ¼type:', typeof error);
            console.error('[loadMessages] (' + callId + ') ã‚¨ãƒ©ãƒ¼message:', error ? error.message : 'ãªã—');
            console.error('[loadMessages] (' + callId + ') ã‚¨ãƒ©ãƒ¼stack:', error ? error.stack : 'ãªã—');

            if (debugInfo) {
              debugInfo.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼ ' + new Date().toLocaleTimeString();
              debugInfo.style.color = '#ff6b6b';
            }

            // ãƒãƒ¼ãƒªãƒ³ã‚°ä¸­ã®ã‚¨ãƒ©ãƒ¼ã¯ã‚µã‚¤ãƒ¬ãƒ³ãƒˆå‡¦ç†ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã—ãªã„ï¼‰
            if (!silent) {
              showError('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error ? error.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
            }
            if (callback) {
              console.log('[loadMessages] (' + callId + ') ã‚¨ãƒ©ãƒ¼å¾Œã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ');
              callback();
            }
          })
          .getMessages(currentChannel, 100);
        console.log('[loadMessages] (' + callId + ') google.script.run.getMessages() å‘¼ã³å‡ºã—å®Œäº†');
      } catch (callError) {
        clearTimeout(timeoutId);
        console.error('[loadMessages] (' + callId + ') ğŸ’¥ å‘¼ã³å‡ºã—æ™‚ä¾‹å¤–:', callError);
        console.error('[loadMessages] (' + callId + ') ä¾‹å¤–è©³ç´°:', callError.message);
        console.error('[loadMessages] (' + callId + ') ä¾‹å¤–stack:', callError.stack);

        if (debugInfo) {
          debugInfo.textContent = 'ğŸ’¥ ä¾‹å¤– ' + new Date().toLocaleTimeString();
          debugInfo.style.color = '#ff6b6b';
        }

        if (!silent) {
          showError('ã‚¨ãƒ©ãƒ¼: ' + callError.message);
        }
        if (callback) {
          console.log('[loadMessages] (' + callId + ') ä¾‹å¤–å¾Œã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ');
          callback();
        }
      }
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function displayMessages(messages) {
      console.log('[displayMessages] é–‹å§‹ - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°:', messages ? messages.length : 0);

      const container = document.getElementById('messagesContainer');
      const emptyState = document.getElementById('emptyState');

      console.log('[displayMessages] DOMè¦ç´ å–å¾—:', {
        container: container ? 'ã‚ã‚Š' : 'ãªã—',
        emptyState: emptyState ? 'ã‚ã‚Š' : 'ãªã—'
      });

      if (!container) {
        console.error('[displayMessages] ã‚¨ãƒ©ãƒ¼: messagesContainerè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      if (!messages || messages.length === 0) {
        if (emptyState) {
          emptyState.style.display = 'block';
        } else {
          console.warn('[displayMessages] emptyStateè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆç©ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºä¸å¯ï¼‰');
        }
        return;
      }

      if (emptyState) {
        emptyState.style.display = 'none';
      }

      // ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿å­˜
      const wasAtBottom = isScrolledToBottom();

      // æ—¢å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸IDã®ã‚»ãƒƒãƒˆã‚’ä½œæˆ
      const existingMessageIds = new Set();
      const existingMessages = container.querySelectorAll('.message-item');
      existingMessages.forEach(function(msgEl) {
        existingMessageIds.add(msgEl.dataset.messageId);
      });

      // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ã‚’è¿½åŠ ï¼ˆå·®åˆ†æ›´æ–°ï¼‰
      let newMessageCount = 0;
      messages.forEach(function(msg) {
        if (!existingMessageIds.has(msg.messageId)) {
          const messageDiv = createMessageElement(msg);
          container.appendChild(messageDiv);
          newMessageCount++;
        }
      });

      console.log('[displayMessages] æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ :', newMessageCount + 'ä»¶');

      // æœ€æ–°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸IDã‚’ä¿å­˜
      if (messages.length > 0) {
        lastMessageId = messages[messages.length - 1].messageId;
      }

      // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆæœ€åˆã®èª­ã¿è¾¼ã¿æ™‚ or æœ€ä¸‹éƒ¨ã«ã„ãŸå ´åˆï¼‰
      if (wasAtBottom === null || wasAtBottom) {
        scrollToBottom();
      }
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã‚’ä½œæˆ
    function createMessageElement(msg) {
      const div = document.createElement('div');
      div.className = 'message-item';
      div.dataset.messageId = msg.messageId;

      // æ¨©é™ãƒãƒƒã‚¸ã®ã‚¯ãƒ©ã‚¹
      const permissionClass = getPermissionClass(msg.senderPermission);

      div.innerHTML = `
        <div class="message-header">
          <span class="message-sender">${escapeHtml(msg.sender)}</span>
          <span class="message-permission ${permissionClass}">${escapeHtml(msg.senderPermission)}</span>
          <span class="message-timestamp">${formatTimestamp(msg.timestamp)}</span>
        </div>
        <div class="message-body">${escapeHtml(msg.message)}</div>
      `;

      return div;
    }

    // æ¨©é™ãƒãƒƒã‚¸ã®ã‚¯ãƒ©ã‚¹ã‚’å–å¾—
    function getPermissionClass(permission) {
      if (permission === 'ã‚ªãƒ¼ãƒŠãƒ¼') return 'permission-owner';
      if (permission === 'ã‚¹ã‚¿ãƒƒãƒ•') return 'permission-staff';
      if (permission === 'å¤–æ³¨') return 'permission-outsource';
      if (permission === 'ã‚·ã‚¹ãƒ†ãƒ ') return 'permission-system';
      return 'permission-staff';
    }

    // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatTimestamp(timestamp) {
      if (!timestamp) return '';

      // YYYY-MM-DD HH:mm:ss å½¢å¼ã‹ã‚‰è¡¨ç¤ºç”¨ã«å¤‰æ›
      const match = timestamp.match(/(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})/);
      if (match) {
        const [_, year, month, day, hour, minute] = match;
        return `${month}/${day} ${hour}:${minute}`;
      }

      return timestamp;
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ãƒã‚§ãƒƒã‚¯
    function isScrolledToBottom() {
      const container = document.getElementById('messagesContainer');
      const threshold = 100; // 100pxä»¥å†…ãªã‚‰ã€Œæœ€ä¸‹éƒ¨ã€ã¨ã¿ãªã™
      return container.scrollHeight - container.scrollTop - container.clientHeight < threshold;
    }

    // æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    function scrollToBottom() {
      const container = document.getElementById('messagesContainer');
      container.scrollTop = container.scrollHeight;
    }

    // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹ãƒ»åœæ­¢ã¯å¾Œæ–¹ã§å®šç¾©ï¼ˆgetNewMessages APIä½¿ç”¨ç‰ˆï¼‰
    // beforeunloadã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚‚å¾Œæ–¹ã§å®šç¾©

    // ãƒšãƒ¼ã‚¸ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã£ãŸæ™‚ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†èª­è¾¼ï¼ˆPWAå¯¾å¿œï¼‰
    window.addEventListener('focus', function() {
      console.log('[Focus] ãƒšãƒ¼ã‚¸ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã‚Šã¾ã—ãŸ');
      loadMessages(false); // ã‚¨ãƒ©ãƒ¼æ™‚ã¯è¡¨ç¤ºï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹èª­ã¿è¾¼ã¿ï¼‰
    });

    // Visibility API: ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚ŒãŸæ™‚ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†èª­è¾¼ï¼ˆPWAå¯¾å¿œï¼‰
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        console.log('[Visibility] ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ');
        loadMessages(false); // ã‚¨ãƒ©ãƒ¼æ™‚ã¯è¡¨ç¤ºï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹èª­ã¿è¾¼ã¿ï¼‰
      }
    });

    // æ‰‹å‹•æ›´æ–°ï¼ˆæ›´æ–°ãƒœã‚¿ãƒ³ï¼‰
    function manualRefresh() {
      const refreshTime = new Date().toLocaleTimeString();
      console.log('[Manual Refresh] ===== æ›´æ–°ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ @ ' + refreshTime + ' =====');

      // è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
      const refreshButton = document.getElementById('refreshButton');
      const refreshIcon = document.getElementById('refreshIcon');
      const refreshText = document.getElementById('refreshText');

      console.log('[Manual Refresh] UIè¦ç´ å–å¾—:', {
        button: refreshButton ? 'ã‚ã‚Š' : 'ãªã—',
        icon: refreshIcon ? 'ã‚ã‚Š' : 'ãªã—',
        text: refreshText ? 'ã‚ã‚Š' : 'ãªã—'
      });

      if (refreshButton) {
        refreshButton.style.background = 'rgba(255,255,255,0.4)';
        refreshButton.disabled = true;
        console.log('[Manual Refresh] ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–');
      }

      if (refreshIcon) {
        refreshIcon.style.display = 'inline-block';
        refreshIcon.style.animation = 'spin 1s linear infinite';
        console.log('[Manual Refresh] ã‚¹ãƒ”ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹');
      }

      if (refreshText) {
        refreshText.textContent = 'èª­è¾¼ä¸­...';
        console.log('[Manual Refresh] ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›´: èª­è¾¼ä¸­...');
      }

      // å¼·åˆ¶UIãƒªã‚»ãƒƒãƒˆï¼ˆ8ç§’å¾Œï¼‰
      let resetDone = false;
      const forceResetTimer = setTimeout(function() {
        if (resetDone) return;
        console.warn('[Manual Refresh] âš ï¸ å¼·åˆ¶UIãƒªã‚»ãƒƒãƒˆï¼ˆ8ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰');
        resetDone = true;

        if (refreshButton) {
          refreshButton.style.background = 'rgba(255,255,255,0.2)';
          refreshButton.disabled = false;
        }
        if (refreshIcon) {
          refreshIcon.style.animation = '';
        }
        if (refreshText) {
          refreshText.textContent = 'æ›´æ–°';
        }
      }, 8000);

      // UIãƒªã‚»ãƒƒãƒˆé–¢æ•°
      function resetUI() {
        if (resetDone) return;
        resetDone = true;
        clearTimeout(forceResetTimer);

        if (refreshButton) {
          refreshButton.style.background = 'rgba(255,255,255,0.2)';
          refreshButton.disabled = false;
          console.log('[Manual Refresh] ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–');
        }

        if (refreshIcon) {
          refreshIcon.style.animation = '';
          console.log('[Manual Refresh] ã‚¹ãƒ”ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢');
        }

        if (refreshText) {
          refreshText.textContent = 'æ›´æ–°';
          console.log('[Manual Refresh] ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›´: æ›´æ–°');
        }

        console.log('[Manual Refresh] ===== æ›´æ–°å®Œäº† =====');
      }

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èª­ã¿è¾¼ã¿
      console.log('[Manual Refresh] loadMessages() å‘¼ã³å‡ºã—é–‹å§‹');
      loadMessages(false, function() {
        console.log('[Manual Refresh] ===== ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ @ ' + new Date().toLocaleTimeString() + ' =====');
        resetUI();
      });
      console.log('[Manual Refresh] loadMessages() å‘¼ã³å‡ºã—å®Œäº†ï¼ˆéåŒæœŸå‡¦ç†ä¸­ï¼‰');
    }

    // Pull-to-Refreshè¨­å®š
    function setupPullToRefresh() {
      const container = document.getElementById('messagesContainer');
      const pullIndicator = document.getElementById('pullToRefresh');

      container.addEventListener('touchstart', function(e) {
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ãŒä¸€ç•ªä¸Šã®æ™‚ã®ã¿Pull-to-Refreshæœ‰åŠ¹
        if (container.scrollTop === 0) {
          touchStartY = e.touches[0].clientY;
        }
      });

      container.addEventListener('touchmove', function(e) {
        if (touchStartY === 0) return;

        const touchY = e.touches[0].clientY;
        const pullDistance = touchY - touchStartY;

        // ä¸‹æ–¹å‘ã«å¼•ã£å¼µã£ã¦ã„ã‚‹ & è·é›¢ãŒ50pxä»¥ä¸Š
        if (pullDistance > 0 && container.scrollTop === 0) {
          isPulling = true;

          if (pullDistance > 60) {
            pullIndicator.classList.add('visible');
            pullIndicator.textContent = 'â†‘ é›¢ã—ã¦æ›´æ–°';
          } else {
            pullIndicator.textContent = 'â†“ ä¸‹ã«å¼•ã£å¼µã£ã¦æ›´æ–°';
          }
        }
      });

      container.addEventListener('touchend', function() {
        if (isPulling) {
          isPulling = false;
          pullIndicator.classList.remove('visible');
          pullIndicator.textContent = 'â†“ é›¢ã—ã¦æ›´æ–°';

          console.log('[Pull-to-Refresh] æ‰‹å‹•æ›´æ–°å®Ÿè¡Œ');
          loadMessages(false); // æ‰‹å‹•æ›´æ–°
        }
        touchStartY = 0;
      });
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    function showLoading(show) {
      const overlay = document.getElementById('loadingOverlay');
      overlay.style.display = show ? 'flex' : 'none';
    }

    // é€ä¿¡ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹
    function disableSendButton(disabled) {
      const sendButton = document.getElementById('sendButton');
      sendButton.disabled = disabled;
    }

    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showError(message) {
      console.error('[Error]', message);
      const toast = new bootstrap.Toast(document.getElementById('errorToast'));
      document.getElementById('errorToastBody').textContent = message;
      toast.show();
    }

    // ğŸ“¡ Polling: æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ï¼ˆFCMãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    let lastPollingCheck = Date.now();

    function startPolling() {
      console.log('[Polling] é–‹å§‹: 30ç§’é–“éš”ã§æ–°ç€ç¢ºèª');

      // æ—¢å­˜ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’ã‚¯ãƒªã‚¢
      if (pollingInterval) {
        clearInterval(pollingInterval);
      }

      // 30ç§’ã”ã¨ã«æ–°ç€ãƒã‚§ãƒƒã‚¯
      pollingInterval = setInterval(() => {
        // GASç‰ˆã§ã¯å…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†èª­ã¿è¾¼ã¿ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªæ–¹å¼ï¼‰
        if (!fcmToken) {
          console.log('[Polling] GASç‰ˆ - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†èª­ã¿è¾¼ã¿');
          loadMessages(true); // silent=trueï¼ˆã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã—ãªã„ï¼‰
          return;
        }

        // PWAç‰ˆã§ã¯æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿å–å¾—ï¼ˆåŠ¹ç‡çš„ãªæ–¹å¼ï¼‰
        (async () => {
          try {
            const userName = localStorage.getItem('reborn_user_name');
            if (!userName) {
              console.log('[Polling] PWAç‰ˆ - ãƒ¦ãƒ¼ã‚¶ãƒ¼åæœªè¨­å®šã€ã‚¹ã‚­ãƒƒãƒ—');
              return;
            }

            const url = BASE_URL + '?action=getNewMessages' +
              '&lastCheckTime=' + lastPollingCheck +
              '&userName=' + encodeURIComponent(userName) +
              '&channelId=' + encodeURIComponent(currentChannel);

            console.log('[Polling] PWAç‰ˆ - æ–°ç€ç¢ºèªä¸­... lastCheckTime:', new Date(lastPollingCheck).toLocaleString('ja-JP'));

            const response = await fetch(url);
            const data = await response.json();

            if (data.success && data.count > 0) {
              console.log('[Polling] âœ… æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ' + data.count + 'ä»¶');

              // æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’UIã«è¿½åŠ 
              data.messages.forEach(msg => {
                appendMessage(msg, false); // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã—ï¼ˆPollingæ™‚ï¼‰
              });

              // ãƒãƒƒã‚¸æ›´æ–°ï¼ˆæ–°ç€ä»¶æ•°åˆ†ï¼‰
              if (typeof updateBadge === 'function') {
                updateBadge(data.count);
              }

              // æœ€æ–°ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æ›´æ–°
              if (data.messages.length > 0) {
                const latestMsg = data.messages[data.messages.length - 1];
                if (latestMsg.timestampMs) {
                  lastPollingCheck = latestMsg.timestampMs + 1; // æ¬¡å›ã¯ ã“ã®å¾Œã‹ã‚‰å–å¾—
                }
              }
            } else {
              console.log('[Polling] æ–°ç€ãªã—');
            }

            // ã‚µãƒ¼ãƒãƒ¼æ™‚åˆ»ã§æœ€çµ‚ç¢ºèªæ™‚åˆ»ã‚’æ›´æ–°
            if (data.serverTime) {
              lastPollingCheck = data.serverTime;
            }

          } catch (error) {
            console.error('[Polling] PWAç‰ˆã‚¨ãƒ©ãƒ¼:', error);
          }
        })();
      }, 30000); // 30ç§’
    }

    function stopPolling() {
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
        console.log('[Polling] åœæ­¢');
      }
    }

    // ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹æ™‚ã«Pollingåœæ­¢
    window.addEventListener('beforeunload', () => {
      stopPolling();
    });
  </script>
</body>
</html>
