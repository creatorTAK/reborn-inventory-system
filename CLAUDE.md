# REBORN プロジェクト - 開発ドキュメント

古着物販管理システム（Google Apps Script + スプレッドシート）

**完成度: 40%** | **商品登録: 80%** | **在庫管理: 0%** | **設定管理: 90%** | **売上分析: 20%**

---

## 📋 目次

1. [プロジェクト概要](#プロジェクト概要)
2. [技術スタック](#技術スタック)
3. [ファイル構成（38ファイル）](#ファイル構成)
4. [実装済み機能](#実装済み機能)
5. [設定管理システム](#設定管理システム)
6. [データ構造](#データ構造)
7. [過去のトラブルと教訓](#過去のトラブルと教訓)
8. [開発ルール](#開発ルール)
9. [次の実装予定](#次の実装予定)

---

## プロジェクト概要

### ビジネス背景

古着の**仕入れからメルカリ等での販売**まで、物販事業の全工程を超効率化するシステム。非エンジニアがAI + ライブコーディングで開発中。

### 開発目標

- **短期**: 個人 + チームでの業務効率化
- **中期**: 単純作業の外注化、AIによる半自動出品
- **長期**: 同業者向けSaaS化（課金制ビジネス）

---

## 技術スタック

### コア技術

```
Google Apps Script (GAS)
├── バックエンド: JavaScript (ES6+)
├── データベース: Google スプレッドシート
├── フロントエンド: HTML Service + Bootstrap 5
└── デプロイ: clasp (Google Apps Script CLI)
```

### 開発環境

```
ローカル開発
├── エディタ: Visual Studio Code
├── バージョン管理: Git + GitHub (Private)
└── 同期ツール: clasp
```

### 開発ワークフロー

```bash
# 1. ローカルでコード編集（VSCode）
# 2. GASにプッシュ
clasp push

# 3. ブラウザでテスト（スーパーリロード: Cmd+Shift+R）
clasp open

# 4. 動作確認後、Gitにコミット
git add .
git commit -m "feat: 新機能追加"
git push origin main
```

### 今後の統合予定

```
AI機能
├── Gemini API: 商品説明文自動生成
├── Gemini Vision API: 画像解析
└── 価格最適化提案

開発効率化ツール
├── Claude Code: AI駆動開発（導入済み）
├── Serena MCP: リポジトリ全体把握精度向上
└── CLAUDE.md: 完全開発ドキュメント（このファイル）
```

---

## ファイル構成

### 全38ファイル構成

#### JSファイル（21個）

**コアシステム**
```
config.js                    # システム全体設定・FIELD_IDS定義
menu.js                      # メニュー表示・サイドバー制御（設定管理追加）
common.js                    # 共通ユーティリティ統合
utils.js                     # ユーティリティ（最小版）
error_handler.js             # 統一エラーハンドリングシステム
```

**商品管理**
```
product.js                   # 商品登録（列名ベースマッピング、管理番号設定対応）★重要
inventory.js                 # 在庫管理（検索・更新・利益計算）
id.js                        # 管理番号生成（柔軟な設定対応）
```

**設定管理（新規）**
```
config_loader.js             # 設定マスタ読み込み・保存 ★最重要
setup_config.js              # 設定マスタシート自動生成
```

**マスタデータ管理**
```
master.js                    # マスタデータ取得 ★最重要
master_hierarchy.js          # セールスワード関連機能のみ
master_utils.js              # マスタ共通処理（シート名取得等）
master_simple.js             # 手動管理シート用シンプルマスタ取得
master_data_manager.js       # マスタデータ管理統括（軽量・安全版）
master_data_reducer.js       # データ削減システム（段階的実行版）
```

**最適化・検証**
```
performance_optimizer.js     # パフォーマンス最適化（キャッシュ機能）
data_integrity.js            # データ整合性確保（重複チェック等）
validation_enhancer.js       # 強化されたバリデーションシステム
diagnosis.js                 # システム診断
test_master.js               # テスト用
```

#### HTMLファイル（17個）

**メインUI**
```
sidebar_product.html         # 商品登録メインUI（テンプレート構造）
sidebar_config.html          # 設定管理UI（5タブ構成）★新規
sidebar_inventory.html       # 在庫管理サイドバー（最小版）
inventory_sidebar.html       # 在庫管理UIサイドバー
master_manager_ui.html       # マスタデータ管理UI
```

**スクリプト・スタイル**
```
sp_scripts.html              # JavaScript処理（設定マスタ対応）★最重要・最大規模
sp_styles.html               # CSSスタイルシート（包括的）
```

**商品登録UIブロック（モジュラー設計）**
```
sp_block_manage.html         # 管理番号入力ブロック
sp_block_basic.html          # 基本情報入力ブロック
sp_block_title.html          # 商品名作成ブロック
sp_block_description.html    # 商品の説明ブロック
sp_block_shipping.html       # 配送情報ブロック
sp_block_procure.html        # 仕入情報ブロック
sp_block_listing.html        # 出品情報ブロック
sp_block_kodawari.html       # こだわり条件ブロック
```

---

## 実装済み機能

### 1. 商品登録（80%完成）

#### 管理番号自動採番機能（拡張版）

**柔軟な設定対応**:
- 棚番号の使用/不使用を選択可能
- 棚番号形式: アルファベット2文字(AA-ZZ)、1文字(A-Z)、数字2桁(01-99)、数字3桁(001-999)、自由入力
- 区切り文字: 任意（`-`, `_`, 空欄など）
- 商品番号桁数: 3〜6桁（ゼロパディング）
- 商品番号開始値: 任意の数値

**対応例**:
- `AA-1001` (デフォルト)
- `A_001` (アルファベット1文字、区切り`_`、3桁)
- `01-00001` (数字2桁、区切り`-`、5桁)
- `RACK-A-0001` (自由入力、区切り`-`、4桁)
- `1001` (棚番号なし、商品番号のみ)

**実装ファイル**: `id.js`, `product.js`, `sp_block_manage.html`, `config_loader.js`

#### 分類カテゴリ6階層プルダウン

- 大分類 → 中分類 → 小分類 → 細分類1 → 細分類2 → アイテム名
- 階層連動（上位選択で下位が有効化）
- サイズ詳細入力機能に連動

**データ件数**: 1,686件（手動管理_アイテム分類）
**実装ファイル**: `master.js`, `sp_scripts.html`, `sp_block_basic.html`

#### ブランド名2段式表示オートコンプリート機能

- 英語50,000 + カナ50,000 = 合計100,000超の候補から瞬時に検索
- 大文字小文字区別なし、部分マッチ可能
- 最大15件表示
- 2行表示（英語名 + カナ読み）
- メルカリと同様のUI

**データ件数**: 52,667件（手動管理_ブランド）
**実装ファイル**: `master.js`, `sp_scripts.html`, `sp_styles.html`

#### 商品名選択式自動作成

- リアルタイムプレビュー（入力中に即座に反映）
- 40文字カウンター（超過時警告）
- SEO最適化された商品名の半自動生成

**構成要素**:
1. セールスワード
2. ブランド名（英語/カナ）
3. アイテム名
4. 商品属性（3つまで）

**実装ファイル**: `sp_scripts.html`, `sp_block_title.html`

#### セールスワード連動選択

- 19カテゴリ × 連動キーワード
- カテゴリ選択でキーワードが自動更新
- 商品名プレビューに自動反映

**実装ファイル**: `master.js`, `sp_scripts.html`

#### 商品の説明選択式自動作成（設定マスタ対応）

- リアルタイムプレビュー
- 1000文字カウンター（超過時警告）

**自動生成される要素**:
1. ブランド情報
2. サイズ情報（実寸）
3. 素材情報
4. 商品状態（詳細）
5. オリジナルハッシュタグ（設定可能）
6. 割引情報（設定可能）

**実装ファイル**: `sp_scripts.html`, `sp_block_description.html`, `config_loader.js`

#### ハッシュタグ自動生成（設定可能）

**設定項目**:
- 全商品プレフィックス（例: `#REBORN_`）
- 全商品テキスト（例: `全商品`）
- ブランドプレフィックス・サフィックス
- カテゴリプレフィックス・サフィックス

**生成例**:
```
#REBORN_全商品
#REBORN_UNIQLOアイテム一覧
#REBORN_トップス一覧
#REBORN_レディースアイテム一覧
#REBORN_レディーストップス一覧
```

**実装ファイル**: `sp_scripts.html`, `config_loader.js`

#### 割引情報自動挿入（設定可能）

**設定項目**:
- フォロー割: 範囲と割引額（複数設定可）+ 説明文
- リピート割: 割引額 + 説明文
- まとめ割: 範囲と割引額（複数設定可）+ 説明文

**デフォルト例**:
```
【お得な割引情報】

■ フォロー割
〜2,999円 ⇒ 100円引
〜5,999円 ⇒ 200円引
〜8,999円 ⇒ 300円引
9,000円〜 ⇒ 500円引

■ リピート割
次回購入時に200円引
「リピート割希望」とコメントにてお知らせください。

■ まとめ割
2点⇒300円引
3点⇒500円引
4点以上⇒1,000円引
購入したい商品が複数ある場合、コメントにてお知らせください。
```

**特徴**:
- すべての割引を削除すると、割引情報セクション全体が非表示
- 説明文は設定マスタで自由に編集可能

**実装ファイル**: `sp_scripts.html`, `config_loader.js`, `sidebar_config.html`

#### 配送についてブロック（設定可能）

**設定項目**:
- 配送料の負担: プルダウン選択
- 配送の方法: プルダウン選択（10種類以上）
- 発送元の地域: プルダウン選択（全47都道府県）
- 発送までの日数: プルダウン選択

**デフォルト値**:
- 配送料の負担: 送料込み(出品者負担)
- 配送の方法: ゆうゆうメルカリ便
- 発送元の地域: 岡山県
- 発送までの日数: 1~2日で発送

**実装ファイル**: `sp_block_shipping.html`, `sp_scripts.html`, `config_loader.js`

---

### 2. 設定管理システム（90%完成）★新機能

#### 概要

非エンジニアでも簡単に各種設定を変更できるUI。SaaS化の基盤となる重要機能。

#### メニュー構成

「物販管理システム」→「⚙️ 設定管理」から5タブ構成のUIを開く

**タブ一覧**:
1. 商品状態ボタン設定
2. ハッシュタグ設定
3. 割引情報設定
4. 配送デフォルト設定
5. 管理番号設定

#### 1. 商品状態ボタン設定

**機能**:
- 商品の状態（6種類）ごとにクイック挿入ボタンを設定
- ボタンラベル、ボタンテキストを自由に編集
- ボタンの追加・削除が可能

**対応する商品の状態**:
- 新品、未使用
- 未使用に近い
- 目立った傷や汚れなし
- やや傷や汚れあり
- 傷や汚れあり
- 全体的に状態が悪い

**実装ファイル**: `sidebar_config.html`, `config_loader.js`

#### 2. ハッシュタグ設定

**設定項目**:
- 全商品プレフィックス
- 全商品テキスト
- ブランドプレフィックス
- ブランドサフィックス
- カテゴリプレフィックス
- カテゴリサフィックス

**実装ファイル**: `sidebar_config.html`, `config_loader.js`

#### 3. 割引情報設定

**設定項目**:

**フォロー割**:
- 範囲と割引額（複数設定可）
- 説明文（任意）

**リピート割**:
- 割引額
- 説明文（任意）

**まとめ割**:
- 範囲と割引額（複数設定可）
- 説明文（任意）

**特徴**:
- すべてフリーテキスト入力
- 範囲追加・削除ボタンあり
- 説明文はデフォルト値が表示され、そのまま編集可能

**実装ファイル**: `sidebar_config.html`, `config_loader.js`, `sp_scripts.html`

#### 4. 配送デフォルト設定

**設定項目**:
- 配送料の負担（プルダウン）
- 配送の方法（プルダウン: 10種類以上）
- 発送元の地域（プルダウン: 全47都道府県）
- 発送までの日数（プルダウン）

**実装ファイル**: `sidebar_config.html`, `config_loader.js`

#### 5. 管理番号設定 ★高度な機能

**設定項目**:

**棚番号の使用**:
- チェックボックスで有効/無効を切り替え

**棚番号の形式**（棚番号使用時のみ）:
- アルファベット2文字 (AA-ZZ)
- アルファベット1文字 (A-Z)
- 数字2桁 (01-99)
- 数字3桁 (001-999)
- 自由入力（任意の文字列）

**棚番号のサンプル値**（自由入力時のみ）:
- プレビュー表示用のサンプル値

**区切り文字**:
- 任意の文字列（最大10文字）
- 空欄も可能

**商品番号桁数**:
- 3〜6桁から選択

**商品番号開始値**:
- 任意の数値（例: 1, 100, 1001）

**プレビュー**:
- 設定内容をリアルタイムで確認可能
- 例: `AA-1001`, `A_001`, `RACK-A-0001`, `1001`

**実装ファイル**: `sidebar_config.html`, `config_loader.js`, `product.js`, `id.js`

#### 設定マスタシート

**シート名**: `設定マスタ`

**構造**:
```
カテゴリ | 項目1 | 項目2 | 項目3 | 値
---------|-------|-------|-------|-----
商品状態ボタン | 新品、未使用 | タグ付き未使用 | | タグ付き未使用品です。
ハッシュタグ | 全商品プレフィックス | | | #REBORN_
割引情報 | フォロー割 | 〜2,999円 | | 100円引
割引情報 | リピート割 | 説明文 | | 「リピート割希望」とコメントにてお知らせください。
配送デフォルト | 配送料の負担 | | | 送料込み(出品者負担)
管理番号設定 | 棚番号使用 | | | true
```

**自動生成**:
- `setup_config.js`の`setupConfigSheet()`関数で自動生成可能
- Apps Scriptエディタで実行するだけで初期設定が完了

**キャッシュ**:
- 5分間キャッシュ（パフォーマンス向上）
- 保存時に自動でキャッシュクリア

**実装ファイル**: `config_loader.js`, `setup_config.js`

---

### 3. 在庫管理（0%完成）

**現状**: メニューUI未実装、未着手

---

### 4. マスタデータ管理（30%完成）

**現状**: メニューUI未実装、データ分離のみ完了

#### 手動管理シート分離

**シート構成**:
```
マスタデータ（31列）
├── 仕入先、出品先、担当者
├── サイズ、商品の状態
├── 配送料の負担、配送の方法、発送元の地域、発送までの日数
├── 素材(箇所)、素材(種類)
├── セールスワード(カテゴリ)、セールスワード
└── タイトル情報（18項目）

手動管理_ブランド（52,667件）
├── ブランド(英語)
└── ブランド(カナ)

手動管理_アイテム分類（1,686件）
├── 大分類
├── 中分類
├── 小分類
├── 細分類1
├── 細分類2
└── アイテム名

設定マスタ（新規）
├── 商品状態ボタン
├── ハッシュタグ
├── 割引情報
├── 配送デフォルト
└── 管理番号設定
```

---

### 5. 売上分析（20%完成）

**現状**: メニューUI未実装、未着手

---

## データ構造

### スプレッドシート構成

**メインファイル**: 在庫/売上管理表

#### シート一覧

```
在庫/売上管理表（メインデータ）
├── 管理情報: 棚番号、商品番号、管理番号、担当者
├── 商品情報: ブランド、商品名、カテゴリ、サイズ
├── 説明文: セールスワード、商品説明、状態詳細
├── サイズ詳細: 肩幅、身幅、袖丈、着丈、ウエスト、ヒップ、股上、股下
├── 仕入情報: 仕入日、仕入先、仕入金額
├── 出品情報: 出品日、出品先、出品金額
└── 配送情報: 配送料負担、配送方法、発送元、発送日数

マスタデータ
└── 31列のマスタ項目

手動管理_ブランド
└── 52,667件（英語・カナ）

手動管理_アイテム分類
└── 1,686件（6階層分類）

設定マスタ（新規）
└── 5カテゴリの設定項目
```

### FIELD_IDS配列（全フィールド定義）

```javascript
const FIELD_IDS = [
  '棚番号','商品番号','担当者',
  'セールスワード(カテゴリ)','セールスワード',
  'ブランド(英語)','ブランド(カナ)',
  '商品名(タイトル)',
  '大分類(カテゴリ)','中分類(カテゴリ)','小分類(カテゴリ)',
  '細分類(カテゴリ)','細分類2',
  'サイズ','商品の状態',
  'アイテム名',
  '商品の説明',
  '商品状態詳細',
  '肩幅','身幅','袖丈','着丈','ウエスト','ヒップ','股上','股下',
  '仕入日','仕入先','仕入金額',
  '出品日','出品先','出品金額',
  '配送料の負担','配送の方法','発送元の地域','発送までの日数'
];
```

### フィールドマッピング（列名変換）

```javascript
const fieldMapping = {
  '大分類(カテゴリ)': '大分類',
  '中分類(カテゴリ)': '中分類',
  '小分類(カテゴリ)': '小分類',
  '細分類(カテゴリ)': '細分類1',
  '商品状態詳細': '商品状態(詳細)'
};
```

---

## 過去のトラブルと教訓

### ❌ 問題①: プルダウンの選択肢が表示されない

**症状**: 担当者、サイズ、商品の状態、素材などのプルダウンをクリックしても選択肢が表示されない

**原因**: `_findIdx()`関数が配列形式のエイリアスを正しく処理できていなかった

```javascript
// ❌ NG
arr.indexOf(targets) // targets が配列の場合、配列全体を検索してしまう
```

**解決策**:

```javascript
function _findIdx(arr, targets) {
  // targetsが配列の場合、各エイリアスを順番に試す
  if (Array.isArray(targets)) {
    for (const target of targets) {
      const index = arr.indexOf(target);
      if (index !== -1) return index;
    }
    return -1;
  }
  // 配列でない場合は従来通り
  return arr.indexOf(targets);
}
```

**教訓**:
- エイリアス配列は各要素を順番に検索する必要がある
- `Array.isArray()`で型チェックを必ず行う

---

### ❌ 問題②: 新規行追加時に数式が消える

**症状**: 保存時に新規行が追加されるが、元々数式が入っているセルが空白になる

**原因**:
- `clearContent()`を使用していたため、数式も削除されていた
- `PASTE_NORMAL`は値も一緒にコピーするため、前の行の値が引き継がれてしまう

**解決策**:

```javascript
// ❌ NG: これだと数式が消える
src.copyTo(dst, SpreadsheetApp.CopyPasteType.PASTE_NORMAL, false);
dst.clearContent();

// ✅ OK: 個別にコピー
srcRange.copyTo(dstRange, SpreadsheetApp.CopyPasteType.PASTE_FORMULA, false);
srcRange.copyTo(dstRange, SpreadsheetApp.CopyPasteType.PASTE_FORMAT, false);
srcRange.copyTo(dstRange, SpreadsheetApp.CopyPasteType.PASTE_DATA_VALIDATION, false);
```

**教訓**:
- 行コピー時は`PASTE_FORMULA`, `PASTE_FORMAT`, `PASTE_DATA_VALIDATION`を個別に使用
- `PASTE_NORMAL`や`clearContent()`は使用禁止
- 数式の相対参照は自動的に+1される

---

### ❌ 問題③: 大分類〜細分類、アイテム名が保存されない

**症状**: フォームで選択した分類情報がスプレッドシートに反映されない

**原因**: フォームのID（例: `大分類(カテゴリ)`）とスプレッドシートの列名（例: `大分類`）が一致していなかった

**解決策**:

```javascript
// product.js の PRODUCT_FIELDS を実際のシート列名に変更
const PRODUCT_FIELDS = [
  // ❌ NG: '大分類(カテゴリ)'
  // ✅ OK:
  '大分類','中分類','小分類','細分類1','細分類2',
  'アイテム名'
];

// または、saveProduct() 内でマッピングを追加
const fieldMapping = {
  '大分類(カテゴリ)': '大分類',
  '中分類(カテゴリ)': '中分類',
  '小分類(カテゴリ)': '小分類',
  '細分類(カテゴリ)': '細分類1',
  '商品状態詳細': '商品状態(詳細)'
};
```

**教訓**:
- フォームID、JavaScript変数名、スプレッドシート列名が異なる場合は、必ず`fieldMapping`で明示的にマッピングする
- 推測せず、必ず実際の列名を確認してからコーディングする
- `config.js`の`HEADER_ALIASES`でエイリアス定義があっても、実際の保存時は実列名を使う

---

### ❌ 問題④: 罫線が太く表示される

**症状**: 新規行追加時に罫線が太く表示される

**原因**:
- 既存行の下側に太い罫線が設定されていた
- `PASTE_FORMAT`でその罫線スタイルもコピーされた

**解決策**:

```javascript
// ✅ OK: PASTE_FORMAT で既存行の罫線をそのままコピー
srcRange.copyTo(dstRange, SpreadsheetApp.CopyPasteType.PASTE_FORMAT, false);

// ❌ NG: 手動で罫線を設定すると太さが変わる
dstRange.setBorder(true, null, null, null, null, null, '#000000', SpreadsheetApp.BorderStyle.SOLID);
```

**教訓**:
- 罫線は`PASTE_FORMAT`で既存行からコピーするのが最も安全
- 手動で`setBorder()`を使う場合は、既存行の罫線スタイルが影響する
- スプレッドシート側で既存行の罫線を統一しておく

---

### ❌ 問題⑤: 細分類1・細分類2のバグ

**症状**: 入力して保存した後、細分類1と細分類2の列だけ1つ上の行の値がそのままコピーされて入っている

**原因**: 行コピー時に`PASTE_FORMULA`で数式をコピーしたが、値も一緒にコピーされてしまった

**解決策**:

```javascript
// コピー後、数式以外のセル（値が入っているセル）を空文字でクリア
const values = dstRange.getValues()[0];
const formulas = dstRange.getFormulas()[0];
for (let i = 0; i < values.length; i++) {
  // 数式がないセルで値が入っている場合のみクリア
  if (!formulas[i] && values[i] !== '') {
    sh.getRange(targetRow, i + 1).setValue('');
  }
}
```

**実装箇所**: `product.js` lines 161-169

**教訓**:
- 行コピー後、数式以外のセルに値が残っている場合は明示的にクリアする
- 数式セルと値セルを区別して処理する

---

### ❌ 問題⑥: 商品状態ボタンのテキストが追加されてしまう

**症状**: 別のボタンを押すと前のボタンで入った文章がそのまま残っていて、その後に新しい文章が入るようになっている

**原因**: ボタンクリック時にテキストを追加（append）していた

**解決策**:

```javascript
// ❌ NG: 追加
if (currentValue.trim()) {
  textarea.value = currentValue + '\n' + text;
}

// ✅ OK: 置き換え
textarea.value = text;
```

**実装箇所**: `sp_scripts.html` line 276

**教訓**:
- ボタンの挙動は常に「置き換え」にする
- 追加したい場合は別のUIを用意する

---

### ❌ 問題⑦: ハッシュタグと割引情報が設定マスタから反映されない

**症状**: 設定マスタシートで値を変更しても、商品の説明プレビューに反映されない

**原因**: 設定を非同期で読み込んでいたが、読み込み完了前にプレビューが生成されていた

**解決策**:

```javascript
// 設定読み込み成功時に商品の説明を更新
.withSuccessHandler(function(config) {
  if (config) {
    HASHTAG_CONFIG = config;
    // 読み込み後、プレビューを更新
    if (typeof updateDescriptionFromDetail === 'function') {
      updateDescriptionFromDetail();
    }
  }
})
```

**実装箇所**: `sp_scripts.html` lines 430-437, 470-477

**教訓**:
- 非同期処理の完了を待ってから次の処理を実行する
- 成功ハンドラー内でUIを更新する

---

## 開発ルール

### ✅ 開発時のチェックリスト

#### フィールド追加時
- [ ] フォームIDとスプレッドシート列名が一致しているか確認
- [ ] 一致していない場合は`fieldMapping`に追加
- [ ] `FIELD_IDS`（フロントエンド）に追加
- [ ] `PRODUCT_FIELDS`（バックエンド）に**実際のシート列名**で追加

#### 行コピー処理変更時
- [ ] `PASTE_FORMULA`, `PASTE_FORMAT`, `PASTE_DATA_VALIDATION`を個別使用
- [ ] `clearContent()`を使用していないか確認
- [ ] 数式が正しく引き継がれるかテスト
- [ ] 数式以外のセルに値が残っていないか確認

#### マスタデータ追加時
- [ ] `HEADER_ALIASES`にエイリアス定義を追加
- [ ] `_findIdx()`が配列形式のエイリアスを処理できることを確認

#### 設定マスタ追加時
- [ ] `config_loader.js`の`loadConfigMaster()`に読み込み処理を追加
- [ ] `config_loader.js`の`saveConfigMaster()`に保存処理を追加
- [ ] `setup_config.js`にデフォルトデータを追加
- [ ] `sidebar_config.html`にUI要素を追加
- [ ] キャッシュクリア処理を確認

#### デバッグ時
- [ ] `console.log()`でフォームから送信されたデータを確認
- [ ] 実際のシート列名を確認
- [ ] Apps Scriptの「実行ログ」でエラーを確認

---

### ❌ 禁止事項

#### コーディング
- ❌ `PASTE_NORMAL`を使用しない（数式が消える）
- ❌ `clearContent()`を数式が入っている範囲に使用しない
- ❌ フィールド名を推測しない（必ず実際の列名を確認）
- ❌ 手動で`setBorder()`を使用しない（罫線が太くなる可能性）
- ❌ デフォルト値をコード内にハードコードしない（設定マスタを使用）

#### ワークフロー
- ❌ Apps Script webエディタで直接編集しない
- ❌ `clasp push`せずにブラウザをリロードしない
- ❌ ローカルファイルを編集した後に`clasp pull`しない（上書きされる）

---

### 📝 トラブルシューティング

#### プルダウンが表示されない
1. `master.js`の`_findIdx()`が配列形式のエイリアスを処理できるか確認
2. マスタデータシートに該当列が存在するか確認
3. `HEADER_ALIASES`にエイリアス定義があるか確認

#### データが保存されない
1. フォームIDとスプレッドシート列名が一致しているか確認
2. `fieldMapping`にマッピングがあるか確認
3. `console.log()`でフォームデータが送信されているか確認
4. Apps Scriptの実行ログでエラーが出ていないか確認

#### 数式が消える
1. `PASTE_NORMAL`を使用していないか確認
2. `clearContent()`を使用していないか確認
3. `PASTE_FORMULA`, `PASTE_FORMAT`, `PASTE_DATA_VALIDATION`を個別使用しているか確認

#### 設定が反映されない
1. 設定マスタシートに正しくデータが保存されているか確認
2. キャッシュがクリアされているか確認（`clearConfigCache()`）
3. ブラウザをスーパーリロード（Cmd+Shift+R）
4. 非同期読み込みが完了しているか確認

---

## 次の実装予定

### 短期（2週間以内）- 商品登録残り20%部分

#### 1. ブランド(カナ)の頭に半角スペース

**現状**: `【セール】UNIQLOユニクロ ニット`
**変更後**: `【セール】UNIQLO ユニクロ ニット`

- ブランド(英語)の前: スペースなし（現状維持）
- ブランド(カナ)の前: 半角スペース追加

#### 2. ブランド名自動反映

**機能**:
- 基本情報ブロックでブランド選択
- ↓ 自動反映
- 商品名ブロックのブランド(英語)・ブランド(カナ)

**追加要件**:
- 商品名ブロックのブランド名をテキスト編集可能にする
- 編集した値も商品名プレビューに反映

**理由**: 略称で入力したい場合がある（例: ユニクロ → ユニ）

#### 3. 商品属性の動的追加

**現状**: 固定3セット（見た目が分かりにくい）

**変更後**:
- デフォルト1セット表示
- 素材ブロックと同様の動的追加
- 「+ 商品属性を追加」ボタン
- 見た目スッキリ

**実装参考**: `sp_scripts.html`の`addMaterial()`

#### 4. サイズ全般の表記修正と新規追加１

**変更内容**:

テキスト削除:
- 「トップス／アウター」「パンツ」の文字削除
- 代わりにアイコン設置（👕 👖）

表記変更:
- 「サイズ」→「サイズ(実寸)」

新規追加:
- 「サイズ(表記)」プルダウン追加
- マスタデータの「サイズ(表記)」列を参照

プレビュー表示統一:
```
サイズ(表記)
M

サイズ(実寸)
肩幅：45cm
身幅：50cm
...
```

#### 5. サイズ全般の表記修正と新規追加２

**レイアウト変更**: 縦配置 → 2列並び

```
現状:          変更後:
肩幅           肩幅    身幅
身幅    →      袖丈    着丈
袖丈
着丈
```

**例外処理**: ラグランTシャツ・ラグランスウェット
- 「肩幅」→「裄丈」に変更
- メンズ・レディース両方対応
- アイテム名で判定

#### 6. カラー(詳細)追加

**新規機能**:
- 商品の説明ブロック内に追加
- マスタデータの「カラー/配色/トーン」列を参照
- 複数選択可能（黒 + ブラック、2色以上の服対応）
- プレビュー配置: ブランド名の下

**表示例**:
```
ブランド名
UNIQLO（ユニクロ）

カラー(詳細)
黒、ブラック
```

#### 7. コピーボタン実装

**機能**:
- 商品名コピーボタン
- 商品説明コピーボタン
- ワンクリックでクリップボードにコピー
- メルカリページで貼り付け

**実装位置**:
- 商品名プレビューの近く
- 商品説明プレビューの近く

#### 8. コードレビュー・リファクタリング

**目的**: Gemini API実装前にコードを最適化

**実施内容**:

1. **重複コードの統合**
   ```javascript
   // 例: getSheet_(), getSheet() を統一
   function getMainSheet() {
     return SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
   }
   ```

2. **長い関数の分割**
   ```javascript
   // 分割例
   function updateDescriptionFromDetail() {
     const brandText = getBrandInfo();
     const sizeText = getSizeInfo();
     const materialText = getMaterialInfo();
     const detailText = getDetailInfo();
     const hashtags = generateHashtags();

     const description = buildDescription(brandText, sizeText, materialText, detailText, hashtags);
     updateDescriptionField(description);
   }
   ```

3. **マジックナンバーの定数化**
   ```javascript
   // NG
   if (length > 40) { ... }

   // OK
   const MAX_TITLE_LENGTH = 40;
   if (length > MAX_TITLE_LENGTH) { ... }
   ```

4. **命名規則の統一**
   - 関数名: camelCase
   - 定数: UPPER_SNAKE_CASE
   - プライベート関数: _functionName()

5. **パフォーマンス最適化**
   - ブランド検索の高速化（既に実装済みだが他にも適用）
   - キャッシュの積極活用
   - 不要なループの削除

6. **コメント追加**
   - 複雑なロジックに説明追加
   - 関数の引数・戻り値を明記

7. **エラーハンドリングの統一**
   - `error_handler.js`を全体で活用
   - 一貫したエラーメッセージ

**重点チェック箇所**:
- 過去のトラブル箇所（`_findIdx()`, 列名マッピング等）
- 38ファイルの役割分担が適切か
- 重複コードの有無

#### 9. エラーハンドリング強化

**目的**: Gemini API実装前にエラー処理を強化

**実施内容**:

1. **バリデーション統一**
   ```javascript
   // 例: 商品番号入力時
   input.addEventListener('blur', () => {
     const result = validateField('商品番号', input.value);
     if (!result.isValid) {
       showError(result.message);
     }
   });
   ```

2. **ユーザー向けエラーメッセージ改善**
   ```javascript
   // NG
   return "NG(VALIDATION): Error occurred";

   // OK
   return "商品番号は1001以上の数値で入力してください（現在の値: abc）";
   ```

3. **ログ記録機能追加**
   ```javascript
   function logError(error, context) {
     const logEntry = {
       timestamp: new Date().toISOString(),
       type: error.type,
       message: error.message,
       context: context
     };
     // ログシートに書き込み
     writeToLogSheet(logEntry);
   }
   ```

4. **リトライ機構実装**
   ```javascript
   function retryableExecute(fn, maxRetries = 3) {
     for (let i = 0; i < maxRetries; i++) {
       try {
         return fn();
       } catch (error) {
         if (i === maxRetries - 1) throw error;
         console.log(`Retry ${i + 1}/${maxRetries}`);
       }
     }
   }
   ```

5. **フォールバック処理**
   ```javascript
   function getMasterDataSafe(fieldName) {
     try {
       return getMasterData(fieldName);
     } catch (error) {
       console.warn('マスタデータ取得失敗、キャッシュを使用:', error);
       return getCachedMasterData(fieldName);
     }
   }
   ```

---

### 短期（1ヶ月〜2ヶ月以内）- Gemini API統合

#### 1. AI商品説明文自動生成

**機能概要**:
- 「AI生成」ボタン設置
- 商品登録メニュー内の入力情報をAIが読み込み
- 服のアピールポイントを自動生成（200〜300文字）
  - 商品概要
  - コーディネート案
  - 着用シーン
- 商品の説明プレビューに反映

**実装手順**:
1. Gemini APIキー設定
2. プロンプト設計
3. API呼び出し処理
4. レスポンスのパース・表示
5. エラーハンドリング

**プロンプト例**:
```javascript
const prompt = `
以下の商品情報からメルカリ用の魅力的な商品説明文を200〜300文字で作成してください。

ブランド: ${brandName}
アイテム: ${itemName}
カテゴリ: ${category}
サイズ: ${size}
状態: ${condition}
素材: ${material}
カラー: ${color}

以下の要素を含めてください：
- 商品の特徴
- コーディネート提案
- おすすめの着用シーン
`;
```

**実装ファイル**:
- 新規: `gemini_api.js`
- 修正: `sp_block_description.html`（ボタン追加）
- 修正: `sp_scripts.html`（API呼び出し処理）

#### 2. Gemini Vision API統合（画像解析）

**機能概要**:
- 商品画像アップロード機能（1〜3枚）
- AIが画像を解析
- より精度の高い商品説明文を生成

**実装手順**:
1. 画像アップロードUI作成
2. 画像のBase64エンコード
3. Gemini Vision API呼び出し
4. 画像解析結果と入力情報を統合
5. 説明文生成

**実装ファイル**:
- 修正: `gemini_api.js`
- 新規: `sp_block_image.html`（画像アップロード）

#### 3. 価格最適化提案

**機能概要**:
- 画像解析結果から適正価格を提案
- 出品金額フィールドに自動反映
- 参考価格として表示

**プロンプト例**:
```javascript
const pricePrompt = `
以下の商品情報から、メルカリでの適正な出品価格を提案してください。

ブランド: ${brandName}
アイテム: ${itemName}
状態: ${condition}
仕入価格: ${purchaseAmount}円

価格のみを数値で回答してください。
`;
```

#### 4. データエクスポート機能

**機能概要**:
- メルカリShopsのCSV一括出品用ファイル生成
- 商品登録データをCSV形式でエクスポート

**実装内容**:
- CSVヘッダー定義（メルカリShops仕様に準拠）
- データ変換処理
- ダウンロード機能
- 複数商品の一括エクスポート

**実装ファイル**:
- 新規: `export.js`
- 修正: `menu.js`（メニュー追加）

---

### 中期（2ヶ月〜3ヶ月以内）

**注意**: 大まかな内容のため、開発が進む中で具体化

#### 1. 在庫管理機能

**ジャンプ機能**:
- 管理番号ブロック設置（商品登録と同様）
- 管理番号を選択・検索
- 該当行にジャンプ

**販売情報**:
- 販売日、販売先、販売金額の入力
- UIは仕入情報・出品情報と同様
- シートに保存

**発送情報**:
- 発送方法、梱包資材の選択
- 選択値に基づく自動計算
- 利益計算に反映

**実装ファイル**:
- 修正: `inventory.js`（既存関数あり）
- 新規: UIブロック

#### 2. 売上管理

**統合データ**:
- 仕入情報（商品登録メニュー）
- 出品情報（商品登録メニュー）
- 販売情報（在庫管理メニュー）
- 発送情報（在庫管理メニュー）
- 備品管理データ

**実装予定**:
- 売上・利益の自動計算
- 担当者別報酬の自動計算
- 売上分析ダッシュボード
- 確定申告用書類の出力

#### 3. 備品管理システム

**機能**:
- 在庫アラート機能
- 自動発注システム
- 売上管理との連動

**実装内容**:
- 備品マスタ作成
- 在庫数管理
- 閾値設定・アラート
- 発注処理（将来的に自動化）

#### 4. LINEもしくはSlack通知機能

**目的**: チーム利用・外注スタッフへの自動通知

**通知内容**:
- 商品の発送依頼
- 在庫アラート
- 売上レポート
- タスク完了通知

**実装方法**:
- LINE Messaging API または Slack Webhook
- GASのトリガー機能活用

#### 5. 売上分析ダッシュボード

**表示内容**:
- 売上推移グラフ
- 利益率分析
- 担当者別パフォーマンス
- カテゴリ別売上
- 在庫回転率

**実装技術**:
- Google Data Studio連携
- またはHTML Service + Chart.js

#### 6. モバイル対応UI改善

**目的**:
- 個人・チームでの使い勝手向上
- 将来のSaaS化に向けた準備

**対応内容**:
- レスポンシブデザイン
- タッチ操作最適化
- モバイル専用UI
- PWA化（検討）

---

### 長期（3ヶ月以上）

#### 1. メルカリShops専用システム開発

**内容**:
- メルカリShops特有の機能対応
- CSV一括出品の強化
- ショップ管理機能

#### 2. 課金制SaaSビジネス化

**構想**:
- 同業者（メルカリでファッション系物販を行う副業者・個人事業主）向けサービス提供
- サブスクリプション課金モデル
- ユーザー管理・権限設定
- マルチテナント対応

**技術的課題**:
- GASからクラウドプラットフォームへの移行検討
- データベース（Firestore、Supabase等）
- 認証システム（Firebase Auth等）
- 決済システム（Stripe等）

#### 3. Yahoo!フリマやラクマ対応

**内容**:
- メルカリ以外のプラットフォーム対応
- マルチプラットフォーム一括管理
- プラットフォーム別最適化

---

## 技術的な重要ポイント

### アーキテクチャの特徴

#### 1. モジュラー設計

HTMLファイルを機能ごとに分割し、`include()`で組み合わせ

```html
<?!= include('sp_block_manage'); ?>
<?!= include('sp_block_basic'); ?>
```

**メリット**:
- 保守性が高い
- 再利用性が高い
- 見通しが良い

#### 2. 列名ベースマッピング

フィールドIDとスプレッドシート列名の柔軟な対応

```javascript
const fieldMapping = {
  '大分類(カテゴリ)': '大分類',
  '中分類(カテゴリ)': '中分類',
  // ...
};
```

#### 3. データ取得優先順位

1. 設定マスタシート（最優先）★新規
2. マスタデータシート
3. 手動管理シート
4. デフォルト値（コード内フォールバック）

#### 4. キャッシュ機構

設定マスタデータを5分間キャッシュしてパフォーマンス向上

```javascript
const CACHE_DURATION = 5 * 60 * 1000;
let CONFIG_CACHE = null;
let CONFIG_CACHE_TIMESTAMP = null;
```

#### 5. エラーハンドリング階層

1. フロント側バリデーション
2. バックエンドバリデーション
3. データ整合性チェック
4. ビジネスロジックバリデーション

---

### パフォーマンス最適化

#### 1. ブランド検索の高速化

インデックスマップ活用 - 52,667件から瞬時に候補表示

```javascript
const BRAND_INDEX_MAP = new Map();
BRAND_PAIRS.forEach((pair, index) => {
  BRAND_INDEX_MAP.set(pair.english, index);
});
```

#### 2. DOM要素のキャッシュ

```javascript
const elementCache = new Map();

function _val(id) {
  if (!elementCache.has(id)) {
    elementCache.set(id, document.getElementById(id));
  }
  return elementCache.get(id).value;
}
```

#### 3. 一括データ取得

複数のマスタデータを1回のAPI呼び出しで取得

```javascript
function getBulkInitializationData() {
  return {
    masterOptions: getMasterOptionsOptimized(),
    categoryData: getCategoryRowsOptimized(),
    topBrandsEn: getBrandData('ブランド(英語)').slice(0, 100),
    // ...
  };
}
```

#### 4. 設定マスタの非同期読み込み

ページロード時に設定マスタを非同期で読み込み、UIをブロックしない

```javascript
window.onload = function() {
  loadConditionButtonsFromConfig();
  loadHashtagConfig();
  loadDiscountConfig();
  loadShippingDefaults();
};
```

---

### セキュリティ・データ保護

#### 1. バックアップ体制

- GitHub（コード）
- VSCode（ローカル）
- スプレッドシートの定期バックアップ
- 設定マスタシートの自動生成機能（復旧用）

#### 2. データバリデーション

- フロント側：即座にエラー表示
- バックエンド側：保存前に厳密チェック
- ビジネスロジック：整合性確認

#### 3. 権限管理（今後実装）

- 担当者による権限の強弱
- 複数ユーザー対応

---

## 開発者向け情報

### ユーザー・チーム体制

**現在**:
- 開発者: 1名（非エンジニア）
- 運用者: 将来的に数名で使用予定

**将来**:
- チームメンバー
- 外注スタッフ
- SaaS化後: 複数テナント

---

### 開発優先順位の考え方

1. **短期（2週間）**: 商品登録の完成度を100%に
2. **短期（1-2ヶ月）**: Gemini API統合で差別化
3. **中期（2-3ヶ月）**: チーム利用の基盤整備
4. **長期（3ヶ月以上）**: SaaS化に向けた準備

---

## 最終確認事項

### データの正確性

- **ブランドデータ**: 52,667件
- **アイテム分類**: 1,686件
- **マスタデータ**: 31列
- **設定マスタ**: 5カテゴリ（動的）

### 完成度

- **全体**: 40%
- **商品登録**: 80%
- **設定管理**: 90% ★新規
- **在庫管理**: 0%
- **マスタデータ管理**: 30%
- **売上分析**: 20%

### 次の最優先タスク

1. 商品登録の残り機能実装（ブランド自動反映、サイズ表記改善など）
2. コードレビュー・リファクタリング
3. Gemini API統合準備

---

**このドキュメントは Claude Code が効率的に開発を進めるための完全なリファレンスです。**

**最終更新日**: 2025年（設定管理システム実装完了時）
