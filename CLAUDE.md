# REBORN プロジェクト - 開発ドキュメント

古着物販管理システム（Google Apps Script + スプレッドシート）

**完成度: 30%** | **商品登録: 70%** | **在庫管理: 0%** | **売上分析: 20%**

---

## 📋 目次

1. [プロジェクト概要](#プロジェクト概要)
2. [技術スタック](#技術スタック)
3. [ファイル構成（32ファイル）](#ファイル構成)
4. [実装済み機能](#実装済み機能)
5. [データ構造](#データ構造)
6. [過去のトラブルと教訓](#過去のトラブルと教訓)
7. [開発ルール](#開発ルール)
8. [次の実装予定](#次の実装予定)

---

## プロジェクト概要

### ビジネス背景

古着の**仕入れからメルカリ等での販売**まで、物販事業の全工程を超効率化するシステム。非エンジニアがAI + ライブコーディングで開発中。

### 開発目標

- **短期**: 個人 + チームでの業務効率化
- **中期**: 単純作業の外注化、AIによる半自動出品
- **長期**: 同業者向けSaaS化（課金制ビジネス）

---

## 技術スタック

### コア技術

```
Google Apps Script (GAS)
├── バックエンド: JavaScript (ES6+)
├── データベース: Google スプレッドシート
├── フロントエンド: HTML Service + Bootstrap 5
└── デプロイ: clasp (Google Apps Script CLI)
```

### 開発環境

```
ローカル開発
├── エディタ: Visual Studio Code
├── バージョン管理: Git + GitHub (Private)
└── 同期ツール: clasp
```

### 開発ワークフロー

```bash
# 1. ローカルでコード編集（VSCode）
# 2. GASにプッシュ
clasp push

# 3. ブラウザでテスト（スーパーリロード: Cmd+Shift+R）
clasp open

# 4. 動作確認後、Gitにコミット
git add .
git commit -m "feat: 新機能追加"
git push origin main
```

### 今後の統合予定

```
AI機能
├── Gemini API: 商品説明文自動生成
├── Gemini Vision API: 画像解析
└── 価格最適化提案

開発効率化ツール
├── Claude Code: AI駆動開発（導入済み）
├── Serena MCP: リポジトリ全体把握精度向上
└── CLAUDE.md: 完全開発ドキュメント（このファイル）
```

---

## ファイル構成

### 全32ファイル構成

#### JSファイル（20個）

**コアシステム**
```
config.js                    # システム全体設定・FIELD_IDS定義
menu.js                      # メニュー表示・サイドバー制御
common.js                    # 共通ユーティリティ統合
utils.js                     # ユーティリティ（最小版）
error_handler.js             # 統一エラーハンドリングシステム
```

**商品管理**
```
product.js                   # 商品登録（列名ベースマッピング）★重要
inventory.js                 # 在庫管理（検索・更新・利益計算）
id.js                        # 管理番号生成（自動採番）
```

**マスタデータ管理**
```
master.js                    # マスタデータ取得 ★最重要
master_hierarchy.js          # セールスワード関連機能のみ
master_utils.js              # マスタ共通処理（シート名取得等）
master_simple.js             # 手動管理シート用シンプルマスタ取得
master_data_manager.js       # マスタデータ管理統括（軽量・安全版）
master_data_reducer.js       # データ削減システム（段階的実行版）
```

**最適化・検証**
```
performance_optimizer.js     # パフォーマンス最適化（キャッシュ機能）
data_integrity.js            # データ整合性確保（重複チェック等）
validation_enhancer.js       # 強化されたバリデーションシステム
diagnosis.js                 # システム診断
test_master.js               # テスト用
```

#### HTMLファイル（12個）

**メインUI**
```
sidebar_product.html         # 商品登録メインUI（テンプレート構造）
sidebar_inventory.html       # 在庫管理サイドバー（最小版）
inventory_sidebar.html       # 在庫管理UIサイドバー
master_manager_ui.html       # マスタデータ管理UI
```

**スクリプト・スタイル**
```
sp_scripts.html              # JavaScript処理 ★最重要・最大規模
sp_styles.html               # CSSスタイルシート（包括的）
```

**商品登録UIブロック（モジュラー設計）**
```
sp_block_manage.html         # 管理番号入力ブロック
sp_block_basic.html          # 基本情報入力ブロック
sp_block_title.html          # 商品名作成ブロック
sp_block_description.html    # 商品の説明ブロック
sp_block_shipping.html       # 配送情報ブロック
sp_block_procure.html        # 仕入情報ブロック
sp_block_listing.html        # 出品情報ブロック
sp_block_kodawari.html       # こだわり条件ブロック
```

### 主要ファイルの役割

#### master.js（最重要）

- 統合マスタオプション取得（マスタデータ最優先→手動管理シート→メインシート順）
- セールスワード専用データ取得（19カテゴリ×連動キーワード）
- ブランドペアデータ取得（英語名52,667件 + カナ読みの正確な対応関係）
- 商品保存処理（列名ベースマッピング、数式コピー、書式継承）

#### sp_scripts.html（最重要・最大規模）

- ブランド管理システム（2行表示オートコンプリート、高速検索）
- セールスワードシステム（カテゴリ連動）
- カテゴリ階層管理（6段階連動）
- 商品名リアルタイムプレビュー（40文字カウント）
- 商品の説明自動生成（ブランド+サイズ+素材+状態+ハッシュタグ+割引情報）
- 素材管理システム（動的追加、最大10個）
- 動的サイズシステム（カテゴリ別表示切替）

#### product.js（重要）

- `saveProduct()`: 商品保存（フィールドマッピング、バリデーション、行挿入）
- 行挿入処理（数式・書式・データ検証を最下行からコピー）
- `getNextItemNumber()`: 棚番号別の次の商品番号取得

---

## 実装済み機能

### 1. 商品登録（70%完成）

#### 管理番号自動採番機能

- 頭文字（A-Z）+ 棚番号（AA-ZZ）選択
- 未使用の最小商品番号を自動採番（1001から開始）
- 管理番号形式: `AA-1001`

**実装ファイル**: `id.js`, `sp_block_manage.html`

#### 分類カテゴリ6階層プルダウン

- 大分類 → 中分類 → 小分類 → 細分類1 → 細分類2 → アイテム名
- 階層連動（上位選択で下位が有効化）
- サイズ詳細入力機能に連動

**データ件数**: 1,686件（手動管理_アイテム分類）
**実装ファイル**: `master.js`, `sp_scripts.html`, `sp_block_basic.html`

#### ブランド名2段式表示オートコンプリート機能

- 英語50,000 + カナ50,000 = 合計100,000超の候補から瞬時に検索
- 大文字小文字区別なし、部分マッチ可能
- 最大15件表示
- 2行表示（英語名 + カナ読み）
- メルカリと同様のUI

**データ件数**: 52,667件（手動管理_ブランド）
**実装ファイル**: `master.js`, `sp_scripts.html`, `sp_styles.html`

```javascript
// ブランド検索の高速化（インデックスマップ活用）
const BRAND_INDEX_MAP = new Map();
BRAND_PAIRS.forEach((pair, index) => {
  BRAND_INDEX_MAP.set(pair.english, index);
});
```

#### 商品名選択式自動作成

- リアルタイムプレビュー（入力中に即座に反映）
- 40文字カウンター（超過時警告）
- SEO最適化された商品名の半自動生成

**構成要素**:
1. セールスワード
2. ブランド名（英語/カナ）
3. アイテム名
4. 商品属性（3つまで）

**実装ファイル**: `sp_scripts.html`, `sp_block_title.html`

#### セールスワード連動選択

- 19カテゴリ × 連動キーワード
- カテゴリ選択でキーワードが自動更新
- 商品名プレビューに自動反映

**実装ファイル**: `master.js`, `sp_scripts.html`

#### 商品の説明選択式自動作成

- リアルタイムプレビュー
- 1000文字カウンター（超過時警告）

**自動生成される要素**:
1. ブランド情報
2. サイズ情報（実寸）
3. 素材情報
4. 商品状態（詳細）
5. オリジナルハッシュタグ
6. 割引情報（フォロー割・リピート割・まとめ割）

**実装ファイル**: `sp_scripts.html`, `sp_block_description.html`

#### サイズ詳細入力機能

- カテゴリ自動判定（トップス/パンツ）
- プルダウン選択（20-120cm、1cm刻み）
- 商品の説明に自動反映

**トップス/アウター**: 肩幅、身幅、袖丈、着丈
**パンツ**: ウエスト、ヒップ、股上、股下

**実装ファイル**: `sp_scripts.html`, `sp_block_description.html`

#### ハッシュタグ自動生成

**生成例**:
```
#REBORN_全商品
#REBORN_UNIQLOアイテム一覧
#REBORN_トップス一覧
#REBORN_レディースアイテム一覧
#REBORN_レディーストップス一覧
```

**実装ファイル**: `sp_scripts.html`

#### 割引情報自動挿入

- フォロー割（100円〜500円）
- リピート割（200円）
- まとめ割（300円〜1,000円）
- 商品の説明内にデフォルト挿入

#### 配送についてブロック

**デフォルト値**:
- 配送料の負担: 送料込み(出品者負担)
- 配送の方法: ゆうゆうメルカリ便
- 発送元の地域: 岡山県
- 発送までの日数: 1~2日で発送

**実装ファイル**: `sp_block_shipping.html`, `sp_scripts.html`

### 2. 在庫管理（0%完成）

**現状**: メニューUI未実装、未着手

### 3. マスタデータ管理（30%完成）

**現状**: メニューUI未実装、データ分離のみ完了

#### 手動管理シート分離

**シート構成**:
```
マスタデータ（31列）
├── 仕入先、出品先、担当者
├── サイズ、商品の状態
├── 配送料の負担、配送の方法、発送元の地域、発送までの日数
├── 素材(箇所)、素材(種類)
├── セールスワード(カテゴリ)、セールスワード
└── タイトル情報（18項目）

手動管理_ブランド（52,667件）
├── ブランド(英語)
└── ブランド(カナ)

手動管理_アイテム分類（1,686件）
├── 大分類
├── 中分類
├── 小分類
├── 細分類1
├── 細分類2
└── アイテム名
```

### 4. 売上分析（20%完成）

**現状**: メニューUI未実装、未着手

---

## データ構造

### スプレッドシート構成

**メインファイル**: [在庫/売上管理表 - Google スプレッドシート](https://docs.google.com/spreadsheets/)

#### シート一覧

```
在庫/売上管理表（メインデータ）
├── 管理情報: 棚番号、商品番号、管理番号、担当者
├── 商品情報: ブランド、商品名、カテゴリ、サイズ
├── 説明文: セールスワード、商品説明、状態詳細
├── サイズ詳細: 肩幅、身幅、袖丈、着丈、ウエスト、ヒップ、股上、股下
├── 仕入情報: 仕入日、仕入先、仕入金額
├── 出品情報: 出品日、出品先、出品金額
└── 配送情報: 配送料負担、配送方法、発送元、発送日数

マスタデータ
└── 31列のマスタ項目

手動管理_ブランド
└── 52,667件（英語・カナ）

手動管理_ブランド1
└── サブブランドデータ

手動管理_アイテム分類
└── 1,686件（6階層分類）
```

### FIELD_IDS配列（全フィールド定義）

```javascript
const FIELD_IDS = [
  '棚番号','商品番号','担当者',
  'セールスワード(カテゴリ)','セールスワード',
  'ブランド(英語)','ブランド(カナ)',
  '商品名(タイトル)',
  '大分類(カテゴリ)','中分類(カテゴリ)','小分類(カテゴリ)',
  '細分類(カテゴリ)','細分類2',
  'サイズ','商品の状態',
  'アイテム名',
  '商品の説明',
  '商品状態詳細',
  '肩幅','身幅','袖丈','着丈','ウエスト','ヒップ','股上','股下',
  '仕入日','仕入先','仕入金額',
  '出品日','出品先','出品金額',
  '配送料の負担','配送の方法','発送元の地域','発送までの日数'
];
```

### フィールドマッピング（列名変換）

```javascript
const fieldMapping = {
  '大分類(カテゴリ)': '大分類',
  '中分類(カテゴリ)': '中分類',
  '小分類(カテゴリ)': '小分類',
  '細分類(カテゴリ)': '細分類1',
  '商品状態詳細': '商品状態(詳細)'
};
```

---

## 過去のトラブルと教訓

### ❌ 問題①: プルダウンの選択肢が表示されない

**症状**: 担当者、サイズ、商品の状態、素材などのプルダウンをクリックしても選択肢が表示されない

**原因**: `_findIdx()`関数が配列形式のエイリアスを正しく処理できていなかった

```javascript
// ❌ NG
arr.indexOf(targets) // targets が配列の場合、配列全体を検索してしまう
```

**解決策**:

```javascript
function _findIdx(arr, targets) {
  // targetsが配列の場合、各エイリアスを順番に試す
  if (Array.isArray(targets)) {
    for (const target of targets) {
      const index = arr.indexOf(target);
      if (index !== -1) return index;
    }
    return -1;
  }
  // 配列でない場合は従来通り
  return arr.indexOf(targets);
}
```

**教訓**:
- エイリアス配列は各要素を順番に検索する必要がある
- `Array.isArray()`で型チェックを必ず行う

---

### ❌ 問題②: 新規行追加時に数式が消える

**症状**: 保存時に新規行が追加されるが、元々数式が入っているセルが空白になる

**原因**:
- `clearContent()`を使用していたため、数式も削除されていた
- `PASTE_NORMAL`は値も一緒にコピーするため、前の行の値が引き継がれてしまう

**解決策**:

```javascript
// ❌ NG: これだと数式が消える
src.copyTo(dst, SpreadsheetApp.CopyPasteType.PASTE_NORMAL, false);
dst.clearContent();

// ✅ OK: 個別にコピー
srcRange.copyTo(dstRange, SpreadsheetApp.CopyPasteType.PASTE_FORMULA, false);
srcRange.copyTo(dstRange, SpreadsheetApp.CopyPasteType.PASTE_FORMAT, false);
srcRange.copyTo(dstRange, SpreadsheetApp.CopyPasteType.PASTE_DATA_VALIDATION, false);
```

**教訓**:
- 行コピー時は`PASTE_FORMULA`, `PASTE_FORMAT`, `PASTE_DATA_VALIDATION`を個別に使用
- `PASTE_NORMAL`や`clearContent()`は使用禁止
- 数式の相対参照は自動的に+1される

---

### ❌ 問題③: 大分類〜細分類、アイテム名が保存されない

**症状**: フォームで選択した分類情報がスプレッドシートに反映されない

**原因**: フォームのID（例: `大分類(カテゴリ)`）とスプレッドシートの列名（例: `大分類`）が一致していなかった

**解決策**:

```javascript
// product.js の PRODUCT_FIELDS を実際のシート列名に変更
const PRODUCT_FIELDS = [
  // ❌ NG: '大分類(カテゴリ)'
  // ✅ OK:
  '大分類','中分類','小分類','細分類1','細分類2',
  'アイテム名'
];

// または、saveProduct() 内でマッピングを追加
const fieldMapping = {
  '大分類(カテゴリ)': '大分類',
  '中分類(カテゴリ)': '中分類',
  '小分類(カテゴリ)': '小分類',
  '細分類(カテゴリ)': '細分類1',
  '商品状態詳細': '商品状態(詳細)'
};
```

**教訓**:
- フォームID、JavaScript変数名、スプレッドシート列名が異なる場合は、必ず`fieldMapping`で明示的にマッピングする
- 推測せず、必ず実際の列名を確認してからコーディングする
- `config.js`の`HEADER_ALIASES`でエイリアス定義があっても、実際の保存時は実列名を使う

---

### ❌ 問題④: 罫線が太く表示される

**症状**: 新規行追加時に罫線が太く表示される

**原因**:
- 既存行の下側に太い罫線が設定されていた
- `PASTE_FORMAT`でその罫線スタイルもコピーされた

**解決策**:

```javascript
// ✅ OK: PASTE_FORMAT で既存行の罫線をそのままコピー
srcRange.copyTo(dstRange, SpreadsheetApp.CopyPasteType.PASTE_FORMAT, false);

// ❌ NG: 手動で罫線を設定すると太さが変わる
dstRange.setBorder(true, null, null, null, null, null, '#000000', SpreadsheetApp.BorderStyle.SOLID);
```

**教訓**:
- 罫線は`PASTE_FORMAT`で既存行からコピーするのが最も安全
- 手動で`setBorder()`を使う場合は、既存行の罫線スタイルが影響する
- スプレッドシート側で既存行の罫線を統一しておく

---

## 開発ルール

### ✅ 開発時のチェックリスト

#### フィールド追加時
- [ ] フォームIDとスプレッドシート列名が一致しているか確認
- [ ] 一致していない場合は`fieldMapping`に追加
- [ ] `FIELD_IDS`（フロントエンド）に追加
- [ ] `PRODUCT_FIELDS`（バックエンド）に**実際のシート列名**で追加

#### 行コピー処理変更時
- [ ] `PASTE_FORMULA`, `PASTE_FORMAT`, `PASTE_DATA_VALIDATION`を個別使用
- [ ] `clearContent()`を使用していないか確認
- [ ] 数式が正しく引き継がれるかテスト

#### マスタデータ追加時
- [ ] `HEADER_ALIASES`にエイリアス定義を追加
- [ ] `_findIdx()`が配列形式のエイリアスを処理できることを確認

#### デバッグ時
- [ ] `console.log()`でフォームから送信されたデータを確認
- [ ] 実際のシート列名を確認
- [ ] Apps Scriptの「実行ログ」でエラーを確認

---

### ❌ 禁止事項

#### コーディング
- ❌ `PASTE_NORMAL`を使用しない（数式が消える）
- ❌ `clearContent()`を数式が入っている範囲に使用しない
- ❌ フィールド名を推測しない（必ず実際の列名を確認）
- ❌ 手動で`setBorder()`を使用しない（罫線が太くなる可能性）

#### ワークフロー
- ❌ Apps Script webエディタで直接編集しない
- ❌ `clasp push`せずにブラウザをリロードしない
- ❌ ローカルファイルを編集した後に`clasp pull`しない（上書きされる）

---

### 📝 トラブルシューティング

#### プルダウンが表示されない
1. `master.js`の`_findIdx()`が配列形式のエイリアスを処理できるか確認
2. マスタデータシートに該当列が存在するか確認
3. `HEADER_ALIASES`にエイリアス定義があるか確認

#### データが保存されない
1. フォームIDとスプレッドシート列名が一致しているか確認
2. `fieldMapping`にマッピングがあるか確認
3. `console.log()`でフォームデータが送信されているか確認
4. Apps Scriptの実行ログでエラーが出ていないか確認

#### 数式が消える
1. `PASTE_NORMAL`を使用していないか確認
2. `clearContent()`を使用していないか確認
3. `PASTE_FORMULA`, `PASTE_FORMAT`, `PASTE_DATA_VALIDATION`を個別使用しているか確認

---

## 次の実装予定

### 短期（2週間以内）- 商品登録残り30%部分

#### 1. ~~CLAUDE.mdの作成~~ ✅ 完了
- 完全な開発ドキュメント作成
- Claude Codeに渡して開発生産性向上

#### 2. Serena MCPの導入（ユーザー側で実施）
- Claude Codeの性能向上
- リポジトリ全体の把握精度向上

#### 3. 商品状態(詳細)全般の修正 🔥 不具合修正

**現在の問題**:
- 過去の入力履歴が表示されない
- ボタンの仕様が不適切

**修正内容**:
- 基本情報ブロックの「商品の状態」プルダウン値を商品の説明プレビューに直接反映
- 商品状態(詳細)のボタンを「商品の状態」の値に連動して表示切替
- ボタン押下で商品状態(詳細)に値を反映
- フリー入力エリアのテキストも商品状態(詳細)に反映

#### 4. ブランド(カナ)の頭に半角スペース

**現状**: `【セール】UNIQLOユニクロ ニット`
**変更後**: `【セール】UNIQLO ユニクロ ニット`

- ブランド(英語)の前: スペースなし（現状維持）
- ブランド(カナ)の前: 半角スペース追加

#### 5. ブランド名自動反映

**機能**:
- 基本情報ブロックでブランド選択
- ↓ 自動反映
- 商品名ブロックのブランド(英語)・ブランド(カナ)

**追加要件**:
- 商品名ブロックのブランド名をテキスト編集可能にする
- 編集した値も商品名プレビューに反映

**理由**: 略称で入力したい場合がある（例: ユニクロ → ユニ）

#### 6. 商品属性の動的追加

**現状**: 固定3セット（見た目が分かりにくい）

**変更後**:
- デフォルト1セット表示
- 素材ブロックと同様の動的追加
- 「+ 商品属性を追加」ボタン
- 見た目スッキリ

**実装参考**: `sp_scripts.html`の`addMaterial()`

#### 7. サイズ全般の表記修正と新規追加１

**変更内容**:

テキスト削除:
- 「トップス／アウター」「パンツ」の文字削除
- 代わりにアイコン設置（👕 👖）

表記変更:
- 「サイズ」→「サイズ(実寸)」

新規追加:
- 「サイズ(表記)」プルダウン追加
- マスタデータの「サイズ(表記)」列を参照

プレビュー表示統一:
```
サイズ(表記)
M

サイズ(実寸)
肩幅：45cm
身幅：50cm
...
```

#### 8. サイズ全般の表記修正と新規追加２

**レイアウト変更**: 縦配置 → 2列並び

```
現状:          変更後:
肩幅           肩幅    身幅
身幅    →      袖丈    着丈
袖丈
着丈
```

**例外処理**: ラグランTシャツ・ラグランスウェット
- 「肩幅」→「裄丈」に変更
- メンズ・レディース両方対応
- アイテム名で判定

#### 9. カラー(詳細)追加

**新規機能**:
- 商品の説明ブロック内に追加
- マスタデータの「カラー/配色/トーン」列を参照
- 複数選択可能（黒 + ブラック、2色以上の服対応）
- プレビュー配置: ブランド名の下

**表示例**:
```
ブランド名
UNIQLO（ユニクロ）

カラー(詳細)
黒、ブラック
```

#### 10. コピーボタン実装

**機能**:
- 商品名コピーボタン
- 商品説明コピーボタン
- ワンクリックでクリップボードにコピー
- メルカリページで貼り付け

**実装位置**:
- 商品名プレビューの近く
- 商品説明プレビューの近く

#### 11. コードレビュー・リファクタリング

**目的**: Gemini API実装前にコードを最適化

**実施内容**:

1. **重複コードの統合**
   ```javascript
   // 例: getSheet_(), getSheet() を統一
   function getMainSheet() {
     return SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
   }
   ```

2. **長い関数の分割**
   ```javascript
   // 分割例
   function updateDescriptionFromDetail() {
     const brandText = getBrandInfo();
     const sizeText = getSizeInfo();
     const materialText = getMaterialInfo();
     const detailText = getDetailInfo();
     const hashtags = generateHashtags();

     const description = buildDescription(brandText, sizeText, materialText, detailText, hashtags);
     updateDescriptionField(description);
   }
   ```

3. **マジックナンバーの定数化**
   ```javascript
   // NG
   if (length > 40) { ... }

   // OK
   const MAX_TITLE_LENGTH = 40;
   if (length > MAX_TITLE_LENGTH) { ... }
   ```

4. **命名規則の統一**
   - 関数名: camelCase
   - 定数: UPPER_SNAKE_CASE
   - プライベート関数: _functionName()

5. **パフォーマンス最適化**
   - ブランド検索の高速化（既に実装済みだが他にも適用）
   - キャッシュの積極活用
   - 不要なループの削除

6. **コメント追加**
   - 複雑なロジックに説明追加
   - 関数の引数・戻り値を明記

7. **エラーハンドリングの統一**
   - `error_handler.js`を全体で活用
   - 一貫したエラーメッセージ

**重点チェック箇所**:
- 過去のトラブル箇所（`_findIdx()`, 列名マッピング等）
- 32ファイルの役割分担が適切か
- 重複コードの有無

#### 12. エラーハンドリング強化

**目的**: Gemini API実装前にエラー処理を強化

**実施内容**:

1. **バリデーション統一**
   ```javascript
   // 例: 商品番号入力時
   input.addEventListener('blur', () => {
     const result = validateField('商品番号', input.value);
     if (!result.isValid) {
       showError(result.message);
     }
   });
   ```

2. **ユーザー向けエラーメッセージ改善**
   ```javascript
   // NG
   return "NG(VALIDATION): Error occurred";

   // OK
   return "商品番号は1001以上の数値で入力してください（現在の値: abc）";
   ```

3. **ログ記録機能追加**
   ```javascript
   function logError(error, context) {
     const logEntry = {
       timestamp: new Date().toISOString(),
       type: error.type,
       message: error.message,
       context: context
     };
     // ログシートに書き込み
     writeToLogSheet(logEntry);
   }
   ```

4. **リトライ機構実装**
   ```javascript
   function retryableExecute(fn, maxRetries = 3) {
     for (let i = 0; i < maxRetries; i++) {
       try {
         return fn();
       } catch (error) {
         if (i === maxRetries - 1) throw error;
         console.log(`Retry ${i + 1}/${maxRetries}`);
       }
     }
   }
   ```

5. **フォールバック処理**
   ```javascript
   function getMasterDataSafe(fieldName) {
     try {
       return getMasterData(fieldName);
     } catch (error) {
       console.warn('マスタデータ取得失敗、キャッシュを使用:', error);
       return getCachedMasterData(fieldName);
     }
   }
   ```

---

### 短期（1ヶ月〜2ヶ月以内）- Gemini API統合

#### 1. AI商品説明文自動生成

**機能概要**:
- 「AI生成」ボタン設置
- 商品登録メニュー内の入力情報をAIが読み込み
- 服のアピールポイントを自動生成（200〜300文字）
  - 商品概要
  - コーディネート案
  - 着用シーン
- 商品の説明プレビューに反映

**実装手順**:
1. Gemini APIキー設定
2. プロンプト設計
3. API呼び出し処理
4. レスポンスのパース・表示
5. エラーハンドリング

**プロンプト例**:
```javascript
const prompt = `
以下の商品情報からメルカリ用の魅力的な商品説明文を200〜300文字で作成してください。

ブランド: ${brandName}
アイテム: ${itemName}
カテゴリ: ${category}
サイズ: ${size}
状態: ${condition}
素材: ${material}
カラー: ${color}

以下の要素を含めてください：
- 商品の特徴
- コーディネート提案
- おすすめの着用シーン
`;
```

**実装ファイル**:
- 新規: `gemini_api.js`
- 修正: `sp_block_description.html`（ボタン追加）
- 修正: `sp_scripts.html`（API呼び出し処理）

#### 2. Gemini Vision API統合（画像解析）

**機能概要**:
- 商品画像アップロード機能（1〜3枚）
- AIが画像を解析
- より精度の高い商品説明文を生成

**実装手順**:
1. 画像アップロードUI作成
2. 画像のBase64エンコード
3. Gemini Vision API呼び出し
4. 画像解析結果と入力情報を統合
5. 説明文生成

**実装ファイル**:
- 修正: `gemini_api.js`
- 新規: `sp_block_image.html`（画像アップロード）

#### 3. 価格最適化提案

**機能概要**:
- 画像解析結果から適正価格を提案
- 出品金額フィールドに自動反映
- 参考価格として表示

**プロンプト例**:
```javascript
const pricePrompt = `
以下の商品情報から、メルカリでの適正な出品価格を提案してください。

ブランド: ${brandName}
アイテム: ${itemName}
状態: ${condition}
仕入価格: ${purchaseAmount}円

価格のみを数値で回答してください。
`;
```

#### 4. データエクスポート機能

**機能概要**:
- メルカリShopsのCSV一括出品用ファイル生成
- 商品登録データをCSV形式でエクスポート

**実装内容**:
- CSVヘッダー定義（メルカリShops仕様に準拠）
- データ変換処理
- ダウンロード機能
- 複数商品の一括エクスポート

**実装ファイル**:
- 新規: `export.js`
- 修正: `menu.js`（メニュー追加）

---

### 中期（2ヶ月〜3ヶ月以内）

**注意**: 大まかな内容のため、開発が進む中で具体化

#### 1. 在庫管理機能

**ジャンプ機能**:
- 管理番号ブロック設置（商品登録と同様）
- 管理番号を選択・検索
- 該当行にジャンプ

**販売情報**:
- 販売日、販売先、販売金額の入力
- UIは仕入情報・出品情報と同様
- シートに保存

**発送情報**:
- 発送方法、梱包資材の選択
- 選択値に基づく自動計算
- 利益計算に反映

**実装ファイル**:
- 修正: `inventory.js`（既存関数あり）
- 新規: UIブロック

#### 2. 売上管理

**統合データ**:
- 仕入情報（商品登録メニュー）
- 出品情報（商品登録メニュー）
- 販売情報（在庫管理メニュー）
- 発送情報（在庫管理メニュー）
- 備品管理データ

**実装予定**:
- 売上・利益の自動計算
- 担当者別報酬の自動計算
- 売上分析ダッシュボード
- 確定申告用書類の出力

#### 3. 備品管理システム

**機能**:
- 在庫アラート機能
- 自動発注システム
- 売上管理との連動

**実装内容**:
- 備品マスタ作成
- 在庫数管理
- 閾値設定・アラート
- 発注処理（将来的に自動化）

#### 4. LINEもしくはSlack通知機能

**目的**: チーム利用・外注スタッフへの自動通知

**通知内容**:
- 商品の発送依頼
- 在庫アラート
- 売上レポート
- タスク完了通知

**実装方法**:
- LINE Messaging API または Slack Webhook
- GASのトリガー機能活用

#### 5. 売上分析ダッシュボード

**表示内容**:
- 売上推移グラフ
- 利益率分析
- 担当者別パフォーマンス
- カテゴリ別売上
- 在庫回転率

**実装技術**:
- Google Data Studio連携
- またはHTML Service + Chart.js

#### 6. モバイル対応UI改善

**目的**:
- 個人・チームでの使い勝手向上
- 将来のSaaS化に向けた準備

**対応内容**:
- レスポンシブデザイン
- タッチ操作最適化
- モバイル専用UI
- PWA化（検討）

---

### 長期（3ヶ月以上）

#### 1. メルカリShops専用システム開発

**内容**:
- メルカリShops特有の機能対応
- CSV一括出品の強化
- ショップ管理機能

#### 2. 課金制SaaSビジネス化

**構想**:
- 同業者（メルカリでファッション系物販を行う副業者・個人事業主）向けサービス提供
- サブスクリプション課金モデル
- ユーザー管理・権限設定
- マルチテナント対応

**技術的課題**:
- GASからクラウドプラットフォームへの移行検討
- データベース（Firestore、Supabase等）
- 認証システム（Firebase Auth等）
- 決済システム（Stripe等）

#### 3. Yahoo!フリマやラクマ対応

**内容**:
- メルカリ以外のプラットフォーム対応
- マルチプラットフォーム一括管理
- プラットフォーム別最適化

---

## 技術的な重要ポイント

### アーキテクチャの特徴

#### 1. モジュラー設計

HTMLファイルを機能ごとに分割し、`include()`で組み合わせ

```html
<?!= include('sp_block_manage'); ?>
<?!= include('sp_block_basic'); ?>
```

**メリット**:
- 保守性が高い
- 再利用性が高い
- 見通しが良い

#### 2. 列名ベースマッピング

フィールドIDとスプレッドシート列名の柔軟な対応

```javascript
const fieldMapping = {
  '大分類(カテゴリ)': '大分類',
  '中分類(カテゴリ)': '中分類',
  // ...
};
```

#### 3. データ取得優先順位

1. マスタデータシート（最優先）
2. 手動管理シート
3. デフォルト値

#### 4. キャッシュ機構

マスタデータを5分間キャッシュしてパフォーマンス向上

```javascript
const CACHE_DURATION = 5 * 60 * 1000;
let masterDataCache = null;
let cacheTimestamp = null;
```

#### 5. エラーハンドリング階層

1. フロント側バリデーション
2. バックエンドバリデーション
3. データ整合性チェック
4. ビジネスロジックバリデーション

---

### パフォーマンス最適化

#### 1. ブランド検索の高速化

インデックスマップ活用 - 52,667件から瞬時に候補表示

```javascript
const BRAND_INDEX_MAP = new Map();
BRAND_PAIRS.forEach((pair, index) => {
  BRAND_INDEX_MAP.set(pair.english, index);
});
```

#### 2. DOM要素のキャッシュ

```javascript
const elementCache = new Map();

function _val(id) {
  if (!elementCache.has(id)) {
    elementCache.set(id, document.getElementById(id));
  }
  return elementCache.get(id).value;
}
```

#### 3. 一括データ取得

複数のマスタデータを1回のAPI呼び出しで取得

```javascript
function getBulkInitializationData() {
  return {
    masterOptions: getMasterOptionsOptimized(),
    categoryData: getCategoryRowsOptimized(),
    topBrandsEn: getBrandData('ブランド(英語)').slice(0, 100),
    // ...
  };
}
```

---

### セキュリティ・データ保護

#### 1. バックアップ体制

- GitHub（コード）
- VSCode（ローカル）
- スプレッドシートの定期バックアップ
- Serena MCP導入予定

#### 2. データバリデーション

- フロント側：即座にエラー表示
- バックエンド側：保存前に厳密チェック
- ビジネスロジック：整合性確認

#### 3. 権限管理（今後実装）

- 担当者による権限の強弱
- 複数ユーザー対応

---

## 開発者向け情報

### ユーザー・チーム体制

**現在**:
- 開発者: 1名（非エンジニア）
- 運用者: 将来的に数名で使用予定

**将来**:
- チームメンバー
- 外注スタッフ
- SaaS化後: 複数テナント

---

### 開発優先順位の考え方

1. **短期（2週間）**: 商品登録の完成度を100%に
2. **短期（1-2ヶ月）**: Gemini API統合で差別化
3. **中期（2-3ヶ月）**: チーム利用の基盤整備
4. **長期（3ヶ月以上）**: SaaS化に向けた準備

---

## 最終確認事項

### データの正確性

- **ブランドデータ**: 52,667件（3,836件ではない）
- **アイテム分類**: 1,686件
- **マスタデータ**: 31列

### 完成度

- **全体**: 30%
- **商品登録**: 70%
- **在庫管理**: 0%
- **マスタデータ管理**: 30%
- **売上分析**: 20%

### 次の最優先タスク

1. ~~CLAUDE.md作成~~ ✅ 完了
2. 商品状態(詳細)修正（不具合）
3. その他短期実装（2週間以内）

---

**このドキュメントは Claude Code が効率的に開発を進めるための完全なリファレンスです。**
