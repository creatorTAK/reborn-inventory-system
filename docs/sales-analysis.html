<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base target="_top">
  <title>å£²ä¸Šç®¡ç†ãƒ»åˆ†æ - FURIRA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://www.reborn-inventory.com/css/reborn-theme.css?v=0bd1a9b">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    .content-container {
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* æœŸé–“é¸æŠ */
    .period-selector {
      background: white;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    /* KPIã‚«ãƒ¼ãƒ‰ */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .kpi-card {
      background: white;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: transform 0.2s;
    }
    .kpi-card:hover {
      transform: translateY(-2px);
    }
    .kpi-label {
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .kpi-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1f2937;
    }
    .kpi-value.positive {
      color: #10b981;
    }
    .kpi-value.negative {
      color: #ef4444;
    }
    .kpi-unit {
      font-size: 0.875rem;
      color: #6b7280;
    }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ */
    .section-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .section-title {
      font-size: 1rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e5e7eb;
    }

    /* æŒ‡æ¨™ãƒ†ãƒ¼ãƒ–ãƒ« */
    .metrics-table {
      width: 100%;
    }
    .metrics-table th {
      background: #f9fafb;
      padding: 12px 8px;
      font-size: 0.75rem;
      font-weight: 600;
      color: #6b7280;
      text-align: center;
      border-bottom: 1px solid #e5e7eb;
    }
    .metrics-table td {
      padding: 12px 8px;
      text-align: center;
      border-bottom: 1px solid #f3f4f6;
      font-size: 0.875rem;
    }
    .metrics-table .category-header {
      background: #f0f9ff;
      font-weight: 600;
      color: #0369a1;
      text-align: left;
      padding-left: 12px;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 576px) {
      .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .kpi-value {
        font-size: 1.25rem;
      }
    }
  </style>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>
  </div>

  <!-- çµ±ä¸€ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <div class="header-content">
      <button class="back-button" onclick="goBack()">
        <i class="bi bi-chevron-left"></i>
      </button>
      <div class="header-title">
        <span style="font-size: 20px;">ğŸ“ˆ</span>
        å£²ä¸Šåˆ†æ
      </div>
      <button class="menu-button" onclick="window.parent.postMessage({type:'toggleDrawer'}, '*')" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
        <i class="bi bi-list"></i>
      </button>
    </div>
  </div>

  <div class="content-container">
    <!-- æœŸé–“é¸æŠ -->
    <div class="period-selector">
      <div class="row align-items-center g-2">
        <div class="col-auto">
          <label class="form-label mb-0 small fw-bold">æœŸé–“:</label>
        </div>
        <div class="col-auto">
          <select class="form-select form-select-sm" id="periodType" onchange="onPeriodTypeChange()">
            <option value="month">æœˆåˆ¥</option>
            <option value="year">å¹´åˆ¥</option>
            <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
          </select>
        </div>
        <div class="col-auto" id="monthSelector">
          <input type="month" class="form-control form-control-sm" id="selectedMonth" onchange="loadSalesData()">
        </div>
        <div class="col-auto d-none" id="yearSelector">
          <select class="form-select form-select-sm" id="selectedYear" onchange="loadSalesData()">
          </select>
        </div>
        <div class="col-auto d-none" id="customSelector">
          <input type="date" class="form-control form-control-sm" id="startDate">
          <span class="mx-1">ã€œ</span>
          <input type="date" class="form-control form-control-sm" id="endDate">
          <button class="btn btn-sm btn-primary ms-2" onclick="loadSalesData()">é©ç”¨</button>
        </div>
      </div>
    </div>

    <!-- ä¸»è¦KPI -->
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label">å£²ä¸Šé«˜</div>
        <div class="kpi-value" id="kpi-sales">-</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">ç²—åˆ©ç›Š</div>
        <div class="kpi-value" id="kpi-grossProfit">-</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">å–¶æ¥­åˆ©ç›Š</div>
        <div class="kpi-value" id="kpi-operatingProfit">-</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">ç²—åˆ©ç›Šç‡</div>
        <div class="kpi-value" id="kpi-grossProfitRate">-</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">å–¶æ¥­åˆ©ç›Šç‡</div>
        <div class="kpi-value" id="kpi-operatingProfitRate">-</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">æˆç´„ç‡</div>
        <div class="kpi-value" id="kpi-conversionRate">-</div>
      </div>
    </div>

    <!-- ä»•å…¥ãƒ»å‡ºå“ãƒ»è²©å£² ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="section-card">
      <h5 class="section-title">ğŸ“Š ä»•å…¥ãƒ»å‡ºå“ãƒ»è²©å£² ã‚µãƒãƒªãƒ¼</h5>
      <div class="table-responsive">
        <table class="metrics-table">
          <thead>
            <tr>
              <th></th>
              <th>ä»•å…¥</th>
              <th>å‡ºå“</th>
              <th>è²©å£²</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="category-header">ä»¶æ•°</td>
              <td id="metric-purchaseCount">-</td>
              <td id="metric-listingCount">-</td>
              <td id="metric-salesCount">-</td>
            </tr>
            <tr>
              <td class="category-header">é‡‘é¡</td>
              <td id="metric-purchaseAmount">-</td>
              <td id="metric-listingAmount">-</td>
              <td id="metric-salesAmount">-</td>
            </tr>
            <tr>
              <td class="category-header">å¹³å‡å˜ä¾¡</td>
              <td id="metric-avgPurchase">-</td>
              <td id="metric-avgListing">-</td>
              <td id="metric-avgSales">-</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- çµŒè²»ãƒ»åˆ©ç›Š ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="section-card">
      <h5 class="section-title">ğŸ’° çµŒè²»ãƒ»åˆ©ç›Š è©³ç´°</h5>
      <div class="table-responsive">
        <table class="metrics-table">
          <thead>
            <tr>
              <th>é …ç›®</th>
              <th>é‡‘é¡</th>
              <th>å£²ä¸Šæ¯”</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="category-header">å£²ä¸Šé«˜</td>
              <td id="detail-sales">-</td>
              <td>100%</td>
            </tr>
            <tr>
              <td class="category-header">å£²ä¸ŠåŸä¾¡ï¼ˆä»•å…¥ï¼‰</td>
              <td id="detail-cogs">-</td>
              <td id="detail-cogsRate">-</td>
            </tr>
            <tr>
              <td class="category-header">ç²—åˆ©ç›Š</td>
              <td id="detail-grossProfit">-</td>
              <td id="detail-grossProfitRate">-</td>
            </tr>
            <tr>
              <td class="category-header">è²©å£²æ‰‹æ•°æ–™</td>
              <td id="detail-platformFee">-</td>
              <td id="detail-platformFeeRate">-</td>
            </tr>
            <tr>
              <td class="category-header">é€æ–™</td>
              <td id="detail-shippingFee">-</td>
              <td id="detail-shippingFeeRate">-</td>
            </tr>
            <tr>
              <td class="category-header">æ¢±åŒ…è³‡æè²»</td>
              <td id="detail-packagingCost">-</td>
              <td id="detail-packagingCostRate">-</td>
            </tr>
            <tr style="background: #f0fdf4; font-weight: 600;">
              <td class="category-header">å–¶æ¥­åˆ©ç›Š</td>
              <td id="detail-operatingProfit">-</td>
              <td id="detail-operatingProfitRate">-</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- åœ¨åº«å›è»¢ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="section-card">
      <h5 class="section-title">ğŸ“¦ åœ¨åº«çŠ¶æ³</h5>
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-label">ç¾åœ¨åº«æ•°</div>
          <div class="kpi-value" id="stock-count">-</div>
          <div class="kpi-unit">ç‚¹</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">ç¾åœ¨åº«é¡</div>
          <div class="kpi-value" id="stock-value">-</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">å¹³å‡åœ¨åº«æ—¥æ•°</div>
          <div class="kpi-value" id="avg-stock-days">-</div>
          <div class="kpi-unit">æ—¥</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">å¹³å‡åˆ©ç›Šå˜ä¾¡</div>
          <div class="kpi-value" id="avg-profit-per-item">-</div>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebaseè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "furira.jp",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /**
     * å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
     */
    async function calculateSalesMetrics(startDate, endDate) {
      console.log('ğŸ“Š [å£²ä¸Šåˆ†æ] ãƒ‡ãƒ¼ã‚¿é›†è¨ˆé–‹å§‹:', startDate, 'ã€œ', endDate);

      const productsRef = collection(db, 'products');
      const snapshot = await getDocs(productsRef);

      // åˆæœŸåŒ–
      const metrics = {
        // ä»•å…¥
        purchaseCount: 0,
        purchaseAmount: 0,
        // å‡ºå“
        listingCount: 0,
        listingAmount: 0,
        // è²©å£²
        salesCount: 0,
        salesAmount: 0,
        // çµŒè²»
        platformFee: 0,
        shippingFee: 0,
        packagingCost: 0,
        // åœ¨åº«
        stockCount: 0,
        stockValue: 0,
        // åˆ©ç›Š
        finalProfit: 0,
        // åœ¨åº«æ—¥æ•°åˆè¨ˆï¼ˆå¹³å‡è¨ˆç®—ç”¨ï¼‰
        totalStockDays: 0
      };

      snapshot.forEach(doc => {
        const data = doc.data();

        // ä»•å…¥æ—¥ã§ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆä»•å…¥æƒ…å ±ï¼‰
        const purchaseDate = data.purchase?.date || data.purchaseDate || '';
        if (purchaseDate >= startDate && purchaseDate <= endDate) {
          metrics.purchaseCount++;
          metrics.purchaseAmount += parseFloat(data.purchase?.amount || data.purchaseAmount || 0);
        }

        // å‡ºå“æ—¥ã§ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆå‡ºå“æƒ…å ±ï¼‰
        const listingDate = data.listing?.date || data.listingDate || '';
        if (listingDate >= startDate && listingDate <= endDate) {
          metrics.listingCount++;
          metrics.listingAmount += parseFloat(data.listing?.amount || data.listingAmount || 0);
        }

        // è²©å£²æ—¥ã§ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆè²©å£²æƒ…å ±ï¼‰
        const saleDate = data.saleDate || '';
        if (saleDate >= startDate && saleDate <= endDate) {
          metrics.salesCount++;
          metrics.salesAmount += parseFloat(data.saleAmount || 0);
          metrics.platformFee += parseFloat(data.platformFee || 0);
          metrics.shippingFee += parseFloat(data.shippingFee || 0);
          metrics.packagingCost += parseFloat(data.packagingCostTotal || 0);
          metrics.finalProfit += parseFloat(data.finalProfit || 0);

          // åœ¨åº«æ—¥æ•°è¨ˆç®—ï¼ˆå‡ºå“æ—¥ã‹ã‚‰è²©å£²æ—¥ã¾ã§ï¼‰
          if (listingDate && saleDate) {
            const days = Math.floor((new Date(saleDate) - new Date(listingDate)) / (1000 * 60 * 60 * 24));
            if (days >= 0) metrics.totalStockDays += days;
          }
        }

        // ç¾åœ¨åº«ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒåœ¨åº«ä¸­ã¾ãŸã¯å‡ºå“ä¸­ï¼‰
        const status = data.status || '';
        if (status === 'åœ¨åº«ä¸­' || status === 'å‡ºå“ä¸­') {
          metrics.stockCount++;
          metrics.stockValue += parseFloat(data.purchase?.amount || data.purchaseAmount || 0);
        }
      });

      console.log('ğŸ“Š [å£²ä¸Šåˆ†æ] é›†è¨ˆçµæœ:', metrics);
      return metrics;
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.SalesApi = {
      calculateSalesMetrics
    };

    console.log('âœ… [å£²ä¸Šåˆ†æ] FirebaseåˆæœŸåŒ–å®Œäº†');

    // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    window.addEventListener('load', () => {
      initializePeriodSelector();
      loadSalesData();
    });
  </script>

  <script>
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    function showLoading() {
      document.getElementById('loadingOverlay').style.display = 'flex';
    }
    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }

    // æœŸé–“ã‚»ãƒ¬ã‚¯ã‚¿åˆæœŸåŒ–
    function initializePeriodSelector() {
      // ä»Šæœˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«
      const now = new Date();
      const yearMonth = now.toISOString().slice(0, 7); // YYYY-MM
      document.getElementById('selectedMonth').value = yearMonth;

      // å¹´ã‚»ãƒ¬ã‚¯ã‚¿ï¼ˆéå»5å¹´åˆ†ï¼‰
      const yearSelect = document.getElementById('selectedYear');
      const currentYear = now.getFullYear();
      for (let y = currentYear; y >= currentYear - 5; y--) {
        const option = document.createElement('option');
        option.value = y;
        option.textContent = y + 'å¹´';
        yearSelect.appendChild(option);
      }
    }

    // æœŸé–“ã‚¿ã‚¤ãƒ—å¤‰æ›´
    function onPeriodTypeChange() {
      const type = document.getElementById('periodType').value;
      document.getElementById('monthSelector').classList.toggle('d-none', type !== 'month');
      document.getElementById('yearSelector').classList.toggle('d-none', type !== 'year');
      document.getElementById('customSelector').classList.toggle('d-none', type !== 'custom');

      if (type !== 'custom') {
        loadSalesData();
      }
    }

    // æœŸé–“ã‚’å–å¾—
    function getSelectedPeriod() {
      const type = document.getElementById('periodType').value;
      let startDate, endDate;

      if (type === 'month') {
        const month = document.getElementById('selectedMonth').value;
        startDate = month + '-01';
        const nextMonth = new Date(month + '-01');
        nextMonth.setMonth(nextMonth.getMonth() + 1);
        nextMonth.setDate(0); // æœˆæœ«
        endDate = nextMonth.toISOString().slice(0, 10);
      } else if (type === 'year') {
        const year = document.getElementById('selectedYear').value;
        startDate = year + '-01-01';
        endDate = year + '-12-31';
      } else {
        startDate = document.getElementById('startDate').value;
        endDate = document.getElementById('endDate').value;
      }

      return { startDate, endDate };
    }

    // é‡‘é¡ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatCurrency(amount) {
      if (amount === null || amount === undefined || isNaN(amount)) return '-';
      return 'Â¥' + Math.round(amount).toLocaleString();
    }

    // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatPercent(value) {
      if (value === null || value === undefined || isNaN(value)) return '-';
      return value.toFixed(1) + '%';
    }

    // å£²ä¸Šãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadSalesData() {
      showLoading();

      try {
        const { startDate, endDate } = getSelectedPeriod();

        if (!startDate || !endDate) {
          hideLoading();
          return;
        }

        const metrics = await SalesApi.calculateSalesMetrics(startDate, endDate);

        // è¨ˆç®—
        const cogs = metrics.purchaseAmount; // å£²ä¸ŠåŸä¾¡ï¼ˆè²©å£²ã—ãŸå•†å“ã®ä»•å…¥é‡‘é¡ï¼‰
        const grossProfit = metrics.salesAmount - cogs;
        const grossProfitRate = metrics.salesAmount > 0 ? (grossProfit / metrics.salesAmount) * 100 : 0;
        const totalExpenses = metrics.platformFee + metrics.shippingFee + metrics.packagingCost;
        const operatingProfit = grossProfit - totalExpenses;
        const operatingProfitRate = metrics.salesAmount > 0 ? (operatingProfit / metrics.salesAmount) * 100 : 0;
        const conversionRate = metrics.listingCount > 0 ? (metrics.salesCount / metrics.listingCount) * 100 : 0;
        const avgStockDays = metrics.salesCount > 0 ? Math.round(metrics.totalStockDays / metrics.salesCount) : 0;
        const avgProfitPerItem = metrics.salesCount > 0 ? Math.round(metrics.finalProfit / metrics.salesCount) : 0;

        // ä¸»è¦KPIæ›´æ–°
        document.getElementById('kpi-sales').textContent = formatCurrency(metrics.salesAmount);
        document.getElementById('kpi-grossProfit').textContent = formatCurrency(grossProfit);
        document.getElementById('kpi-grossProfit').className = 'kpi-value ' + (grossProfit >= 0 ? 'positive' : 'negative');
        document.getElementById('kpi-operatingProfit').textContent = formatCurrency(operatingProfit);
        document.getElementById('kpi-operatingProfit').className = 'kpi-value ' + (operatingProfit >= 0 ? 'positive' : 'negative');
        document.getElementById('kpi-grossProfitRate').textContent = formatPercent(grossProfitRate);
        document.getElementById('kpi-operatingProfitRate').textContent = formatPercent(operatingProfitRate);
        document.getElementById('kpi-conversionRate').textContent = formatPercent(conversionRate);

        // ã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
        document.getElementById('metric-purchaseCount').textContent = metrics.purchaseCount + 'ä»¶';
        document.getElementById('metric-listingCount').textContent = metrics.listingCount + 'ä»¶';
        document.getElementById('metric-salesCount').textContent = metrics.salesCount + 'ä»¶';
        document.getElementById('metric-purchaseAmount').textContent = formatCurrency(metrics.purchaseAmount);
        document.getElementById('metric-listingAmount').textContent = formatCurrency(metrics.listingAmount);
        document.getElementById('metric-salesAmount').textContent = formatCurrency(metrics.salesAmount);
        document.getElementById('metric-avgPurchase').textContent = formatCurrency(metrics.purchaseCount > 0 ? metrics.purchaseAmount / metrics.purchaseCount : 0);
        document.getElementById('metric-avgListing').textContent = formatCurrency(metrics.listingCount > 0 ? metrics.listingAmount / metrics.listingCount : 0);
        document.getElementById('metric-avgSales').textContent = formatCurrency(metrics.salesCount > 0 ? metrics.salesAmount / metrics.salesCount : 0);

        // çµŒè²»ãƒ»åˆ©ç›Šè©³ç´°æ›´æ–°
        document.getElementById('detail-sales').textContent = formatCurrency(metrics.salesAmount);
        document.getElementById('detail-cogs').textContent = formatCurrency(cogs);
        document.getElementById('detail-cogsRate').textContent = formatPercent(metrics.salesAmount > 0 ? (cogs / metrics.salesAmount) * 100 : 0);
        document.getElementById('detail-grossProfit').textContent = formatCurrency(grossProfit);
        document.getElementById('detail-grossProfitRate').textContent = formatPercent(grossProfitRate);
        document.getElementById('detail-platformFee').textContent = formatCurrency(metrics.platformFee);
        document.getElementById('detail-platformFeeRate').textContent = formatPercent(metrics.salesAmount > 0 ? (metrics.platformFee / metrics.salesAmount) * 100 : 0);
        document.getElementById('detail-shippingFee').textContent = formatCurrency(metrics.shippingFee);
        document.getElementById('detail-shippingFeeRate').textContent = formatPercent(metrics.salesAmount > 0 ? (metrics.shippingFee / metrics.salesAmount) * 100 : 0);
        document.getElementById('detail-packagingCost').textContent = formatCurrency(metrics.packagingCost);
        document.getElementById('detail-packagingCostRate').textContent = formatPercent(metrics.salesAmount > 0 ? (metrics.packagingCost / metrics.salesAmount) * 100 : 0);
        document.getElementById('detail-operatingProfit').textContent = formatCurrency(operatingProfit);
        document.getElementById('detail-operatingProfitRate').textContent = formatPercent(operatingProfitRate);

        // åœ¨åº«çŠ¶æ³æ›´æ–°
        document.getElementById('stock-count').textContent = metrics.stockCount;
        document.getElementById('stock-value').textContent = formatCurrency(metrics.stockValue);
        document.getElementById('avg-stock-days').textContent = avgStockDays;
        document.getElementById('avg-profit-per-item').textContent = formatCurrency(avgProfitPerItem);

      } catch (error) {
        console.error('å£²ä¸Šãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      } finally {
        hideLoading();
      }
    }

    // æˆ»ã‚‹ãƒœã‚¿ãƒ³
    function goBack() {
      const isInIframe = window.self !== window.top;
      if (isInIframe) {
        window.top.postMessage({ type: 'goBack' }, '*');
      } else {
        window.location.href = '/menu_home.html';
      }
    }
  </script>
</body>
</html>
