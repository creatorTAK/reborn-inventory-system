<!DOCTYPE html>
<html>
<head>
  <!-- Cache Bust: 2025-11-30 - ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆæ©Ÿèƒ½è¿½åŠ  -->
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¿ã‚¹ã‚¯</title>
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- REBORN Brand Colors & Theme -->
  <link rel="stylesheet" href="/css/reborn-brand-colors.css?v=0bd1a9b">
  <link rel="stylesheet" href="/css/reborn-theme.css?v=0bd1a9b">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }
    /* v207: ã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆçµ±ä¸€ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ */
    .sub-header {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 56px;
      padding: 0 16px;
      background: #ffffff;
      border-bottom: 1px solid #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .sub-header-back {
      position: absolute;
      left: 16px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 20px;
      transition: background 0.2s;
    }
    .sub-header-back:hover {
      background: #f2f2f2;
    }
    .sub-header-back:active {
      background: #e5e5e5;
    }
    .sub-header-title {
      font-weight: 600;
      font-size: 16px;
      color: #1f2937;
    }
    .sub-header-icons {
      position: absolute;
      right: 16px;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    .sub-header-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 20px;
      transition: background 0.2s;
      position: relative;
    }
    .sub-header-icon:hover {
      background: #f2f2f2;
    }
    .sub-header-icon:active {
      background: #e5e5e5;
    }
    /* è¨­å®šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ */
    .settings-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 200px;
      padding: 8px 0;
      display: none;
      z-index: 1001;
    }
    .settings-dropdown.active {
      display: block;
    }
    .settings-dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border: none;
      background: none;
      width: 100%;
      font-size: 14px;
      color: #374151;
      cursor: pointer;
      text-align: left;
    }
    .settings-dropdown-item:hover {
      background: #f3f4f6;
    }
    .settings-dropdown-item i {
      font-size: 18px;
      color: #6b7280;
      width: 20px;
      text-align: center;
    }
    .announce-dot {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      display: none;
    }
    .announce-dot.visible {
      display: block;
    }
    /* æ¤œç´¢ãƒãƒ¼ */
    .search-bar {
      display: flex;
      align-items: center;
      background: #e5e7eb;
      border-radius: 12px;
      padding: 12px 14px;
      gap: 10px;
      margin: 12px 16px;
    }
    .search-bar i {
      color: #9ca3af;
      font-size: 16px;
    }
    .search-bar input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 16px;
      color: #1f2937;
      outline: none;
    }
    .search-bar input::placeholder {
      color: #9ca3af;
    }
    .search-bar .clear-btn {
      display: none;
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      padding: 0;
      font-size: 16px;
    }
    .search-bar .clear-btn.show {
      display: block;
    }
    .settings-dropdown-divider {
      height: 1px;
      background: #e5e7eb;
      margin: 4px 0;
    }
    .settings-dropdown-item.admin-only {
      border-top: 1px solid #e5e7eb;
      color: #6366f1;
    }
    .settings-dropdown-item.admin-only i {
      color: #6366f1;
    }
    /* ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .task-admin-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
      overflow-y: auto;
    }
    .task-admin-modal.active {
      display: flex;
    }
    .task-admin-content {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }
    .task-admin-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
      position: sticky;
      top: 0;
      background: white;
      z-index: 1;
    }
    .task-admin-header h2 {
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
      margin: 0;
    }
    .task-admin-close {
      background: none;
      border: none;
      font-size: 24px;
      color: #6b7280;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    .task-admin-body {
      padding: 16px 20px;
    }
    .task-summary-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    .task-summary-card {
      background: #f9fafb;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    .task-summary-card .number {
      font-size: 24px;
      font-weight: 700;
    }
    .task-summary-card .label {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }
    .user-task-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      border-bottom: 1px solid #f3f4f6;
    }
    .user-task-item:last-child {
      border-bottom: none;
    }
    .user-task-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .user-task-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 500;
    }
    .user-task-name {
      font-size: 14px;
      font-weight: 500;
      color: #1f2937;
    }
    .user-task-email {
      font-size: 11px;
      color: #6b7280;
    }
    .user-task-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .user-task-badge {
      font-size: 12px;
      font-weight: 500;
      padding: 4px 8px;
      border-radius: 6px;
    }
    .user-task-badge.overdue {
      background: #fee2e2;
      color: #ef4444;
    }
    .user-task-badge.pending {
      background: #fef3c7;
      color: #f59e0b;
    }
    .user-task-badge.complete {
      background: #d1fae5;
      color: #10b981;
    }
    .remind-btn {
      padding: 6px 12px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
    }
    .remind-btn:active {
      opacity: 0.8;
    }
    /* æœŸé™è¨­å®šãƒ»å»¶é•·ç”³è«‹ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .deadline-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1100;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .deadline-modal.active {
      display: flex;
    }
    .deadline-modal-content {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 400px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    .deadline-modal-header {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .deadline-modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
    }
    .deadline-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: #9ca3af;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    .deadline-modal-body {
      padding: 20px;
    }
    .deadline-modal-footer {
      padding: 16px 20px;
      background: #f9fafb;
      display: flex;
      gap: 12px;
    }
    .deadline-modal-btn {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .deadline-modal-btn.cancel {
      border: 1px solid #d1d5db;
      background: white;
      color: #374151;
    }
    .deadline-modal-btn.primary {
      border: none;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      color: white;
    }
    .deadline-input-group {
      margin-bottom: 16px;
    }
    .deadline-input-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 8px;
    }
    .deadline-input-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .deadline-input-row input {
      width: 80px;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 16px;
      text-align: center;
    }
    .deadline-input-row span {
      font-size: 14px;
      color: #6b7280;
    }
    .deadline-preview {
      margin-top: 8px;
      font-size: 12px;
      color: #6b7280;
    }
    .deadline-note {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 12px;
      padding: 10px;
      background: #f9fafb;
      border-radius: 6px;
    }
    /* å»¶é•·ç”³è«‹ãƒªã‚¹ãƒˆï¼ˆç®¡ç†è€…ç”¨ï¼‰ */
    .extension-requests-section {
      margin-bottom: 16px;
    }
    .extension-request-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-left: 4px solid #f59e0b;
    }
    .extension-request-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .extension-request-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .extension-request-info h4 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
    }
    .extension-request-info span {
      font-size: 11px;
      color: #6b7280;
    }
    .extension-request-body {
      margin-bottom: 12px;
    }
    .extension-request-dates {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #374151;
      margin-bottom: 8px;
    }
    .extension-request-dates .arrow {
      color: #9ca3af;
    }
    .extension-request-dates .new-date {
      color: #f59e0b;
      font-weight: 600;
    }
    .extension-request-reason {
      font-size: 13px;
      color: #6b7280;
      padding: 10px;
      background: #f9fafb;
      border-radius: 6px;
      border-left: 3px solid #e5e7eb;
    }
    .extension-request-actions {
      display: flex;
      gap: 8px;
    }
    .extension-request-btn {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .extension-request-btn.reject {
      border: 1px solid #ef4444;
      background: white;
      color: #ef4444;
    }
    .extension-request-btn.approve {
      border: none;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    /* å»¶é•·ç”³è«‹ãƒœã‚¿ãƒ³ï¼ˆã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰å†…ï¼‰ */
    .request-extension-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 10px;
      background: #fef3c7;
      color: #b45309;
      border: none;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      margin-top: 8px;
    }
    .request-extension-btn:hover {
      background: #fde68a;
    }
    .pending-extension-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: #fef3c7;
      color: #b45309;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 500;
      margin-top: 8px;
    }
    .tasks-container {
      padding: 8px 16px 16px 16px;
      max-width: 600px;
      margin: 0 auto;
    }
    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 12px;
      padding-left: 4px;
    }
    .task-item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: all 0.2s ease;
      border-left: 4px solid var(--reborn-primary);
    }
    .task-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    .task-item.completed {
      opacity: 0.6;
      border-left-color: #9ca3af;
    }
    .task-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .task-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: #fef3c7;
      color: #92400e;
      font-size: 12px;
    }
    .history-link {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 20px;
      margin-top: 16px;
      background: #f3f4f6;
      border-radius: 12px;
      color: #6b7280;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .history-link:hover {
      background: #e5e7eb;
    }
    .history-link .history-count {
      background: var(--reborn-primary);
      color: white;
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .task-content {
      flex: 1;
    }
    .task-title {
      font-size: 15px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }
    .task-description {
      font-size: 13px;
      color: #6b7280;
      line-height: 1.4;
    }
    .task-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      font-size: 12px;
      color: #9ca3af;
    }
    .task-action {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 20px;
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      color: white;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      margin-top: 12px;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .task-action:active {
      transform: scale(0.97);
      opacity: 0.9;
    }
    .status-card {
      background: white;
      border-radius: 16px;
      padding: 32px 20px;
      margin-top: 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .empty-state {
      text-align: center;
      color: #6b7280;
    }
    .empty-state i {
      font-size: 48px;
      margin-bottom: 12px;
      display: block;
      color: #d1d5db;
    }
    .empty-state p {
      font-size: 15px;
      color: #9ca3af;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    .type-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    .type-badge.pending_user_approval {
      background: #fef3c7;
      color: #92400e;
    }
    .type-badge.inventory_alert {
      background: #fee2e2;
      color: #991b1b;
    }
    .type-badge.shipping_info_registration,
    .type-badge.bank_account_registration {
      background: #dbeafe;
      color: #1e40af;
    }
    .type-badge.receiving_task {
      background: #dcfce7;
      color: #166534;
    }
    .type-badge.product_registration_task {
      background: #fef3c7;
      color: #92400e;
    }
    .type-badge.revision_request {
      background: #fef2f2;
      color: #dc2626;
    }
    .type-badge.inspection_task {
      background: #ecfdf5;
      color: #047857;
    }
    .type-badge.default {
      background: #e0e7ff;
      color: #3730a3;
    }
  </style>
</head>
<body>
  <!-- v207: ã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆçµ±ä¸€ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ -->
  <div class="sub-header">
    <button class="sub-header-back" onclick="window.parent.postMessage({type:'navigateToPage', page:'home'}, '*')" title="æˆ»ã‚‹">
      <i class="bi bi-chevron-left"></i>
    </button>
    <span class="sub-header-title">ã‚¿ã‚¹ã‚¯</span>
    <div class="sub-header-icons">
      <button class="sub-header-icon" title="é€šçŸ¥" onclick="openAnnouncePage()">
        <i class="bi bi-bell"></i>
        <span class="announce-dot" id="announceDot"></span>
      </button>
      <div style="position: relative;">
        <button class="sub-header-icon" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼" onclick="toggleSettingsDropdown(event)">
          <i class="bi bi-list"></i>
        </button>
        <div class="settings-dropdown" id="settingsDropdown">
          <button class="settings-dropdown-item" onclick="goToHistory()">
            <i class="bi bi-clock-history"></i>
            <span>å®Œäº†ã—ãŸå±¥æ­´</span>
          </button>
          <button class="settings-dropdown-item admin-only" id="adminTaskManagement" onclick="openTaskManagement()" style="display: none;">
            <i class="bi bi-people"></i>
            <span>ã‚¿ã‚¹ã‚¯ç®¡ç†</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ¤œç´¢ãƒãƒ¼ -->
  <div class="search-bar">
    <i class="bi bi-search"></i>
    <input type="text" id="searchInput" placeholder="ã‚¿ã‚¹ã‚¯ã‚’æ¤œç´¢" oninput="performSearch()" />
    <button class="clear-btn" id="searchClearBtn" onclick="clearSearch()">
      <i class="bi bi-x-circle-fill"></i>
    </button>
  </div>

  <!-- ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰ -->
  <div class="task-admin-modal" id="taskAdminModal" onclick="closeTaskManagement(event)">
    <div class="task-admin-content" onclick="event.stopPropagation()">
      <div class="task-admin-header">
        <h2>ã‚¿ã‚¹ã‚¯ç®¡ç†</h2>
        <button class="task-admin-close" onclick="closeTaskManagement()">&times;</button>
      </div>
      <div class="task-admin-body">
        <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
        <div class="task-summary-cards">
          <div class="task-summary-card">
            <div class="number" style="color: #3b82f6;" id="adminTaskTotal">-</div>
            <div class="label">ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
          </div>
          <div class="task-summary-card">
            <div class="number" style="color: #f59e0b;" id="adminTaskPending">-</div>
            <div class="label">æœªå®Œäº†ã‚ã‚Š</div>
          </div>
          <div class="task-summary-card">
            <div class="number" style="color: #ef4444;" id="adminTaskOverdue">-</div>
            <div class="label">æœŸé™åˆ‡ã‚Œ/æ”¾ç½®</div>
          </div>
        </div>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ -->
        <div style="background: #f9fafb; border-radius: 12px; overflow: hidden;">
          <div style="padding: 12px 16px; background: #e5e7eb; font-weight: 600; font-size: 14px; color: #374151;">
            ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚¿ã‚¹ã‚¯çŠ¶æ³
          </div>
          <div id="adminUserTaskList" style="max-height: 300px; overflow-y: auto;">
            <div style="padding: 20px; text-align: center; color: #9ca3af;">èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ç®¡ç†è€…ç”¨: å»¶é•·ç”³è«‹ä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <div id="extensionRequestsSection" class="tasks-container extension-requests-section" style="display: none;">
    <div class="section-title" style="display: flex; align-items: center; gap: 8px;">
      <i class="bi bi-clock-history" style="color: #f59e0b;"></i>
      å»¶é•·ç”³è«‹
      <span id="extensionRequestsCount" style="background: #f59e0b; color: white; font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">0</span>
    </div>
    <div id="extensionRequestsList">
      <div style="text-align: center; color: #9ca3af; font-size: 13px; padding: 20px;">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  </div>

  <div class="tasks-container">
    <div id="loading" class="loading">
      <i class="bi bi-arrow-repeat"></i> èª­ã¿è¾¼ã¿ä¸­...
    </div>

    <div id="pending-tasks" style="display: none;">
      <div class="section-title">æœªå®Œäº†ã®ã‚¿ã‚¹ã‚¯</div>
      <div id="pending-tasks-list"></div>
    </div>

    <!-- ç©ºã®çŠ¶æ…‹ + å±¥æ­´ãƒªãƒ³ã‚¯ï¼ˆç™½ã„ã‚«ãƒ¼ãƒ‰å†…ï¼‰ -->
    <div id="status-card" class="status-card" style="display: none;">
      <div id="empty-state" class="empty-state" style="display: none;">
        <i class="bi bi-check-circle"></i>
        <p>ã‚„ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“</p>
      </div>

      <!-- å®Œäº†å±¥æ­´ã¸ã®ãƒªãƒ³ã‚¯ -->
      <div id="history-link-container" style="display: none;">
        <div class="history-link" onclick="goToHistory()">
          <i class="bi bi-clock-history"></i>
          <span>å®Œäº†ã—ãŸå±¥æ­´ã‚’è¦‹ã‚‹</span>
          <span id="completed-count" class="history-count"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    // URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
    const urlParams = new URLSearchParams(window.location.search);
    const userEmail = urlParams.get('userEmail') || '';
    const parentOrigin = urlParams.get('parentOrigin') || window.location.origin;
    const pmToken = urlParams.get('pmToken') || '';

    // Firebase åˆæœŸåŒ–
    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "furira.jp",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // å…¨ã‚¿ã‚¹ã‚¯ã‚’ä¿å­˜ï¼ˆæ¤œç´¢ç”¨ï¼‰
    let allPendingTasks = [];

    // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadTasks() {
      if (!userEmail) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('empty-state').style.display = 'block';
        return;
      }

      try {
        const tasksRef = db.collection('userTasks').doc(userEmail).collection('tasks');
        const snapshot = await tasksRef.orderBy('createdAt', 'desc').get();

        const pendingTasks = [];
        const completedTasks = [];

        snapshot.forEach(doc => {
          const task = { id: doc.id, ...doc.data() };
          if (task.completed) {
            completedTasks.push(task);
          } else {
            pendingTasks.push(task);
          }
        });

        document.getElementById('loading').style.display = 'none';

        // 365æ—¥ï¼ˆ1å¹´ï¼‰çµŒéã—ãŸå®Œäº†ã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•å‰Šé™¤
        const oneYearAgo = new Date();
        oneYearAgo.setDate(oneYearAgo.getDate() - 365);
        for (const task of completedTasks) {
          if (task.completedAt) {
            const completedDate = task.completedAt.toDate ? task.completedAt.toDate() : new Date(task.completedAt);
            if (completedDate < oneYearAgo) {
              await db.collection('userTasks').doc(userEmail).collection('tasks').doc(task.id).delete();
              console.log('1å¹´çµŒéã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤:', task.id);
            }
          }
        }

        // æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚’ä¿å­˜ãƒ»è¡¨ç¤º
        allPendingTasks = pendingTasks;
        if (pendingTasks.length > 0) {
          document.getElementById('pending-tasks').style.display = 'block';
          document.getElementById('pending-tasks-list').innerHTML = pendingTasks.map(task => renderTask(task)).join('');
        }

        // å®Œäº†ã‚¿ã‚¹ã‚¯ãŒã‚ã‚‹å ´åˆã¯å±¥æ­´ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤º
        // 1å¹´ä»¥å†…ã®ã‚¿ã‚¹ã‚¯ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆ
        const recentCompletedTasks = completedTasks.filter(task => {
          if (!task.completedAt) return true;
          const completedDate = task.completedAt.toDate ? task.completedAt.toDate() : new Date(task.completedAt);
          return completedDate >= oneYearAgo;
        });

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºåˆ¶å¾¡
        const showEmptyState = pendingTasks.length === 0;
        const showHistoryLink = recentCompletedTasks.length > 0;

        if (showEmptyState || showHistoryLink) {
          document.getElementById('status-card').style.display = 'block';

          if (showEmptyState) {
            document.getElementById('empty-state').style.display = 'block';
          }

          if (showHistoryLink) {
            document.getElementById('history-link-container').style.display = 'block';
            document.getElementById('completed-count').textContent = `${recentCompletedTasks.length}ä»¶`;
          }
        }

      } catch (error) {
        console.error('ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('loading').innerHTML = '<i class="bi bi-exclamation-circle"></i> èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼';
      }
    }

    // ã‚¿ã‚¹ã‚¯ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆæœªå®Œäº†ã‚¿ã‚¹ã‚¯ç”¨ï¼‰
    function renderTask(task) {
      const typeLabel = getTypeLabel(task.type);
      const typeBadgeClass = task.type || 'default';
      const createdAt = task.createdAt ? formatDate(task.createdAt.toDate()) : '';

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªã‚¿ã‚¹ã‚¯ã§å†™çœŸãŒã‚ã‚‹å ´åˆã¯ç”»åƒã‚’è¡¨ç¤ºã€ãªã‘ã‚Œã°ã‚¢ã‚¤ã‚³ãƒ³
      let iconHtml;
      if (task.type === 'pending_user_approval' && task.relatedData?.pendingUserPhoto) {
        iconHtml = `<img src="${escapeHtml(task.relatedData.pendingUserPhoto)}" alt="ãƒ¦ãƒ¼ã‚¶ãƒ¼" style="width:28px;height:28px;border-radius:50%;object-fit:cover;">`;
      } else {
        iconHtml = getTypeIcon(task.type);
      }

      // å®Œäº†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—ï¼ˆå ±é…¬å¯¾è±¡ã‚¿ã‚¹ã‚¯ã®ã¿ + revision_request + inspection_taskï¼‰
      // åˆæœŸè¨­å®šã‚¿ã‚¹ã‚¯ï¼ˆshipping_info_registration, bank_account_registrationï¼‰ã¯è¨­å®šä¿å­˜æ™‚ã«è‡ªå‹•å®Œäº†
      const completableTaskTypes = ['listing_approval', 'shipping_task', 'revision_request', 'inspection_task'];
      const showCompleteButton = completableTaskTypes.includes(task.type);

      // æœŸé™è¡¨ç¤ºï¼ˆç™ºé€ã‚¿ã‚¹ã‚¯ãªã©ï¼‰
      let dueDateHtml = '';
      if (task.dueDate) {
        const dueDate = task.dueDate.toDate ? task.dueDate.toDate() : new Date(task.dueDate);
        const now = new Date();
        const diffTime = dueDate - now;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays < 0) {
          // æœŸé™åˆ‡ã‚Œ
          dueDateHtml = `<span style="color: #ef4444; font-weight: 600; font-size: 11px;">âš ï¸ æœŸé™åˆ‡ã‚Œï¼ˆ${Math.abs(diffDays)}æ—¥è¶…éï¼‰</span>`;
        } else if (diffDays === 0) {
          // ä»Šæ—¥ãŒæœŸé™
          dueDateHtml = `<span style="color: #f59e0b; font-weight: 600; font-size: 11px;">â° æœ¬æ—¥æœŸé™</span>`;
        } else if (diffDays === 1) {
          // æ˜æ—¥ãŒæœŸé™
          dueDateHtml = `<span style="color: #f59e0b; font-size: 11px;">ğŸ“… æ˜æ—¥ã¾ã§</span>`;
        } else {
          // ãã‚Œä»¥å¤–
          dueDateHtml = `<span style="color: #6b7280; font-size: 11px;">ğŸ“… ${dueDate.getMonth() + 1}/${dueDate.getDate()}ã¾ã§</span>`;
        }
      }

      // ğŸ”¢ å•†å“ç™»éŒ²ã‚¿ã‚¹ã‚¯ã®ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼è¡¨ç¤º
      let progressHtml = '';
      let extensionBtnHtml = '';
      if (task.type === 'product_registration_task' && task.relatedData) {
        const totalCount = task.relatedData.totalCount || 0;
        const registeredCount = task.relatedData.registeredCount || 0;
        const remainingCount = task.relatedData.remainingCount || totalCount;
        const progressPercent = totalCount > 0 ? Math.round((registeredCount / totalCount) * 100) : 0;

        progressHtml = `
          <div style="margin-top: 8px; padding: 8px; background: #f3f4f6; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px;">
              <span style="color: #374151; font-weight: 600;">ğŸ“¦ ç™»éŒ²é€²æ—</span>
              <span style="color: #6b7280;">${registeredCount} / ${totalCount} ç‚¹ (${progressPercent}%)</span>
            </div>
            <div style="background: #e5e7eb; border-radius: 4px; height: 8px; overflow: hidden;">
              <div style="background: linear-gradient(90deg, #10b981 0%, #34d399 100%); height: 100%; width: ${progressPercent}%; transition: width 0.5s ease;"></div>
            </div>
            <div style="text-align: center; margin-top: 6px; font-size: 14px; color: ${remainingCount === 0 ? '#10b981' : '#f59e0b'}; font-weight: 600;">
              ${remainingCount === 0 ? 'âœ… å®Œäº†!' : `æ®‹ã‚Š ${remainingCount} ç‚¹`}
            </div>
          </div>
        `;

        // å»¶é•·ç”³è«‹ãƒœã‚¿ãƒ³ï¼ˆç”³è«‹ä¸­ã§ãªã„å ´åˆã®ã¿è¡¨ç¤ºï¼‰
        if (task.pendingExtension) {
          extensionBtnHtml = `<div class="pending-extension-badge"><i class="bi bi-hourglass-split"></i> å»¶é•·ç”³è«‹ä¸­</div>`;
        } else if (task.dueDate) {
          extensionBtnHtml = `<button class="request-extension-btn" onclick="event.stopPropagation(); openExtensionRequestModalForTask('${task.id}')"><i class="bi bi-clock-history"></i> æœŸé™å»¶é•·ã‚’ç”³è«‹</button>`;
        }
      }

      // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
      let actionButtons = '';
      if (task.link) {
        actionButtons += `<div class="task-action" onclick="handleTaskClick('${task.id}', '${task.link}')"><i class="bi bi-arrow-right-circle"></i> å¯¾å¿œã™ã‚‹</div>`;
      }
      if (showCompleteButton) {
        // listing_approvalã®å ´åˆã¯ã€Œæ‰¿èªã€ã¨ã€Œå´ä¸‹ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        if (task.type === 'listing_approval') {
          actionButtons += `<div class="task-action complete-btn" onclick="completeTask('${task.id}', '${task.type}')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); margin-left: 8px;"><i class="bi bi-check-circle"></i> æ‰¿èª</div>`;
          actionButtons += `<div class="task-action reject-btn" onclick="openRejectModal('${task.id}', '${task.type}')" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); margin-left: 8px;"><i class="bi bi-x-circle"></i> å´ä¸‹</div>`;
        } else if (task.type === 'revision_request') {
          // revision_requestã®å ´åˆã¯ã€Œä¿®æ­£å®Œäº†ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
          actionButtons += `<div class="task-action complete-btn" onclick="completeTask('${task.id}', '${task.type}')" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); margin-left: 8px;"><i class="bi bi-check-circle"></i> ä¿®æ­£å®Œäº†</div>`;
        } else {
          actionButtons += `<div class="task-action complete-btn" onclick="completeTask('${task.id}', '${task.type}')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); margin-left: 8px;"><i class="bi bi-check-circle"></i> å®Œäº†</div>`;
        }
      }

      return `
        <div class="task-item" data-task-id="${task.id}">
          <div class="task-header">
            <div class="task-icon">${iconHtml}</div>
            <div class="task-content">
              <div class="task-title">${escapeHtml(task.title)}</div>
              <div class="task-description">${escapeHtml(task.description)}</div>
              <div class="task-meta">
                <span class="type-badge ${typeBadgeClass}">${typeLabel}</span>
                <span>${createdAt}</span>
                ${dueDateHtml}
              </div>
              ${progressHtml}
              ${extensionBtnHtml}
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                ${actionButtons}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ã‚¿ã‚¹ã‚¯IDã‹ã‚‰ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦å»¶é•·ç”³è«‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    async function openExtensionRequestModalForTask(taskId) {
      try {
        const taskRef = db.collection('userTasks').doc(userEmail).collection('tasks').doc(taskId);
        const taskDoc = await taskRef.get();
        if (!taskDoc.exists) {
          alert('ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        const taskData = taskDoc.data();
        taskData.id = taskId;
        openExtensionRequestModal(taskId, taskData);
      } catch (error) {
        console.error('ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    /**
     * ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã«ã™ã‚‹
     */
    async function completeTask(taskId, taskType) {
      // å ±é…¬å¯¾è±¡ã‚¿ã‚¹ã‚¯ã‹åˆ¤å®š
      const rewardTaskTypes = ['listing_approval', 'shipping_task', 'product_registration_task', 'inspection_task'];
      const isRewardTask = rewardTaskTypes.includes(taskType);

      // receiving_taskã®å ´åˆã¯æœŸé™è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
      if (taskType === 'receiving_task') {
        try {
          const taskRef = db.collection('userTasks').doc(userEmail).collection('tasks').doc(taskId);
          const taskDoc = await taskRef.get();
          if (!taskDoc.exists) {
            alert('ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
          }
          const taskData = taskDoc.data();
          openReceivingCompleteModal(taskId, taskData);
          return; // ãƒ¢ãƒ¼ãƒ€ãƒ«ã§å‡¦ç†ã‚’ç¶™ç¶š
        } catch (error) {
          console.error('ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          alert('ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
          return;
        }
      }

      // ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—åˆ¥ã®ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      let confirmMsg;
      if (taskType === 'revision_request') {
        confirmMsg = 'ä¿®æ­£ã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆç®¡ç†è€…ã«å†æ‰¿èªã‚¿ã‚¹ã‚¯ãŒé€ä¿¡ã•ã‚Œã¾ã™ï¼‰';
      } else if (isRewardTask) {
        confirmMsg = 'ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã«ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå ±é…¬ãŒè‡ªå‹•è¨˜éŒ²ã•ã‚Œã¾ã™ï¼‰';
      } else {
        confirmMsg = 'ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã«ã—ã¾ã™ã‹ï¼Ÿ';
      }

      if (!confirm(confirmMsg)) return;

      try {
        const taskRef = db.collection('userTasks').doc(userEmail).collection('tasks').doc(taskId);
        const taskDoc = await taskRef.get();

        if (!taskDoc.exists) {
          alert('ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        const taskData = taskDoc.data();

        // revision_requestã®å ´åˆã¯ç®¡ç†è€…ã«å†æ‰¿èªã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ
        if (taskType === 'revision_request') {
          await createReApprovalTask(taskData);
        }

        await taskRef.update({
          completed: true,
          completedAt: new Date().toISOString()
        });

        console.log('âœ… [Task] ã‚¿ã‚¹ã‚¯å®Œäº†:', taskId);
        alert('ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã—ã¾ã—ãŸ');
        loadTasks(); // å†èª­ã¿è¾¼ã¿
      } catch (error) {
        console.error('âŒ [Task] ã‚¿ã‚¹ã‚¯å®Œäº†ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚¿ã‚¹ã‚¯ã®å®Œäº†ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    /**
     * å†æ‰¿èªã‚¿ã‚¹ã‚¯ã‚’ä½œæˆï¼ˆrevision_requestå®Œäº†æ™‚ï¼‰
     * ç®¡ç†è€…ã«å‡ºå“ç¢ºèªã‚¿ã‚¹ã‚¯ã‚’å†ä½œæˆã™ã‚‹
     */
    async function createReApprovalTask(revisionTaskData) {
      const relatedData = revisionTaskData.relatedData || {};
      const productId = relatedData.productId;
      const managementNumber = relatedData.managementNumber;
      const rejectedBy = relatedData.rejectedBy; // å…ƒã®å´ä¸‹è€…ï¼ˆç®¡ç†è€…ï¼‰

      if (!rejectedBy) {
        console.warn('âš ï¸ [Task] å†æ‰¿èªã‚¿ã‚¹ã‚¯ä½œæˆã‚¹ã‚­ãƒƒãƒ—: å´ä¸‹è€…æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      try {
        // å•†å“æƒ…å ±ã‚’å–å¾—ã—ã¦ç™»éŒ²è€…æƒ…å ±ã‚’å–å¾—
        let staffName = 'ã‚¹ã‚¿ãƒƒãƒ•';
        if (productId) {
          const productDoc = await db.collection('products').doc(productId).get();
          if (productDoc.exists) {
            const productData = productDoc.data();
            staffName = productData.registrant || staffName;
          }
        }

        // ç®¡ç†è€…ï¼ˆå´ä¸‹è€…ï¼‰ã«å†æ‰¿èªã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ
        const reApprovalTaskRef = db.collection('userTasks').doc(rejectedBy).collection('tasks').doc();
        await reApprovalTaskRef.set({
          type: 'listing_approval',
          title: `å†ç¢ºèª: ${managementNumber || 'å•†å“'}`,
          description: `${staffName}ã•ã‚“ãŒä¿®æ­£ã‚’å®Œäº†ã—ã¾ã—ãŸã€‚å†åº¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚`,
          createdAt: new Date().toISOString(),
          completed: false,
          priority: 'high',
          link: productId ? `/product.html?edit=${productId}` : null,
          relatedData: {
            productId: productId,
            managementNumber: managementNumber,
            staffEmail: userEmail,
            staffName: staffName,
            isReApproval: true
          }
        });

        console.log('âœ… [Task] å†æ‰¿èªã‚¿ã‚¹ã‚¯ä½œæˆ:', rejectedBy);
      } catch (error) {
        console.error('âŒ [Task] å†æ‰¿èªã‚¿ã‚¹ã‚¯ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
        throw error;
      }
    }

    /**
     * å•†å“ç™»éŒ²ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆï¼ˆreceiving_taskå®Œäº†æ™‚ï¼‰
     */
    async function createProductRegistrationTask(relatedData) {
      if (!relatedData || !relatedData.batchId) {
        console.warn('å•†å“ç™»éŒ²ã‚¿ã‚¹ã‚¯ä½œæˆã‚¹ã‚­ãƒƒãƒ—: relatedDataãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      const { batchId, itemCount, supplier } = relatedData;

      // è¨­å®šã‹ã‚‰æœŸé™æ—¥æ•°ã‚’å–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ7æ—¥ï¼‰
      let dueDays = 7;
      try {
        const settingsDoc = await db.collection('settings').doc('taskSettings').get();
        if (settingsDoc.exists) {
          dueDays = settingsDoc.data()?.productRegistration?.defaultDueDays || 7;
        }
      } catch (e) {
        console.warn('ã‚¿ã‚¹ã‚¯è¨­å®šå–å¾—å¤±æ•—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ7æ—¥ã‚’ä½¿ç”¨');
      }

      const dueDate = new Date();
      dueDate.setDate(dueDate.getDate() + dueDays);

      const newTaskId = `task-${Date.now()}-${Math.random().toString(36).substring(2, 6)}`;
      const taskData = {
        type: 'product_registration_task',
        title: `å•†å“ç™»éŒ²ï¼ˆæ®‹ã‚Š${itemCount}ç‚¹ï¼‰`,
        description: `å—å–å®Œäº†ã—ãŸ${itemCount}ç‚¹ã®å•†å“ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚æœŸé™: ${dueDate.getMonth() + 1}/${dueDate.getDate()}`,
        link: 'scan',
        relatedData: {
          batchId: batchId,
          totalCount: itemCount,
          remainingCount: itemCount,
          registeredCount: 0,
          supplier: supplier
        },
        dueDate: dueDate.toISOString(),
        createdAt: new Date().toISOString(),
        completed: false,
        read: false
      };

      await db.collection('userTasks')
        .doc(userEmail)
        .collection('tasks')
        .doc(newTaskId)
        .set(taskData);

      // purchaseBatchesã‚’æ›´æ–°
      await db.collection('purchaseBatches').doc(batchId).update({
        status: 'received',
        receivedAt: firebase.firestore.FieldValue.serverTimestamp(),
        registrationTaskId: newTaskId,
        registrationDueDate: dueDate.toISOString()
      });

      console.log('ğŸ“ [Task] å•†å“ç™»éŒ²ã‚¿ã‚¹ã‚¯ä½œæˆ:', newTaskId);
    }

    // ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—
    function getTypeIcon(type) {
      const icons = {
        'pending_user_approval': 'ğŸ‘¤',
        'inventory_alert': 'ğŸ“¦',
        'listing_approval': 'ğŸ“¤',
        'shipping_task': 'ğŸ“¦',
        'shipping_info_registration': 'ğŸ“¦',
        'bank_account_registration': 'ğŸ¦',
        'receiving_task': 'ğŸ“¬',
        'product_registration_task': 'ğŸ“',
        'revision_request': 'ğŸ”„',
        'inspection_task': 'ğŸ”'
      };
      return icons[type] || 'ğŸ“‹';
    }

    // ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—ã®ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
    function getTypeLabel(type) {
      const labels = {
        'pending_user_approval': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èª',
        'inventory_alert': 'åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆ',
        'listing_approval': 'å‡ºå“ç¢ºèª',
        'shipping_task': 'æ¢±åŒ…ãƒ»ç™ºé€',
        'shipping_info_registration': 'åˆæœŸè¨­å®š',
        'bank_account_registration': 'åˆæœŸè¨­å®š',
        'receiving_task': 'ä»•å…¥å•†å“å—å–',
        'product_registration_task': 'å•†å“ç™»éŒ²',
        'revision_request': 'ä¿®æ­£ä¾é ¼',
        'inspection_task': 'æ¤œå“ä½œæ¥­'
      };
      return labels[type] || 'ã‚¿ã‚¹ã‚¯';
    }

    // æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatDate(date) {
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return 'ãŸã£ãŸä»Š';
      if (minutes < 60) return `${minutes}åˆ†å‰`;
      if (hours < 24) return `${hours}æ™‚é–“å‰`;
      if (days < 7) return `${days}æ—¥å‰`;

      return `${date.getMonth() + 1}/${date.getDate()}`;
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ã‚¿ã‚¹ã‚¯ç¨®åˆ¥ã®ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
    function getTaskTypeLabel(taskType) {
      const typeLabels = {
        'shipping_task': 'ç™ºé€',
        'listing_approval': 'å‡ºå“ç¢ºèª',
        'inspection': 'æ¤œå“',
        'photography': 'æ’®å½±',
        'receiving_task': 'ä»•å…¥å—å–',
        'product_registration_task': 'å•†å“ç™»éŒ²',
        'other': 'ãã®ä»–'
      };
      return typeLabels[taskType] || taskType;
    }

    // å±¥æ­´ãƒšãƒ¼ã‚¸ã¸é·ç§»
    function goToHistory() {
      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) dropdown.classList.remove('active');

      if (window.parent && window.parent !== window) {
        window.parent.postMessage({
          type: 'navigateToPage',
          page: 'todo-history',
          pmToken: pmToken
        }, parentOrigin);
      } else {
        window.location.href = `todo_history.html?userEmail=${encodeURIComponent(userEmail)}&parentOrigin=${encodeURIComponent(parentOrigin)}&pmToken=${encodeURIComponent(pmToken)}`;
      }
    }

    // è¨­å®šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åˆ¶å¾¡
    function toggleSettingsDropdown(event) {
      event.stopPropagation();
      const dropdown = document.getElementById('settingsDropdown');
      dropdown.classList.toggle('active');
    }

    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown && !event.target.closest('.settings-dropdown') && !event.target.closest('.sub-header-icon')) {
        dropdown.classList.remove('active');
      }
    });

    // ãŠçŸ¥ã‚‰ã›ãƒšãƒ¼ã‚¸ã‚’é–‹ã
    function openAnnouncePage() {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'navigate', page: 'announce' }, '*');
      } else {
        window.location.href = '/announce.html';
      }
    }

    // æ¤œç´¢æ©Ÿèƒ½
    function performSearch() {
      const query = document.getElementById('searchInput').value.toLowerCase().trim();
      const clearBtn = document.getElementById('searchClearBtn');

      // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
      if (query) {
        clearBtn.classList.add('show');
      } else {
        clearBtn.classList.remove('show');
      }

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const filteredTasks = allPendingTasks.filter(task => {
        const title = (task.title || '').toLowerCase();
        const description = (task.description || '').toLowerCase();
        return title.includes(query) || description.includes(query);
      });

      // è¡¨ç¤ºæ›´æ–°
      const pendingTasksContainer = document.getElementById('pending-tasks');
      const pendingTasksList = document.getElementById('pending-tasks-list');

      if (filteredTasks.length > 0) {
        pendingTasksContainer.style.display = 'block';
        pendingTasksList.innerHTML = filteredTasks.map(task => renderTask(task)).join('');
      } else {
        if (query) {
          pendingTasksContainer.style.display = 'block';
          pendingTasksList.innerHTML = `
            <div style="text-align: center; padding: 32px; color: #9ca3af;">
              <i class="bi bi-search" style="font-size: 32px; display: block; margin-bottom: 8px;"></i>
              <p>ã€Œ${escapeHtml(query)}ã€ã«ä¸€è‡´ã™ã‚‹ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</p>
            </div>
          `;
        } else {
          pendingTasksContainer.style.display = allPendingTasks.length > 0 ? 'block' : 'none';
          pendingTasksList.innerHTML = allPendingTasks.map(task => renderTask(task)).join('');
        }
      }
    }

    // æ¤œç´¢ã‚¯ãƒªã‚¢
    function clearSearch() {
      document.getElementById('searchInput').value = '';
      document.getElementById('searchClearBtn').classList.remove('show');

      // å…ƒã®ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’å¾©å…ƒ
      const pendingTasksContainer = document.getElementById('pending-tasks');
      const pendingTasksList = document.getElementById('pending-tasks-list');

      if (allPendingTasks.length > 0) {
        pendingTasksContainer.style.display = 'block';
        pendingTasksList.innerHTML = allPendingTasks.map(task => renderTask(task)).join('');
      } else {
        pendingTasksContainer.style.display = 'none';
      }
    }

    // ã‚¿ã‚¹ã‚¯ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
    function handleTaskClick(taskId, link) {
      if (!link) return;

      // è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ãƒšãƒ¼ã‚¸é·ç§»ã‚’é€šçŸ¥
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({
          type: 'navigateToPage',
          page: link,
          pmToken: pmToken
        }, parentOrigin);
      }
    }

    // æˆ»ã‚‹ãƒœã‚¿ãƒ³
    // æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆäºŒé‡ç™ºç«é˜²æ­¢ä»˜ãï¼‰
    let isNavigatingBack = false;
    function goBack() {
      // äºŒé‡ç™ºç«é˜²æ­¢
      if (isNavigatingBack) {
        console.log('[todo_list] âš ï¸ äºŒé‡ç™ºç«ã‚’é˜²æ­¢ã—ã¾ã—ãŸ');
        return;
      }
      isNavigatingBack = true;

      if (window.parent && window.parent !== window) {
        // è¦ªã«ã€Œæˆ»ã‚ŠãŸã„ã€ã¨ã„ã†è¦æ±‚ã‚’é€ã‚‹ï¼ˆãƒãƒ£ãƒƒãƒˆã¨åŒã˜goBackã‚¿ã‚¤ãƒ—ã‚’ä½¿ç”¨ï¼‰
        window.parent.postMessage({
          type: 'goBack',
          pmToken: pmToken
        }, parentOrigin);
        console.log('[todo_list] goBack sent to parent (v284)');
      } else {
        history.back();
      }

      // 500mså¾Œã«ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒšãƒ¼ã‚¸é·ç§»ãŒå®Œäº†ã—ãªã‹ã£ãŸå ´åˆã®ãŸã‚ï¼‰
      setTimeout(() => { isNavigatingBack = false; }, 500);
    }

    // ========================================
    // ç®¡ç†è€…ã‚¿ã‚¹ã‚¯ç®¡ç†æ©Ÿèƒ½
    // ========================================

    // ç®¡ç†è€…ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºã‚’åˆ¶å¾¡
    async function checkAdminStatus() {
      if (!userEmail) return;

      try {
        const userDoc = await db.collection('users').doc(userEmail).get();
        if (userDoc.exists) {
          const userData = userDoc.data();
          if (userData.permissionId === 'owner' || userData.permissionId === 'admin') {
            window.isAdmin = true;
            const adminMenu = document.getElementById('adminTaskManagement');
            if (adminMenu) {
              adminMenu.style.display = 'flex';
            }
            // ç®¡ç†è€…ç”¨å»¶é•·ç”³è«‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            const extSection = document.getElementById('extensionRequestsSection');
            if (extSection) {
              extSection.style.display = 'block';
            }
          }
        }
      } catch (error) {
        console.error('ç®¡ç†è€…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ========================================
    // æœŸé™è¨­å®šãƒ»å»¶é•·ç”³è«‹æ©Ÿèƒ½
    // ========================================

    let pendingReceivingTask = null; // å—å–å®Œäº†å¾…ã¡ã‚¿ã‚¹ã‚¯æƒ…å ±
    let pendingExtensionTask = null; // å»¶é•·ç”³è«‹å¾…ã¡ã‚¿ã‚¹ã‚¯æƒ…å ±

    // å—å–å®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openReceivingCompleteModal(taskId, taskData) {
      pendingReceivingTask = { taskId, taskData };

      // ç‚¹æ•°ã‚’è¡¨ç¤º
      const itemCount = taskData.relatedData?.itemCount || 0;
      document.getElementById('receivingItemCount').textContent = itemCount;

      // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‹ã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ—¥æ•°ã‚’å–å¾—
      loadDefaultDueDays().then(days => {
        document.getElementById('receivingDueDays').value = days;
        updateReceivingDueDatePreview();
      });

      document.getElementById('receivingCompleteModal').classList.add('active');
    }

    // å—å–å®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeReceivingCompleteModal() {
      pendingReceivingTask = null;
      document.getElementById('receivingCompleteModal').classList.remove('active');
    }

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœŸé™æ—¥æ•°ã‚’å–å¾—
    async function loadDefaultDueDays() {
      try {
        const settingsDoc = await db.collection('settings').doc('taskSettings').get();
        if (settingsDoc.exists) {
          return settingsDoc.data()?.productRegistration?.defaultDueDays || 7;
        }
      } catch (e) {
        console.warn('ã‚¿ã‚¹ã‚¯è¨­å®šå–å¾—å¤±æ•—');
      }
      return 7;
    }

    // å—å–å®Œäº†æœŸé™ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
    function updateReceivingDueDatePreview() {
      const days = parseInt(document.getElementById('receivingDueDays').value) || 7;
      const dueDate = new Date();
      dueDate.setDate(dueDate.getDate() + days);
      const preview = `${dueDate.getMonth() + 1}/${dueDate.getDate()}ï¼ˆ${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][dueDate.getDay()]}ï¼‰ã¾ã§`;
      document.getElementById('receivingDueDatePreview').textContent = 'â†’ ' + preview;
    }

    // å—å–å®Œäº†ã‚’é€ä¿¡
    async function submitReceivingComplete() {
      if (!pendingReceivingTask) return;

      const { taskId, taskData } = pendingReceivingTask;
      const dueDays = parseInt(document.getElementById('receivingDueDays').value) || 7;

      try {
        // å•†å“ç™»éŒ²ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆï¼ˆã‚«ã‚¹ã‚¿ãƒ æœŸé™ä»˜ãï¼‰
        await createProductRegistrationTaskWithDeadline(taskData.relatedData, dueDays);

        // å—å–ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†
        const taskRef = db.collection('userTasks').doc(userEmail).collection('tasks').doc(taskId);
        await taskRef.update({
          completed: true,
          completedAt: new Date().toISOString()
        });

        closeReceivingCompleteModal();
        alert('å—å–ã‚’å®Œäº†ã—ã¾ã—ãŸ');
        loadTasks();
      } catch (error) {
        console.error('å—å–å®Œäº†ã‚¨ãƒ©ãƒ¼:', error);
        alert('å—å–å®Œäº†ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // å•†å“ç™»éŒ²ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆï¼ˆã‚«ã‚¹ã‚¿ãƒ æœŸé™ä»˜ãï¼‰
    async function createProductRegistrationTaskWithDeadline(relatedData, dueDays) {
      if (!relatedData || !relatedData.batchId) {
        console.warn('å•†å“ç™»éŒ²ã‚¿ã‚¹ã‚¯ä½œæˆã‚¹ã‚­ãƒƒãƒ—: relatedDataãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      const { batchId, itemCount, supplier } = relatedData;

      const dueDate = new Date();
      dueDate.setDate(dueDate.getDate() + dueDays);

      const newTaskId = `task-${Date.now()}-${Math.random().toString(36).substring(2, 6)}`;
      const taskData = {
        type: 'product_registration_task',
        title: `å•†å“ç™»éŒ²ï¼ˆæ®‹ã‚Š${itemCount}ç‚¹ï¼‰`,
        description: `å—å–å®Œäº†ã—ãŸ${itemCount}ç‚¹ã®å•†å“ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚æœŸé™: ${dueDate.getMonth() + 1}/${dueDate.getDate()}`,
        link: 'scan',
        relatedData: {
          batchId: batchId,
          totalCount: itemCount,
          remainingCount: itemCount,
          registeredCount: 0,
          supplier: supplier
        },
        dueDate: dueDate.toISOString(),
        originalDueDate: dueDate.toISOString(), // åˆå›è¨­å®šã®æœŸé™ã‚’è¨˜éŒ²
        dueDateSetBy: userEmail,
        extensionCount: 0,
        createdAt: new Date().toISOString(),
        completed: false,
        read: false
      };

      await db.collection('userTasks')
        .doc(userEmail)
        .collection('tasks')
        .doc(newTaskId)
        .set(taskData);

      // purchaseBatchesã‚’æ›´æ–°
      await db.collection('purchaseBatches').doc(batchId).update({
        status: 'received',
        receivedAt: firebase.firestore.FieldValue.serverTimestamp(),
        registrationTaskId: newTaskId,
        registrationDueDate: dueDate.toISOString()
      });

      console.log('ğŸ“ [Task] å•†å“ç™»éŒ²ã‚¿ã‚¹ã‚¯ä½œæˆï¼ˆã‚«ã‚¹ã‚¿ãƒ æœŸé™ï¼‰:', newTaskId, dueDays + 'æ—¥');
    }

    // å»¶é•·ç”³è«‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openExtensionRequestModal(taskId, taskData) {
      pendingExtensionTask = { taskId, taskData };

      // ç¾åœ¨ã®æœŸé™ã‚’è¡¨ç¤º
      const currentDueDate = taskData.dueDate ?
        (taskData.dueDate.toDate ? taskData.dueDate.toDate() : new Date(taskData.dueDate)) :
        new Date();
      const dateStr = `${currentDueDate.getMonth() + 1}/${currentDueDate.getDate()}ï¼ˆ${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][currentDueDate.getDay()]}ï¼‰`;
      document.getElementById('extensionCurrentDueDate').textContent = dateStr;

      // å»¶é•·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
      document.getElementById('extensionDays').value = 3;
      document.getElementById('extensionReason').value = '';
      updateExtensionDueDatePreview();

      document.getElementById('extensionRequestModal').classList.add('active');
    }

    // å»¶é•·ç”³è«‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeExtensionRequestModal() {
      pendingExtensionTask = null;
      document.getElementById('extensionRequestModal').classList.remove('active');
    }

    // å»¶é•·æœŸé™ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
    function updateExtensionDueDatePreview() {
      if (!pendingExtensionTask) return;

      const days = parseInt(document.getElementById('extensionDays').value) || 3;
      const currentDueDate = pendingExtensionTask.taskData.dueDate ?
        (pendingExtensionTask.taskData.dueDate.toDate ? pendingExtensionTask.taskData.dueDate.toDate() : new Date(pendingExtensionTask.taskData.dueDate)) :
        new Date();

      const newDueDate = new Date(currentDueDate);
      newDueDate.setDate(newDueDate.getDate() + days);
      const preview = `${newDueDate.getMonth() + 1}/${newDueDate.getDate()}ï¼ˆ${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][newDueDate.getDay()]}ï¼‰ã¾ã§`;
      document.getElementById('extensionDueDatePreview').textContent = 'â†’ ' + preview;
    }

    // å»¶é•·ç”³è«‹ã‚’é€ä¿¡
    async function submitExtensionRequest() {
      if (!pendingExtensionTask) return;

      const { taskId, taskData } = pendingExtensionTask;
      const extensionDays = parseInt(document.getElementById('extensionDays').value) || 3;
      const reason = document.getElementById('extensionReason').value.trim();

      if (!reason) {
        alert('ç”³è«‹ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      try {
        const currentDueDate = taskData.dueDate ?
          (taskData.dueDate.toDate ? taskData.dueDate.toDate() : new Date(taskData.dueDate)) :
          new Date();

        const newDueDate = new Date(currentDueDate);
        newDueDate.setDate(newDueDate.getDate() + extensionDays);

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
        let userName = userEmail;
        try {
          const userDoc = await db.collection('users').doc(userEmail).get();
          if (userDoc.exists) {
            userName = userDoc.data().userName || userDoc.data().name || userEmail;
          }
        } catch (e) {}

        // å»¶é•·ç”³è«‹ã‚’ä½œæˆ
        const requestId = `ext-${Date.now()}-${Math.random().toString(36).substring(2, 6)}`;
        await db.collection('extensionRequests').doc(requestId).set({
          taskId: taskId,
          taskOwnerEmail: userEmail,
          taskTitle: taskData.title || 'å•†å“ç™»éŒ²ã‚¿ã‚¹ã‚¯',
          taskType: taskData.type,
          requestedBy: userEmail,
          requestedByName: userName,
          currentDueDate: currentDueDate.toISOString(),
          requestedDays: extensionDays,
          newDueDate: newDueDate.toISOString(),
          reason: reason,
          status: 'pending',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // ã‚¿ã‚¹ã‚¯ã«ç”³è«‹ä¸­ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
        const taskRef = db.collection('userTasks').doc(userEmail).collection('tasks').doc(taskId);
        await taskRef.update({
          pendingExtension: true,
          pendingExtensionId: requestId
        });

        console.log('ğŸ“ [Extension] å»¶é•·ç”³è«‹ä½œæˆ:', requestId);
        closeExtensionRequestModal();
        alert('å»¶é•·ç”³è«‹ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã®æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚');
        loadTasks();

        // ç®¡ç†è€…å…¨å“¡ã«ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’é€ä¿¡
        try {
          const adminsSnapshot = await db.collection('users')
            .where('status', '==', 'active')
            .get();
          
          const adminTokens = [];
          adminsSnapshot.forEach(doc => {
            const userData = doc.data();
            if ((userData.permissionId === 'owner' || userData.permissionId === 'admin') && userData.fcmToken) {
              adminTokens.push(userData.fcmToken);
            }
          });

          if (adminTokens.length > 0) {
            await fetch('https://reborn-fcm-worker.mercari-yasuhirotakuji.workers.dev/send', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                tokens: adminTokens,
                title: 'ğŸ“‹ æœŸé™å»¶é•·ç”³è«‹',
                body: `${userName}ã•ã‚“ã‹ã‚‰å»¶é•·ç”³è«‹ãŒå±Šãã¾ã—ãŸï¼ˆ${extensionDays}æ—¥é–“ï¼‰`,
                data: { type: 'extension_request', requestId: requestId }
              })
            });
            console.log('ğŸ“¤ [Extension] ç®¡ç†è€…ã¸ã®é€šçŸ¥é€ä¿¡å®Œäº†');
          }
        } catch (notifyError) {
          console.error('ç®¡ç†è€…ã¸ã®é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼:', notifyError);
        }

      } catch (error) {
        console.error('å»¶é•·ç”³è«‹ã‚¨ãƒ©ãƒ¼:', error);
        alert('å»¶é•·ç”³è«‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // å»¶é•·ç”³è«‹ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ï¼ˆç®¡ç†è€…ç”¨ï¼‰
    async function loadExtensionRequests() {
      if (!window.isAdmin) return;

      try {
        const snapshot = await db.collection('extensionRequests')
          .where('status', '==', 'pending')
          .orderBy('createdAt', 'desc')
          .get();

        const container = document.getElementById('extensionRequestsList');
        if (!container) return;

        if (snapshot.empty) {
          container.innerHTML = '<div style="text-align: center; color: #9ca3af; font-size: 13px; padding: 20px;">ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
          document.getElementById('extensionRequestsCount').textContent = '0';
          return;
        }

        let html = '';
        snapshot.forEach(doc => {
          const req = doc.data();
          const createdAt = req.createdAt?.toDate ? req.createdAt.toDate() : new Date();
          const currentDate = new Date(req.currentDueDate);
          const newDate = new Date(req.newDueDate);

          html += `
            <div class="extension-request-card">
              <div class="extension-request-header">
                <div class="extension-request-avatar">ğŸ‘¤</div>
                <div class="extension-request-info">
                  <h4>${escapeHtml(req.requestedByName)}</h4>
                  <span>${createdAt.getMonth() + 1}/${createdAt.getDate()} ç”³è«‹</span>
                </div>
              </div>
              <div class="extension-request-body">
                <div style="font-size: 13px; color: #374151; margin-bottom: 8px;">
                  ${escapeHtml(req.taskTitle)}
                </div>
                <div class="extension-request-dates">
                  <span>${currentDate.getMonth() + 1}/${currentDate.getDate()}</span>
                  <span class="arrow">â†’</span>
                  <span class="new-date">${newDate.getMonth() + 1}/${newDate.getDate()}ï¼ˆ+${req.requestedDays}æ—¥ï¼‰</span>
                </div>
                <div class="extension-request-reason">
                  ğŸ’¬ ${escapeHtml(req.reason)}
                </div>
              </div>
              <div class="extension-request-actions">
                <button class="extension-request-btn reject" onclick="rejectExtensionRequest('${doc.id}')">å´ä¸‹</button>
                <button class="extension-request-btn approve" onclick="approveExtensionRequest('${doc.id}')">æ‰¿èª</button>
              </div>
            </div>
          `;
        });

        container.innerHTML = html;
        document.getElementById('extensionRequestsCount').textContent = snapshot.size;

      } catch (error) {
        console.error('å»¶é•·ç”³è«‹èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // å»¶é•·ç”³è«‹ã‚’æ‰¿èª
    async function approveExtensionRequest(requestId) {
      if (!confirm('ã“ã®å»¶é•·ç”³è«‹ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ')) return;

      try {
        const reqDoc = await db.collection('extensionRequests').doc(requestId).get();
        if (!reqDoc.exists) {
          alert('ç”³è«‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        const req = reqDoc.data();

        // ã‚¿ã‚¹ã‚¯ã®æœŸé™ã‚’æ›´æ–°
        const taskRef = db.collection('userTasks').doc(req.taskOwnerEmail).collection('tasks').doc(req.taskId);
        const taskDoc = await taskRef.get();

        if (taskDoc.exists) {
          const taskData = taskDoc.data();
          await taskRef.update({
            dueDate: req.newDueDate,
            extensionCount: (taskData.extensionCount || 0) + 1,
            pendingExtension: false,
            pendingExtensionId: null,
            lastExtendedAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastExtendedBy: userEmail
          });
        }

        // ç”³è«‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
        await db.collection('extensionRequests').doc(requestId).update({
          status: 'approved',
          reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
          reviewedBy: userEmail
        });

        console.log('âœ… [Extension] ç”³è«‹æ‰¿èª:', requestId);
        alert('å»¶é•·ç”³è«‹ã‚’æ‰¿èªã—ã¾ã—ãŸ');
        loadExtensionRequests();

        // ç”³è«‹è€…ã«ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’é€ä¿¡
        try {
          const requesterDoc = await db.collection('users').doc(req.taskOwnerEmail).get();
          if (requesterDoc.exists && requesterDoc.data().fcmToken) {
            await fetch('https://reborn-fcm-worker.mercari-yasuhirotakuji.workers.dev/send', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                tokens: [requesterDoc.data().fcmToken],
                title: 'âœ… å»¶é•·ç”³è«‹ãŒæ‰¿èªã•ã‚Œã¾ã—ãŸ',
                body: `æœŸé™ãŒ${req.requestedDays}æ—¥é–“å»¶é•·ã•ã‚Œã¾ã—ãŸ`,
                data: { type: 'extension_approved', taskId: req.taskId }
              })
            });
            console.log('ğŸ“¤ [Extension] ç”³è«‹è€…ã¸ã®æ‰¿èªé€šçŸ¥é€ä¿¡å®Œäº†');
          }
        } catch (notifyError) {
          console.error('ç”³è«‹è€…ã¸ã®é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼:', notifyError);
        }

      } catch (error) {
        console.error('æ‰¿èªã‚¨ãƒ©ãƒ¼:', error);
        alert('æ‰¿èªã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // å»¶é•·ç”³è«‹ã‚’å´ä¸‹
    async function rejectExtensionRequest(requestId) {
      if (!confirm('ã“ã®å»¶é•·ç”³è«‹ã‚’å´ä¸‹ã—ã¾ã™ã‹ï¼Ÿ')) return;

      try {
        const reqDoc = await db.collection('extensionRequests').doc(requestId).get();
        if (!reqDoc.exists) {
          alert('ç”³è«‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        const req = reqDoc.data();

        // ã‚¿ã‚¹ã‚¯ã®ãƒ•ãƒ©ã‚°ã‚’è§£é™¤
        const taskRef = db.collection('userTasks').doc(req.taskOwnerEmail).collection('tasks').doc(req.taskId);
        await taskRef.update({
          pendingExtension: false,
          pendingExtensionId: null
        });

        // ç”³è«‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
        await db.collection('extensionRequests').doc(requestId).update({
          status: 'rejected',
          reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
          reviewedBy: userEmail
        });

        console.log('âŒ [Extension] ç”³è«‹å´ä¸‹:', requestId);
        alert('å»¶é•·ç”³è«‹ã‚’å´ä¸‹ã—ã¾ã—ãŸ');
        loadExtensionRequests();

        // ç”³è«‹è€…ã«ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’é€ä¿¡
        try {
          const requesterDoc = await db.collection('users').doc(req.taskOwnerEmail).get();
          if (requesterDoc.exists && requesterDoc.data().fcmToken) {
            await fetch('https://reborn-fcm-worker.mercari-yasuhirotakuji.workers.dev/send', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                tokens: [requesterDoc.data().fcmToken],
                title: 'âš ï¸ å»¶é•·ç”³è«‹ãŒå´ä¸‹ã•ã‚Œã¾ã—ãŸ',
                body: 'å»¶é•·ç”³è«‹ã¯æ‰¿èªã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚è©³ç´°ã¯ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚',
                data: { type: 'extension_rejected', taskId: req.taskId }
              })
            });
            console.log('ğŸ“¤ [Extension] ç”³è«‹è€…ã¸ã®å´ä¸‹é€šçŸ¥é€ä¿¡å®Œäº†');
          }
        } catch (notifyError) {
          console.error('ç”³è«‹è€…ã¸ã®é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼:', notifyError);
        }

      } catch (error) {
        console.error('å´ä¸‹ã‚¨ãƒ©ãƒ¼:', error);
        alert('å´ä¸‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    async function openTaskManagement() {
      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) dropdown.classList.remove('active');

      const modal = document.getElementById('taskAdminModal');
      if (modal) {
        modal.classList.add('active');
        await loadAdminTaskData();
      }
    }

    // ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeTaskManagement(event) {
      if (event && event.target !== event.currentTarget) return;

      const modal = document.getElementById('taskAdminModal');
      if (modal) {
        modal.classList.remove('active');
      }
    }

    // ç®¡ç†è€…ç”¨ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
    async function loadAdminTaskData() {
      const userListEl = document.getElementById('adminUserTaskList');
      const totalUsersEl = document.getElementById('adminTaskTotal');
      const pendingTasksEl = document.getElementById('adminTaskPending');
      const overdueEl = document.getElementById('adminTaskOverdue');

      if (!userListEl) return;

      userListEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #9ca3af;"><i class="bi bi-arrow-repeat spin"></i> èª­ã¿è¾¼ã¿ä¸­...</div>';

      try {
        // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
        const usersSnapshot = await db.collection('users').get();
        const usersData = [];
        let usersWithPending = 0;
        let overdueCount = 0;
        const threeDaysAgo = new Date();
        threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);

        // å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ã‚¹ã‚¯ã‚’å–å¾—
        for (const userDoc of usersSnapshot.docs) {
          const userData = userDoc.data();
          const userEmail = userDoc.id;

          // ã‚¿ã‚¹ã‚¯ã‚’å–å¾—
          const tasksSnapshot = await db.collection('userTasks').doc(userEmail)
            .collection('tasks')
            .orderBy('createdAt', 'desc')
            .get();

          let pending = 0;
          let completedThisWeek = 0;
          let overdue = 0;
          const pendingByType = {}; // ã‚¿ã‚¹ã‚¯ç¨®åˆ¥ã”ã¨ã®æœªå®Œäº†æ•°

          const now = new Date();
          // ä»Šé€±ã®é–‹å§‹æ—¥ï¼ˆæ—¥æ›œæ—¥ï¼‰ã‚’è¨ˆç®—
          const weekStart = new Date(now);
          weekStart.setDate(now.getDate() - now.getDay());
          weekStart.setHours(0, 0, 0, 0);

          tasksSnapshot.docs.forEach(doc => {
            const task = doc.data();
            if (task.completed) {
              // ä»Šé€±å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆ
              const completedAt = task.completedAt?.toDate ? task.completedAt.toDate() :
                                  (task.completedAt ? new Date(task.completedAt) : null);
              if (completedAt && completedAt >= weekStart) {
                completedThisWeek++;
              }
            } else {
              pending++;
              // ã‚¿ã‚¹ã‚¯ç¨®åˆ¥ã”ã¨ã«ã‚«ã‚¦ãƒ³ãƒˆ
              const taskType = task.type || 'other';
              const typeLabel = getTaskTypeLabel(taskType);
              pendingByType[typeLabel] = (pendingByType[typeLabel] || 0) + 1;

              // æœŸé™åˆ‡ã‚Œãƒã‚§ãƒƒã‚¯ï¼ˆç™ºé€ã‚¿ã‚¹ã‚¯ã¯dueDateã€ãã‚Œä»¥å¤–ã¯3æ—¥æ”¾ç½®ï¼‰
              if (task.dueDate) {
                // dueDateãŒã‚ã‚‹ã‚¿ã‚¹ã‚¯ï¼ˆç™ºé€ã‚¿ã‚¹ã‚¯ç­‰ï¼‰
                const dueDate = task.dueDate.toDate ? task.dueDate.toDate() : new Date(task.dueDate);
                if (dueDate < now) {
                  overdue++;
                }
              } else if (task.createdAt) {
                // dueDateãŒãªã„ã‚¿ã‚¹ã‚¯ã¯3æ—¥ä»¥ä¸Šæ”¾ç½®ã§ã‚«ã‚¦ãƒ³ãƒˆ
                const createdDate = task.createdAt.toDate ? task.createdAt.toDate() : new Date(task.createdAt);
                if (createdDate < threeDaysAgo) {
                  overdue++;
                }
              }
            }
          });

          if (pending > 0) usersWithPending++;
          overdueCount += overdue;

          usersData.push({
            email: userEmail,
            name: userData.userName || userData.displayName || userData.name || userEmail.split('@')[0],
            photoURL: userData.photoURL || '',
            pending: pending,
            completedThisWeek: completedThisWeek,
            pendingByType: pendingByType,
            overdue: overdue
          });
        }

        // ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
        if (totalUsersEl) totalUsersEl.textContent = usersData.length;
        if (pendingTasksEl) pendingTasksEl.textContent = usersWithPending;
        if (overdueEl) overdueEl.textContent = overdueCount;

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆæœªå®Œäº†ã‚¿ã‚¹ã‚¯ãŒã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å„ªå…ˆï¼‰
        usersData.sort((a, b) => b.pending - a.pending);

        if (usersData.length === 0) {
          userListEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #9ca3af;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</div>';
          return;
        }

        userListEl.innerHTML = usersData.map(user => {
          // æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã®ç¨®åˆ¥è¡¨ç¤ºã‚’ç”Ÿæˆ
          const pendingTypeText = user.pending > 0
            ? Object.entries(user.pendingByType).map(([type, count]) => `${type}: ${count}`).join(', ')
            : '';

          return `
          <div class="admin-user-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: ${user.overdue > 0 ? '#fef2f2' : '#f9fafb'}; border-radius: 8px; margin-bottom: 8px; ${user.overdue > 0 ? 'border-left: 3px solid #ef4444;' : ''}">
            <div style="display: flex; align-items: center; gap: 12px;">
              ${user.photoURL
                ? `<img src="${escapeHtml(user.photoURL)}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">`
                : `<div style="width: 40px; height: 40px; background: #e5e7eb; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-person" style="color: #9ca3af; font-size: 18px;"></i>
                  </div>`
              }
              <div style="font-weight: 500;">${escapeHtml(user.name)}</div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 12px; color: #6b7280;">
                æœªå®Œäº†: <span style="color: ${user.pending > 0 ? '#ef4444' : '#22c55e'}; font-weight: 600;">${user.pending}</span>
                ${pendingTypeText ? `<span style="font-size: 10px; color: #9ca3af; margin-left: 4px;">(${pendingTypeText})</span>` : ''}
              </div>
              ${user.overdue > 0
                ? `<div style="font-size: 11px; color: #ef4444;">âš ï¸ ${user.overdue}ä»¶ãŒè¦å¯¾å¿œ</div>`
                : `<div style="font-size: 12px; color: #6b7280;">ä»Šé€±å®Œäº†: <span style="color: #22c55e;">${user.completedThisWeek}</span></div>`
              }
            </div>
          </div>
        `}).join('');

      } catch (error) {
        console.error('ç®¡ç†è€…ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        userListEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      }
    }

    // å€‹åˆ¥ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’é€ä¿¡
    async function sendReminder(userEmail, userName) {
      if (!confirm(`${userName}ã•ã‚“ã«ã‚¿ã‚¹ã‚¯æœªå®Œäº†ã®é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`)) return;

      try {
        const now = firebase.firestore.Timestamp.now();
        await db.collection('users').doc(userEmail).collection('userAnnouncements').add({
          title: 'ã‚¿ã‚¹ã‚¯æœªå®Œäº†ã®ãŠçŸ¥ã‚‰ã›',
          content: 'æœªå®Œäº†ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚',
          createdAt: now,
          read: false,
          type: 'reminder'
        });

        alert(`${userName}ã•ã‚“ã«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ`);
      } catch (error) {
        console.error('ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        alert('é€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ============================================
    // å´ä¸‹æ©Ÿèƒ½
    // ============================================

    let rejectingTaskId = null;
    let rejectingTaskType = null;

    /**
     * å´ä¸‹ç†ç”±å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
     */
    function openRejectModal(taskId, taskType) {
      rejectingTaskId = taskId;
      rejectingTaskType = taskType;
      document.getElementById('rejectReason').value = '';
      document.getElementById('rejectModal').style.display = 'flex';
    }

    /**
     * å´ä¸‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
     */
    function closeRejectModal() {
      rejectingTaskId = null;
      rejectingTaskType = null;
      document.getElementById('rejectModal').style.display = 'none';
    }

    /**
     * å´ä¸‹ã‚’å®Ÿè¡Œ
     */
    async function submitReject() {
      const reason = document.getElementById('rejectReason').value.trim();
      if (!reason) {
        alert('å´ä¸‹ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      if (!rejectingTaskId) {
        alert('ã‚¿ã‚¹ã‚¯ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }

      try {
        // å…ƒã®ã‚¿ã‚¹ã‚¯ã‚’å–å¾—
        const taskRef = db.collection('userTasks').doc(userEmail).collection('tasks').doc(rejectingTaskId);
        const taskDoc = await taskRef.get();
        if (!taskDoc.exists) {
          alert('ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        const taskData = taskDoc.data();
        const staffEmail = taskData.relatedData?.staffEmail || taskData.relatedData?.createdByEmail;
        const staffName = taskData.relatedData?.staffName || taskData.relatedData?.createdBy || 'æ‹…å½“è€…';
        const productId = taskData.relatedData?.productId;
        const managementNumber = taskData.relatedData?.managementNumber;

        if (!staffEmail) {
          alert('æ‹…å½“è€…ã®æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        // å…ƒã®ã‚¿ã‚¹ã‚¯ã‚’å´ä¸‹çŠ¶æ…‹ã«æ›´æ–°
        await taskRef.update({
          rejected: true,
          rejectedAt: new Date().toISOString(),
          rejectedBy: userEmail,
          rejectReason: reason,
          completed: false
        });

        // æ‹…å½“è€…ã«ä¿®æ­£ä¾é ¼ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ
        const revisionTaskRef = db.collection('userTasks').doc(staffEmail).collection('tasks').doc();
        await revisionTaskRef.set({
          type: 'revision_request',
          title: `ä¿®æ­£ä¾é ¼: ${taskData.title || 'å‡ºå“ç¢ºèª'}`,
          description: `ã€å´ä¸‹ç†ç”±ã€‘\n${reason}`,
          createdAt: new Date().toISOString(),
          completed: false,
          priority: 'high',
          link: productId ? `/product.html?edit=${productId}` : null,
          relatedData: {
            originalTaskId: rejectingTaskId,
            originalTaskType: rejectingTaskType,
            productId: productId,
            managementNumber: managementNumber,
            rejectedBy: userEmail,
            rejectReason: reason
          }
        });

        console.log('âœ… [Task] ã‚¿ã‚¹ã‚¯å´ä¸‹å®Œäº†:', rejectingTaskId);
        console.log('âœ… [Task] ä¿®æ­£ä¾é ¼ã‚¿ã‚¹ã‚¯ä½œæˆ:', staffEmail);

        closeRejectModal();
        alert(`${staffName}ã•ã‚“ã«ä¿®æ­£ä¾é ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸ`);
        loadTasks(); // å†èª­ã¿è¾¼ã¿

      } catch (error) {
        console.error('âŒ [Task] å´ä¸‹ã‚¨ãƒ©ãƒ¼:', error);
        alert('å´ä¸‹å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // åˆæœŸåŒ–
    loadTasks();
    // ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯å®Œäº†å¾Œã«å»¶é•·ç”³è«‹ã‚’èª­ã¿è¾¼ã‚€
    checkAdminStatus().then(() => {
      loadExtensionRequests();
    });
  </script>

  <!-- å—å–å®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæœŸé™è¨­å®šï¼‰ -->
  <div id="receivingCompleteModal" class="deadline-modal">
    <div class="deadline-modal-content">
      <div class="deadline-modal-header">
        <h3><i class="bi bi-check-circle" style="color: #10b981; margin-right: 8px;"></i>å—å–å®Œäº†</h3>
        <button class="deadline-modal-close" onclick="closeReceivingCompleteModal()">&times;</button>
      </div>
      <div class="deadline-modal-body">
        <div style="background: #f0fdf4; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
          <div style="font-size: 13px; color: #166534;">
            <strong id="receivingItemCount">0</strong>ç‚¹ã®å•†å“ã‚’å—ã‘å–ã‚Šã¾ã—ãŸ
          </div>
        </div>

        <div class="deadline-input-group">
          <label><i class="bi bi-calendar-event" style="margin-right: 6px;"></i>å•†å“ç™»éŒ²æœŸé™</label>
          <div class="deadline-input-row">
            <input type="number" id="receivingDueDays" min="1" max="30" value="7" onchange="updateReceivingDueDatePreview()">
            <span>æ—¥å¾Œ</span>
          </div>
          <div class="deadline-preview" id="receivingDueDatePreview"></div>
        </div>

        <div class="deadline-note">
          <i class="bi bi-info-circle" style="margin-right: 4px;"></i>
          ã“ã®æœŸé™ã¯å—å–ç‚¹æ•°ã‚„æ‹…å½“è€…ã®çŠ¶æ³ã«å¿œã˜ã¦èª¿æ•´ã§ãã¾ã™ã€‚<br>
          è¨­å®šå¾Œã®å»¶é•·ã«ã¯ç®¡ç†è€…ã®æ‰¿èªãŒå¿…è¦ã§ã™ã€‚
        </div>
      </div>
      <div class="deadline-modal-footer">
        <button class="deadline-modal-btn cancel" onclick="closeReceivingCompleteModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="deadline-modal-btn primary" onclick="submitReceivingComplete()">å®Œäº†</button>
      </div>
    </div>
  </div>

  <!-- å»¶é•·ç”³è«‹ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="extensionRequestModal" class="deadline-modal">
    <div class="deadline-modal-content">
      <div class="deadline-modal-header">
        <h3><i class="bi bi-clock-history" style="color: #f59e0b; margin-right: 8px;"></i>æœŸé™å»¶é•·ç”³è«‹</h3>
        <button class="deadline-modal-close" onclick="closeExtensionRequestModal()">&times;</button>
      </div>
      <div class="deadline-modal-body">
        <div style="background: #fef3c7; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
          <div style="font-size: 12px; color: #92400e;">
            <strong>ç¾åœ¨ã®æœŸé™:</strong> <span id="extensionCurrentDueDate">-</span>
          </div>
        </div>

        <div class="deadline-input-group">
          <label><i class="bi bi-plus-circle" style="margin-right: 6px;"></i>å»¶é•·æ—¥æ•°</label>
          <div class="deadline-input-row">
            <input type="number" id="extensionDays" min="1" max="14" value="3" onchange="updateExtensionDueDatePreview()">
            <span>æ—¥å»¶é•·</span>
          </div>
          <div class="deadline-preview" id="extensionDueDatePreview"></div>
        </div>

        <div class="deadline-input-group">
          <label><i class="bi bi-chat-left-text" style="margin-right: 6px;"></i>ç”³è«‹ç†ç”±ï¼ˆå¿…é ˆï¼‰</label>
          <textarea id="extensionReason" placeholder="ä¾‹: ç‰©é‡ãŒå¤šãã€æ’®å½±ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã‚‹ãŸã‚" style="width: 100%; height: 80px; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; resize: none; box-sizing: border-box;"></textarea>
        </div>

        <div class="deadline-note">
          <i class="bi bi-shield-check" style="margin-right: 4px;"></i>
          ç”³è«‹ã¯ç®¡ç†è€…ã«é€ä¿¡ã•ã‚Œã€æ‰¿èªå¾Œã«æœŸé™ãŒå»¶é•·ã•ã‚Œã¾ã™ã€‚
        </div>
      </div>
      <div class="deadline-modal-footer">
        <button class="deadline-modal-btn cancel" onclick="closeExtensionRequestModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="deadline-modal-btn primary" onclick="submitExtensionRequest()">ç”³è«‹ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- å´ä¸‹ç†ç”±å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="rejectModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; padding: 20px;">
    <div style="background: white; border-radius: 16px; width: 100%; max-width: 400px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
      <div style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #1f2937;">å´ä¸‹ç†ç”±</h3>
          <button onclick="closeRejectModal()" style="background: none; border: none; font-size: 24px; color: #9ca3af; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
        </div>
      </div>
      <div style="padding: 20px;">
        <p style="margin: 0 0 12px 0; font-size: 14px; color: #6b7280;">ä¿®æ­£ãŒå¿…è¦ãªç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚æ‹…å½“è€…ã«é€šçŸ¥ã•ã‚Œã¾ã™ã€‚</p>
        <textarea id="rejectReason" placeholder="ä¾‹: ç”»åƒãŒæš—ã„ã®ã§æ’®ã‚Šç›´ã—ã¦ãã ã•ã„" style="width: 100%; height: 120px; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; resize: none; box-sizing: border-box;"></textarea>
      </div>
      <div style="padding: 16px 20px; background: #f9fafb; display: flex; gap: 12px;">
        <button onclick="closeRejectModal()" style="flex: 1; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; background: white; font-size: 14px; font-weight: 500; color: #374151; cursor: pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button onclick="submitReject()" style="flex: 1; padding: 12px; border: none; border-radius: 8px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); font-size: 14px; font-weight: 500; color: white; cursor: pointer;">å´ä¸‹ã™ã‚‹</button>
      </div>
    </div>
  </div>
</body>
</html>
