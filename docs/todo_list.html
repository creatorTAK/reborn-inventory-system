<!DOCTYPE html>
<html>
<head>
  <!-- Cache Bust: 2025-11-30 - やることリスト機能追加 -->
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>やることリスト</title>
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- REBORN Brand Colors & Theme -->
  <link rel="stylesheet" href="/css/reborn-brand-colors.css?v=0bd1a9b">
  <link rel="stylesheet" href="/css/reborn-theme.css?v=0bd1a9b">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      min-height: 100vh;
    }
    .header {
      background: white;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .back-button {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      color: var(--reborn-primary);
    }
    .header-title {
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
    }
    .tasks-container {
      padding: 16px;
      max-width: 600px;
      margin: 0 auto;
    }
    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 12px;
      padding-left: 4px;
    }
    .task-item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: all 0.2s ease;
      border-left: 4px solid var(--reborn-primary);
    }
    .task-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    .task-item.completed {
      opacity: 0.6;
      border-left-color: #9ca3af;
    }
    .task-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .task-checkbox {
      width: 24px;
      height: 24px;
      border: 2px solid #d1d5db;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .task-checkbox:hover {
      border-color: var(--reborn-primary);
    }
    .task-checkbox.checked {
      background: var(--reborn-primary);
      border-color: var(--reborn-primary);
      color: white;
    }
    .task-content {
      flex: 1;
    }
    .task-title {
      font-size: 15px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }
    .task-description {
      font-size: 13px;
      color: #6b7280;
      line-height: 1.4;
    }
    .task-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      font-size: 12px;
      color: #9ca3af;
    }
    .task-action {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 12px;
      background: #eff6ff;
      color: var(--reborn-primary);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      margin-top: 8px;
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #9ca3af;
    }
    .empty-state i {
      font-size: 48px;
      margin-bottom: 16px;
      display: block;
    }
    .empty-state p {
      font-size: 16px;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    .type-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    .type-badge.pending_user_approval {
      background: #fef3c7;
      color: #92400e;
    }
    .type-badge.inventory_alert {
      background: #fee2e2;
      color: #991b1b;
    }
    .type-badge.default {
      background: #e0e7ff;
      color: #3730a3;
    }
  </style>
</head>
<body>
  <div class="header">
    <button class="back-button" onclick="goBack()">
      <i class="bi bi-chevron-left"></i>
    </button>
    <span class="header-title">✓ やることリスト</span>
  </div>

  <div class="tasks-container">
    <div id="loading" class="loading">
      <i class="bi bi-arrow-repeat"></i> 読み込み中...
    </div>

    <div id="pending-tasks" style="display: none;">
      <div class="section-title">未完了のタスク</div>
      <div id="pending-tasks-list"></div>
    </div>

    <div id="completed-tasks" style="display: none; margin-top: 24px;">
      <div class="section-title">完了したタスク</div>
      <div id="completed-tasks-list"></div>
    </div>

    <div id="empty-state" class="empty-state" style="display: none;">
      <i class="bi bi-check-circle"></i>
      <p>やることはありません</p>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    // URL パラメータを取得
    const urlParams = new URLSearchParams(window.location.search);
    const userEmail = urlParams.get('userEmail') || '';
    const parentOrigin = urlParams.get('parentOrigin') || window.location.origin;
    const pmToken = urlParams.get('pmToken') || '';

    // Firebase 初期化
    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "reborn-chat.firebaseapp.com",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // タスク一覧を読み込み
    async function loadTasks() {
      if (!userEmail) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('empty-state').style.display = 'block';
        return;
      }

      try {
        const tasksRef = db.collection('userTasks').doc(userEmail).collection('tasks');
        const snapshot = await tasksRef.orderBy('createdAt', 'desc').get();

        const pendingTasks = [];
        const completedTasks = [];

        snapshot.forEach(doc => {
          const task = { id: doc.id, ...doc.data() };
          if (task.completed) {
            completedTasks.push(task);
          } else {
            pendingTasks.push(task);
          }
        });

        document.getElementById('loading').style.display = 'none';

        if (pendingTasks.length === 0 && completedTasks.length === 0) {
          document.getElementById('empty-state').style.display = 'block';
          return;
        }

        // 未完了タスクを表示
        if (pendingTasks.length > 0) {
          document.getElementById('pending-tasks').style.display = 'block';
          document.getElementById('pending-tasks-list').innerHTML = pendingTasks.map(task => renderTask(task)).join('');
        }

        // 完了タスクを表示（最新5件のみ）
        if (completedTasks.length > 0) {
          document.getElementById('completed-tasks').style.display = 'block';
          document.getElementById('completed-tasks-list').innerHTML = completedTasks.slice(0, 5).map(task => renderTask(task)).join('');
        }

      } catch (error) {
        console.error('タスク読み込みエラー:', error);
        document.getElementById('loading').innerHTML = '<i class="bi bi-exclamation-circle"></i> 読み込みエラー';
      }
    }

    // タスクをレンダリング
    function renderTask(task) {
      const typeLabel = getTypeLabel(task.type);
      const typeBadgeClass = task.type || 'default';
      const createdAt = task.createdAt ? formatDate(task.createdAt.toDate()) : '';
      const checkedClass = task.completed ? 'checked' : '';
      const completedClass = task.completed ? 'completed' : '';

      return `
        <div class="task-item ${completedClass}" data-task-id="${task.id}" onclick="handleTaskClick('${task.id}', '${task.link || ''}')">
          <div class="task-header">
            <div class="task-checkbox ${checkedClass}" onclick="event.stopPropagation(); toggleTask('${task.id}', ${!task.completed})">
              ${task.completed ? '<i class="bi bi-check"></i>' : ''}
            </div>
            <div class="task-content">
              <div class="task-title">${escapeHtml(task.title)}</div>
              <div class="task-description">${escapeHtml(task.description)}</div>
              <div class="task-meta">
                <span class="type-badge ${typeBadgeClass}">${typeLabel}</span>
                <span>${createdAt}</span>
              </div>
              ${task.link && !task.completed ? `<div class="task-action"><i class="bi bi-arrow-right-circle"></i> 対応する</div>` : ''}
            </div>
          </div>
        </div>
      `;
    }

    // タスクタイプのラベルを取得
    function getTypeLabel(type) {
      const labels = {
        'pending_user_approval': 'ユーザー承認',
        'inventory_alert': '在庫アラート'
      };
      return labels[type] || 'タスク';
    }

    // 日付をフォーマット
    function formatDate(date) {
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return 'たった今';
      if (minutes < 60) return `${minutes}分前`;
      if (hours < 24) return `${hours}時間前`;
      if (days < 7) return `${days}日前`;

      return `${date.getMonth() + 1}/${date.getDate()}`;
    }

    // HTMLエスケープ
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // タスクの完了/未完了を切り替え
    async function toggleTask(taskId, completed) {
      try {
        await db.collection('userTasks').doc(userEmail).collection('tasks').doc(taskId).update({
          completed: completed,
          completedAt: completed ? firebase.firestore.FieldValue.serverTimestamp() : null
        });
        loadTasks(); // 再読み込み
      } catch (error) {
        console.error('タスク更新エラー:', error);
        alert('タスクの更新に失敗しました');
      }
    }

    // タスククリック時の処理
    function handleTaskClick(taskId, link) {
      if (!link) return;

      // 親ウィンドウにページ遷移を通知
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({
          type: 'navigateToPage',
          page: link,
          pmToken: pmToken
        }, parentOrigin);
      }
    }

    // 戻るボタン
    function goBack() {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({
          type: 'navigateToPage',
          page: 'home',
          pmToken: pmToken
        }, parentOrigin);
      } else {
        history.back();
      }
    }

    // 初期化
    loadTasks();
  </script>
</body>
</html>
