<!DOCTYPE html>
<html>
<head>
  <!-- Cache Bust: 2025-11-30 - ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆæ©Ÿèƒ½è¿½åŠ  -->
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¿ã‚¹ã‚¯</title>
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- REBORN Brand Colors & Theme -->
  <link rel="stylesheet" href="/css/reborn-brand-colors.css?v=0bd1a9b">
  <link rel="stylesheet" href="/css/reborn-theme.css?v=0bd1a9b">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }
    /* ãƒ˜ãƒ«ãƒ—é¢¨ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .page-header {
      background: linear-gradient(135deg, var(--reborn-primary, #40B4E5) 0%, var(--reborn-primary-dark, #1E8FBF) 100%);
      padding: 16px 20px;
      color: white;
      text-align: center;
      position: relative;
    }
    .page-header h1 {
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .page-header h1 i {
      font-size: 20px;
    }
    .back-button {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      left: 16px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: white;
      font-size: 20px;
    }
    .back-button:active {
      background: rgba(255, 255, 255, 0.3);
    }
    .menu-button {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      right: 16px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: white;
      font-size: 20px;
    }
    .menu-button:active {
      background: rgba(255, 255, 255, 0.3);
    }
    .tasks-container {
      padding: 16px;
      max-width: 600px;
      margin: 0 auto;
    }
    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 12px;
      padding-left: 4px;
    }
    .task-item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: all 0.2s ease;
      border-left: 4px solid var(--reborn-primary);
    }
    .task-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    .task-item.completed {
      opacity: 0.6;
      border-left-color: #9ca3af;
    }
    .task-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .task-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: #fef3c7;
      color: #92400e;
      font-size: 12px;
    }
    .history-link {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 20px;
      margin-top: 16px;
      background: #f3f4f6;
      border-radius: 12px;
      color: #6b7280;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .history-link:hover {
      background: #e5e7eb;
    }
    .history-link .history-count {
      background: var(--reborn-primary);
      color: white;
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .task-content {
      flex: 1;
    }
    .task-title {
      font-size: 15px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }
    .task-description {
      font-size: 13px;
      color: #6b7280;
      line-height: 1.4;
    }
    .task-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      font-size: 12px;
      color: #9ca3af;
    }
    .task-action {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 20px;
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      color: white;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      margin-top: 12px;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .task-action:active {
      transform: scale(0.97);
      opacity: 0.9;
    }
    .status-card {
      background: white;
      border-radius: 16px;
      padding: 32px 20px;
      margin-top: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .empty-state {
      text-align: center;
      color: #6b7280;
    }
    .empty-state i {
      font-size: 48px;
      margin-bottom: 12px;
      display: block;
      color: #d1d5db;
    }
    .empty-state p {
      font-size: 15px;
      color: #9ca3af;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    .type-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    .type-badge.pending_user_approval {
      background: #fef3c7;
      color: #92400e;
    }
    .type-badge.inventory_alert {
      background: #fee2e2;
      color: #991b1b;
    }
    .type-badge.default {
      background: #e0e7ff;
      color: #3730a3;
    }
  </style>
</head>
<body>
  <!-- ãƒ˜ãƒ«ãƒ—é¢¨ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="page-header">
    <button class="back-button" onclick="goBack()" title="æˆ»ã‚‹">
      <i class="bi bi-chevron-left"></i>
    </button>
    <h1><i class="bi bi-check2-square"></i> ã‚¿ã‚¹ã‚¯</h1>
    <button class="menu-button" onclick="window.parent.postMessage({type:'toggleDrawer'}, '*')" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
      <i class="bi bi-list"></i>
    </button>
  </div>

  <div class="tasks-container">
    <div id="loading" class="loading">
      <i class="bi bi-arrow-repeat"></i> èª­ã¿è¾¼ã¿ä¸­...
    </div>

    <div id="pending-tasks" style="display: none;">
      <div class="section-title">æœªå®Œäº†ã®ã‚¿ã‚¹ã‚¯</div>
      <div id="pending-tasks-list"></div>
    </div>

    <!-- ç©ºã®çŠ¶æ…‹ + å±¥æ­´ãƒªãƒ³ã‚¯ï¼ˆç™½ã„ã‚«ãƒ¼ãƒ‰å†…ï¼‰ -->
    <div id="status-card" class="status-card" style="display: none;">
      <div id="empty-state" class="empty-state" style="display: none;">
        <i class="bi bi-check-circle"></i>
        <p>ã‚„ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“</p>
      </div>

      <!-- å®Œäº†å±¥æ­´ã¸ã®ãƒªãƒ³ã‚¯ -->
      <div id="history-link-container" style="display: none;">
        <div class="history-link" onclick="goToHistory()">
          <i class="bi bi-clock-history"></i>
          <span>å®Œäº†ã—ãŸå±¥æ­´ã‚’è¦‹ã‚‹</span>
          <span id="completed-count" class="history-count"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    // URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
    const urlParams = new URLSearchParams(window.location.search);
    const userEmail = urlParams.get('userEmail') || '';
    const parentOrigin = urlParams.get('parentOrigin') || window.location.origin;
    const pmToken = urlParams.get('pmToken') || '';

    // Firebase åˆæœŸåŒ–
    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "furira.jp",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadTasks() {
      if (!userEmail) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('empty-state').style.display = 'block';
        return;
      }

      try {
        const tasksRef = db.collection('userTasks').doc(userEmail).collection('tasks');
        const snapshot = await tasksRef.orderBy('createdAt', 'desc').get();

        const pendingTasks = [];
        const completedTasks = [];

        snapshot.forEach(doc => {
          const task = { id: doc.id, ...doc.data() };
          if (task.completed) {
            completedTasks.push(task);
          } else {
            pendingTasks.push(task);
          }
        });

        document.getElementById('loading').style.display = 'none';

        // 30æ—¥çµŒéã—ãŸå®Œäº†ã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•å‰Šé™¤
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        for (const task of completedTasks) {
          if (task.completedAt) {
            const completedDate = task.completedAt.toDate ? task.completedAt.toDate() : new Date(task.completedAt);
            if (completedDate < thirtyDaysAgo) {
              await db.collection('userTasks').doc(userEmail).collection('tasks').doc(task.id).delete();
              console.log('30æ—¥çµŒéã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤:', task.id);
            }
          }
        }

        // æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º
        if (pendingTasks.length > 0) {
          document.getElementById('pending-tasks').style.display = 'block';
          document.getElementById('pending-tasks-list').innerHTML = pendingTasks.map(task => renderTask(task)).join('');
        }

        // å®Œäº†ã‚¿ã‚¹ã‚¯ãŒã‚ã‚‹å ´åˆã¯å±¥æ­´ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤º
        // 30æ—¥ä»¥å†…ã®ã‚¿ã‚¹ã‚¯ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆ
        const recentCompletedTasks = completedTasks.filter(task => {
          if (!task.completedAt) return true;
          const completedDate = task.completedAt.toDate ? task.completedAt.toDate() : new Date(task.completedAt);
          return completedDate >= thirtyDaysAgo;
        });

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºåˆ¶å¾¡
        const showEmptyState = pendingTasks.length === 0;
        const showHistoryLink = recentCompletedTasks.length > 0;

        if (showEmptyState || showHistoryLink) {
          document.getElementById('status-card').style.display = 'block';

          if (showEmptyState) {
            document.getElementById('empty-state').style.display = 'block';
          }

          if (showHistoryLink) {
            document.getElementById('history-link-container').style.display = 'block';
            document.getElementById('completed-count').textContent = `${recentCompletedTasks.length}ä»¶`;
          }
        }

      } catch (error) {
        console.error('ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('loading').innerHTML = '<i class="bi bi-exclamation-circle"></i> èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼';
      }
    }

    // ã‚¿ã‚¹ã‚¯ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆæœªå®Œäº†ã‚¿ã‚¹ã‚¯ç”¨ï¼‰
    function renderTask(task) {
      const typeLabel = getTypeLabel(task.type);
      const typeBadgeClass = task.type || 'default';
      const createdAt = task.createdAt ? formatDate(task.createdAt.toDate()) : '';

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªã‚¿ã‚¹ã‚¯ã§å†™çœŸãŒã‚ã‚‹å ´åˆã¯ç”»åƒã‚’è¡¨ç¤ºã€ãªã‘ã‚Œã°ã‚¢ã‚¤ã‚³ãƒ³
      let iconHtml;
      if (task.type === 'pending_user_approval' && task.relatedData?.pendingUserPhoto) {
        iconHtml = `<img src="${escapeHtml(task.relatedData.pendingUserPhoto)}" alt="ãƒ¦ãƒ¼ã‚¶ãƒ¼" style="width:28px;height:28px;border-radius:50%;object-fit:cover;">`;
      } else {
        iconHtml = getTypeIcon(task.type);
      }

      // å®Œäº†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—ï¼ˆå ±é…¬å¯¾è±¡ã‚¿ã‚¹ã‚¯ï¼‰
      const completableTaskTypes = ['listing_approval', 'shipping_task'];
      const showCompleteButton = completableTaskTypes.includes(task.type);

      // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
      let actionButtons = '';
      if (task.link) {
        actionButtons += `<div class="task-action" onclick="handleTaskClick('${task.id}', '${task.link}')"><i class="bi bi-arrow-right-circle"></i> å¯¾å¿œã™ã‚‹</div>`;
      }
      if (showCompleteButton) {
        actionButtons += `<div class="task-action complete-btn" onclick="completeTask('${task.id}')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); margin-left: 8px;"><i class="bi bi-check-circle"></i> å®Œäº†</div>`;
      }

      return `
        <div class="task-item" data-task-id="${task.id}">
          <div class="task-header">
            <div class="task-icon">${iconHtml}</div>
            <div class="task-content">
              <div class="task-title">${escapeHtml(task.title)}</div>
              <div class="task-description">${escapeHtml(task.description)}</div>
              <div class="task-meta">
                <span class="type-badge ${typeBadgeClass}">${typeLabel}</span>
                <span>${createdAt}</span>
              </div>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                ${actionButtons}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    /**
     * ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã«ã™ã‚‹ï¼ˆå ±é…¬ãƒˆãƒªã‚¬ãƒ¼ç™ºå‹•ï¼‰
     */
    async function completeTask(taskId) {
      if (!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã«ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå ±é…¬ãŒè‡ªå‹•è¨˜éŒ²ã•ã‚Œã¾ã™ï¼‰')) return;

      try {
        const taskRef = db.collection('userTasks').doc(userEmail).collection('tasks').doc(taskId);
        await taskRef.update({
          completed: true,
          completedAt: new Date().toISOString()
        });

        console.log('âœ… [Task] ã‚¿ã‚¹ã‚¯å®Œäº†:', taskId);
        alert('ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã—ã¾ã—ãŸ');
        loadTasks(); // å†èª­ã¿è¾¼ã¿
      } catch (error) {
        console.error('âŒ [Task] ã‚¿ã‚¹ã‚¯å®Œäº†ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚¿ã‚¹ã‚¯ã®å®Œäº†ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—
    function getTypeIcon(type) {
      const icons = {
        'pending_user_approval': 'ğŸ‘¤',
        'inventory_alert': 'ğŸ“¦',
        'listing_approval': 'ğŸ“¤',
        'shipping_task': 'ğŸ“¦'
      };
      return icons[type] || 'ğŸ“‹';
    }

    // ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—ã®ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
    function getTypeLabel(type) {
      const labels = {
        'pending_user_approval': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èª',
        'inventory_alert': 'åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆ',
        'listing_approval': 'å‡ºå“ç¢ºèª',
        'shipping_task': 'æ¢±åŒ…ãƒ»ç™ºé€'
      };
      return labels[type] || 'ã‚¿ã‚¹ã‚¯';
    }

    // æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatDate(date) {
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return 'ãŸã£ãŸä»Š';
      if (minutes < 60) return `${minutes}åˆ†å‰`;
      if (hours < 24) return `${hours}æ™‚é–“å‰`;
      if (days < 7) return `${days}æ—¥å‰`;

      return `${date.getMonth() + 1}/${date.getDate()}`;
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // å±¥æ­´ãƒšãƒ¼ã‚¸ã¸é·ç§»
    function goToHistory() {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({
          type: 'navigateToPage',
          page: 'todo-history',
          pmToken: pmToken
        }, parentOrigin);
      } else {
        window.location.href = `todo_history.html?userEmail=${encodeURIComponent(userEmail)}&parentOrigin=${encodeURIComponent(parentOrigin)}&pmToken=${encodeURIComponent(pmToken)}`;
      }
    }

    // ã‚¿ã‚¹ã‚¯ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
    function handleTaskClick(taskId, link) {
      if (!link) return;

      // è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ãƒšãƒ¼ã‚¸é·ç§»ã‚’é€šçŸ¥
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({
          type: 'navigateToPage',
          page: link,
          pmToken: pmToken
        }, parentOrigin);
      }
    }

    // æˆ»ã‚‹ãƒœã‚¿ãƒ³
    // æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆäºŒé‡ç™ºç«é˜²æ­¢ä»˜ãï¼‰
    let isNavigatingBack = false;
    function goBack() {
      // äºŒé‡ç™ºç«é˜²æ­¢
      if (isNavigatingBack) {
        console.log('[todo_list] âš ï¸ äºŒé‡ç™ºç«ã‚’é˜²æ­¢ã—ã¾ã—ãŸ');
        return;
      }
      isNavigatingBack = true;

      if (window.parent && window.parent !== window) {
        // è¦ªã«ã€Œæˆ»ã‚ŠãŸã„ã€ã¨ã„ã†è¦æ±‚ã‚’é€ã‚‹ï¼ˆãƒãƒ£ãƒƒãƒˆã¨åŒã˜goBackã‚¿ã‚¤ãƒ—ã‚’ä½¿ç”¨ï¼‰
        window.parent.postMessage({
          type: 'goBack',
          pmToken: pmToken
        }, parentOrigin);
        console.log('[todo_list] goBack sent to parent (v284)');
      } else {
        history.back();
      }

      // 500mså¾Œã«ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒšãƒ¼ã‚¸é·ç§»ãŒå®Œäº†ã—ãªã‹ã£ãŸå ´åˆã®ãŸã‚ï¼‰
      setTimeout(() => { isNavigatingBack = false; }, 500);
    }

    // åˆæœŸåŒ–
    loadTasks();
  </script>
</body>
</html>
