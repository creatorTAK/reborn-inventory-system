<!DOCTYPE html>
<html>
<head>
  <!-- Cache Bust: 2025-11-30 - ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆæ©Ÿèƒ½è¿½åŠ  -->
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¿ã‚¹ã‚¯</title>
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- REBORN Brand Colors & Theme -->
  <link rel="stylesheet" href="/css/reborn-brand-colors.css?v=0bd1a9b">
  <link rel="stylesheet" href="/css/reborn-theme.css?v=0bd1a9b">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }
    /* ãƒŸãƒ‹ãƒãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒã‚¤ãƒšãƒ¼ã‚¸ã¨åŒã˜ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ */
    .minimal-header {
      background: #ffffff;
      height: 56px;
      padding: 0 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 1px solid #f0f0f0;
    }
    .minimal-header-logo {
      width: 100px;
      height: auto;
      cursor: pointer;
    }
    .minimal-header-icons {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .minimal-header-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 22px;
      transition: background 0.2s;
      position: relative;
    }
    .minimal-header-icon:hover {
      background: #f2f2f2;
    }
    .minimal-header-icon:active {
      background: #e5e5e5;
    }
    /* è¨­å®šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ */
    .settings-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 200px;
      padding: 8px 0;
      display: none;
      z-index: 1001;
    }
    .settings-dropdown.active {
      display: block;
    }
    .settings-dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border: none;
      background: none;
      width: 100%;
      font-size: 14px;
      color: #374151;
      cursor: pointer;
      text-align: left;
    }
    .settings-dropdown-item:hover {
      background: #f3f4f6;
    }
    .settings-dropdown-item i {
      font-size: 18px;
      color: #6b7280;
      width: 20px;
      text-align: center;
    }
    .announce-dot {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      display: none;
    }
    .announce-dot.visible {
      display: block;
    }
    /* æ¤œç´¢ãƒãƒ¼ */
    .search-bar {
      display: flex;
      align-items: center;
      background: #e5e7eb;
      border-radius: 12px;
      padding: 12px 14px;
      gap: 10px;
      margin: 12px 16px;
    }
    .search-bar i {
      color: #9ca3af;
      font-size: 16px;
    }
    .search-bar input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 16px;
      color: #1f2937;
      outline: none;
    }
    .search-bar input::placeholder {
      color: #9ca3af;
    }
    .search-bar .clear-btn {
      display: none;
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      padding: 0;
      font-size: 16px;
    }
    .search-bar .clear-btn.show {
      display: block;
    }
    .settings-dropdown-divider {
      height: 1px;
      background: #e5e7eb;
      margin: 4px 0;
    }
    .settings-dropdown-item.admin-only {
      border-top: 1px solid #e5e7eb;
      color: #6366f1;
    }
    .settings-dropdown-item.admin-only i {
      color: #6366f1;
    }
    /* ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .task-admin-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
      overflow-y: auto;
    }
    .task-admin-modal.active {
      display: flex;
    }
    .task-admin-content {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }
    .task-admin-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
      position: sticky;
      top: 0;
      background: white;
      z-index: 1;
    }
    .task-admin-header h2 {
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
      margin: 0;
    }
    .task-admin-close {
      background: none;
      border: none;
      font-size: 24px;
      color: #6b7280;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    .task-admin-body {
      padding: 16px 20px;
    }
    .task-summary-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    .task-summary-card {
      background: #f9fafb;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    .task-summary-card .number {
      font-size: 24px;
      font-weight: 700;
    }
    .task-summary-card .label {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }
    .user-task-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      border-bottom: 1px solid #f3f4f6;
    }
    .user-task-item:last-child {
      border-bottom: none;
    }
    .user-task-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .user-task-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 500;
    }
    .user-task-name {
      font-size: 14px;
      font-weight: 500;
      color: #1f2937;
    }
    .user-task-email {
      font-size: 11px;
      color: #6b7280;
    }
    .user-task-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .user-task-badge {
      font-size: 12px;
      font-weight: 500;
      padding: 4px 8px;
      border-radius: 6px;
    }
    .user-task-badge.overdue {
      background: #fee2e2;
      color: #ef4444;
    }
    .user-task-badge.pending {
      background: #fef3c7;
      color: #f59e0b;
    }
    .user-task-badge.complete {
      background: #d1fae5;
      color: #10b981;
    }
    .remind-btn {
      padding: 6px 12px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
    }
    .remind-btn:active {
      opacity: 0.8;
    }
    .bulk-remind-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 16px;
    }
    .tasks-container {
      padding: 16px;
      max-width: 600px;
      margin: 0 auto;
    }
    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 12px;
      padding-left: 4px;
    }
    .task-item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: all 0.2s ease;
      border-left: 4px solid var(--reborn-primary);
    }
    .task-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    .task-item.completed {
      opacity: 0.6;
      border-left-color: #9ca3af;
    }
    .task-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .task-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: #fef3c7;
      color: #92400e;
      font-size: 12px;
    }
    .history-link {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 20px;
      margin-top: 16px;
      background: #f3f4f6;
      border-radius: 12px;
      color: #6b7280;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .history-link:hover {
      background: #e5e7eb;
    }
    .history-link .history-count {
      background: var(--reborn-primary);
      color: white;
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .task-content {
      flex: 1;
    }
    .task-title {
      font-size: 15px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }
    .task-description {
      font-size: 13px;
      color: #6b7280;
      line-height: 1.4;
    }
    .task-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      font-size: 12px;
      color: #9ca3af;
    }
    .task-action {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 20px;
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      color: white;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      margin-top: 12px;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .task-action:active {
      transform: scale(0.97);
      opacity: 0.9;
    }
    .status-card {
      background: white;
      border-radius: 16px;
      padding: 32px 20px;
      margin-top: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .empty-state {
      text-align: center;
      color: #6b7280;
    }
    .empty-state i {
      font-size: 48px;
      margin-bottom: 12px;
      display: block;
      color: #d1d5db;
    }
    .empty-state p {
      font-size: 15px;
      color: #9ca3af;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    .type-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    .type-badge.pending_user_approval {
      background: #fef3c7;
      color: #92400e;
    }
    .type-badge.inventory_alert {
      background: #fee2e2;
      color: #991b1b;
    }
    .type-badge.shipping_info_registration,
    .type-badge.bank_account_registration {
      background: #dbeafe;
      color: #1e40af;
    }
    .type-badge.default {
      background: #e0e7ff;
      color: #3730a3;
    }
  </style>
</head>
<body>
  <!-- ãƒŸãƒ‹ãƒãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒã‚¤ãƒšãƒ¼ã‚¸ã¨åŒã˜ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ -->
  <div class="minimal-header">
    <img src="/images/furira-square-logo.png?v=20251209" alt="Furira" class="minimal-header-logo" onclick="window.parent.postMessage({type:'navigate', page:'home'}, '*')">
    <div class="minimal-header-icons">
      <button class="minimal-header-icon" title="é€šçŸ¥" onclick="openAnnouncePage()">
        <i class="bi bi-bell"></i>
        <span class="announce-dot" id="announceDot"></span>
      </button>
      <div style="position: relative;">
        <button class="minimal-header-icon" title="è¨­å®š" onclick="toggleSettingsDropdown(event)">
          <i class="bi bi-gear"></i>
        </button>
        <div class="settings-dropdown" id="settingsDropdown">
          <button class="settings-dropdown-item" onclick="goToHistory()">
            <i class="bi bi-clock-history"></i>
            <span>å®Œäº†ã—ãŸå±¥æ­´</span>
          </button>
          <button class="settings-dropdown-item admin-only" id="adminTaskManagement" onclick="openTaskManagement()" style="display: none;">
            <i class="bi bi-people"></i>
            <span>ã‚¿ã‚¹ã‚¯ç®¡ç†</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ¤œç´¢ãƒãƒ¼ -->
  <div class="search-bar">
    <i class="bi bi-search"></i>
    <input type="text" id="searchInput" placeholder="ã‚¿ã‚¹ã‚¯ã‚’æ¤œç´¢" oninput="performSearch()" />
    <button class="clear-btn" id="searchClearBtn" onclick="clearSearch()">
      <i class="bi bi-x-circle-fill"></i>
    </button>
  </div>

  <!-- ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰ -->
  <div class="task-admin-modal" id="taskAdminModal" onclick="closeTaskManagement(event)">
    <div class="task-admin-content" onclick="event.stopPropagation()">
      <div class="task-admin-header">
        <h2>ğŸ“‹ ã‚¿ã‚¹ã‚¯ç®¡ç†</h2>
        <button class="task-admin-close" onclick="closeTaskManagement()">&times;</button>
      </div>
      <div class="task-admin-body">
        <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
        <div class="task-summary-cards">
          <div class="task-summary-card">
            <div class="number" style="color: #3b82f6;" id="adminTaskTotal">-</div>
            <div class="label">ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
          </div>
          <div class="task-summary-card">
            <div class="number" style="color: #f59e0b;" id="adminTaskPending">-</div>
            <div class="label">æœªå®Œäº†ã‚ã‚Š</div>
          </div>
          <div class="task-summary-card">
            <div class="number" style="color: #ef4444;" id="adminTaskOverdue">-</div>
            <div class="label">3æ—¥ä»¥ä¸Šæ”¾ç½®</div>
          </div>
        </div>

        <!-- ä¸€æ‹¬ãƒªãƒã‚¤ãƒ³ãƒ‰ãƒœã‚¿ãƒ³ -->
        <button class="bulk-remind-btn" onclick="sendBulkReminder()">
          <i class="bi bi-bell"></i>
          æœªå®Œäº†ã‚¿ã‚¹ã‚¯ãŒã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¸€æ‹¬ãƒªãƒã‚¤ãƒ³ãƒ‰
        </button>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ -->
        <div style="background: #f9fafb; border-radius: 12px; overflow: hidden;">
          <div style="padding: 12px 16px; background: #e5e7eb; font-weight: 600; font-size: 14px; color: #374151;">
            ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚¿ã‚¹ã‚¯çŠ¶æ³
          </div>
          <div id="adminUserTaskList" style="max-height: 300px; overflow-y: auto;">
            <div style="padding: 20px; text-align: center; color: #9ca3af;">èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="tasks-container">
    <div id="loading" class="loading">
      <i class="bi bi-arrow-repeat"></i> èª­ã¿è¾¼ã¿ä¸­...
    </div>

    <div id="pending-tasks" style="display: none;">
      <div class="section-title">æœªå®Œäº†ã®ã‚¿ã‚¹ã‚¯</div>
      <div id="pending-tasks-list"></div>
    </div>

    <!-- ç©ºã®çŠ¶æ…‹ + å±¥æ­´ãƒªãƒ³ã‚¯ï¼ˆç™½ã„ã‚«ãƒ¼ãƒ‰å†…ï¼‰ -->
    <div id="status-card" class="status-card" style="display: none;">
      <div id="empty-state" class="empty-state" style="display: none;">
        <i class="bi bi-check-circle"></i>
        <p>ã‚„ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“</p>
      </div>

      <!-- å®Œäº†å±¥æ­´ã¸ã®ãƒªãƒ³ã‚¯ -->
      <div id="history-link-container" style="display: none;">
        <div class="history-link" onclick="goToHistory()">
          <i class="bi bi-clock-history"></i>
          <span>å®Œäº†ã—ãŸå±¥æ­´ã‚’è¦‹ã‚‹</span>
          <span id="completed-count" class="history-count"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    // URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
    const urlParams = new URLSearchParams(window.location.search);
    const userEmail = urlParams.get('userEmail') || '';
    const parentOrigin = urlParams.get('parentOrigin') || window.location.origin;
    const pmToken = urlParams.get('pmToken') || '';

    // Firebase åˆæœŸåŒ–
    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "furira.jp",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // å…¨ã‚¿ã‚¹ã‚¯ã‚’ä¿å­˜ï¼ˆæ¤œç´¢ç”¨ï¼‰
    let allPendingTasks = [];

    // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadTasks() {
      if (!userEmail) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('empty-state').style.display = 'block';
        return;
      }

      try {
        const tasksRef = db.collection('userTasks').doc(userEmail).collection('tasks');
        const snapshot = await tasksRef.orderBy('createdAt', 'desc').get();

        const pendingTasks = [];
        const completedTasks = [];

        snapshot.forEach(doc => {
          const task = { id: doc.id, ...doc.data() };
          if (task.completed) {
            completedTasks.push(task);
          } else {
            pendingTasks.push(task);
          }
        });

        document.getElementById('loading').style.display = 'none';

        // 30æ—¥çµŒéã—ãŸå®Œäº†ã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•å‰Šé™¤
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        for (const task of completedTasks) {
          if (task.completedAt) {
            const completedDate = task.completedAt.toDate ? task.completedAt.toDate() : new Date(task.completedAt);
            if (completedDate < thirtyDaysAgo) {
              await db.collection('userTasks').doc(userEmail).collection('tasks').doc(task.id).delete();
              console.log('30æ—¥çµŒéã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤:', task.id);
            }
          }
        }

        // æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚’ä¿å­˜ãƒ»è¡¨ç¤º
        allPendingTasks = pendingTasks;
        if (pendingTasks.length > 0) {
          document.getElementById('pending-tasks').style.display = 'block';
          document.getElementById('pending-tasks-list').innerHTML = pendingTasks.map(task => renderTask(task)).join('');
        }

        // å®Œäº†ã‚¿ã‚¹ã‚¯ãŒã‚ã‚‹å ´åˆã¯å±¥æ­´ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤º
        // 30æ—¥ä»¥å†…ã®ã‚¿ã‚¹ã‚¯ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆ
        const recentCompletedTasks = completedTasks.filter(task => {
          if (!task.completedAt) return true;
          const completedDate = task.completedAt.toDate ? task.completedAt.toDate() : new Date(task.completedAt);
          return completedDate >= thirtyDaysAgo;
        });

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºåˆ¶å¾¡
        const showEmptyState = pendingTasks.length === 0;
        const showHistoryLink = recentCompletedTasks.length > 0;

        if (showEmptyState || showHistoryLink) {
          document.getElementById('status-card').style.display = 'block';

          if (showEmptyState) {
            document.getElementById('empty-state').style.display = 'block';
          }

          if (showHistoryLink) {
            document.getElementById('history-link-container').style.display = 'block';
            document.getElementById('completed-count').textContent = `${recentCompletedTasks.length}ä»¶`;
          }
        }

      } catch (error) {
        console.error('ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('loading').innerHTML = '<i class="bi bi-exclamation-circle"></i> èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼';
      }
    }

    // ã‚¿ã‚¹ã‚¯ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆæœªå®Œäº†ã‚¿ã‚¹ã‚¯ç”¨ï¼‰
    function renderTask(task) {
      const typeLabel = getTypeLabel(task.type);
      const typeBadgeClass = task.type || 'default';
      const createdAt = task.createdAt ? formatDate(task.createdAt.toDate()) : '';

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªã‚¿ã‚¹ã‚¯ã§å†™çœŸãŒã‚ã‚‹å ´åˆã¯ç”»åƒã‚’è¡¨ç¤ºã€ãªã‘ã‚Œã°ã‚¢ã‚¤ã‚³ãƒ³
      let iconHtml;
      if (task.type === 'pending_user_approval' && task.relatedData?.pendingUserPhoto) {
        iconHtml = `<img src="${escapeHtml(task.relatedData.pendingUserPhoto)}" alt="ãƒ¦ãƒ¼ã‚¶ãƒ¼" style="width:28px;height:28px;border-radius:50%;object-fit:cover;">`;
      } else {
        iconHtml = getTypeIcon(task.type);
      }

      // å®Œäº†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—ï¼ˆå ±é…¬å¯¾è±¡ã‚¿ã‚¹ã‚¯ã®ã¿ï¼‰
      // åˆæœŸè¨­å®šã‚¿ã‚¹ã‚¯ï¼ˆshipping_info_registration, bank_account_registrationï¼‰ã¯è¨­å®šä¿å­˜æ™‚ã«è‡ªå‹•å®Œäº†
      const completableTaskTypes = ['listing_approval', 'shipping_task'];
      const showCompleteButton = completableTaskTypes.includes(task.type);

      // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
      let actionButtons = '';
      if (task.link) {
        actionButtons += `<div class="task-action" onclick="handleTaskClick('${task.id}', '${task.link}')"><i class="bi bi-arrow-right-circle"></i> å¯¾å¿œã™ã‚‹</div>`;
      }
      if (showCompleteButton) {
        actionButtons += `<div class="task-action complete-btn" onclick="completeTask('${task.id}', '${task.type}')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); margin-left: 8px;"><i class="bi bi-check-circle"></i> å®Œäº†</div>`;
      }

      return `
        <div class="task-item" data-task-id="${task.id}">
          <div class="task-header">
            <div class="task-icon">${iconHtml}</div>
            <div class="task-content">
              <div class="task-title">${escapeHtml(task.title)}</div>
              <div class="task-description">${escapeHtml(task.description)}</div>
              <div class="task-meta">
                <span class="type-badge ${typeBadgeClass}">${typeLabel}</span>
                <span>${createdAt}</span>
              </div>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                ${actionButtons}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    /**
     * ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã«ã™ã‚‹
     */
    async function completeTask(taskId, taskType) {
      // å ±é…¬å¯¾è±¡ã‚¿ã‚¹ã‚¯ã‹åˆ¤å®š
      const rewardTaskTypes = ['listing_approval', 'shipping_task'];
      const isRewardTask = rewardTaskTypes.includes(taskType);
      const confirmMsg = isRewardTask
        ? 'ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã«ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå ±é…¬ãŒè‡ªå‹•è¨˜éŒ²ã•ã‚Œã¾ã™ï¼‰'
        : 'ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã«ã—ã¾ã™ã‹ï¼Ÿ';

      if (!confirm(confirmMsg)) return;

      try {
        const taskRef = db.collection('userTasks').doc(userEmail).collection('tasks').doc(taskId);
        await taskRef.update({
          completed: true,
          completedAt: new Date().toISOString()
        });

        console.log('âœ… [Task] ã‚¿ã‚¹ã‚¯å®Œäº†:', taskId);
        alert('ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã—ã¾ã—ãŸ');
        loadTasks(); // å†èª­ã¿è¾¼ã¿
      } catch (error) {
        console.error('âŒ [Task] ã‚¿ã‚¹ã‚¯å®Œäº†ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚¿ã‚¹ã‚¯ã®å®Œäº†ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—
    function getTypeIcon(type) {
      const icons = {
        'pending_user_approval': 'ğŸ‘¤',
        'inventory_alert': 'ğŸ“¦',
        'listing_approval': 'ğŸ“¤',
        'shipping_task': 'ğŸ“¦',
        'shipping_info_registration': 'ğŸ“¦',
        'bank_account_registration': 'ğŸ¦'
      };
      return icons[type] || 'ğŸ“‹';
    }

    // ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—ã®ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
    function getTypeLabel(type) {
      const labels = {
        'pending_user_approval': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èª',
        'inventory_alert': 'åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆ',
        'listing_approval': 'å‡ºå“ç¢ºèª',
        'shipping_task': 'æ¢±åŒ…ãƒ»ç™ºé€',
        'shipping_info_registration': 'åˆæœŸè¨­å®š',
        'bank_account_registration': 'åˆæœŸè¨­å®š'
      };
      return labels[type] || 'ã‚¿ã‚¹ã‚¯';
    }

    // æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatDate(date) {
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return 'ãŸã£ãŸä»Š';
      if (minutes < 60) return `${minutes}åˆ†å‰`;
      if (hours < 24) return `${hours}æ™‚é–“å‰`;
      if (days < 7) return `${days}æ—¥å‰`;

      return `${date.getMonth() + 1}/${date.getDate()}`;
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // å±¥æ­´ãƒšãƒ¼ã‚¸ã¸é·ç§»
    function goToHistory() {
      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) dropdown.classList.remove('active');

      if (window.parent && window.parent !== window) {
        window.parent.postMessage({
          type: 'navigateToPage',
          page: 'todo-history',
          pmToken: pmToken
        }, parentOrigin);
      } else {
        window.location.href = `todo_history.html?userEmail=${encodeURIComponent(userEmail)}&parentOrigin=${encodeURIComponent(parentOrigin)}&pmToken=${encodeURIComponent(pmToken)}`;
      }
    }

    // è¨­å®šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åˆ¶å¾¡
    function toggleSettingsDropdown(event) {
      event.stopPropagation();
      const dropdown = document.getElementById('settingsDropdown');
      dropdown.classList.toggle('active');
    }

    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown && !event.target.closest('.settings-dropdown') && !event.target.closest('.minimal-header-icon')) {
        dropdown.classList.remove('active');
      }
    });

    // ãŠçŸ¥ã‚‰ã›ãƒšãƒ¼ã‚¸ã‚’é–‹ã
    function openAnnouncePage() {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'navigate', page: 'announce' }, '*');
      } else {
        window.location.href = '/announce.html';
      }
    }

    // æ¤œç´¢æ©Ÿèƒ½
    function performSearch() {
      const query = document.getElementById('searchInput').value.toLowerCase().trim();
      const clearBtn = document.getElementById('searchClearBtn');

      // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
      if (query) {
        clearBtn.classList.add('show');
      } else {
        clearBtn.classList.remove('show');
      }

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const filteredTasks = allPendingTasks.filter(task => {
        const title = (task.title || '').toLowerCase();
        const description = (task.description || '').toLowerCase();
        return title.includes(query) || description.includes(query);
      });

      // è¡¨ç¤ºæ›´æ–°
      const pendingTasksContainer = document.getElementById('pending-tasks');
      const pendingTasksList = document.getElementById('pending-tasks-list');

      if (filteredTasks.length > 0) {
        pendingTasksContainer.style.display = 'block';
        pendingTasksList.innerHTML = filteredTasks.map(task => renderTask(task)).join('');
      } else {
        if (query) {
          pendingTasksContainer.style.display = 'block';
          pendingTasksList.innerHTML = `
            <div style="text-align: center; padding: 32px; color: #9ca3af;">
              <i class="bi bi-search" style="font-size: 32px; display: block; margin-bottom: 8px;"></i>
              <p>ã€Œ${escapeHtml(query)}ã€ã«ä¸€è‡´ã™ã‚‹ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</p>
            </div>
          `;
        } else {
          pendingTasksContainer.style.display = allPendingTasks.length > 0 ? 'block' : 'none';
          pendingTasksList.innerHTML = allPendingTasks.map(task => renderTask(task)).join('');
        }
      }
    }

    // æ¤œç´¢ã‚¯ãƒªã‚¢
    function clearSearch() {
      document.getElementById('searchInput').value = '';
      document.getElementById('searchClearBtn').classList.remove('show');

      // å…ƒã®ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’å¾©å…ƒ
      const pendingTasksContainer = document.getElementById('pending-tasks');
      const pendingTasksList = document.getElementById('pending-tasks-list');

      if (allPendingTasks.length > 0) {
        pendingTasksContainer.style.display = 'block';
        pendingTasksList.innerHTML = allPendingTasks.map(task => renderTask(task)).join('');
      } else {
        pendingTasksContainer.style.display = 'none';
      }
    }

    // ã‚¿ã‚¹ã‚¯ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
    function handleTaskClick(taskId, link) {
      if (!link) return;

      // è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ãƒšãƒ¼ã‚¸é·ç§»ã‚’é€šçŸ¥
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({
          type: 'navigateToPage',
          page: link,
          pmToken: pmToken
        }, parentOrigin);
      }
    }

    // æˆ»ã‚‹ãƒœã‚¿ãƒ³
    // æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆäºŒé‡ç™ºç«é˜²æ­¢ä»˜ãï¼‰
    let isNavigatingBack = false;
    function goBack() {
      // äºŒé‡ç™ºç«é˜²æ­¢
      if (isNavigatingBack) {
        console.log('[todo_list] âš ï¸ äºŒé‡ç™ºç«ã‚’é˜²æ­¢ã—ã¾ã—ãŸ');
        return;
      }
      isNavigatingBack = true;

      if (window.parent && window.parent !== window) {
        // è¦ªã«ã€Œæˆ»ã‚ŠãŸã„ã€ã¨ã„ã†è¦æ±‚ã‚’é€ã‚‹ï¼ˆãƒãƒ£ãƒƒãƒˆã¨åŒã˜goBackã‚¿ã‚¤ãƒ—ã‚’ä½¿ç”¨ï¼‰
        window.parent.postMessage({
          type: 'goBack',
          pmToken: pmToken
        }, parentOrigin);
        console.log('[todo_list] goBack sent to parent (v284)');
      } else {
        history.back();
      }

      // 500mså¾Œã«ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒšãƒ¼ã‚¸é·ç§»ãŒå®Œäº†ã—ãªã‹ã£ãŸå ´åˆã®ãŸã‚ï¼‰
      setTimeout(() => { isNavigatingBack = false; }, 500);
    }

    // ========================================
    // ç®¡ç†è€…ã‚¿ã‚¹ã‚¯ç®¡ç†æ©Ÿèƒ½
    // ========================================

    // ç®¡ç†è€…ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºã‚’åˆ¶å¾¡
    async function checkAdminStatus() {
      if (!currentUserEmail) return;

      try {
        const userDoc = await db.collection('users').doc(currentUserEmail).get();
        if (userDoc.exists) {
          const userData = userDoc.data();
          if (userData.permissionId === 'owner') {
            const adminMenu = document.getElementById('adminTaskManagement');
            if (adminMenu) {
              adminMenu.style.display = 'flex';
            }
          }
        }
      } catch (error) {
        console.error('ç®¡ç†è€…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    async function openTaskManagement() {
      toggleSettingsDropdown(); // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹

      const modal = document.getElementById('taskAdminModal');
      if (modal) {
        modal.classList.add('active');
        await loadAdminTaskData();
      }
    }

    // ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeTaskManagement(event) {
      if (event && event.target !== event.currentTarget) return;

      const modal = document.getElementById('taskAdminModal');
      if (modal) {
        modal.classList.remove('active');
      }
    }

    // ç®¡ç†è€…ç”¨ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
    async function loadAdminTaskData() {
      const userListEl = document.getElementById('adminUserTaskList');
      const totalUsersEl = document.getElementById('adminTaskTotal');
      const pendingTasksEl = document.getElementById('adminTaskPending');
      const overdueEl = document.getElementById('adminTaskOverdue');

      if (!userListEl) return;

      userListEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #9ca3af;"><i class="bi bi-arrow-repeat spin"></i> èª­ã¿è¾¼ã¿ä¸­...</div>';

      try {
        // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
        const usersSnapshot = await db.collection('users').get();
        const usersData = [];
        let usersWithPending = 0;
        let overdueCount = 0;
        const threeDaysAgo = new Date();
        threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);

        // å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ã‚¹ã‚¯ã‚’å–å¾—
        for (const userDoc of usersSnapshot.docs) {
          const userData = userDoc.data();
          const userEmail = userDoc.id;

          // ã‚¿ã‚¹ã‚¯ã‚’å–å¾—
          const tasksSnapshot = await db.collection('users').doc(userEmail)
            .collection('tasks')
            .orderBy('createdAt', 'desc')
            .get();

          let pending = 0;
          let completed = 0;
          let overdue = 0;

          tasksSnapshot.docs.forEach(doc => {
            const task = doc.data();
            if (task.completed) {
              completed++;
            } else {
              pending++;
              // 3æ—¥ä»¥ä¸Šå‰ã«ä½œæˆã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã‹ãƒã‚§ãƒƒã‚¯
              if (task.createdAt) {
                const createdDate = task.createdAt.toDate ? task.createdAt.toDate() : new Date(task.createdAt);
                if (createdDate < threeDaysAgo) {
                  overdue++;
                }
              }
            }
          });

          if (pending > 0) usersWithPending++;
          overdueCount += overdue;

          usersData.push({
            email: userEmail,
            name: userData.displayName || userData.name || userEmail.split('@')[0],
            pending: pending,
            completed: completed,
            overdue: overdue,
            total: pending + completed
          });
        }

        // ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
        if (totalUsersEl) totalUsersEl.textContent = usersData.length;
        if (pendingTasksEl) pendingTasksEl.textContent = usersWithPending;
        if (overdueEl) overdueEl.textContent = overdueCount;

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆæœªå®Œäº†ã‚¿ã‚¹ã‚¯ãŒã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å„ªå…ˆï¼‰
        usersData.sort((a, b) => b.pending - a.pending);

        if (usersData.length === 0) {
          userListEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #9ca3af;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</div>';
          return;
        }

        userListEl.innerHTML = usersData.map(user => `
          <div class="admin-user-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: ${user.overdue > 0 ? '#fef2f2' : '#f9fafb'}; border-radius: 8px; margin-bottom: 8px; ${user.overdue > 0 ? 'border-left: 3px solid #ef4444;' : ''}">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="width: 40px; height: 40px; background: ${user.pending > 0 ? '#fef2f2' : '#f0fdf4'}; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-person" style="color: ${user.pending > 0 ? '#ef4444' : '#22c55e'};"></i>
              </div>
              <div>
                <div style="font-weight: 500;">${escapeHtml(user.name)}</div>
                <div style="font-size: 12px; color: #9ca3af;">${escapeHtml(user.email)}</div>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="text-align: right;">
                <div style="font-size: 12px; color: #6b7280;">æœªå®Œäº†: <span style="color: ${user.pending > 0 ? '#ef4444' : '#22c55e'}; font-weight: 600;">${user.pending}</span></div>
                ${user.overdue > 0 ? `<div style="font-size: 11px; color: #ef4444;">âš ï¸ ${user.overdue}ä»¶ãŒ3æ—¥ä»¥ä¸Š</div>` : `<div style="font-size: 12px; color: #6b7280;">å®Œäº†: <span style="color: #22c55e;">${user.completed}</span></div>`}
              </div>
              ${user.pending > 0 ? `
                <button onclick="sendReminder('${escapeHtml(user.email)}', '${escapeHtml(user.name)}')"
                        style="padding: 6px 12px; background: #6366f1; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">
                  <i class="bi bi-bell"></i> é€šçŸ¥
                </button>
              ` : ''}
            </div>
          </div>
        `).join('');

      } catch (error) {
        console.error('ç®¡ç†è€…ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        userListEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      }
    }

    // å€‹åˆ¥ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’é€ä¿¡
    async function sendReminder(userEmail, userName) {
      if (!confirm(`${userName}ã•ã‚“ã«ã‚¿ã‚¹ã‚¯æœªå®Œäº†ã®é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`)) return;

      try {
        const now = firebase.firestore.Timestamp.now();
        await db.collection('users').doc(userEmail).collection('userAnnouncements').add({
          title: 'ã‚¿ã‚¹ã‚¯æœªå®Œäº†ã®ãŠçŸ¥ã‚‰ã›',
          content: 'æœªå®Œäº†ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚',
          createdAt: now,
          read: false,
          type: 'reminder'
        });

        alert(`${userName}ã•ã‚“ã«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ`);
      } catch (error) {
        console.error('ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        alert('é€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ä¸€æ‹¬ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’é€ä¿¡
    async function sendBulkReminder() {
      if (!confirm('æœªå®Œäº†ã‚¿ã‚¹ã‚¯ãŒã‚ã‚‹å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ')) return;

      const userListEl = document.getElementById('adminUserList');
      const userItems = userListEl ? userListEl.querySelectorAll('.admin-user-item') : [];

      try {
        const usersSnapshot = await db.collection('users').get();
        const now = firebase.firestore.Timestamp.now();
        let sentCount = 0;

        for (const userDoc of usersSnapshot.docs) {
          const userEmail = userDoc.id;

          // æœªå®Œäº†ã‚¿ã‚¹ã‚¯ãŒã‚ã‚‹ã‹ç¢ºèª
          const pendingTasksSnapshot = await db.collection('users').doc(userEmail)
            .collection('tasks')
            .where('completed', '==', false)
            .limit(1)
            .get();

          if (!pendingTasksSnapshot.empty) {
            await db.collection('users').doc(userEmail).collection('userAnnouncements').add({
              title: 'ã‚¿ã‚¹ã‚¯æœªå®Œäº†ã®ãŠçŸ¥ã‚‰ã›',
              content: 'æœªå®Œäº†ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚',
              createdAt: now,
              read: false,
              type: 'reminder'
            });
            sentCount++;
          }
        }

        alert(`${sentCount}äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ`);
      } catch (error) {
        console.error('ä¸€æ‹¬ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        alert('ä¸€æ‹¬é€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // åˆæœŸåŒ–
    loadTasks();
    checkAdminStatus(); // ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯
  </script>
</body>
</html>
