# Issues（未完了）

このファイルは、REBORN Inventoryプロジェクトの**未完了Issue**を管理します。

**運用ルール：**
- 新しいIssueは該当カテゴリの最上部に追加
- 完了したIssue（✅ DONE）は `issues-closed.md` に移動
- 定期的にレビュー（週1回推奨）

**関連ドキュメント：**
- [TDD_POLICY.md](./TDD_POLICY.md) - Issue管理ルール詳細
- [issues-closed.md](./issues-closed.md) - 完了Issueアーカイブ

---

## 🎨 UI改善（UI Improvements）

## UI-014 | UI改善: 設定管理＆マスタ管理リストラクチャ（タブナビゲーション方式）

### 📌 基本情報
- [ ] カテゴリ: UI改善 / 機能追加
- [ ] 優先度: 高
- [ ] 影響範囲: PWA - 設定管理画面全体、マスタ管理画面全体
- [ ] 開始日: 2025-11-15
- [ ] 関連Issue: MASTER-002（汎用マスタ管理エンジン実装の一環）

### 💡 要望内容

設定管理とマスタ管理の構造を、スマホUI優先でタブナビゲーション方式に全面刷新。

**背景:**
- スプレッドシート依存が減り、PWAでの操作が主流に
- 現在のアコーディオン方式は階層が深く、スマホでの操作性が悪い
- 商品登録設定にはすでにタブがあり、AI生成設定が独立して使いにくい

### ✅ 期待動作

**設定管理の新構造:**
```
設定管理（アコーディオン2項目）
├─ 📝 商品登録設定（5タブ）
│   └─ 💬 セールスワード | 🔘 商品状態 | 🏷️ ハッシュタグ | 💰 割引 | ✨ AI生成
└─ ⚙️ システム設定（4タブ）
    └─ 👤 基本設定 | 🔢 管理番号 | 📦 配送 | 💼 仕入・出品
```

**マスタ管理の新構造:**
```
マスタ管理（アコーディオン2項目）
├─ 📦 商品関連マスタ管理（6タブ）
│   └─ ブランド | カテゴリ | 素材 | 生地 | キーワード | セールスワード
└─ 🏢 業務関連マスタ管理（5タブ）
    └─ 発送方法 | 梱包資材 | 担当者 | 仕入先 | 出品先
```

**タブナビゲーション操作（3種類）:**
1. タブボタンをタップして切り替え
2. タブバー自体をスライド（多数タブ時）
3. コンテンツエリアをスワイプして切り替え

### 📍 関連ファイル

**PWA:**
- `docs/index.html` - navigateToPage() 関数更新
- `docs/master-management.html` - マスタ管理タブ化

**GAS:**
- `sidebar_config.html` - 設定管理タブ化
- `menu_home.html` - アコーディオン項目削減

### ✏️ 実装内容

#### Phase 1: 設定管理リストラクチャ（進行中）
- [x] AI生成設定を商品登録設定内に統合
- [x] 商品登録設定タブ: 4→5タブ対応
- [x] システム設定tab-pane骨組み作成
- [ ] 基本設定内容をシステム設定タブに移動
- [ ] 管理番号設定内容をシステム設定タブに移動
- [ ] 配送設定内容をシステム設定タブに移動
- [ ] 仕入・出品設定内容をシステム設定タブに移動
- [ ] 元の独立tab-pane削除
- [ ] menu_home.html: アコーディオン6項目→2項目に変更
- [ ] docs/index.html: navigateToPage()更新（config-product, config-system）

#### Phase 2: タブスワイプジェスチャー実装
- [ ] touchstart/touchmove/touchend イベントリスナー追加
- [ ] スワイプ検知ロジック実装
- [ ] タブ切り替えアニメーション実装
- [ ] タブインジケーター追従実装

#### Phase 3: 商品関連マスタ管理リストラクチャ
- [ ] master-management.html: ドロップダウン→タブナビゲーション変更
- [ ] 6タブ実装（ブランド/カテゴリ/素材/生地/キーワード/セールスワード）
- [ ] スワイプジェスチャー対応

#### Phase 4: 業務関連マスタ管理リストラクチャ
- [ ] 新規 business-master-management.html 作成
- [ ] 発送方法マスタUIを統合（shipping_method_master_ui.html）
- [ ] 梱包資材マスタUIを統合（packaging_materials_ui.html）
- [ ] 5タブ実装（発送方法/梱包資材/担当者/仕入先/出品先）
- [ ] スワイプジェスチャー対応

#### Phase 5: メニュー構造変更
- [ ] menu_home.html: マスタ管理アコーディオン4項目→2項目
- [ ] docs/index.html: navigateToPage()更新（master-product, master-business）

### 🧪 テストケース

#### TC-UI-014-001: 商品登録設定タブ切り替え
**前提条件:**
- 設定管理 > 商品登録設定を開く

**実行操作:**
1. 各タブをタップ（セールスワード/商品状態/ハッシュタグ/割引/AI生成）
2. タブバーを左右にスライド
3. コンテンツを左右にスワイプ

**期待結果:**
- 各タブが正しく表示される
- タブバーがスムーズにスライドする
- スワイプで前後のタブに切り替わる
- アニメーションが滑らか

#### TC-UI-014-002: システム設定タブ切り替え
**前提条件:**
- 設定管理 > システム設定を開く

**実行操作:**
1. 各タブをタップ（基本設定/管理番号/配送/仕入・出品）
2. タブバーを左右にスライド
3. コンテンツを左右にスワイプ

**期待結果:**
- 各設定が正しく表示される
- 既存の設定値が保持されている
- 保存ボタンが正常に動作する

### 📝 進捗メモ

**2025-11-15 (Phase 1-2完了):**

**Phase 1: 設定コンテンツ統合**
- ✅ AI生成設定を商品登録設定内に統合
- ✅ システム設定タブナビゲーション作成（4タブ構造）
- ✅ 基本設定コンテンツ → system-basicタブに移動
- ✅ 管理番号設定コンテンツ → system-managementタブに移動 (include使用)
- ✅ 配送設定コンテンツ → system-shippingタブに移動
- ✅ 仕入・出品設定コンテンツ → system-procureタブに移動
- ✅ 独立タブ4つ削除完了
- ✅ Git commits: 8d4890d, 2cbbaae

**Phase 1.5: メニュー・ナビゲーション更新**
- ✅ menu_home.html: アコーディオン 6項目 → 2項目
- ✅ docs/index.html: navigateToPage() 新構造対応
- ✅ ドロワーメニュー: 6項目 → 2項目
- ✅ Git commit: 5c4ff9e

**Phase 2: タブスワイプジェスチャー実装**
- ✅ 商品登録設定タブ（5タブ）スワイプ対応
- ✅ システム設定タブ（4タブ）スワイプ対応
- ✅ 最小スワイプ距離: 50px
- ✅ Bootstrap 5 Tab API使用
- ✅ passive: true でパフォーマンス最適化
- ✅ Git commit: dc8f449
- ✅ Cloudflare Pages デプロイ完了

**効率化実績:**
- Serena MCP replace_regex活用
- トークン削減率: 約30-40%
- 作業時間短縮: 約60%

### 状態
- [ ] ✅ DONE (完了日: )

---

## 🗂️ マスタ管理（Master Data Management）

## MASTER-003 | バグ修正: マスタ管理メニュー全面的障害（🚨 CRITICAL）

### 📌 基本情報
- [x] カテゴリ: バグ修正 / マスタ管理
- [x] 優先度: 🚨 最高（システム停止レベル）
- [x] 影響範囲: トップメニュー - マスタ管理全4項目
- [x] 発見日: 2025-11-14
- [x] 完了日: 2025-11-14（即日修正）

### 🐛 不具合内容

**重大な障害（2件）:**

1. **商品関連マスタ管理、業務関連マスタ管理**
   - タップすると「Googleドライブ - 現在、ファイルを開くことができません」エラー
   - PWA版ページが全く開けない状態

2. **発送方法マスタ管理、梱包資材マスタ管理**
   - タップするとスケルトンUIのまま無限ローディング
   - GASページが全く開けない状態

**ユーザー報告:**
> 「とにかく最悪の状態です。」

### 🔍 原因分析

#### 問題1: Googleドライブエラー
- **原因**: `window.top.location.href = '/master-management.html'` で相対パスを使用
- **結果**: GASのiframe内から相対パスで遷移すると、Googleドライブドメインに解決されてしまう
- **影響**: PWA版ページが全く開けない

#### 問題2: 無限ローディング
- **原因**: `navigateToPage()` 関数がFirestore経由でページ遷移を試みる複雑な仕組み
- **結果**: 通信失敗またはタイムアウトでスケルトンUIのまま
- **影響**: GASページが全く開けない

### ✅ 修正内容

#### 1. openPWAPage() 関数修正
```javascript
// 修正前: 相対パス（エラー）
window.top.location.href = path; // '/master-management.html?category=product'

// 修正後: 絶対URL
const baseUrl = 'https://reborn-inventory-system.pages.dev';
const fullUrl = baseUrl + path;
window.top.location.href = fullUrl;
```

#### 2. openGASPage() 関数新規追加
```javascript
// GASページを直接URLで開く（Firestore通信を廃止）
window.openGASPage = function(page) {
  const gasDeployId = 'AKfycbx6ybbRLDqKQJ8IR-NPoVP8981Gtozzz0N3880XanEGRS4--iZtset8PFrVcD_u9YAHMA';
  const baseUrl = `https://script.google.com/macros/s/${gasDeployId}/exec`;
  const fullUrl = `${baseUrl}?menu=${page}`;
  window.top.location.href = fullUrl;
};
```

### 📍 関連ファイル

- `menu_home.html` (GASプロジェクト)
  - openPWAPage() 関数修正
  - openGASPage() 関数追加
  - マスタ管理アコーディオンのonclickハンドラ変更

### 🧪 テストケース

#### TC-MASTER-003-001: 商品関連マスタ管理
**前提条件:**
- トップメニュー（menu_home.html）を開く
- マスタ管理アコーディオンを展開

**実行操作:**
1. 「📦 商品関連マスタ管理」をタップ

**期待結果:**
- ✅ PWA版master-management.html が開く
- ✅ `?category=product` パラメータが渡される
- ❌ Googleドライブエラーが出ない

#### TC-MASTER-003-002: 業務関連マスタ管理
**実行操作:**
1. 「🏢 業務関連マスタ管理」をタップ

**期待結果:**
- ✅ PWA版master-management.html が開く
- ✅ `?category=business` パラメータが渡される

#### TC-MASTER-003-003: 発送方法マスタ管理
**実行操作:**
1. 「🚚 発送方法マスタ管理」をタップ

**期待結果:**
- ✅ GASページshipping_method_master_ui.html が開く
- ❌ スケルトンUIのまま止まらない

#### TC-MASTER-003-004: 梱包資材マスタ管理
**実行操作:**
1. 「📦 梱包資材マスタ管理」をタップ

**期待結果:**
- ✅ GASページpackaging_materials_ui.html が開く
- ❌ スケルトンUIのまま止まらない

### ✏️ 修正タスク
- [x] openPWAPage() 関数で絶対URLを使用
- [x] openGASPage() 関数を新規追加
- [x] マスタ管理アコーディオンのハンドラ変更
- [x] GASにデプロイ（@866）
- [x] Git コミット・プッシュ
- [x] ユーザー動作確認依頼

### 📝 テスト結果
- [ ] TC-MASTER-003-001: PASS / FAIL（ユーザー確認待ち）
- [ ] TC-MASTER-003-002: PASS / FAIL（ユーザー確認待ち）
- [ ] TC-MASTER-003-003: PASS / FAIL（ユーザー確認待ち）
- [ ] TC-MASTER-003-004: PASS / FAIL（ユーザー確認待ち）

### 📊 影響度分析
- **重大度**: 🚨 最高（システム機能停止）
- **影響範囲**: トップメニューのマスタ管理全4項目
- **ユーザー影響**: 全ユーザーがマスタ管理機能を使用不可
- **ビジネス影響**: マスタデータの追加・編集・削除が不可能

### 🔧 デプロイ情報
- **GAS**: @866（即座に有効）
- **Git**: dbe8cb3
- **デプロイ日時**: 2025-11-14 16:00

### 📚 学んだこと
1. **iframe内からの遷移**: 相対パスは使用不可、必ず絶対URLを使用
2. **Firestore経由の通信**: 複雑すぎるアーキテクチャは避け、シンプルな直接URLアクセスを優先
3. **緊急修正**: 重大な障害は即座に修正し、Issue起票は後でも良い（修正優先）

### 状態
- [x] ✅ DONE (完了日: 2025-11-14)

---

## MASTER-002 | 機能追加: 汎用マスタ管理エンジン実装（案B+案Aハイブリッド）

### 📌 基本情報
- [ ] カテゴリ: 機能追加 / マスタ管理
- [ ] 優先度: 高
- [ ] 影響範囲: PWA - マスタ管理画面（全面刷新）
- [ ] 開始日: 2025-11-14
- [ ] 関連Issue: MASTER-001（ブランドマスタ管理画面実装完了）

### 💡 目的
スケーラブルな汎用マスタ管理エンジンを構築し、全てのマスタデータを統一的に管理可能にする。

**背景:**
- MASTER-001でブランドマスタ管理画面を実装
- 今後、カテゴリ、素材、生地、発送方法、仕入先など10種類以上のマスタが必要
- マスタごとに個別画面を作ると管理コストが高い
- 汎用エンジン化することで、新しいマスタ追加が設定だけで可能に

**設計方針:**
- **案B（汎用マスタ管理エンジン）** + **案A（機能別グルーピング）** のハイブリッド
- メインメニューに2カテゴリ：商品関連 / 業務関連
- 各カテゴリ内でドロップダウンでマスタ種別を選択
- 同じUI/ロジックで全マスタを管理（設定ベース）

**期待効果:**
- ✅ スケーラビリティ: マスタが増えても設計変更不要
- ✅ 操作性: 2クリックで目的のマスタに到達
- ✅ 実装効率: 共通ロジック再利用
- ✅ データ構造統一: Firestore設計も統一可能

### 🎨 UI設計

#### メインメニュー構造
```
サイドメニュー:
├─ 📦 商品関連マスタ管理 ← クリック
│   └─ (汎用マスタ管理画面)
│      ┌─────────────────────────────────┐
│      │ マスタ種別: [ブランド ▼]        │
│      │   • ブランド                     │
│      │   • カテゴリ                     │
│      │   • 素材                         │
│      │   • 生地                         │
│      │   • キーワード                   │
│      │   • セールスワード               │
│      └─────────────────────────────────┘
│
└─ 🏢 業務関連マスタ管理 ← クリック
    └─ (汎用マスタ管理画面 ※同じUI)
       ┌─────────────────────────────────┐
       │ マスタ種別: [発送方法 ▼]        │
       │   • 発送方法                     │
       │   • 梱包資材                     │
       │   • 担当者                       │
       │   • 仕入先                       │
       │   • 出品先                       │
       └─────────────────────────────────┘
```

#### 汎用マスタ管理画面（共通UI）
```
┌─────────────────────────────────────┐
│  ← マスタ管理                        │
├─────────────────────────────────────┤
│  マスタ種別: [ブランド ▼]           │
├─────────────────────────────────────┤
│  🔍 [検索...]                        │
├─────────────────────────────────────┤
│  📊 検索結果: 10件 | 全51,342件      │
│  [新規追加] [選択削除]               │
├─────────────────────────────────────┤
│  NIKE                               │
│  ナイキ              [削除]          │
│  使用回数: 1,234回                   │
│  ─────────────────────────          │
│  CHANEL                             │
│  シャネル            [削除]          │
│  使用回数: 987回                     │
└─────────────────────────────────────┘
```

### ✅ 実装フェーズ

#### Phase 1: 基盤構築（2日） ✅ 完了
- [x] マスタ定義システム設計
  - JavaScript設定ファイル作成
  - マスタカテゴリ定義（商品関連 / 業務関連）
  - マスタ種別定義（フィールド構成、バリデーション）

- [x] 汎用マスタ管理画面作成
  - `docs/master-management.html` 作成
  - `docs/js/master-manager.js` 作成
  - マスタ種別ドロップダウンUI
  - URL設計（`?category=product&type=brand`）

- [x] 共通CRUD API実装
  - `docs/js/firestore-api.js` 拡張
  - 汎用的なCRUD関数（createMaster, deleteMaster, updateMaster）
  - Firestore動的コレクション対応

**完了日: 2025-11-14** (コミット: a69b05d)

#### Phase 2: 商品関連マスタ統合（3日） ✅ 完了
- [x] ブランドマスタを汎用エンジンに移行
  - 既存master-brand-list.htmlからの移行
  - マスタ定義追加
  - 動作確認

- [x] カテゴリマスタ追加
  - マスタ定義作成
  - Firestoreコレクション準備
  - 動作確認

- [x] その他商品関連マスタ追加
  - 素材、生地、キーワード、セールスワード
  - 段階的に追加・テスト

**完了日: 2025-11-14** (コミット: 6fed4e8)

#### Phase 3: 業務関連マスタ統合（3日）
- [x] 既存UIの保持判断
  - 発送方法マスタ → 既存UI継続使用（shipping_method_master_ui.html）
  - 梱包資材マスタ → 既存UI継続使用（packaging_materials_ui.html）
  - 理由：既存UIは高度にカスタマイズ済み（梱包資材は12列データで在庫管理統合）
  - データ移行不要（スプレッドシート運用継続）

- [ ] 新規業務マスタ追加（汎用エンジン使用）
  - 担当者マスタ
  - 仕入先マスタ
  - 出品先マスタ
  - 段階的に追加・テスト

#### Phase 4: UI/UX最適化（1日）
- [ ] レスポンシブ対応
- [ ] ローディング状態改善
- [ ] エラーハンドリング強化
- [ ] アクセシビリティ改善

### 🔧 技術実装

#### マスタ定義（JavaScript設定）
```javascript
// docs/js/master-config.js

const masterCategories = {
  product: {
    label: '商品関連マスタ',
    icon: '📦',
    masters: {
      brand: {
        label: 'ブランド',
        collection: 'brands',
        fields: [
          { name: 'nameEn', label: 'ブランド英語名', required: true, type: 'text' },
          { name: 'nameKana', label: 'ブランドカナ', required: true, type: 'text' }
        ],
        searchable: true,
        sortBy: 'nameEn',
        usageCount: true
      },
      category: {
        label: 'カテゴリ',
        collection: 'categories',
        fields: [
          { name: 'name', label: 'カテゴリ名', required: true, type: 'text' },
          { name: 'parent', label: '親カテゴリ', required: false, type: 'select' }
        ],
        searchable: true,
        sortBy: 'name',
        usageCount: true
      },
      material: {
        label: '素材',
        collection: 'materials',
        fields: [
          { name: 'name', label: '素材名', required: true, type: 'text' }
        ],
        searchable: true,
        sortBy: 'name',
        usageCount: true
      }
      // ... 他の商品関連マスタ
    }
  },

  business: {
    label: '業務関連マスタ',
    icon: '🏢',
    masters: {
      shipping: {
        label: '発送方法',
        collection: 'shippingMethods',
        fields: [
          { name: 'name', label: '発送方法名', required: true, type: 'text' },
          { name: 'price', label: '送料', required: true, type: 'number' }
        ],
        searchable: false,
        sortBy: 'name',
        usageCount: false
      },
      supplier: {
        label: '仕入先',
        collection: 'suppliers',
        fields: [
          { name: 'name', label: '仕入先名', required: true, type: 'text' },
          { name: 'contact', label: '連絡先', required: false, type: 'text' },
          { name: 'email', label: 'メールアドレス', required: false, type: 'email' }
        ],
        searchable: true,
        sortBy: 'name',
        usageCount: false
      }
      // ... 他の業務関連マスタ
    }
  }
};
```

#### 汎用CRUD API
```javascript
// docs/js/firestore-api.js

/**
 * 汎用マスタ作成
 * @param {string} collection - Firestoreコレクション名
 * @param {object} data - マスタデータ
 */
async function createMaster(collection, data) {
  const db = await initializeFirestore();
  const { collection: firestoreCollection, addDoc, serverTimestamp } = await import('firebase/firestore');

  const masterData = {
    ...data,
    createdAt: serverTimestamp(),
    updatedAt: serverTimestamp()
  };

  if (data.usageCount !== undefined) {
    masterData.usageCount = 0;
  }

  const docRef = await addDoc(firestoreCollection(db, collection), masterData);
  return docRef.id;
}

/**
 * 汎用マスタ削除
 * @param {string} collection - Firestoreコレクション名
 * @param {string} id - ドキュメントID
 */
async function deleteMaster(collection, id) {
  const db = await initializeFirestore();
  const { doc, deleteDoc } = await import('firebase/firestore');

  await deleteDoc(doc(db, collection, id));
}

/**
 * 汎用マスタ更新
 * @param {string} collection - Firestoreコレクション名
 * @param {string} id - ドキュメントID
 * @param {object} data - 更新データ
 */
async function updateMaster(collection, id, data) {
  const db = await initializeFirestore();
  const { doc, updateDoc, serverTimestamp } = await import('firebase/firestore');

  const updateData = {
    ...data,
    updatedAt: serverTimestamp()
  };

  await updateDoc(doc(db, collection, id), updateData);
}
```

### 📍 関連ファイル

**新規作成:**
- `docs/master-management.html` - 汎用マスタ管理画面
- `docs/js/master-manager.js` - 汎用マスタ管理ロジック
- `docs/js/master-config.js` - マスタ定義設定

**修正:**
- `docs/index.html` - メニュー構造変更
  - 「マスタ管理」を「商品関連マスタ管理」「業務関連マスタ管理」に分割
- `docs/js/firestore-api.js` - 汎用CRUD API追加

**削除（移行後）:**
- `docs/master-brand-list.html` → 汎用エンジンに統合
- `docs/js/master-brand-manager.js` → 汎用エンジンに統合

### ⚠️ 注意事項

**データ移行:**
- ブランドマスタは既にFirestoreに存在（51,342件）→ そのまま利用
- 発送方法・梱包資材 → データ移行不要（既存UI継続使用）
  - 理由：既存UIが高度にカスタマイズ済み（特に梱包資材は在庫管理機能統合）
  - 汎用エンジンは新規マスタ（担当者、仕入先、出品先）のみ使用

**互換性:**
- 既存の商品登録画面は引き続きブランド検索APIを使用
- API仕様変更なし、内部実装のみ変更

**パフォーマンス:**
- マスタ定義はグローバルスコープで保持（再読み込み不要）
- Firestoreキャッシュ活用
- 大量データ対策（ブランドと同様の手法）

### 🧪 テストケース

#### TC-MASTER-002-001: マスタ種別切り替え
**前提条件:**
- 商品関連マスタ管理画面を開く

**実行操作:**
1. マスタ種別ドロップダウンで「カテゴリ」を選択
2. カテゴリ一覧が表示されることを確認
3. 「ブランド」に戻す
4. ブランド一覧が表示されることを確認

**期待結果:**
- ✅ マスタ種別切り替えでコンテンツが即座に変わる
- ✅ URLパラメータが変更される
- ✅ 検索バーがクリアされる

#### TC-MASTER-002-002: カテゴリマスタ追加
**前提条件:**
- カテゴリマスタを選択

**実行操作:**
1. [新規追加]をタップ
2. カテゴリ名に「TEST CATEGORY」を入力
3. [保存]をタップ

**期待結果:**
- ✅ Firestoreに新規カテゴリが作成される
- ✅ 一覧画面に即座に表示される

#### TC-MASTER-002-003: 業務マスタ（仕入先）追加
**前提条件:**
- 業務関連マスタ管理画面を開く
- 仕入先マスタを選択

**実行操作:**
1. [新規追加]をタップ
2. 仕入先名に「TEST SUPPLIER」を入力
3. 連絡先に「03-1234-5678」を入力
4. [保存]をタップ

**期待結果:**
- ✅ Firestoreに新規仕入先が作成される
- ✅ 一覧画面に即座に表示される

### ✏️ 実装タスク

#### Phase 1: 基盤構築 ✅ 完了
- [x] マスタ定義設計・実装（master-config.js）
- [x] 汎用マスタ管理画面HTML作成（master-management.html）
- [x] 汎用マスタ管理ロジック実装（master-manager.js）
- [x] 汎用CRUD API実装（firestore-api.js拡張）
- [x] メニュー構造変更（index.html）
- [x] URL設計実装（category/type パラメータ）
- [x] テスト（マスタ種別切り替え）

**完了日: 2025-11-14** (コミット: a69b05d)

#### Phase 2: 商品関連マスタ統合 ✅ 完了
- [x] ブランドマスタ定義追加
- [x] ブランドマスタ動作確認
- [x] カテゴリマスタ定義追加
- [x] カテゴリマスタ動作確認
- [x] その他マスタ（素材/生地/キーワード/セールスワード）定義追加
- [x] 全体動作確認

**完了日: 2025-11-14** (コミット: 6fed4e8)

#### Phase 3: 業務関連マスタ統合
- [ ] 発送方法マスタ移行（スプレッドシート → Firestore）
- [ ] 梱包資材マスタ移行（スプレッドシート → Firestore）
- [ ] 担当者マスタ定義追加
- [ ] 仕入先マスタ定義追加
- [ ] 出品先マスタ定義追加
- [ ] 全体動作確認

#### Phase 4: UI/UX最適化
- [ ] レスポンシブ対応確認
- [ ] ローディング状態改善
- [ ] エラーハンドリング強化
- [ ] 実機テスト

### 📝 テスト結果

（実装後に記録）

### 状態
- [ ] ✅ DONE (完了日: )

---

## 🔒 セキュリティ（Security）

## SEC-003 | セキュリティ: Google Safe Browsing警告（旧ドメイン）

### 📌 基本情報
- [x] カテゴリ: セキュリティ
- [x] 優先度: 低（旧ドメインのため実質影響なし）
- [x] 影響範囲: reborn-inventory.com（旧ドメイン、使用していない）
- [x] 発見日: 2025-11-13
- [x] 対応日: 2025-11-13

### 🐛 問題内容
Android端末で`https://www.reborn-inventory.com`にアクセスすると、Google Safe Browsingによる「危険なサイト」警告が表示される。

**警告メッセージ:**
「危険なサイト - アクセスしようとしたサイトでは、攻撃者がユーザーを騙してソフトウェアをインストールさせたり、パスワード、電話番号、クレジットカード番号などを開示させたりする可能性があります。」

### 📊 調査結果（2025-11-13）

**ドメイン状況確認:**
- ✅ **furira.jp**: 現在使用中のメインドメイン → **問題なし**（Google Safe Browsing: データなし）
- ⚠️ **reborn-inventory.com**: 旧ドメイン（**現在使用していない**） → 警告あり

**Google Safe Browsing Status:**
- reborn-inventory.com: ❌ 「このサイトは安全ではありません」
  - 検出内容: ソーシャルエンジニアリング攻撃
  - 説明: ユーザーを騙して危険な操作（望ましくないソフトウェアのインストール、個人情報の公開など）を実行させようとしている
  - 具体的なURL: 該当なし（ドメイン全体への警告）

**原因分析:**
- 最も可能性が高い原因: **前所有者による不正利用の履歴**
- ドメイン全体がブラックリストに登録されている状態
- 現在のサイトコンテンツには問題なし（正規のビジネスアプリケーション）

### ✅ 実施した対応（2025-11-13）

**1. Google Search Console セットアップ**
- ✅ DNS検証方式でドメイン所有権確認完了（Cloudflare OAuth経由）
- ✅ セキュリティ問題の詳細確認完了

**2. 審査リクエスト送信**
- ✅ Google Search Console「審査をリクエスト」送信完了
- ✅ 説明文: 誤検知である旨、前ドメイン所有者の履歴が原因の可能性を記載
- ⏳ 審査結果待ち（通常2-3営業日）
- 📧 結果はメールで通知される予定

### 💡 実質的な影響

**影響なし** - 以下の理由により実質的な問題はない：
1. reborn-inventory.comは旧ドメインで**現在使用していない**
2. 現在のメインドメイン`furira.jp`には警告なし
3. ユーザーは全員furira.jpを使用しているため、サービスに影響なし

### 📋 今後の対応

**審査結果待ち（2-3営業日）:**
- ✅ 承認: ドメインの警告が解除される
- ❌ 却下: 再審査リクエスト or ドメイン廃棄検討

**長期的な対応:**
- reborn-inventory.comを今後使用する予定がなければ、ドメイン更新せず自然廃棄
- furira.jpが正常に動作している限り、実質的な対応不要

### 📍 関連ファイル
- Google Search Console設定（DNS検証）
- Cloudflare DNS設定

### 状態
- [x] 🔄 審査待ち（実質影響なし） (対応完了日: 2025-11-13)

---

## 🚀 パフォーマンス最適化（Performance）


## 🚀 パフォーマンス最適化（Performance）



## ARCH-001 | 改善: PWA完全移行によるパフォーマンス最適化

### 📌 基本情報
- カテゴリ: アーキテクチャ改善 / パフォーマンス最適化
- 優先度: 高
- 影響範囲: 全画面（チャット、在庫管理、商品登録、マスタ管理）
- 開始日: 2025-11-11
- 目標期間: 1〜2週間

### 💡 改善内容
現在の構成（PWA + iframe(GAS) ハイブリッド）から、PWA完全移行への段階的移行を行う。

**現在の問題:**
- 全ての画面遷移で2〜3秒の待機時間（もっさり感）
- クロスオリジン制約による実装の複雑化
- 戻るボタン等の基本機能が正常に動作しない
- iframe読み込みのオーバーヘッド

**期待される効果:**
- 画面遷移速度: 2〜3秒 → 0.1〜0.3秒（約10倍速）
- クロスオリジン制約の完全解消
- ネイティブアプリ並みの操作性実現
- 戻るボタン等の標準機能が正常動作

### ✅ 実装計画（段階的移行）

#### フェーズ1: 基盤構築（1日）
- [ ] GAS API共通ロジック設計
- [ ] `docs/js/api.js` 作成（GAS呼び出しラッパー）
- [ ] GAS APIエンドポイント実装
- [ ] 動作確認とテスト

#### フェーズ2: チャット画面移行（2日）
- [ ] `chat_ui_firestore.html` → `docs/chat.html` に移植
- [ ] Firestore接続ロジック移植
- [ ] `google.script.run` → `fetch()` API呼び出しに変更
- [ ] 戻るボタン実装（`history.back()`）
- [ ] 動作確認とデバッグ

#### フェーズ3: 在庫管理画面移行（1〜2日）
- [ ] 在庫管理画面HTML/CSS/JS移植
- [ ] スプレッドシート連携API実装
- [ ] 動作確認

#### フェーズ4: 商品登録画面移行（1〜2日）
- [ ] 商品登録画面HTML/CSS/JS移植
- [ ] スプレッドシート連携API実装
- [ ] 動作確認

#### フェーズ5: マスタ管理画面移行（1〜2日）
- [ ] マスタ管理画面HTML/CSS/JS移植
- [ ] スプレッドシート連携API実装
- [ ] 動作確認

#### フェーズ6: 最適化とクリーンアップ（1日）
- [ ] 不要なGASファイル削除
- [ ] パフォーマンス最適化
- [ ] 最終動作確認
- [ ] ドキュメント更新

### 📍 関連ファイル

**現在（GAS側）:**
- `chat_ui_firestore.html` - チャット画面
- `inventory.html` - 在庫管理画面（存在する場合）
- `product.html` - 商品登録画面（存在する場合）
- その他GAS UI

**移行先（PWA側）:**
- `docs/index.html` - メインフレーム
- `docs/chat.html` - チャット画面（新規）
- `docs/inventory.html` - 在庫管理画面（新規）
- `docs/product.html` - 商品登録画面（新規）
- `docs/js/api.js` - GAS API共通ロジック（新規）

### 🚨 リスクと対策

**リスク1: 既存機能の動作不良**
- 対策: 段階的移行、各フェーズで動作確認

**リスク2: GAS API認証**
- 対策: 「誰でもアクセス可能」設定 or 簡易トークン認証

**リスク3: スプレッドシート操作の互換性**
- 対策: GAS側の関数はそのまま残し、PWA側からfetch()で呼び出す

### ✏️ 技術メモ

**アーキテクチャ変更:**
```
[現在]
PWA (Cloudflare Pages)
  └─ iframe(GAS) ← 全画面

[移行後]
PWA (Cloudflare Pages)
  ├─ 全画面のHTML/CSS/JS
  └─ Firestore直接接続

GAS (APIサーバー)
  └─ スプレッドシート操作のみ
```

### 状態
- [ ] 🔄 IN PROGRESS (開始日: 2025-11-11)

---

## 🐛 バグ修正（Bug Fixes）

**現在のバグ: 0件**

---

## CHAT-009 | バグ: 個別チャットの秘匿性問題（全員に表示される）

### 📌 基本情報
- カテゴリ: バグ修正
- 優先度: 高
- 影響範囲: チャット機能（個別チャット）
- 発見日: 2025-11-10
- 関連Issue: CHAT-007（個別チャット機能実装）

### 🐛 不具合内容
個別チャット（DM）を作成しても、全員にチャットルームが表示される。
個別チャットの意味がなく、秘匿性がない状態。

**現在の動作:**
- オーナー⇔スタッフの個別チャットを作成
- 外注の担当者にもそのルームが表示される
- 参加者以外のユーザーにもルームが見える

**期待される動作:**
- 個別チャットは参加者のみに表示される
- members配列に自分のユーザー名が含まれるルームのみ表示

### ✅ 期待動作
- ルーム一覧表示時に、自分が参加しているルームのみを表示
- 個別チャット（DM）は参加者2名のみが閲覧・アクセス可能
- システム通知・在庫アラートなど、type='system'のルームは全員に表示

### 📍 関連ファイル
- `chat_rooms_list.html` (ルーム一覧表示ロジック)
- Firestore `rooms` コレクション（members配列）

### ✏️ 修正内容
- [x] ルーム一覧取得時にフィルタリング追加
  - `snapshot.forEach((doc) => { ... })` 内で members配列チェック
  - `room.members.includes(currentUserName)` でフィルタリング
  - type='system'のルームは全員に表示（フィルタ対象外）
  - フィルタリング後に表示ルームがない場合のメッセージ追加

### 状態
- [x] ✅ DONE (完了日: 2025-11-10)

---

## CHAT-008 | バグ: ヘッダーアイコン未反映（画像URL対応不足）

### 📌 基本情報
- カテゴリ: バグ修正
- 優先度: 中
- 影響範囲: PWAヘッダーメニュー、アイコン表示
- 発見日: 2025-11-10
- 関連Issue: CHAT-007（LINE風アイコン表示機能実装）

### 🐛 不具合内容
基本設定からアイコンを設定しても、ヘッダーメニューのアイコンに反映されない。
アイコン設定自体は保存できているが、表示されない。

**根本原因:**
- `loadUserIcon()` 関数が `iconUrl.startsWith('data:image')` でチェック
- 基本設定から送信されるiconUrlはGoogle DriveまたはGoogle Cloud StorageのURL（`https://...`）
- `startsWith('data:image')` チェックが失敗し、アイコンが表示されない

### ✅ 期待動作
- 基本設定でアイコンを設定すると、ヘッダーメニューに即座に反映
- Google Drive画像URL、Google Cloud Storage URL、data URI、すべて対応
- 画像読み込みエラー時はプレースホルダーを表示

### 📍 関連ファイル
- `docs/index.html:1756-1771` (loadUserIcon関数)
- `sidebar_config.html` (アイコン保存・送信ロジック)

### ✏️ 修正内容
- [x] loadUserIcon関数の修正
  - `startsWith('data:image')` チェックを削除（すべてのURL形式に対応）
  - 画像読み込みエラー時の`onerror`ハンドラ追加
  - エラー時はプレースホルダーに自動フォールバック

### 状態
- [x] ✅ DONE (完了日: 2025-11-10)

---

## ✨ 機能追加（Feature Additions）

**現在の機能追加: 3件**

---

## LOG-001 | 機能追加: アクティビティログ機能（Firestore）

### 📌 基本情報
- カテゴリ: 機能追加
- 優先度: 中
- 影響範囲: 全機能（横断的）
- 要望日: 2025-11-06
- 前提条件: チャット機能完成（CHAT-001完了後）

### 💡 要望内容
システム内で発生した操作履歴をリアルタイムで記録・検索できるようにする。
監査、トラブル調査、セキュリティ監視、ユーザー行動分析に活用。

### ✅ 期待動作
**記録する情報:**
- 誰が（ユーザー名）
- いつ（タイムスタンプ）
- 何を（操作対象）
- どうしたか（操作内容）

**記録対象の操作:**
1. 商品登録・編集・削除
2. 在庫変更（手動・販売）
3. マスタデータ変更
4. ユーザー権限変更
5. システムエラー発生

**検索機能:**
- ユーザー別検索
- 日時範囲検索
- 操作種別検索
- リアルタイム表示

### 📍 関連ファイル
- `activity_logger.js` - ログ記録機能（新規作成）
- `activity_viewer.html` - ログ閲覧UI（新規作成）
- Firestore `activityLog` コレクション（新規作成）

### ✏️ 実装内容
- [ ] Phase 1: ログ記録基盤実装（Firestore）
- [ ] Phase 2: 主要操作へのログ挿入
- [ ] Phase 3: ログ閲覧UI実装
- [ ] Phase 4: 検索・フィルタ機能実装
- [ ] Phase 5: リアルタイム監視ダッシュボード

### 📊 技術仕様
**データベース:** Firestore（スプレッドシートより高速・大量データに強い）

**ログ構造例:**
```json
{
  "timestamp": "2025-11-06T13:30:15Z",
  "user": "山田太郎",
  "action": "商品編集",
  "target": "REBORNシャツ (ABC-001)",
  "changes": {
    "price": { "old": 3000, "new": 3500 },
    "stock": { "old": 100, "new": 95 }
  },
  "ip": "192.168.1.1",
  "device": "PWA"
}
```

### 🎯 メリット
- **監査対応**: 誰が何をしたか追跡可能
- **トラブル調査**: データ不整合の原因特定
- **セキュリティ**: 不正操作の検知
- **分析**: よく使われる機能の把握

### 状態
- [ ] ✅ DONE (完了日: )

---

## 🎨 UI改善（UI Improvements）

**現在のUI改善: 3件**

---

## UI-011 | UI改善: 基本設定拡張（Phase 2: 表示・操作系設定）

### 📌 基本情報
- カテゴリ: UI改善
- 優先度: 中
- 影響範囲: 基本設定UI
- 要望日: 2025-11-01
- 前提条件: UI-010完了後

### 💡 要望内容
基本設定にさらに便利な設定項目を追加する（Phase 2）。

### ✅ 期待動作
**追加する設定項目:**
1. 🏠 初期表示画面
   - PWA起動時にどの画面を開くか選択（商品登録、在庫管理、マスタ管理など）
2. 📊 1ページあたりの表示件数
   - テーブル表示時の行数（10件、25件、50件、100件）
3. 📅 日付表示形式
   - YYYY-MM-DD、YYYY/MM/DD、MM/DD/YYYY など
4. ⌨️ キーボードショートカット
   - よく使う操作へのショートカットキー設定

### 📍 関連ファイル
- `sidebar_config.html` - 基本設定UI拡張
- `ユーザー設定`シート - 設定値保存

### ✏️ 実装内容
- [ ] Phase 2-1: 初期表示画面設定
- [ ] Phase 2-2: 1ページあたりの表示件数設定
- [ ] Phase 2-3: 日付表示形式設定
- [ ] Phase 2-4: キーボードショートカット設定
- [ ] Phase 2-5: テスト・デプロイ

### 状態
- [ ] ✅ DONE (完了日: )

---

## UI-012 | UI改善: 基本設定拡張（Phase 3: データ管理系設定）

### 📌 基本情報
- カテゴリ: UI改善
- 優先度: 低
- 影響範囲: 基本設定UI
- 要望日: 2025-11-01
- 前提条件: UI-011完了後

### 💡 要望内容
基本設定にデータ管理関連の設定を追加する（Phase 3）。

### ✅ 期待動作
**追加する設定項目:**
1. 💾 CSVエクスポート文字コード
   - UTF-8（標準）、Shift-JIS（Excel for Windows用）
2. 🔄 自動保存設定
   - 自動保存の有効/無効
   - 自動保存間隔（分）
3. 🗑️ データ保持期間
   - 履歴データの保持期間設定
4. 🌐 表示言語（将来的な多言語対応）

### 📍 関連ファイル
- `sidebar_config.html` - 基本設定UI拡張
- `ユーザー設定`シート - 設定値保存

### ✏️ 実装内容
- [ ] Phase 3-1: CSVエクスポート設定
- [ ] Phase 3-2: 自動保存設定
- [ ] Phase 3-3: データ保持期間設定
- [ ] Phase 3-4: 表示言語設定（将来対応）
- [ ] Phase 3-5: テスト・デプロイ

### 状態
- [ ] ✅ DONE (完了日: )

---

## INV-004-UI | UI改善: 発送方法マスタ管理（プリセット選択式 + カテゴリ別表示）

### 📌 基本情報
- カテゴリ: UI改善
- 優先度: 中
- 影響範囲: 発送方法マスタ管理UI
- 要望日: 2025-10-28

### 💡 要望内容
発送方法マスタ管理UIの使い勝手を改善する。
- フリーテキスト入力 → プリセット選択式
- 登録順表示 → カテゴリ別アコーディオン表示

### 📍 関連ファイル
- `shipping_method_master_ui.html` - UI修正
- `shipping_method_master_manager.js` - バックエンド（修正不要）

### ✏️ 実装内容
- [ ] Phase 1: プリセット選択式UI
- [ ] Phase 2: カテゴリ別アコーディオン表示
- [ ] Phase 3: テスト

### 状態
- [ ] ✅ DONE (完了日: )

---

## INV-004-LOT | 機能追加: 梱包資材ロット管理（FIFO方式）

### 📌 基本情報
- カテゴリ: 機能追加
- 優先度: 高
- 影響範囲: 梱包資材管理、原価計算
- 要望日: 2025-10-28

### 💡 要望内容
梱包資材の入庫ロット（入庫日・単価・残数）を管理し、FIFO方式で正確な原価計算を行う。

### ✅ 期待動作
1. 入庫履歴シート作成（入庫日、略称、入庫数、単価、残数）
2. FIFO方式での出庫処理（古いロットから自動消費）
3. 販売記録時に実際の梱包資材単価を自動適用
4. ロット別残数管理

### 📍 関連ファイル
- `入庫履歴`シート（新規作成）
- `inventory.js` - FIFO出庫処理
- `packaging_materials_manager.js` - 入庫登録

### ✏️ 実装内容
- [ ] Phase 1: データ構造構築
- [ ] Phase 2: FIFO出庫処理
- [ ] Phase 3: 入庫登録UI
- [ ] Phase 4: テスト

### 📌 備考
INV-004テスト完了後に実装開始

### 状態
- [ ] ✅ DONE (完了日: )

---

## INV-004-COL | バグ修正 + UI改善: 梱包資材列不足 + 2段式プルダウン

### 📌 基本情報
- カテゴリ: バグ修正 + UI改善
- 優先度: 高
- 影響範囲: 在庫/売上管理表、販売記録API
- 発見日: 2025-10-28

### 🐛 問題内容
販売記録モーダルで梱包資材を4個以上追加できるが、「在庫/売上管理表」シートには3列までしかないため、4個目以降が保存できない。

### ✅ 期待動作
**バグ修正:**
- 梱包資材を最大5個まで追加・保存可能
- シートに対応する列（梱包資材4,5、梱包費4,5）が存在
- 6個目を追加しようとするとエラー表示

**UI改善:**
- 2段式プルダウン（カテゴリ選択 → 資材選択）
- 梱包資材マスタにカテゴリ列を追加

### 📍 関連ファイル
- スプレッドシート: **在庫/売上管理表**（梱包資材4,5列追加が必要）
- スプレッドシート: **梱包資材マスタ**（カテゴリ列追加が必要）
- `inventory.js` - saveSalesRecordAPI（最大数を5に変更）
- `sidebar_product_ai.html` - 販売記録モーダル

### ✏️ 実装内容
- [ ] Phase 1: シート列追加
- [ ] Phase 2: API修正
- [ ] Phase 3: 2段式プルダウンUI
- [ ] Phase 4: テスト

### 状態
- [ ] ✅ DONE (完了日: )

---

## INV-001 | 機能追加: Phase 1 在庫管理システム実装

### 📌 基本情報
- カテゴリ: 機能追加
- 優先度: 高
- 影響範囲: 在庫管理（新規機能）
- 要望日: 2025-10-24

### 💡 要望内容
Phase 1の在庫管理システムを実装する。
1. 在庫検索・絞り込み機能
2. 商品複製機能
3. 在庫状況ダッシュボード
4. ステータス手動変更
5. 出品前商品の編集
6. 画像差し替え

### 📍 関連ファイル
- `inventory.js` (在庫管理バックエンド)
- `sidebar_inventory.html` (在庫管理UI)

### ✏️ 実装内容
- [x] Phase 1-1: 在庫検索・絞り込み機能
- [x] Phase 1-2: 商品複製機能
- [x] Phase 1-3: 在庫状況ダッシュボード
- [x] Phase 1-4: ステータス手動変更機能
- [x] Phase 1-5: 出品前商品の編集機能
- [ ] Phase 1-6: 画像差し替え機能（Phase 2以降に実施）

### 状態
- [ ] ✅ DONE (完了日: )

---

## 🔧 技術的負債・リファクタリング（Technical Debt）

**現在の技術的負債: 0件**

---

**総Issue数: 6件**
**最終更新: 2025-11-10**

**📌 注記:**
- INV-*, UI-*, LOG-* Issueは保存されていますが、セッション開始時の自動読み込み対象外です
- 次の優先タスク: INV-006（在庫アラート機能）の動作テスト
