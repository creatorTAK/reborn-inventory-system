# Issues（未完了）

このファイルは、REBORN Inventoryプロジェクトの**未完了Issue**を管理します。

**運用ルール：**
- 新しいIssueは該当カテゴリの最上部に追加
- 完了したIssue（✅ DONE）は `issues-closed.md` に移動
- 定期的にレビュー（週1回推奨）

**関連ドキュメント：**
- [TDD_POLICY.md](./TDD_POLICY.md) - Issue管理ルール詳細
- [ISSUE_TEMPLATE.md](./ISSUE_TEMPLATE.md) - Issue起票テンプレート
- [issues-closed.md](./issues-closed.md) - 完了Issueアーカイブ

---

## 🐛 バグ修正（Bug Fixes）

**現在のバグ: 0件**

---

## 🔧 パフォーマンス改善（Performance）

**現在のパフォーマンス課題: 1件**

---

## PERF-001 | パフォーマンス: PWA画面遷移が遅い（特に在庫管理が5秒）

### 📌 基本情報
- [ ] カテゴリ: パフォーマンス改善
- [ ] 優先度: 中
- [ ] 影響範囲: PWA全体（特に在庫管理）
- [ ] 発見日: 2025-10-24

### 🐛 問題内容
PWA版で画面遷移（商品登録、設定、在庫管理）が遅く、体感で鈍い。
特に在庫管理は5秒程度かかり、ロードマークが表示される。

**症状:**
- 商品登録 → 設定 → 在庫管理の遷移に時間がかかる
- 在庫管理は特に遅く、約5秒
- 中央にロードマークが表示される

### ✅ 期待動作
- 画面遷移が1秒以内（目標）
- 最低でも2秒以内に表示開始
- ローディング中も操作可能な状態を維持

### 📍 関連ファイル
- `docs/index.html` (iframe制御、navigateToPage関数)
- `menu.js` (doGet関数、Web App初期化)
- `sidebar_inventory.html` (在庫管理UI、初期化処理)
- `inventory.js` (searchInventoryAPI, getStatisticsAPI)

### 🔍 調査項目
- [ ] iframe読み込み時間を計測
- [ ] GAS Web App初期化時間を計測
- [ ] sidebar_inventory.html初期化時のAPI呼び出しを確認
- [ ] スプレッドシートアクセス時間を計測
- [ ] ブラウザDevToolsでネットワーク/パフォーマンス分析

### 💡 改善案
1. **ローディングUI改善**
   - プログレスバー追加
   - スケルトンUI表示
   - 「読み込み中...」メッセージ

2. **API最適化**
   - 初期表示時は最低限のデータのみ取得
   - 統計情報は遅延ロード
   - ページネーションのデフォルト件数削減（50→20）

3. **キャッシュ活用**
   - 前回の統計情報をlocalStorageにキャッシュ
   - マスタデータ（ブランド、カテゴリ等）をキャッシュ

4. **iframe事前ロード**
   - 非表示iframeで事前にロード
   - 表示時は切り替えのみ

5. **遅延ロード**
   - 画像は遅延ロード
   - 商品一覧は初回10件のみ表示

### ✏️ 実装内容
- [x] パフォーマンス計測（各処理の時間）
- [x] ボトルネック特定（原因: loadDashboard()とsearch()を同時実行）
- [x] Phase 1: ページネーション最適化（50→10件）
- [x] Phase 2: API統合実装（getInventoryDashboardAPI作成）
- [x] sidebar_inventory.htmlの修正（loadDashboardAndSearch()に統合）
- [x] デプロイ完了（GAS）
- [ ] Phase 3: キャッシュ実装（localStorage活用）- 次回実施予定
- [ ] ユーザーテスト実施
- [ ] 改善効果の実測

### 📝 測定結果
- [x] 改善前: 在庫管理ロード時間 約5秒（ユーザー報告）
- [x] 改善後: 在庫管理ロード時間 **3.6〜4.8秒**（実測 2025-10-26）
- [x] 改善率: **約28%削減**（期待より低い）

**実測データ（コンソールログ）:**
- API応答時間1: 3597ms（約3.6秒）
- API応答時間2: 4803ms（約4.8秒）
- **体感的にも遅さを感じる** → Phase 3で改善必須

### 💡 実装した改善内容
**Phase 1: ページネーション最適化**
- デフォルト表示件数: 50件 → 10件に変更
- sidebar_inventory.html: 248行目

**Phase 2: API統合**
- 新規API作成: `getInventoryDashboardAPI(params)` (inventory.js: 817-1122行目)
- 1回のスプレッドシートスキャンで統計と商品一覧の両方を取得
- 既存の`loadDashboard()`と`search()`を`loadDashboardAndSearch()`に統合
- スプレッドシートアクセスを2回→1回に削減

**期待効果 vs 実測:**
- 期待: 約80%削減（5秒→1秒）
- 実測: 約28%削減（5秒→3.6〜4.8秒）
- **ギャップ原因**: 統計計算で全件スキャンが発生している可能性

### 🔧 Phase 3実装予定（優先度: 高）
- [ ] 統計シート活用の確認（recalculateAllStats実行タイミング）
- [ ] localStorageに統計情報をキャッシュ（初回以降は高速化）
- [ ] 初回表示時の統計計算を非同期化
- [ ] 目標: **1秒以内**でダッシュボード+一覧表示

### 状態
- [ ] ✅ DONE (完了日: ) - Phase 3実装後に完了予定

---

## ✨ 機能追加・改善（Features & Improvements）

**現在の機能追加・改善: 2件**

---

## INV-003 | 機能追加: 複数プラットフォーム対応設計・実装

### 📌 基本情報
- [ ] カテゴリ: 機能追加（戦略的拡張）
- [ ] 優先度: 最高（事業成長の要）
- [ ] 影響範囲: データ構造全体、在庫管理、API連携
- [ ] 要望日: 2025-10-27

### 💡 要望内容

8つの販売プラットフォームに対応し、複数プラットフォームでの同時出品・在庫管理を可能にする。

**背景:**
- メルカリ単独依存のリスク（規制強化、アカウント制限）
- チーム運用の困難さ（通常メルカリのアカウント制限）
- SaaS化への展開（複数顧客×複数プラットフォーム）
- 販路拡大による事業成長

**対象プラットフォーム:**
- Phase 1: メルカリ（手動）← 現在
- Phase 2: メルカリShops（優先、API連携）
- Phase 3: ラクマ、Yahoo!フリマ、BASE、Shopify
- Phase 4: Yahoo!オークション、eBay

### ✅ 期待動作

**1商品×複数プラットフォーム出品:**
- AA-1001をメルカリ、メルカリShops、BASEに同時出品可能
- プラットフォームごとに異なる価格設定可能（手数料率が異なるため）
- プラットフォームごとの出品ステータス管理

**在庫同期:**
- 1つのプラットフォームで販売された時、他のプラットフォームの在庫を自動更新
- 例：メルカリで販売 → 全プラットフォームで「販売済み」または「取り下げ」

**プラットフォーム別情報管理:**
- プラットフォーム商品ID（merc_xxx、shops_yyy等）
- 出品日時、販売日時
- プラットフォーム別利益計算

### 📍 関連ファイル・ドキュメント
- `docs/MULTI_PLATFORM_DESIGN.md` - 設計ドキュメント（詳細設計）
- スプレッドシート - プラットフォーム出品管理シート（新規作成予定）
- `inventory.js` - API拡張
- `sidebar_inventory.html` - UI拡張

### 🏗️ 実装内容（Phase別）

#### Phase 2-1: データ構造拡張 ⏳ 未着手
- [ ] プラットフォーム出品管理シート作成
  - 列定義：管理番号、プラットフォーム、出品ステータス、商品ID、出品価格、出品日時、販売日時、手数料率、利益、備考
  - テストデータ投入
- [ ] 商品マスタシートに全体ステータス列追加
  - 登録済み、出品可能、一部出品中、全出品中、一部販売済み、全販売済み、取り下げ
- [ ] マイグレーションスクリプト作成
  - 既存データをプラットフォーム出品管理シートに移行
  - メルカリ出品データの移行

#### Phase 2-2: バックエンドAPI拡張 ⏳ 未着手
- [ ] `getPlatformListingsAPI(managementNumber)` - 特定商品のプラットフォーム別出品状態取得
- [ ] `createPlatformListingAPI(params)` - プラットフォームへの出品情報登録
- [ ] `updatePlatformListingAPI(params)` - プラットフォーム出品情報更新
- [ ] `deletePlatformListingAPI(params)` - プラットフォーム出品取り下げ
- [ ] `syncInventoryAPI(managementNumber)` - 在庫同期処理

#### Phase 2-3: UI拡張（在庫管理画面） ⏳ 未着手
- [ ] 商品カードにプラットフォーム別ステータス表示
  - 例：[メ] 出品中 ¥5,000 / [Sh] 準備中 ¥5,200 / [+] 出品可能
- [ ] 商品詳細モーダルにプラットフォーム管理セクション追加
  - プラットフォーム別：ステータス、商品ID、価格、出品日、[出品する][取り下げ][編集]ボタン
- [ ] プラットフォーム追加UI
  - 出品可能なプラットフォーム一覧から選択
  - 出品価格の自動計算（手数料率考慮）

#### Phase 3-1: メルカリShops API連携 ⏳ 未着手（ショップ開設待ち）
- [ ] メルカリShops API調査
  - APIドキュメント確認
  - 認証方式（OAuth等）
  - 商品登録、在庫管理、注文取得等のエンドポイント確認
- [ ] OAuth認証実装
- [ ] 商品登録API連携
  - 商品情報送信
  - 画像URL送信（R2から）
  - 商品ID取得
- [ ] 在庫同期実装
  - Webhook受信（販売通知）
  - またはポーリング（定期的に注文状態確認）
- [ ] テスト運用

#### Phase 3-2: その他プラットフォームAPI調査 ⏳ 未着手
- [ ] BASE API調査・ドキュメント確認
- [ ] Shopify API調査・ドキュメント確認
- [ ] ラクマ API調査（API提供有無確認）
- [ ] Yahoo!フリマ API調査（API提供有無確認）
- [ ] Yahoo!オークション API調査
- [ ] eBay API調査

### 🧪 テストケース

#### TC-INV-003-001: プラットフォーム出品管理シート作成
**前提条件:**
- 既存の商品マスタに商品が登録されている（例：AA-1001）

**実行操作:**
1. プラットフォーム出品管理シートを作成
2. AA-1001のメルカリ出品情報を登録
3. AA-1001のメルカリShops出品準備情報を登録

**期待結果:**
- プラットフォーム出品管理シートに2行追加される
- 管理番号、プラットフォーム、ステータス等が正しく記録される

#### TC-INV-003-002: 在庫管理画面でプラットフォーム別表示
**前提条件:**
- AA-1001がメルカリ（出品中）、メルカリShops（出品準備中）に登録されている

**実行操作:**
1. 在庫管理画面を開く
2. AA-1001の商品カードを確認

**期待結果:**
- 商品カードに「[メ] 出品中 ¥5,000」「[Sh] 準備中 ¥5,200」が表示される

#### TC-INV-003-003: プラットフォームへの出品登録
**前提条件:**
- AA-1001が商品マスタに登録済み
- メルカリShopsに未出品

**実行操作:**
1. 商品詳細モーダルを開く
2. 「メルカリShopsに出品する」ボタンをクリック
3. 出品価格を入力（¥5,200）
4. 出品実行

**期待結果:**
- プラットフォーム出品管理シートに新規行追加
- ステータス：出品準備中
- （API連携後）メルカリShopsに商品が登録される

### 📝 テスト結果
- [ ] TC-INV-003-001: PASS / FAIL
- [ ] TC-INV-003-002: PASS / FAIL
- [ ] TC-INV-003-003: PASS / FAIL
- [ ] デグレード確認（既存機能）: OK / NG

### 状態
- [ ] ✅ DONE (完了日: )

### 📌 備考
- 設計ドキュメント: `docs/MULTI_PLATFORM_DESIGN.md`参照
- Phase 2開始タイミング: メルカリ手動運用完成後
- メルカリShops: ショップ開設完了後にPhase 3開始

---

## INV-001 | 機能追加: Phase 1 在庫管理システム実装

### 📌 基本情報
- [ ] カテゴリ: 機能追加
- [ ] 優先度: 高
- [ ] 影響範囲: 在庫管理（新規機能）
- [ ] 要望日: 2025-10-24

### 💡 要望内容

Phase 1の在庫管理システムを実装する。以下の機能を含む：

**実装する機能**:
1. 在庫検索・絞り込み機能
2. 商品複製機能（メルカリ再出品、類似商品登録）
3. 在庫状況ダッシュボード
4. ステータス手動変更
5. 出品前商品の編集
6. 画像差し替え

**実装しない機能（Phase 2以降）**:
- 出品後商品の全項目編集
- 複数プラットフォーム管理
- 一括価格変更

### ✅ 期待動作

**在庫検索・絞り込み**:
- ステータス、ブランド、カテゴリ、サイズ、カラー等で絞り込み可能
- 一覧表示（カード形式、50件/ページ）
- ソート機能（登録日時、出品日、販売日、利益金額）

**商品複製**:
- 既存商品データを全コピー
- 管理番号のみ新規採番
- ステータスを「登録済み」にリセット
- 商品登録フォームを開く（データ入力済み）

**在庫状況ダッシュボード**:
- ステータス別件数表示
- 総在庫金額、総出品金額、総販売金額、総利益金額
- 平均在庫日数

### 📍 関連ファイル
- `inventory.js` (在庫管理バックエンド)
- `sidebar_inventory.html` (在庫管理UI)
- `INVENTORY_MANAGEMENT_DESIGN.md` (設計書)

### 🧪 テストケース

#### TC-INV-001-001: 在庫検索（ステータス絞り込み）
**前提条件:**
- スプレッドシートに複数ステータスの商品が存在
  - 登録済み: 5件
  - 出品中: 10件
  - 販売済み: 20件

**実行操作:**
1. 在庫管理画面を開く
2. ステータスフィルタで「出品中」を選択
3. 検索ボタンをクリック

**期待結果:**
- 「出品中」の商品10件のみが表示される
- 他のステータスの商品は表示されない

#### TC-INV-001-002: 商品複製
**前提条件:**
- 管理番号 AA-1001 の商品が存在
- 次の管理番号は AA-1002

**実行操作:**
1. 在庫一覧で AA-1001 の「複製」ボタンをクリック
2. 商品登録フォームが開く
3. そのまま「登録」ボタンをクリック

**期待結果:**
- 新しい商品が AA-1002 として登録される
- AA-1001 のデータ（ブランド、カテゴリ等）が全てコピーされている
- ステータスは「登録済み」
- 出品日、販売日はクリアされている

#### TC-INV-001-003: 在庫状況ダッシュボード
**前提条件:**
- 登録済み: 5件（仕入金額合計: 10,000円）
- 出品中: 10件（仕入金額合計: 50,000円、出品金額合計: 100,000円）
- 販売済み: 20件（販売金額合計: 500,000円、利益金額合計: 200,000円）

**実行操作:**
1. 在庫管理画面を開く
2. ダッシュボードを表示

**期待結果:**
- ステータス別件数が正しく表示される
  - 登録済み: 5件
  - 出品中: 10件
  - 販売済み: 20件
- 総在庫金額: 60,000円
- 総出品金額: 100,000円
- 総販売金額: 500,000円
- 総利益金額: 200,000円

### ✏️ 実装内容

#### Phase 1-1: 在庫検索・絞り込み機能 ✅ 完了
- [x] バックエンド関数実装（`inventory.js`）
  - [x] `searchInventoryAPI(params)` - 検索・絞り込み（ページネーション、ソート、詳細フィルタ対応）
  - [x] `getStatisticsAPI(params)` - 統計情報取得（新ステータス対応）
- [x] フロントエンド実装（`sidebar_inventory.html`）
  - [x] 検索フォームUI
  - [x] フィルタUI（ステータス複数選択、ブランド、カテゴリ、サイズ、カラー、テキスト検索）
  - [x] 一覧表示UI（カード形式、レスポンシブ）
  - [x] ページネーション
  - [x] ソート機能
- [ ] TC-INV-001-001 実行（次回テスト予定）

#### Phase 1-2: 商品複製機能 ✅ 完了
- [x] バックエンド関数実装（`inventory.js`）
  - [x] `duplicateProductAPI(params)` - 商品複製
- [x] フロントエンド実装（`sidebar_inventory.html`）
  - [x] 「複製」ボタン追加
  - [x] 複製処理実装
- [ ] TC-INV-001-002 実行（次回テスト予定）

#### Phase 1-3: 在庫状況ダッシュボード ✅ 完了
- [x] バックエンド関数実装（`inventory.js`）
  - [x] `getStatisticsAPI(params)` - 統計情報取得
- [x] フロントエンド実装（`sidebar_inventory.html`）
  - [x] ダッシュボードUI（ステータス別件数、総利益、平均在庫日数）
  - [x] 統計情報表示
- [ ] TC-INV-001-003 実行（次回テスト予定）

#### Phase 1-4: その他機能
- [x] ステータス手動変更機能（実装完了 2025-10-26）
  - 商品詳細モーダルでステータス選択可能
  - updateProductStatusAPIとの連携
  - 全ステータス間の手動変更に対応
- [x] 出品前商品の編集機能（実装完了 2025-10-26）
  - 「登録済み」「出品準備中」のみ編集可能
  - 編集可能フィールド: ブランド、商品名、カテゴリ、アイテム、サイズ、カラー、素材、商品説明、仕入金額、出品金額
  - 変更フィールドの自動検出と一括更新
  - updateProductAPIとの連携
- [ ] 画像差し替え機能（Phase 2以降に実施 - 別Issue化予定）

### 📝 テスト結果
- [ ] TC-INV-001-001: PASS / FAIL
- [ ] TC-INV-001-002: PASS / FAIL
- [ ] TC-INV-001-003: PASS / FAIL
- [ ] デグレード確認（商品登録機能）: OK / NG

### 状態
- [ ] ✅ DONE (完了日: )

---

---

## 🔧 技術的負債・リファクタリング（Technical Debt）

**現在の技術的負債: 0件**

---

**総Issue数: 3件**
**最終更新: 2025-10-27**
