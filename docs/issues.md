# Issues（未完了）

このファイルは、REBORN Inventoryプロジェクトの**未完了Issue**を管理します。

**運用ルール：**
- 新しいIssueは該当カテゴリの最上部に追加
- 完了したIssue（✅ DONE）は `issues-closed.md` に移動
- 定期的にレビュー（週1回推奨）

**関連ドキュメント：**
- [TDD_POLICY.md](./TDD_POLICY.md) - Issue管理ルール詳細
- [issues-closed.md](./issues-closed.md) - 完了Issueアーカイブ

---

## 🐛 バグ修正（Bug Fixes）

**現在のバグ: 4件**

---

## UI-007 | バグ修正: 在庫検索時のiOS自動ズーム問題

### 📌 基本情報
- カテゴリ: バグ修正
- 優先度: 中
- 影響範囲: 在庫管理UI（モバイル）
- 発見日: 2025-10-31

### 🐛 問題内容
在庫管理で商品名・管理番号の検索フィールドにテキストを入力すると、iOSで画面が自動的にピンチイン（ズーム）し、そのまま画面が寄ったままになる。

### ✅ 期待動作
- 検索フィールド入力時に自動ズームしない
- または入力完了後に自動的にピンチアウトする

### 📍 関連ファイル
- `sidebar_inventory.html` - 検索フィールド（333行目）
  - 現在: `form-control-sm` クラス使用（font-sizeが16px未満）
  - iOS Safariは16px未満のinputで自動ズームを実行

### ✏️ 修正内容
- [ ] 検索フィールドのfont-sizeを16px以上に設定
- [ ] 詳細フィルタの各inputフィールドも同様に対応
- [ ] モバイルでの動作確認
- [ ] デプロイ（PWA）

### 状態
- [ ] ✅ DONE (完了日: )

---

## UI-008 | バグ修正: 梱包資材マスタ管理の担当者名設定モーダル表示バグ

### 📌 基本情報
- カテゴリ: バグ修正
- 優先度: 高
- 影響範囲: 梱包資材マスタ管理UI
- 発見日: 2025-10-31

### 🐛 問題内容
梱包資材マスタ管理画面で「担当者名設定」ボタンを押すと、モーダルは開くが中身（入力フィールド）が表示されない。

### ✅ 期待動作
- 設定ボタンをクリックすると担当者名入力フィールドが表示される
- 現在の担当者名が自動入力される

### 📍 関連ファイル
- `packaging_materials_ui.html` - `openOperatorSettingModal()` 関数（2591-2608行目）
  - 問題: `withSuccessHandler` 内でモーダルを開く処理が抜けている
  - `withFailureHandler` のみに `style.display = 'flex'` がある

### ✏️ 修正内容
- [ ] `openOperatorSettingModal()` の `withSuccessHandler` 内にモーダル表示処理を追加
- [ ] テスト実行
- [ ] デプロイ（GAS）

### 状態
- [ ] ✅ DONE (完了日: )

---

## INV-007 | バグ修正: 出庫履歴の操作者が「システム」固定

### 📌 基本情報
- カテゴリ: バグ修正
- 優先度: 高
- 影響範囲: 入出庫履歴、販売記録
- 発見日: 2025-10-31

### 🐛 問題内容
販売記録保存時の出庫履歴で、操作者が「システム」と表示される。入庫履歴では初期設定時のユーザー名が正しく表示されているが、出庫は「システム」固定になっている。

### ✅ 期待動作
- 出庫履歴でも初期設定時のユーザー名（PropertiesService）を使用
- 入庫・出庫で操作者表示を統一

### 📍 関連ファイル
- `inventory.js` - `saveSalesRecordAPI()` 関数
  - 2323行目: `recordUserUpdate(sheet, targetRow, map, 'システム');`
  - 2341行目: `operator: 'システム'`
- `inventory.js` - PropertiesServiceからユーザー名取得処理を追加する必要あり

### ✏️ 修正内容
- [ ] `saveSalesRecordAPI()` でPropertiesServiceから操作者名を取得
- [ ] 2323行目の `'システム'` を取得したユーザー名に変更
- [ ] 2341行目の `operator: 'システム'` を取得したユーザー名に変更
- [ ] テスト実行（販売記録保存→出庫履歴確認）
- [ ] デプロイ（GAS）

### 状態
- [ ] ✅ DONE (完了日: )

---

## NOTIF-003 | バグ修正: FCMトークン自動更新未対応による通知未達

### 📌 基本情報
- カテゴリ: バグ修正
- 優先度: 高
- 影響範囲: FCM通知システム（PWA全体）
- 発見日: 2025-10-27

### 🐛 問題内容
FCMトークンの自動更新（refresh）がハンドリングされていないため、トークンが無効化されても古いトークンが「アクティブ」のまま残り、通知が届かなくなる。

### ✅ 期待動作
- FCMトークンが自動更新された際、新しいトークンをGASに自動送信
- 古いトークンを自動的に非アクティブ化
- 送信失敗時（トークン無効）に自動的にトークンを非アクティブ化

### 📍 関連ファイル
- `docs/index.html` - FCMトークン取得・登録処理（修正必要）
- `web_push.js` - 通知送信・エラーハンドリング（Phase 1完了、Phase 2保留中）

### ✏️ 修正内容
#### Phase 1: 無効トークン自動無効化 ✅ 完了
- [x] web_push.js に deactivateFCMToken 関数を追加
- [x] sendFCMToTokenV1 でエラー時に自動無効化を実行
- [x] デプロイ（GAS @341 + PWA）

#### Phase 2: トークンリフレッシュ処理 ⏳ 保留中（INV-005完了後）
- [ ] index.html にトークンリフレッシュ処理を追加
- [ ] テスト実行
- [ ] デプロイ（PWA）

### 状態
- [ ] ✅ DONE (完了日: )

---

## INV-008 | 機能追加: 梱包資材プリセット機能

### 📌 基本情報
- カテゴリ: 機能追加
- 優先度: 中
- 影響範囲: 販売記録UI
- 要望日: 2025-10-31

### 💡 要望内容
梱包資材の組み合わせパターンがある程度固定されているため、毎回入力するのが手間。よく使うパターンをプリセットとして登録し、ワンクリックで選択できるようにしたい。

### ✅ 期待動作
1. プリセット管理UI（新規作成・編集・削除）
2. プリセット名と梱包資材リストを登録
3. 販売記録モーダルでプリセット選択
4. 選択すると梱包資材フィールドが自動入力される

### 📍 関連ファイル
- スプレッドシート: `梱包資材プリセット`シート（新規作成）
- `sidebar_product_ai.html` - 販売記録モーダル（プリセット選択UI追加）
- `inventory.js` - プリセット管理API
- `packaging_materials_manager.js` - プリセット管理UI（新規作成）

### ✏️ 実装内容
- [ ] Phase 1: データ構造設計
- [ ] Phase 2: プリセット管理API
- [ ] Phase 3: プリセット管理UI
- [ ] Phase 4: 販売記録モーダルへの組み込み
- [ ] Phase 5: テスト

### 状態
- [ ] ✅ DONE (完了日: )

---

## PERF-001 | パフォーマンス改善: 販売記録保存時間の短縮

### 📌 基本情報
- カテゴリ: パフォーマンス改善
- 優先度: 高
- 影響範囲: 販売記録保存処理
- 要望日: 2025-10-31

### 💡 要望内容
販売記録の保存に時間がかかりすぎる。処理速度を上げるか、楽観的UIで体感速度を改善したい。

### ✅ 期待動作
- 販売記録保存が3秒以内に完了（現在: 推定5-10秒）
- または楽観的UI（即座にモーダルを閉じて「保存中...」表示、バックグラウンドで処理）

### 📍 関連ファイル
- `inventory.js` - `saveSalesRecordAPI()` 関数（2231-2366行目）
  - 現在の処理: シート更新、梱包資材書き込み、入出庫履歴記録、統計再計算
- `sidebar_product_ai.html` - 販売記録モーダル（保存処理のUI改善）

### ✏️ 実装内容
#### 案1: バックエンド最適化
- [ ] 入出庫履歴の一括記録を最適化（現在は実装済み）
- [ ] 統計再計算の非同期化・遅延実行
- [ ] シート操作のバッチ処理化
- [ ] パフォーマンス測定・ボトルネック特定

#### 案2: 楽観的UI（推奨）
- [ ] 保存ボタン押下時に即座にモーダルを閉じる
- [ ] 「保存中...」トースト通知を表示
- [ ] バックグラウンドで保存処理実行
- [ ] 完了時に「保存完了」通知、エラー時に再試行ダイアログ
- [ ] 一覧表示を楽観的に更新（保存前提で表示変更）

### 状態
- [ ] ✅ DONE (完了日: )

---


## INV-006 | 機能追加: 在庫アラートのプッシュ通知

### 📌 基本情報
- カテゴリ: 機能追加
- 優先度: 高
- 影響範囲: 在庫管理、FCM通知システム
- 要望日: 2025-10-29

### 💡 要望内容
在庫が少なくなった際に、権限のある管理者にプッシュ通知を送る機能を実装する。

### ✅ 期待動作
1. 在庫アラート設定UI（閾値、通知先、通知タイミング）
2. 販売記録時または定期実行で在庫チェック
3. 閾値以下の資材をプッシュ通知
4. 権限管理（FCMトークン登録済みユーザーのみ）

### 📍 関連ファイル
- `inventory.js` - アラート判定ロジック
- `web_push.js` - FCM通知送信
- `ユーザー管理`シート - 権限フラグ追加
- `在庫アラート設定`シート（新規作成）

### ✏️ 実装内容
- [ ] Phase 1: 設定データ構造
- [ ] Phase 2: アラート判定ロジック
- [ ] Phase 3: 通知送信機能
- [ ] Phase 4: 設定UI
- [ ] Phase 5: 定期実行（オプション）
- [ ] Phase 6: デプロイ・テスト

### 📌 備考
INV-005（入出庫履歴）実装後に着手

### 状態
- [ ] ✅ DONE (完了日: )

---

## INV-004-UI | UI改善: 発送方法マスタ管理（プリセット選択式 + カテゴリ別表示）

### 📌 基本情報
- カテゴリ: UI改善
- 優先度: 中
- 影響範囲: 発送方法マスタ管理UI
- 要望日: 2025-10-28

### 💡 要望内容
発送方法マスタ管理UIの使い勝手を改善する。
- フリーテキスト入力 → プリセット選択式
- 登録順表示 → カテゴリ別アコーディオン表示

### 📍 関連ファイル
- `shipping_method_master_ui.html` - UI修正
- `shipping_method_master_manager.js` - バックエンド（修正不要）

### ✏️ 実装内容
- [ ] Phase 1: プリセット選択式UI
- [ ] Phase 2: カテゴリ別アコーディオン表示
- [ ] Phase 3: テスト

### 状態
- [ ] ✅ DONE (完了日: )

---

## INV-004-LOT | 機能追加: 梱包資材ロット管理（FIFO方式）

### 📌 基本情報
- カテゴリ: 機能追加
- 優先度: 高
- 影響範囲: 梱包資材管理、原価計算
- 要望日: 2025-10-28

### 💡 要望内容
梱包資材の入庫ロット（入庫日・単価・残数）を管理し、FIFO方式で正確な原価計算を行う。

### ✅ 期待動作
1. 入庫履歴シート作成（入庫日、略称、入庫数、単価、残数）
2. FIFO方式での出庫処理（古いロットから自動消費）
3. 販売記録時に実際の梱包資材単価を自動適用
4. ロット別残数管理

### 📍 関連ファイル
- `入庫履歴`シート（新規作成）
- `inventory.js` - FIFO出庫処理
- `packaging_materials_manager.js` - 入庫登録

### ✏️ 実装内容
- [ ] Phase 1: データ構造構築
- [ ] Phase 2: FIFO出庫処理
- [ ] Phase 3: 入庫登録UI
- [ ] Phase 4: テスト

### 📌 備考
INV-004テスト完了後に実装開始

### 状態
- [ ] ✅ DONE (完了日: )

---

## INV-004-COL | バグ修正 + UI改善: 梱包資材列不足 + 2段式プルダウン

### 📌 基本情報
- カテゴリ: バグ修正 + UI改善
- 優先度: 高
- 影響範囲: 在庫/売上管理表、販売記録API
- 発見日: 2025-10-28

### 🐛 問題内容
販売記録モーダルで梱包資材を4個以上追加できるが、「在庫/売上管理表」シートには3列までしかないため、4個目以降が保存できない。

### ✅ 期待動作
**バグ修正:**
- 梱包資材を最大5個まで追加・保存可能
- シートに対応する列（梱包資材4,5、梱包費4,5）が存在
- 6個目を追加しようとするとエラー表示

**UI改善:**
- 2段式プルダウン（カテゴリ選択 → 資材選択）
- 梱包資材マスタにカテゴリ列を追加

### 📍 関連ファイル
- スプレッドシート: **在庫/売上管理表**（梱包資材4,5列追加が必要）
- スプレッドシート: **梱包資材マスタ**（カテゴリ列追加が必要）
- `inventory.js` - saveSalesRecordAPI（最大数を5に変更）
- `sidebar_product_ai.html` - 販売記録モーダル

### ✏️ 実装内容
- [ ] Phase 1: シート列追加
- [ ] Phase 2: API修正
- [ ] Phase 3: 2段式プルダウンUI
- [ ] Phase 4: テスト

### 状態
- [ ] ✅ DONE (完了日: )

---

## INV-001 | 機能追加: Phase 1 在庫管理システム実装

### 📌 基本情報
- カテゴリ: 機能追加
- 優先度: 高
- 影響範囲: 在庫管理（新規機能）
- 要望日: 2025-10-24

### 💡 要望内容
Phase 1の在庫管理システムを実装する。
1. 在庫検索・絞り込み機能
2. 商品複製機能
3. 在庫状況ダッシュボード
4. ステータス手動変更
5. 出品前商品の編集
6. 画像差し替え

### 📍 関連ファイル
- `inventory.js` (在庫管理バックエンド)
- `sidebar_inventory.html` (在庫管理UI)

### ✏️ 実装内容
- [x] Phase 1-1: 在庫検索・絞り込み機能
- [x] Phase 1-2: 商品複製機能
- [x] Phase 1-3: 在庫状況ダッシュボード
- [x] Phase 1-4: ステータス手動変更機能
- [x] Phase 1-5: 出品前商品の編集機能
- [ ] Phase 1-6: 画像差し替え機能（Phase 2以降に実施）

### 状態
- [ ] ✅ DONE (完了日: )

---

## 🔧 技術的負債・リファクタリング（Technical Debt）

**現在の技術的負債: 0件**

---

**総Issue数: 11件**
**最終更新: 2025-10-31**
