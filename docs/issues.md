# Issues（未完了）

このファイルは、REBORN Inventoryプロジェクトの**未完了Issue**を管理します。

**運用ルール：**
- 新しいIssueは該当カテゴリの最上部に追加
- 完了したIssue（✅ DONE）は `issues-closed.md` に移動
- 定期的にレビュー（週1回推奨）

**関連ドキュメント：**
- [TDD_POLICY.md](./TDD_POLICY.md) - Issue管理ルール詳細
- [issues-closed.md](./issues-closed.md) - 完了Issueアーカイブ

---

## 🐛 バグ修正（Bug Fixes）

**現在のバグ: 2件**

---

## NOTIF-004 | バグ: 通知・バッジの不安定な配信（間欠的な未達）

### 📌 基本情報
- [ ] カテゴリ: バグ修正
- [ ] 優先度: 高
- [ ] 影響範囲: 商品登録通知、チャット通知、全端末
- [ ] 発見日: 2025-11-10
- [ ] 関連Issue: PROD-001（@795デプロイ後に発見）

### 🐛 不具合内容
@795デプロイ後、様々な端末でテストを繰り返しているうちに、通知・バッジの配信が不安定になった。

**症状:**
- 商品登録時：通知・バッジが届く/届かないが不規則に発生
- 通常チャット：通知・バッジが届く/届かないが不規則に発生
- 端末による違い：同じ操作でも端末によって届いたり届かなかったり
- タイミング：特定のタイミングは不明（再現条件が特定困難）

**発生状況:**
- PROD-001の修正（@795）は正常動作：スタッフ・外注端末でそれぞれの名前で通知が届く
- しかし、複数回テストを繰り返すうちに、通知・バッジの安定性が低下
- どの操作、どのタイミングで不安定になったか特定困難

### ✅ 期待動作
- すべての端末で安定して通知・バッジが届く
- 商品登録、チャット問わず、確実に通知される
- 再現性のある安定した動作

### 📍 関連ファイル
- `web_push.js` (sendFCMToTokenV1, getUserFCMTokens)
- `chat_ui_firestore.html` (Service Worker, FCMトークン管理)
- `product.js` (sendProductRegistrationWebhook)
- `cloudflare-workers/webhook-worker.js` (postToFirestore, unreadCounts更新)
- Firestore: `fcm_tokens` コレクション
- Firestore: `rooms/{roomId}/unreadCounts/{userName}` コレクション

### 🔍 調査項目
- [ ] FCMトークン管理シートの確認（重複、無効トークン）
- [ ] デバッグログシートの確認（FCM送信成功/失敗）
- [ ] ブラウザDevToolsのコンソールエラー確認
- [ ] Service Workerの状態確認
- [ ] FirestoreのunreadCounts同期状態確認
- [ ] @795の変更による副作用の可能性（recordUserActivity関数への影響）

### 🧪 テストケース
#### TC-NOTIF-004-001: 商品登録通知の安定性テスト
**前提条件:**
- オーナー端末、スタッフ端末、外注端末の3台準備
- すべての端末でPWA版ログイン済み
- FCMトークン正常登録済み

**実行操作:**
1. スタッフ端末で商品登録（5回連続）
2. 外注端末で商品登録（5回連続）
3. オーナー端末で商品登録（5回連続）

**期待結果:**
- オーナー端末：スタッフ・外注の登録時に15回すべて通知・バッジ受信
- スタッフ端末：オーナー・外注の登録時に10回すべて通知・バッジ受信
- 外注端末：オーナー・スタッフの登録時に10回すべて通知・バッジ受信
- 自分の登録時は通知なし（15回とも）

#### TC-NOTIF-004-002: チャット通知の安定性テスト
**前提条件:**
- オーナー端末、スタッフ端末、外注端末の3台準備
- すべての端末でPWA版ログイン済み

**実行操作:**
1. スタッフ端末から全体チャットにメッセージ送信（5回）
2. 外注端末から全体チャットにメッセージ送信（5回）
3. オーナー端末から全体チャットにメッセージ送信（5回）

**期待結果:**
- オーナー端末：スタッフ・外注のメッセージに10回すべて通知・バッジ受信
- スタッフ端末：オーナー・外注のメッセージに10回すべて通知・バッジ受信
- 外注端末：オーナー・スタッフのメッセージに10回すべて通知・バッジ受信

#### TC-NOTIF-004-003: FCMトークン管理確認
**実行操作:**
1. スプレッドシート「FCMトークン管理」シートを開く
2. すべてのトークンを確認

**期待結果:**
- 各ユーザーのトークンが1件ずつ登録
- 重複トークンなし
- 無効（isActive=false）トークンなし
- lastSentがnullでないこと

### ✏️ 修正内容

#### Phase 1: Service Worker最適化（@796 - 2025-11-10）
- [x] **原因特定**: Service Worker のメモリリーク + ネットワークキュー詰まり
  - notificationCache（Map）の無制限な肥大化
  - IndexedDB操作の頻繁な実行（通知1回あたり5回）
  - ネットワークリクエストのタイムアウトなし
  - 症状: チャット/商品登録を繰り返すと通知が届かなくなる → タスクキルで復活

- [x] **修正実装（docs/firebase-messaging-sw.js）**:
  1. notificationCacheのサイズ制限（最大100件）
  2. ACK送信のタイムアウト（5秒）
  3. Firestore unreadCount更新のタイムアウト（5秒）
  4. キャッシュクリーンアップロジック改善

- [x] **デプロイ**: PWA v30
- [x] **テスト結果**: TC-NOTIF-004-001/002実行 → **FAIL（1台あたり3-4回まで通知が届く制限を確認）**
  - 症状: 1台の端末に3-4回までしか通知が来ない
  - バッジ・メッセージは正常動作
  - 原因: ブラウザの通知表示数制限（3-5件）
  - 古い通知がクリアされず、新しい通知が表示されない

#### Phase 2: 通知自動クリーンアップ（@796 - 2025-11-10）
- [x] **根本原因特定**: ブラウザの通知表示数制限（Chrome/Safari: 3-5件）
  - showNotification()前に古い通知をクリアしていない
  - 制限に達すると新しい通知が表示されない（バッジ・メッセージは正常）

- [x] **修正実装（docs/firebase-messaging-sw.js v31）**:
  1. showNotification()前に既存通知を取得（getNotifications()）
  2. 2件以上ある場合、古い通知を全てクリア（.close()）
  3. 新しい通知を表示する余裕を確保
  4. エラーハンドリング追加（クリア失敗でも通知表示は続行）

- [x] **デプロイ**: PWA v31
- [x] **テスト結果**: FAIL（依然として3-4回で停止）

#### Phase 3: event.waitUntil()ベースに全面改修（@796 - 2025-11-10）
- [x] **ChatGPT分析による根本原因特定**: `event.waitUntil()`の不足
  - `messaging.onBackgroundMessage()`内の非同期処理がブラウザにSW実行完了を保証していない
  - ブラウザが数回のpushイベント後にSWを停止してしまう（Safari等で典型的）
  - 参考: MDN ExtendableEvent.waitUntil(), DEV Community報告事例

- [x] **修正実装（docs/firebase-messaging-sw.js v32）**:
  1. **低レベルpushイベントハンドラに変更**
     - `messaging.onBackgroundMessage()` → `self.addEventListener('push', ...)`
     - 全ての非同期処理を`event.waitUntil(promiseChain)`でラップ

  2. **IndexedDB操作の最小化**
     - 重い操作を軽量なヘルパー関数に置換
     - 1回の書き込みで完結（RebornBadgeDB or SystemNotificationDB）

  3. **タイムアウト制御の改善**
     - ACK送信: 4秒タイムアウト
     - Firestore更新: 4秒タイムアウト
     - 並列実行可能な処理は並列化（ACK sendは await不要）

  4. **エラーハンドリング強化**
     - グローバルエラーハンドラ追加
     - 処理失敗時も通知表示を試みる

  5. **通知クリーンアップ改善**
     - 5件以上で全削除（Phase 2の2件から調整）

- [x] **GAS側確認**: 既にdata-onlyペイロード（修正不要）
  - `notification`ブロックなし
  - 全て`data`フィールドで送信済み

- [x] **デプロイ**: PWA v32
- [x] **テスト結果**: 2重通知発生（同じ通知が2回届く）
  - 原因: Firebase Messaging SDKと手動pushハンドラの競合
  - Firebase SDK内部のpushハンドラ + 手動addEventListener('push')の両方が反応

#### Phase 3.5: Firebase Messaging SDK削除（@796 - 2025-11-10）
- [x] **根本原因特定**: Firebase Messaging SDKの内部pushハンドラとの競合
  - `firebase.initializeApp()` + `messaging = firebase.messaging()` → SDK内部でpushイベント自動リッスン
  - 手動の`self.addEventListener('push', ...)` → 2つ目のハンドラ
  - 結果: 1つのpushイベントに2つのハンドラが反応 → 2重通知

- [x] **修正実装（docs/firebase-messaging-sw.js v33）**:
  1. Firebase Messaging SDK完全削除
     - `importScripts('firebase-messaging-compat.js')` 削除
     - `firebase.initializeApp()` 削除
     - `firebase.messaging()` 削除

  2. 完全に手動でpushイベントハンドリング
     - `self.addEventListener('push', ...)` のみ
     - `event.data.json()` でペイロードを直接取得
     - `event.waitUntil()` で確実にSW実行完了を保証

- [ ] **デプロイ**: PWA v33
- [ ] **再テスト**: 1回の操作で1回の通知が届くか確認
- [ ] **10回以上連続テスト**: TC-NOTIF-004-001/002実行

#### Phase 4予定（Phase 3で改善しない場合）:
- [ ] Service Worker定期再起動ロジック
- [ ] より詳細なデバッグログ追加
- [ ] ブラウザ別の細かい挙動調査

### 📝 テスト結果
- [ ] TC-NOTIF-004-001: PASS / FAIL
- [ ] TC-NOTIF-004-002: PASS / FAIL
- [ ] TC-NOTIF-004-003: PASS / FAIL

### 状態
- [ ] ✅ DONE (完了日: )

---

## ✨ 機能追加（Feature Additions）

**現在の機能追加: 3件**

---

## LOG-001 | 機能追加: アクティビティログ機能（Firestore）

### 📌 基本情報
- カテゴリ: 機能追加
- 優先度: 中
- 影響範囲: 全機能（横断的）
- 要望日: 2025-11-06
- 前提条件: チャット機能完成（CHAT-001完了後）

### 💡 要望内容
システム内で発生した操作履歴をリアルタイムで記録・検索できるようにする。
監査、トラブル調査、セキュリティ監視、ユーザー行動分析に活用。

### ✅ 期待動作
**記録する情報:**
- 誰が（ユーザー名）
- いつ（タイムスタンプ）
- 何を（操作対象）
- どうしたか（操作内容）

**記録対象の操作:**
1. 商品登録・編集・削除
2. 在庫変更（手動・販売）
3. マスタデータ変更
4. ユーザー権限変更
5. システムエラー発生

**検索機能:**
- ユーザー別検索
- 日時範囲検索
- 操作種別検索
- リアルタイム表示

### 📍 関連ファイル
- `activity_logger.js` - ログ記録機能（新規作成）
- `activity_viewer.html` - ログ閲覧UI（新規作成）
- Firestore `activityLog` コレクション（新規作成）

### ✏️ 実装内容
- [ ] Phase 1: ログ記録基盤実装（Firestore）
- [ ] Phase 2: 主要操作へのログ挿入
- [ ] Phase 3: ログ閲覧UI実装
- [ ] Phase 4: 検索・フィルタ機能実装
- [ ] Phase 5: リアルタイム監視ダッシュボード

### 📊 技術仕様
**データベース:** Firestore（スプレッドシートより高速・大量データに強い）

**ログ構造例:**
```json
{
  "timestamp": "2025-11-06T13:30:15Z",
  "user": "山田太郎",
  "action": "商品編集",
  "target": "REBORNシャツ (ABC-001)",
  "changes": {
    "price": { "old": 3000, "new": 3500 },
    "stock": { "old": 100, "new": 95 }
  },
  "ip": "192.168.1.1",
  "device": "PWA"
}
```

### 🎯 メリット
- **監査対応**: 誰が何をしたか追跡可能
- **トラブル調査**: データ不整合の原因特定
- **セキュリティ**: 不正操作の検知
- **分析**: よく使われる機能の把握

### 状態
- [ ] ✅ DONE (完了日: )

---

## 🎨 UI改善（UI Improvements）

**現在のUI改善: 3件**

---

## UI-011 | UI改善: 基本設定拡張（Phase 2: 表示・操作系設定）

### 📌 基本情報
- カテゴリ: UI改善
- 優先度: 中
- 影響範囲: 基本設定UI
- 要望日: 2025-11-01
- 前提条件: UI-010完了後

### 💡 要望内容
基本設定にさらに便利な設定項目を追加する（Phase 2）。

### ✅ 期待動作
**追加する設定項目:**
1. 🏠 初期表示画面
   - PWA起動時にどの画面を開くか選択（商品登録、在庫管理、マスタ管理など）
2. 📊 1ページあたりの表示件数
   - テーブル表示時の行数（10件、25件、50件、100件）
3. 📅 日付表示形式
   - YYYY-MM-DD、YYYY/MM/DD、MM/DD/YYYY など
4. ⌨️ キーボードショートカット
   - よく使う操作へのショートカットキー設定

### 📍 関連ファイル
- `sidebar_config.html` - 基本設定UI拡張
- `ユーザー設定`シート - 設定値保存

### ✏️ 実装内容
- [ ] Phase 2-1: 初期表示画面設定
- [ ] Phase 2-2: 1ページあたりの表示件数設定
- [ ] Phase 2-3: 日付表示形式設定
- [ ] Phase 2-4: キーボードショートカット設定
- [ ] Phase 2-5: テスト・デプロイ

### 状態
- [ ] ✅ DONE (完了日: )

---

## UI-012 | UI改善: 基本設定拡張（Phase 3: データ管理系設定）

### 📌 基本情報
- カテゴリ: UI改善
- 優先度: 低
- 影響範囲: 基本設定UI
- 要望日: 2025-11-01
- 前提条件: UI-011完了後

### 💡 要望内容
基本設定にデータ管理関連の設定を追加する（Phase 3）。

### ✅ 期待動作
**追加する設定項目:**
1. 💾 CSVエクスポート文字コード
   - UTF-8（標準）、Shift-JIS（Excel for Windows用）
2. 🔄 自動保存設定
   - 自動保存の有効/無効
   - 自動保存間隔（分）
3. 🗑️ データ保持期間
   - 履歴データの保持期間設定
4. 🌐 表示言語（将来的な多言語対応）

### 📍 関連ファイル
- `sidebar_config.html` - 基本設定UI拡張
- `ユーザー設定`シート - 設定値保存

### ✏️ 実装内容
- [ ] Phase 3-1: CSVエクスポート設定
- [ ] Phase 3-2: 自動保存設定
- [ ] Phase 3-3: データ保持期間設定
- [ ] Phase 3-4: 表示言語設定（将来対応）
- [ ] Phase 3-5: テスト・デプロイ

### 状態
- [ ] ✅ DONE (完了日: )

---

## INV-004-UI | UI改善: 発送方法マスタ管理（プリセット選択式 + カテゴリ別表示）

### 📌 基本情報
- カテゴリ: UI改善
- 優先度: 中
- 影響範囲: 発送方法マスタ管理UI
- 要望日: 2025-10-28

### 💡 要望内容
発送方法マスタ管理UIの使い勝手を改善する。
- フリーテキスト入力 → プリセット選択式
- 登録順表示 → カテゴリ別アコーディオン表示

### 📍 関連ファイル
- `shipping_method_master_ui.html` - UI修正
- `shipping_method_master_manager.js` - バックエンド（修正不要）

### ✏️ 実装内容
- [ ] Phase 1: プリセット選択式UI
- [ ] Phase 2: カテゴリ別アコーディオン表示
- [ ] Phase 3: テスト

### 状態
- [ ] ✅ DONE (完了日: )

---

## INV-004-LOT | 機能追加: 梱包資材ロット管理（FIFO方式）

### 📌 基本情報
- カテゴリ: 機能追加
- 優先度: 高
- 影響範囲: 梱包資材管理、原価計算
- 要望日: 2025-10-28

### 💡 要望内容
梱包資材の入庫ロット（入庫日・単価・残数）を管理し、FIFO方式で正確な原価計算を行う。

### ✅ 期待動作
1. 入庫履歴シート作成（入庫日、略称、入庫数、単価、残数）
2. FIFO方式での出庫処理（古いロットから自動消費）
3. 販売記録時に実際の梱包資材単価を自動適用
4. ロット別残数管理

### 📍 関連ファイル
- `入庫履歴`シート（新規作成）
- `inventory.js` - FIFO出庫処理
- `packaging_materials_manager.js` - 入庫登録

### ✏️ 実装内容
- [ ] Phase 1: データ構造構築
- [ ] Phase 2: FIFO出庫処理
- [ ] Phase 3: 入庫登録UI
- [ ] Phase 4: テスト

### 📌 備考
INV-004テスト完了後に実装開始

### 状態
- [ ] ✅ DONE (完了日: )

---

## INV-004-COL | バグ修正 + UI改善: 梱包資材列不足 + 2段式プルダウン

### 📌 基本情報
- カテゴリ: バグ修正 + UI改善
- 優先度: 高
- 影響範囲: 在庫/売上管理表、販売記録API
- 発見日: 2025-10-28

### 🐛 問題内容
販売記録モーダルで梱包資材を4個以上追加できるが、「在庫/売上管理表」シートには3列までしかないため、4個目以降が保存できない。

### ✅ 期待動作
**バグ修正:**
- 梱包資材を最大5個まで追加・保存可能
- シートに対応する列（梱包資材4,5、梱包費4,5）が存在
- 6個目を追加しようとするとエラー表示

**UI改善:**
- 2段式プルダウン（カテゴリ選択 → 資材選択）
- 梱包資材マスタにカテゴリ列を追加

### 📍 関連ファイル
- スプレッドシート: **在庫/売上管理表**（梱包資材4,5列追加が必要）
- スプレッドシート: **梱包資材マスタ**（カテゴリ列追加が必要）
- `inventory.js` - saveSalesRecordAPI（最大数を5に変更）
- `sidebar_product_ai.html` - 販売記録モーダル

### ✏️ 実装内容
- [ ] Phase 1: シート列追加
- [ ] Phase 2: API修正
- [ ] Phase 3: 2段式プルダウンUI
- [ ] Phase 4: テスト

### 状態
- [ ] ✅ DONE (完了日: )

---

## INV-001 | 機能追加: Phase 1 在庫管理システム実装

### 📌 基本情報
- カテゴリ: 機能追加
- 優先度: 高
- 影響範囲: 在庫管理（新規機能）
- 要望日: 2025-10-24

### 💡 要望内容
Phase 1の在庫管理システムを実装する。
1. 在庫検索・絞り込み機能
2. 商品複製機能
3. 在庫状況ダッシュボード
4. ステータス手動変更
5. 出品前商品の編集
6. 画像差し替え

### 📍 関連ファイル
- `inventory.js` (在庫管理バックエンド)
- `sidebar_inventory.html` (在庫管理UI)

### ✏️ 実装内容
- [x] Phase 1-1: 在庫検索・絞り込み機能
- [x] Phase 1-2: 商品複製機能
- [x] Phase 1-3: 在庫状況ダッシュボード
- [x] Phase 1-4: ステータス手動変更機能
- [x] Phase 1-5: 出品前商品の編集機能
- [ ] Phase 1-6: 画像差し替え機能（Phase 2以降に実施）

### 状態
- [ ] ✅ DONE (完了日: )

---

## 🔧 技術的負債・リファクタリング（Technical Debt）

**現在の技術的負債: 0件**

---

**総Issue数: 7件**
**最終更新: 2025-11-10**

**📌 注記:**
- INV-*, UI-*, LOG-* Issueは保存されていますが、セッション開始時の自動読み込み対象外です
- 次の優先タスク: INV-006（在庫アラート機能）の動作テスト
