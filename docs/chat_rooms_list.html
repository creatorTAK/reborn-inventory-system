<!DOCTYPE html>
<html>
<head>
  <!-- Cache Bust: 2025-12-05-v4 - ã‚¹ãƒ¯ã‚¤ãƒ—UIæ”¹å–„ãƒ»ãƒ”ãƒ³ç•™ã‚æ©Ÿèƒ½è¿½åŠ  -->
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ã‚½ãƒ¼ãƒ«æœ‰åŠ¹åŒ– -->

  <title>ãƒãƒ£ãƒƒãƒˆ</title>
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- REBORN Brand Colors & Theme -->
  <link rel="stylesheet" href="/css/reborn-brand-colors.css?v=0bd1a9b">
  <link rel="stylesheet" href="/css/reborn-theme.css?v=302">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5; /* v325: èƒŒæ™¯ã‚’ç™½ç³»ã«å¤‰æ›´ */
      height: 100vh;
      overflow: hidden;
    }
    .user-info {
      font-size: 13px;
      color: #6b7280;
      padding: 8px 16px;
      background: #f8f9fa;
      border-bottom: 1px solid #e5e7eb;
    }
    .buttons-container {
      display: flex;
      gap: 12px;
      padding: 0 16px;
      margin: 16px 0;
    }
    .create-room-button {
      background: var(--reborn-primary);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      flex: 1;
    }
    .create-room-button.orange {
      background: var(--reborn-accent);
      box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
    }
    .create-room-button.green {
      background: #48bb78;
      box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
    }
    .create-room-button:active {
      transform: scale(0.98);
    }
    .create-room-button.orange:active {
      box-shadow: 0 2px 6px rgba(255, 107, 53, 0.3);
    }
    .create-room-button.green:active {
      box-shadow: 0 2px 6px rgba(72, 187, 120, 0.3);
    }
    .rooms-container {
      height: calc(100vh - 180px); /* v326: æ¤œç´¢ãƒãƒ¼åˆ†ã‚’è€ƒæ…® */
      overflow-y: auto;
      padding: 8px 16px;
      background: rgba(224, 242, 254, 0.8); /* v326: è–„ã„æ°´è‰²èƒŒæ™¯ */
      margin: 0 16px 16px 16px;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    /* ãƒ˜ãƒ«ãƒ—é¢¨ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .page-header {
      background: linear-gradient(135deg, var(--reborn-primary, #40B4E5) 0%, var(--reborn-primary-dark, #1E8FBF) 100%);
      padding: 28px 20px;
      color: white;
      text-align: center;
      position: relative;
    }
    .page-header h1 {
      font-size: 22px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .page-header h1 i {
      font-size: 22px;
    }
    .back-button {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      left: 16px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      width: 42px;
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: white;
      font-size: 20px;
    }
    .back-button:active {
      background: rgba(255, 255, 255, 0.3);
    }
    .menu-button {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      right: 16px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      width: 42px;
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: white;
      font-size: 20px;
    }
    .menu-button:active {
      background: rgba(255, 255, 255, 0.3);
    }
    .search-bar {
      display: flex;
      align-items: center;
      background: #e5e7eb; /* v326: ã‚ˆã‚Šæ¿ƒã„ã‚°ãƒ¬ãƒ¼ã§è¦–èªæ€§å‘ä¸Š */
      border-radius: 12px;
      padding: 12px 14px;
      gap: 10px;
    }
    .search-bar i {
      color: #9ca3af;
      font-size: 16px;
    }
    .search-bar input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 16px; /* iOSã‚ºãƒ¼ãƒ é˜²æ­¢ã®ãŸã‚16pxä»¥ä¸Šå¿…é ˆ */
      color: #1f2937;
      outline: none;
    }
    .search-bar input::placeholder {
      color: #9ca3af;
    }
    .search-bar .clear-btn {
      display: none;
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      padding: 0;
      font-size: 16px;
    }
    .search-bar .clear-btn.show {
      display: block;
    }
    .room-item-wrapper {
      position: relative;
      margin-bottom: 12px;
      overflow: hidden;
      border-radius: 12px;
    }
    .room-item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      cursor: pointer;
      transition: transform 0.3s ease;
      display: flex;
      gap: 12px;
      align-items: center;
      position: relative;
      z-index: 2;
    }
    .room-item.swiping {
      transition: none;
    }
    .room-item:active:not(.swiping) {
      transform: scale(0.98);
      background: #f7fafc;
    }

    /* ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIï¼ˆãƒ«ãƒ¼ãƒ ã‚¿ãƒƒãƒ—æ™‚ã«å…¨ç”»é¢è¡¨ç¤ºï¼‰ */
    #skeleton-loader {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: rgba(255, 255, 255, 0.95);
      z-index: 9999;
      padding: 20px;
      overflow: hidden;
    }

    #skeleton-loader.active {
      display: block;
    }

    .skeleton-header {
      width: 100%;
      height: 60px;
      background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
      background-size: 200% 100%;
      animation: skeleton-pulse 1.5s ease-in-out infinite;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .skeleton-room {
      width: 100%;
      height: 80px;
      background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
      background-size: 200% 100%;
      animation: skeleton-pulse 1.5s ease-in-out infinite;
      border-radius: 12px;
      margin-bottom: 12px;
    }

    .loading-spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 48px;
      height: 48px;
      border: 4px solid #e0e0e0;
      border-top: 4px solid var(--reborn-primary);
      border-radius: 50%;
      animation: spinner-rotate 1s linear infinite;
      z-index: 10;
    }

    @keyframes skeleton-pulse {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    @keyframes spinner-rotate {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    .swipe-buttons {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      display: flex;
      z-index: 1;
    }
    /* å³å´ãƒœã‚¿ãƒ³: éè¡¨ç¤º + å‰Šé™¤ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰ */
    .hide-button {
      width: 70px;
      background: #6b7280;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .hide-button:active {
      background: #4b5563;
    }
    .delete-button {
      width: 70px;
      background: #ef4444;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .delete-button:active {
      background: #dc2626;
    }
    /* å·¦å´ãƒœã‚¿ãƒ³: ãƒŸãƒ¥ãƒ¼ãƒˆ + ãƒ”ãƒ³ç•™ã‚ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ï¼‰ */
    .swipe-buttons-left {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      display: flex;
      z-index: 1;
    }
    .mute-button {
      width: 70px;
      background: #f59e0b;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .mute-button:active {
      background: #d97706;
    }
    .pin-button {
      width: 70px;
      background: #3b82f6;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .pin-button:active {
      background: #2563eb;
    }
    .room-icon {
      font-size: 32px;
      flex-shrink: 0;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      color: white;
      overflow: hidden;
    }
    .room-icon.has-emoji {
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
    }
    .room-content {
      flex: 1;
      min-width: 0;
    }
    .room-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 4px;
    }
    .room-name {
      font-size: 16px;
      font-weight: 600;
      color: #2d3748;
      flex: 1;
    }
    .room-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }
    .room-time {
      font-size: 12px;
      color: #a0aec0;
    }
    .room-preview {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .room-last-message {
      font-size: 14px;
      color: #718096;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
    }
    .unread-badge {
      background: #ef4444;
      color: white;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 600;
      min-width: 20px;
      text-align: center;
      display: inline-block;
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #718096;
    }
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }
    .empty-state-text {
      font-size: 16px;
      margin-bottom: 8px;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #718096;
    }
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }
    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 20px;
    }
    .menu-option-button {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      text-align: left;
    }
    .menu-option-button:hover {
      border-color: var(--reborn-accent);
      background: #fffaf5;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 107, 53, 0.1);
    }
    .menu-option-button:active {
      transform: translateY(0);
    }
    .menu-option-icon {
      font-size: 32px;
      flex-shrink: 0;
    }
    .menu-option-content {
      flex: 1;
    }
    .menu-option-title {
      font-size: 16px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 4px;
    }
    .menu-option-desc {
      font-size: 13px;
      color: #718096;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 8px;
    }
    .form-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--reborn-primary);
    }
    .form-select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      background: white;
      cursor: pointer;
    }
    /* çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ« */
    .emoji-picker-button {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: border-color 0.2s;
    }
    .emoji-picker-button:hover {
      border-color: var(--reborn-primary);
    }
    .emoji-picker-button .selected-emoji {
      font-size: 24px;
    }
    .emoji-picker-button .button-text {
      color: #4a5568;
      flex: 1;
      text-align: left;
    }
    .emoji-picker-button .change-icon {
      color: #a0aec0;
      font-size: 14px;
    }
    .emoji-picker-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .emoji-picker-modal.active {
      display: flex;
    }
    .emoji-picker-content {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 360px;
      max-height: 70vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }
    .emoji-picker-header {
      padding: 16px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .emoji-picker-header h3 {
      margin: 0;
      font-size: 18px;
      color: #2d3748;
    }
    .emoji-picker-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #a0aec0;
      padding: 4px;
    }
    .emoji-categories {
      display: flex;
      gap: 4px;
      padding: 12px;
      border-bottom: 1px solid #e2e8f0;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      flex-shrink: 0;
      min-height: 48px;
      width: 100%;
      box-sizing: border-box;
    }
    .emoji-category-btn {
      background: none;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
      color: #718096;
      transition: all 0.2s;
    }
    .emoji-category-btn.active {
      background: #1E8FBF !important;
      color: #ffffff !important;
      font-weight: 600;
    }
    .emoji-grid-container {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
    }
    .emoji-item {
      font-size: 24px;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: background 0.2s;
    }
    .emoji-item:hover {
      background: #edf2f7;
    }
    .emoji-item:active {
      background: #e2e8f0;
      transform: scale(0.95);
    }
    /* ãƒ¡ãƒ³ãƒãƒ¼æ¤œç´¢ã‚¹ã‚¿ã‚¤ãƒ« */
    .member-search-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .member-search-input {
      flex: 1;
      padding: 10px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px; /* iOSè‡ªå‹•ã‚ºãƒ¼ãƒ é˜²æ­¢ã®ãŸã‚16pxä»¥ä¸Šå¿…é ˆ */
      transition: border-color 0.2s;
    }
    .member-search-input:focus {
      outline: none;
      border-color: var(--reborn-primary);
    }
    .member-search-input::placeholder {
      color: #a0aec0;
    }
    .member-count {
      font-size: 12px;
      color: #718096;
      white-space: nowrap;
    }
    .no-results {
      text-align: center;
      padding: 20px;
      color: #718096;
    }
    .no-results-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    .no-results-text {
      font-size: 14px;
    }
    .modal-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    .modal-button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .modal-button.primary {
      background: var(--reborn-primary);
      color: white;
    }
    .modal-button.primary:hover {
      background: #5568d3;
    }
    .modal-button.secondary {
      background: #e2e8f0;
      color: #4a5568;
    }
    .modal-button.secondary:hover {
      background: #cbd5e0;
    }
    .user-list-item {
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .user-list-item:hover {
      border-color: #48bb78;
      background: #f0fff4;
    }
    .user-list-item:active {
      transform: scale(0.98);
    }
    .user-list-item-checkbox {
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .user-list-item-checkbox:hover {
      border-color: var(--reborn-primary);
      background: #f7fafc;
    }
    .user-list-item-checkbox.selected {
      border-color: var(--reborn-primary);
      background: #ebf4ff;
    }
    .user-checkbox {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      cursor: pointer;
    }
    .user-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .user-icon img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #e2e8f0;
    }
    .user-icon-placeholder {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 600;
      flex-shrink: 0;
      border: 2px solid #e2e8f0;
    }
    .user-info {
      flex: 1;
      min-width: 0;
    }
    .user-name {
      font-size: 16px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 4px;
    }
    .user-permission {
      font-size: 12px;
      color: #718096;
    }
    /* æ¤œç´¢ãƒœã‚¿ãƒ³ï¼ˆé€šå¸¸ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰- chat_ui_firestore.htmlã¨çµ±ä¸€ */
    .search-button {
      width: 40px;
      height: 40px;
      border: none;
      background: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.2s;
      color: #374151;
      font-size: 18px;
    }
    .search-button:hover {
      background: #f3f4f6;
    }
    .search-button:active {
      background: #e5e7eb;
    }
    /* æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ç”¨ãƒ˜ãƒƒãƒ€ãƒ¼ - chat_ui_firestore.htmlã¨çµ±ä¸€ */
    .header-search-mode {
      display: none !important;
    }
    .header-search-mode.active {
      display: flex !important;
      align-items: center;
      gap: 8px;
    }
    .header-content.hidden {
      display: none !important;
    }
    /* æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ç”¨æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
    .header-search-mode .back-button {
      background: transparent;
      color: #374151;
    }
    /* æ¤œç´¢å…¥åŠ›ã‚³ãƒ³ãƒ†ãƒŠ */
    .search-input-container {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
    }
    .search-input {
      width: 100%;
      height: 36px;
      border: none;
      border-radius: 8px;
      padding: 0 12px;
      font-size: 16px;
      background: #f3f4f6;
      color: #1f2937;
    }
    .search-input:focus {
      outline: none;
    }
    .search-input::placeholder {
      color: #9ca3af;
    }
    /* æ¤œç´¢é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ */
    .search-close-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #6b7280;
      font-size: 20px;
      margin-left: 4px;
      flex-shrink: 0;
    }
    .search-close-btn:active {
      color: #374151;
    }
    /* æ¤œç´¢çµæœãƒ•ã‚£ãƒ«ã‚¿ */
    .room-item-wrapper.search-hidden {
      display: none !important;
    }
    /* æ¤œç´¢ãƒã‚¤ãƒ©ã‚¤ãƒˆ - chat_ui_firestore.htmlã¨çµ±ä¸€ï¼ˆé»„è‰²ï¼‰ */
    .search-highlight {
      background: #fef08a;
      padding: 1px 2px;
      border-radius: 2px;
    }
  </style>
</head>
<body>
  <!-- ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIï¼ˆãƒ«ãƒ¼ãƒ ã‚¿ãƒƒãƒ—æ™‚ã«å…¨ç”»é¢è¡¨ç¤ºï¼‰ -->
  <div id="skeleton-loader">
    <div class="skeleton-header"></div>
    <div class="skeleton-room"></div>
    <div class="skeleton-room"></div>
    <div class="skeleton-room"></div>
    <div class="skeleton-room"></div>
    <div class="skeleton-room"></div>
    <div class="loading-spinner"></div>
  </div>

  <!-- ãƒ˜ãƒ«ãƒ—é¢¨ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="page-header">
    <button class="back-button" id="back-button" title="æˆ»ã‚‹">
      <i class="bi bi-chevron-left"></i>
    </button>
    <h1><i class="bi bi-chat"></i> ãƒãƒ£ãƒƒãƒˆ</h1>
    <button class="menu-button" onclick="window.parent.postMessage({type:'toggleDrawer'}, '*')" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
      <i class="bi bi-list"></i>
    </button>
  </div>

  <!-- v326: æ¤œç´¢ãƒãƒ¼ï¼ˆã‚°ãƒ¬ãƒ¼èƒŒæ™¯ã®ã¿ã€ç™½ã‚³ãƒ³ãƒ†ãƒŠå‰Šé™¤ï¼‰ -->
  <div class="search-bar" style="margin: 12px 16px;">
    <i class="bi bi-search"></i>
    <input type="text" id="searchInput" placeholder="ãƒ«ãƒ¼ãƒ åãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§æ¤œç´¢" oninput="performSearchNew()" />
    <button class="clear-btn" id="searchClearBtn" onclick="clearSearch()">
      <i class="bi bi-x-circle-fill"></i>
    </button>
  </div>

  <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãƒãƒ¼ï¼ˆéè¡¨ç¤ºï¼‰ -->
  <div class="user-info" id="userInfo" style="display: none;">èª­ã¿è¾¼ã¿ä¸­...</div>

  <!-- ãƒãƒ£ãƒƒãƒˆä½œæˆãƒœã‚¿ãƒ³ -->
  <button class="create-room-button orange" id="createChatButton" onclick="openChatTypeMenu()" style="margin: 12px 16px;">
    â• ãƒãƒ£ãƒƒãƒˆä½œæˆ
  </button>

  <div class="rooms-container" id="roomsContainer">
    <div class="loading">ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
  </div>

  <!-- ãƒãƒ£ãƒƒãƒˆã‚¿ã‚¤ãƒ—é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="chatTypeMenuModal">
    <div class="modal-content">
      <div class="modal-title">â• ãƒãƒ£ãƒƒãƒˆä½œæˆ</div>
      <div style="margin-bottom: 16px; font-size: 14px; color: #718096;">
        ä½œæˆã™ã‚‹ãƒãƒ£ãƒƒãƒˆã®ç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„
      </div>
      <div style="display: flex; flex-direction: column; gap: 12px;">
        <button class="menu-option-button" onclick="selectChatType('room')">
          <div class="menu-option-icon">ğŸ’¬</div>
          <div class="menu-option-content">
            <div class="menu-option-title">æ–°è¦ãƒ«ãƒ¼ãƒ ä½œæˆ</div>
            <div class="menu-option-desc">è¤‡æ•°äººã§ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆ</div>
          </div>
        </button>
        <button class="menu-option-button" onclick="selectChatType('direct')">
          <div class="menu-option-icon">ğŸ‘¤</div>
          <div class="menu-option-content">
            <div class="menu-option-title">å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆ</div>
            <div class="menu-option-desc">1å¯¾1ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ£ãƒƒãƒˆ</div>
          </div>
        </button>
      </div>
      <div class="modal-buttons" style="margin-top: 20px;">
        <button type="button" class="modal-button secondary" onclick="closeChatTypeMenu()">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
      </div>
    </div>
  </div>

  <!-- ãƒ«ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="createRoomModal">
    <div class="modal-content">
      <div class="modal-title">â• æ–°è¦ãƒ«ãƒ¼ãƒ ä½œæˆ</div>
      <form id="createRoomForm" onsubmit="return false;">
        <div class="form-group">
          <label class="form-label" for="roomNameInput">ãƒ«ãƒ¼ãƒ å *</label>
          <input
            type="text"
            class="form-input"
            id="roomNameInput"
            placeholder="ä¾‹: å•†å“ä¼ç”»ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°"
            maxlength="50"
            required
          />
        </div>
        <div class="form-group">
          <label class="form-label">ã‚¢ã‚¤ã‚³ãƒ³</label>
          <input type="hidden" id="roomIconSelect" value="ğŸ’¬">
          <button type="button" class="emoji-picker-button" onclick="openEmojiPicker()">
            <span class="selected-emoji" id="selectedEmojiPreview">ğŸ’¬</span>
            <span class="button-text">ã‚¿ãƒƒãƒ—ã—ã¦çµµæ–‡å­—ã‚’é¸æŠ</span>
            <span class="change-icon">â–¼</span>
          </button>
        </div>

        <!-- ãƒ¡ãƒ³ãƒãƒ¼é¸æŠ -->
        <div class="form-group">
          <label class="form-label">ãƒ¡ãƒ³ãƒãƒ¼é¸æŠ *</label>
          <div style="margin-bottom: 8px; font-size: 14px; color: #718096;">
            ã‚°ãƒ«ãƒ¼ãƒ—ã«å‚åŠ ã™ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰
          </div>
          <div class="member-search-container">
            <input type="text" class="member-search-input" id="memberSearchInput" placeholder="ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§æ¤œç´¢..." oninput="filterGroupMembers(this.value)">
            <span class="member-count" id="memberCount"></span>
          </div>
          <div id="groupMemberListContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 8px;">
            <div class="loading">ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
          </div>
        </div>

        <div class="modal-buttons">
          <button type="button" class="modal-button secondary" onclick="closeCreateRoomModal()">
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button type="submit" class="modal-button primary" onclick="submitCreateRoom()">
            ä½œæˆ
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="directChatModal">
    <div class="modal-content">
      <div class="modal-title">ğŸ‘¤ å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆä½œæˆ</div>
      <div style="margin-bottom: 16px; font-size: 14px; color: #718096;">
        ãƒãƒ£ãƒƒãƒˆã—ãŸã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„
      </div>
      
      <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ -->
      <div id="userListContainer" style="max-height: 400px; overflow-y: auto; margin-bottom: 16px;">
        <div class="loading">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
      </div>

      <div class="modal-buttons">
        <button type="button" class="modal-button secondary" onclick="closeDirectChatModal()">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
      </div>
    </div>
  </div>

  <!-- çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="emoji-picker-modal" id="emojiPickerModal">
    <div class="emoji-picker-content">
      <div class="emoji-picker-header">
        <h3>ğŸ¨ ã‚¢ã‚¤ã‚³ãƒ³ã‚’é¸æŠ</h3>
        <button class="emoji-picker-close" onclick="closeEmojiPicker()">Ã—</button>
      </div>
      <div class="emoji-categories" id="emojiCategories">
        <!-- ã‚«ãƒ†ã‚´ãƒªãƒœã‚¿ãƒ³ã¯JSã§ç”Ÿæˆ -->
      </div>
      <div class="emoji-grid-container">
        <div class="emoji-grid" id="emojiGrid">
          <!-- çµµæ–‡å­—ã¯JSã§ç”Ÿæˆ -->
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK: ç›´æ¥CDNã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆå¤–éƒ¨JSãƒ•ã‚¡ã‚¤ãƒ«ä¸è¦ï¼‰ -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, doc, query, orderBy, onSnapshot, addDoc, serverTimestamp, getDocs, where, setDoc, deleteDoc, updateDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebaseè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "furira.jp",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    // FirebaseåˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    console.log('[Firestore] åˆæœŸåŒ–å®Œäº†');

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function getQueryParam(key) {
      try {
        return new URLSearchParams(location.search).get(key) || '';
      } catch(e) {
        return '';
      }
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let currentUserName = '';
    let currentUserEmail = '';
    let usersCache = []; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    let unsubscribeRooms = null; // Firestoreãƒªã‚¹ãƒŠãƒ¼ã®è§£é™¤ç”¨

    // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.debugUsersCache = () => {
      console.log('[DEBUG] usersCache:', usersCache);
      console.log('[DEBUG] usersCache length:', usersCache?.length);
      console.log('[DEBUG] isPWA:', isPWA);
      console.log('[DEBUG] currentUserName:', currentUserName);
      console.log('[DEBUG] currentUserEmail:', currentUserEmail);
    };

    // ================================================================================
    // çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼æ©Ÿèƒ½
    // ================================================================================
    const emojiCategories = {
      'ã‚ˆãä½¿ã†': ['ğŸ’¬', 'ğŸ“¢', 'ğŸ’¡', 'ğŸ“Š', 'ğŸ¯', 'ğŸ“¦', 'ğŸš€', 'ğŸ”§', 'ğŸ‰', 'â­', 'â¤ï¸', 'ğŸ‘', 'âœ…', 'ğŸ“', 'ğŸ“Œ', 'ğŸ””', 'ğŸ’¼', 'ğŸ“', 'ğŸ ', 'ğŸ›’', 'ğŸ', 'ğŸ’°', 'ğŸ†', 'ğŸª', 'ğŸ¬', 'ğŸ“¸', 'ğŸµ', 'ğŸ¤', 'ğŸ’', 'ğŸ‘‘', 'ğŸŒˆ', 'ğŸ”¥', 'âš¡', 'âœ¨', 'ğŸ’¯', 'ğŸ‘¤', 'ğŸ‘¥', 'ğŸ†•', 'ğŸ†—', 'ğŸ†™', 'ğŸ”´', 'ğŸŸ ', 'ğŸŸ¡', 'ğŸŸ¢', 'ğŸ”µ', 'ğŸŸ£', 'âšª', 'âš«', 'ğŸŸ¤', 'ğŸ”¶', 'ğŸ”·', 'ğŸ”¸', 'ğŸ”¹'],
      'é¡”ãƒ»æ„Ÿæƒ…': ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜˜', 'ğŸ˜—', 'â˜ºï¸', 'ğŸ˜š', 'ğŸ˜™', 'ğŸ¥²', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ¤‘', 'ğŸ¤—', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤”', 'ğŸ¤', 'ğŸ¤¨', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜’', 'ğŸ™„', 'ğŸ˜¬', 'ğŸ¤¥', 'ğŸ˜Œ', 'ğŸ˜”', 'ğŸ˜ª', 'ğŸ¤¤', 'ğŸ˜´', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ¥´', 'ğŸ˜µ', 'ğŸ¤¯', 'ğŸ¤ ', 'ğŸ¥³', 'ğŸ¥¸', 'ğŸ˜', 'ğŸ¤“', 'ğŸ§', 'ğŸ˜•', 'ğŸ˜Ÿ', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜®', 'ğŸ˜¯', 'ğŸ˜²', 'ğŸ˜³', 'ğŸ¥º', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜±', 'ğŸ˜–', 'ğŸ˜£', 'ğŸ˜', 'ğŸ˜“', 'ğŸ˜©', 'ğŸ˜«', 'ğŸ¥±', 'ğŸ˜¤', 'ğŸ˜¡', 'ğŸ˜ ', 'ğŸ¤¬', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ’€', 'â˜ ï¸', 'ğŸ’©', 'ğŸ¤¡', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ‘»', 'ğŸ‘½', 'ğŸ‘¾', 'ğŸ¤–'],
      'äººãƒ»æ‰‹': ['ğŸ‘¤', 'ğŸ‘¥', 'ğŸ‘‹', 'ğŸ¤š', 'ğŸ–ï¸', 'âœ‹', 'ğŸ––', 'ğŸ‘Œ', 'ğŸ¤Œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ–•', 'ğŸ‘‡', 'â˜ï¸', 'ğŸ‘', 'ğŸ‘', 'âœŠ', 'ğŸ‘Š', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™', 'âœï¸', 'ğŸ’…', 'ğŸ¤³', 'ğŸ’ª', 'ğŸ¦¾', 'ğŸ¦¿', 'ğŸ¦µ', 'ğŸ¦¶', 'ğŸ‘‚', 'ğŸ¦»', 'ğŸ‘ƒ', 'ğŸ§ ', 'ğŸ«€', 'ğŸ«', 'ğŸ¦·', 'ğŸ¦´', 'ğŸ‘€', 'ğŸ‘ï¸', 'ğŸ‘…', 'ğŸ‘„', 'ğŸ‘¶', 'ğŸ§’', 'ğŸ‘¦', 'ğŸ‘§', 'ğŸ§‘', 'ğŸ‘±', 'ğŸ‘¨', 'ğŸ§”', 'ğŸ‘©', 'ğŸ§“', 'ğŸ‘´', 'ğŸ‘µ', 'ğŸ™', 'ğŸ™', 'ğŸ™…', 'ğŸ™†', 'ğŸ’', 'ğŸ™‹', 'ğŸ§', 'ğŸ™‡', 'ğŸ¤¦', 'ğŸ¤·', 'ğŸ‘®', 'ğŸ•µï¸', 'ğŸ’‚', 'ğŸ¥·', 'ğŸ‘·', 'ğŸ¤´', 'ğŸ‘¸', 'ğŸ‘³', 'ğŸ‘²', 'ğŸ§•', 'ğŸ¤µ', 'ğŸ‘°', 'ğŸ¤°', 'ğŸ¤±', 'ğŸ‘¼', 'ğŸ…', 'ğŸ¤¶', 'ğŸ¦¸', 'ğŸ¦¹', 'ğŸ§™', 'ğŸ§š', 'ğŸ§›', 'ğŸ§œ', 'ğŸ§', 'ğŸ§', 'ğŸ§Ÿ', 'ğŸ’†', 'ğŸ’‡', 'ğŸš¶', 'ğŸ§', 'ğŸ§', 'ğŸƒ', 'ğŸ’ƒ', 'ğŸ•º', 'ğŸ‘¯', 'ğŸ§–', 'ğŸ§—', 'ğŸ¤¸', 'ğŸŒï¸', 'ğŸ‡', 'â›·ï¸', 'ğŸ‚', 'ğŸ‹ï¸', 'ğŸ¤¼', 'ğŸ¤½', 'ğŸ¤¾', 'ğŸ¤º', 'â›¹ï¸', 'ğŸš´', 'ğŸšµ', 'ğŸŠ', 'ğŸ§˜', 'ğŸ›€', 'ğŸ›Œ', 'ğŸ‘­', 'ğŸ‘«', 'ğŸ‘¬', 'ğŸ’', 'ğŸ’‘', 'ğŸ‘ª', 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦', 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§', 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦', 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦â€ğŸ‘¦', 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘§'],
      'ä»•äº‹': ['ğŸ’¼', 'ğŸ“Š', 'ğŸ“ˆ', 'ğŸ“‰', 'ğŸ’¹', 'ğŸ—‚ï¸', 'ğŸ“‹', 'ğŸ“', 'ğŸ“‚', 'ğŸ—ƒï¸', 'ğŸ—„ï¸', 'ğŸ“‘', 'ğŸ—’ï¸', 'ğŸ““', 'ğŸ“”', 'ğŸ“’', 'ğŸ“•', 'ğŸ“—', 'ğŸ“˜', 'ğŸ“™', 'ğŸ“š', 'ğŸ“–', 'ğŸ”–', 'ğŸ“', 'ğŸ–‡ï¸', 'ğŸ“', 'ğŸ“', 'ğŸ§®', 'ğŸ“Œ', 'ğŸ“', 'âœ‚ï¸', 'ğŸ–Šï¸', 'ğŸ–‹ï¸', 'âœ’ï¸', 'ğŸ–Œï¸', 'ğŸ–ï¸', 'ğŸ“', 'âœï¸', 'ğŸ”', 'ğŸ”', 'ğŸ”', 'ğŸ”', 'ğŸ”’', 'ğŸ”“', 'ğŸ’°', 'ğŸ’´', 'ğŸ’µ', 'ğŸ’¶', 'ğŸ’·', 'ğŸ’¸', 'ğŸ’³', 'ğŸ§¾', 'ğŸ¦', 'ğŸ¢', 'ğŸ£', 'ğŸ¤', 'ğŸ¥', 'ğŸ¨', 'ğŸ©', 'ğŸª', 'ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ¯', 'ğŸ°', 'ğŸ—¼', 'ğŸ—½', 'â›ª', 'ğŸ•Œ', 'ğŸ›•', 'ğŸ•', 'â›©ï¸', 'ğŸ•‹', 'ğŸ–¥ï¸', 'ğŸ–¨ï¸', 'âŒ¨ï¸', 'ğŸ–±ï¸', 'ğŸ–²ï¸', 'ğŸ’½', 'ğŸ’¾', 'ğŸ’¿', 'ğŸ“€'],
      'é€šä¿¡': ['ğŸ’¬', 'ğŸ’­', 'ğŸ—¨ï¸', 'ğŸ—¯ï¸', 'ğŸ“¢', 'ğŸ“£', 'ğŸ“¯', 'ğŸ””', 'ğŸ”•', 'ğŸ“±', 'ğŸ“²', 'â˜ï¸', 'ğŸ“', 'ğŸ“Ÿ', 'ğŸ“ ', 'âœ‰ï¸', 'ğŸ“§', 'ğŸ“¨', 'ğŸ“©', 'ğŸ“¤', 'ğŸ“¥', 'ğŸ“¦', 'ğŸ“«', 'ğŸ“ª', 'ğŸ“¬', 'ğŸ“­', 'ğŸ“®', 'ğŸ—³ï¸', 'ğŸ“', 'ğŸ’Œ', 'ğŸ“ƒ', 'ğŸ“„', 'ğŸ“œ', 'ğŸ“°', 'ğŸ—ï¸', 'ğŸ“‘', 'ğŸ”—', 'ğŸ–¥ï¸', 'ğŸ–¨ï¸', 'âŒ¨ï¸', 'ğŸ–±ï¸', 'ğŸ–²ï¸', 'ğŸ’½', 'ğŸ’¾', 'ğŸ’¿', 'ğŸ“€', 'ğŸ¥', 'ğŸï¸', 'ğŸ“½ï¸', 'ğŸ¬', 'ğŸ“º', 'ğŸ“·', 'ğŸ“¸', 'ğŸ“¹', 'ğŸ“¼', 'ğŸ”', 'ğŸ”', 'ğŸ•¯ï¸', 'ğŸ’¡', 'ğŸ”¦', 'ğŸ®', 'ğŸª”', 'ğŸ“»', 'ğŸ™ï¸', 'ğŸšï¸', 'ğŸ›ï¸', 'ğŸ§­', 'â±ï¸', 'â²ï¸', 'â°', 'ğŸ•°ï¸', 'âŒ›', 'â³'],
      'ãƒ„ãƒ¼ãƒ«': ['ğŸ”§', 'ğŸ”¨', 'âš’ï¸', 'ğŸ› ï¸', 'âš™ï¸', 'ğŸ”©', 'ğŸ—œï¸', 'â›ï¸', 'ğŸ”—', 'â›“ï¸', 'ğŸ§°', 'ğŸ”', 'ğŸ”‘', 'ğŸ—ï¸', 'ğŸ”’', 'ğŸ”“', 'ğŸ›¡ï¸', 'âš”ï¸', 'ğŸ—¡ï¸', 'ğŸª“', 'ğŸ§²', 'ğŸªš', 'ğŸ”ª', 'ğŸ—ƒï¸', 'ğŸ—„ï¸', 'ğŸ—‘ï¸', 'ğŸ§±', 'ğŸª¨', 'ğŸªµ', 'ğŸ§³', 'ğŸŒ¡ï¸', 'ğŸ§ª', 'ğŸ§«', 'ğŸ§¬', 'ğŸ”¬', 'ğŸ”­', 'ğŸ“¡', 'ğŸ’‰', 'ğŸ©¸', 'ğŸ’Š', 'ğŸ©¹', 'ğŸ©º', 'ğŸšª', 'ğŸ›—', 'ğŸª', 'ğŸªŸ', 'ğŸ›ï¸', 'ğŸ›‹ï¸', 'ğŸª‘', 'ğŸš½', 'ğŸª ', 'ğŸš¿', 'ğŸ›', 'ğŸª¤', 'ğŸª’', 'ğŸ§´', 'ğŸ§·', 'ğŸ§¹', 'ğŸ§º', 'ğŸ§»', 'ğŸª£', 'ğŸ§¼', 'ğŸª¥', 'ğŸ§½', 'ğŸ§¯', 'ğŸ›’', 'ğŸš¬', 'âš°ï¸', 'ğŸª¦', 'âš±ï¸', 'ğŸ—¿', 'ğŸª§', 'ğŸ§', 'ğŸªœ', 'ğŸª', 'ğŸ§²', 'âš—ï¸', 'ğŸ”‹', 'ğŸ”Œ', 'ğŸ’»', 'ğŸ–¥ï¸', 'ğŸ–¨ï¸', 'âŒ¨ï¸', 'ğŸ–±ï¸', 'ğŸ–²ï¸'],
      'ã‚·ãƒ³ãƒœãƒ«': ['â­', 'ğŸŒŸ', 'âœ¨', 'ğŸ’«', 'âš¡', 'ğŸ”¥', 'ğŸ’¥', 'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ¤', 'ğŸ–¤', 'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’', 'ğŸ’˜', 'ğŸ’Ÿ', 'â˜®ï¸', 'âœï¸', 'â˜ªï¸', 'ğŸ•‰ï¸', 'â˜¸ï¸', 'âœ¡ï¸', 'ğŸ”¯', 'ğŸ•', 'â˜¯ï¸', 'â˜¦ï¸', 'ğŸ›', 'â›', 'â™ˆ', 'â™‰', 'â™Š', 'â™‹', 'â™Œ', 'â™', 'â™', 'â™', 'â™', 'â™‘', 'â™’', 'â™“', 'ğŸ†”', 'âš›ï¸', 'â˜¢ï¸', 'â˜£ï¸', 'ğŸ“´', 'ğŸ“³', 'âœ´ï¸', 'ğŸ†š', 'ğŸ’®', 'ğŸ‰', 'ãŠ™ï¸', 'ãŠ—ï¸', 'ğŸˆ´', 'ğŸˆµ', 'ğŸˆ¹', 'ğŸˆ²', 'ğŸ…°ï¸', 'ğŸ…±ï¸', 'ğŸ†', 'ğŸ†‘', 'ğŸ…¾ï¸', 'ğŸ†˜', 'âŒ', 'â­•', 'ğŸ›‘', 'â›”', 'ğŸ“›', 'ğŸš«', 'ğŸ’¯', 'ğŸ’¢', 'â™¨ï¸', 'ğŸš·', 'ğŸš¯', 'ğŸš³', 'ğŸš±', 'ğŸ”', 'ğŸ“µ', 'ğŸš­', 'â—', 'â•', 'â“', 'â”', 'â€¼ï¸', 'â‰ï¸', 'ğŸ”…', 'ğŸ”†', 'ã€½ï¸', 'âš ï¸', 'ğŸš¸', 'ğŸ”±', 'âšœï¸', 'ğŸ”°', 'â™»ï¸', 'âœ…', 'ğŸ’¹', 'â‡ï¸', 'âœ³ï¸', 'â', 'ğŸŒ', 'ğŸ’ ', 'â“‚ï¸', 'ğŸŒ€', 'ğŸ’¤', 'ğŸ”´', 'ğŸŸ ', 'ğŸŸ¡', 'ğŸŸ¢', 'ğŸ”µ', 'ğŸŸ£', 'ğŸŸ¤', 'âš«', 'âšª', 'ğŸŸ¥', 'ğŸŸ§', 'ğŸŸ¨', 'ğŸŸ©', 'ğŸŸ¦', 'ğŸŸª', 'ğŸŸ«', 'â¬›', 'â¬œ', 'â—¼ï¸', 'â—»ï¸', 'â—¾', 'â—½', 'â–ªï¸', 'â–«ï¸', 'ğŸ”¶', 'ğŸ”·', 'ğŸ”¸', 'ğŸ”¹', 'ğŸ”º', 'ğŸ”»', 'ğŸ’ ', 'ğŸ”˜', 'ğŸ”³', 'ğŸ”²'],
      'å‹•ç‰©': ['ğŸ¶', 'ğŸ•', 'ğŸ¦®', 'ğŸ•â€ğŸ¦º', 'ğŸ©', 'ğŸº', 'ğŸ¦Š', 'ğŸ¦', 'ğŸ±', 'ğŸˆ', 'ğŸˆâ€â¬›', 'ğŸ¦', 'ğŸ¯', 'ğŸ…', 'ğŸ†', 'ğŸ´', 'ğŸ', 'ğŸ¦„', 'ğŸ¦“', 'ğŸ¦Œ', 'ğŸ¦¬', 'ğŸ®', 'ğŸ‚', 'ğŸƒ', 'ğŸ„', 'ğŸ·', 'ğŸ–', 'ğŸ—', 'ğŸ½', 'ğŸ', 'ğŸ‘', 'ğŸ', 'ğŸª', 'ğŸ«', 'ğŸ¦™', 'ğŸ¦’', 'ğŸ˜', 'ğŸ¦£', 'ğŸ¦', 'ğŸ¦›', 'ğŸ­', 'ğŸ', 'ğŸ€', 'ğŸ¹', 'ğŸ°', 'ğŸ‡', 'ğŸ¿ï¸', 'ğŸ¦«', 'ğŸ¦”', 'ğŸ¦‡', 'ğŸ»', 'ğŸ»â€â„ï¸', 'ğŸ¨', 'ğŸ¼', 'ğŸ¦¥', 'ğŸ¦¦', 'ğŸ¦¨', 'ğŸ¦˜', 'ğŸ¦¡', 'ğŸ¾', 'ğŸ¦ƒ', 'ğŸ”', 'ğŸ“', 'ğŸ£', 'ğŸ¤', 'ğŸ¥', 'ğŸ¦', 'ğŸ§', 'ğŸ•Šï¸', 'ğŸ¦…', 'ğŸ¦†', 'ğŸ¦¢', 'ğŸ¦‰', 'ğŸ¦¤', 'ğŸª¶', 'ğŸ¦©', 'ğŸ¦š', 'ğŸ¦œ', 'ğŸ¸', 'ğŸŠ', 'ğŸ¢', 'ğŸ¦', 'ğŸ', 'ğŸ²', 'ğŸ‰', 'ğŸ¦•', 'ğŸ¦–', 'ğŸ³', 'ğŸ‹', 'ğŸ¬', 'ğŸ¦­', 'ğŸŸ', 'ğŸ ', 'ğŸ¡', 'ğŸ¦ˆ', 'ğŸ™', 'ğŸš', 'ğŸŒ', 'ğŸ¦‹', 'ğŸ›', 'ğŸœ', 'ğŸ', 'ğŸª²', 'ğŸ', 'ğŸ¦—', 'ğŸª³', 'ğŸ•·ï¸', 'ğŸ•¸ï¸', 'ğŸ¦‚', 'ğŸ¦Ÿ', 'ğŸª°', 'ğŸª±', 'ğŸ¦ '],
      'æ¤ç‰©': ['ğŸŒ¸', 'ğŸ’®', 'ğŸµï¸', 'ğŸŒ¹', 'ğŸ¥€', 'ğŸŒº', 'ğŸŒ»', 'ğŸŒ¼', 'ğŸŒ·', 'ğŸŒ±', 'ğŸª´', 'ğŸŒ²', 'ğŸŒ³', 'ğŸŒ´', 'ğŸŒµ', 'ğŸŒ¾', 'ğŸŒ¿', 'â˜˜ï¸', 'ğŸ€', 'ğŸ', 'ğŸ‚', 'ğŸƒ', 'ğŸªº', 'ğŸª¹', 'ğŸ„', 'ğŸŒ°', 'ğŸ¦€', 'ğŸ¦', 'ğŸ¦', 'ğŸ¦‘', 'ğŸ¦ª', 'ğŸŒ', 'ğŸŒ', 'ğŸŒ', 'ğŸŒ', 'ğŸ—ºï¸', 'ğŸ§­', 'ğŸ”ï¸', 'â›°ï¸', 'ğŸŒ‹', 'ğŸ—»', 'ğŸ•ï¸', 'ğŸ–ï¸', 'ğŸœï¸', 'ğŸï¸', 'ğŸï¸', 'ğŸŸï¸', 'ğŸ›ï¸', 'ğŸ—ï¸', 'ğŸ§±', 'ğŸª¨', 'ğŸªµ', 'ğŸ›–', 'ğŸ˜ï¸', 'ğŸšï¸', 'ğŸ ', 'ğŸ¡'],
      'é£Ÿã¹ç‰©': ['ğŸ‡', 'ğŸˆ', 'ğŸ‰', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ', 'ğŸ¥­', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ‘', 'ğŸ’', 'ğŸ“', 'ğŸ«', 'ğŸ¥', 'ğŸ…', 'ğŸ«’', 'ğŸ¥¥', 'ğŸ¥‘', 'ğŸ†', 'ğŸ¥”', 'ğŸ¥•', 'ğŸŒ½', 'ğŸŒ¶ï¸', 'ğŸ«‘', 'ğŸ¥’', 'ğŸ¥¬', 'ğŸ¥¦', 'ğŸ§„', 'ğŸ§…', 'ğŸ„', 'ğŸ¥œ', 'ğŸŒ°', 'ğŸ', 'ğŸ¥', 'ğŸ¥–', 'ğŸ«“', 'ğŸ¥¨', 'ğŸ¥¯', 'ğŸ¥', 'ğŸ§‡', 'ğŸ§€', 'ğŸ–', 'ğŸ—', 'ğŸ¥©', 'ğŸ¥“', 'ğŸ”', 'ğŸŸ', 'ğŸ•', 'ğŸŒ­', 'ğŸ¥ª', 'ğŸŒ®', 'ğŸŒ¯', 'ğŸ«”', 'ğŸ¥™', 'ğŸ§†', 'ğŸ¥š', 'ğŸ³', 'ğŸ¥˜', 'ğŸ²', 'ğŸ«•', 'ğŸ¥£', 'ğŸ¥—', 'ğŸ¿', 'ğŸ§ˆ', 'ğŸ§‚', 'ğŸ¥«', 'ğŸ±', 'ğŸ˜', 'ğŸ™', 'ğŸš', 'ğŸ›', 'ğŸœ', 'ğŸ', 'ğŸ ', 'ğŸ¢', 'ğŸ£', 'ğŸ¤', 'ğŸ¥', 'ğŸ¥®', 'ğŸ¡', 'ğŸ¥Ÿ', 'ğŸ¥ ', 'ğŸ¥¡', 'ğŸ¦€', 'ğŸ¦', 'ğŸ¦', 'ğŸ¦‘', 'ğŸ¦ª', 'ğŸ¦', 'ğŸ§', 'ğŸ¨', 'ğŸ©', 'ğŸª', 'ğŸ‚', 'ğŸ°', 'ğŸ§', 'ğŸ¥§', 'ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ®', 'ğŸ¯'],
      'é£²ã¿ç‰©': ['ğŸ¼', 'ğŸ¥›', 'â˜•', 'ğŸ«–', 'ğŸµ', 'ğŸ¶', 'ğŸ¾', 'ğŸ·', 'ğŸ¸', 'ğŸ¹', 'ğŸº', 'ğŸ»', 'ğŸ¥‚', 'ğŸ¥ƒ', 'ğŸ¥¤', 'ğŸ§‹', 'ğŸ§ƒ', 'ğŸ§‰', 'ğŸ§Š', 'ğŸ«—'],
      'ã‚¹ãƒãƒ¼ãƒ„': ['âš½', 'ğŸ€', 'ğŸˆ', 'âš¾', 'ğŸ¥', 'ğŸ¾', 'ğŸ', 'ğŸ‰', 'ğŸ¥', 'ğŸ±', 'ğŸª€', 'ğŸ“', 'ğŸ¸', 'ğŸ’', 'ğŸ‘', 'ğŸ¥', 'ğŸ', 'ğŸªƒ', 'ğŸ¥…', 'â›³', 'ğŸª', 'ğŸ¹', 'ğŸ£', 'ğŸ¤¿', 'ğŸ¥Š', 'ğŸ¥‹', 'ğŸ½', 'ğŸ›¹', 'ğŸ›¼', 'ğŸ›·', 'â›¸ï¸', 'ğŸ¥Œ', 'ğŸ¿', 'â›·ï¸', 'ğŸ‚', 'ğŸª‚', 'ğŸ‹ï¸', 'ğŸ¤¼', 'ğŸ¤¸', 'â›¹ï¸', 'ğŸ¤º', 'ğŸ¤¾', 'ğŸŒï¸', 'ğŸ‡', 'ğŸ„', 'ğŸš£', 'ğŸŠ', 'ğŸš´', 'ğŸšµ', 'ğŸ–ï¸', 'ğŸ…', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ†', 'ğŸµï¸', 'ğŸ—ï¸', 'ğŸ«', 'ğŸŸï¸'],
      'éŸ³æ¥½ãƒ»èŠ¸è¡“': ['ğŸ®', 'ğŸ•¹ï¸', 'ğŸ¯', 'ğŸ³', 'ğŸ°', 'ğŸ²', 'ğŸ§©', 'â™Ÿï¸', 'ğŸ­', 'ğŸ¨', 'ğŸ§µ', 'ğŸª¡', 'ğŸ§¶', 'ğŸª¢', 'ğŸ¼', 'ğŸµ', 'ğŸ¶', 'ğŸ¹', 'ğŸ¥', 'ğŸª˜', 'ğŸ·', 'ğŸº', 'ğŸª—', 'ğŸ¸', 'ğŸª•', 'ğŸ»', 'ğŸ¤', 'ğŸ§', 'ğŸšï¸', 'ğŸ›ï¸', 'ğŸ“»', 'ğŸªˆ', 'ğŸ¬', 'ğŸ¥', 'ğŸ“½ï¸', 'ğŸï¸', 'ğŸ“¹', 'ğŸ“º', 'ğŸ“·', 'ğŸ“¸', 'ğŸ“¼', 'ğŸ”', 'ğŸ”', 'ğŸ•¯ï¸', 'ğŸ’¡', 'ğŸ”¦', 'ğŸ®', 'ğŸª”', 'ğŸ“”', 'ğŸ“•', 'ğŸ“–', 'ğŸ“—', 'ğŸ“˜', 'ğŸ“™', 'ğŸ“š', 'ğŸ““', 'ğŸ“’', 'ğŸ“ƒ', 'ğŸ“œ', 'ğŸ“„', 'ğŸ“°', 'ğŸ—ï¸', 'ğŸ“‘', 'ğŸ”–', 'ğŸ·ï¸', 'ğŸª', 'ğŸ¤¹', 'ğŸ­', 'ğŸ©°'],
      'ä¹—ã‚Šç‰©': ['ğŸš—', 'ğŸš•', 'ğŸš™', 'ğŸšŒ', 'ğŸš', 'ğŸï¸', 'ğŸš“', 'ğŸš‘', 'ğŸš’', 'ğŸš', 'ğŸ›»', 'ğŸšš', 'ğŸš›', 'ğŸšœ', 'ğŸ¦¯', 'ğŸ¦½', 'ğŸ¦¼', 'ğŸ›´', 'ğŸš²', 'ğŸ›µ', 'ğŸï¸', 'ğŸ›º', 'ğŸš¨', 'ğŸš”', 'ğŸš', 'ğŸš˜', 'ğŸš–', 'ğŸš¡', 'ğŸš ', 'ğŸšŸ', 'ğŸšƒ', 'ğŸš‹', 'ğŸš', 'ğŸš', 'ğŸš„', 'ğŸš…', 'ğŸšˆ', 'ğŸš‚', 'ğŸš†', 'ğŸš‡', 'ğŸšŠ', 'ğŸš‰', 'âœˆï¸', 'ğŸ›«', 'ğŸ›¬', 'ğŸ›©ï¸', 'ğŸ’º', 'ğŸ›°ï¸', 'ğŸš€', 'ğŸ›¸', 'ğŸš', 'ğŸ›¶', 'â›µ', 'ğŸš¤', 'ğŸ›¥ï¸', 'ğŸ›³ï¸', 'â›´ï¸', 'ğŸš¢', 'âš“', 'ğŸª', 'â›½', 'ğŸš§', 'ğŸš¦', 'ğŸš¥', 'ğŸš', 'ğŸ—ºï¸', 'ğŸ—¿', 'ğŸ—½', 'ğŸ—¼', 'ğŸ°', 'ğŸ¯', 'ğŸŸï¸', 'ğŸ¡', 'ğŸ¢', 'ğŸ ', 'â›²', 'â›±ï¸', 'ğŸ–ï¸', 'ğŸï¸', 'ğŸœï¸', 'ğŸŒ‹', 'â›°ï¸', 'ğŸ”ï¸', 'ğŸ—»', 'ğŸ•ï¸', 'â›º', 'ğŸ›–', 'ğŸ ', 'ğŸ¡', 'ğŸ˜ï¸', 'ğŸšï¸', 'ğŸ—ï¸', 'ğŸ­', 'ğŸ¢', 'ğŸ¬', 'ğŸ£', 'ğŸ¤', 'ğŸ¥', 'ğŸ¦', 'ğŸ¨', 'ğŸª', 'ğŸ«', 'ğŸ©', 'ğŸ’’', 'ğŸ›ï¸', 'â›ª', 'ğŸ•Œ', 'ğŸ•', 'ğŸ›•', 'ğŸ•‹', 'â›©ï¸'],
      'å¤©æ°—': ['â˜€ï¸', 'ğŸŒ¤ï¸', 'â›…', 'ğŸŒ¥ï¸', 'â˜ï¸', 'ğŸŒ¦ï¸', 'ğŸŒ§ï¸', 'â›ˆï¸', 'ğŸŒ©ï¸', 'ğŸŒ¨ï¸', 'â„ï¸', 'â˜ƒï¸', 'â›„', 'ğŸŒ¬ï¸', 'ğŸ’¨', 'ğŸŒªï¸', 'ğŸŒ«ï¸', 'ğŸŒŠ', 'ğŸ’§', 'ğŸ’¦', 'â˜”', 'â˜‚ï¸', 'ğŸŒˆ', 'ğŸŒ™', 'ğŸŒ›', 'ğŸŒœ', 'ğŸŒš', 'ğŸŒ•', 'ğŸŒ–', 'ğŸŒ—', 'ğŸŒ˜', 'ğŸŒ‘', 'ğŸŒ’', 'ğŸŒ“', 'ğŸŒ”', 'ğŸŒ', 'ğŸŒ', 'ğŸª', 'â­', 'ğŸŒŸ', 'âœ¨', 'ğŸ’«', 'â˜„ï¸', 'ğŸŒ ', 'ğŸŒŒ'],
      'æ™‚è¨ˆ': ['â°', 'â±ï¸', 'â²ï¸', 'ğŸ•°ï¸', 'âŒ›', 'â³', 'ğŸ“…', 'ğŸ“†', 'ğŸ—“ï¸', 'ğŸ•', 'ğŸ•‘', 'ğŸ•’', 'ğŸ•“', 'ğŸ•”', 'ğŸ••', 'ğŸ•–', 'ğŸ•—', 'ğŸ•˜', 'ğŸ•™', 'ğŸ•š', 'ğŸ•›', 'ğŸ•œ', 'ğŸ•', 'ğŸ•', 'ğŸ•Ÿ', 'ğŸ• ', 'ğŸ•¡', 'ğŸ•¢', 'ğŸ•£', 'ğŸ•¤', 'ğŸ•¥', 'ğŸ•¦', 'ğŸ•§'],
      'æ——': ['ğŸ', 'ğŸš©', 'ğŸŒ', 'ğŸ´', 'ğŸ³ï¸', 'ğŸ³ï¸â€ğŸŒˆ', 'ğŸ³ï¸â€âš§ï¸', 'ğŸ´â€â˜ ï¸', 'ğŸ‡¯ğŸ‡µ', 'ğŸ‡ºğŸ‡¸', 'ğŸ‡¬ğŸ‡§', 'ğŸ‡«ğŸ‡·', 'ğŸ‡©ğŸ‡ª', 'ğŸ‡®ğŸ‡¹', 'ğŸ‡ªğŸ‡¸', 'ğŸ‡¨ğŸ‡³', 'ğŸ‡°ğŸ‡·', 'ğŸ‡¹ğŸ‡¼', 'ğŸ‡­ğŸ‡°', 'ğŸ‡¸ğŸ‡¬', 'ğŸ‡¹ğŸ‡­', 'ğŸ‡»ğŸ‡³', 'ğŸ‡®ğŸ‡©', 'ğŸ‡µğŸ‡­', 'ğŸ‡²ğŸ‡¾', 'ğŸ‡¦ğŸ‡º', 'ğŸ‡³ğŸ‡¿', 'ğŸ‡¨ğŸ‡¦', 'ğŸ‡§ğŸ‡·', 'ğŸ‡²ğŸ‡½', 'ğŸ‡·ğŸ‡º', 'ğŸ‡®ğŸ‡³', 'ğŸ‡¸ğŸ‡¦', 'ğŸ‡¦ğŸ‡ª', 'ğŸ‡ªğŸ‡¬', 'ğŸ‡¿ğŸ‡¦', 'ğŸ‡³ğŸ‡¬', 'ğŸ‡°ğŸ‡ª', 'ğŸ‡ªğŸ‡º']
    };

    let currentEmojiCategory = 'ã‚ˆãä½¿ã†';

    // çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ã‚’é–‹ã
    window.openEmojiPicker = function() {
      console.log('[Emoji Picker] é–‹ã');
      const modal = document.getElementById('emojiPickerModal');
      modal.classList.add('active');
      renderEmojiCategories();
      renderEmojiGrid(currentEmojiCategory);
    };

    // çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ã‚’é–‰ã˜ã‚‹
    window.closeEmojiPicker = function() {
      console.log('[Emoji Picker] é–‰ã˜ã‚‹');
      document.getElementById('emojiPickerModal').classList.remove('active');
    };

    // ã‚«ãƒ†ã‚´ãƒªãƒœã‚¿ãƒ³ã‚’æç”»
    function renderEmojiCategories() {
      const container = document.getElementById('emojiCategories');
      container.innerHTML = '';

      Object.keys(emojiCategories).forEach(category => {
        const btn = document.createElement('button');
        btn.className = 'emoji-category-btn';
        btn.textContent = category;

        // é¸æŠçŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç›´æ¥é©ç”¨ï¼ˆ!importantä»˜ãï¼‰
        if (category === currentEmojiCategory) {
          btn.style.setProperty('background-color', '#1E8FBF', 'important');
          btn.style.setProperty('color', '#ffffff', 'important');
          btn.style.setProperty('font-weight', '600', 'important');
          btn.style.setProperty('border-radius', '8px', 'important');
        } else {
          btn.style.setProperty('background-color', 'transparent', 'important');
          btn.style.setProperty('color', '#718096', 'important');
        }

        btn.onclick = () => {
          currentEmojiCategory = category;
          renderEmojiCategories();
          renderEmojiGrid(category);
        };
        container.appendChild(btn);
      });
    }

    // çµµæ–‡å­—ã‚°ãƒªãƒƒãƒ‰ã‚’æç”»
    function renderEmojiGrid(category) {
      const grid = document.getElementById('emojiGrid');
      grid.innerHTML = '';

      const emojis = emojiCategories[category] || [];
      emojis.forEach(emoji => {
        const item = document.createElement('div');
        item.className = 'emoji-item';
        item.textContent = emoji;
        item.onclick = () => selectEmoji(emoji);
        grid.appendChild(item);
      });
    }

    // çµµæ–‡å­—ã‚’é¸æŠ
    function selectEmoji(emoji) {
      console.log('[Emoji Picker] é¸æŠ:', emoji);
      document.getElementById('roomIconSelect').value = emoji;
      document.getElementById('selectedEmojiPreview').textContent = emoji;
      closeEmojiPicker();
    }

    // çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.getElementById('emojiPickerModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeEmojiPicker();
      }
    });
    // ================================================================================

    // PWAç‰ˆï¼šURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼ˆGASãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ã¯ä½¿ç”¨ã—ãªã„ï¼‰
    const isPWAFlag        = true;  // PWAç‰ˆã¨ã—ã¦å‹•ä½œ
    const pwaUserNameParam = getQueryParam('userName') || '';
    const pwaUserEmailParam = getQueryParam('userEmail') || '';
    const gasUserNameParam = '';
    const pwaParentOriginParam = window.location.origin;  // PWAç‰ˆã®origin
    const pwaPmTokenParam = '';
    const gasBaseUrlParam  = '';

    // parentOrigin ã¨ pmToken ã‚’è¨­å®šï¼ˆPWAç‰ˆã§ã¯URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼‰
    const parentOrigin = getQueryParam('parentOrigin') || window.location.origin;
    const pmToken = getQueryParam('pmToken') || '';

    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
    console.log('[Rooms List] ãƒ‡ãƒãƒƒã‚°æƒ…å ±:');
    console.log('  - URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ parentOrigin:', getQueryParam('parentOrigin'));
    console.log('  - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ pwaParentOriginParam:', pwaParentOriginParam);
    console.log('  - æœ€çµ‚ parentOrigin:', parentOrigin);
    console.log('  - URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ pmToken:', getQueryParam('pmToken'));
    console.log('  - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ pwaPmTokenParam:', pwaPmTokenParam);
    console.log('  - æœ€çµ‚ pmToken:', pmToken);

    // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
    const isEmbedded = (window.top !== window);
    const looksLikePWA = isEmbedded && pwaUserNameParam !== "";
    const isPWA = isPWAFlag || looksLikePWA;
    const isGAS = !isPWA;

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[Rooms List] åˆæœŸåŒ–é–‹å§‹');

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¨­å®š
      if (isGAS) {
        if (gasUserNameParam && gasUserNameParam.trim() !== '') {
          try {
            currentUserName = JSON.parse(gasUserNameParam);
          } catch (e) {
            currentUserName = gasUserNameParam;
          }
          document.getElementById('userInfo').textContent = `ğŸ‘¤ ${currentUserName}`;
          console.log('[GAS] ãƒ¦ãƒ¼ã‚¶ãƒ¼åè‡ªå‹•è¨­å®š:', currentUserName);
        }
      } else {
        try {
          currentUserName = JSON.parse(pwaUserNameParam);
        } catch (e) {
          currentUserName = pwaUserNameParam;
        }
        try {
          currentUserEmail = JSON.parse(pwaUserEmailParam);
        } catch (e) {
          currentUserEmail = pwaUserEmailParam;
        }
        document.getElementById('userInfo').textContent = `ğŸ‘¤ ${currentUserName}`;
        console.log('[PWA] ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¨­å®š:', currentUserName);
        console.log('[PWA] ãƒ¦ãƒ¼ã‚¶ãƒ¼Emailè¨­å®š:', currentUserEmail);
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºç”¨ï¼‰
      if (isPWA) {
        // PWAç‰ˆï¼šgetUserList()ã¯api.jsã«ä¾å­˜ã—ã¦ã„ã‚‹ãŸã‚ã‚¹ã‚­ãƒƒãƒ—
        // ç›´æ¥Firestoreã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—
        console.log('[User Cache] Firestoreã‹ã‚‰ç›´æ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—é–‹å§‹');

        // ã¾ãšå…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã—ã¦statusç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        getDocs(collection(db, 'users'))
          .then(snapshot => {
            console.log('[User Cache] å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ snapshot.size:', snapshot.size);
            console.log('[User Cache] å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ snapshot.empty:', snapshot.empty);

            const allUsers = [];
            snapshot.forEach(doc => {
              const data = doc.data();
              console.log('[User Cache] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:', doc.id, 'status:', data.status, 'data:', data);
              allUsers.push({ id: doc.id, ...data });
            });

            console.log('[User Cache] å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:', allUsers.length);

            // userNameãŒã‚ã‚Šã€æ‰¿èªæ¸ˆã¿ï¼ˆactiveï¼‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
            const users = allUsers.filter(u => u.userName && u.status === 'active');
            console.log('[User Cache] æœ‰åŠ¹ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:', users.length);

            if (users.length > 0) {
              usersCache = users;
              console.log('[User Cache] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Œäº†:', usersCache.length + 'ä»¶');
              console.log('[User Cache] usersCacheå†…å®¹:', usersCache);
            } else {
              console.warn('[User Cache] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãŒç©ºã§ã™');
            }

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å–å¾—å®Œäº†å¾Œã€ãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚’è¡¨ç¤º
            console.log('[Rooms List] ã‚­ãƒ£ãƒƒã‚·ãƒ¥å–å¾—å®Œäº†ã€ãƒªã‚¹ãƒ‹ãƒ³ã‚°é–‹å§‹');
            startListening();
          })
          .catch(error => {
            console.error('[User Cache] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            console.error('[User Cache] ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.code, error.message);
            // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã§ã‚‚ãƒ«ãƒ¼ãƒ ä¸€è¦§ã¯è¡¨ç¤ºã™ã‚‹
            startListening();
          });
      } else if (typeof google !== 'undefined' && google.script && google.script.run) {
        // GASç‰ˆï¼šgoogle.script.runã§å‘¼ã³å‡ºã—
        google.script.run
          .withSuccessHandler(function(users) {
            if (users && users.length > 0) {
              usersCache = users;
              console.log('[User Cache] GASç‰ˆ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Œäº†:', usersCache.length + 'ä»¶');
              console.log('[User Cache] ã‚­ãƒ£ãƒƒã‚·ãƒ¥å†…å®¹:', usersCache);
            } else {
              console.warn('[User Cache] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãŒç©ºã§ã™');
            }
            // GASç‰ˆã¯å³åº§ã«startListening
            startListening();
          })
          .withFailureHandler(function(error) {
            console.error('[User Cache] GASç‰ˆ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã§ã‚‚startListening
            startListening();
          })
          .getUserListForUI();
      } else {
        // ã©ã¡ã‚‰ã§ã‚‚ãªã„å ´åˆ
        console.warn('[User Cache] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥å–å¾—ã‚’ã‚¹ã‚­ãƒƒãƒ—');
        startListening();
      }
    });

    // ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒ‹ãƒ³ã‚°
    async function startListening() {
      console.log('[Firestore] startListening() é–‹å§‹');
      console.log('[Firestore] ğŸ” currentUserName:', JSON.stringify(currentUserName), 'length:', currentUserName?.length);
      console.log('[Firestore] ğŸ” currentUserEmail:', JSON.stringify(currentUserEmail));

      // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤ï¼ˆé‡è¤‡ç™»éŒ²é˜²æ­¢ï¼‰
      if (unsubscribeRooms) {
        console.log('[Firestore] æ—¢å­˜ãƒªã‚¹ãƒŠãƒ¼è§£é™¤');
        unsubscribeRooms();
        unsubscribeRooms = null;
      }

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      const container = document.getElementById('roomsContainer');
      if (container) {
        container.innerHTML = '<div style="padding:20px;text-align:center;color:#40B4E5;">ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>';
      }

      // ğŸ”§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ™ãƒ¼ã‚¹ã§ãƒ«ãƒ¼ãƒ ã‚’æ¤œç´¢ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åå¤‰æ›´ã«å¯¾å¿œï¼‰
      const trimmedUserEmail = (currentUserEmail || '').trim();
      const trimmedUserName = (currentUserName || '').trim();
      console.log('[Firestore] ğŸ” trimmedUserEmail:', JSON.stringify(trimmedUserEmail));
      console.log('[Firestore] ğŸ” trimmedUserName:', JSON.stringify(trimmedUserName));

      if (!trimmedUserEmail && !trimmedUserName) {
        console.error('[Firestore] âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒç©ºã§ã™ï¼ãƒ«ãƒ¼ãƒ å–å¾—ã‚’ä¸­æ­¢');
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">âš ï¸</div>
            <div class="empty-state-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“</div>
            <div style="font-size: 14px; color: #a0aec0;">ã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„</div>
          </div>
        `;
        return;
      }

      // ğŸ”§ emailãƒ™ãƒ¼ã‚¹ã®ã‚¯ã‚¨ãƒªã‚’å„ªå…ˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åå¤‰æ›´ã«å¼·ã„ï¼‰
      // memberEmailsãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹ãƒ«ãƒ¼ãƒ ã¯emailã§ã€ãªã‘ã‚Œã°membersã§æ¤œç´¢
      const qByEmail = trimmedUserEmail ? query(
        collection(db, 'rooms'),
        where('memberEmails', 'array-contains', trimmedUserEmail),
        orderBy('lastMessageAt', 'desc')
      ) : null;

      const qByName = query(
        collection(db, 'rooms'),
        where('members', 'array-contains', trimmedUserName),
        orderBy('lastMessageAt', 'desc')
      );

      // ğŸ”§ ã¾ãšemailã§æ¤œç´¢ã€çµæœãŒ0ä»¶ãªã‚‰nameã§ã‚‚æ¤œç´¢
      console.log('[Firestore] ğŸ“¡ emailãƒ™ãƒ¼ã‚¹ã§æ¤œç´¢è©¦è¡Œ...');

      let useEmailQuery = false;
      if (qByEmail) {
        try {
          const emailSnapshot = await getDocs(qByEmail);
          console.log('[Firestore] ğŸ“¡ emailã‚¯ã‚¨ãƒªçµæœ:', emailSnapshot.size, 'ä»¶');
          if (emailSnapshot.size > 0) {
            useEmailQuery = true;
          }
        } catch (err) {
          console.log('[Firestore] emailã‚¯ã‚¨ãƒªå¤±æ•—ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœªä½œæˆã®å¯èƒ½æ€§ï¼‰:', err.message);
        }
      }

      // nameãƒ™ãƒ¼ã‚¹ã§ã‚‚æ¤œç´¢
      let nameSnapshotSize = 0;
      try {
        const nameSnapshot = await getDocs(qByName);
        nameSnapshotSize = nameSnapshot.size;
        console.log('[Firestore] ğŸ“¡ nameã‚¯ã‚¨ãƒªçµæœ:', nameSnapshotSize, 'ä»¶');
      } catch (err) {
        console.log('[Firestore] nameã‚¯ã‚¨ãƒªå¤±æ•—:', err.message);
      }

      // ã©ã¡ã‚‰ã‹ã§çµæœãŒã‚ã‚Œã°ä½¿ç”¨
      let q = useEmailQuery ? qByEmail : qByName;
      let useClientFilter = false;
      console.log('[Firestore] ä½¿ç”¨ã‚¯ã‚¨ãƒª:', useEmailQuery ? 'memberEmails' : 'members');

      // ğŸ”§ ä¸¡æ–¹ã®ã‚¯ã‚¨ãƒªãŒ0ä»¶ã®å ´åˆã€å…¨ãƒ«ãƒ¼ãƒ å–å¾—ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿
      if (!useEmailQuery && nameSnapshotSize === 0) {
        console.log('[Firestore] âš ï¸ ä¸¡ã‚¯ã‚¨ãƒª0ä»¶ - å…¨ãƒ«ãƒ¼ãƒ å–å¾—ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿ã«åˆ‡ã‚Šæ›¿ãˆ');
        useClientFilter = true;
        // orderByã®ã¿ã®ã‚¯ã‚¨ãƒªï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãªã—ï¼‰
        q = query(
          collection(db, 'rooms'),
          orderBy('lastMessageAt', 'desc')
        );
      }

      // ãƒ‡ãƒãƒƒã‚°: å…¨ãƒ«ãƒ¼ãƒ ã‚’ç¢ºèª
      getDocs(collection(db, 'rooms')).then(allRooms => {
        console.log('[Firestore] ğŸ” å…¨ãƒ«ãƒ¼ãƒ æ•°:', allRooms.size);
        allRooms.forEach(doc => {
          const data = doc.data();
          console.log('[Firestore] ğŸ” ãƒ«ãƒ¼ãƒ :', doc.id,
            'memberEmails:', data.memberEmails,
            'members:', data.members,
            'emailMatch:', data.memberEmails?.includes(trimmedUserEmail),
            'nameMatch:', data.members?.includes(trimmedUserName));
        });
      });

      console.log('[Firestore] æ–°è¦ãƒªã‚¹ãƒŠãƒ¼ç™»éŒ² (clientFilter:', useClientFilter, ')');
      unsubscribeRooms = onSnapshot(q, (snapshot) => {
        console.log('[Firestore] ãƒ«ãƒ¼ãƒ æ›´æ–°:', snapshot.size + 'ä»¶');

        const container = document.getElementById('roomsContainer');
        container.innerHTML = '';

        if (snapshot.empty) {
          // ç©ºã®çŠ¶æ…‹
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ’¬</div>
              <div class="empty-state-text">ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</div>
              <div style="font-size: 14px; color: #a0aec0;">ã€Œæ–°ã—ã„ãƒ«ãƒ¼ãƒ ä½œæˆã€ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†</div>
            </div>
          `;
          return;
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        console.log('[Filter] currentUserName:', currentUserName);
        console.log('[Filter] currentUserEmail:', currentUserEmail);
        console.log('[Filter] å…¨ãƒ«ãƒ¼ãƒ æ•°:', snapshot.size);

        // ãƒ«ãƒ¼ãƒ ã‚’é…åˆ—ã«åé›†ã—ã¦ã‚½ãƒ¼ãƒˆ
        const visibleRooms = [];
        snapshot.forEach((doc) => {
          const room = { id: doc.id, ...doc.data() };

          // ğŸ”§ emailã¾ãŸã¯nameã§ãƒãƒƒãƒãƒ³ã‚°ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åå¤‰æ›´å¯¾å¿œï¼‰
          const emailMatch = room.memberEmails?.includes(trimmedUserEmail);
          const nameMatch = room.members?.includes(trimmedUserName);
          const isSystemRoom = room.type === 'system';

          // ãƒ‡ãƒãƒƒã‚°: å„ãƒ«ãƒ¼ãƒ ã®æƒ…å ±ã‚’å‡ºåŠ›
          console.log('[Filter] ãƒ«ãƒ¼ãƒ æ¤œè¨¼:', {
            id: room.id,
            name: room.name,
            type: room.type,
            memberEmails: room.memberEmails,
            members: room.members,
            emailMatch: emailMatch,
            nameMatch: nameMatch,
            isSystemRoom: isSystemRoom
          });

          // éè¡¨ç¤ºãƒã‚§ãƒƒã‚¯: hiddenByé…åˆ—ã«è‡ªåˆ†ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹
          const isHidden = room.hiddenBy && Array.isArray(room.hiddenBy) && room.hiddenBy.includes(currentUserName);

          // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°: è‡ªåˆ†ãŒå‚åŠ ã—ã¦ã„ã‚‹ãƒ«ãƒ¼ãƒ ã®ã¿è¡¨ç¤º
          // - type='system'ã®ãƒ«ãƒ¼ãƒ ã¯å…¨å“¡ã«è¡¨ç¤º
          // - memberEmails ã«è‡ªåˆ†ã®ãƒ¡ãƒ¼ãƒ«ãŒå«ã¾ã‚Œã‚‹å ´åˆ
          // - ã¾ãŸã¯ membersé…åˆ—ã«è‡ªåˆ†ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒå«ã¾ã‚Œã‚‹å ´åˆ
          // - éè¡¨ç¤ºè¨­å®šã•ã‚Œã¦ã„ã‚‹ãƒ«ãƒ¼ãƒ ã¯é™¤å¤–
          if ((isSystemRoom || emailMatch || nameMatch) && !isHidden) {
            console.log('[Filter] âœ… ãƒ«ãƒ¼ãƒ è¡¨ç¤º:', room.id, room.name,
              isSystemRoom ? '(system)' : emailMatch ? '(emailMatch)' : '(nameMatch)');
            visibleRooms.push(room);
          } else if (isHidden) {
            console.log('[Filter] ğŸ™ˆ éè¡¨ç¤ºãƒ«ãƒ¼ãƒ :', room.id, room.name);
          } else {
            console.log('[Filter] âŒ ãƒ«ãƒ¼ãƒ ã‚’ã‚¹ã‚­ãƒƒãƒ—:', room.id, room.name);
          }
        });

        // ã‚½ãƒ¼ãƒˆ: ãƒ”ãƒ³ç•™ã‚å„ªå…ˆ â†’ æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ™‚é–“é™é †
        visibleRooms.sort((a, b) => {
          const aPinned = a.pinnedBy && Array.isArray(a.pinnedBy) && a.pinnedBy.includes(currentUserName);
          const bPinned = b.pinnedBy && Array.isArray(b.pinnedBy) && b.pinnedBy.includes(currentUserName);

          // ãƒ”ãƒ³ç•™ã‚ã•ã‚Œã¦ã„ã‚‹ãƒ«ãƒ¼ãƒ ã‚’ä¸Šã«
          if (aPinned && !bPinned) return -1;
          if (!aPinned && bPinned) return 1;

          // åŒã˜ãƒ”ãƒ³ç•™ã‚çŠ¶æ…‹ãªã‚‰æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ™‚é–“ã§é™é †ã‚½ãƒ¼ãƒˆ
          const aTime = a.lastMessageAt?.toMillis?.() || 0;
          const bTime = b.lastMessageAt?.toMillis?.() || 0;
          return bTime - aTime;
        });

        // ã‚½ãƒ¼ãƒˆã•ã‚ŒãŸé †åºã§è¡¨ç¤º
        visibleRooms.forEach(room => appendRoom(room));
        const visibleRoomCount = visibleRooms.length;

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã«è¡¨ç¤ºã™ã‚‹ãƒ«ãƒ¼ãƒ ãŒãªã„å ´åˆ
        if (visibleRoomCount === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ’¬</div>
              <div class="empty-state-text">å‚åŠ ä¸­ã®ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</div>
              <div style="font-size: 14px; color: #a0aec0;">ã€Œæ–°ã—ã„ãƒ«ãƒ¼ãƒ ä½œæˆã€ã¾ãŸã¯ã€Œå€‹åˆ¥ãƒãƒ£ãƒƒãƒˆä½œæˆã€ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†</div>
            </div>
          `;
        }
      }, (error) => {
        console.error('[Firestore] ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
        const container = document.getElementById('roomsContainer');
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">âš ï¸</div>
            <div class="empty-state-text">ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>
            <div style="font-size: 14px; color: #a0aec0;">${error.message}</div>
          </div>
        `;
      });
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³URLã‚’å–å¾—
    function getUserIconUrl(userName) {
      console.log('[Room Icon] getUserIconUrl:', { userName, cacheSize: usersCache?.length || 0 });

      if (!userName || !usersCache || usersCache.length === 0) {
        console.warn('[Room Icon] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒç©ºã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼åãªã—');
        return null;
      }

      const user = usersCache.find(u => u.userName === userName);
      console.log('[Room Icon] æ¤œç´¢çµæœ:', user);

      if (user && (user.userIconUrl || user.photoURL)) {
        const iconUrl = user.userIconUrl || user.photoURL;
        console.log('[Room Icon] ã‚¢ã‚¤ã‚³ãƒ³URLè¿”å´:', iconUrl);
        return iconUrl;
      } else {
        console.warn('[Room Icon] ã‚¢ã‚¤ã‚³ãƒ³URLãªã—:', userName);
        return null;
      }
    }

    // ğŸ”§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³URLã‚’å–å¾—
    function getUserIconUrlByEmail(email) {
      if (!email || !usersCache || usersCache.length === 0) {
        return null;
      }

      const user = usersCache.find(u => u.id === email || u.userEmail === email);
      if (user && (user.userIconUrl || user.photoURL)) {
        return user.userIconUrl || user.photoURL;
      }
      return null;
    }

    // ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ã‚’UIã«è¿½åŠ 
    function appendRoom(room) {
      const container = document.getElementById('roomsContainer');

      // ãƒ«ãƒ¼ãƒ ã‚¢ã‚¤ãƒ†ãƒ ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆã‚¹ãƒ¯ã‚¤ãƒ—ç”¨ï¼‰
      const wrapper = document.createElement('div');
      wrapper.className = 'room-item-wrapper';
      wrapper.dataset.roomId = room.id;

      // ãƒŸãƒ¥ãƒ¼ãƒˆãƒ»ãƒ”ãƒ³ç•™ã‚çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
      const isMuted = room.mutedBy && Array.isArray(room.mutedBy) && room.mutedBy.includes(currentUserName);
      const isPinned = room.pinnedBy && Array.isArray(room.pinnedBy) && room.pinnedBy.includes(currentUserName);

      // å³å´ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠï¼ˆéè¡¨ç¤ºãƒ»å‰Šé™¤ï¼‰- å·¦ã‚¹ãƒ¯ã‚¤ãƒ—ã§è¡¨ç¤º
      const buttonsContainer = document.createElement('div');
      buttonsContainer.className = 'swipe-buttons';

      // éè¡¨ç¤ºãƒœã‚¿ãƒ³ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰
      const hideBtn = document.createElement('div');
      hideBtn.className = 'hide-button';
      hideBtn.textContent = 'éè¡¨ç¤º';
      hideBtn.onclick = (e) => {
        e.stopPropagation();
        toggleHideRoom(room.id);
      };

      // å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰
      const deleteBtn = document.createElement('div');
      deleteBtn.className = 'delete-button';
      deleteBtn.textContent = 'å‰Šé™¤';
      deleteBtn.onclick = (e) => {
        e.stopPropagation();
        confirmDeleteRoom(room.id, room.name || 'ä¸æ˜ãªãƒ«ãƒ¼ãƒ ');
      };

      buttonsContainer.appendChild(hideBtn);
      buttonsContainer.appendChild(deleteBtn);

      // å·¦å´ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠï¼ˆãƒŸãƒ¥ãƒ¼ãƒˆãƒ»ãƒ”ãƒ³ç•™ã‚ï¼‰- å³ã‚¹ãƒ¯ã‚¤ãƒ—ã§è¡¨ç¤º
      const buttonsContainerLeft = document.createElement('div');
      buttonsContainerLeft.className = 'swipe-buttons-left';

      // ãƒŸãƒ¥ãƒ¼ãƒˆãƒœã‚¿ãƒ³ï¼ˆBootstrap Iconï¼‰
      const muteBtn = document.createElement('div');
      muteBtn.className = 'mute-button';
      muteBtn.innerHTML = isMuted ? '<i class="bi bi-bell"></i>' : '<i class="bi bi-bell-slash"></i>';
      muteBtn.onclick = (e) => {
        e.stopPropagation();
        toggleMuteRoom(room.id, isMuted);
      };

      // ãƒ”ãƒ³ç•™ã‚ãƒœã‚¿ãƒ³ï¼ˆBootstrap Iconï¼‰
      const pinBtn = document.createElement('div');
      pinBtn.className = 'pin-button';
      pinBtn.innerHTML = isPinned ? '<i class="bi bi-pin-fill"></i>' : '<i class="bi bi-pin-angle"></i>';
      pinBtn.onclick = (e) => {
        e.stopPropagation();
        togglePinRoom(room.id, isPinned);
      };

      buttonsContainerLeft.appendChild(muteBtn);
      buttonsContainerLeft.appendChild(pinBtn);

      const item = document.createElement('div');
      item.className = 'room-item';
      item.onclick = () => {
        // ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã®å ´åˆã¯ã‚¹ãƒ¯ã‚¤ãƒ—ã‚’é–‰ã˜ã‚‹ã ã‘
        if (currentlySwipedItem === item) {
          item.style.transform = 'translateX(0)';
          currentlySwipedItem = null;
          return;
        }
        // ä»–ã®ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Œã°é–‰ã˜ã‚‹
        if (currentlySwipedItem) {
          currentlySwipedItem.style.transform = 'translateX(0)';
          currentlySwipedItem = null;
        }
        openRoom(room.id);
      };

      // ã‚¢ã‚¤ã‚³ãƒ³
      const icon = document.createElement('div');
      icon.className = 'room-icon';

      // å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆï¼ˆDMï¼‰ã®å ´åˆã¯ç›¸æ‰‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º
      if (room.type === 'direct') {
        // ğŸ”§ memberEmailsã‹ã‚‰è‡ªåˆ†ä»¥å¤–ã‚’ç‰¹å®šï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åå¤‰æ›´å¯¾å¿œï¼‰
        let otherUser = null;
        let otherUserEmail = null;

        if (room.memberEmails && room.memberEmails.length === 2) {
          otherUserEmail = room.memberEmails.find(e => e !== currentUserEmail);
          // emailã‹ã‚‰usersCacheã§ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
          const otherUserData = usersCache.find(u => u.id === otherUserEmail || u.userEmail === otherUserEmail);
          otherUser = otherUserData?.userName || otherUserEmail?.split('@')[0] || 'ä¸æ˜';
        } else if (room.members && room.members.length === 2) {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ—§æ–¹å¼
          otherUser = room.members.find(m => m !== currentUserName);
        }

        const iconUrl = getUserIconUrl(otherUser) || (otherUserEmail ? getUserIconUrlByEmail(otherUserEmail) : null);

        console.log('[Room Icon] å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆ:', { roomId: room.id, otherUser, otherUserEmail, iconUrl });

        if (iconUrl) {
          // ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒãŒã‚ã‚‹å ´åˆ
          const img = document.createElement('img');
          img.src = iconUrl;
          img.alt = otherUser || 'åŒ¿å';
          img.style.width = '48px';
          img.style.height = '48px';
          img.style.borderRadius = '50%';
          img.style.objectFit = 'cover';
          img.onerror = function() {
            // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
            icon.textContent = (otherUser || 'åŒ¿').charAt(0);
            icon.classList.add('has-emoji');
            icon.style.color = 'white';
            icon.style.fontWeight = '600';
          };
          icon.appendChild(img);
        } else {
          // ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒãŒãªã„å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
          icon.textContent = (otherUser || 'åŒ¿').charAt(0);
          icon.classList.add('has-emoji');
          icon.style.color = 'white';
          icon.style.fontWeight = '600';
        }
      } else {
        // ã‚·ã‚¹ãƒ†ãƒ ãƒ«ãƒ¼ãƒ ã‚„å…¨ä½“ãƒãƒ£ãƒƒãƒˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³
        // system-notificationsï¼ˆç®¡ç†è€…é€šçŸ¥ï¼‰ã¯ğŸ‘‘ã‚’ä½¿ç”¨
        if (room.id === 'system-notifications') {
          icon.textContent = 'ğŸ‘‘';
        } else {
          icon.textContent = room.icon || 'ğŸ’¬';
        }
        icon.classList.add('has-emoji');
      }

      // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
      const content = document.createElement('div');
      content.className = 'room-content';

      // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒ«ãƒ¼ãƒ å + å³å´ãƒ¡ã‚¿æƒ…å ±ï¼‰
      const header = document.createElement('div');
      header.className = 'room-header';

      const name = document.createElement('div');
      name.className = 'room-name';

      // å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆã®å ´åˆã¯ç›¸æ‰‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å‹•çš„ç”Ÿæˆ
      if (room.type === 'direct') {
        // ğŸ”§ memberEmailsã‹ã‚‰è‡ªåˆ†ä»¥å¤–ã‚’ç‰¹å®šï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åå¤‰æ›´å¯¾å¿œï¼‰
        let otherMemberName = 'ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼';

        if (room.memberEmails && room.memberEmails.length === 2) {
          const otherEmail = room.memberEmails.find(e => e !== currentUserEmail);
          // emailã‹ã‚‰usersCacheã§ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
          const otherUserData = usersCache.find(u => u.id === otherEmail || u.userEmail === otherEmail);
          otherMemberName = otherUserData?.userName || otherEmail?.split('@')[0] || 'ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼';
        } else if (room.members && Array.isArray(room.members)) {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ—§æ–¹å¼
          otherMemberName = room.members.find(m => m !== currentUserName) || 'ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼';
        }

        name.textContent = otherMemberName;
      } else {
        // ãƒ«ãƒ¼ãƒ åã‹ã‚‰å…ˆé ­ã®çµµæ–‡å­—ã‚’å‰Šé™¤ï¼ˆå·¦ã®ä¸¸ã‚¢ã‚¤ã‚³ãƒ³ã§è¡¨ç¤ºã™ã‚‹ãŸã‚é‡è¤‡å›é¿ï¼‰
        let displayName = room.name || 'ç„¡é¡Œã®ãƒ«ãƒ¼ãƒ ';
        // çµµæ–‡å­— + ã‚¹ãƒšãƒ¼ã‚¹ã§å§‹ã¾ã‚‹å ´åˆã¯å‰Šé™¤
        displayName = displayName.replace(/^[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]+\s*/u, '');
        name.textContent = displayName;
      }

      // ãƒ”ãƒ³ç•™ã‚ä¸­ã®å ´åˆã¯ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
      if (isPinned) {
        const pinIcon = document.createElement('i');
        pinIcon.className = 'bi bi-pin-fill';
        pinIcon.style.marginLeft = '6px';
        pinIcon.style.fontSize = '12px';
        pinIcon.style.color = '#3b82f6';
        name.appendChild(pinIcon);
      }

      // ãƒŸãƒ¥ãƒ¼ãƒˆä¸­ã®å ´åˆã¯ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
      if (isMuted) {
        const muteIcon = document.createElement('i');
        muteIcon.className = 'bi bi-bell-slash-fill';
        muteIcon.style.marginLeft = '6px';
        muteIcon.style.fontSize = '12px';
        muteIcon.style.color = '#9ca3af';
        name.appendChild(muteIcon);
      }

      // å³å´ãƒ¡ã‚¿æƒ…å ±ï¼ˆæ™‚é–“ + æœªèª­ãƒãƒƒã‚¸ï¼‰
      const meta = document.createElement('div');
      meta.className = 'room-meta';

      const time = document.createElement('div');
      time.className = 'room-time';
      if (room.lastMessageAt && room.lastMessageAt.toDate) {
        const date = room.lastMessageAt.toDate();
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) {
          time.textContent = 'ãŸã£ãŸä»Š';
        } else if (diffMins < 60) {
          time.textContent = `${diffMins}åˆ†å‰`;
        } else if (diffHours < 24) {
          time.textContent = `${diffHours}æ™‚é–“å‰`;
        } else if (diffDays < 7) {
          time.textContent = `${diffDays}æ—¥å‰`;
        } else {
          time.textContent = date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
        }
      }

      meta.appendChild(time);

      // æœªèª­ãƒãƒƒã‚¸ï¼ˆæ™‚é–“ã®ä¸‹ã«é…ç½®ï¼‰
      const badge = document.createElement('div');
      badge.className = 'unread-badge';
      badge.id = `unread-badge-${room.id}`;
      badge.style.display = 'none'; // åˆæœŸéè¡¨ç¤º
      meta.appendChild(badge);

      header.appendChild(name);
      header.appendChild(meta);

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ + æœªèª­ãƒãƒƒã‚¸ï¼‰
      const preview = document.createElement('div');
      preview.className = 'room-preview';

      const lastMessage = document.createElement('div');
      lastMessage.className = 'room-last-message';
      if (room.lastMessage) {
        const sender = room.lastMessageBy || '';

        // è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯:
        // - å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆï¼ˆtype='direct'ï¼‰: é€ä¿¡è€…åãªã—
        // - ã‚·ã‚¹ãƒ†ãƒ ãƒ«ãƒ¼ãƒ ï¼ˆsender='ã‚·ã‚¹ãƒ†ãƒ 'ï¼‰: é€ä¿¡è€…åãªã—
        // - ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆ: é€ä¿¡è€…åã‚ã‚Š
        if (room.type === 'direct' || sender === 'ã‚·ã‚¹ãƒ†ãƒ ') {
          lastMessage.textContent = room.lastMessage;
        } else {
          lastMessage.textContent = `${sender}: ${room.lastMessage}`;
        }
      } else {
        lastMessage.textContent = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“';
      }

      preview.appendChild(lastMessage);

      content.appendChild(header);
      content.appendChild(preview);

      item.appendChild(icon);
      item.appendChild(content);

      // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼è¨­å®š
      setupSwipeGesture(wrapper, item);

      wrapper.appendChild(buttonsContainerLeft);
      wrapper.appendChild(buttonsContainer);
      wrapper.appendChild(item);
      container.appendChild(wrapper);

      // æœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å–å¾—ãƒ»æ›´æ–°
      if (currentUserEmail) {
        const unreadRef = doc(db, `rooms/${room.id}/unreadCounts/${currentUserEmail}`);
        onSnapshot(unreadRef, (unreadDoc) => {
          const badgeEl = document.getElementById(`unread-badge-${room.id}`);
          if (badgeEl) {
            const unreadData = unreadDoc.data();
            const unreadCount = unreadData?.unreadCount || 0;

            if (unreadCount > 0) {
              badgeEl.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
              badgeEl.style.display = 'inline-block';
            } else {
              badgeEl.style.display = 'none';
            }
          }
        }, (error) => {
          console.error('[Rooms List] æœªèª­ã‚«ã‚¦ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', room.id, error);
        });
      }
    }

    // ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ã‚’é–‹ã
    // ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ã‚’é–‹ãï¼ˆæ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã¯å¼•ãç¶™ãï¼‰
    window.openRoom = function(roomId) {
      console.log('[Rooms List] ãƒ«ãƒ¼ãƒ é¸æŠ:', roomId);

      // æ¤œç´¢ä¸­ã®å ´åˆã€æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—
      const searchInput = document.getElementById('searchInput');
      const searchQuery = searchInput?.value?.trim() || '';

      // ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIã‚’è¡¨ç¤ºï¼ˆå…¨ç”»é¢ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼‰
      const skeleton = document.getElementById('skeleton-loader');
      if (skeleton) {
        skeleton.classList.add('active');
        console.log('[Rooms List] âœ… ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIè¡¨ç¤º');
      }

      // ãƒãƒ£ãƒƒãƒˆç”»é¢ã«é·ç§»ï¼ˆroomIdã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æ¸¡ã™ï¼‰
      if (isGAS) {
        // GASç‰ˆ: åŒã˜ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ãï¼ˆPWAç‰ˆã§ã¯ä½¿ç”¨ã•ã‚Œãªã„ï¼‰
        console.warn('[Rooms List] GAS mode is not supported in PWA');
      } else {
        // PWAç‰ˆ: window.top.postMessageã§è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«é€ä¿¡
        // targetOriginãŒç©ºæ–‡å­—åˆ—ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ï¼ˆSyntaxErrorå¯¾ç­–ï¼‰
        const targetOrigin = parentOrigin || window.location.origin;

        console.log('[Rooms List] postMessageé€ä¿¡:', {
          page: 'chat',
          roomId: roomId,
          userName: currentUserName,
          targetOrigin: targetOrigin,
          pmToken: pmToken,
          searchQuery: searchQuery
        });

        try {
          window.top.postMessage({
            __reborn: true,
            type: 'navigate',
            page: 'chat',
            roomId: roomId,
            userName: currentUserName || '',
            pmToken: pmToken,
            searchQuery: searchQuery  // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å¼•ãç¶™ã
          }, targetOrigin);
          console.log('[Rooms List] postMessageé€ä¿¡æˆåŠŸ', searchQuery ? `(æ¤œç´¢: ${searchQuery})` : '');
        } catch (error) {
          console.error('[Rooms List] postMessageé€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
          alert('ç”»é¢é·ç§»ã‚¨ãƒ©ãƒ¼: ' + error.message);
        }
      }
    };

    // ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.createRoom = function() {
      console.log('[Rooms List] ãƒ«ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆç›´æ¥å‘¼ã³å‡ºã—éæ¨å¥¨ï¼‰');
      // æ³¨ï¼šã“ã®é–¢æ•°ã¯ selectChatType('room') çµŒç”±ã§å‘¼ã°ã‚Œã‚‹ã¹ã
      document.getElementById('createRoomModal').classList.add('active');
      document.getElementById('roomNameInput').focus();
    };

    // ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeCreateRoomModal = function() {
      console.log('[Rooms List] ãƒ«ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹');
      document.getElementById('createRoomModal').classList.remove('active');
      document.getElementById('createRoomForm').reset();
      // é¸æŠã•ã‚ŒãŸãƒ¡ãƒ³ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
      selectedGroupMembers = [];
    };

    // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼é¸æŠç”¨ã®é…åˆ—
    let selectedGroupMembers = [];
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’ä¿å­˜
    let groupMemberUsersList = [];

    // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
    async function loadGroupMemberList() {
      console.log('[Group Room] ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...');
      const container = document.getElementById('groupMemberListContainer');
      container.innerHTML = '<div class="loading">ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>';

      // æ¤œç´¢å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
      const searchInput = document.getElementById('memberSearchInput');
      if (searchInput) searchInput.value = '';

      try {
        let users;

        // PWAç‰ˆï¼šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—
        if (usersCache && usersCache.length > 0) {
          users = usersCache;
          console.log('[Group Room] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—:', users.length + 'ä»¶');
        } else if (typeof google !== 'undefined' && google.script && google.script.run) {
          // GASç‰ˆï¼šgoogle.script.runã§å‘¼ã³å‡ºã—
          users = await new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getUserListForUI();
          });
          console.log('[Group Room] GASç‰ˆ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—æˆåŠŸ:', users.length + 'ä»¶');
        } else {
          throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
        }

        console.log('[Group Room] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—æˆåŠŸ:', users.length + 'ä»¶');

        if (!users || users.length === 0) {
          groupMemberUsersList = [];
          updateMemberCount(0, 0);
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ‘¥</div>
              <div class="empty-state-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>
            </div>
          `;
          return;
        }

        // è‡ªåˆ†è‡ªèº«ã‚’é™¤å¤–ã—ã¦ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
        groupMemberUsersList = users.filter(u => u.userName !== currentUserName);

        if (groupMemberUsersList.length === 0) {
          updateMemberCount(0, 0);
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ‘¥</div>
              <div class="empty-state-text">ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>
            </div>
          `;
          return;
        }

        // ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º
        renderGroupMemberList(groupMemberUsersList);

      } catch (error) {
        console.error('[Group Room] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        groupMemberUsersList = [];
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">âš ï¸</div>
            <div class="empty-state-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>
          </div>
        `;
      }
    }

    // ãƒ¡ãƒ³ãƒãƒ¼æ•°ã‚’æ›´æ–°
    function updateMemberCount(shown, total) {
      const countElement = document.getElementById('memberCount');
      if (countElement) {
        if (shown === total) {
          countElement.textContent = `${total}äºº`;
        } else {
          countElement.textContent = `${shown}/${total}äºº`;
        }
      }
    }

    // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderGroupMemberList(users) {
      const container = document.getElementById('groupMemberListContainer');
      container.innerHTML = '';

      updateMemberCount(users.length, groupMemberUsersList.length);

      if (users.length === 0) {
        container.innerHTML = `
          <div class="no-results">
            <div class="no-results-icon">ğŸ”</div>
            <div class="no-results-text">è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>
          </div>
        `;
        return;
      }

      users.forEach(user => {
        const item = document.createElement('div');
        item.className = 'user-list-item-checkbox';
        item.dataset.userName = user.userName;

        // æ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
        if (selectedGroupMembers.includes(user.userName)) {
          item.classList.add('selected');
        }

        item.onclick = () => toggleGroupMember(user.userName, item);

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'user-checkbox';
        checkbox.checked = selectedGroupMembers.includes(user.userName);
        checkbox.onclick = (e) => {
          e.stopPropagation();
          toggleGroupMember(user.userName, item);
        };

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º
        let iconElement;
        if (user.userIconUrl) {
          iconElement = document.createElement('div');
          iconElement.className = 'user-icon';

          const img = document.createElement('img');
          img.src = user.userIconUrl;
          img.alt = user.userName;
          img.onerror = function() {
            const placeholder = document.createElement('div');
            placeholder.className = 'user-icon-placeholder';
            placeholder.textContent = user.userName.charAt(0);
            this.parentElement.replaceWith(placeholder);
          };

          iconElement.appendChild(img);
        } else {
          iconElement = document.createElement('div');
          iconElement.className = 'user-icon-placeholder';
          iconElement.textContent = user.userName.charAt(0);
        }

        const info = document.createElement('div');
        info.className = 'user-info';

        const name = document.createElement('div');
        name.className = 'user-name';
        name.textContent = user.userName;

        const permission = document.createElement('div');
        permission.className = 'user-permission';
        // ğŸ‘‘ã‚’å‰Šé™¤ã—ã¦è¡¨ç¤ºï¼ˆç®¡ç†è€… â†’ ç®¡ç†è€…ï¼‰
        const permText = (user.permissionDisplay || 'ã‚¹ã‚¿ãƒƒãƒ•').replace('ğŸ‘‘ ', '');
        permission.textContent = permText;

        info.appendChild(name);
        info.appendChild(permission);

        item.appendChild(checkbox);
        item.appendChild(iconElement);
        item.appendChild(info);

        container.appendChild(item);
      });
    }

    // ãƒ¡ãƒ³ãƒãƒ¼æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    window.filterGroupMembers = function(searchTerm) {
      const term = searchTerm.toLowerCase().trim();

      if (!term) {
        // æ¤œç´¢èªãŒç©ºã®å ´åˆã¯å…¨å“¡è¡¨ç¤º
        renderGroupMemberList(groupMemberUsersList);
        return;
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      const filtered = groupMemberUsersList.filter(user =>
        user.userName.toLowerCase().includes(term)
      );

      renderGroupMemberList(filtered);
    };

    // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ã®é¸æŠåˆ‡ã‚Šæ›¿ãˆ
    function toggleGroupMember(userName, itemElement) {
      const checkbox = itemElement.querySelector('.user-checkbox');
      const index = selectedGroupMembers.indexOf(userName);

      if (index === -1) {
        // é¸æŠ
        selectedGroupMembers.push(userName);
        checkbox.checked = true;
        itemElement.classList.add('selected');
      } else {
        // é¸æŠè§£é™¤
        selectedGroupMembers.splice(index, 1);
        checkbox.checked = false;
        itemElement.classList.remove('selected');
      }

      console.log('[Group Room] é¸æŠãƒ¡ãƒ³ãƒãƒ¼:', selectedGroupMembers);
    }

    // ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ä½œæˆå®Ÿè¡Œ
    window.submitCreateRoom = async function() {
      console.log('[Rooms List] ãƒ«ãƒ¼ãƒ ä½œæˆå‡¦ç†é–‹å§‹');

      const roomName = document.getElementById('roomNameInput').value.trim();
      const roomIcon = document.getElementById('roomIconSelect').value;

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: ãƒ«ãƒ¼ãƒ åå¿…é ˆ
      if (!roomName) {
        alert('ãƒ«ãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: ãƒ¡ãƒ³ãƒãƒ¼é¸æŠå¿…é ˆ
      if (selectedGroupMembers.length === 0) {
        alert('ãƒ¡ãƒ³ãƒãƒ¼ã‚’1äººä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: ãƒ«ãƒ¼ãƒ åé‡è¤‡ãƒã‚§ãƒƒã‚¯
      try {
        const q = query(
          collection(db, 'rooms'),
          where('name', '==', roomName)
        );
        const snapshot = await getDocs(q);

        if (!snapshot.empty) {
          alert('åŒã˜åå‰ã®ãƒ«ãƒ¼ãƒ ãŒã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚\nåˆ¥ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        // ãƒ¡ãƒ³ãƒãƒ¼é…åˆ—ã‚’ä½œæˆï¼ˆä½œæˆè€… + é¸æŠã•ã‚ŒãŸãƒ¡ãƒ³ãƒãƒ¼ï¼‰
        const members = [currentUserName || 'ä¸æ˜', ...selectedGroupMembers];
        console.log('[Rooms List] ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼:', members);

        // Firestoreã«ãƒ«ãƒ¼ãƒ ä½œæˆ
        console.log('[Rooms List] Firestoreã«ãƒ«ãƒ¼ãƒ ä½œæˆ:', { roomName, roomIcon, members });

        const newRoom = await addDoc(collection(db, 'rooms'), {
          name: roomName,
          icon: roomIcon,
          createdBy: currentUserName || 'ä¸æ˜',
          createdAt: serverTimestamp(),
          lastMessageAt: serverTimestamp(),
          lastMessageText: '',
          lastMessageSender: '',
          members: members,
          type: 'group' // ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆã§ã‚ã‚‹ã“ã¨ã‚’æ˜ç¤º
        });

        console.log('[Rooms List] ãƒ«ãƒ¼ãƒ ä½œæˆæˆåŠŸ:', newRoom.id);

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closeCreateRoomModal();

        // ä½œæˆã—ãŸãƒ«ãƒ¼ãƒ ã‚’é–‹ã
        setTimeout(() => {
          openRoom(newRoom.id);
        }, 500);

      } catch (error) {
        console.error('[Rooms List] ãƒ«ãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ«ãƒ¼ãƒ ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };

    // ========================================
    // å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½
    // ========================================

    // å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.createDirectChat = async function() {
      console.log('[Direct Chat] å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã');
      document.getElementById('directChatModal').classList.add('active');

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
      await loadUserList();
    };

    // å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeDirectChatModal = function() {
      console.log('[Direct Chat] å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹');
      document.getElementById('directChatModal').classList.remove('active');
    };

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€ï¼ˆãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãï¼‰
    let loadUserListRetryCount = 0;
    const MAX_RETRY = 3;

    async function loadUserList() {
      console.log('[Direct Chat] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...');
      const container = document.getElementById('userListContainer');
      container.innerHTML = '<div class="loading">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>';

      try {
        let users;

        // PWAç‰ˆï¼šå¸¸ã«Firestoreã‹ã‚‰æœ€æ–°ã‚’å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ä½¿ã‚ãªã„ï¼‰
        if (isPWA && db) {
          console.log('[Direct Chat] Firestoreã‹ã‚‰ç›´æ¥å–å¾—');
          const snapshot = await getDocs(collection(db, 'users'));
          const allUsers = [];
          snapshot.forEach(doc => {
            const data = doc.data();
            allUsers.push({ id: doc.id, userEmail: doc.id, ...data });
          });
          
          // ğŸ” ãƒ‡ãƒãƒƒã‚°: å–å¾—ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
          console.log('[Direct Chat] å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:', allUsers.length);
          console.log('[Direct Chat] è‡ªåˆ†:', currentUserName, currentUserEmail);
          allUsers.forEach(u => {
            console.log('[Direct Chat] ãƒ¦ãƒ¼ã‚¶ãƒ¼:', u.userName, 'status:', u.status, 'email:', u.id);
          });
          
          // userNameãŒã‚ã‚Šã€æ‰¿èªæ¸ˆã¿ï¼ˆactiveï¼‰ã¾ãŸã¯statusãªã—ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ•ã‚£ãƒ«ã‚¿
          // config.htmlã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯: status === 'active' || !u.status
          users = allUsers.filter(u => u.userName && (u.status === 'active' || !u.status));
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
          if (users.length > 0) {
            usersCache = users;
          }
          console.log('[Direct Chat] ãƒ•ã‚£ãƒ«ã‚¿å¾Œãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:', users.length + 'ä»¶');
        } else if (typeof google !== 'undefined' && google.script && google.script.run) {
          // GASç‰ˆï¼šgoogle.script.runã§å‘¼ã³å‡ºã—
          users = await new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getUserListForUI();
          });
          console.log('[Direct Chat] GASç‰ˆ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—æˆåŠŸ:', users.length + 'ä»¶');
        } else {
          throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
        }

        console.log('[Direct Chat] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—æˆåŠŸ:', users.length + 'ä»¶');

        if (!users || users.length === 0) {
          // ãƒªãƒˆãƒ©ã‚¤ï¼ˆæœ€å¤§3å›ã€1ç§’é–“éš”ï¼‰
          if (loadUserListRetryCount < MAX_RETRY) {
            loadUserListRetryCount++;
            console.log('[Direct Chat] ãƒ¦ãƒ¼ã‚¶ãƒ¼0ä»¶ã®ãŸã‚ãƒªãƒˆãƒ©ã‚¤:', loadUserListRetryCount + '/' + MAX_RETRY);
            container.innerHTML = '<div class="loading">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’åŒæœŸä¸­...</div>';
            setTimeout(() => loadUserList(), 1000);
            return;
          }
          loadUserListRetryCount = 0; // ãƒªã‚»ãƒƒãƒˆ
          // ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ‘¥</div>
              <div class="empty-state-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>
              <div style="font-size: 11px; color: #888; margin-top: 12px; text-align: left; padding: 8px; background: #f5f5f5; border-radius: 4px;">
                <strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong><br>
                è‡ªåˆ†: ${currentUserName}<br>
                Email: ${currentUserEmail}<br>
                isPWA: ${isPWA}<br>
                db: ${db ? 'OK' : 'null'}
              </div>
            </div>
          `;
          return;
        }
        loadUserListRetryCount = 0; // æˆåŠŸã—ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ

        // è‡ªåˆ†è‡ªèº«ã‚’é™¤å¤–
        let filteredUsers = users.filter(u => u.userName !== currentUserName);

        // æ—¢å­˜ã®DMãƒ«ãƒ¼ãƒ ãŒã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é™¤å¤–
        if (isPWA && db && currentUserEmail) {
          try {
            // è‡ªåˆ†ãŒãƒ¡ãƒ³ãƒãƒ¼ã®DMãƒ«ãƒ¼ãƒ ï¼ˆtype: 'direct'ï¼‰ã‚’å–å¾—
            const dmRoomsSnapshot = await getDocs(
              query(
                collection(db, 'rooms'),
                where('type', '==', 'direct'),
                where('memberEmails', 'array-contains', currentUserEmail)
              )
            );

            const existingDmUserEmails = new Set();
            dmRoomsSnapshot.forEach(doc => {
              const data = doc.data();
              // memberEmailsã‹ã‚‰è‡ªåˆ†ä»¥å¤–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
              if (data.memberEmails && Array.isArray(data.memberEmails)) {
                data.memberEmails.forEach(email => {
                  if (email !== currentUserEmail) {
                    existingDmUserEmails.add(email);
                  }
                });
              }
            });

            console.log('[Direct Chat] æ—¢å­˜DMãƒ¦ãƒ¼ã‚¶ãƒ¼:', [...existingDmUserEmails]);

            // æ—¢å­˜DMãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é™¤å¤–
            filteredUsers = filteredUsers.filter(u => {
              const userEmail = u.userEmail || u.email || u.id;
              return !existingDmUserEmails.has(userEmail);
            });
          } catch (error) {
            console.error('[Direct Chat] æ—¢å­˜DMãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
            // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯é™¤å¤–ã›ãšã«ç¶šè¡Œ
          }
        }

        if (filteredUsers.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ‘¥</div>
              <div class="empty-state-text">æ–°ã—ãå€‹åˆ¥ãƒãƒ£ãƒƒãƒˆã‚’ä½œæˆã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</div>
            </div>
          `;
          return;
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º
        container.innerHTML = '';
        filteredUsers.forEach(user => {
          const item = document.createElement('div');
          item.className = 'user-list-item';
          item.onclick = () => selectUserForDirectChat(user);

          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º
          let iconElement;
          if (user.userIconUrl) {
            // ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒãŒã‚ã‚‹å ´åˆ
            iconElement = document.createElement('div');
            iconElement.className = 'user-icon';
            
            const img = document.createElement('img');
            img.src = user.userIconUrl;
            img.alt = user.userName;
            img.onerror = function() {
              // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
              const placeholder = document.createElement('div');
              placeholder.className = 'user-icon-placeholder';
              placeholder.textContent = user.userName.charAt(0);
              this.parentElement.replaceWith(placeholder);
            };
            
            iconElement.appendChild(img);
          } else {
            // ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒãŒãªã„å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
            iconElement = document.createElement('div');
            iconElement.className = 'user-icon-placeholder';
            iconElement.textContent = user.userName.charAt(0);
          }

          const info = document.createElement('div');
          info.className = 'user-info';

          const name = document.createElement('div');
          name.className = 'user-name';
          name.textContent = user.userName;

          const permission = document.createElement('div');
          permission.className = 'user-permission';
          // ğŸ‘‘ã‚’å‰Šé™¤ã—ã¦è¡¨ç¤ºï¼ˆç®¡ç†è€… â†’ ç®¡ç†è€…ï¼‰
          const permText = (user.permissionDisplay || 'ã‚¹ã‚¿ãƒƒãƒ•').replace('ğŸ‘‘ ', '');
          permission.textContent = permText;

          info.appendChild(name);
          info.appendChild(permission);

          item.appendChild(iconElement);
          item.appendChild(info);

          container.appendChild(item);
        });

      } catch (error) {
        console.error('[Direct Chat] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">âš ï¸</div>
            <div class="empty-state-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>
            <div style="font-size: 14px; color: #a0aec0;">${error.message}</div>
          </div>
        `;
      }
    }

    // roomIdç”Ÿæˆï¼ˆdm_[email1]_[email2]ã€ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ï¼‰
    function generateDirectRoomId(email1, email2) {
      // @ã‚’_at_ã«ã€.ã‚’_ã«ç½®æ›ï¼ˆFirestoreäº’æ›ï¼‰
      const sanitize = (email) => email.replace(/@/g, '_at_').replace(/\./g, '_');
      const emails = [sanitize(email1), sanitize(email2)].sort();
      return `dm_${emails[0]}_${emails[1]}`;
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠæ™‚ã®å‡¦ç†
    async function selectUserForDirectChat(targetUser) {
      // Firestoreã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯ userEmail ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½¿ç”¨
      const targetEmail = targetUser.userEmail || targetUser.email;
      console.log('[Direct Chat] ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠ:', targetUser.userName, targetEmail);

      if (!currentUserEmail || !targetEmail) {
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“');
        return;
      }

      try {
        // roomIdç”Ÿæˆï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ™ãƒ¼ã‚¹ï¼‰
        const roomId = generateDirectRoomId(currentUserEmail, targetEmail);
        console.log('[Direct Chat] ç”Ÿæˆã•ã‚ŒãŸroomId:', roomId);

        // æ—¢å­˜ã®DMãƒ«ãƒ¼ãƒ ã‚’ãƒã‚§ãƒƒã‚¯
        const q = query(
          collection(db, 'rooms'),
          where('__name__', '==', roomId)
        );
        const snapshot = await getDocs(q);

        if (!snapshot.empty) {
          // æ—¢å­˜ãƒ«ãƒ¼ãƒ ãŒå­˜åœ¨ â†’ é–‹ãã ã‘
          console.log('[Direct Chat] æ—¢å­˜ã®DMãƒ«ãƒ¼ãƒ ã‚’é–‹ã:', roomId);
          closeDirectChatModal();
          setTimeout(() => {
            openRoom(roomId);
          }, 300);
          return;
        }

        // æ–°è¦DMãƒ«ãƒ¼ãƒ ä½œæˆ
        console.log('[Direct Chat] æ–°è¦DMãƒ«ãƒ¼ãƒ ä½œæˆ:', roomId);
        await createDirectChatRoom(roomId, targetUser);

      } catch (error) {
        console.error('[Direct Chat] DMãƒ«ãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
        alert('å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ç¾åœ¨ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½è·¡
    let currentlySwipedItem = null;

    // ã™ã¹ã¦ã®ã‚¹ãƒ¯ã‚¤ãƒ—ã‚’é–‰ã˜ã‚‹
    function closeAllSwipes() {
      if (currentlySwipedItem) {
        currentlySwipedItem.style.transform = 'translateX(0)';
        currentlySwipedItem = null;
      }
    }

    // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼è¨­å®š
    function setupSwipeGesture(wrapper, item) {
      let startX = 0;
      let startY = 0;
      let currentX = 0;
      let isSwiping = false;
      let isScrolling = false;
      let directionLocked = false;
      const rightButtonWidth = 140; // éè¡¨ç¤º + å‰Šé™¤ã®åˆè¨ˆå¹…
      const leftButtonWidth = 140;  // ãƒŸãƒ¥ãƒ¼ãƒˆ + ãƒ”ãƒ³ç•™ã‚ã®åˆè¨ˆå¹…

      item.addEventListener('touchstart', (e) => {
        // ä»–ã®ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Œã°é–‰ã˜ã‚‹
        if (currentlySwipedItem && currentlySwipedItem !== item) {
          currentlySwipedItem.style.transform = 'translateX(0)';
        }

        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        currentX = startX;
        isSwiping = false;
        isScrolling = false;
        directionLocked = false;
        item.classList.add('swiping');
      });

      item.addEventListener('touchmove', (e) => {
        const deltaX = Math.abs(e.touches[0].clientX - startX);
        const deltaY = Math.abs(e.touches[0].clientY - startY);

        // æ–¹å‘ãŒã¾ã ç¢ºå®šã—ã¦ã„ãªã„å ´åˆã€åˆ¤å®šã™ã‚‹
        if (!directionLocked && (deltaX > 10 || deltaY > 10)) {
          directionLocked = true;
          // æ¨ªæ–¹å‘ã®å‹•ããŒç¸¦æ–¹å‘ã‚ˆã‚Š1.5å€ä»¥ä¸Šå¤§ãã„å ´åˆã®ã¿ã‚¹ãƒ¯ã‚¤ãƒ—
          if (deltaX > deltaY * 1.5 && deltaX > 15) {
            isSwiping = true;
            isScrolling = false;
          } else {
            isSwiping = false;
            isScrolling = true;
          }
        }

        if (isSwiping) {
          e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²æ­¢
          currentX = e.touches[0].clientX;
          const diff = currentX - startX;

          // å·¦ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆdiff < 0ï¼‰ï¼šéè¡¨ç¤ºãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³è¡¨ç¤º
          if (diff < 0) {
            const offset = Math.max(diff, -rightButtonWidth);
            item.style.transform = `translateX(${offset}px)`;
          }
          // å³ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆdiff > 0ï¼‰ï¼šãƒŸãƒ¥ãƒ¼ãƒˆãƒ»ãƒ”ãƒ³ç•™ã‚ãƒœã‚¿ãƒ³è¡¨ç¤º
          else if (diff > 0) {
            const offset = Math.min(diff, leftButtonWidth);
            item.style.transform = `translateX(${offset}px)`;
          }
        }
      }, { passive: false });

      item.addEventListener('touchend', (e) => {
        item.classList.remove('swiping');

        // ã‚¹ãƒ¯ã‚¤ãƒ—ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®ã¿ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        if (isSwiping) {
          const diff = currentX - startX;

          if (diff < -40) {
            // å·¦ã«40pxä»¥ä¸Šã‚¹ãƒ¯ã‚¤ãƒ—ã§éè¡¨ç¤ºãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³è¡¨ç¤º
            item.style.transform = `translateX(-${rightButtonWidth}px)`;
            currentlySwipedItem = item;
          } else if (diff > 40) {
            // å³ã«40pxä»¥ä¸Šã‚¹ãƒ¯ã‚¤ãƒ—ã§ãƒŸãƒ¥ãƒ¼ãƒˆãƒ»ãƒ”ãƒ³ç•™ã‚ãƒœã‚¿ãƒ³è¡¨ç¤º
            item.style.transform = `translateX(${leftButtonWidth}px)`;
            currentlySwipedItem = item;
          } else {
            // é–‰ã˜ã‚‹
            item.style.transform = 'translateX(0)';
            if (currentlySwipedItem === item) {
              currentlySwipedItem = null;
            }
          }
        }

        // ãƒªã‚»ãƒƒãƒˆ
        isSwiping = false;
        isScrolling = false;
        directionLocked = false;
        startX = 0;
        startY = 0;
        currentX = 0;
      });
    }

    // ãƒ«ãƒ¼ãƒ ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆ
    async function toggleMuteRoom(roomId, currentlyMuted) {
      try {
        console.log('[Mute Room] ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆ:', { roomId, currentlyMuted, currentUserName });

        const roomRef = doc(db, 'rooms', roomId);
        const roomSnap = await getDoc(roomRef);

        if (!roomSnap.exists()) {
          console.error('[Mute Room] ãƒ«ãƒ¼ãƒ ãŒå­˜åœ¨ã—ã¾ã›ã‚“:', roomId);
          return;
        }

        const roomData = roomSnap.data();
        let mutedBy = roomData.mutedBy || [];

        if (currentlyMuted) {
          // ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤ï¼šé…åˆ—ã‹ã‚‰å‰Šé™¤
          mutedBy = mutedBy.filter(user => user !== currentUserName);
          console.log('[Mute Room] ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤:', currentUserName);
        } else {
          // ãƒŸãƒ¥ãƒ¼ãƒˆï¼šé…åˆ—ã«è¿½åŠ 
          if (!mutedBy.includes(currentUserName)) {
            mutedBy.push(currentUserName);
          }
          console.log('[Mute Room] ãƒŸãƒ¥ãƒ¼ãƒˆè¨­å®š:', currentUserName);
        }

        // Firestoreã‚’æ›´æ–°
        await updateDoc(roomRef, { mutedBy });
        console.log('[Mute Room] æ›´æ–°æˆåŠŸ:', mutedBy);

        // UIã¯è‡ªå‹•çš„ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã•ã‚Œã‚‹ï¼ˆonSnapshotï¼‰

      } catch (error) {
        console.error('[Mute Room] ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒŸãƒ¥ãƒ¼ãƒˆè¨­å®šã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ãƒ«ãƒ¼ãƒ ãƒ”ãƒ³ç•™ã‚åˆ‡ã‚Šæ›¿ãˆ
    async function togglePinRoom(roomId, currentlyPinned) {
      try {
        console.log('[Pin Room] ãƒ”ãƒ³ç•™ã‚åˆ‡ã‚Šæ›¿ãˆ:', { roomId, currentlyPinned, currentUserName });

        const roomRef = doc(db, 'rooms', roomId);
        const roomSnap = await getDoc(roomRef);

        if (!roomSnap.exists()) {
          console.error('[Pin Room] ãƒ«ãƒ¼ãƒ ãŒå­˜åœ¨ã—ã¾ã›ã‚“:', roomId);
          return;
        }

        const roomData = roomSnap.data();
        let pinnedBy = roomData.pinnedBy || [];

        if (currentlyPinned) {
          // ãƒ”ãƒ³è§£é™¤ï¼šé…åˆ—ã‹ã‚‰å‰Šé™¤
          pinnedBy = pinnedBy.filter(user => user !== currentUserName);
          console.log('[Pin Room] ãƒ”ãƒ³è§£é™¤:', currentUserName);
        } else {
          // ãƒ”ãƒ³ç•™ã‚ï¼šé…åˆ—ã«è¿½åŠ 
          if (!pinnedBy.includes(currentUserName)) {
            pinnedBy.push(currentUserName);
          }
          console.log('[Pin Room] ãƒ”ãƒ³ç•™ã‚è¨­å®š:', currentUserName);
        }

        // Firestoreã‚’æ›´æ–°
        await updateDoc(roomRef, { pinnedBy });
        console.log('[Pin Room] æ›´æ–°æˆåŠŸ:', pinnedBy);

        // UIã¯è‡ªå‹•çš„ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã•ã‚Œã‚‹ï¼ˆonSnapshotï¼‰

      } catch (error) {
        console.error('[Pin Room] ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ”ãƒ³ç•™ã‚è¨­å®šã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ãƒ«ãƒ¼ãƒ éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    async function toggleHideRoom(roomId) {
      try {
        console.log('[Hide Room] éè¡¨ç¤ºè¨­å®š:', { roomId, currentUserName });

        const roomRef = doc(db, 'rooms', roomId);
        const roomSnap = await getDoc(roomRef);

        if (!roomSnap.exists()) {
          console.error('[Hide Room] ãƒ«ãƒ¼ãƒ ãŒå­˜åœ¨ã—ã¾ã›ã‚“:', roomId);
          return;
        }

        const roomData = roomSnap.data();
        let hiddenBy = roomData.hiddenBy || [];

        // éè¡¨ç¤ºï¼šé…åˆ—ã«è¿½åŠ ï¼ˆãƒˆã‚°ãƒ«ã§ã¯ãªãå¸¸ã«éè¡¨ç¤ºåŒ–ï¼‰
        if (!hiddenBy.includes(currentUserName)) {
          hiddenBy.push(currentUserName);
        }
        console.log('[Hide Room] éè¡¨ç¤ºè¨­å®š:', currentUserName);

        // Firestoreã‚’æ›´æ–°
        await updateDoc(roomRef, { hiddenBy });
        console.log('[Hide Room] æ›´æ–°æˆåŠŸ:', hiddenBy);

        // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚’ãƒªã‚»ãƒƒãƒˆ
        closeAllSwipes();

        // UIã¯è‡ªå‹•çš„ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã•ã‚Œã‚‹ï¼ˆonSnapshotï¼‰

      } catch (error) {
        console.error('[Hide Room] ã‚¨ãƒ©ãƒ¼:', error);
        alert('éè¡¨ç¤ºè¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    function confirmDeleteRoom(roomId, roomName) {
      const displayName = roomName || 'ä¸æ˜ãªãƒ«ãƒ¼ãƒ ';
      if (confirm(`ã€Œ${displayName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nä¼šè©±å±¥æ­´ã‚‚å®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
        deleteRoom(roomId);
      }
    }

    // ãƒ«ãƒ¼ãƒ å‰Šé™¤ï¼ˆã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å«ã‚€å®Œå…¨å‰Šé™¤ï¼‰
    async function deleteRoom(roomId) {
      try {
        console.log('[Delete Room] å‰Šé™¤é–‹å§‹:', roomId);

        // 1. messagesã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
        const messagesRef = collection(db, `rooms/${roomId}/messages`);
        const messagesSnapshot = await getDocs(messagesRef);

        console.log('[Delete Room] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°:', messagesSnapshot.size);

        const deleteBatch = [];
        messagesSnapshot.forEach((doc) => {
          deleteBatch.push(deleteDoc(doc.ref));
        });

        if (deleteBatch.length > 0) {
          await Promise.all(deleteBatch);
          console.log('[Delete Room] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤å®Œäº†');
        }

        // 2. unreadCountsã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
        const unreadRef = collection(db, `rooms/${roomId}/unreadCounts`);
        const unreadSnapshot = await getDocs(unreadRef);

        const unreadBatch = [];
        unreadSnapshot.forEach((doc) => {
          unreadBatch.push(deleteDoc(doc.ref));
        });

        if (unreadBatch.length > 0) {
          await Promise.all(unreadBatch);
          console.log('[Delete Room] æœªèª­ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤å®Œäº†');
        }

        // 3. roomãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
        await deleteDoc(doc(db, 'rooms', roomId));
        console.log('[Delete Room] ãƒ«ãƒ¼ãƒ å‰Šé™¤å®Œäº†');

        // 4. UIã‹ã‚‰å‰Šé™¤
        const wrapper = document.querySelector(`.room-item-wrapper[data-room-id="${roomId}"]`);
        if (wrapper) {
          wrapper.style.opacity = '0';
          wrapper.style.transform = 'translateX(-100%)';
          setTimeout(() => {
            wrapper.remove();
          }, 300);
        }

        alert('ãƒ«ãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');

      } catch (error) {
        console.error('[Delete Room] ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ«ãƒ¼ãƒ ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // Firestore roomsã«å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ä½œæˆ
    async function createDirectChatRoom(roomId, targetUser) {
      try {
        // Firestoreã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯ userEmail ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½¿ç”¨
        const targetEmail = targetUser.userEmail || targetUser.email;

        // ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã§ãƒ«ãƒ¼ãƒ ä½œæˆ
        await setDoc(doc(db, 'rooms', roomId), {
          name: '',  // å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆã¯å‹•çš„ç”Ÿæˆã™ã‚‹ãŸã‚ç©ºæ¬„
          type: 'direct',
          icon: 'ğŸ‘¤',
          members: [currentUserName, targetUser.userName],
          memberEmails: [currentUserEmail, targetEmail],  // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚‚ä¿å­˜
          createdBy: currentUserName,
          createdAt: serverTimestamp(),
          lastMessageAt: serverTimestamp(),
          lastMessage: '',
          lastMessageBy: ''
        });

        console.log('[Direct Chat] DMãƒ«ãƒ¼ãƒ ä½œæˆæˆåŠŸ:', roomId);

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closeDirectChatModal();

        // ä½œæˆã—ãŸãƒ«ãƒ¼ãƒ ã‚’é–‹ã
        setTimeout(() => {
          openRoom(roomId);
        }, 500);

      } catch (error) {
        console.error('[Direct Chat] Firestoreæ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        throw error;
      }
    }

    // ãƒãƒ£ãƒƒãƒˆã‚¿ã‚¤ãƒ—é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã
    window.openChatTypeMenu = function() {
      document.getElementById('chatTypeMenuModal').classList.add('active');
    }

    // ãƒãƒ£ãƒƒãƒˆã‚¿ã‚¤ãƒ—é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
    window.closeChatTypeMenu = function() {
      document.getElementById('chatTypeMenuModal').classList.remove('active');
    }

    // ãƒãƒ£ãƒƒãƒˆã‚¿ã‚¤ãƒ—ã‚’é¸æŠ
    window.selectChatType = async function(type) {
      window.closeChatTypeMenu();

      if (type === 'room') {
        // æ–°è¦ãƒ«ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        document.getElementById('createRoomModal').classList.add('active');
        // çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('roomIconSelect').value = 'ğŸ’¬';
        document.getElementById('selectedEmojiPreview').textContent = 'ğŸ’¬';
        // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
        await loadGroupMemberList();
      } else if (type === 'direct') {
        // å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        document.getElementById('directChatModal').classList.add('active');
        loadUserList();
      }
    }
  </script>

  <!-- æ¤œç´¢æ©Ÿèƒ½ -->
  <script>
    // æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹ã
    window.openSearchMode = function() {
      const headerNormal = document.getElementById('headerNormal');
      const headerSearch = document.getElementById('headerSearch');
      const searchInput = document.getElementById('searchInput');

      headerNormal.classList.add('hidden');
      headerSearch.classList.add('active');
      searchInput.focus();
    };

    // æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ã‚’é–‰ã˜ã‚‹
    window.closeSearchMode = function() {
      const headerNormal = document.getElementById('headerNormal');
      const headerSearch = document.getElementById('headerSearch');
      const searchInput = document.getElementById('searchInput');

      headerNormal.classList.remove('hidden');
      headerSearch.classList.remove('active');
      searchInput.value = '';

      // å…¨ãƒ«ãƒ¼ãƒ ã‚’è¡¨ç¤ºã—ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤
      const roomWrappers = document.querySelectorAll('.room-item-wrapper');
      roomWrappers.forEach(wrapper => {
        wrapper.classList.remove('search-hidden');
        // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤
        const roomNameEl = wrapper.querySelector('.room-name');
        const lastMessageEl = wrapper.querySelector('.room-last-message');
        removeHighlights(roomNameEl);
        removeHighlights(lastMessageEl);
      });
    };

    // ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function highlightText(text, query) {
      if (!text || !query) return text;
      const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
      return text.replace(regex, '<span class="search-highlight">$1</span>');
    }

    // æ­£è¦è¡¨ç¾ç”¨ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤
    function removeHighlights(element) {
      if (!element) return;
      const highlights = element.querySelectorAll('.search-highlight');
      highlights.forEach(el => {
        const parent = el.parentNode;
        parent.replaceChild(document.createTextNode(el.textContent), el);
        parent.normalize();
      });
    }

    // æ¤œç´¢å®Ÿè¡Œ
    window.performSearch = function() {
      const searchInput = document.getElementById('searchInput');
      const query = searchInput.value.trim();
      const queryLower = query.toLowerCase();

      // æ¤œç´¢ã‚¯ã‚¨ãƒªãŒãªã„å ´åˆã¯å…¨ã¦è¡¨ç¤ºã—ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆå‰Šé™¤
      if (!query) {
        const roomWrappers = document.querySelectorAll('.room-item-wrapper');
        roomWrappers.forEach(wrapper => {
          wrapper.classList.remove('search-hidden');
          // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤ã—ã¦å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã«æˆ»ã™
          const roomNameEl = wrapper.querySelector('.room-name');
          const lastMessageEl = wrapper.querySelector('.room-last-message');
          removeHighlights(roomNameEl);
          removeHighlights(lastMessageEl);
        });
        return;
      }

      // ãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚’æ¤œç´¢
      const roomWrappers = document.querySelectorAll('.room-item-wrapper');
      let matchCount = 0;

      roomWrappers.forEach(wrapper => {
        const roomItem = wrapper.querySelector('.room-item');
        if (!roomItem) return;

        // æ¤œç´¢å¯¾è±¡è¦ç´ ã‚’å–å¾—
        const roomNameEl = roomItem.querySelector('.room-name');
        const lastMessageEl = roomItem.querySelector('.room-last-message');

        // ã¾ãšãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤
        removeHighlights(roomNameEl);
        removeHighlights(lastMessageEl);

        // å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
        const roomName = roomNameEl?.textContent || '';
        const lastMessage = lastMessageEl?.textContent || '';

        // ãƒ«ãƒ¼ãƒ åã€æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆé€ä¿¡è€…å«ã‚€ï¼‰ã§æ¤œç´¢
        const searchText = `${roomName} ${lastMessage}`.toLowerCase();

        if (searchText.includes(queryLower)) {
          wrapper.classList.remove('search-hidden');
          matchCount++;

          // ãƒãƒƒãƒã—ãŸç®‡æ‰€ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
          if (roomNameEl && roomName.toLowerCase().includes(queryLower)) {
            roomNameEl.innerHTML = highlightText(roomName, query);
          }
          if (lastMessageEl && lastMessage.toLowerCase().includes(queryLower)) {
            lastMessageEl.innerHTML = highlightText(lastMessage, query);
          }
        } else {
          wrapper.classList.add('search-hidden');
        }
      });
    };

    // v325: å¸¸æ™‚è¡¨ç¤ºæ¤œç´¢ãƒãƒ¼ç”¨ã®æ–°é–¢æ•°
    window.performSearchNew = function() {
      const searchInput = document.getElementById('searchInput');
      const clearBtn = document.getElementById('searchClearBtn');
      const query = searchInput.value.trim();

      // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ‡æ›¿
      if (clearBtn) {
        clearBtn.classList.toggle('show', query.length > 0);
      }

      // æ—¢å­˜ã®performSearché–¢æ•°ã‚’å‘¼ã³å‡ºã—
      performSearch();
    };

    // v325: æ¤œç´¢ã‚¯ãƒªã‚¢
    window.clearSearch = function() {
      const searchInput = document.getElementById('searchInput');
      const clearBtn = document.getElementById('searchClearBtn');

      if (searchInput) {
        searchInput.value = '';
        searchInput.focus();
      }
      if (clearBtn) {
        clearBtn.classList.remove('show');
      }

      // å…¨ãƒ«ãƒ¼ãƒ ã‚’è¡¨ç¤ºã—ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆå‰Šé™¤
      const roomWrappers = document.querySelectorAll('.room-item-wrapper');
      roomWrappers.forEach(wrapper => {
        wrapper.classList.remove('search-hidden');
        const roomNameEl = wrapper.querySelector('.room-name');
        const lastMessageEl = wrapper.querySelector('.room-last-message');
        removeHighlights(roomNameEl);
        removeHighlights(lastMessageEl);
      });
    };
  </script>

  <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³å‡¦ç† -->
<script>
  console.log('[chat_rooms_list] âœ… Script loaded - Version @899-debug');
  
  async function goBack() {
    console.log('[chat_rooms_list] >>> goBack() called at', new Date().toISOString());
    const isInIframe = window.self !== window.top;
    console.log('[chat_rooms_list] isInIframe:', isInIframe);
    
    if (isInIframe) {
      console.log('[chat_rooms_list] iframeå†…ã§é–‹ã‹ã‚Œã¦ã„ã‚‹ãŸã‚ã€postMessageé€ä¿¡ï¼ˆå±¥æ­´ãƒ™ãƒ¼ã‚¹ã®æˆ»ã‚‹ï¼‰');
      window.top.postMessage({ type: 'goBack' }, '*');
      console.log('[chat_rooms_list] âœ… postMessageé€ä¿¡å®Œäº† (type: goBack)');
    } else {
      console.log('[chat_rooms_list] ç›´æ¥é–‹ã‹ã‚Œã¦ã„ã‚‹ãŸã‚ã€google.script.host.close()');
      google.script.host.close();
    }
  }
  
  document.addEventListener('DOMContentLoaded', () => {
    console.log('[chat_rooms_list] DOMContentLoaded fired');
    const backButton = document.getElementById('back-button');
    console.log('[chat_rooms_list] backButton element:', backButton);
    
    if (backButton) {
      backButton.addEventListener('click', goBack);
      console.log('[chat_rooms_list] âœ… æˆ»ã‚‹ãƒœã‚¿ãƒ³ã«goBack()ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ');
    } else {
      console.error('[chat_rooms_list] âŒ æˆ»ã‚‹ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
  });
</script>

</body>
</html>
