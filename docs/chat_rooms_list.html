<!DOCTYPE html>
<html>
<head>
  <!-- Cache Bust: 2025-11-13 12:45 -->
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ¼ãƒ  ãƒãƒ£ãƒƒãƒˆ</title>
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- REBORN Brand Colors & Theme -->
  <link rel="stylesheet" href="https://www.reborn-inventory.com/css/reborn-brand-colors.css?v=0bd1a9b">
  <link rel="stylesheet" href="https://www.reborn-inventory.com/css/reborn-theme.css?v=0bd1a9b">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      height: 100vh;
      overflow: hidden;
    }
    .user-info {
      font-size: 13px;
      color: #6b7280;
      padding: 8px 16px;
      background: #f8f9fa;
      border-bottom: 1px solid #e5e7eb;
    }
    .create-room-button {
      background: var(--reborn-primary);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      margin: 16px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .create-room-button:active {
      transform: scale(0.98);
      box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
    }
    .rooms-container {
      height: calc(100vh - 120px);
      overflow-y: auto;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.9);
      margin: 0 16px 16px 16px;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    .room-item-wrapper {
      position: relative;
      margin-bottom: 12px;
      overflow: hidden;
      border-radius: 12px;
    }
    .room-item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      cursor: pointer;
      transition: transform 0.3s ease;
      display: flex;
      gap: 12px;
      align-items: center;
      position: relative;
      z-index: 2;
    }
    .room-item.swiping {
      transition: none;
    }
    .room-item:active:not(.swiping) {
      transform: scale(0.98);
      background: #f7fafc;
    }

    /* ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIï¼ˆãƒ«ãƒ¼ãƒ ã‚¿ãƒƒãƒ—æ™‚ã«å…¨ç”»é¢è¡¨ç¤ºï¼‰ */
    #skeleton-loader {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: rgba(255, 255, 255, 0.95);
      z-index: 9999;
      padding: 20px;
      overflow: hidden;
    }

    #skeleton-loader.active {
      display: block;
    }

    .skeleton-header {
      width: 100%;
      height: 60px;
      background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
      background-size: 200% 100%;
      animation: skeleton-pulse 1.5s ease-in-out infinite;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .skeleton-room {
      width: 100%;
      height: 80px;
      background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
      background-size: 200% 100%;
      animation: skeleton-pulse 1.5s ease-in-out infinite;
      border-radius: 12px;
      margin-bottom: 12px;
    }

    .loading-spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 48px;
      height: 48px;
      border: 4px solid #e0e0e0;
      border-top: 4px solid var(--reborn-primary);
      border-radius: 50%;
      animation: spinner-rotate 1s linear infinite;
      z-index: 10;
    }

    @keyframes skeleton-pulse {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    @keyframes spinner-rotate {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    .delete-button {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 80px;
      background: #ef4444;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      z-index: 1;
      transition: all 0.3s ease;
    }
    .delete-button:active {
      background: #dc2626;
    }
    .room-icon {
      font-size: 32px;
      flex-shrink: 0;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      border-radius: 50%;
      color: white;
    }
    .room-content {
      flex: 1;
      min-width: 0;
    }
    .room-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 4px;
    }
    .room-name {
      font-size: 16px;
      font-weight: 600;
      color: #2d3748;
      flex: 1;
    }
    .room-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }
    .room-time {
      font-size: 12px;
      color: #a0aec0;
    }
    .room-preview {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .room-last-message {
      font-size: 14px;
      color: #718096;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
    }
    .unread-badge {
      background: #ef4444;
      color: white;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 600;
      min-width: 20px;
      text-align: center;
      display: inline-block;
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #718096;
    }
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }
    .empty-state-text {
      font-size: 16px;
      margin-bottom: 8px;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #718096;
    }
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }
    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 8px;
    }
    .form-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--reborn-primary);
    }
    .form-select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      background: white;
      cursor: pointer;
    }
    .modal-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    .modal-button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .modal-button.primary {
      background: var(--reborn-primary);
      color: white;
    }
    .modal-button.primary:hover {
      background: #5568d3;
    }
    .modal-button.secondary {
      background: #e2e8f0;
      color: #4a5568;
    }
    .modal-button.secondary:hover {
      background: #cbd5e0;
    }
    .user-list-item {
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .user-list-item:hover {
      border-color: #48bb78;
      background: #f0fff4;
    }
    .user-list-item:active {
      transform: scale(0.98);
    }
    .user-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .user-icon img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #e2e8f0;
    }
    .user-icon-placeholder {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 600;
      flex-shrink: 0;
      border: 2px solid #e2e8f0;
    }
    .user-info {
      flex: 1;
      min-width: 0;
    }
    .user-name {
      font-size: 16px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 4px;
    }
    .user-permission {
      font-size: 12px;
      color: #718096;
    }
  </style>
</head>
<body>
  <!-- ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIï¼ˆãƒ«ãƒ¼ãƒ ã‚¿ãƒƒãƒ—æ™‚ã«å…¨ç”»é¢è¡¨ç¤ºï¼‰ -->
  <div id="skeleton-loader">
    <div class="skeleton-header"></div>
    <div class="skeleton-room"></div>
    <div class="skeleton-room"></div>
    <div class="skeleton-room"></div>
    <div class="skeleton-room"></div>
    <div class="skeleton-room"></div>
    <div class="loading-spinner"></div>
  </div>

  <!-- çµ±ä¸€ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <div class="header-content">
      <button class="back-button" id="back-button">
        <i class="bi bi-chevron-left"></i>
      </button>
      <div class="header-title">
        <i class="bi bi-chat-dots"></i>
        ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ 
      </div>
      <div style="width: 40px;"></div>
    </div>
  </div>

  <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãƒãƒ¼ -->
  <div class="user-info" id="userInfo">èª­ã¿è¾¼ã¿ä¸­...</div>

  <button class="create-room-button" id="createRoomButton" onclick="createRoom()">
    â• æ–°ã—ã„ãƒ«ãƒ¼ãƒ ä½œæˆ
  </button>

  <button class="create-room-button" id="createDirectChatButton" onclick="createDirectChat()" style="background: #48bb78; box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);">
    ğŸ‘¤ å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆä½œæˆ
  </button>

  <div class="rooms-container" id="roomsContainer">
    <div class="loading">ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
  </div>

  <!-- ãƒ«ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="createRoomModal">
    <div class="modal-content">
      <div class="modal-title">â• æ–°ã—ã„ãƒ«ãƒ¼ãƒ ä½œæˆ</div>
      <form id="createRoomForm" onsubmit="return false;">
        <div class="form-group">
          <label class="form-label" for="roomNameInput">ãƒ«ãƒ¼ãƒ å *</label>
          <input
            type="text"
            class="form-input"
            id="roomNameInput"
            placeholder="ä¾‹: å•†å“ä¼ç”»ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°"
            maxlength="50"
            required
          />
        </div>
        <div class="form-group">
          <label class="form-label" for="roomIconSelect">ã‚¢ã‚¤ã‚³ãƒ³</label>
          <select class="form-select" id="roomIconSelect">
            <option value="ğŸ’¬">ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ</option>
            <option value="ğŸ“¢">ğŸ“¢ ãŠçŸ¥ã‚‰ã›</option>
            <option value="ğŸ’¡">ğŸ’¡ ã‚¢ã‚¤ãƒ‡ã‚¢</option>
            <option value="ğŸ“Š">ğŸ“Š ä¼šè­°</option>
            <option value="ğŸ¯">ğŸ¯ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</option>
            <option value="ğŸ“¦">ğŸ“¦ åœ¨åº«</option>
            <option value="ğŸš€">ğŸš€ ãƒªãƒªãƒ¼ã‚¹</option>
            <option value="ğŸ”§">ğŸ”§ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹</option>
            <option value="ğŸ‰">ğŸ‰ ã‚¤ãƒ™ãƒ³ãƒˆ</option>
            <option value="â­">â­ é‡è¦</option>
          </select>
        </div>
        <div class="modal-buttons">
          <button type="button" class="modal-button secondary" onclick="closeCreateRoomModal()">
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button type="submit" class="modal-button primary" onclick="submitCreateRoom()">
            ä½œæˆ
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="directChatModal">
    <div class="modal-content">
      <div class="modal-title">ğŸ‘¤ å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆä½œæˆ</div>
      <div style="margin-bottom: 16px; font-size: 14px; color: #718096;">
        ãƒãƒ£ãƒƒãƒˆã—ãŸã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„
      </div>
      
      <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ -->
      <div id="userListContainer" style="max-height: 400px; overflow-y: auto; margin-bottom: 16px;">
        <div class="loading">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
      </div>

      <div class="modal-buttons">
        <button type="button" class="modal-button secondary" onclick="closeDirectChatModal()">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
      </div>
    </div>
  </div>

  <!-- Firestore API Wrapper (ARCH-001 Phase 2) -->
  <script type="module" src="https://www.reborn-inventory.com/js/firestore-api.js?v=850"></script>

  <!-- GAS API Wrapper (ARCH-001 Phase 2) -->
  <script src="https://www.reborn-inventory.com/js/api.js?v=850"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, doc, query, orderBy, onSnapshot, addDoc, serverTimestamp, getDocs, where, setDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebaseè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "reborn-chat.firebaseapp.com",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    // FirebaseåˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    console.log('[Firestore] åˆæœŸåŒ–å®Œäº†');

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function getQueryParam(key) {
      try {
        return new URLSearchParams(location.search).get(key) || '';
      } catch(e) {
        return '';
      }
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let currentUserName = '';
    let usersCache = []; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥

    // PWAç‰ˆï¼šURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼ˆGASãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ã¯ä½¿ç”¨ã—ãªã„ï¼‰
    const isPWAFlag        = true;  // PWAç‰ˆã¨ã—ã¦å‹•ä½œ
    const pwaUserNameParam = getQueryParam('userName') || '';
    const gasUserNameParam = '';
    const pwaParentOriginParam = window.location.origin;  // PWAç‰ˆã®origin
    const pwaPmTokenParam = '';
    const gasBaseUrlParam  = '';

    // parentOrigin ã¨ pmToken ã‚’è¨­å®šï¼ˆPWAç‰ˆã§ã¯å›ºå®šå€¤ã‚’ä½¿ç”¨ï¼‰
    const parentOrigin = 'https://furira.jp';  // PWAç‰ˆã®è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦origin
    const pmToken = '';

    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
    console.log('[Rooms List] ãƒ‡ãƒãƒƒã‚°æƒ…å ±:');
    console.log('  - URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ parentOrigin:', getQueryParam('parentOrigin'));
    console.log('  - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ pwaParentOriginParam:', pwaParentOriginParam);
    console.log('  - æœ€çµ‚ parentOrigin:', parentOrigin);
    console.log('  - URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ pmToken:', getQueryParam('pmToken'));
    console.log('  - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ pwaPmTokenParam:', pwaPmTokenParam);
    console.log('  - æœ€çµ‚ pmToken:', pmToken);

    // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
    const isEmbedded = (window.top !== window);
    const looksLikePWA = isEmbedded && pwaUserNameParam !== "";
    const isPWA = isPWAFlag || looksLikePWA;
    const isGAS = !isPWA;

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[Rooms List] åˆæœŸåŒ–é–‹å§‹');

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¨­å®š
      if (isGAS) {
        if (gasUserNameParam && gasUserNameParam.trim() !== '') {
          try {
            currentUserName = JSON.parse(gasUserNameParam);
          } catch (e) {
            currentUserName = gasUserNameParam;
          }
          document.getElementById('userInfo').textContent = `ğŸ‘¤ ${currentUserName}`;
          console.log('[GAS] ãƒ¦ãƒ¼ã‚¶ãƒ¼åè‡ªå‹•è¨­å®š:', currentUserName);
        }
      } else {
        try {
          currentUserName = JSON.parse(pwaUserNameParam);
        } catch (e) {
          currentUserName = pwaUserNameParam;
        }
        document.getElementById('userInfo').textContent = `ğŸ‘¤ ${currentUserName}`;
        console.log('[PWA] ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¨­å®š:', currentUserName);
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºç”¨ï¼‰
      if (isPWA) {
        // PWAç‰ˆï¼šapi.jsçµŒç”±ã§Firestoreå„ªå…ˆå–å¾—ï¼ˆARCH-001 Phase 2ï¼‰
        console.log('[User Cache] api.jsçµŒç”±ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—é–‹å§‹');
        getUserList()
          .then(users => {
            if (users && users.length > 0) {
              usersCache = users;
              console.log('[User Cache] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Œäº†:', usersCache.length + 'ä»¶');
              console.log('[User Cache] ã‚­ãƒ£ãƒƒã‚·ãƒ¥å†…å®¹:', usersCache);

              // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å–å¾—å®Œäº†å¾Œã€ãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚’è¡¨ç¤º
              console.log('[Rooms List] ã‚­ãƒ£ãƒƒã‚·ãƒ¥å–å¾—å®Œäº†ã€ãƒªã‚¹ãƒ‹ãƒ³ã‚°é–‹å§‹');
              startListening();
            } else {
              console.warn('[User Cache] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãŒç©ºã§ã™');
              // ç©ºã®å ´åˆã§ã‚‚ãƒ«ãƒ¼ãƒ ä¸€è¦§ã¯è¡¨ç¤ºã™ã‚‹
              startListening();
            }
          })
          .catch(error => {
            console.error('[User Cache] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã§ã‚‚ãƒ«ãƒ¼ãƒ ä¸€è¦§ã¯è¡¨ç¤ºã™ã‚‹
            startListening();
          });
      } else if (typeof google !== 'undefined' && google.script && google.script.run) {
        // GASç‰ˆï¼šgoogle.script.runã§å‘¼ã³å‡ºã—
        google.script.run
          .withSuccessHandler(function(users) {
            if (users && users.length > 0) {
              usersCache = users;
              console.log('[User Cache] GASç‰ˆ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Œäº†:', usersCache.length + 'ä»¶');
              console.log('[User Cache] ã‚­ãƒ£ãƒƒã‚·ãƒ¥å†…å®¹:', usersCache);
            } else {
              console.warn('[User Cache] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãŒç©ºã§ã™');
            }
            // GASç‰ˆã¯å³åº§ã«startListening
            startListening();
          })
          .withFailureHandler(function(error) {
            console.error('[User Cache] GASç‰ˆ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã§ã‚‚startListening
            startListening();
          })
          .getUserListForUI();
      } else {
        // ã©ã¡ã‚‰ã§ã‚‚ãªã„å ´åˆ
        console.warn('[User Cache] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥å–å¾—ã‚’ã‚¹ã‚­ãƒƒãƒ—');
        startListening();
      }
    });

    // ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒ‹ãƒ³ã‚°
    function startListening() {
      const q = query(
        collection(db, 'rooms'),
        orderBy('lastMessageAt', 'desc')
      );

      onSnapshot(q, (snapshot) => {
        console.log('[Firestore] ãƒ«ãƒ¼ãƒ æ›´æ–°:', snapshot.size + 'ä»¶');

        const container = document.getElementById('roomsContainer');
        container.innerHTML = '';

        if (snapshot.empty) {
          // ç©ºã®çŠ¶æ…‹
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ’¬</div>
              <div class="empty-state-text">ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</div>
              <div style="font-size: 14px; color: #a0aec0;">ã€Œæ–°ã—ã„ãƒ«ãƒ¼ãƒ ä½œæˆã€ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†</div>
            </div>
          `;
          return;
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        console.log('[Filter] currentUserName:', currentUserName);
        console.log('[Filter] å…¨ãƒ«ãƒ¼ãƒ æ•°:', snapshot.size);

        let visibleRoomCount = 0;
        snapshot.forEach((doc) => {
          const room = { id: doc.id, ...doc.data() };

          // ãƒ‡ãƒãƒƒã‚°: å„ãƒ«ãƒ¼ãƒ ã®æƒ…å ±ã‚’å‡ºåŠ›
          console.log('[Filter] ãƒ«ãƒ¼ãƒ æ¤œè¨¼:', {
            id: room.id,
            name: room.name,
            type: room.type,
            members: room.members,
            includes: room.members?.includes(currentUserName)
          });

          // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°: è‡ªåˆ†ãŒå‚åŠ ã—ã¦ã„ã‚‹ãƒ«ãƒ¼ãƒ ã®ã¿è¡¨ç¤º
          // - type='system'ã®ãƒ«ãƒ¼ãƒ ã¯å…¨å“¡ã«è¡¨ç¤º
          // - ãã‚Œä»¥å¤–ã¯ membersé…åˆ—ã«è‡ªåˆ†ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒå«ã¾ã‚Œã‚‹å ´åˆã®ã¿è¡¨ç¤º
          if (room.type === 'system' || (room.members && room.members.includes(currentUserName))) {
            console.log('[Filter] âœ… ãƒ«ãƒ¼ãƒ è¡¨ç¤º:', room.id, room.name);
            appendRoom(room);
            visibleRoomCount++;
          } else {
            console.log('[Filter] âŒ ãƒ«ãƒ¼ãƒ ã‚’ã‚¹ã‚­ãƒƒãƒ—:', room.id, room.name, 'members:', room.members);
          }
        });

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã«è¡¨ç¤ºã™ã‚‹ãƒ«ãƒ¼ãƒ ãŒãªã„å ´åˆ
        if (visibleRoomCount === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ’¬</div>
              <div class="empty-state-text">å‚åŠ ä¸­ã®ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</div>
              <div style="font-size: 14px; color: #a0aec0;">ã€Œæ–°ã—ã„ãƒ«ãƒ¼ãƒ ä½œæˆã€ã¾ãŸã¯ã€Œå€‹åˆ¥ãƒãƒ£ãƒƒãƒˆä½œæˆã€ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†</div>
            </div>
          `;
        }
      }, (error) => {
        console.error('[Firestore] ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
        const container = document.getElementById('roomsContainer');
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">âš ï¸</div>
            <div class="empty-state-text">ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>
            <div style="font-size: 14px; color: #a0aec0;">${error.message}</div>
          </div>
        `;
      });
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³URLã‚’å–å¾—
    function getUserIconUrl(userName) {
      console.log('[Room Icon] getUserIconUrl:', { userName, cacheSize: usersCache?.length || 0 });

      if (!userName || !usersCache || usersCache.length === 0) {
        console.warn('[Room Icon] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒç©ºã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼åãªã—');
        return null;
      }

      const user = usersCache.find(u => u.userName === userName);
      console.log('[Room Icon] æ¤œç´¢çµæœ:', user);

      if (user && user.userIconUrl) {
        console.log('[Room Icon] ã‚¢ã‚¤ã‚³ãƒ³URLè¿”å´:', user.userIconUrl);
        return user.userIconUrl;
      } else {
        console.warn('[Room Icon] ã‚¢ã‚¤ã‚³ãƒ³URLãªã—:', userName);
        return null;
      }
    }

    // ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ã‚’UIã«è¿½åŠ 
    function appendRoom(room) {
      const container = document.getElementById('roomsContainer');

      // ãƒ«ãƒ¼ãƒ ã‚¢ã‚¤ãƒ†ãƒ ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆã‚¹ãƒ¯ã‚¤ãƒ—å‰Šé™¤ç”¨ï¼‰
      const wrapper = document.createElement('div');
      wrapper.className = 'room-item-wrapper';
      wrapper.dataset.roomId = room.id;

      // å‰Šé™¤ãƒœã‚¿ãƒ³
      const deleteBtn = document.createElement('div');
      deleteBtn.className = 'delete-button';
      deleteBtn.textContent = 'å‰Šé™¤';
      deleteBtn.onclick = (e) => {
        e.stopPropagation();
        confirmDeleteRoom(room.id, room.name || 'ä¸æ˜ãªãƒ«ãƒ¼ãƒ ');
      };

      const item = document.createElement('div');
      item.className = 'room-item';
      item.onclick = () => openRoom(room.id);

      // ã‚¢ã‚¤ã‚³ãƒ³
      const icon = document.createElement('div');
      icon.className = 'room-icon';

      // å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆï¼ˆDMï¼‰ã®å ´åˆã¯ç›¸æ‰‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º
      if (room.type === 'direct' && room.members && room.members.length === 2) {
        // è‡ªåˆ†ä»¥å¤–ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’å–å¾—
        const otherUser = room.members.find(m => m !== currentUserName);
        const iconUrl = getUserIconUrl(otherUser);

        console.log('[Room Icon] å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆ:', { roomId: room.id, otherUser, iconUrl });

        if (iconUrl) {
          // ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒãŒã‚ã‚‹å ´åˆ
          const img = document.createElement('img');
          img.src = iconUrl;
          img.alt = otherUser || 'åŒ¿å';
          img.style.width = '40px';
          img.style.height = '40px';
          img.style.borderRadius = '50%';
          img.style.objectFit = 'cover';
          img.onerror = function() {
            // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
            icon.textContent = (otherUser || 'åŒ¿').charAt(0);
            icon.style.background = 'linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%)';
            icon.style.color = 'white';
            icon.style.display = 'flex';
            icon.style.alignItems = 'center';
            icon.style.justifyContent = 'center';
            icon.style.fontWeight = '600';
          };
          icon.appendChild(img);
        } else {
          // ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒãŒãªã„å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
          icon.textContent = (otherUser || 'åŒ¿').charAt(0);
          icon.style.background = 'linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%)';
          icon.style.color = 'white';
          icon.style.display = 'flex';
          icon.style.alignItems = 'center';
          icon.style.justifyContent = 'center';
          icon.style.fontWeight = '600';
        }
      } else {
        // ã‚·ã‚¹ãƒ†ãƒ ãƒ«ãƒ¼ãƒ ã‚„å…¨ä½“ãƒãƒ£ãƒƒãƒˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³
        icon.textContent = room.icon || 'ğŸ’¬';
      }

      // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
      const content = document.createElement('div');
      content.className = 'room-content';

      // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒ«ãƒ¼ãƒ å + å³å´ãƒ¡ã‚¿æƒ…å ±ï¼‰
      const header = document.createElement('div');
      header.className = 'room-header';

      const name = document.createElement('div');
      name.className = 'room-name';

      // å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆã®å ´åˆã¯ç›¸æ‰‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å‹•çš„ç”Ÿæˆ
      if (room.type === 'direct' && room.members && Array.isArray(room.members)) {
        const otherMember = room.members.find(m => m !== currentUserName);
        name.textContent = otherMember || 'ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼';
      } else {
        name.textContent = room.name || 'ç„¡é¡Œã®ãƒ«ãƒ¼ãƒ ';
      }

      // å³å´ãƒ¡ã‚¿æƒ…å ±ï¼ˆæ™‚é–“ + æœªèª­ãƒãƒƒã‚¸ï¼‰
      const meta = document.createElement('div');
      meta.className = 'room-meta';

      const time = document.createElement('div');
      time.className = 'room-time';
      if (room.lastMessageAt && room.lastMessageAt.toDate) {
        const date = room.lastMessageAt.toDate();
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) {
          time.textContent = 'ãŸã£ãŸä»Š';
        } else if (diffMins < 60) {
          time.textContent = `${diffMins}åˆ†å‰`;
        } else if (diffHours < 24) {
          time.textContent = `${diffHours}æ™‚é–“å‰`;
        } else if (diffDays < 7) {
          time.textContent = `${diffDays}æ—¥å‰`;
        } else {
          time.textContent = date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
        }
      }

      meta.appendChild(time);

      // æœªèª­ãƒãƒƒã‚¸ï¼ˆæ™‚é–“ã®ä¸‹ã«é…ç½®ï¼‰
      const badge = document.createElement('div');
      badge.className = 'unread-badge';
      badge.id = `unread-badge-${room.id}`;
      badge.style.display = 'none'; // åˆæœŸéè¡¨ç¤º
      meta.appendChild(badge);

      header.appendChild(name);
      header.appendChild(meta);

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ + æœªèª­ãƒãƒƒã‚¸ï¼‰
      const preview = document.createElement('div');
      preview.className = 'room-preview';

      const lastMessage = document.createElement('div');
      lastMessage.className = 'room-last-message';
      if (room.lastMessage) {
        const sender = room.lastMessageBy || '';
        lastMessage.textContent = `${sender}: ${room.lastMessage}`;
      } else {
        lastMessage.textContent = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“';
      }

      preview.appendChild(lastMessage);

      content.appendChild(header);
      content.appendChild(preview);

      item.appendChild(icon);
      item.appendChild(content);

      // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼è¨­å®š
      setupSwipeGesture(wrapper, item);

      wrapper.appendChild(deleteBtn);
      wrapper.appendChild(item);
      container.appendChild(wrapper);

      // æœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å–å¾—ãƒ»æ›´æ–°
      if (currentUserName) {
        const unreadRef = doc(db, `rooms/${room.id}/unreadCounts/${currentUserName}`);
        onSnapshot(unreadRef, (unreadDoc) => {
          const badgeEl = document.getElementById(`unread-badge-${room.id}`);
          if (badgeEl) {
            const unreadData = unreadDoc.data();
            const unreadCount = unreadData?.unreadCount || 0;

            if (unreadCount > 0) {
              badgeEl.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
              badgeEl.style.display = 'inline-block';
            } else {
              badgeEl.style.display = 'none';
            }
          }
        }, (error) => {
          console.error('[Rooms List] æœªèª­ã‚«ã‚¦ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', room.id, error);
        });
      }
    }

    // ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ã‚’é–‹ã
    window.openRoom = function(roomId) {
      console.log('[Rooms List] ãƒ«ãƒ¼ãƒ é¸æŠ:', roomId);

      // ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIã‚’è¡¨ç¤ºï¼ˆå…¨ç”»é¢ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼‰
      const skeleton = document.getElementById('skeleton-loader');
      if (skeleton) {
        skeleton.classList.add('active');
        console.log('[Rooms List] âœ… ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIè¡¨ç¤º');
      }

      // ãƒãƒ£ãƒƒãƒˆç”»é¢ã«é·ç§»ï¼ˆroomIdã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æ¸¡ã™ï¼‰
      if (isGAS) {
        // GASç‰ˆ: åŒã˜ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ã
        window.location.href = `<?= ScriptApp.getService().getUrl() ?>?page=chat&roomId=${roomId}`;
      } else {
        // PWAç‰ˆ: window.top.postMessageã§è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«é€ä¿¡
        // targetOriginãŒç©ºæ–‡å­—åˆ—ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ï¼ˆSyntaxErrorå¯¾ç­–ï¼‰
        const targetOrigin = parentOrigin || 'https://www.reborn-inventory.com';

        console.log('[Rooms List] postMessageé€ä¿¡:', {
          page: 'chat',
          roomId: roomId,
          userName: currentUserName,
          targetOrigin: targetOrigin,
          pmToken: pmToken
        });

        try {
          window.top.postMessage({
            __reborn: true,
            type: 'navigate',
            page: 'chat',
            roomId: roomId,
            userName: currentUserName || '',
            pmToken: pmToken
          }, targetOrigin);
          console.log('[Rooms List] postMessageé€ä¿¡æˆåŠŸ');
        } catch (error) {
          console.error('[Rooms List] postMessageé€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
          alert('ç”»é¢é·ç§»ã‚¨ãƒ©ãƒ¼: ' + error.message);
        }
      }
    };

    // ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.createRoom = function() {
      console.log('[Rooms List] ãƒ«ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã');
      document.getElementById('createRoomModal').classList.add('active');
      document.getElementById('roomNameInput').focus();
    };

    // ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeCreateRoomModal = function() {
      console.log('[Rooms List] ãƒ«ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹');
      document.getElementById('createRoomModal').classList.remove('active');
      document.getElementById('createRoomForm').reset();
    };

    // ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ä½œæˆå®Ÿè¡Œ
    window.submitCreateRoom = async function() {
      console.log('[Rooms List] ãƒ«ãƒ¼ãƒ ä½œæˆå‡¦ç†é–‹å§‹');

      const roomName = document.getElementById('roomNameInput').value.trim();
      const roomIcon = document.getElementById('roomIconSelect').value;

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: ãƒ«ãƒ¼ãƒ åå¿…é ˆ
      if (!roomName) {
        alert('ãƒ«ãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: ãƒ«ãƒ¼ãƒ åé‡è¤‡ãƒã‚§ãƒƒã‚¯
      try {
        const q = query(
          collection(db, 'rooms'),
          where('name', '==', roomName)
        );
        const snapshot = await getDocs(q);

        if (!snapshot.empty) {
          alert('åŒã˜åå‰ã®ãƒ«ãƒ¼ãƒ ãŒã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚\nåˆ¥ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        // Firestoreã«ãƒ«ãƒ¼ãƒ ä½œæˆ
        console.log('[Rooms List] Firestoreã«ãƒ«ãƒ¼ãƒ ä½œæˆ:', { roomName, roomIcon });

        const newRoom = await addDoc(collection(db, 'rooms'), {
          name: roomName,
          icon: roomIcon,
          createdBy: currentUserName || 'ä¸æ˜',
          createdAt: serverTimestamp(),
          lastMessageAt: serverTimestamp(),
          lastMessageText: '',
          lastMessageSender: '',
          members: [currentUserName || 'ä¸æ˜']
        });

        console.log('[Rooms List] ãƒ«ãƒ¼ãƒ ä½œæˆæˆåŠŸ:', newRoom.id);

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closeCreateRoomModal();

        // ä½œæˆã—ãŸãƒ«ãƒ¼ãƒ ã‚’é–‹ã
        setTimeout(() => {
          openRoom(newRoom.id);
        }, 500);

      } catch (error) {
        console.error('[Rooms List] ãƒ«ãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ«ãƒ¼ãƒ ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };

    // ========================================
    // å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½
    // ========================================

    // å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.createDirectChat = async function() {
      console.log('[Direct Chat] å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã');
      document.getElementById('directChatModal').classList.add('active');

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
      await loadUserList();
    };

    // å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeDirectChatModal = function() {
      console.log('[Direct Chat] å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹');
      document.getElementById('directChatModal').classList.remove('active');
    };

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    async function loadUserList() {
      console.log('[Direct Chat] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...');
      const container = document.getElementById('userListContainer');
      container.innerHTML = '<div class="loading">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>';

      try {
        // GAS APIã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—
        const users = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .getUserListForUI();
        });

        console.log('[Direct Chat] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—æˆåŠŸ:', users.length + 'ä»¶');

        if (!users || users.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ‘¥</div>
              <div class="empty-state-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>
            </div>
          `;
          return;
        }

        // è‡ªåˆ†è‡ªèº«ã‚’é™¤å¤–
        const filteredUsers = users.filter(u => u.userName !== currentUserName);

        if (filteredUsers.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ‘¥</div>
              <div class="empty-state-text">ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>
            </div>
          `;
          return;
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º
        container.innerHTML = '';
        filteredUsers.forEach(user => {
          const item = document.createElement('div');
          item.className = 'user-list-item';
          item.onclick = () => selectUserForDirectChat(user.userName);

          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º
          let iconElement;
          if (user.userIconUrl) {
            // ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒãŒã‚ã‚‹å ´åˆ
            iconElement = document.createElement('div');
            iconElement.className = 'user-icon';
            
            const img = document.createElement('img');
            img.src = user.userIconUrl;
            img.alt = user.userName;
            img.onerror = function() {
              // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
              const placeholder = document.createElement('div');
              placeholder.className = 'user-icon-placeholder';
              placeholder.textContent = user.userName.charAt(0);
              this.parentElement.replaceWith(placeholder);
            };
            
            iconElement.appendChild(img);
          } else {
            // ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒãŒãªã„å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
            iconElement = document.createElement('div');
            iconElement.className = 'user-icon-placeholder';
            iconElement.textContent = user.userName.charAt(0);
          }

          const info = document.createElement('div');
          info.className = 'user-info';

          const name = document.createElement('div');
          name.className = 'user-name';
          name.textContent = user.userName;

          const permission = document.createElement('div');
          permission.className = 'user-permission';
          permission.textContent = user.permission || 'ã‚¹ã‚¿ãƒƒãƒ•';

          info.appendChild(name);
          info.appendChild(permission);

          item.appendChild(iconElement);
          item.appendChild(info);

          container.appendChild(item);
        });

      } catch (error) {
        console.error('[Direct Chat] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">âš ï¸</div>
            <div class="empty-state-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>
            <div style="font-size: 14px; color: #a0aec0;">${error.message}</div>
          </div>
        `;
      }
    }

    // roomIdç”Ÿæˆï¼ˆdm_[user1]_[user2]ã€ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ï¼‰
    function generateDirectRoomId(user1, user2) {
      const users = [user1, user2].sort();
      return `dm_${users[0]}_${users[1]}`;
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠæ™‚ã®å‡¦ç†
    async function selectUserForDirectChat(targetUserName) {
      console.log('[Direct Chat] ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠ:', targetUserName);

      if (!currentUserName) {
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“');
        return;
      }

      try {
        // roomIdç”Ÿæˆ
        const roomId = generateDirectRoomId(currentUserName, targetUserName);
        console.log('[Direct Chat] ç”Ÿæˆã•ã‚ŒãŸroomId:', roomId);

        // æ—¢å­˜ã®DMãƒ«ãƒ¼ãƒ ã‚’ãƒã‚§ãƒƒã‚¯
        const q = query(
          collection(db, 'rooms'),
          where('__name__', '==', roomId)
        );
        const snapshot = await getDocs(q);

        if (!snapshot.empty) {
          // æ—¢å­˜ãƒ«ãƒ¼ãƒ ãŒå­˜åœ¨ â†’ é–‹ãã ã‘
          console.log('[Direct Chat] æ—¢å­˜ã®DMãƒ«ãƒ¼ãƒ ã‚’é–‹ã:', roomId);
          closeDirectChatModal();
          setTimeout(() => {
            openRoom(roomId);
          }, 300);
          return;
        }

        // æ–°è¦DMãƒ«ãƒ¼ãƒ ä½œæˆ
        console.log('[Direct Chat] æ–°è¦DMãƒ«ãƒ¼ãƒ ä½œæˆ:', roomId);
        await createDirectChatRoom(roomId, targetUserName);

      } catch (error) {
        console.error('[Direct Chat] DMãƒ«ãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
        alert('å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼è¨­å®š
    function setupSwipeGesture(wrapper, item) {
      let startX = 0;
      let currentX = 0;
      let isSwiping = false;

      item.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        currentX = startX;
        item.classList.add('swiping');
      });

      item.addEventListener('touchmove', (e) => {
        if (!isSwiping && Math.abs(e.touches[0].clientX - startX) > 10) {
          isSwiping = true;
        }

        if (isSwiping) {
          currentX = e.touches[0].clientX;
          const diff = currentX - startX;

          // å·¦ã‚¹ãƒ¯ã‚¤ãƒ—ã®ã¿è¨±å¯ï¼ˆdiff < 0ï¼‰
          if (diff < 0) {
            const offset = Math.max(diff, -80);
            item.style.transform = `translateX(${offset}px)`;
          }
        }
      });

      item.addEventListener('touchend', (e) => {
        item.classList.remove('swiping');
        const diff = currentX - startX;

        if (diff < -40) {
          // 40pxä»¥ä¸Šã‚¹ãƒ¯ã‚¤ãƒ—ã§å‰Šé™¤ãƒœã‚¿ãƒ³è¡¨ç¤º
          item.style.transform = 'translateX(-80px)';
        } else {
          // é–‰ã˜ã‚‹
          item.style.transform = 'translateX(0)';
        }

        isSwiping = false;
        startX = 0;
        currentX = 0;
      });
    }

    // å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    function confirmDeleteRoom(roomId, roomName) {
      const displayName = roomName || 'ä¸æ˜ãªãƒ«ãƒ¼ãƒ ';
      if (confirm(`ã€Œ${displayName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nä¼šè©±å±¥æ­´ã‚‚å®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
        deleteRoom(roomId);
      }
    }

    // ãƒ«ãƒ¼ãƒ å‰Šé™¤ï¼ˆã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å«ã‚€å®Œå…¨å‰Šé™¤ï¼‰
    async function deleteRoom(roomId) {
      try {
        console.log('[Delete Room] å‰Šé™¤é–‹å§‹:', roomId);

        // 1. messagesã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
        const messagesRef = collection(db, `rooms/${roomId}/messages`);
        const messagesSnapshot = await getDocs(messagesRef);

        console.log('[Delete Room] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°:', messagesSnapshot.size);

        const deleteBatch = [];
        messagesSnapshot.forEach((doc) => {
          deleteBatch.push(deleteDoc(doc.ref));
        });

        if (deleteBatch.length > 0) {
          await Promise.all(deleteBatch);
          console.log('[Delete Room] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤å®Œäº†');
        }

        // 2. unreadCountsã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
        const unreadRef = collection(db, `rooms/${roomId}/unreadCounts`);
        const unreadSnapshot = await getDocs(unreadRef);

        const unreadBatch = [];
        unreadSnapshot.forEach((doc) => {
          unreadBatch.push(deleteDoc(doc.ref));
        });

        if (unreadBatch.length > 0) {
          await Promise.all(unreadBatch);
          console.log('[Delete Room] æœªèª­ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤å®Œäº†');
        }

        // 3. roomãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
        await deleteDoc(doc(db, 'rooms', roomId));
        console.log('[Delete Room] ãƒ«ãƒ¼ãƒ å‰Šé™¤å®Œäº†');

        // 4. UIã‹ã‚‰å‰Šé™¤
        const wrapper = document.querySelector(`.room-item-wrapper[data-room-id="${roomId}"]`);
        if (wrapper) {
          wrapper.style.opacity = '0';
          wrapper.style.transform = 'translateX(-100%)';
          setTimeout(() => {
            wrapper.remove();
          }, 300);
        }

        alert('ãƒ«ãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');

      } catch (error) {
        console.error('[Delete Room] ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ«ãƒ¼ãƒ ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // Firestore roomsã«å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ä½œæˆ
    async function createDirectChatRoom(roomId, targetUserName) {
      try {
        // ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã§ãƒ«ãƒ¼ãƒ ä½œæˆ
        await setDoc(doc(db, 'rooms', roomId), {
          name: '',  // å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆã¯å‹•çš„ç”Ÿæˆã™ã‚‹ãŸã‚ç©ºæ¬„
          type: 'direct',
          icon: 'ğŸ‘¤',
          members: [currentUserName, targetUserName],
          createdBy: currentUserName,
          createdAt: serverTimestamp(),
          lastMessageAt: serverTimestamp(),
          lastMessage: '',
          lastMessageBy: ''
        });

        console.log('[Direct Chat] DMãƒ«ãƒ¼ãƒ ä½œæˆæˆåŠŸ:', roomId);

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closeDirectChatModal();

        // ä½œæˆã—ãŸãƒ«ãƒ¼ãƒ ã‚’é–‹ã
        setTimeout(() => {
          openRoom(roomId);
        }, 500);

      } catch (error) {
        console.error('[Direct Chat] Firestoreæ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        throw error;
      }
    }
  </script>

  <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³å‡¦ç† -->
<script>
  console.log('[chat_rooms_list] âœ… Script loaded - Version @899-debug');
  
  async function goBack() {
    console.log('[chat_rooms_list] >>> goBack() called at', new Date().toISOString());
    const isInIframe = window.self !== window.top;
    console.log('[chat_rooms_list] isInIframe:', isInIframe);
    
    if (isInIframe) {
      console.log('[chat_rooms_list] iframeå†…ã§é–‹ã‹ã‚Œã¦ã„ã‚‹ãŸã‚ã€postMessageé€ä¿¡');
      window.top.postMessage({ type: 'navigateToHome' }, '*');
      console.log('[chat_rooms_list] âœ… postMessageé€ä¿¡å®Œäº†');
    } else {
      console.log('[chat_rooms_list] ç›´æ¥é–‹ã‹ã‚Œã¦ã„ã‚‹ãŸã‚ã€google.script.host.close()');
      google.script.host.close();
    }
  }
  
  document.addEventListener('DOMContentLoaded', () => {
    console.log('[chat_rooms_list] DOMContentLoaded fired');
    const backButton = document.getElementById('back-button');
    console.log('[chat_rooms_list] backButton element:', backButton);
    
    if (backButton) {
      backButton.addEventListener('click', goBack);
      console.log('[chat_rooms_list] âœ… æˆ»ã‚‹ãƒœã‚¿ãƒ³ã«goBack()ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ');
    } else {
      console.error('[chat_rooms_list] âŒ æˆ»ã‚‹ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
  });
</script>

</body>
</html>
