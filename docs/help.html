<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- v323: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾—ã‚’ãƒ•ãƒªãƒ©æ¨™æº–æ–¹å¼ã«ä¿®æ­£ -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ãƒ˜ãƒ«ãƒ— - ãƒ•ãƒªãƒ©</title>
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/reborn-brand-colors.css?v=9635">
  <link rel="stylesheet" href="/css/reborn-theme.css?v=304">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      padding-bottom: 80px;
    }

    .help-header {
      background: linear-gradient(135deg, var(--reborn-primary, #40B4E5) 0%, var(--reborn-primary-dark, #1E8FBF) 100%);
      padding: 28px 20px;
      color: white;
      text-align: center;
      position: relative;
    }

    .help-header h1 {
      font-size: 22px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .help-header h1 i {
      font-size: 22px;
    }

    .help-container {
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
    }

    .help-section {
      background: white;
      border-radius: 12px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      overflow: hidden;
    }

    .help-section-title {
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      padding: 12px 16px 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .help-item {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid #f3f4f6;
      cursor: pointer;
      transition: background 0.2s;
      text-decoration: none;
      color: inherit;
    }

    .help-item:last-child {
      border-bottom: none;
    }

    .help-item:active {
      background: #f9fafb;
    }

    .help-item-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: var(--reborn-primary-lightest, #E8F7FC);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      flex-shrink: 0;
    }

    .help-item-icon i {
      font-size: 20px;
      color: var(--reborn-primary, #40B4E5);
    }

    .help-item-content {
      flex: 1;
    }

    .help-item-title {
      font-size: 15px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 2px;
    }

    .help-item-desc {
      font-size: 13px;
      color: #6b7280;
    }

    .help-item-arrow {
      color: #9ca3af;
      font-size: 18px;
    }

    /* FAQ ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ */
    .faq-item {
      border-bottom: 1px solid #f3f4f6;
    }

    .faq-item:last-child {
      border-bottom: none;
    }

    .faq-question {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .faq-question:active {
      background: #f9fafb;
    }

    .faq-question-icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--reborn-primary, #40B4E5);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      margin-right: 12px;
      flex-shrink: 0;
    }

    .faq-question-text {
      flex: 1;
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
    }

    .faq-toggle {
      color: #9ca3af;
      font-size: 18px;
      transition: transform 0.3s;
    }

    .faq-item.open .faq-toggle {
      transform: rotate(180deg);
    }

    .faq-answer {
      display: none;
      padding: 0 16px 14px 56px;
      font-size: 14px;
      color: #4b5563;
      line-height: 1.6;
    }

    .faq-item.open .faq-answer {
      display: block;
    }

    /* ãƒ•ãƒƒã‚¿ãƒ¼ */
    .help-footer {
      padding: 24px 20px;
      text-align: center;
    }

    .help-footer-links {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 12px;
    }

    .help-footer-links a {
      color: #6b7280;
      font-size: 13px;
      text-decoration: none;
    }

    .help-footer-links a:hover {
      color: var(--reborn-primary);
      text-decoration: underline;
    }

    .help-footer-copyright {
      color: #9ca3af;
      font-size: 12px;
    }

    /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
    .back-button {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      left: 16px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      width: 42px;
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: white;
      font-size: 20px;
    }

    .back-button:active {
      background: rgba(255, 255, 255, 0.3);
    }

    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ */
    .menu-button {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      right: 16px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      width: 42px;
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: white;
      font-size: 20px;
    }

    .menu-button:active {
      background: rgba(255, 255, 255, 0.3);
    }

    /* ========================================
       AIãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ UIï¼ˆChatGPTé¢¨ï¼‰
       ======================================== */

    /* ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ï¼ˆFABï¼‰ */
    .chat-fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--reborn-primary, #40B4E5) 0%, var(--reborn-primary-dark, #1E8FBF) 100%);
      color: white;
      border: none;
      box-shadow: 0 4px 12px rgba(64, 180, 229, 0.4);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      z-index: 1000;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .chat-fab:active {
      transform: scale(0.95);
    }

    .chat-fab:hover {
      box-shadow: 0 6px 16px rgba(64, 180, 229, 0.5);
    }

    /* ãƒãƒ£ãƒƒãƒˆå…¨ç”»é¢ã‚³ãƒ³ãƒ†ãƒŠ */
    .chat-fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #f5f5f5;
      z-index: 2000;
      display: none;
      flex-direction: row;
    }

    .chat-fullscreen.open {
      display: flex;
    }

    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆä¼šè©±ä¸€è¦§ï¼‰ */
    .chat-sidebar {
      width: 280px;
      background: #1f2937;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    @media (max-width: 768px) {
      .chat-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: 280px;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        z-index: 2100;
      }

      .chat-sidebar.open {
        transform: translateX(0);
      }

      .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2050;
        display: none;
      }

      .sidebar-overlay.open {
        display: block;
      }
    }

    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid #374151;
    }

    .new-chat-btn {
      width: 100%;
      padding: 12px 16px;
      background: transparent;
      border: 1px solid #4b5563;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
    }

    .new-chat-btn:hover {
      background: #374151;
    }

    .new-chat-btn i {
      font-size: 16px;
    }

    .sidebar-conversations {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .conversation-item {
      padding: 12px;
      border-radius: 8px;
      color: #d1d5db;
      cursor: pointer;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.2s;
    }

    .conversation-item:hover {
      background: #374151;
    }

    .conversation-item.active {
      background: #374151;
    }

    .conversation-item i {
      font-size: 16px;
      flex-shrink: 0;
    }

    .conversation-title {
      flex: 1;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .conversation-delete {
      opacity: 0;
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: opacity 0.2s, color 0.2s;
    }

    .conversation-item:hover .conversation-delete {
      opacity: 1;
    }

    .conversation-delete:hover {
      color: #ef4444;
    }

    .sidebar-footer {
      padding: 16px;
      border-top: 1px solid #374151;
    }

    .close-chat-btn {
      width: 100%;
      padding: 10px 16px;
      background: #374151;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: background 0.2s;
    }

    .close-chat-btn:hover {
      background: #4b5563;
    }

    /* ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ */
    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
      min-width: 0;
    }

    /* ãƒãƒ£ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ */
    .chat-main-header {
      background: linear-gradient(135deg, var(--reborn-primary, #40B4E5) 0%, var(--reborn-primary-dark, #1E8FBF) 100%);
      color: white;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    .chat-header-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .chat-header-btn:active {
      background: rgba(255, 255, 255, 0.3);
    }

    .chat-main-header-avatar {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      overflow: hidden;
      flex-shrink: 0;
      background: white;
    }

    .chat-main-header-avatar img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .chat-main-header-info {
      flex: 1;
    }

    .chat-main-header-title {
      font-size: 16px;
      font-weight: 600;
    }

    .chat-main-header-status {
      font-size: 12px;
      opacity: 0.9;
    }


    /* ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background: #f9fafb;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .chat-message {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.6;
      word-wrap: break-word;
    }

    .chat-message.user {
      align-self: flex-end;
      background: var(--reborn-primary, #40B4E5);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .chat-message.ai {
      align-self: flex-start;
      background: white;
      color: #1f2937;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .chat-message.ai.typing {
      color: #9ca3af;
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 4px 0;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      background: #9ca3af;
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(1) { animation-delay: 0s; }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
      30% { transform: translateY(-4px); opacity: 1; }
    }

    /* ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .chat-welcome {
      text-align: center;
      padding: 40px 20px;
      color: #6b7280;
    }

    .chat-welcome-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .chat-welcome-title {
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 8px;
    }

    .chat-welcome-desc {
      font-size: 14px;
      max-width: 400px;
      margin: 0 auto;
    }

    /* ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
    .chat-quick-actions {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      background: #f9fafb;
    }

    .quick-action-btn {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 13px;
      color: #374151;
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-action-btn:hover {
      background: var(--reborn-primary-lightest, #E8F7FC);
      border-color: var(--reborn-primary, #40B4E5);
    }

    .quick-action-btn:active {
      background: #e5e7eb;
    }

    /* ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ */
    .chat-input-area {
      padding: 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
      background: white;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .chat-input {
      flex: 1;
      border: 1px solid #e5e7eb;
      border-radius: 24px;
      padding: 12px 20px;
      font-size: 16px;
      resize: none;
      max-height: 120px;
      min-height: 48px;
      line-height: 1.4;
      outline: none;
      transition: border-color 0.2s;
    }

    .chat-input:focus {
      border-color: var(--reborn-primary, #40B4E5);
    }

    .chat-send-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--reborn-primary, #40B4E5);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
      transition: background 0.2s, opacity 0.2s;
    }

    .chat-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .chat-send-btn:not(:disabled):active {
      background: var(--reborn-primary-dark, #1E8FBF);
    }

    /* ä¼šè©±ãªã—ã®çŠ¶æ…‹ */
    .no-conversations {
      color: #6b7280;
      font-size: 13px;
      text-align: center;
      padding: 20px;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading-conversations {
      color: #9ca3af;
      font-size: 13px;
      text-align: center;
      padding: 20px;
    }

    /* æ—¥ä»˜åŒºåˆ‡ã‚Š */
    .conversation-date-divider {
      font-size: 11px;
      color: #6b7280;
      padding: 8px 12px 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
  </style>
</head>
<body>
  <div class="help-header">
    <button class="back-button" onclick="goBack()" title="æˆ»ã‚‹">
      <i class="bi bi-chevron-left"></i>
    </button>
    <h1><i class="bi bi-question-circle"></i> ãƒ˜ãƒ«ãƒ—</h1>
    <button class="menu-button" onclick="window.parent.postMessage({type:'toggleDrawer'}, '*')" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
      <i class="bi bi-list"></i>
    </button>
  </div>

  <div class="help-container">
    <!-- ã‚ˆãã‚ã‚‹è³ªå• -->
    <div class="help-section">
      <div class="help-section-title">ã‚ˆãã‚ã‚‹è³ªå•</div>

      <div class="faq-item" onclick="toggleFaq(this)">
        <div class="faq-question">
          <span class="faq-question-icon">Q</span>
          <span class="faq-question-text">å•†å“ã‚’ç™»éŒ²ã™ã‚‹ã«ã¯ã©ã†ã™ã‚Œã°ã„ã„ã§ã™ã‹ï¼Ÿ</span>
          <i class="bi bi-chevron-down faq-toggle"></i>
        </div>
        <div class="faq-answer">
          ç”»é¢ä¸‹éƒ¨ã®ã€Œç™»éŒ²ã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã‹ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œå•†å“ç™»éŒ²ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚ã‚«ãƒ¡ãƒ©ã§å•†å“ã‚’æ’®å½±ã—ã€å¿…è¦ãªæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ä¿å­˜ã§ãã¾ã™ã€‚
        </div>
      </div>

      <div class="faq-item" onclick="toggleFaq(this)">
        <div class="faq-question">
          <span class="faq-question-icon">Q</span>
          <span class="faq-question-text">ãƒãƒ£ãƒƒãƒˆã§é€šçŸ¥ãŒå±Šãã¾ã›ã‚“</span>
          <i class="bi bi-chevron-down faq-toggle"></i>
        </div>
        <div class="faq-answer">
          1. ç«¯æœ«ã®é€šçŸ¥è¨­å®šã§ãƒ•ãƒªãƒ©ã®é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚<br>
          2. ãƒã‚¤ãƒšãƒ¼ã‚¸â†’åŸºæœ¬è¨­å®šã‹ã‚‰é€šçŸ¥è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚<br>
          3. ã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
        </div>
      </div>

      <div class="faq-item" onclick="toggleFaq(this)">
        <div class="faq-question">
          <span class="faq-question-icon">Q</span>
          <span class="faq-question-text">ãƒ‡ãƒ¼ã‚¿ã¯ã©ã“ã«ä¿å­˜ã•ã‚Œã¾ã™ã‹ï¼Ÿ</span>
          <i class="bi bi-chevron-down faq-toggle"></i>
        </div>
        <div class="faq-answer">
          ãƒ‡ãƒ¼ã‚¿ã¯ã‚¯ãƒ©ã‚¦ãƒ‰ï¼ˆFirestoreï¼‰ã«å®‰å…¨ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒã‚ã‚Œã°ã€ã©ã®ç«¯æœ«ã‹ã‚‰ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚
        </div>
      </div>

      <div class="faq-item" onclick="toggleFaq(this)">
        <div class="faq-question">
          <span class="faq-question-icon">Q</span>
          <span class="faq-question-text">ã‚¢ãƒ—ãƒªã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚‹ã«ã¯ï¼Ÿ</span>
          <i class="bi bi-chevron-down faq-toggle"></i>
        </div>
        <div class="faq-answer">
          ãƒ•ãƒªãƒ©ã¯PWAï¼ˆProgressive Web Appï¼‰ã®ãŸã‚ã€è‡ªå‹•çš„ã«æœ€æ–°ç‰ˆã«æ›´æ–°ã•ã‚Œã¾ã™ã€‚æ›´æ–°ãŒåæ˜ ã•ã‚Œãªã„å ´åˆã¯ã€ã‚¢ãƒ—ãƒªã‚’å®Œå…¨ã«çµ‚äº†ã—ã¦ã‹ã‚‰å†åº¦é–‹ã„ã¦ãã ã•ã„ã€‚
        </div>
      </div>
    </div>

    <!-- æ“ä½œã‚¬ã‚¤ãƒ‰ -->
    <div class="help-section">
      <div class="help-section-title">æ“ä½œã‚¬ã‚¤ãƒ‰</div>

      <a class="help-item" href="#" onclick="showGuide('product'); return false;">
        <div class="help-item-icon">
          <i class="bi bi-camera"></i>
        </div>
        <div class="help-item-content">
          <div class="help-item-title">å•†å“ç™»éŒ²ã®ä½¿ã„æ–¹</div>
          <div class="help-item-desc">å†™çœŸæ’®å½±ã‹ã‚‰ç™»éŒ²å®Œäº†ã¾ã§</div>
        </div>
        <i class="bi bi-chevron-right help-item-arrow"></i>
      </a>

      <a class="help-item" href="#" onclick="showGuide('inventory'); return false;">
        <div class="help-item-icon">
          <i class="bi bi-box-seam"></i>
        </div>
        <div class="help-item-content">
          <div class="help-item-title">åœ¨åº«ç®¡ç†ã®ä½¿ã„æ–¹</div>
          <div class="help-item-desc">åœ¨åº«ç¢ºèªãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´</div>
        </div>
        <i class="bi bi-chevron-right help-item-arrow"></i>
      </a>

      <a class="help-item" href="#" onclick="showGuide('chat'); return false;">
        <div class="help-item-icon">
          <i class="bi bi-chat"></i>
        </div>
        <div class="help-item-content">
          <div class="help-item-title">ãƒãƒ£ãƒƒãƒˆã®ä½¿ã„æ–¹</div>
          <div class="help-item-desc">ãƒãƒ¼ãƒ é€£çµ¡ãƒ»é€šçŸ¥è¨­å®š</div>
        </div>
        <i class="bi bi-chevron-right help-item-arrow"></i>
      </a>
    </div>

    <!-- AIã‚µãƒãƒ¼ãƒˆ -->
    <div class="help-section">
      <div class="help-section-title">AIã‚µãƒãƒ¼ãƒˆ</div>

      <a class="help-item" href="#" onclick="openChatFullscreen(); return false;">
        <div class="help-item-icon" style="background: linear-gradient(135deg, var(--reborn-primary, #40B4E5) 0%, var(--reborn-primary-dark, #1E8FBF) 100%);">
          <i class="bi bi-chat-dots-fill" style="color: white;"></i>
        </div>
        <div class="help-item-content">
          <div class="help-item-title">AIã«è³ªå•ã™ã‚‹</div>
          <div class="help-item-desc">ãƒ•ãƒªãƒ©ã®ä½¿ã„æ–¹ã‚’ä½•ã§ã‚‚èã‘ã¾ã™</div>
        </div>
        <i class="bi bi-chevron-right help-item-arrow"></i>
      </a>
    </div>

    <!-- ãŠå•ã„åˆã‚ã› -->
    <div class="help-section">
      <div class="help-section-title">ã‚µãƒãƒ¼ãƒˆ</div>

      <a class="help-item" href="mailto:support@furira.jp">
        <div class="help-item-icon">
          <i class="bi bi-envelope"></i>
        </div>
        <div class="help-item-content">
          <div class="help-item-title">ãƒ¡ãƒ¼ãƒ«ã§ãŠå•ã„åˆã‚ã›</div>
          <div class="help-item-desc">support@furira.jp</div>
        </div>
        <i class="bi bi-chevron-right help-item-arrow"></i>
      </a>
    </div>

    <!-- ã‚¢ãƒ—ãƒªæƒ…å ± -->
    <div class="help-section">
      <div class="help-section-title">ã‚¢ãƒ—ãƒªæƒ…å ±</div>

      <div class="help-item" style="cursor: default;">
        <div class="help-item-icon">
          <i class="bi bi-info-circle"></i>
        </div>
        <div class="help-item-content">
          <div class="help-item-title">ãƒãƒ¼ã‚¸ãƒ§ãƒ³</div>
          <div class="help-item-desc" id="app-version">v321</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
  <div class="help-footer">
    <div class="help-footer-links">
      <a href="/privacy-policy.html" target="_blank">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
      <a href="/terms-of-service.html" target="_blank">åˆ©ç”¨è¦ç´„</a>
    </div>
    <div class="help-footer-copyright">&copy; 2025 ãƒ•ãƒªãƒ©</div>
  </div>

  <!-- AIãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ FAB -->
  <button class="chat-fab" onclick="openChatFullscreen()" title="AIã«è³ªå•ã™ã‚‹">
    <i class="bi bi-chat-dots-fill"></i>
  </button>

  <!-- AIãƒãƒ£ãƒƒãƒˆå…¨ç”»é¢UIï¼ˆChatGPTé¢¨ï¼‰ -->
  <div class="chat-fullscreen" id="chatFullscreen">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆä¼šè©±ä¸€è¦§ï¼‰ -->
    <div class="chat-sidebar" id="chatSidebar">
      <div class="sidebar-header">
        <button class="new-chat-btn" onclick="startNewConversation()">
          <i class="bi bi-plus-lg"></i>
          <span>æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ</span>
        </button>
      </div>
      <div class="sidebar-conversations" id="conversationList">
        <div class="loading-conversations">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
      <div class="sidebar-footer">
        <button class="close-chat-btn" onclick="closeChatFullscreen()">
          <i class="bi bi-x-lg"></i>
          <span>ãƒãƒ£ãƒƒãƒˆã‚’é–‰ã˜ã‚‹</span>
        </button>
      </div>
    </div>

    <!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼‰ -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
    <div class="chat-main">
      <div class="chat-main-header">
        <button class="chat-header-btn" onclick="closeChatFullscreen()" title="é–‰ã˜ã‚‹">
          <i class="bi bi-chevron-left"></i>
        </button>
        <div class="chat-main-header-avatar"><img src="/chatboticon.png" alt="AIã‚µãƒãƒ¼ãƒˆ"></div>
        <div class="chat-main-header-info">
          <div class="chat-main-header-title">ãƒ•ãƒªãƒ© AIã‚µãƒãƒ¼ãƒˆ</div>
          <div class="chat-main-header-status">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</div>
        </div>
        <button class="chat-header-btn" onclick="toggleSidebar()" title="ä¼šè©±å±¥æ­´">
          <i class="bi bi-clock-history"></i>
        </button>
      </div>

      <div class="chat-messages" id="chatMessages">
        <div class="chat-welcome">
          <div class="chat-welcome-icon">ğŸ‘‹</div>
          <div class="chat-welcome-title">ã“ã‚“ã«ã¡ã¯ï¼</div>
          <div class="chat-welcome-desc">ãƒ•ãƒªãƒ©ã®ä½¿ã„æ–¹ã«ã¤ã„ã¦ä½•ã§ã‚‚èã„ã¦ãã ã•ã„ã€‚<br>ä¼šè©±å±¥æ­´ã¯è‡ªå‹•ã§ä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>
        </div>
      </div>

      <div class="chat-quick-actions" id="quickActions">
        <button class="quick-action-btn" onclick="sendQuickMessage('å•†å“ç™»éŒ²ã®æ–¹æ³•ã‚’æ•™ãˆã¦')">ğŸ“¦ å•†å“ç™»éŒ²ã®æ–¹æ³•</button>
        <button class="quick-action-btn" onclick="sendQuickMessage('é€šçŸ¥ãŒå±Šã‹ãªã„')">ğŸ”” é€šçŸ¥ãŒå±Šã‹ãªã„</button>
        <button class="quick-action-btn" onclick="sendQuickMessage('åœ¨åº«ç®¡ç†ã®ä½¿ã„æ–¹')">ğŸ“Š åœ¨åº«ç®¡ç†</button>
        <button class="quick-action-btn" onclick="sendQuickMessage('ãƒãƒ£ãƒƒãƒˆã®ä½¿ã„æ–¹')">ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ</button>
      </div>

      <div class="chat-input-area">
        <textarea
          class="chat-input"
          id="chatInput"
          placeholder="è³ªå•ã‚’å…¥åŠ›..."
          rows="1"
          onkeydown="handleKeyDown(event)"
          oninput="autoResize(this)"
        ></textarea>
        <button class="chat-send-btn" id="chatSendBtn" onclick="sendMessage()" disabled>
          <i class="bi bi-send-fill"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, query, where, orderBy, limit, onSnapshot, serverTimestamp, doc, updateDoc, getDoc, setDoc, deleteDoc, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebaseè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "furira.jp",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    // FirebaseåˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    console.log('[Help] Firebase Firestore åˆæœŸåŒ–å®Œäº†');

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let currentUserId = null;
    let currentConversationId = null;
    let conversationHistory = [];
    let unsubscribeConversations = null;

    // Cloudflare Worker ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
    const CHATBOT_API_ENDPOINT = 'https://reborn-help-chatbot.mercari-yasuhirotakuji.workers.dev/chat';

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾—ï¼ˆlocalStorageã‹ã‚‰ - ãƒ•ãƒªãƒ©æ¨™æº–æ–¹å¼ï¼‰
    function getUserId() {
      // ãƒ•ãƒªãƒ©ã®ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
      const userEmail = localStorage.getItem('reborn_user_email');
      if (userEmail) {
        console.log('[Help] ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆãƒ¡ãƒ¼ãƒ«ï¼‰:', userEmail);
        return userEmail;
      }

      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: Firebase UIDã‚’è©¦ã™
      const firebaseUid = localStorage.getItem('reborn_firebase_uid');
      if (firebaseUid) {
        console.log('[Help] ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆFirebase UIDï¼‰:', firebaseUid);
        return firebaseUid;
      }

      // æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ‡ãƒã‚¤ã‚¹å›ºæœ‰IDã‚’ç”Ÿæˆãƒ»ä¿å­˜
      let deviceId = localStorage.getItem('help_chat_device_id');
      if (!deviceId) {
        deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('help_chat_device_id', deviceId);
        console.log('[Help] æ–°è¦ãƒ‡ãƒã‚¤ã‚¹IDç”Ÿæˆ:', deviceId);
      } else {
        console.log('[Help] æ—¢å­˜ãƒ‡ãƒã‚¤ã‚¹ID:', deviceId);
      }
      return deviceId;
    }

    // åˆæœŸåŒ–
    function initChat() {
      currentUserId = getUserId();
      console.log('[Help] ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:', currentUserId);

      // ä¼šè©±ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
      loadConversations();
    }

    // ä¼šè©±ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    function loadConversations() {
      const conversationListEl = document.getElementById('conversationList');
      conversationListEl.innerHTML = '<div class="loading-conversations">èª­ã¿è¾¼ã¿ä¸­...</div>';

      const q = query(
        collection(db, 'help_conversations'),
        where('userId', '==', currentUserId),
        orderBy('updatedAt', 'desc'),
        limit(50)
      );

      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
      unsubscribeConversations = onSnapshot(q, (snapshot) => {
        const conversations = [];
        snapshot.forEach((doc) => {
          conversations.push({ id: doc.id, ...doc.data() });
        });

        renderConversationList(conversations);
      }, (error) => {
        console.error('[Help] ä¼šè©±ä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        conversationListEl.innerHTML = '<div class="no-conversations">ä¼šè©±å±¥æ­´ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</div>';
      });
    }

    // ä¼šè©±ä¸€è¦§ã‚’æç”»
    function renderConversationList(conversations) {
      const conversationListEl = document.getElementById('conversationList');

      if (conversations.length === 0) {
        conversationListEl.innerHTML = '<div class="no-conversations">ä¼šè©±å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      let html = '';
      let lastDate = '';

      conversations.forEach((conv) => {
        // æ—¥ä»˜åŒºåˆ‡ã‚Š
        const convDate = conv.updatedAt?.toDate ? conv.updatedAt.toDate() : new Date();
        const dateStr = formatDateDivider(convDate);
        if (dateStr !== lastDate) {
          html += `<div class="conversation-date-divider">${dateStr}</div>`;
          lastDate = dateStr;
        }

        const activeClass = conv.id === currentConversationId ? 'active' : '';
        html += `
          <div class="conversation-item ${activeClass}" onclick="window.selectConversation('${conv.id}')" data-id="${conv.id}">
            <i class="bi bi-chat-left-text"></i>
            <span class="conversation-title">${escapeHtml(conv.title || 'æ–°ã—ã„ä¼šè©±')}</span>
            <button class="conversation-delete" onclick="event.stopPropagation(); window.deleteConversation('${conv.id}')" title="å‰Šé™¤">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        `;
      });

      conversationListEl.innerHTML = html;
    }

    // æ—¥ä»˜åŒºåˆ‡ã‚Šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatDateDivider(date) {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
      const targetDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

      if (targetDate.getTime() === today.getTime()) {
        return 'ä»Šæ—¥';
      } else if (targetDate.getTime() === yesterday.getTime()) {
        return 'æ˜¨æ—¥';
      } else if (targetDate.getTime() > today.getTime() - 7 * 24 * 60 * 60 * 1000) {
        return 'éå»7æ—¥é–“';
      } else if (targetDate.getTime() > today.getTime() - 30 * 24 * 60 * 60 * 1000) {
        return 'éå»30æ—¥é–“';
      } else {
        return date.getFullYear() + 'å¹´' + (date.getMonth() + 1) + 'æœˆ';
      }
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ä¼šè©±ã‚’é¸æŠ
    window.selectConversation = async function(conversationId) {
      currentConversationId = conversationId;

      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
      document.querySelectorAll('.conversation-item').forEach(el => {
        el.classList.toggle('active', el.dataset.id === conversationId);
      });

      // ä¼šè©±ã‚’èª­ã¿è¾¼ã¿
      try {
        const docRef = doc(db, 'help_conversations', conversationId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          const data = docSnap.data();
          conversationHistory = data.messages || [];

          // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          renderMessages();
        }
      } catch (error) {
        console.error('[Help] ä¼šè©±èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }

      // ãƒ¢ãƒã‚¤ãƒ«ã§ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
      if (window.innerWidth <= 768) {
        toggleSidebar();
      }
    };

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æç”»
    function renderMessages() {
      const messagesEl = document.getElementById('chatMessages');

      if (conversationHistory.length === 0) {
        messagesEl.innerHTML = `
          <div class="chat-welcome">
            <div class="chat-welcome-icon">ğŸ‘‹</div>
            <div class="chat-welcome-title">ã“ã‚“ã«ã¡ã¯ï¼</div>
            <div class="chat-welcome-desc">ãƒ•ãƒªãƒ©ã®ä½¿ã„æ–¹ã«ã¤ã„ã¦ä½•ã§ã‚‚èã„ã¦ãã ã•ã„ã€‚<br>ä¼šè©±å±¥æ­´ã¯è‡ªå‹•ã§ä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>
          </div>
        `;
        document.getElementById('quickActions').style.display = 'flex';
        return;
      }

      document.getElementById('quickActions').style.display = 'none';

      let html = '';
      conversationHistory.forEach((msg) => {
        const roleClass = msg.role === 'user' ? 'user' : 'ai';
        html += `<div class="chat-message ${roleClass}">${escapeHtml(msg.content)}</div>`;
      });

      messagesEl.innerHTML = html;
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // æ–°ã—ã„ä¼šè©±ã‚’é–‹å§‹
    window.startNewConversation = function() {
      currentConversationId = null;
      conversationHistory = [];

      // UIæ›´æ–°
      document.querySelectorAll('.conversation-item').forEach(el => {
        el.classList.remove('active');
      });

      renderMessages();

      // ãƒ¢ãƒã‚¤ãƒ«ã§ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
      if (window.innerWidth <= 768) {
        toggleSidebar();
      }
    };

    // ä¼šè©±ã‚’å‰Šé™¤
    window.deleteConversation = async function(conversationId) {
      if (!confirm('ã“ã®ä¼šè©±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

      try {
        await deleteDoc(doc(db, 'help_conversations', conversationId));
        console.log('[Help] ä¼šè©±å‰Šé™¤å®Œäº†:', conversationId);

        // ç¾åœ¨è¡¨ç¤ºä¸­ã®ä¼šè©±ãŒå‰Šé™¤ã•ã‚ŒãŸå ´åˆ
        if (currentConversationId === conversationId) {
          startNewConversation();
        }
      } catch (error) {
        console.error('[Help] ä¼šè©±å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    };

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    window.sendMessage = async function() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();

      if (!message) return;

      // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
      input.value = '';
      autoResize(input);
      document.getElementById('chatSendBtn').disabled = true;

      // ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
      document.getElementById('quickActions').style.display = 'none';

      // ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
      const welcome = document.querySelector('.chat-welcome');
      if (welcome) welcome.remove();

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      addMessageToUI(message, 'user');

      // ä¼šè©±å±¥æ­´ã«è¿½åŠ 
      conversationHistory.push({ role: 'user', content: message, timestamp: new Date().toISOString() });

      // æ–°ã—ã„ä¼šè©±ã®å ´åˆã€Firestoreã«ä½œæˆ
      if (!currentConversationId) {
        try {
          const title = message.length > 30 ? message.substring(0, 30) + '...' : message;
          const docRef = await addDoc(collection(db, 'help_conversations'), {
            userId: currentUserId,
            title: title,
            messages: conversationHistory,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
          currentConversationId = docRef.id;
          console.log('[Help] æ–°ã—ã„ä¼šè©±ä½œæˆ:', currentConversationId);
        } catch (error) {
          console.error('[Help] ä¼šè©±ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
        }
      }

      // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤º
      const typingId = showTypingIndicator();

      try {
        // APIã‚’å‘¼ã³å‡ºã—
        const response = await fetch(CHATBOT_API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: message,
            history: conversationHistory.slice(-10)
          }),
        });

        // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’å‰Šé™¤
        removeTypingIndicator(typingId);

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        const aiResponse = data.response || 'ã™ã¿ã¾ã›ã‚“ã€å›ç­”ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';

        // AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        addMessageToUI(aiResponse, 'ai');

        // ä¼šè©±å±¥æ­´ã«è¿½åŠ 
        conversationHistory.push({ role: 'assistant', content: aiResponse, timestamp: new Date().toISOString() });

        // Firestoreã«ä¿å­˜
        if (currentConversationId) {
          try {
            await updateDoc(doc(db, 'help_conversations', currentConversationId), {
              messages: conversationHistory,
              updatedAt: serverTimestamp()
            });
          } catch (error) {
            console.error('[Help] ä¼šè©±æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
          }
        }

      } catch (error) {
        console.error('ãƒãƒ£ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
        removeTypingIndicator(typingId);

        const errorMessage = 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ç¾åœ¨AIã‚µãƒãƒ¼ãƒˆã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ã—ã°ã‚‰ãçµŒã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        addMessageToUI(errorMessage, 'ai');
      }
    };

    // UIã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    function addMessageToUI(text, type) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${type}`;
      messageDiv.textContent = text;
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤º
    function showTypingIndicator() {
      const messagesContainer = document.getElementById('chatMessages');
      const typingDiv = document.createElement('div');
      const typingId = 'typing-' + Date.now();
      typingDiv.id = typingId;
      typingDiv.className = 'chat-message ai typing';
      typingDiv.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
      messagesContainer.appendChild(typingDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      return typingId;
    }

    // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’å‰Šé™¤
    function removeTypingIndicator(typingId) {
      const typingDiv = document.getElementById(typingId);
      if (typingDiv) {
        typingDiv.remove();
      }
    }

    // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®è‡ªå‹•ãƒªã‚µã‚¤ã‚º
    window.autoResize = function(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';

      const sendBtn = document.getElementById('chatSendBtn');
      sendBtn.disabled = !textarea.value.trim();
    };

    // Enterã‚­ãƒ¼ã§é€ä¿¡
    window.handleKeyDown = function(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    };

    // ã‚¯ã‚¤ãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    window.sendQuickMessage = function(message) {
      document.getElementById('chatInput').value = message;
      sendMessage();
    };

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®é–‹é–‰
    window.toggleSidebar = function() {
      const sidebar = document.getElementById('chatSidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.toggle('open');
      overlay.classList.toggle('open');
    };

    // ãƒãƒ£ãƒƒãƒˆå…¨ç”»é¢ã‚’é–‹ã
    window.openChatFullscreen = function() {
      const fullscreen = document.getElementById('chatFullscreen');
      fullscreen.classList.add('open');

      // ãƒœãƒˆãƒ ãƒŠãƒ“ã‚’éè¡¨ç¤º
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'hideBottomNav' }, '*');
      }

      // åˆæœŸåŒ–ãŒã¾ã ã®å ´åˆ
      if (!currentUserId) {
        initChat();
      }
    };

    // ãƒãƒ£ãƒƒãƒˆå…¨ç”»é¢ã‚’é–‰ã˜ã‚‹
    window.closeChatFullscreen = function() {
      const fullscreen = document.getElementById('chatFullscreen');
      fullscreen.classList.remove('open');

      // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚‚é–‰ã˜ã‚‹
      const sidebar = document.getElementById('chatSidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.remove('open');
      overlay.classList.remove('open');

      // ãƒœãƒˆãƒ ãƒŠãƒ“ã‚’è¡¨ç¤º
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'showBottomNav' }, '*');
      }
    };

    // å…¥åŠ›ç›£è¦–ã®åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      const input = document.getElementById('chatInput');
      if (input) {
        input.addEventListener('input', function() {
          autoResize(this);
        });
      }
    });

    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    window.addEventListener('beforeunload', () => {
      if (unsubscribeConversations) {
        unsubscribeConversations();
      }
    });
  </script>

  <script>
    // FAQã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³
    function toggleFaq(element) {
      document.querySelectorAll('.faq-item.open').forEach(item => {
        if (item !== element) {
          item.classList.remove('open');
        }
      });
      element.classList.toggle('open');
    }

    // æ“ä½œã‚¬ã‚¤ãƒ‰è¡¨ç¤º
    function showGuide(type) {
      alert('ã€Œ' + type + 'ã€ã®ã‚¬ã‚¤ãƒ‰ã¯æº–å‚™ä¸­ã§ã™ã€‚');
    }

    // æˆ»ã‚‹ãƒœã‚¿ãƒ³
    function goBack() {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'requestBack' }, '*');
      } else {
        window.history.back();
      }
    }
  </script>
</body>
</html>
