<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://www.reborn-inventory.com/css/reborn-brand-colors.css?v=0bd1a9b">
  <link rel="stylesheet" href="/css/reborn-theme.css?v=296">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      padding: 0;
      background-color: #f8f9fa;
      margin: 0;
    }

    /* PCç‰ˆï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ã®ã¿é€æ˜èƒŒæ™¯ */
    @media (min-width: 768px) {
      body {
        background-color: transparent;
      }
    }

    .container-fluid {
      padding: 12px; /* ã‚¹ãƒãƒ›ç‰ˆ: å°‘ã—ä½™ç™½ */
    }

    /* PCç‰ˆ: ä½™ç™½æœ€å° */
    @media (min-width: 768px) {
      .container-fluid {
        padding: 8px;
      }
    }

    .filter-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      border: 1px solid #e9ecef;
    }
    .filter-section .form-label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 6px;
    }
    .filter-section .form-select,
    .filter-section .form-control {
      border: 1px solid #ced4da;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      transition: all 0.2s ease;
    }
    .filter-section .form-select:focus,
    .filter-section .form-control:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    .filter-section .btn-primary {
      padding: 10px 24px;
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(37, 99, 235, 0.3);
      transition: all 0.2s ease;
    }
    .filter-section .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }
    .history-card {
      background: white;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      border-left: 4px solid #e9ecef;
      transition: box-shadow 0.2s ease;
    }
    .history-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .history-card.card-inbound {
      border-left-color: #10b981;
    }
    .history-card.card-outbound {
      border-left-color: #ef4444;
    }
    .history-card.card-adjustment {
      border-left-color: #f59e0b;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e9ecef;
    }
    .card-date {
      font-size: 0.85rem;
      color: #6c757d;
    }
    .card-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .card-material {
      font-weight: 600;
      font-size: 1rem;
      color: #212529;
    }
    .card-quantity {
      font-size: 1.25rem;
      font-weight: 700;
      color: #212529;
    }
    .card-details {
      font-size: 0.85rem;
      color: #6c757d;
    }
    .card-detail-row {
      margin-top: 4px;
    }
    .card-detail-row.price-info {
      color: #059669;
      font-weight: 600;
    }
    .table thead th {
      background-color: #f59e0b;
      color: white;
      font-weight: 600;
      border: none;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .table tbody tr:hover {
      background-color: #f8f9fa;
    }
    .badge-type {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .spinner-border {
      width: 3rem;
      height: 3rem;
    }
    .table-container {
      max-height: 500px;
      overflow-y: auto;
      overflow-x: auto;
    }
    .table {
      font-size: 0.85rem;
      white-space: nowrap;
    }
    .table th {
      font-size: 0.75rem;
      padding: 8px 4px;
    }
    .table td {
      padding: 6px 4px;
    }
    .export-section {
      background: white;
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- ã‚µãƒ–ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆç™½èƒŒæ™¯ãƒ»ã‚·ãƒ³ãƒ—ãƒ«ï¼‰ -->
  <style>
    .sub-header {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 56px;
      padding: 0 16px;
      background: #ffffff;
      border-bottom: 1px solid #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .sub-header-back {
      position: absolute;
      left: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: transparent;
      border: none;
      color: #374151;
      font-size: 20px;
      cursor: pointer;
    }
    .sub-header-back:hover { background: #f3f4f6; }
    .sub-header-back:active { background: #e5e7eb; }
    .sub-header-title {
      font-size: 17px;
      font-weight: 600;
      color: #111827;
    }
    .sub-header-icons {
      position: absolute;
      right: 8px;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    .sub-header-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: transparent;
      border: none;
      color: #374151;
      font-size: 20px;
      cursor: pointer;
    }
    .sub-header-icon:hover { background: #f3f4f6; }
    .sub-header-icon:active { background: #e5e7eb; }
    /* è¨­å®šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ */
    .settings-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 180px;
      padding: 8px 0;
      display: none;
      z-index: 1001;
    }
    .settings-dropdown.show {
      display: block;
    }
    .settings-dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border: none;
      background: none;
      width: 100%;
      font-size: 14px;
      color: #374151;
      cursor: pointer;
      text-align: left;
    }
    .settings-dropdown-item:hover {
      background: #f3f4f6;
    }
    .settings-dropdown-item i {
      font-size: 18px;
      color: #6b7280;
      width: 20px;
      text-align: center;
    }
  </style>
  <div class="sub-header">
    <button class="sub-header-back" onclick="window.parent.postMessage({type:'navigateToPage', page:'home'}, '*')" title="æˆ»ã‚‹">
      <i class="bi bi-chevron-left"></i>
    </button>
    <span class="sub-header-title">è³‡æç®¡ç†</span>
    <div class="sub-header-icons">
      <button class="sub-header-icon" onclick="window.parent.postMessage({type:'openChatRooms'}, '*')" title="ãŠçŸ¥ã‚‰ã›">
        <i class="bi bi-bell"></i>
      </button>
      <div style="position: relative;">
        <button class="sub-header-icon" onclick="toggleSettingsDropdown(event)" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
          <i class="bi bi-list"></i>
        </button>
        <div class="settings-dropdown" id="settingsDropdown">
          <button class="settings-dropdown-item" onclick="exportToCSV()">
            <i class="bi bi-download"></i>
            <span>CSVå‡ºåŠ›</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  <script>
  function toggleSettingsDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('settingsDropdown');
    dropdown.classList.toggle('show');
  }
  document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('settingsDropdown');
    if (dropdown && !e.target.closest('.settings-dropdown') && !e.target.closest('.sub-header-icon')) {
      dropdown.classList.remove('show');
    }
  });
  </script>

  <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <style>
    .material-tabs {
      display: flex;
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      position: sticky;
      top: 56px;
      z-index: 999;
    }
    .material-tab {
      flex: 1;
      padding: 12px 8px;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      color: #6b7280;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }
    .material-tab:hover {
      color: #374151;
      background: #f9fafb;
    }
    .material-tab.active {
      color: #2563eb;
      border-bottom-color: #2563eb;
    }
    .material-tab i {
      display: block;
      font-size: 18px;
      margin-bottom: 4px;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    /* åœ¨åº«ã‚¿ãƒ–å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .stock-card {
      background: white;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border-left: 4px solid #e5e7eb;
    }
    .stock-card.stock-ok { border-left-color: #10b981; }
    .stock-card.stock-warning { border-left-color: #f59e0b; }
    .stock-card.stock-danger { border-left-color: #ef4444; }
    .stock-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .stock-card-name {
      font-weight: 600;
      font-size: 14px;
    }
    .stock-card-category {
      font-size: 12px;
      color: #6b7280;
    }
    .stock-card-body {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .stock-count {
      font-size: 20px;
      font-weight: 700;
    }
    .stock-count.text-success { color: #10b981; }
    .stock-count.text-warning { color: #f59e0b; }
    .stock-count.text-danger { color: #ef4444; }
    .stock-actions {
      display: flex;
      gap: 8px;
    }
    /* ç™ºæ³¨ã‚¿ãƒ–å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .order-card {
      background: white;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border-left: 4px solid #3b82f6;
    }
    .order-card.order-pending { border-left-color: #f59e0b; }
    .order-card.order-received { border-left-color: #10b981; }
    .order-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .order-card-date {
      font-size: 12px;
      color: #6b7280;
    }
    .order-card-body {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .order-material {
      font-weight: 600;
    }
    .order-quantity {
      font-size: 16px;
      font-weight: 600;
    }
  </style>

  <div class="material-tabs">
    <button class="material-tab active" data-tab="stock" onclick="switchTab('stock')">
      <i class="bi bi-box-seam"></i>
      åœ¨åº«
    </button>
    <button class="material-tab" data-tab="history" onclick="switchTab('history')">
      <i class="bi bi-arrow-left-right"></i>
      å…¥å‡ºåº«å±¥æ­´
    </button>
    <button class="material-tab" data-tab="orders" onclick="switchTab('orders')">
      <i class="bi bi-cart-plus"></i>
      ç™ºæ³¨
    </button>
  </div>

  <!-- åœ¨åº«ã‚¿ãƒ– -->
  <div class="tab-content active" id="tab-stock">
    <div class="container-fluid">
      <div class="filter-section" style="margin-top: 12px;">
        <div class="row g-2 mb-2">
          <div class="col-8">
            <select class="form-select form-select-sm" id="stockCategoryFilter">
              <option value="">å…¨ã‚«ãƒ†ã‚´ãƒª</option>
            </select>
          </div>
          <div class="col-2">
            <button class="btn btn-success btn-sm w-100" onclick="showStockInModalMaterial()">
              <i class="bi bi-plus"></i> å…¥åº«
            </button>
          </div>
          <div class="col-2">
            <button class="btn btn-warning btn-sm w-100" onclick="showStockAdjustmentModal()">
              <i class="bi bi-pencil"></i> èª¿æ•´
            </button>
          </div>
        </div>
        <div class="row g-2">
          <div class="col-12">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="showLowStockOnly">
              <label class="form-check-label small" for="showLowStockOnly">è¦ç™ºæ³¨ã®ã¿è¡¨ç¤º</label>
            </div>
          </div>
        </div>
      </div>
      <div id="stockList"></div>
    </div>
  </div>

  <!-- å…¥å‡ºåº«å±¥æ­´ã‚¿ãƒ– -->
  <div class="tab-content" id="tab-history">
    <div class="container-fluid">

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="filter-section">
      <!-- Row 1: ã‚«ãƒ†ã‚´ãƒª | è³‡æå -->
      <div class="row g-2 mb-2">
        <div class="col-6 col-md-2">
          <label for="filterCategory" class="form-label small mb-1">ã‚«ãƒ†ã‚´ãƒª</label>
          <select class="form-select form-select-sm" id="filterCategory">
            <option value="">å…¨ã¦</option>
          </select>
        </div>
        <div class="col-6 col-md-3">
          <label for="filterMaterial" class="form-label small mb-1">è³‡æå</label>
          <select class="form-select form-select-sm" id="filterMaterial">
            <option value="">å…¨ã¦</option>
          </select>
        </div>
      </div>

      <!-- Row 2: ç¨®åˆ¥ -->
      <div class="row g-2 mb-2">
        <div class="col-6 col-md-2">
          <label for="filterType" class="form-label small mb-1">ç¨®åˆ¥</label>
          <select class="form-select form-select-sm" id="filterType">
            <option value="">å…¨ã¦</option>
            <option value="å…¥åº«">å…¥åº«</option>
            <option value="å‡ºåº«">å‡ºåº«</option>
            <option value="èª¿æ•´">èª¿æ•´</option>
          </select>
        </div>
      </div>

      <!-- Row 3: æœŸé–“ã‚¯ã‚¤ãƒƒã‚¯é¸æŠ -->
      <div class="row g-2 mb-1">
        <div class="col-12">
          <label class="form-label small mb-1 text-muted"><i class="bi bi-calendar3"></i> æœŸé–“ã‚¯ã‚¤ãƒƒã‚¯é¸æŠ</label>
        </div>
        <div class="col-12">
          <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm flex-fill" id="btnAllPeriod">å…¨æœŸé–“</button>
            <button class="btn btn-outline-primary btn-sm flex-fill" id="btnThisMonth">ä»Šæœˆ</button>
            <button class="btn btn-outline-primary btn-sm flex-fill" id="btnLastMonth">å…ˆæœˆ</button>
          </div>
        </div>
      </div>
      <div class="row g-2 mb-2">
        <div class="col-12">
          <div class="d-flex gap-2">
            <select class="form-select form-select-sm flex-fill" id="filterYear">
              <option value="">å¹´é¸æŠ</option>
            </select>
            <select class="form-select form-select-sm flex-fill" id="filterMonth">
              <option value="">æœˆé¸æŠ</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Row 4: é–‹å§‹æ—¥ | çµ‚äº†æ—¥ -->
      <div class="row g-2 mb-2">
        <div class="col-6 col-md-2">
          <label for="filterStartDate" class="form-label small mb-1">é–‹å§‹æ—¥</label>
          <input type="date" class="form-control form-control-sm" id="filterStartDate">
        </div>
        <div class="col-6 col-md-2">
          <label for="filterEndDate" class="form-label small mb-1">çµ‚äº†æ—¥</label>
          <input type="date" class="form-control form-control-sm" id="filterEndDate">
        </div>
      </div>

      <!-- Row 5: æ¤œç´¢ãƒœã‚¿ãƒ³ -->
      <div class="row g-2 mb-2">
        <div class="col-12 col-md-3">
          <button class="btn btn-primary btn-sm w-100" id="btnSearch"><i class="bi bi-search"></i> æ¤œç´¢</button>
        </div>
      </div>

      <!-- ãƒªã‚»ãƒƒãƒˆãƒ»ä»¶æ•°è¡¨ç¤º -->
      <div class="row mt-2">
        <div class="col-12">
          <button class="btn btn-outline-secondary btn-sm" id="btnReset"><i class="bi bi-arrow-clockwise"></i> ãƒªã‚»ãƒƒãƒˆ</button>
          <span class="ms-3 text-muted small" id="resultCount"></span>
        </div>
      </div>
    </div>

    <!-- å±¥æ­´ã‚«ãƒ¼ãƒ‰ä¸€è¦§ -->
    <div id="historyCards"></div>

    <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div id="pagination" class="d-flex justify-content-center align-items-center gap-2 my-3" style="display: none !important;"></div>

    </div>
  </div>

  <!-- ç™ºæ³¨ã‚¿ãƒ– -->
  <div class="tab-content" id="tab-orders">
    <div class="container-fluid">
      <div class="filter-section" style="margin-top: 12px;">
        <div class="row g-2 mb-2">
          <div class="col-6">
            <select class="form-select form-select-sm" id="orderStatusFilter">
              <option value="">å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
              <option value="ordered" selected>ç™ºæ³¨ä¸­</option>
              <option value="received">å…¥è·æ¸ˆã¿</option>
              <option value="cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
            </select>
          </div>
          <div class="col-6">
            <button class="btn btn-primary btn-sm w-100" onclick="showOrderModalMaterial()">
              <i class="bi bi-cart-plus"></i> æ–°è¦ç™ºæ³¨
            </button>
          </div>
        </div>
      </div>
      <div id="ordersList"></div>
    </div>
  </div>

  <!-- å…¥åº«ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal fade" id="stockInModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-box-arrow-in-down"></i> å…¥åº«ç™»éŒ²</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">è³‡æé¸æŠ</label>
            <select class="form-select" id="stockInMaterial" style="font-size:16px;">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">å…¥åº«æ•°é‡</label>
            <input type="number" class="form-control" id="stockInQuantity" min="1" style="font-size:16px;">
          </div>
          <div class="mb-3">
            <label class="form-label">è³¼å…¥ä¾¡æ ¼ï¼ˆåˆè¨ˆãƒ»ç¨è¾¼ï¼‰</label>
            <input type="number" class="form-control" id="stockInPrice" min="0" style="font-size:16px;">
            <small class="text-muted">â€»å…¥åº«æ•°ã§å‰²ã£ã¦å˜ä¾¡ã‚’è¨ˆç®—ã—ã¾ã™</small>
          </div>
          <div class="mb-3">
            <label class="form-label">ç™ºæ³¨å…ˆï¼ˆä»»æ„ï¼‰</label>
            <input type="text" class="form-control" id="stockInSupplier" placeholder="ä¾‹: Amazon, æ¥½å¤©" style="font-size:16px;">
          </div>
          <div class="mb-3">
            <label class="form-label">å‚™è€ƒ</label>
            <input type="text" class="form-control" id="stockInNote" style="font-size:16px;">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="btn btn-success" onclick="processStockInMaterial()">å…¥åº«ç™»éŒ²</button>
        </div>
      </div>
    </div>
  </div>

  <!-- åœ¨åº«èª¿æ•´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal fade" id="stockAdjustmentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-pencil-square"></i> åœ¨åº«èª¿æ•´ï¼ˆæ¸›å°‘ï¼‰</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">è³‡æé¸æŠ</label>
            <select class="form-select" id="adjustMaterial" style="font-size:16px;">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">æ¸›å°‘æ•°é‡</label>
            <input type="number" class="form-control" id="adjustQuantity" min="1" style="font-size:16px;">
            <small class="text-muted">â€»æ–°ã—ã„ãƒ­ãƒƒãƒˆã‹ã‚‰è‡ªå‹•çš„ã«æ¸›å°‘ã—ã¾ã™ï¼ˆLIFOï¼‰</small>
          </div>
          <div class="mb-3">
            <label class="form-label">ç†ç”±</label>
            <select class="form-select" id="adjustReason" style="font-size:16px;">
              <option value="damaged">ç ´æ</option>
              <option value="lost">ç´›å¤±</option>
              <option value="discarded">å»ƒæ£„</option>
              <option value="other">ãã®ä»–</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">å‚™è€ƒ</label>
            <input type="text" class="form-control" id="adjustNote" placeholder="è©³ç´°ãƒ¡ãƒ¢" style="font-size:16px;">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="btn btn-warning" onclick="processStockAdjustmentMaterial()">åœ¨åº«èª¿æ•´</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç™ºæ³¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal fade" id="orderModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-cart-plus"></i> ç™ºæ³¨ç™»éŒ²</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">è³‡æé¸æŠ</label>
            <select class="form-select" id="orderMaterial" style="font-size:16px;">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">ç™ºæ³¨æ•°é‡</label>
            <input type="number" class="form-control" id="orderQuantity" min="1" style="font-size:16px;">
          </div>
          <div class="mb-3">
            <label class="form-label">ç™ºæ³¨å…ˆ</label>
            <input type="text" class="form-control" id="orderSupplier" style="font-size:16px;">
          </div>
          <div class="mb-3">
            <label class="form-label">å‚™è€ƒ</label>
            <input type="text" class="form-control" id="orderNote" style="font-size:16px;">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="btn btn-primary" onclick="processOrderMaterial()">ç™ºæ³¨ç™»éŒ²</button>
        </div>
      </div>
    </div>
  </div>

  <!-- å…¥è·å‡¦ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal fade" id="receiveModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-check-circle"></i> å…¥è·å‡¦ç†</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">è³‡æå</label>
            <input type="text" class="form-control" id="receiveMaterialName" readonly style="font-size:16px;">
            <input type="hidden" id="receiveOrderId">
            <input type="hidden" id="receiveMaterialId">
          </div>
          <div class="mb-3">
            <label class="form-label">ç™ºæ³¨æ•°é‡</label>
            <input type="number" class="form-control" id="receiveOrderedQuantity" readonly style="font-size:16px;">
          </div>
          <div class="mb-3">
            <label class="form-label">å®Ÿéš›ã®å…¥è·æ•°é‡</label>
            <input type="number" class="form-control" id="receiveActualQuantity" min="1" style="font-size:16px;">
          </div>
          <div class="mb-3">
            <label class="form-label">è³¼å…¥ä¾¡æ ¼ï¼ˆç¨è¾¼ï¼‰</label>
            <input type="number" class="form-control" id="receivePrice" min="0" style="font-size:16px;">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="btn btn-success" onclick="processReceiveOrderMaterial()">å…¥è·å®Œäº†</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentHistoryData = [];
    let allMaterials = []; // å…¨è³‡æãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
    let currentPage = 1;
    const itemsPerPage = 10;

    // æ—¥æœ¬æ™‚é–“ã§ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆYYYY-MM-DDå½¢å¼ï¼‰
    function getJSTToday() {
      const now = new Date();
      const jst = new Date(now.getTime() + (9 * 60 + now.getTimezoneOffset()) * 60000);
      const year = jst.getFullYear();
      const month = String(jst.getMonth() + 1).padStart(2, '0');
      const day = String(jst.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸš€ inventory_history_viewer.html ãƒãƒ¼ã‚¸ãƒ§ãƒ³: @451-PAGINATION-10');
      console.log('ğŸ”§ APIé–¢æ•°å: getInventoryHistoryAPI (Wrapperãªã— - ç›´æ¥å‘¼ã³å‡ºã—)');
      console.log('ğŸ”§ APIé–¢æ•°å2: getPackagingMaterialsAPI (Wrapperãªã— - ç›´æ¥å‘¼ã³å‡ºã—)');

      initializePeriodFilters();
      loadMaterialsList();
      showInitialMessage(); // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      document.getElementById('filterCategory').addEventListener('change', function() {
        filterMaterialsByCategory(this.value);
      });
      document.getElementById('btnAllPeriod').addEventListener('click', setAllPeriod);
      document.getElementById('btnThisMonth').addEventListener('click', setThisMonth);
      document.getElementById('btnLastMonth').addEventListener('click', setLastMonth);
      document.getElementById('filterYear').addEventListener('change', updatePeriodFromYearMonth);
      document.getElementById('filterMonth').addEventListener('change', updatePeriodFromYearMonth);
      document.getElementById('btnSearch').addEventListener('click', loadHistoryData);
      document.getElementById('btnReset').addEventListener('click', resetFilters);
    });

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º/éè¡¨ç¤º
    function showLoading() {
      document.getElementById('loadingOverlay').style.display = 'flex';
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }

    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showInitialMessage() {
      const container = document.getElementById('historyCards');
      container.innerHTML = `
        <div class="text-center text-muted py-5" style="font-size: 1rem;">
          <div>æ¤œç´¢æ¡ä»¶ã‚’é¸æŠã—ã¦æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</div>
        </div>
      `;
      document.getElementById('resultCount').textContent = '';
    }

    // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ã®åˆæœŸåŒ–
    function initializePeriodFilters() {
      const currentYear = new Date().getFullYear();
      const yearSelect = document.getElementById('filterYear');

      // 2020å¹´ã‹ã‚‰ç¾åœ¨å¹´ã¾ã§ï¼ˆé™é †ï¼‰
      for (let year = currentYear; year >= 2020; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = `${year}å¹´`;
        yearSelect.appendChild(option);
      }

      // 1æœˆã€œ12æœˆã®å›ºå®šãƒªã‚¹ãƒˆ
      const monthSelect = document.getElementById('filterMonth');
      for (let month = 1; month <= 12; month++) {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = `${month}æœˆ`;
        monthSelect.appendChild(option);
      }
    }

    // å…¨æœŸé–“ã‚’è¨­å®š
    function setAllPeriod() {
      document.getElementById('filterStartDate').value = '';
      document.getElementById('filterEndDate').value = '';
      document.getElementById('filterYear').value = '';
      document.getElementById('filterMonth').value = '';
    }

    // ä»Šæœˆã‚’è¨­å®š
    function setThisMonth() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const firstDay = `${year}-${month}-01`;
      const lastDay = new Date(year, now.getMonth() + 1, 0);
      const lastDayStr = `${year}-${month}-${String(lastDay.getDate()).padStart(2, '0')}`;

      document.getElementById('filterStartDate').value = firstDay;
      document.getElementById('filterEndDate').value = lastDayStr;
      document.getElementById('filterYear').value = '';
      document.getElementById('filterMonth').value = '';
    }

    // å…ˆæœˆã‚’è¨­å®š
    function setLastMonth() {
      const now = new Date();
      const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      const year = lastMonth.getFullYear();
      const month = String(lastMonth.getMonth() + 1).padStart(2, '0');
      const firstDay = `${year}-${month}-01`;
      const lastDay = new Date(year, lastMonth.getMonth() + 1, 0);
      const lastDayStr = `${year}-${month}-${String(lastDay.getDate()).padStart(2, '0')}`;

      document.getElementById('filterStartDate').value = firstDay;
      document.getElementById('filterEndDate').value = lastDayStr;
      document.getElementById('filterYear').value = '';
      document.getElementById('filterMonth').value = '';
    }

    // å¹´ã¾ãŸã¯æœˆã®é¸æŠå¤‰æ›´æ™‚ã«æœŸé–“ã‚’è¨­å®š
    function updatePeriodFromYearMonth() {
      const year = document.getElementById('filterYear').value;
      const month = document.getElementById('filterMonth').value;

      if (year && month) {
        // å¹´ãƒ»æœˆä¸¡æ–¹é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
        const lastDay = new Date(year, month, 0).getDate();
        document.getElementById('filterStartDate').value = `${year}-${String(month).padStart(2, '0')}-01`;
        document.getElementById('filterEndDate').value = `${year}-${String(month).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`;
      } else if (year && !month) {
        // å¹´ã®ã¿é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
        document.getElementById('filterStartDate').value = `${year}-01-01`;
        document.getElementById('filterEndDate').value = `${year}-12-31`;
      } else {
        // ãã‚Œä»¥å¤–ã¯ã‚¯ãƒªã‚¢
        document.getElementById('filterStartDate').value = '';
        document.getElementById('filterEndDate').value = '';
      }
    }

    // è³‡æãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿
    function loadMaterialsList() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (!result) {
            console.error('è³‡æãƒªã‚¹ãƒˆAPIã‹ã‚‰å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            return;
          }

          if (result.success) {
            allMaterials = result.data;

            // ã‚«ãƒ†ã‚´ãƒªã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒªã‚¹ãƒˆã‚’å–å¾—
            const categories = [...new Set(result.data.map(m => m.category).filter(c => c))];
            const categorySelect = document.getElementById('filterCategory');
            categorySelect.innerHTML = '<option value="">å…¨ã¦</option>';

            categories.forEach(cat => {
              const option = document.createElement('option');
              option.value = cat;
              option.textContent = cat;
              categorySelect.appendChild(option);
            });

            // åˆæœŸè¡¨ç¤º: å…¨è³‡æã‚’è¡¨ç¤º
            filterMaterialsByCategory('');
          }
        })
        .withFailureHandler(function(error) {
          console.error('è³‡æãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getPackagingMaterialsAPI();
    }

    // ã‚«ãƒ†ã‚´ãƒªé¸æŠã«ã‚ˆã‚‹è³‡æãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    function filterMaterialsByCategory(category) {
      const materialSelect = document.getElementById('filterMaterial');
      materialSelect.innerHTML = '<option value="">å…¨ã¦</option>';

      const filtered = category ? allMaterials.filter(m => m.category === category) : allMaterials;

      filtered.forEach(material => {
        const option = document.createElement('option');
        option.value = material.productName;
        option.textContent = material.productName;
        materialSelect.appendChild(option);
      });
    }

    // å±¥æ­´ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    function loadHistoryData() {
      showLoading();

      const params = {
        materialName: document.getElementById('filterMaterial').value || undefined,
        type: document.getElementById('filterType').value || undefined,
        startDate: document.getElementById('filterStartDate').value || undefined,
        endDate: document.getElementById('filterEndDate').value || undefined,
        limit: 1000
      };

      // undefinedã®ã‚­ãƒ¼ã‚’å‰Šé™¤
      Object.keys(params).forEach(key => params[key] === undefined && delete params[key]);

      console.log('APIå‘¼ã³å‡ºã—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:', params);

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          console.log('âœ… Success handler called');
          console.log('Result:', result);
          console.log('Result type:', typeof result);
          
          if (!result) {
            showError('APIã‹ã‚‰å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å…¥å‡ºåº«å±¥æ­´ã‚·ãƒ¼ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            return;
          }

          if (result.success) {
            currentHistoryData = result.data;
            currentPage = 1; // æ¤œç´¢çµæœã¯å¸¸ã«1ãƒšãƒ¼ã‚¸ç›®ã‹ã‚‰è¡¨ç¤º
            renderHistoryTable(result.data);
            document.getElementById('resultCount').textContent = `${result.data.length}ä»¶`;
          } else {
            showError(result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error('âŒ Failure handler called');
          console.error('Error object:', error);
          console.error('Error message:', error.message);
          showError('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .getInventoryHistoryAPI(params);
    }

    // å±¥æ­´ã‚«ãƒ¼ãƒ‰æç”»ï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
    function renderHistoryTable(data) {
      const container = document.getElementById('historyCards');
      const paginationContainer = document.getElementById('pagination');

      if (data.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-4">è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        paginationContainer.style.display = 'none';
        return;
      }

      // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç®—
      const totalPages = Math.ceil(data.length / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageData = data.slice(startIndex, endIndex);

      // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
      container.innerHTML = pageData.map(item => {
        // ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ã‚¯ãƒ©ã‚¹ã‚’æ±ºå®š
        let cardTypeClass = '';
        if (item.type === 'å…¥åº«') cardTypeClass = 'card-inbound';
        else if (item.type === 'å‡ºåº«') cardTypeClass = 'card-outbound';
        else if (item.type === 'èª¿æ•´') cardTypeClass = 'card-adjustment';

        return `
        <div class="history-card ${cardTypeClass}">
          <div class="card-header">
            <span class="card-date">${formatDateTime(item.timestamp)}</span>
            ${getBadgeType(item.type)}
          </div>
          <div class="card-main">
            <div class="card-material">${escapeHtml(item.materialName)}</div>
            <div class="card-quantity">${item.quantity.toLocaleString()}å€‹</div>
          </div>
          <div class="card-details">${item.type === 'å…¥åº«' ? `<div style="display:flex;gap:12px;margin-top:8px;padding-top:8px;border-top:1px solid #f0f0f0;"><div style="flex:1;">${item.purchasePrice ? `<div class="card-detail-row price-info">è³¼å…¥ä¾¡æ ¼: Â¥${item.purchasePrice.toLocaleString()}</div>` : ''}${item.packageQuantity ? `<div class="card-detail-row price-info">è³¼å…¥å€‹æ•°: ${item.packageQuantity.toLocaleString()}å€‹</div>` : ''}${item.unitCost ? `<div class="card-detail-row price-info">å˜ä¾¡: Â¥${item.unitCost.toFixed(2)}</div>` : ''}</div><div style="flex:1;">${item.reason ? `<div class="card-detail-row">ç†ç”±: ${escapeHtml(item.reason)}</div>` : ''}${item.operator ? `<div class="card-detail-row">ãƒ¦ãƒ¼ã‚¶ãƒ¼å: ${escapeHtml(item.operator)}</div>` : ''}${item.relatedSalesRecord ? `<div class="card-detail-row">è²©å£²è¨˜éŒ²: ${escapeHtml(item.relatedSalesRecord)}</div>` : ''}${item.note ? `<div class="card-detail-row">å‚™è€ƒ: ${escapeHtml(item.note)}</div>` : ''}</div></div>` : `${item.reason ? `<div class="card-detail-row" style="margin-top:8px;padding-top:8px;border-top:1px solid #f0f0f0;">ç†ç”±: ${escapeHtml(item.reason)}</div>` : ''}${item.operator ? `<div class="card-detail-row">ãƒ¦ãƒ¼ã‚¶ãƒ¼å: ${escapeHtml(item.operator)}</div>` : ''}${item.relatedSalesRecord ? `<div class="card-detail-row">è²©å£²è¨˜éŒ²: ${escapeHtml(item.relatedSalesRecord)}</div>` : ''}${item.note ? `<div class="card-detail-row">å‚™è€ƒ: ${escapeHtml(item.note)}</div>` : ''}`}</div>
        </div>
      `;}).join('');

      // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³UIç”Ÿæˆ
      renderPagination(totalPages, data.length);
    }

    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³UIç”Ÿæˆ
    function renderPagination(totalPages, totalItems) {
      const paginationContainer = document.getElementById('pagination');

      if (totalPages <= 1) {
        paginationContainer.style.display = 'none';
        return;
      }

      paginationContainer.style.display = 'flex';

      let html = '';

      // å‰ã¸ãƒœã‚¿ãƒ³
      html += `<button class="btn btn-outline-primary btn-sm" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">â€¹ å‰ã¸</button>`;

      // ãƒšãƒ¼ã‚¸ç•ªå·ãƒœã‚¿ãƒ³
      const maxButtons = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
      let endPage = Math.min(totalPages, startPage + maxButtons - 1);

      if (endPage - startPage < maxButtons - 1) {
        startPage = Math.max(1, endPage - maxButtons + 1);
      }

      for (let i = startPage; i <= endPage; i++) {
        html += `<button class="btn ${i === currentPage ? 'btn-primary' : 'btn-outline-primary'} btn-sm" onclick="changePage(${i})">${i}</button>`;
      }

      // æ¬¡ã¸ãƒœã‚¿ãƒ³
      html += `<button class="btn btn-outline-primary btn-sm" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">æ¬¡ã¸ â€º</button>`;

      // ä»¶æ•°è¡¨ç¤º
      html += `<span class="text-muted small ms-2">${totalItems}ä»¶ä¸­ ${(currentPage - 1) * itemsPerPage + 1}-${Math.min(currentPage * itemsPerPage, totalItems)}ä»¶</span>`;

      paginationContainer.innerHTML = html;
    }

    // ãƒšãƒ¼ã‚¸å¤‰æ›´
    function changePage(page) {
      currentPage = page;
      renderHistoryTable(currentHistoryData);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ç¨®åˆ¥ãƒãƒƒã‚¸ç”Ÿæˆ
    function getBadgeType(type) {
      const badges = {
        'å…¥åº«': '<span class="badge bg-success badge-type">å…¥åº«</span>',
        'å‡ºåº«': '<span class="badge bg-danger badge-type">å‡ºåº«</span>',
        'èª¿æ•´': '<span class="badge bg-warning text-dark badge-type">èª¿æ•´</span>'
      };
      return badges[type] || type;
    }

    // æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatDateTime(date) {
      const d = new Date(date);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      const hours = String(d.getHours()).padStart(2, '0');
      const minutes = String(d.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªã‚»ãƒƒãƒˆ
    function resetFilters() {
      document.getElementById('filterCategory').value = '';
      document.getElementById('filterMaterial').value = '';
      document.getElementById('filterType').value = '';
      document.getElementById('filterStartDate').value = '';
      document.getElementById('filterEndDate').value = '';
      document.getElementById('filterYear').value = '';
      document.getElementById('filterMonth').value = '';
      filterMaterialsByCategory(''); // è³‡æãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
      showInitialMessage(); // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    }

    // CSVå‡ºåŠ›
    function exportToCSV() {
      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
      document.getElementById('settingsDropdown').classList.remove('show');

      if (currentHistoryData.length === 0) {
        alert('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      // CSVãƒ˜ãƒƒãƒ€ãƒ¼
      const headers = ['æ—¥æ™‚', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å', 'è³‡æå', 'ç¨®åˆ¥', 'æ•°é‡', 'ç†ç”±', 'é–¢é€£è²©å£²è¨˜éŒ²', 'å‚™è€ƒ'];

      // CSVãƒ‡ãƒ¼ã‚¿
      const rows = currentHistoryData.map(item => [
        formatDateTime(item.timestamp),
        item.operator,
        item.materialName,
        item.type,
        item.quantity,
        item.reason,
        item.relatedSalesRecord,
        item.note
      ]);

      // CSVæ–‡å­—åˆ—ç”Ÿæˆ
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
      ].join('\n');

      // BOMä»˜ãUTF-8ï¼ˆExcelå¯¾å¿œï¼‰
      const bom = '\uFEFF';
      const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });

      // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      const timestamp = getJSTToday().replace(/-/g, '');
      link.setAttribute('href', url);
      link.setAttribute('download', `å…¥å‡ºåº«å±¥æ­´_${timestamp}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);

      // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
      link.click();

      // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆé…å»¶å®Ÿè¡Œã§ãƒšãƒ¼ã‚¸é·ç§»ã‚’é˜²ãï¼‰
      setTimeout(function() {
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }, 100);
    }

    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showError(message) {
      const container = document.getElementById('historyCards');
      container.innerHTML = `<div class="text-center text-danger py-4">âŒ ${escapeHtml(message)}</div>`;
    }

    // ========================================
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
    // ========================================
    let currentTab = 'stock';
    let allOrders = [];

    function switchTab(tabName) {
      currentTab = tabName;

      // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
      document.querySelectorAll('.material-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });

      // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡æ›¿
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `tab-${tabName}`);
      });

      // ã‚¿ãƒ–å›ºæœ‰ã®åˆæœŸåŒ–
      if (tabName === 'stock') {
        loadStockList();
      } else if (tabName === 'orders') {
        loadOrdersList();
      }
    }

    // ========================================
    // Firebase/Firestoreã‚¢ã‚¯ã‚»ã‚¹
    // ========================================
    function getDb() {
      // iframeå†…ã‹ã‚‰è¦ªã®dbã‚’å‚ç…§
      return window.parent?.db || window.db;
    }

    function getFirebaseTimestamp() {
      if (window.parent?.firebase?.firestore?.FieldValue) {
        return window.parent.firebase.firestore.FieldValue.serverTimestamp();
      }
      return new Date();
    }

    // ========================================
    // åœ¨åº«ã‚¿ãƒ–æ©Ÿèƒ½
    // ========================================
    async function loadStockList() {
      const container = document.getElementById('stockList');
      container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div></div>';

      try {
        const db = getDb();
        if (!db) {
          container.innerHTML = '<div class="text-center text-danger py-4">Firestoreã«æ¥ç¶šã§ãã¾ã›ã‚“</div>';
          return;
        }

        const snapshot = await db.collection('packagingMaterials').get();
        allMaterials = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        populateStockCategoryFilter(allMaterials);
        renderStockList(allMaterials);
      } catch (error) {
        console.error('è³‡æãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        container.innerHTML = `<div class="text-center text-danger py-4">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
      }
    }

    function populateStockCategoryFilter(materials) {
      const categories = [...new Set(materials.map(m => m.category).filter(c => c))];
      const select = document.getElementById('stockCategoryFilter');
      select.innerHTML = '<option value="">å…¨ã‚«ãƒ†ã‚´ãƒª</option>' +
        categories.map(cat => `<option value="${escapeHtml(cat)}">${escapeHtml(cat)}</option>`).join('');
    }

    function renderStockList(materials) {
      const container = document.getElementById('stockList');
      const categoryFilter = document.getElementById('stockCategoryFilter').value;
      const showLowOnly = document.getElementById('showLowStockOnly').checked;

      let filtered = materials;
      if (categoryFilter) {
        filtered = filtered.filter(m => m.category === categoryFilter);
      }
      if (showLowOnly) {
        filtered = filtered.filter(m => (m.currentStock || 0) <= (m.stockAlertThreshold || 0));
      }

      if (filtered.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-4">è©²å½“ã™ã‚‹è³‡æãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      container.innerHTML = filtered.map(item => {
        const stock = item.currentStock || 0;
        const threshold = item.stockAlertThreshold || 0;
        let stockClass = 'stock-ok';
        let countClass = 'text-success';
        if (stock <= 0) {
          stockClass = 'stock-danger';
          countClass = 'text-danger';
        } else if (stock <= threshold) {
          stockClass = 'stock-warning';
          countClass = 'text-warning';
        }

        return `
        <div class="stock-card ${stockClass}">
          <div class="stock-card-header">
            <span class="stock-card-name">${escapeHtml(item.productName || item.name)}</span>
            <span class="stock-card-category">${escapeHtml(item.category || '')}</span>
          </div>
          <div class="stock-card-body">
            <div>
              <span class="stock-count ${countClass}">${stock}</span>
              <span class="text-muted small">å€‹</span>
              ${threshold > 0 ? `<span class="text-muted small ms-2">(ç™ºæ³¨ç‚¹: ${threshold})</span>` : ''}
            </div>
            <div class="stock-actions">
              <button class="btn btn-sm btn-outline-success" onclick="showStockInModalMaterial('${item.id}')">
                <i class="bi bi-plus"></i>
              </button>
              <button class="btn btn-sm btn-outline-primary" onclick="showOrderModalMaterial('${item.id}')">
                <i class="bi bi-cart-plus"></i>
              </button>
            </div>
          </div>
        </div>
        `;
      }).join('');
    }

    // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿å¤‰æ›´æ™‚
    document.getElementById('stockCategoryFilter')?.addEventListener('change', function() {
      renderStockList(allMaterials);
    });

    // è¦ç™ºæ³¨ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿å¤‰æ›´æ™‚
    document.getElementById('showLowStockOnly')?.addEventListener('change', function() {
      renderStockList(allMaterials);
    });

    // ========================================
    // å…¥åº«ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½
    // ========================================
    function showStockInModalMaterial(materialId) {
      // è³‡æãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
      const select = document.getElementById('stockInMaterial');
      select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
        allMaterials.map(m => `<option value="${m.id}" ${m.id === materialId ? 'selected' : ''}>${escapeHtml(m.productName || m.name)}</option>`).join('');

      // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('stockInQuantity').value = '';
      document.getElementById('stockInPrice').value = '';
      document.getElementById('stockInSupplier').value = '';
      document.getElementById('stockInNote').value = '';

      // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
      const modal = new bootstrap.Modal(document.getElementById('stockInModal'));
      modal.show();
    }

    async function processStockInMaterial() {
      const materialId = document.getElementById('stockInMaterial').value;
      const quantity = parseInt(document.getElementById('stockInQuantity').value) || 0;
      const price = parseFloat(document.getElementById('stockInPrice').value) || 0;
      const supplier = document.getElementById('stockInSupplier').value.trim();
      const note = document.getElementById('stockInNote').value;

      if (!materialId) {
        alert('è³‡æã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      if (quantity <= 0) {
        alert('æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const material = allMaterials.find(m => m.id === materialId);
      const materialName = material ? (material.productName || material.name) : '';
      const unitPrice = price > 0 && quantity > 0 ? Math.round(price / quantity) : 0;

      showLoading();
      bootstrap.Modal.getInstance(document.getElementById('stockInModal'))?.hide();

      try {
        const db = getDb();

        // 1. ãƒ­ãƒƒãƒˆã‚’ä½œæˆ
        const lotRef = await db.collection('packagingLots').add({
          materialId: materialId,
          quantity: quantity,
          remainingQty: quantity,
          unitPrice: unitPrice,
          purchaseDate: getFirebaseTimestamp(),
          supplier: supplier,
          notes: note,
          status: 'active',
          createdBy: window.parent?.currentUser?.name || 'unknown',
          createdAt: getFirebaseTimestamp(),
          updatedAt: getFirebaseTimestamp()
        });

        // 2. å…¥åº«å±¥æ­´ã‚’ç™»éŒ²
        await db.collection('packagingTransactions').add({
          materialId: materialId,
          materialName: materialName,
          type: 'å…¥åº«',
          quantity: quantity,
          purchasePrice: price,
          unitPrice: unitPrice,
          lotId: lotRef.id,
          supplier: supplier,
          reason: 'æ‰‹å‹•å…¥åº«',
          note: note,
          createdBy: window.parent?.currentUser?.name || 'unknown',
          createdAt: getFirebaseTimestamp()
        });

        // 3. åˆè¨ˆåœ¨åº«ã‚’è¨ˆç®—ã—ã¦materialã«åæ˜ 
        const lotsSnapshot = await db.collection('packagingLots')
          .where('materialId', '==', materialId)
          .where('status', '==', 'active')
          .get();
        const totalStock = lotsSnapshot.docs.reduce((sum, doc) => sum + (doc.data().remainingQty || 0), 0);

        await db.collection('packagingMaterials').doc(materialId).update({
          currentStock: totalStock,
          updatedAt: getFirebaseTimestamp()
        });

        hideLoading();
        alert(`å…¥åº«ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼ˆå˜ä¾¡: Â¥${unitPrice}ï¼‰`);
        loadStockList();
      } catch (error) {
        hideLoading();
        console.error('å…¥åº«ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
        alert('å…¥åº«ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ========================================
    // åœ¨åº«èª¿æ•´ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½
    // ========================================
    function showStockAdjustmentModal(materialId) {
      // è³‡æãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
      const select = document.getElementById('adjustMaterial');
      select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
        allMaterials.map(m => `<option value="${m.id}" ${m.id === materialId ? 'selected' : ''}>${escapeHtml(m.productName || m.name)} (ç¾åœ¨åº«: ${m.currentStock || 0})</option>`).join('');

      // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('adjustQuantity').value = '';
      document.getElementById('adjustReason').value = 'damaged';
      document.getElementById('adjustNote').value = '';

      // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
      const modal = new bootstrap.Modal(document.getElementById('stockAdjustmentModal'));
      modal.show();
    }

    async function processStockAdjustmentMaterial() {
      const materialId = document.getElementById('adjustMaterial').value;
      const quantity = parseInt(document.getElementById('adjustQuantity').value) || 0;
      const reason = document.getElementById('adjustReason').value;
      const note = document.getElementById('adjustNote').value;

      if (!materialId) {
        alert('è³‡æã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      if (quantity <= 0) {
        alert('æ¸›å°‘æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const material = allMaterials.find(m => m.id === materialId);
      const materialName = material ? (material.productName || material.name) : '';

      // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
      if (!confirm(`ã€Œ${materialName}ã€ã®åœ¨åº«ã‚’${quantity}å€‹æ¸›å°‘ã•ã›ã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
        return;
      }

      showLoading();
      bootstrap.Modal.getInstance(document.getElementById('stockAdjustmentModal'))?.hide();

      try {
        const db = getDb();

        // 1. LIFOæ–¹å¼ã§ãƒ­ãƒƒãƒˆã‹ã‚‰åœ¨åº«ã‚’èª¿æ•´ï¼ˆæ–°ã—ã„é †ï¼‰
        const lotsSnapshot = await db.collection('packagingLots')
          .where('materialId', '==', materialId)
          .where('status', '==', 'active')
          .orderBy('purchaseDate', 'desc')
          .get();

        let remaining = quantity;
        const adjusted = [];

        for (const doc of lotsSnapshot.docs) {
          if (remaining <= 0) break;

          const lot = doc.data();
          const toAdjust = Math.min(remaining, lot.remainingQty);
          const newRemainingQty = lot.remainingQty - toAdjust;
          const newStatus = newRemainingQty <= 0 ? 'depleted' : 'active';

          await db.collection('packagingLots').doc(doc.id).update({
            remainingQty: newRemainingQty,
            status: newStatus,
            updatedAt: getFirebaseTimestamp()
          });

          adjusted.push({
            lotId: doc.id,
            quantity: toAdjust,
            unitPrice: lot.unitPrice
          });

          remaining -= toAdjust;
        }

        // 2. èª¿æ•´å±¥æ­´ã‚’ç™»éŒ²
        const reasonLabels = {
          damaged: 'ç ´æ',
          lost: 'ç´›å¤±',
          discarded: 'å»ƒæ£„',
          other: 'ãã®ä»–'
        };

        await db.collection('packagingTransactions').add({
          materialId: materialId,
          materialName: materialName,
          type: 'èª¿æ•´',
          quantity: -quantity,
          reason: reasonLabels[reason] || reason,
          adjustedLots: adjusted,
          note: note,
          createdBy: window.parent?.currentUser?.name || 'unknown',
          createdAt: getFirebaseTimestamp()
        });

        // 3. åˆè¨ˆåœ¨åº«ã‚’è¨ˆç®—ã—ã¦materialã«åæ˜ 
        const updatedLotsSnapshot = await db.collection('packagingLots')
          .where('materialId', '==', materialId)
          .where('status', '==', 'active')
          .get();
        const totalStock = updatedLotsSnapshot.docs.reduce((sum, doc) => sum + (doc.data().remainingQty || 0), 0);

        await db.collection('packagingMaterials').doc(materialId).update({
          currentStock: totalStock,
          updatedAt: getFirebaseTimestamp()
        });

        hideLoading();
        alert(`åœ¨åº«ã‚’èª¿æ•´ã—ã¾ã—ãŸï¼ˆ-${quantity}ï¼‰`);
        loadStockList();
      } catch (error) {
        hideLoading();
        console.error('åœ¨åº«èª¿æ•´ã‚¨ãƒ©ãƒ¼:', error);
        alert('åœ¨åº«èª¿æ•´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ========================================
    // ç™ºæ³¨ã‚¿ãƒ–æ©Ÿèƒ½
    // ========================================
    async function loadOrdersList() {
      const container = document.getElementById('ordersList');
      container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div></div>';

      try {
        const db = getDb();
        if (!db) {
          container.innerHTML = '<div class="text-center text-danger py-4">Firestoreã«æ¥ç¶šã§ãã¾ã›ã‚“</div>';
          return;
        }

        const snapshot = await db.collection('packagingOrders')
          .orderBy('orderedAt', 'desc')
          .limit(50)
          .get();

        allOrders = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data(),
          orderedAt: doc.data().orderedAt?.toDate?.() || doc.data().orderedAt
        }));

        renderOrdersList();
      } catch (error) {
        console.error('ç™ºæ³¨ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        container.innerHTML = `<div class="text-center text-danger py-4">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
      }
    }

    function renderOrdersList() {
      const container = document.getElementById('ordersList');
      const statusFilter = document.getElementById('orderStatusFilter').value;

      let filtered = allOrders;
      if (statusFilter) {
        filtered = filtered.filter(o => o.status === statusFilter);
      }

      if (filtered.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-4">è©²å½“ã™ã‚‹ç™ºæ³¨ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      container.innerHTML = filtered.map(order => {
        const statusBadge = order.status === 'ordered' ? '<span class="badge bg-warning">ç™ºæ³¨ä¸­</span>'
          : order.status === 'received' ? '<span class="badge bg-success">å…¥è·æ¸ˆã¿</span>'
          : order.status === 'cancelled' ? '<span class="badge bg-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>'
          : '<span class="badge bg-light text-dark">' + escapeHtml(order.status) + '</span>';

        const cardClass = order.status === 'ordered' ? 'order-pending'
          : order.status === 'received' ? 'order-received'
          : '';

        return `
        <div class="order-card ${cardClass}">
          <div class="order-card-header">
            <span class="order-card-date">${formatDateTime(order.orderedAt || order.createdAt)}</span>
            ${statusBadge}
          </div>
          <div class="order-card-body">
            <div>
              <div class="order-material">${escapeHtml(order.materialName)}</div>
              ${order.supplier ? `<div class="text-muted small">${escapeHtml(order.supplier)}</div>` : ''}
            </div>
            <div class="order-quantity">${order.quantity}å€‹</div>
          </div>
          ${order.status === 'ordered' ? `
          <div class="mt-2 d-flex gap-2 justify-content-end">
            <button class="btn btn-sm btn-success" onclick="showReceiveModal('${order.id}')">
              <i class="bi bi-check"></i> å…¥è·
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="cancelOrderMaterial('${order.id}')">
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
          </div>
          ` : ''}
        </div>
        `;
      }).join('');
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿å¤‰æ›´æ™‚
    document.getElementById('orderStatusFilter')?.addEventListener('change', function() {
      renderOrdersList();
    });

    // ========================================
    // ç™ºæ³¨ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½
    // ========================================
    async function showOrderModalMaterial(materialId) {
      // è³‡æãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯å…ˆã«èª­ã¿è¾¼ã‚€
      if (allMaterials.length === 0) {
        try {
          const db = getDb();
          const snapshot = await db.collection('packagingMaterials').get();
          allMaterials = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
        } catch (error) {
          console.error('è³‡æãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        }
      }
      populateOrderMaterialSelect(materialId);
    }

    function populateOrderMaterialSelect(materialId) {
      const select = document.getElementById('orderMaterial');
      select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
        allMaterials.map(m => `<option value="${m.id}" ${m.id === materialId ? 'selected' : ''}>${escapeHtml(m.productName || m.name)}</option>`).join('');

      // é¸æŠã•ã‚ŒãŸè³‡æã®ç™ºæ³¨å…ˆã‚’è‡ªå‹•å…¥åŠ›
      if (materialId) {
        const material = allMaterials.find(m => m.id === materialId);
        if (material && material.supplier) {
          document.getElementById('orderSupplier').value = material.supplier;
        }
      }

      // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('orderQuantity').value = '';
      document.getElementById('orderNote').value = '';

      // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
      const modal = new bootstrap.Modal(document.getElementById('orderModal'));
      modal.show();
    }

    async function processOrderMaterial() {
      const materialId = document.getElementById('orderMaterial').value;
      const quantity = parseInt(document.getElementById('orderQuantity').value) || 0;
      const supplier = document.getElementById('orderSupplier').value;
      const note = document.getElementById('orderNote').value;

      if (!materialId) {
        alert('è³‡æã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      if (quantity <= 0) {
        alert('æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const material = allMaterials.find(m => m.id === materialId);
      const materialName = material ? (material.productName || material.name) : '';

      showLoading();
      bootstrap.Modal.getInstance(document.getElementById('orderModal'))?.hide();

      try {
        const db = getDb();

        await db.collection('packagingOrders').add({
          materialId: materialId,
          materialName: materialName,
          quantity: quantity,
          supplier: supplier,
          note: note,
          status: 'ordered',
          orderedAt: getFirebaseTimestamp(),
          createdBy: window.parent?.currentUser?.name || 'unknown'
        });

        hideLoading();
        alert('ç™ºæ³¨ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
        loadOrdersList();
      } catch (error) {
        hideLoading();
        console.error('ç™ºæ³¨ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
        alert('ç™ºæ³¨ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ========================================
    // å…¥è·å‡¦ç†ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½
    // ========================================
    function showReceiveModal(orderId) {
      const order = allOrders.find(o => o.id === orderId);
      if (!order) {
        alert('ç™ºæ³¨ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      document.getElementById('receiveOrderId').value = orderId;
      document.getElementById('receiveMaterialId').value = order.materialId;
      document.getElementById('receiveMaterialName').value = order.materialName;
      document.getElementById('receiveOrderedQuantity').value = order.quantity;
      document.getElementById('receiveActualQuantity').value = order.quantity;
      document.getElementById('receivePrice').value = '';

      const modal = new bootstrap.Modal(document.getElementById('receiveModal'));
      modal.show();
    }

    async function processReceiveOrderMaterial() {
      const orderId = document.getElementById('receiveOrderId').value;
      const materialId = document.getElementById('receiveMaterialId').value;
      const materialName = document.getElementById('receiveMaterialName').value;
      const actualQuantity = parseInt(document.getElementById('receiveActualQuantity').value) || 0;
      const price = parseFloat(document.getElementById('receivePrice').value) || 0;

      if (actualQuantity <= 0) {
        alert('å…¥è·æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      showLoading();
      bootstrap.Modal.getInstance(document.getElementById('receiveModal'))?.hide();

      try {
        const db = getDb();

        // 1. ç™ºæ³¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
        await db.collection('packagingOrders').doc(orderId).update({
          status: 'received',
          receivedAt: getFirebaseTimestamp()
        });

        // 2. å…¥åº«å±¥æ­´ã‚’ç™»éŒ²
        await db.collection('packagingTransactions').add({
          materialId: materialId,
          materialName: materialName,
          type: 'å…¥åº«',
          quantity: actualQuantity,
          purchasePrice: price,
          unitCost: price > 0 && actualQuantity > 0 ? price / actualQuantity : 0,
          reason: 'ç™ºæ³¨å…¥è·',
          orderId: orderId,
          createdBy: window.parent?.currentUser?.name || 'unknown',
          createdAt: getFirebaseTimestamp()
        });

        // 3. åœ¨åº«æ•°ã‚’æ›´æ–°
        const materialRef = db.collection('packagingMaterials').doc(materialId);
        const materialDoc = await materialRef.get();
        const currentStock = materialDoc.exists ? (materialDoc.data().currentStock || 0) : 0;
        await materialRef.update({
          currentStock: currentStock + actualQuantity,
          updatedAt: getFirebaseTimestamp()
        });

        hideLoading();
        alert('å…¥è·å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ');
        loadOrdersList();
        if (currentTab === 'stock') {
          loadStockList();
        }
      } catch (error) {
        hideLoading();
        console.error('å…¥è·å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        alert('å…¥è·å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    async function cancelOrderMaterial(orderId) {
      if (!confirm('ã“ã®ç™ºæ³¨ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      showLoading();

      try {
        const db = getDb();
        await db.collection('packagingOrders').doc(orderId).update({
          status: 'cancelled'
        });

        hideLoading();
        alert('ç™ºæ³¨ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
        loadOrdersList();
      } catch (error) {
        hideLoading();
        console.error('ç™ºæ³¨ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ========================================
    // åˆæœŸåŒ–æ™‚ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ–ã‚’èª­ã¿è¾¼ã‚€
    // ========================================
    document.addEventListener('DOMContentLoaded', function() {
      // åœ¨åº«ã‚¿ãƒ–ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§èª­ã¿è¾¼ã‚€
      loadStockList();
    });
  </script>

  <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³å‡¦ç† -->
<script>
  console.log('[inventory_history_viewer] âœ… Script loaded - Version @899-debug');
  
  async function goBack() {
    console.log('[inventory_history_viewer] >>> goBack() called at', new Date().toISOString());
    const isInIframe = window.self !== window.top;
    console.log('[inventory_history_viewer] isInIframe:', isInIframe);
    
    if (isInIframe) {
      console.log('[inventory_history_viewer] iframeå†…ã§é–‹ã‹ã‚Œã¦ã„ã‚‹ãŸã‚ã€postMessageé€ä¿¡');
      window.top.postMessage({ type: 'navigateToHome' }, '*');
      console.log('[inventory_history_viewer] âœ… postMessageé€ä¿¡å®Œäº†');
    } else {
      console.log('[inventory_history_viewer] ç›´æ¥é–‹ã‹ã‚Œã¦ã„ã‚‹ãŸã‚ã€google.script.host.close()');
      google.script.host.close();
    }
  }
  
  // ãƒŸãƒ‹ãƒãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼: æˆ»ã‚‹ãƒœã‚¿ãƒ³ã¯å»ƒæ­¢ã€ãƒ­ã‚´ã‚¿ãƒƒãƒ—ã§ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
</script>

</body>
</html>
