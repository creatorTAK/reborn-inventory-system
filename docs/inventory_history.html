<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://www.reborn-inventory.com/css/reborn-brand-colors.css?v=0bd1a9b">
  <link rel="stylesheet" href="/css/reborn-theme.css?v=296">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      padding: 0;
      background-color: #f8f9fa;
      margin: 0;
    }

    /* PCç‰ˆï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ã®ã¿é€æ˜èƒŒæ™¯ */
    @media (min-width: 768px) {
      body {
        background-color: transparent;
      }
    }

    .container-fluid {
      padding: 12px; /* ã‚¹ãƒãƒ›ç‰ˆ: å°‘ã—ä½™ç™½ */
    }

    /* PCç‰ˆ: ä½™ç™½æœ€å° */
    @media (min-width: 768px) {
      .container-fluid {
        padding: 8px;
      }
    }

    .filter-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      border: 1px solid #e9ecef;
    }
    .filter-section .form-label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 6px;
    }
    .filter-section .form-select,
    .filter-section .form-control {
      border: 1px solid #ced4da;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      transition: all 0.2s ease;
    }
    .filter-section .form-select:focus,
    .filter-section .form-control:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    .filter-section .btn-primary {
      padding: 10px 24px;
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(37, 99, 235, 0.3);
      transition: all 0.2s ease;
    }
    .filter-section .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }
    .history-card {
      background: white;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      border-left: 4px solid #e9ecef;
      transition: box-shadow 0.2s ease;
    }
    .history-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .history-card.card-inbound {
      border-left-color: #10b981;
    }
    .history-card.card-outbound {
      border-left-color: #ef4444;
    }
    .history-card.card-adjustment {
      border-left-color: #f59e0b;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e9ecef;
    }
    .card-date {
      font-size: 0.85rem;
      color: #6c757d;
    }
    .card-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .card-material {
      font-weight: 600;
      font-size: 1rem;
      color: #212529;
    }
    .card-quantity {
      font-size: 1.25rem;
      font-weight: 700;
      color: #212529;
    }
    .card-details {
      font-size: 0.85rem;
      color: #6c757d;
    }
    .card-detail-row {
      margin-top: 4px;
    }
    .card-detail-row.price-info {
      color: #059669;
      font-weight: 600;
    }
    .table thead th {
      background-color: #f59e0b;
      color: white;
      font-weight: 600;
      border: none;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .table tbody tr:hover {
      background-color: #f8f9fa;
    }
    .badge-type {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .spinner-border {
      width: 3rem;
      height: 3rem;
    }
    .table-container {
      max-height: 500px;
      overflow-y: auto;
      overflow-x: auto;
    }
    .table {
      font-size: 0.85rem;
      white-space: nowrap;
    }
    .table th {
      font-size: 0.75rem;
      padding: 8px 4px;
    }
    .table td {
      padding: 6px 4px;
    }
    .export-section {
      background: white;
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- çµ±ä¸€ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <div class="header-content">
      <button class="back-button" id="back-button">
        <i class="bi bi-chevron-left"></i>
      </button>
      <div class="header-title">
        <i class="bi bi-clock-history"></i>
        å…¥å‡ºåº«å±¥æ­´
      </div>
      <button class="menu-button" onclick="window.parent.postMessage({type:'toggleDrawer'}, '*')" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
        <i class="bi bi-list"></i>
      </button>
    </div>
  </div>

  <div class="container-fluid">

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="filter-section">
      <!-- Row 1: ã‚«ãƒ†ã‚´ãƒª | è³‡æå -->
      <div class="row g-2 mb-2">
        <div class="col-6 col-md-2">
          <label for="filterCategory" class="form-label small mb-1">ã‚«ãƒ†ã‚´ãƒª</label>
          <select class="form-select form-select-sm" id="filterCategory">
            <option value="">å…¨ã¦</option>
          </select>
        </div>
        <div class="col-6 col-md-3">
          <label for="filterMaterial" class="form-label small mb-1">è³‡æå</label>
          <select class="form-select form-select-sm" id="filterMaterial">
            <option value="">å…¨ã¦</option>
          </select>
        </div>
      </div>

      <!-- Row 2: ç¨®åˆ¥ -->
      <div class="row g-2 mb-2">
        <div class="col-6 col-md-2">
          <label for="filterType" class="form-label small mb-1">ç¨®åˆ¥</label>
          <select class="form-select form-select-sm" id="filterType">
            <option value="">å…¨ã¦</option>
            <option value="å…¥åº«">å…¥åº«</option>
            <option value="å‡ºåº«">å‡ºåº«</option>
            <option value="èª¿æ•´">èª¿æ•´</option>
          </select>
        </div>
      </div>

      <!-- Row 3: æœŸé–“ã‚¯ã‚¤ãƒƒã‚¯é¸æŠ -->
      <div class="row g-2 mb-1">
        <div class="col-12">
          <label class="form-label small mb-1 text-muted">ğŸ“… æœŸé–“ã‚¯ã‚¤ãƒƒã‚¯é¸æŠ</label>
        </div>
        <div class="col-12">
          <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm flex-fill" id="btnAllPeriod">å…¨æœŸé–“</button>
            <button class="btn btn-outline-primary btn-sm flex-fill" id="btnThisMonth">ä»Šæœˆ</button>
            <button class="btn btn-outline-primary btn-sm flex-fill" id="btnLastMonth">å…ˆæœˆ</button>
          </div>
        </div>
      </div>
      <div class="row g-2 mb-2">
        <div class="col-12">
          <div class="d-flex gap-2">
            <select class="form-select form-select-sm flex-fill" id="filterYear">
              <option value="">å¹´é¸æŠ</option>
            </select>
            <select class="form-select form-select-sm flex-fill" id="filterMonth">
              <option value="">æœˆé¸æŠ</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Row 4: é–‹å§‹æ—¥ | çµ‚äº†æ—¥ -->
      <div class="row g-2 mb-2">
        <div class="col-6 col-md-2">
          <label for="filterStartDate" class="form-label small mb-1">é–‹å§‹æ—¥</label>
          <input type="date" class="form-control form-control-sm" id="filterStartDate">
        </div>
        <div class="col-6 col-md-2">
          <label for="filterEndDate" class="form-label small mb-1">çµ‚äº†æ—¥</label>
          <input type="date" class="form-control form-control-sm" id="filterEndDate">
        </div>
      </div>

      <!-- Row 5: æ¤œç´¢ãƒœã‚¿ãƒ³ -->
      <div class="row g-2 mb-2">
        <div class="col-12 col-md-3">
          <button class="btn btn-primary btn-sm w-100" id="btnSearch">ğŸ” æ¤œç´¢</button>
        </div>
      </div>

      <!-- ãƒªã‚»ãƒƒãƒˆãƒ»ä»¶æ•°è¡¨ç¤º -->
      <div class="row mt-2">
        <div class="col-12">
          <button class="btn btn-outline-secondary btn-sm" id="btnReset">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
          <span class="ms-3 text-muted small" id="resultCount"></span>
        </div>
      </div>
    </div>

    <!-- å±¥æ­´ã‚«ãƒ¼ãƒ‰ä¸€è¦§ -->
    <div id="historyCards"></div>

    <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div id="pagination" class="d-flex justify-content-center align-items-center gap-2 my-3" style="display: none !important;"></div>

    <!-- CSVå‡ºåŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="export-section">
      <button class="btn btn-success btn-sm" id="btnExportCSV">ğŸ“¥ CSVå‡ºåŠ›</button>
      <div class="text-muted small mt-2">ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çµæœã‚’CSVå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentHistoryData = [];
    let allMaterials = []; // å…¨è³‡æãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
    let currentPage = 1;
    const itemsPerPage = 10;

    // æ—¥æœ¬æ™‚é–“ã§ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆYYYY-MM-DDå½¢å¼ï¼‰
    function getJSTToday() {
      const now = new Date();
      const jst = new Date(now.getTime() + (9 * 60 + now.getTimezoneOffset()) * 60000);
      const year = jst.getFullYear();
      const month = String(jst.getMonth() + 1).padStart(2, '0');
      const day = String(jst.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸš€ inventory_history_viewer.html ãƒãƒ¼ã‚¸ãƒ§ãƒ³: @451-PAGINATION-10');
      console.log('ğŸ”§ APIé–¢æ•°å: getInventoryHistoryAPI (Wrapperãªã— - ç›´æ¥å‘¼ã³å‡ºã—)');
      console.log('ğŸ”§ APIé–¢æ•°å2: getPackagingMaterialsAPI (Wrapperãªã— - ç›´æ¥å‘¼ã³å‡ºã—)');

      initializePeriodFilters();
      loadMaterialsList();
      showInitialMessage(); // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      document.getElementById('filterCategory').addEventListener('change', function() {
        filterMaterialsByCategory(this.value);
      });
      document.getElementById('btnAllPeriod').addEventListener('click', setAllPeriod);
      document.getElementById('btnThisMonth').addEventListener('click', setThisMonth);
      document.getElementById('btnLastMonth').addEventListener('click', setLastMonth);
      document.getElementById('filterYear').addEventListener('change', updatePeriodFromYearMonth);
      document.getElementById('filterMonth').addEventListener('change', updatePeriodFromYearMonth);
      document.getElementById('btnSearch').addEventListener('click', loadHistoryData);
      document.getElementById('btnReset').addEventListener('click', resetFilters);
      document.getElementById('btnExportCSV').addEventListener('click', exportToCSV);
    });

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º/éè¡¨ç¤º
    function showLoading() {
      document.getElementById('loadingOverlay').style.display = 'flex';
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }

    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showInitialMessage() {
      const container = document.getElementById('historyCards');
      container.innerHTML = `
        <div class="text-center text-muted py-5" style="font-size: 1rem;">
          <div>æ¤œç´¢æ¡ä»¶ã‚’é¸æŠã—ã¦æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</div>
        </div>
      `;
      document.getElementById('resultCount').textContent = '';
    }

    // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ã®åˆæœŸåŒ–
    function initializePeriodFilters() {
      const currentYear = new Date().getFullYear();
      const yearSelect = document.getElementById('filterYear');

      // 2020å¹´ã‹ã‚‰ç¾åœ¨å¹´ã¾ã§ï¼ˆé™é †ï¼‰
      for (let year = currentYear; year >= 2020; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = `${year}å¹´`;
        yearSelect.appendChild(option);
      }

      // 1æœˆã€œ12æœˆã®å›ºå®šãƒªã‚¹ãƒˆ
      const monthSelect = document.getElementById('filterMonth');
      for (let month = 1; month <= 12; month++) {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = `${month}æœˆ`;
        monthSelect.appendChild(option);
      }
    }

    // å…¨æœŸé–“ã‚’è¨­å®š
    function setAllPeriod() {
      document.getElementById('filterStartDate').value = '';
      document.getElementById('filterEndDate').value = '';
      document.getElementById('filterYear').value = '';
      document.getElementById('filterMonth').value = '';
    }

    // ä»Šæœˆã‚’è¨­å®š
    function setThisMonth() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const firstDay = `${year}-${month}-01`;
      const lastDay = new Date(year, now.getMonth() + 1, 0);
      const lastDayStr = `${year}-${month}-${String(lastDay.getDate()).padStart(2, '0')}`;

      document.getElementById('filterStartDate').value = firstDay;
      document.getElementById('filterEndDate').value = lastDayStr;
      document.getElementById('filterYear').value = '';
      document.getElementById('filterMonth').value = '';
    }

    // å…ˆæœˆã‚’è¨­å®š
    function setLastMonth() {
      const now = new Date();
      const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      const year = lastMonth.getFullYear();
      const month = String(lastMonth.getMonth() + 1).padStart(2, '0');
      const firstDay = `${year}-${month}-01`;
      const lastDay = new Date(year, lastMonth.getMonth() + 1, 0);
      const lastDayStr = `${year}-${month}-${String(lastDay.getDate()).padStart(2, '0')}`;

      document.getElementById('filterStartDate').value = firstDay;
      document.getElementById('filterEndDate').value = lastDayStr;
      document.getElementById('filterYear').value = '';
      document.getElementById('filterMonth').value = '';
    }

    // å¹´ã¾ãŸã¯æœˆã®é¸æŠå¤‰æ›´æ™‚ã«æœŸé–“ã‚’è¨­å®š
    function updatePeriodFromYearMonth() {
      const year = document.getElementById('filterYear').value;
      const month = document.getElementById('filterMonth').value;

      if (year && month) {
        // å¹´ãƒ»æœˆä¸¡æ–¹é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
        const lastDay = new Date(year, month, 0).getDate();
        document.getElementById('filterStartDate').value = `${year}-${String(month).padStart(2, '0')}-01`;
        document.getElementById('filterEndDate').value = `${year}-${String(month).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`;
      } else if (year && !month) {
        // å¹´ã®ã¿é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
        document.getElementById('filterStartDate').value = `${year}-01-01`;
        document.getElementById('filterEndDate').value = `${year}-12-31`;
      } else {
        // ãã‚Œä»¥å¤–ã¯ã‚¯ãƒªã‚¢
        document.getElementById('filterStartDate').value = '';
        document.getElementById('filterEndDate').value = '';
      }
    }

    // è³‡æãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿
    function loadMaterialsList() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (!result) {
            console.error('è³‡æãƒªã‚¹ãƒˆAPIã‹ã‚‰å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            return;
          }

          if (result.success) {
            allMaterials = result.data;

            // ã‚«ãƒ†ã‚´ãƒªã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒªã‚¹ãƒˆã‚’å–å¾—
            const categories = [...new Set(result.data.map(m => m.category).filter(c => c))];
            const categorySelect = document.getElementById('filterCategory');
            categorySelect.innerHTML = '<option value="">å…¨ã¦</option>';

            categories.forEach(cat => {
              const option = document.createElement('option');
              option.value = cat;
              option.textContent = cat;
              categorySelect.appendChild(option);
            });

            // åˆæœŸè¡¨ç¤º: å…¨è³‡æã‚’è¡¨ç¤º
            filterMaterialsByCategory('');
          }
        })
        .withFailureHandler(function(error) {
          console.error('è³‡æãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getPackagingMaterialsAPI();
    }

    // ã‚«ãƒ†ã‚´ãƒªé¸æŠã«ã‚ˆã‚‹è³‡æãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    function filterMaterialsByCategory(category) {
      const materialSelect = document.getElementById('filterMaterial');
      materialSelect.innerHTML = '<option value="">å…¨ã¦</option>';

      const filtered = category ? allMaterials.filter(m => m.category === category) : allMaterials;

      filtered.forEach(material => {
        const option = document.createElement('option');
        option.value = material.productName;
        option.textContent = material.productName;
        materialSelect.appendChild(option);
      });
    }

    // å±¥æ­´ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    function loadHistoryData() {
      showLoading();

      const params = {
        materialName: document.getElementById('filterMaterial').value || undefined,
        type: document.getElementById('filterType').value || undefined,
        startDate: document.getElementById('filterStartDate').value || undefined,
        endDate: document.getElementById('filterEndDate').value || undefined,
        limit: 1000
      };

      // undefinedã®ã‚­ãƒ¼ã‚’å‰Šé™¤
      Object.keys(params).forEach(key => params[key] === undefined && delete params[key]);

      console.log('APIå‘¼ã³å‡ºã—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:', params);

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          console.log('âœ… Success handler called');
          console.log('Result:', result);
          console.log('Result type:', typeof result);
          
          if (!result) {
            showError('APIã‹ã‚‰å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å…¥å‡ºåº«å±¥æ­´ã‚·ãƒ¼ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            return;
          }

          if (result.success) {
            currentHistoryData = result.data;
            currentPage = 1; // æ¤œç´¢çµæœã¯å¸¸ã«1ãƒšãƒ¼ã‚¸ç›®ã‹ã‚‰è¡¨ç¤º
            renderHistoryTable(result.data);
            document.getElementById('resultCount').textContent = `${result.data.length}ä»¶`;
          } else {
            showError(result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error('âŒ Failure handler called');
          console.error('Error object:', error);
          console.error('Error message:', error.message);
          showError('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .getInventoryHistoryAPI(params);
    }

    // å±¥æ­´ã‚«ãƒ¼ãƒ‰æç”»ï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
    function renderHistoryTable(data) {
      const container = document.getElementById('historyCards');
      const paginationContainer = document.getElementById('pagination');

      if (data.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-4">è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        paginationContainer.style.display = 'none';
        return;
      }

      // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç®—
      const totalPages = Math.ceil(data.length / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageData = data.slice(startIndex, endIndex);

      // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
      container.innerHTML = pageData.map(item => {
        // ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ã‚¯ãƒ©ã‚¹ã‚’æ±ºå®š
        let cardTypeClass = '';
        if (item.type === 'å…¥åº«') cardTypeClass = 'card-inbound';
        else if (item.type === 'å‡ºåº«') cardTypeClass = 'card-outbound';
        else if (item.type === 'èª¿æ•´') cardTypeClass = 'card-adjustment';

        return `
        <div class="history-card ${cardTypeClass}">
          <div class="card-header">
            <span class="card-date">${formatDateTime(item.timestamp)}</span>
            ${getBadgeType(item.type)}
          </div>
          <div class="card-main">
            <div class="card-material">${escapeHtml(item.materialName)}</div>
            <div class="card-quantity">${item.quantity.toLocaleString()}å€‹</div>
          </div>
          <div class="card-details">${item.type === 'å…¥åº«' ? `<div style="display:flex;gap:12px;margin-top:8px;padding-top:8px;border-top:1px solid #f0f0f0;"><div style="flex:1;">${item.purchasePrice ? `<div class="card-detail-row price-info">è³¼å…¥ä¾¡æ ¼: Â¥${item.purchasePrice.toLocaleString()}</div>` : ''}${item.packageQuantity ? `<div class="card-detail-row price-info">è³¼å…¥å€‹æ•°: ${item.packageQuantity.toLocaleString()}å€‹</div>` : ''}${item.unitCost ? `<div class="card-detail-row price-info">å˜ä¾¡: Â¥${item.unitCost.toFixed(2)}</div>` : ''}</div><div style="flex:1;">${item.reason ? `<div class="card-detail-row">ç†ç”±: ${escapeHtml(item.reason)}</div>` : ''}${item.operator ? `<div class="card-detail-row">ãƒ¦ãƒ¼ã‚¶ãƒ¼å: ${escapeHtml(item.operator)}</div>` : ''}${item.relatedSalesRecord ? `<div class="card-detail-row">è²©å£²è¨˜éŒ²: ${escapeHtml(item.relatedSalesRecord)}</div>` : ''}${item.note ? `<div class="card-detail-row">å‚™è€ƒ: ${escapeHtml(item.note)}</div>` : ''}</div></div>` : `${item.reason ? `<div class="card-detail-row" style="margin-top:8px;padding-top:8px;border-top:1px solid #f0f0f0;">ç†ç”±: ${escapeHtml(item.reason)}</div>` : ''}${item.operator ? `<div class="card-detail-row">ãƒ¦ãƒ¼ã‚¶ãƒ¼å: ${escapeHtml(item.operator)}</div>` : ''}${item.relatedSalesRecord ? `<div class="card-detail-row">è²©å£²è¨˜éŒ²: ${escapeHtml(item.relatedSalesRecord)}</div>` : ''}${item.note ? `<div class="card-detail-row">å‚™è€ƒ: ${escapeHtml(item.note)}</div>` : ''}`}</div>
        </div>
      `;}).join('');

      // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³UIç”Ÿæˆ
      renderPagination(totalPages, data.length);
    }

    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³UIç”Ÿæˆ
    function renderPagination(totalPages, totalItems) {
      const paginationContainer = document.getElementById('pagination');

      if (totalPages <= 1) {
        paginationContainer.style.display = 'none';
        return;
      }

      paginationContainer.style.display = 'flex';

      let html = '';

      // å‰ã¸ãƒœã‚¿ãƒ³
      html += `<button class="btn btn-outline-primary btn-sm" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">â€¹ å‰ã¸</button>`;

      // ãƒšãƒ¼ã‚¸ç•ªå·ãƒœã‚¿ãƒ³
      const maxButtons = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
      let endPage = Math.min(totalPages, startPage + maxButtons - 1);

      if (endPage - startPage < maxButtons - 1) {
        startPage = Math.max(1, endPage - maxButtons + 1);
      }

      for (let i = startPage; i <= endPage; i++) {
        html += `<button class="btn ${i === currentPage ? 'btn-primary' : 'btn-outline-primary'} btn-sm" onclick="changePage(${i})">${i}</button>`;
      }

      // æ¬¡ã¸ãƒœã‚¿ãƒ³
      html += `<button class="btn btn-outline-primary btn-sm" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">æ¬¡ã¸ â€º</button>`;

      // ä»¶æ•°è¡¨ç¤º
      html += `<span class="text-muted small ms-2">${totalItems}ä»¶ä¸­ ${(currentPage - 1) * itemsPerPage + 1}-${Math.min(currentPage * itemsPerPage, totalItems)}ä»¶</span>`;

      paginationContainer.innerHTML = html;
    }

    // ãƒšãƒ¼ã‚¸å¤‰æ›´
    function changePage(page) {
      currentPage = page;
      renderHistoryTable(currentHistoryData);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ç¨®åˆ¥ãƒãƒƒã‚¸ç”Ÿæˆ
    function getBadgeType(type) {
      const badges = {
        'å…¥åº«': '<span class="badge bg-success badge-type">å…¥åº«</span>',
        'å‡ºåº«': '<span class="badge bg-danger badge-type">å‡ºåº«</span>',
        'èª¿æ•´': '<span class="badge bg-warning text-dark badge-type">èª¿æ•´</span>'
      };
      return badges[type] || type;
    }

    // æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatDateTime(date) {
      const d = new Date(date);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      const hours = String(d.getHours()).padStart(2, '0');
      const minutes = String(d.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªã‚»ãƒƒãƒˆ
    function resetFilters() {
      document.getElementById('filterCategory').value = '';
      document.getElementById('filterMaterial').value = '';
      document.getElementById('filterType').value = '';
      document.getElementById('filterStartDate').value = '';
      document.getElementById('filterEndDate').value = '';
      document.getElementById('filterYear').value = '';
      document.getElementById('filterMonth').value = '';
      filterMaterialsByCategory(''); // è³‡æãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
      showInitialMessage(); // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    }

    // CSVå‡ºåŠ›
    function exportToCSV() {
      if (currentHistoryData.length === 0) {
        alert('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      // CSVãƒ˜ãƒƒãƒ€ãƒ¼
      const headers = ['æ—¥æ™‚', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å', 'è³‡æå', 'ç¨®åˆ¥', 'æ•°é‡', 'ç†ç”±', 'é–¢é€£è²©å£²è¨˜éŒ²', 'å‚™è€ƒ'];

      // CSVãƒ‡ãƒ¼ã‚¿
      const rows = currentHistoryData.map(item => [
        formatDateTime(item.timestamp),
        item.operator,
        item.materialName,
        item.type,
        item.quantity,
        item.reason,
        item.relatedSalesRecord,
        item.note
      ]);

      // CSVæ–‡å­—åˆ—ç”Ÿæˆ
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
      ].join('\n');

      // BOMä»˜ãUTF-8ï¼ˆExcelå¯¾å¿œï¼‰
      const bom = '\uFEFF';
      const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });

      // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      const timestamp = getJSTToday().replace(/-/g, '');
      link.setAttribute('href', url);
      link.setAttribute('download', `å…¥å‡ºåº«å±¥æ­´_${timestamp}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);

      // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
      link.click();

      // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆé…å»¶å®Ÿè¡Œã§ãƒšãƒ¼ã‚¸é·ç§»ã‚’é˜²ãï¼‰
      setTimeout(function() {
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }, 100);
    }

    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showError(message) {
      const container = document.getElementById('historyCards');
      container.innerHTML = `<div class="text-center text-danger py-4">âŒ ${escapeHtml(message)}</div>`;
    }
  </script>

  <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³å‡¦ç† -->
<script>
  console.log('[inventory_history_viewer] âœ… Script loaded - Version @899-debug');
  
  async function goBack() {
    console.log('[inventory_history_viewer] >>> goBack() called at', new Date().toISOString());
    const isInIframe = window.self !== window.top;
    console.log('[inventory_history_viewer] isInIframe:', isInIframe);
    
    if (isInIframe) {
      console.log('[inventory_history_viewer] iframeå†…ã§é–‹ã‹ã‚Œã¦ã„ã‚‹ãŸã‚ã€postMessageé€ä¿¡');
      window.top.postMessage({ type: 'navigateToHome' }, '*');
      console.log('[inventory_history_viewer] âœ… postMessageé€ä¿¡å®Œäº†');
    } else {
      console.log('[inventory_history_viewer] ç›´æ¥é–‹ã‹ã‚Œã¦ã„ã‚‹ãŸã‚ã€google.script.host.close()');
      google.script.host.close();
    }
  }
  
  document.addEventListener('DOMContentLoaded', () => {
    console.log('[inventory_history_viewer] DOMContentLoaded fired');
    const backButton = document.getElementById('back-button');
    console.log('[inventory_history_viewer] backButton element:', backButton);
    
    if (backButton) {
      backButton.addEventListener('click', goBack);
      console.log('[inventory_history_viewer] âœ… æˆ»ã‚‹ãƒœã‚¿ãƒ³ã«goBack()ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ');
    } else {
      console.error('[inventory_history_viewer] âŒ æˆ»ã‚‹ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
  });
</script>

</body>
</html>
