<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å•†å“å±æ€§ã‚«ãƒ†ã‚´ãƒªåˆæœŸåŒ– - REBORN</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f5f6fa;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }

    h1 {
      font-size: 24px;
      margin-bottom: 16px;
      color: #333;
    }

    .description {
      color: #666;
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .status {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .status-item:last-child {
      border-bottom: none;
    }

    .status-label {
      font-weight: 600;
      color: #333;
    }

    .status-value {
      color: #666;
    }

    .btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 12px;
    }

    .btn-primary {
      background: #4facfe;
      color: white;
    }

    .btn-primary:hover {
      background: #3a9ae6;
    }

    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #e0e0e0;
      color: #666;
    }

    .btn-secondary:hover {
      background: #d0d0d0;
    }

    .log {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 16px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.6;
      margin-top: 24px;
      display: none;
    }

    .log.show {
      display: block;
    }

    .log-entry {
      margin-bottom: 4px;
    }

    .log-success {
      color: #27ae60;
    }

    .log-error {
      color: #e74c3c;
    }

    .log-info {
      color: #3498db;
    }

    .warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
      color: #856404;
    }

    .warning strong {
      display: block;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ·ï¸ å•†å“å±æ€§ã‚«ãƒ†ã‚´ãƒªåˆæœŸåŒ–</h1>
    
    <div class="description">
      ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€å•†å“å±æ€§ã‚«ãƒ†ã‚´ãƒªã®18ç¨®é¡ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã«æŠ•å…¥ã—ã¾ã™ã€‚
      <br><br>
      åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ™‚ã«1åº¦ã ã‘å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
    </div>

    <div class="warning">
      <strong>âš ï¸ æ³¨æ„</strong>
      æ—¢ã«ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯é‡è¤‡æŠ•å…¥ã•ã‚Œã¾ã›ã‚“ã€‚
      æŠ•å…¥æ¸ˆã¿ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã£ãŸå¾Œã€å¿…è¦ãªå ´åˆã®ã¿ãƒ‡ãƒ¼ã‚¿ãŒè¿½åŠ ã•ã‚Œã¾ã™ã€‚
    </div>

    <div class="status">
      <div class="status-item">
        <span class="status-label">æŠ•å…¥å¯¾è±¡ã‚«ãƒ†ã‚´ãƒªæ•°:</span>
        <span class="status-value" id="totalCount">18ä»¶</span>
      </div>
      <div class="status-item">
        <span class="status-label">ç¾åœ¨ã®ç™»éŒ²æ•°:</span>
        <span class="status-value" id="existingCount">ç¢ºèªä¸­...</span>
      </div>
      <div class="status-item">
        <span class="status-label">æŠ•å…¥äºˆå®š:</span>
        <span class="status-value" id="toInsertCount">ç¢ºèªä¸­...</span>
      </div>
    </div>

    <button id="initButton" class="btn btn-primary" onclick="initialize()">
      åˆæœŸåŒ–å®Ÿè¡Œ
    </button>

    <button class="btn btn-secondary" onclick="goBack()">
      æˆ»ã‚‹
    </button>

    <div id="log" class="log"></div>
  </div>

  <script src="./js/master-config.js"></script>
  <script type="module">
    import('./js/firestore-api.js').then(module => {
      window.getMasterData = module.getMasterData;
      window.createMaster = module.createMaster;
      window.initializeFirestore = module.initializeFirestore;

      // åˆæœŸåŒ–å®Œäº†å¾Œã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
      checkExistingData();
    });

    let existingCategories = [];
    let defaultCategories = [];

    async function checkExistingData() {
      try {
        addLog('ğŸ“Š æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ç¢ºèªä¸­...', 'info');

        // master-config.jsã‹ã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—
        defaultCategories = window.masterCategories.product.masters.attributeCategory.defaultData;
        document.getElementById('totalCount').textContent = `${defaultCategories.length}ä»¶`;

        // Firestoreã‹ã‚‰æ—¢å­˜ãƒ‡ãƒ¼ã‚¿å–å¾—
        existingCategories = await window.getMasterData('attributeCategories');
        document.getElementById('existingCount').textContent = `${existingCategories.length}ä»¶`;

        // æŠ•å…¥äºˆå®šæ•°è¨ˆç®—
        const toInsert = defaultCategories.length - existingCategories.length;
        document.getElementById('toInsertCount').textContent = 
          toInsert > 0 ? `${toInsert}ä»¶` : 'æŠ•å…¥ä¸è¦ï¼ˆæ—¢ã«å®Œäº†ï¼‰';

        if (toInsert <= 0) {
          addLog('âœ… æ—¢ã«ãƒ‡ãƒ¼ã‚¿ãŒæŠ•å…¥ã•ã‚Œã¦ã„ã¾ã™', 'success');
          document.getElementById('initButton').disabled = true;
          document.getElementById('initButton').textContent = 'æŠ•å…¥æ¸ˆã¿';
        } else {
          addLog(`âœ… ${toInsert}ä»¶ã®ã‚«ãƒ†ã‚´ãƒªã‚’æŠ•å…¥å¯èƒ½`, 'success');
        }

      } catch (error) {
        console.error('âŒ ãƒ‡ãƒ¼ã‚¿ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
        addLog(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      }
    }

    window.initialize = async function() {
      const button = document.getElementById('initButton');
      button.disabled = true;
      button.textContent = 'æŠ•å…¥ä¸­...';

      document.getElementById('log').classList.add('show');
      addLog('ğŸš€ åˆæœŸåŒ–é–‹å§‹', 'info');

      try {
        let insertedCount = 0;
        let skippedCount = 0;

        for (const category of defaultCategories) {
          // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«åŒã˜nameãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          const exists = existingCategories.find(c => c.name === category.name);

          if (exists) {
            addLog(`â­ï¸ ã‚¹ã‚­ãƒƒãƒ—: ${category.name}ï¼ˆæ—¢å­˜ï¼‰`, 'info');
            skippedCount++;
            continue;
          }

          // æŠ•å…¥å®Ÿè¡Œ
          addLog(`ğŸ“ æŠ•å…¥ä¸­: ${category.name}...`, 'info');

          const result = await window.createMaster('attributeCategories', {
            name: category.name,
            displayOrder: category.displayOrder
          }, false);

          if (result.success) {
            addLog(`âœ… æˆåŠŸ: ${category.name}`, 'success');
            insertedCount++;
          } else {
            addLog(`âŒ å¤±æ•—: ${category.name} - ${result.error}`, 'error');
          }

          // çŸ­ã„é–“éš”ã‚’ç©ºã‘ã‚‹ï¼ˆFirestoreè² è·è»½æ¸›ï¼‰
          await new Promise(resolve => setTimeout(resolve, 100));
        }

        addLog(``, 'info');
        addLog(`ğŸ‰ åˆæœŸåŒ–å®Œäº†`, 'success');
        addLog(`âœ… æŠ•å…¥æˆåŠŸ: ${insertedCount}ä»¶`, 'success');
        addLog(`â­ï¸ ã‚¹ã‚­ãƒƒãƒ—: ${skippedCount}ä»¶`, 'info');

        button.textContent = 'å®Œäº†';
        
        // ãƒ‡ãƒ¼ã‚¿å†ç¢ºèª
        setTimeout(() => {
          checkExistingData();
        }, 1000);

      } catch (error) {
        console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        addLog(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        button.disabled = false;
        button.textContent = 'å†è©¦è¡Œ';
      }
    };

    function addLog(message, type = 'info') {
      const log = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = message;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
    }

    function goBack() {
      window.location.href = '/master-management.html?category=product&type=attributeCategory';
    }
  </script>
</body>
</html>
