<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base target="_top">
  <title>ãƒã‚¤ãƒšãƒ¼ã‚¸ - FURIRA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/reborn-theme.css?v=296">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    .content-container {
      padding: 16px;
      max-width: 600px;
      margin: 0 auto;
    }

    /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ */
    .profile-card {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 16px;
      color: white;
      text-align: center;
    }
    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px;
      font-size: 40px;
      border: 3px solid rgba(255,255,255,0.5);
      overflow: hidden;
    }
    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .profile-name {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .profile-role {
      font-size: 14px;
      opacity: 0.9;
    }
    .profile-month {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 8px;
    }

    /* å ±é…¬ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ */
    .compensation-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .compensation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .compensation-title {
      font-size: 14px;
      color: #6b7280;
      font-weight: 600;
    }
    .compensation-amount {
      font-size: 32px;
      font-weight: 800;
      color: #1f2937;
      margin-bottom: 4px;
    }
    .compensation-goal {
      font-size: 14px;
      color: #6b7280;
    }
    .compensation-goal .goal-amount {
      color: #40B4E5;
      font-weight: 600;
    }

    /* é€²æ—ãƒãƒ¼ */
    .progress-container {
      margin: 16px 0;
    }
    .progress-bar-bg {
      height: 12px;
      background: #e5e7eb;
      border-radius: 6px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #40B4E5 0%, #10b981 100%);
      border-radius: 6px;
      transition: width 0.5s ease;
    }
    .progress-text {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 12px;
      color: #6b7280;
    }
    .progress-percent {
      font-weight: 700;
      color: #40B4E5;
    }

    /* å†…è¨³ã‚«ãƒ¼ãƒ‰ */
    .breakdown-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .breakdown-title {
      font-size: 14px;
      color: #374151;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .breakdown-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    .breakdown-item:last-child {
      border-bottom: none;
    }
    .breakdown-label {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .breakdown-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .breakdown-icon.listing {
      background: #dbeafe;
    }
    .breakdown-icon.shipping {
      background: #fef3c7;
    }
    .breakdown-name {
      font-size: 14px;
      color: #374151;
      font-weight: 500;
    }
    .breakdown-count {
      font-size: 12px;
      color: #9ca3af;
    }
    .breakdown-amount {
      font-size: 16px;
      font-weight: 700;
      color: #1f2937;
    }

    /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰ */
    .ranking-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .ranking-title {
      font-size: 14px;
      color: #374151;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .ranking-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      border-radius: 10px;
      margin-bottom: 8px;
      background: #f9fafb;
    }
    .ranking-item.highlight {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 2px solid #f59e0b;
    }
    .ranking-position {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      margin-right: 12px;
    }
    .ranking-position.gold {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: white;
    }
    .ranking-position.silver {
      background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
      color: white;
    }
    .ranking-position.bronze {
      background: linear-gradient(135deg, #f59e0b 0%, #b45309 100%);
      color: white;
    }
    .ranking-position.normal {
      background: #e5e7eb;
      color: #6b7280;
    }
    .ranking-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
      font-weight: 500;
    }
    .ranking-name.me {
      color: #b45309;
      font-weight: 700;
    }
    .ranking-amount {
      font-size: 14px;
      font-weight: 700;
      color: #40B4E5;
    }

    /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 8px;
    }
    .action-btn {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .action-btn:hover {
      background: #f9fafb;
      border-color: #40B4E5;
    }
    .action-btn:active {
      transform: scale(0.98);
    }
    .action-btn i {
      font-size: 24px;
      color: #40B4E5;
      margin-bottom: 8px;
      display: block;
    }
    .action-btn span {
      font-size: 13px;
      color: #374151;
      font-weight: 500;
    }

    /* ç›®æ¨™è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
    .goal-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .goal-modal {
      background: white;
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .goal-modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 16px;
      text-align: center;
    }
    .goal-input-group {
      margin-bottom: 20px;
    }
    .goal-input-group label {
      display: block;
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    .goal-input-wrapper {
      display: flex;
      align-items: center;
      background: #f3f4f6;
      border-radius: 10px;
      padding: 12px 16px;
    }
    .goal-input-wrapper span {
      font-size: 18px;
      color: #6b7280;
      margin-right: 8px;
    }
    .goal-input-wrapper input {
      flex: 1;
      min-width: 0;
      border: none;
      background: transparent;
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
      outline: none;
      text-align: right;
    }
    .goal-presets {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .goal-preset-btn {
      padding: 8px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 20px;
      background: white;
      font-size: 13px;
      color: #374151;
      cursor: pointer;
    }
    .goal-preset-btn:hover {
      border-color: #40B4E5;
      color: #40B4E5;
    }
    .goal-modal-buttons {
      display: flex;
      gap: 12px;
    }
    .goal-modal-buttons button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .goal-cancel-btn {
      background: #f3f4f6;
      border: none;
      color: #6b7280;
    }
    .goal-save-btn {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      border: none;
      color: white;
    }

    /* ç›®æ¨™å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .history-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .history-modal {
      background: white;
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .history-modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 16px;
      text-align: center;
    }
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .history-item {
      background: #f9fafb;
      border-radius: 12px;
      padding: 16px;
      border-left: 4px solid #40B4E5;
    }
    .history-item.achieved {
      border-left-color: #10b981;
    }
    .history-item.not-achieved {
      border-left-color: #ef4444;
    }
    .history-month {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }
    .history-amounts {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .history-goal, .history-actual {
      font-size: 13px;
      color: #6b7280;
    }
    .history-goal span, .history-actual span {
      font-weight: 600;
      color: #1f2937;
    }
    .history-progress {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .history-progress-bar {
      flex: 1;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
    }
    .history-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #40B4E5, #1E8FBF);
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    .history-progress-fill.achieved {
      background: linear-gradient(90deg, #10b981, #059669);
    }
    .history-percent {
      font-size: 14px;
      font-weight: 700;
      color: #40B4E5;
      min-width: 45px;
      text-align: right;
    }
    .history-percent.achieved {
      color: #10b981;
    }
    .history-empty {
      text-align: center;
      padding: 32px 16px;
      color: #9ca3af;
    }
    .history-empty i {
      font-size: 48px;
      margin-bottom: 12px;
      display: block;
    }
    .history-close-btn {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: #f3f4f6;
      border: none;
      color: #6b7280;
      margin-top: 16px;
    }
    /* å±¥æ­´è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .history-details {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }
    .history-breakdown {
      display: flex;
      gap: 12px;
      margin-bottom: 8px;
    }
    .history-breakdown-item {
      flex: 1;
      background: white;
      padding: 8px;
      border-radius: 8px;
      text-align: center;
    }
    .history-breakdown-icon {
      font-size: 16px;
      margin-bottom: 4px;
    }
    .history-breakdown-label {
      font-size: 10px;
      color: #9ca3af;
    }
    .history-breakdown-value {
      font-size: 12px;
      font-weight: 600;
      color: #374151;
    }
    .history-ranking {
      background: white;
      padding: 8px 12px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .history-ranking-label {
      font-size: 12px;
      color: #6b7280;
    }
    .history-ranking-value {
      font-size: 14px;
      font-weight: 700;
      color: #f59e0b;
    }
    .history-toggle {
      font-size: 11px;
      color: #40B4E5;
      cursor: pointer;
      text-align: center;
      margin-top: 8px;
    }

    /* ãŠçŸ¥ã‚‰ã›ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .announce-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .announce-modal {
      background: white;
      border-radius: 16px;
      padding: 0;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .announce-modal-header {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      color: white;
      padding: 16px 20px;
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .announce-modal-body {
      padding: 0;
      max-height: 60vh;
      overflow-y: auto;
    }
    .announce-list {
      display: flex;
      flex-direction: column;
    }
    .announce-item {
      padding: 16px 20px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s;
    }
    .announce-item:hover {
      background: #f9fafb;
    }
    .announce-item.unread {
      background: #eff6ff;
    }
    .announce-item.unread:hover {
      background: #dbeafe;
    }
    .announce-item-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .announce-priority {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
    }
    .announce-priority.important {
      background: #fef2f2;
      color: #dc2626;
    }
    .announce-priority.normal {
      background: #f0f9ff;
      color: #0284c7;
    }
    .announce-date {
      font-size: 12px;
      color: #9ca3af;
    }
    .announce-title {
      font-size: 15px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }
    .announce-preview {
      font-size: 13px;
      color: #6b7280;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .announce-empty {
      text-align: center;
      padding: 40px 20px;
      color: #9ca3af;
    }
    .announce-empty i {
      font-size: 48px;
      margin-bottom: 12px;
      display: block;
    }
    .announce-modal-footer {
      padding: 12px 20px;
      border-top: 1px solid #f0f0f0;
    }
    .announce-close-btn {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: #f3f4f6;
      border: none;
      color: #6b7280;
    }
    /* ãŠçŸ¥ã‚‰ã›è©³ç´° */
    .announce-detail {
      padding: 20px;
    }
    .announce-detail-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 8px;
    }
    .announce-detail-meta {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .announce-detail-body {
      font-size: 14px;
      color: #374151;
      line-height: 1.7;
      white-space: pre-wrap;
    }
    .announce-back-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 14px;
      color: #40B4E5;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      margin-bottom: 16px;
    }
    /* ãƒ™ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ã®ãƒãƒƒã‚¸ */
    .minimal-header-icon {
      position: relative;
    }
    .header-badge {
      position: absolute;
      top: 4px;
      right: 4px;
      background: #ef4444;
      color: white;
      font-size: 10px;
      font-weight: 700;
      min-width: 16px;
      height: 16px;
      border-radius: 8px;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }
    .header-badge.active {
      display: flex;
    }

    /* è¨­å®šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ */
    .settings-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 200px;
      overflow: hidden;
      display: none;
      z-index: 1001;
    }
    .settings-dropdown.active {
      display: block;
    }
    .settings-dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      font-size: 14px;
      color: #1f2937;
      text-decoration: none;
      transition: background 0.2s;
      cursor: pointer;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }
    .settings-dropdown-item:hover {
      background: #f3f4f6;
    }
    .settings-dropdown-item i {
      font-size: 18px;
      color: #6b7280;
      width: 24px;
      text-align: center;
    }
    .settings-dropdown-item.admin-only {
      display: none;
    }
    .settings-dropdown-item.admin-only.visible {
      display: flex;
      border-top: 1px solid #e5e7eb;
      color: #6366f1;
    }
    .settings-dropdown-item.admin-only.visible i {
      color: #6366f1;
    }
    .settings-dropdown-divider {
      height: 1px;
      background: #e5e7eb;
      margin: 4px 0;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    /* éå¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .not-eligible {
      text-align: center;
      padding: 40px 20px;
    }
    .not-eligible i {
      font-size: 64px;
      color: #d1d5db;
      margin-bottom: 16px;
    }
    .not-eligible h3 {
      font-size: 18px;
      color: #374151;
      margin-bottom: 8px;
    }
    .not-eligible p {
      font-size: 14px;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>
  </div>

  <!-- YouTubeé¢¨ãƒŸãƒ‹ãƒãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <style>
    .minimal-header {
      background: #ffffff;
      height: 56px;
      padding: 0 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 1px solid #f0f0f0;
    }
    .minimal-header-logo {
      width: 100px;
      height: auto;
      cursor: pointer;
    }
    .minimal-header-icons {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .minimal-header-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 22px;
      transition: background 0.2s;
    }
    .minimal-header-icon:hover {
      background: #f2f2f2;
    }
    .minimal-header-icon:active {
      background: #e5e5e5;
    }
  </style>
  <div class="minimal-header">
    <img src="/images/furira-square-logo.png?v=20251209" alt="Furira" class="minimal-header-logo" onclick="window.parent.postMessage({type:'navigate', page:'home'}, '*')">
    <div class="minimal-header-icons">
      <button class="minimal-header-icon" title="é€šçŸ¥" onclick="openAnnouncePage()">
        <i class="bi bi-bell"></i>
        <span class="header-badge" id="announceBadge">0</span>
      </button>
      <div style="position: relative;">
        <button class="minimal-header-icon" title="è¨­å®š" onclick="toggleSettingsDropdown(event)">
          <i class="bi bi-gear"></i>
        </button>
        <div class="settings-dropdown" id="settingsDropdown">
          <button class="settings-dropdown-item" onclick="window.parent.postMessage({type:'navigate', page:'config'}, '*')">
            <i class="bi bi-sliders"></i>
            <span>è¨­å®šç®¡ç†</span>
          </button>
          <button class="settings-dropdown-item" onclick="window.parent.postMessage({type:'navigate', page:'help'}, '*')">
            <i class="bi bi-question-circle"></i>
            <span>ãƒ˜ãƒ«ãƒ—</span>
          </button>
          <button class="settings-dropdown-item admin-only" id="adminAnnounceLink" onclick="openAdminAnnounce()">
            <i class="bi bi-megaphone"></i>
            <span>ãŠçŸ¥ã‚‰ã›ç®¡ç†</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="content-container" id="mainContent">
    <!-- å‹•çš„ã«è¡¨ç¤º -->
  </div>

  <!-- ç›®æ¨™è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="goal-modal-backdrop" id="goalModal">
    <div class="goal-modal">
      <div class="goal-modal-title">ğŸ¯ ä»Šæœˆã®ç›®æ¨™é‡‘é¡ã‚’è¨­å®š</div>
      <div class="goal-input-group">
        <label>ç›®æ¨™é‡‘é¡</label>
        <div class="goal-input-wrapper">
          <span>Â¥</span>
          <input type="number" id="goalAmountInput" placeholder="10000" step="1000">
        </div>
      </div>
      <div class="goal-presets">
        <button class="goal-preset-btn" onclick="setGoalPreset(5000)">Â¥5,000</button>
        <button class="goal-preset-btn" onclick="setGoalPreset(10000)">Â¥10,000</button>
        <button class="goal-preset-btn" onclick="setGoalPreset(20000)">Â¥20,000</button>
        <button class="goal-preset-btn" onclick="setGoalPreset(30000)">Â¥30,000</button>
        <button class="goal-preset-btn" onclick="setGoalPreset(50000)">Â¥50,000</button>
      </div>
      <div class="goal-modal-buttons">
        <button class="goal-cancel-btn" onclick="closeGoalModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="goal-save-btn" onclick="saveGoal()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="history-modal-backdrop" id="historyModal">
    <div class="history-modal">
      <div class="history-modal-title">ğŸ“Š ç›®æ¨™å±¥æ­´</div>
      <div class="history-list" id="historyList">
        <!-- å‹•çš„ã«ç”Ÿæˆ -->
      </div>
      <button class="history-close-btn" onclick="closeHistoryModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- ãŠçŸ¥ã‚‰ã›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="announce-modal-backdrop" id="announceModal">
    <div class="announce-modal">
      <div class="announce-modal-header">
        <i class="bi bi-bell"></i> ãŠçŸ¥ã‚‰ã›
      </div>
      <div class="announce-modal-body" id="announceModalBody">
        <!-- å‹•çš„ã«ç”Ÿæˆ -->
      </div>
      <div class="announce-modal-footer">
        <button class="announce-close-btn" onclick="closeAnnouncementModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, getDoc, setDoc, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "furira.jp",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let currentUser = null;
    let compensationRecords = [];
    let compensationSettings = {};
    let userGoal = 0;

    // åˆæœŸåŒ–
    async function init() {
      showLoading(true);

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
      currentUser = {
        email: localStorage.getItem('reborn_user_email') || '',
        name: localStorage.getItem('reborn_user_name') || 'ã‚²ã‚¹ãƒˆ',
        permissionId: localStorage.getItem('reborn_user_permission_id') || 'staff',
        permissionDisplay: localStorage.getItem('reborn_user_permission_display') || 'ã‚¹ã‚¿ãƒƒãƒ•',
        photoURL: localStorage.getItem('reborn_user_icon_url') || localStorage.getItem('reborn_user_photo_url') || ''
      };

      if (!currentUser.email) {
        showNotEligible('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
        showLoading(false);
        return;
      }

      try {
        // å ±é…¬è¨­å®šã‚’å–å¾—
        await loadCompensationSettings();

        // å ±é…¬å¯¾è±¡è€…ã‹ãƒã‚§ãƒƒã‚¯
        const isEligible = await checkEligibility();

        if (!isEligible) {
          showNotEligible('å ±é…¬å¯¾è±¡å¤–ã§ã™', 'ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯å ±é…¬ç®¡ç†ã®å¯¾è±¡å¤–ã§ã™ã€‚');
          showLoading(false);
          return;
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç›®æ¨™ã‚’å–å¾—
        await loadUserGoal();

        // å ±é…¬ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        await loadCompensationData();

        // ç”»é¢ã‚’æç”»
        renderMyPage();

        // ãŠçŸ¥ã‚‰ã›ã‚’èª­ã¿è¾¼ã‚“ã§ãƒãƒƒã‚¸ã‚’æ›´æ–°
        await initAnnouncements();

        // ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºãƒã‚§ãƒƒã‚¯
        checkAdminAccess();
      } catch (error) {
        console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        showNotEligible('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
      }

      showLoading(false);
    }

    // ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
    const ADMIN_EMAILS = ['mercari.yasuhirotakuji@gmail.com'];

    // ç®¡ç†è€…ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚§ãƒƒã‚¯
    function checkAdminAccess() {
      if (currentUser && ADMIN_EMAILS.includes(currentUser.email)) {
        const adminLink = document.getElementById('adminAnnounceLink');
        if (adminLink) {
          adminLink.classList.add('visible');
        }
        console.log('ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º:', currentUser.email);
      }
    }

    // è¨­å®šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åˆ¶å¾¡
    window.toggleSettingsDropdown = function(event) {
      event.stopPropagation();
      const dropdown = document.getElementById('settingsDropdown');
      dropdown.classList.toggle('active');
    };

    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown && !dropdown.contains(event.target)) {
        dropdown.classList.remove('active');
      }
    });

    // ãŠçŸ¥ã‚‰ã›ç®¡ç†ã‚’é–‹ãï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã¦ã‹ã‚‰ï¼‰
    window.openAdminAnnounce = function() {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) {
        dropdown.classList.remove('active');
      }
      window.open('/admin-announce.html', '_blank');
    };

    // å ±é…¬è¨­å®šã‚’å–å¾—ï¼ˆlocalStorageã‹ã‚‰configçµŒç”±ï¼‰
    async function loadCompensationSettings() {
      try {
        // localStorageã‹ã‚‰configèª­ã¿è¾¼ã¿
        const configStr = localStorage.getItem('config');
        if (configStr) {
          const config = JSON.parse(configStr);
          if (config.å ±é…¬è¨­å®š) {
            compensationSettings = config.å ±é…¬è¨­å®š;
            console.log('å ±é…¬è¨­å®šã‚’èª­ã¿è¾¼ã¿:', compensationSettings);
            return;
          }
        }

        // Firestoreã‹ã‚‰ã‚‚å–å¾—è©¦è¡Œ
        const docRef = doc(db, 'settings', 'compensation');
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          compensationSettings = docSnap.data();
        } else {
          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
          compensationSettings = {
            taskRates: { listing: 100, shipping: 100, photography: 50, inspection: 30 },
            mypage: { enabled: true, allowedUsers: [] }
          };
        }
      } catch (error) {
        console.error('å ±é…¬è¨­å®šå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        compensationSettings = {
          taskRates: { listing: 100, shipping: 100 },
          mypage: { enabled: true, allowedUsers: [] }
        };
      }
    }

    // å ±é…¬å¯¾è±¡è€…ã‹ãƒã‚§ãƒƒã‚¯
    async function checkEligibility() {
      // ãƒã‚¤ãƒšãƒ¼ã‚¸æ©Ÿèƒ½ãŒç„¡åŠ¹ã®å ´åˆ
      if (compensationSettings.mypage && compensationSettings.mypage.enabled === false) {
        console.log('ãƒã‚¤ãƒšãƒ¼ã‚¸æ©Ÿèƒ½ãŒç„¡åŠ¹ã§ã™');
        return false;
      }

      // allowedUsersãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      const allowedUsers = compensationSettings.mypage?.allowedUsers || [];

      // allowedUsersãŒç©ºï¼ˆæœªè¨­å®šï¼‰ã®å ´åˆã¯å…¨å“¡è¨±å¯
      if (allowedUsers.length === 0) {
        console.log('ãƒã‚¤ãƒšãƒ¼ã‚¸: å…¨å“¡è¨±å¯ï¼ˆallowedUsersæœªè¨­å®šï¼‰');
        return true;
      }

      // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      const isAllowed = allowedUsers.includes(currentUser.email);
      console.log('ãƒã‚¤ãƒšãƒ¼ã‚¸æ¨©é™ãƒã‚§ãƒƒã‚¯:', currentUser.email, 'allowed:', isAllowed);

      return isAllowed;
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç›®æ¨™ã‚’å–å¾—
    async function loadUserGoal() {
      try {
        const now = new Date();
        const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const docRef = doc(db, 'userGoals', `${currentUser.email}_${yearMonth}`);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          userGoal = docSnap.data().goalAmount || 0;
        } else {
          userGoal = 10000; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç›®æ¨™
        }
      } catch (error) {
        console.error('ç›®æ¨™å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        userGoal = 10000;
      }
    }

    // å ±é…¬ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    async function loadCompensationData() {
      try {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;

        const recordsRef = collection(db, 'compensationRecords');
        const snapshot = await getDocs(recordsRef);

        compensationRecords = [];
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          compensationRecords.push({ id: docSnap.id, ...data });
        });

        // ä»Šæœˆã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
        compensationRecords = compensationRecords.filter(r => {
          if (!r.completedAt && !r.recordedAt) return false;
          const dateStr = r.completedAt || r.recordedAt;
          const date = typeof dateStr === 'string' ? new Date(dateStr) : (dateStr.toDate ? dateStr.toDate() : new Date(dateStr));
          return date.getFullYear() === year && (date.getMonth() + 1) === month;
        });
      } catch (error) {
        console.error('å ±é…¬ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        compensationRecords = [];
      }
    }

    // ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚’æç”»
    function renderMyPage() {
      const now = new Date();
      const monthName = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ`;

      // è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
      const myRecords = compensationRecords.filter(r => r.staffEmail === currentUser.email);
      const myStats = calculateStats(myRecords);

      // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
      const rankingData = calculateRanking();
      const myRank = rankingData.findIndex(r => r.email === currentUser.email) + 1;

      // é€²æ—ç‡ã‚’è¨ˆç®—
      const progressPercent = userGoal > 0 ? Math.min(100, Math.round((myStats.totalAmount / userGoal) * 100)) : 0;

      // ã‚¢ãƒã‚¿ãƒ¼
      const avatarHtml = currentUser.photoURL
        ? `<img src="${currentUser.photoURL}" alt="ã‚¢ãƒã‚¿ãƒ¼">`
        : 'ğŸ‘¤';

      const html = `
        <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ -->
        <div class="profile-card">
          <div class="profile-avatar">${avatarHtml}</div>
          <div class="profile-name">${escapeHtml(currentUser.name)}ã•ã‚“</div>
          <div class="profile-role">${escapeHtml(currentUser.permissionDisplay)}</div>
          <div class="profile-month">${monthName}</div>
        </div>

        <!-- å ±é…¬ã‚µãƒãƒªãƒ¼ -->
        <div class="compensation-card">
          <div class="compensation-header">
            <div class="compensation-title">ğŸ’° ä»Šæœˆã®å ±é…¬</div>
          </div>
          <div class="compensation-amount">Â¥${myStats.totalAmount.toLocaleString()}</div>
          <div class="compensation-goal">
            ç›®æ¨™: <span class="goal-amount">Â¥${userGoal.toLocaleString()}</span>
          </div>
          <div class="progress-container">
            <div class="progress-bar-bg">
              <div class="progress-bar-fill" style="width: ${progressPercent}%"></div>
            </div>
            <div class="progress-text">
              <span>é”æˆç‡</span>
              <span class="progress-percent">${progressPercent}%</span>
            </div>
          </div>
        </div>

        <!-- å†…è¨³ -->
        <div class="breakdown-card">
          <div class="breakdown-title"><i class="bi bi-pie-chart"></i> å†…è¨³</div>
          <div class="breakdown-item">
            <div class="breakdown-label">
              <div class="breakdown-icon listing">ğŸ“¦</div>
              <div>
                <div class="breakdown-name">å•†å“å‡ºå“</div>
                <div class="breakdown-count">${myStats.listingCount}ä»¶</div>
              </div>
            </div>
            <div class="breakdown-amount">Â¥${myStats.listingAmount.toLocaleString()}</div>
          </div>
          <div class="breakdown-item">
            <div class="breakdown-label">
              <div class="breakdown-icon shipping">ğŸšš</div>
              <div>
                <div class="breakdown-name">æ¢±åŒ…ãƒ»ç™ºé€</div>
                <div class="breakdown-count">${myStats.shippingCount}ä»¶</div>
              </div>
            </div>
            <div class="breakdown-amount">Â¥${myStats.shippingAmount.toLocaleString()}</div>
          </div>
        </div>

        <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
        <div class="ranking-card">
          <div class="ranking-title"><i class="bi bi-trophy"></i> ä»Šæœˆã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
          ${renderRankingList(rankingData, currentUser.email)}
        </div>

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
        <div class="action-buttons">
          <div class="action-btn" onclick="openBasicInfo()">
            <i class="bi bi-gear"></i>
            <span>åŸºæœ¬æƒ…å ±</span>
          </div>
          <div class="action-btn" onclick="openGoalModal()">
            <i class="bi bi-bullseye"></i>
            <span>ç›®æ¨™è¨­å®š</span>
          </div>
          <div class="action-btn" onclick="openHistoryModal()">
            <i class="bi bi-clock-history"></i>
            <span>å±¥æ­´</span>
          </div>
        </div>
      `;

      document.getElementById('mainContent').innerHTML = html;
    }

    // çµ±è¨ˆã‚’è¨ˆç®—
    function calculateStats(records) {
      let listingCount = 0;
      let listingAmount = 0;
      let shippingCount = 0;
      let shippingAmount = 0;

      records.forEach(r => {
        const taskType = r.taskTypeKey || r.taskType || '';
        const amount = r.unitPrice || 0;

        if (taskType === 'listing' || taskType === 'listing_approval') {
          listingCount++;
          listingAmount += amount;
        } else if (taskType === 'shipping' || taskType === 'shipping_task') {
          shippingCount++;
          shippingAmount += amount;
        }
      });

      return {
        listingCount,
        listingAmount,
        shippingCount,
        shippingAmount,
        totalAmount: listingAmount + shippingAmount,
        totalCount: listingCount + shippingCount
      };
    }

    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¨ˆç®—
    function calculateRanking() {
      const staffStats = {};

      compensationRecords.forEach(r => {
        const email = r.staffEmail || '';
        const name = r.staffName || 'ä¸æ˜';
        const amount = r.unitPrice || 0;

        if (!email) return;

        if (!staffStats[email]) {
          staffStats[email] = { email, name, totalAmount: 0 };
        }
        staffStats[email].totalAmount += amount;
      });

      // é‡‘é¡ã§ã‚½ãƒ¼ãƒˆ
      const ranking = Object.values(staffStats).sort((a, b) => b.totalAmount - a.totalAmount);

      return ranking;
    }

    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒªã‚¹ãƒˆã‚’æç”»
    function renderRankingList(rankingData, myEmail) {
      if (rankingData.length === 0) {
        return '<div class="text-center text-muted py-3">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      }

      // ä¸Šä½3å + è‡ªåˆ†ã®ä½ç½®ã‚’è¡¨ç¤º
      const myRankIndex = rankingData.findIndex(r => r.email === myEmail);
      const displayItems = [];

      // ä¸Šä½3å
      for (let i = 0; i < Math.min(3, rankingData.length); i++) {
        displayItems.push({ ...rankingData[i], rank: i + 1 });
      }

      // è‡ªåˆ†ãŒ4ä½ä»¥ä¸‹ãªã‚‰è¿½åŠ 
      if (myRankIndex >= 3) {
        // åŒºåˆ‡ã‚Šç·šã®ä»£ã‚ã‚Šã«...ã‚’è¿½åŠ 
        displayItems.push({ separator: true });
        displayItems.push({ ...rankingData[myRankIndex], rank: myRankIndex + 1 });
      }

      return displayItems.map(item => {
        if (item.separator) {
          return '<div class="text-center text-muted py-1">â‹®</div>';
        }

        const isMe = item.email === myEmail;
        const positionClass = item.rank === 1 ? 'gold' : item.rank === 2 ? 'silver' : item.rank === 3 ? 'bronze' : 'normal';
        const highlightClass = isMe ? 'highlight' : '';
        const nameClass = isMe ? 'me' : '';
        const displayName = isMe ? `â˜… ${item.name}` : item.name;

        return `
          <div class="ranking-item ${highlightClass}">
            <div class="ranking-position ${positionClass}">${item.rank}</div>
            <div class="ranking-name ${nameClass}">${escapeHtml(displayName)}</div>
            <div class="ranking-amount">Â¥${item.totalAmount.toLocaleString()}</div>
          </div>
        `;
      }).join('');
    }

    // éå¯¾è±¡è€…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    function showNotEligible(title, message) {
      document.getElementById('mainContent').innerHTML = `
        <div class="not-eligible">
          <i class="bi bi-person-x"></i>
          <h3>${escapeHtml(title)}</h3>
          <p>${escapeHtml(message)}</p>
          <div class="action-buttons mt-4">
            <div class="action-btn" onclick="openBasicInfo()">
              <i class="bi bi-gear"></i>
              <span>åŸºæœ¬æƒ…å ±</span>
            </div>
          </div>
        </div>
      `;
    }

    // ç›®æ¨™è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.openGoalModal = function() {
      document.getElementById('goalAmountInput').value = userGoal || '';
      document.getElementById('goalModal').style.display = 'flex';
    };

    // ç›®æ¨™è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeGoalModal = function() {
      document.getElementById('goalModal').style.display = 'none';
    };

    // ãƒ—ãƒªã‚»ãƒƒãƒˆé‡‘é¡ã‚’è¨­å®š
    window.setGoalPreset = function(amount) {
      document.getElementById('goalAmountInput').value = amount;
    };

    // ç›®æ¨™ã‚’ä¿å­˜
    window.saveGoal = async function() {
      const goalAmount = parseInt(document.getElementById('goalAmountInput').value) || 0;

      if (goalAmount < 0) {
        alert('ç›®æ¨™é‡‘é¡ã¯0ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      try {
        showLoading(true);

        const now = new Date();
        const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const docRef = doc(db, 'userGoals', `${currentUser.email}_${yearMonth}`);

        await setDoc(docRef, {
          email: currentUser.email,
          name: currentUser.name,
          yearMonth: yearMonth,
          goalAmount: goalAmount,
          updatedAt: new Date().toISOString()
        });

        userGoal = goalAmount;
        closeGoalModal();
        renderMyPage();

        showLoading(false);
      } catch (error) {
        console.error('ç›®æ¨™ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        showLoading(false);
      }
    };

    // å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.openHistoryModal = async function() {
      document.getElementById('historyModal').style.display = 'flex';
      document.getElementById('historyList').innerHTML = '<div class="history-empty"><div class="spinner-border text-primary" role="status"></div><p style="margin-top: 12px;">èª­ã¿è¾¼ã¿ä¸­...</p></div>';
      
      try {
        const historyData = await loadGoalHistory();
        renderHistoryList(historyData);
      } catch (error) {
        console.error('å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('historyList').innerHTML = '<div class="history-empty"><i class="bi bi-exclamation-circle"></i><p>å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p></div>';
      }
    };

    // å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeHistoryModal = function() {
      document.getElementById('historyModal').style.display = 'none';
    };

    // éå»ã®ç›®æ¨™å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€ï¼ˆéå»12ãƒ¶æœˆï¼‰
    async function loadGoalHistory() {
      const history = [];
      const now = new Date();
      
      // éå»12ãƒ¶æœˆåˆ†ã‚’å–å¾—ï¼ˆå½“æœˆã¯é™¤ãï¼‰
      for (let i = 1; i <= 12; i++) {
        const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const year = targetDate.getFullYear();
        const month = targetDate.getMonth() + 1;
        const yearMonth = `${year}-${String(month).padStart(2, '0')}`;
        
        // ç›®æ¨™ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const goalDocRef = doc(db, 'userGoals', `${currentUser.email}_${yearMonth}`);
        const goalSnap = await getDoc(goalDocRef);
        
        // å ±é…¬ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const recordsRef = collection(db, 'compensationRecords');
        const recordsSnap = await getDocs(recordsRef);
        
        let monthRecords = [];
        recordsSnap.forEach(docSnap => {
          const data = docSnap.data();
          if (data.staffEmail !== currentUser.email) return;
          
          const dateStr = data.completedAt || data.recordedAt;
          if (!dateStr) return;
          
          const date = typeof dateStr === 'string' ? new Date(dateStr) : (dateStr.toDate ? dateStr.toDate() : new Date(dateStr));
          if (date.getFullYear() === year && (date.getMonth() + 1) === month) {
            monthRecords.push(data);
          }
        });
        
        // ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹æœˆã®ã¿è¿½åŠ 
        if (goalSnap.exists() || monthRecords.length > 0) {
          const goalAmount = goalSnap.exists() ? (goalSnap.data().goalAmount || 0) : 10000;
          const stats = calculateStats(monthRecords);
          
          // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¨ˆç®—ï¼ˆå…¨å“¡åˆ†ï¼‰
          const allUsersMap = new Map();
          recordsSnap.forEach(docSnap => {
            const data = docSnap.data();
            const dateStr = data.completedAt || data.recordedAt;
            if (!dateStr) return;
            
            const date = typeof dateStr === 'string' ? new Date(dateStr) : (dateStr.toDate ? dateStr.toDate() : new Date(dateStr));
            if (date.getFullYear() === year && (date.getMonth() + 1) === month) {
              const email = data.staffEmail || 'unknown';
              if (!allUsersMap.has(email)) {
                allUsersMap.set(email, { totalAmount: 0 });
              }
              allUsersMap.get(email).totalAmount += (data.unitPrice || 0);
            }
          });
          
          // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ç”Ÿæˆ
          const ranking = Array.from(allUsersMap.entries())
            .map(([email, data]) => ({ email, ...data }))
            .sort((a, b) => b.totalAmount - a.totalAmount);
          
          const myRank = ranking.findIndex(r => r.email === currentUser.email) + 1;
          
          history.push({
            yearMonth,
            year,
            month,
            goalAmount,
            actualAmount: stats.totalAmount,
            listingCount: stats.listingCount,
            listingAmount: stats.listingAmount,
            shippingCount: stats.shippingCount,
            shippingAmount: stats.shippingAmount,
            rank: myRank || '-',
            totalParticipants: ranking.length
          });
        }
      }
      
      return history;
    }

    // å±¥æ­´ãƒªã‚¹ãƒˆã‚’æç”»
    function renderHistoryList(historyData) {
      if (historyData.length === 0) {
        document.getElementById('historyList').innerHTML = '<div class="history-empty"><i class="bi bi-calendar-x"></i><p>éå»ã®å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
        return;
      }
      
      const html = historyData.map(item => {
        const percent = item.goalAmount > 0 ? Math.min(100, Math.round((item.actualAmount / item.goalAmount) * 100)) : 0;
        const achieved = percent >= 100;
        const achievedClass = achieved ? 'achieved' : (percent > 0 ? 'not-achieved' : '');
        
        return `
          <div class="history-item ${achievedClass}">
            <div class="history-month">${item.year}å¹´${item.month}æœˆ</div>
            <div class="history-amounts">
              <div class="history-goal">ç›®æ¨™: <span>Â¥${item.goalAmount.toLocaleString()}</span></div>
              <div class="history-actual">å®Ÿç¸¾: <span>Â¥${item.actualAmount.toLocaleString()}</span></div>
            </div>
            <div class="history-progress">
              <div class="history-progress-bar">
                <div class="history-progress-fill ${achieved ? 'achieved' : ''}" style="width: ${percent}%"></div>
              </div>
              <div class="history-percent ${achieved ? 'achieved' : ''}">${percent}%</div>
            </div>
            <div class="history-details">
              <div class="history-breakdown">
                <div class="history-breakdown-item">
                  <div class="history-breakdown-icon">ğŸ“¦</div>
                  <div class="history-breakdown-label">å‡ºå“</div>
                  <div class="history-breakdown-value">${item.listingCount}ä»¶ / Â¥${item.listingAmount.toLocaleString()}</div>
                </div>
                <div class="history-breakdown-item">
                  <div class="history-breakdown-icon">ğŸšš</div>
                  <div class="history-breakdown-label">ç™ºé€</div>
                  <div class="history-breakdown-value">${item.shippingCount}ä»¶ / Â¥${item.shippingAmount.toLocaleString()}</div>
                </div>
              </div>
              <div class="history-ranking">
                <span class="history-ranking-label">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span>
                <span class="history-ranking-value">${item.rank}ä½ / ${item.totalParticipants}äºº</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('historyList').innerHTML = html;
    }

    // ========================================
    // ãŠçŸ¥ã‚‰ã›æ©Ÿèƒ½
    // ========================================
    let announcements = [];
    let readAnnouncementIds = new Set();
    let currentAnnouncementView = 'list'; // 'list' or 'detail'

    // ãŠçŸ¥ã‚‰ã›ãƒšãƒ¼ã‚¸ã‚’é–‹ã
    window.openAnnouncePage = function() {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'navigate', page: 'announce' }, '*');
      } else {
        window.location.href = '/announce.html';
      }
    };

    // ãŠçŸ¥ã‚‰ã›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼ã€ä½¿ç”¨ã•ã‚Œã¦ã„ãªã„ï¼‰
    window.openAnnouncementModal = async function() {
      document.getElementById('announceModal').style.display = 'flex';
      currentAnnouncementView = 'list';
      document.getElementById('announceModalBody').innerHTML = '<div class="announce-empty"><div class="spinner-border text-primary" role="status"></div><p style="margin-top: 12px;">èª­ã¿è¾¼ã¿ä¸­...</p></div>';
      
      try {
        await loadAnnouncements();
        renderAnnouncementList();
      } catch (error) {
        console.error('ãŠçŸ¥ã‚‰ã›èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('announceModalBody').innerHTML = '<div class="announce-empty"><i class="bi bi-exclamation-circle"></i><p>ãŠçŸ¥ã‚‰ã›ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p></div>';
      }
    };

    // ãŠçŸ¥ã‚‰ã›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeAnnouncementModal = function() {
      document.getElementById('announceModal').style.display = 'none';
    };

    // ãŠçŸ¥ã‚‰ã›ã‚’èª­ã¿è¾¼ã‚€
    async function loadAnnouncements() {
      // ãŠçŸ¥ã‚‰ã›ä¸€è¦§ã‚’å–å¾—
      const announcementsRef = collection(db, 'announcements');
      const snapshot = await getDocs(announcementsRef);
      
      announcements = [];
      snapshot.forEach(docSnap => {
        announcements.push({ id: docSnap.id, ...docSnap.data() });
      });
      
      // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
      announcements.sort((a, b) => {
        const dateA = a.createdAt ? (typeof a.createdAt === 'string' ? new Date(a.createdAt) : a.createdAt.toDate()) : new Date(0);
        const dateB = b.createdAt ? (typeof b.createdAt === 'string' ? new Date(b.createdAt) : b.createdAt.toDate()) : new Date(0);
        return dateB - dateA;
      });
      
      // æ—¢èª­æƒ…å ±ã‚’å–å¾—
      readAnnouncementIds = new Set();
      if (currentUser && currentUser.email) {
        const readRef = collection(db, 'readAnnouncements');
        const readSnapshot = await getDocs(readRef);
        readSnapshot.forEach(docSnap => {
          const data = docSnap.data();
          if (data.userEmail === currentUser.email) {
            readAnnouncementIds.add(data.announcementId);
          }
        });
      }
      
      // ãƒãƒƒã‚¸ã‚’æ›´æ–°
      updateAnnounceBadge();
    }

    // ãŠçŸ¥ã‚‰ã›ä¸€è¦§ã‚’æç”»
    function renderAnnouncementList() {
      if (announcements.length === 0) {
        document.getElementById('announceModalBody').innerHTML = '<div class="announce-empty"><i class="bi bi-bell-slash"></i><p>ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“</p></div>';
        return;
      }
      
      const html = `<div class="announce-list">${announcements.map(item => {
        const isUnread = !readAnnouncementIds.has(item.id);
        const date = item.createdAt ? (typeof item.createdAt === 'string' ? new Date(item.createdAt) : item.createdAt.toDate()) : null;
        const dateStr = date ? `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()}` : '';
        const priorityClass = item.priority === 'important' ? 'important' : 'normal';
        const priorityLabel = item.priority === 'important' ? 'é‡è¦' : 'ãŠçŸ¥ã‚‰ã›';
        
        return `
          <div class="announce-item ${isUnread ? 'unread' : ''}" onclick="showAnnouncementDetail('${item.id}')">
            <div class="announce-item-header">
              <span class="announce-priority ${priorityClass}">${priorityLabel}</span>
              <span class="announce-date">${dateStr}</span>
            </div>
            <div class="announce-title">${escapeHtml(item.title || '')}</div>
            <div class="announce-preview">${escapeHtml(item.body || '').substring(0, 50)}${(item.body || '').length > 50 ? '...' : ''}</div>
          </div>
        `;
      }).join('')}</div>`;
      
      document.getElementById('announceModalBody').innerHTML = html;
    }

    // ãŠçŸ¥ã‚‰ã›è©³ç´°ã‚’è¡¨ç¤º
    window.showAnnouncementDetail = async function(announcementId) {
      const item = announcements.find(a => a.id === announcementId);
      if (!item) return;
      
      currentAnnouncementView = 'detail';
      
      const date = item.createdAt ? (typeof item.createdAt === 'string' ? new Date(item.createdAt) : item.createdAt.toDate()) : null;
      const dateStr = date ? `${date.getFullYear()}å¹´${date.getMonth()+1}æœˆ${date.getDate()}æ—¥` : '';
      const priorityClass = item.priority === 'important' ? 'important' : 'normal';
      const priorityLabel = item.priority === 'important' ? 'é‡è¦' : 'ãŠçŸ¥ã‚‰ã›';
      
      const html = `
        <div class="announce-detail">
          <button class="announce-back-btn" onclick="renderAnnouncementList(); currentAnnouncementView='list';">
            <i class="bi bi-chevron-left"></i> ä¸€è¦§ã«æˆ»ã‚‹
          </button>
          <div class="announce-detail-title">${escapeHtml(item.title || '')}</div>
          <div class="announce-detail-meta">
            <span class="announce-priority ${priorityClass}">${priorityLabel}</span>
            <span>${dateStr}</span>
          </div>
          <div class="announce-detail-body">${escapeHtml(item.body || '')}</div>
        </div>
      `;
      
      document.getElementById('announceModalBody').innerHTML = html;
      
      // æ—¢èª­ã«ã™ã‚‹
      if (!readAnnouncementIds.has(announcementId) && currentUser && currentUser.email) {
        try {
          const readDocRef = doc(db, 'readAnnouncements', `${currentUser.email}_${announcementId}`);
          await setDoc(readDocRef, {
            userEmail: currentUser.email,
            announcementId: announcementId,
            readAt: new Date().toISOString()
          });
          readAnnouncementIds.add(announcementId);
          updateAnnounceBadge();
        } catch (error) {
          console.error('æ—¢èª­ãƒãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼:', error);
        }
      }
    };

    // ãƒãƒƒã‚¸ã‚’æ›´æ–°
    function updateAnnounceBadge() {
      const unreadCount = announcements.filter(a => !readAnnouncementIds.has(a.id)).length;
      const badge = document.getElementById('announceBadge');
      if (badge) {
        if (unreadCount > 0) {
          badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
          badge.classList.add('active');
        } else {
          badge.textContent = '0';
          badge.classList.remove('active');
        }
      }
    }

    // åˆæœŸåŒ–æ™‚ã«ãŠçŸ¥ã‚‰ã›ã‚’èª­ã¿è¾¼ã‚“ã§ãƒãƒƒã‚¸ã‚’æ›´æ–°
    async function initAnnouncements() {
      try {
        await loadAnnouncements();
      } catch (error) {
        console.error('ãŠçŸ¥ã‚‰ã›åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // åŸºæœ¬æƒ…å ±ã‚’é–‹ã
    window.openBasicInfo = function() {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'navigate', page: 'config-basic' }, '*');
      } else {
        window.location.href = '/config.html?tab=system';
      }
    };

    // æˆ»ã‚‹ï¼ˆå±¥æ­´ãƒ™ãƒ¼ã‚¹ï¼‰
    window.goBack = function() {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'goBack' }, '*');
      } else {
        window.history.back();
      }
    };

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    function showLoading(show) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, char => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[char]));
    }

    // åˆæœŸåŒ–å®Ÿè¡Œ
    init();
  </script>
</body>
</html>
