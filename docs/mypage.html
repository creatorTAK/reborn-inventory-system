<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base target="_top">
  <title>ãƒã‚¤ãƒšãƒ¼ã‚¸ - FURIRA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/reborn-theme.css?v=303">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    .content-container {
      padding: 16px;
      max-width: 600px;
      margin: 0 auto;
    }

    /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ */
    .profile-card {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 16px;
      color: white;
      text-align: center;
    }
    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px;
      font-size: 40px;
      border: 3px solid rgba(255,255,255,0.5);
      overflow: hidden;
    }
    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .profile-name {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .profile-role {
      font-size: 14px;
      opacity: 0.9;
    }
    .profile-month {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 8px;
    }

    /* å ±é…¬ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ */
    .compensation-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .compensation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .compensation-title {
      font-size: 14px;
      color: #6b7280;
      font-weight: 600;
    }
    .compensation-amount {
      font-size: 32px;
      font-weight: 800;
      color: #1f2937;
      margin-bottom: 4px;
    }
    .compensation-goal {
      font-size: 14px;
      color: #6b7280;
    }
    .compensation-goal .goal-amount {
      color: #40B4E5;
      font-weight: 600;
    }

    /* é€²æ—ãƒãƒ¼ */
    .progress-container {
      margin: 16px 0;
    }
    .progress-bar-bg {
      height: 12px;
      background: #e5e7eb;
      border-radius: 6px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #40B4E5 0%, #10b981 100%);
      border-radius: 6px;
      transition: width 0.5s ease;
    }
    .progress-text {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 12px;
      color: #6b7280;
    }
    .progress-percent {
      font-weight: 700;
      color: #40B4E5;
    }

    /* å†…è¨³ã‚«ãƒ¼ãƒ‰ */
    .breakdown-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .breakdown-title {
      font-size: 14px;
      color: #374151;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .breakdown-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    .breakdown-item:last-child {
      border-bottom: none;
    }
    .breakdown-label {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .breakdown-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .breakdown-icon.listing {
      background: #dbeafe;
    }
    .breakdown-icon.shipping {
      background: #fef3c7;
    }
    .breakdown-name {
      font-size: 14px;
      color: #374151;
      font-weight: 500;
    }
    .breakdown-count {
      font-size: 12px;
      color: #9ca3af;
    }
    .breakdown-amount {
      font-size: 16px;
      font-weight: 700;
      color: #1f2937;
    }

    /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰ */
    .ranking-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .ranking-title {
      font-size: 14px;
      color: #374151;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .ranking-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      border-radius: 10px;
      margin-bottom: 8px;
      background: #f9fafb;
    }
    .ranking-item.highlight {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 2px solid #f59e0b;
    }
    .ranking-position {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      margin-right: 12px;
    }
    .ranking-position.gold {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: white;
    }
    .ranking-position.silver {
      background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
      color: white;
    }
    .ranking-position.bronze {
      background: linear-gradient(135deg, #f59e0b 0%, #b45309 100%);
      color: white;
    }
    .ranking-position.normal {
      background: #e5e7eb;
      color: #6b7280;
    }
    .ranking-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
      font-weight: 500;
    }
    .ranking-name.me {
      color: #b45309;
      font-weight: 700;
    }
    .ranking-amount {
      font-size: 14px;
      font-weight: 700;
      color: #40B4E5;
    }

    /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 8px;
    }
    .action-btn {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .action-btn:hover {
      background: #f9fafb;
      border-color: #40B4E5;
    }
    .action-btn:active {
      transform: scale(0.98);
    }
    .action-btn i {
      font-size: 24px;
      color: #40B4E5;
      margin-bottom: 8px;
      display: block;
    }
    .action-btn span {
      font-size: 13px;
      color: #374151;
      font-weight: 500;
    }

    /* ç›®æ¨™è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
    .goal-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .goal-modal {
      background: white;
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .goal-modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 16px;
      text-align: center;
    }
    .goal-input-group {
      margin-bottom: 20px;
    }
    .goal-input-group label {
      display: block;
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    .goal-input-wrapper {
      display: flex;
      align-items: center;
      background: #f3f4f6;
      border-radius: 10px;
      padding: 12px 16px;
    }
    .goal-input-wrapper span {
      font-size: 18px;
      color: #6b7280;
      margin-right: 8px;
    }
    .goal-input-wrapper input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
      outline: none;
      text-align: right;
    }
    .goal-presets {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .goal-preset-btn {
      padding: 8px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 20px;
      background: white;
      font-size: 13px;
      color: #374151;
      cursor: pointer;
    }
    .goal-preset-btn:hover {
      border-color: #40B4E5;
      color: #40B4E5;
    }
    .goal-modal-buttons {
      display: flex;
      gap: 12px;
    }
    .goal-modal-buttons button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .goal-cancel-btn {
      background: #f3f4f6;
      border: none;
      color: #6b7280;
    }
    .goal-save-btn {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      border: none;
      color: white;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    /* éå¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .not-eligible {
      text-align: center;
      padding: 40px 20px;
    }
    .not-eligible i {
      font-size: 64px;
      color: #d1d5db;
      margin-bottom: 16px;
    }
    .not-eligible h3 {
      font-size: 18px;
      color: #374151;
      margin-bottom: 8px;
    }
    .not-eligible p {
      font-size: 14px;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>
  </div>

  <!-- çµ±ä¸€ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <div class="header-content">
      <button class="back-button" onclick="goBack()">
        <i class="bi bi-chevron-left"></i>
      </button>
      <div class="header-title">
        <i class="bi bi-person"></i>
        ãƒã‚¤ãƒšãƒ¼ã‚¸
      </div>
      <div class="header-actions">
        <button class="menu-button" onclick="window.parent.postMessage({type:'toggleDrawer'}, '*')" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
          <i class="bi bi-list"></i>
        </button>
      </div>
    </div>
  </div>

  <div class="content-container" id="mainContent">
    <!-- å‹•çš„ã«è¡¨ç¤º -->
  </div>

  <!-- ç›®æ¨™è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="goal-modal-backdrop" id="goalModal">
    <div class="goal-modal">
      <div class="goal-modal-title">ğŸ¯ ä»Šæœˆã®ç›®æ¨™é‡‘é¡ã‚’è¨­å®š</div>
      <div class="goal-input-group">
        <label>ç›®æ¨™é‡‘é¡</label>
        <div class="goal-input-wrapper">
          <span>Â¥</span>
          <input type="number" id="goalAmountInput" placeholder="10000" step="1000">
        </div>
      </div>
      <div class="goal-presets">
        <button class="goal-preset-btn" onclick="setGoalPreset(5000)">Â¥5,000</button>
        <button class="goal-preset-btn" onclick="setGoalPreset(10000)">Â¥10,000</button>
        <button class="goal-preset-btn" onclick="setGoalPreset(20000)">Â¥20,000</button>
        <button class="goal-preset-btn" onclick="setGoalPreset(30000)">Â¥30,000</button>
        <button class="goal-preset-btn" onclick="setGoalPreset(50000)">Â¥50,000</button>
      </div>
      <div class="goal-modal-buttons">
        <button class="goal-cancel-btn" onclick="closeGoalModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="goal-save-btn" onclick="saveGoal()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, getDoc, setDoc, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "furira.jp",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let currentUser = null;
    let compensationRecords = [];
    let compensationSettings = {};
    let userGoal = 0;

    // åˆæœŸåŒ–
    async function init() {
      showLoading(true);

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
      currentUser = {
        email: localStorage.getItem('reborn_user_email') || '',
        name: localStorage.getItem('reborn_user_name') || 'ã‚²ã‚¹ãƒˆ',
        permissionId: localStorage.getItem('reborn_user_permission_id') || 'staff',
        permissionDisplay: localStorage.getItem('reborn_user_permission_display') || 'ã‚¹ã‚¿ãƒƒãƒ•',
        photoURL: localStorage.getItem('reborn_user_icon_url') || localStorage.getItem('reborn_user_photo_url') || ''
      };

      if (!currentUser.email) {
        showNotEligible('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
        showLoading(false);
        return;
      }

      try {
        // å ±é…¬è¨­å®šã‚’å–å¾—
        await loadCompensationSettings();

        // å ±é…¬å¯¾è±¡è€…ã‹ãƒã‚§ãƒƒã‚¯
        const isEligible = await checkEligibility();

        if (!isEligible) {
          showNotEligible('å ±é…¬å¯¾è±¡å¤–ã§ã™', 'ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯å ±é…¬ç®¡ç†ã®å¯¾è±¡å¤–ã§ã™ã€‚');
          showLoading(false);
          return;
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç›®æ¨™ã‚’å–å¾—
        await loadUserGoal();

        // å ±é…¬ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        await loadCompensationData();

        // ç”»é¢ã‚’æç”»
        renderMyPage();
      } catch (error) {
        console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        showNotEligible('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
      }

      showLoading(false);
    }

    // å ±é…¬è¨­å®šã‚’å–å¾—ï¼ˆlocalStorageã‹ã‚‰configçµŒç”±ï¼‰
    async function loadCompensationSettings() {
      try {
        // localStorageã‹ã‚‰configèª­ã¿è¾¼ã¿
        const configStr = localStorage.getItem('config');
        if (configStr) {
          const config = JSON.parse(configStr);
          if (config.å ±é…¬è¨­å®š) {
            compensationSettings = config.å ±é…¬è¨­å®š;
            console.log('å ±é…¬è¨­å®šã‚’èª­ã¿è¾¼ã¿:', compensationSettings);
            return;
          }
        }

        // Firestoreã‹ã‚‰ã‚‚å–å¾—è©¦è¡Œ
        const docRef = doc(db, 'settings', 'compensation');
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          compensationSettings = docSnap.data();
        } else {
          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
          compensationSettings = {
            taskRates: { listing: 100, shipping: 100, photography: 50, inspection: 30 },
            mypage: { enabled: true, allowedUsers: [] }
          };
        }
      } catch (error) {
        console.error('å ±é…¬è¨­å®šå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        compensationSettings = {
          taskRates: { listing: 100, shipping: 100 },
          mypage: { enabled: true, allowedUsers: [] }
        };
      }
    }

    // å ±é…¬å¯¾è±¡è€…ã‹ãƒã‚§ãƒƒã‚¯
    async function checkEligibility() {
      // ãƒã‚¤ãƒšãƒ¼ã‚¸æ©Ÿèƒ½ãŒç„¡åŠ¹ã®å ´åˆ
      if (compensationSettings.mypage && compensationSettings.mypage.enabled === false) {
        console.log('ãƒã‚¤ãƒšãƒ¼ã‚¸æ©Ÿèƒ½ãŒç„¡åŠ¹ã§ã™');
        return false;
      }

      // allowedUsersãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      const allowedUsers = compensationSettings.mypage?.allowedUsers || [];

      // allowedUsersãŒç©ºï¼ˆæœªè¨­å®šï¼‰ã®å ´åˆã¯å…¨å“¡è¨±å¯
      if (allowedUsers.length === 0) {
        console.log('ãƒã‚¤ãƒšãƒ¼ã‚¸: å…¨å“¡è¨±å¯ï¼ˆallowedUsersæœªè¨­å®šï¼‰');
        return true;
      }

      // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      const isAllowed = allowedUsers.includes(currentUser.email);
      console.log('ãƒã‚¤ãƒšãƒ¼ã‚¸æ¨©é™ãƒã‚§ãƒƒã‚¯:', currentUser.email, 'allowed:', isAllowed);

      return isAllowed;
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç›®æ¨™ã‚’å–å¾—
    async function loadUserGoal() {
      try {
        const now = new Date();
        const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const docRef = doc(db, 'userGoals', `${currentUser.email}_${yearMonth}`);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          userGoal = docSnap.data().goalAmount || 0;
        } else {
          userGoal = 10000; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç›®æ¨™
        }
      } catch (error) {
        console.error('ç›®æ¨™å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        userGoal = 10000;
      }
    }

    // å ±é…¬ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    async function loadCompensationData() {
      try {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;

        const recordsRef = collection(db, 'compensationRecords');
        const snapshot = await getDocs(recordsRef);

        compensationRecords = [];
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          compensationRecords.push({ id: docSnap.id, ...data });
        });

        // ä»Šæœˆã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
        compensationRecords = compensationRecords.filter(r => {
          if (!r.completedAt && !r.recordedAt) return false;
          const dateStr = r.completedAt || r.recordedAt;
          const date = typeof dateStr === 'string' ? new Date(dateStr) : (dateStr.toDate ? dateStr.toDate() : new Date(dateStr));
          return date.getFullYear() === year && (date.getMonth() + 1) === month;
        });
      } catch (error) {
        console.error('å ±é…¬ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        compensationRecords = [];
      }
    }

    // ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚’æç”»
    function renderMyPage() {
      const now = new Date();
      const monthName = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ`;

      // è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
      const myRecords = compensationRecords.filter(r => r.staffEmail === currentUser.email);
      const myStats = calculateStats(myRecords);

      // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
      const rankingData = calculateRanking();
      const myRank = rankingData.findIndex(r => r.email === currentUser.email) + 1;

      // é€²æ—ç‡ã‚’è¨ˆç®—
      const progressPercent = userGoal > 0 ? Math.min(100, Math.round((myStats.totalAmount / userGoal) * 100)) : 0;

      // ã‚¢ãƒã‚¿ãƒ¼
      const avatarHtml = currentUser.photoURL
        ? `<img src="${currentUser.photoURL}" alt="ã‚¢ãƒã‚¿ãƒ¼">`
        : 'ğŸ‘¤';

      const html = `
        <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ -->
        <div class="profile-card">
          <div class="profile-avatar">${avatarHtml}</div>
          <div class="profile-name">${escapeHtml(currentUser.name)}ã•ã‚“</div>
          <div class="profile-role">${escapeHtml(currentUser.permissionDisplay)}</div>
          <div class="profile-month">${monthName}</div>
        </div>

        <!-- å ±é…¬ã‚µãƒãƒªãƒ¼ -->
        <div class="compensation-card">
          <div class="compensation-header">
            <div class="compensation-title">ğŸ’° ä»Šæœˆã®å ±é…¬</div>
          </div>
          <div class="compensation-amount">Â¥${myStats.totalAmount.toLocaleString()}</div>
          <div class="compensation-goal">
            ç›®æ¨™: <span class="goal-amount">Â¥${userGoal.toLocaleString()}</span>
          </div>
          <div class="progress-container">
            <div class="progress-bar-bg">
              <div class="progress-bar-fill" style="width: ${progressPercent}%"></div>
            </div>
            <div class="progress-text">
              <span>é”æˆç‡</span>
              <span class="progress-percent">${progressPercent}%</span>
            </div>
          </div>
        </div>

        <!-- å†…è¨³ -->
        <div class="breakdown-card">
          <div class="breakdown-title"><i class="bi bi-pie-chart"></i> å†…è¨³</div>
          <div class="breakdown-item">
            <div class="breakdown-label">
              <div class="breakdown-icon listing">ğŸ“¦</div>
              <div>
                <div class="breakdown-name">å•†å“å‡ºå“</div>
                <div class="breakdown-count">${myStats.listingCount}ä»¶</div>
              </div>
            </div>
            <div class="breakdown-amount">Â¥${myStats.listingAmount.toLocaleString()}</div>
          </div>
          <div class="breakdown-item">
            <div class="breakdown-label">
              <div class="breakdown-icon shipping">ğŸšš</div>
              <div>
                <div class="breakdown-name">æ¢±åŒ…ãƒ»ç™ºé€</div>
                <div class="breakdown-count">${myStats.shippingCount}ä»¶</div>
              </div>
            </div>
            <div class="breakdown-amount">Â¥${myStats.shippingAmount.toLocaleString()}</div>
          </div>
        </div>

        <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
        <div class="ranking-card">
          <div class="ranking-title"><i class="bi bi-trophy"></i> ä»Šæœˆã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
          ${renderRankingList(rankingData, currentUser.email)}
        </div>

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
        <div class="action-buttons">
          <div class="action-btn" onclick="openBasicInfo()">
            <i class="bi bi-gear"></i>
            <span>åŸºæœ¬æƒ…å ±</span>
          </div>
          <div class="action-btn" onclick="openGoalModal()">
            <i class="bi bi-bullseye"></i>
            <span>ç›®æ¨™è¨­å®š</span>
          </div>
        </div>
      `;

      document.getElementById('mainContent').innerHTML = html;
    }

    // çµ±è¨ˆã‚’è¨ˆç®—
    function calculateStats(records) {
      let listingCount = 0;
      let listingAmount = 0;
      let shippingCount = 0;
      let shippingAmount = 0;

      records.forEach(r => {
        const taskType = r.taskTypeKey || r.taskType || '';
        const amount = r.unitPrice || 0;

        if (taskType === 'listing' || taskType === 'listing_approval') {
          listingCount++;
          listingAmount += amount;
        } else if (taskType === 'shipping' || taskType === 'shipping_task') {
          shippingCount++;
          shippingAmount += amount;
        }
      });

      return {
        listingCount,
        listingAmount,
        shippingCount,
        shippingAmount,
        totalAmount: listingAmount + shippingAmount,
        totalCount: listingCount + shippingCount
      };
    }

    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¨ˆç®—
    function calculateRanking() {
      const staffStats = {};

      compensationRecords.forEach(r => {
        const email = r.staffEmail || '';
        const name = r.staffName || 'ä¸æ˜';
        const amount = r.unitPrice || 0;

        if (!email) return;

        if (!staffStats[email]) {
          staffStats[email] = { email, name, totalAmount: 0 };
        }
        staffStats[email].totalAmount += amount;
      });

      // é‡‘é¡ã§ã‚½ãƒ¼ãƒˆ
      const ranking = Object.values(staffStats).sort((a, b) => b.totalAmount - a.totalAmount);

      return ranking;
    }

    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒªã‚¹ãƒˆã‚’æç”»
    function renderRankingList(rankingData, myEmail) {
      if (rankingData.length === 0) {
        return '<div class="text-center text-muted py-3">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      }

      // ä¸Šä½3å + è‡ªåˆ†ã®ä½ç½®ã‚’è¡¨ç¤º
      const myRankIndex = rankingData.findIndex(r => r.email === myEmail);
      const displayItems = [];

      // ä¸Šä½3å
      for (let i = 0; i < Math.min(3, rankingData.length); i++) {
        displayItems.push({ ...rankingData[i], rank: i + 1 });
      }

      // è‡ªåˆ†ãŒ4ä½ä»¥ä¸‹ãªã‚‰è¿½åŠ 
      if (myRankIndex >= 3) {
        // åŒºåˆ‡ã‚Šç·šã®ä»£ã‚ã‚Šã«...ã‚’è¿½åŠ 
        displayItems.push({ separator: true });
        displayItems.push({ ...rankingData[myRankIndex], rank: myRankIndex + 1 });
      }

      return displayItems.map(item => {
        if (item.separator) {
          return '<div class="text-center text-muted py-1">â‹®</div>';
        }

        const isMe = item.email === myEmail;
        const positionClass = item.rank === 1 ? 'gold' : item.rank === 2 ? 'silver' : item.rank === 3 ? 'bronze' : 'normal';
        const highlightClass = isMe ? 'highlight' : '';
        const nameClass = isMe ? 'me' : '';
        const displayName = isMe ? `â˜… ${item.name}` : item.name;

        return `
          <div class="ranking-item ${highlightClass}">
            <div class="ranking-position ${positionClass}">${item.rank}</div>
            <div class="ranking-name ${nameClass}">${escapeHtml(displayName)}</div>
            <div class="ranking-amount">Â¥${item.totalAmount.toLocaleString()}</div>
          </div>
        `;
      }).join('');
    }

    // éå¯¾è±¡è€…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    function showNotEligible(title, message) {
      document.getElementById('mainContent').innerHTML = `
        <div class="not-eligible">
          <i class="bi bi-person-x"></i>
          <h3>${escapeHtml(title)}</h3>
          <p>${escapeHtml(message)}</p>
          <div class="action-buttons mt-4">
            <div class="action-btn" onclick="openBasicInfo()">
              <i class="bi bi-gear"></i>
              <span>åŸºæœ¬æƒ…å ±</span>
            </div>
          </div>
        </div>
      `;
    }

    // ç›®æ¨™è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.openGoalModal = function() {
      document.getElementById('goalAmountInput').value = userGoal || '';
      document.getElementById('goalModal').style.display = 'flex';
    };

    // ç›®æ¨™è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeGoalModal = function() {
      document.getElementById('goalModal').style.display = 'none';
    };

    // ãƒ—ãƒªã‚»ãƒƒãƒˆé‡‘é¡ã‚’è¨­å®š
    window.setGoalPreset = function(amount) {
      document.getElementById('goalAmountInput').value = amount;
    };

    // ç›®æ¨™ã‚’ä¿å­˜
    window.saveGoal = async function() {
      const goalAmount = parseInt(document.getElementById('goalAmountInput').value) || 0;

      if (goalAmount < 0) {
        alert('ç›®æ¨™é‡‘é¡ã¯0ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      try {
        showLoading(true);

        const now = new Date();
        const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const docRef = doc(db, 'userGoals', `${currentUser.email}_${yearMonth}`);

        await setDoc(docRef, {
          email: currentUser.email,
          name: currentUser.name,
          yearMonth: yearMonth,
          goalAmount: goalAmount,
          updatedAt: new Date().toISOString()
        });

        userGoal = goalAmount;
        closeGoalModal();
        renderMyPage();

        showLoading(false);
      } catch (error) {
        console.error('ç›®æ¨™ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        showLoading(false);
      }
    };

    // åŸºæœ¬æƒ…å ±ã‚’é–‹ã
    window.openBasicInfo = function() {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'navigate', page: 'config-basic' }, '*');
      } else {
        window.location.href = '/config.html?tab=system';
      }
    };

    // æˆ»ã‚‹ï¼ˆå±¥æ­´ãƒ™ãƒ¼ã‚¹ï¼‰
    window.goBack = function() {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'goBack' }, '*');
      } else {
        window.history.back();
      }
    };

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    function showLoading(show) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, char => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[char]));
    }

    // åˆæœŸåŒ–å®Ÿè¡Œ
    init();
  </script>
</body>
</html>
