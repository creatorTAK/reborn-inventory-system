<!DOCTYPE html>
<html>
<head>
  <!-- Cache Bust: 2025-12-22-v355 - 設定統合（個人情報・通知設定・アイコン編集） -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base target="_top">
  <title>マイページ - FURIRA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/reborn-theme.css?v=298">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    .content-container {
      padding: 16px;
      max-width: 600px;
      margin: 0 auto;
    }

    /* プロフィールカード */
    .profile-card {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      border-radius: 16px;
      padding: 24px;
      background-size: cover;
      background-position: center center;
      margin-bottom: 16px;
      color: white;
      text-align: center;
      position: relative;
      background-size: cover;
      background-position: center;
    }
    /* 背景編集ボタン */
    .profile-bg-edit-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.25);
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      backdrop-filter: blur(4px);
    }
    .profile-bg-edit-btn:hover {
      background: rgba(255, 255, 255, 0.4);
    }
    .profile-bg-edit-btn:active {
      transform: scale(0.95);
    }
    /* 背景選択モーダル */
    .bg-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .bg-modal-backdrop.active {
      display: flex;
    }
    .bg-modal {
      background: white;
      border-radius: 20px;
      width: 90%;
      max-width: 360px;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .bg-modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .bg-modal-title {
      font-size: 17px;
      font-weight: 600;
      color: #1f2937;
    }
    .bg-modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: #f3f4f6;
      border-radius: 50%;
      font-size: 18px;
      color: #6b7280;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .bg-modal-body {
      padding: 20px;
      max-height: 60vh;
      overflow-y: auto;
    }
    .bg-section-title {
      font-size: 13px;
      color: #6b7280;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .bg-gradient-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }
    .bg-gradient-item {
      aspect-ratio: 1;
      border-radius: 12px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s;
      position: relative;
    }
    .bg-gradient-item:hover {
      transform: scale(1.05);
    }
    .bg-gradient-item.selected {
      border-color: #1f2937;
    }
    .bg-gradient-item.selected::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      color: #1f2937;
    }
    .bg-image-upload {
      margin-top: 16px;
    }
    .bg-upload-btn {
      width: 100%;
      padding: 14px;
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      background: #f9fafb;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 14px;
      color: #6b7280;
      transition: all 0.2s;
    }
    .bg-upload-btn:hover {
      border-color: #40B4E5;
      color: #40B4E5;
      background: #f0f9ff;
    }
    .bg-upload-btn i {
      font-size: 20px;
    }
    .bg-preview {
      margin-top: 16px;
      display: none;
    }
    .bg-preview.active {
      display: block;
    }
    .bg-position-adjuster {
      position: relative;
      width: 100%;
      height: 140px;
      border-radius: 12px;
      overflow: hidden;
      cursor: grab;
      background-color: #f0f0f0;
      margin-bottom: 8px;
    }
    .bg-position-adjuster:active {
      cursor: grabbing;
    }
    .bg-preview-image {
      width: 100%;
      height: auto;
      min-height: 100%;
      object-fit: cover;
      position: absolute;
      left: 0;
      top: 0;
      pointer-events: none;
      transition: none;
    }
    .bg-position-hint {
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      color: white;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 12px;
      pointer-events: none;
    }
    .bg-position-reset {
      text-align: center;
      margin-bottom: 8px;
    }
    .bg-position-reset-btn {
      font-size: 12px;
      color: #6b7280;
      background: none;
      border: none;
      cursor: pointer;
    }
    .bg-position-reset-btn:hover {
      color: #374151;
    }
    .bg-preview-remove {
      font-size: 13px;
      color: #ef4444;
      background: none;
      border: none;
      cursor: pointer;
    }
    .bg-modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 12px;
    }
    .bg-modal-footer button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .bg-cancel-btn {
      background: #f3f4f6;
      border: none;
      color: #6b7280;
    }
    .bg-save-btn {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      border: none;
      color: white;
    }
    .bg-save-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* 設定モーダル共通 */
    .settings-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .settings-modal-backdrop.active {
      display: flex;
    }
    .settings-modal {
      background: white;
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
      max-height: 85vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .settings-modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .settings-modal-title {
      font-size: 17px;
      font-weight: 600;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .settings-modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: #f3f4f6;
      border-radius: 50%;
      font-size: 18px;
      color: #6b7280;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .settings-modal-body {
      padding: 20px;
      max-height: 60vh;
      overflow-y: auto;
    }
    .settings-section {
      margin-bottom: 20px;
    }
    .settings-section:last-child {
      margin-bottom: 0;
    }
    .settings-section-title {
      font-size: 13px;
      color: #6b7280;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .settings-input-group {
      margin-bottom: 16px;
    }
    .settings-input-group:last-child {
      margin-bottom: 0;
    }
    .settings-input-label {
      display: block;
      font-size: 14px;
      color: #374151;
      font-weight: 500;
      margin-bottom: 6px;
    }
    .settings-input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      font-size: 15px;
      transition: border-color 0.2s;
    }
    .settings-input:focus {
      outline: none;
      border-color: #40B4E5;
    }
    .settings-textarea {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      font-size: 15px;
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
    }
    .settings-textarea:focus {
      outline: none;
      border-color: #40B4E5;
    }
    .settings-toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    .settings-toggle-row:last-child {
      border-bottom: none;
    }
    .settings-toggle-label {
      font-size: 15px;
      color: #1f2937;
    }
    .settings-toggle {
      position: relative;
      width: 50px;
      height: 28px;
    }
    .settings-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .settings-toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #d1d5db;
      transition: .3s;
      border-radius: 28px;
    }
    .settings-toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .settings-toggle input:checked + .settings-toggle-slider {
      background-color: #40B4E5;
    }
    .settings-toggle input:checked + .settings-toggle-slider:before {
      transform: translateX(22px);
    }
    .settings-modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 12px;
    }
    .settings-modal-footer button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .settings-cancel-btn {
      background: #f3f4f6;
      border: none;
      color: #6b7280;
    }
    .settings-save-btn {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      border: none;
      color: white;
    }
    .settings-save-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* プロフィール編集可能スタイル */
    .profile-avatar-editable {
      cursor: pointer;
      position: relative;
    }
    .profile-avatar-editable:hover::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      border-radius: 50%;
    }
    .profile-avatar-editable:hover::before {
      content: '\f030';
      font-family: 'bootstrap-icons';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 24px;
      z-index: 1;
    }
    .profile-name-editable {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .profile-name-editable:hover {
      text-decoration: underline;
    }
    .profile-name-edit-icon {
      font-size: 14px;
      opacity: 0.7;
    }

    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px;
      font-size: 40px;
      border: none;
      overflow: hidden;
    }
    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .profile-avatar {
      position: relative;
    }
    .profile-avatar-edit-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.5);
      color: white;
      font-size: 14px;
      padding: 4px 0;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .profile-avatar:hover .profile-avatar-edit-overlay {
      opacity: 1;
    }
    .profile-name {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .profile-name .edit-icon {
      font-size: 12px;
      opacity: 0.7;
      margin-left: 4px;
      position: absolute;
    }
    .profile-role {
      font-size: 13px;
      background: transparent;
      padding: 4px 12px;
      border-radius: 12px;
      display: block;
    }
    .profile-month {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 8px;
    }

    /* 報酬サマリーカード */
    .compensation-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .compensation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .compensation-title {
      font-size: 14px;
      color: #6b7280;
      font-weight: 600;
    }
    .compensation-amount {
      font-size: 32px;
      font-weight: 800;
      color: #1f2937;
      margin-bottom: 4px;
    }
    .compensation-goal {
      font-size: 14px;
      color: #6b7280;
    }
    .compensation-goal .goal-amount {
      color: #40B4E5;
      font-weight: 600;
    }

    /* 進捗バー */
    .progress-container {
      margin: 16px 0;
    }
    .progress-bar-bg {
      height: 12px;
      background: #e5e7eb;
      border-radius: 6px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #40B4E5 0%, #10b981 100%);
      border-radius: 6px;
      transition: width 0.5s ease;
    }
    .progress-text {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 12px;
      color: #6b7280;
    }
    .progress-percent {
      font-weight: 700;
      color: #40B4E5;
    }

    /* 進捗吹き出し */
    .progress-milestone {
      margin-top: 12px;
      padding: 10px 14px;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 12px;
      font-size: 13px;
      color: #92400e;
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .progress-milestone::before {
      content: '';
      position: absolute;
      top: -6px;
      left: 20px;
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 6px solid #fef3c7;
    }
    .progress-milestone.milestone-50 {
      background: linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%);
      color: #1e40af;
    }
    .progress-milestone.milestone-50::before {
      border-bottom-color: #dbeafe;
    }
    .progress-milestone.milestone-80 {
      background: linear-gradient(135deg, #d1fae5 0%, #6ee7b7 100%);
      color: #065f46;
    }
    .progress-milestone.milestone-80::before {
      border-bottom-color: #d1fae5;
    }
    .progress-milestone.milestone-100 {
      background: linear-gradient(135deg, #fce7f3 0%, #f9a8d4 100%);
      color: #9d174d;
    }
    .progress-milestone.milestone-100::before {
      border-bottom-color: #fce7f3;
    }

    /* 内訳カード */
    .breakdown-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .breakdown-title {
      font-size: 14px;
      color: #374151;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .breakdown-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    .breakdown-item:last-child {
      border-bottom: none;
    }
    .breakdown-label {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .breakdown-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .breakdown-icon.listing {
      background: #dbeafe;
    }
    .breakdown-icon.shipping {
      background: #fef3c7;
    }
    .breakdown-name {
      font-size: 14px;
      color: #374151;
      font-weight: 500;
    }
    .breakdown-count {
      font-size: 12px;
      color: #9ca3af;
    }
    .breakdown-amount {
      font-size: 16px;
      font-weight: 700;
      color: #1f2937;
    }

    /* ランキングカード */
    .ranking-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .ranking-title {
      font-size: 14px;
      color: #374151;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .ranking-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      border-radius: 10px;
      margin-bottom: 8px;
      background: #f9fafb;
    }
    .ranking-item.highlight {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 2px solid #f59e0b;
    }
    .ranking-position {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      margin-right: 12px;
    }
    .ranking-position.gold {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: white;
    }
    .ranking-position.silver {
      background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
      color: white;
    }
    .ranking-position.bronze {
      background: linear-gradient(135deg, #f59e0b 0%, #b45309 100%);
      color: white;
    }
    .ranking-position.normal {
      background: #e5e7eb;
      color: #6b7280;
    }
    .ranking-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
      font-weight: 500;
    }
    .ranking-name.me {
      color: #b45309;
      font-weight: 700;
    }
    .ranking-amount {
      font-size: 14px;
      font-weight: 700;
      color: #40B4E5;
    }
    .ranking-opt-out-message {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      background: #f3f4f6;
      border-radius: 10px;
      color: #6b7280;
      font-size: 14px;
      margin-bottom: 8px;
    }
    .ranking-opt-out-message i {
      font-size: 18px;
    }

    /* アクションボタン */
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 8px;
    }
    .action-btn {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .action-btn:hover {
      background: #f9fafb;
      border-color: #40B4E5;
    }
    .action-btn:active {
      transform: scale(0.98);
    }
    .action-btn i {
      font-size: 24px;
      color: #40B4E5;
      margin-bottom: 8px;
      display: block;
    }
    .action-btn span {
      font-size: 13px;
      color: #374151;
      font-weight: 500;
    }

    /* 目標設定モーダル */
    .goal-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .goal-modal {
      background: white;
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .goal-modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 16px;
      text-align: center;
    }
    .goal-input-group {
      margin-bottom: 20px;
    }
    .goal-input-group label {
      display: block;
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    .goal-input-wrapper {
      display: flex;
      align-items: center;
      background: #f3f4f6;
      border-radius: 10px;
      padding: 12px 16px;
    }
    .goal-input-wrapper span {
      font-size: 18px;
      color: #6b7280;
      margin-right: 8px;
    }
    .goal-input-wrapper input {
      flex: 1;
      min-width: 0;
      border: none;
      background: transparent;
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
      outline: none;
      text-align: right;
    }
    .goal-presets {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .goal-preset-btn {
      padding: 8px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 20px;
      background: white;
      font-size: 13px;
      color: #374151;
      cursor: pointer;
    }
    .goal-preset-btn:hover {
      border-color: #40B4E5;
      color: #40B4E5;
    }
    .goal-skip-option {
      margin-bottom: 20px;
      text-align: center;
    }
    .goal-skip-btn {
      padding: 10px 20px;
      border: 1px solid #9ca3af;
      border-radius: 8px;
      background: #f9fafb;
      font-size: 13px;
      color: #6b7280;
      cursor: pointer;
      width: 100%;
    }
    .goal-skip-btn:hover {
      background: #f3f4f6;
      border-color: #6b7280;
    }
    .ranking-option {
      margin-bottom: 20px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
    }
    .ranking-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }
    .ranking-toggle input {
      display: none;
    }
    .toggle-slider {
      width: 44px;
      height: 24px;
      background: #d1d5db;
      border-radius: 12px;
      position: relative;
      transition: background 0.2s;
      flex-shrink: 0;
    }
    .toggle-slider::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: transform 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .ranking-toggle input:checked + .toggle-slider {
      background: #40B4E5;
    }
    .ranking-toggle input:checked + .toggle-slider::after {
      transform: translateX(20px);
    }
    .toggle-label {
      font-size: 14px;
      color: #374151;
      font-weight: 500;
    }
    .ranking-option-note {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 8px;
      padding-left: 56px;
    }
    .goal-modal-buttons {
      display: flex;
      gap: 12px;
    }
    .goal-modal-buttons button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .goal-cancel-btn {
      background: #f3f4f6;
      border: none;
      color: #6b7280;
    }
    .goal-save-btn {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      border: none;
      color: white;
    }

    /* 目標履歴モーダル */
    .history-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .history-modal {
      background: white;
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .history-modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 16px;
      text-align: center;
    }
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .history-item {
      background: #f9fafb;
      border-radius: 12px;
      padding: 16px;
      border-left: 4px solid #40B4E5;
    }
    .history-item.achieved {
      border-left-color: #10b981;
    }
    .history-item.not-achieved {
      border-left-color: #ef4444;
    }
    .history-month {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }
    .history-amounts {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .history-goal, .history-actual {
      font-size: 13px;
      color: #6b7280;
    }
    .history-goal span, .history-actual span {
      font-weight: 600;
      color: #1f2937;
    }
    .history-progress {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .history-progress-bar {
      flex: 1;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
    }
    .history-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #40B4E5, #1E8FBF);
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    .history-progress-fill.achieved {
      background: linear-gradient(90deg, #10b981, #059669);
    }
    .history-percent {
      font-size: 14px;
      font-weight: 700;
      color: #40B4E5;
      min-width: 45px;
      text-align: right;
    }
    .history-percent.achieved {
      color: #10b981;
    }
    .history-empty {
      text-align: center;
      padding: 32px 16px;
      color: #9ca3af;
    }
    .history-empty i {
      font-size: 48px;
      margin-bottom: 12px;
      display: block;
    }
    .history-close-btn {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: #f3f4f6;
      border: none;
      color: #6b7280;
      margin-top: 16px;
    }
    /* 履歴詳細セクション */
    .history-details {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }
    .history-breakdown {
      display: flex;
      gap: 12px;
      margin-bottom: 8px;
    }
    .history-breakdown-item {
      flex: 1;
      background: white;
      padding: 8px;
      border-radius: 8px;
      text-align: center;
    }
    .history-breakdown-icon {
      font-size: 16px;
      margin-bottom: 4px;
    }
    .history-breakdown-label {
      font-size: 10px;
      color: #9ca3af;
    }
    .history-breakdown-value {
      font-size: 12px;
      font-weight: 600;
      color: #374151;
    }
    .history-ranking {
      background: white;
      padding: 8px 12px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .history-ranking-label {
      font-size: 12px;
      color: #6b7280;
    }
    .history-ranking-value {
      font-size: 14px;
      font-weight: 700;
      color: #f59e0b;
    }
    .history-toggle {
      font-size: 11px;
      color: #40B4E5;
      cursor: pointer;
      text-align: center;
      margin-top: 8px;
    }

    /* お知らせモーダル */
    .announce-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .announce-modal {
      background: white;
      border-radius: 16px;
      padding: 0;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .announce-modal-header {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      color: white;
      padding: 16px 20px;
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .announce-modal-body {
      padding: 0;
      max-height: 60vh;
      overflow-y: auto;
    }
    .announce-list {
      display: flex;
      flex-direction: column;
    }
    .announce-item {
      padding: 16px 20px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s;
    }
    .announce-item:hover {
      background: #f9fafb;
    }
    .announce-item.unread {
      background: #eff6ff;
    }
    .announce-item.unread:hover {
      background: #dbeafe;
    }
    .announce-item-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .announce-priority {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
    }
    .announce-priority.important {
      background: #fef2f2;
      color: #dc2626;
    }
    .announce-priority.normal {
      background: #f0f9ff;
      color: #0284c7;
    }
    .announce-date {
      font-size: 12px;
      color: #9ca3af;
    }
    .announce-title {
      font-size: 15px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }
    .announce-preview {
      font-size: 13px;
      color: #6b7280;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .announce-empty {
      text-align: center;
      padding: 40px 20px;
      color: #9ca3af;
    }
    .announce-empty i {
      font-size: 48px;
      margin-bottom: 12px;
      display: block;
    }
    .announce-modal-footer {
      padding: 12px 20px;
      border-top: 1px solid #f0f0f0;
    }
    .announce-close-btn {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: #f3f4f6;
      border: none;
      color: #6b7280;
    }
    /* お知らせ詳細 */
    .announce-detail {
      padding: 20px;
    }
    .announce-detail-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 8px;
    }
    .announce-detail-meta {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .announce-detail-body {
      font-size: 14px;
      color: #374151;
      line-height: 1.7;
      white-space: pre-wrap;
    }
    .announce-back-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 14px;
      color: #40B4E5;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      margin-bottom: 16px;
    }

    /* ノート機能 */
    .notes-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      z-index: 1100;
    }
    .notes-modal-backdrop.active {
      display: block;
    }
    .notes-modal {
      position: fixed;
      top: 0;
      right: -100%;
      width: 100%;
      height: 100%;
      background: #f8f9fa;
      z-index: 1101;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    .notes-modal.active {
      right: 0;
    }
    .notes-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: white;
      border-bottom: 1px solid #e5e7eb;
    }
    .notes-modal-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .notes-back-btn {
      background: none;
      border: none;
      font-size: 20px;
      color: #6b7280;
      cursor: pointer;
      padding: 4px;
    }
    .notes-modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
    }
    .notes-add-btn {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      color: white;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .notes-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    .notes-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .note-item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .note-item:active {
      transform: scale(0.98);
    }
    .note-item-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .note-item-icon {
      font-size: 20px;
      color: #f59e0b;
    }
    .note-item-title {
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .note-item-date {
      font-size: 12px;
      color: #9ca3af;
    }
    .note-item-preview {
      font-size: 13px;
      color: #6b7280;
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .notes-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      color: #9ca3af;
    }
    .notes-empty i {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    .notes-empty-text {
      font-size: 15px;
      text-align: center;
      line-height: 1.6;
    }

    /* ノート編集モーダル */
    .note-editor-modal {
      position: fixed;
      top: 0;
      right: -100%;
      width: 100%;
      height: 100%;
      background: white;
      z-index: 1200;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    .note-editor-modal.active {
      right: 0;
    }
    .note-editor-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: white;
      border-bottom: 1px solid #e5e7eb;
    }
    .note-editor-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .note-editor-header-right {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .note-editor-btn {
      background: none;
      border: none;
      padding: 8px;
      color: #6b7280;
      font-size: 18px;
      cursor: pointer;
      border-radius: 8px;
    }
    .note-editor-btn:hover {
      background: #f3f4f6;
    }
    .note-editor-btn.delete {
      color: #ef4444;
    }
    .note-editor-body {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .note-title-input {
      width: 100%;
      padding: 16px;
      font-size: 20px;
      font-weight: 700;
      border: none;
      outline: none;
      background: transparent;
    }
    .note-title-input::placeholder {
      color: #9ca3af;
    }
    .note-blocks-container {
      flex: 1;
      padding: 0 16px 120px;
      min-height: 200px;
    }
    /* 罫線タイプ */
    .note-blocks-container.paper-lined {
      background-image: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 31px,
        #e5e7eb 31px,
        #e5e7eb 32px
      );
      background-position: 0 16px;
    }
    .note-blocks-container.paper-grid {
      background-image:
        linear-gradient(#e5e7eb 1px, transparent 1px),
        linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
      background-size: 24px 24px;
    }
    .note-block {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 8px 0;
      position: relative;
    }
    .block-drag-handle {
      cursor: grab;
      color: #9ca3af;
      font-size: 16px;
      padding: 12px 8px;
      user-select: none;
      touch-action: none;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      min-height: 40px;
      border-radius: 4px;
      transition: background 0.15s;
    }
    .block-drag-handle:hover {
      background: #f3f4f6;
      color: #6b7280;
    }
    .block-drag-handle:active {
      cursor: grabbing;
      background: #e5e7eb;
    }
    .block-content {
      flex: 1;
      min-width: 0;
    }
    .block-textarea {
      width: 100%;
      min-height: 44px;
      padding: 8px 12px;
      border: 1px solid transparent;
      border-radius: 8px;
      font-size: 16px; /* iOS zoom防止 */
      line-height: 1.6;
      resize: none;
      outline: none;
      background: transparent; /* 罫線が見えるように透明 */
      overflow: hidden; /* 自動リサイズ時にスクロールバー非表示 */
      transition: border-color 0.15s, background 0.15s;
    }
    .block-textarea:hover {
      border-color: #e5e7eb;
      background: rgba(255,255,255,0.5);
    }
    .block-textarea:focus {
      border-color: #40B4E5;
      background: rgba(255,255,255,0.8);
    }
    /* 見出しブロック */
    .block-heading {
      width: 100%;
      padding: 4px 8px;
      border: none;
      background: transparent;
      font-weight: 600;
      line-height: 1.4;
      resize: none;
      outline: none;
      overflow: hidden;
    }
    .block-heading:focus {
      background: rgba(255,255,255,0.5);
      border-radius: 4px;
    }
    .block-heading.h1 {
      font-size: 28px;
    }
    .block-heading.h2 {
      font-size: 22px;
    }
    .block-heading.h3 {
      font-size: 18px;
    }
    .block-image {
      width: 100%;
      border-radius: 8px;
      background: #f3f4f6;
    }
    .block-image img {
      width: 100%;
      border-radius: 8px;
      display: block;
    }
    /* 画像サイズバリエーション */
    .block-image.size-small {
      width: 50%;
    }
    .block-image.size-medium {
      width: 75%;
    }
    .block-image.size-large {
      width: 100%;
    }
    /* 画像サイズ変更ボタン */
    .block-image-controls {
      display: flex;
      gap: 4px;
      margin-top: 8px;
    }
    .block-size-btn {
      padding: 4px 10px;
      font-size: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      background: white;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.15s;
    }
    .block-size-btn:hover {
      border-color: #40B4E5;
      color: #40B4E5;
    }
    .block-size-btn.active {
      background: #40B4E5;
      border-color: #40B4E5;
      color: white;
    }
    /* テキスト色変更ボタン */
    .block-color-controls {
      display: flex;
      gap: 4px;
      margin-top: 6px;
    }
    .block-color-btn {
      width: 24px;
      height: 24px;
      border: 2px solid #e5e7eb;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.15s;
    }
    .block-color-btn:hover {
      transform: scale(1.1);
    }
    .block-color-btn.active {
      border-color: #40B4E5;
      box-shadow: 0 0 0 2px rgba(64,180,229,0.3);
    }
    .block-file {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: #f8f9fa;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }
    .block-file-icon {
      font-size: 24px;
      color: #6b7280;
    }
    .block-file-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .block-delete-btn {
      background: none;
      border: none;
      color: #d1d5db;
      font-size: 16px;
      cursor: pointer;
      padding: 4px;
    }
    .block-delete-btn:hover {
      color: #ef4444;
    }
    /* ノートメニューオーバーレイ */
    .note-menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      z-index: 1200;
      display: none;
    }
    .note-menu-overlay.active {
      display: block;
    }
    /* ブロック追加メニュー（開閉式） */
    .note-add-block-menu {
      position: fixed;
      bottom: 70px;
      left: 0;
      right: 0;
      padding: 12px 16px;
      background: white;
      border-top: 1px solid #e5e7eb;
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      z-index: 1202;
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
    }
    .note-add-block-menu.active {
      display: flex;
    }
    .note-add-block-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 12px 16px;
      background: white;
      border-top: 1px solid #e5e7eb;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1201;
    }
    .note-editor-modal.active .note-add-block-bar {
      display: flex;
    }
    .note-add-toggle-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
      box-shadow: 0 2px 8px rgba(64,180,229,0.3);
    }
    .note-add-toggle-btn:active {
      transform: scale(0.95);
    }
    .note-add-toggle-btn.active {
      transform: rotate(45deg);
    }
    .note-add-block-row {
      display: flex;
      justify-content: center;
      gap: 12px;
    }
    .note-add-block-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: #f3f4f6;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      color: #374151;
      cursor: pointer;
    }
    .note-add-block-btn:active {
      background: #e5e7eb;
    }
    .note-add-block-btn i {
      font-size: 16px;
    }
    /* 罫線選択ポップオーバー */
    .paper-type-popover {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 8px;
      min-width: 140px;
      display: none;
      z-index: 1300;
    }
    .paper-type-popover.active {
      display: block;
    }
    .paper-type-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
    }
    .paper-type-option:hover {
      background: #f3f4f6;
    }
    .paper-type-option.selected {
      background: #eff6ff;
      color: #1E8FBF;
    }
    .paper-type-option i {
      font-size: 16px;
    }
    /* Sortable.js用 */
    .sortable-ghost {
      opacity: 0.4;
    }
    .sortable-chosen {
      background: #f0f9ff;
    }

    /* ノート共有モーダル */
    .share-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 5000;
      display: none;
    }
    .share-modal-overlay.active {
      display: block;
    }
    .share-modal {
      position: fixed;
      bottom: -100%;
      left: 0;
      right: 0;
      max-height: 70vh;
      background: white;
      border-radius: 16px 16px 0 0;
      z-index: 5001;
      transition: bottom 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    .share-modal.active {
      bottom: 0;
    }
    .share-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
      font-weight: 600;
      font-size: 16px;
    }
    .share-modal-close {
      background: none;
      border: none;
      padding: 8px;
      cursor: pointer;
      color: #6b7280;
    }
    .share-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }
    .share-loading {
      text-align: center;
      padding: 40px 20px;
      color: #9ca3af;
    }
    .share-room-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .share-room-item:hover {
      background: #f9fafb;
    }
    .share-room-item:active {
      background: #f3f4f6;
    }
    .share-room-icon {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, #1E8FBF, #0ea5e9);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      flex-shrink: 0;
    }
    .share-room-info {
      flex: 1;
      min-width: 0;
    }
    .share-room-name {
      font-size: 15px;
      font-weight: 500;
      color: #1f2937;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .share-room-type {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 2px;
    }
    .share-link-section {
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
    }
    .share-link-title {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    .share-link-box {
      display: flex;
      gap: 8px;
    }
    .share-link-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 13px;
      background: #f9fafb;
    }
    .share-link-copy-btn {
      padding: 10px 16px;
      background: #1E8FBF;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
    }
    .share-link-copy-btn:active {
      background: #1a7ba3;
    }
    .share-rooms-title {
      padding: 12px 20px 8px;
      font-size: 12px;
      color: #6b7280;
    }

    /* ベルアイコンのバッジ（v288: 赤いドット表示に変更） */
    .minimal-header-icon {
      position: relative;
    }
    .announce-dot {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      display: none;
      box-shadow: 0 0 0 2px white;
    }
    .announce-dot.active {
      display: block;
    }

    /* 設定ドロップダウン */
    .settings-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 200px;
      overflow: hidden;
      display: none;
      z-index: 1001;
    }
    .settings-dropdown.active {
      display: block;
    }
    .settings-dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      font-size: 14px;
      color: #1f2937;
      text-decoration: none;
      transition: background 0.2s;
      cursor: pointer;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }
    .settings-dropdown-item:hover {
      background: #f3f4f6;
    }
    .settings-dropdown-item i {
      font-size: 18px;
      color: #6b7280;
      width: 24px;
      text-align: center;
    }
    .settings-dropdown-item.admin-only {
      display: none;
    }
    .settings-dropdown-item.admin-only.visible {
      display: flex;
      border-top: 1px solid #e5e7eb;
      color: #6366f1;
    }
    .settings-dropdown-item.admin-only.visible i {
      color: #6366f1;
    }
    .settings-dropdown-divider {
      height: 1px;
      background: #e5e7eb;
      margin: 4px 0;
    }

    /* ローディング */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    /* 非対象ユーザー向けメッセージ */
    .not-eligible {
      text-align: center;
      padding: 40px 20px;
    }
    .not-eligible i {
      font-size: 64px;
      color: #d1d5db;
      margin-bottom: 16px;
    }
    .not-eligible h3 {
      font-size: 18px;
      color: #374151;
      margin-bottom: 8px;
    }
    .not-eligible p {
      font-size: 14px;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <!-- ローディング -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted">データを読み込んでいます...</p>
    </div>
  </div>

  <!-- YouTube風ミニマルヘッダー -->
  <style>
    .minimal-header {
      background: #ffffff;
      height: 56px;
      padding: 0 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 1px solid #f0f0f0;
    }
    .minimal-header-logo {
      width: 100px;
      height: auto;
      cursor: pointer;
    }
    .minimal-header-icons {
      display: flex;
      align-items: center;
      gap: 2px;
    }
    .minimal-header-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 20px;
      transition: background 0.2s;
    }
    .minimal-header-icon:hover {
      background: #f2f2f2;
    }
    .minimal-header-icon:active {
      background: #e5e5e5;
    }
  </style>
  <div class="minimal-header">
    <img src="/images/furira-square-logo.png?v=20251209" alt="Furira" class="minimal-header-logo" onclick="window.parent.postMessage({type:'navigate', page:'home'}, '*')">
    <div class="minimal-header-icons">
      <button class="minimal-header-icon" title="ノート" onclick="openNotesModal()">
        <i class="bi bi-journal-text"></i>
      </button>
      <button class="minimal-header-icon" title="通知" onclick="openAnnouncePage()">
        <i class="bi bi-bell"></i>
        <span class="announce-dot" id="announceDot"></span>
      </button>
      <div style="position: relative;">
        <button class="minimal-header-icon" title="設定" onclick="toggleSettingsDropdown(event)">
          <i class="bi bi-gear"></i>
        </button>
        <div class="settings-dropdown" id="settingsDropdown">
          <button class="settings-dropdown-item" onclick="openPersonalInfoModal()">
            <i class="bi bi-person-badge"></i>
            <span>個人情報設定</span>
          </button>
          <button class="settings-dropdown-item" onclick="openNotificationSettingsModal()">
            <i class="bi bi-bell"></i>
            <span>通知設定</span>
          </button>
          <div class="settings-dropdown-divider"></div>
          <button class="settings-dropdown-item" onclick="window.parent.postMessage({type:'navigate', page:'help'}, '*')">
            <i class="bi bi-question-circle"></i>
            <span>ヘルプ</span>
          </button>
          <button class="settings-dropdown-item admin-only" id="adminAnnounceLink" onclick="openAdminAnnounce()">
            <i class="bi bi-megaphone"></i>
            <span>お知らせ管理</span>
          </button>
          <button class="settings-dropdown-item admin-only" id="adminPlanLink" onclick="openPlanManagement()">
            <i class="bi bi-award"></i>
            <span>プラン管理</span>
          </button>
          <div class="settings-dropdown-divider"></div>
          <button class="settings-dropdown-item" onclick="openPrivacyPolicy()">
            <i class="bi bi-file-text"></i>
            <span>プライバシーポリシー</span>
          </button>
          <button class="settings-dropdown-item" onclick="openTermsOfService()">
            <i class="bi bi-file-earmark-text"></i>
            <span>利用規約</span>
          </button>
          <div class="settings-dropdown-divider"></div>
          <button class="settings-dropdown-item" onclick="openFeedback()">
            <i class="bi bi-chat-square-text"></i>
            <span>フィードバック送信</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="content-container" id="mainContent">
    <!-- 動的に表示 -->
  </div>

  <!-- 目標設定モーダル -->
  <div class="goal-modal-backdrop" id="goalModal">
    <div class="goal-modal">
      <div class="goal-modal-title">🎯 今月の目標金額を設定</div>
      <div class="goal-input-group">
        <label>目標金額</label>
        <div class="goal-input-wrapper">
          <span>¥</span>
          <input type="number" id="goalAmountInput" placeholder="10000" step="1000">
        </div>
      </div>
      <div class="goal-presets">
        <button class="goal-preset-btn" onclick="setGoalPreset(5000)">¥5,000</button>
        <button class="goal-preset-btn" onclick="setGoalPreset(10000)">¥10,000</button>
        <button class="goal-preset-btn" onclick="setGoalPreset(20000)">¥20,000</button>
        <button class="goal-preset-btn" onclick="setGoalPreset(30000)">¥30,000</button>
        <button class="goal-preset-btn" onclick="setGoalPreset(50000)">¥50,000</button>
      </div>
      <div class="goal-skip-option">
        <button class="goal-skip-btn" onclick="skipGoal()">目標を設定しない</button>
      </div>
      <div class="ranking-option">
        <label class="ranking-toggle">
          <input type="checkbox" id="rankingParticipation" checked>
          <span class="toggle-slider"></span>
          <span class="toggle-label">ランキングに参加する</span>
        </label>
        <div class="ranking-option-note">オフにすると他のメンバーにあなたの順位が表示されません</div>
      </div>
      <div class="goal-modal-buttons">
        <button class="goal-cancel-btn" onclick="closeGoalModal()">キャンセル</button>
        <button class="goal-save-btn" onclick="saveGoal()">保存</button>
      </div>
    </div>
  </div>

  <!-- 履歴モーダル -->
  <div class="history-modal-backdrop" id="historyModal">
    <div class="history-modal">
      <div class="history-modal-title">📊 目標履歴</div>
      <div class="history-list" id="historyList">
        <!-- 動的に生成 -->
      </div>
      <button class="history-close-btn" onclick="closeHistoryModal()">閉じる</button>
    </div>
  </div>

  <!-- 背景選択モーダル -->
  <div class="bg-modal-backdrop" id="bgModal">
    <div class="bg-modal">
      <div class="bg-modal-header">
        <span class="bg-modal-title">背景を変更</span>
        <button class="bg-modal-close" onclick="closeBgModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>
      <div class="bg-modal-body">
        <div class="bg-section-title">グラデーション</div>
        <div class="bg-gradient-grid" id="bgGradientGrid">
          <!-- グラデーションプリセット（JavaScriptで生成） -->
        </div>
        <div class="bg-section-title">カスタム画像</div>
        <div class="bg-image-upload">
          <label class="bg-upload-btn" for="bgImageInput">
            <i class="bi bi-image"></i>
            <span>画像をアップロード</span>
          </label>
          <input type="file" id="bgImageInput" accept="image/*" style="display: none;" onchange="handleBgImageSelect(event)">
        </div>
        <div class="bg-preview" id="bgPreview">
          <div class="bg-position-adjuster" id="bgPositionAdjuster">
            <img class="bg-preview-image" id="bgPreviewImage" src="" alt="プレビュー" draggable="false">
            <div class="bg-position-hint">ドラッグして位置を調整</div>
          </div>
          <div class="bg-position-reset">
            <button type="button" class="bg-position-reset-btn" onclick="resetBgPosition()">
              <i class="bi bi-arrow-counterclockwise"></i> 位置をリセット
            </button>
          </div>
          <button class="bg-preview-remove" onclick="removeBgImage()">
            <i class="bi bi-trash"></i> 画像を削除
          </button>
        </div>
      </div>
      <div class="bg-modal-footer">
        <button class="bg-cancel-btn" onclick="closeBgModal()">キャンセル</button>
        <button class="bg-save-btn" id="bgSaveBtn" onclick="saveBgSetting()">保存</button>
      </div>
    </div>
  </div>

  <!-- お知らせモーダル -->
  <div class="announce-modal-backdrop" id="announceModal">
    <div class="announce-modal">
      <div class="announce-modal-header">
        <i class="bi bi-bell"></i> お知らせ
      </div>
      <div class="announce-modal-body" id="announceModalBody">
        <!-- 動的に生成 -->
      </div>
      <div class="announce-modal-footer">
        <button class="announce-close-btn" onclick="closeAnnouncementModal()">閉じる</button>
      </div>
    </div>
  </div>

  <!-- ノート一覧モーダル -->
  <div class="notes-modal-backdrop" id="notesModalBackdrop" onclick="closeNotesModal()"></div>
  <div class="notes-modal" id="notesModal">
    <div class="notes-modal-header">
      <div class="notes-modal-header-left">
        <button class="notes-back-btn" onclick="closeNotesModal()">
          <i class="bi bi-chevron-left"></i>
        </button>
        <span class="notes-modal-title">ノート</span>
      </div>
      <button class="notes-add-btn" onclick="createNewNote()">
        <i class="bi bi-plus"></i>
      </button>
    </div>
    <div class="notes-modal-body" id="notesModalBody">
      <div class="notes-empty">
        <i class="bi bi-journal-text"></i>
        <div class="notes-empty-text">
          ノートがありません<br>
          <small>＋ボタンから新しいノートを作成できます</small>
        </div>
      </div>
    </div>
  </div>

  <!-- ノート編集モーダル -->
  <div class="note-editor-modal" id="noteEditorModal">
    <div class="note-editor-header">
      <div class="note-editor-header-left">
        <button class="note-editor-btn" onclick="closeNoteEditor()">
          <i class="bi bi-chevron-left"></i>
        </button>
      </div>
      <div class="note-editor-header-right">
        <div style="position: relative;">
          <button class="note-editor-btn" onclick="togglePaperTypePopover()" title="罫線タイプ">
            <i class="bi bi-journal"></i>
          </button>
          <div class="paper-type-popover" id="paperTypePopover">
            <div class="paper-type-option" data-type="blank" onclick="selectPaperType('blank')">
              <i class="bi bi-square"></i>
              <span>無地</span>
            </div>
            <div class="paper-type-option" data-type="lined" onclick="selectPaperType('lined')">
              <i class="bi bi-text-left"></i>
              <span>横罫線</span>
            </div>
            <div class="paper-type-option selected" data-type="grid" onclick="selectPaperType('grid')">
              <i class="bi bi-grid-3x3"></i>
              <span>方眼</span>
            </div>
          </div>
        </div>
        <button class="note-editor-btn" onclick="shareNote()" title="共有">
          <i class="bi bi-share"></i>
        </button>
        <button class="note-editor-btn delete" onclick="deleteNote()" title="削除">
          <i class="bi bi-trash"></i>
        </button>
      </div>
    </div>
    <div class="note-editor-body">
      <input type="text" class="note-title-input" id="noteTitleInput" placeholder="タイトル" oninput="scheduleNoteSave()">
      <div class="note-blocks-container paper-grid" id="noteBlocksContainer">
        <!-- ブロックが動的に追加される -->
      </div>
    </div>
    <!-- ブロック追加メニューオーバーレイ -->
    <div class="note-menu-overlay" id="noteMenuOverlay" onclick="closeNoteBlockMenu()"></div>
    <!-- ブロック追加メニュー（開閉式） -->
    <div class="note-add-block-menu" id="noteAddBlockMenu">
      <div class="note-add-block-row">
        <button class="note-add-block-btn" onclick="addHeadingBlock(); closeNoteBlockMenu();">
          <i class="bi bi-type-h1"></i>
          <span>見出し</span>
        </button>
        <button class="note-add-block-btn" onclick="addTextBlock(); closeNoteBlockMenu();">
          <i class="bi bi-fonts"></i>
          <span>テキスト</span>
        </button>
        <button class="note-add-block-btn" onclick="triggerImageUpload(); closeNoteBlockMenu();">
          <i class="bi bi-image"></i>
          <span>画像</span>
        </button>
      </div>
      <div class="note-add-block-row">
        <button class="note-add-block-btn" onclick="triggerFileUpload(); closeNoteBlockMenu();">
          <i class="bi bi-paperclip"></i>
          <span>ファイル</span>
        </button>
      </div>
    </div>
    <!-- +ボタン -->
    <div class="note-add-block-bar" id="noteAddBlockBar">
      <button class="note-add-toggle-btn" id="noteAddToggleBtn" onclick="toggleNoteBlockMenu()">
        <i class="bi bi-plus-lg"></i>
      </button>
    </div>
  </div>

  <!-- ノート用の隠しファイル入力 -->
  <input type="file" id="noteImageInput" accept="image/*" style="display: none;" onchange="handleNoteImageUpload(event)">
  <input type="file" id="noteFileInput" style="display: none;" onchange="handleNoteFileUpload(event)">

  <!-- ノート共有モーダル -->
  <div id="shareModalOverlay" class="share-modal-overlay" onclick="closeShareModal()"></div>
  <div id="shareModal" class="share-modal">
    <div class="share-modal-header">
      <span>ノートを共有</span>
      <button class="share-modal-close" onclick="closeShareModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="share-link-section">
      <div class="share-link-title">共有リンク</div>
      <div class="share-link-box">
        <input type="text" class="share-link-input" id="shareLinkInput" readonly>
        <button class="share-link-copy-btn" onclick="copyShareLink()">コピー</button>
      </div>
    </div>
    <div class="share-rooms-title">チャットに送信</div>
    <div class="share-modal-body" id="shareRoomList">
      <!-- ルーム一覧がここに動的に追加される -->
    </div>
  </div>

  <!-- 個人情報設定モーダル -->
  <div class="settings-modal-backdrop" id="personalInfoModal">
    <div class="settings-modal">
      <div class="settings-modal-header">
        <span class="settings-modal-title">
          <i class="bi bi-person-badge"></i> 個人情報設定
        </span>
        <button class="settings-modal-close" onclick="closePersonalInfoModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>
      <div class="settings-modal-body">
        <div class="settings-section">
          <div class="settings-section-title">📦 発送先情報</div>
          <div class="settings-input-group">
            <label class="settings-input-label">郵便番号</label>
            <input type="text" class="settings-input" id="shippingPostalCode" placeholder="000-0000">
          </div>
          <div class="settings-input-group">
            <label class="settings-input-label">住所</label>
            <textarea class="settings-textarea" id="shippingAddress" placeholder="都道府県 市区町村 番地"></textarea>
          </div>
          <div class="settings-input-group">
            <label class="settings-input-label">氏名</label>
            <input type="text" class="settings-input" id="shippingName" placeholder="山田 太郎">
          </div>
          <div class="settings-input-group">
            <label class="settings-input-label">電話番号</label>
            <input type="tel" class="settings-input" id="shippingPhone" placeholder="090-0000-0000">
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">🏦 口座情報</div>
          <div class="settings-input-group">
            <label class="settings-input-label">銀行名</label>
            <input type="text" class="settings-input" id="bankName" placeholder="○○銀行">
          </div>
          <div class="settings-input-group">
            <label class="settings-input-label">支店名</label>
            <input type="text" class="settings-input" id="bankBranch" placeholder="○○支店">
          </div>
          <div class="settings-input-group">
            <label class="settings-input-label">口座種別</label>
            <select class="settings-input" id="bankAccountType">
              <option value="ordinary">普通</option>
              <option value="checking">当座</option>
            </select>
          </div>
          <div class="settings-input-group">
            <label class="settings-input-label">口座番号</label>
            <input type="text" class="settings-input" id="bankAccountNumber" placeholder="0000000">
          </div>
          <div class="settings-input-group">
            <label class="settings-input-label">口座名義（カタカナ）</label>
            <input type="text" class="settings-input" id="bankAccountHolder" placeholder="ヤマダ タロウ">
          </div>
        </div>
      </div>
      <div class="settings-modal-footer">
        <button class="settings-cancel-btn" onclick="closePersonalInfoModal()">キャンセル</button>
        <button class="settings-save-btn" id="personalInfoSaveBtn" onclick="savePersonalInfo()">保存</button>
      </div>
    </div>
  </div>

  <!-- 通知設定モーダル -->
  <div class="settings-modal-backdrop" id="notificationSettingsModal">
    <div class="settings-modal">
      <div class="settings-modal-header">
        <span class="settings-modal-title">
          <i class="bi bi-bell"></i> 通知設定
        </span>
        <button class="settings-modal-close" onclick="closeNotificationSettingsModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>
      <div class="settings-modal-body">
        <div class="settings-toggle-row">
          <span class="settings-toggle-label">プッシュ通知</span>
          <label class="settings-toggle">
            <input type="checkbox" id="pushNotificationToggle">
            <span class="settings-toggle-slider"></span>
          </label>
        </div>
        <div class="settings-toggle-row">
          <span class="settings-toggle-label">通知音</span>
          <label class="settings-toggle">
            <input type="checkbox" id="notificationSoundToggle">
            <span class="settings-toggle-slider"></span>
          </label>
        </div>
      </div>
      <div class="settings-modal-footer">
        <button class="settings-cancel-btn" onclick="closeNotificationSettingsModal()">キャンセル</button>
        <button class="settings-save-btn" id="notificationSaveBtn" onclick="saveNotificationSettings()">保存</button>
      </div>
    </div>
  </div>

  <!-- ユーザー名編集モーダル -->
  <div class="settings-modal-backdrop" id="usernameEditModal">
    <div class="settings-modal" style="max-width: 320px;">
      <div class="settings-modal-header">
        <span class="settings-modal-title">
          <i class="bi bi-pencil"></i> ユーザー名を変更
        </span>
        <button class="settings-modal-close" onclick="closeUsernameEditModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>
      <div class="settings-modal-body">
        <div class="settings-input-group">
          <label class="settings-input-label">新しいユーザー名</label>
          <input type="text" class="settings-input" id="newUsernameInput" placeholder="ユーザー名" maxlength="50">
        </div>
      </div>
      <div class="settings-modal-footer">
        <button class="settings-cancel-btn" onclick="closeUsernameEditModal()">キャンセル</button>
        <button class="settings-save-btn" id="usernameSaveBtn" onclick="saveUsername()">保存</button>
      </div>
    </div>
  </div>

  <!-- プロフィール画像アップロード用hidden input -->
  <input type="file" id="profileImageInput" accept="image/*" style="display: none;" onchange="handleProfileImageSelect(event)">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, getDoc, setDoc, query, where, updateDoc, addDoc, deleteDoc, orderBy, limit, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "furira.jp",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // グラデーションプリセット
    const GRADIENT_PRESETS = [
      { id: 'blue', gradient: 'linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%)' },
      { id: 'purple', gradient: 'linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%)' },
      { id: 'pink', gradient: 'linear-gradient(135deg, #EC4899 0%, #BE185D 100%)' },
      { id: 'orange', gradient: 'linear-gradient(135deg, #F97316 0%, #EA580C 100%)' },
      { id: 'green', gradient: 'linear-gradient(135deg, #22C55E 0%, #15803D 100%)' },
      { id: 'teal', gradient: 'linear-gradient(135deg, #14B8A6 0%, #0F766E 100%)' },
      { id: 'indigo', gradient: 'linear-gradient(135deg, #6366F1 0%, #4338CA 100%)' },
      { id: 'rose', gradient: 'linear-gradient(135deg, #F43F5E 0%, #BE123C 100%)' },
      { id: 'amber', gradient: 'linear-gradient(135deg, #F59E0B 0%, #D97706 100%)' },
      { id: 'cyan', gradient: 'linear-gradient(135deg, #06B6D4 0%, #0891B2 100%)' },
      { id: 'lime', gradient: 'linear-gradient(135deg, #84CC16 0%, #65A30D 100%)' },
      { id: 'slate', gradient: 'linear-gradient(135deg, #64748B 0%, #475569 100%)' },
    ];

    // グローバル変数
    let currentUser = null;
    let compensationRecords = [];
    let compensationSettings = {};
    let userProfileBg = { type: 'gradient', value: 'blue', position: 50 }; // デフォルト（position: 0-100で縦位置）
    let selectedBgType = 'gradient';
    let selectedBgValue = 'blue';
    let selectedBgPosition = 50; // 画像の縦位置（0=上端, 50=中央, 100=下端）
    let pendingBgImageFile = null;
    let userGoal = 0;
    let rankingParticipation = true; // ランキング参加フラグ
    let allUsersRankingPrefs = {}; // 全ユーザーのランキング参加設定
    let assignedTasks = ['listing', 'shipping']; // ユーザーの担当タスク（デフォルトは両方）

    // ノート関連変数
    let notesList = [];
    let currentNoteId = null;
    let currentNoteData = null;
    let noteSaveTimer = null;
    let sortableInstance = null;

    // 初期化
    async function init() {
      showLoading(true);

      // ユーザー情報取得
      currentUser = {
        email: localStorage.getItem('reborn_user_email') || '',
        name: localStorage.getItem('reborn_user_name') || 'ゲスト',
        permissionId: localStorage.getItem('reborn_user_permission_id') || 'staff',
        permissionDisplay: localStorage.getItem('reborn_user_permission_display') || 'スタッフ',
        photoURL: localStorage.getItem('reborn_user_icon_url') || localStorage.getItem('reborn_user_photo_url') || ''
      };

      if (!currentUser.email) {
        showNotEligible('ログインが必要です', 'ユーザー情報が見つかりません。再度ログインしてください。');
        showLoading(false);
        return;
      }

      try {
        // 報酬設定を取得
        await loadCompensationSettings();

        // 報酬対象者かチェック
        const isEligible = await checkEligibility();

        if (!isEligible) {
          showNotEligible('報酬対象外です', 'このアカウントは報酬管理の対象外です。');
          showLoading(false);
          return;
        }

        // ユーザーの目標を取得
        await loadUserGoal();

        // ユーザーの担当タスクを取得
        await loadAssignedTasks();

        // 全ユーザーのランキング参加設定を取得
        await loadAllUsersRankingPrefs();

        // 報酬データを取得
        await loadCompensationData();

        // ユーザーの背景設定を取得
        await loadUserProfileBg();

        // 画面を描画
        renderMyPage();

        // お知らせを読み込んでバッジを更新
        await initAnnouncements();

        // 管理者メニュー表示チェック
        checkAdminAccess();
      } catch (error) {
        console.error('初期化エラー:', error);
        showNotEligible('エラーが発生しました', 'データの読み込み中にエラーが発生しました。');
      }

      showLoading(false);
    }

    // 管理者メールアドレス
    const ADMIN_EMAILS = ['mercari.yasuhirotakuji@gmail.com'];

    // 管理者アクセスチェック
    function checkAdminAccess() {
      if (currentUser && ADMIN_EMAILS.includes(currentUser.email)) {
        const adminLink = document.getElementById('adminAnnounceLink');
        if (adminLink) {
          adminLink.classList.add('visible');
        }
        const adminPlanLink = document.getElementById('adminPlanLink');
        if (adminPlanLink) {
          adminPlanLink.classList.add('visible');
        }
        console.log('管理者メニュー表示:', currentUser.email);
      }
    }

    // 設定ドロップダウン制御
    window.toggleSettingsDropdown = function(event) {
      event.stopPropagation();
      const dropdown = document.getElementById('settingsDropdown');
      dropdown.classList.toggle('active');
    };

    // ドロップダウン外クリックで閉じる
    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown && !dropdown.contains(event.target)) {
        dropdown.classList.remove('active');
      }
    });

    // お知らせ管理を開く（ドロップダウンを閉じてから）
    window.openAdminAnnounce = function() {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) {
        dropdown.classList.remove('active');
      }
      window.open('/admin-announce.html', '_blank');
    };

    // プラン管理を開く
    window.openPlanManagement = function() {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) {
        dropdown.classList.remove('active');
      }
      // iframe内で開く
      window.parent.postMessage({ type: 'navigate', page: 'plans' }, '*');
    };

    // プライバシーポリシーを開く
    window.openPrivacyPolicy = function() {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) {
        dropdown.classList.remove('active');
      }
      // iframe内で開く（戻るボタンでマイページに戻れるように）
      window.parent.postMessage({ type: 'navigate', page: 'privacy-policy' }, '*');
    };

    // 利用規約を開く
    window.openTermsOfService = function() {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) {
        dropdown.classList.remove('active');
      }
      // iframe内で開く（戻るボタンでマイページに戻れるように）
      window.parent.postMessage({ type: 'navigate', page: 'terms-of-service' }, '*');
    };

    // フィードバック送信を開く
    window.openFeedback = function() {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) {
        dropdown.classList.remove('active');
      }
      // iframe内で開く（戻るボタンでマイページに戻れるように）
      window.parent.postMessage({ type: 'navigate', page: 'feedback' }, '*');
    };

    // 報酬設定を取得（localStorageからconfig経由）
    async function loadCompensationSettings() {
      try {
        // localStorageからconfig読み込み
        const configStr = localStorage.getItem('config');
        if (configStr) {
          const config = JSON.parse(configStr);
          if (config.報酬設定) {
            compensationSettings = config.報酬設定;
            console.log('報酬設定を読み込み:', compensationSettings);
            return;
          }
        }

        // Firestoreからも取得試行
        const docRef = doc(db, 'settings', 'compensation');
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          compensationSettings = docSnap.data();
        } else {
          // デフォルト設定
          compensationSettings = {
            taskRates: { listing: 100, shipping: 100, photography: 50, inspection: 30 },
            mypage: { enabled: true, allowedUsers: [] }
          };
        }
      } catch (error) {
        console.error('報酬設定取得エラー:', error);
        compensationSettings = {
          taskRates: { listing: 100, shipping: 100 },
          mypage: { enabled: true, allowedUsers: [] }
        };
      }
    }

    // 報酬対象者かチェック
    async function checkEligibility() {
      // マイページ機能が無効の場合
      if (compensationSettings.mypage && compensationSettings.mypage.enabled === false) {
        console.log('マイページ機能が無効です');
        return false;
      }

      // allowedUsersが設定されている場合、リストに含まれているかチェック
      const allowedUsers = compensationSettings.mypage?.allowedUsers || [];

      // allowedUsersが空（未設定）の場合は全員許可
      if (allowedUsers.length === 0) {
        console.log('マイページ: 全員許可（allowedUsers未設定）');
        return true;
      }

      // 現在のユーザーがリストに含まれているかチェック
      const isAllowed = allowedUsers.includes(currentUser.email);
      console.log('マイページ権限チェック:', currentUser.email, 'allowed:', isAllowed);

      return isAllowed;
    }

    // ユーザーの目標を取得
    async function loadUserGoal() {
      try {
        const now = new Date();
        const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const docRef = doc(db, 'userGoals', `${currentUser.email}_${yearMonth}`);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          const data = docSnap.data();
          userGoal = data.goalAmount || 0;
          rankingParticipation = data.rankingParticipation !== false; // デフォルトtrue
        } else {
          userGoal = 0; // 目標未設定
          rankingParticipation = true;
        }
      } catch (error) {
        console.error('目標取得エラー:', error);
        userGoal = 0;
        rankingParticipation = true;
      }
    }

    // ユーザーの担当タスクを取得
    async function loadAssignedTasks() {
      try {
        const userRef = doc(db, 'users', currentUser.email);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          const data = userSnap.data();
          // 担当タスクが設定されていればそれを使用、未設定なら両方担当
          assignedTasks = data.assignedTasks || ['listing', 'shipping'];
        } else {
          assignedTasks = ['listing', 'shipping'];
        }
        console.log('担当タスク:', assignedTasks);
      } catch (error) {
        console.error('担当タスク取得エラー:', error);
        assignedTasks = ['listing', 'shipping'];
      }
    }

    // 全ユーザーのランキング参加設定を取得
    async function loadAllUsersRankingPrefs() {
      try {
        const now = new Date();
        const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const goalsRef = collection(db, 'userGoals');
        const snapshot = await getDocs(goalsRef);

        allUsersRankingPrefs = {};
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          if (data.yearMonth === yearMonth) {
            allUsersRankingPrefs[data.email] = data.rankingParticipation !== false;
          }
        });
      } catch (error) {
        console.error('ランキング設定取得エラー:', error);
      }
    }

    // 報酬データを取得
    async function loadCompensationData() {
      try {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;

        const recordsRef = collection(db, 'compensationRecords');
        const snapshot = await getDocs(recordsRef);

        compensationRecords = [];
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          compensationRecords.push({ id: docSnap.id, ...data });
        });

        // 今月のデータのみフィルタ
        compensationRecords = compensationRecords.filter(r => {
          if (!r.completedAt && !r.recordedAt) return false;
          const dateStr = r.completedAt || r.recordedAt;
          const date = typeof dateStr === 'string' ? new Date(dateStr) : (dateStr.toDate ? dateStr.toDate() : new Date(dateStr));
          return date.getFullYear() === year && (date.getMonth() + 1) === month;
        });
      } catch (error) {
        console.error('報酬データ取得エラー:', error);
        compensationRecords = [];
      }
    }

    // 進捗に応じたマイルストーンメッセージを取得
    function getMilestoneMessage(percent) {
      if (percent >= 100) {
        return `<div class="progress-milestone milestone-100">🎉 目標達成おめでとうございます！</div>`;
      } else if (percent >= 80) {
        return `<div class="progress-milestone milestone-80">🔥 あと少し！目標まであと${100 - percent}%です！</div>`;
      } else if (percent >= 50) {
        return `<div class="progress-milestone milestone-50">💪 折り返し地点を通過！この調子で頑張りましょう！</div>`;
      } else if (percent >= 30) {
        return `<div class="progress-milestone">🌱 順調に進んでいます！目標の${percent}%達成中！</div>`;
      }
      return '';
    }

    // マイページを描画
    function renderMyPage() {
      const now = new Date();
      const monthName = `${now.getFullYear()}年${now.getMonth() + 1}月`;

      // 自分のデータを集計
      const myRecords = compensationRecords.filter(r => r.staffEmail === currentUser.email);
      const myStats = calculateStats(myRecords);

      // ランキングデータを生成
      const rankingData = calculateRanking();
      const myRank = rankingData.findIndex(r => r.email === currentUser.email) + 1;

      // 進捗率を計算
      const progressPercent = userGoal > 0 ? Math.min(100, Math.round((myStats.totalAmount / userGoal) * 100)) : 0;

      // アバター（クリック可能）
      const avatarHtml = currentUser.photoURL
        ? `<img src="${currentUser.photoURL}" alt="アバター">`
        : '👤';

      // 背景スタイル
      const bgStyle = getProfileBgStyle();

      const html = `
        <!-- プロフィールカード -->
        <div class="profile-card" id="profileCard" style="${bgStyle}">
          <button class="profile-bg-edit-btn" onclick="openBgModal()" title="背景を変更">
            <i class="bi bi-pencil"></i>
          </button>
          <div class="profile-avatar" onclick="clickProfileImage()" title="アイコンを変更" style="cursor: pointer;">
            ${avatarHtml}
            <div class="profile-avatar-edit-overlay"><i class="bi bi-camera"></i></div>
          </div>
          <div class="profile-name" onclick="openUsernameEditModal()" title="ユーザー名を変更" style="cursor: pointer;">${escapeHtml(currentUser.name)}<i class="bi bi-pencil edit-icon"></i></div>
          <div class="profile-role">${escapeHtml(stripEmoji(currentUser.permissionDisplay))}</div>
        </div>

        <!-- 報酬サマリー -->
        <div class="compensation-card">
          <div class="compensation-header">
            <div class="compensation-title">今月の報酬</div>
          </div>
          <div class="compensation-amount">¥${myStats.totalAmount.toLocaleString()}</div>
          <div class="compensation-goal">
            目標: <span class="goal-amount">${userGoal > 0 ? '¥' + userGoal.toLocaleString() : '未設定'}</span>
          </div>
          ${userGoal > 0 ? `
          <div class="progress-container">
            <div class="progress-bar-bg">
              <div class="progress-bar-fill" style="width: ${progressPercent}%"></div>
            </div>
            <div class="progress-text">
              <span>達成率</span>
              <span class="progress-percent">${progressPercent}%</span>
            </div>
            ${getMilestoneMessage(progressPercent)}
          </div>` : ''}
        </div>

        <!-- 内訳（担当タスクのみ表示） -->
        <div class="breakdown-card">
          <div class="breakdown-title">内訳</div>
          ${assignedTasks.includes('listing') ? `
          <div class="breakdown-item">
            <div class="breakdown-label">
              <div class="breakdown-icon listing">📦</div>
              <div>
                <div class="breakdown-name">商品出品</div>
                <div class="breakdown-count">${myStats.listingCount}件</div>
              </div>
            </div>
            <div class="breakdown-amount">¥${myStats.listingAmount.toLocaleString()}</div>
          </div>` : ''}
          ${assignedTasks.includes('shipping') ? `
          <div class="breakdown-item">
            <div class="breakdown-label">
              <div class="breakdown-icon shipping">🚚</div>
              <div>
                <div class="breakdown-name">梱包・発送</div>
                <div class="breakdown-count">${myStats.shippingCount}件</div>
              </div>
            </div>
            <div class="breakdown-amount">¥${myStats.shippingAmount.toLocaleString()}</div>
          </div>` : ''}
          ${assignedTasks.length === 0 ? `
          <div style="text-align: center; color: #9ca3af; padding: 16px; font-size: 14px;">
            担当タスクが設定されていません
          </div>` : ''}
        </div>

        <!-- ランキング -->
        <div class="ranking-card">
          <div class="ranking-title">今月のランキング</div>
          ${renderRankingList(rankingData, currentUser.email)}
        </div>

        <!-- アクションボタン -->
        <div class="action-buttons">
          <div class="action-btn" onclick="openGoalModal()">
            <i class="bi bi-bullseye"></i>
            <span>目標設定</span>
          </div>
          <div class="action-btn" onclick="openHistoryModal()">
            <i class="bi bi-clock-history"></i>
            <span>履歴</span>
          </div>
        </div>
      `;

      document.getElementById('mainContent').innerHTML = html;
    }

    // 統計を計算
    function calculateStats(records) {
      let listingCount = 0;
      let listingAmount = 0;
      let shippingCount = 0;
      let shippingAmount = 0;

      records.forEach(r => {
        const taskType = r.taskTypeKey || r.taskType || '';
        const amount = r.unitPrice || 0;

        if (taskType === 'listing' || taskType === 'listing_approval') {
          listingCount++;
          listingAmount += amount;
        } else if (taskType === 'shipping' || taskType === 'shipping_task') {
          shippingCount++;
          shippingAmount += amount;
        }
      });

      return {
        listingCount,
        listingAmount,
        shippingCount,
        shippingAmount,
        totalAmount: listingAmount + shippingAmount,
        totalCount: listingCount + shippingCount
      };
    }

    // ランキングを計算
    function calculateRanking() {
      const staffStats = {};

      compensationRecords.forEach(r => {
        const email = r.staffEmail || '';
        const name = r.staffName || '不明';
        const amount = r.unitPrice || 0;

        if (!email) return;

        // ランキング不参加のユーザーはスキップ（自分以外）
        // 自分は参加・不参加に関わらず自分の位置を確認できる
        if (email !== currentUser.email && allUsersRankingPrefs[email] === false) {
          return;
        }

        if (!staffStats[email]) {
          staffStats[email] = { email, name, totalAmount: 0 };
        }
        staffStats[email].totalAmount += amount;
      });

      // 金額でソート
      const ranking = Object.values(staffStats).sort((a, b) => b.totalAmount - a.totalAmount);

      return ranking;
    }

    // ランキングリストを描画
    function renderRankingList(rankingData, myEmail) {
      // ランキング不参加の場合はメッセージを表示
      if (!rankingParticipation) {
        return `
          <div class="ranking-opt-out-message">
            <i class="bi bi-eye-slash"></i>
            <span>ランキング非公開中</span>
          </div>
          <div class="text-center text-muted" style="font-size: 12px;">
            目標設定から「ランキングに参加する」をオンにすると表示されます
          </div>
        `;
      }

      if (rankingData.length === 0) {
        return '<div class="text-center text-muted py-3">まだデータがありません</div>';
      }

      // 上位3名 + 自分の位置を表示
      const myRankIndex = rankingData.findIndex(r => r.email === myEmail);
      const displayItems = [];

      // 上位3名
      for (let i = 0; i < Math.min(3, rankingData.length); i++) {
        displayItems.push({ ...rankingData[i], rank: i + 1 });
      }

      // 自分が4位以下なら追加
      if (myRankIndex >= 3) {
        // 区切り線の代わりに...を追加
        displayItems.push({ separator: true });
        displayItems.push({ ...rankingData[myRankIndex], rank: myRankIndex + 1 });
      }

      return displayItems.map(item => {
        if (item.separator) {
          return '<div class="text-center text-muted py-1">⋮</div>';
        }

        const isMe = item.email === myEmail;
        const positionClass = item.rank === 1 ? 'gold' : item.rank === 2 ? 'silver' : item.rank === 3 ? 'bronze' : 'normal';
        const highlightClass = isMe ? 'highlight' : '';
        const nameClass = isMe ? 'me' : '';
        const displayName = isMe ? `★ ${item.name}` : item.name;

        return `
          <div class="ranking-item ${highlightClass}">
            <div class="ranking-position ${positionClass}">${item.rank}</div>
            <div class="ranking-name ${nameClass}">${escapeHtml(displayName)}</div>
            <div class="ranking-amount">¥${item.totalAmount.toLocaleString()}</div>
          </div>
        `;
      }).join('');
    }

    // 非対象者メッセージを表示
    function showNotEligible(title, message) {
      document.getElementById('mainContent').innerHTML = `
        <div class="not-eligible">
          <i class="bi bi-person-x"></i>
          <h3>${escapeHtml(title)}</h3>
          <p>${escapeHtml(message)}</p>
        </div>
      `;
    }

    // 目標設定モーダルを開く
    window.openGoalModal = function() {
      document.getElementById('goalAmountInput').value = userGoal || '';
      document.getElementById('rankingParticipation').checked = rankingParticipation;
      document.getElementById('goalModal').style.display = 'flex';
    };

    // 目標設定モーダルを閉じる
    window.closeGoalModal = function() {
      document.getElementById('goalModal').style.display = 'none';
    };

    // プリセット金額を設定
    window.setGoalPreset = function(amount) {
      document.getElementById('goalAmountInput').value = amount;
    };

    // 目標をスキップ（設定しない）
    window.skipGoal = async function() {
      try {
        showLoading(true);

        const now = new Date();
        const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const docRef = doc(db, 'userGoals', `${currentUser.email}_${yearMonth}`);

        const newRankingPref = document.getElementById('rankingParticipation').checked;
        await setDoc(docRef, {
          email: currentUser.email,
          name: currentUser.name,
          yearMonth: yearMonth,
          goalAmount: 0,
          skipped: true,
          rankingParticipation: newRankingPref,
          updatedAt: new Date().toISOString()
        });

        userGoal = 0;
        rankingParticipation = newRankingPref;
        allUsersRankingPrefs[currentUser.email] = newRankingPref;
        closeGoalModal();
        renderMyPage();

        showLoading(false);
      } catch (error) {
        console.error('目標スキップエラー:', error);
        alert('保存に失敗しました。');
        showLoading(false);
      }
    };

    // 目標を保存
    window.saveGoal = async function() {
      const goalAmount = parseInt(document.getElementById('goalAmountInput').value) || 0;

      if (goalAmount < 0) {
        alert('目標金額は0以上で設定してください。');
        return;
      }

      try {
        showLoading(true);

        const now = new Date();
        const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const docRef = doc(db, 'userGoals', `${currentUser.email}_${yearMonth}`);

        const newRankingPref = document.getElementById('rankingParticipation').checked;
        await setDoc(docRef, {
          email: currentUser.email,
          name: currentUser.name,
          yearMonth: yearMonth,
          goalAmount: goalAmount,
          rankingParticipation: newRankingPref,
          updatedAt: new Date().toISOString()
        });

        userGoal = goalAmount;
        rankingParticipation = newRankingPref;
        allUsersRankingPrefs[currentUser.email] = newRankingPref;
        closeGoalModal();
        renderMyPage();

        showLoading(false);
      } catch (error) {
        console.error('目標保存エラー:', error);
        alert('保存に失敗しました。');
        showLoading(false);
      }
    };

    // 履歴モーダルを開く
    window.openHistoryModal = async function() {
      document.getElementById('historyModal').style.display = 'flex';
      document.getElementById('historyList').innerHTML = '<div class="history-empty"><div class="spinner-border text-primary" role="status"></div><p style="margin-top: 12px;">読み込み中...</p></div>';
      
      try {
        const historyData = await loadGoalHistory();
        renderHistoryList(historyData);
      } catch (error) {
        console.error('履歴読み込みエラー:', error);
        document.getElementById('historyList').innerHTML = '<div class="history-empty"><i class="bi bi-exclamation-circle"></i><p>履歴の読み込みに失敗しました</p></div>';
      }
    };

    // 履歴モーダルを閉じる
    window.closeHistoryModal = function() {
      document.getElementById('historyModal').style.display = 'none';
    };

    // 過去の目標履歴を読み込む（過去12ヶ月）
    async function loadGoalHistory() {
      const history = [];
      const now = new Date();
      
      // 過去12ヶ月分を取得（当月は除く）
      for (let i = 1; i <= 12; i++) {
        const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const year = targetDate.getFullYear();
        const month = targetDate.getMonth() + 1;
        const yearMonth = `${year}-${String(month).padStart(2, '0')}`;
        
        // 目標データを取得
        const goalDocRef = doc(db, 'userGoals', `${currentUser.email}_${yearMonth}`);
        const goalSnap = await getDoc(goalDocRef);
        
        // 報酬データを取得
        const recordsRef = collection(db, 'compensationRecords');
        const recordsSnap = await getDocs(recordsRef);
        
        let monthRecords = [];
        recordsSnap.forEach(docSnap => {
          const data = docSnap.data();
          if (data.staffEmail !== currentUser.email) return;
          
          const dateStr = data.completedAt || data.recordedAt;
          if (!dateStr) return;
          
          const date = typeof dateStr === 'string' ? new Date(dateStr) : (dateStr.toDate ? dateStr.toDate() : new Date(dateStr));
          if (date.getFullYear() === year && (date.getMonth() + 1) === month) {
            monthRecords.push(data);
          }
        });
        
        // そのユーザーのデータが存在する月のみ追加
        if (goalSnap.exists() || monthRecords.length > 0) {
          const goalAmount = goalSnap.exists() ? (goalSnap.data().goalAmount || 0) : 10000;
          const stats = calculateStats(monthRecords);
          
          // ランキングを計算（全員分）
          const allUsersMap = new Map();
          recordsSnap.forEach(docSnap => {
            const data = docSnap.data();
            const dateStr = data.completedAt || data.recordedAt;
            if (!dateStr) return;
            
            const date = typeof dateStr === 'string' ? new Date(dateStr) : (dateStr.toDate ? dateStr.toDate() : new Date(dateStr));
            if (date.getFullYear() === year && (date.getMonth() + 1) === month) {
              const email = data.staffEmail || 'unknown';
              if (!allUsersMap.has(email)) {
                allUsersMap.set(email, { totalAmount: 0 });
              }
              allUsersMap.get(email).totalAmount += (data.unitPrice || 0);
            }
          });
          
          // ランキングを生成
          const ranking = Array.from(allUsersMap.entries())
            .map(([email, data]) => ({ email, ...data }))
            .sort((a, b) => b.totalAmount - a.totalAmount);
          
          const myRank = ranking.findIndex(r => r.email === currentUser.email) + 1;
          
          history.push({
            yearMonth,
            year,
            month,
            goalAmount,
            actualAmount: stats.totalAmount,
            listingCount: stats.listingCount,
            listingAmount: stats.listingAmount,
            shippingCount: stats.shippingCount,
            shippingAmount: stats.shippingAmount,
            rank: myRank || '-',
            totalParticipants: ranking.length
          });
        }
      }
      
      return history;
    }

    // 履歴リストを描画
    function renderHistoryList(historyData) {
      if (historyData.length === 0) {
        document.getElementById('historyList').innerHTML = '<div class="history-empty"><i class="bi bi-calendar-x"></i><p>過去の履歴がありません</p></div>';
        return;
      }
      
      const html = historyData.map(item => {
        const percent = item.goalAmount > 0 ? Math.min(100, Math.round((item.actualAmount / item.goalAmount) * 100)) : 0;
        const achieved = percent >= 100;
        const achievedClass = achieved ? 'achieved' : (percent > 0 ? 'not-achieved' : '');
        
        return `
          <div class="history-item ${achievedClass}">
            <div class="history-month">${item.year}年${item.month}月</div>
            <div class="history-amounts">
              <div class="history-goal">目標: <span>¥${item.goalAmount.toLocaleString()}</span></div>
              <div class="history-actual">実績: <span>¥${item.actualAmount.toLocaleString()}</span></div>
            </div>
            <div class="history-progress">
              <div class="history-progress-bar">
                <div class="history-progress-fill ${achieved ? 'achieved' : ''}" style="width: ${percent}%"></div>
              </div>
              <div class="history-percent ${achieved ? 'achieved' : ''}">${percent}%</div>
            </div>
            <div class="history-details">
              <div class="history-breakdown">
                ${assignedTasks.includes('listing') ? `
                <div class="history-breakdown-item">
                  <div class="history-breakdown-icon">📦</div>
                  <div class="history-breakdown-label">出品</div>
                  <div class="history-breakdown-value">${item.listingCount}件 / ¥${item.listingAmount.toLocaleString()}</div>
                </div>` : ''}
                ${assignedTasks.includes('shipping') ? `
                <div class="history-breakdown-item">
                  <div class="history-breakdown-icon">🚚</div>
                  <div class="history-breakdown-label">発送</div>
                  <div class="history-breakdown-value">${item.shippingCount}件 / ¥${item.shippingAmount.toLocaleString()}</div>
                </div>` : ''}
              </div>
              <div class="history-ranking">
                <span class="history-ranking-label">🏆 ランキング</span>
                <span class="history-ranking-value">${item.rank}位 / ${item.totalParticipants}人</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('historyList').innerHTML = html;
    }

    // ========================================
    // お知らせ機能
    // ========================================
    let announcements = [];
    let personalAnnouncements = [];
    let readAnnouncementIds = new Set();
    let readPersonalIds = new Set();
    let currentAnnouncementView = 'list'; // 'list' or 'detail'

    // お知らせページを開く
    window.openAnnouncePage = function() {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'navigate', page: 'announce' }, '*');
      } else {
        window.location.href = '/announce.html';
      }
    };

    // お知らせモーダルを開く（レガシー、使用されていない）
    window.openAnnouncementModal = async function() {
      document.getElementById('announceModal').style.display = 'flex';
      currentAnnouncementView = 'list';
      document.getElementById('announceModalBody').innerHTML = '<div class="announce-empty"><div class="spinner-border text-primary" role="status"></div><p style="margin-top: 12px;">読み込み中...</p></div>';
      
      try {
        await loadAnnouncements();
        renderAnnouncementList();
      } catch (error) {
        console.error('お知らせ読み込みエラー:', error);
        document.getElementById('announceModalBody').innerHTML = '<div class="announce-empty"><i class="bi bi-exclamation-circle"></i><p>お知らせの読み込みに失敗しました</p></div>';
      }
    };

    // お知らせモーダルを閉じる
    window.closeAnnouncementModal = function() {
      document.getElementById('announceModal').style.display = 'none';
    };

    // お知らせを読み込む
    async function loadAnnouncements() {
      // 全体お知らせ一覧を取得
      const announcementsRef = collection(db, 'announcements');
      const snapshot = await getDocs(announcementsRef);

      announcements = [];
      snapshot.forEach(docSnap => {
        announcements.push({ id: docSnap.id, ...docSnap.data() });
      });

      // 日付でソート（新しい順）
      announcements.sort((a, b) => {
        const dateA = a.createdAt ? (typeof a.createdAt === 'string' ? new Date(a.createdAt) : a.createdAt.toDate()) : new Date(0);
        const dateB = b.createdAt ? (typeof b.createdAt === 'string' ? new Date(b.createdAt) : b.createdAt.toDate()) : new Date(0);
        return dateB - dateA;
      });

      // 全体お知らせ既読情報を取得
      readAnnouncementIds = new Set();
      if (currentUser && currentUser.email) {
        const readRef = collection(db, 'readAnnouncements');
        const readSnapshot = await getDocs(readRef);
        readSnapshot.forEach(docSnap => {
          const data = docSnap.data();
          if (data.userEmail === currentUser.email) {
            readAnnouncementIds.add(data.announcementId);
          }
        });

        // 個人お知らせを取得
        try {
          const personalRef = collection(db, 'users', currentUser.email, 'personalAnnouncements');
          const personalSnapshot = await getDocs(personalRef);
          personalAnnouncements = [];
          personalSnapshot.forEach(docSnap => {
            personalAnnouncements.push({ id: docSnap.id, ...docSnap.data() });
          });

          // 個人お知らせ既読情報を取得
          readPersonalIds = new Set();
          const readPersonalRef = collection(db, 'users', currentUser.email, 'readPersonalAnnouncements');
          const readPersonalSnapshot = await getDocs(readPersonalRef);
          readPersonalSnapshot.forEach(docSnap => {
            readPersonalIds.add(docSnap.data().announcementId);
          });
        } catch (e) {
          console.log('[Announce] 個人お知らせ読み込みスキップ:', e.message);
          personalAnnouncements = [];
          readPersonalIds = new Set();
        }
      }

      // バッジを更新
      updateAnnounceBadge();
    }

    // お知らせ一覧を描画
    function renderAnnouncementList() {
      if (announcements.length === 0) {
        document.getElementById('announceModalBody').innerHTML = '<div class="announce-empty"><i class="bi bi-bell-slash"></i><p>お知らせはありません</p></div>';
        return;
      }
      
      const html = `<div class="announce-list">${announcements.map(item => {
        const isUnread = !readAnnouncementIds.has(item.id);
        const date = item.createdAt ? (typeof item.createdAt === 'string' ? new Date(item.createdAt) : item.createdAt.toDate()) : null;
        const dateStr = date ? `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()}` : '';
        const priorityClass = item.priority === 'important' ? 'important' : 'normal';
        const priorityLabel = item.priority === 'important' ? '重要' : 'お知らせ';
        
        return `
          <div class="announce-item ${isUnread ? 'unread' : ''}" onclick="showAnnouncementDetail('${item.id}')">
            <div class="announce-item-header">
              <span class="announce-priority ${priorityClass}">${priorityLabel}</span>
              <span class="announce-date">${dateStr}</span>
            </div>
            <div class="announce-title">${escapeHtml(item.title || '')}</div>
            <div class="announce-preview">${escapeHtml(item.body || '').substring(0, 50)}${(item.body || '').length > 50 ? '...' : ''}</div>
          </div>
        `;
      }).join('')}</div>`;
      
      document.getElementById('announceModalBody').innerHTML = html;
    }

    // お知らせ詳細を表示
    window.showAnnouncementDetail = async function(announcementId) {
      const item = announcements.find(a => a.id === announcementId);
      if (!item) return;
      
      currentAnnouncementView = 'detail';
      
      const date = item.createdAt ? (typeof item.createdAt === 'string' ? new Date(item.createdAt) : item.createdAt.toDate()) : null;
      const dateStr = date ? `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日` : '';
      const priorityClass = item.priority === 'important' ? 'important' : 'normal';
      const priorityLabel = item.priority === 'important' ? '重要' : 'お知らせ';
      
      const html = `
        <div class="announce-detail">
          <button class="announce-back-btn" onclick="renderAnnouncementList(); currentAnnouncementView='list';">
            <i class="bi bi-chevron-left"></i> 一覧に戻る
          </button>
          <div class="announce-detail-title">${escapeHtml(item.title || '')}</div>
          <div class="announce-detail-meta">
            <span class="announce-priority ${priorityClass}">${priorityLabel}</span>
            <span>${dateStr}</span>
          </div>
          <div class="announce-detail-body">${escapeHtml(item.body || '')}</div>
        </div>
      `;
      
      document.getElementById('announceModalBody').innerHTML = html;
      
      // 既読にする
      if (!readAnnouncementIds.has(announcementId) && currentUser && currentUser.email) {
        try {
          const readDocRef = doc(db, 'readAnnouncements', `${currentUser.email}_${announcementId}`);
          await setDoc(readDocRef, {
            userEmail: currentUser.email,
            announcementId: announcementId,
            readAt: new Date().toISOString()
          });
          readAnnouncementIds.add(announcementId);
          updateAnnounceBadge();
        } catch (error) {
          console.error('既読マークエラー:', error);
        }
      }
    };

    // バッジを更新（v288: 赤いドット表示に変更）
    // 未読があれば赤いドットを表示、なければ非表示
    function updateAnnounceBadge() {
      const globalUnread = announcements.filter(a => !readAnnouncementIds.has(a.id)).length;
      const personalUnread = personalAnnouncements.filter(a => !readPersonalIds.has(a.id)).length;
      const hasUnread = (globalUnread + personalUnread) > 0;
      const dot = document.getElementById('announceDot');
      if (dot) {
        if (hasUnread) {
          dot.classList.add('active');
        } else {
          dot.classList.remove('active');
        }
      }
      console.log('[Announce] 未読あり:', hasUnread, '(全体:', globalUnread, ', 個人:', personalUnread, ')');
      // v288: お知らせは独立管理のため、親フレームへの通知は不要
    }

    // 初期化時にお知らせを読み込んでバッジを更新
    async function initAnnouncements() {
      try {
        await loadAnnouncements();
      } catch (error) {
        console.error('お知らせ初期化エラー:', error);
      }
    }

    // 戻る（履歴ベース）
    window.goBack = function() {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'goBack' }, '*');
      } else {
        window.history.back();
      }
    };

    // ローディング表示
    function showLoading(show) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    // エスケープ
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, char => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[char]));
    }

    // 絵文字を削除
    function stripEmoji(str) {
      if (!str) return '';
      return str.replace(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '').trim();
    }

    // 初期化実行
    // ========================================
    // 背景カスタマイズ機能
    // ========================================

    // 背景スタイルを取得
    function getProfileBgStyle() {
      if (userProfileBg.type === 'image' && userProfileBg.value) {
        const pos = userProfileBg.position !== undefined ? userProfileBg.position : 50;
        return `background-image: url('${userProfileBg.value}'); background-size: cover; background-position: center ${pos}%;`;
      } else {
        const preset = GRADIENT_PRESETS.find(p => p.id === userProfileBg.value) || GRADIENT_PRESETS[0];
        return `background: ${preset.gradient};`;
      }
    }

    // ユーザーの背景設定を読み込む
    async function loadUserProfileBg() {
      try {
        const userRef = doc(db, 'users', currentUser.email);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          const data = userSnap.data();
          if (data.profileBackground) {
            userProfileBg = data.profileBackground;
            console.log('[ProfileBg] 背景設定を読み込み:', userProfileBg);
          }
        }
      } catch (error) {
        console.error('[ProfileBg] 背景設定読み込みエラー:', error);
      }
    }

    // 背景選択モーダルを開く
    window.openBgModal = function() {
      // 現在の設定を選択状態に
      selectedBgType = userProfileBg.type;
      selectedBgValue = userProfileBg.value;
      selectedBgPosition = userProfileBg.position !== undefined ? userProfileBg.position : 50;
      pendingBgImageFile = null;

      // グラデーショングリッドを生成
      renderBgGradientGrid();

      // 画像プレビューをリセット
      const preview = document.getElementById('bgPreview');
      const previewImg = document.getElementById('bgPreviewImage');
      if (userProfileBg.type === 'image' && userProfileBg.value) {
        previewImg.src = userProfileBg.value;
        preview.classList.add('active');
        // 画像が読み込まれたら位置を適用
        previewImg.onload = function() {
          applyPreviewPosition();
        };
      } else {
        preview.classList.remove('active');
        previewImg.src = '';
      }

      document.getElementById('bgImageInput').value = '';
      document.getElementById('bgModal').classList.add('active');

      // ドラッグイベントをセットアップ
      setupBgPositionDrag();
    };

    // 背景選択モーダルを閉じる
    window.closeBgModal = function() {
      document.getElementById('bgModal').classList.remove('active');
    };

    // グラデーショングリッドを生成
    function renderBgGradientGrid() {
      const grid = document.getElementById('bgGradientGrid');
      grid.innerHTML = GRADIENT_PRESETS.map(preset => {
        const isSelected = selectedBgType === 'gradient' && selectedBgValue === preset.id;
        return `<div class="bg-gradient-item ${isSelected ? 'selected' : ''}"
                    style="background: ${preset.gradient};"
                    onclick="selectBgGradient('${preset.id}')"></div>`;
      }).join('');
    }

    // グラデーションを選択
    window.selectBgGradient = function(gradientId) {
      selectedBgType = 'gradient';
      selectedBgValue = gradientId;
      pendingBgImageFile = null;

      // 画像プレビューを非表示
      document.getElementById('bgPreview').classList.remove('active');
      document.getElementById('bgImageInput').value = '';

      // 選択状態を更新
      renderBgGradientGrid();
    };

    // 画像選択ハンドラ
    window.handleBgImageSelect = function(event) {
      const file = event.target.files[0];
      if (!file) return;

      // ファイルサイズチェック（5MB以下）
      if (file.size > 5 * 1024 * 1024) {
        alert('画像サイズは5MB以下にしてください');
        event.target.value = '';
        return;
      }

      // プレビュー表示
      const reader = new FileReader();
      reader.onload = function(e) {
        const previewImg = document.getElementById('bgPreviewImage');
        previewImg.src = e.target.result;
        document.getElementById('bgPreview').classList.add('active');

        selectedBgType = 'image';
        selectedBgValue = e.target.result; // 一時的にData URLを設定
        selectedBgPosition = 50; // 新しい画像は中央からスタート
        pendingBgImageFile = file;

        // 画像が読み込まれたら位置を適用
        previewImg.onload = function() {
          applyPreviewPosition();
          setupBgPositionDrag();
        };

        // グラデーションの選択を解除
        renderBgGradientGrid();
      };
      reader.readAsDataURL(file);
    };

    // 画像を削除
    window.removeBgImage = function() {
      document.getElementById('bgPreview').classList.remove('active');
      document.getElementById('bgPreviewImage').src = '';
      document.getElementById('bgImageInput').value = '';
      pendingBgImageFile = null;

      // デフォルトのグラデーションに戻す
      selectedBgType = 'gradient';
      selectedBgValue = userProfileBg.type === 'gradient' ? userProfileBg.value : 'blue';
      renderBgGradientGrid();
    };

    // 画像位置調整のドラッグ処理をセットアップ
    function setupBgPositionDrag() {
      const adjuster = document.getElementById('bgPositionAdjuster');
      const previewImg = document.getElementById('bgPreviewImage');
      if (!adjuster || !previewImg) return;

      let isDragging = false;
      let startY = 0;
      let startPosition = 0;

      const onStart = (e) => {
        if (selectedBgType !== 'image') return;
        isDragging = true;
        startY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
        startPosition = selectedBgPosition;
        e.preventDefault();
      };

      const onMove = (e) => {
        if (!isDragging) return;
        const currentY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
        const deltaY = currentY - startY;
        const containerHeight = adjuster.offsetHeight;
        const imgHeight = previewImg.offsetHeight;

        // deltaYに応じて位置を変更（上にドラッグ→position増加、下にドラッグ→position減少）
        const sensitivity = 100 / Math.max(imgHeight - containerHeight, 100);
        let newPosition = startPosition - (deltaY * sensitivity);
        newPosition = Math.max(0, Math.min(100, newPosition));

        selectedBgPosition = newPosition;
        applyPreviewPosition();
      };

      const onEnd = () => {
        isDragging = false;
      };

      // 既存のイベントリスナーを削除
      adjuster.onmousedown = null;
      adjuster.ontouchstart = null;
      document.onmousemove = null;
      document.ontouchmove = null;
      document.onmouseup = null;
      document.ontouchend = null;

      // 新しいイベントリスナーを追加
      adjuster.onmousedown = onStart;
      adjuster.ontouchstart = onStart;
      document.onmousemove = onMove;
      document.ontouchmove = onMove;
      document.onmouseup = onEnd;
      document.ontouchend = onEnd;
    }

    // プレビュー画像の位置を適用
    function applyPreviewPosition() {
      const previewImg = document.getElementById('bgPreviewImage');
      const adjuster = document.getElementById('bgPositionAdjuster');
      if (!previewImg || !adjuster) return;

      // 画像の高さとコンテナの高さから、移動可能範囲を計算
      const containerHeight = adjuster.offsetHeight;
      const imgHeight = previewImg.naturalHeight * (adjuster.offsetWidth / previewImg.naturalWidth);
      const maxOffset = Math.max(0, imgHeight - containerHeight);

      // positionに応じてtop位置を計算
      const topOffset = -(maxOffset * selectedBgPosition / 100);
      previewImg.style.top = `${topOffset}px`;
    }

    // 位置をリセット
    window.resetBgPosition = function() {
      selectedBgPosition = 50;
      applyPreviewPosition();
    };

    // 背景設定を保存
    window.saveBgSetting = async function() {
      const saveBtn = document.getElementById('bgSaveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = '保存中...';

      try {
        let newBgValue = selectedBgValue;

        // 画像の場合はアップロード
        if (selectedBgType === 'image' && pendingBgImageFile) {
          const timestamp = Date.now();
          const fileName = `profile-bg/${currentUser.email}/${timestamp}_${pendingBgImageFile.name}`;
          const storageRef = ref(storage, fileName);

          await uploadBytes(storageRef, pendingBgImageFile);
          newBgValue = await getDownloadURL(storageRef);
          console.log('[ProfileBg] 画像アップロード完了:', newBgValue);
        }

        // Firestoreに保存（position情報も含める）
        const userRef = doc(db, 'users', currentUser.email);
        await updateDoc(userRef, {
          profileBackground: {
            type: selectedBgType,
            value: newBgValue,
            position: selectedBgType === 'image' ? selectedBgPosition : 50
          }
        });

        // ローカル状態を更新
        userProfileBg = {
          type: selectedBgType,
          value: newBgValue,
          position: selectedBgType === 'image' ? selectedBgPosition : 50
        };

        // プロフィールカードの背景を即時反映
        const profileCard = document.getElementById('profileCard');
        if (profileCard) {
          if (userProfileBg.type === 'image') {
            const pos = userProfileBg.position !== undefined ? userProfileBg.position : 50;
            profileCard.style.cssText = `background-image: url('${userProfileBg.value}'); background-size: cover; background-position: center ${pos}%;`;
          } else {
            const preset = GRADIENT_PRESETS.find(p => p.id === userProfileBg.value) || GRADIENT_PRESETS[0];
            profileCard.style.cssText = `background: ${preset.gradient};`;
          }
        }

        closeBgModal();
        console.log('[ProfileBg] 背景設定を保存:', userProfileBg);
      } catch (error) {
        console.error('[ProfileBg] 保存エラー:', error);
        alert('背景の保存に失敗しました');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = '保存';
      }
    };

    // ========================================
    // 個人情報設定・通知設定機能
    // ========================================

    // 個人情報（発送先・口座）を保持
    let personalInfo = {
      shipping: { name: '', postalCode: '', address: '', phone: '' },
      bank: { bankName: '', branchName: '', accountType: '', accountNumber: '', accountHolder: '' }
    };

    // 通知設定を保持
    let notificationSettings = {
      pushEnabled: true,
      soundEnabled: true
    };

    // 個人情報を読み込む
    async function loadPersonalInfo() {
      try {
        const userRef = doc(db, 'users', currentUser.email);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          const data = userSnap.data();
          if (data.personalInfo) {
            personalInfo = {
              shipping: data.personalInfo.shipping || { name: '', postalCode: '', address: '', phone: '' },
              bank: data.personalInfo.bank || { bankName: '', branchName: '', accountType: '', accountNumber: '', accountHolder: '' }
            };
          }
        }
      } catch (error) {
        console.error('[PersonalInfo] 読み込みエラー:', error);
      }
    }

    // 通知設定を読み込む
    async function loadNotificationSettings() {
      try {
        const userRef = doc(db, 'users', currentUser.email);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          const data = userSnap.data();
          if (data.notificationSettings) {
            notificationSettings = {
              pushEnabled: data.notificationSettings.pushEnabled !== false,
              soundEnabled: data.notificationSettings.soundEnabled !== false
            };
          }
        }
      } catch (error) {
        console.error('[NotificationSettings] 読み込みエラー:', error);
      }
    }

    // 個人情報設定モーダルを開く
    window.openPersonalInfoModal = async function() {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) dropdown.classList.remove('active');

      // 個人情報を読み込み
      await loadPersonalInfo();

      // フォームに値をセット
      document.getElementById('shippingName').value = personalInfo.shipping.name || '';
      document.getElementById('shippingPostalCode').value = personalInfo.shipping.postalCode || '';
      document.getElementById('shippingAddress').value = personalInfo.shipping.address || '';
      document.getElementById('shippingPhone').value = personalInfo.shipping.phone || '';
      document.getElementById('bankName').value = personalInfo.bank.bankName || '';
      document.getElementById('branchName').value = personalInfo.bank.branchName || '';
      document.getElementById('accountType').value = personalInfo.bank.accountType || '普通';
      document.getElementById('accountNumber').value = personalInfo.bank.accountNumber || '';
      document.getElementById('accountHolder').value = personalInfo.bank.accountHolder || '';

      document.getElementById('personalInfoModal').classList.add('active');
    };

    // 個人情報設定モーダルを閉じる
    window.closePersonalInfoModal = function() {
      document.getElementById('personalInfoModal').classList.remove('active');
    };

    // 個人情報を保存
    window.savePersonalInfo = async function() {
      const saveBtn = document.getElementById('personalInfoSaveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = '保存中...';

      try {
        const newPersonalInfo = {
          shipping: {
            name: document.getElementById('shippingName').value.trim(),
            postalCode: document.getElementById('shippingPostalCode').value.trim(),
            address: document.getElementById('shippingAddress').value.trim(),
            phone: document.getElementById('shippingPhone').value.trim()
          },
          bank: {
            bankName: document.getElementById('bankName').value.trim(),
            branchName: document.getElementById('branchName').value.trim(),
            accountType: document.getElementById('accountType').value,
            accountNumber: document.getElementById('accountNumber').value.trim(),
            accountHolder: document.getElementById('accountHolder').value.trim()
          }
        };

        // Firestoreに保存
        const userRef = doc(db, 'users', currentUser.email);
        await updateDoc(userRef, {
          personalInfo: newPersonalInfo
        });

        personalInfo = newPersonalInfo;
        closePersonalInfoModal();
        console.log('[PersonalInfo] 個人情報を保存:', personalInfo);
      } catch (error) {
        console.error('[PersonalInfo] 保存エラー:', error);
        alert('個人情報の保存に失敗しました');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = '保存';
      }
    };

    // 通知設定モーダルを開く
    window.openNotificationSettingsModal = async function() {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) dropdown.classList.remove('active');

      // 通知設定を読み込み
      await loadNotificationSettings();

      // トグルに値をセット
      document.getElementById('pushNotificationToggle').checked = notificationSettings.pushEnabled;
      document.getElementById('notificationSoundToggle').checked = notificationSettings.soundEnabled;

      document.getElementById('notificationSettingsModal').classList.add('active');
    };

    // 通知設定モーダルを閉じる
    window.closeNotificationSettingsModal = function() {
      document.getElementById('notificationSettingsModal').classList.remove('active');
    };

    // 通知設定を保存
    window.saveNotificationSettings = async function() {
      const saveBtn = document.getElementById('notificationSaveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = '保存中...';

      try {
        const newSettings = {
          pushEnabled: document.getElementById('pushNotificationToggle').checked,
          soundEnabled: document.getElementById('notificationSoundToggle').checked
        };

        // Firestoreに保存
        const userRef = doc(db, 'users', currentUser.email);
        await updateDoc(userRef, {
          notificationSettings: newSettings
        });

        notificationSettings = newSettings;
        closeNotificationSettingsModal();
        console.log('[NotificationSettings] 通知設定を保存:', notificationSettings);
      } catch (error) {
        console.error('[NotificationSettings] 保存エラー:', error);
        alert('通知設定の保存に失敗しました');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = '保存';
      }
    };

    // ユーザー名編集モーダルを開く
    window.openUsernameEditModal = function() {
      document.getElementById('newUsernameInput').value = currentUser.name || '';
      document.getElementById('usernameEditModal').classList.add('active');
    };

    // ユーザー名編集モーダルを閉じる
    window.closeUsernameEditModal = function() {
      document.getElementById('usernameEditModal').classList.remove('active');
    };

    // ユーザー名を保存
    window.saveUsername = async function() {
      const newUsername = document.getElementById('newUsernameInput').value.trim();
      if (!newUsername) {
        alert('ユーザー名を入力してください');
        return;
      }

      const saveBtn = document.getElementById('usernameSaveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = '保存中...';

      try {
        // Firestoreに保存
        const userRef = doc(db, 'users', currentUser.email);
        await updateDoc(userRef, {
          name: newUsername,
          displayName: newUsername
        });

        // ローカルストレージも更新
        localStorage.setItem('reborn_user_name', newUsername);

        // 現在のユーザー情報を更新
        currentUser.name = newUsername;

        closeUsernameEditModal();
        renderMyPage();
        console.log('[Username] ユーザー名を保存:', newUsername);
      } catch (error) {
        console.error('[Username] 保存エラー:', error);
        alert('ユーザー名の保存に失敗しました');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = '保存';
      }
    };

    // プロフィール画像選択ハンドラ
    window.handleProfileImageSelect = async function(event) {
      const file = event.target.files[0];
      if (!file) return;

      // ファイルサイズチェック（5MB以下）
      if (file.size > 5 * 1024 * 1024) {
        alert('画像サイズは5MB以下にしてください');
        event.target.value = '';
        return;
      }

      showLoading(true);

      try {
        // Firebase Storageにアップロード
        const timestamp = Date.now();
        const fileName = `userIcons/${currentUser.email}/${timestamp}_${file.name}`;
        const storageRef = ref(storage, fileName);

        await uploadBytes(storageRef, file);
        const downloadURL = await getDownloadURL(storageRef);

        // Firestoreに保存
        const userRef = doc(db, 'users', currentUser.email);
        await updateDoc(userRef, {
          photoURL: downloadURL,
          iconUrl: downloadURL
        });

        // ローカルストレージも更新
        localStorage.setItem('reborn_user_icon_url', downloadURL);
        localStorage.setItem('reborn_user_photo_url', downloadURL);

        // 現在のユーザー情報を更新
        currentUser.photoURL = downloadURL;

        renderMyPage();
        console.log('[ProfileImage] プロフィール画像を更新:', downloadURL);
      } catch (error) {
        console.error('[ProfileImage] アップロードエラー:', error);
        alert('画像のアップロードに失敗しました');
      } finally {
        showLoading(false);
        event.target.value = '';
      }
    };

    // プロフィール画像クリックハンドラ
    window.clickProfileImage = function() {
      document.getElementById('profileImageInput').click();
    };

    // ========================================
    // ノート機能
    // ========================================

    // ノート一覧モーダルを開く
    window.openNotesModal = async function() {
      const backdrop = document.getElementById('notesModalBackdrop');
      const modal = document.getElementById('notesModal');

      backdrop.classList.add('active');
      setTimeout(() => modal.classList.add('active'), 10);

      await loadNotes();
    };

    // ノート一覧モーダルを閉じる
    window.closeNotesModal = function() {
      const backdrop = document.getElementById('notesModalBackdrop');
      const modal = document.getElementById('notesModal');

      modal.classList.remove('active');
      setTimeout(() => {
        backdrop.classList.remove('active');
      }, 300);
    };

    // ノート一覧を読み込み
    async function loadNotes() {
      const body = document.getElementById('notesModalBody');
      body.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;"><i class="bi bi-arrow-repeat" style="animation: spin 1s linear infinite; font-size: 24px;"></i></div>';

      try {
        const notesRef = collection(db, 'users', currentUser.email, 'notes');
        const q = query(notesRef, orderBy('updatedAt', 'desc'), limit(50));
        const snapshot = await getDocs(q);

        notesList = [];
        snapshot.forEach(doc => {
          notesList.push({ id: doc.id, ...doc.data() });
        });

        renderNotesList();
      } catch (error) {
        console.error('[Notes] 読み込みエラー:', error);
        body.innerHTML = '<div class="notes-empty"><i class="bi bi-exclamation-circle"></i><div class="notes-empty-text">読み込みに失敗しました</div></div>';
      }
    }

    // ノート一覧を描画
    function renderNotesList() {
      const body = document.getElementById('notesModalBody');

      if (notesList.length === 0) {
        body.innerHTML = `
          <div class="notes-empty">
            <i class="bi bi-journal-text"></i>
            <div class="notes-empty-text">
              ノートがありません<br>
              <small>＋ボタンから新しいノートを作成できます</small>
            </div>
          </div>
        `;
        return;
      }

      const html = notesList.map(note => {
        // プレビューテキストを取得
        let preview = '';
        if (note.blocks && note.blocks.length > 0) {
          const textBlock = note.blocks.find(b => b.type === 'text' && b.content?.text);
          if (textBlock) {
            preview = textBlock.content.text.substring(0, 100);
          }
        }

        // 更新日時
        let dateStr = '';
        if (note.updatedAt) {
          const date = note.updatedAt.toDate ? note.updatedAt.toDate() : new Date(note.updatedAt);
          dateStr = date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
        }

        return `
          <div class="note-item" onclick="openNoteEditor('${note.id}')">
            <div class="note-item-header">
              <i class="bi bi-journal-text note-item-icon"></i>
              <span class="note-item-title">${escapeHtml(note.title || '無題のノート')}</span>
            </div>
            <div class="note-item-date">${dateStr}</div>
            ${preview ? `<div class="note-item-preview">${escapeHtml(preview)}</div>` : ''}
          </div>
        `;
      }).join('');

      body.innerHTML = `<div class="notes-list">${html}</div>`;
    }

    // 新規ノート作成
    window.createNewNote = async function() {
      try {
        const notesRef = collection(db, 'users', currentUser.email, 'notes');
        const newNote = await addDoc(notesRef, {
          title: '',
          blocks: [],
          paperType: 'grid',
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          shareId: null,
          isPublic: false
        });

        console.log('[Notes] 新規ノート作成:', newNote.id);
        openNoteEditor(newNote.id);
      } catch (error) {
        console.error('[Notes] 作成エラー:', error);
        alert('ノートの作成に失敗しました');
      }
    };

    // ノートエディタを開く
    window.openNoteEditor = async function(noteId) {
      currentNoteId = noteId;

      const modal = document.getElementById('noteEditorModal');
      modal.classList.add('active');

      // ノートデータを読み込み
      try {
        const noteRef = doc(db, 'users', currentUser.email, 'notes', noteId);
        const noteSnap = await getDoc(noteRef);

        if (!noteSnap.exists()) {
          alert('ノートが見つかりません');
          closeNoteEditor();
          return;
        }

        currentNoteData = { id: noteId, ...noteSnap.data() };

        // タイトル設定
        document.getElementById('noteTitleInput').value = currentNoteData.title || '';

        // 罫線タイプ設定
        const container = document.getElementById('noteBlocksContainer');
        container.className = 'note-blocks-container';
        if (currentNoteData.paperType === 'lined') {
          container.classList.add('paper-lined');
        } else if (currentNoteData.paperType === 'grid') {
          container.classList.add('paper-grid');
        }
        updatePaperTypeUI(currentNoteData.paperType || 'grid');

        // ブロックを描画
        renderBlocks();

        // Sortable.js初期化
        initSortable();

      } catch (error) {
        console.error('[Notes] エディタ読み込みエラー:', error);
        alert('ノートの読み込みに失敗しました');
        closeNoteEditor();
      }
    };

    // ノートエディタを閉じる
    window.closeNoteEditor = function() {
      // 保存を実行
      if (noteSaveTimer) {
        clearTimeout(noteSaveTimer);
        saveNote();
      }

      const modal = document.getElementById('noteEditorModal');
      modal.classList.remove('active');

      currentNoteId = null;
      currentNoteData = null;

      if (sortableInstance) {
        sortableInstance.destroy();
        sortableInstance = null;
      }

      // ノート一覧を更新
      loadNotes();
    };

    // ブロックを描画
    function renderBlocks() {
      const container = document.getElementById('noteBlocksContainer');

      if (!currentNoteData.blocks || currentNoteData.blocks.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af; font-size: 14px;">ブロックを追加してください</div>';
        return;
      }

      const html = currentNoteData.blocks.map(block => renderBlock(block)).join('');
      container.innerHTML = html;

      // テキストエリアの高さを自動調整
      setTimeout(() => {
        resizeAllTextareas();
      }, 10);
    }

    // 単一ブロックをHTMLに変換
    function renderBlock(block) {
      if (block.type === 'text') {
        const textColor = block.content?.color || '#000000';
        return `
          <div class="note-block" data-block-id="${block.id}">
            <div class="block-drag-handle">⋮⋮</div>
            <div class="block-content">
              <textarea class="block-textarea"
                        placeholder="テキストを入力..."
                        style="color: ${textColor};"
                        oninput="updateBlockContent('${block.id}', this.value); autoResizeTextarea(this);"
              >${escapeHtml(block.content?.text || '')}</textarea>
              <div class="block-color-controls">
                <button class="block-color-btn ${textColor === '#000000' ? 'active' : ''}" style="background: #000000;" onclick="changeTextColor('${block.id}', '#000000')" title="黒"></button>
                <button class="block-color-btn ${textColor === '#6b7280' ? 'active' : ''}" style="background: #6b7280;" onclick="changeTextColor('${block.id}', '#6b7280')" title="グレー"></button>
                <button class="block-color-btn ${textColor === '#ef4444' ? 'active' : ''}" style="background: #ef4444;" onclick="changeTextColor('${block.id}', '#ef4444')" title="赤"></button>
                <button class="block-color-btn ${textColor === '#f97316' ? 'active' : ''}" style="background: #f97316;" onclick="changeTextColor('${block.id}', '#f97316')" title="オレンジ"></button>
                <button class="block-color-btn ${textColor === '#22c55e' ? 'active' : ''}" style="background: #22c55e;" onclick="changeTextColor('${block.id}', '#22c55e')" title="緑"></button>
                <button class="block-color-btn ${textColor === '#3b82f6' ? 'active' : ''}" style="background: #3b82f6;" onclick="changeTextColor('${block.id}', '#3b82f6')" title="青"></button>
                <button class="block-color-btn ${textColor === '#8b5cf6' ? 'active' : ''}" style="background: #8b5cf6;" onclick="changeTextColor('${block.id}', '#8b5cf6')" title="紫"></button>
              </div>
            </div>
            <button class="block-delete-btn" onclick="deleteBlock('${block.id}')">
              <i class="bi bi-x"></i>
            </button>
          </div>
        `;
      } else if (block.type === 'image') {
        const size = block.content?.size || 'large';
        return `
          <div class="note-block" data-block-id="${block.id}">
            <div class="block-drag-handle">⋮⋮</div>
            <div class="block-content">
              <div class="block-image size-${size}">
                <img src="${block.content?.url || ''}" alt="${escapeHtml(block.content?.fileName || '画像')}">
              </div>
              <div class="block-image-controls">
                <button class="block-size-btn ${size === 'small' ? 'active' : ''}" onclick="changeImageSize('${block.id}', 'small')">S</button>
                <button class="block-size-btn ${size === 'medium' ? 'active' : ''}" onclick="changeImageSize('${block.id}', 'medium')">M</button>
                <button class="block-size-btn ${size === 'large' ? 'active' : ''}" onclick="changeImageSize('${block.id}', 'large')">L</button>
              </div>
            </div>
            <button class="block-delete-btn" onclick="deleteBlock('${block.id}')">
              <i class="bi bi-x"></i>
            </button>
          </div>
        `;
      } else if (block.type === 'file') {
        return `
          <div class="note-block" data-block-id="${block.id}">
            <div class="block-drag-handle">⋮⋮</div>
            <div class="block-content">
              <div class="block-file" onclick="window.open('${block.content?.url || ''}', '_blank')">
                <i class="bi bi-file-earmark block-file-icon"></i>
                <span class="block-file-name">${escapeHtml(block.content?.fileName || 'ファイル')}</span>
              </div>
            </div>
            <button class="block-delete-btn" onclick="deleteBlock('${block.id}')">
              <i class="bi bi-x"></i>
            </button>
          </div>
        `;
      } else if (block.type === 'heading') {
        const level = block.content?.level || 'h2';
        const headingColor = block.content?.color || '#000000';
        return `
          <div class="note-block" data-block-id="${block.id}">
            <div class="block-drag-handle">⋮⋮</div>
            <div class="block-content">
              <textarea class="block-heading ${level}"
                        placeholder="${level === 'h1' ? '大見出し' : level === 'h2' ? '中見出し' : '小見出し'}"
                        style="color: ${headingColor};"
                        oninput="updateBlockContent('${block.id}', this.value); autoResizeTextarea(this);"
              >${escapeHtml(block.content?.text || '')}</textarea>
              <div class="block-image-controls">
                <button class="block-size-btn ${level === 'h1' ? 'active' : ''}" onclick="changeHeadingLevel('${block.id}', 'h1')">H1</button>
                <button class="block-size-btn ${level === 'h2' ? 'active' : ''}" onclick="changeHeadingLevel('${block.id}', 'h2')">H2</button>
                <button class="block-size-btn ${level === 'h3' ? 'active' : ''}" onclick="changeHeadingLevel('${block.id}', 'h3')">H3</button>
              </div>
              <div class="block-color-controls">
                <button class="block-color-btn ${headingColor === '#000000' ? 'active' : ''}" style="background: #000000;" onclick="changeTextColor('${block.id}', '#000000')" title="黒"></button>
                <button class="block-color-btn ${headingColor === '#6b7280' ? 'active' : ''}" style="background: #6b7280;" onclick="changeTextColor('${block.id}', '#6b7280')" title="グレー"></button>
                <button class="block-color-btn ${headingColor === '#ef4444' ? 'active' : ''}" style="background: #ef4444;" onclick="changeTextColor('${block.id}', '#ef4444')" title="赤"></button>
                <button class="block-color-btn ${headingColor === '#f97316' ? 'active' : ''}" style="background: #f97316;" onclick="changeTextColor('${block.id}', '#f97316')" title="オレンジ"></button>
                <button class="block-color-btn ${headingColor === '#22c55e' ? 'active' : ''}" style="background: #22c55e;" onclick="changeTextColor('${block.id}', '#22c55e')" title="緑"></button>
                <button class="block-color-btn ${headingColor === '#3b82f6' ? 'active' : ''}" style="background: #3b82f6;" onclick="changeTextColor('${block.id}', '#3b82f6')" title="青"></button>
                <button class="block-color-btn ${headingColor === '#8b5cf6' ? 'active' : ''}" style="background: #8b5cf6;" onclick="changeTextColor('${block.id}', '#8b5cf6')" title="紫"></button>
              </div>
            </div>
            <button class="block-delete-btn" onclick="deleteBlock('${block.id}')">
              <i class="bi bi-x"></i>
            </button>
          </div>
        `;
      }
      return '';
    }

    // Sortable.js初期化
    function initSortable() {
      const container = document.getElementById('noteBlocksContainer');

      if (sortableInstance) {
        sortableInstance.destroy();
      }

      sortableInstance = new Sortable(container, {
        animation: 150,
        handle: '.block-drag-handle',
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        onEnd: function(evt) {
          updateBlockOrder();
          scheduleNoteSave();
        }
      });
    }

    // ブロック順序更新
    function updateBlockOrder() {
      const container = document.getElementById('noteBlocksContainer');
      const blockElements = container.querySelectorAll('.note-block');

      const newBlocks = [];
      blockElements.forEach((el, index) => {
        const blockId = el.dataset.blockId;
        const block = currentNoteData.blocks.find(b => b.id === blockId);
        if (block) {
          block.order = index;
          newBlocks.push(block);
        }
      });

      currentNoteData.blocks = newBlocks;
    }

    // UUID生成
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // テキストブロック追加
    window.addTextBlock = function() {
      const block = {
        id: generateUUID(),
        type: 'text',
        order: currentNoteData.blocks ? currentNoteData.blocks.length : 0,
        content: { text: '' }
      };

      if (!currentNoteData.blocks) {
        currentNoteData.blocks = [];
      }
      currentNoteData.blocks.push(block);

      renderBlocks();
      initSortable();
      scheduleNoteSave();

      // 新しいtextareaにフォーカス
      setTimeout(() => {
        const textareas = document.querySelectorAll('.block-textarea');
        if (textareas.length > 0) {
          textareas[textareas.length - 1].focus();
        }
      }, 100);
    };

    // ノートブロックメニュー開閉
    window.toggleNoteBlockMenu = function() {
      const menu = document.getElementById('noteAddBlockMenu');
      const overlay = document.getElementById('noteMenuOverlay');
      const toggleBtn = document.getElementById('noteAddToggleBtn');

      if (menu.classList.contains('active')) {
        closeNoteBlockMenu();
      } else {
        menu.classList.add('active');
        overlay.classList.add('active');
        toggleBtn.classList.add('active');
      }
    };

    window.closeNoteBlockMenu = function() {
      const menu = document.getElementById('noteAddBlockMenu');
      const overlay = document.getElementById('noteMenuOverlay');
      const toggleBtn = document.getElementById('noteAddToggleBtn');

      menu.classList.remove('active');
      overlay.classList.remove('active');
      toggleBtn.classList.remove('active');
    };

    // 見出しブロック追加
    window.addHeadingBlock = function() {
      const block = {
        id: generateUUID(),
        type: 'heading',
        order: currentNoteData.blocks ? currentNoteData.blocks.length : 0,
        content: { text: '', level: 'h2' }
      };

      if (!currentNoteData.blocks) {
        currentNoteData.blocks = [];
      }
      currentNoteData.blocks.push(block);

      renderBlocks();
      initSortable();
      scheduleNoteSave();

      // 新しい見出しにフォーカス
      setTimeout(() => {
        const headings = document.querySelectorAll('.block-heading');
        if (headings.length > 0) {
          headings[headings.length - 1].focus();
        }
      }, 100);
    };

    // 画像アップロードトリガー
    window.triggerImageUpload = function() {
      document.getElementById('noteImageInput').click();
    };

    // ファイルアップロードトリガー
    window.triggerFileUpload = function() {
      document.getElementById('noteFileInput').click();
    };

    // 画像アップロード処理
    window.handleNoteImageUpload = async function(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (file.size > 10 * 1024 * 1024) {
        alert('画像サイズは10MB以下にしてください');
        event.target.value = '';
        return;
      }

      showLoading(true);

      try {
        // Firebase Storageにアップロード
        const timestamp = Date.now();
        const blockId = generateUUID();
        const fileName = `notes/${currentUser.email}/${currentNoteId}/${blockId}_${file.name}`;
        const storageRef = ref(storage, fileName);

        await uploadBytes(storageRef, file);
        const downloadURL = await getDownloadURL(storageRef);

        // ブロック追加
        const block = {
          id: blockId,
          type: 'image',
          order: currentNoteData.blocks ? currentNoteData.blocks.length : 0,
          content: { url: downloadURL, fileName: file.name }
        };

        if (!currentNoteData.blocks) {
          currentNoteData.blocks = [];
        }
        currentNoteData.blocks.push(block);

        renderBlocks();
        initSortable();
        saveNote();

        console.log('[Notes] 画像ブロック追加:', downloadURL);
      } catch (error) {
        console.error('[Notes] 画像アップロードエラー:', error);
        alert('画像のアップロードに失敗しました');
      } finally {
        showLoading(false);
        event.target.value = '';
      }
    };

    // ファイルアップロード処理
    window.handleNoteFileUpload = async function(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (file.size > 10 * 1024 * 1024) {
        alert('ファイルサイズは10MB以下にしてください');
        event.target.value = '';
        return;
      }

      showLoading(true);

      try {
        // Firebase Storageにアップロード
        const timestamp = Date.now();
        const blockId = generateUUID();
        const fileName = `notes/${currentUser.email}/${currentNoteId}/${blockId}_${file.name}`;
        const storageRef = ref(storage, fileName);

        await uploadBytes(storageRef, file);
        const downloadURL = await getDownloadURL(storageRef);

        // ブロック追加
        const block = {
          id: blockId,
          type: 'file',
          order: currentNoteData.blocks ? currentNoteData.blocks.length : 0,
          content: { url: downloadURL, fileName: file.name, fileType: file.type }
        };

        if (!currentNoteData.blocks) {
          currentNoteData.blocks = [];
        }
        currentNoteData.blocks.push(block);

        renderBlocks();
        initSortable();
        saveNote();

        console.log('[Notes] ファイルブロック追加:', downloadURL);
      } catch (error) {
        console.error('[Notes] ファイルアップロードエラー:', error);
        alert('ファイルのアップロードに失敗しました');
      } finally {
        showLoading(false);
        event.target.value = '';
      }
    };

    // ブロック内容更新
    window.updateBlockContent = function(blockId, value) {
      const block = currentNoteData.blocks.find(b => b.id === blockId);
      if (block) {
        block.content.text = value;
        scheduleNoteSave();
      }
    };

    // ブロック削除
    window.deleteBlock = function(blockId) {
      currentNoteData.blocks = currentNoteData.blocks.filter(b => b.id !== blockId);
      renderBlocks();
      initSortable();
      scheduleNoteSave();
    };

    // 画像サイズ変更
    window.changeImageSize = function(blockId, size) {
      const block = currentNoteData.blocks.find(b => b.id === blockId);
      if (block && block.type === 'image') {
        if (!block.content) block.content = {};
        block.content.size = size;
        renderBlocks();
        initSortable();
        scheduleNoteSave();
      }
    };

    // 見出しレベル変更
    window.changeHeadingLevel = function(blockId, level) {
      const block = currentNoteData.blocks.find(b => b.id === blockId);
      if (block && block.type === 'heading') {
        if (!block.content) block.content = {};
        block.content.level = level;
        renderBlocks();
        initSortable();
        scheduleNoteSave();
      }
    };

    // テキスト色変更
    window.changeTextColor = function(blockId, color) {
      const block = currentNoteData.blocks.find(b => b.id === blockId);
      if (block && (block.type === 'text' || block.type === 'heading')) {
        if (!block.content) block.content = {};
        block.content.color = color;
        renderBlocks();
        initSortable();
        scheduleNoteSave();
      }
    };

    // テキストエリア自動リサイズ
    window.autoResizeTextarea = function(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    };

    // 全テキストエリアの高さを調整
    function resizeAllTextareas() {
      const textareas = document.querySelectorAll('.block-textarea, .block-heading');
      textareas.forEach(textarea => {
        autoResizeTextarea(textarea);
      });
    }

    // 保存スケジュール（デバウンス）
    window.scheduleNoteSave = function() {
      if (noteSaveTimer) {
        clearTimeout(noteSaveTimer);
      }
      noteSaveTimer = setTimeout(() => {
        saveNote();
      }, 500);
    };

    // ノート保存
    async function saveNote() {
      if (!currentNoteId || !currentNoteData) return;

      try {
        const noteRef = doc(db, 'users', currentUser.email, 'notes', currentNoteId);

        // タイトル取得
        const titleInput = document.getElementById('noteTitleInput');
        currentNoteData.title = titleInput ? titleInput.value : '';

        await updateDoc(noteRef, {
          title: currentNoteData.title,
          blocks: currentNoteData.blocks || [],
          paperType: currentNoteData.paperType || 'grid',
          updatedAt: serverTimestamp()
        });

        console.log('[Notes] 保存完了');
      } catch (error) {
        console.error('[Notes] 保存エラー:', error);
      }
    }

    // 罫線タイプ選択ポップオーバー表示/非表示
    window.togglePaperTypePopover = function(event) {
      if (event) event.stopPropagation();
      const popover = document.getElementById('paperTypePopover');
      const isActive = popover.classList.toggle('active');

      // 外側クリックで閉じる処理
      if (isActive) {
        setTimeout(() => {
          document.addEventListener('click', closePaperTypeOnOutsideClick);
        }, 10);
      }
    };

    function closePaperTypeOnOutsideClick(event) {
      const popover = document.getElementById('paperTypePopover');
      const btn = event.target.closest('[onclick*="togglePaperTypePopover"]');
      if (!popover.contains(event.target) && !btn) {
        popover.classList.remove('active');
        document.removeEventListener('click', closePaperTypeOnOutsideClick);
      }
    }

    // 罫線タイプ選択
    window.selectPaperType = function(type) {
      currentNoteData.paperType = type;

      const container = document.getElementById('noteBlocksContainer');
      container.className = 'note-blocks-container';
      if (type === 'lined') {
        container.classList.add('paper-lined');
      } else if (type === 'grid') {
        container.classList.add('paper-grid');
      }

      updatePaperTypeUI(type);
      // ポップオーバーを閉じる
      const popover = document.getElementById('paperTypePopover');
      popover.classList.remove('active');
      document.removeEventListener('click', closePaperTypeOnOutsideClick);
      scheduleNoteSave();
    };

    // 罫線タイプUI更新
    function updatePaperTypeUI(type) {
      const options = document.querySelectorAll('.paper-type-option');
      options.forEach(opt => {
        opt.classList.remove('selected');
        if (opt.dataset.type === type) {
          opt.classList.add('selected');
        }
      });
    }

    // ノート削除
    window.deleteNote = async function() {
      if (!confirm('このノートを削除しますか？')) return;

      try {
        const noteRef = doc(db, 'users', currentUser.email, 'notes', currentNoteId);
        await deleteDoc(noteRef);

        console.log('[Notes] 削除完了:', currentNoteId);
        closeNoteEditor();
      } catch (error) {
        console.error('[Notes] 削除エラー:', error);
        alert('削除に失敗しました');
      }
    };

    // ノート共有機能
    let currentShareNoteId = null;
    let currentShareId = null;

    window.shareNote = async function() {
      if (!currentNoteId || !currentNoteData) return;

      // 共有IDがない場合は生成
      if (!currentNoteData.shareId) {
        try {
          const shareId = generateUUID().substring(0, 12);
          const noteRef = doc(db, 'users', currentUser.email, 'notes', currentNoteId);
          await updateDoc(noteRef, {
            shareId: shareId,
            isPublic: true
          });

          // noteSharesコレクションにインデックス追加
          const shareRef = doc(db, 'noteShares', shareId);
          await setDoc(shareRef, {
            noteId: currentNoteId,
            ownerEmail: currentUser.email,
            createdAt: serverTimestamp(),
            isActive: true
          });

          currentNoteData.shareId = shareId;
          console.log('[Notes] 共有ID生成:', shareId);
        } catch (error) {
          console.error('[Notes] 共有ID生成エラー:', error);
          alert('共有リンクの生成に失敗しました');
          return;
        }
      }

      currentShareNoteId = currentNoteId;
      currentShareId = currentNoteData.shareId;

      // 共有リンクを設定
      const shareUrl = `${window.location.origin}/note-view.html?id=${currentShareId}`;
      document.getElementById('shareLinkInput').value = shareUrl;

      // モーダルを開く
      openShareModal();
    };

    // 共有モーダルを開く
    async function openShareModal() {
      const overlay = document.getElementById('shareModalOverlay');
      const modal = document.getElementById('shareModal');
      const roomList = document.getElementById('shareRoomList');

      overlay.classList.add('active');
      setTimeout(() => modal.classList.add('active'), 10);

      // ルーム一覧を読み込み
      roomList.innerHTML = '<div class="share-loading"><i class="bi bi-arrow-repeat" style="animation: spin 1s linear infinite;"></i> 読み込み中...</div>';

      try {
        const roomsRef = collection(db, 'rooms');
        // membersにはユーザー名が入っている（emailではない）
        const userName = currentUser.name || currentUser.email.split('@')[0];
        console.log('[Notes] ルーム検索ユーザー名:', userName);
        const q = query(
          roomsRef,
          where('members', 'array-contains', userName),
          limit(50)
        );
        const snapshot = await getDocs(q);
        console.log('[Notes] ルーム検索結果:', snapshot.size, '件');

        const rooms = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          // システムルームとKeepルームは除外
          if (data.type !== 'system' && data.type !== 'keep') {
            rooms.push({ id: doc.id, ...data });
          }
        });

        if (rooms.length === 0) {
          roomList.innerHTML = '<div class="share-loading">送信先のチャットルームがありません</div>';
          return;
        }

        // ユーザーアイコンを取得するためにusersコレクションを読み込み
        const usersSnapshot = await getDocs(collection(db, 'users'));
        const usersMap = {};
        usersSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.userName) {
            usersMap[data.userName] = data.userIconUrl || data.photoURL || data.iconUrl || '';
          }
        });

        const html = rooms.map(room => {
          let iconHtml = '';
          let typeLabel = 'チャット';
          let roomName = room.name || '';
          let otherUserName = '';

          if (room.type === 'team') {
            // チーム・全体チャットは💬絵文字
            iconHtml = '<span style="font-size: 22px;">💬</span>';
            typeLabel = 'チーム';
          } else if (room.type === 'direct' || room.type === 'dm') {
            typeLabel = '個別';
            // membersから相手の名前を取得
            if (room.members && Array.isArray(room.members)) {
              otherUserName = room.members.find(m => m !== userName) || '';
              if (otherUserName) roomName = otherUserName;
            }
            // 相手のアイコンを取得
            const iconUrl = usersMap[otherUserName] || '';
            if (iconUrl) {
              iconHtml = `<img src="${iconUrl}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" onerror="this.outerHTML='<i class=\\'bi bi-person-fill\\'></i>'">`;
            } else {
              iconHtml = '<i class="bi bi-person-fill"></i>';
            }
          } else {
            iconHtml = '<i class="bi bi-chat-fill"></i>';
          }

          // ルーム名がない場合はmembersから生成
          if (!roomName && room.members && Array.isArray(room.members)) {
            roomName = room.members.filter(m => m !== userName).join(', ') || room.members.join(', ');
          }

          return `
            <div class="share-room-item" onclick="sendNoteToRoom('${room.id}', '${escapeHtml(roomName || '無題のルーム')}')">
              <div class="share-room-icon">
                ${iconHtml}
              </div>
              <div class="share-room-info">
                <div class="share-room-name">${escapeHtml(roomName || '無題のルーム')}</div>
                <div class="share-room-type">${typeLabel}</div>
              </div>
            </div>
          `;
        }).join('');

        roomList.innerHTML = html;

      } catch (error) {
        console.error('[Notes] ルーム一覧読み込みエラー:', error);
        roomList.innerHTML = '<div class="share-loading">ルーム一覧の読み込みに失敗しました</div>';
      }
    }

    // 共有モーダルを閉じる
    window.closeShareModal = function() {
      const overlay = document.getElementById('shareModalOverlay');
      const modal = document.getElementById('shareModal');

      modal.classList.remove('active');
      setTimeout(() => {
        overlay.classList.remove('active');
      }, 300);
    };

    // 共有リンクをコピー
    window.copyShareLink = async function() {
      const input = document.getElementById('shareLinkInput');
      const url = input.value;

      try {
        await navigator.clipboard.writeText(url);
        alert('リンクをコピーしました');
      } catch (error) {
        // フォールバック
        input.select();
        document.execCommand('copy');
        alert('リンクをコピーしました');
      }
    };

    // ノートをチャットルームに送信
    window.sendNoteToRoom = async function(roomId, roomName) {
      if (!currentShareNoteId || !currentShareId) return;

      closeShareModal();

      try {
        const shareUrl = `${window.location.origin}/note-view.html?id=${currentShareId}`;
        const noteTitle = currentNoteData?.title || '無題のノート';

        // メッセージを送信
        const messagesRef = collection(db, 'rooms', roomId, 'messages');
        await addDoc(messagesRef, {
          text: `📝 ノートを共有しました\n\n「${noteTitle}」\n${shareUrl}`,
          userName: currentUser.name,  // チャットのusersCache検索と一致させる
          userEmail: currentUser.email,
          timestamp: serverTimestamp(),
          type: 'note-share',
          noteShareData: {
            shareId: currentShareId,
            noteId: currentShareNoteId,
            title: noteTitle,
            url: shareUrl
          }
        });

        // ルームのlastMessage更新
        const roomRef = doc(db, 'rooms', roomId);
        await updateDoc(roomRef, {
          lastMessage: `📝 ${noteTitle}`,
          lastMessageAt: serverTimestamp()
        });

        console.log('[Notes] ノート共有送信完了:', roomId);
        alert(`「${roomName}」にノートを共有しました`);

      } catch (error) {
        console.error('[Notes] ノート共有送信エラー:', error);
        alert('送信に失敗しました');
      }

      currentShareNoteId = null;
      currentShareId = null;
    };

    init();
  </script>
</body>
</html>
