<!DOCTYPE html>
<html>
<head>
  <!-- Cache Bust: 2025-12-22-v355 - Ë®≠ÂÆöÁµ±ÂêàÔºàÂÄã‰∫∫ÊÉÖÂ†±„ÉªÈÄöÁü•Ë®≠ÂÆö„Éª„Ç¢„Ç§„Ç≥„É≥Á∑®ÈõÜÔºâ -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base target="_top">
  <title>„Éû„Ç§„Éö„Éº„Ç∏ - FURIRA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/reborn-theme.css?v=298">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    .content-container {
      padding: 16px;
      max-width: 600px;
      margin: 0 auto;
    }

    /* „Éó„É≠„Éï„Ç£„Éº„É´„Ç´„Éº„Éâ */
    .profile-card {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 16px;
      color: white;
      text-align: center;
      position: relative;
      background-size: cover;
      background-position: center;
    }
    /* ËÉåÊôØÁ∑®ÈõÜ„Éú„Çø„É≥ */
    .profile-bg-edit-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.25);
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      backdrop-filter: blur(4px);
    }
    .profile-bg-edit-btn:hover {
      background: rgba(255, 255, 255, 0.4);
    }
    .profile-bg-edit-btn:active {
      transform: scale(0.95);
    }
    /* ËÉåÊôØÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ */
    .bg-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .bg-modal-backdrop.active {
      display: flex;
    }
    .bg-modal {
      background: white;
      border-radius: 20px;
      width: 90%;
      max-width: 360px;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .bg-modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .bg-modal-title {
      font-size: 17px;
      font-weight: 600;
      color: #1f2937;
    }
    .bg-modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: #f3f4f6;
      border-radius: 50%;
      font-size: 18px;
      color: #6b7280;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .bg-modal-body {
      padding: 20px;
      max-height: 60vh;
      overflow-y: auto;
    }
    .bg-section-title {
      font-size: 13px;
      color: #6b7280;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .bg-gradient-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }
    .bg-gradient-item {
      aspect-ratio: 1;
      border-radius: 12px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s;
      position: relative;
    }
    .bg-gradient-item:hover {
      transform: scale(1.05);
    }
    .bg-gradient-item.selected {
      border-color: #1f2937;
    }
    .bg-gradient-item.selected::after {
      content: '‚úì';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      color: #1f2937;
    }
    .bg-image-upload {
      margin-top: 16px;
    }
    .bg-upload-btn {
      width: 100%;
      padding: 14px;
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      background: #f9fafb;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 14px;
      color: #6b7280;
      transition: all 0.2s;
    }
    .bg-upload-btn:hover {
      border-color: #40B4E5;
      color: #40B4E5;
      background: #f0f9ff;
    }
    .bg-upload-btn i {
      font-size: 20px;
    }
    .bg-preview {
      margin-top: 16px;
      display: none;
    }
    .bg-preview.active {
      display: block;
    }
    .bg-preview-image {
      width: 100%;
      height: 120px;
      border-radius: 12px;
      object-fit: cover;
      margin-bottom: 8px;
    }
    .bg-preview-remove {
      font-size: 13px;
      color: #ef4444;
      background: none;
      border: none;
      cursor: pointer;
    }
    .bg-modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 12px;
    }
    .bg-modal-footer button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .bg-cancel-btn {
      background: #f3f4f6;
      border: none;
      color: #6b7280;
    }
    .bg-save-btn {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      border: none;
      color: white;
    }
    .bg-save-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ÂÖ±ÈÄö */
    .settings-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .settings-modal-backdrop.active {
      display: flex;
    }
    .settings-modal {
      background: white;
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
      max-height: 85vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .settings-modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .settings-modal-title {
      font-size: 17px;
      font-weight: 600;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .settings-modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: #f3f4f6;
      border-radius: 50%;
      font-size: 18px;
      color: #6b7280;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .settings-modal-body {
      padding: 20px;
      max-height: 60vh;
      overflow-y: auto;
    }
    .settings-section {
      margin-bottom: 20px;
    }
    .settings-section:last-child {
      margin-bottom: 0;
    }
    .settings-section-title {
      font-size: 13px;
      color: #6b7280;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .settings-input-group {
      margin-bottom: 16px;
    }
    .settings-input-group:last-child {
      margin-bottom: 0;
    }
    .settings-input-label {
      display: block;
      font-size: 14px;
      color: #374151;
      font-weight: 500;
      margin-bottom: 6px;
    }
    .settings-input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      font-size: 15px;
      transition: border-color 0.2s;
    }
    .settings-input:focus {
      outline: none;
      border-color: #40B4E5;
    }
    .settings-textarea {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      font-size: 15px;
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
    }
    .settings-textarea:focus {
      outline: none;
      border-color: #40B4E5;
    }
    .settings-toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    .settings-toggle-row:last-child {
      border-bottom: none;
    }
    .settings-toggle-label {
      font-size: 15px;
      color: #1f2937;
    }
    .settings-toggle {
      position: relative;
      width: 50px;
      height: 28px;
    }
    .settings-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .settings-toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #d1d5db;
      transition: .3s;
      border-radius: 28px;
    }
    .settings-toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .settings-toggle input:checked + .settings-toggle-slider {
      background-color: #40B4E5;
    }
    .settings-toggle input:checked + .settings-toggle-slider:before {
      transform: translateX(22px);
    }
    .settings-modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 12px;
    }
    .settings-modal-footer button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .settings-cancel-btn {
      background: #f3f4f6;
      border: none;
      color: #6b7280;
    }
    .settings-save-btn {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      border: none;
      color: white;
    }
    .settings-save-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* „Éó„É≠„Éï„Ç£„Éº„É´Á∑®ÈõÜÂèØËÉΩ„Çπ„Çø„Ç§„É´ */
    .profile-avatar-editable {
      cursor: pointer;
      position: relative;
    }
    .profile-avatar-editable:hover::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      border-radius: 50%;
    }
    .profile-avatar-editable:hover::before {
      content: '\f030';
      font-family: 'bootstrap-icons';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 24px;
      z-index: 1;
    }
    .profile-name-editable {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .profile-name-editable:hover {
      text-decoration: underline;
    }
    .profile-name-edit-icon {
      font-size: 14px;
      opacity: 0.7;
    }

    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px;
      font-size: 40px;
      border: 3px solid rgba(255,255,255,0.5);
      overflow: hidden;
    }
    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .profile-avatar {
      position: relative;
    }
    .profile-avatar-edit-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.5);
      color: white;
      font-size: 14px;
      padding: 4px 0;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .profile-avatar:hover .profile-avatar-edit-overlay {
      opacity: 1;
    }
    .profile-name {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .profile-role {
      font-size: 13px;
      background: rgba(0,0,0,0.15);
      padding: 4px 12px;
      border-radius: 12px;
      display: inline-block;
    }
    .profile-month {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 8px;
    }

    /* Â†±ÈÖ¨„Çµ„Éû„É™„Éº„Ç´„Éº„Éâ */
    .compensation-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .compensation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .compensation-title {
      font-size: 14px;
      color: #6b7280;
      font-weight: 600;
    }
    .compensation-amount {
      font-size: 32px;
      font-weight: 800;
      color: #1f2937;
      margin-bottom: 4px;
    }
    .compensation-goal {
      font-size: 14px;
      color: #6b7280;
    }
    .compensation-goal .goal-amount {
      color: #40B4E5;
      font-weight: 600;
    }

    /* ÈÄ≤Êçó„Éê„Éº */
    .progress-container {
      margin: 16px 0;
    }
    .progress-bar-bg {
      height: 12px;
      background: #e5e7eb;
      border-radius: 6px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #40B4E5 0%, #10b981 100%);
      border-radius: 6px;
      transition: width 0.5s ease;
    }
    .progress-text {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 12px;
      color: #6b7280;
    }
    .progress-percent {
      font-weight: 700;
      color: #40B4E5;
    }

    /* ÈÄ≤ÊçóÂêπ„ÅçÂá∫„Åó */
    .progress-milestone {
      margin-top: 12px;
      padding: 10px 14px;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 12px;
      font-size: 13px;
      color: #92400e;
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .progress-milestone::before {
      content: '';
      position: absolute;
      top: -6px;
      left: 20px;
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 6px solid #fef3c7;
    }
    .progress-milestone.milestone-50 {
      background: linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%);
      color: #1e40af;
    }
    .progress-milestone.milestone-50::before {
      border-bottom-color: #dbeafe;
    }
    .progress-milestone.milestone-80 {
      background: linear-gradient(135deg, #d1fae5 0%, #6ee7b7 100%);
      color: #065f46;
    }
    .progress-milestone.milestone-80::before {
      border-bottom-color: #d1fae5;
    }
    .progress-milestone.milestone-100 {
      background: linear-gradient(135deg, #fce7f3 0%, #f9a8d4 100%);
      color: #9d174d;
    }
    .progress-milestone.milestone-100::before {
      border-bottom-color: #fce7f3;
    }

    /* ÂÜÖË®≥„Ç´„Éº„Éâ */
    .breakdown-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .breakdown-title {
      font-size: 14px;
      color: #374151;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .breakdown-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    .breakdown-item:last-child {
      border-bottom: none;
    }
    .breakdown-label {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .breakdown-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .breakdown-icon.listing {
      background: #dbeafe;
    }
    .breakdown-icon.shipping {
      background: #fef3c7;
    }
    .breakdown-name {
      font-size: 14px;
      color: #374151;
      font-weight: 500;
    }
    .breakdown-count {
      font-size: 12px;
      color: #9ca3af;
    }
    .breakdown-amount {
      font-size: 16px;
      font-weight: 700;
      color: #1f2937;
    }

    /* „É©„É≥„Ç≠„É≥„Ç∞„Ç´„Éº„Éâ */
    .ranking-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .ranking-title {
      font-size: 14px;
      color: #374151;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .ranking-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      border-radius: 10px;
      margin-bottom: 8px;
      background: #f9fafb;
    }
    .ranking-item.highlight {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 2px solid #f59e0b;
    }
    .ranking-position {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      margin-right: 12px;
    }
    .ranking-position.gold {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: white;
    }
    .ranking-position.silver {
      background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
      color: white;
    }
    .ranking-position.bronze {
      background: linear-gradient(135deg, #f59e0b 0%, #b45309 100%);
      color: white;
    }
    .ranking-position.normal {
      background: #e5e7eb;
      color: #6b7280;
    }
    .ranking-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
      font-weight: 500;
    }
    .ranking-name.me {
      color: #b45309;
      font-weight: 700;
    }
    .ranking-amount {
      font-size: 14px;
      font-weight: 700;
      color: #40B4E5;
    }
    .ranking-opt-out-message {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      background: #f3f4f6;
      border-radius: 10px;
      color: #6b7280;
      font-size: 14px;
      margin-bottom: 8px;
    }
    .ranking-opt-out-message i {
      font-size: 18px;
    }

    /* „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ */
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 8px;
    }
    .action-btn {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .action-btn:hover {
      background: #f9fafb;
      border-color: #40B4E5;
    }
    .action-btn:active {
      transform: scale(0.98);
    }
    .action-btn i {
      font-size: 24px;
      color: #40B4E5;
      margin-bottom: 8px;
      display: block;
    }
    .action-btn span {
      font-size: 13px;
      color: #374151;
      font-weight: 500;
    }

    /* ÁõÆÊ®ôË®≠ÂÆö„É¢„Éº„ÉÄ„É´ */
    .goal-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .goal-modal {
      background: white;
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .goal-modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 16px;
      text-align: center;
    }
    .goal-input-group {
      margin-bottom: 20px;
    }
    .goal-input-group label {
      display: block;
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    .goal-input-wrapper {
      display: flex;
      align-items: center;
      background: #f3f4f6;
      border-radius: 10px;
      padding: 12px 16px;
    }
    .goal-input-wrapper span {
      font-size: 18px;
      color: #6b7280;
      margin-right: 8px;
    }
    .goal-input-wrapper input {
      flex: 1;
      min-width: 0;
      border: none;
      background: transparent;
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
      outline: none;
      text-align: right;
    }
    .goal-presets {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .goal-preset-btn {
      padding: 8px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 20px;
      background: white;
      font-size: 13px;
      color: #374151;
      cursor: pointer;
    }
    .goal-preset-btn:hover {
      border-color: #40B4E5;
      color: #40B4E5;
    }
    .goal-skip-option {
      margin-bottom: 20px;
      text-align: center;
    }
    .goal-skip-btn {
      padding: 10px 20px;
      border: 1px solid #9ca3af;
      border-radius: 8px;
      background: #f9fafb;
      font-size: 13px;
      color: #6b7280;
      cursor: pointer;
      width: 100%;
    }
    .goal-skip-btn:hover {
      background: #f3f4f6;
      border-color: #6b7280;
    }
    .ranking-option {
      margin-bottom: 20px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
    }
    .ranking-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }
    .ranking-toggle input {
      display: none;
    }
    .toggle-slider {
      width: 44px;
      height: 24px;
      background: #d1d5db;
      border-radius: 12px;
      position: relative;
      transition: background 0.2s;
      flex-shrink: 0;
    }
    .toggle-slider::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: transform 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .ranking-toggle input:checked + .toggle-slider {
      background: #40B4E5;
    }
    .ranking-toggle input:checked + .toggle-slider::after {
      transform: translateX(20px);
    }
    .toggle-label {
      font-size: 14px;
      color: #374151;
      font-weight: 500;
    }
    .ranking-option-note {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 8px;
      padding-left: 56px;
    }
    .goal-modal-buttons {
      display: flex;
      gap: 12px;
    }
    .goal-modal-buttons button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .goal-cancel-btn {
      background: #f3f4f6;
      border: none;
      color: #6b7280;
    }
    .goal-save-btn {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      border: none;
      color: white;
    }

    /* ÁõÆÊ®ôÂ±•Ê≠¥„É¢„Éº„ÉÄ„É´ */
    .history-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .history-modal {
      background: white;
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .history-modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 16px;
      text-align: center;
    }
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .history-item {
      background: #f9fafb;
      border-radius: 12px;
      padding: 16px;
      border-left: 4px solid #40B4E5;
    }
    .history-item.achieved {
      border-left-color: #10b981;
    }
    .history-item.not-achieved {
      border-left-color: #ef4444;
    }
    .history-month {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }
    .history-amounts {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .history-goal, .history-actual {
      font-size: 13px;
      color: #6b7280;
    }
    .history-goal span, .history-actual span {
      font-weight: 600;
      color: #1f2937;
    }
    .history-progress {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .history-progress-bar {
      flex: 1;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
    }
    .history-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #40B4E5, #1E8FBF);
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    .history-progress-fill.achieved {
      background: linear-gradient(90deg, #10b981, #059669);
    }
    .history-percent {
      font-size: 14px;
      font-weight: 700;
      color: #40B4E5;
      min-width: 45px;
      text-align: right;
    }
    .history-percent.achieved {
      color: #10b981;
    }
    .history-empty {
      text-align: center;
      padding: 32px 16px;
      color: #9ca3af;
    }
    .history-empty i {
      font-size: 48px;
      margin-bottom: 12px;
      display: block;
    }
    .history-close-btn {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: #f3f4f6;
      border: none;
      color: #6b7280;
      margin-top: 16px;
    }
    /* Â±•Ê≠¥Ë©≥Á¥∞„Çª„ÇØ„Ç∑„Éß„É≥ */
    .history-details {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }
    .history-breakdown {
      display: flex;
      gap: 12px;
      margin-bottom: 8px;
    }
    .history-breakdown-item {
      flex: 1;
      background: white;
      padding: 8px;
      border-radius: 8px;
      text-align: center;
    }
    .history-breakdown-icon {
      font-size: 16px;
      margin-bottom: 4px;
    }
    .history-breakdown-label {
      font-size: 10px;
      color: #9ca3af;
    }
    .history-breakdown-value {
      font-size: 12px;
      font-weight: 600;
      color: #374151;
    }
    .history-ranking {
      background: white;
      padding: 8px 12px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .history-ranking-label {
      font-size: 12px;
      color: #6b7280;
    }
    .history-ranking-value {
      font-size: 14px;
      font-weight: 700;
      color: #f59e0b;
    }
    .history-toggle {
      font-size: 11px;
      color: #40B4E5;
      cursor: pointer;
      text-align: center;
      margin-top: 8px;
    }

    /* „ÅäÁü•„Çâ„Åõ„É¢„Éº„ÉÄ„É´ */
    .announce-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .announce-modal {
      background: white;
      border-radius: 16px;
      padding: 0;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .announce-modal-header {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      color: white;
      padding: 16px 20px;
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .announce-modal-body {
      padding: 0;
      max-height: 60vh;
      overflow-y: auto;
    }
    .announce-list {
      display: flex;
      flex-direction: column;
    }
    .announce-item {
      padding: 16px 20px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s;
    }
    .announce-item:hover {
      background: #f9fafb;
    }
    .announce-item.unread {
      background: #eff6ff;
    }
    .announce-item.unread:hover {
      background: #dbeafe;
    }
    .announce-item-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .announce-priority {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
    }
    .announce-priority.important {
      background: #fef2f2;
      color: #dc2626;
    }
    .announce-priority.normal {
      background: #f0f9ff;
      color: #0284c7;
    }
    .announce-date {
      font-size: 12px;
      color: #9ca3af;
    }
    .announce-title {
      font-size: 15px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }
    .announce-preview {
      font-size: 13px;
      color: #6b7280;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .announce-empty {
      text-align: center;
      padding: 40px 20px;
      color: #9ca3af;
    }
    .announce-empty i {
      font-size: 48px;
      margin-bottom: 12px;
      display: block;
    }
    .announce-modal-footer {
      padding: 12px 20px;
      border-top: 1px solid #f0f0f0;
    }
    .announce-close-btn {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: #f3f4f6;
      border: none;
      color: #6b7280;
    }
    /* „ÅäÁü•„Çâ„ÅõË©≥Á¥∞ */
    .announce-detail {
      padding: 20px;
    }
    .announce-detail-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 8px;
    }
    .announce-detail-meta {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .announce-detail-body {
      font-size: 14px;
      color: #374151;
      line-height: 1.7;
      white-space: pre-wrap;
    }
    .announce-back-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 14px;
      color: #40B4E5;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      margin-bottom: 16px;
    }
    /* „Éô„É´„Ç¢„Ç§„Ç≥„É≥„ÅÆ„Éê„ÉÉ„Ç∏Ôºàv288: Ëµ§„ÅÑ„Éâ„ÉÉ„ÉàË°®Á§∫„Å´Â§âÊõ¥Ôºâ */
    .minimal-header-icon {
      position: relative;
    }
    .announce-dot {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      display: none;
      box-shadow: 0 0 0 2px white;
    }
    .announce-dot.active {
      display: block;
    }

    /* Ë®≠ÂÆö„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥ */
    .settings-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 200px;
      overflow: hidden;
      display: none;
      z-index: 1001;
    }
    .settings-dropdown.active {
      display: block;
    }
    .settings-dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      font-size: 14px;
      color: #1f2937;
      text-decoration: none;
      transition: background 0.2s;
      cursor: pointer;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }
    .settings-dropdown-item:hover {
      background: #f3f4f6;
    }
    .settings-dropdown-item i {
      font-size: 18px;
      color: #6b7280;
      width: 24px;
      text-align: center;
    }
    .settings-dropdown-item.admin-only {
      display: none;
    }
    .settings-dropdown-item.admin-only.visible {
      display: flex;
      border-top: 1px solid #e5e7eb;
      color: #6366f1;
    }
    .settings-dropdown-item.admin-only.visible i {
      color: #6366f1;
    }
    .settings-dropdown-divider {
      height: 1px;
      background: #e5e7eb;
      margin: 4px 0;
    }

    /* „É≠„Éº„Éá„Ç£„É≥„Ç∞ */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    /* ÈùûÂØæË±°„É¶„Éº„Ç∂„ÉºÂêë„Åë„É°„ÉÉ„Çª„Éº„Ç∏ */
    .not-eligible {
      text-align: center;
      padding: 40px 20px;
    }
    .not-eligible i {
      font-size: 64px;
      color: #d1d5db;
      margin-bottom: 16px;
    }
    .not-eligible h3 {
      font-size: 18px;
      color: #374151;
      margin-bottom: 8px;
    }
    .not-eligible p {
      font-size: 14px;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...</p>
    </div>
  </div>

  <!-- YouTubeÈ¢®„Éü„Éã„Éû„É´„Éò„ÉÉ„ÉÄ„Éº -->
  <style>
    .minimal-header {
      background: #ffffff;
      height: 56px;
      padding: 0 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 1px solid #f0f0f0;
    }
    .minimal-header-logo {
      width: 100px;
      height: auto;
      cursor: pointer;
    }
    .minimal-header-icons {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .minimal-header-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 22px;
      transition: background 0.2s;
    }
    .minimal-header-icon:hover {
      background: #f2f2f2;
    }
    .minimal-header-icon:active {
      background: #e5e5e5;
    }
  </style>
  <div class="minimal-header">
    <img src="/images/furira-square-logo.png?v=20251209" alt="Furira" class="minimal-header-logo" onclick="window.parent.postMessage({type:'navigate', page:'home'}, '*')">
    <div class="minimal-header-icons">
      <button class="minimal-header-icon" title="ÈÄöÁü•" onclick="openAnnouncePage()">
        <i class="bi bi-bell"></i>
        <span class="announce-dot" id="announceDot"></span>
      </button>
      <div style="position: relative;">
        <button class="minimal-header-icon" title="Ë®≠ÂÆö" onclick="toggleSettingsDropdown(event)">
          <i class="bi bi-gear"></i>
        </button>
        <div class="settings-dropdown" id="settingsDropdown">
          <button class="settings-dropdown-item" onclick="openPersonalInfoModal()">
            <i class="bi bi-person-badge"></i>
            <span>ÂÄã‰∫∫ÊÉÖÂ†±Ë®≠ÂÆö</span>
          </button>
          <button class="settings-dropdown-item" onclick="openNotificationSettingsModal()">
            <i class="bi bi-bell"></i>
            <span>ÈÄöÁü•Ë®≠ÂÆö</span>
          </button>
          <div class="settings-dropdown-divider"></div>
          <button class="settings-dropdown-item" onclick="window.parent.postMessage({type:'navigate', page:'config'}, '*')">
            <i class="bi bi-sliders"></i>
            <span>Ë®≠ÂÆöÁÆ°ÁêÜ</span>
          </button>
          <button class="settings-dropdown-item" onclick="window.parent.postMessage({type:'navigate', page:'help'}, '*')">
            <i class="bi bi-question-circle"></i>
            <span>„Éò„É´„Éó</span>
          </button>
          <button class="settings-dropdown-item admin-only" id="adminAnnounceLink" onclick="openAdminAnnounce()">
            <i class="bi bi-megaphone"></i>
            <span>„ÅäÁü•„Çâ„ÅõÁÆ°ÁêÜ</span>
          </button>
          <button class="settings-dropdown-item admin-only" id="adminPlanLink" onclick="openPlanManagement()">
            <i class="bi bi-award"></i>
            <span>„Éó„É©„É≥ÁÆ°ÁêÜ</span>
          </button>
          <div class="settings-dropdown-divider"></div>
          <button class="settings-dropdown-item" onclick="openPrivacyPolicy()">
            <i class="bi bi-file-text"></i>
            <span>„Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº</span>
          </button>
          <button class="settings-dropdown-item" onclick="openTermsOfService()">
            <i class="bi bi-file-earmark-text"></i>
            <span>Âà©Áî®Ë¶èÁ¥Ñ</span>
          </button>
          <div class="settings-dropdown-divider"></div>
          <button class="settings-dropdown-item" onclick="openFeedback()">
            <i class="bi bi-chat-square-text"></i>
            <span>„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÈÄÅ‰ø°</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="content-container" id="mainContent">
    <!-- ÂãïÁöÑ„Å´Ë°®Á§∫ -->
  </div>

  <!-- ÁõÆÊ®ôË®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
  <div class="goal-modal-backdrop" id="goalModal">
    <div class="goal-modal">
      <div class="goal-modal-title">üéØ ‰ªäÊúà„ÅÆÁõÆÊ®ôÈáëÈ°ç„ÇíË®≠ÂÆö</div>
      <div class="goal-input-group">
        <label>ÁõÆÊ®ôÈáëÈ°ç</label>
        <div class="goal-input-wrapper">
          <span>¬•</span>
          <input type="number" id="goalAmountInput" placeholder="10000" step="1000">
        </div>
      </div>
      <div class="goal-presets">
        <button class="goal-preset-btn" onclick="setGoalPreset(5000)">¬•5,000</button>
        <button class="goal-preset-btn" onclick="setGoalPreset(10000)">¬•10,000</button>
        <button class="goal-preset-btn" onclick="setGoalPreset(20000)">¬•20,000</button>
        <button class="goal-preset-btn" onclick="setGoalPreset(30000)">¬•30,000</button>
        <button class="goal-preset-btn" onclick="setGoalPreset(50000)">¬•50,000</button>
      </div>
      <div class="goal-skip-option">
        <button class="goal-skip-btn" onclick="skipGoal()">ÁõÆÊ®ô„ÇíË®≠ÂÆö„Åó„Å™„ÅÑ</button>
      </div>
      <div class="ranking-option">
        <label class="ranking-toggle">
          <input type="checkbox" id="rankingParticipation" checked>
          <span class="toggle-slider"></span>
          <span class="toggle-label">„É©„É≥„Ç≠„É≥„Ç∞„Å´ÂèÇÂä†„Åô„Çã</span>
        </label>
        <div class="ranking-option-note">„Ç™„Éï„Å´„Åô„Çã„Å®‰ªñ„ÅÆ„É°„É≥„Éê„Éº„Å´„ÅÇ„Å™„Åü„ÅÆÈ†Ü‰Ωç„ÅåË°®Á§∫„Åï„Çå„Åæ„Åõ„Çì</div>
      </div>
      <div class="goal-modal-buttons">
        <button class="goal-cancel-btn" onclick="closeGoalModal()">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="goal-save-btn" onclick="saveGoal()">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- Â±•Ê≠¥„É¢„Éº„ÉÄ„É´ -->
  <div class="history-modal-backdrop" id="historyModal">
    <div class="history-modal">
      <div class="history-modal-title">üìä ÁõÆÊ®ôÂ±•Ê≠¥</div>
      <div class="history-list" id="historyList">
        <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
      </div>
      <button class="history-close-btn" onclick="closeHistoryModal()">Èñâ„Åò„Çã</button>
    </div>
  </div>

  <!-- ËÉåÊôØÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ -->
  <div class="bg-modal-backdrop" id="bgModal">
    <div class="bg-modal">
      <div class="bg-modal-header">
        <span class="bg-modal-title">ËÉåÊôØ„ÇíÂ§âÊõ¥</span>
        <button class="bg-modal-close" onclick="closeBgModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>
      <div class="bg-modal-body">
        <div class="bg-section-title">„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥</div>
        <div class="bg-gradient-grid" id="bgGradientGrid">
          <!-- „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„Éó„É™„Çª„ÉÉ„ÉàÔºàJavaScript„ÅßÁîüÊàêÔºâ -->
        </div>
        <div class="bg-section-title">„Ç´„Çπ„Çø„É†ÁîªÂÉè</div>
        <div class="bg-image-upload">
          <label class="bg-upload-btn" for="bgImageInput">
            <i class="bi bi-image"></i>
            <span>ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</span>
          </label>
          <input type="file" id="bgImageInput" accept="image/*" style="display: none;" onchange="handleBgImageSelect(event)">
        </div>
        <div class="bg-preview" id="bgPreview">
          <img class="bg-preview-image" id="bgPreviewImage" src="" alt="„Éó„É¨„Éì„É•„Éº">
          <button class="bg-preview-remove" onclick="removeBgImage()">
            <i class="bi bi-trash"></i> ÁîªÂÉè„ÇíÂâäÈô§
          </button>
        </div>
      </div>
      <div class="bg-modal-footer">
        <button class="bg-cancel-btn" onclick="closeBgModal()">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="bg-save-btn" id="bgSaveBtn" onclick="saveBgSetting()">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- „ÅäÁü•„Çâ„Åõ„É¢„Éº„ÉÄ„É´ -->
  <div class="announce-modal-backdrop" id="announceModal">
    <div class="announce-modal">
      <div class="announce-modal-header">
        <i class="bi bi-bell"></i> „ÅäÁü•„Çâ„Åõ
      </div>
      <div class="announce-modal-body" id="announceModalBody">
        <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
      </div>
      <div class="announce-modal-footer">
        <button class="announce-close-btn" onclick="closeAnnouncementModal()">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>

  <!-- ÂÄã‰∫∫ÊÉÖÂ†±Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
  <div class="settings-modal-backdrop" id="personalInfoModal">
    <div class="settings-modal">
      <div class="settings-modal-header">
        <span class="settings-modal-title">
          <i class="bi bi-person-badge"></i> ÂÄã‰∫∫ÊÉÖÂ†±Ë®≠ÂÆö
        </span>
        <button class="settings-modal-close" onclick="closePersonalInfoModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>
      <div class="settings-modal-body">
        <div class="settings-section">
          <div class="settings-section-title">üì¶ Áô∫ÈÄÅÂÖàÊÉÖÂ†±</div>
          <div class="settings-input-group">
            <label class="settings-input-label">ÈÉµ‰æøÁï™Âè∑</label>
            <input type="text" class="settings-input" id="shippingPostalCode" placeholder="000-0000">
          </div>
          <div class="settings-input-group">
            <label class="settings-input-label">‰ΩèÊâÄ</label>
            <textarea class="settings-textarea" id="shippingAddress" placeholder="ÈÉΩÈÅìÂ∫úÁúå Â∏ÇÂå∫Áî∫Êùë Áï™Âú∞"></textarea>
          </div>
          <div class="settings-input-group">
            <label class="settings-input-label">Ê∞èÂêç</label>
            <input type="text" class="settings-input" id="shippingName" placeholder="Â±±Áî∞ Â§™ÈÉé">
          </div>
          <div class="settings-input-group">
            <label class="settings-input-label">ÈõªË©±Áï™Âè∑</label>
            <input type="tel" class="settings-input" id="shippingPhone" placeholder="090-0000-0000">
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">üè¶ Âè£Â∫ßÊÉÖÂ†±</div>
          <div class="settings-input-group">
            <label class="settings-input-label">ÈäÄË°åÂêç</label>
            <input type="text" class="settings-input" id="bankName" placeholder="‚óã‚óãÈäÄË°å">
          </div>
          <div class="settings-input-group">
            <label class="settings-input-label">ÊîØÂ∫óÂêç</label>
            <input type="text" class="settings-input" id="bankBranch" placeholder="‚óã‚óãÊîØÂ∫ó">
          </div>
          <div class="settings-input-group">
            <label class="settings-input-label">Âè£Â∫ßÁ®ÆÂà•</label>
            <select class="settings-input" id="bankAccountType">
              <option value="ordinary">ÊôÆÈÄö</option>
              <option value="checking">ÂΩìÂ∫ß</option>
            </select>
          </div>
          <div class="settings-input-group">
            <label class="settings-input-label">Âè£Â∫ßÁï™Âè∑</label>
            <input type="text" class="settings-input" id="bankAccountNumber" placeholder="0000000">
          </div>
          <div class="settings-input-group">
            <label class="settings-input-label">Âè£Â∫ßÂêçÁæ©Ôºà„Ç´„Çø„Ç´„ÉäÔºâ</label>
            <input type="text" class="settings-input" id="bankAccountHolder" placeholder="„É§„Éû„ÉÄ „Çø„É≠„Ç¶">
          </div>
        </div>
      </div>
      <div class="settings-modal-footer">
        <button class="settings-cancel-btn" onclick="closePersonalInfoModal()">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="settings-save-btn" id="personalInfoSaveBtn" onclick="savePersonalInfo()">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- ÈÄöÁü•Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
  <div class="settings-modal-backdrop" id="notificationSettingsModal">
    <div class="settings-modal">
      <div class="settings-modal-header">
        <span class="settings-modal-title">
          <i class="bi bi-bell"></i> ÈÄöÁü•Ë®≠ÂÆö
        </span>
        <button class="settings-modal-close" onclick="closeNotificationSettingsModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>
      <div class="settings-modal-body">
        <div class="settings-toggle-row">
          <span class="settings-toggle-label">„Éó„ÉÉ„Ç∑„É•ÈÄöÁü•</span>
          <label class="settings-toggle">
            <input type="checkbox" id="pushNotificationToggle">
            <span class="settings-toggle-slider"></span>
          </label>
        </div>
        <div class="settings-toggle-row">
          <span class="settings-toggle-label">ÈÄöÁü•Èü≥</span>
          <label class="settings-toggle">
            <input type="checkbox" id="notificationSoundToggle">
            <span class="settings-toggle-slider"></span>
          </label>
        </div>
      </div>
      <div class="settings-modal-footer">
        <button class="settings-cancel-btn" onclick="closeNotificationSettingsModal()">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="settings-save-btn" id="notificationSaveBtn" onclick="saveNotificationSettings()">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- „É¶„Éº„Ç∂„ÉºÂêçÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
  <div class="settings-modal-backdrop" id="usernameEditModal">
    <div class="settings-modal" style="max-width: 320px;">
      <div class="settings-modal-header">
        <span class="settings-modal-title">
          <i class="bi bi-pencil"></i> „É¶„Éº„Ç∂„ÉºÂêç„ÇíÂ§âÊõ¥
        </span>
        <button class="settings-modal-close" onclick="closeUsernameEditModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>
      <div class="settings-modal-body">
        <div class="settings-input-group">
          <label class="settings-input-label">Êñ∞„Åó„ÅÑ„É¶„Éº„Ç∂„ÉºÂêç</label>
          <input type="text" class="settings-input" id="newUsernameInput" placeholder="„É¶„Éº„Ç∂„ÉºÂêç" maxlength="50">
        </div>
      </div>
      <div class="settings-modal-footer">
        <button class="settings-cancel-btn" onclick="closeUsernameEditModal()">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="settings-save-btn" id="usernameSaveBtn" onclick="saveUsername()">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- „Éó„É≠„Éï„Ç£„Éº„É´ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÁî®hidden input -->
  <input type="file" id="profileImageInput" accept="image/*" style="display: none;" onchange="handleProfileImageSelect(event)">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, getDoc, setDoc, query, where, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "furira.jp",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„Éó„É™„Çª„ÉÉ„Éà
    const GRADIENT_PRESETS = [
      { id: 'blue', gradient: 'linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%)' },
      { id: 'purple', gradient: 'linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%)' },
      { id: 'pink', gradient: 'linear-gradient(135deg, #EC4899 0%, #BE185D 100%)' },
      { id: 'orange', gradient: 'linear-gradient(135deg, #F97316 0%, #EA580C 100%)' },
      { id: 'green', gradient: 'linear-gradient(135deg, #22C55E 0%, #15803D 100%)' },
      { id: 'teal', gradient: 'linear-gradient(135deg, #14B8A6 0%, #0F766E 100%)' },
      { id: 'indigo', gradient: 'linear-gradient(135deg, #6366F1 0%, #4338CA 100%)' },
      { id: 'rose', gradient: 'linear-gradient(135deg, #F43F5E 0%, #BE123C 100%)' },
      { id: 'amber', gradient: 'linear-gradient(135deg, #F59E0B 0%, #D97706 100%)' },
      { id: 'cyan', gradient: 'linear-gradient(135deg, #06B6D4 0%, #0891B2 100%)' },
      { id: 'lime', gradient: 'linear-gradient(135deg, #84CC16 0%, #65A30D 100%)' },
      { id: 'slate', gradient: 'linear-gradient(135deg, #64748B 0%, #475569 100%)' },
    ];

    // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
    let currentUser = null;
    let compensationRecords = [];
    let compensationSettings = {};
    let userProfileBg = { type: 'gradient', value: 'blue' }; // „Éá„Éï„Ç©„É´„Éà
    let selectedBgType = 'gradient';
    let selectedBgValue = 'blue';
    let pendingBgImageFile = null;
    let userGoal = 0;
    let rankingParticipation = true; // „É©„É≥„Ç≠„É≥„Ç∞ÂèÇÂä†„Éï„É©„Ç∞
    let allUsersRankingPrefs = {}; // ÂÖ®„É¶„Éº„Ç∂„Éº„ÅÆ„É©„É≥„Ç≠„É≥„Ç∞ÂèÇÂä†Ë®≠ÂÆö
    let assignedTasks = ['listing', 'shipping']; // „É¶„Éº„Ç∂„Éº„ÅÆÊãÖÂΩì„Çø„Çπ„ÇØÔºà„Éá„Éï„Ç©„É´„Éà„ÅØ‰∏°ÊñπÔºâ

    // ÂàùÊúüÂåñ
    async function init() {
      showLoading(true);

      // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±ÂèñÂæó
      currentUser = {
        email: localStorage.getItem('reborn_user_email') || '',
        name: localStorage.getItem('reborn_user_name') || '„Ç≤„Çπ„Éà',
        permissionId: localStorage.getItem('reborn_user_permission_id') || 'staff',
        permissionDisplay: localStorage.getItem('reborn_user_permission_display') || '„Çπ„Çø„ÉÉ„Éï',
        photoURL: localStorage.getItem('reborn_user_icon_url') || localStorage.getItem('reborn_user_photo_url') || ''
      };

      if (!currentUser.email) {
        showNotEligible('„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô', '„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇÂÜçÂ∫¶„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        showLoading(false);
        return;
      }

      try {
        // Â†±ÈÖ¨Ë®≠ÂÆö„ÇíÂèñÂæó
        await loadCompensationSettings();

        // Â†±ÈÖ¨ÂØæË±°ËÄÖ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        const isEligible = await checkEligibility();

        if (!isEligible) {
          showNotEligible('Â†±ÈÖ¨ÂØæË±°Â§ñ„Åß„Åô', '„Åì„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„ÅØÂ†±ÈÖ¨ÁÆ°ÁêÜ„ÅÆÂØæË±°Â§ñ„Åß„Åô„ÄÇ');
          showLoading(false);
          return;
        }

        // „É¶„Éº„Ç∂„Éº„ÅÆÁõÆÊ®ô„ÇíÂèñÂæó
        await loadUserGoal();

        // „É¶„Éº„Ç∂„Éº„ÅÆÊãÖÂΩì„Çø„Çπ„ÇØ„ÇíÂèñÂæó
        await loadAssignedTasks();

        // ÂÖ®„É¶„Éº„Ç∂„Éº„ÅÆ„É©„É≥„Ç≠„É≥„Ç∞ÂèÇÂä†Ë®≠ÂÆö„ÇíÂèñÂæó
        await loadAllUsersRankingPrefs();

        // Â†±ÈÖ¨„Éá„Éº„Çø„ÇíÂèñÂæó
        await loadCompensationData();

        // „É¶„Éº„Ç∂„Éº„ÅÆËÉåÊôØË®≠ÂÆö„ÇíÂèñÂæó
        await loadUserProfileBg();

        // ÁîªÈù¢„ÇíÊèèÁîª
        renderMyPage();

        // „ÅäÁü•„Çâ„Åõ„ÇíË™≠„ÅøËæº„Çì„Åß„Éê„ÉÉ„Ç∏„ÇíÊõ¥Êñ∞
        await initAnnouncements();

        // ÁÆ°ÁêÜËÄÖ„É°„Éã„É•„ÉºË°®Á§∫„ÉÅ„Çß„ÉÉ„ÇØ
        checkAdminAccess();
      } catch (error) {
        console.error('ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
        showNotEligible('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', '„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
      }

      showLoading(false);
    }

    // ÁÆ°ÁêÜËÄÖ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ
    const ADMIN_EMAILS = ['mercari.yasuhirotakuji@gmail.com'];

    // ÁÆ°ÁêÜËÄÖ„Ç¢„ÇØ„Çª„Çπ„ÉÅ„Çß„ÉÉ„ÇØ
    function checkAdminAccess() {
      if (currentUser && ADMIN_EMAILS.includes(currentUser.email)) {
        const adminLink = document.getElementById('adminAnnounceLink');
        if (adminLink) {
          adminLink.classList.add('visible');
        }
        const adminPlanLink = document.getElementById('adminPlanLink');
        if (adminPlanLink) {
          adminPlanLink.classList.add('visible');
        }
        console.log('ÁÆ°ÁêÜËÄÖ„É°„Éã„É•„ÉºË°®Á§∫:', currentUser.email);
      }
    }

    // Ë®≠ÂÆö„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥Âà∂Âæ°
    window.toggleSettingsDropdown = function(event) {
      event.stopPropagation();
      const dropdown = document.getElementById('settingsDropdown');
      dropdown.classList.toggle('active');
    };

    // „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown && !dropdown.contains(event.target)) {
        dropdown.classList.remove('active');
      }
    });

    // „ÅäÁü•„Çâ„ÅõÁÆ°ÁêÜ„ÇíÈñã„ÅèÔºà„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÈñâ„Åò„Å¶„Åã„ÇâÔºâ
    window.openAdminAnnounce = function() {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) {
        dropdown.classList.remove('active');
      }
      window.open('/admin-announce.html', '_blank');
    };

    // „Éó„É©„É≥ÁÆ°ÁêÜ„ÇíÈñã„Åè
    window.openPlanManagement = function() {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) {
        dropdown.classList.remove('active');
      }
      // iframeÂÜÖ„ÅßÈñã„Åè
      window.parent.postMessage({ type: 'navigate', page: 'plans' }, '*');
    };

    // „Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº„ÇíÈñã„Åè
    window.openPrivacyPolicy = function() {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) {
        dropdown.classList.remove('active');
      }
      // iframeÂÜÖ„ÅßÈñã„ÅèÔºàÊàª„Çã„Éú„Çø„É≥„Åß„Éû„Ç§„Éö„Éº„Ç∏„Å´Êàª„Çå„Çã„Çà„ÅÜ„Å´Ôºâ
      window.parent.postMessage({ type: 'navigate', page: 'privacy-policy' }, '*');
    };

    // Âà©Áî®Ë¶èÁ¥Ñ„ÇíÈñã„Åè
    window.openTermsOfService = function() {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) {
        dropdown.classList.remove('active');
      }
      // iframeÂÜÖ„ÅßÈñã„ÅèÔºàÊàª„Çã„Éú„Çø„É≥„Åß„Éû„Ç§„Éö„Éº„Ç∏„Å´Êàª„Çå„Çã„Çà„ÅÜ„Å´Ôºâ
      window.parent.postMessage({ type: 'navigate', page: 'terms-of-service' }, '*');
    };

    // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÈÄÅ‰ø°„ÇíÈñã„Åè
    window.openFeedback = function() {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) {
        dropdown.classList.remove('active');
      }
      // iframeÂÜÖ„ÅßÈñã„ÅèÔºàÊàª„Çã„Éú„Çø„É≥„Åß„Éû„Ç§„Éö„Éº„Ç∏„Å´Êàª„Çå„Çã„Çà„ÅÜ„Å´Ôºâ
      window.parent.postMessage({ type: 'navigate', page: 'feedback' }, '*');
    };

    // Â†±ÈÖ¨Ë®≠ÂÆö„ÇíÂèñÂæóÔºàlocalStorage„Åã„ÇâconfigÁµåÁî±Ôºâ
    async function loadCompensationSettings() {
      try {
        // localStorage„Åã„ÇâconfigË™≠„ÅøËæº„Åø
        const configStr = localStorage.getItem('config');
        if (configStr) {
          const config = JSON.parse(configStr);
          if (config.Â†±ÈÖ¨Ë®≠ÂÆö) {
            compensationSettings = config.Â†±ÈÖ¨Ë®≠ÂÆö;
            console.log('Â†±ÈÖ¨Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø:', compensationSettings);
            return;
          }
        }

        // Firestore„Åã„Çâ„ÇÇÂèñÂæóË©¶Ë°å
        const docRef = doc(db, 'settings', 'compensation');
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          compensationSettings = docSnap.data();
        } else {
          // „Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö
          compensationSettings = {
            taskRates: { listing: 100, shipping: 100, photography: 50, inspection: 30 },
            mypage: { enabled: true, allowedUsers: [] }
          };
        }
      } catch (error) {
        console.error('Â†±ÈÖ¨Ë®≠ÂÆöÂèñÂæó„Ç®„É©„Éº:', error);
        compensationSettings = {
          taskRates: { listing: 100, shipping: 100 },
          mypage: { enabled: true, allowedUsers: [] }
        };
      }
    }

    // Â†±ÈÖ¨ÂØæË±°ËÄÖ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
    async function checkEligibility() {
      // „Éû„Ç§„Éö„Éº„Ç∏Ê©üËÉΩ„ÅåÁÑ°Âäπ„ÅÆÂ†¥Âêà
      if (compensationSettings.mypage && compensationSettings.mypage.enabled === false) {
        console.log('„Éû„Ç§„Éö„Éº„Ç∏Ê©üËÉΩ„ÅåÁÑ°Âäπ„Åß„Åô');
        return false;
      }

      // allowedUsers„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ„É™„Çπ„Éà„Å´Âê´„Åæ„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
      const allowedUsers = compensationSettings.mypage?.allowedUsers || [];

      // allowedUsers„ÅåÁ©∫ÔºàÊú™Ë®≠ÂÆöÔºâ„ÅÆÂ†¥Âêà„ÅØÂÖ®Âì°Ë®±ÂèØ
      if (allowedUsers.length === 0) {
        console.log('„Éû„Ç§„Éö„Éº„Ç∏: ÂÖ®Âì°Ë®±ÂèØÔºàallowedUsersÊú™Ë®≠ÂÆöÔºâ');
        return true;
      }

      // ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº„Åå„É™„Çπ„Éà„Å´Âê´„Åæ„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
      const isAllowed = allowedUsers.includes(currentUser.email);
      console.log('„Éû„Ç§„Éö„Éº„Ç∏Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØ:', currentUser.email, 'allowed:', isAllowed);

      return isAllowed;
    }

    // „É¶„Éº„Ç∂„Éº„ÅÆÁõÆÊ®ô„ÇíÂèñÂæó
    async function loadUserGoal() {
      try {
        const now = new Date();
        const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const docRef = doc(db, 'userGoals', `${currentUser.email}_${yearMonth}`);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          const data = docSnap.data();
          userGoal = data.goalAmount || 0;
          rankingParticipation = data.rankingParticipation !== false; // „Éá„Éï„Ç©„É´„Éàtrue
        } else {
          userGoal = 0; // ÁõÆÊ®ôÊú™Ë®≠ÂÆö
          rankingParticipation = true;
        }
      } catch (error) {
        console.error('ÁõÆÊ®ôÂèñÂæó„Ç®„É©„Éº:', error);
        userGoal = 0;
        rankingParticipation = true;
      }
    }

    // „É¶„Éº„Ç∂„Éº„ÅÆÊãÖÂΩì„Çø„Çπ„ÇØ„ÇíÂèñÂæó
    async function loadAssignedTasks() {
      try {
        const userRef = doc(db, 'users', currentUser.email);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          const data = userSnap.data();
          // ÊãÖÂΩì„Çø„Çπ„ÇØ„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çå„Å∞„Åù„Çå„Çí‰ΩøÁî®„ÄÅÊú™Ë®≠ÂÆö„Å™„Çâ‰∏°ÊñπÊãÖÂΩì
          assignedTasks = data.assignedTasks || ['listing', 'shipping'];
        } else {
          assignedTasks = ['listing', 'shipping'];
        }
        console.log('ÊãÖÂΩì„Çø„Çπ„ÇØ:', assignedTasks);
      } catch (error) {
        console.error('ÊãÖÂΩì„Çø„Çπ„ÇØÂèñÂæó„Ç®„É©„Éº:', error);
        assignedTasks = ['listing', 'shipping'];
      }
    }

    // ÂÖ®„É¶„Éº„Ç∂„Éº„ÅÆ„É©„É≥„Ç≠„É≥„Ç∞ÂèÇÂä†Ë®≠ÂÆö„ÇíÂèñÂæó
    async function loadAllUsersRankingPrefs() {
      try {
        const now = new Date();
        const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const goalsRef = collection(db, 'userGoals');
        const snapshot = await getDocs(goalsRef);

        allUsersRankingPrefs = {};
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          if (data.yearMonth === yearMonth) {
            allUsersRankingPrefs[data.email] = data.rankingParticipation !== false;
          }
        });
      } catch (error) {
        console.error('„É©„É≥„Ç≠„É≥„Ç∞Ë®≠ÂÆöÂèñÂæó„Ç®„É©„Éº:', error);
      }
    }

    // Â†±ÈÖ¨„Éá„Éº„Çø„ÇíÂèñÂæó
    async function loadCompensationData() {
      try {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;

        const recordsRef = collection(db, 'compensationRecords');
        const snapshot = await getDocs(recordsRef);

        compensationRecords = [];
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          compensationRecords.push({ id: docSnap.id, ...data });
        });

        // ‰ªäÊúà„ÅÆ„Éá„Éº„Çø„ÅÆ„Åø„Éï„Ç£„É´„Çø
        compensationRecords = compensationRecords.filter(r => {
          if (!r.completedAt && !r.recordedAt) return false;
          const dateStr = r.completedAt || r.recordedAt;
          const date = typeof dateStr === 'string' ? new Date(dateStr) : (dateStr.toDate ? dateStr.toDate() : new Date(dateStr));
          return date.getFullYear() === year && (date.getMonth() + 1) === month;
        });
      } catch (error) {
        console.error('Â†±ÈÖ¨„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:', error);
        compensationRecords = [];
      }
    }

    // ÈÄ≤Êçó„Å´Âøú„Åò„Åü„Éû„Ç§„É´„Çπ„Éà„Éº„É≥„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂèñÂæó
    function getMilestoneMessage(percent) {
      if (percent >= 100) {
        return `<div class="progress-milestone milestone-100">üéâ ÁõÆÊ®ôÈÅîÊàê„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ</div>`;
      } else if (percent >= 80) {
        return `<div class="progress-milestone milestone-80">üî• „ÅÇ„Å®Â∞ë„ÅóÔºÅÁõÆÊ®ô„Åæ„Åß„ÅÇ„Å®${100 - percent}%„Åß„ÅôÔºÅ</div>`;
      } else if (percent >= 50) {
        return `<div class="progress-milestone milestone-50">üí™ Êäò„ÇäËøî„ÅóÂú∞ÁÇπ„ÇíÈÄöÈÅéÔºÅ„Åì„ÅÆË™øÂ≠ê„ÅßÈ†ëÂºµ„Çä„Åæ„Åó„Çá„ÅÜÔºÅ</div>`;
      } else if (percent >= 30) {
        return `<div class="progress-milestone">üå± È†ÜË™ø„Å´ÈÄ≤„Çì„Åß„ÅÑ„Åæ„ÅôÔºÅÁõÆÊ®ô„ÅÆ${percent}%ÈÅîÊàê‰∏≠ÔºÅ</div>`;
      }
      return '';
    }

    // „Éû„Ç§„Éö„Éº„Ç∏„ÇíÊèèÁîª
    function renderMyPage() {
      const now = new Date();
      const monthName = `${now.getFullYear()}Âπ¥${now.getMonth() + 1}Êúà`;

      // Ëá™ÂàÜ„ÅÆ„Éá„Éº„Çø„ÇíÈõÜË®à
      const myRecords = compensationRecords.filter(r => r.staffEmail === currentUser.email);
      const myStats = calculateStats(myRecords);

      // „É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„Çø„ÇíÁîüÊàê
      const rankingData = calculateRanking();
      const myRank = rankingData.findIndex(r => r.email === currentUser.email) + 1;

      // ÈÄ≤ÊçóÁéá„ÇíË®àÁÆó
      const progressPercent = userGoal > 0 ? Math.min(100, Math.round((myStats.totalAmount / userGoal) * 100)) : 0;

      // „Ç¢„Éê„Çø„ÉºÔºà„ÇØ„É™„ÉÉ„ÇØÂèØËÉΩÔºâ
      const avatarHtml = currentUser.photoURL
        ? `<img src="${currentUser.photoURL}" alt="„Ç¢„Éê„Çø„Éº">`
        : 'üë§';

      // ËÉåÊôØ„Çπ„Çø„Ç§„É´
      const bgStyle = getProfileBgStyle();

      const html = `
        <!-- „Éó„É≠„Éï„Ç£„Éº„É´„Ç´„Éº„Éâ -->
        <div class="profile-card" id="profileCard" style="${bgStyle}">
          <button class="profile-bg-edit-btn" onclick="openBgModal()" title="ËÉåÊôØ„ÇíÂ§âÊõ¥">
            <i class="bi bi-pencil"></i>
          </button>
          <div class="profile-avatar" onclick="clickProfileImage()" title="„Ç¢„Ç§„Ç≥„É≥„ÇíÂ§âÊõ¥" style="cursor: pointer;">
            ${avatarHtml}
            <div class="profile-avatar-edit-overlay"><i class="bi bi-camera"></i></div>
          </div>
          <div class="profile-name" onclick="openUsernameEditModal()" title="„É¶„Éº„Ç∂„ÉºÂêç„ÇíÂ§âÊõ¥" style="cursor: pointer;">${escapeHtml(currentUser.name)}„Åï„Çì <i class="bi bi-pencil" style="font-size: 12px; opacity: 0.7;"></i></div>
          <div class="profile-role">${escapeHtml(stripEmoji(currentUser.permissionDisplay))}</div>
          <div class="profile-month">${monthName}</div>
        </div>

        <!-- Â†±ÈÖ¨„Çµ„Éû„É™„Éº -->
        <div class="compensation-card">
          <div class="compensation-header">
            <div class="compensation-title">‰ªäÊúà„ÅÆÂ†±ÈÖ¨</div>
          </div>
          <div class="compensation-amount">¬•${myStats.totalAmount.toLocaleString()}</div>
          <div class="compensation-goal">
            ÁõÆÊ®ô: <span class="goal-amount">${userGoal > 0 ? '¬•' + userGoal.toLocaleString() : 'Êú™Ë®≠ÂÆö'}</span>
          </div>
          ${userGoal > 0 ? `
          <div class="progress-container">
            <div class="progress-bar-bg">
              <div class="progress-bar-fill" style="width: ${progressPercent}%"></div>
            </div>
            <div class="progress-text">
              <span>ÈÅîÊàêÁéá</span>
              <span class="progress-percent">${progressPercent}%</span>
            </div>
            ${getMilestoneMessage(progressPercent)}
          </div>` : ''}
        </div>

        <!-- ÂÜÖË®≥ÔºàÊãÖÂΩì„Çø„Çπ„ÇØ„ÅÆ„ÅøË°®Á§∫Ôºâ -->
        <div class="breakdown-card">
          <div class="breakdown-title">ÂÜÖË®≥</div>
          ${assignedTasks.includes('listing') ? `
          <div class="breakdown-item">
            <div class="breakdown-label">
              <div class="breakdown-icon listing">üì¶</div>
              <div>
                <div class="breakdown-name">ÂïÜÂìÅÂá∫ÂìÅ</div>
                <div class="breakdown-count">${myStats.listingCount}‰ª∂</div>
              </div>
            </div>
            <div class="breakdown-amount">¬•${myStats.listingAmount.toLocaleString()}</div>
          </div>` : ''}
          ${assignedTasks.includes('shipping') ? `
          <div class="breakdown-item">
            <div class="breakdown-label">
              <div class="breakdown-icon shipping">üöö</div>
              <div>
                <div class="breakdown-name">Ê¢±ÂåÖ„ÉªÁô∫ÈÄÅ</div>
                <div class="breakdown-count">${myStats.shippingCount}‰ª∂</div>
              </div>
            </div>
            <div class="breakdown-amount">¬•${myStats.shippingAmount.toLocaleString()}</div>
          </div>` : ''}
          ${assignedTasks.length === 0 ? `
          <div style="text-align: center; color: #9ca3af; padding: 16px; font-size: 14px;">
            ÊãÖÂΩì„Çø„Çπ„ÇØ„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì
          </div>` : ''}
        </div>

        <!-- „É©„É≥„Ç≠„É≥„Ç∞ -->
        <div class="ranking-card">
          <div class="ranking-title">‰ªäÊúà„ÅÆ„É©„É≥„Ç≠„É≥„Ç∞</div>
          ${renderRankingList(rankingData, currentUser.email)}
        </div>

        <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ -->
        <div class="action-buttons">
          <div class="action-btn" onclick="openBasicInfo()">
            <i class="bi bi-gear"></i>
            <span>Âü∫Êú¨ÊÉÖÂ†±</span>
          </div>
          <div class="action-btn" onclick="openGoalModal()">
            <i class="bi bi-bullseye"></i>
            <span>ÁõÆÊ®ôË®≠ÂÆö</span>
          </div>
          <div class="action-btn" onclick="openHistoryModal()">
            <i class="bi bi-clock-history"></i>
            <span>Â±•Ê≠¥</span>
          </div>
        </div>
      `;

      document.getElementById('mainContent').innerHTML = html;
    }

    // Áµ±Ë®à„ÇíË®àÁÆó
    function calculateStats(records) {
      let listingCount = 0;
      let listingAmount = 0;
      let shippingCount = 0;
      let shippingAmount = 0;

      records.forEach(r => {
        const taskType = r.taskTypeKey || r.taskType || '';
        const amount = r.unitPrice || 0;

        if (taskType === 'listing' || taskType === 'listing_approval') {
          listingCount++;
          listingAmount += amount;
        } else if (taskType === 'shipping' || taskType === 'shipping_task') {
          shippingCount++;
          shippingAmount += amount;
        }
      });

      return {
        listingCount,
        listingAmount,
        shippingCount,
        shippingAmount,
        totalAmount: listingAmount + shippingAmount,
        totalCount: listingCount + shippingCount
      };
    }

    // „É©„É≥„Ç≠„É≥„Ç∞„ÇíË®àÁÆó
    function calculateRanking() {
      const staffStats = {};

      compensationRecords.forEach(r => {
        const email = r.staffEmail || '';
        const name = r.staffName || '‰∏çÊòé';
        const amount = r.unitPrice || 0;

        if (!email) return;

        // „É©„É≥„Ç≠„É≥„Ç∞‰∏çÂèÇÂä†„ÅÆ„É¶„Éº„Ç∂„Éº„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºàËá™ÂàÜ‰ª•Â§ñÔºâ
        // Ëá™ÂàÜ„ÅØÂèÇÂä†„Éª‰∏çÂèÇÂä†„Å´Èñ¢„Çè„Çâ„ÅöËá™ÂàÜ„ÅÆ‰ΩçÁΩÆ„ÇíÁ¢∫Ë™ç„Åß„Åç„Çã
        if (email !== currentUser.email && allUsersRankingPrefs[email] === false) {
          return;
        }

        if (!staffStats[email]) {
          staffStats[email] = { email, name, totalAmount: 0 };
        }
        staffStats[email].totalAmount += amount;
      });

      // ÈáëÈ°ç„Åß„ÇΩ„Éº„Éà
      const ranking = Object.values(staffStats).sort((a, b) => b.totalAmount - a.totalAmount);

      return ranking;
    }

    // „É©„É≥„Ç≠„É≥„Ç∞„É™„Çπ„Éà„ÇíÊèèÁîª
    function renderRankingList(rankingData, myEmail) {
      // „É©„É≥„Ç≠„É≥„Ç∞‰∏çÂèÇÂä†„ÅÆÂ†¥Âêà„ÅØ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
      if (!rankingParticipation) {
        return `
          <div class="ranking-opt-out-message">
            <i class="bi bi-eye-slash"></i>
            <span>„É©„É≥„Ç≠„É≥„Ç∞ÈùûÂÖ¨Èñã‰∏≠</span>
          </div>
          <div class="text-center text-muted" style="font-size: 12px;">
            ÁõÆÊ®ôË®≠ÂÆö„Åã„Çâ„Äå„É©„É≥„Ç≠„É≥„Ç∞„Å´ÂèÇÂä†„Åô„Çã„Äç„Çí„Ç™„É≥„Å´„Åô„Çã„Å®Ë°®Á§∫„Åï„Çå„Åæ„Åô
          </div>
        `;
      }

      if (rankingData.length === 0) {
        return '<div class="text-center text-muted py-3">„Åæ„Å†„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
      }

      // ‰∏ä‰Ωç3Âêç + Ëá™ÂàÜ„ÅÆ‰ΩçÁΩÆ„ÇíË°®Á§∫
      const myRankIndex = rankingData.findIndex(r => r.email === myEmail);
      const displayItems = [];

      // ‰∏ä‰Ωç3Âêç
      for (let i = 0; i < Math.min(3, rankingData.length); i++) {
        displayItems.push({ ...rankingData[i], rank: i + 1 });
      }

      // Ëá™ÂàÜ„Åå4‰Ωç‰ª•‰∏ã„Å™„ÇâËøΩÂä†
      if (myRankIndex >= 3) {
        // Âå∫Âàá„ÇäÁ∑ö„ÅÆ‰ª£„Çè„Çä„Å´...„ÇíËøΩÂä†
        displayItems.push({ separator: true });
        displayItems.push({ ...rankingData[myRankIndex], rank: myRankIndex + 1 });
      }

      return displayItems.map(item => {
        if (item.separator) {
          return '<div class="text-center text-muted py-1">‚ãÆ</div>';
        }

        const isMe = item.email === myEmail;
        const positionClass = item.rank === 1 ? 'gold' : item.rank === 2 ? 'silver' : item.rank === 3 ? 'bronze' : 'normal';
        const highlightClass = isMe ? 'highlight' : '';
        const nameClass = isMe ? 'me' : '';
        const displayName = isMe ? `‚òÖ ${item.name}` : item.name;

        return `
          <div class="ranking-item ${highlightClass}">
            <div class="ranking-position ${positionClass}">${item.rank}</div>
            <div class="ranking-name ${nameClass}">${escapeHtml(displayName)}</div>
            <div class="ranking-amount">¬•${item.totalAmount.toLocaleString()}</div>
          </div>
        `;
      }).join('');
    }

    // ÈùûÂØæË±°ËÄÖ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
    function showNotEligible(title, message) {
      document.getElementById('mainContent').innerHTML = `
        <div class="not-eligible">
          <i class="bi bi-person-x"></i>
          <h3>${escapeHtml(title)}</h3>
          <p>${escapeHtml(message)}</p>
          <div class="action-buttons mt-4">
            <div class="action-btn" onclick="openBasicInfo()">
              <i class="bi bi-gear"></i>
              <span>Âü∫Êú¨ÊÉÖÂ†±</span>
            </div>
          </div>
        </div>
      `;
    }

    // ÁõÆÊ®ôË®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
    window.openGoalModal = function() {
      document.getElementById('goalAmountInput').value = userGoal || '';
      document.getElementById('rankingParticipation').checked = rankingParticipation;
      document.getElementById('goalModal').style.display = 'flex';
    };

    // ÁõÆÊ®ôË®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    window.closeGoalModal = function() {
      document.getElementById('goalModal').style.display = 'none';
    };

    // „Éó„É™„Çª„ÉÉ„ÉàÈáëÈ°ç„ÇíË®≠ÂÆö
    window.setGoalPreset = function(amount) {
      document.getElementById('goalAmountInput').value = amount;
    };

    // ÁõÆÊ®ô„Çí„Çπ„Ç≠„ÉÉ„ÉóÔºàË®≠ÂÆö„Åó„Å™„ÅÑÔºâ
    window.skipGoal = async function() {
      try {
        showLoading(true);

        const now = new Date();
        const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const docRef = doc(db, 'userGoals', `${currentUser.email}_${yearMonth}`);

        const newRankingPref = document.getElementById('rankingParticipation').checked;
        await setDoc(docRef, {
          email: currentUser.email,
          name: currentUser.name,
          yearMonth: yearMonth,
          goalAmount: 0,
          skipped: true,
          rankingParticipation: newRankingPref,
          updatedAt: new Date().toISOString()
        });

        userGoal = 0;
        rankingParticipation = newRankingPref;
        allUsersRankingPrefs[currentUser.email] = newRankingPref;
        closeGoalModal();
        renderMyPage();

        showLoading(false);
      } catch (error) {
        console.error('ÁõÆÊ®ô„Çπ„Ç≠„ÉÉ„Éó„Ç®„É©„Éº:', error);
        alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
        showLoading(false);
      }
    };

    // ÁõÆÊ®ô„Çí‰øùÂ≠ò
    window.saveGoal = async function() {
      const goalAmount = parseInt(document.getElementById('goalAmountInput').value) || 0;

      if (goalAmount < 0) {
        alert('ÁõÆÊ®ôÈáëÈ°ç„ÅØ0‰ª•‰∏ä„ÅßË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        return;
      }

      try {
        showLoading(true);

        const now = new Date();
        const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const docRef = doc(db, 'userGoals', `${currentUser.email}_${yearMonth}`);

        const newRankingPref = document.getElementById('rankingParticipation').checked;
        await setDoc(docRef, {
          email: currentUser.email,
          name: currentUser.name,
          yearMonth: yearMonth,
          goalAmount: goalAmount,
          rankingParticipation: newRankingPref,
          updatedAt: new Date().toISOString()
        });

        userGoal = goalAmount;
        rankingParticipation = newRankingPref;
        allUsersRankingPrefs[currentUser.email] = newRankingPref;
        closeGoalModal();
        renderMyPage();

        showLoading(false);
      } catch (error) {
        console.error('ÁõÆÊ®ô‰øùÂ≠ò„Ç®„É©„Éº:', error);
        alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
        showLoading(false);
      }
    };

    // Â±•Ê≠¥„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
    window.openHistoryModal = async function() {
      document.getElementById('historyModal').style.display = 'flex';
      document.getElementById('historyList').innerHTML = '<div class="history-empty"><div class="spinner-border text-primary" role="status"></div><p style="margin-top: 12px;">Ë™≠„ÅøËæº„Åø‰∏≠...</p></div>';
      
      try {
        const historyData = await loadGoalHistory();
        renderHistoryList(historyData);
      } catch (error) {
        console.error('Â±•Ê≠¥Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
        document.getElementById('historyList').innerHTML = '<div class="history-empty"><i class="bi bi-exclamation-circle"></i><p>Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p></div>';
      }
    };

    // Â±•Ê≠¥„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    window.closeHistoryModal = function() {
      document.getElementById('historyModal').style.display = 'none';
    };

    // ÈÅéÂéª„ÅÆÁõÆÊ®ôÂ±•Ê≠¥„ÇíË™≠„ÅøËæº„ÇÄÔºàÈÅéÂéª12„É∂ÊúàÔºâ
    async function loadGoalHistory() {
      const history = [];
      const now = new Date();
      
      // ÈÅéÂéª12„É∂ÊúàÂàÜ„ÇíÂèñÂæóÔºàÂΩìÊúà„ÅØÈô§„ÅèÔºâ
      for (let i = 1; i <= 12; i++) {
        const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const year = targetDate.getFullYear();
        const month = targetDate.getMonth() + 1;
        const yearMonth = `${year}-${String(month).padStart(2, '0')}`;
        
        // ÁõÆÊ®ô„Éá„Éº„Çø„ÇíÂèñÂæó
        const goalDocRef = doc(db, 'userGoals', `${currentUser.email}_${yearMonth}`);
        const goalSnap = await getDoc(goalDocRef);
        
        // Â†±ÈÖ¨„Éá„Éº„Çø„ÇíÂèñÂæó
        const recordsRef = collection(db, 'compensationRecords');
        const recordsSnap = await getDocs(recordsRef);
        
        let monthRecords = [];
        recordsSnap.forEach(docSnap => {
          const data = docSnap.data();
          if (data.staffEmail !== currentUser.email) return;
          
          const dateStr = data.completedAt || data.recordedAt;
          if (!dateStr) return;
          
          const date = typeof dateStr === 'string' ? new Date(dateStr) : (dateStr.toDate ? dateStr.toDate() : new Date(dateStr));
          if (date.getFullYear() === year && (date.getMonth() + 1) === month) {
            monthRecords.push(data);
          }
        });
        
        // „Åù„ÅÆ„É¶„Éº„Ç∂„Éº„ÅÆ„Éá„Éº„Çø„ÅåÂ≠òÂú®„Åô„ÇãÊúà„ÅÆ„ÅøËøΩÂä†
        if (goalSnap.exists() || monthRecords.length > 0) {
          const goalAmount = goalSnap.exists() ? (goalSnap.data().goalAmount || 0) : 10000;
          const stats = calculateStats(monthRecords);
          
          // „É©„É≥„Ç≠„É≥„Ç∞„ÇíË®àÁÆóÔºàÂÖ®Âì°ÂàÜÔºâ
          const allUsersMap = new Map();
          recordsSnap.forEach(docSnap => {
            const data = docSnap.data();
            const dateStr = data.completedAt || data.recordedAt;
            if (!dateStr) return;
            
            const date = typeof dateStr === 'string' ? new Date(dateStr) : (dateStr.toDate ? dateStr.toDate() : new Date(dateStr));
            if (date.getFullYear() === year && (date.getMonth() + 1) === month) {
              const email = data.staffEmail || 'unknown';
              if (!allUsersMap.has(email)) {
                allUsersMap.set(email, { totalAmount: 0 });
              }
              allUsersMap.get(email).totalAmount += (data.unitPrice || 0);
            }
          });
          
          // „É©„É≥„Ç≠„É≥„Ç∞„ÇíÁîüÊàê
          const ranking = Array.from(allUsersMap.entries())
            .map(([email, data]) => ({ email, ...data }))
            .sort((a, b) => b.totalAmount - a.totalAmount);
          
          const myRank = ranking.findIndex(r => r.email === currentUser.email) + 1;
          
          history.push({
            yearMonth,
            year,
            month,
            goalAmount,
            actualAmount: stats.totalAmount,
            listingCount: stats.listingCount,
            listingAmount: stats.listingAmount,
            shippingCount: stats.shippingCount,
            shippingAmount: stats.shippingAmount,
            rank: myRank || '-',
            totalParticipants: ranking.length
          });
        }
      }
      
      return history;
    }

    // Â±•Ê≠¥„É™„Çπ„Éà„ÇíÊèèÁîª
    function renderHistoryList(historyData) {
      if (historyData.length === 0) {
        document.getElementById('historyList').innerHTML = '<div class="history-empty"><i class="bi bi-calendar-x"></i><p>ÈÅéÂéª„ÅÆÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p></div>';
        return;
      }
      
      const html = historyData.map(item => {
        const percent = item.goalAmount > 0 ? Math.min(100, Math.round((item.actualAmount / item.goalAmount) * 100)) : 0;
        const achieved = percent >= 100;
        const achievedClass = achieved ? 'achieved' : (percent > 0 ? 'not-achieved' : '');
        
        return `
          <div class="history-item ${achievedClass}">
            <div class="history-month">${item.year}Âπ¥${item.month}Êúà</div>
            <div class="history-amounts">
              <div class="history-goal">ÁõÆÊ®ô: <span>¬•${item.goalAmount.toLocaleString()}</span></div>
              <div class="history-actual">ÂÆüÁ∏æ: <span>¬•${item.actualAmount.toLocaleString()}</span></div>
            </div>
            <div class="history-progress">
              <div class="history-progress-bar">
                <div class="history-progress-fill ${achieved ? 'achieved' : ''}" style="width: ${percent}%"></div>
              </div>
              <div class="history-percent ${achieved ? 'achieved' : ''}">${percent}%</div>
            </div>
            <div class="history-details">
              <div class="history-breakdown">
                ${assignedTasks.includes('listing') ? `
                <div class="history-breakdown-item">
                  <div class="history-breakdown-icon">üì¶</div>
                  <div class="history-breakdown-label">Âá∫ÂìÅ</div>
                  <div class="history-breakdown-value">${item.listingCount}‰ª∂ / ¬•${item.listingAmount.toLocaleString()}</div>
                </div>` : ''}
                ${assignedTasks.includes('shipping') ? `
                <div class="history-breakdown-item">
                  <div class="history-breakdown-icon">üöö</div>
                  <div class="history-breakdown-label">Áô∫ÈÄÅ</div>
                  <div class="history-breakdown-value">${item.shippingCount}‰ª∂ / ¬•${item.shippingAmount.toLocaleString()}</div>
                </div>` : ''}
              </div>
              <div class="history-ranking">
                <span class="history-ranking-label">üèÜ „É©„É≥„Ç≠„É≥„Ç∞</span>
                <span class="history-ranking-value">${item.rank}‰Ωç / ${item.totalParticipants}‰∫∫</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('historyList').innerHTML = html;
    }

    // ========================================
    // „ÅäÁü•„Çâ„ÅõÊ©üËÉΩ
    // ========================================
    let announcements = [];
    let personalAnnouncements = [];
    let readAnnouncementIds = new Set();
    let readPersonalIds = new Set();
    let currentAnnouncementView = 'list'; // 'list' or 'detail'

    // „ÅäÁü•„Çâ„Åõ„Éö„Éº„Ç∏„ÇíÈñã„Åè
    window.openAnnouncePage = function() {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'navigate', page: 'announce' }, '*');
      } else {
        window.location.href = '/announce.html';
      }
    };

    // „ÅäÁü•„Çâ„Åõ„É¢„Éº„ÉÄ„É´„ÇíÈñã„ÅèÔºà„É¨„Ç¨„Ç∑„Éº„ÄÅ‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÔºâ
    window.openAnnouncementModal = async function() {
      document.getElementById('announceModal').style.display = 'flex';
      currentAnnouncementView = 'list';
      document.getElementById('announceModalBody').innerHTML = '<div class="announce-empty"><div class="spinner-border text-primary" role="status"></div><p style="margin-top: 12px;">Ë™≠„ÅøËæº„Åø‰∏≠...</p></div>';
      
      try {
        await loadAnnouncements();
        renderAnnouncementList();
      } catch (error) {
        console.error('„ÅäÁü•„Çâ„ÅõË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
        document.getElementById('announceModalBody').innerHTML = '<div class="announce-empty"><i class="bi bi-exclamation-circle"></i><p>„ÅäÁü•„Çâ„Åõ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p></div>';
      }
    };

    // „ÅäÁü•„Çâ„Åõ„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    window.closeAnnouncementModal = function() {
      document.getElementById('announceModal').style.display = 'none';
    };

    // „ÅäÁü•„Çâ„Åõ„ÇíË™≠„ÅøËæº„ÇÄ
    async function loadAnnouncements() {
      // ÂÖ®‰Ωì„ÅäÁü•„Çâ„Åõ‰∏ÄË¶ß„ÇíÂèñÂæó
      const announcementsRef = collection(db, 'announcements');
      const snapshot = await getDocs(announcementsRef);

      announcements = [];
      snapshot.forEach(docSnap => {
        announcements.push({ id: docSnap.id, ...docSnap.data() });
      });

      // Êó•‰ªò„Åß„ÇΩ„Éº„ÉàÔºàÊñ∞„Åó„ÅÑÈ†ÜÔºâ
      announcements.sort((a, b) => {
        const dateA = a.createdAt ? (typeof a.createdAt === 'string' ? new Date(a.createdAt) : a.createdAt.toDate()) : new Date(0);
        const dateB = b.createdAt ? (typeof b.createdAt === 'string' ? new Date(b.createdAt) : b.createdAt.toDate()) : new Date(0);
        return dateB - dateA;
      });

      // ÂÖ®‰Ωì„ÅäÁü•„Çâ„ÅõÊó¢Ë™≠ÊÉÖÂ†±„ÇíÂèñÂæó
      readAnnouncementIds = new Set();
      if (currentUser && currentUser.email) {
        const readRef = collection(db, 'readAnnouncements');
        const readSnapshot = await getDocs(readRef);
        readSnapshot.forEach(docSnap => {
          const data = docSnap.data();
          if (data.userEmail === currentUser.email) {
            readAnnouncementIds.add(data.announcementId);
          }
        });

        // ÂÄã‰∫∫„ÅäÁü•„Çâ„Åõ„ÇíÂèñÂæó
        try {
          const personalRef = collection(db, 'users', currentUser.email, 'personalAnnouncements');
          const personalSnapshot = await getDocs(personalRef);
          personalAnnouncements = [];
          personalSnapshot.forEach(docSnap => {
            personalAnnouncements.push({ id: docSnap.id, ...docSnap.data() });
          });

          // ÂÄã‰∫∫„ÅäÁü•„Çâ„ÅõÊó¢Ë™≠ÊÉÖÂ†±„ÇíÂèñÂæó
          readPersonalIds = new Set();
          const readPersonalRef = collection(db, 'users', currentUser.email, 'readPersonalAnnouncements');
          const readPersonalSnapshot = await getDocs(readPersonalRef);
          readPersonalSnapshot.forEach(docSnap => {
            readPersonalIds.add(docSnap.data().announcementId);
          });
        } catch (e) {
          console.log('[Announce] ÂÄã‰∫∫„ÅäÁü•„Çâ„ÅõË™≠„ÅøËæº„Åø„Çπ„Ç≠„ÉÉ„Éó:', e.message);
          personalAnnouncements = [];
          readPersonalIds = new Set();
        }
      }

      // „Éê„ÉÉ„Ç∏„ÇíÊõ¥Êñ∞
      updateAnnounceBadge();
    }

    // „ÅäÁü•„Çâ„Åõ‰∏ÄË¶ß„ÇíÊèèÁîª
    function renderAnnouncementList() {
      if (announcements.length === 0) {
        document.getElementById('announceModalBody').innerHTML = '<div class="announce-empty"><i class="bi bi-bell-slash"></i><p>„ÅäÁü•„Çâ„Åõ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p></div>';
        return;
      }
      
      const html = `<div class="announce-list">${announcements.map(item => {
        const isUnread = !readAnnouncementIds.has(item.id);
        const date = item.createdAt ? (typeof item.createdAt === 'string' ? new Date(item.createdAt) : item.createdAt.toDate()) : null;
        const dateStr = date ? `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()}` : '';
        const priorityClass = item.priority === 'important' ? 'important' : 'normal';
        const priorityLabel = item.priority === 'important' ? 'ÈáçË¶Å' : '„ÅäÁü•„Çâ„Åõ';
        
        return `
          <div class="announce-item ${isUnread ? 'unread' : ''}" onclick="showAnnouncementDetail('${item.id}')">
            <div class="announce-item-header">
              <span class="announce-priority ${priorityClass}">${priorityLabel}</span>
              <span class="announce-date">${dateStr}</span>
            </div>
            <div class="announce-title">${escapeHtml(item.title || '')}</div>
            <div class="announce-preview">${escapeHtml(item.body || '').substring(0, 50)}${(item.body || '').length > 50 ? '...' : ''}</div>
          </div>
        `;
      }).join('')}</div>`;
      
      document.getElementById('announceModalBody').innerHTML = html;
    }

    // „ÅäÁü•„Çâ„ÅõË©≥Á¥∞„ÇíË°®Á§∫
    window.showAnnouncementDetail = async function(announcementId) {
      const item = announcements.find(a => a.id === announcementId);
      if (!item) return;
      
      currentAnnouncementView = 'detail';
      
      const date = item.createdAt ? (typeof item.createdAt === 'string' ? new Date(item.createdAt) : item.createdAt.toDate()) : null;
      const dateStr = date ? `${date.getFullYear()}Âπ¥${date.getMonth()+1}Êúà${date.getDate()}Êó•` : '';
      const priorityClass = item.priority === 'important' ? 'important' : 'normal';
      const priorityLabel = item.priority === 'important' ? 'ÈáçË¶Å' : '„ÅäÁü•„Çâ„Åõ';
      
      const html = `
        <div class="announce-detail">
          <button class="announce-back-btn" onclick="renderAnnouncementList(); currentAnnouncementView='list';">
            <i class="bi bi-chevron-left"></i> ‰∏ÄË¶ß„Å´Êàª„Çã
          </button>
          <div class="announce-detail-title">${escapeHtml(item.title || '')}</div>
          <div class="announce-detail-meta">
            <span class="announce-priority ${priorityClass}">${priorityLabel}</span>
            <span>${dateStr}</span>
          </div>
          <div class="announce-detail-body">${escapeHtml(item.body || '')}</div>
        </div>
      `;
      
      document.getElementById('announceModalBody').innerHTML = html;
      
      // Êó¢Ë™≠„Å´„Åô„Çã
      if (!readAnnouncementIds.has(announcementId) && currentUser && currentUser.email) {
        try {
          const readDocRef = doc(db, 'readAnnouncements', `${currentUser.email}_${announcementId}`);
          await setDoc(readDocRef, {
            userEmail: currentUser.email,
            announcementId: announcementId,
            readAt: new Date().toISOString()
          });
          readAnnouncementIds.add(announcementId);
          updateAnnounceBadge();
        } catch (error) {
          console.error('Êó¢Ë™≠„Éû„Éº„ÇØ„Ç®„É©„Éº:', error);
        }
      }
    };

    // „Éê„ÉÉ„Ç∏„ÇíÊõ¥Êñ∞Ôºàv288: Ëµ§„ÅÑ„Éâ„ÉÉ„ÉàË°®Á§∫„Å´Â§âÊõ¥Ôºâ
    // Êú™Ë™≠„Åå„ÅÇ„Çå„Å∞Ëµ§„ÅÑ„Éâ„ÉÉ„Éà„ÇíË°®Á§∫„ÄÅ„Å™„Åë„Çå„Å∞ÈùûË°®Á§∫
    function updateAnnounceBadge() {
      const globalUnread = announcements.filter(a => !readAnnouncementIds.has(a.id)).length;
      const personalUnread = personalAnnouncements.filter(a => !readPersonalIds.has(a.id)).length;
      const hasUnread = (globalUnread + personalUnread) > 0;
      const dot = document.getElementById('announceDot');
      if (dot) {
        if (hasUnread) {
          dot.classList.add('active');
        } else {
          dot.classList.remove('active');
        }
      }
      console.log('[Announce] Êú™Ë™≠„ÅÇ„Çä:', hasUnread, '(ÂÖ®‰Ωì:', globalUnread, ', ÂÄã‰∫∫:', personalUnread, ')');
      // v288: „ÅäÁü•„Çâ„Åõ„ÅØÁã¨Á´ãÁÆ°ÁêÜ„ÅÆ„Åü„ÇÅ„ÄÅË¶™„Éï„É¨„Éº„É†„Å∏„ÅÆÈÄöÁü•„ÅØ‰∏çË¶Å
    }

    // ÂàùÊúüÂåñÊôÇ„Å´„ÅäÁü•„Çâ„Åõ„ÇíË™≠„ÅøËæº„Çì„Åß„Éê„ÉÉ„Ç∏„ÇíÊõ¥Êñ∞
    async function initAnnouncements() {
      try {
        await loadAnnouncements();
      } catch (error) {
        console.error('„ÅäÁü•„Çâ„ÅõÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
      }
    }

    // Âü∫Êú¨ÊÉÖÂ†±„ÇíÈñã„Åè
    window.openBasicInfo = function() {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'navigate', page: 'config-basic' }, '*');
      } else {
        window.location.href = '/config.html?tab=system';
      }
    };

    // Êàª„ÇãÔºàÂ±•Ê≠¥„Éô„Éº„ÇπÔºâ
    window.goBack = function() {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'goBack' }, '*');
      } else {
        window.history.back();
      }
    };

    // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
    function showLoading(show) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    // „Ç®„Çπ„Ç±„Éº„Éó
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, char => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[char]));
    }

    // ÁµµÊñáÂ≠ó„ÇíÂâäÈô§
    function stripEmoji(str) {
      if (!str) return '';
      return str.replace(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '').trim();
    }

    // ÂàùÊúüÂåñÂÆüË°å
    // ========================================
    // ËÉåÊôØ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫Ê©üËÉΩ
    // ========================================

    // ËÉåÊôØ„Çπ„Çø„Ç§„É´„ÇíÂèñÂæó
    function getProfileBgStyle() {
      if (userProfileBg.type === 'image' && userProfileBg.value) {
        return `background-image: url('${userProfileBg.value}'); background-color: transparent;`;
      } else {
        const preset = GRADIENT_PRESETS.find(p => p.id === userProfileBg.value) || GRADIENT_PRESETS[0];
        return `background: ${preset.gradient};`;
      }
    }

    // „É¶„Éº„Ç∂„Éº„ÅÆËÉåÊôØË®≠ÂÆö„ÇíË™≠„ÅøËæº„ÇÄ
    async function loadUserProfileBg() {
      try {
        const userRef = doc(db, 'users', currentUser.email);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          const data = userSnap.data();
          if (data.profileBackground) {
            userProfileBg = data.profileBackground;
            console.log('[ProfileBg] ËÉåÊôØË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø:', userProfileBg);
          }
        }
      } catch (error) {
        console.error('[ProfileBg] ËÉåÊôØË®≠ÂÆöË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
      }
    }

    // ËÉåÊôØÈÅ∏Êäû„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
    window.openBgModal = function() {
      // ÁèæÂú®„ÅÆË®≠ÂÆö„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´
      selectedBgType = userProfileBg.type;
      selectedBgValue = userProfileBg.value;
      pendingBgImageFile = null;

      // „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„Ç∞„É™„ÉÉ„Éâ„ÇíÁîüÊàê
      renderBgGradientGrid();

      // ÁîªÂÉè„Éó„É¨„Éì„É•„Éº„Çí„É™„Çª„ÉÉ„Éà
      const preview = document.getElementById('bgPreview');
      const previewImg = document.getElementById('bgPreviewImage');
      if (userProfileBg.type === 'image' && userProfileBg.value) {
        previewImg.src = userProfileBg.value;
        preview.classList.add('active');
      } else {
        preview.classList.remove('active');
        previewImg.src = '';
      }

      document.getElementById('bgImageInput').value = '';
      document.getElementById('bgModal').classList.add('active');
    };

    // ËÉåÊôØÈÅ∏Êäû„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    window.closeBgModal = function() {
      document.getElementById('bgModal').classList.remove('active');
    };

    // „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„Ç∞„É™„ÉÉ„Éâ„ÇíÁîüÊàê
    function renderBgGradientGrid() {
      const grid = document.getElementById('bgGradientGrid');
      grid.innerHTML = GRADIENT_PRESETS.map(preset => {
        const isSelected = selectedBgType === 'gradient' && selectedBgValue === preset.id;
        return `<div class="bg-gradient-item ${isSelected ? 'selected' : ''}"
                    style="background: ${preset.gradient};"
                    onclick="selectBgGradient('${preset.id}')"></div>`;
      }).join('');
    }

    // „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„ÇíÈÅ∏Êäû
    window.selectBgGradient = function(gradientId) {
      selectedBgType = 'gradient';
      selectedBgValue = gradientId;
      pendingBgImageFile = null;

      // ÁîªÂÉè„Éó„É¨„Éì„É•„Éº„ÇíÈùûË°®Á§∫
      document.getElementById('bgPreview').classList.remove('active');
      document.getElementById('bgImageInput').value = '';

      // ÈÅ∏ÊäûÁä∂ÊÖã„ÇíÊõ¥Êñ∞
      renderBgGradientGrid();
    };

    // ÁîªÂÉèÈÅ∏Êäû„Éè„É≥„Éâ„É©
    window.handleBgImageSelect = function(event) {
      const file = event.target.files[0];
      if (!file) return;

      // „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØÔºà5MB‰ª•‰∏ãÔºâ
      if (file.size > 5 * 1024 * 1024) {
        alert('ÁîªÂÉè„Çµ„Ç§„Ç∫„ÅØ5MB‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        event.target.value = '';
        return;
      }

      // „Éó„É¨„Éì„É•„ÉºË°®Á§∫
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('bgPreviewImage').src = e.target.result;
        document.getElementById('bgPreview').classList.add('active');

        selectedBgType = 'image';
        selectedBgValue = e.target.result; // ‰∏ÄÊôÇÁöÑ„Å´Data URL„ÇíË®≠ÂÆö
        pendingBgImageFile = file;

        // „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„ÅÆÈÅ∏Êäû„ÇíËß£Èô§
        renderBgGradientGrid();
      };
      reader.readAsDataURL(file);
    };

    // ÁîªÂÉè„ÇíÂâäÈô§
    window.removeBgImage = function() {
      document.getElementById('bgPreview').classList.remove('active');
      document.getElementById('bgPreviewImage').src = '';
      document.getElementById('bgImageInput').value = '';
      pendingBgImageFile = null;

      // „Éá„Éï„Ç©„É´„Éà„ÅÆ„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„Å´Êàª„Åô
      selectedBgType = 'gradient';
      selectedBgValue = userProfileBg.type === 'gradient' ? userProfileBg.value : 'blue';
      renderBgGradientGrid();
    };

    // ËÉåÊôØË®≠ÂÆö„Çí‰øùÂ≠ò
    window.saveBgSetting = async function() {
      const saveBtn = document.getElementById('bgSaveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = '‰øùÂ≠ò‰∏≠...';

      try {
        let newBgValue = selectedBgValue;

        // ÁîªÂÉè„ÅÆÂ†¥Âêà„ÅØ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
        if (selectedBgType === 'image' && pendingBgImageFile) {
          const timestamp = Date.now();
          const fileName = `profile-bg/${currentUser.email}/${timestamp}_${pendingBgImageFile.name}`;
          const storageRef = ref(storage, fileName);

          await uploadBytes(storageRef, pendingBgImageFile);
          newBgValue = await getDownloadURL(storageRef);
          console.log('[ProfileBg] ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂÆå‰∫Ü:', newBgValue);
        }

        // Firestore„Å´‰øùÂ≠ò
        const userRef = doc(db, 'users', currentUser.email);
        await updateDoc(userRef, {
          profileBackground: {
            type: selectedBgType,
            value: newBgValue
          }
        });

        // „É≠„Éº„Ç´„É´Áä∂ÊÖã„ÇíÊõ¥Êñ∞
        userProfileBg = { type: selectedBgType, value: newBgValue };

        // „Éó„É≠„Éï„Ç£„Éº„É´„Ç´„Éº„Éâ„ÅÆËÉåÊôØ„ÇíÊõ¥Êñ∞
        const profileCard = document.getElementById('profileCard');
        if (profileCard) {
          if (userProfileBg.type === 'image') {
            profileCard.style.backgroundImage = `url('${userProfileBg.value}')`;
            profileCard.style.background = '';
          } else {
            const preset = GRADIENT_PRESETS.find(p => p.id === userProfileBg.value) || GRADIENT_PRESETS[0];
            profileCard.style.backgroundImage = '';
            profileCard.style.background = preset.gradient;
          }
        }

        closeBgModal();
        console.log('[ProfileBg] ËÉåÊôØË®≠ÂÆö„Çí‰øùÂ≠ò:', userProfileBg);
      } catch (error) {
        console.error('[ProfileBg] ‰øùÂ≠ò„Ç®„É©„Éº:', error);
        alert('ËÉåÊôØ„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = '‰øùÂ≠ò';
      }
    };

    // ========================================
    // ÂÄã‰∫∫ÊÉÖÂ†±Ë®≠ÂÆö„ÉªÈÄöÁü•Ë®≠ÂÆöÊ©üËÉΩ
    // ========================================

    // ÂÄã‰∫∫ÊÉÖÂ†±ÔºàÁô∫ÈÄÅÂÖà„ÉªÂè£Â∫ßÔºâ„Çí‰øùÊåÅ
    let personalInfo = {
      shipping: { name: '', postalCode: '', address: '', phone: '' },
      bank: { bankName: '', branchName: '', accountType: '', accountNumber: '', accountHolder: '' }
    };

    // ÈÄöÁü•Ë®≠ÂÆö„Çí‰øùÊåÅ
    let notificationSettings = {
      pushEnabled: true,
      soundEnabled: true
    };

    // ÂÄã‰∫∫ÊÉÖÂ†±„ÇíË™≠„ÅøËæº„ÇÄ
    async function loadPersonalInfo() {
      try {
        const userRef = doc(db, 'users', currentUser.email);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          const data = userSnap.data();
          if (data.personalInfo) {
            personalInfo = {
              shipping: data.personalInfo.shipping || { name: '', postalCode: '', address: '', phone: '' },
              bank: data.personalInfo.bank || { bankName: '', branchName: '', accountType: '', accountNumber: '', accountHolder: '' }
            };
          }
        }
      } catch (error) {
        console.error('[PersonalInfo] Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
      }
    }

    // ÈÄöÁü•Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„ÇÄ
    async function loadNotificationSettings() {
      try {
        const userRef = doc(db, 'users', currentUser.email);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          const data = userSnap.data();
          if (data.notificationSettings) {
            notificationSettings = {
              pushEnabled: data.notificationSettings.pushEnabled !== false,
              soundEnabled: data.notificationSettings.soundEnabled !== false
            };
          }
        }
      } catch (error) {
        console.error('[NotificationSettings] Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
      }
    }

    // ÂÄã‰∫∫ÊÉÖÂ†±Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
    window.openPersonalInfoModal = async function() {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) dropdown.classList.remove('active');

      // ÂÄã‰∫∫ÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø
      await loadPersonalInfo();

      // „Éï„Ç©„Éº„É†„Å´ÂÄ§„Çí„Çª„ÉÉ„Éà
      document.getElementById('shippingName').value = personalInfo.shipping.name || '';
      document.getElementById('shippingPostalCode').value = personalInfo.shipping.postalCode || '';
      document.getElementById('shippingAddress').value = personalInfo.shipping.address || '';
      document.getElementById('shippingPhone').value = personalInfo.shipping.phone || '';
      document.getElementById('bankName').value = personalInfo.bank.bankName || '';
      document.getElementById('branchName').value = personalInfo.bank.branchName || '';
      document.getElementById('accountType').value = personalInfo.bank.accountType || 'ÊôÆÈÄö';
      document.getElementById('accountNumber').value = personalInfo.bank.accountNumber || '';
      document.getElementById('accountHolder').value = personalInfo.bank.accountHolder || '';

      document.getElementById('personalInfoModal').classList.add('active');
    };

    // ÂÄã‰∫∫ÊÉÖÂ†±Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    window.closePersonalInfoModal = function() {
      document.getElementById('personalInfoModal').classList.remove('active');
    };

    // ÂÄã‰∫∫ÊÉÖÂ†±„Çí‰øùÂ≠ò
    window.savePersonalInfo = async function() {
      const saveBtn = document.getElementById('personalInfoSaveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = '‰øùÂ≠ò‰∏≠...';

      try {
        const newPersonalInfo = {
          shipping: {
            name: document.getElementById('shippingName').value.trim(),
            postalCode: document.getElementById('shippingPostalCode').value.trim(),
            address: document.getElementById('shippingAddress').value.trim(),
            phone: document.getElementById('shippingPhone').value.trim()
          },
          bank: {
            bankName: document.getElementById('bankName').value.trim(),
            branchName: document.getElementById('branchName').value.trim(),
            accountType: document.getElementById('accountType').value,
            accountNumber: document.getElementById('accountNumber').value.trim(),
            accountHolder: document.getElementById('accountHolder').value.trim()
          }
        };

        // Firestore„Å´‰øùÂ≠ò
        const userRef = doc(db, 'users', currentUser.email);
        await updateDoc(userRef, {
          personalInfo: newPersonalInfo
        });

        personalInfo = newPersonalInfo;
        closePersonalInfoModal();
        console.log('[PersonalInfo] ÂÄã‰∫∫ÊÉÖÂ†±„Çí‰øùÂ≠ò:', personalInfo);
      } catch (error) {
        console.error('[PersonalInfo] ‰øùÂ≠ò„Ç®„É©„Éº:', error);
        alert('ÂÄã‰∫∫ÊÉÖÂ†±„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = '‰øùÂ≠ò';
      }
    };

    // ÈÄöÁü•Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
    window.openNotificationSettingsModal = async function() {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) dropdown.classList.remove('active');

      // ÈÄöÁü•Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
      await loadNotificationSettings();

      // „Éà„Ç∞„É´„Å´ÂÄ§„Çí„Çª„ÉÉ„Éà
      document.getElementById('pushNotificationToggle').checked = notificationSettings.pushEnabled;
      document.getElementById('notificationSoundToggle').checked = notificationSettings.soundEnabled;

      document.getElementById('notificationSettingsModal').classList.add('active');
    };

    // ÈÄöÁü•Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    window.closeNotificationSettingsModal = function() {
      document.getElementById('notificationSettingsModal').classList.remove('active');
    };

    // ÈÄöÁü•Ë®≠ÂÆö„Çí‰øùÂ≠ò
    window.saveNotificationSettings = async function() {
      const saveBtn = document.getElementById('notificationSaveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = '‰øùÂ≠ò‰∏≠...';

      try {
        const newSettings = {
          pushEnabled: document.getElementById('pushNotificationToggle').checked,
          soundEnabled: document.getElementById('notificationSoundToggle').checked
        };

        // Firestore„Å´‰øùÂ≠ò
        const userRef = doc(db, 'users', currentUser.email);
        await updateDoc(userRef, {
          notificationSettings: newSettings
        });

        notificationSettings = newSettings;
        closeNotificationSettingsModal();
        console.log('[NotificationSettings] ÈÄöÁü•Ë®≠ÂÆö„Çí‰øùÂ≠ò:', notificationSettings);
      } catch (error) {
        console.error('[NotificationSettings] ‰øùÂ≠ò„Ç®„É©„Éº:', error);
        alert('ÈÄöÁü•Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = '‰øùÂ≠ò';
      }
    };

    // „É¶„Éº„Ç∂„ÉºÂêçÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
    window.openUsernameEditModal = function() {
      document.getElementById('newUsernameInput').value = currentUser.name || '';
      document.getElementById('usernameEditModal').classList.add('active');
    };

    // „É¶„Éº„Ç∂„ÉºÂêçÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    window.closeUsernameEditModal = function() {
      document.getElementById('usernameEditModal').classList.remove('active');
    };

    // „É¶„Éº„Ç∂„ÉºÂêç„Çí‰øùÂ≠ò
    window.saveUsername = async function() {
      const newUsername = document.getElementById('newUsernameInput').value.trim();
      if (!newUsername) {
        alert('„É¶„Éº„Ç∂„ÉºÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }

      const saveBtn = document.getElementById('usernameSaveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = '‰øùÂ≠ò‰∏≠...';

      try {
        // Firestore„Å´‰øùÂ≠ò
        const userRef = doc(db, 'users', currentUser.email);
        await updateDoc(userRef, {
          name: newUsername,
          displayName: newUsername
        });

        // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÇÇÊõ¥Êñ∞
        localStorage.setItem('reborn_user_name', newUsername);

        // ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÊõ¥Êñ∞
        currentUser.name = newUsername;

        closeUsernameEditModal();
        renderMyPage();
        console.log('[Username] „É¶„Éº„Ç∂„ÉºÂêç„Çí‰øùÂ≠ò:', newUsername);
      } catch (error) {
        console.error('[Username] ‰øùÂ≠ò„Ç®„É©„Éº:', error);
        alert('„É¶„Éº„Ç∂„ÉºÂêç„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = '‰øùÂ≠ò';
      }
    };

    // „Éó„É≠„Éï„Ç£„Éº„É´ÁîªÂÉèÈÅ∏Êäû„Éè„É≥„Éâ„É©
    window.handleProfileImageSelect = async function(event) {
      const file = event.target.files[0];
      if (!file) return;

      // „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØÔºà5MB‰ª•‰∏ãÔºâ
      if (file.size > 5 * 1024 * 1024) {
        alert('ÁîªÂÉè„Çµ„Ç§„Ç∫„ÅØ5MB‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        event.target.value = '';
        return;
      }

      showLoading(true);

      try {
        // Firebase Storage„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
        const timestamp = Date.now();
        const fileName = `userIcons/${currentUser.email}/${timestamp}_${file.name}`;
        const storageRef = ref(storage, fileName);

        await uploadBytes(storageRef, file);
        const downloadURL = await getDownloadURL(storageRef);

        // Firestore„Å´‰øùÂ≠ò
        const userRef = doc(db, 'users', currentUser.email);
        await updateDoc(userRef, {
          photoURL: downloadURL,
          iconUrl: downloadURL
        });

        // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÇÇÊõ¥Êñ∞
        localStorage.setItem('reborn_user_icon_url', downloadURL);
        localStorage.setItem('reborn_user_photo_url', downloadURL);

        // ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÊõ¥Êñ∞
        currentUser.photoURL = downloadURL;

        renderMyPage();
        console.log('[ProfileImage] „Éó„É≠„Éï„Ç£„Éº„É´ÁîªÂÉè„ÇíÊõ¥Êñ∞:', downloadURL);
      } catch (error) {
        console.error('[ProfileImage] „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº:', error);
        alert('ÁîªÂÉè„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      } finally {
        showLoading(false);
        event.target.value = '';
      }
    };

    // „Éó„É≠„Éï„Ç£„Éº„É´ÁîªÂÉè„ÇØ„É™„ÉÉ„ÇØ„Éè„É≥„Éâ„É©
    window.clickProfileImage = function() {
      document.getElementById('profileImageInput').click();
    };

    init();
  </script>
</body>
</html>
