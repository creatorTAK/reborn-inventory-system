<!DOCTYPE html>
<html>
<head>
  <!-- Cache Bust: 2025-12-25-v356 - 背景画像Base64キャッシュ（Fetch API方式） -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base target="_top">
  <title>マイページ - FURIRA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/reborn-theme.css?v=298">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    .content-container {
      padding: 16px;
      max-width: 600px;
      margin: 0 auto;
    }

    /* プロフィールカード */
    .profile-card {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      border-radius: 16px;
      padding: 24px;
      background-size: cover;
      background-position: center center;
      margin-bottom: 16px;
      color: white;
      text-align: center;
      position: relative;
      background-size: cover;
      background-position: center;
    }
    /* 背景編集ボタン */
    .profile-bg-edit-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.25);
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      backdrop-filter: blur(4px);
    }
    .profile-bg-edit-btn:hover {
      background: rgba(255, 255, 255, 0.4);
    }
    .profile-bg-edit-btn:active {
      transform: scale(0.95);
    }
    /* 背景選択モーダル */
    .bg-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .bg-modal-backdrop.active {
      display: flex;
    }
    .bg-modal {
      background: white;
      border-radius: 20px;
      width: 90%;
      max-width: 360px;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .bg-modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .bg-modal-title {
      font-size: 17px;
      font-weight: 600;
      color: #1f2937;
    }
    .bg-modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: #f3f4f6;
      border-radius: 50%;
      font-size: 18px;
      color: #6b7280;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .bg-modal-body {
      padding: 20px;
      max-height: 60vh;
      overflow-y: auto;
    }
    .bg-section-title {
      font-size: 13px;
      color: #6b7280;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .bg-gradient-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }
    .bg-gradient-item {
      aspect-ratio: 1;
      border-radius: 12px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s;
      position: relative;
    }
    .bg-gradient-item:hover {
      transform: scale(1.05);
    }
    .bg-gradient-item.selected {
      border-color: #1f2937;
    }
    .bg-gradient-item.selected::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      color: #1f2937;
    }
    .bg-image-upload {
      margin-top: 16px;
    }
    .bg-upload-btn {
      width: 100%;
      padding: 14px;
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      background: #f9fafb;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 14px;
      color: #6b7280;
      transition: all 0.2s;
    }
    .bg-upload-btn:hover {
      border-color: #40B4E5;
      color: #40B4E5;
      background: #f0f9ff;
    }
    .bg-upload-btn i {
      font-size: 20px;
    }
    .bg-preview {
      margin-top: 16px;
      display: none;
    }
    .bg-preview.active {
      display: block;
    }
    .bg-position-adjuster {
      position: relative;
      width: 100%;
      height: 140px;
      border-radius: 12px;
      overflow: hidden;
      cursor: grab;
      background-color: #f0f0f0;
      margin-bottom: 8px;
    }
    .bg-position-adjuster:active {
      cursor: grabbing;
    }
    .bg-preview-image {
      width: 100%;
      height: auto;
      min-height: 100%;
      object-fit: cover;
      position: absolute;
      left: 0;
      top: 0;
      pointer-events: none;
      transition: none;
    }
    .bg-position-hint {
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      color: white;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 12px;
      pointer-events: none;
    }
    .bg-position-reset {
      text-align: center;
      margin-bottom: 8px;
    }
    .bg-position-reset-btn {
      font-size: 12px;
      color: #6b7280;
      background: none;
      border: none;
      cursor: pointer;
    }
    .bg-position-reset-btn:hover {
      color: #374151;
    }
    .bg-preview-remove {
      font-size: 13px;
      color: #ef4444;
      background: none;
      border: none;
      cursor: pointer;
    }
    .bg-modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 12px;
    }
    .bg-modal-footer button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .bg-cancel-btn {
      background: #f3f4f6;
      border: none;
      color: #6b7280;
    }
    .bg-save-btn {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      border: none;
      color: white;
    }
    .bg-save-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* 設定モーダル共通 */
    .settings-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .settings-modal-backdrop.active {
      display: flex;
    }
    .settings-modal {
      background: white;
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
      max-height: 85vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .settings-modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .settings-modal-title {
      font-size: 17px;
      font-weight: 600;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .settings-modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: #f3f4f6;
      border-radius: 50%;
      font-size: 18px;
      color: #6b7280;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .settings-modal-body {
      padding: 20px;
      max-height: 60vh;
      overflow-y: auto;
    }
    .settings-section {
      margin-bottom: 20px;
    }
    .settings-section:last-child {
      margin-bottom: 0;
    }
    .settings-section-title {
      font-size: 13px;
      color: #6b7280;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .settings-input-group {
      margin-bottom: 16px;
    }
    .settings-input-group:last-child {
      margin-bottom: 0;
    }
    .settings-input-label {
      display: block;
      font-size: 14px;
      color: #374151;
      font-weight: 500;
      margin-bottom: 6px;
    }
    .settings-input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      font-size: 15px;
      transition: border-color 0.2s;
    }
    .settings-input:focus {
      outline: none;
      border-color: #40B4E5;
    }
    .settings-textarea {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      font-size: 15px;
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
    }
    .settings-textarea:focus {
      outline: none;
      border-color: #40B4E5;
    }
    .settings-toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    .settings-toggle-row:last-child {
      border-bottom: none;
    }
    .settings-toggle-label {
      font-size: 15px;
      color: #1f2937;
    }
    .settings-toggle {
      position: relative;
      width: 50px;
      height: 28px;
    }
    .settings-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .settings-toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #d1d5db;
      transition: .3s;
      border-radius: 28px;
    }
    .settings-toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .settings-toggle input:checked + .settings-toggle-slider {
      background-color: #40B4E5;
    }
    .settings-toggle input:checked + .settings-toggle-slider:before {
      transform: translateX(22px);
    }
    .settings-modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 12px;
    }
    .settings-modal-footer button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .settings-cancel-btn {
      background: #f3f4f6;
      border: none;
      color: #6b7280;
    }
    .settings-save-btn {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      border: none;
      color: white;
    }
    .settings-save-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* プロフィール編集可能スタイル */
    .profile-avatar-editable {
      cursor: pointer;
      position: relative;
    }
    .profile-avatar-editable:hover::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      border-radius: 50%;
    }
    .profile-avatar-editable:hover::before {
      content: '\f030';
      font-family: 'bootstrap-icons';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 24px;
      z-index: 1;
    }
    .profile-name-editable {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .profile-name-editable:hover {
      text-decoration: underline;
    }
    .profile-name-edit-icon {
      font-size: 14px;
      opacity: 0.7;
    }

    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px;
      font-size: 40px;
      border: none;
      overflow: hidden;
    }
    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .profile-avatar {
      position: relative;
    }
    .profile-avatar-edit-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.5);
      color: white;
      font-size: 14px;
      padding: 4px 0;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .profile-avatar:hover .profile-avatar-edit-overlay {
      opacity: 1;
    }
    .profile-name {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .profile-name .edit-icon {
      font-size: 12px;
      opacity: 0.7;
      margin-left: 4px;
      position: absolute;
    }
    .profile-role {
      font-size: 13px;
      background: transparent;
      padding: 4px 12px;
      border-radius: 12px;
      display: block;
    }
    .profile-month {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 8px;
    }

    /* 報酬サマリーカード */
    .compensation-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .compensation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .compensation-title {
      font-size: 14px;
      color: #6b7280;
      font-weight: 600;
    }
    .compensation-amount {
      font-size: 32px;
      font-weight: 800;
      color: #1f2937;
      margin-bottom: 4px;
    }
    .compensation-goal {
      font-size: 14px;
      color: #6b7280;
    }
    .compensation-goal .goal-amount {
      color: #40B4E5;
      font-weight: 600;
    }

    /* 進捗バー */
    .progress-container {
      margin: 16px 0;
    }
    .progress-bar-bg {
      height: 12px;
      background: #e5e7eb;
      border-radius: 6px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #40B4E5 0%, #10b981 100%);
      border-radius: 6px;
      transition: width 0.5s ease;
    }
    .progress-text {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 12px;
      color: #6b7280;
    }
    .progress-percent {
      font-weight: 700;
      color: #40B4E5;
    }

    /* 進捗吹き出し */
    .progress-milestone {
      margin-top: 12px;
      padding: 10px 14px;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 12px;
      font-size: 13px;
      color: #92400e;
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .progress-milestone::before {
      content: '';
      position: absolute;
      top: -6px;
      left: 20px;
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 6px solid #fef3c7;
    }
    .progress-milestone.milestone-50 {
      background: linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%);
      color: #1e40af;
    }
    .progress-milestone.milestone-50::before {
      border-bottom-color: #dbeafe;
    }
    .progress-milestone.milestone-80 {
      background: linear-gradient(135deg, #d1fae5 0%, #6ee7b7 100%);
      color: #065f46;
    }
    .progress-milestone.milestone-80::before {
      border-bottom-color: #d1fae5;
    }
    .progress-milestone.milestone-100 {
      background: linear-gradient(135deg, #fce7f3 0%, #f9a8d4 100%);
      color: #9d174d;
    }
    .progress-milestone.milestone-100::before {
      border-bottom-color: #fce7f3;
    }

    /* 内訳カード */
    .breakdown-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .breakdown-title {
      font-size: 14px;
      color: #374151;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .breakdown-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 12px 0;
      border-bottom: 1px solid #f3f4f6;
      gap: 12px;
    }
    .breakdown-item:last-child {
      border-bottom: none;
    }
    .breakdown-label {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .breakdown-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .breakdown-icon.listing {
      background: #dbeafe;
    }
    .breakdown-icon.shipping {
      background: #fef3c7;
    }
    .breakdown-icon.photography {
      background: #fce7f3;
    }
    .breakdown-icon.inspection {
      background: #d1fae5;
    }
    .breakdown-icon.stocktaking {
      background: #fed7aa;
    }
    .breakdown-icon.editing {
      background: #e0e7ff;
    }
    .breakdown-name {
      font-size: 14px;
      color: #374151;
      font-weight: 500;
    }
    .breakdown-count {
      font-size: 12px;
      color: #9ca3af;
    }
    .breakdown-amount {
      font-size: 16px;
      font-weight: 700;
      color: #1f2937;
    }

    /* 報酬単価アコーディオン（内訳セクション内） */
    .rate-accordion-btn {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 12px 16px;
      margin-top: 16px;
      background: #f3f4f6;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      color: #374151;
      cursor: pointer;
      transition: background 0.2s;
    }
    .rate-accordion-btn:hover {
      background: #e5e7eb;
    }
    .rate-accordion-btn i {
      transition: transform 0.2s;
    }
    .rate-accordion-btn.active i {
      transform: rotate(180deg);
    }
    .rate-accordion-content {
      display: none;
      padding: 12px 0 0 0;
    }
    .rate-accordion-content.active {
      display: block;
    }
    .rate-items {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .rate-item {
      display: flex;
      align-items: center;
      gap: 6px;
      background: #f9fafb;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
    }
    .rate-item-name {
      color: #6b7280;
    }
    .rate-item-value {
      font-weight: 600;
      color: #1f2937;
    }

    /* ランキングカード */
    .ranking-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .ranking-title {
      font-size: 14px;
      color: #374151;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .ranking-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      border-radius: 10px;
      margin-bottom: 8px;
      background: #f9fafb;
    }
    .ranking-item.highlight {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 2px solid #f59e0b;
    }
    .ranking-position {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      margin-right: 12px;
    }
    .ranking-position.gold {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: white;
    }
    .ranking-position.silver {
      background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
      color: white;
    }
    .ranking-position.bronze {
      background: linear-gradient(135deg, #f59e0b 0%, #b45309 100%);
      color: white;
    }
    .ranking-position.normal {
      background: #e5e7eb;
      color: #6b7280;
    }
    .ranking-name {
      flex: 1;
      font-size: 14px;
      color: #374151;
      font-weight: 500;
    }
    .ranking-name.me {
      color: #b45309;
      font-weight: 700;
    }
    .ranking-amount {
      font-size: 14px;
      font-weight: 700;
      color: #40B4E5;
    }
    .ranking-opt-out-message {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      background: #f3f4f6;
      border-radius: 10px;
      color: #6b7280;
      font-size: 14px;
      margin-bottom: 8px;
    }
    .ranking-opt-out-message i {
      font-size: 18px;
    }

    /* アクションボタン */
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 8px;
    }
    .action-btn {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .action-btn:hover {
      background: #f9fafb;
      border-color: #40B4E5;
    }
    .action-btn:active {
      transform: scale(0.98);
    }
    .action-btn i {
      font-size: 24px;
      color: #40B4E5;
      margin-bottom: 8px;
      display: block;
    }
    .action-btn span {
      font-size: 13px;
      color: #374151;
      font-weight: 500;
    }

    /* 目標設定モーダル */
    .goal-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .goal-modal {
      background: white;
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .goal-modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 16px;
      text-align: center;
    }
    .goal-input-group {
      margin-bottom: 20px;
    }
    .goal-input-group label {
      display: block;
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    .goal-input-wrapper {
      display: flex;
      align-items: center;
      background: #f3f4f6;
      border-radius: 10px;
      padding: 12px 16px;
    }
    .goal-input-wrapper span {
      font-size: 18px;
      color: #6b7280;
      margin-right: 8px;
    }
    .goal-input-wrapper input {
      flex: 1;
      min-width: 0;
      border: none;
      background: transparent;
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
      outline: none;
      text-align: right;
    }
    .goal-presets {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .goal-preset-btn {
      padding: 8px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 20px;
      background: white;
      font-size: 13px;
      color: #374151;
      cursor: pointer;
    }
    .goal-preset-btn:hover {
      border-color: #40B4E5;
      color: #40B4E5;
    }
    .goal-skip-option {
      margin-bottom: 20px;
      text-align: center;
    }
    .goal-skip-btn {
      padding: 10px 20px;
      border: 1px solid #9ca3af;
      border-radius: 8px;
      background: #f9fafb;
      font-size: 13px;
      color: #6b7280;
      cursor: pointer;
      width: 100%;
    }
    .goal-skip-btn:hover {
      background: #f3f4f6;
      border-color: #6b7280;
    }
    .ranking-option {
      margin-bottom: 20px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
    }
    .ranking-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }
    .ranking-toggle input {
      display: none;
    }
    .toggle-slider {
      width: 44px;
      height: 24px;
      background: #d1d5db;
      border-radius: 12px;
      position: relative;
      transition: background 0.2s;
      flex-shrink: 0;
    }
    .toggle-slider::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: transform 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .ranking-toggle input:checked + .toggle-slider {
      background: #40B4E5;
    }
    .ranking-toggle input:checked + .toggle-slider::after {
      transform: translateX(20px);
    }
    .toggle-label {
      font-size: 14px;
      color: #374151;
      font-weight: 500;
    }
    .ranking-option-note {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 8px;
      padding-left: 56px;
    }
    .goal-modal-buttons {
      display: flex;
      gap: 12px;
    }
    .goal-modal-buttons button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .goal-cancel-btn {
      background: #f3f4f6;
      border: none;
      color: #6b7280;
    }
    .goal-save-btn {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      border: none;
      color: white;
    }

    /* タスク別目標設定 */
    .task-goal-list {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 16px;
    }
    .task-goal-item {
      display: flex;
      align-items: center;
      padding: 12px;
      background: #f9fafb;
      border-radius: 10px;
      margin-bottom: 8px;
      gap: 12px;
    }
    .task-goal-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }
    .task-goal-icon.listing { background: #dbeafe; }
    .task-goal-icon.shipping { background: #fef3c7; }
    .task-goal-icon.photography { background: #fce7f3; }
    .task-goal-icon.inspection { background: #d1fae5; }
    .task-goal-icon.stocktaking { background: #fed7aa; }
    .task-goal-icon.editing { background: #e0e7ff; }
    .task-goal-info {
      flex: 1;
      min-width: 0;
    }
    .task-goal-name {
      font-size: 13px;
      font-weight: 600;
      color: #374151;
    }
    .task-goal-rate {
      font-size: 11px;
      color: #9ca3af;
    }
    .task-goal-input-wrap {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .task-goal-input {
      width: 60px;
      padding: 6px 8px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      text-align: right;
      color: #1f2937;
    }
    .task-goal-input:focus {
      outline: none;
      border-color: #40B4E5;
    }
    .task-goal-unit {
      font-size: 12px;
      color: #6b7280;
    }
    .task-goal-amount {
      font-size: 13px;
      font-weight: 600;
      color: #40B4E5;
      min-width: 70px;
      text-align: right;
    }
    .goal-total-section {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
      text-align: center;
    }
    .goal-total-label {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .goal-total-amount {
      font-size: 28px;
      font-weight: 700;
      color: #0369a1;
    }

    /* プログレスバー付き内訳 */
    .breakdown-progress-wrap {
      margin-top: 6px;
    }
    .breakdown-progress-bar {
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
    }
    .breakdown-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #40B4E5, #1E8FBF);
      border-radius: 3px;
      transition: width 0.3s;
    }
    .breakdown-progress-text {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }
    .breakdown-goal-text {
      font-size: 11px;
      color: #40B4E5;
      font-weight: 500;
    }

    /* ========== 管理者マイページ ========== */
    .admin-section {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .admin-section-title {
      font-size: 15px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .admin-summary-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .admin-summary-card {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    .admin-summary-card.highlight {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      color: white;
    }
    .admin-summary-card.highlight .admin-summary-label {
      color: rgba(255,255,255,0.8);
    }
    .admin-summary-label {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .admin-summary-value {
      font-size: 24px;
      font-weight: 700;
      color: #0369a1;
    }
    .admin-summary-card.highlight .admin-summary-value {
      color: white;
    }
    .staff-performance-list {
      max-height: 400px;
      overflow-y: auto;
    }
    .staff-performance-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 8px;
      background: #f9fafb;
      gap: 12px;
    }
    .staff-performance-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      overflow: hidden;
    }
    .staff-performance-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .staff-performance-info {
      flex: 1;
      min-width: 0;
    }
    .staff-performance-name {
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
    }
    .staff-performance-stats {
      font-size: 12px;
      color: #6b7280;
    }
    .staff-performance-amount {
      font-size: 16px;
      font-weight: 700;
      color: #40B4E5;
    }
    .staff-performance-progress {
      width: 100%;
      margin-top: 6px;
    }
    .staff-performance-bar {
      height: 4px;
      background: #e5e7eb;
      border-radius: 2px;
      overflow: hidden;
    }
    .staff-performance-fill {
      height: 100%;
      background: linear-gradient(90deg, #40B4E5, #1E8FBF);
      border-radius: 2px;
    }
    .team-goal-section {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      margin-bottom: 16px;
    }
    .team-goal-label {
      font-size: 13px;
      color: #92400e;
      margin-bottom: 8px;
    }
    .team-goal-amount {
      font-size: 32px;
      font-weight: 700;
      color: #78350f;
    }
    .team-goal-progress {
      margin-top: 12px;
    }
    .team-goal-bar {
      height: 8px;
      background: rgba(255,255,255,0.5);
      border-radius: 4px;
      overflow: hidden;
    }
    .team-goal-fill {
      height: 100%;
      background: #f59e0b;
      border-radius: 4px;
    }
    .team-goal-text {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #92400e;
      margin-top: 6px;
    }
    .system-status-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .system-status-item {
      background: #f9fafb;
      border-radius: 10px;
      padding: 14px;
      text-align: center;
    }
    .system-status-icon {
      font-size: 24px;
      margin-bottom: 6px;
    }
    .system-status-label {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .system-status-value {
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }
    .system-status-note {
      text-align: center;
      font-size: 12px;
      color: #9ca3af;
      margin-top: 12px;
      padding: 12px;
      background: #f3f4f6;
      border-radius: 8px;
    }

    /* 目標履歴モーダル */
    .history-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .history-modal {
      background: white;
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .history-modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 16px;
      text-align: center;
    }
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .history-item {
      background: #f9fafb;
      border-radius: 12px;
      padding: 16px;
      border-left: 4px solid #40B4E5;
    }
    .history-item.achieved {
      border-left-color: #10b981;
    }
    .history-item.not-achieved {
      border-left-color: #ef4444;
    }
    .history-month {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }
    .history-amounts {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .history-goal, .history-actual {
      font-size: 13px;
      color: #6b7280;
    }
    .history-goal span, .history-actual span {
      font-weight: 600;
      color: #1f2937;
    }
    .history-progress {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .history-progress-bar {
      flex: 1;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
    }
    .history-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #40B4E5, #1E8FBF);
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    .history-progress-fill.achieved {
      background: linear-gradient(90deg, #10b981, #059669);
    }
    .history-percent {
      font-size: 14px;
      font-weight: 700;
      color: #40B4E5;
      min-width: 45px;
      text-align: right;
    }
    .history-percent.achieved {
      color: #10b981;
    }
    .history-empty {
      text-align: center;
      padding: 32px 16px;
      color: #9ca3af;
    }
    .history-empty i {
      font-size: 48px;
      margin-bottom: 12px;
      display: block;
    }
    .history-close-btn {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: #f3f4f6;
      border: none;
      color: #6b7280;
      margin-top: 16px;
    }
    /* 履歴詳細セクション */
    .history-details {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }
    .history-breakdown {
      display: flex;
      gap: 12px;
      margin-bottom: 8px;
    }
    .history-breakdown-item {
      flex: 1;
      background: white;
      padding: 8px;
      border-radius: 8px;
      text-align: center;
    }
    .history-breakdown-icon {
      font-size: 16px;
      margin-bottom: 4px;
    }
    .history-breakdown-label {
      font-size: 10px;
      color: #9ca3af;
    }
    .history-breakdown-value {
      font-size: 12px;
      font-weight: 600;
      color: #374151;
    }
    .history-ranking {
      background: white;
      padding: 8px 12px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .history-ranking-label {
      font-size: 12px;
      color: #6b7280;
    }
    .history-ranking-value {
      font-size: 14px;
      font-weight: 700;
      color: #f59e0b;
    }
    .history-toggle {
      font-size: 11px;
      color: #40B4E5;
      cursor: pointer;
      text-align: center;
      margin-top: 8px;
    }

    /* お知らせモーダル */
    .announce-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .announce-modal {
      background: white;
      border-radius: 16px;
      padding: 0;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .announce-modal-header {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      color: white;
      padding: 16px 20px;
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .announce-modal-body {
      padding: 0;
      max-height: 60vh;
      overflow-y: auto;
    }
    .announce-list {
      display: flex;
      flex-direction: column;
    }
    .announce-item {
      padding: 16px 20px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s;
    }
    .announce-item:hover {
      background: #f9fafb;
    }
    .announce-item.unread {
      background: #eff6ff;
    }
    .announce-item.unread:hover {
      background: #dbeafe;
    }
    .announce-item-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .announce-priority {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
    }
    .announce-priority.important {
      background: #fef2f2;
      color: #dc2626;
    }
    .announce-priority.normal {
      background: #f0f9ff;
      color: #0284c7;
    }
    .announce-date {
      font-size: 12px;
      color: #9ca3af;
    }
    .announce-title {
      font-size: 15px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }
    .announce-preview {
      font-size: 13px;
      color: #6b7280;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .announce-empty {
      text-align: center;
      padding: 40px 20px;
      color: #9ca3af;
    }
    .announce-empty i {
      font-size: 48px;
      margin-bottom: 12px;
      display: block;
    }
    .announce-modal-footer {
      padding: 12px 20px;
      border-top: 1px solid #f0f0f0;
    }
    .announce-close-btn {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: #f3f4f6;
      border: none;
      color: #6b7280;
    }
    /* お知らせ詳細 */
    .announce-detail {
      padding: 20px;
    }
    .announce-detail-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 8px;
    }
    .announce-detail-meta {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .announce-detail-body {
      font-size: 14px;
      color: #374151;
      line-height: 1.7;
      white-space: pre-wrap;
    }
    .announce-back-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 14px;
      color: #40B4E5;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      margin-bottom: 16px;
    }

    /* ノート機能 */
    .notes-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      z-index: 1100;
    }
    .notes-modal-backdrop.active {
      display: block;
    }
    .notes-modal {
      position: fixed;
      top: 0;
      right: -100%;
      width: 100%;
      height: 100%;
      background: #f8f9fa;
      z-index: 1101;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    .notes-modal.active {
      right: 0;
    }
    .notes-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: white;
      border-bottom: 1px solid #e5e7eb;
    }
    .notes-modal-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .notes-back-btn {
      background: none;
      border: none;
      font-size: 20px;
      color: #6b7280;
      cursor: pointer;
      padding: 4px;
    }
    .notes-modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
    }
    .notes-add-btn {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      color: white;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .notes-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    .notes-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .note-item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .note-item:active {
      transform: scale(0.98);
    }
    .note-item-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .note-item-icon {
      font-size: 20px;
      color: #f59e0b;
    }
    .note-item-title {
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .note-item-date {
      font-size: 12px;
      color: #9ca3af;
    }
    .note-item-preview {
      font-size: 13px;
      color: #6b7280;
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .notes-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      color: #9ca3af;
    }
    .notes-empty i {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    .notes-empty-text {
      font-size: 15px;
      text-align: center;
      line-height: 1.6;
    }

    /* ノート編集モーダル */
    .note-editor-modal {
      position: fixed;
      top: 0;
      right: -100%;
      width: 100%;
      height: 100%;
      background: white;
      z-index: 1200;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    .note-editor-modal.active {
      right: 0;
    }
    .note-editor-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: white;
      border-bottom: 1px solid #e5e7eb;
    }
    .note-editor-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .note-editor-header-right {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .note-editor-btn {
      background: none;
      border: none;
      padding: 8px;
      color: #6b7280;
      font-size: 18px;
      cursor: pointer;
      border-radius: 8px;
    }
    .note-editor-btn:hover {
      background: #f3f4f6;
    }
    .note-editor-btn.delete {
      color: #ef4444;
    }
    .note-editor-body {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .note-title-input {
      width: 100%;
      padding: 16px;
      font-size: 20px;
      font-weight: 700;
      border: none;
      outline: none;
      background: transparent;
    }
    .note-title-input::placeholder {
      color: #9ca3af;
    }
    /* キャンバス形式のブロックコンテナ */
    .note-blocks-container {
      position: relative;
      min-height: 600px;
      height: calc(100vh - 180px);
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    /* 罫線タイプ */
    .note-blocks-container.paper-lined {
      background-image: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 31px,
        #e5e7eb 31px,
        #e5e7eb 32px
      );
      background-position: 0 16px;
    }
    .note-blocks-container.paper-grid {
      background-image:
        linear-gradient(#e5e7eb 1px, transparent 1px),
        linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
      background-size: 24px 24px;
    }
    /* 自由配置ブロック（透明） */
    .note-block {
      position: absolute;
      min-width: 100px;
      max-width: calc(100% - 32px);
      background: transparent;
    }
    .note-block.dragging {
      z-index: 1000;
      opacity: 0.7;
    }
    .note-block.selected {
      z-index: 100;
    }
    /* ブロック選択時のコントロール（枠の下に表示） */
    .block-controls {
      position: absolute;
      bottom: -36px;
      left: 0;
      display: none;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      z-index: 10;
    }
    .note-block.selected .block-controls {
      display: flex;
    }
    /* ドラッグハンドル */
    .block-drag-handle {
      position: absolute;
      top: -12px;
      right: -12px;
      width: 28px;
      height: 28px;
      background: #40B4E5;
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
      cursor: move;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 11;
      touch-action: none;
    }
    .note-block.selected .block-drag-handle {
      display: flex;
    }
    .block-ctrl-btn {
      padding: 4px 8px;
      font-size: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      background: white;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.15s;
    }
    .block-ctrl-btn:hover {
      border-color: #40B4E5;
      color: #40B4E5;
    }
    .block-ctrl-btn.active {
      background: #40B4E5;
      border-color: #40B4E5;
      color: white;
    }
    .block-ctrl-btn.delete {
      color: #ef4444;
      border-color: #fecaca;
    }
    .block-ctrl-btn.delete:hover {
      background: #ef4444;
      color: white;
    }
    .block-color-dot {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid #e5e7eb;
      cursor: pointer;
    }
    .block-color-dot:hover {
      transform: scale(1.1);
    }
    /* ブロックコンテンツ */
    .block-content {
      position: relative;
    }
    .block-textarea {
      width: 100%;
      min-height: 44px;
      padding: 8px 12px;
      border: 1px solid transparent;
      border-radius: 8px;
      font-size: 16px; /* iOS zoom防止 */
      line-height: 1.6;
      resize: none;
      outline: none;
      background: transparent; /* 罫線が見えるように透明 */
      overflow: hidden; /* 自動リサイズ時にスクロールバー非表示 */
      transition: border-color 0.15s, background 0.15s;
    }
    .block-textarea:hover {
      border-color: #e5e7eb;
      background: rgba(255,255,255,0.5);
    }
    .block-textarea:focus {
      border-color: #40B4E5;
      background: rgba(255,255,255,0.8);
    }
    /* リッチテキストブロック */
    .block-richtext {
      width: 100%;
      min-height: 44px;
      padding: 8px 12px;
      border: 1px solid transparent;
      border-radius: 8px;
      font-size: 16px;
      line-height: 1.6;
      outline: none;
      background: transparent;
      transition: border-color 0.15s, background 0.15s;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .block-richtext:hover {
      border-color: #e5e7eb;
      background: rgba(255,255,255,0.5);
    }
    .block-richtext:focus {
      border-color: #40B4E5;
      background: rgba(255,255,255,0.8);
    }
    .block-richtext:empty:before {
      content: attr(data-placeholder);
      color: #9ca3af;
      pointer-events: none;
    }
    /* フォーマットボタン */
    .block-ctrl-btn.format {
      font-family: Georgia, serif;
      min-width: 24px;
    }
    .block-ctrl-btn.format b,
    .block-ctrl-btn.format i,
    .block-ctrl-btn.format u,
    .block-ctrl-btn.format s {
      font-size: 13px;
    }
    /* 見出しブロック */
    .block-heading {
      width: 100%;
      padding: 4px 8px;
      border: none;
      background: transparent;
      font-weight: 600;
      line-height: 1.4;
      resize: none;
      outline: none;
      overflow: hidden;
    }
    .block-heading:focus {
      background: rgba(255,255,255,0.5);
      border-radius: 4px;
    }
    .block-heading.h1 {
      font-size: 28px;
    }
    .block-heading.h2 {
      font-size: 22px;
    }
    .block-heading.h3 {
      font-size: 18px;
    }
    /* 画像ブロック */
    .block-img {
      display: block;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .block-img.size-small {
      width: 150px;
    }
    .block-img.size-medium {
      width: 280px;
    }
    .block-img.size-large {
      width: 400px;
    }
    /* ファイルブロック */
    .block-file-card {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: rgba(255,255,255,0.9);
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 13px;
      color: #374151;
      cursor: pointer;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    .block-file-card:hover {
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }
    .block-file-card i {
      font-size: 18px;
      color: #6b7280;
    }
    /* 下部固定の追加ボタン */
    .note-add-fixed {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 50;
      display: none; /* デフォルトは非表示、ノート編集時のみ表示 */
    }
    .note-add-fixed.active {
      display: block;
    }
    .note-add-fixed-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 20px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 24px;
      font-size: 14px;
      color: #6b7280;
      cursor: pointer;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      transition: all 0.15s;
    }
    .note-add-fixed-btn:hover {
      border-color: #40B4E5;
      color: #40B4E5;
      box-shadow: 0 4px 16px rgba(64,180,229,0.2);
    }
    .note-add-fixed-btn i {
      font-size: 16px;
    }
    /* ブロック追加ポップオーバー */
    .note-add-popover {
      position: absolute;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 8px;
      display: none;
      z-index: 1300;
      min-width: 140px;
    }
    .note-add-popover.active {
      display: block;
    }
    .note-add-popover-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: none;
      border: none;
      width: 100%;
      font-size: 14px;
      color: #374151;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.15s;
    }
    .note-add-popover-item:hover {
      background: #f3f4f6;
    }
    .note-add-popover-item i {
      font-size: 16px;
      color: #6b7280;
      width: 20px;
    }
    /* カラー選択ポップオーバー */
    .block-color-popover {
      position: absolute;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 12px;
      display: none;
      z-index: 1300;
    }
    .block-color-popover.active {
      display: block;
    }
    .block-color-popover-title {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    .block-color-popover-grid {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      max-width: 160px;
    }
    .block-color-option {
      width: 28px;
      height: 28px;
      border: 2px solid #e5e7eb;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.15s;
    }
    .block-color-option:hover {
      transform: scale(1.1);
    }
    .block-color-option.active {
      border-color: #40B4E5;
      box-shadow: 0 0 0 2px rgba(64,180,229,0.3);
    }
    /* ブロックツールバー（カラーボタン等） */
    .block-toolbar {
      display: flex;
      gap: 4px;
      margin-top: 6px;
    }
    .block-toolbar-btn {
      width: 28px;
      height: 28px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #6b7280;
      transition: all 0.15s;
      position: relative;
    }
    .block-toolbar-btn:hover {
      border-color: #40B4E5;
      color: #40B4E5;
    }
    .block-color-indicator {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 1px solid rgba(0,0,0,0.1);
    }
    /* ポップオーバー用オーバーレイ */
    .popover-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1299;
      display: none;
    }
    .popover-overlay.active {
      display: block;
    }
    /* 罫線選択ポップオーバー */
    .paper-type-popover {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 8px;
      min-width: 140px;
      display: none;
      z-index: 1300;
    }
    .paper-type-popover.active {
      display: block;
    }
    .paper-type-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
    }
    .paper-type-option:hover {
      background: #f3f4f6;
    }
    .paper-type-option.selected {
      background: #eff6ff;
      color: #1E8FBF;
    }
    .paper-type-option i {
      font-size: 16px;
    }
    /* Sortable.js用 */
    .sortable-ghost {
      opacity: 0.4;
    }
    .sortable-chosen {
      background: #f0f9ff;
    }

    /* ノート共有モーダル */
    .share-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 5000;
      display: none;
    }
    .share-modal-overlay.active {
      display: block;
    }
    .share-modal {
      position: fixed;
      bottom: -100%;
      left: 0;
      right: 0;
      max-height: 70vh;
      background: white;
      border-radius: 16px 16px 0 0;
      z-index: 5001;
      transition: bottom 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    .share-modal.active {
      bottom: 0;
    }
    .share-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
      font-weight: 600;
      font-size: 16px;
    }
    .share-modal-close {
      background: none;
      border: none;
      padding: 8px;
      cursor: pointer;
      color: #6b7280;
    }
    .share-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }
    .share-loading {
      text-align: center;
      padding: 40px 20px;
      color: #9ca3af;
    }
    .share-room-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .share-room-item:hover {
      background: #f9fafb;
    }
    .share-room-item:active {
      background: #f3f4f6;
    }
    .share-room-icon {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, #1E8FBF, #0ea5e9);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      flex-shrink: 0;
    }
    .share-room-info {
      flex: 1;
      min-width: 0;
    }
    .share-room-name {
      font-size: 15px;
      font-weight: 500;
      color: #1f2937;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .share-room-type {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 2px;
    }
    .share-link-section {
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
    }
    .share-link-title {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    .share-link-box {
      display: flex;
      gap: 8px;
    }
    .share-link-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 13px;
      background: #f9fafb;
    }
    .share-link-copy-btn {
      padding: 10px 16px;
      background: #1E8FBF;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
    }
    .share-link-copy-btn:active {
      background: #1a7ba3;
    }
    .share-rooms-title {
      padding: 12px 20px 8px;
      font-size: 12px;
      color: #6b7280;
    }

    /* ベルアイコンのバッジ（v288: 赤いドット表示に変更） */
    .sub-header-icon {
      position: relative;
    }
    .announce-dot {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      display: none;
      box-shadow: 0 0 0 2px white;
    }
    .announce-dot.active {
      display: block;
    }

    /* 設定ドロップダウン */
    .settings-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 200px;
      overflow: hidden;
      display: none;
      z-index: 1001;
    }
    .settings-dropdown.active {
      display: block;
    }
    .settings-dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      font-size: 14px;
      color: #1f2937;
      text-decoration: none;
      transition: background 0.2s;
      cursor: pointer;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }
    .settings-dropdown-item:hover {
      background: #f3f4f6;
    }
    .settings-dropdown-item i {
      font-size: 18px;
      color: #6b7280;
      width: 24px;
      text-align: center;
    }
    .settings-dropdown-item.admin-only {
      display: none;
    }
    .settings-dropdown-item.admin-only.visible {
      display: flex;
      border-top: 1px solid #e5e7eb;
      color: #6366f1;
    }
    .settings-dropdown-item.admin-only.visible i {
      color: #6366f1;
    }
    .settings-dropdown-divider {
      height: 1px;
      background: #e5e7eb;
      margin: 4px 0;
    }

    /* ローディング */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    /* 非対象ユーザー向けメッセージ */
    .not-eligible {
      text-align: center;
      padding: 40px 20px;
    }
    .not-eligible i {
      font-size: 64px;
      color: #d1d5db;
      margin-bottom: 16px;
    }
    .not-eligible h3 {
      font-size: 18px;
      color: #374151;
      margin-bottom: 8px;
    }
    .not-eligible p {
      font-size: 14px;
      color: #6b7280;
    }

    /* 報酬履歴モーダル */
    .comp-history-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: flex-end;
      z-index: 1000;
    }
    .comp-history-modal-backdrop.active {
      display: flex;
    }
    .comp-history-modal {
      background: white;
      width: 100%;
      max-height: 80vh;
      border-radius: 20px 20px 0 0;
      display: flex;
      flex-direction: column;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }
    .comp-history-modal-backdrop.active .comp-history-modal {
      transform: translateY(0);
    }
    .comp-history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
    }
    .comp-history-title {
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }
    .comp-history-close {
      width: 32px;
      height: 32px;
      border: none;
      background: #f3f4f6;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      color: #6b7280;
    }
    .comp-history-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
    }
    .comp-history-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .comp-history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: #f9fafb;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .comp-history-item:active {
      background: #f3f4f6;
    }
    .comp-history-item-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .comp-history-item-month {
      font-size: 15px;
      font-weight: 600;
      color: #1f2937;
    }
    .comp-history-item-count {
      font-size: 12px;
      color: #6b7280;
    }
    .comp-history-item-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .comp-history-item-amount {
      font-size: 16px;
      font-weight: 600;
      color: #40B4E5;
    }
    .comp-history-item-arrow {
      color: #9ca3af;
      font-size: 14px;
    }
    .comp-history-empty {
      text-align: center;
      padding: 40px 20px;
      color: #6b7280;
    }
    .comp-history-empty i {
      font-size: 48px;
      color: #d1d5db;
      margin-bottom: 12px;
    }

    /* 報酬明細モーダル */
    .comp-detail-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      display: none;
      z-index: 1001;
    }
    .comp-detail-modal-backdrop.active {
      display: block;
    }
    .comp-detail-modal {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    .comp-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: white;
      border-bottom: 1px solid #f0f0f0;
    }
    .comp-detail-back, .comp-detail-pdf {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      color: #374151;
      border-radius: 50%;
    }
    .comp-detail-back:active, .comp-detail-pdf:active {
      background: #f3f4f6;
    }
    .comp-detail-title {
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }
    .comp-detail-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px 16px;
      background: #f9fafb;
    }
    .comp-detail-summary {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      text-align: center;
    }
    .comp-detail-total-label {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .comp-detail-total-amount {
      font-size: 32px;
      font-weight: 700;
      color: #40B4E5;
    }
    .comp-detail-period {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 8px;
    }
    .comp-detail-breakdown {
      background: white;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .comp-detail-breakdown-title {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 12px;
    }
    .comp-detail-breakdown-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    .comp-detail-breakdown-item:last-child {
      border-bottom: none;
    }
    .comp-detail-breakdown-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .comp-detail-breakdown-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .comp-detail-breakdown-icon.listing { background: #dbeafe; }
    .comp-detail-breakdown-icon.shipping { background: #fef3c7; }
    .comp-detail-breakdown-icon.photography { background: #fce7f3; }
    .comp-detail-breakdown-icon.inspection { background: #d1fae5; }
    .comp-detail-breakdown-icon.stocktaking { background: #fed7aa; }
    .comp-detail-breakdown-icon.editing { background: #e0e7ff; }
    .comp-detail-breakdown-name {
      font-size: 14px;
      color: #374151;
    }
    .comp-detail-breakdown-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
    }
    .comp-detail-breakdown-amount {
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
    }
    .comp-detail-breakdown-count {
      font-size: 11px;
      color: #9ca3af;
    }
    .comp-detail-records {
      background: white;
      border-radius: 16px;
      padding: 16px;
    }
    .comp-detail-records-title {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 12px;
    }
    .comp-detail-record-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    .comp-detail-record-item:last-child {
      border-bottom: none;
    }
    .comp-detail-record-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .comp-detail-record-desc {
      font-size: 13px;
      color: #374151;
    }
    .comp-detail-record-date {
      font-size: 11px;
      color: #9ca3af;
    }
    .comp-detail-record-amount {
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
    }
  </style>
</head>
<body>
  <!-- ローディング -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted">データを読み込んでいます...</p>
    </div>
  </div>

  <!-- v207: サブヘッダー（統一スタイル） -->
  <style>
    .sub-header {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 56px;
      padding: 0 16px;
      background: #ffffff;
      border-bottom: 1px solid #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .sub-header-back {
      position: absolute;
      left: 16px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 20px;
      transition: background 0.2s;
    }
    .sub-header-back:hover {
      background: #f2f2f2;
    }
    .sub-header-back:active {
      background: #e5e5e5;
    }
    .sub-header-title {
      font-weight: 600;
      font-size: 16px;
      color: #1f2937;
    }
    .sub-header-icons {
      position: absolute;
      right: 16px;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    .sub-header-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 20px;
      transition: background 0.2s;
      position: relative;
    }
    .sub-header-icon:hover {
      background: #f2f2f2;
    }
    .sub-header-icon:active {
      background: #e5e5e5;
    }
  </style>
  <div class="sub-header">
    <button class="sub-header-back" onclick="window.parent.postMessage({type:'navigateToPage', page:'home'}, '*')" title="戻る">
      <i class="bi bi-chevron-left"></i>
    </button>
    <span class="sub-header-title">マイページ</span>
    <div class="sub-header-icons">
      <button class="sub-header-icon" title="ノート" onclick="openNotesModal()">
        <i class="bi bi-journal-text"></i>
      </button>
      <button class="sub-header-icon" title="通知" onclick="openAnnouncePage()">
        <i class="bi bi-bell"></i>
        <span class="announce-dot" id="announceDot"></span>
      </button>
      <div style="position: relative;">
        <button class="sub-header-icon" title="メニュー" onclick="toggleSettingsDropdown(event)">
          <i class="bi bi-list"></i>
        </button>
        <div class="settings-dropdown" id="settingsDropdown">
          <button class="settings-dropdown-item" onclick="openPersonalInfoModal()">
            <i class="bi bi-person-badge"></i>
            <span>個人情報設定</span>
          </button>
          <button class="settings-dropdown-item" onclick="openNotificationSettingsModal()">
            <i class="bi bi-bell"></i>
            <span>通知設定</span>
          </button>
          <div class="settings-dropdown-divider"></div>
          <button class="settings-dropdown-item" onclick="window.parent.postMessage({type:'navigate', page:'help'}, '*')">
            <i class="bi bi-question-circle"></i>
            <span>ヘルプ</span>
          </button>
          <button class="settings-dropdown-item admin-only" id="adminAnnounceLink" onclick="openAdminAnnounce()">
            <i class="bi bi-megaphone"></i>
            <span>お知らせ管理</span>
          </button>
          <button class="settings-dropdown-item admin-only" id="adminPlanLink" onclick="openPlanManagement()">
            <i class="bi bi-award"></i>
            <span>プラン管理</span>
          </button>
          <div class="settings-dropdown-divider"></div>
          <button class="settings-dropdown-item" onclick="openPrivacyPolicy()">
            <i class="bi bi-file-text"></i>
            <span>プライバシーポリシー</span>
          </button>
          <button class="settings-dropdown-item" onclick="openTermsOfService()">
            <i class="bi bi-file-earmark-text"></i>
            <span>利用規約</span>
          </button>
          <div class="settings-dropdown-divider"></div>
          <button class="settings-dropdown-item" onclick="openFeedback()">
            <i class="bi bi-chat-square-text"></i>
            <span>フィードバック送信</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="content-container" id="mainContent">
    <!-- 動的に表示 -->
  </div>

  <!-- 目標設定モーダル -->
  <div class="goal-modal-backdrop" id="goalModal">
    <div class="goal-modal">
      <div class="goal-modal-title">🎯 今月のタスク目標を設定</div>
      
      <!-- タスク別目標入力 -->
      <div class="task-goal-list" id="taskGoalList">
        <!-- JavaScriptで動的生成 -->
      </div>

      <!-- 合計目標金額 -->
      <div class="goal-total-section">
        <div class="goal-total-label">合計目標金額</div>
        <div class="goal-total-amount" id="goalTotalAmount">¥0</div>
      </div>

      <div class="goal-skip-option">
        <button class="goal-skip-btn" onclick="skipGoal()">目標を設定しない</button>
      </div>
      <div class="ranking-option">
        <label class="ranking-toggle">
          <input type="checkbox" id="rankingParticipation" checked>
          <span class="toggle-slider"></span>
          <span class="toggle-label">ランキングに参加する</span>
        </label>
        <div class="ranking-option-note">オフにすると他のメンバーにあなたの順位が表示されません</div>
      </div>
      <div class="goal-modal-buttons">
        <button class="goal-cancel-btn" onclick="closeGoalModal()">キャンセル</button>
        <button class="goal-save-btn" onclick="saveGoal()">保存</button>
      </div>
    </div>
  </div>

  <!-- 履歴モーダル -->
  <div class="history-modal-backdrop" id="historyModal">
    <div class="history-modal">
      <div class="history-modal-title">📊 目標履歴</div>
      <div class="history-list" id="historyList">
        <!-- 動的に生成 -->
      </div>
      <button class="history-close-btn" onclick="closeHistoryModal()">閉じる</button>
    </div>
  </div>

  <!-- 報酬履歴モーダル -->
  <div class="comp-history-modal-backdrop" id="compHistoryModal">
    <div class="comp-history-modal">
      <div class="comp-history-header">
        <span class="comp-history-title">📋 報酬履歴</span>
        <button class="comp-history-close" onclick="closeCompensationHistoryModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>
      <div class="comp-history-body">
        <div class="comp-history-list" id="compHistoryList">
          <!-- 動的に生成 -->
        </div>
      </div>
    </div>
  </div>

  <!-- 報酬明細モーダル -->
  <div class="comp-detail-modal-backdrop" id="compDetailModal">
    <div class="comp-detail-modal">
      <div class="comp-detail-header">
        <button class="comp-detail-back" onclick="closeCompensationDetailModal()">
          <i class="bi bi-chevron-left"></i>
        </button>
        <span class="comp-detail-title" id="compDetailTitle">2025年1月 報酬明細</span>
        <button class="comp-detail-pdf" onclick="downloadCompensationPDF()">
          <i class="bi bi-download"></i>
        </button>
      </div>
      <div class="comp-detail-body" id="compDetailBody">
        <!-- 動的に生成 -->
      </div>
    </div>
  </div>

  <!-- 背景選択モーダル -->
  <div class="bg-modal-backdrop" id="bgModal">
    <div class="bg-modal">
      <div class="bg-modal-header">
        <span class="bg-modal-title">背景を変更</span>
        <button class="bg-modal-close" onclick="closeBgModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>
      <div class="bg-modal-body">
        <div class="bg-section-title">グラデーション</div>
        <div class="bg-gradient-grid" id="bgGradientGrid">
          <!-- グラデーションプリセット（JavaScriptで生成） -->
        </div>
        <div class="bg-section-title">カスタム画像</div>
        <div class="bg-image-upload">
          <label class="bg-upload-btn" for="bgImageInput">
            <i class="bi bi-image"></i>
            <span>画像をアップロード</span>
          </label>
          <input type="file" id="bgImageInput" accept="image/*" style="display: none;" onchange="handleBgImageSelect(event)">
        </div>
        <div class="bg-preview" id="bgPreview">
          <div class="bg-position-adjuster" id="bgPositionAdjuster">
            <img class="bg-preview-image" id="bgPreviewImage" src="" alt="プレビュー" draggable="false">
            <div class="bg-position-hint">ドラッグして位置を調整</div>
          </div>
          <div class="bg-position-reset">
            <button type="button" class="bg-position-reset-btn" onclick="resetBgPosition()">
              <i class="bi bi-arrow-counterclockwise"></i> 位置をリセット
            </button>
          </div>
          <button class="bg-preview-remove" onclick="removeBgImage()">
            <i class="bi bi-trash"></i> 画像を削除
          </button>
        </div>
      </div>
      <div class="bg-modal-footer">
        <button class="bg-cancel-btn" onclick="closeBgModal()">キャンセル</button>
        <button class="bg-save-btn" id="bgSaveBtn" onclick="saveBgSetting()">保存</button>
      </div>
    </div>
  </div>

  <!-- お知らせモーダル -->
  <div class="announce-modal-backdrop" id="announceModal">
    <div class="announce-modal">
      <div class="announce-modal-header">
        <i class="bi bi-bell"></i> お知らせ
      </div>
      <div class="announce-modal-body" id="announceModalBody">
        <!-- 動的に生成 -->
      </div>
      <div class="announce-modal-footer">
        <button class="announce-close-btn" onclick="closeAnnouncementModal()">閉じる</button>
      </div>
    </div>
  </div>

  <!-- ノート一覧モーダル -->
  <div class="notes-modal-backdrop" id="notesModalBackdrop" onclick="closeNotesModal()"></div>
  <div class="notes-modal" id="notesModal">
    <div class="notes-modal-header">
      <div class="notes-modal-header-left">
        <button class="notes-back-btn" onclick="closeNotesModal()">
          <i class="bi bi-chevron-left"></i>
        </button>
        <span class="notes-modal-title">ノート</span>
      </div>
      <button class="notes-add-btn" onclick="createNewNote()">
        <i class="bi bi-plus"></i>
      </button>
    </div>
    <div class="notes-modal-body" id="notesModalBody">
      <div class="notes-empty">
        <i class="bi bi-journal-text"></i>
        <div class="notes-empty-text">
          ノートがありません<br>
          <small>＋ボタンから新しいノートを作成できます</small>
        </div>
      </div>
    </div>
  </div>

  <!-- ノート編集モーダル -->
  <div class="note-editor-modal" id="noteEditorModal">
    <div class="note-editor-header">
      <div class="note-editor-header-left">
        <button class="note-editor-btn" onclick="closeNoteEditor()">
          <i class="bi bi-chevron-left"></i>
        </button>
      </div>
      <div class="note-editor-header-right">
        <div style="position: relative;">
          <button class="note-editor-btn" onclick="togglePaperTypePopover()" title="罫線タイプ">
            <i class="bi bi-journal"></i>
          </button>
          <div class="paper-type-popover" id="paperTypePopover">
            <div class="paper-type-option" data-type="blank" onclick="selectPaperType('blank')">
              <i class="bi bi-square"></i>
              <span>無地</span>
            </div>
            <div class="paper-type-option" data-type="lined" onclick="selectPaperType('lined')">
              <i class="bi bi-text-left"></i>
              <span>横罫線</span>
            </div>
            <div class="paper-type-option selected" data-type="grid" onclick="selectPaperType('grid')">
              <i class="bi bi-grid-3x3"></i>
              <span>方眼</span>
            </div>
          </div>
        </div>
        <button class="note-editor-btn" onclick="shareNote()" title="共有">
          <i class="bi bi-share"></i>
        </button>
        <button class="note-editor-btn delete" onclick="deleteNote()" title="削除">
          <i class="bi bi-trash"></i>
        </button>
      </div>
    </div>
    <div class="note-editor-body">
      <input type="text" class="note-title-input" id="noteTitleInput" placeholder="タイトル" oninput="scheduleNoteSave()">
      <div class="note-blocks-container paper-grid" id="noteBlocksContainer">
        <!-- ブロックが動的に追加される -->
      </div>
    </div>
    <!-- 下部固定の追加ボタン -->
    <div class="note-add-fixed" id="noteAddFixed">
      <button class="note-add-fixed-btn" onclick="showAddPopover(event)">
        <i class="bi bi-plus"></i>
        <span>ブロックを追加</span>
      </button>
    </div>
    <!-- ポップオーバー用オーバーレイ -->
    <div class="popover-overlay" id="popoverOverlay" onclick="closeAllPopovers()"></div>
    <!-- ブロック追加ポップオーバー -->
    <div class="note-add-popover" id="noteAddPopover">
      <button class="note-add-popover-item" onclick="addHeadingBlock(); closeAllPopovers();">
        <i class="bi bi-type-h1"></i>
        <span>見出し</span>
      </button>
      <button class="note-add-popover-item" onclick="addTextBlock(); closeAllPopovers();">
        <i class="bi bi-fonts"></i>
        <span>テキスト</span>
      </button>
      <button class="note-add-popover-item" onclick="triggerImageUpload(); closeAllPopovers();">
        <i class="bi bi-image"></i>
        <span>画像</span>
      </button>
      <button class="note-add-popover-item" onclick="triggerFileUpload(); closeAllPopovers();">
        <i class="bi bi-paperclip"></i>
        <span>ファイル</span>
      </button>
    </div>
    <!-- カラー選択ポップオーバー -->
    <div class="block-color-popover" id="blockColorPopover">
      <div class="block-color-popover-title">文字色</div>
      <div class="block-color-popover-grid" id="colorPopoverGrid">
        <!-- JavaScriptで生成 -->
      </div>
    </div>
  </div>

  <!-- ノート用の隠しファイル入力 -->
  <input type="file" id="noteImageInput" accept="image/*" style="display: none;" onchange="handleNoteImageUpload(event)">
  <input type="file" id="noteFileInput" style="display: none;" onchange="handleNoteFileUpload(event)">

  <!-- ノート共有モーダル -->
  <div id="shareModalOverlay" class="share-modal-overlay" onclick="closeShareModal()"></div>
  <div id="shareModal" class="share-modal">
    <div class="share-modal-header">
      <span>ノートを共有</span>
      <button class="share-modal-close" onclick="closeShareModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="share-link-section">
      <div class="share-link-title">共有リンク</div>
      <div class="share-link-box">
        <input type="text" class="share-link-input" id="shareLinkInput" readonly>
        <button class="share-link-copy-btn" onclick="copyShareLink()">コピー</button>
      </div>
    </div>
    <div class="share-rooms-title">チャットに送信</div>
    <div class="share-modal-body" id="shareRoomList">
      <!-- ルーム一覧がここに動的に追加される -->
    </div>
  </div>

  <!-- 個人情報設定モーダル -->
  <div class="settings-modal-backdrop" id="personalInfoModal">
    <div class="settings-modal">
      <div class="settings-modal-header">
        <span class="settings-modal-title">
          <i class="bi bi-person-badge"></i> 個人情報設定
        </span>
        <button class="settings-modal-close" onclick="closePersonalInfoModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>
      <div class="settings-modal-body">
        <div class="settings-section">
          <div class="settings-section-title">📦 発送先情報</div>
          <div class="settings-input-group">
            <label class="settings-input-label">郵便番号</label>
            <input type="text" class="settings-input" id="shippingPostalCode" placeholder="000-0000">
          </div>
          <div class="settings-input-group">
            <label class="settings-input-label">住所</label>
            <textarea class="settings-textarea" id="shippingAddress" placeholder="都道府県 市区町村 番地"></textarea>
          </div>
          <div class="settings-input-group">
            <label class="settings-input-label">氏名</label>
            <input type="text" class="settings-input" id="shippingName" placeholder="山田 太郎">
          </div>
          <div class="settings-input-group">
            <label class="settings-input-label">電話番号</label>
            <input type="tel" class="settings-input" id="shippingPhone" placeholder="090-0000-0000">
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">🏦 口座情報</div>
          <div class="settings-input-group">
            <label class="settings-input-label">銀行名</label>
            <input type="text" class="settings-input" id="bankName" placeholder="○○銀行">
          </div>
          <div class="settings-input-group">
            <label class="settings-input-label">支店名</label>
            <input type="text" class="settings-input" id="bankBranch" placeholder="○○支店">
          </div>
          <div class="settings-input-group">
            <label class="settings-input-label">口座種別</label>
            <select class="settings-input" id="bankAccountType">
              <option value="ordinary">普通</option>
              <option value="checking">当座</option>
            </select>
          </div>
          <div class="settings-input-group">
            <label class="settings-input-label">口座番号</label>
            <input type="text" class="settings-input" id="bankAccountNumber" placeholder="0000000">
          </div>
          <div class="settings-input-group">
            <label class="settings-input-label">口座名義（カタカナ）</label>
            <input type="text" class="settings-input" id="bankAccountHolder" placeholder="ヤマダ タロウ">
          </div>
        </div>
      </div>
      <div class="settings-modal-footer">
        <button class="settings-cancel-btn" onclick="closePersonalInfoModal()">キャンセル</button>
        <button class="settings-save-btn" id="personalInfoSaveBtn" onclick="savePersonalInfo()">保存</button>
      </div>
    </div>
  </div>

  <!-- 通知設定モーダル -->
  <div class="settings-modal-backdrop" id="notificationSettingsModal">
    <div class="settings-modal">
      <div class="settings-modal-header">
        <span class="settings-modal-title">
          <i class="bi bi-bell"></i> 通知設定
        </span>
        <button class="settings-modal-close" onclick="closeNotificationSettingsModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>
      <div class="settings-modal-body">
        <div class="settings-toggle-row">
          <span class="settings-toggle-label">プッシュ通知</span>
          <label class="settings-toggle">
            <input type="checkbox" id="pushNotificationToggle">
            <span class="settings-toggle-slider"></span>
          </label>
        </div>
        <div class="settings-toggle-row">
          <span class="settings-toggle-label">通知音</span>
          <label class="settings-toggle">
            <input type="checkbox" id="notificationSoundToggle">
            <span class="settings-toggle-slider"></span>
          </label>
        </div>
      </div>
      <div class="settings-modal-footer">
        <button class="settings-cancel-btn" onclick="closeNotificationSettingsModal()">キャンセル</button>
        <button class="settings-save-btn" id="notificationSaveBtn" onclick="saveNotificationSettings()">保存</button>
      </div>
    </div>
  </div>

  <!-- ユーザー名編集モーダル -->
  <div class="settings-modal-backdrop" id="usernameEditModal">
    <div class="settings-modal" style="max-width: 320px;">
      <div class="settings-modal-header">
        <span class="settings-modal-title">
          <i class="bi bi-pencil"></i> ユーザー名を変更
        </span>
        <button class="settings-modal-close" onclick="closeUsernameEditModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>
      <div class="settings-modal-body">
        <div class="settings-input-group">
          <label class="settings-input-label">新しいユーザー名</label>
          <input type="text" class="settings-input" id="newUsernameInput" placeholder="ユーザー名" maxlength="50">
        </div>
      </div>
      <div class="settings-modal-footer">
        <button class="settings-cancel-btn" onclick="closeUsernameEditModal()">キャンセル</button>
        <button class="settings-save-btn" id="usernameSaveBtn" onclick="saveUsername()">保存</button>
      </div>
    </div>
  </div>

  <!-- プロフィール画像アップロード用hidden input -->
  <input type="file" id="profileImageInput" accept="image/*" style="display: none;" onchange="handleProfileImageSelect(event)">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, getDoc, setDoc, query, where, updateDoc, addDoc, deleteDoc, orderBy, limit, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "furira.jp",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // グラデーションプリセット
    const GRADIENT_PRESETS = [
      { id: 'blue', gradient: 'linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%)' },
      { id: 'purple', gradient: 'linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%)' },
      { id: 'pink', gradient: 'linear-gradient(135deg, #EC4899 0%, #BE185D 100%)' },
      { id: 'orange', gradient: 'linear-gradient(135deg, #F97316 0%, #EA580C 100%)' },
      { id: 'green', gradient: 'linear-gradient(135deg, #22C55E 0%, #15803D 100%)' },
      { id: 'teal', gradient: 'linear-gradient(135deg, #14B8A6 0%, #0F766E 100%)' },
      { id: 'indigo', gradient: 'linear-gradient(135deg, #6366F1 0%, #4338CA 100%)' },
      { id: 'rose', gradient: 'linear-gradient(135deg, #F43F5E 0%, #BE123C 100%)' },
      { id: 'amber', gradient: 'linear-gradient(135deg, #F59E0B 0%, #D97706 100%)' },
      { id: 'cyan', gradient: 'linear-gradient(135deg, #06B6D4 0%, #0891B2 100%)' },
      { id: 'lime', gradient: 'linear-gradient(135deg, #84CC16 0%, #65A30D 100%)' },
      { id: 'slate', gradient: 'linear-gradient(135deg, #64748B 0%, #475569 100%)' },
    ];

    // グローバル変数
    let currentUser = null;
    let compensationRecords = [];
    let compensationSettings = {};
    let userProfileBg = { type: 'gradient', value: 'blue', position: 50 }; // デフォルト（position: 0-100で縦位置）
    let selectedBgType = 'gradient';
    let selectedBgValue = 'blue';
    let selectedBgPosition = 50; // 画像の縦位置（0=上端, 50=中央, 100=下端）
    let pendingBgImageFile = null;
    let userGoal = 0; // 後方互換性のため維持
    let taskGoals = {}; // タスク別目標（件数）: { listing: 50, shipping: 30, ... }
    let rankingParticipation = true; // ランキング参加フラグ
    let allUsersRankingPrefs = {}; // 全ユーザーのランキング参加設定
    let assignedTasks = ['listing', 'shipping', 'photography', 'stocktaking', 'editing']; // ユーザーの担当タスク（デフォルト: 検品作業以外の5つ）

    // ノート関連変数
    let notesList = [];
    let currentNoteId = null;
    let currentNoteData = null;
    let noteSaveTimer = null;
    let sortableInstance = null;

    // キャッシュ関連定数
    const MYPAGE_CACHE_KEY = 'reborn_mypage_cache';
    const MYPAGE_BG_IMAGE_CACHE_KEY = 'reborn_mypage_bg_image';
    const MYPAGE_CACHE_DURATION_MS = 3 * 60 * 1000; // 3分

    // 背景画像をBase64でキャッシュ（Fetch API方式 - CORS問題回避）
    async function cacheBgImageAsBase64(imageUrl) {
      if (!imageUrl) return;

      try {
        // Fetch APIでBlobとして取得
        const response = await fetch(imageUrl, { mode: 'cors' });
        if (!response.ok) {
          console.warn('背景画像取得エラー:', response.status);
          return;
        }
        const blob = await response.blob();

        // BlobをBase64に変換
        const reader = new FileReader();
        reader.onloadend = function() {
          const base64 = reader.result;
          sessionStorage.setItem(MYPAGE_BG_IMAGE_CACHE_KEY, base64);
          console.log('🖼️ [CACHE] 背景画像をBase64でキャッシュ完了 (' + Math.round(base64.length / 1024) + 'KB)');
        };
        reader.onerror = function() {
          console.warn('背景画像Base64変換エラー');
        };
        reader.readAsDataURL(blob);
      } catch (e) {
        console.warn('背景画像キャッシュエラー:', e);
      }
    }

    // キャッシュされた背景画像Base64を取得
    function getCachedBgImage() {
      try {
        return sessionStorage.getItem(MYPAGE_BG_IMAGE_CACHE_KEY);
      } catch (e) {
        return null;
      }
    }

    // キャッシュからデータを復元
    function restoreFromCache() {
      try {
        const cached = sessionStorage.getItem(MYPAGE_CACHE_KEY);
        if (!cached) return null;

        const data = JSON.parse(cached);
        const age = Date.now() - (data.timestamp || 0);

        if (age > MYPAGE_CACHE_DURATION_MS) {
          console.log('📊 [CACHE] マイページキャッシュ期限切れ');
          return null;
        }

        console.log('⚡ [CACHE] マイページキャッシュから復元 (経過: ' + Math.round(age / 1000) + '秒)');
        return data;
      } catch (e) {
        console.warn('キャッシュ読み込みエラー:', e);
        return null;
      }
    }

    // キャッシュにデータを保存
    function saveToCache() {
      try {
        const data = {
          compensationSettings,
          compensationRecords,
          userGoal,
          rankingParticipation,
          allUsersRankingPrefs,
          assignedTasks,
          userProfileBg,
          timestamp: Date.now()
        };
        sessionStorage.setItem(MYPAGE_CACHE_KEY, JSON.stringify(data));
        console.log('💾 [CACHE] マイページデータをキャッシュに保存');
      } catch (e) {
        console.warn('キャッシュ保存エラー:', e);
      }
    }

    // 初期化（キャッシュ優先 + 並列実行）
    async function init() {
      const startTime = performance.now();

      // ユーザー情報取得
      currentUser = {
        email: localStorage.getItem('reborn_user_email') || '',
        name: localStorage.getItem('reborn_user_name') || 'ゲスト',
        permissionId: localStorage.getItem('reborn_user_permission_id') || 'staff',
        permissionDisplay: localStorage.getItem('reborn_user_permission_display') || 'スタッフ',
        photoURL: localStorage.getItem('reborn_user_icon_url') || localStorage.getItem('reborn_user_photo_url') || ''
      };

      if (!currentUser.email) {
        showNotEligible('ログインが必要です', 'ユーザー情報が見つかりません。再度ログインしてください。');
        return;
      }

      // 1. キャッシュを確認（キャッシュがあればローディングなしで即座に表示）
      const cached = restoreFromCache();
      if (cached) {
        // キャッシュからデータを復元
        compensationSettings = cached.compensationSettings || {};
        compensationRecords = cached.compensationRecords || [];
        userGoal = cached.userGoal || 0;
        rankingParticipation = cached.rankingParticipation !== false;
        allUsersRankingPrefs = cached.allUsersRankingPrefs || {};
        assignedTasks = cached.assignedTasks || ['listing', 'shipping', 'photography', 'stocktaking', 'editing'];
        userProfileBg = cached.userProfileBg || { type: 'gradient', value: 'blue', position: 50 };

        // 背景画像がある場合は先行ロード（プリロード）
        if (userProfileBg.type === 'image' && userProfileBg.value) {
          const preloadImg = new Image();
          preloadImg.src = userProfileBg.value;
          console.log('🖼️ [PRELOAD] 背景画像を先行ロード開始');
        }

        // 即座に描画（ローディングなし）
        renderMyPage();
        checkAdminAccess();

        // お知らせはバックグラウンドで読み込み
        initAnnouncements().catch(e => console.warn('お知らせ読み込みエラー:', e));

        console.log('✅ [CACHE] マイページ即時表示完了 (' + (performance.now() - startTime).toFixed(0) + 'ms)');
        return;
      }

      // 2. キャッシュがない場合はFirestoreから取得
      showLoading(true);

      try {
        // まず報酬設定を取得（checkEligibilityに必要）
        await loadCompensationSettings();

        // 報酬対象者かチェック
        const isEligible = await checkEligibility();

        if (!isEligible) {
          showNotEligible('報酬対象外です', 'このアカウントは報酬管理の対象外です。');
          showLoading(false);
          return;
        }

        // 残りのデータを並列で取得（高速化）
        console.log('🚀 [PARALLEL] 並列データ取得開始');
        await Promise.all([
          loadUserGoal(),
          loadAssignedTasks(),
          loadAllUsersRankingPrefs(),
          loadCompensationData(),
          loadUserProfileBg(),
          initAnnouncements()
        ]);
        console.log('✅ [PARALLEL] 並列データ取得完了');

        // 画面を描画
        renderMyPage();

        // 管理者メニュー表示チェック
        checkAdminAccess();

        // キャッシュに保存
        saveToCache();

        // 背景画像がある場合はBase64でキャッシュ（次回用）
        if (userProfileBg.type === 'image' && userProfileBg.value) {
          cacheBgImageAsBase64(userProfileBg.value);
        }

        const duration = (performance.now() - startTime).toFixed(0);
        console.log('✅ [FIRESTORE] マイページ初期化完了 (' + duration + 'ms)');
      } catch (error) {
        console.error('初期化エラー:', error);
        showNotEligible('エラーが発生しました', 'データの読み込み中にエラーが発生しました。');
      }

      showLoading(false);
    }

    // 管理者メールアドレス
    const ADMIN_EMAILS = ['mercari.yasuhirotakuji@gmail.com'];

    // 管理者アクセスチェック
    function checkAdminAccess() {
      if (currentUser && ADMIN_EMAILS.includes(currentUser.email)) {
        const adminLink = document.getElementById('adminAnnounceLink');
        if (adminLink) {
          adminLink.classList.add('visible');
        }
        const adminPlanLink = document.getElementById('adminPlanLink');
        if (adminPlanLink) {
          adminPlanLink.classList.add('visible');
        }
        console.log('管理者メニュー表示:', currentUser.email);
      }
    }

    // 設定ドロップダウン制御
    window.toggleSettingsDropdown = function(event) {
      event.stopPropagation();
      const dropdown = document.getElementById('settingsDropdown');
      dropdown.classList.toggle('active');
    };

    // ドロップダウン外クリックで閉じる
    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown && !dropdown.contains(event.target)) {
        dropdown.classList.remove('active');
      }
    });

    // お知らせ管理を開く（ドロップダウンを閉じてから）
    window.openAdminAnnounce = function() {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) {
        dropdown.classList.remove('active');
      }
      window.open('/admin-announce.html', '_blank');
    };

    // プラン管理を開く
    window.openPlanManagement = function() {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) {
        dropdown.classList.remove('active');
      }
      // iframe内で開く
      window.parent.postMessage({ type: 'navigate', page: 'plans' }, '*');
    };

    // プライバシーポリシーを開く
    window.openPrivacyPolicy = function() {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) {
        dropdown.classList.remove('active');
      }
      // iframe内で開く（戻るボタンでマイページに戻れるように）
      window.parent.postMessage({ type: 'navigate', page: 'privacy-policy' }, '*');
    };

    // 利用規約を開く
    window.openTermsOfService = function() {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) {
        dropdown.classList.remove('active');
      }
      // iframe内で開く（戻るボタンでマイページに戻れるように）
      window.parent.postMessage({ type: 'navigate', page: 'terms-of-service' }, '*');
    };

    // フィードバック送信を開く
    window.openFeedback = function() {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) {
        dropdown.classList.remove('active');
      }
      // iframe内で開く（戻るボタンでマイページに戻れるように）
      window.parent.postMessage({ type: 'navigate', page: 'feedback' }, '*');
    };

    // 報酬設定を取得（Firestoreを優先）
    async function loadCompensationSettings() {
      try {
        // Firestoreから取得（優先）
        const docRef = doc(db, 'settings', 'compensation');
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          compensationSettings = docSnap.data();
          console.log('報酬設定を読み込み（Firestore）:', compensationSettings);
          return;
        }

        // Firestoreにない場合はlocalStorageを確認
        const configStr = localStorage.getItem('config');
        if (configStr) {
          const config = JSON.parse(configStr);
          if (config.報酬設定) {
            compensationSettings = config.報酬設定;
            console.log('報酬設定を読み込み（localStorage）:', compensationSettings);
            return;
          }
        }

        // デフォルト設定
        compensationSettings = {
          taskRates: { listing: 100, shipping: 100, editing: 50 },
          mypage: { enabled: true, allowedUsers: [] }
        };
      } catch (error) {
        console.error('報酬設定取得エラー:', error);
        compensationSettings = {
          taskRates: { listing: 100, shipping: 100, editing: 50 },
          mypage: { enabled: true, allowedUsers: [] }
        };
      }
    }

    // 報酬対象者かチェック
    async function checkEligibility() {
      // マイページ機能が無効の場合
      if (compensationSettings.mypage && compensationSettings.mypage.enabled === false) {
        console.log('マイページ機能が無効です');
        return false;
      }

      // allowedUsersが設定されている場合、リストに含まれているかチェック
      const allowedUsers = compensationSettings.mypage?.allowedUsers || [];

      // allowedUsersが空（未設定）の場合は全員許可
      if (allowedUsers.length === 0) {
        console.log('マイページ: 全員許可（allowedUsers未設定）');
        return true;
      }

      // 現在のユーザーがリストに含まれているかチェック
      const isAllowed = allowedUsers.includes(currentUser.email);
      console.log('マイページ権限チェック:', currentUser.email, 'allowed:', isAllowed);

      return isAllowed;
    }

    // ユーザーの目標を取得
    async function loadUserGoal() {
      try {
        const now = new Date();
        const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const docRef = doc(db, 'userGoals', `${currentUser.email}_${yearMonth}`);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          const data = docSnap.data();
          // 新形式: taskGoals優先、後方互換性のためgoalAmountも維持
          taskGoals = data.taskGoals || {};
          userGoal = data.goalAmount || 0;
          rankingParticipation = data.rankingParticipation !== false; // デフォルトtrue
        } else {
          taskGoals = {};
          userGoal = 0; // 目標未設定
          rankingParticipation = true;
        }
      } catch (error) {
        console.error('目標取得エラー:', error);
        taskGoals = {};
        userGoal = 0;
        rankingParticipation = true;
      }
    }

    // ユーザーの担当タスクを取得
    async function loadAssignedTasks() {
      try {
        const userRef = doc(db, 'users', currentUser.email);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          const data = userSnap.data();
          // 担当タスクが設定されていればそれを使用、未設定ならデフォルト（検品作業以外の5つ）
          assignedTasks = data.assignedTasks || ['listing', 'shipping', 'photography', 'stocktaking', 'editing'];
        } else {
          assignedTasks = ['listing', 'shipping', 'photography', 'stocktaking', 'editing'];
        }
        console.log('担当タスク:', assignedTasks);
      } catch (error) {
        console.error('担当タスク取得エラー:', error);
        assignedTasks = ['listing', 'shipping', 'photography', 'stocktaking', 'editing'];
      }
    }

    // 全ユーザーのランキング参加設定を取得
    async function loadAllUsersRankingPrefs() {
      try {
        const now = new Date();
        const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const goalsRef = collection(db, 'userGoals');
        const snapshot = await getDocs(goalsRef);

        allUsersRankingPrefs = {};
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          if (data.yearMonth === yearMonth) {
            allUsersRankingPrefs[data.email] = data.rankingParticipation !== false;
          }
        });
      } catch (error) {
        console.error('ランキング設定取得エラー:', error);
      }
    }

    // 報酬データを取得
    async function loadCompensationData() {
      try {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;

        const recordsRef = collection(db, 'compensationRecords');
        const snapshot = await getDocs(recordsRef);

        compensationRecords = [];
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          compensationRecords.push({ id: docSnap.id, ...data });
        });

        // 今月のデータのみフィルタ
        compensationRecords = compensationRecords.filter(r => {
          if (!r.completedAt && !r.recordedAt) return false;
          const dateStr = r.completedAt || r.recordedAt;
          const date = typeof dateStr === 'string' ? new Date(dateStr) : (dateStr.toDate ? dateStr.toDate() : new Date(dateStr));
          return date.getFullYear() === year && (date.getMonth() + 1) === month;
        });
      } catch (error) {
        console.error('報酬データ取得エラー:', error);
        compensationRecords = [];
      }
    }

    // 進捗に応じたマイルストーンメッセージを取得
    function getMilestoneMessage(percent) {
      if (percent >= 100) {
        return `<div class="progress-milestone milestone-100">🎉 目標達成おめでとうございます！</div>`;
      } else if (percent >= 80) {
        return `<div class="progress-milestone milestone-80">🔥 あと少し！目標まであと${100 - percent}%です！</div>`;
      } else if (percent >= 50) {
        return `<div class="progress-milestone milestone-50">💪 折り返し地点を通過！この調子で頑張りましょう！</div>`;
      } else if (percent >= 30) {
        return `<div class="progress-milestone">🌱 順調に進んでいます！目標の${percent}%達成中！</div>`;
      }
      return '';
    }

    // タスク定義（表示用）
    const TASK_DEFINITIONS = {
      listing: { icon: '📦', name: '商品出品', cssClass: 'listing' },
      shipping: { icon: '🚚', name: '梱包・発送', cssClass: 'shipping' },
      photography: { icon: '📸', name: '商品撮影', cssClass: 'photography' },
      inspection: { icon: '🔍', name: '検品作業', cssClass: 'inspection' },
      stocktaking: { icon: '📋', name: '棚卸', cssClass: 'stocktaking' },
      editing: { icon: '✏️', name: '追加編集', cssClass: 'editing' }
    };

    // 内訳アイテムを動的に生成
    function generateBreakdownItems(assignedTasks, taskStats) {
      if (!assignedTasks || assignedTasks.length === 0) {
        return `<div style="text-align: center; color: #9ca3af; padding: 16px; font-size: 14px;">
          担当タスクが設定されていません
        </div>`;
      }

      let html = '';
      assignedTasks.forEach(taskId => {
        const taskDef = TASK_DEFINITIONS[taskId];
        if (!taskDef) return;

        // statsがない場合は0件/¥0で表示
        const stats = (taskStats && taskStats[taskId]) ? taskStats[taskId] : { count: 0, amount: 0 };
        
        // 目標値を取得
        const goalCount = taskGoals[taskId] || 0;
        const rate = compensationSettings.taskRates?.[taskId] || 0;
        const goalAmount = goalCount * rate;
        
        // 進捗率を計算（目標がある場合のみ）
        const hasGoal = goalCount > 0;
        const progressPercent = hasGoal ? Math.min(100, Math.round((stats.count / goalCount) * 100)) : 0;

        html += `
          <div class="breakdown-item" style="${hasGoal ? 'flex-direction: column; align-items: stretch;' : ''}">
            <div class="breakdown-label" style="width: 100%;">
              <div class="breakdown-icon ${taskDef.cssClass}">${taskDef.icon}</div>
              <div style="flex: 1; min-width: 0;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div class="breakdown-name">${taskDef.name}</div>
                  <div class="breakdown-amount">¥${stats.amount.toLocaleString()}</div>
                </div>
                <div class="breakdown-count">${stats.count}件${hasGoal ? ` / ${goalCount}件` : ''}</div>
              </div>
            </div>
            ${hasGoal ? `
            <div class="breakdown-progress-wrap" style="margin-left: 46px;">
              <div class="breakdown-progress-bar">
                <div class="breakdown-progress-fill" style="width: ${progressPercent}%"></div>
              </div>
              <div class="breakdown-progress-text">
                <span>${progressPercent}%達成</span>
                <span>目標 ¥${goalAmount.toLocaleString()}</span>
              </div>
            </div>
            ` : ''}
          </div>`;
      });

      return html;
    }

    // 履歴用内訳アイテムを動的に生成
    function generateHistoryBreakdownItems(assignedTasks, taskStats) {
      if (!assignedTasks || assignedTasks.length === 0) {
        return '';
      }

      let html = '';
      assignedTasks.forEach(taskId => {
        const taskDef = TASK_DEFINITIONS[taskId];
        if (!taskDef) return;

        // statsがない場合は0件/¥0で表示
        const stats = (taskStats && taskStats[taskId]) ? taskStats[taskId] : { count: 0, amount: 0 };

        html += `
          <div class="history-breakdown-item">
            <div class="history-breakdown-icon">${taskDef.icon}</div>
            <div class="history-breakdown-label">${taskDef.name}</div>
            <div class="history-breakdown-value">${stats.count}件 / ¥${stats.amount.toLocaleString()}</div>
          </div>`;
      });

      return html;
    }

    // マイページを描画
    // 管理者用マイページを描画
    function renderAdminMyPage() {
      const now = new Date();
      const monthName = `${now.getFullYear()}年${now.getMonth() + 1}月`;

      // 全体の売上を集計
      let totalAmount = 0;
      let totalCount = 0;
      compensationRecords.forEach(r => {
        totalAmount += r.unitPrice || 0;
        totalCount++;
      });

      // スタッフ別集計
      const staffStats = {};
      compensationRecords.forEach(r => {
        const email = r.staffEmail || '';
        if (!email) return;
        
        if (!staffStats[email]) {
          staffStats[email] = {
            email,
            name: r.staffName || '不明',
            photoURL: '',
            totalAmount: 0,
            totalCount: 0,
            goalAmount: 0
          };
        }
        staffStats[email].totalAmount += r.unitPrice || 0;
        staffStats[email].totalCount++;
      });

      // ユーザー情報とゴールを取得
      const staffList = Object.values(staffStats).sort((a, b) => b.totalAmount - a.totalAmount);

      // チーム目標を取得（将来的にFirestoreから読み込み）
      const teamGoal = 500000; // 仮の値、後で設定機能を追加
      const teamProgress = teamGoal > 0 ? Math.min(100, Math.round((totalAmount / teamGoal) * 100)) : 0;

      // 背景スタイル
      const bgStyle = getProfileBgStyle();

      // アバター
      const avatarHtml = currentUser.photoURL
        ? `<img src="${currentUser.photoURL}" alt="アバター">`
        : '👤';

      const html = `
        <!-- プロフィールカード -->
        <div class="profile-card" id="profileCard" style="${bgStyle}">
          <button class="profile-bg-edit-btn" onclick="openBgModal()" title="背景を変更">
            <i class="bi bi-pencil"></i>
          </button>
          <div class="profile-avatar" onclick="clickProfileImage()" title="アイコンを変更" style="cursor: pointer;">
            ${avatarHtml}
            <div class="profile-avatar-edit-overlay"><i class="bi bi-camera"></i></div>
          </div>
          <div class="profile-name" onclick="openUsernameEditModal()" title="ユーザー名を変更" style="cursor: pointer;">${escapeHtml(currentUser.name)}<i class="bi bi-pencil edit-icon"></i></div>
          <div class="profile-role">${escapeHtml(stripEmoji(currentUser.permissionDisplay))}</div>
        </div>

        <!-- チーム目標 -->
        <div class="team-goal-section">
          <div class="team-goal-label">🎯 ${monthName} チーム目標</div>
          <div class="team-goal-amount">¥${teamGoal.toLocaleString()}</div>
          <div class="team-goal-progress">
            <div class="team-goal-bar">
              <div class="team-goal-fill" style="width: ${teamProgress}%"></div>
            </div>
            <div class="team-goal-text">
              <span>達成 ¥${totalAmount.toLocaleString()}</span>
              <span>${teamProgress}%</span>
            </div>
          </div>
        </div>

        <!-- 全体売上サマリー -->
        <div class="admin-section">
          <div class="admin-section-title">📊 ${monthName}の全体サマリー</div>
          <div class="admin-summary-grid">
            <div class="admin-summary-card highlight">
              <div class="admin-summary-label">総売上</div>
              <div class="admin-summary-value">¥${totalAmount.toLocaleString()}</div>
            </div>
            <div class="admin-summary-card">
              <div class="admin-summary-label">総作業件数</div>
              <div class="admin-summary-value">${totalCount}件</div>
            </div>
            <div class="admin-summary-card">
              <div class="admin-summary-label">アクティブスタッフ</div>
              <div class="admin-summary-value">${staffList.length}人</div>
            </div>
            <div class="admin-summary-card">
              <div class="admin-summary-label">平均単価</div>
              <div class="admin-summary-value">¥${totalCount > 0 ? Math.round(totalAmount / totalCount).toLocaleString() : 0}</div>
            </div>
          </div>
        </div>

        <!-- スタッフ別パフォーマンス -->
        <div class="admin-section">
          <div class="admin-section-title">👥 スタッフ別パフォーマンス</div>
          <div class="staff-performance-list">
            ${staffList.map((staff, index) => `
              <div class="staff-performance-item">
                <div class="staff-performance-avatar">
                  ${staff.photoURL ? `<img src="${staff.photoURL}" alt="">` : '👤'}
                </div>
                <div class="staff-performance-info">
                  <div class="staff-performance-name">${escapeHtml(staff.name)}</div>
                  <div class="staff-performance-stats">${staff.totalCount}件完了</div>
                </div>
                <div class="staff-performance-amount">¥${staff.totalAmount.toLocaleString()}</div>
              </div>
            `).join('')}
            ${staffList.length === 0 ? '<div style="text-align: center; color: #9ca3af; padding: 20px;">データがありません</div>' : ''}
          </div>
        </div>

        <!-- ランキング -->
        <div class="ranking-card">
          <div class="ranking-title">🏆 今月のランキング</div>
          ${renderRankingList(calculateRanking(), currentUser.email)}
        </div>

        <!-- システム状態ダッシュボード（実装予定） -->
        <div class="admin-section">
          <div class="admin-section-title">🖥️ システム状態</div>
          <div class="system-status-grid">
            <div class="system-status-item">
              <div class="system-status-icon">👥</div>
              <div class="system-status-label">アクティブユーザー</div>
              <div class="system-status-value">-</div>
            </div>
            <div class="system-status-item">
              <div class="system-status-icon">💾</div>
              <div class="system-status-label">Firestore使用量</div>
              <div class="system-status-value">-</div>
            </div>
            <div class="system-status-item">
              <div class="system-status-icon">📦</div>
              <div class="system-status-label">ストレージ残量</div>
              <div class="system-status-value">-</div>
            </div>
            <div class="system-status-item">
              <div class="system-status-icon">⚠️</div>
              <div class="system-status-label">エラー発生</div>
              <div class="system-status-value">-</div>
            </div>
          </div>
          <div class="system-status-note">
            ※ 詳細機能は今後実装予定
          </div>
        </div>

        <!-- アクションボタン -->
        <div class="action-buttons">
          <div class="action-btn" onclick="openTeamGoalModal()">
            <i class="bi bi-bullseye"></i>
            <span>チーム目標設定</span>
          </div>
          <div class="action-btn" onclick="openHistoryModal()">
            <i class="bi bi-clock-history"></i>
            <span>履歴</span>
          </div>
          <div class="action-btn" onclick="openCompensationHistoryModal()">
            <i class="bi bi-file-earmark-text"></i>
            <span>報酬履歴</span>
          </div>
        </div>
      `;

      document.getElementById('mainContent').innerHTML = html;
    }

    // チーム目標設定モーダル（プレースホルダー）
    window.openTeamGoalModal = function() {
      alert('チーム目標設定機能は今後実装予定です');
    };

    // スタッフ/外注向けマイページを描画
    function renderMyPage() {
      // 管理者の場合は管理者用マイページを表示
      if (currentUser.permissionId === 'owner') {
        renderAdminMyPage();
        return;
      }

      const now = new Date();
      const monthName = `${now.getFullYear()}年${now.getMonth() + 1}月`;

      // 自分のデータを集計
      const myRecords = compensationRecords.filter(r => r.staffEmail === currentUser.email);
      const myStats = calculateStats(myRecords);

      // ランキングデータを生成
      const rankingData = calculateRanking();
      const myRank = rankingData.findIndex(r => r.email === currentUser.email) + 1;

      // 進捗率を計算
      const progressPercent = userGoal > 0 ? Math.min(100, Math.round((myStats.totalAmount / userGoal) * 100)) : 0;

      // アバター（クリック可能）
      const avatarHtml = currentUser.photoURL
        ? `<img src="${currentUser.photoURL}" alt="アバター">`
        : '👤';

      // 背景スタイル
      const bgStyle = getProfileBgStyle();

      const html = `
        <!-- プロフィールカード -->
        <div class="profile-card" id="profileCard" style="${bgStyle}">
          <button class="profile-bg-edit-btn" onclick="openBgModal()" title="背景を変更">
            <i class="bi bi-pencil"></i>
          </button>
          <div class="profile-avatar" onclick="clickProfileImage()" title="アイコンを変更" style="cursor: pointer;">
            ${avatarHtml}
            <div class="profile-avatar-edit-overlay"><i class="bi bi-camera"></i></div>
          </div>
          <div class="profile-name" onclick="openUsernameEditModal()" title="ユーザー名を変更" style="cursor: pointer;">${escapeHtml(currentUser.name)}<i class="bi bi-pencil edit-icon"></i></div>
          <div class="profile-role">${escapeHtml(stripEmoji(currentUser.permissionDisplay))}</div>
        </div>

        <!-- 報酬サマリー -->
        <div class="compensation-card">
          <div class="compensation-header">
            <div class="compensation-title">今月の報酬</div>
          </div>
          <div class="compensation-amount">¥${myStats.totalAmount.toLocaleString()}</div>
          <div class="compensation-goal">
            目標: <span class="goal-amount">${userGoal > 0 ? '¥' + userGoal.toLocaleString() : '未設定'}</span>
          </div>
          ${userGoal > 0 ? `
          <div class="progress-container">
            <div class="progress-bar-bg">
              <div class="progress-bar-fill" style="width: ${progressPercent}%"></div>
            </div>
            <div class="progress-text">
              <span>達成率</span>
              <span class="progress-percent">${progressPercent}%</span>
            </div>
            ${getMilestoneMessage(progressPercent)}
          </div>` : ''}
        </div>

        <!-- 内訳（担当タスクのみ表示） -->
        <div class="breakdown-card">
          <div class="breakdown-title">内訳</div>
          ${generateBreakdownItems(assignedTasks, myStats.taskStats)}

          <!-- 報酬単価アコーディオン -->
          <button class="rate-accordion-btn" onclick="toggleRateAccordion(this)">
            <span>報酬単価を確認</span>
            <i class="bi bi-chevron-down"></i>
          </button>
          <div class="rate-accordion-content">
            <div class="rate-items">
              ${compensationSettings.taskRates?.listing ? `
              <div class="rate-item">
                <span class="rate-item-name">商品出品</span>
                <span class="rate-item-value">¥${compensationSettings.taskRates.listing.toLocaleString()}/件</span>
              </div>` : ''}
              ${compensationSettings.taskRates?.shipping ? `
              <div class="rate-item">
                <span class="rate-item-name">梱包・発送</span>
                <span class="rate-item-value">¥${compensationSettings.taskRates.shipping.toLocaleString()}/件</span>
              </div>` : ''}
              ${compensationSettings.taskRates?.photography ? `
              <div class="rate-item">
                <span class="rate-item-name">商品撮影</span>
                <span class="rate-item-value">¥${compensationSettings.taskRates.photography.toLocaleString()}/件</span>
              </div>` : ''}
              ${compensationSettings.taskRates?.inspection ? `
              <div class="rate-item">
                <span class="rate-item-name">検品作業</span>
                <span class="rate-item-value">¥${compensationSettings.taskRates.inspection.toLocaleString()}/件</span>
              </div>` : ''}
              ${compensationSettings.taskRates?.stocktaking ? `
              <div class="rate-item">
                <span class="rate-item-name">棚卸</span>
                <span class="rate-item-value">¥${compensationSettings.taskRates.stocktaking.toLocaleString()}/件</span>
              </div>` : ''}
              ${compensationSettings.taskRates?.editing ? `
              <div class="rate-item">
                <span class="rate-item-name">追加編集</span>
                <span class="rate-item-value">¥${compensationSettings.taskRates.editing.toLocaleString()}/件</span>
              </div>` : ''}
              ${(compensationSettings.customTasks || []).map(task => `
              <div class="rate-item">
                <span class="rate-item-name">${task.name}</span>
                <span class="rate-item-value">¥${(task.rate || 0).toLocaleString()}/件</span>
              </div>`).join('')}
            </div>
          </div>
        </div>

        <!-- ランキング -->
        <div class="ranking-card">
          <div class="ranking-title">今月のランキング</div>
          ${renderRankingList(rankingData, currentUser.email)}
        </div>

        <!-- アクションボタン -->
        <div class="action-buttons">
          <div class="action-btn" onclick="openGoalModal()">
            <i class="bi bi-bullseye"></i>
            <span>目標設定</span>
          </div>
          <div class="action-btn" onclick="openHistoryModal()">
            <i class="bi bi-clock-history"></i>
            <span>履歴</span>
          </div>
          <div class="action-btn" onclick="openCompensationHistoryModal()">
            <i class="bi bi-file-earmark-text"></i>
            <span>報酬履歴</span>
          </div>
        </div>
      `;

      document.getElementById('mainContent').innerHTML = html;
    }

    // 統計を計算（全6タスク対応）
    function calculateStats(records) {
      // タスク別集計オブジェクト
      const taskStats = {
        listing: { count: 0, amount: 0 },
        shipping: { count: 0, amount: 0 },
        photography: { count: 0, amount: 0 },
        inspection: { count: 0, amount: 0 },
        stocktaking: { count: 0, amount: 0 },
        editing: { count: 0, amount: 0 }
      };

      let totalAmount = 0;
      let totalCount = 0;

      records.forEach(r => {
        const taskType = r.taskTypeKey || r.taskType || '';
        const amount = r.unitPrice || 0;

        // タスクタイプのマッピング
        let normalizedType = null;
        if (taskType === 'listing' || taskType === 'listing_approval') {
          normalizedType = 'listing';
        } else if (taskType === 'shipping' || taskType === 'shipping_task') {
          normalizedType = 'shipping';
        } else if (taskType === 'photography' || taskType === 'photography_task') {
          normalizedType = 'photography';
        } else if (taskType === 'inspection' || taskType === 'inspection_task') {
          normalizedType = 'inspection';
        } else if (taskType === 'stocktaking' || taskType === 'stocktaking_task') {
          normalizedType = 'stocktaking';
        } else if (taskType === 'editing' || taskType === 'editing_task') {
          normalizedType = 'editing';
        }

        if (normalizedType && taskStats[normalizedType]) {
          taskStats[normalizedType].count++;
          taskStats[normalizedType].amount += amount;
          totalAmount += amount;
          totalCount++;
        }
      });

      return {
        // 後方互換性のため個別プロパティも維持
        listingCount: taskStats.listing.count,
        listingAmount: taskStats.listing.amount,
        shippingCount: taskStats.shipping.count,
        shippingAmount: taskStats.shipping.amount,
        // 新しい構造
        taskStats,
        totalAmount,
        totalCount
      };
    }

    // ランキングを計算
    function calculateRanking() {
      const staffStats = {};

      compensationRecords.forEach(r => {
        const email = r.staffEmail || '';
        const name = r.staffName || '不明';
        const amount = r.unitPrice || 0;

        if (!email) return;

        // ランキング不参加のユーザーはスキップ（自分以外）
        // 自分は参加・不参加に関わらず自分の位置を確認できる
        if (email !== currentUser.email && allUsersRankingPrefs[email] === false) {
          return;
        }

        if (!staffStats[email]) {
          staffStats[email] = { email, name, totalAmount: 0 };
        }
        staffStats[email].totalAmount += amount;
      });

      // 金額でソート
      const ranking = Object.values(staffStats).sort((a, b) => b.totalAmount - a.totalAmount);

      return ranking;
    }

    // ランキングリストを描画
    function renderRankingList(rankingData, myEmail) {
      // ランキング不参加の場合はメッセージを表示
      if (!rankingParticipation) {
        return `
          <div class="ranking-opt-out-message">
            <i class="bi bi-eye-slash"></i>
            <span>ランキング非公開中</span>
          </div>
          <div class="text-center text-muted" style="font-size: 12px;">
            目標設定から「ランキングに参加する」をオンにすると表示されます
          </div>
        `;
      }

      if (rankingData.length === 0) {
        return '<div class="text-center text-muted py-3">まだデータがありません</div>';
      }

      // 上位3名 + 自分の位置を表示
      const myRankIndex = rankingData.findIndex(r => r.email === myEmail);
      const displayItems = [];

      // 上位3名
      for (let i = 0; i < Math.min(3, rankingData.length); i++) {
        displayItems.push({ ...rankingData[i], rank: i + 1 });
      }

      // 自分が4位以下なら追加
      if (myRankIndex >= 3) {
        // 区切り線の代わりに...を追加
        displayItems.push({ separator: true });
        displayItems.push({ ...rankingData[myRankIndex], rank: myRankIndex + 1 });
      }

      return displayItems.map(item => {
        if (item.separator) {
          return '<div class="text-center text-muted py-1">⋮</div>';
        }

        const isMe = item.email === myEmail;
        const positionClass = item.rank === 1 ? 'gold' : item.rank === 2 ? 'silver' : item.rank === 3 ? 'bronze' : 'normal';
        const highlightClass = isMe ? 'highlight' : '';
        const nameClass = isMe ? 'me' : '';
        const displayName = isMe ? `★ ${item.name}` : item.name;

        return `
          <div class="ranking-item ${highlightClass}">
            <div class="ranking-position ${positionClass}">${item.rank}</div>
            <div class="ranking-name ${nameClass}">${escapeHtml(displayName)}</div>
            <div class="ranking-amount">¥${item.totalAmount.toLocaleString()}</div>
          </div>
        `;
      }).join('');
    }

    // 非対象者メッセージを表示
    function showNotEligible(title, message) {
      document.getElementById('mainContent').innerHTML = `
        <div class="not-eligible">
          <i class="bi bi-person-x"></i>
          <h3>${escapeHtml(title)}</h3>
          <p>${escapeHtml(message)}</p>
        </div>
      `;
    }

    // 目標設定モーダルを開く
    // 目標設定モーダルを開く
    window.openGoalModal = function() {
      // タスク別目標入力フォームを生成
      const taskGoalList = document.getElementById('taskGoalList');
      let html = '';

      assignedTasks.forEach(taskId => {
        const taskDef = TASK_DEFINITIONS[taskId];
        if (!taskDef) return;

        const rate = compensationSettings.taskRates?.[taskId] || 0;
        const currentGoal = taskGoals[taskId] || 0;

        html += `
          <div class="task-goal-item">
            <div class="task-goal-icon ${taskDef.cssClass}">${taskDef.icon}</div>
            <div class="task-goal-info">
              <div class="task-goal-name">${taskDef.name}</div>
              <div class="task-goal-rate">¥${rate.toLocaleString()}/件</div>
            </div>
            <div class="task-goal-input-wrap">
              <input type="number" class="task-goal-input" id="taskGoal_${taskId}" 
                     value="${currentGoal}" min="0" placeholder="0"
                     onchange="updateGoalTotal()" oninput="updateGoalTotal()">
              <span class="task-goal-unit">件</span>
            </div>
            <div class="task-goal-amount" id="taskGoalAmount_${taskId}">¥${(currentGoal * rate).toLocaleString()}</div>
          </div>
        `;
      });

      taskGoalList.innerHTML = html;
      document.getElementById('rankingParticipation').checked = rankingParticipation;
      updateGoalTotal();
      document.getElementById('goalModal').style.display = 'flex';
    };

    // 目標合計金額を更新
    window.updateGoalTotal = function() {
      let total = 0;

      assignedTasks.forEach(taskId => {
        const input = document.getElementById(`taskGoal_${taskId}`);
        if (!input) return;

        const count = parseInt(input.value) || 0;
        const rate = compensationSettings.taskRates?.[taskId] || 0;
        const amount = count * rate;

        // 個別タスクの金額表示を更新
        const amountEl = document.getElementById(`taskGoalAmount_${taskId}`);
        if (amountEl) {
          amountEl.textContent = `¥${amount.toLocaleString()}`;
        }

        total += amount;
      });

      document.getElementById('goalTotalAmount').textContent = `¥${total.toLocaleString()}`;
    };

    // 目標設定モーダルを閉じる
    window.closeGoalModal = function() {
      document.getElementById('goalModal').style.display = 'none';
    };

    // 目標をスキップ（設定しない）
    window.skipGoal = async function() {
      try {
        showLoading(true);

        const now = new Date();
        const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const docRef = doc(db, 'userGoals', `${currentUser.email}_${yearMonth}`);

        const newRankingPref = document.getElementById('rankingParticipation').checked;
        await setDoc(docRef, {
          email: currentUser.email,
          name: currentUser.name,
          yearMonth: yearMonth,
          taskGoals: {},
          goalAmount: 0,
          skipped: true,
          rankingParticipation: newRankingPref,
          updatedAt: new Date().toISOString()
        });

        taskGoals = {};
        userGoal = 0;
        rankingParticipation = newRankingPref;
        allUsersRankingPrefs[currentUser.email] = newRankingPref;
        closeGoalModal();
        renderMyPage();

        showLoading(false);
      } catch (error) {
        console.error('目標スキップエラー:', error);
        alert('保存に失敗しました。');
        showLoading(false);
      }
    };

    // 目標を保存
    window.saveGoal = async function() {
      try {
        showLoading(true);

        // タスク別目標を収集
        const newTaskGoals = {};
        let totalAmount = 0;

        assignedTasks.forEach(taskId => {
          const input = document.getElementById(`taskGoal_${taskId}`);
          if (!input) return;

          const count = parseInt(input.value) || 0;
          if (count > 0) {
            newTaskGoals[taskId] = count;
            const rate = compensationSettings.taskRates?.[taskId] || 0;
            totalAmount += count * rate;
          }
        });

        const now = new Date();
        const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const docRef = doc(db, 'userGoals', `${currentUser.email}_${yearMonth}`);

        const newRankingPref = document.getElementById('rankingParticipation').checked;
        await setDoc(docRef, {
          email: currentUser.email,
          name: currentUser.name,
          yearMonth: yearMonth,
          taskGoals: newTaskGoals,
          goalAmount: totalAmount, // 後方互換性のため合計金額も保存
          rankingParticipation: newRankingPref,
          updatedAt: new Date().toISOString()
        });

        taskGoals = newTaskGoals;
        userGoal = totalAmount;
        rankingParticipation = newRankingPref;
        allUsersRankingPrefs[currentUser.email] = newRankingPref;
        closeGoalModal();
        renderMyPage();

        showLoading(false);
      } catch (error) {
        console.error('目標保存エラー:', error);
        alert('保存に失敗しました。');
        showLoading(false);
      }
    };

    // 履歴モーダルを開く
    window.openHistoryModal = async function() {
      document.getElementById('historyModal').style.display = 'flex';
      document.getElementById('historyList').innerHTML = '<div class="history-empty"><div class="spinner-border text-primary" role="status"></div><p style="margin-top: 12px;">読み込み中...</p></div>';
      
      try {
        const historyData = await loadGoalHistory();
        renderHistoryList(historyData);
      } catch (error) {
        console.error('履歴読み込みエラー:', error);
        document.getElementById('historyList').innerHTML = '<div class="history-empty"><i class="bi bi-exclamation-circle"></i><p>履歴の読み込みに失敗しました</p></div>';
      }
    };

    // 履歴モーダルを閉じる
    window.closeHistoryModal = function() {
      document.getElementById('historyModal').style.display = 'none';
    };

    // ========================================
    // 報酬履歴機能
    // ========================================

    let compHistoryData = []; // 月別報酬データ
    let currentCompMonth = null; // 現在表示中の月

    // 報酬履歴モーダルを開く
    window.openCompensationHistoryModal = async function() {
      const backdrop = document.getElementById('compHistoryModal');
      const listEl = document.getElementById('compHistoryList');

      backdrop.classList.add('active');
      listEl.innerHTML = '<div class="comp-history-empty"><div class="spinner-border text-primary" role="status"></div><p style="margin-top: 12px;">読み込み中...</p></div>';

      try {
        compHistoryData = await loadCompensationHistory();
        renderCompensationHistoryList();
      } catch (error) {
        console.error('報酬履歴読み込みエラー:', error);
        listEl.innerHTML = '<div class="comp-history-empty"><i class="bi bi-exclamation-circle"></i><p>履歴の読み込みに失敗しました</p></div>';
      }
    };

    // 報酬履歴モーダルを閉じる
    window.closeCompensationHistoryModal = function() {
      document.getElementById('compHistoryModal').classList.remove('active');
    };

    // 報酬履歴を読み込む（過去12ヶ月）
    async function loadCompensationHistory() {
      const history = [];
      const now = new Date();

      // 報酬レコードを全件取得
      const recordsRef = collection(db, 'compensationRecords');
      const snapshot = await getDocs(recordsRef);

      const allRecords = [];
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.staffEmail === currentUser.email) {
          allRecords.push({ id: docSnap.id, ...data });
        }
      });

      // 過去12ヶ月分を集計（当月含む）
      for (let i = 0; i < 12; i++) {
        const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const year = targetDate.getFullYear();
        const month = targetDate.getMonth() + 1;

        // その月のレコードをフィルタ
        const monthRecords = allRecords.filter(r => {
          const dateStr = r.completedAt || r.recordedAt;
          if (!dateStr) return false;
          const date = typeof dateStr === 'string' ? new Date(dateStr) : (dateStr.toDate ? dateStr.toDate() : new Date(dateStr));
          return date.getFullYear() === year && (date.getMonth() + 1) === month;
        });

        if (monthRecords.length > 0) {
          const totalAmount = monthRecords.reduce((sum, r) => sum + (r.unitPrice || 0), 0);
          history.push({
            year,
            month,
            yearMonth: `${year}-${String(month).padStart(2, '0')}`,
            displayMonth: `${year}年${month}月`,
            count: monthRecords.length,
            totalAmount,
            records: monthRecords
          });
        }
      }

      return history;
    }

    // 報酬履歴リストを描画
    function renderCompensationHistoryList() {
      const listEl = document.getElementById('compHistoryList');

      if (compHistoryData.length === 0) {
        listEl.innerHTML = '<div class="comp-history-empty"><i class="bi bi-file-earmark-text"></i><p>報酬履歴がありません</p></div>';
        return;
      }

      listEl.innerHTML = compHistoryData.map(item => `
        <div class="comp-history-item" onclick="openCompensationDetail('${item.yearMonth}')">
          <div class="comp-history-item-left">
            <div class="comp-history-item-month">${item.displayMonth}</div>
            <div class="comp-history-item-count">${item.count}件のタスク</div>
          </div>
          <div class="comp-history-item-right">
            <div class="comp-history-item-amount">¥${item.totalAmount.toLocaleString()}</div>
            <i class="bi bi-chevron-right comp-history-item-arrow"></i>
          </div>
        </div>
      `).join('');
    }

    // 報酬明細を開く
    window.openCompensationDetail = function(yearMonth) {
      currentCompMonth = compHistoryData.find(h => h.yearMonth === yearMonth);
      if (!currentCompMonth) return;

      document.getElementById('compDetailTitle').textContent = `${currentCompMonth.displayMonth} 報酬明細`;
      document.getElementById('compDetailModal').classList.add('active');

      renderCompensationDetail();
    };

    // 報酬明細モーダルを閉じる
    window.closeCompensationDetailModal = function() {
      document.getElementById('compDetailModal').classList.remove('active');
    };

    // 報酬明細を描画
    function renderCompensationDetail() {
      if (!currentCompMonth) return;

      const records = currentCompMonth.records;
      const stats = calculateStats(records);

      // タスクタイプ定義
      const taskDefs = {
        listing: { name: '商品出品', icon: '📦' },
        shipping: { name: '梱包・発送', icon: '🚚' },
        photography: { name: '商品撮影', icon: '📷' },
        inspection: { name: '検品作業', icon: '🔍' },
        stocktaking: { name: '棚卸', icon: '📋' },
        editing: { name: '追加編集', icon: '✏️' }
      };

      // 内訳HTML
      let breakdownHtml = '';
      Object.entries(stats.taskStats).forEach(([key, val]) => {
        if (val.count > 0) {
          const def = taskDefs[key] || { name: key, icon: '📌' };
          breakdownHtml += `
            <div class="comp-detail-breakdown-item">
              <div class="comp-detail-breakdown-left">
                <div class="comp-detail-breakdown-icon ${key}">${def.icon}</div>
                <div class="comp-detail-breakdown-name">${def.name}</div>
              </div>
              <div class="comp-detail-breakdown-right">
                <div class="comp-detail-breakdown-amount">¥${val.amount.toLocaleString()}</div>
                <div class="comp-detail-breakdown-count">${val.count}件 × ¥${Math.round(val.amount / val.count).toLocaleString()}</div>
              </div>
            </div>
          `;
        }
      });

      // レコード一覧HTML（日付順）
      const sortedRecords = [...records].sort((a, b) => {
        const dateA = new Date(a.completedAt || a.recordedAt || 0);
        const dateB = new Date(b.completedAt || b.recordedAt || 0);
        return dateB - dateA;
      });

      const recordsHtml = sortedRecords.map(r => {
        const dateStr = r.completedAt || r.recordedAt;
        const date = dateStr ? new Date(dateStr) : null;
        const displayDate = date ? `${date.getMonth() + 1}/${date.getDate()}` : '-';
        const desc = r.description || r.managementNumber || 'タスク';

        return `
          <div class="comp-detail-record-item">
            <div class="comp-detail-record-left">
              <div class="comp-detail-record-desc">${escapeHtml(desc)}</div>
              <div class="comp-detail-record-date">${displayDate}</div>
            </div>
            <div class="comp-detail-record-amount">¥${(r.unitPrice || 0).toLocaleString()}</div>
          </div>
        `;
      }).join('');

      // 締め日・支払日を取得
      const cutoffDay = compensationSettings.options?.cutoffDay || '末日';
      const paymentDay = compensationSettings.options?.paymentDay || '翌月5日';

      document.getElementById('compDetailBody').innerHTML = `
        <div class="comp-detail-summary">
          <div class="comp-detail-total-label">合計報酬</div>
          <div class="comp-detail-total-amount">¥${currentCompMonth.totalAmount.toLocaleString()}</div>
          <div class="comp-detail-period">締め日: ${cutoffDay} / 支払日: ${paymentDay}</div>
        </div>

        <div class="comp-detail-breakdown">
          <div class="comp-detail-breakdown-title">内訳</div>
          ${breakdownHtml || '<div style="color: #9ca3af; font-size: 13px;">内訳データがありません</div>'}
        </div>

        <div class="comp-detail-records">
          <div class="comp-detail-records-title">明細一覧（${records.length}件）</div>
          ${recordsHtml || '<div style="color: #9ca3af; font-size: 13px;">明細データがありません</div>'}
        </div>
      `;
    }

    // PDF生成・ダウンロード
    window.downloadCompensationPDF = async function() {
      if (!currentCompMonth) return;

      try {
        // jsPDFを動的にロード
        if (!window.jspdf) {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
          document.head.appendChild(script);
          await new Promise(resolve => script.onload = resolve);
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // 日本語フォントが必要な場合はフォールバック
        // PDFのフォーマット設定
        const userName = currentUser.name || currentUser.email.split('@')[0];
        const monthStr = currentCompMonth.displayMonth;
        const totalAmount = currentCompMonth.totalAmount;
        const records = currentCompMonth.records;
        const stats = calculateStats(records);

        // タイトル
        doc.setFontSize(18);
        doc.text('Compensation Statement', 105, 20, { align: 'center' });
        doc.text('報酬明細書', 105, 30, { align: 'center' });

        // 基本情報
        doc.setFontSize(12);
        doc.text(`Period: ${monthStr}`, 20, 50);
        doc.text(`Name: ${userName}`, 20, 60);
        doc.text(`Total: ${totalAmount.toLocaleString()} JPY`, 20, 70);

        // 内訳テーブル
        let y = 90;
        doc.setFontSize(14);
        doc.text('Breakdown:', 20, y);
        y += 10;

        doc.setFontSize(10);
        const taskNames = {
          listing: 'Product Listing',
          shipping: 'Packing/Shipping',
          photography: 'Photography',
          inspection: 'Inspection',
          stocktaking: 'Stocktaking',
          editing: 'Editing'
        };

        Object.entries(stats.taskStats).forEach(([key, val]) => {
          if (val.count > 0) {
            const name = taskNames[key] || key;
            doc.text(`${name}: ${val.count} x ${Math.round(val.amount / val.count)} = ${val.amount.toLocaleString()} JPY`, 25, y);
            y += 8;
          }
        });

        // フッター
        y += 20;
        doc.setFontSize(8);
        doc.text(`Generated: ${new Date().toLocaleDateString('ja-JP')}`, 20, y);
        doc.text('Furira / REBORN Inventory System', 20, y + 5);

        // ダウンロード
        doc.save(`compensation_${currentCompMonth.yearMonth}_${userName}.pdf`);

      } catch (error) {
        console.error('PDF生成エラー:', error);
        alert('PDFの生成に失敗しました');
      }
    };

    // 過去の目標履歴を読み込む（過去12ヶ月）
    async function loadGoalHistory() {
      const history = [];
      const now = new Date();
      
      // 過去12ヶ月分を取得（当月は除く）
      for (let i = 1; i <= 12; i++) {
        const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const year = targetDate.getFullYear();
        const month = targetDate.getMonth() + 1;
        const yearMonth = `${year}-${String(month).padStart(2, '0')}`;
        
        // 目標データを取得
        const goalDocRef = doc(db, 'userGoals', `${currentUser.email}_${yearMonth}`);
        const goalSnap = await getDoc(goalDocRef);
        
        // 報酬データを取得
        const recordsRef = collection(db, 'compensationRecords');
        const recordsSnap = await getDocs(recordsRef);
        
        let monthRecords = [];
        recordsSnap.forEach(docSnap => {
          const data = docSnap.data();
          if (data.staffEmail !== currentUser.email) return;
          
          const dateStr = data.completedAt || data.recordedAt;
          if (!dateStr) return;
          
          const date = typeof dateStr === 'string' ? new Date(dateStr) : (dateStr.toDate ? dateStr.toDate() : new Date(dateStr));
          if (date.getFullYear() === year && (date.getMonth() + 1) === month) {
            monthRecords.push(data);
          }
        });
        
        // そのユーザーのデータが存在する月のみ追加
        if (goalSnap.exists() || monthRecords.length > 0) {
          const goalAmount = goalSnap.exists() ? (goalSnap.data().goalAmount || 0) : 10000;
          const stats = calculateStats(monthRecords);
          
          // ランキングを計算（全員分）
          const allUsersMap = new Map();
          recordsSnap.forEach(docSnap => {
            const data = docSnap.data();
            const dateStr = data.completedAt || data.recordedAt;
            if (!dateStr) return;
            
            const date = typeof dateStr === 'string' ? new Date(dateStr) : (dateStr.toDate ? dateStr.toDate() : new Date(dateStr));
            if (date.getFullYear() === year && (date.getMonth() + 1) === month) {
              const email = data.staffEmail || 'unknown';
              if (!allUsersMap.has(email)) {
                allUsersMap.set(email, { totalAmount: 0 });
              }
              allUsersMap.get(email).totalAmount += (data.unitPrice || 0);
            }
          });
          
          // ランキングを生成
          const ranking = Array.from(allUsersMap.entries())
            .map(([email, data]) => ({ email, ...data }))
            .sort((a, b) => b.totalAmount - a.totalAmount);
          
          const myRank = ranking.findIndex(r => r.email === currentUser.email) + 1;
          
          history.push({
            yearMonth,
            year,
            month,
            goalAmount,
            actualAmount: stats.totalAmount,
            listingCount: stats.listingCount,
            listingAmount: stats.listingAmount,
            shippingCount: stats.shippingCount,
            shippingAmount: stats.shippingAmount,
            taskStats: stats.taskStats,  // 全タスク統計を追加
            rank: myRank || '-',
            totalParticipants: ranking.length
          });
        }
      }
      
      return history;
    }

    // 履歴リストを描画
    function renderHistoryList(historyData) {
      if (historyData.length === 0) {
        document.getElementById('historyList').innerHTML = '<div class="history-empty"><i class="bi bi-calendar-x"></i><p>過去の履歴がありません</p></div>';
        return;
      }
      
      const html = historyData.map(item => {
        const percent = item.goalAmount > 0 ? Math.min(100, Math.round((item.actualAmount / item.goalAmount) * 100)) : 0;
        const achieved = percent >= 100;
        const achievedClass = achieved ? 'achieved' : (percent > 0 ? 'not-achieved' : '');
        
        return `
          <div class="history-item ${achievedClass}">
            <div class="history-month">${item.year}年${item.month}月</div>
            <div class="history-amounts">
              <div class="history-goal">目標: <span>¥${item.goalAmount.toLocaleString()}</span></div>
              <div class="history-actual">実績: <span>¥${item.actualAmount.toLocaleString()}</span></div>
            </div>
            <div class="history-progress">
              <div class="history-progress-bar">
                <div class="history-progress-fill ${achieved ? 'achieved' : ''}" style="width: ${percent}%"></div>
              </div>
              <div class="history-percent ${achieved ? 'achieved' : ''}">${percent}%</div>
            </div>
            <div class="history-details">
              <div class="history-breakdown">
                ${generateHistoryBreakdownItems(assignedTasks, item.taskStats)}
              </div>
              <div class="history-ranking">
                <span class="history-ranking-label">🏆 ランキング</span>
                <span class="history-ranking-value">${item.rank}位 / ${item.totalParticipants}人</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('historyList').innerHTML = html;
    }

    // ========================================
    // お知らせ機能
    // ========================================
    let announcements = [];
    let personalAnnouncements = [];
    let readAnnouncementIds = new Set();
    let readPersonalIds = new Set();
    let currentAnnouncementView = 'list'; // 'list' or 'detail'

    // お知らせページを開く
    window.openAnnouncePage = function() {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'navigate', page: 'announce' }, '*');
      } else {
        window.location.href = '/announce.html';
      }
    };

    // お知らせモーダルを開く（レガシー、使用されていない）
    window.openAnnouncementModal = async function() {
      document.getElementById('announceModal').style.display = 'flex';
      currentAnnouncementView = 'list';
      document.getElementById('announceModalBody').innerHTML = '<div class="announce-empty"><div class="spinner-border text-primary" role="status"></div><p style="margin-top: 12px;">読み込み中...</p></div>';
      
      try {
        await loadAnnouncements();
        renderAnnouncementList();
      } catch (error) {
        console.error('お知らせ読み込みエラー:', error);
        document.getElementById('announceModalBody').innerHTML = '<div class="announce-empty"><i class="bi bi-exclamation-circle"></i><p>お知らせの読み込みに失敗しました</p></div>';
      }
    };

    // お知らせモーダルを閉じる
    window.closeAnnouncementModal = function() {
      document.getElementById('announceModal').style.display = 'none';
    };

    // お知らせを読み込む
    async function loadAnnouncements() {
      // 全体お知らせ一覧を取得
      const announcementsRef = collection(db, 'announcements');
      const snapshot = await getDocs(announcementsRef);

      announcements = [];
      snapshot.forEach(docSnap => {
        announcements.push({ id: docSnap.id, ...docSnap.data() });
      });

      // 日付でソート（新しい順）
      announcements.sort((a, b) => {
        const dateA = a.createdAt ? (typeof a.createdAt === 'string' ? new Date(a.createdAt) : a.createdAt.toDate()) : new Date(0);
        const dateB = b.createdAt ? (typeof b.createdAt === 'string' ? new Date(b.createdAt) : b.createdAt.toDate()) : new Date(0);
        return dateB - dateA;
      });

      // 全体お知らせ既読情報を取得
      readAnnouncementIds = new Set();
      if (currentUser && currentUser.email) {
        const readRef = collection(db, 'readAnnouncements');
        const readSnapshot = await getDocs(readRef);
        readSnapshot.forEach(docSnap => {
          const data = docSnap.data();
          if (data.userEmail === currentUser.email) {
            readAnnouncementIds.add(data.announcementId);
          }
        });

        // 個人お知らせを取得
        try {
          const personalRef = collection(db, 'users', currentUser.email, 'personalAnnouncements');
          const personalSnapshot = await getDocs(personalRef);
          personalAnnouncements = [];
          personalSnapshot.forEach(docSnap => {
            personalAnnouncements.push({ id: docSnap.id, ...docSnap.data() });
          });

          // 個人お知らせ既読情報を取得
          readPersonalIds = new Set();
          const readPersonalRef = collection(db, 'users', currentUser.email, 'readPersonalAnnouncements');
          const readPersonalSnapshot = await getDocs(readPersonalRef);
          readPersonalSnapshot.forEach(docSnap => {
            readPersonalIds.add(docSnap.data().announcementId);
          });
        } catch (e) {
          console.log('[Announce] 個人お知らせ読み込みスキップ:', e.message);
          personalAnnouncements = [];
          readPersonalIds = new Set();
        }
      }

      // バッジを更新
      updateAnnounceBadge();
    }

    // お知らせ一覧を描画
    function renderAnnouncementList() {
      if (announcements.length === 0) {
        document.getElementById('announceModalBody').innerHTML = '<div class="announce-empty"><i class="bi bi-bell-slash"></i><p>お知らせはありません</p></div>';
        return;
      }
      
      const html = `<div class="announce-list">${announcements.map(item => {
        const isUnread = !readAnnouncementIds.has(item.id);
        const date = item.createdAt ? (typeof item.createdAt === 'string' ? new Date(item.createdAt) : item.createdAt.toDate()) : null;
        const dateStr = date ? `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()}` : '';
        const priorityClass = item.priority === 'important' ? 'important' : 'normal';
        const priorityLabel = item.priority === 'important' ? '重要' : 'お知らせ';
        
        return `
          <div class="announce-item ${isUnread ? 'unread' : ''}" onclick="showAnnouncementDetail('${item.id}')">
            <div class="announce-item-header">
              <span class="announce-priority ${priorityClass}">${priorityLabel}</span>
              <span class="announce-date">${dateStr}</span>
            </div>
            <div class="announce-title">${escapeHtml(item.title || '')}</div>
            <div class="announce-preview">${escapeHtml(item.body || '').substring(0, 50)}${(item.body || '').length > 50 ? '...' : ''}</div>
          </div>
        `;
      }).join('')}</div>`;
      
      document.getElementById('announceModalBody').innerHTML = html;
    }

    // お知らせ詳細を表示
    window.showAnnouncementDetail = async function(announcementId) {
      const item = announcements.find(a => a.id === announcementId);
      if (!item) return;
      
      currentAnnouncementView = 'detail';
      
      const date = item.createdAt ? (typeof item.createdAt === 'string' ? new Date(item.createdAt) : item.createdAt.toDate()) : null;
      const dateStr = date ? `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日` : '';
      const priorityClass = item.priority === 'important' ? 'important' : 'normal';
      const priorityLabel = item.priority === 'important' ? '重要' : 'お知らせ';
      
      const html = `
        <div class="announce-detail">
          <button class="announce-back-btn" onclick="renderAnnouncementList(); currentAnnouncementView='list';">
            <i class="bi bi-chevron-left"></i> 一覧に戻る
          </button>
          <div class="announce-detail-title">${escapeHtml(item.title || '')}</div>
          <div class="announce-detail-meta">
            <span class="announce-priority ${priorityClass}">${priorityLabel}</span>
            <span>${dateStr}</span>
          </div>
          <div class="announce-detail-body">${escapeHtml(item.body || '')}</div>
        </div>
      `;
      
      document.getElementById('announceModalBody').innerHTML = html;
      
      // 既読にする
      if (!readAnnouncementIds.has(announcementId) && currentUser && currentUser.email) {
        try {
          const readDocRef = doc(db, 'readAnnouncements', `${currentUser.email}_${announcementId}`);
          await setDoc(readDocRef, {
            userEmail: currentUser.email,
            announcementId: announcementId,
            readAt: new Date().toISOString()
          });
          readAnnouncementIds.add(announcementId);
          updateAnnounceBadge();
        } catch (error) {
          console.error('既読マークエラー:', error);
        }
      }
    };

    // バッジを更新（v288: 赤いドット表示に変更）
    // 未読があれば赤いドットを表示、なければ非表示
    function updateAnnounceBadge() {
      const globalUnread = announcements.filter(a => !readAnnouncementIds.has(a.id)).length;
      const personalUnread = personalAnnouncements.filter(a => !readPersonalIds.has(a.id)).length;
      const hasUnread = (globalUnread + personalUnread) > 0;
      const dot = document.getElementById('announceDot');
      if (dot) {
        if (hasUnread) {
          dot.classList.add('active');
        } else {
          dot.classList.remove('active');
        }
      }
      console.log('[Announce] 未読あり:', hasUnread, '(全体:', globalUnread, ', 個人:', personalUnread, ')');
      // v288: お知らせは独立管理のため、親フレームへの通知は不要
    }

    // 初期化時にお知らせを読み込んでバッジを更新
    async function initAnnouncements() {
      try {
        await loadAnnouncements();
      } catch (error) {
        console.error('お知らせ初期化エラー:', error);
      }
    }

    // 戻る（履歴ベース）
    window.goBack = function() {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'goBack' }, '*');
      } else {
        window.history.back();
      }
    };

    // ローディング表示
    function showLoading(show) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    // エスケープ
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, char => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[char]));
    }

    // 絵文字を削除
    function stripEmoji(str) {
      if (!str) return '';
      return str.replace(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '').trim();
    }

    // 初期化実行
    // ========================================
    // 背景カスタマイズ機能
    // ========================================

    // 背景スタイルを取得（Base64キャッシュ優先）
    function getProfileBgStyle() {
      if (userProfileBg.type === 'image' && userProfileBg.value) {
        const pos = userProfileBg.position !== undefined ? userProfileBg.position : 50;
        // Base64キャッシュがあればそれを使用（即座に表示）
        const cachedBase64 = getCachedBgImage();
        const imageUrl = cachedBase64 || userProfileBg.value;
        return `background-image: url('${imageUrl}'); background-size: cover; background-position: center ${pos}%;`;
      } else {
        const preset = GRADIENT_PRESETS.find(p => p.id === userProfileBg.value) || GRADIENT_PRESETS[0];
        return `background: ${preset.gradient};`;
      }
    }

    // ユーザーの背景設定を読み込む
    async function loadUserProfileBg() {
      try {
        const userRef = doc(db, 'users', currentUser.email);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          const data = userSnap.data();
          if (data.profileBackground) {
            userProfileBg = data.profileBackground;
            console.log('[ProfileBg] 背景設定を読み込み:', userProfileBg);
          }
        }
      } catch (error) {
        console.error('[ProfileBg] 背景設定読み込みエラー:', error);
      }
    }

    // 背景選択モーダルを開く
    window.openBgModal = function() {
      // 現在の設定を選択状態に
      selectedBgType = userProfileBg.type;
      selectedBgValue = userProfileBg.value;
      selectedBgPosition = userProfileBg.position !== undefined ? userProfileBg.position : 50;
      pendingBgImageFile = null;

      // グラデーショングリッドを生成
      renderBgGradientGrid();

      // 画像プレビューをリセット
      const preview = document.getElementById('bgPreview');
      const previewImg = document.getElementById('bgPreviewImage');
      if (userProfileBg.type === 'image' && userProfileBg.value) {
        previewImg.src = userProfileBg.value;
        preview.classList.add('active');
        // 画像が読み込まれたら位置を適用
        previewImg.onload = function() {
          applyPreviewPosition();
        };
      } else {
        preview.classList.remove('active');
        previewImg.src = '';
      }

      document.getElementById('bgImageInput').value = '';
      document.getElementById('bgModal').classList.add('active');

      // ドラッグイベントをセットアップ
      setupBgPositionDrag();
    };

    // 背景選択モーダルを閉じる
    window.closeBgModal = function() {
      document.getElementById('bgModal').classList.remove('active');
    };

    // グラデーショングリッドを生成
    function renderBgGradientGrid() {
      const grid = document.getElementById('bgGradientGrid');
      grid.innerHTML = GRADIENT_PRESETS.map(preset => {
        const isSelected = selectedBgType === 'gradient' && selectedBgValue === preset.id;
        return `<div class="bg-gradient-item ${isSelected ? 'selected' : ''}"
                    style="background: ${preset.gradient};"
                    onclick="selectBgGradient('${preset.id}')"></div>`;
      }).join('');
    }

    // グラデーションを選択
    window.selectBgGradient = function(gradientId) {
      selectedBgType = 'gradient';
      selectedBgValue = gradientId;
      pendingBgImageFile = null;

      // 画像プレビューを非表示
      document.getElementById('bgPreview').classList.remove('active');
      document.getElementById('bgImageInput').value = '';

      // 選択状態を更新
      renderBgGradientGrid();
    };

    // 画像選択ハンドラ
    window.handleBgImageSelect = function(event) {
      const file = event.target.files[0];
      if (!file) return;

      // ファイルサイズチェック（5MB以下）
      if (file.size > 5 * 1024 * 1024) {
        alert('画像サイズは5MB以下にしてください');
        event.target.value = '';
        return;
      }

      // プレビュー表示
      const reader = new FileReader();
      reader.onload = function(e) {
        const previewImg = document.getElementById('bgPreviewImage');
        previewImg.src = e.target.result;
        document.getElementById('bgPreview').classList.add('active');

        selectedBgType = 'image';
        selectedBgValue = e.target.result; // 一時的にData URLを設定
        selectedBgPosition = 50; // 新しい画像は中央からスタート
        pendingBgImageFile = file;

        // 画像が読み込まれたら位置を適用
        previewImg.onload = function() {
          applyPreviewPosition();
          setupBgPositionDrag();
        };

        // グラデーションの選択を解除
        renderBgGradientGrid();
      };
      reader.readAsDataURL(file);
    };

    // 画像を削除
    window.removeBgImage = function() {
      document.getElementById('bgPreview').classList.remove('active');
      document.getElementById('bgPreviewImage').src = '';
      document.getElementById('bgImageInput').value = '';
      pendingBgImageFile = null;

      // デフォルトのグラデーションに戻す
      selectedBgType = 'gradient';
      selectedBgValue = userProfileBg.type === 'gradient' ? userProfileBg.value : 'blue';
      renderBgGradientGrid();
    };

    // 画像位置調整のドラッグ処理をセットアップ
    function setupBgPositionDrag() {
      const adjuster = document.getElementById('bgPositionAdjuster');
      const previewImg = document.getElementById('bgPreviewImage');
      if (!adjuster || !previewImg) return;

      let isDragging = false;
      let startY = 0;
      let startPosition = 0;

      const onStart = (e) => {
        if (selectedBgType !== 'image') return;
        isDragging = true;
        startY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
        startPosition = selectedBgPosition;
        e.preventDefault();
      };

      const onMove = (e) => {
        if (!isDragging) return;
        const currentY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
        const deltaY = currentY - startY;
        const containerHeight = adjuster.offsetHeight;
        const imgHeight = previewImg.offsetHeight;

        // deltaYに応じて位置を変更（上にドラッグ→position増加、下にドラッグ→position減少）
        const sensitivity = 100 / Math.max(imgHeight - containerHeight, 100);
        let newPosition = startPosition - (deltaY * sensitivity);
        newPosition = Math.max(0, Math.min(100, newPosition));

        selectedBgPosition = newPosition;
        applyPreviewPosition();
      };

      const onEnd = () => {
        isDragging = false;
      };

      // 既存のイベントリスナーを削除
      adjuster.onmousedown = null;
      adjuster.ontouchstart = null;
      document.onmousemove = null;
      document.ontouchmove = null;
      document.onmouseup = null;
      document.ontouchend = null;

      // 新しいイベントリスナーを追加
      adjuster.onmousedown = onStart;
      adjuster.ontouchstart = onStart;
      document.onmousemove = onMove;
      document.ontouchmove = onMove;
      document.onmouseup = onEnd;
      document.ontouchend = onEnd;
    }

    // プレビュー画像の位置を適用
    function applyPreviewPosition() {
      const previewImg = document.getElementById('bgPreviewImage');
      const adjuster = document.getElementById('bgPositionAdjuster');
      if (!previewImg || !adjuster) return;

      // 画像の高さとコンテナの高さから、移動可能範囲を計算
      const containerHeight = adjuster.offsetHeight;
      const imgHeight = previewImg.naturalHeight * (adjuster.offsetWidth / previewImg.naturalWidth);
      const maxOffset = Math.max(0, imgHeight - containerHeight);

      // positionに応じてtop位置を計算
      const topOffset = -(maxOffset * selectedBgPosition / 100);
      previewImg.style.top = `${topOffset}px`;
    }

    // 位置をリセット
    window.resetBgPosition = function() {
      selectedBgPosition = 50;
      applyPreviewPosition();
    };

    // 背景設定を保存
    window.saveBgSetting = async function() {
      const saveBtn = document.getElementById('bgSaveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = '保存中...';

      try {
        let newBgValue = selectedBgValue;

        // 画像の場合はアップロード
        if (selectedBgType === 'image' && pendingBgImageFile) {
          const timestamp = Date.now();
          const fileName = `profile-bg/${currentUser.email}/${timestamp}_${pendingBgImageFile.name}`;
          const storageRef = ref(storage, fileName);

          await uploadBytes(storageRef, pendingBgImageFile);
          newBgValue = await getDownloadURL(storageRef);
          console.log('[ProfileBg] 画像アップロード完了:', newBgValue);
        }

        // Firestoreに保存（position情報も含める）
        const userRef = doc(db, 'users', currentUser.email);
        await updateDoc(userRef, {
          profileBackground: {
            type: selectedBgType,
            value: newBgValue,
            position: selectedBgType === 'image' ? selectedBgPosition : 50
          }
        });

        // ローカル状態を更新
        userProfileBg = {
          type: selectedBgType,
          value: newBgValue,
          position: selectedBgType === 'image' ? selectedBgPosition : 50
        };

        // プロフィールカードの背景を即時反映
        const profileCard = document.getElementById('profileCard');
        if (profileCard) {
          if (userProfileBg.type === 'image') {
            const pos = userProfileBg.position !== undefined ? userProfileBg.position : 50;
            profileCard.style.cssText = `background-image: url('${userProfileBg.value}'); background-size: cover; background-position: center ${pos}%;`;
          } else {
            const preset = GRADIENT_PRESETS.find(p => p.id === userProfileBg.value) || GRADIENT_PRESETS[0];
            profileCard.style.cssText = `background: ${preset.gradient};`;
          }
        }

        closeBgModal();

        // キャッシュを更新（次回即時表示用）
        saveToCache();
        if (userProfileBg.type === 'image' && userProfileBg.value) {
          cacheBgImageAsBase64(userProfileBg.value);
        } else {
          // グラデーションの場合は画像キャッシュをクリア
          sessionStorage.removeItem(MYPAGE_BG_IMAGE_CACHE_KEY);
        }

        console.log('[ProfileBg] 背景設定を保存:', userProfileBg);
      } catch (error) {
        console.error('[ProfileBg] 保存エラー:', error);
        alert('背景の保存に失敗しました');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = '保存';
      }
    };

    // ========================================
    // 個人情報設定・通知設定機能
    // ========================================

    // 個人情報（発送先・口座）を保持
    let personalInfo = {
      shipping: { name: '', postalCode: '', address: '', phone: '' },
      bank: { bankName: '', branchName: '', accountType: '', accountNumber: '', accountHolder: '' }
    };

    // 通知設定を保持
    let notificationSettings = {
      pushEnabled: true,
      soundEnabled: true
    };

    // 個人情報を読み込む
    async function loadPersonalInfo() {
      try {
        const userRef = doc(db, 'users', currentUser.email);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          const data = userSnap.data();
          if (data.personalInfo) {
            personalInfo = {
              shipping: data.personalInfo.shipping || { name: '', postalCode: '', address: '', phone: '' },
              bank: data.personalInfo.bank || { bankName: '', branchName: '', accountType: '', accountNumber: '', accountHolder: '' }
            };
          }
        }
      } catch (error) {
        console.error('[PersonalInfo] 読み込みエラー:', error);
      }
    }

    // 通知設定を読み込む
    async function loadNotificationSettings() {
      try {
        const userRef = doc(db, 'users', currentUser.email);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          const data = userSnap.data();
          if (data.notificationSettings) {
            notificationSettings = {
              pushEnabled: data.notificationSettings.pushEnabled !== false,
              soundEnabled: data.notificationSettings.soundEnabled !== false
            };
          }
        }
      } catch (error) {
        console.error('[NotificationSettings] 読み込みエラー:', error);
      }
    }

    // 個人情報設定モーダルを開く
    window.openPersonalInfoModal = async function() {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) dropdown.classList.remove('active');

      // 個人情報を読み込み
      await loadPersonalInfo();

      // フォームに値をセット
      document.getElementById('shippingName').value = personalInfo.shipping.name || '';
      document.getElementById('shippingPostalCode').value = personalInfo.shipping.postalCode || '';
      document.getElementById('shippingAddress').value = personalInfo.shipping.address || '';
      document.getElementById('shippingPhone').value = personalInfo.shipping.phone || '';
      document.getElementById('bankName').value = personalInfo.bank.bankName || '';
      document.getElementById('branchName').value = personalInfo.bank.branchName || '';
      document.getElementById('accountType').value = personalInfo.bank.accountType || '普通';
      document.getElementById('accountNumber').value = personalInfo.bank.accountNumber || '';
      document.getElementById('accountHolder').value = personalInfo.bank.accountHolder || '';

      document.getElementById('personalInfoModal').classList.add('active');
    };

    // 個人情報設定モーダルを閉じる
    window.closePersonalInfoModal = function() {
      document.getElementById('personalInfoModal').classList.remove('active');
    };

    // 個人情報を保存
    window.savePersonalInfo = async function() {
      const saveBtn = document.getElementById('personalInfoSaveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = '保存中...';

      try {
        const newPersonalInfo = {
          shipping: {
            name: document.getElementById('shippingName').value.trim(),
            postalCode: document.getElementById('shippingPostalCode').value.trim(),
            address: document.getElementById('shippingAddress').value.trim(),
            phone: document.getElementById('shippingPhone').value.trim()
          },
          bank: {
            bankName: document.getElementById('bankName').value.trim(),
            branchName: document.getElementById('branchName').value.trim(),
            accountType: document.getElementById('accountType').value,
            accountNumber: document.getElementById('accountNumber').value.trim(),
            accountHolder: document.getElementById('accountHolder').value.trim()
          }
        };

        // Firestoreに保存
        const userRef = doc(db, 'users', currentUser.email);
        await updateDoc(userRef, {
          personalInfo: newPersonalInfo
        });

        personalInfo = newPersonalInfo;
        closePersonalInfoModal();
        console.log('[PersonalInfo] 個人情報を保存:', personalInfo);
      } catch (error) {
        console.error('[PersonalInfo] 保存エラー:', error);
        alert('個人情報の保存に失敗しました');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = '保存';
      }
    };

    // 通知設定モーダルを開く
    window.openNotificationSettingsModal = async function() {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) dropdown.classList.remove('active');

      // 通知設定を読み込み
      await loadNotificationSettings();

      // トグルに値をセット
      document.getElementById('pushNotificationToggle').checked = notificationSettings.pushEnabled;
      document.getElementById('notificationSoundToggle').checked = notificationSettings.soundEnabled;

      document.getElementById('notificationSettingsModal').classList.add('active');
    };

    // 通知設定モーダルを閉じる
    window.closeNotificationSettingsModal = function() {
      document.getElementById('notificationSettingsModal').classList.remove('active');
    };

    // 通知設定を保存
    window.saveNotificationSettings = async function() {
      const saveBtn = document.getElementById('notificationSaveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = '保存中...';

      try {
        const newSettings = {
          pushEnabled: document.getElementById('pushNotificationToggle').checked,
          soundEnabled: document.getElementById('notificationSoundToggle').checked
        };

        // Firestoreに保存
        const userRef = doc(db, 'users', currentUser.email);
        await updateDoc(userRef, {
          notificationSettings: newSettings
        });

        notificationSettings = newSettings;
        closeNotificationSettingsModal();
        console.log('[NotificationSettings] 通知設定を保存:', notificationSettings);
      } catch (error) {
        console.error('[NotificationSettings] 保存エラー:', error);
        alert('通知設定の保存に失敗しました');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = '保存';
      }
    };

    // ユーザー名編集モーダルを開く
    window.openUsernameEditModal = function() {
      document.getElementById('newUsernameInput').value = currentUser.name || '';
      document.getElementById('usernameEditModal').classList.add('active');
    };

    // ユーザー名編集モーダルを閉じる
    window.closeUsernameEditModal = function() {
      document.getElementById('usernameEditModal').classList.remove('active');
    };

    // ユーザー名を保存
    window.saveUsername = async function() {
      const newUsername = document.getElementById('newUsernameInput').value.trim();
      if (!newUsername) {
        alert('ユーザー名を入力してください');
        return;
      }

      const saveBtn = document.getElementById('usernameSaveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = '保存中...';

      try {
        // Firestoreに保存
        const userRef = doc(db, 'users', currentUser.email);
        await updateDoc(userRef, {
          name: newUsername,
          displayName: newUsername
        });

        // ローカルストレージも更新
        localStorage.setItem('reborn_user_name', newUsername);

        // 現在のユーザー情報を更新
        currentUser.name = newUsername;

        closeUsernameEditModal();
        renderMyPage();
        console.log('[Username] ユーザー名を保存:', newUsername);
      } catch (error) {
        console.error('[Username] 保存エラー:', error);
        alert('ユーザー名の保存に失敗しました');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = '保存';
      }
    };

    // プロフィール画像選択ハンドラ
    window.handleProfileImageSelect = async function(event) {
      const file = event.target.files[0];
      if (!file) return;

      // ファイルサイズチェック（5MB以下）
      if (file.size > 5 * 1024 * 1024) {
        alert('画像サイズは5MB以下にしてください');
        event.target.value = '';
        return;
      }

      showLoading(true);

      try {
        // Firebase Storageにアップロード
        const timestamp = Date.now();
        const fileName = `userIcons/${currentUser.email}/${timestamp}_${file.name}`;
        const storageRef = ref(storage, fileName);

        await uploadBytes(storageRef, file);
        const downloadURL = await getDownloadURL(storageRef);

        // Firestoreに保存
        const userRef = doc(db, 'users', currentUser.email);
        await updateDoc(userRef, {
          photoURL: downloadURL,
          iconUrl: downloadURL
        });

        // ローカルストレージも更新
        localStorage.setItem('reborn_user_icon_url', downloadURL);
        localStorage.setItem('reborn_user_photo_url', downloadURL);

        // 現在のユーザー情報を更新
        currentUser.photoURL = downloadURL;

        renderMyPage();
        console.log('[ProfileImage] プロフィール画像を更新:', downloadURL);
      } catch (error) {
        console.error('[ProfileImage] アップロードエラー:', error);
        alert('画像のアップロードに失敗しました');
      } finally {
        showLoading(false);
        event.target.value = '';
      }
    };

    // プロフィール画像クリックハンドラ
    window.clickProfileImage = function() {
      document.getElementById('profileImageInput').click();
    };

    // ========================================
    // ノート機能
    // ========================================

    // ノート一覧モーダルを開く
    window.openNotesModal = async function() {
      const backdrop = document.getElementById('notesModalBackdrop');
      const modal = document.getElementById('notesModal');

      backdrop.classList.add('active');
      setTimeout(() => modal.classList.add('active'), 10);

      await loadNotes();
    };

    // ノート一覧モーダルを閉じる
    window.closeNotesModal = function() {
      const backdrop = document.getElementById('notesModalBackdrop');
      const modal = document.getElementById('notesModal');

      modal.classList.remove('active');
      setTimeout(() => {
        backdrop.classList.remove('active');
      }, 300);
    };

    // ノート一覧を読み込み
    async function loadNotes() {
      const body = document.getElementById('notesModalBody');
      body.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;"><i class="bi bi-arrow-repeat" style="animation: spin 1s linear infinite; font-size: 24px;"></i></div>';

      try {
        const notesRef = collection(db, 'users', currentUser.email, 'notes');
        const q = query(notesRef, orderBy('updatedAt', 'desc'), limit(50));
        const snapshot = await getDocs(q);

        notesList = [];
        snapshot.forEach(doc => {
          notesList.push({ id: doc.id, ...doc.data() });
        });

        renderNotesList();
      } catch (error) {
        console.error('[Notes] 読み込みエラー:', error);
        body.innerHTML = '<div class="notes-empty"><i class="bi bi-exclamation-circle"></i><div class="notes-empty-text">読み込みに失敗しました</div></div>';
      }
    }

    // ノート一覧を描画
    function renderNotesList() {
      const body = document.getElementById('notesModalBody');

      if (notesList.length === 0) {
        body.innerHTML = `
          <div class="notes-empty">
            <i class="bi bi-journal-text"></i>
            <div class="notes-empty-text">
              ノートがありません<br>
              <small>＋ボタンから新しいノートを作成できます</small>
            </div>
          </div>
        `;
        return;
      }

      const html = notesList.map(note => {
        // プレビューテキストを取得
        let preview = '';
        if (note.blocks && note.blocks.length > 0) {
          const textBlock = note.blocks.find(b => b.type === 'text' && b.content?.text);
          if (textBlock) {
            preview = textBlock.content.text.substring(0, 100);
          }
        }

        // 更新日時
        let dateStr = '';
        if (note.updatedAt) {
          const date = note.updatedAt.toDate ? note.updatedAt.toDate() : new Date(note.updatedAt);
          dateStr = date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
        }

        return `
          <div class="note-item" onclick="openNoteEditor('${note.id}')">
            <div class="note-item-header">
              <i class="bi bi-journal-text note-item-icon"></i>
              <span class="note-item-title">${escapeHtml(note.title || '無題のノート')}</span>
            </div>
            <div class="note-item-date">${dateStr}</div>
            ${preview ? `<div class="note-item-preview">${escapeHtml(preview)}</div>` : ''}
          </div>
        `;
      }).join('');

      body.innerHTML = `<div class="notes-list">${html}</div>`;
    }

    // 新規ノート作成
    window.createNewNote = async function() {
      try {
        const notesRef = collection(db, 'users', currentUser.email, 'notes');
        const newNote = await addDoc(notesRef, {
          title: '',
          blocks: [],
          paperType: 'grid',
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          shareId: null,
          isPublic: false
        });

        console.log('[Notes] 新規ノート作成:', newNote.id);
        openNoteEditor(newNote.id);
      } catch (error) {
        console.error('[Notes] 作成エラー:', error);
        alert('ノートの作成に失敗しました');
      }
    };

    // ノートエディタを開く
    window.openNoteEditor = async function(noteId) {
      currentNoteId = noteId;

      const modal = document.getElementById('noteEditorModal');
      modal.classList.add('active');

      // ブロック追加ボタンを表示
      document.getElementById('noteAddFixed').classList.add('active');

      // ノートデータを読み込み
      try {
        const noteRef = doc(db, 'users', currentUser.email, 'notes', noteId);
        const noteSnap = await getDoc(noteRef);

        if (!noteSnap.exists()) {
          alert('ノートが見つかりません');
          closeNoteEditor();
          return;
        }

        currentNoteData = { id: noteId, ...noteSnap.data() };

        // タイトル設定
        document.getElementById('noteTitleInput').value = currentNoteData.title || '';

        // 罫線タイプ設定
        const container = document.getElementById('noteBlocksContainer');
        container.className = 'note-blocks-container';
        if (currentNoteData.paperType === 'lined') {
          container.classList.add('paper-lined');
        } else if (currentNoteData.paperType === 'grid') {
          container.classList.add('paper-grid');
        }
        updatePaperTypeUI(currentNoteData.paperType || 'grid');

        // ブロックを描画
        renderBlocks();

        // Sortable.js初期化
        initSortable();

      } catch (error) {
        console.error('[Notes] エディタ読み込みエラー:', error);
        alert('ノートの読み込みに失敗しました');
        closeNoteEditor();
      }
    };

    // ノートエディタを閉じる
    window.closeNoteEditor = function() {
      // 保存を実行
      if (noteSaveTimer) {
        clearTimeout(noteSaveTimer);
        saveNote();
      }

      const modal = document.getElementById('noteEditorModal');
      modal.classList.remove('active');

      // ブロック追加ボタンを非表示
      document.getElementById('noteAddFixed').classList.remove('active');

      currentNoteId = null;
      currentNoteData = null;

      if (sortableInstance) {
        sortableInstance.destroy();
        sortableInstance = null;
      }

      // ノート一覧を更新
      loadNotes();
    };

    // ブロックを描画
    function renderBlocks() {
      const container = document.getElementById('noteBlocksContainer');

      if (!currentNoteData.blocks || currentNoteData.blocks.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af; font-size: 14px;">下の「ブロックを追加」ボタンをタップ</div>';
        return;
      }

      const html = currentNoteData.blocks.map(block => renderBlock(block)).join('');
      container.innerHTML = html;

      // テキストエリアの高さを自動調整
      setTimeout(() => {
        resizeAllTextareas();
      }, 10);
    }

    // 単一ブロックをHTMLに変換（シンプル自由配置）
    function renderBlock(block) {
      // 位置情報（デフォルト値）
      const x = block.content?.x ?? 16;
      const y = block.content?.y ?? (block.order * 100 + 16);
      const posStyle = `left: ${x}px; top: ${y}px;`;

      if (block.type === 'text') {
        const textColor = block.content?.color || '#000000';
        // HTMLコンテンツ（リッチテキスト対応）
        const htmlContent = block.content?.html || escapeHtml(block.content?.text || '');
        return `
          <div class="note-block" data-block-id="${block.id}" style="${posStyle}"
               onclick="selectBlock(event, '${block.id}')">
            <div class="block-drag-handle" onmousedown="startDrag(event, '${block.id}')" ontouchstart="startDrag(event, '${block.id}')">
              <i class="bi bi-arrows-move"></i>
            </div>
            <div class="block-controls">
              <button class="block-color-dot" style="background: ${textColor};" onclick="event.stopPropagation(); showColorPopover(event, '${block.id}')" title="文字色"></button>
              <button class="block-ctrl-btn delete" onclick="event.stopPropagation(); deleteBlock('${block.id}')"><i class="bi bi-trash"></i></button>
            </div>
            <div class="block-content">
              <div class="block-richtext"
                   contenteditable="true"
                   data-placeholder="テキストを入力..."
                   style="color: ${textColor};"
                   onfocus="selectBlock(event, '${block.id}')"
                   oninput="updateBlockHtml('${block.id}', this.innerHTML)"
              >${htmlContent}</div>
            </div>
          </div>
        `;
      } else if (block.type === 'image') {
        const size = block.content?.size || 'medium';
        return `
          <div class="note-block" data-block-id="${block.id}" style="${posStyle}"
               onclick="selectBlock(event, '${block.id}')">
            <div class="block-drag-handle" onmousedown="startDrag(event, '${block.id}')" ontouchstart="startDrag(event, '${block.id}')">
              <i class="bi bi-arrows-move"></i>
            </div>
            <div class="block-controls">
              <button class="block-ctrl-btn ${size === 'small' ? 'active' : ''}" onclick="event.stopPropagation(); changeImageSize('${block.id}', 'small')">S</button>
              <button class="block-ctrl-btn ${size === 'medium' ? 'active' : ''}" onclick="event.stopPropagation(); changeImageSize('${block.id}', 'medium')">M</button>
              <button class="block-ctrl-btn ${size === 'large' ? 'active' : ''}" onclick="event.stopPropagation(); changeImageSize('${block.id}', 'large')">L</button>
              <button class="block-ctrl-btn delete" onclick="event.stopPropagation(); deleteBlock('${block.id}')"><i class="bi bi-trash"></i></button>
            </div>
            <div class="block-content">
              <img class="block-img size-${size}" src="${block.content?.url || ''}" alt="${escapeHtml(block.content?.fileName || '画像')}" draggable="false">
            </div>
          </div>
        `;
      } else if (block.type === 'file') {
        return `
          <div class="note-block" data-block-id="${block.id}" style="${posStyle}"
               onclick="selectBlock(event, '${block.id}')">
            <div class="block-drag-handle" onmousedown="startDrag(event, '${block.id}')" ontouchstart="startDrag(event, '${block.id}')">
              <i class="bi bi-arrows-move"></i>
            </div>
            <div class="block-controls">
              <button class="block-ctrl-btn delete" onclick="event.stopPropagation(); deleteBlock('${block.id}')"><i class="bi bi-trash"></i></button>
            </div>
            <div class="block-content">
              <div class="block-file-card" onclick="event.stopPropagation(); window.open('${block.content?.url || ''}', '_blank')">
                <i class="bi bi-file-earmark"></i>
                <span>${escapeHtml(block.content?.fileName || 'ファイル')}</span>
              </div>
            </div>
          </div>
        `;
      } else if (block.type === 'heading') {
        const level = block.content?.level || 'h2';
        const headingColor = block.content?.color || '#000000';
        return `
          <div class="note-block" data-block-id="${block.id}" style="${posStyle}"
               onclick="selectBlock(event, '${block.id}')">
            <div class="block-drag-handle" onmousedown="startDrag(event, '${block.id}')" ontouchstart="startDrag(event, '${block.id}')">
              <i class="bi bi-arrows-move"></i>
            </div>
            <div class="block-controls">
              <button class="block-ctrl-btn ${level === 'h1' ? 'active' : ''}" onclick="event.stopPropagation(); changeHeadingLevel('${block.id}', 'h1')">H1</button>
              <button class="block-ctrl-btn ${level === 'h2' ? 'active' : ''}" onclick="event.stopPropagation(); changeHeadingLevel('${block.id}', 'h2')">H2</button>
              <button class="block-ctrl-btn ${level === 'h3' ? 'active' : ''}" onclick="event.stopPropagation(); changeHeadingLevel('${block.id}', 'h3')">H3</button>
              <button class="block-color-dot" style="background: ${headingColor};" onclick="event.stopPropagation(); showColorPopover(event, '${block.id}')" title="文字色"></button>
              <button class="block-ctrl-btn delete" onclick="event.stopPropagation(); deleteBlock('${block.id}')"><i class="bi bi-trash"></i></button>
            </div>
            <div class="block-content">
              <textarea class="block-heading ${level}"
                        placeholder="${level === 'h1' ? '大見出し' : level === 'h2' ? '中見出し' : '小見出し'}"
                        style="color: ${headingColor};"
                        onfocus="selectBlock(event, '${block.id}')"
                        oninput="updateBlockContent('${block.id}', this.value); autoResizeTextarea(this);"
              >${escapeHtml(block.content?.text || '')}</textarea>
            </div>
          </div>
        `;
      }
      return '';
    }

    // ブロック選択
    let selectedBlockId = null;

    window.selectBlock = function(event, blockId) {
      event.stopPropagation();
      
      // 他のブロックの選択を解除
      document.querySelectorAll('.note-block.selected').forEach(el => {
        el.classList.remove('selected');
      });

      // このブロックを選択
      const blockEl = document.querySelector(`.note-block[data-block-id="${blockId}"]`);
      if (blockEl) {
        blockEl.classList.add('selected');
        selectedBlockId = blockId;
      }
    };

    // コンテナクリックで選択解除
    function initCanvasClick() {
      const container = document.getElementById('noteBlocksContainer');
      if (container) {
        container.addEventListener('click', function(e) {
          if (e.target === container) {
            document.querySelectorAll('.note-block.selected').forEach(el => {
              el.classList.remove('selected');
            });
            selectedBlockId = null;
          }
        });
      }
    }

    // 自由配置ドラッグ機能
    let dragState = {
      isDragging: false,
      blockId: null,
      startX: 0,
      startY: 0,
      blockStartX: 0,
      blockStartY: 0,
      element: null,
      hasMoved: false
    };

    window.startDrag = function(event, blockId) {
      event.preventDefault();
      event.stopPropagation();
      
      const blockEl = document.querySelector(`.note-block[data-block-id="${blockId}"]`);
      if (!blockEl) return;
      
      // ブロックを選択状態に
      selectBlock(event, blockId);

      const touch = event.touches ? event.touches[0] : event;
      
      dragState = {
        isDragging: true,
        blockId: blockId,
        startX: touch.clientX,
        startY: touch.clientY,
        blockStartX: parseInt(blockEl.style.left) || 0,
        blockStartY: parseInt(blockEl.style.top) || 0,
        element: blockEl,
        hasMoved: false
      };

      blockEl.classList.add('dragging');
      
      // イベントリスナー追加
      document.addEventListener('mousemove', onDragMove);
      document.addEventListener('mouseup', onDragEnd);
      document.addEventListener('touchmove', onDragMove, { passive: false });
      document.addEventListener('touchend', onDragEnd);
    };

    function onDragMove(event) {
      if (!dragState.isDragging) return;

      const touch = event.touches ? event.touches[0] : event;
      const deltaX = touch.clientX - dragState.startX;
      const deltaY = touch.clientY - dragState.startY;

      // 少し動いたらドラッグ開始
      if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
        dragState.hasMoved = true;
        event.preventDefault();
      }

      if (dragState.hasMoved) {
        const newX = Math.max(0, dragState.blockStartX + deltaX);
        const newY = Math.max(0, dragState.blockStartY + deltaY);

        dragState.element.style.left = newX + 'px';
        dragState.element.style.top = newY + 'px';
      }
    }

    function onDragEnd(event) {
      if (!dragState.isDragging) return;

      // 位置を保存（移動した場合のみ）
      if (dragState.hasMoved) {
        const block = currentNoteData.blocks.find(b => b.id === dragState.blockId);
        if (block) {
          if (!block.content) block.content = {};
          block.content.x = parseInt(dragState.element.style.left) || 0;
          block.content.y = parseInt(dragState.element.style.top) || 0;
          scheduleNoteSave();
        }
      }

      dragState.element.classList.remove('dragging');
      
      // イベントリスナー削除
      document.removeEventListener('mousemove', onDragMove);
      document.removeEventListener('mouseup', onDragEnd);
      document.removeEventListener('touchmove', onDragMove);
      document.removeEventListener('touchend', onDragEnd);

      dragState = {
        isDragging: false,
        blockId: null,
        startX: 0,
        startY: 0,
        blockStartX: 0,
        blockStartY: 0,
        element: null,
        hasMoved: false
      };
    }

    // initSortableを空関数に（互換性のため残す）
    function initSortable() {
      // 自由配置モードでは不要
      initCanvasClick();
    }

    // UUID生成
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // テキストブロック追加
    window.addTextBlock = function() {
      const block = {
        id: generateUUID(),
        type: 'text',
        order: currentNoteData.blocks ? currentNoteData.blocks.length : 0,
        content: { text: '' }
      };

      if (!currentNoteData.blocks) {
        currentNoteData.blocks = [];
      }
      currentNoteData.blocks.push(block);

      renderBlocks();
      initSortable();
      scheduleNoteSave();

      // 新しいリッチテキストにフォーカス
      setTimeout(() => {
        const richtexts = document.querySelectorAll('.block-richtext');
        if (richtexts.length > 0) {
          richtexts[richtexts.length - 1].focus();
        }
      }, 100);
    };

    // 全ポップオーバーを閉じる
    window.closeAllPopovers = function() {
      const overlay = document.getElementById('popoverOverlay');
      const addPopover = document.getElementById('noteAddPopover');
      const colorPopover = document.getElementById('blockColorPopover');

      overlay.classList.remove('active');
      addPopover.classList.remove('active');
      colorPopover.classList.remove('active');
    };

    // ブロック追加ポップオーバー表示
    window.showAddPopover = function(event) {
      event.stopPropagation();
      closeAllPopovers();

      const overlay = document.getElementById('popoverOverlay');
      const popover = document.getElementById('noteAddPopover');
      const btn = event.currentTarget;
      const rect = btn.getBoundingClientRect();

      // ボタンの上に表示
      popover.style.left = (rect.left + rect.width / 2 - 70) + 'px';
      popover.style.bottom = (window.innerHeight - rect.top + 8) + 'px';
      popover.style.top = 'auto';

      overlay.classList.add('active');
      popover.classList.add('active');
    };

    // カラー選択ポップオーバー表示
    let currentColorBlockId = null;
    const colorOptions = [
      { color: '#000000', name: '黒' },
      { color: '#6b7280', name: 'グレー' },
      { color: '#ef4444', name: '赤' },
      { color: '#f97316', name: 'オレンジ' },
      { color: '#22c55e', name: '緑' },
      { color: '#3b82f6', name: '青' },
      { color: '#8b5cf6', name: '紫' }
    ];

    // ブロック全体の色を変更
    window.showColorPopover = function(event, blockId) {
      event.stopPropagation();
      closeAllPopovers();

      currentColorBlockId = blockId;
      const overlay = document.getElementById('popoverOverlay');
      const popover = document.getElementById('blockColorPopover');
      const grid = document.getElementById('colorPopoverGrid');
      const btn = event.currentTarget;
      const rect = btn.getBoundingClientRect();

      // 現在の色を取得
      const block = currentNoteData.blocks.find(b => b.id === blockId);
      const currentColor = block?.content?.color || '#000000';

      // カラーグリッド生成
      grid.innerHTML = colorOptions.map(opt => `
        <button class="block-color-option ${currentColor === opt.color ? 'active' : ''}"
                style="background: ${opt.color};"
                onclick="selectColor('${opt.color}')"
                title="${opt.name}"></button>
      `).join('');

      // ボタンの下に表示
      popover.style.left = Math.max(8, rect.left - 40) + 'px';
      popover.style.top = (rect.bottom + 8) + 'px';
      popover.style.bottom = 'auto';

      overlay.classList.add('active');
      popover.classList.add('active');
    };

    // カラー選択実行（見出しブロック用）
    window.selectColor = function(color) {
      if (currentColorBlockId) {
        changeTextColor(currentColorBlockId, color);
      }
      closeAllPopovers();
    };

    // 見出しブロック追加
    window.addHeadingBlock = function() {
      const block = {
        id: generateUUID(),
        type: 'heading',
        order: currentNoteData.blocks ? currentNoteData.blocks.length : 0,
        content: { text: '', level: 'h2' }
      };

      if (!currentNoteData.blocks) {
        currentNoteData.blocks = [];
      }
      currentNoteData.blocks.push(block);

      renderBlocks();
      initSortable();
      scheduleNoteSave();

      // 新しい見出しにフォーカス
      setTimeout(() => {
        const headings = document.querySelectorAll('.block-heading');
        if (headings.length > 0) {
          headings[headings.length - 1].focus();
        }
      }, 100);
    };

    // 画像アップロードトリガー
    window.triggerImageUpload = function() {
      document.getElementById('noteImageInput').click();
    };

    // ファイルアップロードトリガー
    window.triggerFileUpload = function() {
      document.getElementById('noteFileInput').click();
    };

    // 画像アップロード処理
    window.handleNoteImageUpload = async function(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (file.size > 10 * 1024 * 1024) {
        alert('画像サイズは10MB以下にしてください');
        event.target.value = '';
        return;
      }

      showLoading(true);

      try {
        // Firebase Storageにアップロード
        const timestamp = Date.now();
        const blockId = generateUUID();
        const fileName = `notes/${currentUser.email}/${currentNoteId}/${blockId}_${file.name}`;
        const storageRef = ref(storage, fileName);

        await uploadBytes(storageRef, file);
        const downloadURL = await getDownloadURL(storageRef);

        // ブロック追加
        const block = {
          id: blockId,
          type: 'image',
          order: currentNoteData.blocks ? currentNoteData.blocks.length : 0,
          content: { url: downloadURL, fileName: file.name }
        };

        if (!currentNoteData.blocks) {
          currentNoteData.blocks = [];
        }
        currentNoteData.blocks.push(block);

        renderBlocks();
        initSortable();
        saveNote();

        console.log('[Notes] 画像ブロック追加:', downloadURL);
      } catch (error) {
        console.error('[Notes] 画像アップロードエラー:', error);
        alert('画像のアップロードに失敗しました');
      } finally {
        showLoading(false);
        event.target.value = '';
      }
    };

    // ファイルアップロード処理
    window.handleNoteFileUpload = async function(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (file.size > 10 * 1024 * 1024) {
        alert('ファイルサイズは10MB以下にしてください');
        event.target.value = '';
        return;
      }

      showLoading(true);

      try {
        // Firebase Storageにアップロード
        const timestamp = Date.now();
        const blockId = generateUUID();
        const fileName = `notes/${currentUser.email}/${currentNoteId}/${blockId}_${file.name}`;
        const storageRef = ref(storage, fileName);

        await uploadBytes(storageRef, file);
        const downloadURL = await getDownloadURL(storageRef);

        // ブロック追加
        const block = {
          id: blockId,
          type: 'file',
          order: currentNoteData.blocks ? currentNoteData.blocks.length : 0,
          content: { url: downloadURL, fileName: file.name, fileType: file.type }
        };

        if (!currentNoteData.blocks) {
          currentNoteData.blocks = [];
        }
        currentNoteData.blocks.push(block);

        renderBlocks();
        initSortable();
        saveNote();

        console.log('[Notes] ファイルブロック追加:', downloadURL);
      } catch (error) {
        console.error('[Notes] ファイルアップロードエラー:', error);
        alert('ファイルのアップロードに失敗しました');
      } finally {
        showLoading(false);
        event.target.value = '';
      }
    };

    // ブロック内容更新（プレーンテキスト）
    window.updateBlockContent = function(blockId, value) {
      const block = currentNoteData.blocks.find(b => b.id === blockId);
      if (block) {
        block.content.text = value;
        scheduleNoteSave();
      }
    };

    // ブロックHTML更新（リッチテキスト）
    window.updateBlockHtml = function(blockId, html) {
      const block = currentNoteData.blocks.find(b => b.id === blockId);
      if (block) {
        block.content.html = html;
        // プレーンテキストも保存（検索用）
        const temp = document.createElement('div');
        temp.innerHTML = html;
        block.content.text = temp.textContent || temp.innerText || '';
        scheduleNoteSave();
      }
    };

    // テキストフォーマット適用
    window.formatText = function(command) {
      // 選択範囲を保持しながらフォーマット適用
      document.execCommand(command, false, null);

      // 変更を保存
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const richtext = range.startContainer.closest ?
                         range.startContainer.closest('.block-richtext') :
                         range.startContainer.parentElement?.closest('.block-richtext');
        if (richtext) {
          const blockEl = richtext.closest('.note-block');
          if (blockEl) {
            const blockId = blockEl.dataset.blockId;
            updateBlockHtml(blockId, richtext.innerHTML);
          }
        }
      }
    };

    // ブロック削除
    window.deleteBlock = function(blockId) {
      currentNoteData.blocks = currentNoteData.blocks.filter(b => b.id !== blockId);
      renderBlocks();
      initSortable();
      scheduleNoteSave();
    };

    // 画像サイズ変更
    window.changeImageSize = function(blockId, size) {
      const block = currentNoteData.blocks.find(b => b.id === blockId);
      if (block && block.type === 'image') {
        if (!block.content) block.content = {};
        block.content.size = size;
        renderBlocks();
        initSortable();
        scheduleNoteSave();
      }
    };

    // 見出しレベル変更
    window.changeHeadingLevel = function(blockId, level) {
      const block = currentNoteData.blocks.find(b => b.id === blockId);
      if (block && block.type === 'heading') {
        if (!block.content) block.content = {};
        block.content.level = level;
        renderBlocks();
        initSortable();
        scheduleNoteSave();
      }
    };

    // テキスト色変更
    window.changeTextColor = function(blockId, color) {
      const block = currentNoteData.blocks.find(b => b.id === blockId);
      if (block && (block.type === 'text' || block.type === 'heading')) {
        if (!block.content) block.content = {};
        block.content.color = color;
        renderBlocks();
        initSortable();
        scheduleNoteSave();
      }
    };

    // テキストエリア自動リサイズ
    window.autoResizeTextarea = function(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    };

    // 全テキストエリアの高さを調整
    function resizeAllTextareas() {
      const textareas = document.querySelectorAll('.block-textarea, .block-heading');
      textareas.forEach(textarea => {
        autoResizeTextarea(textarea);
      });
    }

    // 保存スケジュール（デバウンス）
    window.scheduleNoteSave = function() {
      if (noteSaveTimer) {
        clearTimeout(noteSaveTimer);
      }
      noteSaveTimer = setTimeout(() => {
        saveNote();
      }, 500);
    };

    // ノート保存
    async function saveNote() {
      if (!currentNoteId || !currentNoteData) return;

      try {
        const noteRef = doc(db, 'users', currentUser.email, 'notes', currentNoteId);

        // タイトル取得
        const titleInput = document.getElementById('noteTitleInput');
        currentNoteData.title = titleInput ? titleInput.value : '';

        await updateDoc(noteRef, {
          title: currentNoteData.title,
          blocks: currentNoteData.blocks || [],
          paperType: currentNoteData.paperType || 'grid',
          updatedAt: serverTimestamp()
        });

        console.log('[Notes] 保存完了');
      } catch (error) {
        console.error('[Notes] 保存エラー:', error);
      }
    }

    // 罫線タイプ選択ポップオーバー表示/非表示
    window.togglePaperTypePopover = function(event) {
      if (event) event.stopPropagation();
      const popover = document.getElementById('paperTypePopover');
      const isActive = popover.classList.toggle('active');

      // 外側クリックで閉じる処理
      if (isActive) {
        setTimeout(() => {
          document.addEventListener('click', closePaperTypeOnOutsideClick);
        }, 10);
      }
    };

    function closePaperTypeOnOutsideClick(event) {
      const popover = document.getElementById('paperTypePopover');
      const btn = event.target.closest('[onclick*="togglePaperTypePopover"]');
      if (!popover.contains(event.target) && !btn) {
        popover.classList.remove('active');
        document.removeEventListener('click', closePaperTypeOnOutsideClick);
      }
    }

    // 罫線タイプ選択
    window.selectPaperType = function(type) {
      currentNoteData.paperType = type;

      const container = document.getElementById('noteBlocksContainer');
      container.className = 'note-blocks-container';
      if (type === 'lined') {
        container.classList.add('paper-lined');
      } else if (type === 'grid') {
        container.classList.add('paper-grid');
      }

      updatePaperTypeUI(type);
      // ポップオーバーを閉じる
      const popover = document.getElementById('paperTypePopover');
      popover.classList.remove('active');
      document.removeEventListener('click', closePaperTypeOnOutsideClick);
      scheduleNoteSave();
    };

    // 罫線タイプUI更新
    function updatePaperTypeUI(type) {
      const options = document.querySelectorAll('.paper-type-option');
      options.forEach(opt => {
        opt.classList.remove('selected');
        if (opt.dataset.type === type) {
          opt.classList.add('selected');
        }
      });
    }

    // ノート削除
    window.deleteNote = async function() {
      if (!confirm('このノートを削除しますか？')) return;

      try {
        const noteRef = doc(db, 'users', currentUser.email, 'notes', currentNoteId);
        await deleteDoc(noteRef);

        console.log('[Notes] 削除完了:', currentNoteId);
        closeNoteEditor();
      } catch (error) {
        console.error('[Notes] 削除エラー:', error);
        alert('削除に失敗しました');
      }
    };

    // ノート共有機能
    let currentShareNoteId = null;
    let currentShareId = null;

    window.shareNote = async function() {
      if (!currentNoteId || !currentNoteData) return;

      // 共有IDがない場合は生成
      if (!currentNoteData.shareId) {
        try {
          const shareId = generateUUID().substring(0, 12);
          const noteRef = doc(db, 'users', currentUser.email, 'notes', currentNoteId);
          await updateDoc(noteRef, {
            shareId: shareId,
            isPublic: true
          });

          // noteSharesコレクションにインデックス追加
          const shareRef = doc(db, 'noteShares', shareId);
          await setDoc(shareRef, {
            noteId: currentNoteId,
            ownerEmail: currentUser.email,
            createdAt: serverTimestamp(),
            isActive: true
          });

          currentNoteData.shareId = shareId;
          console.log('[Notes] 共有ID生成:', shareId);
        } catch (error) {
          console.error('[Notes] 共有ID生成エラー:', error);
          alert('共有リンクの生成に失敗しました');
          return;
        }
      }

      currentShareNoteId = currentNoteId;
      currentShareId = currentNoteData.shareId;

      // 共有リンクを設定
      const shareUrl = `${window.location.origin}/note-view.html?id=${currentShareId}`;
      document.getElementById('shareLinkInput').value = shareUrl;

      // モーダルを開く
      openShareModal();
    };

    // 共有モーダルを開く
    async function openShareModal() {
      const overlay = document.getElementById('shareModalOverlay');
      const modal = document.getElementById('shareModal');
      const roomList = document.getElementById('shareRoomList');

      overlay.classList.add('active');
      setTimeout(() => modal.classList.add('active'), 10);

      // ルーム一覧を読み込み
      roomList.innerHTML = '<div class="share-loading"><i class="bi bi-arrow-repeat" style="animation: spin 1s linear infinite;"></i> 読み込み中...</div>';

      try {
        const roomsRef = collection(db, 'rooms');
        // membersにはユーザー名が入っている（emailではない）
        const userName = currentUser.name || currentUser.email.split('@')[0];
        console.log('[Notes] ルーム検索ユーザー名:', userName);
        const q = query(
          roomsRef,
          where('members', 'array-contains', userName),
          limit(50)
        );
        const snapshot = await getDocs(q);
        console.log('[Notes] ルーム検索結果:', snapshot.size, '件');

        const rooms = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          // システムルームとKeepルームは除外
          if (data.type !== 'system' && data.type !== 'keep') {
            rooms.push({ id: doc.id, ...data });
          }
        });

        if (rooms.length === 0) {
          roomList.innerHTML = '<div class="share-loading">送信先のチャットルームがありません</div>';
          return;
        }

        // ユーザーアイコンを取得するためにusersコレクションを読み込み
        const usersSnapshot = await getDocs(collection(db, 'users'));
        const usersMap = {};
        usersSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.userName) {
            usersMap[data.userName] = data.userIconUrl || data.photoURL || data.iconUrl || '';
          }
        });

        const html = rooms.map(room => {
          let iconHtml = '';
          let typeLabel = 'チャット';
          let roomName = room.name || '';
          let otherUserName = '';

          if (room.type === 'team') {
            // チーム・全体チャットは💬絵文字
            iconHtml = '<span style="font-size: 22px;">💬</span>';
            typeLabel = 'チーム';
          } else if (room.type === 'direct' || room.type === 'dm') {
            typeLabel = '個別';
            // membersから相手の名前を取得
            if (room.members && Array.isArray(room.members)) {
              otherUserName = room.members.find(m => m !== userName) || '';
              if (otherUserName) roomName = otherUserName;
            }
            // 相手のアイコンを取得
            const iconUrl = usersMap[otherUserName] || '';
            if (iconUrl) {
              iconHtml = `<img src="${iconUrl}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" onerror="this.outerHTML='<i class=\\'bi bi-person-fill\\'></i>'">`;
            } else {
              iconHtml = '<i class="bi bi-person-fill"></i>';
            }
          } else {
            iconHtml = '<i class="bi bi-chat-fill"></i>';
          }

          // ルーム名がない場合はmembersから生成
          if (!roomName && room.members && Array.isArray(room.members)) {
            roomName = room.members.filter(m => m !== userName).join(', ') || room.members.join(', ');
          }

          return `
            <div class="share-room-item" onclick="sendNoteToRoom('${room.id}', '${escapeHtml(roomName || '無題のルーム')}')">
              <div class="share-room-icon">
                ${iconHtml}
              </div>
              <div class="share-room-info">
                <div class="share-room-name">${escapeHtml(roomName || '無題のルーム')}</div>
                <div class="share-room-type">${typeLabel}</div>
              </div>
            </div>
          `;
        }).join('');

        roomList.innerHTML = html;

      } catch (error) {
        console.error('[Notes] ルーム一覧読み込みエラー:', error);
        roomList.innerHTML = '<div class="share-loading">ルーム一覧の読み込みに失敗しました</div>';
      }
    }

    // 共有モーダルを閉じる
    window.closeShareModal = function() {
      const overlay = document.getElementById('shareModalOverlay');
      const modal = document.getElementById('shareModal');

      modal.classList.remove('active');
      setTimeout(() => {
        overlay.classList.remove('active');
      }, 300);
    };

    // 共有リンクをコピー
    window.copyShareLink = async function() {
      const input = document.getElementById('shareLinkInput');
      const url = input.value;

      try {
        await navigator.clipboard.writeText(url);
        alert('リンクをコピーしました');
      } catch (error) {
        // フォールバック
        input.select();
        document.execCommand('copy');
        alert('リンクをコピーしました');
      }
    };

    // ノートをチャットルームに送信
    window.sendNoteToRoom = async function(roomId, roomName) {
      if (!currentShareNoteId || !currentShareId) return;

      closeShareModal();

      try {
        const shareUrl = `${window.location.origin}/note-view.html?id=${currentShareId}`;
        const noteTitle = currentNoteData?.title || '無題のノート';

        // メッセージを送信
        const messagesRef = collection(db, 'rooms', roomId, 'messages');
        await addDoc(messagesRef, {
          text: `📝 ノートを共有しました\n\n「${noteTitle}」\n${shareUrl}`,
          userName: currentUser.name,  // チャットのusersCache検索と一致させる
          userEmail: currentUser.email,
          timestamp: serverTimestamp(),
          type: 'note-share',
          noteShareData: {
            shareId: currentShareId,
            noteId: currentShareNoteId,
            title: noteTitle,
            url: shareUrl
          }
        });

        // ルームのlastMessage更新
        const roomRef = doc(db, 'rooms', roomId);
        await updateDoc(roomRef, {
          lastMessage: `📝 ${noteTitle}`,
          lastMessageAt: serverTimestamp()
        });

        console.log('[Notes] ノート共有送信完了:', roomId);
        alert(`「${roomName}」にノートを共有しました`);

      } catch (error) {
        console.error('[Notes] ノート共有送信エラー:', error);
        alert('送信に失敗しました');
      }

      currentShareNoteId = null;
      currentShareId = null;
    };

    // 報酬単価アコーディオンの開閉
    window.toggleRateAccordion = function(btn) {
      btn.classList.toggle('active');
      const content = btn.nextElementSibling;
      content.classList.toggle('active');
    };

    init();
  </script>
</body>
</html>
