<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<title>仕入登録 - FURIRA</title>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- QRCode.js (qrcode-generator) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  * {
    box-sizing: border-box;
  }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #f5f5f5;
    margin: 0;
    padding: 0;
    min-height: 100vh;
  }
  
  /* ヘッダー */
  .header {
    background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
    color: white;
    padding: 16px 20px;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 600px;
    margin: 0 auto;
  }
  .header-title {
    font-size: 1.1rem;
    font-weight: 600;
  }
  .back-button {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
  }
  
  /* コンテンツ */
  .content {
    max-width: 600px;
    margin: 0 auto;
    padding: 16px;
  }
  
  /* カード */
  .card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border: none;
  }
  .card-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 16px;
    color: #333;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  /* フォーム */
  .form-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #555;
    margin-bottom: 6px;
  }
  .form-control, .form-select {
    border-radius: 8px;
    border: 1px solid #ddd;
    padding: 12px;
    font-size: 1rem;
  }
  .form-control:focus, .form-select:focus {
    border-color: #4ECDC4;
    box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
  }
  
  /* ボタン */
  .btn-primary {
    background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
    border: none;
    border-radius: 8px;
    padding: 14px 24px;
    font-size: 1rem;
    font-weight: 600;
  }
  .btn-primary:hover {
    background: linear-gradient(135deg, #3dbdb5 0%, #3a9080 100%);
  }
  .btn-secondary {
    background: #6c757d;
    border: none;
    border-radius: 8px;
    padding: 14px 24px;
    font-size: 1rem;
  }
  .btn-outline-primary {
    border: 2px solid #4ECDC4;
    color: #4ECDC4;
    border-radius: 8px;
    padding: 12px 20px;
  }
  .btn-outline-primary:hover {
    background: #4ECDC4;
    color: white;
  }
  
  /* QRコードプレビュー */
  .qr-preview-container {
    display: none;
  }
  .qr-preview-container.show {
    display: block;
  }
  .qr-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 12px;
    margin-top: 16px;
  }
  .qr-item {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 12px;
    text-align: center;
  }
  .qr-item canvas {
    max-width: 100%;
    height: auto;
  }
  .qr-item-label {
    font-size: 0.75rem;
    color: #666;
    margin-top: 8px;
    word-break: break-all;
  }
  
  /* 印刷用スタイル */
  @media print {
    body {
      background: white;
    }
    .header, .card:not(.print-area), .btn, .no-print {
      display: none !important;
    }
    .print-area {
      box-shadow: none;
      padding: 0;
    }
    .qr-grid {
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    .qr-item {
      border: 1px solid #000;
      padding: 8px;
      page-break-inside: avoid;
    }
    .qr-item canvas {
      width: 80px !important;
      height: 80px !important;
    }
  }
  
  /* 仕入先追加モーダル */
  .supplier-list {
    max-height: 200px;
    overflow-y: auto;
  }
  .supplier-item {
    padding: 10px 12px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
  }
  .supplier-item:hover {
    background: #f5f5f5;
  }
  
  /* 金額入力 */
  .price-per-item {
    background: #f0f9f8;
    border-radius: 8px;
    padding: 12px;
    margin-top: 12px;
  }
  .price-per-item-label {
    font-size: 0.875rem;
    color: #666;
  }
  .price-per-item-value {
    font-size: 1.25rem;
    font-weight: 600;
    color: #4ECDC4;
  }
</style>
</head>
<body>

<!-- ヘッダー -->
<div class="header">
  <div class="header-content">
    <button class="back-button" onclick="history.back()">
      <i class="bi bi-chevron-left"></i>
    </button>
    <div class="header-title">
      <i class="bi bi-box-seam"></i> 仕入登録
    </div>
    <div style="width: 40px;"></div>
  </div>
</div>

<!-- コンテンツ -->
<div class="content">
  <!-- 仕入情報入力 -->
  <div class="card">
    <div class="card-title">
      <i class="bi bi-clipboard-data"></i> 仕入情報
    </div>
    
    <div class="mb-3">
      <label class="form-label">仕入日 <span class="text-danger">*</span></label>
      <input type="date" class="form-control" id="purchaseDate">
    </div>
    
    <div class="mb-3">
      <label class="form-label">仕入先 <span class="text-danger">*</span></label>
      <select class="form-select" id="supplier">
        <option value="">読み込み中...</option>
      </select>
    </div>
    
    <div class="row">
      <div class="col-6">
        <div class="mb-3">
          <label class="form-label">仕入点数 <span class="text-danger">*</span></label>
          <input type="number" class="form-control" id="itemCount" min="1" max="100" value="1" onchange="calculatePerItem()">
        </div>
      </div>
      <div class="col-6">
        <div class="mb-3">
          <label class="form-label">仕入合計金額 <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text">¥</span>
            <input type="number" class="form-control" id="totalAmount" min="0" onchange="calculatePerItem()">
          </div>
        </div>
      </div>
    </div>
    
    <div class="price-per-item">
      <div class="price-per-item-label">1点あたりの仕入単価（参考）</div>
      <div class="price-per-item-value" id="pricePerItem">¥0</div>
    </div>
    
    <div class="mb-3 mt-3">
      <label class="form-label">メモ（任意）</label>
      <textarea class="form-control" id="memo" rows="2" placeholder="仕入れに関するメモ"></textarea>
    </div>
    
    <div class="mb-3">
      <label class="form-label">発送先（外注） <span class="text-danger">*</span></label>
      <select class="form-select" id="assignee">
        <option value="">読み込み中...</option>
      </select>
    </div>
  </div>
  
  <!-- QRコード生成ボタン -->
  <div class="d-grid gap-2 no-print">
    <button class="btn btn-primary btn-lg" onclick="generateQRCodes()">
      <i class="bi bi-qr-code"></i> QRコードを生成
    </button>
  </div>
  
  <!-- QRコードプレビュー -->
  <div class="card qr-preview-container print-area" id="qrPreview">
    <div class="card-title">
      <i class="bi bi-grid-3x3"></i> QRコードプレビュー
      <span class="badge bg-success ms-2" id="qrCount">0枚</span>
    </div>
    
    <div class="d-flex gap-2 mb-3 no-print">
      <button class="btn btn-outline-primary flex-fill" onclick="printQRCodes()">
        <i class="bi bi-printer"></i> 印刷
      </button>
      <button class="btn btn-outline-primary flex-fill" onclick="downloadQRCodes()">
        <i class="bi bi-download"></i> PDF保存
      </button>
    </div>
    
    <div class="qr-grid" id="qrGrid">
      <!-- QRコードがここに生成される -->
    </div>
    
    <div class="mt-3 no-print">
      <small class="text-muted">
        <i class="bi bi-info-circle"></i> 
        QRコードを印刷して、各商品に貼り付けてください。
        外注スタッフがスキャンすると商品登録画面が開きます。
      </small>
    </div>
  </div>
  
  <!-- 登録完了後のアクション -->
  <div class="card no-print" id="afterActions" style="display: none;">
    <div class="card-title">
      <i class="bi bi-check-circle text-success"></i> 仕入登録完了
    </div>
    <p class="mb-3">仕入ID: <strong id="purchaseId"></strong></p>
    <div class="d-grid gap-2">
      <button class="btn btn-primary" onclick="location.reload()">
        <i class="bi bi-plus-circle"></i> 続けて仕入登録
      </button>
      <button class="btn btn-secondary" onclick="location.href='purchase.html'">
        <i class="bi bi-list"></i> 仕入一覧に戻る
      </button>
    </div>
  </div>
</div>

<!-- 新規仕入先追加モーダル -->
<div class="modal fade" id="newSupplierModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">新規仕入先を追加</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="text" class="form-control" id="newSupplierName" placeholder="仕入先名を入力">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <button type="button" class="btn btn-primary" onclick="addNewSupplier()">追加</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<script>
  // Firebase初期化
  const firebaseConfig = {
    apiKey: "AIzaSyD4fJJLlFx0GBRvPDwpTQpQsJdZQqPkMRw",
    authDomain: "furira.jp",
    projectId: "reborn-inventory-system",
    storageBucket: "reborn-inventory-system.firebasestorage.app",
    messagingSenderId: "537012810863",
    appId: "1:537012810863:web:c2c26deb1d3ee40b08b280",
    measurementId: "G-6JL9VPVPK1"
  };

  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // 初期化
  document.addEventListener('DOMContentLoaded', async function() {
    // 今日の日付をセット
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('purchaseDate').value = today;

    // マスタデータを読み込み
    await loadMasterData();

    // 仕入先選択の監視
    document.getElementById('supplier').addEventListener('change', function() {
      if (this.value === '__new__') {
        const modal = new bootstrap.Modal(document.getElementById('newSupplierModal'));
        modal.show();
        this.value = '';
      }
    });
  });

  // マスタデータ読み込み
  async function loadMasterData() {
    try {
      // 仕入先マスタを読み込み
      const suppliersSnap = await db.collection('masters').doc('suppliers').get();
      const suppliersData = suppliersSnap.exists ? suppliersSnap.data() : { items: [] };
      const suppliers = suppliersData.items || [];

      const supplierSelect = document.getElementById('supplier');
      supplierSelect.innerHTML = '<option value="">--選択してください--</option>';
      suppliers.forEach(item => {
        const option = document.createElement('option');
        option.value = item.name;
        option.textContent = item.name;
        supplierSelect.appendChild(option);
      });
      // 新規追加オプションを最後に追加
      const newOption = document.createElement('option');
      newOption.value = '__new__';
      newOption.textContent = '+ 新規追加...';
      supplierSelect.appendChild(newOption);

      // 発送先マスタを読み込み
      const assigneesSnap = await db.collection('masters').doc('assignees').get();
      const assigneesData = assigneesSnap.exists ? assigneesSnap.data() : { items: [] };
      const assignees = assigneesData.items || [];

      const assigneeSelect = document.getElementById('assignee');
      assigneeSelect.innerHTML = '<option value="">--選択してください--</option>';
      assignees.forEach(item => {
        const option = document.createElement('option');
        option.value = item.name;
        option.textContent = item.note ? `${item.name}（${item.note}）` : item.name;
        assigneeSelect.appendChild(option);
      });
      // 「自分で管理」オプションを最後に追加
      const selfOption = document.createElement('option');
      selfOption.value = '自分で管理';
      selfOption.textContent = '自分で管理';
      assigneeSelect.appendChild(selfOption);

      console.log('[MASTER] マスタデータ読み込み完了 - 仕入先:', suppliers.length, '件, 発送先:', assignees.length, '件');
    } catch (error) {
      console.error('[MASTER] マスタデータ読み込みエラー:', error);
      // エラー時はフォールバック表示
      document.getElementById('supplier').innerHTML = `
        <option value="">--選択してください--</option>
        <option value="__new__">+ 新規追加...</option>
      `;
      document.getElementById('assignee').innerHTML = `
        <option value="">--選択してください--</option>
        <option value="自分で管理">自分で管理</option>
      `;
    }
  }
  
  // 1点あたり単価計算
  function calculatePerItem() {
    const count = parseInt(document.getElementById('itemCount').value) || 1;
    const total = parseInt(document.getElementById('totalAmount').value) || 0;
    const perItem = Math.round(total / count);
    document.getElementById('pricePerItem').textContent = '¥' + perItem.toLocaleString();
  }
  
  // 新規仕入先追加（Firestoreにも保存）
  async function addNewSupplier() {
    const name = document.getElementById('newSupplierName').value.trim();
    if (name) {
      try {
        // Firestoreに保存
        const snapshot = await db.collection('masters').doc('suppliers').get();
        const data = snapshot.exists ? snapshot.data() : { items: [] };
        const items = data.items || [];

        // 重複チェック
        if (items.some(item => item.name === name)) {
          alert('この仕入先は既に登録されています');
          return;
        }

        items.push({ name, createdAt: new Date().toISOString() });
        await db.collection('masters').doc('suppliers').set({ items });

        // セレクトボックスに追加
        const select = document.getElementById('supplier');
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        select.insertBefore(option, select.querySelector('option[value="__new__"]'));
        select.value = name;

        console.log('[MASTER] 仕入先を追加:', name);
      } catch (error) {
        console.error('[MASTER] 仕入先追加エラー:', error);
        // エラー時もローカルに追加（利便性のため）
        const select = document.getElementById('supplier');
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        select.insertBefore(option, select.querySelector('option[value="__new__"]'));
        select.value = name;
      }

      bootstrap.Modal.getInstance(document.getElementById('newSupplierModal')).hide();
      document.getElementById('newSupplierName').value = '';
    }
  }
  
  // QRコード生成
  function generateQRCodes() {
    const purchaseDate = document.getElementById('purchaseDate').value;
    const supplier = document.getElementById('supplier').value;
    const itemCount = parseInt(document.getElementById('itemCount').value) || 0;
    const totalAmount = parseInt(document.getElementById('totalAmount').value) || 0;
    const assignee = document.getElementById('assignee').value;
    
    // バリデーション
    if (!purchaseDate || !supplier || !itemCount || !assignee) {
      alert('必須項目を入力してください');
      return;
    }
    
    // 仕入IDを生成（日付ベース）
    const dateStr = purchaseDate.replace(/-/g, '');
    const randomStr = Math.random().toString(36).substring(2, 6).toUpperCase();
    const purchaseId = `PUR-${dateStr}-${randomStr}`;
    
    // QRコード生成
    const qrGrid = document.getElementById('qrGrid');
    qrGrid.innerHTML = '';
    
    for (let i = 1; i <= itemCount; i++) {
      // 仕入商品ID
      const invId = `INV-${dateStr}-${randomStr}-${String(i).padStart(3, '0')}`;
      
      // QRコードの内容（URL）
      const qrContent = `https://furira.jp/scan?inv=${invId}`;
      
      // QRコード要素を作成
      const qrItem = document.createElement('div');
      qrItem.className = 'qr-item';
      
      const qrContainer = document.createElement('div');
      qrContainer.id = `qr-${i}`;
      qrItem.appendChild(qrContainer);
      
      const label = document.createElement('div');
      label.className = 'qr-item-label';
      label.textContent = `#${i}`;
      qrItem.appendChild(label);
      
      qrGrid.appendChild(qrItem);
      
      // QRコード描画（qrcodejs ライブラリ）
      new QRCode(qrContainer, {
        text: qrContent,
        width: 100,
        height: 100,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.M
      });
    }
    
    // プレビュー表示
    document.getElementById('qrPreview').classList.add('show');
    document.getElementById('qrCount').textContent = itemCount + '枚';
    document.getElementById('purchaseId').textContent = purchaseId;
    
    // 完了メッセージ
    document.getElementById('afterActions').style.display = 'block';
    
    // スクロール
    document.getElementById('qrPreview').scrollIntoView({ behavior: 'smooth' });
  }
  
  // 印刷
  function printQRCodes() {
    window.print();
  }
  
  // PDF保存（簡易版：印刷ダイアログからPDF保存）
  function downloadQRCodes() {
    alert('印刷ダイアログで「PDFとして保存」を選択してください');
    window.print();
  }
</script>

</body>
</html>
