<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<title>仕入登録 - FURIRA</title>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- QRCode.js (qrcode-generator) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  * {
    box-sizing: border-box;
  }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #f5f5f5;
    margin: 0;
    padding: 0;
    min-height: 100vh;
  }
  
  /* ヘッダー */
  .header {
    background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
    color: white;
    padding: 16px 20px;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 600px;
    margin: 0 auto;
  }
  .header-title {
    font-size: 1.1rem;
    font-weight: 600;
  }
  .back-button {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
  }
  
  /* コンテンツ */
  .content {
    max-width: 600px;
    margin: 0 auto;
    padding: 16px;
  }
  
  /* カード */
  .card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border: none;
  }
  .card-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 16px;
    color: #333;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  /* フォーム */
  .form-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #555;
    margin-bottom: 6px;
  }
  .form-control, .form-select {
    border-radius: 8px;
    border: 1px solid #ddd;
    padding: 12px;
    font-size: 1rem;
  }
  .form-control:focus, .form-select:focus {
    border-color: #4ECDC4;
    box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
  }
  
  /* ボタン */
  .btn-primary {
    background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
    border: none;
    border-radius: 8px;
    padding: 14px 24px;
    font-size: 1rem;
    font-weight: 600;
  }
  .btn-primary:hover {
    background: linear-gradient(135deg, #3dbdb5 0%, #3a9080 100%);
  }
  .btn-secondary {
    background: #6c757d;
    border: none;
    border-radius: 8px;
    padding: 14px 24px;
    font-size: 1rem;
  }
  .btn-outline-primary {
    border: 2px solid #4ECDC4;
    color: #4ECDC4;
    border-radius: 8px;
    padding: 12px 20px;
  }
  .btn-outline-primary:hover {
    background: #4ECDC4;
    color: white;
  }
  
  /* QRコードプレビュー */
  .qr-preview-container {
    display: none;
  }
  .qr-preview-container.show {
    display: block;
  }
  .qr-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 12px;
    margin-top: 16px;
  }
  .qr-item {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 12px;
    text-align: center;
  }
  .qr-item canvas {
    max-width: 100%;
    height: auto;
  }
  .qr-item-label {
    font-size: 0.75rem;
    color: #666;
    margin-top: 8px;
    word-break: break-all;
  }
  
  /* ラベル設定カード */
  .label-preset-btn {
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    font-size: 0.85rem;
  }
  .label-preset-btn:hover {
    border-color: #4ECDC4;
    background: #f0faf9;
  }
  .label-preset-btn.active {
    border-color: #4ECDC4;
    background: #e8f8f6;
  }
  .label-preset-btn .preset-name {
    font-weight: 600;
    color: #333;
  }
  .label-preset-btn .preset-info {
    font-size: 0.75rem;
    color: #666;
    margin-top: 4px;
  }
  .custom-settings {
    display: none;
    background: #f8f9fa;
    border-radius: 8px;
    padding: 16px;
    margin-top: 12px;
  }
  .custom-settings.show {
    display: block;
  }
  .custom-settings .form-label {
    font-size: 0.75rem;
    margin-bottom: 4px;
  }
  .custom-settings .form-control {
    padding: 8px;
    font-size: 0.875rem;
  }

  /* ラベルシートプレビュー */
  .label-sheet-preview {
    background: white;
    border: 1px solid #ccc;
    margin: 16px auto;
    position: relative;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .label-cell {
    position: absolute;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }
  .label-cell canvas, .label-cell img {
    max-width: 100%;
    max-height: 100%;
  }
  .label-cell-empty {
    background: #f5f5f5;
    border: 1px dashed #ccc;
  }

  /* 印刷モード選択 */
  .print-mode-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }
  .print-mode-tab {
    flex: 1;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    text-align: center;
    font-size: 0.9rem;
    transition: all 0.2s;
  }
  .print-mode-tab:hover {
    border-color: #4ECDC4;
  }
  .print-mode-tab.active {
    border-color: #4ECDC4;
    background: #e8f8f6;
    color: #2a8a82;
  }
  .print-mode-tab i {
    display: block;
    font-size: 1.5rem;
    margin-bottom: 4px;
  }

  /* 印刷用スタイル */
  @media print {
    body {
      background: white;
      margin: 0;
      padding: 0;
    }
    .header, .card:not(.print-area), .btn, .no-print, .content > *:not(.print-area) {
      display: none !important;
    }
    .content {
      max-width: none;
      padding: 0;
      margin: 0;
    }
    .print-area {
      box-shadow: none;
      padding: 0;
      margin: 0;
      border-radius: 0;
    }
    /* 通常印刷モード */
    .qr-grid {
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    .qr-item {
      border: 1px solid #000;
      padding: 8px;
      page-break-inside: avoid;
    }
    .qr-item canvas {
      width: 80px !important;
      height: 80px !important;
    }
    /* ラベルシート印刷モード */
    .label-sheet-print-area {
      width: 210mm;
      height: 297mm;
      margin: 0;
      padding: 0;
      page-break-after: always;
    }
    .label-sheet-print-area:last-child {
      page-break-after: auto;
    }
    .label-sheet-preview {
      border: none;
      box-shadow: none;
      margin: 0;
    }
    @page {
      size: A4;
      margin: 0;
    }
  }
  
  /* 仕入先追加モーダル */
  .supplier-list {
    max-height: 200px;
    overflow-y: auto;
  }
  .supplier-item {
    padding: 10px 12px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
  }
  .supplier-item:hover {
    background: #f5f5f5;
  }
  
  /* 金額入力 */
  .price-per-item {
    background: #f0f9f8;
    border-radius: 8px;
    padding: 12px;
    margin-top: 12px;
  }
  .price-per-item-label {
    font-size: 0.875rem;
    color: #666;
  }
  .price-per-item-value {
    font-size: 1.25rem;
    font-weight: 600;
    color: #4ECDC4;
  }

  /* 入力モード切替タブ */
  .input-mode-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }
  .input-mode-tab {
    flex: 1;
    padding: 12px 8px;
    border: 2px solid #ddd;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    text-align: center;
    font-size: 0.85rem;
    transition: all 0.2s;
  }
  .input-mode-tab:hover {
    border-color: #4ECDC4;
  }
  .input-mode-tab.active {
    border-color: #4ECDC4;
    background: #e8f8f6;
    color: #2a8a82;
  }
  .input-mode-tab i {
    display: block;
    font-size: 1.3rem;
    margin-bottom: 4px;
  }
  .input-mode-tab .tab-label {
    font-weight: 600;
  }
  .input-mode-tab .tab-desc {
    font-size: 0.7rem;
    color: #888;
    margin-top: 2px;
  }

  /* 個別入力モード */
  .individual-items-container {
    max-height: 400px;
    overflow-y: auto;
  }
  .individual-item {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    position: relative;
  }
  .individual-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  .individual-item-number {
    font-weight: 600;
    color: #4ECDC4;
    font-size: 0.9rem;
  }
  .individual-item-delete {
    background: none;
    border: none;
    color: #dc3545;
    cursor: pointer;
    padding: 4px 8px;
    font-size: 1rem;
  }
  .individual-item-delete:hover {
    background: #fee;
    border-radius: 4px;
  }
  .individual-item .row {
    margin-bottom: 0;
  }
  .individual-item .form-control,
  .individual-item .form-select {
    padding: 8px 10px;
    font-size: 0.9rem;
  }
  .individual-item .form-label {
    font-size: 0.75rem;
    margin-bottom: 4px;
  }

  /* 商品追加ボタン */
  .add-item-btn {
    width: 100%;
    padding: 12px;
    border: 2px dashed #4ECDC4;
    border-radius: 8px;
    background: #f0faf9;
    color: #4ECDC4;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    transition: all 0.2s;
  }
  .add-item-btn:hover {
    background: #e0f5f3;
    border-color: #3dbdb5;
  }

  /* 合計表示 */
  .individual-total {
    background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
    color: white;
    border-radius: 8px;
    padding: 16px;
    margin-top: 16px;
    text-align: center;
  }
  .individual-total-label {
    font-size: 0.85rem;
    opacity: 0.9;
  }
  .individual-total-value {
    font-size: 1.5rem;
    font-weight: 700;
  }
  .individual-total-count {
    font-size: 0.8rem;
    opacity: 0.8;
    margin-top: 4px;
  }
</style>
</head>
<body>

<!-- ヘッダー -->
<div class="header">
  <div class="header-content">
    <button class="back-button" onclick="history.back()">
      <i class="bi bi-chevron-left"></i>
    </button>
    <div class="header-title">
      <i class="bi bi-box-seam"></i> 仕入登録
    </div>
    <div style="width: 40px;"></div>
  </div>
</div>

<!-- コンテンツ -->
<div class="content">
  <!-- 仕入情報入力 -->
  <div class="card">
    <div class="card-title">
      <i class="bi bi-clipboard-data"></i> 仕入情報
    </div>

    <!-- 入力モード切替 -->
    <div class="input-mode-tabs">
      <div class="input-mode-tab active" onclick="setInputMode('batch')" id="inputModeBatch">
        <i class="bi bi-collection"></i>
        <div class="tab-label">一括入力</div>
        <div class="tab-desc">同じ単価でまとめて</div>
      </div>
      <div class="input-mode-tab" onclick="setInputMode('individual')" id="inputModeIndividual">
        <i class="bi bi-list-ol"></i>
        <div class="tab-label">個別入力</div>
        <div class="tab-desc">1点ずつ金額入力</div>
      </div>
    </div>

    <!-- 共通：仕入日 -->
    <div class="mb-3">
      <label class="form-label">仕入日 <span class="text-danger">*</span></label>
      <input type="date" class="form-control" id="purchaseDate">
    </div>

    <!-- 一括入力モード -->
    <div id="batchInputSection">
      <div class="mb-3">
        <label class="form-label">仕入先 <span class="text-danger">*</span></label>
        <select class="form-select" id="supplier">
          <option value="">読み込み中...</option>
        </select>
      </div>

      <div class="row">
        <div class="col-6">
          <div class="mb-3">
            <label class="form-label">仕入点数 <span class="text-danger">*</span></label>
            <input type="number" class="form-control" id="itemCount" min="1" max="100" value="1" onchange="calculatePerItem()">
          </div>
        </div>
        <div class="col-6">
          <div class="mb-3">
            <label class="form-label">仕入合計金額 <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text">¥</span>
              <input type="number" class="form-control" id="totalAmount" min="0" onchange="calculatePerItem()">
            </div>
          </div>
        </div>
      </div>

      <div class="price-per-item">
        <div class="price-per-item-label">1点あたりの仕入単価（参考）</div>
        <div class="price-per-item-value" id="pricePerItem">¥0</div>
      </div>

      <div class="mb-3 mt-3">
        <label class="form-label">メモ（任意）</label>
        <textarea class="form-control" id="memo" rows="2" placeholder="仕入れに関するメモ"></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">発送先 <span class="text-danger">*</span></label>
        <select class="form-select" id="assignee">
          <option value="">読み込み中...</option>
        </select>
      </div>
    </div>

    <!-- 個別入力モード -->
    <div id="individualInputSection" style="display: none;">
      <div class="mb-3">
        <label class="form-label">発送先 <span class="text-danger">*</span></label>
        <select class="form-select" id="assigneeIndividual">
          <option value="">読み込み中...</option>
        </select>
        <small class="text-muted">全商品共通の発送先</small>
      </div>

      <div class="mb-3">
        <label class="form-label fw-bold">商品リスト</label>
        <div class="individual-items-container" id="individualItemsContainer">
          <!-- 個別商品がここに追加される -->
        </div>
        <button type="button" class="add-item-btn" onclick="addIndividualItem()">
          <i class="bi bi-plus-circle"></i> 商品を追加
        </button>
      </div>

      <div class="individual-total" id="individualTotal">
        <div class="individual-total-label">合計金額</div>
        <div class="individual-total-value" id="individualTotalValue">¥0</div>
        <div class="individual-total-count" id="individualTotalCount">0点</div>
      </div>
    </div>
  </div>

  <!-- QRコード生成ボタン -->
  <div class="d-grid gap-2 no-print">
    <button class="btn btn-primary btn-lg" onclick="generateQRCodes()">
      <i class="bi bi-qr-code"></i> QRコードを生成
    </button>
  </div>
  
  <!-- QRコードプレビュー -->
  <div class="card qr-preview-container" id="qrPreview">
    <div class="card-title">
      <i class="bi bi-grid-3x3"></i> QRコードプレビュー
      <span class="badge bg-success ms-2" id="qrCount">0枚</span>
    </div>

    <!-- 印刷モード選択 -->
    <div class="print-mode-tabs no-print">
      <div class="print-mode-tab active" onclick="setPrintMode('simple')" id="printModeSimple">
        <i class="bi bi-grid-3x3-gap"></i>
        シンプル印刷
      </div>
      <div class="print-mode-tab" onclick="setPrintMode('label')" id="printModeLabel">
        <i class="bi bi-layout-wtf"></i>
        ラベルシート印刷
      </div>
    </div>

    <!-- シンプル印刷モード -->
    <div id="simplePrintSection">
      <div class="d-flex gap-2 mb-3 no-print">
        <button class="btn btn-outline-primary flex-fill" onclick="printSimple()">
          <i class="bi bi-printer"></i> 印刷
        </button>
        <button class="btn btn-outline-primary flex-fill" onclick="downloadQRCodes()">
          <i class="bi bi-download"></i> PDF保存
        </button>
      </div>

      <div class="qr-grid print-area" id="qrGrid">
        <!-- QRコードがここに生成される -->
      </div>
    </div>

    <!-- ラベルシート印刷モード -->
    <div id="labelPrintSection" style="display: none;">
      <!-- ラベル設定 -->
      <div class="mb-3 no-print">
        <label class="form-label fw-bold">ラベルシートを選択</label>
        <div class="row g-2" id="labelPresets">
          <div class="col-6">
            <div class="label-preset-btn active" onclick="selectLabelPreset('70face')" data-preset="70face">
              <div class="preset-name">70面</div>
              <div class="preset-info">20×20mm / A4</div>
            </div>
          </div>
          <div class="col-6">
            <div class="label-preset-btn" onclick="selectLabelPreset('24face')" data-preset="24face">
              <div class="preset-name">24面</div>
              <div class="preset-info">66×33.9mm / A4</div>
            </div>
          </div>
          <div class="col-6">
            <div class="label-preset-btn" onclick="selectLabelPreset('44face')" data-preset="44face">
              <div class="preset-name">44面</div>
              <div class="preset-info">48.3×25.4mm / A4</div>
            </div>
          </div>
          <div class="col-6">
            <div class="label-preset-btn" onclick="selectLabelPreset('custom')" data-preset="custom">
              <div class="preset-name">カスタム</div>
              <div class="preset-info">自由設定</div>
            </div>
          </div>
        </div>

        <!-- カスタム設定パネル -->
        <div class="custom-settings" id="customSettings">
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">ラベル幅 (mm)</label>
              <input type="number" class="form-control" id="labelWidth" value="20" min="10" max="100" onchange="updateLabelPreview()">
            </div>
            <div class="col-6">
              <label class="form-label">ラベル高さ (mm)</label>
              <input type="number" class="form-control" id="labelHeight" value="20" min="10" max="100" onchange="updateLabelPreview()">
            </div>
            <div class="col-6">
              <label class="form-label">列数</label>
              <input type="number" class="form-control" id="labelCols" value="7" min="1" max="15" onchange="updateLabelPreview()">
            </div>
            <div class="col-6">
              <label class="form-label">行数</label>
              <input type="number" class="form-control" id="labelRows" value="10" min="1" max="20" onchange="updateLabelPreview()">
            </div>
            <div class="col-6">
              <label class="form-label">上余白 (mm)</label>
              <input type="number" class="form-control" id="marginTop" value="30.5" min="0" max="50" step="0.5" onchange="updateLabelPreview()">
            </div>
            <div class="col-6">
              <label class="form-label">左余白 (mm)</label>
              <input type="number" class="form-control" id="marginLeft" value="4" min="0" max="50" step="0.5" onchange="updateLabelPreview()">
            </div>
            <div class="col-6">
              <label class="form-label">横間隔 (mm)</label>
              <input type="number" class="form-control" id="gapX" value="10" min="0" max="20" step="0.5" onchange="updateLabelPreview()">
            </div>
            <div class="col-6">
              <label class="form-label">縦間隔 (mm)</label>
              <input type="number" class="form-control" id="gapY" value="3" min="0" max="20" step="0.5" onchange="updateLabelPreview()">
            </div>
          </div>
          <div class="mt-2">
            <button class="btn btn-sm btn-outline-secondary" onclick="saveLabelSettings()">
              <i class="bi bi-save"></i> 設定を保存
            </button>
          </div>
        </div>
      </div>

      <!-- ラベル情報表示 -->
      <div class="alert alert-info py-2 no-print">
        <small>
          <i class="bi bi-info-circle"></i>
          <span id="labelInfo">70面ラベル: 1シートあたり70枚印刷可能</span>
          <br>
          <span id="sheetInfo">必要シート数: 1枚</span>
        </small>
      </div>

      <!-- 印刷開始位置 -->
      <div class="mb-3 no-print">
        <label class="form-label">印刷開始位置</label>
        <div class="input-group">
          <input type="number" class="form-control" id="startPosition" value="1" min="1">
          <span class="input-group-text">番目から印刷</span>
        </div>
        <small class="text-muted">途中から印刷する場合に使用（使いかけのシートを有効活用）</small>
      </div>

      <!-- 印刷ボタン -->
      <div class="d-grid gap-2 mb-3 no-print">
        <button class="btn btn-primary" onclick="printLabelSheet()">
          <i class="bi bi-printer"></i> ラベルシート印刷
        </button>
      </div>

      <!-- ラベルシートプレビュー -->
      <div class="text-center no-print">
        <small class="text-muted mb-2 d-block">プレビュー（縮小表示）</small>
      </div>
      <div id="labelSheetContainer">
        <!-- ラベルシートプレビューがここに生成される -->
      </div>
    </div>

    <div class="mt-3 no-print">
      <small class="text-muted">
        <i class="bi bi-info-circle"></i>
        QRコードを印刷して、各商品に貼り付けてください。
        外注スタッフがスキャンすると商品登録画面が開きます。
      </small>
    </div>
  </div>

  <!-- ラベルシート印刷用の隠しエリア -->
  <div id="labelPrintArea" class="print-area" style="display: none;">
    <!-- 印刷時にここにラベルシートが複製される -->
  </div>
  
  <!-- 登録完了後のアクション -->
  <div class="card no-print" id="afterActions" style="display: none;">
    <div class="card-title">
      <i class="bi bi-check-circle text-success"></i> 仕入登録完了
    </div>
    <p class="mb-3">仕入ID: <strong id="purchaseId"></strong></p>
    <div class="d-grid gap-2">
      <button class="btn btn-primary" onclick="location.reload()">
        <i class="bi bi-plus-circle"></i> 続けて仕入登録
      </button>
      <button class="btn btn-secondary" onclick="location.href='purchase.html'">
        <i class="bi bi-list"></i> 仕入一覧に戻る
      </button>
    </div>
  </div>
</div>

<!-- 新規仕入先追加モーダル -->
<div class="modal fade" id="newSupplierModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">新規仕入先を追加</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="text" class="form-control" id="newSupplierName" placeholder="仕入先名を入力">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <button type="button" class="btn btn-primary" onclick="addNewSupplier()">追加</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<script>
  // Firebase初期化（reborn-chat統一）
  const firebaseConfig = {
    apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
    authDomain: "furira.jp",
    projectId: "reborn-chat",
    storageBucket: "reborn-chat.firebasestorage.app",
    messagingSenderId: "345706548795",
    appId: "1:345706548795:web:058a553da6b4b74db5161e"
  };

  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // グローバル変数
  let suppliersData = []; // 仕入先マスタデータ
  let assigneesData = []; // 発送先マスタデータ
  let currentInputMode = 'batch'; // 'batch' or 'individual'
  let individualItems = []; // 個別入力の商品リスト

  // 初期化
  document.addEventListener('DOMContentLoaded', async function() {
    // 今日の日付をセット
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('purchaseDate').value = today;

    // マスタデータを読み込み
    await loadMasterData();

    // 仕入先選択の監視（一括入力モード）
    document.getElementById('supplier').addEventListener('change', function() {
      if (this.value === '__new__') {
        const modal = new bootstrap.Modal(document.getElementById('newSupplierModal'));
        modal.show();
        this.value = '';
      }
    });

    // 個別入力モードの初期化（最初の1件を追加）
    addIndividualItem();
  });

  // マスタデータ読み込み（Firestoreトップレベルコレクションから）
  async function loadMasterData() {
    try {
      // 仕入先マスタを読み込み（suppliersコレクション）
      const suppliersSnap = await db.collection('suppliers').get();
      suppliersData = [];
      suppliersSnap.forEach(doc => {
        suppliersData.push({ id: doc.id, ...doc.data() });
      });
      // 名前順でソート
      suppliersData.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ja'));

      // 一括入力モード用セレクトボックス
      const supplierSelect = document.getElementById('supplier');
      supplierSelect.innerHTML = '<option value="">--選択してください--</option>';
      suppliersData.forEach(item => {
        const option = document.createElement('option');
        option.value = item.name;
        option.textContent = item.name;
        option.dataset.id = item.id;
        supplierSelect.appendChild(option);
      });
      // 新規追加オプションを最後に追加
      const newOption = document.createElement('option');
      newOption.value = '__new__';
      newOption.textContent = '+ 新規追加...';
      supplierSelect.appendChild(newOption);

      // 発送先マスタを読み込み（assigneesコレクション）
      const assigneesSnap = await db.collection('assignees').get();
      assigneesData = [];
      assigneesSnap.forEach(doc => {
        assigneesData.push({ id: doc.id, ...doc.data() });
      });
      // 名前順でソート
      assigneesData.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ja'));

      // 一括入力モード用発送先セレクトボックス
      const assigneeSelect = document.getElementById('assignee');
      assigneeSelect.innerHTML = '<option value="">--選択してください--</option>';
      assigneesData.forEach(item => {
        const option = document.createElement('option');
        option.value = item.name;
        option.textContent = item.note ? `${item.name}（${item.note}）` : item.name;
        option.dataset.id = item.id;
        assigneeSelect.appendChild(option);
      });
      // 「自分で管理」オプションを最後に追加
      const selfOption = document.createElement('option');
      selfOption.value = '自分で管理';
      selfOption.textContent = '自分で管理';
      assigneeSelect.appendChild(selfOption);

      // 個別入力モード用発送先セレクトボックス
      const assigneeIndividualSelect = document.getElementById('assigneeIndividual');
      assigneeIndividualSelect.innerHTML = assigneeSelect.innerHTML;

      console.log('[MASTER] マスタデータ読み込み完了 - 仕入先:', suppliersData.length, '件, 発送先:', assigneesData.length, '件');
    } catch (error) {
      console.error('[MASTER] マスタデータ読み込みエラー:', error);
      // エラー時はフォールバック表示
      document.getElementById('supplier').innerHTML = `
        <option value="">--選択してください--</option>
        <option value="__new__">+ 新規追加...</option>
      `;
      document.getElementById('assignee').innerHTML = `
        <option value="">--選択してください--</option>
        <option value="自分で管理">自分で管理</option>
      `;
      document.getElementById('assigneeIndividual').innerHTML = `
        <option value="">--選択してください--</option>
        <option value="自分で管理">自分で管理</option>
      `;
    }
  }
  
  // 1点あたり単価計算
  function calculatePerItem() {
    const count = parseInt(document.getElementById('itemCount').value) || 1;
    const total = parseInt(document.getElementById('totalAmount').value) || 0;
    const perItem = Math.round(total / count);
    document.getElementById('pricePerItem').textContent = '¥' + perItem.toLocaleString();
  }

  // ========================================
  // 入力モード切替
  // ========================================
  function setInputMode(mode) {
    currentInputMode = mode;

    // タブのアクティブ状態を切替
    document.getElementById('inputModeBatch').classList.toggle('active', mode === 'batch');
    document.getElementById('inputModeIndividual').classList.toggle('active', mode === 'individual');

    // セクションの表示切替
    document.getElementById('batchInputSection').style.display = mode === 'batch' ? 'block' : 'none';
    document.getElementById('individualInputSection').style.display = mode === 'individual' ? 'block' : 'none';
  }

  // ========================================
  // 個別入力モード
  // ========================================

  // 仕入先セレクトボックスのHTMLを生成
  function createSupplierOptionsHTML() {
    let html = '<option value="">--選択--</option>';
    suppliersData.forEach(item => {
      html += `<option value="${item.name}">${item.name}</option>`;
    });
    return html;
  }

  // 個別商品を追加
  function addIndividualItem() {
    const itemId = Date.now(); // ユニークID
    const itemNumber = individualItems.length + 1;

    const itemData = {
      id: itemId,
      supplier: '',
      amount: 0,
      memo: ''
    };
    individualItems.push(itemData);

    const container = document.getElementById('individualItemsContainer');
    const itemDiv = document.createElement('div');
    itemDiv.className = 'individual-item';
    itemDiv.id = `individual-item-${itemId}`;
    itemDiv.innerHTML = `
      <div class="individual-item-header">
        <span class="individual-item-number">#${itemNumber}</span>
        <button type="button" class="individual-item-delete" onclick="removeIndividualItem(${itemId})" ${individualItems.length === 1 ? 'disabled style="opacity:0.3"' : ''}>
          <i class="bi bi-trash"></i>
        </button>
      </div>
      <div class="row g-2">
        <div class="col-6">
          <label class="form-label">仕入先 <span class="text-danger">*</span></label>
          <select class="form-select" id="supplier-${itemId}" onchange="updateIndividualItem(${itemId})">
            ${createSupplierOptionsHTML()}
          </select>
        </div>
        <div class="col-6">
          <label class="form-label">金額 <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text">¥</span>
            <input type="number" class="form-control" id="amount-${itemId}" min="0" onchange="updateIndividualItem(${itemId})">
          </div>
        </div>
      </div>
      <div class="row g-2 mt-1">
        <div class="col-12">
          <label class="form-label">メモ（任意）</label>
          <input type="text" class="form-control" id="memo-${itemId}" placeholder="商品メモ" onchange="updateIndividualItem(${itemId})">
        </div>
      </div>
    `;

    container.appendChild(itemDiv);
    updateIndividualTotal();
    updateIndividualItemNumbers();
  }

  // 個別商品を削除
  function removeIndividualItem(itemId) {
    if (individualItems.length <= 1) {
      return; // 最低1件は残す
    }

    const index = individualItems.findIndex(item => item.id === itemId);
    if (index > -1) {
      individualItems.splice(index, 1);
    }

    const itemDiv = document.getElementById(`individual-item-${itemId}`);
    if (itemDiv) {
      itemDiv.remove();
    }

    updateIndividualTotal();
    updateIndividualItemNumbers();
  }

  // 個別商品の情報を更新
  function updateIndividualItem(itemId) {
    const item = individualItems.find(i => i.id === itemId);
    if (item) {
      item.supplier = document.getElementById(`supplier-${itemId}`)?.value || '';
      item.amount = parseInt(document.getElementById(`amount-${itemId}`)?.value) || 0;
      item.memo = document.getElementById(`memo-${itemId}`)?.value || '';
    }
    updateIndividualTotal();
  }

  // 商品番号を再採番
  function updateIndividualItemNumbers() {
    individualItems.forEach((item, index) => {
      const numberSpan = document.querySelector(`#individual-item-${item.id} .individual-item-number`);
      if (numberSpan) {
        numberSpan.textContent = `#${index + 1}`;
      }
      // 最後の1件は削除ボタンを無効化
      const deleteBtn = document.querySelector(`#individual-item-${item.id} .individual-item-delete`);
      if (deleteBtn) {
        deleteBtn.disabled = individualItems.length === 1;
        deleteBtn.style.opacity = individualItems.length === 1 ? '0.3' : '1';
      }
    });
  }

  // 合計を更新
  function updateIndividualTotal() {
    const totalAmount = individualItems.reduce((sum, item) => sum + (item.amount || 0), 0);
    const count = individualItems.length;

    document.getElementById('individualTotalValue').textContent = '¥' + totalAmount.toLocaleString();
    document.getElementById('individualTotalCount').textContent = `${count}点`;
  }

  // 新規仕入先追加（Firestoreトップレベルコレクションに保存）
  async function addNewSupplier() {
    const name = document.getElementById('newSupplierName').value.trim();
    if (name) {
      try {
        // 重複チェック（suppliersコレクションを検索）
        const existingSnap = await db.collection('suppliers').where('name', '==', name).get();
        if (!existingSnap.empty) {
          alert('この仕入先は既に登録されています');
          return;
        }

        // Firestoreに保存（新規ドキュメントとして追加）
        const docRef = await db.collection('suppliers').add({
          name,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // セレクトボックスに追加
        const select = document.getElementById('supplier');
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        option.dataset.id = docRef.id;
        select.insertBefore(option, select.querySelector('option[value="__new__"]'));
        select.value = name;

        console.log('[MASTER] 仕入先を追加:', name, 'ID:', docRef.id);
      } catch (error) {
        console.error('[MASTER] 仕入先追加エラー:', error);
        // エラー時もローカルに追加（利便性のため）
        const select = document.getElementById('supplier');
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        select.insertBefore(option, select.querySelector('option[value="__new__"]'));
        select.value = name;
      }

      bootstrap.Modal.getInstance(document.getElementById('newSupplierModal')).hide();
      document.getElementById('newSupplierName').value = '';
    }
  }
  
  // QRコード生成（入力モードに応じて分岐）
  function generateQRCodes() {
    if (currentInputMode === 'batch') {
      generateQRCodesBatch();
    } else {
      generateQRCodesIndividual();
    }
  }

  // 一括入力モードのQRコード生成
  function generateQRCodesBatch() {
    const purchaseDate = document.getElementById('purchaseDate').value;
    const supplier = document.getElementById('supplier').value;
    const itemCount = parseInt(document.getElementById('itemCount').value) || 0;
    const totalAmount = parseInt(document.getElementById('totalAmount').value) || 0;
    const assignee = document.getElementById('assignee').value;

    // バリデーション
    if (!purchaseDate || !supplier || !itemCount || !assignee) {
      alert('必須項目を入力してください');
      return;
    }

    // 仕入IDを生成（日付ベース）
    const dateStr = purchaseDate.replace(/-/g, '');
    const randomStr = Math.random().toString(36).substring(2, 6).toUpperCase();
    const purchaseId = `PUR-${dateStr}-${randomStr}`;

    // QRデータをリセット
    generatedQRData = [];

    // QRコード生成
    const qrGrid = document.getElementById('qrGrid');
    qrGrid.innerHTML = '';

    for (let i = 1; i <= itemCount; i++) {
      // 仕入商品ID
      const invId = `INV-${dateStr}-${randomStr}-${String(i).padStart(3, '0')}`;

      // QRコードの内容（URL）
      const qrContent = `https://furira.jp/scan?inv=${invId}`;

      // QRコード要素を作成
      const qrItem = document.createElement('div');
      qrItem.className = 'qr-item';

      const qrContainer = document.createElement('div');
      qrContainer.id = `qr-${i}`;
      qrItem.appendChild(qrContainer);

      const label = document.createElement('div');
      label.className = 'qr-item-label';
      label.textContent = `#${i}`;
      qrItem.appendChild(label);

      qrGrid.appendChild(qrItem);

      // QRコード描画（qrcodejs ライブラリ）
      new QRCode(qrContainer, {
        text: qrContent,
        width: 100,
        height: 100,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.M
      });

      // QRデータを保持（後でdataURL取得）
      generatedQRData.push({
        id: invId,
        content: qrContent,
        index: i,
        dataUrl: null
      });
    }

    // プレビュー表示
    document.getElementById('qrPreview').classList.add('show');
    document.getElementById('qrCount').textContent = itemCount + '枚';
    document.getElementById('purchaseId').textContent = purchaseId;

    // 完了メッセージ
    document.getElementById('afterActions').style.display = 'block';

    // QRコードのcanvasからdataURLを取得（少し遅延）
    setTimeout(() => {
      for (let i = 0; i < generatedQRData.length; i++) {
        const canvas = document.querySelector(`#qr-${i + 1} canvas`);
        if (canvas) {
          generatedQRData[i].dataUrl = canvas.toDataURL('image/png');
        }
      }
      // ラベルプレビューを更新
      if (currentPrintMode === 'label') {
        updateLabelPreview();
      }
      updateLabelInfo();
    }, 500);

    // スクロール
    document.getElementById('qrPreview').scrollIntoView({ behavior: 'smooth' });
  }

  // 個別入力モードのQRコード生成
  function generateQRCodesIndividual() {
    const purchaseDate = document.getElementById('purchaseDate').value;
    const assignee = document.getElementById('assigneeIndividual').value;

    // バリデーション
    if (!purchaseDate) {
      alert('仕入日を入力してください');
      return;
    }
    if (!assignee) {
      alert('発送先を選択してください');
      return;
    }

    // 個別商品のバリデーション
    const validItems = [];
    for (const item of individualItems) {
      // 入力欄から最新の値を取得
      item.supplier = document.getElementById(`supplier-${item.id}`)?.value || '';
      item.amount = parseInt(document.getElementById(`amount-${item.id}`)?.value) || 0;
      item.memo = document.getElementById(`memo-${item.id}`)?.value || '';

      if (!item.supplier) {
        alert(`商品 #${individualItems.indexOf(item) + 1} の仕入先を選択してください`);
        return;
      }
      if (item.amount <= 0) {
        alert(`商品 #${individualItems.indexOf(item) + 1} の金額を入力してください`);
        return;
      }
      validItems.push(item);
    }

    if (validItems.length === 0) {
      alert('商品を追加してください');
      return;
    }

    // 仕入IDを生成（日付ベース）
    const dateStr = purchaseDate.replace(/-/g, '');
    const randomStr = Math.random().toString(36).substring(2, 6).toUpperCase();
    const purchaseId = `PUR-${dateStr}-${randomStr}`;

    // QRデータをリセット
    generatedQRData = [];

    // QRコード生成
    const qrGrid = document.getElementById('qrGrid');
    qrGrid.innerHTML = '';

    validItems.forEach((item, index) => {
      const i = index + 1;
      // 仕入商品ID
      const invId = `INV-${dateStr}-${randomStr}-${String(i).padStart(3, '0')}`;

      // QRコードの内容（URL）
      const qrContent = `https://furira.jp/scan?inv=${invId}`;

      // QRコード要素を作成
      const qrItem = document.createElement('div');
      qrItem.className = 'qr-item';

      const qrContainer = document.createElement('div');
      qrContainer.id = `qr-${i}`;
      qrItem.appendChild(qrContainer);

      // ラベル（金額と仕入先を表示）
      const label = document.createElement('div');
      label.className = 'qr-item-label';
      label.innerHTML = `#${i}<br><small>¥${item.amount.toLocaleString()}</small><br><small>${item.supplier}</small>`;
      qrItem.appendChild(label);

      qrGrid.appendChild(qrItem);

      // QRコード描画
      new QRCode(qrContainer, {
        text: qrContent,
        width: 100,
        height: 100,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.M
      });

      // QRデータを保持（後でdataURL取得）
      generatedQRData.push({
        id: invId,
        content: qrContent,
        index: i,
        dataUrl: null,
        amount: item.amount,
        supplier: item.supplier
      });
    });

    // プレビュー表示
    document.getElementById('qrPreview').classList.add('show');
    document.getElementById('qrCount').textContent = validItems.length + '枚';
    document.getElementById('purchaseId').textContent = purchaseId;

    // 完了メッセージ
    document.getElementById('afterActions').style.display = 'block';

    // QRコードのcanvasからdataURLを取得（少し遅延）
    setTimeout(() => {
      for (let i = 0; i < generatedQRData.length; i++) {
        const canvas = document.querySelector(`#qr-${i + 1} canvas`);
        if (canvas) {
          generatedQRData[i].dataUrl = canvas.toDataURL('image/png');
        }
      }
      // ラベルプレビューを更新
      if (currentPrintMode === 'label') {
        updateLabelPreview();
      }
      updateLabelInfo();
    }, 500);

    // スクロール
    document.getElementById('qrPreview').scrollIntoView({ behavior: 'smooth' });
  }
  
  // シンプル印刷
  function printSimple() {
    // シンプル印刷モードを設定
    document.getElementById('qrGrid').classList.add('print-area');
    document.getElementById('labelPrintArea').style.display = 'none';
    window.print();
  }

  // PDF保存（簡易版：印刷ダイアログからPDF保存）
  function downloadQRCodes() {
    alert('印刷ダイアログで「PDFとして保存」を選択してください');
    printSimple();
  }

  // ========================================
  // ラベルシート印刷機能
  // ========================================

  // 現在の印刷モード
  let currentPrintMode = 'simple';

  // 生成されたQRコードデータを保持
  let generatedQRData = [];

  // ラベルプリセット定義
  const labelPresets = {
    '70face': {
      name: '70面',
      labelWidth: 20,
      labelHeight: 20,
      cols: 7,
      rows: 10,
      marginTop: 30.5,
      marginLeft: 4,
      gapX: 10,
      gapY: 3,
      perSheet: 70
    },
    '24face': {
      name: '24面',
      labelWidth: 66,
      labelHeight: 33.9,
      cols: 3,
      rows: 8,
      marginTop: 8.5,
      marginLeft: 5,
      gapX: 2.5,
      gapY: 0,
      perSheet: 24
    },
    '44face': {
      name: '44面',
      labelWidth: 48.3,
      labelHeight: 25.4,
      cols: 4,
      rows: 11,
      marginTop: 12.7,
      marginLeft: 7,
      gapX: 2.5,
      gapY: 0,
      perSheet: 44
    },
    'custom': {
      name: 'カスタム',
      labelWidth: 20,
      labelHeight: 20,
      cols: 7,
      rows: 10,
      marginTop: 30.5,
      marginLeft: 4,
      gapX: 10,
      gapY: 3,
      perSheet: 70
    }
  };

  // 現在のラベル設定
  let currentLabelSettings = { ...labelPresets['70face'] };

  // 印刷モード切替
  function setPrintMode(mode) {
    currentPrintMode = mode;

    // タブのアクティブ状態を切替
    document.getElementById('printModeSimple').classList.toggle('active', mode === 'simple');
    document.getElementById('printModeLabel').classList.toggle('active', mode === 'label');

    // セクションの表示切替
    document.getElementById('simplePrintSection').style.display = mode === 'simple' ? 'block' : 'none';
    document.getElementById('labelPrintSection').style.display = mode === 'label' ? 'block' : 'none';

    // ラベルモードの場合はプレビューを更新
    if (mode === 'label' && generatedQRData.length > 0) {
      updateLabelPreview();
    }
  }

  // ラベルプリセット選択
  function selectLabelPreset(presetKey) {
    // ボタンのアクティブ状態を切替
    document.querySelectorAll('.label-preset-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.preset === presetKey);
    });

    // カスタム設定パネルの表示
    document.getElementById('customSettings').classList.toggle('show', presetKey === 'custom');

    // 設定を適用
    if (presetKey !== 'custom') {
      currentLabelSettings = { ...labelPresets[presetKey] };
      // カスタム入力欄も更新
      updateCustomInputs();
    } else {
      // カスタムの場合は入力値から設定を読み取る
      readCustomInputs();
    }

    // ラベル情報とプレビューを更新
    updateLabelInfo();
    updateLabelPreview();
  }

  // カスタム入力欄を更新
  function updateCustomInputs() {
    document.getElementById('labelWidth').value = currentLabelSettings.labelWidth;
    document.getElementById('labelHeight').value = currentLabelSettings.labelHeight;
    document.getElementById('labelCols').value = currentLabelSettings.cols;
    document.getElementById('labelRows').value = currentLabelSettings.rows;
    document.getElementById('marginTop').value = currentLabelSettings.marginTop;
    document.getElementById('marginLeft').value = currentLabelSettings.marginLeft;
    document.getElementById('gapX').value = currentLabelSettings.gapX;
    document.getElementById('gapY').value = currentLabelSettings.gapY;
  }

  // カスタム入力値を読み取る
  function readCustomInputs() {
    currentLabelSettings.labelWidth = parseFloat(document.getElementById('labelWidth').value) || 20;
    currentLabelSettings.labelHeight = parseFloat(document.getElementById('labelHeight').value) || 20;
    currentLabelSettings.cols = parseInt(document.getElementById('labelCols').value) || 7;
    currentLabelSettings.rows = parseInt(document.getElementById('labelRows').value) || 10;
    currentLabelSettings.marginTop = parseFloat(document.getElementById('marginTop').value) || 0;
    currentLabelSettings.marginLeft = parseFloat(document.getElementById('marginLeft').value) || 0;
    currentLabelSettings.gapX = parseFloat(document.getElementById('gapX').value) || 0;
    currentLabelSettings.gapY = parseFloat(document.getElementById('gapY').value) || 0;
    currentLabelSettings.perSheet = currentLabelSettings.cols * currentLabelSettings.rows;
  }

  // ラベル情報を更新
  function updateLabelInfo() {
    const perSheet = currentLabelSettings.cols * currentLabelSettings.rows;
    const qrCount = generatedQRData.length;
    const startPos = parseInt(document.getElementById('startPosition')?.value) || 1;
    const effectivePerSheet = perSheet - (startPos - 1);
    const sheetsNeeded = qrCount > 0 ? Math.ceil((qrCount + startPos - 1) / perSheet) : 1;

    document.getElementById('labelInfo').textContent =
      `${currentLabelSettings.name || 'カスタム'}ラベル: 1シートあたり${perSheet}枚印刷可能`;
    document.getElementById('sheetInfo').textContent =
      `必要シート数: ${sheetsNeeded}枚（${qrCount}個のQRコード）`;
  }

  // ラベルシートプレビューを更新
  function updateLabelPreview() {
    // カスタムモードの場合は入力値を読み取る
    if (document.querySelector('.label-preset-btn[data-preset="custom"].active')) {
      readCustomInputs();
    }

    updateLabelInfo();

    if (generatedQRData.length === 0) {
      document.getElementById('labelSheetContainer').innerHTML =
        '<div class="text-center text-muted py-4">QRコードを生成するとプレビューが表示されます</div>';
      return;
    }

    const container = document.getElementById('labelSheetContainer');
    container.innerHTML = '';

    const { labelWidth, labelHeight, cols, rows, marginTop, marginLeft, gapX, gapY } = currentLabelSettings;
    const perSheet = cols * rows;
    const startPos = parseInt(document.getElementById('startPosition')?.value) || 1;

    // A4サイズ (210mm x 297mm)
    const a4Width = 210;
    const a4Height = 297;

    // プレビュースケール（画面に収まるように縮小）
    const maxPreviewWidth = 350;
    const scale = maxPreviewWidth / a4Width;

    // 必要シート数を計算
    const totalQR = generatedQRData.length;
    const sheetsNeeded = Math.ceil((totalQR + startPos - 1) / perSheet);

    let qrIndex = 0;

    for (let sheet = 0; sheet < sheetsNeeded; sheet++) {
      // シートコンテナ
      const sheetDiv = document.createElement('div');
      sheetDiv.className = 'label-sheet-preview';
      sheetDiv.style.width = (a4Width * scale) + 'px';
      sheetDiv.style.height = (a4Height * scale) + 'px';
      sheetDiv.style.marginBottom = '16px';

      // 各ラベルセルを配置
      for (let row = 0; row < rows; row++) {
        for (let col = 0; col < cols; col++) {
          const cellIndex = row * cols + col;
          const globalIndex = sheet * perSheet + cellIndex;

          // 開始位置より前はスキップ（空のセルとして表示）
          const isBeforeStart = globalIndex < startPos - 1;
          const hasQR = !isBeforeStart && qrIndex < totalQR;

          // セル位置を計算
          const x = marginLeft + col * (labelWidth + gapX);
          const y = marginTop + row * (labelHeight + gapY);

          const cell = document.createElement('div');
          cell.className = 'label-cell' + (hasQR ? '' : ' label-cell-empty');
          cell.style.left = (x * scale) + 'px';
          cell.style.top = (y * scale) + 'px';
          cell.style.width = (labelWidth * scale) + 'px';
          cell.style.height = (labelHeight * scale) + 'px';

          if (hasQR) {
            // QRコードを配置
            const qrData = generatedQRData[qrIndex];
            const img = document.createElement('img');
            img.src = qrData.dataUrl;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'contain';
            cell.appendChild(img);
            qrIndex++;
          }

          sheetDiv.appendChild(cell);
        }
      }

      // シート番号ラベル
      const sheetLabel = document.createElement('div');
      sheetLabel.className = 'text-center text-muted mt-1';
      sheetLabel.style.fontSize = '0.75rem';
      sheetLabel.textContent = `シート ${sheet + 1} / ${sheetsNeeded}`;

      const wrapper = document.createElement('div');
      wrapper.appendChild(sheetDiv);
      wrapper.appendChild(sheetLabel);
      container.appendChild(wrapper);
    }
  }

  // ラベルシート印刷
  function printLabelSheet() {
    if (generatedQRData.length === 0) {
      alert('先にQRコードを生成してください');
      return;
    }

    // カスタムモードの場合は入力値を読み取る
    if (document.querySelector('.label-preset-btn[data-preset="custom"].active')) {
      readCustomInputs();
    }

    const { labelWidth, labelHeight, cols, rows, marginTop, marginLeft, gapX, gapY } = currentLabelSettings;
    const perSheet = cols * rows;
    const startPos = parseInt(document.getElementById('startPosition')?.value) || 1;

    // A4サイズ (mm)
    const a4Width = 210;
    const a4Height = 297;

    // 印刷用エリアを準備
    const printArea = document.getElementById('labelPrintArea');
    printArea.innerHTML = '';
    printArea.style.display = 'block';

    // シンプル印刷エリアを非表示
    document.getElementById('qrGrid').classList.remove('print-area');

    const totalQR = generatedQRData.length;
    const sheetsNeeded = Math.ceil((totalQR + startPos - 1) / perSheet);

    let qrIndex = 0;

    for (let sheet = 0; sheet < sheetsNeeded; sheet++) {
      // シートコンテナ（実寸）
      const sheetDiv = document.createElement('div');
      sheetDiv.className = 'label-sheet-print-area';
      sheetDiv.style.width = a4Width + 'mm';
      sheetDiv.style.height = a4Height + 'mm';
      sheetDiv.style.position = 'relative';
      sheetDiv.style.background = 'white';

      // 各ラベルセルを配置
      for (let row = 0; row < rows; row++) {
        for (let col = 0; col < cols; col++) {
          const cellIndex = row * cols + col;
          const globalIndex = sheet * perSheet + cellIndex;

          // 開始位置より前はスキップ
          const isBeforeStart = globalIndex < startPos - 1;
          const hasQR = !isBeforeStart && qrIndex < totalQR;

          if (!hasQR) continue;

          // セル位置を計算
          const x = marginLeft + col * (labelWidth + gapX);
          const y = marginTop + row * (labelHeight + gapY);

          const cell = document.createElement('div');
          cell.style.position = 'absolute';
          cell.style.left = x + 'mm';
          cell.style.top = y + 'mm';
          cell.style.width = labelWidth + 'mm';
          cell.style.height = labelHeight + 'mm';
          cell.style.display = 'flex';
          cell.style.alignItems = 'center';
          cell.style.justifyContent = 'center';

          // QRコードを配置
          const qrData = generatedQRData[qrIndex];
          const img = document.createElement('img');
          img.src = qrData.dataUrl;
          // QRコードをラベルサイズに合わせる（パディング考慮）
          const qrSize = Math.min(labelWidth, labelHeight) * 0.9;
          img.style.width = qrSize + 'mm';
          img.style.height = qrSize + 'mm';
          cell.appendChild(img);

          sheetDiv.appendChild(cell);
          qrIndex++;
        }
      }

      printArea.appendChild(sheetDiv);
    }

    // 印刷実行
    setTimeout(() => {
      window.print();
      // 印刷後にリセット
      setTimeout(() => {
        printArea.style.display = 'none';
      }, 1000);
    }, 100);
  }

  // ラベル設定を保存
  async function saveLabelSettings() {
    readCustomInputs();
    try {
      await db.collection('settings').doc('labelSettings').set({
        ...currentLabelSettings,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert('ラベル設定を保存しました');
    } catch (error) {
      console.error('ラベル設定保存エラー:', error);
      alert('設定の保存に失敗しました');
    }
  }

  // ラベル設定を読み込み
  async function loadLabelSettings() {
    try {
      const doc = await db.collection('settings').doc('labelSettings').get();
      if (doc.exists) {
        const saved = doc.data();
        labelPresets['custom'] = { ...saved, name: 'カスタム' };
        console.log('[LABEL] 保存済み設定を読み込みました');
      }
    } catch (error) {
      console.error('ラベル設定読み込みエラー:', error);
    }
  }

  // 初期化時にラベル設定を読み込み
  document.addEventListener('DOMContentLoaded', function() {
    loadLabelSettings();
    // 開始位置変更時にプレビュー更新
    document.getElementById('startPosition')?.addEventListener('change', function() {
      updateLabelInfo();
      updateLabelPreview();
    });
  });
</script>

</body>
</html>
