<!-- SPA Fragment: sales.html -->
<!-- Prefix: sal- -->
<div id="spa-page-sales">
  <style>
    #spa-page-sales {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    #spa-page-sales .sal-content-container {
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Material Tabs */
    #spa-page-sales .sal-material-tabs {
      display: flex;
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      position: sticky;
      top: 56px;
      z-index: 999;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    #spa-page-sales .sal-material-tabs::-webkit-scrollbar { display: none; }
    #spa-page-sales .sal-material-tab {
      flex: 1;
      min-width: 0;
      padding: 12px 4px;
      text-align: center;
      font-size: 13px;
      font-weight: 500;
      color: #6b7280;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    #spa-page-sales .sal-material-tab:hover {
      color: #374151;
      background: #f9fafb;
    }
    #spa-page-sales .sal-material-tab.active {
      color: #2563eb;
      border-bottom-color: #2563eb;
    }
    #spa-page-sales .sal-material-tab i {
      display: block;
      font-size: 18px;
      margin-bottom: 4px;
    }

    /* フィルタセクション */
    #spa-page-sales .sal-filter-section {
      background: white;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    /* サマリーカード */
    #spa-page-sales .sal-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    #spa-page-sales .sal-summary-card {
      background: white;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    #spa-page-sales .sal-summary-label {
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 4px;
    }
    #spa-page-sales .sal-summary-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1f2937;
    }
    #spa-page-sales .sal-summary-value.positive { color: #10b981; }
    #spa-page-sales .sal-summary-value.negative { color: #ef4444; }

    /* 売上一覧テーブル */
    #spa-page-sales .sal-sales-table-container {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    #spa-page-sales .sal-sales-table {
      width: 100%;
      font-size: 0.875rem;
    }
    #spa-page-sales .sal-sales-table th {
      background: #f9fafb;
      padding: 12px 8px;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
      white-space: nowrap;
    }
    #spa-page-sales .sal-sales-table td {
      padding: 12px 8px;
      border-bottom: 1px solid #f3f4f6;
      vertical-align: middle;
      white-space: nowrap;
    }
    #spa-page-sales .sal-sales-table tr:hover {
      background: #f9fafb;
    }

    /* 取引ステータスバッジ */
    #spa-page-sales .sal-status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      user-select: none;
    }
    #spa-page-sales .sal-status-badge:hover { opacity: 0.8; }
    #spa-page-sales .sal-status-paid { background: #d1fae5; color: #065f46; }
    #spa-page-sales .sal-status-unpaid { background: #fee2e2; color: #991b1b; }
    #spa-page-sales .sal-status-partial { background: #fef3c7; color: #92400e; }
    #spa-page-sales .sal-status-cancelled { background: #f3f4f6; color: #6b7280; }
    #spa-page-sales .sal-row-cancelled { opacity: 0.5; }
    #spa-page-sales .sal-row-cancelled td { text-decoration: line-through; }

    /* ローディング */
    #spa-page-sales .sal-loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    /* レスポンシブ */
    @media (max-width: 576px) {
      #spa-page-sales .sal-summary-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      #spa-page-sales .sal-sales-table {
        font-size: 0.75rem;
      }
      #spa-page-sales .sal-sales-table th, #spa-page-sales .sal-sales-table td {
        padding: 8px 4px;
      }
    }

    /* btn-check選択時の文字色修正 */
    #spa-page-sales .btn-check:checked + .btn-outline-primary,
    #spa-page-sales .btn-check:active + .btn-outline-primary {
      color: #fff !important;
      background-color: #3b82f6;
      border-color: #3b82f6;
    }

    /* 期間プリセットボタン */
    #spa-page-sales .sal-period-preset,
    #spa-page-sales .sal-analysis-period-preset,
    #spa-page-sales .sal-perf-period-preset {
      padding: 4px 10px;
      font-size: 0.75rem;
    }
    #spa-page-sales .sal-period-preset.active,
    #spa-page-sales .sal-analysis-period-preset.active,
    #spa-page-sales .sal-perf-period-preset.active {
      background-color: #3b82f6;
      border-color: #3b82f6;
      color: white;
    }

    /* パフォーマンステーブル */
    #spa-page-sales .sal-performance-table {
      min-width: 700px;
      font-size: 0.875rem;
      border-collapse: separate;
      border-spacing: 0;
    }
    #spa-page-sales .sal-performance-table th {
      background: #f9fafb;
      padding: 12px 10px;
      font-size: 0.8rem;
      font-weight: 600;
      color: #6b7280;
      border-bottom: 2px solid #e5e7eb;
      white-space: nowrap;
      text-align: center;
    }
    #spa-page-sales .sal-performance-table th:first-child {
      min-width: 120px;
      max-width: 150px;
      text-align: left;
      position: sticky;
      left: 0;
      z-index: 2;
      background: #f9fafb;
      box-shadow: 2px 0 4px rgba(0,0,0,0.1);
    }
    #spa-page-sales .sal-performance-table td {
      padding: 10px;
      border-bottom: 1px solid #f3f4f6;
      vertical-align: middle;
      text-align: center;
    }
    #spa-page-sales .sal-performance-table td:first-child {
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 150px;
      position: sticky;
      left: 0;
      z-index: 1;
      background: white;
      box-shadow: 2px 0 4px rgba(0,0,0,0.1);
    }
    #spa-page-sales .sal-performance-table tbody tr:hover td {
      background: #f0f9ff;
    }
    #spa-page-sales .sal-performance-table tbody tr:hover td:first-child {
      background: #f0f9ff;
    }
    #spa-page-sales .sal-performance-table tfoot td {
      background: #f0fdf4;
      font-weight: 600;
      border-top: 2px solid #e5e7eb;
    }
    #spa-page-sales .sal-performance-table tfoot td:first-child {
      background: #f0fdf4;
    }

    /* 消化率バー */
    #spa-page-sales .sal-consumption-bar {
      width: 50px;
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
      display: inline-block;
      vertical-align: middle;
      margin-right: 4px;
    }
    #spa-page-sales .sal-consumption-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #059669);
      border-radius: 3px;
    }

    /* 利益率カラーリング */
    #spa-page-sales .sal-profit-rate.high { color: #10b981; font-weight: 600; }
    #spa-page-sales .sal-profit-rate.medium { color: #f59e0b; }
    #spa-page-sales .sal-profit-rate.low { color: #ef4444; }

    /* サブヘッダー */
    #spa-page-sales .sal-sub-header {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 56px;
      padding: 0 16px;
      background: #ffffff;
      border-bottom: 1px solid #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    #spa-page-sales .sal-sub-header-back {
      position: absolute;
      left: 16px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 20px;
      transition: background 0.2s;
    }
    #spa-page-sales .sal-sub-header-back:hover { background: #f2f2f2; }
    #spa-page-sales .sal-sub-header-back:active { background: #e5e5e5; }
    #spa-page-sales .sal-sub-header-title {
      font-weight: 600;
      font-size: 16px;
      color: #1f2937;
    }
    #spa-page-sales .sal-sub-header-icons {
      position: absolute;
      right: 16px;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    #spa-page-sales .sal-sub-header-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 20px;
      transition: background 0.2s;
      position: relative;
    }
    #spa-page-sales .sal-sub-header-icon:hover { background: #f2f2f2; }
    #spa-page-sales .sal-sub-header-icon:active { background: #e5e5e5; }

    /* 設定ドロップダウン */
    #spa-page-sales .sal-settings-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 200px;
      padding: 8px 0;
      display: none;
      z-index: 1001;
    }
    #spa-page-sales .sal-settings-dropdown.active { display: block; }
    #spa-page-sales .sal-settings-dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border: none;
      background: none;
      width: 100%;
      font-size: 14px;
      color: #374151;
      cursor: pointer;
      text-align: left;
    }
    #spa-page-sales .sal-settings-dropdown-item:hover { background: #f3f4f6; }
    #spa-page-sales .sal-settings-dropdown-item i {
      font-size: 18px;
      color: #6b7280;
      width: 20px;
      text-align: center;
    }
    #spa-page-sales .sal-announce-dot {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      display: none;
    }
    #spa-page-sales .sal-announce-dot.visible { display: block; }

    /* タブコンテンツ表示制御 */
    #spa-page-sales .sal-tab-pane { display: none; }
    #spa-page-sales .sal-tab-pane.active { display: block; }

    /* モーダル */
    #spa-page-sales .sal-modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
    }
    #spa-page-sales .sal-modal-overlay.active {
      display: flex;
    }
    #spa-page-sales .sal-modal-dialog {
      background: white;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    #spa-page-sales .sal-modal-dialog.sal-modal-lg {
      max-width: 800px;
    }
    #spa-page-sales .sal-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
    }
    #spa-page-sales .sal-modal-title {
      font-weight: 600;
      font-size: 1.1rem;
      margin: 0;
    }
    #spa-page-sales .sal-modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #6b7280;
      line-height: 1;
    }
    #spa-page-sales .sal-modal-body { padding: 20px; }
    #spa-page-sales .sal-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      padding: 16px 20px;
      border-top: 1px solid #e5e7eb;
    }
  </style>

  <!-- ローディングオーバーレイ -->
  <div class="sal-loading-overlay" id="sal-loadingOverlay">
    <div class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted">データを読み込んでいます...</p>
    </div>
  </div>

  <!-- サブヘッダー -->
  <div class="sal-sub-header">
    <button class="sal-sub-header-back" onclick="spaGoBack()" title="戻る">
      <i class="bi bi-chevron-left"></i>
    </button>
    <span class="sal-sub-header-title">売上管理</span>
    <div class="sal-sub-header-icons">
      <button class="sal-sub-header-icon" title="通知" onclick="salOpenAnnouncePage()">
        <i class="bi bi-bell"></i>
        <span class="sal-announce-dot" id="sal-announceDot"></span>
      </button>
      <div style="position: relative;">
        <button class="sal-sub-header-icon" title="メニュー" onclick="salToggleSettingsDropdown(event)">
          <i class="bi bi-list"></i>
        </button>
        <div class="sal-settings-dropdown" id="sal-settingsDropdown">
          <button class="sal-settings-dropdown-item" onclick="salOpenInvoiceModal(); salCloseSettingsDropdown();">
            <i class="bi bi-file-text"></i>
            <span>請求書発行</span>
          </button>
          <button class="sal-settings-dropdown-item" onclick="salOpenExportModal(); salCloseSettingsDropdown();">
            <i class="bi bi-download"></i>
            <span>データエクスポート</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Material Tabs -->
  <div class="sal-material-tabs">
    <button class="sal-material-tab active" data-tab="sal-sales-content" onclick="salSwitchTab('sal-sales-content')">
      <i class="bi bi-currency-yen"></i> 売上一覧
    </button>
    <button class="sal-material-tab" data-tab="sal-ar-content" onclick="salSwitchTab('sal-ar-content')">
      <i class="bi bi-arrow-repeat"></i> 取引状況
    </button>
    <button class="sal-material-tab" data-tab="sal-analysis-content" onclick="salSwitchTab('sal-analysis-content')">
      <i class="bi bi-graph-up"></i> 売上分析
    </button>
    <button class="sal-material-tab" data-tab="sal-performance-content" onclick="salSwitchTab('sal-performance-content')">
      <i class="bi bi-bar-chart-line"></i> 軸分析
    </button>
  </div>

  <div class="sal-content-container">
    <!-- タブコンテンツ -->
    <div>
      <!-- 売上一覧タブ -->
      <div class="sal-tab-pane active" id="sal-sales-content">
        <div class="sal-filter-section">
          <div class="row g-2 mb-2">
            <div class="col-6">
              <label class="form-label mb-1 small fw-bold"><i class="bi bi-calendar3"></i> 期間</label>
              <select class="form-select form-select-sm" id="sal-salesPeriodSelect" onchange="salOnSalesPeriodChange()">
                <option value="today">今日</option>
                <option value="week">今週</option>
                <option value="month" selected>今月</option>
                <option value="lastMonth">先月</option>
                <option value="quarter">今四半期</option>
                <option value="year">今年</option>
                <option value="all">全期間</option>
              </select>
            </div>
            <div class="col-6">
              <label class="form-label mb-1 small fw-bold">販売先</label>
              <select class="form-select form-select-sm" id="sal-salesPlatformFilter" onchange="salLoadSalesData()">
                <option value="">すべて</option>
                <option value="メルカリ">メルカリ</option>
                <option value="メルカリShops">メルカリShops</option>
                <option value="ラクマ">ラクマ</option>
                <option value="Yahoo!フリマ">Yahoo!フリマ</option>
              </select>
            </div>
          </div>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label mb-1 small">開始日</label>
              <input type="date" class="form-control form-control-sm" id="sal-salesStartDate" onchange="salLoadSalesData()">
            </div>
            <div class="col-6">
              <label class="form-label mb-1 small">終了日</label>
              <input type="date" class="form-control form-control-sm" id="sal-salesEndDate" onchange="salLoadSalesData()">
            </div>
          </div>
        </div>

        <div class="sal-summary-grid">
          <div class="sal-summary-card">
            <div class="sal-summary-label">販売件数</div>
            <div class="sal-summary-value" id="sal-summary-count">-</div>
          </div>
          <div class="sal-summary-card">
            <div class="sal-summary-label">売上合計</div>
            <div class="sal-summary-value" id="sal-summary-sales">-</div>
          </div>
          <div class="sal-summary-card">
            <div class="sal-summary-label">利益合計</div>
            <div class="sal-summary-value positive" id="sal-summary-profit">-</div>
          </div>
          <div class="sal-summary-card">
            <div class="sal-summary-label">平均利益率</div>
            <div class="sal-summary-value" id="sal-summary-profitRate">-</div>
          </div>
        </div>

        <div class="sal-sales-table-container">
          <div class="table-responsive">
            <table class="sal-sales-table">
              <thead>
                <tr>
                  <th>販売日</th>
                  <th>管理番号</th>
                  <th>商品名</th>
                  <th>販売先</th>
                  <th class="text-end">売上</th>
                  <th class="text-end">利益</th>
                  <th>取引</th>
                </tr>
              </thead>
              <tbody id="sal-salesTableBody">
                <tr>
                  <td colspan="7" class="text-center text-muted py-4">データを読み込んでいます...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 取引状況タブ -->
      <div class="sal-tab-pane" id="sal-ar-content">
        <div class="sal-summary-grid">
          <div class="sal-summary-card">
            <div class="sal-summary-label">取引中 合計</div>
            <div class="sal-summary-value negative" id="sal-receivable-balance">-</div>
          </div>
          <div class="sal-summary-card">
            <div class="sal-summary-label">取引中</div>
            <div class="sal-summary-value" id="sal-receivable-count">-</div>
          </div>
        </div>

        <div class="alert alert-danger mb-3" id="sal-overdueAlert" style="display: none;">
          <i class="bi bi-exclamation-triangle-fill"></i>
          <strong>滞留アラート:</strong> <span id="sal-overdueAlertText"></span>
        </div>

        <div class="sal-sales-table-container">
          <div class="table-responsive">
            <table class="sal-sales-table">
              <thead>
                <tr>
                  <th>販売日</th>
                  <th>管理番号</th>
                  <th>商品名</th>
                  <th>販売先</th>
                  <th class="text-end">売上金額</th>
                  <th>経過日数</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="sal-receivableTableBody">
                <tr>
                  <td colspan="7" class="text-center text-muted py-4">データを読み込んでいます...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 分析タブ -->
      <div class="sal-tab-pane" id="sal-analysis-content">
        <div class="sal-filter-section mb-3">
          <div class="row g-2 mb-2">
            <div class="col-12">
              <label class="form-label mb-1 small fw-bold"><i class="bi bi-calendar3"></i> 期間</label>
              <select class="form-select form-select-sm" id="sal-analysisPeriodSelect" onchange="salOnAnalysisPeriodChange()">
                <option value="month">今月</option>
                <option value="lastMonth">先月</option>
                <option value="year">今年</option>
                <option value="all">全期間</option>
              </select>
            </div>
          </div>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label mb-1 small">開始日</label>
              <input type="date" class="form-control form-control-sm" id="sal-analysisStartDate" onchange="salLoadAnalysisWithPreset()">
            </div>
            <div class="col-6">
              <label class="form-label mb-1 small">終了日</label>
              <input type="date" class="form-control form-control-sm" id="sal-analysisEndDate" onchange="salLoadAnalysisWithPreset()">
            </div>
          </div>
        </div>

        <!-- 売上KPIサマリー -->
        <div class="sal-sales-table-container mb-3">
          <h6 class="mb-2 text-primary"><i class="bi bi-cash-stack"></i> 売上実績</h6>
          <div class="sal-summary-grid">
            <div class="sal-summary-card">
              <div class="sal-summary-label">累計売上高</div>
              <div class="sal-summary-value" id="sal-analysis-revenue">-</div>
            </div>
            <div class="sal-summary-card">
              <div class="sal-summary-label">累計利益額</div>
              <div class="sal-summary-value positive" id="sal-analysis-profit">-</div>
            </div>
            <div class="sal-summary-card">
              <div class="sal-summary-label">利益率</div>
              <div class="sal-summary-value" id="sal-analysis-profit-rate">-</div>
            </div>
            <div class="sal-summary-card">
              <div class="sal-summary-label">累計販売数</div>
              <div class="sal-summary-value" id="sal-analysis-count">-</div>
            </div>
          </div>
        </div>

        <!-- 在庫KPIサマリー -->
        <div class="sal-sales-table-container mb-3">
          <h6 class="mb-2 text-success"><i class="bi bi-box-seam"></i> 在庫状況（現在）</h6>
          <div class="sal-summary-grid">
            <div class="sal-summary-card">
              <div class="sal-summary-label">総出品数</div>
              <div class="sal-summary-value" id="sal-analysis-listing-count">-</div>
            </div>
            <div class="sal-summary-card">
              <div class="sal-summary-label">総在庫数</div>
              <div class="sal-summary-value" id="sal-analysis-stock-count">-</div>
            </div>
            <div class="sal-summary-card">
              <div class="sal-summary-label">総在庫金額</div>
              <div class="sal-summary-value" id="sal-analysis-stock-value">-</div>
            </div>
            <div class="sal-summary-card">
              <div class="sal-summary-label">平均単価</div>
              <div class="sal-summary-value" id="sal-analysis-avg-price">-</div>
            </div>
          </div>
        </div>

        <!-- パフォーマンス指標 -->
        <div class="sal-sales-table-container mb-3">
          <h6 class="mb-2 text-info"><i class="bi bi-speedometer2"></i> パフォーマンス指標</h6>
          <div class="sal-summary-grid">
            <div class="sal-summary-card">
              <div class="sal-summary-label">GMROI</div>
              <div class="sal-summary-value" id="sal-analysis-gmroi">-</div>
              <div class="small text-muted">目安: 2.5以上</div>
            </div>
            <div class="sal-summary-card">
              <div class="sal-summary-label">セルスルーレート</div>
              <div class="sal-summary-value" id="sal-analysis-sell-through">-</div>
              <div class="small text-muted">目安: 60-80%</div>
            </div>
            <div class="sal-summary-card">
              <div class="sal-summary-label">平均ROI</div>
              <div class="sal-summary-value" id="sal-analysis-avg-roi">-</div>
              <div class="small text-muted">目安: 30-50%</div>
            </div>
            <div class="sal-summary-card">
              <div class="sal-summary-label">在庫回転率</div>
              <div class="sal-summary-value" id="sal-analysis-turnover">-</div>
              <div class="small text-muted">目安: 年4-6回</div>
            </div>
          </div>
        </div>

        <!-- 滞留在庫アラート -->
        <div class="sal-sales-table-container mb-3">
          <h6 class="mb-2 text-warning"><i class="bi bi-exclamation-triangle"></i> 滞留在庫アラート</h6>
          <div class="row g-2">
            <div class="col-4">
              <div class="alert alert-success mb-0 py-2 text-center">
                <div class="small">2週間以内</div>
                <div class="fw-bold" id="sal-aging-2w-count">-件</div>
                <div class="small" id="sal-aging-2w-value">&#165;-</div>
              </div>
            </div>
            <div class="col-4">
              <div class="alert alert-warning mb-0 py-2 text-center">
                <div class="small">2-4週間</div>
                <div class="fw-bold" id="sal-aging-4w-count">-件</div>
                <div class="small" id="sal-aging-4w-value">&#165;-</div>
              </div>
            </div>
            <div class="col-4">
              <div class="alert alert-danger mb-0 py-2 text-center">
                <div class="small">4週間超過</div>
                <div class="fw-bold" id="sal-aging-6w-count">-件</div>
                <div class="small" id="sal-aging-6w-value">&#165;-</div>
              </div>
            </div>
          </div>
        </div>

        <!-- 売上推移グラフ -->
        <div class="sal-sales-table-container mb-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0"><i class="bi bi-graph-up"></i> <span id="sal-chartTitle">売上推移</span></h6>
            <select class="form-select form-select-sm" id="sal-analysisDisplaySelect" onchange="salLoadAnalysisWithPreset()" style="width: auto;">
              <option value="daily">日別</option>
              <option value="monthly" selected>月別</option>
            </select>
          </div>
          <div style="height: 250px; position: relative;">
            <canvas id="sal-monthlyChart"></canvas>
          </div>
        </div>

        <!-- 販売先別ランキング -->
        <div class="sal-sales-table-container mb-3">
          <h6 class="mb-3"><i class="bi bi-trophy"></i> 販売先別売上</h6>
          <div class="table-responsive">
            <table class="sal-sales-table">
              <thead>
                <tr>
                  <th>販売先</th>
                  <th class="text-end">販売数</th>
                  <th class="text-end">売上</th>
                  <th class="text-end">利益</th>
                </tr>
              </thead>
              <tbody id="sal-platformRankingBody">
                <tr>
                  <td colspan="4" class="text-center text-muted py-3">データを読み込んでいます...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 商品ランキング -->
        <div class="sal-sales-table-container">
          <h6 class="mb-3"><i class="bi bi-star"></i> 売上TOP10商品</h6>
          <div class="table-responsive">
            <table class="sal-sales-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>商品名</th>
                  <th class="text-end">売上</th>
                  <th class="text-end">利益</th>
                </tr>
              </thead>
              <tbody id="sal-productRankingBody">
                <tr>
                  <td colspan="4" class="text-center text-muted py-3">データを読み込んでいます...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 軸分析タブ -->
      <div class="sal-tab-pane" id="sal-performance-content">
        <div class="sal-filter-section mb-3">
          <div class="row g-2 mb-2">
            <div class="col-6">
              <label class="form-label mb-1 small fw-bold">分析軸</label>
              <select class="form-select form-select-sm" id="sal-performanceAxis" onchange="salLoadPerformanceData()">
                <option value="brand">ブランド別</option>
                <option value="categoryMajor">大カテゴリ別</option>
                <option value="categoryMiddle">中カテゴリ別</option>
                <option value="itemName">アイテム名別</option>
                <option value="condition">状態別</option>
                <option value="size">サイズ別</option>
                <option value="salePlatform">販売先別</option>
                <option value="priceRange">価格帯別</option>
              </select>
            </div>
            <div class="col-6">
              <label class="form-label mb-1 small fw-bold">並び順</label>
              <select class="form-select form-select-sm" id="sal-performanceSortKey" onchange="salSortPerformanceData()">
                <option value="profit-desc">総利益（高い順）</option>
                <option value="profit-asc">総利益（低い順）</option>
                <option value="profitRate-desc">利益率（高い順）</option>
                <option value="profitRate-asc">利益率（低い順）</option>
                <option value="consumption-desc">消化率（高い順）</option>
                <option value="consumption-asc">消化率（低い順）</option>
                <option value="days-asc">在庫日数（短い順）</option>
                <option value="days-desc">在庫日数（長い順）</option>
              </select>
            </div>
          </div>
          <div class="row g-2 mb-2">
            <div class="col-12">
              <label class="form-label mb-1 small fw-bold"><i class="bi bi-calendar3"></i> 期間</label>
              <select class="form-select form-select-sm" id="sal-perfPeriodSelect" onchange="salOnPerfPeriodChange()">
                <option value="month" selected>今月</option>
                <option value="lastMonth">先月</option>
                <option value="year">今年</option>
                <option value="all">全期間</option>
              </select>
            </div>
          </div>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label mb-1 small">開始日</label>
              <input type="date" class="form-control form-control-sm" id="sal-perfStartDate" onchange="salLoadPerformanceData()">
            </div>
            <div class="col-6">
              <label class="form-label mb-1 small">終了日</label>
              <input type="date" class="form-control form-control-sm" id="sal-perfEndDate" onchange="salLoadPerformanceData()">
            </div>
          </div>
        </div>

        <div class="sal-sales-table-container">
          <div class="table-responsive">
            <table class="sal-performance-table" id="sal-performanceTable">
              <thead>
                <tr>
                  <th style="text-align:left">項目名</th>
                  <th>仕入数</th>
                  <th>販売数</th>
                  <th>消化率</th>
                  <th>総売上</th>
                  <th>売上シェア</th>
                  <th>総利益</th>
                  <th>利益率</th>
                  <th>ROI</th>
                  <th>在庫日</th>
                </tr>
              </thead>
              <tbody id="sal-performanceBody">
                <tr>
                  <td colspan="10" class="text-center text-muted py-4">
                    <i class="bi bi-hourglass-split"></i> タブを選択するとデータを読み込みます
                  </td>
                </tr>
              </tbody>
              <tfoot id="sal-performanceFoot"></tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- キャンセルモーダル -->
  <div class="sal-modal-overlay" id="sal-cancelModalOverlay">
    <div class="sal-modal-dialog">
      <div class="sal-modal-header">
        <h5 class="sal-modal-title">取引キャンセル</h5>
        <button type="button" class="sal-modal-close" onclick="salCloseModal('sal-cancelModalOverlay')">&times;</button>
      </div>
      <div class="sal-modal-body">
        <div class="mb-3">
          <label class="form-label">管理番号</label>
          <input type="text" class="form-control" id="sal-cancelManagementNumber" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label">キャンセル理由</label>
          <input type="text" class="form-control" id="sal-cancelReason" placeholder="例: 購入者都合、商品不良、配送破損等">
        </div>
        <div class="mb-3">
          <label class="form-label">発生費用（任意）</label>
          <div class="input-group">
            <span class="input-group-text">&#165;</span>
            <input type="number" class="form-control" id="sal-cancelCost" placeholder="例: 返送料 800" min="0">
          </div>
          <div class="form-text">返送料など発生した費用があれば入力</div>
        </div>
      </div>
      <div class="sal-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="salCloseModal('sal-cancelModalOverlay')">閉じる</button>
        <button type="button" class="btn btn-danger" onclick="salSaveCancellation()">キャンセルを記録</button>
      </div>
    </div>
  </div>

  <!-- 帳簿出力モーダル -->
  <div class="sal-modal-overlay" id="sal-exportModalOverlay">
    <div class="sal-modal-dialog">
      <div class="sal-modal-header">
        <h5 class="sal-modal-title"><i class="bi bi-download"></i> データエクスポート</h5>
        <button type="button" class="sal-modal-close" onclick="salCloseModal('sal-exportModalOverlay')">&times;</button>
      </div>
      <div class="sal-modal-body">
        <div class="mb-3">
          <label class="form-label fw-bold">出力形式</label>
          <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="sal-exportFormat" id="sal-formatCSV" value="csv" checked>
            <label class="btn btn-outline-primary" for="sal-formatCSV">CSV</label>
            <input type="radio" class="btn-check" name="sal-exportFormat" id="sal-formatExcel" value="excel">
            <label class="btn btn-outline-primary" for="sal-formatExcel">Excel形式</label>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">出力期間</label>
          <select class="form-select" id="sal-exportPeriod" onchange="salUpdateExportDates()">
            <option value="month">今月</option>
            <option value="quarter">今四半期</option>
            <option value="year">今年度</option>
            <option value="custom">カスタム</option>
          </select>
        </div>
        <div class="row g-2 mb-3" id="sal-exportDateRange">
          <div class="col-6">
            <label class="form-label">開始日</label>
            <input type="date" class="form-control" id="sal-exportStartDate">
          </div>
          <div class="col-6">
            <label class="form-label">終了日</label>
            <input type="date" class="form-control" id="sal-exportEndDate">
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold text-primary"><i class="bi bi-currency-yen"></i> 売上・取引データ</label>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="sal-exportSalesDetail" checked>
            <label class="form-check-label" for="sal-exportSalesDetail">
              売上明細 <small class="text-muted">（販売日、商品名、金額、利益など）</small>
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="sal-exportReceivable">
            <label class="form-check-label" for="sal-exportReceivable">
              取引中一覧 <small class="text-muted">（未完了の取引）</small>
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="sal-exportPaymentHistory">
            <label class="form-check-label" for="sal-exportPaymentHistory">
              取引完了一覧 <small class="text-muted">（完了済みの取引）</small>
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="sal-exportSummary">
            <label class="form-check-label" for="sal-exportSummary">
              月別サマリー <small class="text-muted">（月ごとの集計表）</small>
            </label>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold text-success"><i class="bi bi-bar-chart-line"></i> 分析データ</label>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="sal-exportAxisAnalysis" onchange="salToggleAxisSelect()">
            <label class="form-check-label" for="sal-exportAxisAnalysis">
              軸分析データ <small class="text-muted">（パフォーマンス分析結果）</small>
            </label>
          </div>
          <div id="sal-axisSelectContainer" class="ms-4 mt-2" style="display: none;">
            <select class="form-select form-select-sm" id="sal-exportAxisType" style="max-width: 200px;">
              <option value="brand">ブランド別</option>
              <option value="categoryMajor">大カテゴリ別</option>
              <option value="categoryMiddle">中カテゴリ別</option>
              <option value="itemName">アイテム名別</option>
              <option value="condition">状態別</option>
              <option value="size">サイズ別</option>
              <option value="salePlatform">販売先別</option>
            </select>
          </div>
        </div>
        <div class="alert alert-light small mb-0 border">
          <i class="bi bi-lightbulb text-warning"></i>
          <strong>確定申告用：</strong>期間を「今年度」、売上明細と月別サマリーを選択
        </div>
      </div>
      <div class="sal-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="salCloseModal('sal-exportModalOverlay')">キャンセル</button>
        <button type="button" class="btn btn-primary" onclick="salExportData()">
          <i class="bi bi-download"></i> ダウンロード
        </button>
      </div>
    </div>
  </div>

  <!-- 請求書発行モーダル -->
  <div class="sal-modal-overlay" id="sal-invoiceModalOverlay">
    <div class="sal-modal-dialog sal-modal-lg">
      <div class="sal-modal-header">
        <h5 class="sal-modal-title">請求書発行</h5>
        <button type="button" class="sal-modal-close" onclick="salCloseModal('sal-invoiceModalOverlay')">&times;</button>
      </div>
      <div class="sal-modal-body">
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label fw-bold">請求先</label>
            <input type="text" class="form-control" id="sal-invoiceCustomer" placeholder="請求先名を入力">
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold">請求日</label>
            <input type="date" class="form-control" id="sal-invoiceDate">
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label fw-bold">支払期限</label>
            <input type="date" class="form-control" id="sal-invoiceDueDate">
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold">請求番号</label>
            <input type="text" class="form-control" id="sal-invoiceNumber" placeholder="自動生成">
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">請求明細</label>
          <div class="table-responsive">
            <table class="table table-sm table-bordered" id="sal-invoiceItemsTable">
              <thead class="table-light">
                <tr>
                  <th>商品名</th>
                  <th class="text-end" style="width: 80px;">数量</th>
                  <th class="text-end" style="width: 120px;">単価</th>
                  <th class="text-end" style="width: 120px;">金額</th>
                  <th style="width: 40px;"></th>
                </tr>
              </thead>
              <tbody id="sal-invoiceItemsBody"></tbody>
              <tfoot>
                <tr>
                  <td colspan="5">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="salAddInvoiceItem()">
                      <i class="bi bi-plus"></i> 行を追加
                    </button>
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label">小計</label>
            <div class="input-group">
              <span class="input-group-text">&#165;</span>
              <input type="text" class="form-control text-end" id="sal-invoiceSubtotal" readonly>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label">消費税（10%）</label>
            <div class="input-group">
              <span class="input-group-text">&#165;</span>
              <input type="text" class="form-control text-end" id="sal-invoiceTax" readonly>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-bold">合計金額</label>
            <div class="input-group">
              <span class="input-group-text">&#165;</span>
              <input type="text" class="form-control text-end fw-bold" id="sal-invoiceTotal" readonly>
            </div>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">備考</label>
          <textarea class="form-control" id="sal-invoiceNote" rows="2" placeholder="振込先情報など"></textarea>
        </div>
      </div>
      <div class="sal-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="salCloseModal('sal-invoiceModalOverlay')">キャンセル</button>
        <button type="button" class="btn btn-outline-primary" onclick="salPreviewInvoice()">
          <i class="bi bi-eye"></i> プレビュー
        </button>
        <button type="button" class="btn btn-primary" onclick="salDownloadInvoicePDF()">
          <i class="bi bi-download"></i> PDF出力
        </button>
      </div>
    </div>
  </div>

  <!-- 請求書プレビューモーダル -->
  <div class="sal-modal-overlay" id="sal-invoicePreviewModalOverlay">
    <div class="sal-modal-dialog sal-modal-lg" style="max-height: 90vh; overflow-y: auto;">
      <div class="sal-modal-header">
        <h5 class="sal-modal-title">請求書プレビュー</h5>
        <button type="button" class="sal-modal-close" onclick="salCloseModal('sal-invoicePreviewModalOverlay')">&times;</button>
      </div>
      <div class="sal-modal-body" style="padding: 0;">
        <div id="sal-invoicePreviewContent" style="background: white; padding: 40px;"></div>
      </div>
      <div class="sal-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="salCloseModal('sal-invoicePreviewModalOverlay')">閉じる</button>
        <button type="button" class="btn btn-primary" onclick="salDownloadInvoicePDF()">
          <i class="bi bi-download"></i> PDF出力
        </button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // SPA Fragment: sales.html
    // All functions prefixed: sal
    // All globals prefixed: _sal_
    // ============================================

    var _sal_currentSalesData = [];
    var _sal_selectedProductForCancel = null;
    var _sal_currentPeriodPreset = 'month';
    var _sal_currentInvoiceData = null;
    var _sal_monthlyChart = null;
    var _sal_allSalesDataForAnalysis = [];
    var _sal_allProductsForAnalysis = [];
    var _sal_analysisDataLoaded = false;
    var _sal_analysisPeriodPreset = 'month';
    var _sal_currentPerformanceData = [];
    var _sal_performanceDataLoaded = false;
    var _sal_perfPeriodPreset = 'all';
    var _sal_dropdownClickHandler = null;
    var _sal_tabClickHandlers = [];

    // ============================================
    // Dynamic script loading helper
    // ============================================
    function _salLoadScript(src) {
      return new Promise(function(resolve, reject) {
        var existing = document.querySelector('script[src="' + src + '"]');
        if (existing) { resolve(); return; }
        var script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    // ============================================
    // Utility functions
    // ============================================
    function salGetJSTToday() {
      var now = new Date();
      var jst = new Date(now.getTime() + (9 * 60 + now.getTimezoneOffset()) * 60000);
      var year = jst.getFullYear();
      var month = String(jst.getMonth() + 1).padStart(2, '0');
      var day = String(jst.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }

    function salGetJSTMonth() {
      var now = new Date();
      var jst = new Date(now.getTime() + (9 * 60 + now.getTimezoneOffset()) * 60000);
      var year = jst.getFullYear();
      var month = String(jst.getMonth() + 1).padStart(2, '0');
      return year + '-' + month;
    }

    function salFormatDateLocal(date) {
      var year = date.getFullYear();
      var month = String(date.getMonth() + 1).padStart(2, '0');
      var day = String(date.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }

    function salShowLoading() {
      var el = document.getElementById('sal-loadingOverlay');
      if (el) el.style.display = 'flex';
    }
    function salHideLoading() {
      var el = document.getElementById('sal-loadingOverlay');
      if (el) el.style.display = 'none';
    }

    function salFormatCurrency(amount) {
      if (amount === null || amount === undefined || isNaN(amount)) return '-';
      return '\u00a5' + Math.round(amount).toLocaleString();
    }

    function salFormatPercent(value) {
      if (value === null || value === undefined || isNaN(value)) return '-';
      return value.toFixed(1) + '%';
    }

    function salEscapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    // ============================================
    // Modal helpers (replacing Bootstrap modals)
    // ============================================
    function salOpenModal(id) {
      var el = document.getElementById(id);
      if (el) el.classList.add('active');
    }
    function salCloseModal(id) {
      var el = document.getElementById(id);
      if (el) el.classList.remove('active');
    }

    // ============================================
    // Tab switching (replacing Bootstrap tabs)
    // ============================================
    function salSwitchTab(targetId) {
      var container = document.getElementById('spa-page-sales');
      if (!container) return;
      // Deactivate all tabs and panes
      container.querySelectorAll('.sal-material-tab').forEach(function(el) { el.classList.remove('active'); });
      container.querySelectorAll('.sal-tab-pane').forEach(function(el) { el.classList.remove('active'); });

      // Activate clicked tab
      var btn = container.querySelector('.sal-material-tab[data-tab="' + targetId + '"]');
      if (btn) btn.classList.add('active');
      var targetPane = document.getElementById(targetId);
      if (targetPane) targetPane.classList.add('active');

      // Trigger data loading for specific tabs
      if (targetId === 'sal-analysis-content') {
        salLoadAnalysisData();
      } else if (targetId === 'sal-performance-content') {
        if (!_sal_performanceDataLoaded) {
          salOnPerfPeriodChange();
        }
      }
    }

    // (salSwitchArSub removed - sub-tabs no longer needed)

    // ============================================
    // Firebase API (using parent globals)
    // ============================================
    function salGetSalesData(startDate, endDate, platform) {
      return new Promise(function(resolve, reject) {
        console.log('[Sal SPA] データ取得開始:', startDate, '~', endDate, platform);

        var db = window.firebaseDB;
        var collection = window.firestoreCollection;
        var getDocs = window.firestoreGetDocs;

        if (!db || !collection || !getDocs) {
          reject(new Error('Firebase未初期化'));
          return;
        }

        var productsRef = collection(db, 'products');
        getDocs(productsRef).then(function(snapshot) {
          var salesList = [];

          snapshot.forEach(function(docSnapshot) {
            var data = docSnapshot.data();
            if (data.status !== '販売済') return;

            var saleDate = data.saleDate || '';
            var salePlatform = data.salePlatform || '';

            if (startDate && saleDate < startDate) return;
            if (endDate && saleDate > endDate) return;
            if (platform && salePlatform !== platform) return;

            salesList.push({
              id: docSnapshot.id,
              managementNumber: data.managementNumber || '',
              productName: data.productName || '',
              saleDate: saleDate,
              salePlatform: salePlatform,
              saleAmount: parseFloat(data.saleAmount || 0),
              finalProfit: parseFloat(data.finalProfit || 0),
              profitRate: parseFloat(data.profitRate || 0),
              paymentStatus: data.paymentStatus || 'unpaid',
              paymentDate: data.paymentDate || '',
              paymentAmount: parseFloat(data.paymentAmount || 0),
              purchasePrice: parseFloat(data.purchasePrice || data.costPrice || 0),
              purchaseAmount: parseFloat(data.purchase && data.purchase.amount || data.purchaseAmount || 0),
              brand: data.brand,
              categoryMajor: data.category && data.category.major || '',
              categoryMiddle: data.category && data.category.middle || '',
              itemName: data.itemName || '',
              condition: data.condition,
              size: data.size,
              listingDate: data.listing && data.listing.date || data.listingDate || '',
              salesPrice: parseFloat(data.saleAmount || 0),
              cancelReason: data.cancelReason || '',
              cancelCost: parseFloat(data.cancelCost || 0)
            });
          });

          salesList.sort(function(a, b) { return (b.saleDate || '').localeCompare(a.saleDate || ''); });
          console.log('[Sal SPA] 取得完了:', salesList.length + '件');
          resolve(salesList);
        }).catch(reject);
      });
    }

    function salUpdatePaymentStatus(productId, paymentData) {
      var db = window.firebaseDB;
      var docFn = window.firestoreDoc;
      var updateDoc = window.firestoreUpdateDoc;
      var serverTimestamp = window.firestoreServerTimestamp;

      var productRef = docFn(db, 'products', productId);
      var updateFields = {
        paymentStatus: paymentData.status,
        updatedAt: serverTimestamp()
      };
      if (paymentData.cancelReason !== undefined) updateFields.cancelReason = paymentData.cancelReason;
      if (paymentData.cancelCost !== undefined) updateFields.cancelCost = paymentData.cancelCost;
      return updateDoc(productRef, updateFields);
    }

    // ============================================
    // Date range calculations
    // ============================================
    function salCalculateDateRange(preset) {
      var now = new Date();
      var today = salGetJSTToday();
      var startDate = '';
      var endDate = today;

      switch (preset) {
        case 'today': startDate = today; break;
        case 'week':
          var weekStart = new Date(now);
          weekStart.setDate(now.getDate() - now.getDay());
          startDate = salFormatDateLocal(weekStart);
          break;
        case 'month': startDate = salGetJSTMonth() + '-01'; break;
        case 'lastMonth':
          var lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
          var lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
          startDate = salFormatDateLocal(lastMonth);
          endDate = salFormatDateLocal(lastMonthEnd);
          break;
        case 'quarter':
          var quarterMonth = Math.floor(now.getMonth() / 3) * 3;
          var quarterStart = new Date(now.getFullYear(), quarterMonth, 1);
          startDate = salFormatDateLocal(quarterStart);
          break;
        case 'year': startDate = now.getFullYear() + '-01-01'; break;
        case 'all': startDate = ''; endDate = ''; break;
        case 'custom':
          startDate = document.getElementById('sal-salesStartDate').value || '';
          endDate = document.getElementById('sal-salesEndDate').value || '';
          break;
      }
      return { startDate: startDate, endDate: endDate };
    }

    function salGetPeriodDisplayText(preset, startDate, endDate) {
      var formatDate = function(d) {
        if (!d) return '';
        var parts = d.split('-');
        return parts[0] + '/' + parts[1] + '/' + parts[2];
      };
      switch (preset) {
        case 'today': return '今日';
        case 'week': return '今週';
        case 'month': return '今月';
        case 'lastMonth': return '先月';
        case 'quarter': return '今四半期';
        case 'year': return '今年';
        case 'all': return '全期間';
        case 'custom':
          if (startDate && endDate) return formatDate(startDate) + ' 〜 ' + formatDate(endDate);
          if (startDate) return formatDate(startDate) + ' 〜';
          if (endDate) return '〜 ' + formatDate(endDate);
          return 'カスタム';
        default: return '';
      }
    }

    // ============================================
    // Sales list tab
    // ============================================
    function salOnSalesPeriodChange() {
      var period = document.getElementById('sal-salesPeriodSelect').value;
      _sal_currentPeriodPreset = period;
      var range = salCalculateDateRange(period);
      document.getElementById('sal-salesStartDate').value = range.startDate;
      document.getElementById('sal-salesEndDate').value = range.endDate;
      salLoadSalesData();
    }

    function salLoadSalesData() {
      salShowLoading();
      var startDate = document.getElementById('sal-salesStartDate').value || '';
      var endDate = document.getElementById('sal-salesEndDate').value || '';
      var platform = document.getElementById('sal-salesPlatformFilter').value;

      salGetSalesData(startDate, endDate, platform).then(function(data) {
        _sal_currentSalesData = data;
        salRenderSalesTable();
        salRenderReceivableTable();
        salUpdateSummary();
      }).catch(function(error) {
        console.error('[Sal SPA] 売上データ読み込みエラー:', error);
        alert('データの読み込みに失敗しました: ' + error.message);
      }).finally(function() {
        salHideLoading();
      });
    }

    function salRenderSalesTable() {
      var tbody = document.getElementById('sal-salesTableBody');
      if (!tbody) return;

      if (_sal_currentSalesData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">該当する売上データがありません</td></tr>';
        return;
      }

      var html = '';
      _sal_currentSalesData.forEach(function(item) {
        var paymentBadge = salGetPaymentBadge(item.paymentStatus, item.id);
        var isCancelled = item.paymentStatus === 'cancelled';
        var rowClass = isCancelled ? 'sal-row-cancelled' : '';
        html += '<tr class="' + rowClass + '">' +
          '<td>' + (item.saleDate || '-') + '</td>' +
          '<td>' + item.managementNumber + '</td>' +
          '<td style="white-space: nowrap;">' + salEscapeHtml(item.productName) + '</td>' +
          '<td>' + (item.salePlatform || '-') + '</td>' +
          '<td class="text-end">' + salFormatCurrency(item.saleAmount) + '</td>' +
          '<td class="text-end ' + (item.finalProfit >= 0 ? 'text-success' : 'text-danger') + '">' + salFormatCurrency(item.finalProfit) + '</td>' +
          '<td>' + paymentBadge + '</td>' +
          '</tr>';
      });
      tbody.innerHTML = html;
    }

    function salGetPaymentBadge(status, productId) {
      if (productId) {
        switch (status) {
          case 'paid':
            return '<span class="sal-status-badge sal-status-paid" onclick="salOnBadgeClick(\'' + productId + '\', \'paid\')">取引完了</span>';
          case 'cancelled':
            return '<span class="sal-status-badge sal-status-cancelled" onclick="salOnBadgeClick(\'' + productId + '\', \'cancelled\')">キャンセル</span>';
          case 'partial':
          default:
            return '<span class="sal-status-badge sal-status-unpaid" onclick="salOnBadgeClick(\'' + productId + '\', \'unpaid\')">取引中</span>';
        }
      }
      switch (status) {
        case 'paid': return '<span class="sal-status-badge sal-status-paid">取引完了</span>';
        case 'cancelled': return '<span class="sal-status-badge sal-status-cancelled">キャンセル</span>';
        case 'partial':
        default: return '<span class="sal-status-badge sal-status-unpaid">取引中</span>';
      }
    }

    function salGetPaymentStatusText(status) {
      switch (status) {
        case 'paid': return '取引完了';
        case 'cancelled': return 'キャンセル';
        case 'partial':
        default: return '取引中';
      }
    }

    // バッジタップ時の処理
    function salOnBadgeClick(productId, currentStatus) {
      if (currentStatus === 'unpaid' || currentStatus === 'partial') {
        // 取引中 → 選択肢: 取引完了 or キャンセル
        var choice = prompt('操作を選択してください:\n1 = 取引完了\n2 = キャンセル\n\n番号を入力:');
        if (choice === '1') {
          salCompleteTransaction(productId);
        } else if (choice === '2') {
          salOpenCancelModal(productId);
        }
      } else if (currentStatus === 'paid' || currentStatus === 'cancelled') {
        // 取引完了/キャンセル → 取引中に戻す
        salRevertTransaction(productId);
      }
    }

    // 取引完了（ワンタップ）
    function salCompleteTransaction(productId) {
      if (!confirm('取引完了にしますか？')) return;
      salShowLoading();
      salUpdatePaymentStatus(productId, { status: 'paid' }).then(function() {
        salLoadSalesData();
      }).catch(function(error) {
        console.error('[Sal SPA] 取引完了エラー:', error);
        alert('更新に失敗しました: ' + error.message);
      }).finally(function() { salHideLoading(); });
    }

    // 取引中に戻す（ワンタップ）
    function salRevertTransaction(productId) {
      if (!confirm('取引中に戻しますか？')) return;
      salShowLoading();
      salUpdatePaymentStatus(productId, { status: 'unpaid', cancelReason: '', cancelCost: 0 }).then(function() {
        salLoadSalesData();
      }).catch(function(error) {
        console.error('[Sal SPA] 取引戻しエラー:', error);
        alert('更新に失敗しました: ' + error.message);
      }).finally(function() { salHideLoading(); });
    }

    // キャンセルモーダルを開く
    function salOpenCancelModal(productId) {
      var item = _sal_currentSalesData.find(function(d) { return d.id === productId; });
      _sal_selectedProductForCancel = { id: productId, managementNumber: item ? item.managementNumber : '' };
      document.getElementById('sal-cancelManagementNumber').value = _sal_selectedProductForCancel.managementNumber;
      document.getElementById('sal-cancelReason').value = '';
      document.getElementById('sal-cancelCost').value = '';
      salOpenModal('sal-cancelModalOverlay');
    }

    // キャンセル保存
    function salSaveCancellation() {
      if (!_sal_selectedProductForCancel) return;
      var reason = document.getElementById('sal-cancelReason').value.trim();
      if (!reason) { alert('キャンセル理由を入力してください'); return; }
      var cost = parseFloat(document.getElementById('sal-cancelCost').value) || 0;

      salShowLoading();
      salUpdatePaymentStatus(_sal_selectedProductForCancel.id, {
        status: 'cancelled', cancelReason: reason, cancelCost: cost
      }).then(function() {
        salCloseModal('sal-cancelModalOverlay');
        alert('キャンセルを記録しました');
        salLoadSalesData();
      }).catch(function(error) {
        console.error('[Sal SPA] キャンセル記録エラー:', error);
        alert('キャンセルの記録に失敗しました: ' + error.message);
      }).finally(function() { salHideLoading(); });
    }

    function salUpdateSummary() {
      var activeData = _sal_currentSalesData.filter(function(item) { return item.paymentStatus !== 'cancelled'; });
      var count = activeData.length;
      var totalSales = activeData.reduce(function(sum, item) { return sum + item.saleAmount; }, 0);
      var totalProfit = activeData.reduce(function(sum, item) { return sum + item.finalProfit; }, 0);
      var avgProfitRate = count > 0 ? activeData.reduce(function(sum, item) { return sum + item.profitRate; }, 0) / count : 0;

      document.getElementById('sal-summary-count').textContent = count + '件';
      document.getElementById('sal-summary-sales').textContent = salFormatCurrency(totalSales);
      document.getElementById('sal-summary-profit').textContent = salFormatCurrency(totalProfit);
      document.getElementById('sal-summary-profitRate').textContent = salFormatPercent(avgProfitRate);
    }

    // ============================================
    // Receivable tab
    // ============================================
    function salRenderReceivableTable() {
      var tbody = document.getElementById('sal-receivableTableBody');
      if (!tbody) return;

      // 取引中の商品 = unpaid または partial（cancelledとpaidは除外）
      var unpaidItems = _sal_currentSalesData.filter(function(item) {
        return item.paymentStatus !== 'paid' && item.paymentStatus !== 'cancelled';
      });

      if (unpaidItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">取引中の商品はありません</td></tr>';
        salUpdateReceivableSummary(0, 0);
        var alertDiv = document.getElementById('sal-overdueAlert');
        if (alertDiv) alertDiv.style.display = 'none';
        return;
      }

      var html = '';
      var totalUnpaid = 0;
      var overdueCount = 0;
      var overdueAmount = 0;
      var OVERDUE_DAYS = 14;

      unpaidItems.forEach(function(item) {
        totalUnpaid += item.saleAmount;

        var daysPassed = item.saleDate ? Math.floor((new Date() - new Date(item.saleDate)) / (1000 * 60 * 60 * 24)) : 0;
        var isOverdue = daysPassed >= OVERDUE_DAYS;
        if (isOverdue) { overdueCount++; overdueAmount += item.saleAmount; }

        var daysClass = isOverdue ? 'text-danger fw-bold' : (daysPassed >= 7 ? 'text-warning' : '');

        html += '<tr class="' + (isOverdue ? 'table-danger' : '') + '">' +
          '<td>' + (item.saleDate || '-') + '</td>' +
          '<td>' + item.managementNumber + '</td>' +
          '<td style="white-space:nowrap;">' + salEscapeHtml(item.productName) + '</td>' +
          '<td>' + (item.salePlatform || '-') + '</td>' +
          '<td class="text-end">' + salFormatCurrency(item.saleAmount) + '</td>' +
          '<td class="' + daysClass + '">' + daysPassed + '日</td>' +
          '<td><span class="sal-status-badge sal-status-paid" style="cursor:pointer;" onclick="salCompleteTransaction(\'' + item.id + '\')">完了にする</span></td>' +
          '</tr>';
      });

      tbody.innerHTML = html;
      salUpdateReceivableSummary(totalUnpaid, unpaidItems.length);

      var alertDiv = document.getElementById('sal-overdueAlert');
      if (overdueCount > 0) {
        document.getElementById('sal-overdueAlertText').textContent =
          overdueCount + '件（' + salFormatCurrency(overdueAmount) + '）が' + OVERDUE_DAYS + '日以上経過しています。早急に確認してください。';
        alertDiv.style.display = 'block';
      } else {
        alertDiv.style.display = 'none';
      }
    }

    function salUpdateReceivableSummary(totalUnpaid, count) {
      document.getElementById('sal-receivable-balance').textContent = salFormatCurrency(totalUnpaid);
      document.getElementById('sal-receivable-count').textContent = count + '件';
    }

    // (Payment modal removed - replaced by badge tap workflow and cancel modal)

    // ============================================
    // Settings dropdown
    // ============================================
    function salToggleSettingsDropdown(event) {
      event.stopPropagation();
      var dropdown = document.getElementById('sal-settingsDropdown');
      dropdown.classList.toggle('active');
    }

    function salCloseSettingsDropdown() {
      var dropdown = document.getElementById('sal-settingsDropdown');
      if (dropdown) dropdown.classList.remove('active');
    }

    function salOpenAnnouncePage() {
      if (typeof spaNavigateTo === 'function') {
        spaNavigateTo('announce');
      }
    }

    // ============================================
    // Export modal
    // ============================================
    function salOpenExportModal() {
      salUpdateExportDates();
      salOpenModal('sal-exportModalOverlay');
    }

    function salUpdateExportDates() {
      var period = document.getElementById('sal-exportPeriod').value;
      var now = new Date();
      var startDate, endDate;

      switch (period) {
        case 'month':
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          break;
        case 'quarter':
          var quarter = Math.floor(now.getMonth() / 3);
          startDate = new Date(now.getFullYear(), quarter * 3, 1);
          endDate = new Date(now.getFullYear(), (quarter + 1) * 3, 0);
          break;
        case 'year':
          startDate = new Date(now.getFullYear(), 0, 1);
          endDate = new Date(now.getFullYear(), 11, 31);
          break;
        case 'custom': return;
      }
      document.getElementById('sal-exportStartDate').value = salFormatDateLocal(startDate);
      document.getElementById('sal-exportEndDate').value = salFormatDateLocal(endDate);
    }

    function salToggleAxisSelect() {
      var checkbox = document.getElementById('sal-exportAxisAnalysis');
      var container = document.getElementById('sal-axisSelectContainer');
      container.style.display = checkbox.checked ? 'block' : 'none';
    }

    function salExportData() {
      var format = document.querySelector('input[name="sal-exportFormat"]:checked').value;
      var startDate = document.getElementById('sal-exportStartDate').value;
      var endDate = document.getElementById('sal-exportEndDate').value;
      var includeSalesDetail = document.getElementById('sal-exportSalesDetail').checked;
      var includeReceivable = document.getElementById('sal-exportReceivable').checked;
      var includePaymentHistory = document.getElementById('sal-exportPaymentHistory').checked;
      var includeSummary = document.getElementById('sal-exportSummary').checked;
      var includeAxisAnalysis = document.getElementById('sal-exportAxisAnalysis').checked;
      var axisType = document.getElementById('sal-exportAxisType').value;

      if (!startDate || !endDate) { alert('出力期間を設定してください'); return; }
      if (!includeSalesDetail && !includeReceivable && !includePaymentHistory && !includeSummary && !includeAxisAnalysis) {
        alert('出力内容を1つ以上選択してください'); return;
      }

      salShowLoading();

      salGetSalesData(startDate, endDate, '').then(function(filteredData) {
        var csvContent = '';

        if (includeSalesDetail) {
          csvContent += '【売上明細】\n';
          csvContent += '販売日,管理番号,商品名,販売先,売上金額,原価,利益,利益率,取引ステータス\n';
          filteredData.forEach(function(item) {
            csvContent += [
              item.saleDate || '', item.managementNumber || '',
              '"' + (item.productName || '').replace(/"/g, '""') + '"',
              item.salePlatform || '', item.saleAmount || 0, item.purchaseAmount || 0,
              item.finalProfit || 0, (item.profitRate || 0).toFixed(1) + '%',
              salGetPaymentStatusText(item.paymentStatus)
            ].join(',') + '\n';
          });
          csvContent += '\n';
        }

        if (includeReceivable) {
          var receivables = filteredData.filter(function(item) { return item.paymentStatus !== 'paid' && item.paymentStatus !== 'cancelled'; });
          csvContent += '【取引中一覧】\n';
          csvContent += '販売日,管理番号,販売先,売上金額,経過日数\n';
          receivables.forEach(function(item) {
            var daysPassed = item.saleDate ? Math.floor((new Date() - new Date(item.saleDate)) / (1000 * 60 * 60 * 24)) : 0;
            csvContent += [
              item.saleDate || '', item.managementNumber || '', item.salePlatform || '',
              item.saleAmount || 0, daysPassed + '日'
            ].join(',') + '\n';
          });
          csvContent += '\n';
        }

        if (includeSummary) {
          var monthlySummary = {};
          filteredData.forEach(function(item) {
            var month = (item.saleDate || '').slice(0, 7);
            if (!month) return;
            if (!monthlySummary[month]) { monthlySummary[month] = { count: 0, sales: 0, cost: 0, profit: 0, received: 0 }; }
            monthlySummary[month].count++;
            monthlySummary[month].sales += item.saleAmount || 0;
            monthlySummary[month].cost += item.purchaseAmount || 0;
            monthlySummary[month].profit += item.finalProfit || 0;
            if (item.paymentStatus === 'paid') { monthlySummary[month].received += item.saleAmount; }
            else { monthlySummary[month].received += item.paymentAmount || 0; }
          });

          csvContent += '【月別集計（確定申告用）】\n';
          csvContent += '年月,販売件数,売上高,売上原価,売上総利益,利益率,取引完了額,取引中残高\n';

          var totalCount = 0, totalSales = 0, totalCost = 0, totalProfit = 0, totalReceived = 0;
          Object.keys(monthlySummary).sort().forEach(function(month) {
            var m = monthlySummary[month];
            var profitRate = m.sales > 0 ? (m.profit / m.sales * 100).toFixed(1) : '0.0';
            var receivable = m.sales - m.received;
            csvContent += [month, m.count, m.sales, m.cost, m.profit, profitRate + '%', m.received, receivable].join(',') + '\n';
            totalCount += m.count; totalSales += m.sales; totalCost += m.cost; totalProfit += m.profit; totalReceived += m.received;
          });
          var totalProfitRate = totalSales > 0 ? (totalProfit / totalSales * 100).toFixed(1) : '0.0';
          csvContent += ['【合計】', totalCount, totalSales, totalCost, totalProfit, totalProfitRate + '%', totalReceived, totalSales - totalReceived].join(',') + '\n';
        }

        if (includePaymentHistory) {
          var completedItems = filteredData.filter(function(item) { return item.paymentStatus === 'paid'; });
          csvContent += '【取引完了一覧】\n';
          csvContent += '販売日,管理番号,商品名,販売先,売上金額\n';
          completedItems.forEach(function(item) {
            csvContent += [
              item.saleDate || '', item.managementNumber || '',
              '"' + (item.productName || '').replace(/"/g, '""') + '"',
              item.salePlatform || '', item.saleAmount || 0
            ].join(',') + '\n';
          });
          csvContent += '\n';
        }

        if (includeAxisAnalysis) {
          var axisLabels = { brand: 'ブランド別', categoryMajor: '大カテゴリ別', categoryMiddle: '中カテゴリ別',
            itemName: 'アイテム名別', condition: '状態別', size: 'サイズ別', salePlatform: '販売先別' };
          csvContent += '【軸分析データ - ' + (axisLabels[axisType] || axisType) + '】\n';
          csvContent += '項目名,仕入数,販売数,消化率,総売上,総利益,平均利益率,平均在庫日数\n';

          var axisData = {};
          filteredData.forEach(function(item) {
            var key = '';
            switch (axisType) {
              case 'brand': key = (item.brand && (item.brand.nameEn || item.brand.nameKana)) || '不明'; break;
              case 'categoryMajor': key = item.categoryMajor || '不明'; break;
              case 'categoryMiddle': key = item.categoryMiddle || '不明'; break;
              case 'itemName': key = item.itemName || '不明'; break;
              case 'condition': key = (item.condition && item.condition.display) || item.condition || '不明'; break;
              case 'size': key = (item.size && item.size.display) || item.size || '不明'; break;
              case 'salePlatform': key = item.salePlatform || '不明'; break;
              default: key = '不明';
            }
            if (!axisData[key]) { axisData[key] = { purchaseCount: 0, salesCount: 0, totalSales: 0, totalProfit: 0, totalDays: 0 }; }
            axisData[key].purchaseCount++;
            if (item.saleDate) {
              axisData[key].salesCount++;
              axisData[key].totalSales += item.saleAmount || 0;
              axisData[key].totalProfit += item.finalProfit || 0;
              if (item.listingDate && item.saleDate) {
                var days = Math.floor((new Date(item.saleDate) - new Date(item.listingDate)) / (1000 * 60 * 60 * 24));
                axisData[key].totalDays += days;
              }
            }
          });

          Object.keys(axisData).sort(function(a, b) { return axisData[b].totalProfit - axisData[a].totalProfit; }).forEach(function(key) {
            var d = axisData[key];
            var sellThrough = d.purchaseCount > 0 ? (d.salesCount / d.purchaseCount * 100).toFixed(1) : '0.0';
            var avgProfitRate = d.totalSales > 0 ? (d.totalProfit / d.totalSales * 100).toFixed(1) : '0.0';
            var avgDays = d.salesCount > 0 ? Math.round(d.totalDays / d.salesCount) : '-';
            csvContent += ['"' + key.replace(/"/g, '""') + '"', d.purchaseCount, d.salesCount, sellThrough + '%', d.totalSales, d.totalProfit, avgProfitRate + '%', avgDays].join(',') + '\n';
          });
          csvContent += '\n';
        }

        var fileName = 'REBORN_データエクスポート_' + startDate + '_' + endDate + '.csv';
        var bom = '\uFEFF';
        var blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
        var link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.click();

        salCloseModal('sal-exportModalOverlay');
        alert('ダウンロードが完了しました');
      }).catch(function(error) {
        console.error('[Sal SPA] 出力エラー:', error);
        alert('出力に失敗しました: ' + error.message);
      }).finally(function() {
        salHideLoading();
      });
    }

    // ============================================
    // Invoice functions
    // ============================================
    function salOpenInvoiceModal(items) {
      items = items || [];
      _sal_currentInvoiceData = items;

      var todayStr = salGetJSTToday();
      document.getElementById('sal-invoiceDate').value = todayStr;

      var today = new Date();
      var dueDate = new Date(today);
      dueDate.setDate(dueDate.getDate() + 30);
      document.getElementById('sal-invoiceDueDate').value = salFormatDateLocal(dueDate);

      var invoiceNumber = 'INV-' + todayStr.replace(/-/g, '') + '-' + String(Math.floor(Math.random() * 1000)).padStart(3, '0');
      document.getElementById('sal-invoiceNumber').value = invoiceNumber;

      var tbody = document.getElementById('sal-invoiceItemsBody');
      tbody.innerHTML = '';

      if (items.length > 0) {
        items.forEach(function(item) { salAddInvoiceItemRow(item.productName || '', 1, item.salesPrice || 0); });
        if (items[0].platform) { document.getElementById('sal-invoiceCustomer').value = items[0].platform + ' 御中'; }
      } else {
        salAddInvoiceItemRow('', 1, 0);
      }

      salUpdateInvoiceTotals();
      salOpenModal('sal-invoiceModalOverlay');
    }

    function salAddInvoiceItem() { salAddInvoiceItemRow('', 1, 0); }

    function salAddInvoiceItemRow(name, quantity, unitPrice) {
      var tbody = document.getElementById('sal-invoiceItemsBody');
      var amount = quantity * unitPrice;
      var row = document.createElement('tr');
      row.innerHTML =
        '<td><input type="text" class="form-control form-control-sm" value="' + salEscapeHtml(name) + '" onchange="salUpdateInvoiceTotals()"></td>' +
        '<td><input type="number" class="form-control form-control-sm text-end" value="' + quantity + '" min="1" onchange="salUpdateInvoiceTotals()"></td>' +
        '<td><input type="number" class="form-control form-control-sm text-end" value="' + unitPrice + '" min="0" onchange="salUpdateInvoiceTotals()"></td>' +
        '<td class="text-end">' + amount.toLocaleString() + '</td>' +
        '<td><button type="button" class="btn btn-sm btn-outline-danger" onclick="salRemoveInvoiceItem(this)"><i class="bi bi-trash"></i></button></td>';
      tbody.appendChild(row);
    }

    function salRemoveInvoiceItem(btn) {
      var row = btn.closest('tr');
      row.remove();
      salUpdateInvoiceTotals();
    }

    function salUpdateInvoiceTotals() {
      var tbody = document.getElementById('sal-invoiceItemsBody');
      var rows = tbody.querySelectorAll('tr');
      var subtotal = 0;

      rows.forEach(function(row) {
        var inputs = row.querySelectorAll('input[type="number"]');
        var quantity = parseInt(inputs[0] && inputs[0].value) || 0;
        var unitPrice = parseInt(inputs[1] && inputs[1].value) || 0;
        var amount = quantity * unitPrice;
        subtotal += amount;
        var amountCell = row.querySelector('td:nth-child(4)');
        if (amountCell) amountCell.textContent = amount.toLocaleString();
      });

      var tax = Math.floor(subtotal * 0.1);
      var total = subtotal + tax;
      document.getElementById('sal-invoiceSubtotal').value = subtotal.toLocaleString();
      document.getElementById('sal-invoiceTax').value = tax.toLocaleString();
      document.getElementById('sal-invoiceTotal').value = total.toLocaleString();
    }

    function salGenerateInvoiceHtml() {
      var customer = document.getElementById('sal-invoiceCustomer').value || '御中';
      var invoiceDate = document.getElementById('sal-invoiceDate').value;
      var dueDate = document.getElementById('sal-invoiceDueDate').value;
      var invoiceNumber = document.getElementById('sal-invoiceNumber').value;
      var note = document.getElementById('sal-invoiceNote').value;
      var subtotal = document.getElementById('sal-invoiceSubtotal').value;
      var tax = document.getElementById('sal-invoiceTax').value;
      var total = document.getElementById('sal-invoiceTotal').value;

      var tbody = document.getElementById('sal-invoiceItemsBody');
      var rows = tbody.querySelectorAll('tr');
      var itemsHtml = '';
      rows.forEach(function(row, index) {
        var inputs = row.querySelectorAll('input');
        var name = inputs[0] && inputs[0].value || '';
        var quantity = inputs[1] && inputs[1].value || '0';
        var unitPrice = parseInt(inputs[2] && inputs[2].value) || 0;
        var amount = row.querySelector('td:nth-child(4)') && row.querySelector('td:nth-child(4)').textContent || '0';
        if (name) {
          itemsHtml += '<tr>' +
            '<td style="padding: 8px; border: 1px solid #ddd;">' + (index + 1) + '</td>' +
            '<td style="padding: 8px; border: 1px solid #ddd;">' + salEscapeHtml(name) + '</td>' +
            '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + quantity + '</td>' +
            '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">\u00a5' + unitPrice.toLocaleString() + '</td>' +
            '<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">\u00a5' + amount + '</td></tr>';
        }
      });

      var noteHtml = note ? '<div style="margin-bottom: 30px;"><p style="font-weight: bold; margin: 0 0 10px 0;">備考</p>' +
        '<div style="background: #f8f9fa; padding: 15px; border-radius: 4px; white-space: pre-wrap;">' + salEscapeHtml(note) + '</div></div>' : '';

      return '<div style="font-family: \'Helvetica Neue\', Arial, sans-serif; max-width: 800px; margin: 0 auto; color: #333;">' +
        '<div style="text-align: center; margin-bottom: 30px;"><h1 style="font-size: 28px; font-weight: bold; margin: 0; letter-spacing: 8px;">請 求 書</h1></div>' +
        '<div style="display: flex; justify-content: space-between; margin-bottom: 30px;">' +
          '<div><p style="font-size: 18px; font-weight: bold; margin: 0 0 5px 0; border-bottom: 2px solid #333; padding-bottom: 5px;">' + salEscapeHtml(customer) + '</p>' +
          '<p style="margin: 10px 0 0 0; font-size: 14px;">下記の通りご請求申し上げます。</p></div>' +
          '<div style="text-align: right; font-size: 14px;"><p style="margin: 0;">請求日: ' + invoiceDate + '</p>' +
          '<p style="margin: 5px 0;">請求番号: ' + invoiceNumber + '</p><p style="margin: 5px 0;">支払期限: ' + dueDate + '</p></div></div>' +
        '<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; text-align: center;">' +
          '<p style="margin: 0 0 5px 0; font-size: 14px; color: #666;">ご請求金額</p>' +
          '<p style="margin: 0; font-size: 32px; font-weight: bold;">\u00a5' + total + '</p>' +
          '<p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">（税込）</p></div>' +
        '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">' +
          '<thead><tr style="background: #f8f9fa;">' +
          '<th style="padding: 10px; border: 1px solid #ddd; text-align: center; width: 40px;">No</th>' +
          '<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">品名</th>' +
          '<th style="padding: 10px; border: 1px solid #ddd; text-align: right; width: 80px;">数量</th>' +
          '<th style="padding: 10px; border: 1px solid #ddd; text-align: right; width: 100px;">単価</th>' +
          '<th style="padding: 10px; border: 1px solid #ddd; text-align: right; width: 120px;">金額</th></tr></thead>' +
          '<tbody>' + itemsHtml + '</tbody></table>' +
        '<div style="display: flex; justify-content: flex-end; margin-bottom: 30px;">' +
          '<table style="border-collapse: collapse; width: 300px;">' +
          '<tr><td style="padding: 8px; text-align: right;">小計</td><td style="padding: 8px; text-align: right; width: 120px;">\u00a5' + subtotal + '</td></tr>' +
          '<tr><td style="padding: 8px; text-align: right;">消費税（10%）</td><td style="padding: 8px; text-align: right;">\u00a5' + tax + '</td></tr>' +
          '<tr style="font-weight: bold; font-size: 16px; border-top: 2px solid #333;">' +
          '<td style="padding: 8px; text-align: right;">合計</td><td style="padding: 8px; text-align: right;">\u00a5' + total + '</td></tr></table></div>' +
        noteHtml +
        '<div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: right;">' +
          '<p style="font-weight: bold; margin: 0 0 10px 0;">発行者</p><p style="margin: 0;">フリラ</p>' +
          '<p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">Furira</p></div></div>';
    }

    function salPreviewInvoice() {
      var invoiceHtml = salGenerateInvoiceHtml();
      document.getElementById('sal-invoicePreviewContent').innerHTML = invoiceHtml;
      salCloseModal('sal-invoiceModalOverlay');
      setTimeout(function() { salOpenModal('sal-invoicePreviewModalOverlay'); }, 300);
    }

    function salDownloadInvoicePDF() {
      salShowLoading();
      try {
        var invoiceHtml = salGenerateInvoiceHtml();
        var previewContent = document.getElementById('sal-invoicePreviewContent');
        previewContent.innerHTML = invoiceHtml;
        previewContent.style.display = 'block';

        html2canvas(previewContent, { scale: 2, useCORS: true, logging: false, backgroundColor: '#ffffff' }).then(function(canvas) {
          var jsPDFLib = window.jspdf;
          var pdf = new jsPDFLib.jsPDF('p', 'mm', 'a4');
          var imgData = canvas.toDataURL('image/png');
          var pdfWidth = pdf.internal.pageSize.getWidth();
          var pdfHeight = (canvas.height * pdfWidth) / canvas.width;
          pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

          var invoiceNumber = document.getElementById('sal-invoiceNumber').value;
          var customer = document.getElementById('sal-invoiceCustomer').value.replace(/\s/g, '_');
          pdf.save('請求書_' + invoiceNumber + '_' + customer + '.pdf');

          alert('請求書PDFをダウンロードしました');
          salCloseModal('sal-invoicePreviewModalOverlay');
          salCloseModal('sal-invoiceModalOverlay');
        }).catch(function(error) {
          console.error('[Sal SPA] PDF出力エラー:', error);
          alert('PDF出力に失敗しました: ' + error.message);
        }).finally(function() {
          salHideLoading();
        });
      } catch (error) {
        console.error('[Sal SPA] PDF出力エラー:', error);
        alert('PDF出力に失敗しました: ' + error.message);
        salHideLoading();
      }
    }

    // ============================================
    // Analysis tab
    // ============================================
    function salCalculateAnalysisDateRange(preset) {
      var now = new Date();
      var today = salGetJSTToday();
      var startDate = '';
      var endDate = today;

      switch (preset) {
        case 'today': startDate = today; break;
        case 'week':
          var weekStart = new Date(now);
          weekStart.setDate(now.getDate() - now.getDay());
          startDate = salFormatDateLocal(weekStart);
          break;
        case 'month': startDate = salGetJSTMonth() + '-01'; break;
        case 'lastMonth':
          var lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
          var lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
          startDate = salFormatDateLocal(lastMonth);
          endDate = salFormatDateLocal(lastMonthEnd);
          break;
        case 'quarter':
          var quarterMonth = Math.floor(now.getMonth() / 3) * 3;
          var quarterStart = new Date(now.getFullYear(), quarterMonth, 1);
          startDate = salFormatDateLocal(quarterStart);
          break;
        case 'year': startDate = now.getFullYear() + '-01-01'; break;
        case 'all': startDate = ''; endDate = ''; break;
        case 'custom':
          startDate = document.getElementById('sal-analysisStartDate').value || '';
          endDate = document.getElementById('sal-analysisEndDate').value || '';
          break;
      }
      return { startDate: startDate, endDate: endDate };
    }

    function salOnAnalysisPeriodChange() {
      var preset = document.getElementById('sal-analysisPeriodSelect').value;
      _sal_analysisPeriodPreset = preset;
      var now = new Date();
      var startDate, endDate;

      switch (preset) {
        case 'month':
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0); break;
        case 'lastMonth':
          startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
          endDate = new Date(now.getFullYear(), now.getMonth(), 0); break;
        case 'year':
          startDate = new Date(now.getFullYear(), 0, 1);
          endDate = new Date(now.getFullYear(), 11, 31); break;
        case 'all': default:
          startDate = new Date(2025, 0, 1);
          endDate = now;
      }
      document.getElementById('sal-analysisStartDate').value = salFormatDateLocal(startDate);
      document.getElementById('sal-analysisEndDate').value = salFormatDateLocal(endDate);
      salRenderAnalysisTab();
    }

    function salInitAnalysisPeriodPresets() {
      var monthStart = salGetJSTMonth() + '-01';
      document.getElementById('sal-analysisStartDate').value = monthStart;
      document.getElementById('sal-analysisEndDate').value = salGetJSTToday();
    }

    function salLoadAnalysisWithPreset() { salRenderAnalysisTab(); }

    function salLoadAnalysisData() {
      if (_sal_analysisDataLoaded) { salRenderAnalysisTab(); return; }
      salShowLoading();

      var p1 = salGetSalesData('', '', '');
      var p2 = window.db.collection('products').get();

      Promise.all([p1, p2]).then(function(results) {
        _sal_allSalesDataForAnalysis = results[0];
        _sal_allProductsForAnalysis = [];
        results[1].forEach(function(doc) {
          _sal_allProductsForAnalysis.push(Object.assign({ id: doc.id }, doc.data()));
        });
        _sal_analysisDataLoaded = true;
        salRenderAnalysisTab();
      }).catch(function(error) {
        console.error('[Sal SPA] 分析データ読み込みエラー:', error);
      }).finally(function() { salHideLoading(); });
    }

    function salGetFilteredSalesData() {
      var range = salCalculateAnalysisDateRange(_sal_analysisPeriodPreset);
      if (_sal_analysisPeriodPreset === 'all') return _sal_allSalesDataForAnalysis;
      return _sal_allSalesDataForAnalysis.filter(function(item) {
        var saleDate = item.saleDate || '';
        if (!saleDate) return false;
        if (range.startDate && saleDate < range.startDate) return false;
        if (range.endDate && saleDate > range.endDate) return false;
        return true;
      });
    }

    function salRenderAnalysisTab() {
      var data = salGetFilteredSalesData();
      var totalRevenue = data.reduce(function(sum, item) { return sum + (item.saleAmount || 0); }, 0);
      var totalProfit = data.reduce(function(sum, item) { return sum + (item.finalProfit || 0); }, 0);
      var profitRate = totalRevenue > 0 ? (totalProfit / totalRevenue * 100) : 0;

      document.getElementById('sal-analysis-revenue').textContent = salFormatCurrency(totalRevenue);
      document.getElementById('sal-analysis-profit').textContent = salFormatCurrency(totalProfit);
      document.getElementById('sal-analysis-profit-rate').textContent = salFormatPercent(profitRate);
      document.getElementById('sal-analysis-count').textContent = data.length + '件';

      salRenderInventoryKPI();
      salRenderPerformanceMetrics(data);
      salRenderAgingAlert();
      salRenderSalesChart(data);
      salRenderPlatformRanking(data);
      salRenderProductRanking(data);
    }

    function salRenderInventoryKPI() {
      var products = _sal_allProductsForAnalysis;
      var activeProducts = products.filter(function(p) {
        return p.status === 'active' || p.status === '出品中' || (p.quantity > 0 && p.status !== 'sold');
      });
      var listingCount = activeProducts.length;
      var totalStock = products.reduce(function(sum, p) { return sum + (parseInt(p.quantity) || 0); }, 0);
      var totalStockValue = products.reduce(function(sum, p) {
        var qty = parseInt(p.quantity) || 0;
        var cost = parseFloat(p.purchasePrice) || parseFloat(p.costPrice) || 0;
        return sum + (qty * cost);
      }, 0);
      var avgPrice = totalStock > 0 ? totalStockValue / totalStock : 0;

      document.getElementById('sal-analysis-listing-count').textContent = listingCount + '件';
      document.getElementById('sal-analysis-stock-count').textContent = totalStock + '点';
      document.getElementById('sal-analysis-stock-value').textContent = salFormatCurrency(totalStockValue);
      document.getElementById('sal-analysis-avg-price').textContent = salFormatCurrency(avgPrice);
    }

    function salRenderPerformanceMetrics(salesData) {
      var products = _sal_allProductsForAnalysis;
      var range = salCalculateAnalysisDateRange(_sal_analysisPeriodPreset);
      var startDate = range.startDate;
      var endDate = range.endDate;

      var totalProfit = salesData.reduce(function(sum, item) { return sum + (item.finalProfit || 0); }, 0);
      var avgInventoryCost = products.reduce(function(sum, p) {
        var qty = parseInt(p.quantity) || 0;
        var cost = parseFloat(p.purchasePrice) || parseFloat(p.costPrice) || 0;
        return sum + (qty * cost);
      }, 0);
      var gmroi = avgInventoryCost > 0 ? (totalProfit / avgInventoryCost) : 0;

      var soldCount = salesData.length;
      var purchasedInPeriod = products.filter(function(p) {
        var purchaseDate = (p.purchase && p.purchase.date) || p.purchaseDate || '';
        return purchaseDate >= startDate && purchaseDate <= endDate;
      }).length;
      var currentStock = products.filter(function(p) { return p.status !== 'sold' && p.status !== '販売済'; }).length;
      var estimatedStartingStock = currentStock + soldCount - purchasedInPeriod;
      var sellThroughDenominator = Math.max(1, estimatedStartingStock + purchasedInPeriod);
      var sellThroughRate = (soldCount / sellThroughDenominator) * 100;

      var totalCost = salesData.reduce(function(sum, item) {
        return sum + (parseFloat(item.purchasePrice) || 0);
      }, 0);
      var avgRoi = totalCost > 0 ? (totalProfit / totalCost * 100) : 0;

      var cogs = totalCost;
      var start = new Date(startDate);
      var end = new Date(endDate);
      var periodDays = Math.max(1, Math.ceil((end - start) / (1000 * 60 * 60 * 24)));
      var annualFactor = 365 / periodDays;
      var turnoverRate = avgInventoryCost > 0 ? ((cogs / avgInventoryCost) * annualFactor) : 0;

      var gmroiEl = document.getElementById('sal-analysis-gmroi');
      gmroiEl.textContent = gmroi.toFixed(2);
      gmroiEl.className = 'sal-summary-value ' + (gmroi >= 2.5 ? 'positive' : gmroi >= 1.5 ? '' : 'negative');

      var sellThroughEl = document.getElementById('sal-analysis-sell-through');
      sellThroughEl.textContent = sellThroughRate.toFixed(1) + '%';
      sellThroughEl.className = 'sal-summary-value ' + (sellThroughRate >= 60 ? 'positive' : sellThroughRate >= 40 ? '' : 'negative');

      var roiEl = document.getElementById('sal-analysis-avg-roi');
      roiEl.textContent = avgRoi.toFixed(1) + '%';
      roiEl.className = 'sal-summary-value ' + (avgRoi >= 50 ? 'positive' : avgRoi >= 30 ? '' : 'negative');

      var turnoverEl = document.getElementById('sal-analysis-turnover');
      turnoverEl.textContent = turnoverRate.toFixed(1) + '回/年';
      turnoverEl.className = 'sal-summary-value ' + (turnoverRate >= 4 ? 'positive' : turnoverRate >= 2 ? '' : 'negative');
    }

    function salRenderAgingAlert() {
      var products = _sal_allProductsForAnalysis;
      var today = new Date();
      var activeProducts = products.filter(function(p) {
        return (p.status === 'active' || p.status === '出品中') ||
          (p.quantity > 0 && p.status !== 'sold' && p.status !== '販売済');
      });

      var aging = { under2w: { count: 0, value: 0 }, w2to4: { count: 0, value: 0 }, over4w: { count: 0, value: 0 } };
      activeProducts.forEach(function(p) {
        var listingDate = (p.listing && p.listing.date) || p.listingDate || (p.purchase && p.purchase.date) || p.purchaseDate || '';
        var cost = parseFloat(p.purchasePrice) || parseFloat(p.costPrice) || 0;
        if (!listingDate) { aging.over4w.count++; aging.over4w.value += cost; return; }
        var listedDate = new Date(listingDate);
        var daysSinceListing = Math.floor((today - listedDate) / (1000 * 60 * 60 * 24));
        if (daysSinceListing <= 14) { aging.under2w.count++; aging.under2w.value += cost; }
        else if (daysSinceListing <= 28) { aging.w2to4.count++; aging.w2to4.value += cost; }
        else { aging.over4w.count++; aging.over4w.value += cost; }
      });

      document.getElementById('sal-aging-2w-count').textContent = aging.under2w.count + '件';
      document.getElementById('sal-aging-2w-value').textContent = salFormatCurrency(aging.under2w.value);
      document.getElementById('sal-aging-4w-count').textContent = aging.w2to4.count + '件';
      document.getElementById('sal-aging-4w-value').textContent = salFormatCurrency(aging.w2to4.value);
      document.getElementById('sal-aging-6w-count').textContent = aging.over4w.count + '件';
      document.getElementById('sal-aging-6w-value').textContent = salFormatCurrency(aging.over4w.value);
    }

    function salRenderSalesChart(data) {
      var displaySelect = document.getElementById('sal-analysisDisplaySelect');
      var displayMode = displaySelect ? displaySelect.value : 'monthly';
      var chartTitle = document.getElementById('sal-chartTitle');
      if (displayMode === 'monthly') {
        chartTitle.textContent = '月別売上推移';
        salRenderMonthlyChart(data);
      } else {
        chartTitle.textContent = '日別売上推移';
        salRenderDailyChart(data);
      }
    }

    function salRenderMonthlyChart(data) {
      var monthlyData = {};
      data.forEach(function(item) {
        var month = (item.saleDate || '').slice(0, 7);
        if (!month) return;
        if (!monthlyData[month]) { monthlyData[month] = { sales: 0, profit: 0 }; }
        monthlyData[month].sales += item.saleAmount || 0;
        monthlyData[month].profit += item.finalProfit || 0;
      });
      var months = Object.keys(monthlyData).sort().slice(-12);
      var salesArr = months.map(function(m) { return monthlyData[m] ? monthlyData[m].sales : 0; });
      var profitArr = months.map(function(m) { return monthlyData[m] ? monthlyData[m].profit : 0; });
      var labels = months.map(function(m) { var p = m.split('-'); return p[0] + '/' + p[1]; });
      salRenderChart(labels, salesArr, profitArr);
    }

    function salRenderDailyChart(data) {
      var dailyData = {};
      data.forEach(function(item) {
        var date = item.saleDate || '';
        if (!date) return;
        if (!dailyData[date]) { dailyData[date] = { sales: 0, profit: 0 }; }
        dailyData[date].sales += item.saleAmount || 0;
        dailyData[date].profit += item.finalProfit || 0;
      });
      var dates = Object.keys(dailyData).sort().slice(-31);
      var salesArr = dates.map(function(d) { return dailyData[d] ? dailyData[d].sales : 0; });
      var profitArr = dates.map(function(d) { return dailyData[d] ? dailyData[d].profit : 0; });
      var labels = dates.map(function(d) { var p = d.split('-'); return p[1] + '/' + p[2]; });
      salRenderChart(labels, salesArr, profitArr);
    }

    function salRenderChart(labels, salesData, profitData) {
      if (_sal_monthlyChart) { _sal_monthlyChart.destroy(); _sal_monthlyChart = null; }

      var canvas = document.getElementById('sal-monthlyChart');
      if (!canvas) return;
      if (typeof Chart === 'undefined') { console.warn('[Sal SPA] Chart.js not loaded yet'); return; }

      var ctx = canvas.getContext('2d');
      _sal_monthlyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            { label: '売上', data: salesData, backgroundColor: 'rgba(59, 130, 246, 0.7)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1 },
            { label: '利益', data: profitData, backgroundColor: 'rgba(16, 185, 129, 0.7)', borderColor: 'rgba(16, 185, 129, 1)', borderWidth: 1 }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { position: 'top' } },
          scales: { y: { beginAtZero: true, ticks: { callback: function(value) { return '\u00a5' + value.toLocaleString(); } } } }
        }
      });
    }

    function salRenderPlatformRanking(data) {
      var platformStats = {};
      data.forEach(function(item) {
        var platform = item.salePlatform || '未設定';
        if (!platformStats[platform]) { platformStats[platform] = { count: 0, sales: 0, profit: 0 }; }
        platformStats[platform].count++;
        platformStats[platform].sales += item.saleAmount || 0;
        platformStats[platform].profit += item.finalProfit || 0;
      });
      var sorted = Object.entries(platformStats).sort(function(a, b) { return b[1].sales - a[1].sales; });
      var tbody = document.getElementById('sal-platformRankingBody');
      if (sorted.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">データがありません</td></tr>'; return; }
      var html = '';
      sorted.forEach(function(entry) {
        var platform = entry[0]; var stats = entry[1];
        html += '<tr><td>' + platform + '</td><td class="text-end">' + stats.count + '件</td>' +
          '<td class="text-end">' + salFormatCurrency(stats.sales) + '</td>' +
          '<td class="text-end ' + (stats.profit >= 0 ? 'text-success' : 'text-danger') + '">' + salFormatCurrency(stats.profit) + '</td></tr>';
      });
      tbody.innerHTML = html;
    }

    function salRenderProductRanking(data) {
      var sorted = data.slice().filter(function(item) { return item.saleAmount > 0; })
        .sort(function(a, b) { return (b.saleAmount || 0) - (a.saleAmount || 0); }).slice(0, 10);
      var tbody = document.getElementById('sal-productRankingBody');
      if (sorted.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">データがありません</td></tr>'; return; }
      var html = '';
      sorted.forEach(function(item, index) {
        html += '<tr><td>' + (index + 1) + '</td>' +
          '<td style="white-space: nowrap;">' + salEscapeHtml(item.productName || '-') + '</td>' +
          '<td class="text-end">' + salFormatCurrency(item.saleAmount) + '</td>' +
          '<td class="text-end ' + (item.finalProfit >= 0 ? 'text-success' : 'text-danger') + '">' + salFormatCurrency(item.finalProfit) + '</td></tr>';
      });
      tbody.innerHTML = html;
    }

    // ============================================
    // Performance (axis analysis) tab
    // ============================================
    function salCalculatePerformanceByAxis(startDate, endDate, axis) {
      return new Promise(function(resolve, reject) {
        console.log('[Sal SPA] 軸分析開始:', axis, startDate, '〜', endDate);

        var db = window.firebaseDB;
        var collection = window.firestoreCollection;
        var getDocs = window.firestoreGetDocs;
        if (!db || !collection || !getDocs) { reject(new Error('Firestore未初期化')); return; }

        var productsRef = collection(db, 'products');
        getDocs(productsRef).then(function(snapshot) {
          var axisData = {};

          function getAxisValue(data, axis) {
            switch (axis) {
              case 'brand': return (data.brand && (data.brand.nameEn || data.brand.nameKana)) || '(未設定)';
              case 'categoryMajor': return (data.category && data.category.major) || '(未設定)';
              case 'categoryMiddle': return (data.category && data.category.middle) || '(未設定)';
              case 'itemName': return data.itemName || '(未設定)';
              case 'condition': return (data.condition && data.condition.display) || data.condition || '(未設定)';
              case 'size': return (data.size && data.size.display) || data.size || '(未設定)';
              case 'salePlatform': return data.salePlatform || '(未販売)';
              case 'priceRange':
                var price = parseFloat(data.saleAmount || (data.listing && data.listing.amount) || 0);
                if (price === 0) return '(未設定)';
                if (price < 3000) return '〜3,000円';
                if (price < 5000) return '3,000〜5,000円';
                if (price < 10000) return '5,000〜10,000円';
                if (price < 20000) return '10,000〜20,000円';
                if (price < 50000) return '20,000〜50,000円';
                return '50,000円〜';
              default: return '(不明)';
            }
          }

          snapshot.forEach(function(doc) {
            var data = doc.data();
            var key = getAxisValue(data, axis);
            if (!axisData[key]) {
              axisData[key] = { name: key, purchaseCount: 0, purchaseAmount: 0, salesCount: 0, salesAmount: 0, finalProfit: 0, totalDays: 0 };
            }
            var purchaseDate = (data.purchase && data.purchase.date) || data.purchaseDate || '';
            if (purchaseDate >= startDate && purchaseDate <= endDate) {
              axisData[key].purchaseCount++;
              axisData[key].purchaseAmount += parseFloat((data.purchase && data.purchase.amount) || data.purchaseAmount || 0);
            }
            var saleDate = data.saleDate || '';
            if (saleDate >= startDate && saleDate <= endDate) {
              axisData[key].salesCount++;
              axisData[key].salesAmount += parseFloat(data.saleAmount || 0);
              axisData[key].finalProfit += parseFloat(data.finalProfit || 0);
              var listingDate = (data.listing && data.listing.date) || data.listingDate || '';
              if (listingDate && saleDate) {
                var days = Math.floor((new Date(saleDate) - new Date(listingDate)) / (1000 * 60 * 60 * 24));
                if (days >= 0) axisData[key].totalDays += days;
              }
            }
          });

          var totalSalesAmount = Object.values(axisData).reduce(function(sum, item) { return sum + item.salesAmount; }, 0);
          var result = Object.values(axisData).map(function(item) {
            return {
              name: item.name,
              purchaseCount: item.purchaseCount,
              salesCount: item.salesCount,
              consumptionRate: item.purchaseCount > 0 ? (item.salesCount / item.purchaseCount) * 100 : 0,
              salesAmount: item.salesAmount,
              salesShare: totalSalesAmount > 0 ? (item.salesAmount / totalSalesAmount) * 100 : 0,
              finalProfit: item.finalProfit,
              profitRate: item.salesAmount > 0 ? (item.finalProfit / item.salesAmount) * 100 : 0,
              roi: item.purchaseAmount > 0 ? (item.finalProfit / item.purchaseAmount) * 100 : 0,
              avgDays: item.salesCount > 0 ? Math.round(item.totalDays / item.salesCount) : 0
            };
          });
          resolve(result);
        }).catch(reject);
      });
    }

    function salOnPerfPeriodChange() {
      var preset = document.getElementById('sal-perfPeriodSelect').value;
      var now = new Date();
      var startDate, endDate;
      switch (preset) {
        case 'month':
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0); break;
        case 'lastMonth':
          startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
          endDate = new Date(now.getFullYear(), now.getMonth(), 0); break;
        case 'year':
          startDate = new Date(now.getFullYear(), 0, 1);
          endDate = new Date(now.getFullYear(), 11, 31); break;
        case 'all': default:
          startDate = new Date(2025, 0, 1);
          endDate = now;
      }
      document.getElementById('sal-perfStartDate').value = salFormatDateLocal(startDate);
      document.getElementById('sal-perfEndDate').value = salFormatDateLocal(endDate);
      salLoadPerformanceData();
    }

    function salLoadPerformanceData() {
      salShowLoading();
      var startDate = document.getElementById('sal-perfStartDate').value || '2025-01-01';
      var endDate = document.getElementById('sal-perfEndDate').value || salFormatDateLocal(new Date());
      var axis = document.getElementById('sal-performanceAxis').value;

      salCalculatePerformanceByAxis(startDate, endDate, axis).then(function(data) {
        _sal_currentPerformanceData = data;
        _sal_performanceDataLoaded = true;
        salSortPerformanceData();
      }).catch(function(error) {
        console.error('[Sal SPA] 軸分析エラー:', error);
        document.getElementById('sal-performanceBody').innerHTML =
          '<tr><td colspan="10" class="text-center text-danger py-4"><i class="bi bi-exclamation-triangle"></i> データの読み込みに失敗しました<br><small class="text-muted">' + (error.message || error) + '</small></td></tr>';
      }).finally(function() { salHideLoading(); });
    }

    function salSortPerformanceData() {
      if (!_sal_currentPerformanceData || _sal_currentPerformanceData.length === 0) { salRenderPerformanceTable([]); return; }
      var sortKey = document.getElementById('sal-performanceSortKey').value;
      var parts = sortKey.split('-');
      var key = parts[0];
      var order = parts[1];

      var sorted = _sal_currentPerformanceData.slice().sort(function(a, b) {
        var valA, valB;
        switch (key) {
          case 'profit': valA = a.finalProfit; valB = b.finalProfit; break;
          case 'profitRate': valA = a.profitRate; valB = b.profitRate; break;
          case 'consumption': valA = a.consumptionRate; valB = b.consumptionRate; break;
          case 'days': valA = a.avgDays; valB = b.avgDays; break;
          default: valA = a.finalProfit; valB = b.finalProfit;
        }
        return order === 'desc' ? valB - valA : valA - valB;
      });
      salRenderPerformanceTable(sorted);
    }

    function salRenderPerformanceTable(data) {
      var tbody = document.getElementById('sal-performanceBody');
      var tfoot = document.getElementById('sal-performanceFoot');
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-4"><i class="bi bi-inbox"></i> データがありません</td></tr>';
        tfoot.innerHTML = '';
        return;
      }

      var totals = { purchaseCount: 0, salesCount: 0, salesAmount: 0, finalProfit: 0, totalDays: 0 };
      var html = '';
      data.forEach(function(item) {
        totals.purchaseCount += item.purchaseCount;
        totals.salesCount += item.salesCount;
        totals.salesAmount += item.salesAmount;
        totals.finalProfit += item.finalProfit;
        totals.totalDays += item.avgDays * item.salesCount;

        var profitRateClass = 'low';
        if (item.profitRate >= 30) profitRateClass = 'high';
        else if (item.profitRate >= 15) profitRateClass = 'medium';

        var roiClass = 'low';
        if (item.roi >= 50) roiClass = 'high';
        else if (item.roi >= 30) roiClass = 'medium';

        var barWidth = Math.min(100, item.consumptionRate);

        html += '<tr><td style="text-align:left; font-weight:500">' + salEscapeHtml(item.name) + '</td>' +
          '<td>' + item.purchaseCount + '件</td><td>' + item.salesCount + '件</td>' +
          '<td><div class="sal-consumption-bar"><div class="sal-consumption-bar-fill" style="width:' + barWidth + '%"></div></div> ' + item.consumptionRate.toFixed(0) + '%</td>' +
          '<td>' + salFormatCurrency(item.salesAmount) + '</td>' +
          '<td>' + (item.salesShare || 0).toFixed(1) + '%</td>' +
          '<td>' + salFormatCurrency(item.finalProfit) + '</td>' +
          '<td class="sal-profit-rate ' + profitRateClass + '">' + item.profitRate.toFixed(1) + '%</td>' +
          '<td class="sal-profit-rate ' + roiClass + '">' + (item.roi || 0).toFixed(1) + '%</td>' +
          '<td>' + item.avgDays + '日</td></tr>';
      });
      tbody.innerHTML = html;

      var totalConsumptionRate = totals.purchaseCount > 0 ? (totals.salesCount / totals.purchaseCount) * 100 : 0;
      var totalProfitRate = totals.salesAmount > 0 ? (totals.finalProfit / totals.salesAmount) * 100 : 0;
      var avgDays = totals.salesCount > 0 ? Math.round(totals.totalDays / totals.salesCount) : 0;

      tfoot.innerHTML = '<tr>' +
        '<td style="text-align:left; font-weight:600">合計</td>' +
        '<td>' + totals.purchaseCount + '件</td><td>' + totals.salesCount + '件</td>' +
        '<td>' + totalConsumptionRate.toFixed(0) + '%</td>' +
        '<td>' + salFormatCurrency(totals.salesAmount) + '</td><td>100%</td>' +
        '<td>' + salFormatCurrency(totals.finalProfit) + '</td>' +
        '<td>' + totalProfitRate.toFixed(1) + '%</td><td>-</td><td>' + avgDays + '日</td></tr>';
    }

    // ============================================
    // SPA Lifecycle
    // ============================================
    function initSalesPage() {
      console.log('[Sal SPA] initSalesPage called');

      var loadPromises = [];

      // Load Chart.js dynamically
      if (typeof Chart === 'undefined') {
        loadPromises.push(_salLoadScript('https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js'));
      }
      // Load html2canvas
      if (typeof html2canvas === 'undefined') {
        loadPromises.push(_salLoadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js'));
      }
      // Load jsPDF
      if (!window.jspdf) {
        loadPromises.push(_salLoadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'));
      }

      // Tab click handlers are now inline onclick on material-tab buttons
      // No additional setup needed

      // Set up dropdown close handler
      _sal_dropdownClickHandler = function(event) {
        var dropdown = document.getElementById('sal-settingsDropdown');
        if (dropdown && !event.target.closest('.sal-settings-dropdown') && !event.target.closest('.sal-sub-header-icon')) {
          dropdown.classList.remove('active');
        }
      };
      document.addEventListener('click', _sal_dropdownClickHandler);

      // Wait for scripts to load, then initialize
      Promise.all(loadPromises).then(function() {
        console.log('[Sal SPA] External scripts loaded');

        // Initialize analysis period presets
        salInitAnalysisPeriodPresets();

        // Load initial sales data (triggers period change)
        salOnSalesPeriodChange();
      }).catch(function(err) {
        console.error('[Sal SPA] Script loading error:', err);
        // Initialize anyway
        salInitAnalysisPeriodPresets();
        salOnSalesPeriodChange();
      });
    }

    function destroySalesPage() {
      console.log('[Sal SPA] destroySalesPage called');

      // Destroy Chart.js instance
      if (_sal_monthlyChart) {
        _sal_monthlyChart.destroy();
        _sal_monthlyChart = null;
      }

      // Remove dropdown click handler
      if (_sal_dropdownClickHandler) {
        document.removeEventListener('click', _sal_dropdownClickHandler);
        _sal_dropdownClickHandler = null;
      }

      // Remove tab click handlers
      _sal_tabClickHandlers.forEach(function(h) {
        h.el.removeEventListener('click', h.handler);
      });
      _sal_tabClickHandlers = [];

      // Close any open modals
      var modals = document.querySelectorAll('#spa-page-sales .sal-modal-overlay');
      modals.forEach(function(m) { m.classList.remove('active'); });

      // Reset state
      _sal_currentSalesData = [];
      _sal_selectedProductForCancel = null;
      _sal_currentPeriodPreset = 'month';
      _sal_currentInvoiceData = null;
      _sal_allSalesDataForAnalysis = [];
      _sal_allProductsForAnalysis = [];
      _sal_analysisDataLoaded = false;
      _sal_analysisPeriodPreset = 'month';
      _sal_currentPerformanceData = [];
      _sal_performanceDataLoaded = false;
      _sal_perfPeriodPreset = 'all';
    }
  </script>
</div>
