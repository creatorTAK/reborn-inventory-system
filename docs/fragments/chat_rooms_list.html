<!-- SPA Fragment: chat_rooms_list.html -->
<!-- Prefix: crl -->
<!-- Page Key: chat -->
<div id="spa-page-chat-rooms">
  <style>
    #spa-page-chat-rooms {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }
    #spa-page-chat-rooms .crl-user-info {
      font-size: 13px;
      color: #6b7280;
      padding: 8px 16px;
      background: #f8f9fa;
      border-bottom: 1px solid #e5e7eb;
    }
    #spa-page-chat-rooms .crl-buttons-container {
      display: flex;
      gap: 12px;
      padding: 0 16px;
      margin: 16px 0;
    }
    #spa-page-chat-rooms .crl-create-room-button {
      background: var(--reborn-primary);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      flex: 1;
    }
    #spa-page-chat-rooms .crl-create-room-button.orange {
      background: var(--reborn-accent);
      box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
    }
    #spa-page-chat-rooms .crl-create-room-button.green {
      background: #48bb78;
      box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
    }
    #spa-page-chat-rooms .crl-create-room-button:active {
      transform: scale(0.98);
    }
    #spa-page-chat-rooms .crl-rooms-container {
      height: calc(100vh - 190px);
      overflow-y: auto;
      padding: 8px 16px;
      background: var(--reborn-primary);
      margin: 0 16px 16px 16px;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      opacity: 0;
      transition: opacity 0.15s ease;
    }
    #spa-page-chat-rooms .crl-rooms-container.ready {
      opacity: 1;
    }
    #spa-page-chat-rooms .crl-sub-header {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 56px;
      padding: 0 16px;
      background: #ffffff;
      border-bottom: 1px solid #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    #spa-page-chat-rooms .crl-sub-header-title {
      font-weight: 600;
      font-size: 16px;
      color: #1f2937;
    }
    #spa-page-chat-rooms .crl-sub-header-icons {
      position: absolute;
      right: 16px;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    #spa-page-chat-rooms .crl-sub-header-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 20px;
      transition: background 0.2s;
      position: relative;
    }
    #spa-page-chat-rooms .crl-sub-header-icon:hover { background: #f2f2f2; }
    #spa-page-chat-rooms .crl-sub-header-icon:active { background: #e5e5e5; }
    #spa-page-chat-rooms .crl-settings-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 200px;
      overflow: hidden;
      display: none;
      z-index: 1001;
    }
    #spa-page-chat-rooms .crl-settings-dropdown.active { display: block; }
    #spa-page-chat-rooms .crl-settings-dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      font-size: 14px;
      color: #1f2937;
      text-decoration: none;
      transition: background 0.2s;
      cursor: pointer;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }
    #spa-page-chat-rooms .crl-settings-dropdown-item:hover { background: #f3f4f6; }
    #spa-page-chat-rooms .crl-settings-dropdown-item i {
      font-size: 18px;
      color: #6b7280;
      width: 24px;
      text-align: center;
    }
    #spa-page-chat-rooms .crl-settings-dropdown-item.admin-only { display: none; }
    #spa-page-chat-rooms .crl-settings-dropdown-item.admin-only.visible {
      display: flex;
      border-top: 1px solid #e5e7eb;
      color: #6366f1;
    }
    #spa-page-chat-rooms .crl-settings-dropdown-item.admin-only.visible i { color: #6366f1; }
    #spa-page-chat-rooms .crl-settings-dropdown-divider {
      height: 1px;
      background: #e5e7eb;
      margin: 4px 0;
    }
    #spa-page-chat-rooms .crl-announce-dot {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      display: none;
      box-shadow: 0 0 0 2px white;
    }
    #spa-page-chat-rooms .crl-announce-dot.active { display: block; }
    #spa-page-chat-rooms .crl-keep-dot {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 8px;
      height: 8px;
      background: #22c55e;
      border-radius: 50%;
      display: none;
      box-shadow: 0 0 0 2px white;
    }
    #spa-page-chat-rooms .crl-keep-dot.active { display: block; }
    #spa-page-chat-rooms .crl-search-bar {
      display: flex;
      align-items: center;
      background: #e5e7eb;
      border-radius: 12px;
      padding: 12px 14px;
      gap: 10px;
    }
    #spa-page-chat-rooms .crl-search-bar i {
      color: #9ca3af;
      font-size: 16px;
    }
    #spa-page-chat-rooms .crl-search-bar input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 16px;
      color: #1f2937;
      outline: none;
    }
    #spa-page-chat-rooms .crl-search-bar input::placeholder { color: #9ca3af; }
    #spa-page-chat-rooms .crl-search-bar .crl-clear-btn {
      display: none;
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      padding: 0;
      font-size: 16px;
    }
    #spa-page-chat-rooms .crl-search-bar .crl-clear-btn.show { display: block; }
    #spa-page-chat-rooms .crl-room-item-wrapper {
      position: relative;
      margin-bottom: 12px;
      overflow: hidden;
      border-radius: 12px;
    }
    #spa-page-chat-rooms .crl-room-item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      cursor: pointer;
      transition: transform 0.3s ease;
      display: flex;
      gap: 12px;
      align-items: center;
      position: relative;
      z-index: 2;
    }
    #spa-page-chat-rooms .crl-room-item.swiping { transition: none; }
    #spa-page-chat-rooms .crl-room-item:active:not(.swiping) {
      transform: scale(0.98);
      background: #f7fafc;
    }
    #spa-page-chat-rooms .crl-skeleton-loader {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: rgba(255, 255, 255, 0.95);
      z-index: 9999;
      padding: 20px;
      overflow: hidden;
    }
    #spa-page-chat-rooms .crl-skeleton-loader.active { display: block; }
    #spa-page-chat-rooms .crl-skeleton-header {
      width: 100%;
      height: 60px;
      background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
      background-size: 200% 100%;
      animation: crl-skeleton-pulse 1.5s ease-in-out infinite;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    #spa-page-chat-rooms .crl-skeleton-room {
      width: 100%;
      height: 80px;
      background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
      background-size: 200% 100%;
      animation: crl-skeleton-pulse 1.5s ease-in-out infinite;
      border-radius: 12px;
      margin-bottom: 12px;
    }
    #spa-page-chat-rooms .crl-loading-spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 48px;
      height: 48px;
      border: 4px solid #e0e0e0;
      border-top: 4px solid var(--reborn-primary);
      border-radius: 50%;
      animation: crl-spinner-rotate 1s linear infinite;
      z-index: 10;
    }
    @keyframes crl-skeleton-pulse {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    @keyframes crl-spinner-rotate {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    #spa-page-chat-rooms .crl-swipe-buttons {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      display: flex;
      z-index: 1;
    }
    #spa-page-chat-rooms .crl-hide-button {
      width: 70px;
      background: #6b7280;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    #spa-page-chat-rooms .crl-hide-button:active { background: #4b5563; }
    #spa-page-chat-rooms .crl-delete-button {
      width: 70px;
      background: #ef4444;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    #spa-page-chat-rooms .crl-delete-button:active { background: #dc2626; }
    #spa-page-chat-rooms .crl-swipe-buttons-left {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      display: flex;
      z-index: 1;
    }
    #spa-page-chat-rooms .crl-mute-button {
      width: 70px;
      background: #f59e0b;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    #spa-page-chat-rooms .crl-mute-button:active { background: #d97706; }
    #spa-page-chat-rooms .crl-pin-button {
      width: 70px;
      background: #3b82f6;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    #spa-page-chat-rooms .crl-pin-button:active { background: #2563eb; }
    #spa-page-chat-rooms .crl-room-icon {
      font-size: 32px;
      flex-shrink: 0;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      color: white;
      overflow: hidden;
    }
    #spa-page-chat-rooms .crl-room-icon.has-emoji {
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
    }
    #spa-page-chat-rooms .crl-room-content { flex: 1; min-width: 0; }
    #spa-page-chat-rooms .crl-room-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 4px;
    }
    #spa-page-chat-rooms .crl-room-name {
      font-size: 16px;
      font-weight: 600;
      color: #2d3748;
      flex: 1;
    }
    #spa-page-chat-rooms .crl-room-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }
    #spa-page-chat-rooms .crl-room-time { font-size: 12px; color: #a0aec0; }
    #spa-page-chat-rooms .crl-room-preview {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #spa-page-chat-rooms .crl-room-last-message {
      font-size: 14px;
      color: #718096;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
    }
    #spa-page-chat-rooms .crl-room-last-message i {
      font-size: 12px;
      margin-right: 2px;
      vertical-align: middle;
    }
    #spa-page-chat-rooms .crl-unread-badge {
      background: #40B4E5;
      color: white;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 600;
      min-width: 20px;
      text-align: center;
      display: inline-block;
    }
    #spa-page-chat-rooms .crl-empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #718096;
    }
    #spa-page-chat-rooms .crl-empty-state-icon { font-size: 64px; margin-bottom: 16px; }
    #spa-page-chat-rooms .crl-empty-state-text { font-size: 16px; margin-bottom: 8px; }
    #spa-page-chat-rooms .crl-loading {
      text-align: center;
      padding: 40px;
      color: #718096;
    }
    #spa-page-chat-rooms .crl-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    #spa-page-chat-rooms .crl-modal-overlay.active { display: flex; }
    #spa-page-chat-rooms .crl-modal-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }
    #spa-page-chat-rooms .crl-modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 20px;
    }
    #spa-page-chat-rooms .crl-profile-popup-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    #spa-page-chat-rooms .crl-profile-popup-overlay.active { display: flex; }
    #spa-page-chat-rooms .crl-profile-popup {
      background: white;
      border-radius: 20px;
      width: 280px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: crl-popupSlideUp 0.3s ease;
    }
    @keyframes crl-popupSlideUp {
      from { opacity: 0; transform: translateY(20px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    #spa-page-chat-rooms .crl-profile-popup-header {
      background: linear-gradient(135deg, var(--reborn-primary), var(--reborn-primary-dark));
      padding: 30px 20px 20px;
      text-align: center;
      position: relative;
      background-size: cover;
      background-position: center;
    }
    #spa-page-chat-rooms .crl-profile-popup-close {
      position: absolute;
      top: 12px; right: 12px;
      width: 28px; height: 28px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #spa-page-chat-rooms .crl-profile-popup-close:hover { background: rgba(255, 255, 255, 0.3); }
    #spa-page-chat-rooms .crl-profile-popup-avatar {
      width: 80px; height: 80px;
      border-radius: 50%;
      border: 3px solid white;
      object-fit: cover;
      margin-bottom: 12px;
    }
    #spa-page-chat-rooms .crl-profile-popup-avatar-initial {
      width: 80px; height: 80px;
      border-radius: 50%;
      border: 3px solid white;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 32px;
      font-weight: 600;
      margin: 0 auto 12px;
    }
    #spa-page-chat-rooms .crl-profile-popup-name {
      color: white; font-size: 18px; font-weight: 600; margin-bottom: 4px;
    }
    #spa-page-chat-rooms .crl-profile-popup-status {
      color: rgba(255, 255, 255, 0.8); font-size: 13px;
    }
    #spa-page-chat-rooms .crl-profile-popup-actions {
      display: flex;
      justify-content: center;
      gap: 32px;
      padding: 24px 20px;
      background: white;
    }
    #spa-page-chat-rooms .crl-profile-popup-action {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 12px;
      transition: background 0.2s;
    }
    #spa-page-chat-rooms .crl-profile-popup-action:hover { background: #f3f4f6; }
    #spa-page-chat-rooms .crl-profile-popup-action-icon {
      width: 48px; height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }
    #spa-page-chat-rooms .crl-profile-popup-action-icon.chat { background: var(--reborn-primary); color: white; }
    #spa-page-chat-rooms .crl-profile-popup-action-icon.call { background: #22c55e; color: white; }
    #spa-page-chat-rooms .crl-profile-popup-action-label { font-size: 12px; color: #4b5563; font-weight: 500; }
    #spa-page-chat-rooms .crl-menu-option-button {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      text-align: left;
    }
    #spa-page-chat-rooms .crl-menu-option-button:hover {
      border-color: var(--reborn-accent);
      background: #fffaf5;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 107, 53, 0.1);
    }
    #spa-page-chat-rooms .crl-menu-option-button:active { transform: translateY(0); }
    #spa-page-chat-rooms .crl-menu-option-icon { font-size: 32px; flex-shrink: 0; }
    #spa-page-chat-rooms .crl-menu-option-content { flex: 1; }
    #spa-page-chat-rooms .crl-menu-option-title {
      font-size: 16px; font-weight: 600; color: #2d3748; margin-bottom: 4px;
    }
    #spa-page-chat-rooms .crl-menu-option-desc { font-size: 13px; color: #718096; }
    #spa-page-chat-rooms .crl-form-group { margin-bottom: 16px; }
    #spa-page-chat-rooms .crl-form-label {
      display: block; font-size: 14px; font-weight: 600; color: #4a5568; margin-bottom: 8px;
    }
    #spa-page-chat-rooms .crl-form-input {
      width: 100%; padding: 12px;
      border: 2px solid #e2e8f0; border-radius: 8px;
      font-size: 16px; transition: border-color 0.3s ease;
    }
    #spa-page-chat-rooms .crl-form-input:focus { outline: none; border-color: var(--reborn-primary); }
    #spa-page-chat-rooms .crl-emoji-picker-button {
      width: 100%; padding: 12px;
      border: 2px solid #e2e8f0; border-radius: 8px;
      font-size: 16px; background: white; cursor: pointer;
      display: flex; align-items: center; gap: 8px;
      transition: border-color 0.2s;
    }
    #spa-page-chat-rooms .crl-emoji-picker-button:hover { border-color: var(--reborn-primary); }
    #spa-page-chat-rooms .crl-emoji-picker-button .crl-selected-emoji { font-size: 24px; }
    #spa-page-chat-rooms .crl-emoji-picker-button .crl-button-text { color: #4a5568; flex: 1; text-align: left; }
    #spa-page-chat-rooms .crl-emoji-picker-button .crl-change-icon { color: #a0aec0; font-size: 14px; }
    #spa-page-chat-rooms .crl-emoji-picker-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none; justify-content: center; align-items: center; z-index: 2000;
    }
    #spa-page-chat-rooms .crl-emoji-picker-modal.active { display: flex; }
    #spa-page-chat-rooms .crl-emoji-picker-content {
      background: white; border-radius: 16px;
      width: 90%; max-width: 360px; max-height: 70vh;
      display: flex; flex-direction: column;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }
    #spa-page-chat-rooms .crl-emoji-picker-header {
      padding: 16px; border-bottom: 1px solid #e2e8f0;
      display: flex; justify-content: space-between; align-items: center;
    }
    #spa-page-chat-rooms .crl-emoji-picker-header h3 { margin: 0; font-size: 18px; color: #2d3748; }
    #spa-page-chat-rooms .crl-emoji-picker-close {
      background: none; border: none; font-size: 24px; cursor: pointer; color: #a0aec0; padding: 4px;
    }
    #spa-page-chat-rooms .crl-emoji-categories {
      display: flex; gap: 4px; padding: 12px;
      border-bottom: 1px solid #e2e8f0;
      overflow-x: auto; overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      flex-shrink: 0; min-height: 48px; width: 100%; box-sizing: border-box;
    }
    #spa-page-chat-rooms .crl-emoji-category-btn {
      background: none; border: none; padding: 8px 12px;
      border-radius: 8px; font-size: 14px; cursor: pointer;
      white-space: nowrap; color: #718096; transition: all 0.2s;
    }
    #spa-page-chat-rooms .crl-emoji-category-btn.active {
      background: #1E8FBF !important; color: #ffffff !important; font-weight: 600;
    }
    #spa-page-chat-rooms .crl-emoji-grid-container { flex: 1; overflow-y: auto; padding: 12px; }
    #spa-page-chat-rooms .crl-emoji-grid {
      display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;
    }
    #spa-page-chat-rooms .crl-emoji-item {
      font-size: 24px; padding: 8px; border-radius: 8px;
      cursor: pointer; text-align: center; transition: background 0.2s;
    }
    #spa-page-chat-rooms .crl-emoji-item:hover { background: #edf2f7; }
    #spa-page-chat-rooms .crl-emoji-item:active { background: #e2e8f0; transform: scale(0.95); }
    #spa-page-chat-rooms .crl-member-search-container {
      display: flex; align-items: center; gap: 8px; margin-bottom: 8px;
    }
    #spa-page-chat-rooms .crl-member-search-input {
      flex: 1; padding: 10px 12px;
      border: 2px solid #e2e8f0; border-radius: 8px;
      font-size: 16px; transition: border-color 0.2s;
    }
    #spa-page-chat-rooms .crl-member-search-input:focus { outline: none; border-color: var(--reborn-primary); }
    #spa-page-chat-rooms .crl-member-search-input::placeholder { color: #a0aec0; }
    #spa-page-chat-rooms .crl-member-count { font-size: 12px; color: #718096; white-space: nowrap; }
    #spa-page-chat-rooms .crl-modal-buttons { display: flex; gap: 12px; margin-top: 24px; }
    #spa-page-chat-rooms .crl-modal-button {
      flex: 1; padding: 12px; border: none; border-radius: 8px;
      font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
    }
    #spa-page-chat-rooms .crl-modal-button.primary { background: var(--reborn-primary); color: white; }
    #spa-page-chat-rooms .crl-modal-button.primary:hover { background: #5568d3; }
    #spa-page-chat-rooms .crl-modal-button.secondary { background: #e2e8f0; color: #4a5568; }
    #spa-page-chat-rooms .crl-modal-button.secondary:hover { background: #cbd5e0; }
    #spa-page-chat-rooms .crl-user-list-item {
      background: white; border: 2px solid #e2e8f0; border-radius: 8px;
      padding: 12px; margin-bottom: 8px; cursor: pointer;
      transition: all 0.2s ease; display: flex; align-items: center; gap: 12px;
    }
    #spa-page-chat-rooms .crl-user-list-item:hover { border-color: #48bb78; background: #f0fff4; }
    #spa-page-chat-rooms .crl-user-list-item:active { transform: scale(0.98); }
    #spa-page-chat-rooms .crl-user-list-item-checkbox {
      background: white; border: 2px solid #e2e8f0; border-radius: 8px;
      padding: 12px; margin-bottom: 8px; cursor: pointer;
      transition: all 0.2s ease; display: flex; align-items: center; gap: 12px;
    }
    #spa-page-chat-rooms .crl-user-list-item-checkbox:hover { border-color: var(--reborn-primary); background: #f7fafc; }
    #spa-page-chat-rooms .crl-user-list-item-checkbox.selected { border-color: var(--reborn-primary); background: #ebf4ff; }
    #spa-page-chat-rooms .crl-user-checkbox { width: 20px; height: 20px; flex-shrink: 0; cursor: pointer; }
    #spa-page-chat-rooms .crl-user-icon { width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0; }
    #spa-page-chat-rooms .crl-user-icon img {
      width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid #e2e8f0;
    }
    #spa-page-chat-rooms .crl-user-icon-placeholder {
      width: 40px; height: 40px; border-radius: 50%;
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white; display: flex; align-items: center; justify-content: center;
      font-size: 18px; font-weight: 600; flex-shrink: 0; border: 2px solid #e2e8f0;
    }
    #spa-page-chat-rooms .crl-user-info-cell { flex: 1; min-width: 0; }
    #spa-page-chat-rooms .crl-user-name { font-size: 16px; font-weight: 600; color: #2d3748; margin-bottom: 4px; }
    #spa-page-chat-rooms .crl-user-permission { font-size: 12px; color: #718096; }
    #spa-page-chat-rooms .crl-room-item-wrapper.search-hidden { display: none !important; }
    #spa-page-chat-rooms .crl-search-highlight {
      background: #fef08a; padding: 1px 2px; border-radius: 2px;
    }
  </style>

  <!-- Skeleton UI -->
  <div class="crl-skeleton-loader" id="crlSkeletonLoader">
    <div class="crl-skeleton-header"></div>
    <div class="crl-skeleton-room"></div>
    <div class="crl-skeleton-room"></div>
    <div class="crl-skeleton-room"></div>
    <div class="crl-skeleton-room"></div>
    <div class="crl-skeleton-room"></div>
    <div class="crl-loading-spinner"></div>
  </div>

  <!-- Sub Header -->
  <div class="crl-sub-header">
    <span class="crl-sub-header-title">ãƒãƒ£ãƒƒãƒˆ</span>
    <div class="crl-sub-header-icons">
      <button class="crl-sub-header-icon" title="Keepãƒ¡ãƒ¢" onclick="crlOpenKeepMemo()">
        <i class="bi bi-bookmark"></i>
        <span class="crl-keep-dot" id="crlKeepDot"></span>
      </button>
      <button class="crl-sub-header-icon" title="é€šçŸ¥" onclick="crlOpenAnnouncePage()">
        <i class="bi bi-bell"></i>
        <span class="crl-announce-dot" id="crlAnnounceDot"></span>
      </button>
      <div style="position: relative;">
        <button class="crl-sub-header-icon" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼" onclick="crlToggleSettingsDropdown(event)">
          <i class="bi bi-list"></i>
        </button>
        <div class="crl-settings-dropdown" id="crlSettingsDropdown">
          <button class="crl-settings-dropdown-item" onclick="crlOpenChatTypeMenu(); crlToggleSettingsDropdown(event);">
            <i class="bi bi-plus-circle"></i>
            <span>ãƒãƒ£ãƒƒãƒˆä½œæˆ</span>
          </button>
          <div class="crl-settings-dropdown-divider"></div>
          <button class="crl-settings-dropdown-item" onclick="crlOpenMemberListModal(); crlToggleSettingsDropdown(event);">
            <i class="bi bi-people"></i>
            <span>ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§</span>
          </button>
          <button class="crl-settings-dropdown-item" onclick="crlOpenHiddenRoomsModal(); crlToggleSettingsDropdown(event);">
            <i class="bi bi-eye-slash"></i>
            <span>éè¡¨ç¤ºãƒ«ãƒ¼ãƒ </span>
          </button>
          <button class="crl-settings-dropdown-item" onclick="crlOpenMutedRoomsModal(); crlToggleSettingsDropdown(event);">
            <i class="bi bi-bell-slash"></i>
            <span>ãƒŸãƒ¥ãƒ¼ãƒˆä¸­</span>
          </button>
          <button class="crl-settings-dropdown-item" onclick="crlOpenBlockListModal(); crlToggleSettingsDropdown(event);">
            <i class="bi bi-person-x"></i>
            <span>ãƒ–ãƒ­ãƒƒã‚¯ãƒªã‚¹ãƒˆ</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Search Bar -->
  <div class="crl-search-bar" style="margin: 12px 16px;">
    <i class="bi bi-search"></i>
    <input type="text" id="crlSearchInput" placeholder="ãƒ«ãƒ¼ãƒ åãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§æ¤œç´¢" oninput="crlPerformSearchNew()" />
    <button class="crl-clear-btn" id="crlSearchClearBtn" onclick="crlClearSearch()">
      <i class="bi bi-x-circle-fill"></i>
    </button>
  </div>

  <!-- User Info (hidden) -->
  <div class="crl-user-info" id="crlUserInfo" style="display: none;">èª­ã¿è¾¼ã¿ä¸­...</div>

  <!-- Rooms Container -->
  <div class="crl-rooms-container" id="crlRoomsContainer">
    <div class="crl-loading">ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
  </div>

  <!-- Chat Type Menu Modal -->
  <div class="crl-modal-overlay" id="crlChatTypeMenuModal">
    <div class="crl-modal-content">
      <div class="crl-modal-title">ãƒãƒ£ãƒƒãƒˆä½œæˆ</div>
      <div style="margin-bottom: 16px; font-size: 14px; color: #718096;">
        ä½œæˆã™ã‚‹ãƒãƒ£ãƒƒãƒˆã®ç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„
      </div>
      <div style="display: flex; flex-direction: column; gap: 12px;">
        <button class="crl-menu-option-button" onclick="crlSelectChatType('room')">
          <div class="crl-menu-option-icon">ğŸ’¬</div>
          <div class="crl-menu-option-content">
            <div class="crl-menu-option-title">æ–°è¦ãƒ«ãƒ¼ãƒ ä½œæˆ</div>
            <div class="crl-menu-option-desc">è¤‡æ•°äººã§ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆ</div>
          </div>
        </button>
        <button class="crl-menu-option-button" onclick="crlSelectChatType('direct')">
          <div class="crl-menu-option-icon">ğŸ‘¤</div>
          <div class="crl-menu-option-content">
            <div class="crl-menu-option-title">å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆ</div>
            <div class="crl-menu-option-desc">1å¯¾1ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ£ãƒƒãƒˆ</div>
          </div>
        </button>
      </div>
      <div class="crl-modal-buttons" style="margin-top: 20px;">
        <button type="button" class="crl-modal-button secondary" onclick="crlCloseChatTypeMenu()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- Create Room Modal -->
  <div class="crl-modal-overlay" id="crlCreateRoomModal">
    <div class="crl-modal-content">
      <div class="crl-modal-title">æ–°è¦ãƒ«ãƒ¼ãƒ ä½œæˆ</div>
      <form id="crlCreateRoomForm" onsubmit="return false;">
        <div class="crl-form-group">
          <label class="crl-form-label" for="crlRoomNameInput">ãƒ«ãƒ¼ãƒ å *</label>
          <input type="text" class="crl-form-input" id="crlRoomNameInput" placeholder="ä¾‹: å•†å“ä¼ç”»ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°" maxlength="50" required />
        </div>
        <div class="crl-form-group">
          <label class="crl-form-label">ã‚¢ã‚¤ã‚³ãƒ³</label>
          <input type="hidden" id="crlRoomIconSelect" value="ğŸ’¬">
          <button type="button" class="crl-emoji-picker-button" onclick="crlOpenEmojiPicker()">
            <span class="crl-selected-emoji" id="crlSelectedEmojiPreview">ğŸ’¬</span>
            <span class="crl-button-text">ã‚¿ãƒƒãƒ—ã—ã¦çµµæ–‡å­—ã‚’é¸æŠ</span>
            <span class="crl-change-icon">â–¼</span>
          </button>
        </div>
        <div class="crl-form-group">
          <label class="crl-form-label">ãƒ¡ãƒ³ãƒãƒ¼é¸æŠ *</label>
          <div style="margin-bottom: 8px; font-size: 14px; color: #718096;">
            ã‚°ãƒ«ãƒ¼ãƒ—ã«å‚åŠ ã™ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰
          </div>
          <div class="crl-member-search-container">
            <div style="position: relative; flex: 1;">
              <i class="bi bi-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 14px;"></i>
              <input type="text" class="crl-member-search-input" id="crlMemberSearchInput" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§æ¤œç´¢..." oninput="crlFilterGroupMembers(this.value)" style="padding-left: 36px;">
            </div>
            <span class="crl-member-count" id="crlMemberCount"></span>
          </div>
          <div id="crlGroupMemberListContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 8px;">
            <div class="crl-loading">ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
          </div>
        </div>
        <div class="crl-modal-buttons">
          <button type="button" class="crl-modal-button secondary" onclick="crlCloseCreateRoomModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="submit" class="crl-modal-button primary" onclick="crlSubmitCreateRoom()">ä½œæˆ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Direct Chat Modal -->
  <div class="crl-modal-overlay" id="crlDirectChatModal">
    <div class="crl-modal-content">
      <div class="crl-modal-title">ğŸ‘¤ å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆä½œæˆ</div>
      <div style="margin-bottom: 16px; font-size: 14px; color: #718096;">
        ãƒãƒ£ãƒƒãƒˆã—ãŸã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„
      </div>
      <div id="crlUserListContainer" style="max-height: 400px; overflow-y: auto; margin-bottom: 16px;">
        <div class="crl-loading">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
      </div>
      <div class="crl-modal-buttons">
        <button type="button" class="crl-modal-button secondary" onclick="crlCloseDirectChatModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- Emoji Picker Modal -->
  <div class="crl-emoji-picker-modal" id="crlEmojiPickerModal">
    <div class="crl-emoji-picker-content">
      <div class="crl-emoji-picker-header">
        <h3>ã‚¢ã‚¤ã‚³ãƒ³ã‚’é¸æŠ</h3>
        <button class="crl-emoji-picker-close" onclick="crlCloseEmojiPicker()">Ã—</button>
      </div>
      <div class="crl-emoji-categories" id="crlEmojiCategories"></div>
      <div class="crl-emoji-grid-container">
        <div class="crl-emoji-grid" id="crlEmojiGrid"></div>
      </div>
    </div>
  </div>

  <!-- Member List Modal -->
  <div class="crl-modal-overlay" id="crlMemberListModal">
    <div class="crl-modal-content" style="max-height: 80vh;">
      <div class="crl-modal-title">ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§</div>
      <div style="margin-bottom: 12px; position: relative;">
        <i class="bi bi-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 14px;"></i>
        <input type="text" class="crl-form-input" id="crlMemberListSearchInput" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§æ¤œç´¢..." oninput="crlFilterMemberList(this.value)" style="font-size: 16px; padding-left: 36px;">
      </div>
      <div id="crlMemberListContainer" style="max-height: 50vh; overflow-y: auto;">
        <div class="crl-loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
      <div class="crl-modal-buttons" style="margin-top: 16px;">
        <button type="button" class="crl-modal-button secondary" onclick="crlCloseMemberListModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- Hidden Rooms Modal -->
  <div class="crl-modal-overlay" id="crlHiddenRoomsModal">
    <div class="crl-modal-content" style="max-height: 80vh;">
      <div class="crl-modal-title">éè¡¨ç¤ºãƒ«ãƒ¼ãƒ </div>
      <div style="margin-bottom: 12px; font-size: 14px; color: #718096;">
        ã‚¹ãƒ¯ã‚¤ãƒ—ã§éè¡¨ç¤ºã«ã—ãŸãƒ«ãƒ¼ãƒ ã‚’å¾©å…ƒã§ãã¾ã™
      </div>
      <div id="crlHiddenRoomsContainer" style="max-height: 50vh; overflow-y: auto;">
        <div class="crl-loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
      <div class="crl-modal-buttons" style="margin-top: 16px;">
        <button type="button" class="crl-modal-button secondary" onclick="crlCloseHiddenRoomsModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- Muted Rooms Modal -->
  <div class="crl-modal-overlay" id="crlMutedRoomsModal">
    <div class="crl-modal-content" style="max-height: 80vh;">
      <div class="crl-modal-title">ãƒŸãƒ¥ãƒ¼ãƒˆä¸­ãƒ«ãƒ¼ãƒ </div>
      <div style="margin-bottom: 12px; font-size: 14px; color: #718096;">
        é€šçŸ¥ã‚’ã‚ªãƒ•ã«ã—ã¦ã„ã‚‹ãƒ«ãƒ¼ãƒ ã§ã™
      </div>
      <div id="crlMutedRoomsContainer" style="max-height: 50vh; overflow-y: auto;">
        <div class="crl-loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
      <div class="crl-modal-buttons" style="margin-top: 16px;">
        <button type="button" class="crl-modal-button secondary" onclick="crlCloseMutedRoomsModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- Block List Modal -->
  <div class="crl-modal-overlay" id="crlBlockListModal">
    <div class="crl-modal-content" style="max-height: 80vh;">
      <div class="crl-modal-title">ãƒ–ãƒ­ãƒƒã‚¯ãƒªã‚¹ãƒˆ</div>
      <div style="margin-bottom: 12px; font-size: 14px; color: #718096;">
        ãƒ–ãƒ­ãƒƒã‚¯ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒãƒ£ãƒƒãƒˆã«è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“
      </div>
      <div id="crlBlockListContainer" style="max-height: 50vh; overflow-y: auto;">
        <div class="crl-loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
      <div class="crl-modal-buttons" style="margin-top: 16px;">
        <button type="button" class="crl-modal-button secondary" onclick="crlCloseBlockListModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- Profile Popup -->
  <div class="crl-profile-popup-overlay" id="crlProfilePopupOverlay" onclick="crlCloseProfilePopup(event)">
    <div class="crl-profile-popup" onclick="event.stopPropagation()">
      <div class="crl-profile-popup-header">
        <button class="crl-profile-popup-close" onclick="crlCloseProfilePopup(event)">
          <i class="bi bi-x"></i>
        </button>
        <div id="crlProfilePopupAvatar"></div>
        <div class="crl-profile-popup-name" id="crlProfilePopupName"></div>
        <div class="crl-profile-popup-status" id="crlProfilePopupStatus">ãƒ¡ãƒ³ãƒãƒ¼</div>
      </div>
      <div class="crl-profile-popup-actions">
        <button class="crl-profile-popup-action" id="crlProfilePopupChatBtn">
          <div class="crl-profile-popup-action-icon chat">
            <i class="bi bi-chat-dots-fill"></i>
          </div>
          <span class="crl-profile-popup-action-label">ãƒˆãƒ¼ã‚¯</span>
        </button>
        <button class="crl-profile-popup-action" id="crlProfilePopupCallBtn">
          <div class="crl-profile-popup-action-icon call">
            <i class="bi bi-telephone-fill"></i>
          </div>
          <span class="crl-profile-popup-action-label">é€šè©±</span>
        </button>
      </div>
    </div>
  </div>

<script>
// ============================================================
// SPA Fragment: chat_rooms_list.html
// Prefix: crl
// ============================================================

// --- Global State ---
var crlCurrentUserName = '';
var crlCurrentUserEmail = '';
var crlUsersCache = [];
var crlUnsubscribeRooms = null;
var crlCurrentUserBlockedList = [];
var crlRoomUnreadCounts = new Map();
var crlUnreadListeners = [];
var crlCurrentlySwipedItem = null;
var crlSelectedGroupMembers = [];
var crlGroupMemberUsersList = [];
var crlCurrentEmojiCategory = 'ã‚ˆãä½¿ã†';
var crlCurrentProfileUser = null;
var crlAllMembersForList = [];
var crlLoadUserListRetryCount = 0;
var crlMaxRetry = 3;
var crlDropdownClickHandler = null;
var crlDocClickHandler = null;
var crlDocTouchHandler = null;
var crlStorageHandler = null;
var crlEmojiPickerBgHandler = null;
var crlProfileChatHandler = null;
var crlProfileCallHandler = null;

// --- Cache Keys ---
var CRL_ROOMS_CACHE_KEY = 'reborn_chat_rooms_cache';
var CRL_USERS_CACHE_KEY = 'reborn_chat_users_cache';
var CRL_CACHE_DURATION_MS = 5 * 60 * 1000;

// --- Admin ---
var CRL_ADMIN_EMAILS = ['mercari.yasuhirotakuji@gmail.com'];

// --- Gradient Presets ---
var CRL_GRADIENT_PRESETS = [
  { id: 'blue', gradient: 'linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%)' },
  { id: 'purple', gradient: 'linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%)' },
  { id: 'pink', gradient: 'linear-gradient(135deg, #EC4899 0%, #BE185D 100%)' },
  { id: 'orange', gradient: 'linear-gradient(135deg, #F97316 0%, #EA580C 100%)' },
  { id: 'green', gradient: 'linear-gradient(135deg, #22C55E 0%, #15803D 100%)' },
  { id: 'teal', gradient: 'linear-gradient(135deg, #14B8A6 0%, #0F766E 100%)' },
  { id: 'indigo', gradient: 'linear-gradient(135deg, #6366F1 0%, #4338CA 100%)' },
  { id: 'rose', gradient: 'linear-gradient(135deg, #F43F5E 0%, #BE123C 100%)' },
  { id: 'amber', gradient: 'linear-gradient(135deg, #F59E0B 0%, #D97706 100%)' },
  { id: 'cyan', gradient: 'linear-gradient(135deg, #06B6D4 0%, #0891B2 100%)' },
  { id: 'lime', gradient: 'linear-gradient(135deg, #84CC16 0%, #65A30D 100%)' },
  { id: 'slate', gradient: 'linear-gradient(135deg, #64748B 0%, #475569 100%)' },
];

// --- Emoji Categories ---
var crlEmojiCategories = {
  'ã‚ˆãä½¿ã†': ['ğŸ’¬', 'ğŸ“¢', 'ğŸ’¡', 'ğŸ“Š', 'ğŸ¯', 'ğŸ“¦', 'ğŸš€', 'ğŸ”§', 'ğŸ‰', 'â­', 'â¤ï¸', 'ğŸ‘', 'âœ…', 'ğŸ“', 'ğŸ“Œ', 'ğŸ””', 'ğŸ’¼', 'ğŸ“', 'ğŸ ', 'ğŸ›’', 'ğŸ', 'ğŸ’°', 'ğŸ†', 'ğŸª', 'ğŸ¬', 'ğŸ“¸', 'ğŸµ', 'ğŸ¤', 'ğŸ’', 'ğŸ‘‘', 'ğŸŒˆ', 'ğŸ”¥', 'âš¡', 'âœ¨', 'ğŸ’¯', 'ğŸ‘¤', 'ğŸ‘¥', 'ğŸ†•', 'ğŸ†—', 'ğŸ†™', 'ğŸ”´', 'ğŸŸ ', 'ğŸŸ¡', 'ğŸŸ¢', 'ğŸ”µ', 'ğŸŸ£', 'âšª', 'âš«', 'ğŸŸ¤', 'ğŸ”¶', 'ğŸ”·', 'ğŸ”¸', 'ğŸ”¹'],
  'é¡”ãƒ»æ„Ÿæƒ…': ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜˜', 'ğŸ˜—', 'â˜ºï¸', 'ğŸ˜š', 'ğŸ˜™', 'ğŸ¥²', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ¤‘', 'ğŸ¤—', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤”', 'ğŸ¤', 'ğŸ¤¨', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜’', 'ğŸ™„', 'ğŸ˜¬', 'ğŸ¤¥', 'ğŸ˜Œ', 'ğŸ˜”', 'ğŸ˜ª', 'ğŸ¤¤', 'ğŸ˜´', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ¥´', 'ğŸ˜µ', 'ğŸ¤¯', 'ğŸ¤ ', 'ğŸ¥³', 'ğŸ¥¸', 'ğŸ˜', 'ğŸ¤“', 'ğŸ§', 'ğŸ˜•', 'ğŸ˜Ÿ', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜®', 'ğŸ˜¯', 'ğŸ˜²', 'ğŸ˜³', 'ğŸ¥º', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜±', 'ğŸ˜–', 'ğŸ˜£', 'ğŸ˜', 'ğŸ˜“', 'ğŸ˜©', 'ğŸ˜«', 'ğŸ¥±', 'ğŸ˜¤', 'ğŸ˜¡', 'ğŸ˜ ', 'ğŸ¤¬', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ’€', 'â˜ ï¸', 'ğŸ’©', 'ğŸ¤¡', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ‘»', 'ğŸ‘½', 'ğŸ‘¾', 'ğŸ¤–'],
  'äººãƒ»æ‰‹': ['ğŸ‘¤', 'ğŸ‘¥', 'ğŸ‘‹', 'ğŸ¤š', 'ğŸ–ï¸', 'âœ‹', 'ğŸ––', 'ğŸ‘Œ', 'ğŸ¤Œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ–•', 'ğŸ‘‡', 'â˜ï¸', 'ğŸ‘', 'ğŸ‘', 'âœŠ', 'ğŸ‘Š', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™', 'âœï¸', 'ğŸ’…', 'ğŸ¤³', 'ğŸ’ª', 'ğŸ¦¾', 'ğŸ¦¿', 'ğŸ¦µ', 'ğŸ¦¶', 'ğŸ‘‚', 'ğŸ¦»', 'ğŸ‘ƒ', 'ğŸ§ ', 'ğŸ«€', 'ğŸ«', 'ğŸ¦·', 'ğŸ¦´', 'ğŸ‘€', 'ğŸ‘ï¸', 'ğŸ‘…', 'ğŸ‘„'],
  'ä»•äº‹': ['ğŸ’¼', 'ğŸ“Š', 'ğŸ“ˆ', 'ğŸ“‰', 'ğŸ’¹', 'ğŸ—‚ï¸', 'ğŸ“‹', 'ğŸ“', 'ğŸ“‚', 'ğŸ—ƒï¸', 'ğŸ—„ï¸', 'ğŸ“‘', 'ğŸ—’ï¸', 'ğŸ““', 'ğŸ“”', 'ğŸ“’', 'ğŸ“•', 'ğŸ“—', 'ğŸ“˜', 'ğŸ“™', 'ğŸ“š', 'ğŸ“–', 'ğŸ”–', 'ğŸ“', 'ğŸ–‡ï¸', 'ğŸ“', 'ğŸ“', 'ğŸ§®', 'ğŸ“Œ', 'ğŸ“', 'âœ‚ï¸', 'ğŸ–Šï¸', 'ğŸ–‹ï¸', 'âœ’ï¸', 'ğŸ–Œï¸', 'ğŸ–ï¸', 'ğŸ“', 'âœï¸', 'ğŸ”', 'ğŸ”', 'ğŸ”', 'ğŸ”', 'ğŸ”’', 'ğŸ”“', 'ğŸ’°', 'ğŸ’´', 'ğŸ’µ', 'ğŸ’¶', 'ğŸ’·', 'ğŸ’¸', 'ğŸ’³', 'ğŸ§¾', 'ğŸ¦', 'ğŸ¢', 'ğŸ–¥ï¸', 'ğŸ–¨ï¸', 'âŒ¨ï¸', 'ğŸ–±ï¸'],
  'é€šä¿¡': ['ğŸ’¬', 'ğŸ’­', 'ğŸ—¨ï¸', 'ğŸ—¯ï¸', 'ğŸ“¢', 'ğŸ“£', 'ğŸ“¯', 'ğŸ””', 'ğŸ”•', 'ğŸ“±', 'ğŸ“²', 'â˜ï¸', 'ğŸ“', 'ğŸ“Ÿ', 'ğŸ“ ', 'âœ‰ï¸', 'ğŸ“§', 'ğŸ“¨', 'ğŸ“©', 'ğŸ“¤', 'ğŸ“¥', 'ğŸ“¦', 'ğŸ“«', 'ğŸ“ª', 'ğŸ“¬', 'ğŸ“­', 'ğŸ“®', 'ğŸ—³ï¸', 'ğŸ“', 'ğŸ’Œ', 'ğŸ“ƒ', 'ğŸ“„', 'ğŸ“œ', 'ğŸ“°', 'ğŸ—ï¸', 'ğŸ“‘', 'ğŸ”—'],
  'ãƒ„ãƒ¼ãƒ«': ['ğŸ”§', 'ğŸ”¨', 'âš’ï¸', 'ğŸ› ï¸', 'âš™ï¸', 'ğŸ”©', 'ğŸ—œï¸', 'â›ï¸', 'ğŸ”—', 'â›“ï¸', 'ğŸ§°', 'ğŸ”', 'ğŸ”‘', 'ğŸ—ï¸', 'ğŸ”’', 'ğŸ”“', 'ğŸ›¡ï¸', 'âš”ï¸', 'ğŸ—¡ï¸', 'ğŸª“', 'ğŸ§²', 'ğŸªš', 'ğŸ”ª', 'ğŸ—ƒï¸', 'ğŸ—„ï¸', 'ğŸ—‘ï¸', 'ğŸ§±', 'ğŸª¨', 'ğŸªµ', 'ğŸ§³', 'ğŸŒ¡ï¸', 'ğŸ§ª', 'ğŸ§«', 'ğŸ§¬', 'ğŸ”¬', 'ğŸ”­', 'ğŸ“¡', 'ğŸ’‰', 'ğŸ©¸', 'ğŸ’Š', 'ğŸ©¹', 'ğŸ©º', 'ğŸ”‹', 'ğŸ”Œ', 'ğŸ’»', 'ğŸ–¥ï¸', 'ğŸ–¨ï¸', 'âŒ¨ï¸', 'ğŸ–±ï¸'],
  'ã‚·ãƒ³ãƒœãƒ«': ['â­', 'ğŸŒŸ', 'âœ¨', 'ğŸ’«', 'âš¡', 'ğŸ”¥', 'ğŸ’¥', 'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ¤', 'ğŸ–¤', 'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’', 'ğŸ’˜', 'ğŸ’Ÿ', 'â˜®ï¸', 'âœï¸', 'â˜ªï¸', 'ğŸ•‰ï¸', 'â˜¸ï¸', 'âœ¡ï¸', 'ğŸ”¯', 'ğŸ•', 'â˜¯ï¸', 'â˜¦ï¸', 'ğŸ›', 'â›', 'â™ˆ', 'â™‰', 'â™Š', 'â™‹', 'â™Œ', 'â™', 'â™', 'â™', 'â™', 'â™‘', 'â™’', 'â™“', 'âŒ', 'â­•', 'ğŸ›‘', 'â›”', 'ğŸ“›', 'ğŸš«', 'ğŸ’¯', 'ğŸ’¢', 'â™¨ï¸', 'â—', 'â•', 'â“', 'â”', 'â€¼ï¸', 'â‰ï¸', 'âš ï¸', 'ğŸ”°', 'â™»ï¸', 'âœ…', 'â‡ï¸', 'âœ³ï¸', 'â', 'ğŸ”´', 'ğŸŸ ', 'ğŸŸ¡', 'ğŸŸ¢', 'ğŸ”µ', 'ğŸŸ£', 'ğŸŸ¤', 'âš«', 'âšª', 'ğŸ”¶', 'ğŸ”·', 'ğŸ”¸', 'ğŸ”¹', 'ğŸ”º', 'ğŸ”»', 'ğŸ”˜', 'ğŸ”³', 'ğŸ”²'],
  'å‹•ç‰©': ['ğŸ¶', 'ğŸ•', 'ğŸ¦®', 'ğŸ©', 'ğŸº', 'ğŸ¦Š', 'ğŸ¦', 'ğŸ±', 'ğŸˆ', 'ğŸ¦', 'ğŸ¯', 'ğŸ…', 'ğŸ†', 'ğŸ´', 'ğŸ', 'ğŸ¦„', 'ğŸ¦“', 'ğŸ¦Œ', 'ğŸ®', 'ğŸ‚', 'ğŸƒ', 'ğŸ„', 'ğŸ·', 'ğŸ–', 'ğŸ—', 'ğŸ½', 'ğŸ', 'ğŸ‘', 'ğŸ', 'ğŸª', 'ğŸ«', 'ğŸ¦™', 'ğŸ¦’', 'ğŸ˜', 'ğŸ¦', 'ğŸ¦›', 'ğŸ­', 'ğŸ', 'ğŸ€', 'ğŸ¹', 'ğŸ°', 'ğŸ‡', 'ğŸ¿ï¸', 'ğŸ¦”', 'ğŸ¦‡', 'ğŸ»', 'ğŸ¨', 'ğŸ¼', 'ğŸ¦¥', 'ğŸ¦¦', 'ğŸ¦¨', 'ğŸ¦˜', 'ğŸ¦¡', 'ğŸ¾', 'ğŸ¦ƒ', 'ğŸ”', 'ğŸ“', 'ğŸ£', 'ğŸ¤', 'ğŸ¥', 'ğŸ¦', 'ğŸ§', 'ğŸ•Šï¸', 'ğŸ¦…', 'ğŸ¦†', 'ğŸ¦¢', 'ğŸ¦‰', 'ğŸ¦©', 'ğŸ¦š', 'ğŸ¦œ', 'ğŸ¸', 'ğŸŠ', 'ğŸ¢', 'ğŸ¦', 'ğŸ', 'ğŸ²', 'ğŸ‰', 'ğŸ¦•', 'ğŸ¦–', 'ğŸ³', 'ğŸ‹', 'ğŸ¬', 'ğŸŸ', 'ğŸ ', 'ğŸ¡', 'ğŸ¦ˆ', 'ğŸ™', 'ğŸš', 'ğŸŒ', 'ğŸ¦‹', 'ğŸ›', 'ğŸœ', 'ğŸ', 'ğŸ', 'ğŸ¦—', 'ğŸ•·ï¸', 'ğŸ•¸ï¸', 'ğŸ¦‚', 'ğŸ¦Ÿ', 'ğŸ¦ '],
  'æ¤ç‰©': ['ğŸŒ¸', 'ğŸ’®', 'ğŸµï¸', 'ğŸŒ¹', 'ğŸ¥€', 'ğŸŒº', 'ğŸŒ»', 'ğŸŒ¼', 'ğŸŒ·', 'ğŸŒ±', 'ğŸª´', 'ğŸŒ²', 'ğŸŒ³', 'ğŸŒ´', 'ğŸŒµ', 'ğŸŒ¾', 'ğŸŒ¿', 'â˜˜ï¸', 'ğŸ€', 'ğŸ', 'ğŸ‚', 'ğŸƒ', 'ğŸ„', 'ğŸŒ°'],
  'é£Ÿã¹ç‰©': ['ğŸ‡', 'ğŸˆ', 'ğŸ‰', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ', 'ğŸ¥­', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ‘', 'ğŸ’', 'ğŸ“', 'ğŸ«', 'ğŸ¥', 'ğŸ…', 'ğŸ¥¥', 'ğŸ¥‘', 'ğŸ†', 'ğŸ¥”', 'ğŸ¥•', 'ğŸŒ½', 'ğŸŒ¶ï¸', 'ğŸ¥’', 'ğŸ¥¬', 'ğŸ¥¦', 'ğŸ§„', 'ğŸ§…', 'ğŸ„', 'ğŸ¥œ', 'ğŸŒ°', 'ğŸ', 'ğŸ¥', 'ğŸ¥–', 'ğŸ¥¨', 'ğŸ¥¯', 'ğŸ¥', 'ğŸ§‡', 'ğŸ§€', 'ğŸ–', 'ğŸ—', 'ğŸ¥©', 'ğŸ¥“', 'ğŸ”', 'ğŸŸ', 'ğŸ•', 'ğŸŒ­', 'ğŸ¥ª', 'ğŸŒ®', 'ğŸŒ¯', 'ğŸ¥™', 'ğŸ§†', 'ğŸ¥š', 'ğŸ³', 'ğŸ¥˜', 'ğŸ²', 'ğŸ¥£', 'ğŸ¥—', 'ğŸ¿', 'ğŸ§ˆ', 'ğŸ§‚', 'ğŸ¥«', 'ğŸ±', 'ğŸ˜', 'ğŸ™', 'ğŸš', 'ğŸ›', 'ğŸœ', 'ğŸ', 'ğŸ ', 'ğŸ¢', 'ğŸ£', 'ğŸ¤', 'ğŸ¥', 'ğŸ¡', 'ğŸ¥Ÿ', 'ğŸ¥ ', 'ğŸ¥¡', 'ğŸ¦', 'ğŸ§', 'ğŸ¨', 'ğŸ©', 'ğŸª', 'ğŸ‚', 'ğŸ°', 'ğŸ§', 'ğŸ¥§', 'ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ®', 'ğŸ¯'],
  'é£²ã¿ç‰©': ['ğŸ¼', 'ğŸ¥›', 'â˜•', 'ğŸ«–', 'ğŸµ', 'ğŸ¶', 'ğŸ¾', 'ğŸ·', 'ğŸ¸', 'ğŸ¹', 'ğŸº', 'ğŸ»', 'ğŸ¥‚', 'ğŸ¥ƒ', 'ğŸ¥¤', 'ğŸ§‹', 'ğŸ§ƒ', 'ğŸ§‰', 'ğŸ§Š'],
  'ã‚¹ãƒãƒ¼ãƒ„': ['âš½', 'ğŸ€', 'ğŸˆ', 'âš¾', 'ğŸ¥', 'ğŸ¾', 'ğŸ', 'ğŸ‰', 'ğŸ¥', 'ğŸ±', 'ğŸª€', 'ğŸ“', 'ğŸ¸', 'ğŸ’', 'ğŸ‘', 'ğŸ¥', 'ğŸ', 'ğŸ¥…', 'â›³', 'ğŸ¹', 'ğŸ£', 'ğŸ¤¿', 'ğŸ¥Š', 'ğŸ¥‹', 'ğŸ½', 'ğŸ›¹', 'ğŸ›¼', 'ğŸ›·', 'â›¸ï¸', 'ğŸ¥Œ', 'ğŸ¿', 'â›·ï¸', 'ğŸ‚', 'ğŸ‹ï¸', 'ğŸ¤¼', 'ğŸ¤¸', 'â›¹ï¸', 'ğŸ¤º', 'ğŸ¤¾', 'ğŸŒï¸', 'ğŸ‡', 'ğŸ„', 'ğŸš£', 'ğŸŠ', 'ğŸš´', 'ğŸšµ', 'ğŸ–ï¸', 'ğŸ…', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ†', 'ğŸµï¸', 'ğŸ—ï¸', 'ğŸ«', 'ğŸŸï¸'],
  'éŸ³æ¥½ãƒ»èŠ¸è¡“': ['ğŸ®', 'ğŸ•¹ï¸', 'ğŸ¯', 'ğŸ³', 'ğŸ°', 'ğŸ²', 'ğŸ§©', 'â™Ÿï¸', 'ğŸ­', 'ğŸ¨', 'ğŸ§µ', 'ğŸª¡', 'ğŸ§¶', 'ğŸ¼', 'ğŸµ', 'ğŸ¶', 'ğŸ¹', 'ğŸ¥', 'ğŸª˜', 'ğŸ·', 'ğŸº', 'ğŸ¸', 'ğŸª•', 'ğŸ»', 'ğŸ¤', 'ğŸ§', 'ğŸšï¸', 'ğŸ›ï¸', 'ğŸ“»', 'ğŸ¬', 'ğŸ¥', 'ğŸ“½ï¸', 'ğŸï¸', 'ğŸ“¹', 'ğŸ“º', 'ğŸ“·', 'ğŸ“¸', 'ğŸ“¼', 'ğŸª', 'ğŸ¤¹', 'ğŸ­', 'ğŸ©°'],
  'ä¹—ã‚Šç‰©': ['ğŸš—', 'ğŸš•', 'ğŸš™', 'ğŸšŒ', 'ğŸš', 'ğŸï¸', 'ğŸš“', 'ğŸš‘', 'ğŸš’', 'ğŸš', 'ğŸ›»', 'ğŸšš', 'ğŸš›', 'ğŸšœ', 'ğŸ›´', 'ğŸš²', 'ğŸ›µ', 'ğŸï¸', 'ğŸ›º', 'ğŸš¨', 'ğŸš”', 'ğŸš', 'ğŸš˜', 'ğŸš–', 'ğŸš¡', 'ğŸš ', 'ğŸšŸ', 'ğŸšƒ', 'ğŸš‹', 'ğŸš', 'ğŸš', 'ğŸš„', 'ğŸš…', 'ğŸšˆ', 'ğŸš‚', 'ğŸš†', 'ğŸš‡', 'ğŸšŠ', 'ğŸš‰', 'âœˆï¸', 'ğŸ›«', 'ğŸ›¬', 'ğŸ›©ï¸', 'ğŸ’º', 'ğŸ›°ï¸', 'ğŸš€', 'ğŸ›¸', 'ğŸš', 'ğŸ›¶', 'â›µ', 'ğŸš¤', 'ğŸ›¥ï¸', 'ğŸ›³ï¸', 'â›´ï¸', 'ğŸš¢', 'âš“', 'â›½', 'ğŸš§', 'ğŸš¦', 'ğŸš¥', 'ğŸš'],
  'å¤©æ°—': ['â˜€ï¸', 'ğŸŒ¤ï¸', 'â›…', 'ğŸŒ¥ï¸', 'â˜ï¸', 'ğŸŒ¦ï¸', 'ğŸŒ§ï¸', 'â›ˆï¸', 'ğŸŒ©ï¸', 'ğŸŒ¨ï¸', 'â„ï¸', 'â˜ƒï¸', 'â›„', 'ğŸŒ¬ï¸', 'ğŸ’¨', 'ğŸŒªï¸', 'ğŸŒ«ï¸', 'ğŸŒŠ', 'ğŸ’§', 'ğŸ’¦', 'â˜”', 'â˜‚ï¸', 'ğŸŒˆ', 'ğŸŒ™', 'ğŸŒ›', 'ğŸŒœ', 'ğŸŒš', 'ğŸŒ•', 'ğŸŒ–', 'ğŸŒ—', 'ğŸŒ˜', 'ğŸŒ‘', 'ğŸŒ’', 'ğŸŒ“', 'ğŸŒ”', 'ğŸŒ', 'ğŸŒ', 'ğŸª', 'â­', 'ğŸŒŸ', 'âœ¨', 'ğŸ’«', 'â˜„ï¸', 'ğŸŒ ', 'ğŸŒŒ'],
  'æ™‚è¨ˆ': ['â°', 'â±ï¸', 'â²ï¸', 'ğŸ•°ï¸', 'âŒ›', 'â³', 'ğŸ“…', 'ğŸ“†', 'ğŸ—“ï¸', 'ğŸ•', 'ğŸ•‘', 'ğŸ•’', 'ğŸ•“', 'ğŸ•”', 'ğŸ••', 'ğŸ•–', 'ğŸ•—', 'ğŸ•˜', 'ğŸ•™', 'ğŸ•š', 'ğŸ•›', 'ğŸ•œ', 'ğŸ•', 'ğŸ•', 'ğŸ•Ÿ', 'ğŸ• ', 'ğŸ•¡', 'ğŸ•¢', 'ğŸ•£', 'ğŸ•¤', 'ğŸ•¥', 'ğŸ•¦', 'ğŸ•§'],
  'æ——': ['ğŸ', 'ğŸš©', 'ğŸŒ', 'ğŸ´', 'ğŸ³ï¸', 'ğŸ³ï¸â€ğŸŒˆ', 'ğŸ³ï¸â€âš§ï¸', 'ğŸ´â€â˜ ï¸', 'ğŸ‡¯ğŸ‡µ', 'ğŸ‡ºğŸ‡¸', 'ğŸ‡¬ğŸ‡§', 'ğŸ‡«ğŸ‡·', 'ğŸ‡©ğŸ‡ª', 'ğŸ‡®ğŸ‡¹', 'ğŸ‡ªğŸ‡¸', 'ğŸ‡¨ğŸ‡³', 'ğŸ‡°ğŸ‡·', 'ğŸ‡¹ğŸ‡¼', 'ğŸ‡­ğŸ‡°', 'ğŸ‡¸ğŸ‡¬', 'ğŸ‡¹ğŸ‡­', 'ğŸ‡»ğŸ‡³', 'ğŸ‡®ğŸ‡©', 'ğŸ‡µğŸ‡­', 'ğŸ‡²ğŸ‡¾', 'ğŸ‡¦ğŸ‡º', 'ğŸ‡³ğŸ‡¿', 'ğŸ‡¨ğŸ‡¦', 'ğŸ‡§ğŸ‡·', 'ğŸ‡²ğŸ‡½', 'ğŸ‡·ğŸ‡º', 'ğŸ‡®ğŸ‡³', 'ğŸ‡¸ğŸ‡¦', 'ğŸ‡¦ğŸ‡ª', 'ğŸ‡ªğŸ‡¬', 'ğŸ‡¿ğŸ‡¦', 'ğŸ‡³ğŸ‡¬', 'ğŸ‡°ğŸ‡ª', 'ğŸ‡ªğŸ‡º']
};

// ============================================================
// Cache functions
// ============================================================
function crlSaveRoomsToCache(rooms) {
  try {
    sessionStorage.setItem(CRL_ROOMS_CACHE_KEY, JSON.stringify({ rooms: rooms, timestamp: Date.now() }));
  } catch (e) { /* ignore */ }
}

function crlRestoreRoomsFromCache() {
  try {
    var cached = sessionStorage.getItem(CRL_ROOMS_CACHE_KEY);
    if (!cached) return null;
    var data = JSON.parse(cached);
    if (Date.now() - (data.timestamp || 0) > CRL_CACHE_DURATION_MS) return null;
    return data.rooms;
  } catch (e) { return null; }
}

function crlSaveUsersToCache(users) {
  try {
    sessionStorage.setItem(CRL_USERS_CACHE_KEY, JSON.stringify({ users: users, timestamp: Date.now() }));
  } catch (e) { /* ignore */ }
}

function crlRestoreUsersFromCache() {
  try {
    var cached = sessionStorage.getItem(CRL_USERS_CACHE_KEY);
    if (!cached) return null;
    var data = JSON.parse(cached);
    if (Date.now() - (data.timestamp || 0) > CRL_CACHE_DURATION_MS) return null;
    return data.users;
  } catch (e) { return null; }
}

// ============================================================
// Badge sync
// ============================================================
function crlSyncBadgeWithServiceWorker() {
  var totalUnread = 0;
  crlRoomUnreadCounts.forEach(function(count) { totalUnread += count; });

  // ãƒœãƒˆãƒ ãƒŠãƒ“ã®ãƒãƒ£ãƒƒãƒˆãƒãƒƒã‚¸ã‚‚æ›´æ–°ï¼ˆè¦ªã‚·ã‚§ãƒ«ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—ï¼‰
  if (typeof updateBottomNavChatBadge === 'function') {
    updateBottomNavChatBadge(totalUnread);
  }
  // è¦ªã‚·ã‚§ãƒ«ã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚‚åŒæœŸ
  if (typeof updateChatBadge === 'function') {
    updateChatBadge(totalUnread);
  }

  if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
    navigator.serviceWorker.controller.postMessage({
      type: 'SYNC_BADGE_COUNT',
      chatCount: totalUnread,
      todoCount: 0
    });
  }
  if ('setAppBadge' in navigator) {
    if (totalUnread > 0) {
      navigator.setAppBadge(totalUnread).catch(function() {});
    } else {
      navigator.clearAppBadge().catch(function() {});
    }
  }
}

// ============================================================
// Emoji Picker
// ============================================================
function crlOpenEmojiPicker() {
  var modal = document.getElementById('crlEmojiPickerModal');
  if (modal) {
    modal.classList.add('active');
    crlRenderEmojiCategories();
    crlRenderEmojiGrid(crlCurrentEmojiCategory);
  }
}

function crlCloseEmojiPicker() {
  var modal = document.getElementById('crlEmojiPickerModal');
  if (modal) modal.classList.remove('active');
}

function crlRenderEmojiCategories() {
  var container = document.getElementById('crlEmojiCategories');
  if (!container) return;
  container.innerHTML = '';
  Object.keys(crlEmojiCategories).forEach(function(category) {
    var btn = document.createElement('button');
    btn.className = 'crl-emoji-category-btn';
    btn.textContent = category;
    if (category === crlCurrentEmojiCategory) {
      btn.style.setProperty('background-color', '#1E8FBF', 'important');
      btn.style.setProperty('color', '#ffffff', 'important');
      btn.style.setProperty('font-weight', '600', 'important');
      btn.style.setProperty('border-radius', '8px', 'important');
    } else {
      btn.style.setProperty('background-color', 'transparent', 'important');
      btn.style.setProperty('color', '#718096', 'important');
    }
    btn.onclick = function() {
      crlCurrentEmojiCategory = category;
      crlRenderEmojiCategories();
      crlRenderEmojiGrid(category);
    };
    container.appendChild(btn);
  });
}

function crlRenderEmojiGrid(category) {
  var grid = document.getElementById('crlEmojiGrid');
  if (!grid) return;
  grid.innerHTML = '';
  var emojis = crlEmojiCategories[category] || [];
  emojis.forEach(function(emoji) {
    var item = document.createElement('div');
    item.className = 'crl-emoji-item';
    item.textContent = emoji;
    item.onclick = function() { crlSelectEmoji(emoji); };
    grid.appendChild(item);
  });
}

function crlSelectEmoji(emoji) {
  var iconInput = document.getElementById('crlRoomIconSelect');
  var preview = document.getElementById('crlSelectedEmojiPreview');
  if (iconInput) iconInput.value = emoji;
  if (preview) preview.textContent = emoji;
  crlCloseEmojiPicker();
}

// ============================================================
// User icon helpers
// ============================================================
function crlGetUserIconUrl(userName) {
  if (!userName || !crlUsersCache || crlUsersCache.length === 0) return null;
  var user = crlUsersCache.find(function(u) { return u.userName === userName; });
  if (user && (user.userIconUrl || user.photoURL)) return user.userIconUrl || user.photoURL;
  return null;
}

function crlGetUserIconUrlByEmail(email) {
  if (!email || !crlUsersCache || crlUsersCache.length === 0) return null;
  var user = crlUsersCache.find(function(u) { return u.id === email || u.userEmail === email; });
  if (user && (user.userIconUrl || user.photoURL)) return user.userIconUrl || user.photoURL;
  return null;
}

// ============================================================
// Open room - SPA navigation
// ============================================================
function crlOpenRoom(roomId) {
  console.log('[CRL] ãƒ«ãƒ¼ãƒ é¸æŠ:', roomId);

  var searchInput = document.getElementById('crlSearchInput');
  var searchQuery = searchInput ? searchInput.value.trim() : '';

  // Set roomId in localStorage for chat-room page
  localStorage.setItem('current_chat_room_id', roomId);
  if (searchQuery) {
    localStorage.setItem('current_chat_search_query', searchQuery);
  } else {
    localStorage.removeItem('current_chat_search_query');
  }

  // Navigate to chat-room page
  navigateToPage('chat-room');
}

// ============================================================
// Append room to UI
// ============================================================
function crlAppendRoom(room) {
  var container = document.getElementById('crlRoomsContainer');
  if (!container) return;

  var wrapper = document.createElement('div');
  wrapper.className = 'crl-room-item-wrapper';
  wrapper.dataset.roomId = room.id;

  var isMuted = room.mutedBy && Array.isArray(room.mutedBy) && room.mutedBy.includes(crlCurrentUserName);
  var isPinned = room.pinnedBy && Array.isArray(room.pinnedBy) && room.pinnedBy.includes(crlCurrentUserName);

  // Right swipe buttons (hide/delete)
  var buttonsContainer = document.createElement('div');
  buttonsContainer.className = 'crl-swipe-buttons';

  var hideBtn = document.createElement('div');
  hideBtn.className = 'crl-hide-button';
  hideBtn.textContent = 'éè¡¨ç¤º';
  hideBtn.onclick = function(e) { e.stopPropagation(); crlToggleHideRoom(room.id); };

  var deleteBtn = document.createElement('div');
  deleteBtn.className = 'crl-delete-button';
  deleteBtn.textContent = 'å‰Šé™¤';
  deleteBtn.onclick = function(e) { e.stopPropagation(); crlConfirmDeleteRoom(room.id, room.name || 'ä¸æ˜ãªãƒ«ãƒ¼ãƒ '); };

  buttonsContainer.appendChild(hideBtn);
  buttonsContainer.appendChild(deleteBtn);

  // Left swipe buttons (mute/pin)
  var buttonsContainerLeft = document.createElement('div');
  buttonsContainerLeft.className = 'crl-swipe-buttons-left';

  var muteBtn = document.createElement('div');
  muteBtn.className = 'crl-mute-button';
  muteBtn.innerHTML = isMuted ? '<i class="bi bi-bell"></i>' : '<i class="bi bi-bell-slash"></i>';
  muteBtn.onclick = function(e) { e.stopPropagation(); crlToggleMuteRoom(room.id, isMuted); };

  var pinBtn = document.createElement('div');
  pinBtn.className = 'crl-pin-button';
  pinBtn.innerHTML = isPinned ? '<i class="bi bi-pin-fill"></i>' : '<i class="bi bi-pin-angle"></i>';
  pinBtn.onclick = function(e) { e.stopPropagation(); crlTogglePinRoom(room.id, isPinned); };

  buttonsContainerLeft.appendChild(muteBtn);
  buttonsContainerLeft.appendChild(pinBtn);

  var item = document.createElement('div');
  item.className = 'crl-room-item';
  item.onclick = function() {
    if (crlCurrentlySwipedItem === item) {
      item.style.transform = 'translateX(0)';
      crlCurrentlySwipedItem = null;
      return;
    }
    if (crlCurrentlySwipedItem) {
      crlCurrentlySwipedItem.style.transform = 'translateX(0)';
      crlCurrentlySwipedItem = null;
    }
    crlOpenRoom(room.id);
  };

  // Icon
  var icon = document.createElement('div');
  icon.className = 'crl-room-icon';

  if (room.type === 'direct') {
    var otherUser = null;
    var otherUserEmail = null;
    if (room.memberEmails && room.memberEmails.length === 2) {
      otherUserEmail = room.memberEmails.find(function(e) { return e !== crlCurrentUserEmail; });
      var otherUserData = crlUsersCache.find(function(u) { return u.id === otherUserEmail || u.userEmail === otherUserEmail; });
      otherUser = (otherUserData && otherUserData.userName) || (otherUserEmail ? otherUserEmail.split('@')[0] : 'ä¸æ˜');
    } else if (room.members && room.members.length === 2) {
      otherUser = room.members.find(function(m) { return m !== crlCurrentUserName; });
    }
    var iconUrl = crlGetUserIconUrl(otherUser) || (otherUserEmail ? crlGetUserIconUrlByEmail(otherUserEmail) : null);
    if (iconUrl) {
      var img = document.createElement('img');
      img.src = iconUrl;
      img.alt = otherUser || 'åŒ¿å';
      img.style.width = '48px'; img.style.height = '48px';
      img.style.borderRadius = '50%'; img.style.objectFit = 'cover';
      img.onerror = function() {
        icon.textContent = (otherUser || 'åŒ¿').charAt(0);
        icon.classList.add('has-emoji');
        icon.style.color = 'white'; icon.style.fontWeight = '600';
      };
      icon.appendChild(img);
    } else {
      icon.textContent = (otherUser || 'åŒ¿').charAt(0);
      icon.classList.add('has-emoji');
      icon.style.color = 'white'; icon.style.fontWeight = '600';
    }
  } else {
    if (room.id === 'system-notifications') {
      icon.textContent = 'ğŸ‘‘';
    } else {
      icon.textContent = room.icon || 'ğŸ’¬';
    }
    icon.classList.add('has-emoji');
  }

  // Content
  var content = document.createElement('div');
  content.className = 'crl-room-content';

  var header = document.createElement('div');
  header.className = 'crl-room-header';

  var name = document.createElement('div');
  name.className = 'crl-room-name';

  if (room.type === 'direct') {
    var otherMemberName = 'ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼';
    if (room.memberEmails && room.memberEmails.length === 2) {
      var otherEmail = room.memberEmails.find(function(e) { return e !== crlCurrentUserEmail; });
      var otherUD = crlUsersCache.find(function(u) { return u.id === otherEmail || u.userEmail === otherEmail; });
      otherMemberName = (otherUD && otherUD.userName) || (otherEmail ? otherEmail.split('@')[0] : 'ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼');
    } else if (room.members && Array.isArray(room.members)) {
      otherMemberName = room.members.find(function(m) { return m !== crlCurrentUserName; }) || 'ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼';
    }
    name.textContent = otherMemberName;
  } else {
    var displayName = room.name || 'ç„¡é¡Œã®ãƒ«ãƒ¼ãƒ ';
    displayName = displayName.replace(/^[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]+\s*/u, '');
    name.textContent = displayName;
  }

  if (isPinned) {
    var pinIcon = document.createElement('i');
    pinIcon.className = 'bi bi-pin-fill';
    pinIcon.style.marginLeft = '6px'; pinIcon.style.fontSize = '12px'; pinIcon.style.color = '#3b82f6';
    name.appendChild(pinIcon);
  }
  if (isMuted) {
    var muteIcon = document.createElement('i');
    muteIcon.className = 'bi bi-bell-slash-fill';
    muteIcon.style.marginLeft = '6px'; muteIcon.style.fontSize = '12px'; muteIcon.style.color = '#9ca3af';
    name.appendChild(muteIcon);
  }

  // Block check
  var isBlockedRoom = false;
  if (room.type === 'direct' && crlCurrentUserBlockedList.length > 0) {
    var otherMember2 = null;
    if (room.memberEmails && room.memberEmails.length === 2) {
      var oe2 = room.memberEmails.find(function(e) { return e !== crlCurrentUserEmail; });
      var oud2 = crlUsersCache.find(function(u) { return u.id === oe2 || u.userEmail === oe2; });
      otherMember2 = (oud2 && oud2.userName) || oe2;
    } else if (room.members && Array.isArray(room.members)) {
      otherMember2 = room.members.find(function(m) { return m !== crlCurrentUserName; });
    }
    if (otherMember2) {
      isBlockedRoom = crlCurrentUserBlockedList.some(function(blocked) {
        return blocked.toLowerCase() === otherMember2.toLowerCase();
      });
    }
  }

  // Meta (time + badge)
  var meta = document.createElement('div');
  meta.className = 'crl-room-meta';

  var time = document.createElement('div');
  time.className = 'crl-room-time';

  if (isBlockedRoom) {
    time.textContent = '';
  } else if (room.lastMessageAt && room.lastMessageAt.toDate) {
    var date = room.lastMessageAt.toDate();
    var now = new Date();
    var diffMs = now - date;
    var diffMins = Math.floor(diffMs / 60000);
    var diffHours = Math.floor(diffMs / 3600000);
    var diffDays = Math.floor(diffMs / 86400000);
    if (diffMins < 1) time.textContent = 'ãŸã£ãŸä»Š';
    else if (diffMins < 60) time.textContent = diffMins + 'åˆ†å‰';
    else if (diffHours < 24) time.textContent = diffHours + 'æ™‚é–“å‰';
    else if (diffDays < 7) time.textContent = diffDays + 'æ—¥å‰';
    else time.textContent = date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
  }

  meta.appendChild(time);

  var badge = document.createElement('div');
  badge.className = 'crl-unread-badge';
  badge.id = 'crl-unread-badge-' + room.id;
  badge.style.display = 'none';
  if (isBlockedRoom) badge.dataset.blocked = 'true';
  meta.appendChild(badge);

  header.appendChild(name);
  header.appendChild(meta);

  // Preview
  var preview = document.createElement('div');
  preview.className = 'crl-room-preview';

  var lastMessage = document.createElement('div');
  lastMessage.className = 'crl-room-last-message';

  if (isBlockedRoom) {
    lastMessage.innerHTML = '<i class="bi bi-slash-circle"></i> ãƒ–ãƒ­ãƒƒã‚¯ä¸­';
    lastMessage.style.color = '#9ca3af';
    lastMessage.style.fontStyle = 'italic';
  } else if (room.lastMessage) {
    var sender = room.lastMessageBy || '';
    var formatLastMsg = function(msg) {
      if (msg.match(/^é€šè©±\s*\(/)) return '<i class="bi bi-telephone-fill"></i> ' + msg;
      else if (msg === 'éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸' || msg === 'ğŸ¤ éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸') return '<i class="bi bi-mic-fill"></i> éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸';
      else if (msg === 'ãƒãƒ¼ãƒˆã‚’å…±æœ‰ã—ã¾ã—ãŸ' || msg.startsWith('ğŸ“')) return '<i class="bi bi-journal-text"></i> ãƒãƒ¼ãƒˆã‚’å…±æœ‰ã—ã¾ã—ãŸ';
      else if (msg === 'ç”»åƒã‚’é€ä¿¡ã—ã¾ã—ãŸ') return '<i class="bi bi-image"></i> ç”»åƒ';
      else if (msg === 'ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ï¼‰' || msg.includes('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€ä¿¡')) return '<i class="bi bi-file-earmark-fill"></i> ãƒ•ã‚¡ã‚¤ãƒ«';
      var result = msg.replace(/ğŸ†•\s*/g, '<span style="background:#ef4444;color:#fff;font-size:10px;padding:1px 4px;border-radius:3px;margin-right:4px;">NEW</span>');
      return result.replace(/^[ğŸ“ğŸ“ğŸ¤ğŸ“ğŸ“¦ğŸ–¼ï¸]\s*/, '');
    };
    if (room.type === 'direct' || sender === 'ã‚·ã‚¹ãƒ†ãƒ ') {
      lastMessage.innerHTML = formatLastMsg(room.lastMessage);
    } else {
      var escapedSender = sender.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      lastMessage.innerHTML = escapedSender + ': ' + formatLastMsg(room.lastMessage);
    }
  } else {
    lastMessage.textContent = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“';
  }

  preview.appendChild(lastMessage);
  content.appendChild(header);
  content.appendChild(preview);
  item.appendChild(icon);
  item.appendChild(content);

  crlSetupSwipeGesture(wrapper, item);

  wrapper.appendChild(buttonsContainerLeft);
  wrapper.appendChild(buttonsContainer);
  wrapper.appendChild(item);
  container.appendChild(wrapper);

  // Unread count listener
  if (crlCurrentUserEmail && !isBlockedRoom) {
    var db = window.spaFirestoreDb || (window.firebase && firebase.firestore());
    if (db) {
      var unreadRef = db.collection('rooms').doc(room.id).collection('unreadCounts').doc(crlCurrentUserEmail);
      var unsubUnread = unreadRef.onSnapshot(function(unreadDoc) {
        var badgeEl = document.getElementById('crl-unread-badge-' + room.id);
        var unreadData = unreadDoc.data();
        var unreadCount = (unreadData && unreadData.unreadCount) || 0;

        var prevCount = crlRoomUnreadCounts.get(room.id) || 0;
        if (prevCount !== unreadCount) {
          crlRoomUnreadCounts.set(room.id, unreadCount);
          crlSyncBadgeWithServiceWorker();
        }

        if (badgeEl) {
          if (badgeEl.dataset.blocked === 'true') { badgeEl.style.display = 'none'; return; }
          if (unreadCount > 0) {
            badgeEl.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
            badgeEl.style.display = 'inline-block';
          } else {
            badgeEl.style.display = 'none';
          }
        }
      }, function(error) {
        console.error('[CRL] æœªèª­ã‚«ã‚¦ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', room.id, error);
      });
      crlUnreadListeners.push(unsubUnread);
    }
  } else if (isBlockedRoom) {
    crlRoomUnreadCounts.set(room.id, 0);
  }
}

// ============================================================
// Swipe gesture
// ============================================================
function crlCloseAllSwipes() {
  if (crlCurrentlySwipedItem) {
    crlCurrentlySwipedItem.style.transform = 'translateX(0)';
    crlCurrentlySwipedItem = null;
  }
}

function crlSetupSwipeGesture(wrapper, item) {
  var startX = 0, startY = 0, currentX = 0;
  var isSwiping = false, isScrolling = false, directionLocked = false;
  var rightButtonWidth = 140, leftButtonWidth = 140;

  item.addEventListener('touchstart', function(e) {
    if (crlCurrentlySwipedItem && crlCurrentlySwipedItem !== item) {
      crlCurrentlySwipedItem.style.transform = 'translateX(0)';
    }
    startX = e.touches[0].clientX; startY = e.touches[0].clientY;
    currentX = startX; isSwiping = false; isScrolling = false; directionLocked = false;
    item.classList.add('swiping');
  });

  item.addEventListener('touchmove', function(e) {
    var deltaX = Math.abs(e.touches[0].clientX - startX);
    var deltaY = Math.abs(e.touches[0].clientY - startY);
    if (!directionLocked && (deltaX > 10 || deltaY > 10)) {
      directionLocked = true;
      if (deltaX > deltaY * 1.5 && deltaX > 15) { isSwiping = true; isScrolling = false; }
      else { isSwiping = false; isScrolling = true; }
    }
    if (isSwiping) {
      e.preventDefault();
      currentX = e.touches[0].clientX;
      var diff = currentX - startX;
      if (diff < 0) item.style.transform = 'translateX(' + Math.max(diff, -rightButtonWidth) + 'px)';
      else if (diff > 0) item.style.transform = 'translateX(' + Math.min(diff, leftButtonWidth) + 'px)';
    }
  }, { passive: false });

  item.addEventListener('touchend', function(e) {
    item.classList.remove('swiping');
    if (isSwiping) {
      var diff = currentX - startX;
      if (diff < -40) { item.style.transform = 'translateX(-' + rightButtonWidth + 'px)'; crlCurrentlySwipedItem = item; }
      else if (diff > 40) { item.style.transform = 'translateX(' + leftButtonWidth + 'px)'; crlCurrentlySwipedItem = item; }
      else { item.style.transform = 'translateX(0)'; if (crlCurrentlySwipedItem === item) crlCurrentlySwipedItem = null; }
    }
    isSwiping = false; isScrolling = false; directionLocked = false;
    startX = 0; startY = 0; currentX = 0;
  });
}

// ============================================================
// Firestore operations (mute, pin, hide, delete)
// ============================================================
function crlGetDb() {
  return window.spaFirestoreDb || (window.firebase && firebase.firestore());
}

async function crlToggleMuteRoom(roomId, currentlyMuted) {
  try {
    var db = crlGetDb(); if (!db) return;
    var roomRef = db.collection('rooms').doc(roomId);
    var roomSnap = await roomRef.get();
    if (!roomSnap.exists) return;
    var mutedBy = roomSnap.data().mutedBy || [];
    if (currentlyMuted) mutedBy = mutedBy.filter(function(u) { return u !== crlCurrentUserName; });
    else if (!mutedBy.includes(crlCurrentUserName)) mutedBy.push(crlCurrentUserName);
    await roomRef.update({ mutedBy: mutedBy });
  } catch (error) {
    console.error('[CRL] ãƒŸãƒ¥ãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
    alert('ãƒŸãƒ¥ãƒ¼ãƒˆè¨­å®šã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

async function crlTogglePinRoom(roomId, currentlyPinned) {
  try {
    var db = crlGetDb(); if (!db) return;
    var roomRef = db.collection('rooms').doc(roomId);
    var roomSnap = await roomRef.get();
    if (!roomSnap.exists) return;
    var pinnedBy = roomSnap.data().pinnedBy || [];
    if (currentlyPinned) pinnedBy = pinnedBy.filter(function(u) { return u !== crlCurrentUserName; });
    else if (!pinnedBy.includes(crlCurrentUserName)) pinnedBy.push(crlCurrentUserName);
    await roomRef.update({ pinnedBy: pinnedBy });
  } catch (error) {
    console.error('[CRL] ãƒ”ãƒ³ç•™ã‚ã‚¨ãƒ©ãƒ¼:', error);
    alert('ãƒ”ãƒ³ç•™ã‚è¨­å®šã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

async function crlToggleHideRoom(roomId) {
  try {
    var db = crlGetDb(); if (!db) return;
    var roomRef = db.collection('rooms').doc(roomId);
    var roomSnap = await roomRef.get();
    if (!roomSnap.exists) return;
    var hiddenBy = roomSnap.data().hiddenBy || [];
    if (!hiddenBy.includes(crlCurrentUserName)) hiddenBy.push(crlCurrentUserName);
    await roomRef.update({ hiddenBy: hiddenBy });
    crlCloseAllSwipes();
  } catch (error) {
    console.error('[CRL] éè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
    alert('éè¡¨ç¤ºè¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

function crlConfirmDeleteRoom(roomId, roomName) {
  if (confirm('ã€Œ' + (roomName || 'ä¸æ˜ãªãƒ«ãƒ¼ãƒ ') + 'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nä¼šè©±å±¥æ­´ã‚‚å®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
    crlDeleteRoom(roomId);
  }
}

async function crlDeleteRoom(roomId) {
  try {
    var db = crlGetDb(); if (!db) return;
    var messagesSnap = await db.collection('rooms').doc(roomId).collection('messages').get();
    var batch1 = [];
    messagesSnap.forEach(function(d) { batch1.push(d.ref.delete()); });
    if (batch1.length > 0) await Promise.all(batch1);

    var unreadSnap = await db.collection('rooms').doc(roomId).collection('unreadCounts').get();
    var batch2 = [];
    unreadSnap.forEach(function(d) { batch2.push(d.ref.delete()); });
    if (batch2.length > 0) await Promise.all(batch2);

    await db.collection('rooms').doc(roomId).delete();

    var wrapper = document.querySelector('#spa-page-chat-rooms .crl-room-item-wrapper[data-room-id="' + roomId + '"]');
    if (wrapper) {
      wrapper.style.opacity = '0';
      wrapper.style.transform = 'translateX(-100%)';
      setTimeout(function() { wrapper.remove(); }, 300);
    }
    alert('ãƒ«ãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  } catch (error) {
    console.error('[CRL] å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
    alert('ãƒ«ãƒ¼ãƒ ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

// ============================================================
// Room creation
// ============================================================
function crlCloseCreateRoomModal() {
  var modal = document.getElementById('crlCreateRoomModal');
  if (modal) modal.classList.remove('active');
  var form = document.getElementById('crlCreateRoomForm');
  if (form) form.reset();
  crlSelectedGroupMembers = [];
}

async function crlSubmitCreateRoom() {
  var db = crlGetDb(); if (!db) return;
  var roomName = document.getElementById('crlRoomNameInput').value.trim();
  var roomIcon = document.getElementById('crlRoomIconSelect').value;
  if (!roomName) { alert('ãƒ«ãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (crlSelectedGroupMembers.length === 0) { alert('ãƒ¡ãƒ³ãƒãƒ¼ã‚’1äººä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„'); return; }

  try {
    var q = await db.collection('rooms').where('name', '==', roomName).get();
    if (!q.empty) { alert('åŒã˜åå‰ã®ãƒ«ãƒ¼ãƒ ãŒã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚\nåˆ¥ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }

    var members = [crlCurrentUserName || 'ä¸æ˜'].concat(crlSelectedGroupMembers);
    var newRoom = await db.collection('rooms').add({
      name: roomName, icon: roomIcon,
      createdBy: crlCurrentUserName || 'ä¸æ˜',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
      lastMessageText: '', lastMessageSender: '',
      members: members, type: 'group'
    });
    crlCloseCreateRoomModal();
    setTimeout(function() { crlOpenRoom(newRoom.id); }, 500);
  } catch (error) {
    console.error('[CRL] ãƒ«ãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
    alert('ãƒ«ãƒ¼ãƒ ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

// ============================================================
// Group member list
// ============================================================
async function crlLoadGroupMemberList() {
  var container = document.getElementById('crlGroupMemberListContainer');
  if (!container) return;
  container.innerHTML = '<div class="crl-loading">ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>';
  var searchInput = document.getElementById('crlMemberSearchInput');
  if (searchInput) searchInput.value = '';

  try {
    var users;
    if (crlUsersCache && crlUsersCache.length > 0) {
      users = crlUsersCache;
    } else {
      // Firestore ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—
      var db = crlGetDb();
      if (db) {
        var snapshot = await db.collection('users').get();
        users = [];
        snapshot.forEach(function(doc) { users.push({ id: doc.id, userEmail: doc.id, userName: doc.data().userName, status: doc.data().status }); });
        users = users.filter(function(u) { return u.userName && (u.status === 'active' || !u.status); });
        if (users.length > 0) crlUsersCache = users;
      } else { throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“'); }
    }

    if (!users || users.length === 0) {
      crlGroupMemberUsersList = [];
      crlUpdateMemberCount(0, 0);
      container.innerHTML = '<div class="crl-empty-state"><div class="crl-empty-state-icon">ğŸ‘¥</div><div class="crl-empty-state-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div></div>';
      return;
    }
    crlGroupMemberUsersList = users.filter(function(u) { return u.userName !== crlCurrentUserName; });
    if (crlGroupMemberUsersList.length === 0) {
      crlUpdateMemberCount(0, 0);
      container.innerHTML = '<div class="crl-empty-state"><div class="crl-empty-state-icon">ğŸ‘¥</div><div class="crl-empty-state-text">ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div></div>';
      return;
    }
    crlRenderGroupMemberList(crlGroupMemberUsersList);
  } catch (error) {
    console.error('[CRL] ãƒ¡ãƒ³ãƒãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    container.innerHTML = '<div class="crl-empty-state"><div class="crl-empty-state-icon">âš ï¸</div><div class="crl-empty-state-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div></div>';
  }
}

function crlUpdateMemberCount(shown, total) {
  var el = document.getElementById('crlMemberCount');
  if (el) el.textContent = (shown === total) ? total + 'äºº' : shown + '/' + total + 'äºº';
}

function crlRenderGroupMemberList(users) {
  var container = document.getElementById('crlGroupMemberListContainer');
  if (!container) return;
  container.innerHTML = '';
  crlUpdateMemberCount(users.length, crlGroupMemberUsersList.length);
  if (users.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:20px;color:#718096;">è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  users.forEach(function(user) {
    var item = document.createElement('div');
    item.className = 'crl-user-list-item-checkbox';
    item.dataset.userName = user.userName;
    if (crlSelectedGroupMembers.includes(user.userName)) item.classList.add('selected');
    item.onclick = function() { crlToggleGroupMember(user.userName, item); };

    var checkbox = document.createElement('input');
    checkbox.type = 'checkbox'; checkbox.className = 'crl-user-checkbox';
    checkbox.checked = crlSelectedGroupMembers.includes(user.userName);
    checkbox.onclick = function(e) { e.stopPropagation(); crlToggleGroupMember(user.userName, item); };

    var iconElement;
    if (user.userIconUrl) {
      iconElement = document.createElement('div'); iconElement.className = 'crl-user-icon';
      var img = document.createElement('img'); img.src = user.userIconUrl; img.alt = user.userName;
      img.onerror = function() {
        var ph = document.createElement('div'); ph.className = 'crl-user-icon-placeholder'; ph.textContent = user.userName.charAt(0);
        this.parentElement.replaceWith(ph);
      };
      iconElement.appendChild(img);
    } else {
      iconElement = document.createElement('div'); iconElement.className = 'crl-user-icon-placeholder';
      iconElement.textContent = user.userName.charAt(0);
    }

    var info = document.createElement('div'); info.className = 'crl-user-info-cell';
    var nameEl = document.createElement('div'); nameEl.className = 'crl-user-name'; nameEl.textContent = user.userName;
    var perm = document.createElement('div'); perm.className = 'crl-user-permission';
    perm.textContent = (user.permissionDisplay || 'ã‚¹ã‚¿ãƒƒãƒ•').replace('ğŸ‘‘ ', '');
    info.appendChild(nameEl); info.appendChild(perm);
    item.appendChild(checkbox); item.appendChild(iconElement); item.appendChild(info);
    container.appendChild(item);
  });
}

function crlFilterGroupMembers(searchTerm) {
  var term = searchTerm.toLowerCase().trim();
  if (!term) { crlRenderGroupMemberList(crlGroupMemberUsersList); return; }
  var filtered = crlGroupMemberUsersList.filter(function(u) { return u.userName.toLowerCase().includes(term); });
  crlRenderGroupMemberList(filtered);
}

function crlToggleGroupMember(userName, itemElement) {
  var checkbox = itemElement.querySelector('.crl-user-checkbox');
  var index = crlSelectedGroupMembers.indexOf(userName);
  if (index === -1) {
    crlSelectedGroupMembers.push(userName);
    if (checkbox) checkbox.checked = true;
    itemElement.classList.add('selected');
  } else {
    crlSelectedGroupMembers.splice(index, 1);
    if (checkbox) checkbox.checked = false;
    itemElement.classList.remove('selected');
  }
}

// ============================================================
// Direct chat
// ============================================================
function crlCloseDirectChatModal() {
  var modal = document.getElementById('crlDirectChatModal');
  if (modal) modal.classList.remove('active');
}

function crlGenerateDirectRoomId(email1, email2) {
  var sanitize = function(email) { return email.replace(/@/g, '_at_').replace(/\./g, '_'); };
  var emails = [sanitize(email1), sanitize(email2)].sort();
  return 'dm_' + emails[0] + '_' + emails[1];
}

async function crlLoadUserList() {
  var db = crlGetDb();
  var container = document.getElementById('crlUserListContainer');
  if (!container) return;
  container.innerHTML = '<div class="crl-loading">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>';

  try {
    var users;
    if (db) {
      var snapshot = await db.collection('users').get();
      var allUsers = [];
      snapshot.forEach(function(doc) { allUsers.push({ id: doc.id, userEmail: doc.id, ...doc.data() }); });
      users = allUsers.filter(function(u) { return u.userName && (u.status === 'active' || !u.status); });
      if (users.length > 0) crlUsersCache = users;
    } else { throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“'); }

    if (!users || users.length === 0) {
      if (crlLoadUserListRetryCount < crlMaxRetry) {
        crlLoadUserListRetryCount++;
        container.innerHTML = '<div class="crl-loading">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’åŒæœŸä¸­...</div>';
        setTimeout(function() { crlLoadUserList(); }, 1000);
        return;
      }
      crlLoadUserListRetryCount = 0;
      container.innerHTML = '<div class="crl-empty-state"><div class="crl-empty-state-icon">ğŸ‘¥</div><div class="crl-empty-state-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div></div>';
      return;
    }
    crlLoadUserListRetryCount = 0;
    var filteredUsers = users.filter(function(u) { return u.userName !== crlCurrentUserName; });

    if (db && crlCurrentUserEmail) {
      try {
        var dmSnap = await db.collection('rooms').where('type', '==', 'direct').where('memberEmails', 'array-contains', crlCurrentUserEmail).get();
        var existingEmails = new Set();
        dmSnap.forEach(function(doc) {
          var data = doc.data();
          if (data.memberEmails && Array.isArray(data.memberEmails)) {
            data.memberEmails.forEach(function(email) { if (email !== crlCurrentUserEmail) existingEmails.add(email); });
          }
        });
        filteredUsers = filteredUsers.filter(function(u) { return !existingEmails.has(u.userEmail || u.email || u.id); });
      } catch (e) { /* continue without filtering */ }
    }

    if (filteredUsers.length === 0) {
      container.innerHTML = '<div class="crl-empty-state"><div class="crl-empty-state-icon">ğŸ‘¥</div><div class="crl-empty-state-text">æ–°ã—ãå€‹åˆ¥ãƒãƒ£ãƒƒãƒˆã‚’ä½œæˆã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</div></div>';
      return;
    }

    container.innerHTML = '';
    filteredUsers.forEach(function(user) {
      var item = document.createElement('div');
      item.className = 'crl-user-list-item';
      item.onclick = function() { crlSelectUserForDirectChat(user); };
      var iconElement;
      if (user.userIconUrl) {
        iconElement = document.createElement('div'); iconElement.className = 'crl-user-icon';
        var img = document.createElement('img'); img.src = user.userIconUrl; img.alt = user.userName;
        img.onerror = function() {
          var ph = document.createElement('div'); ph.className = 'crl-user-icon-placeholder'; ph.textContent = user.userName.charAt(0);
          this.parentElement.replaceWith(ph);
        };
        iconElement.appendChild(img);
      } else {
        iconElement = document.createElement('div'); iconElement.className = 'crl-user-icon-placeholder';
        iconElement.textContent = user.userName.charAt(0);
      }
      var info = document.createElement('div'); info.className = 'crl-user-info-cell';
      var nameEl = document.createElement('div'); nameEl.className = 'crl-user-name'; nameEl.textContent = user.userName;
      var perm = document.createElement('div'); perm.className = 'crl-user-permission';
      perm.textContent = (user.permissionDisplay || 'ã‚¹ã‚¿ãƒƒãƒ•').replace('ğŸ‘‘ ', '');
      info.appendChild(nameEl); info.appendChild(perm);
      item.appendChild(iconElement); item.appendChild(info);
      container.appendChild(item);
    });
  } catch (error) {
    console.error('[CRL] ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    container.innerHTML = '<div class="crl-empty-state"><div class="crl-empty-state-icon">âš ï¸</div><div class="crl-empty-state-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div></div>';
  }
}

async function crlSelectUserForDirectChat(targetUser) {
  var db = crlGetDb(); if (!db) return;
  var targetEmail = targetUser.userEmail || targetUser.email;
  if (!crlCurrentUserEmail || !targetEmail) { alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“'); return; }
  try {
    var roomId = crlGenerateDirectRoomId(crlCurrentUserEmail, targetEmail);
    var roomDoc = await db.collection('rooms').doc(roomId).get();
    if (roomDoc.exists) {
      crlCloseDirectChatModal();
      setTimeout(function() { crlOpenRoom(roomId); }, 300);
      return;
    }
    await crlCreateDirectChatRoom(roomId, targetUser);
  } catch (error) {
    console.error('[CRL] DMãƒ«ãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
    alert('å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

async function crlCreateDirectChatRoom(roomId, targetUser) {
  var db = crlGetDb(); if (!db) return;
  var targetEmail = targetUser.userEmail || targetUser.email;
  await db.collection('rooms').doc(roomId).set({
    name: '', type: 'direct', icon: 'ğŸ‘¤',
    members: [crlCurrentUserName, targetUser.userName],
    memberEmails: [crlCurrentUserEmail, targetEmail],
    createdBy: crlCurrentUserName,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
    lastMessage: '', lastMessageBy: ''
  });
  crlCloseDirectChatModal();
  setTimeout(function() { crlOpenRoom(roomId); }, 500);
}

// ============================================================
// Header dropdown, modals, search
// ============================================================
function crlToggleSettingsDropdown(event) {
  event.stopPropagation();
  var dd = document.getElementById('crlSettingsDropdown');
  if (dd) dd.classList.toggle('active');
}

function crlOpenAnnouncePage() {
  navigateToPage('announce');
}

function crlOpenChatTypeMenu() {
  var modal = document.getElementById('crlChatTypeMenuModal');
  if (modal) modal.classList.add('active');
}

function crlCloseChatTypeMenu() {
  var modal = document.getElementById('crlChatTypeMenuModal');
  if (modal) modal.classList.remove('active');
}

async function crlSelectChatType(type) {
  crlCloseChatTypeMenu();
  if (type === 'room') {
    var modal = document.getElementById('crlCreateRoomModal');
    if (modal) modal.classList.add('active');
    var iconInput = document.getElementById('crlRoomIconSelect');
    var preview = document.getElementById('crlSelectedEmojiPreview');
    if (iconInput) iconInput.value = 'ğŸ’¬';
    if (preview) preview.textContent = 'ğŸ’¬';
    await crlLoadGroupMemberList();
  } else if (type === 'direct') {
    var dModal = document.getElementById('crlDirectChatModal');
    if (dModal) dModal.classList.add('active');
    crlLoadUserList();
  }
}

// Keep memo
async function crlOpenKeepMemo() {
  var db = crlGetDb(); if (!db) return;
  crlHideKeepDot();
  if (!crlCurrentUserName) { alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“'); return; }
  try {
    var snap = await db.collection('rooms').where('type', '==', 'keep').where('createdBy', '==', crlCurrentUserName).get();
    var roomId;
    if (!snap.empty) {
      roomId = snap.docs[0].id;
    } else {
      var newRoom = await db.collection('rooms').add({
        name: 'Keepãƒ¡ãƒ¢', icon: '', createdBy: crlCurrentUserName,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
        lastMessageText: '', lastMessageSender: '',
        members: [crlCurrentUserName], type: 'keep'
      });
      roomId = newRoom.id;
    }
    crlOpenRoom(roomId);
  } catch (error) {
    console.error('[CRL] Keepãƒ¡ãƒ¢ã‚¨ãƒ©ãƒ¼:', error);
    alert('Keepãƒ¡ãƒ¢ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ: ' + error.message);
  }
}

function crlShowKeepDot() {
  var dot = document.getElementById('crlKeepDot');
  if (dot) { dot.classList.add('active'); localStorage.setItem('keepDotActive', 'true'); }
}

function crlHideKeepDot() {
  var dot = document.getElementById('crlKeepDot');
  if (dot) { dot.classList.remove('active'); localStorage.removeItem('keepDotActive'); }
}

function crlRestoreKeepDotState() {
  if (localStorage.getItem('keepDotActive') === 'true') {
    var dot = document.getElementById('crlKeepDot');
    if (dot) dot.classList.add('active');
  }
}

// ============================================================
// Member list modal
// ============================================================
async function crlOpenMemberListModal() {
  var modal = document.getElementById('crlMemberListModal');
  if (modal) modal.classList.add('active');
  var searchInput = document.getElementById('crlMemberListSearchInput');
  if (searchInput) searchInput.value = '';
  await crlLoadMemberList();
}

function crlCloseMemberListModal() {
  var modal = document.getElementById('crlMemberListModal');
  if (modal) modal.classList.remove('active');
}

async function crlLoadMemberList() {
  var db = crlGetDb(); if (!db) return;
  var container = document.getElementById('crlMemberListContainer');
  if (!container) return;
  container.innerHTML = '<div class="crl-loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
  try {
    var usersSnap = await db.collection('users').get();
    crlAllMembersForList = [];
    var selfIconUrl = '';
    usersSnap.forEach(function(doc) {
      var data = doc.data();
      var iconUrl = data.userIconUrl || data.photoURL || '';
      if (data.userName === crlCurrentUserName) selfIconUrl = iconUrl;
      if (data.userName && data.userName !== crlCurrentUserName) {
        crlAllMembersForList.push({ id: doc.id, userName: data.userName, email: data.email || '', iconUrl: iconUrl });
      }
    });
    crlAllMembersForList.unshift({
      id: 'self', userName: crlCurrentUserName + 'ï¼ˆè‡ªåˆ†ï¼‰',
      email: localStorage.getItem('reborn_user_email') || '', iconUrl: selfIconUrl
    });
    crlRenderMemberList(crlAllMembersForList);
  } catch (error) {
    console.error('[CRL] ãƒ¡ãƒ³ãƒãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    container.innerHTML = '<div style="padding:20px;text-align:center;color:#718096;">ãƒ¡ãƒ³ãƒãƒ¼ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</div>';
  }
}

function crlRenderMemberList(members) {
  var container = document.getElementById('crlMemberListContainer');
  if (!container) return;
  if (members.length === 0) {
    container.innerHTML = '<div style="padding:20px;text-align:center;color:#718096;">ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“</div>';
    return;
  }
  var html = '';
  members.forEach(function(member) {
    var isSelf = member.id === 'self';
    var initial = member.userName.charAt(0).toUpperCase();
    var displayName = isSelf ? member.userName.replace('ï¼ˆè‡ªåˆ†ï¼‰', '') : member.userName;
    var iconHtml;
    if (member.iconUrl) {
      iconHtml = '<img src="' + member.iconUrl + '" style="width:40px;height:40px;border-radius:50%;object-fit:cover;margin-right:12px;" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\'"><div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--reborn-primary),var(--reborn-primary-dark));display:none;align-items:center;justify-content:center;color:white;font-weight:600;font-size:16px;margin-right:12px;">' + initial + '</div>';
    } else {
      iconHtml = '<div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--reborn-primary),var(--reborn-primary-dark));display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:16px;margin-right:12px;">' + initial + '</div>';
    }
    var escapedIconUrl = (member.iconUrl || '').replace(/'/g, "\\'");
    html += '<div style="display:flex;align-items:center;padding:12px;border-bottom:1px solid #e5e7eb;cursor:' + (isSelf ? 'default' : 'pointer') + ';" ' + (isSelf ? '' : 'onclick="crlOpenProfilePopup(\'' + displayName + '\',\'' + escapedIconUrl + '\')"') + '>' + iconHtml + '<div style="flex:1;"><div style="font-weight:500;color:#1f2937;">' + member.userName + '</div></div>' + (isSelf ? '' : '<i class="bi bi-chevron-right" style="color:#9ca3af;"></i>') + '</div>';
  });
  container.innerHTML = html;
}

function crlFilterMemberList(searchTerm) {
  var filtered = crlAllMembersForList.filter(function(m) { return m.userName.toLowerCase().includes(searchTerm.toLowerCase()); });
  crlRenderMemberList(filtered);
}

// ============================================================
// Hidden rooms modal
// ============================================================
async function crlOpenHiddenRoomsModal() {
  var modal = document.getElementById('crlHiddenRoomsModal');
  if (modal) modal.classList.add('active');
  await crlLoadHiddenRooms();
}

function crlCloseHiddenRoomsModal() {
  var modal = document.getElementById('crlHiddenRoomsModal');
  if (modal) modal.classList.remove('active');
}

async function crlLoadHiddenRooms() {
  var db = crlGetDb(); if (!db) return;
  var container = document.getElementById('crlHiddenRoomsContainer');
  if (!container) return;
  container.innerHTML = '<div class="crl-loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
  try {
    var snapshot = await db.collection('rooms').get();
    var hiddenRooms = [];
    snapshot.forEach(function(doc) {
      var data = doc.data();
      var hiddenBy = data.hiddenBy || [];
      if (hiddenBy.includes(crlCurrentUserName)) {
        var displayName = data.name || 'ä¸æ˜ãªãƒ«ãƒ¼ãƒ ';
        var otherUserName = '';
        if (data.type === 'direct' && data.members && Array.isArray(data.members)) {
          otherUserName = data.members.find(function(m) { return m !== crlCurrentUserName; }) || '';
          displayName = otherUserName || 'ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼';
        }
        hiddenRooms.push({ id: doc.id, name: displayName, icon: data.icon || '', type: data.type || 'group', otherUserName: otherUserName });
      }
    });
    if (hiddenRooms.length === 0) {
      container.innerHTML = '<div style="padding:20px;text-align:center;color:#718096;">éè¡¨ç¤ºãƒ«ãƒ¼ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }
    var html = '';
    hiddenRooms.forEach(function(room) {
      var iconHtml;
      if (room.type === 'direct' && room.otherUserName) {
        var iconUrl = crlGetUserIconUrl(room.otherUserName);
        var initial = room.otherUserName.charAt(0).toUpperCase();
        if (iconUrl) {
          iconHtml = '<img src="' + iconUrl + '" style="width:40px;height:40px;border-radius:50%;object-fit:cover;margin-right:12px;" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\'"><div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--reborn-primary),var(--reborn-primary-dark));display:none;align-items:center;justify-content:center;color:white;font-weight:600;font-size:16px;margin-right:12px;">' + initial + '</div>';
        } else {
          iconHtml = '<div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--reborn-primary),var(--reborn-primary-dark));display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:16px;margin-right:12px;">' + initial + '</div>';
        }
      } else {
        iconHtml = '<div style="width:40px;height:40px;border-radius:50%;background:#f3f4f6;display:flex;align-items:center;justify-content:center;font-size:20px;margin-right:12px;">' + (room.icon || 'ğŸ’¬') + '</div>';
      }
      html += '<div style="display:flex;align-items:center;padding:12px;border-bottom:1px solid #e5e7eb;">' + iconHtml + '<div style="flex:1;font-weight:500;color:#1f2937;">' + room.name + '</div><button onclick="crlRestoreHiddenRoom(\'' + room.id + '\')" style="padding:6px 12px;background:var(--reborn-primary);color:white;border:none;border-radius:6px;font-size:13px;cursor:pointer;">å¾©å…ƒ</button></div>';
    });
    container.innerHTML = html;
  } catch (error) {
    container.innerHTML = '<div style="padding:20px;text-align:center;color:#718096;">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
  }
}

async function crlRestoreHiddenRoom(roomId) {
  try {
    var db = crlGetDb(); if (!db) return;
    var roomSnap = await db.collection('rooms').doc(roomId).get();
    if (roomSnap.exists) {
      var hiddenBy = roomSnap.data().hiddenBy || [];
      var newHiddenBy = hiddenBy.filter(function(n) { return n !== crlCurrentUserName; });
      await db.collection('rooms').doc(roomId).update({ hiddenBy: newHiddenBy });
      await crlLoadHiddenRooms();
    }
  } catch (error) { alert('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ'); }
}

// ============================================================
// Muted rooms modal
// ============================================================
async function crlOpenMutedRoomsModal() {
  var modal = document.getElementById('crlMutedRoomsModal');
  if (modal) modal.classList.add('active');
  await crlLoadMutedRooms();
}

function crlCloseMutedRoomsModal() {
  var modal = document.getElementById('crlMutedRoomsModal');
  if (modal) modal.classList.remove('active');
}

async function crlLoadMutedRooms() {
  var db = crlGetDb(); if (!db) return;
  var container = document.getElementById('crlMutedRoomsContainer');
  if (!container) return;
  container.innerHTML = '<div class="crl-loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
  try {
    var snapshot = await db.collection('rooms').get();
    var mutedRooms = [];
    snapshot.forEach(function(doc) {
      var data = doc.data();
      if ((data.mutedBy || []).includes(crlCurrentUserName)) {
        mutedRooms.push({ id: doc.id, name: data.name || 'ä¸æ˜ãªãƒ«ãƒ¼ãƒ ', icon: data.icon || 'ğŸ’¬', type: data.type || 'group' });
      }
    });
    if (mutedRooms.length === 0) {
      container.innerHTML = '<div style="padding:20px;text-align:center;color:#718096;">ãƒŸãƒ¥ãƒ¼ãƒˆä¸­ã®ãƒ«ãƒ¼ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }
    var html = '';
    mutedRooms.forEach(function(room) {
      var dn = room.type === 'direct' ? room.name.replace(crlCurrentUserName, '').replace(' & ', '').trim() : room.name;
      html += '<div style="display:flex;align-items:center;padding:12px;border-bottom:1px solid #e5e7eb;"><div style="font-size:24px;margin-right:12px;">' + room.icon + '</div><div style="flex:1;font-weight:500;color:#1f2937;">' + dn + '</div><button onclick="crlUnmuteMutedRoom(\'' + room.id + '\')" style="padding:6px 12px;background:var(--reborn-primary);color:white;border:none;border-radius:6px;font-size:13px;cursor:pointer;">è§£é™¤</button></div>';
    });
    container.innerHTML = html;
  } catch (error) {
    container.innerHTML = '<div style="padding:20px;text-align:center;color:#718096;">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
  }
}

async function crlUnmuteMutedRoom(roomId) {
  try {
    var db = crlGetDb(); if (!db) return;
    var roomSnap = await db.collection('rooms').doc(roomId).get();
    if (roomSnap.exists) {
      var mutedBy = roomSnap.data().mutedBy || [];
      await db.collection('rooms').doc(roomId).update({ mutedBy: mutedBy.filter(function(n) { return n !== crlCurrentUserName; }) });
      await crlLoadMutedRooms();
    }
  } catch (error) { alert('ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
}

// ============================================================
// Block list modal
// ============================================================
async function crlOpenBlockListModal() {
  var modal = document.getElementById('crlBlockListModal');
  if (modal) modal.classList.add('active');
  await crlLoadBlockList();
}

function crlCloseBlockListModal() {
  var modal = document.getElementById('crlBlockListModal');
  if (modal) modal.classList.remove('active');
}

async function crlLoadBlockList() {
  var db = crlGetDb(); if (!db) return;
  var container = document.getElementById('crlBlockListContainer');
  if (!container) return;
  container.innerHTML = '<div class="crl-loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
  try {
    var userEmail = localStorage.getItem('reborn_user_email') || '';
    if (!userEmail) { container.innerHTML = '<div style="padding:20px;text-align:center;color:#718096;">ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</div>'; return; }
    var userSnap = await db.collection('users').doc(userEmail).get();
    var blockedUsers = [];
    if (userSnap.exists) blockedUsers = userSnap.data().blockedUsers || [];
    var userName = localStorage.getItem('reborn_user_name') || '';
    var origLen = blockedUsers.length;
    blockedUsers = blockedUsers.filter(function(n) { return n !== userName && n !== userEmail; });
    if (blockedUsers.length < origLen) {
      await db.collection('users').doc(userEmail).update({ blockedUsers: blockedUsers });
    }
    if (blockedUsers.length === 0) {
      container.innerHTML = '<div style="padding:20px;text-align:center;color:#718096;">ãƒ–ãƒ­ãƒƒã‚¯ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“</div>';
      return;
    }
    var html = '';
    blockedUsers.forEach(function(un) {
      html += '<div style="display:flex;align-items:center;padding:12px;border-bottom:1px solid #e5e7eb;"><div style="width:40px;height:40px;border-radius:50%;background:#ef4444;display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:16px;margin-right:12px;">' + un.charAt(0).toUpperCase() + '</div><div style="flex:1;font-weight:500;color:#1f2937;">' + un + '</div><button onclick="crlUnblockUser(\'' + un + '\')" style="padding:6px 12px;background:#6b7280;color:white;border:none;border-radius:6px;font-size:13px;cursor:pointer;">è§£é™¤</button></div>';
    });
    container.innerHTML = html;
  } catch (error) {
    container.innerHTML = '<div style="padding:20px;text-align:center;color:#718096;">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
  }
}

async function crlUnblockUser(userName) {
  try {
    var db = crlGetDb(); if (!db) return;
    var userEmail = localStorage.getItem('reborn_user_email') || '';
    var userSnap = await db.collection('users').doc(userEmail).get();
    if (userSnap.exists) {
      var blockedUsers = userSnap.data().blockedUsers || [];
      await db.collection('users').doc(userEmail).update({ blockedUsers: blockedUsers.filter(function(n) { return n !== userName; }) });
      try {
        var roomsSnap = await db.collection('rooms').where('type', '==', 'direct').where('members', 'array-contains', crlCurrentUserName).get();
        for (var i = 0; i < roomsSnap.docs.length; i++) {
          var roomData = roomsSnap.docs[i].data();
          if (roomData.members && roomData.members.includes(userName)) {
            if (roomData.hiddenBy && roomData.hiddenBy.includes(crlCurrentUserName)) {
              await db.collection('rooms').doc(roomsSnap.docs[i].id).update({
                hiddenBy: roomData.hiddenBy.filter(function(n) { return n !== crlCurrentUserName; })
              });
            }
          }
        }
      } catch (e) { /* ignore unhide errors */ }
      await crlLoadBlockList();
    }
  } catch (error) { alert('ãƒ–ãƒ­ãƒƒã‚¯è§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
}

// ============================================================
// Profile popup
// ============================================================
async function crlOpenProfilePopup(userName, iconUrl) {
  var db = crlGetDb(); if (!db) return;
  crlCurrentProfileUser = { userName: userName, iconUrl: iconUrl };
  var avatarContainer = document.getElementById('crlProfilePopupAvatar');
  var initial = userName.charAt(0).toUpperCase();
  if (iconUrl) {
    avatarContainer.innerHTML = '<img src="' + iconUrl + '" class="crl-profile-popup-avatar" onerror="this.outerHTML=\'<div class=crl-profile-popup-avatar-initial>' + initial + '</div>\'">';
  } else {
    avatarContainer.innerHTML = '<div class="crl-profile-popup-avatar-initial">' + initial + '</div>';
  }
  document.getElementById('crlProfilePopupName').textContent = userName;
  var header = document.querySelector('#spa-page-chat-rooms .crl-profile-popup-header');
  try {
    var user = crlUsersCache.find(function(u) { return u.userName === userName; });
    if (user && user.id) {
      var userSnap = await db.collection('users').doc(user.id).get();
      if (userSnap.exists) {
        var userData = userSnap.data();
        if (userData.profileBackground) {
          var bg = userData.profileBackground;
          if (bg.type === 'image' && bg.value) {
            header.style.backgroundImage = 'url(\'' + bg.value + '\')';
            header.style.backgroundSize = 'cover'; header.style.backgroundPosition = 'center';
          } else if (bg.type === 'gradient') {
            var preset = CRL_GRADIENT_PRESETS.find(function(p) { return p.id === bg.value; }) || CRL_GRADIENT_PRESETS[0];
            header.style.backgroundImage = ''; header.style.background = preset.gradient;
          }
        } else {
          header.style.backgroundImage = '';
          header.style.background = 'linear-gradient(135deg, var(--reborn-primary), var(--reborn-primary-dark))';
        }
      }
    } else {
      header.style.backgroundImage = '';
      header.style.background = 'linear-gradient(135deg, var(--reborn-primary), var(--reborn-primary-dark))';
    }
  } catch (e) {
    header.style.backgroundImage = '';
    header.style.background = 'linear-gradient(135deg, var(--reborn-primary), var(--reborn-primary-dark))';
  }
  document.getElementById('crlProfilePopupOverlay').classList.add('active');
}

function crlCloseProfilePopup(event) {
  if (event) event.stopPropagation();
  document.getElementById('crlProfilePopupOverlay').classList.remove('active');
  crlCurrentProfileUser = null;
}

// ============================================================
// Search
// ============================================================
function crlEscapeRegExp(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function crlHighlightText(text, query) {
  if (!text || !query) return text;
  var regex = new RegExp('(' + crlEscapeRegExp(query) + ')', 'gi');
  return text.replace(regex, '<span class="crl-search-highlight">$1</span>');
}

function crlRemoveHighlights(element) {
  if (!element) return;
  var highlights = element.querySelectorAll('.crl-search-highlight');
  highlights.forEach(function(el) {
    var parent = el.parentNode;
    parent.replaceChild(document.createTextNode(el.textContent), el);
    parent.normalize();
  });
}

function crlPerformSearch() {
  var searchInput = document.getElementById('crlSearchInput');
  var query = searchInput ? searchInput.value.trim() : '';
  var queryLower = query.toLowerCase();
  var roomWrappers = document.querySelectorAll('#spa-page-chat-rooms .crl-room-item-wrapper');

  if (!query) {
    roomWrappers.forEach(function(w) {
      w.classList.remove('search-hidden');
      crlRemoveHighlights(w.querySelector('.crl-room-name'));
      crlRemoveHighlights(w.querySelector('.crl-room-last-message'));
    });
    return;
  }

  roomWrappers.forEach(function(w) {
    var roomNameEl = w.querySelector('.crl-room-name');
    var lastMsgEl = w.querySelector('.crl-room-last-message');
    crlRemoveHighlights(roomNameEl); crlRemoveHighlights(lastMsgEl);
    var roomName = roomNameEl ? roomNameEl.textContent : '';
    var lastMsg = lastMsgEl ? lastMsgEl.textContent : '';
    var searchText = (roomName + ' ' + lastMsg).toLowerCase();
    if (searchText.includes(queryLower)) {
      w.classList.remove('search-hidden');
      if (roomNameEl && roomName.toLowerCase().includes(queryLower)) roomNameEl.innerHTML = crlHighlightText(roomName, query);
      if (lastMsgEl && lastMsg.toLowerCase().includes(queryLower)) lastMsgEl.innerHTML = crlHighlightText(lastMsg, query);
    } else {
      w.classList.add('search-hidden');
    }
  });
}

function crlPerformSearchNew() {
  var clearBtn = document.getElementById('crlSearchClearBtn');
  var searchInput = document.getElementById('crlSearchInput');
  if (clearBtn && searchInput) clearBtn.classList.toggle('show', searchInput.value.trim().length > 0);
  crlPerformSearch();
}

function crlClearSearch() {
  var searchInput = document.getElementById('crlSearchInput');
  var clearBtn = document.getElementById('crlSearchClearBtn');
  if (searchInput) { searchInput.value = ''; searchInput.focus(); }
  if (clearBtn) clearBtn.classList.remove('show');
  var roomWrappers = document.querySelectorAll('#spa-page-chat-rooms .crl-room-item-wrapper');
  roomWrappers.forEach(function(w) {
    w.classList.remove('search-hidden');
    crlRemoveHighlights(w.querySelector('.crl-room-name'));
    crlRemoveHighlights(w.querySelector('.crl-room-last-message'));
  });
}

// ============================================================
// Admin check
// ============================================================
function crlCheckAdminAccess() {
  var userEmail = localStorage.getItem('reborn_user_email') || '';
  if (CRL_ADMIN_EMAILS.includes(userEmail)) {
    var adminLink = document.getElementById('crlAdminAnnounceLink');
    if (adminLink) adminLink.classList.add('visible');
  }
}

// ============================================================
// startListening - Firestore real-time listener
// ============================================================
async function crlStartListening() {
  var db = crlGetDb();
  if (!db) { console.error('[CRL] Firestore DB not available'); return; }

  if (crlUnsubscribeRooms) { crlUnsubscribeRooms(); crlUnsubscribeRooms = null; }

  var container = document.getElementById('crlRoomsContainer');
  if (container && !container.classList.contains('ready')) {
    container.innerHTML = '<div style="padding:20px;text-align:center;color:#40B4E5;">ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>';
  }

  var trimmedUserEmail = (crlCurrentUserEmail || '').trim();
  var trimmedUserName = (crlCurrentUserName || '').trim();

  if (!trimmedUserEmail && !trimmedUserName) {
    if (container) container.innerHTML = '<div class="crl-empty-state"><div class="crl-empty-state-icon">âš ï¸</div><div class="crl-empty-state-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“</div><div style="font-size:14px;color:#a0aec0;">ã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„</div></div>';
    return;
  }

  // Fetch block list
  if (trimmedUserEmail) {
    try {
      var userSnap = await db.collection('users').doc(trimmedUserEmail).get();
      if (userSnap.exists) {
        var userData = userSnap.data();
        crlCurrentUserBlockedList = (userData.blockedUsers || []).filter(function(n) { return n !== trimmedUserName && n !== trimmedUserEmail; });
      } else { crlCurrentUserBlockedList = []; }
    } catch (e) { crlCurrentUserBlockedList = []; }
  }

  // Determine query strategy
  var useEmailQuery = false;
  var qByEmail = null;
  if (trimmedUserEmail) {
    try {
      qByEmail = db.collection('rooms').where('memberEmails', 'array-contains', trimmedUserEmail).orderBy('lastMessageAt', 'desc');
      var emailSnap = await qByEmail.get();
      if (emailSnap.size > 0) useEmailQuery = true;
    } catch (e) { /* index not built */ }
  }

  var qByName = db.collection('rooms').where('members', 'array-contains', trimmedUserName).orderBy('lastMessageAt', 'desc');
  var nameSnapSize = 0;
  try { var nameSnap = await qByName.get(); nameSnapSize = nameSnap.size; } catch (e) { /* ignore */ }

  var q;
  var useClientFilter = false;
  if (useEmailQuery) { q = qByEmail; }
  else if (nameSnapSize > 0) { q = qByName; }
  else {
    useClientFilter = true;
    q = db.collection('rooms').orderBy('lastMessageAt', 'desc');
  }

  crlUnsubscribeRooms = q.onSnapshot(function(snapshot) {
    var skeleton = document.getElementById('crlSkeletonLoader');
    if (skeleton) skeleton.classList.remove('active');
    var cont = document.getElementById('crlRoomsContainer');

    crlUnreadListeners.forEach(function(unsub) { try { unsub(); } catch(e) {} });
    crlUnreadListeners = [];
    cont.innerHTML = '';
    crlRoomUnreadCounts.clear();

    if (snapshot.empty) {
      cont.innerHTML = '<div class="crl-empty-state"><div class="crl-empty-state-icon">ğŸ’¬</div><div class="crl-empty-state-text">ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</div><div style="font-size:14px;color:#a0aec0;">ã€Œæ–°ã—ã„ãƒ«ãƒ¼ãƒ ä½œæˆã€ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†</div></div>';
      return;
    }

    var visibleRooms = [];
    snapshot.forEach(function(doc) {
      var room = Object.assign({ id: doc.id }, doc.data());
      var emailMatch = room.memberEmails ? room.memberEmails.includes(trimmedUserEmail) : false;
      var nameMatch = room.members ? room.members.includes(trimmedUserName) : false;
      var isSystemRoom = room.type === 'system';
      var isKeepRoom = room.type === 'keep';
      var isHidden = room.hiddenBy && Array.isArray(room.hiddenBy) && room.hiddenBy.includes(crlCurrentUserName);
      if ((isSystemRoom || emailMatch || nameMatch) && !isHidden && !isKeepRoom) {
        visibleRooms.push(room);
      }
    });

    visibleRooms.sort(function(a, b) {
      var aPinned = a.pinnedBy && Array.isArray(a.pinnedBy) && a.pinnedBy.includes(crlCurrentUserName);
      var bPinned = b.pinnedBy && Array.isArray(b.pinnedBy) && b.pinnedBy.includes(crlCurrentUserName);
      if (aPinned && !bPinned) return -1;
      if (!aPinned && bPinned) return 1;
      var aTime = (a.lastMessageAt && a.lastMessageAt.toMillis) ? a.lastMessageAt.toMillis() : 0;
      var bTime = (b.lastMessageAt && b.lastMessageAt.toMillis) ? b.lastMessageAt.toMillis() : 0;
      return bTime - aTime;
    });

    visibleRooms.forEach(function(room) { crlAppendRoom(room); });
    cont.classList.add('ready');

    var roomsForCache = visibleRooms.map(function(room) {
      return Object.assign({}, room, {
        lastMessageAt: (room.lastMessageAt && room.lastMessageAt.toMillis) ? room.lastMessageAt.toMillis() : (room.lastMessageAt || 0),
        createdAt: (room.createdAt && room.createdAt.toMillis) ? room.createdAt.toMillis() : (room.createdAt || 0)
      });
    });
    crlSaveRoomsToCache(roomsForCache);

    if (visibleRooms.length === 0) {
      cont.innerHTML = '<div class="crl-empty-state"><div class="crl-empty-state-icon">ğŸ’¬</div><div class="crl-empty-state-text">å‚åŠ ä¸­ã®ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</div><div style="font-size:14px;color:#a0aec0;">ã€Œæ–°ã—ã„ãƒ«ãƒ¼ãƒ ä½œæˆã€ã¾ãŸã¯ã€Œå€‹åˆ¥ãƒãƒ£ãƒƒãƒˆä½œæˆã€ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†</div></div>';
    }
  }, function(error) {
    console.error('[CRL] ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
    var skeleton = document.getElementById('crlSkeletonLoader');
    if (skeleton) skeleton.classList.remove('active');
    var cont = document.getElementById('crlRoomsContainer');
    cont.innerHTML = '<div class="crl-empty-state"><div class="crl-empty-state-icon">âš ï¸</div><div class="crl-empty-state-text">ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div><div style="font-size:14px;color:#a0aec0;">' + error.message + '</div></div>';
    cont.classList.add('ready');
  });
}

// ============================================================
// LIFECYCLE: initChatRoomsPage / destroyChatRoomsPage
// ============================================================
function initChatRoomsPage() {
  console.log('[CRL] initChatRoomsPage() é–‹å§‹');

  // Get user info from localStorage (SPA pattern)
  crlCurrentUserName = localStorage.getItem('reborn_user_name') || '';
  crlCurrentUserEmail = localStorage.getItem('reborn_user_email') || '';

  console.log('[CRL] ãƒ¦ãƒ¼ã‚¶ãƒ¼:', crlCurrentUserName, crlCurrentUserEmail);

  // Admin check
  crlCheckAdminAccess();

  // Restore keep dot
  crlRestoreKeepDotState();

  // Update user info display
  var userInfoEl = document.getElementById('crlUserInfo');
  if (userInfoEl) userInfoEl.textContent = 'ğŸ‘¤ ' + crlCurrentUserName;

  // Setup event listeners
  crlDropdownClickHandler = function(event) {
    var dd = document.getElementById('crlSettingsDropdown');
    if (dd && !dd.contains(event.target)) dd.classList.remove('active');
  };
  document.addEventListener('click', crlDropdownClickHandler);

  crlDocClickHandler = function(e) {
    if (!crlCurrentlySwipedItem) return;
    var roomItem = e.target.closest('.crl-room-item-wrapper');
    var swipeButtons = e.target.closest('.crl-swipe-buttons') || e.target.closest('.crl-swipe-buttons-left');
    if (!roomItem && !swipeButtons) crlCloseAllSwipes();
  };
  document.addEventListener('click', crlDocClickHandler);

  crlDocTouchHandler = function(e) {
    if (!crlCurrentlySwipedItem) return;
    var roomItem = e.target.closest('.crl-room-item-wrapper');
    var swipeButtons = e.target.closest('.crl-swipe-buttons') || e.target.closest('.crl-swipe-buttons-left');
    if (!roomItem && !swipeButtons) crlCloseAllSwipes();
  };
  document.addEventListener('touchstart', crlDocTouchHandler, { passive: true });

  crlStorageHandler = function(e) {
    if (e.key === 'keepDotActive') {
      if (e.newValue === 'true') crlShowKeepDot();
      else crlHideKeepDot();
    }
  };
  window.addEventListener('storage', crlStorageHandler);

  // Emoji picker background click
  crlEmojiPickerBgHandler = function(e) {
    var modal = document.getElementById('crlEmojiPickerModal');
    if (e.target === modal) crlCloseEmojiPicker();
  };
  var emojiModal = document.getElementById('crlEmojiPickerModal');
  if (emojiModal) emojiModal.addEventListener('click', crlEmojiPickerBgHandler);

  // Profile popup chat/call buttons
  var chatBtn = document.getElementById('crlProfilePopupChatBtn');
  crlProfileChatHandler = async function() {
    if (!crlCurrentProfileUser) return;
    var db = crlGetDb(); if (!db) return;
    var targetUserName = crlCurrentProfileUser.userName;
    crlCloseProfilePopup();
    crlCloseMemberListModal();
    try {
      var snap = await db.collection('rooms').where('type', '==', 'direct').get();
      var existingRoomId = null;
      snap.forEach(function(doc) {
        var data = doc.data();
        if (data.members && data.members.includes(crlCurrentUserName) && data.members.includes(targetUserName)) existingRoomId = doc.id;
      });
      if (existingRoomId) { crlOpenRoom(existingRoomId); }
      else {
        var newRoom = await db.collection('rooms').add({
          name: crlCurrentUserName + ' & ' + targetUserName,
          type: 'direct', members: [crlCurrentUserName, targetUserName],
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: crlCurrentUserName
        });
        crlOpenRoom(newRoom.id);
      }
    } catch (error) { alert('ãƒãƒ£ãƒƒãƒˆã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ'); }
  };
  if (chatBtn) chatBtn.addEventListener('click', crlProfileChatHandler);

  var callBtn = document.getElementById('crlProfilePopupCallBtn');
  crlProfileCallHandler = function() { if (crlCurrentProfileUser) alert('é€šè©±æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™'); };
  if (callBtn) callBtn.addEventListener('click', crlProfileCallHandler);

  // Cache-first display
  var cachedUsers = crlRestoreUsersFromCache();
  var cachedRooms = crlRestoreRoomsFromCache();

  if (cachedUsers && cachedRooms && cachedRooms.length > 0) {
    crlUsersCache = cachedUsers;
    var container = document.getElementById('crlRoomsContainer');
    if (container) {
      container.innerHTML = '';
      cachedRooms.forEach(function(room) { crlAppendRoom(room); });
      container.classList.add('ready');
    }
    crlStartListening();
    return;
  }

  // Show skeleton
  var skeleton = document.getElementById('crlSkeletonLoader');
  if (skeleton) skeleton.classList.add('active');

  // Load users then start listening
  var db = crlGetDb();
  if (db) {
    db.collection('users').get().then(function(snapshot) {
      var allUsers = [];
      snapshot.forEach(function(doc) { allUsers.push(Object.assign({ id: doc.id }, doc.data())); });
      var users = allUsers.filter(function(u) { return u.userName && u.status === 'active'; });
      if (users.length > 0) {
        crlUsersCache = users;
        crlSaveUsersToCache(users);
      }
      crlStartListening();
    }).catch(function(error) {
      console.error('[CRL] ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      crlStartListening();
    });
  } else {
    crlStartListening();
  }
}

function destroyChatRoomsPage() {
  console.log('[CRL] destroyChatRoomsPage() é–‹å§‹');

  // Unsubscribe ALL onSnapshot listeners
  crlUnreadListeners.forEach(function(unsub) { try { unsub(); } catch(e) {} });
  crlUnreadListeners = [];

  if (crlUnsubscribeRooms) {
    try { crlUnsubscribeRooms(); } catch(e) {}
    crlUnsubscribeRooms = null;
  }

  // Remove event listeners
  if (crlDropdownClickHandler) { document.removeEventListener('click', crlDropdownClickHandler); crlDropdownClickHandler = null; }
  if (crlDocClickHandler) { document.removeEventListener('click', crlDocClickHandler); crlDocClickHandler = null; }
  if (crlDocTouchHandler) { document.removeEventListener('touchstart', crlDocTouchHandler); crlDocTouchHandler = null; }
  if (crlStorageHandler) { window.removeEventListener('storage', crlStorageHandler); crlStorageHandler = null; }

  var emojiModal = document.getElementById('crlEmojiPickerModal');
  if (emojiModal && crlEmojiPickerBgHandler) { emojiModal.removeEventListener('click', crlEmojiPickerBgHandler); crlEmojiPickerBgHandler = null; }

  var chatBtn = document.getElementById('crlProfilePopupChatBtn');
  if (chatBtn && crlProfileChatHandler) { chatBtn.removeEventListener('click', crlProfileChatHandler); crlProfileChatHandler = null; }

  var callBtn = document.getElementById('crlProfilePopupCallBtn');
  if (callBtn && crlProfileCallHandler) { callBtn.removeEventListener('click', crlProfileCallHandler); crlProfileCallHandler = null; }

  // Reset state
  crlCurrentUserName = '';
  crlCurrentUserEmail = '';
  crlUsersCache = [];
  crlCurrentUserBlockedList = [];
  crlRoomUnreadCounts.clear();
  crlCurrentlySwipedItem = null;
  crlSelectedGroupMembers = [];
  crlGroupMemberUsersList = [];
  crlCurrentProfileUser = null;
  crlAllMembersForList = [];
  crlLoadUserListRetryCount = 0;

  console.log('[CRL] destroyChatRoomsPage() å®Œäº†');
}
</script>

</div>
