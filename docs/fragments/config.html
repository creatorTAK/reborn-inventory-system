<!-- SPA Fragment: config.html -->
<!-- Prefix: cfg- (CSS scoped, functions prefixed with cfg, variables with _cfg_) -->
<!-- Page keys: config-product, config-system, config-permission-users, config -->
<div id="spa-page-config">
  <style>
    #spa-page-config {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      background: #f5f6fa;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
      margin: 0;
      padding: 0;
    }

    #spa-page-config * {
      box-sizing: border-box;
    }

    /* ============================================ */
    /* ã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼ */
    /* ============================================ */
    #spa-page-config .sub-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: white;
      padding: 10px 16px;
      border-bottom: 1px solid #e0e0e0;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    #spa-page-config .sub-header .back-btn {
      background: none;
      border: none;
      font-size: 20px;
      color: #40B4E5;
      cursor: pointer;
      padding: 4px 8px;
    }

    #spa-page-config .sub-header .page-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }

    #spa-page-config .sub-header .header-icons {
      display: flex;
      gap: 8px;
    }

    #spa-page-config .sub-header .header-icons button {
      background: none;
      border: none;
      font-size: 18px;
      color: #6b7280;
      cursor: pointer;
      padding: 4px;
    }

    /* ============================================ */
    /* ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–ï¼ˆå•†å“ç™»éŒ²è¨­å®š / ã‚·ã‚¹ãƒ†ãƒ è¨­å®šï¼‰ */
    /* ============================================ */
    #spa-page-config .cfg-main-tabs {
      display: flex;
      background: white;
      border-bottom: 2px solid #e5e7eb;
      position: sticky;
      top: 44px;
      z-index: 99;
    }

    #spa-page-config .cfg-main-tabs .cfg-main-tab {
      flex: 1;
      text-align: center;
      padding: 12px 8px;
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
    }

    #spa-page-config .cfg-main-tabs .cfg-main-tab.active {
      color: #40B4E5;
      border-bottom-color: #40B4E5;
    }

    /* ============================================ */
    /* ã‚¿ãƒ–ãƒšã‚¤ãƒ³ */
    /* ============================================ */
    #spa-page-config .cfg-tab-pane {
      display: none;
    }

    #spa-page-config .cfg-tab-pane.active {
      display: block;
    }

    /* ============================================ */
    /* ã‚µãƒ–ã‚¿ãƒ–ï¼ˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰â€” ãƒã‚¹ã‚¿ç®¡ç†ã¨çµ±ä¸€ */
    /* ============================================ */
    #spa-page-config .cfg-subtabs {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      background: #f8f9fa;
      border-bottom: none;
      padding: 8px 8px 0 8px;
      gap: 0;
      scrollbar-width: thin;
    }

    #spa-page-config .cfg-subtabs::-webkit-scrollbar {
      height: 4px;
    }

    #spa-page-config .cfg-subtabs::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 2px;
    }

    #spa-page-config .cfg-subtabs .cfg-subtab {
      flex-shrink: 0;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 500;
      color: #6c757d;
      border: 1px solid transparent;
      border-radius: 6px 6px 0 0;
      background: transparent;
      cursor: pointer;
      white-space: nowrap;
      margin-right: 4px;
      transition: all 0.2s;
    }

    #spa-page-config .cfg-subtabs .cfg-subtab:hover {
      background: #e9ecef;
      color: #495057;
    }

    #spa-page-config .cfg-subtabs .cfg-subtab.active {
      color: #212529;
      background: white;
      border-color: #dee2e6 #dee2e6 white;
      font-weight: 600;
    }

    /* ============================================ */
    /* ã‚µãƒ–ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    /* ============================================ */
    #spa-page-config .cfg-subtab-content {
      background: white;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    #spa-page-config .cfg-subtab-pane {
      display: none;
      padding: 16px;
    }

    #spa-page-config .cfg-subtab-pane.active {
      display: block;
    }

    /* ============================================ */
    /* è¨­å®šã‚«ãƒ¼ãƒ‰ */
    /* ============================================ */
    #spa-page-config .config-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 0 0 100px 0;
    }

    #spa-page-config .cfg-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    #spa-page-config .cfg-card-title {
      font-size: 15px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #spa-page-config .cfg-card-desc {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 12px;
    }

    /* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ */
    #spa-page-config .cfg-toggle-switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
      flex-shrink: 0;
    }
    #spa-page-config .cfg-toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    #spa-page-config .cfg-toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #d1d5db;
      border-radius: 24px;
      transition: background 0.2s;
    }
    #spa-page-config .cfg-toggle-slider::before {
      content: "";
      position: absolute;
      width: 18px;
      height: 18px;
      left: 3px;
      bottom: 3px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    #spa-page-config .cfg-toggle-switch input:checked + .cfg-toggle-slider {
      background: #40B4E5;
    }
    #spa-page-config .cfg-toggle-switch input:checked + .cfg-toggle-slider::before {
      transform: translateX(20px);
    }

    /* ============================================ */
    /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
    /* ============================================ */
    #spa-page-config .form-control {
      width: 100%;
      padding: 10px 12px;
      border: 1.5px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    #spa-page-config .form-control:focus {
      border-color: #40B4E5;
    }

    #spa-page-config select.form-control,
    #spa-page-config select[style] {
      background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236b7280' stroke-width='1.5' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E") no-repeat right 12px center;
      padding-right: 32px;
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
    }

    /* ============================================ */
    /* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ */
    /* ============================================ */
    #spa-page-config .cfg-toggle {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 28px;
    }

    #spa-page-config .cfg-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    #spa-page-config .cfg-toggle .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #e5e7eb;
      transition: 0.3s;
      border-radius: 28px;
    }

    #spa-page-config .cfg-toggle input:checked + .slider {
      background-color: #34C759;
    }

    #spa-page-config .cfg-toggle .slider::before {
      content: '';
      position: absolute;
      height: 24px;
      width: 24px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    #spa-page-config .cfg-toggle input:checked + .slider::before {
      transform: translateX(20px);
    }

    /* ============================================ */
    /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ */
    /* ============================================ */
    #spa-page-config .cfg-accordion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 4px;
    }

    #spa-page-config .cfg-accordion-header .cfg-accordion-icon {
      transition: transform 0.2s;
      font-size: 12px;
      color: #9ca3af;
    }

    #spa-page-config .cfg-accordion-content {
      display: none;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-top: none;
      border-radius: 0 0 8px 8px;
      background: white;
    }

    #spa-page-config .cfg-accordion-content.open {
      display: block;
    }

    /* ============================================ */
    /* ãƒœã‚¿ãƒ³ */
    /* ============================================ */
    #spa-page-config .cfg-btn-primary {
      background: #40B4E5;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    #spa-page-config .cfg-btn-primary:hover {
      background: #2da0d1;
    }

    #spa-page-config .cfg-btn-secondary {
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #d1d5db;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    #spa-page-config .cfg-btn-danger {
      background: #fee2e2;
      color: #dc2626;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    /* ============================================ */
    /* ä¿å­˜ãƒœã‚¿ãƒ³ï¼ˆå›ºå®šãƒ•ãƒƒã‚¿ãƒ¼ï¼‰ */
    /* ============================================ */
    #spa-page-config .cfg-save-footer {
      position: fixed;
      bottom: 82px;
      left: 0;
      right: 0;
      background: white;
      padding: 12px 16px;
      border-top: 1px solid #e5e7eb;
      z-index: 100;
      display: flex;
      justify-content: center;
    }

    #spa-page-config .cfg-save-footer .cfg-save-btn {
      width: 100%;
      max-width: 600px;
      padding: 14px;
      background: linear-gradient(135deg, #40B4E5 0%, #2196F3 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(64, 180, 229, 0.3);
    }

    /* ============================================ */
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    /* ============================================ */
    #spa-page-config .cfg-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    #spa-page-config .cfg-modal-overlay.active {
      display: flex;
    }

    #spa-page-config .cfg-modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      max-height: 90vh;
      overflow-y: auto;
    }

    #spa-page-config .cfg-modal-header {
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #spa-page-config .cfg-modal-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }

    #spa-page-config .cfg-modal-close {
      background: none;
      border: none;
      font-size: 20px;
      color: #6b7280;
      cursor: pointer;
    }

    #spa-page-config .cfg-modal-body {
      padding: 16px;
    }

    /* ============================================ */
    /* iOS PWAå¯¾å¿œ: bodyç›´ä¸‹ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚¹ã‚¿ãƒƒã‚­ãƒ³ã‚°ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè„±å‡ºç”¨ï¼‰ */
    /* ============================================ */
    body > .cfg-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 99999;
      justify-content: center;
      align-items: center;
    }
    body > .cfg-modal-overlay.active {
      display: flex;
    }
    body > .cfg-modal-overlay .cfg-modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      max-height: 90vh;
      overflow-y: auto;
    }
    body > .cfg-modal-overlay .cfg-modal-header {
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    body > .cfg-modal-overlay .cfg-modal-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }
    body > .cfg-modal-overlay .cfg-modal-close {
      background: none;
      border: none;
      font-size: 20px;
      color: #6b7280;
      cursor: pointer;
      padding: 8px;
      -webkit-tap-highlight-color: rgba(0,0,0,0.1);
    }
    body > .cfg-modal-overlay .cfg-modal-body {
      padding: 16px;
    }

    /* iOS PWAå¯¾å¿œ: bodyç›´ä¸‹ mnb-modal */
    body > .mnb-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 99999;
      align-items: center;
      justify-content: center;
    }
    body > .mnb-modal.active { display: flex; }
    body > .mnb-modal .mnb-modal-content {
      background: white;
      border-radius: 12px;
      padding: 20px;
      max-width: 600px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
    }
    body > .mnb-modal .mnb-modal-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #1f2937; }
    body > .mnb-modal .mnb-form-group { margin-bottom: 12px; }
    body > .mnb-modal .mnb-form-label { display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px; }
    body > .mnb-modal .mnb-form-input,
    body > .mnb-modal .mnb-form-select { width: 100%; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 16px; box-sizing: border-box; }
    body > .mnb-modal .mnb-form-select { background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236b7280' stroke-width='1.5' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E") no-repeat right 10px center; padding-right: 30px; cursor: pointer; -webkit-appearance: none; appearance: none; }
    body > .mnb-modal .mnb-modal-actions { display: flex; gap: 8px; margin-top: 16px; }
    body > .mnb-modal .mnb-modal-btn { flex: 1; padding: 8px 14px; border: none; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; }
    body > .mnb-modal .mnb-modal-btn-primary { background: #3b82f6; color: white; }
    body > .mnb-modal .mnb-modal-btn-secondary { background: #e5e7eb; color: #374151; }
    body > .mnb-modal .mnb-type-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 16px; }
    body > .mnb-modal .mnb-type-card { padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s; background: white; }
    body > .mnb-modal .mnb-type-card.selected { border-color: #3b82f6; background: #eff6ff; }

    /* iOS PWAå¯¾å¿œ: bodyç›´ä¸‹ userDetailModal */
    body > #cfg-userDetailModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 99999;
      justify-content: center;
      align-items: center;
    }
    body > #cfg-userDetailModal .cfg-modal-sheet {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 400px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
    }

    /* ============================================ */
    /* ç®¡ç†ç•ªå·ãƒ“ãƒ«ãƒ€ãƒ¼ï¼ˆæ—§ç‰ˆManagementNumberBuilderç§»æ¤ï¼‰ */
    /* ============================================ */
    #spa-page-config .mnb-container {
      padding: 0;
    }

    /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆ */
    #spa-page-config .mnb-segments {
      background: white;
      border: none;
      border-radius: 8px;
      padding: 0;
      min-height: 100px;
      margin-bottom: 16px;
    }

    #spa-page-config .mnb-segments.drag-over {
      background: #e3f2fd;
      border-color: #2196f3;
    }

    #spa-page-config .mnb-segments-empty {
      text-align: center;
      color: #9ca3af;
      padding: 24px 16px;
      font-size: 13px;
      line-height: 1.6;
    }

    /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒ–ãƒ­ãƒƒã‚¯ */
    #spa-page-config .mnb-segment {
      background: white;
      border: 1px solid #e5e7eb;
      color: #1f2937;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: move;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      transition: all 0.2s;
    }

    #spa-page-config .mnb-segment:hover {
      border-color: #3b82f6;
      box-shadow: 0 2px 6px rgba(59,130,246,0.15);
    }

    #spa-page-config .mnb-segment.dragging {
      opacity: 0.5;
    }

    #spa-page-config .mnb-segment-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }

    #spa-page-config .mnb-segment-drag-handle {
      font-size: 16px;
      color: #9ca3af;
      cursor: grab;
    }

    #spa-page-config .mnb-segment-drag-handle:active {
      cursor: grabbing;
    }

    #spa-page-config .mnb-segment-icon {
      font-size: 18px;
    }

    #spa-page-config .mnb-segment-type {
      flex: 1;
      font-size: 12px;
      font-weight: 500;
      color: #6b7280;
    }

    #spa-page-config .mnb-segment-value {
      font-size: 15px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 8px;
    }

    #spa-page-config .mnb-segment-controls {
      display: flex;
      gap: 8px;
    }

    #spa-page-config .mnb-segment-btn {
      flex: 1;
      background: white;
      border: 1px solid #d1d5db;
      color: #374151;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
      font-weight: 500;
    }

    #spa-page-config .mnb-segment-btn:hover {
      background: #f9fafb;
      border-color: #9ca3af;
    }

    #spa-page-config .mnb-segment-btn.delete {
      color: #ef4444;
      border-color: #fecaca;
    }

    #spa-page-config .mnb-segment-btn.delete:hover {
      background: #fef2f2;
      border-color: #ef4444;
    }

    /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¿½åŠ ãƒœã‚¿ãƒ³ */
    #spa-page-config .mnb-add-segment {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      width: 100%;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    #spa-page-config .mnb-add-segment:hover {
      background: #2563eb;
    }

    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å…±é€š */
    #spa-page-config .cfg-preview {
      background: #f0f9ff;
      border: 2px solid #bae6fd;
      border-radius: 10px;
      padding: 14px;
      text-align: center;
    }
    #spa-page-config .cfg-preview-label {
      font-size: 11px;
      font-weight: 600;
      color: #0369a1;
      margin-bottom: 6px;
    }
    #spa-page-config .cfg-preview-value {
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
    }

    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
    #spa-page-config .mnb-preview {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
    }

    #spa-page-config .mnb-preview-label {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 8px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    #spa-page-config .mnb-preview-value {
      padding: 6px 10px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 6px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 11px;
      color: #1e40af;
      font-weight: 500;
    }

    /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */
    #spa-page-config .mnb-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }

    #spa-page-config .mnb-modal.active {
      display: flex;
    }

    #spa-page-config .mnb-modal-content {
      background: white;
      border-radius: 12px;
      padding: 20px;
      max-width: 600px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
    }

    #spa-page-config .mnb-modal-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #1f2937;
    }

    #spa-page-config .mnb-form-group {
      margin-bottom: 12px;
    }

    #spa-page-config .mnb-form-label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 4px;
    }

    #spa-page-config .mnb-form-input,
    #spa-page-config .mnb-form-select {
      width: 100%;
      padding: 6px 10px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 16px;
      box-sizing: border-box;
    }

    #spa-page-config .mnb-form-select {
      background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236b7280' stroke-width='1.5' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E") no-repeat right 10px center;
      padding-right: 30px;
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
    }

    #spa-page-config .mnb-form-input:focus,
    #spa-page-config .mnb-form-select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    #spa-page-config .mnb-modal-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }

    #spa-page-config .mnb-modal-btn {
      flex: 1;
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    #spa-page-config .mnb-modal-btn-primary {
      background: #3b82f6;
      color: white;
    }

    #spa-page-config .mnb-modal-btn-primary:hover {
      background: #2563eb;
    }

    #spa-page-config .mnb-modal-btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }

    #spa-page-config .mnb-modal-btn-secondary:hover {
      background: #d1d5db;
    }

    /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—é¸æŠ */
    #spa-page-config .mnb-type-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    #spa-page-config .mnb-type-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      padding: 10px 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    #spa-page-config .mnb-type-card:hover {
      border-color: #3b82f6;
      background: #f0f9ff;
    }

    #spa-page-config .mnb-type-card.selected {
      border-color: #3b82f6;
      background: #dbeafe;
    }

    #spa-page-config .mnb-type-card-icon {
      font-size: 30px;
      margin-bottom: 4px;
    }

    #spa-page-config .mnb-type-card-name {
      font-size: 13px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 3px;
    }

    #spa-page-config .mnb-type-card-desc {
      font-size: 11px;
      color: #6b7280;
      line-height: 1.3;
    }

    /* ãƒ—ãƒªã‚»ãƒƒãƒˆã‚«ãƒ¼ãƒ‰é¸æŠã‚¹ã‚¿ã‚¤ãƒ« */
    #spa-page-config .mnb-preset-card {
      transition: all 0.2s ease;
      position: relative;
    }

    #spa-page-config .mnb-preset-card > div:first-child {
      padding-right: 32px;
    }

    #spa-page-config .mnb-preset-card:hover {
      border-color: #3b82f6 !important;
      background: #f8fafc !important;
    }

    #spa-page-config .mnb-preset-card.selected {
      border-color: #3b82f6 !important;
      background: #eff6ff !important;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    #spa-page-config .mnb-preset-card::before {
      content: "";
      position: absolute;
      top: 14px;
      right: 12px;
      width: 20px;
      height: 20px;
      background: white;
      border: 2px solid #d1d5db;
      border-radius: 50%;
    }

    #spa-page-config .mnb-preset-card.selected::before {
      background: #3b82f6;
      border-color: #3b82f6;
    }

    #spa-page-config .mnb-preset-card.selected::after {
      content: "";
      position: absolute;
      top: 18px;
      right: 18px;
      width: 5px;
      height: 9px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }

    /* Sortable.js ã‚´ãƒ¼ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
    #spa-page-config .sortable-ghost {
      opacity: 0.4;
    }

    #spa-page-config .sortable-chosen {
      box-shadow: 0 4px 12px rgba(59,130,246,0.3);
    }


    /* ============================================ */
    /* ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« */
    /* ============================================ */
    #spa-page-config .platform-select-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    #spa-page-config .platform-select-modal.active {
      display: flex;
    }

    /* ============================================ */
    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ»æ¨©é™è¨­å®š */
    /* ============================================ */
    #spa-page-config .cfg-user-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    #spa-page-config .cfg-user-card:hover {
      background: #f3f4f6;
    }

    /* ============================================ */
    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆbodyç›´ä¸‹ã«ç§»å‹•ã•ã‚Œã‚‹ãŸã‚IDç›´æŒ‡å®šï¼‰ */
    /* ============================================ */
    #cfg-userDetailModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 99999;
      justify-content: center;
      align-items: center;
    }

    #cfg-userDetailModal .cfg-modal-sheet {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
    }

    #cfg-userDetailModal .cfg-modal-sheet-header {
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e5e7eb;
    }
    #cfg-userDetailModal .cfg-modal-sheet-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }

    #cfg-userDetailModal .cfg-modal-sheet-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px 16px;
    }

    #cfg-userDetailModal .cfg-modal-sheet-footer {
      padding: 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
      border-top: 1px solid #e5e7eb;
    }
    #cfg-userDetailModal .cfg-modal-close {
      background: none;
      border: none;
      font-size: 20px;
      color: #6b7280;
      cursor: pointer;
      padding: 8px;
    }

    /* ============================================ */
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    /* ============================================ */
    @media (max-width: 768px) {
      #spa-page-config .cfg-subtabs .cfg-subtab {
        font-size: 12px;
        padding: 8px 12px;
      }
    }
  </style>

  <!-- ============================================ -->
  <!-- ã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <!-- ============================================ -->
  <div class="sub-header">
    <button class="back-btn" id="cfg-back-button" onclick="spaGoBack()">
      <i class="bi bi-chevron-left"></i>
    </button>
    <span class="page-title" id="cfg-page-header-title">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</span>
    <div class="header-icons">
      <!-- å°†æ¥ã®æ‹¡å¼µç”¨ -->
    </div>
  </div>

  <!-- ============================================ -->
  <!-- è¨­å®šã‚³ãƒ³ãƒ†ãƒŠ -->
  <!-- ============================================ -->
  <div class="config-container" id="cfg-configContainer">

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–ãƒšã‚¤ãƒ³: å•†å“ç™»éŒ²è¨­å®š -->
    <div class="cfg-tab-pane" id="cfg-product">
      <!-- ã‚µãƒ–ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
      <div class="cfg-subtabs" id="cfg-productConfigTabs">
        <button class="cfg-subtab active" data-target="cfg-product-salesword"><i class="bi bi-chat-quote"></i> ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰</button>
        <button class="cfg-subtab" data-target="cfg-product-condition"><i class="bi bi-toggle-on"></i> å•†å“çŠ¶æ…‹</button>
        <button class="cfg-subtab" data-target="cfg-product-hashtag"><i class="bi bi-tag"></i> ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°</button>
        <button class="cfg-subtab" data-target="cfg-product-discount"><i class="bi bi-percent"></i> å‰²å¼•</button>
        <button class="cfg-subtab" data-target="cfg-product-ai"><i class="bi bi-stars"></i> AIç”Ÿæˆ</button>
        <button class="cfg-subtab" data-target="cfg-product-order"><i class="bi bi-sort-numeric-down"></i> é…ç½®é †åº</button>
      </div>
      <!-- ã‚µãƒ–ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <div id="cfg-productConfigTabContent" class="cfg-subtab-content">
        <!-- ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š -->
        <div class="cfg-subtab-pane active" id="cfg-product-salesword">

          <!--è¡¨ç¤ºå½¢å¼è¨­å®š -->
          <div class="cfg-card" style="margin-bottom: 12px;">
            <div class="cfg-card-title"><i class="bi bi-palette"></i>è¡¨ç¤ºå½¢å¼è¨­å®š</div>
            <div style="background: #f0f9ff; border-left: 3px solid #0ea5e9; padding: 10px 12px; border-radius: 0 8px 8px 0; margin-bottom: 14px; font-size: 12px; color: #0369a1;">
              ğŸ’¡ å…¨ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰å…±é€šã®å‰è¨˜å·ãƒ»å¾Œè¨˜å·ã‚’è¨­å®šã—ã¾ã™ã€‚ãƒ¯ãƒ¼ãƒ‰åˆ¥ã«å€‹åˆ¥è¨­å®šã‚‚å¯èƒ½ã§ã™ã€‚
            </div>

            <!-- ã‚°ãƒ­ãƒ¼ãƒãƒ«å‰è¨˜å· -->
            <div style="margin-bottom: 12px;">
              <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">å‰è¨˜å·</label>
              <select id="cfg-saleswordPrefixSelect" class="form-control" onchange="cfgHandlePrefixChange()">
                <option value="">ãªã—</option>
                <option value="ã€">ã€</option>
                <option value="ã€">ã€</option>
                <option value="ã€Œ">ã€Œ</option>
                <option value="ï¼ˆ">ï¼ˆ</option>
                <option value="â˜…">â˜…</option>
                <option value="â˜†">â˜†</option>
                <option value="â—†">â—†</option>
                <option value="â—‡">â—‡</option>
                <option value="â– ">â– </option>
                <option value="â–¡">â–¡</option>
                <option value="â—">â—</option>
                <option value="â—‹">â—‹</option>
                <option value="â–¶">â–¶</option>
                <option value="âœ¨">âœ¨</option>
                <option value="ğŸ”¥">ğŸ”¥</option>
                <option value="custom">ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›...</option>
              </select>
              <input type="text" id="cfg-saleswordPrefixCustom" class="form-control" maxlength="5" placeholder="ã‚«ã‚¹ã‚¿ãƒ å‰è¨˜å·" style="display: none; margin-top: 6px;" oninput="cfgUpdateSaleswordFormatPreview()">
            </div>

            <!-- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¾Œè¨˜å· -->
            <div style="margin-bottom: 12px;">
              <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">å¾Œè¨˜å·</label>
              <select id="cfg-saleswordSuffixSelect" class="form-control" onchange="cfgHandleSuffixChange()">
                <option value="">ãªã—</option>
                <option value="ã€‘">ã€‘</option>
                <option value="ã€">ã€</option>
                <option value="ã€">ã€</option>
                <option value="ï¼‰">ï¼‰</option>
                <option value="â˜…">â˜…</option>
                <option value="â˜†">â˜†</option>
                <option value="â—†">â—†</option>
                <option value="â—‡">â—‡</option>
                <option value="â– ">â– </option>
                <option value="â–¡">â–¡</option>
                <option value="â—">â—</option>
                <option value="â—‹">â—‹</option>
                <option value="â—€">â—€</option>
                <option value="âœ¨">âœ¨</option>
                <option value="ğŸ”¥">ğŸ”¥</option>
                <option value="custom">ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›...</option>
              </select>
              <input type="text" id="cfg-saleswordSuffixCustom" class="form-control" maxlength="5" placeholder="ã‚«ã‚¹ã‚¿ãƒ å¾Œè¨˜å·" style="display: none; margin-top: 6px;" oninput="cfgUpdateSaleswordFormatPreview()">
            </div>

            <!-- ãƒ©ã‚¤ãƒ–ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div class="cfg-preview">
              <div class="cfg-preview-label">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
              <div id="cfg-saleswordFormatPreview" class="cfg-preview-value">ã€ç¾å“ã€‘</div>
            </div>

            <!-- ãƒ¯ãƒ¼ãƒ‰åˆ¥å€‹åˆ¥è¨­å®š -->
            <div style="margin-top: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <label style="font-size: 13px; font-weight: 600; color: #374151;">ãƒ¯ãƒ¼ãƒ‰åˆ¥å€‹åˆ¥è¨­å®š</label>
              </div>
              <div style="background: #f0f9ff; border-left: 3px solid #0ea5e9; padding: 8px 12px; border-radius: 0 8px 8px 0; margin-bottom: 10px; font-size: 11px; color: #0369a1;">
                ğŸ’¡ ç‰¹å®šã®ãƒ¯ãƒ¼ãƒ‰ã ã‘ç•°ãªã‚‹è¨˜å·ã‚’ä½¿ã„ãŸã„å ´åˆã«è¨­å®šã—ã¾ã™
              </div>
              <div id="cfg-wordOverrideList" style="display: flex; flex-direction: column; gap: 8px;"></div>
              <button type="button" onclick="cfgAddWordOverride()" style="margin-top: 8px; padding: 10px; width: 100%; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer;">
                <i class="bi bi-plus-lg"></i> å€‹åˆ¥è¨­å®šã‚’è¿½åŠ 
              </button>
            </div>
          </div>

          <!--ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¯ãƒ¼ãƒ‰ -->
          <div class="cfg-card" style="margin-bottom: 12px;">
            <div class="cfg-card-title"><i class="bi bi-star"></i>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¯ãƒ¼ãƒ‰ï¼ˆè‡ªå‹•å…¥åŠ›ï¼‰</div>
            <div style="background: #f0f9ff; border-left: 3px solid #0ea5e9; padding: 10px 12px; border-radius: 0 8px 8px 0; margin-bottom: 14px; font-size: 12px; color: #0369a1;">
              ğŸ’¡ å•†å“ç™»éŒ²æ™‚ã«è‡ªå‹•çš„ã«é¸æŠã•ã‚Œã‚‹ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¾ã™
            </div>
            <div style="margin-bottom: 12px;">
              <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">ã‚«ãƒ†ã‚´ãƒª</label>
              <select id="cfg-defaultSaleswordCategory" class="form-control" onchange="cfgUpdateDefaultSaleswordOptions()">
                <option value="">-- ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ --</option>
              </select>
            </div>
            <div>
              <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
              <select id="cfg-defaultSalesword" class="form-control">
                <option value="">-- ãƒ¯ãƒ¼ãƒ‰ã‚’é¸æŠ --</option>
              </select>
            </div>
          </div>

          <!--ã‚ˆãä½¿ã†ãƒ¯ãƒ¼ãƒ‰ -->
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-bookmark-star"></i>ã‚ˆãä½¿ã†ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚¯ã‚¤ãƒƒã‚¯é¸æŠï¼‰</div>
            <div style="background: #f0f9ff; border-left: 3px solid #0ea5e9; padding: 10px 12px; border-radius: 0 8px 8px 0; margin-bottom: 14px; font-size: 12px; color: #0369a1;">
              ğŸ’¡ å•†å“ç™»éŒ²ç”»é¢ã§ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§è¿½åŠ ã§ãã‚‹ãƒ¯ãƒ¼ãƒ‰ã‚’ç™»éŒ²ã—ã¾ã™
            </div>
            <!-- è¿½åŠ ç”¨ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ -->
            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
              <div style="margin-bottom: 8px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">ã‚«ãƒ†ã‚´ãƒª</label>
                <select id="cfg-saleswordCategory" class="form-control" onchange="cfgUpdateSaleswordOptions()">
                  <option value="">-- ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ --</option>
                </select>
              </div>
              <div style="margin-bottom: 8px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <select id="cfg-saleswordSelect" class="form-control">
                  <option value="">-- ãƒ¯ãƒ¼ãƒ‰ã‚’é¸æŠ --</option>
                </select>
              </div>
              <button type="button" onclick="cfgAddSaleswordFromDropdown()" style="padding: 10px; width: 100%; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer;">
                <i class="bi bi-plus-lg"></i> ã‚ˆãä½¿ã†ãƒªã‚¹ãƒˆã«è¿½åŠ 
              </button>
            </div>
            <!-- ç™»éŒ²æ¸ˆã¿ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ -->
            <div id="cfg-saleswordList" style="display: flex; flex-direction: column; gap: 8px;"></div>
            <div id="cfg-saleswordEmptyMsg" style="text-align: center; color: #9ca3af; font-size: 13px; padding: 16px; display: none;">
              ã‚ˆãä½¿ã†ãƒ¯ãƒ¼ãƒ‰ãŒæœªç™»éŒ²ã§ã™
            </div>
          </div>
        </div>

        <!-- å•†å“çŠ¶æ…‹è¨­å®š -->
        <div class="cfg-subtab-pane" id="cfg-product-condition">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-check-circle"></i> å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³è¨­å®š</div>
            <div class="cfg-card-desc">å•†å“ç™»éŒ²ç”»é¢ã§çŠ¶æ…‹ã‚’é¸ã‚“ã æ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ãƒœã‚¿ãƒ³ã‚’è¨­å®šã—ã¾ã™</div>
            <div style="background: #f0f9ff; border-left: 3px solid #0ea5e9; padding: 10px 12px; border-radius: 0 8px 8px 0; margin-bottom: 14px; font-size: 12px; color: #0369a1;">
              ğŸ’¡ å„å•†å“çŠ¶æ…‹ã”ã¨ã«ã€èª¬æ˜æ–‡ã®ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ãƒœã‚¿ãƒ³ï¼ˆãƒ©ãƒ™ãƒ«ï¼‹ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã‚’è¨­å®šã§ãã¾ã™
            </div>
            <div id="cfg-conditionButtonsContainer" style="display: flex; flex-direction: column; gap: 8px;"></div>
            <div style="display: flex; gap: 8px; margin-top: 12px;">
              <button type="button" onclick="cfgClearConditionButtons()" style="flex: 1; padding: 10px 16px; background: white; color: #ef4444; border: 2px solid #ef4444; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer;">
                <i class="bi bi-trash"></i> å…¨ã‚¯ãƒªã‚¢
              </button>
            </div>
          </div>
        </div>

        <!-- ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°è¨­å®š -->
        <div class="cfg-subtab-pane" id="cfg-product-hashtag">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-hash"></i> ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°è¨­å®š</div>
            <div class="cfg-card-desc">å•†å“èª¬æ˜ã«è‡ªå‹•è¿½åŠ ã™ã‚‹ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’è¨­å®šã—ã¾ã™</div>
            <div style="background: #f0f9ff; border-left: 3px solid #0ea5e9; padding: 10px 12px; border-radius: 0 8px 8px 0; margin-bottom: 14px; font-size: 12px; color: #0369a1;">
              ğŸ’¡ ã‚¿ã‚¤ãƒ—åˆ¥ã«ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’è¨­å®šã§ãã¾ã™ã€‚å…±é€šãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã¯å…¨ã‚¿ã‚°ã®å…ˆé ­ã«ä»˜ä¸ã•ã‚Œã¾ã™ã€‚
            </div>
            <!-- å…±é€šãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ -->
            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 14px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 6px;">å…±é€šãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹</label>
              <div style="display: flex; align-items: center; gap: 4px;">
                <span style="color: #6b7280; font-size: 14px; font-weight: 600;">#</span>
                <input type="text" id="cfg-hashtagCommonPrefix" class="form-control" placeholder="ä¾‹: REBORN_" style="font-size: 13px;" oninput="cfgUpdateAllHashtagPreviews()">
              </div>
              <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">ã‚·ãƒ§ãƒƒãƒ—åç­‰ã‚’å…¨ã‚¿ã‚°ã®å…ˆé ­ã«ä»˜ä¸ã—ã¾ã™ï¼ˆä¾‹: #REBORN_ç¾å“ï¼‰</div>
            </div>
            <!-- ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§ -->
            <div id="cfg-hashtagItemsContainer"></div>
            <!-- ã‚¿ã‚¤ãƒ—è¿½åŠ ãƒœã‚¿ãƒ³ -->
            <button type="button" onclick="cfgShowHashtagTypeSelector()" style="margin-top: 12px; padding: 10px; width: 100%; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer;">
              <i class="bi bi-plus-lg"></i> ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’è¿½åŠ 
            </button>
            <!-- ã‚¿ã‚¤ãƒ—é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
            <div id="cfg-hashtagTypeSelector" style="display: none; margin-top: 8px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px;">
              <div style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 6px;">ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ:</div>
              <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                <button type="button" onclick="cfgAddHashtagItemByType('å…¨å•†å“')" style="padding: 6px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; cursor: pointer;">ğŸŒ å…¨å•†å“</button>
                <button type="button" onclick="cfgAddHashtagItemByType('ãƒ–ãƒ©ãƒ³ãƒ‰')" style="padding: 6px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; cursor: pointer;">ğŸ‘” ãƒ–ãƒ©ãƒ³ãƒ‰</button>
                <button type="button" onclick="cfgAddHashtagItemByType('ã‚«ãƒ†ã‚´ãƒª')" style="padding: 6px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; cursor: pointer;">ğŸ“ ã‚«ãƒ†ã‚´ãƒª</button>
                <button type="button" onclick="cfgAddHashtagItemByType('ã‚«ãƒ©ãƒ¼')" style="padding: 6px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; cursor: pointer;">ğŸ¨ ã‚«ãƒ©ãƒ¼</button>
                <button type="button" onclick="cfgAddHashtagItemByType('ã‚µã‚¤ã‚º')" style="padding: 6px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; cursor: pointer;">ğŸ“ ã‚µã‚¤ã‚º</button>
              </div>
              <button type="button" onclick="cfgHideHashtagTypeSelector()" style="margin-top: 6px; padding: 4px 10px; background: none; border: none; color: #6b7280; font-size: 12px; cursor: pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
            <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div class="cfg-preview" style="margin-top: 16px;">
              <div class="cfg-preview-label">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
              <div id="cfg-hashtagPreview" class="cfg-preview-value" style="white-space: pre-line;"></div>
            </div>
          </div>
        </div>

        <!-- å‰²å¼•è¨­å®š -->
        <div class="cfg-subtab-pane" id="cfg-product-discount">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-percent"></i> å‰²å¼•è¨­å®š</div>
            <div class="cfg-card-desc">å•†å“èª¬æ˜ã«è¡¨ç¤ºã™ã‚‹å‰²å¼•æƒ…å ±ã‚’è¨­å®šã—ã¾ã™</div>
            <div style="background: #f0f9ff; border-left: 3px solid #0ea5e9; padding: 10px 12px; border-radius: 0 8px 8px 0; margin-bottom: 14px; font-size: 12px; color: #0369a1;">
              ğŸ’¡ ãƒ•ã‚©ãƒ­ãƒ¼å‰²ãƒ»ãƒªãƒ”ãƒ¼ãƒˆå‰²ãƒ»ã¾ã¨ã‚å‰²ãªã©ã€å‰²å¼•ã‚¿ã‚¤ãƒ—ã”ã¨ã«è¨­å®šã§ãã¾ã™
            </div>
            <!-- ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š -->
            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 14px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 6px;">ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ«</label>
              <select id="cfg-discountTitleSelect" class="form-control" style="font-size: 13px;" onchange="cfgHandleDiscountTitleChange()">
                <option value="ã€ãŠå¾—ãªå‰²å¼•æƒ…å ±ã€‘">ã€ãŠå¾—ãªå‰²å¼•æƒ…å ±ã€‘</option>
                <option value="ã€å‰²å¼•æƒ…å ±ã€‘">ã€å‰²å¼•æƒ…å ±ã€‘</option>
                <option value="ã€ãƒ•ã‚©ãƒ­ãƒ¼å‰²ãƒ»ãƒªãƒ”ãƒ¼ãƒˆå‰²ã€‘">ã€ãƒ•ã‚©ãƒ­ãƒ¼å‰²ãƒ»ãƒªãƒ”ãƒ¼ãƒˆå‰²ã€‘</option>
                <option value="custom">ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›...</option>
              </select>
              <input type="text" id="cfg-discountTitleCustom" class="form-control" placeholder="ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›" style="font-size: 13px; margin-top: 6px; display: none;" oninput="cfgUpdateDiscountPreview()">
            </div>
            <!-- å‰²å¼•ã‚¿ã‚¤ãƒ—ä¸€è¦§ -->
            <div id="cfg-discountTypesList"></div>
            <!-- å‰²å¼•ã‚¿ã‚¤ãƒ—è¿½åŠ ãƒœã‚¿ãƒ³ -->
            <button type="button" onclick="cfgAddDiscountType()" style="margin-top: 12px; padding: 10px; width: 100%; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer;">
              <i class="bi bi-plus-lg"></i> å‰²å¼•ã‚¿ã‚¤ãƒ—ã‚’è¿½åŠ 
            </button>
            <!-- ã‚¿ã‚¤ãƒ—é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
            <div id="cfg-discountTypeSelector" style="display: none; margin-top: 8px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px;">
              <div style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 6px;">è¿½åŠ ã™ã‚‹å‰²å¼•ã‚¿ã‚¤ãƒ—:</div>
              <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                <button type="button" onclick="cfgConfirmAddDiscountType('ãƒ•ã‚©ãƒ­ãƒ¼å‰²')" style="padding: 6px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; cursor: pointer;">ğŸ¤ ãƒ•ã‚©ãƒ­ãƒ¼å‰²</button>
                <button type="button" onclick="cfgConfirmAddDiscountType('ãƒªãƒ”ãƒ¼ãƒˆå‰²')" style="padding: 6px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; cursor: pointer;">ğŸ”„ ãƒªãƒ”ãƒ¼ãƒˆå‰²</button>
                <button type="button" onclick="cfgConfirmAddDiscountType('ã¾ã¨ã‚å‰²')" style="padding: 6px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; cursor: pointer;">ğŸ“¦ ã¾ã¨ã‚å‰²</button>
              </div>
              <button type="button" onclick="cfgCancelAddDiscountType()" style="margin-top: 6px; padding: 4px 10px; background: none; border: none; color: #6b7280; font-size: 12px; cursor: pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
            <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div class="cfg-preview" style="margin-top: 16px;">
              <div class="cfg-preview-label">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
              <div id="cfg-discountPreview" class="cfg-preview-value" style="white-space: pre-line;"></div>
            </div>
          </div>
        </div>

        <!-- AIç”Ÿæˆè¨­å®š -->
        <div class="cfg-subtab-pane" id="cfg-product-ai">
          <div class="cfg-card" style="margin-bottom: 12px;">
            <div class="cfg-card-title"><i class="bi bi-stars"></i> AIç”Ÿæˆè¨­å®š</div>
            <div class="cfg-card-desc">AIã«ã‚ˆã‚‹å•†å“èª¬æ˜æ–‡ã®ç”Ÿæˆè¨­å®šã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¾ã™</div>
            <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠ -->
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
              <div id="cfg-aiPresetButtons" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
            </div>
            <!-- è©³ç´°è¨­å®š -->
            <div id="cfg-aiDetailSettings">
              <div style="margin-bottom: 12px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">ãƒˆãƒ¼ãƒ³</label>
                <select id="cfg-aiTone" class="form-control" onchange="cfgUpdateAiConfigPreview()">
                  <option value="casual">ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«</option>
                  <option value="formal">ãƒ•ã‚©ãƒ¼ãƒãƒ«</option>
                  <option value="friendly">ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼</option>
                  <option value="professional">ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«</option>
                </select>
              </div>
              <div style="margin-bottom: 12px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">é•·ã•</label>
                <select id="cfg-aiLength" class="form-control" onchange="cfgUpdateAiConfigPreview()">
                  <option value="short">çŸ­ã‚ï¼ˆ50-100æ–‡å­—ï¼‰</option>
                  <option value="medium">æ™®é€šï¼ˆ100-200æ–‡å­—ï¼‰</option>
                  <option value="long">é•·ã‚ï¼ˆ200-400æ–‡å­—ï¼‰</option>
                </select>
              </div>
              <div style="margin-bottom: 12px;">
                <label style="display: flex; align-items: center; justify-content: space-between;">
                  <span style="font-size: 13px; font-weight: 500; color: #374151;">æ¸©åº¦ï¼ˆå‰µé€ æ€§ï¼‰</span>
                  <span id="cfg-aiTempDisplay" style="font-size: 13px; color: #6b7280;">0.7</span>
                </label>
                <input type="range" id="cfg-aiTemperature" min="0" max="1" step="0.1" value="0.7"
                  style="width: 100%; margin-top: 4px;"
                  oninput="cfgUpdateTempDisplay(this.value); cfgUpdateAiConfigPreview();">
              </div>
              <div style="margin-bottom: 12px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">è¿½åŠ æŒ‡ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                <textarea id="cfg-aiCustomPrompt" class="form-control" rows="3" placeholder="ä¾‹: è‹¥ã„å¥³æ€§å‘ã‘ã®è¡¨ç¾ã‚’ä½¿ã£ã¦ãã ã•ã„" onchange="cfgUpdateAiConfigPreview()"></textarea>
              </div>
            </div>
          </div>

          <!-- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ -->
          <div class="cfg-card" style="margin-bottom: 12px;">
            <div class="cfg-card-title"><i class="bi bi-file-text"></i> ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</div>
            <div style="background: #f0f9ff; border-left: 3px solid #0ea5e9; padding: 10px 12px; border-radius: 0 8px 8px 0; margin-bottom: 14px; font-size: 12px; color: #0369a1;">
              ğŸ’¡ AIç”Ÿæˆã«ä½¿ç”¨ã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã™ã€‚å¤‰æ•°ã‚¿ã‚°ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æŒ¿å…¥ã§ãã¾ã™ã€‚
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px;" id="cfg-aiTemplateVarButtons">
              <button type="button" onclick="cfgInsertTemplateVar('{brand}')" style="padding: 4px 8px; background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; border-radius: 4px; font-size: 11px; cursor: pointer;">{brand}</button>
              <button type="button" onclick="cfgInsertTemplateVar('{item}')" style="padding: 4px 8px; background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; border-radius: 4px; font-size: 11px; cursor: pointer;">{item}</button>
              <button type="button" onclick="cfgInsertTemplateVar('{category}')" style="padding: 4px 8px; background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; border-radius: 4px; font-size: 11px; cursor: pointer;">{category}</button>
              <button type="button" onclick="cfgInsertTemplateVar('{size}')" style="padding: 4px 8px; background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; border-radius: 4px; font-size: 11px; cursor: pointer;">{size}</button>
              <button type="button" onclick="cfgInsertTemplateVar('{condition}')" style="padding: 4px 8px; background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; border-radius: 4px; font-size: 11px; cursor: pointer;">{condition}</button>
              <button type="button" onclick="cfgInsertTemplateVar('{material}')" style="padding: 4px 8px; background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; border-radius: 4px; font-size: 11px; cursor: pointer;">{material}</button>
              <button type="button" onclick="cfgInsertTemplateVar('{color}')" style="padding: 4px 8px; background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; border-radius: 4px; font-size: 11px; cursor: pointer;">{color}</button>
            </div>
            <textarea id="cfg-aiPromptTemplate" class="form-control" rows="8" placeholder="ä¾‹: {brand}ã®{item}ã«ã¤ã„ã¦ã€{category}ã‚«ãƒ†ã‚´ãƒªã®å•†å“ã¨ã—ã¦é­…åŠ›çš„ãªèª¬æ˜æ–‡ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚" oninput="cfgUpdateAiConfigPreview()"></textarea>
          </div>

          <!-- è¦‹å‡ºã—ã‚¹ã‚¿ã‚¤ãƒ« & ãƒˆãƒ¼ã‚¯ãƒ³æ•° -->
          <div class="cfg-card" style="margin-bottom: 12px;">
            <div class="cfg-card-title"><i class="bi bi-sliders"></i> è©³ç´°ã‚ªãƒ—ã‚·ãƒ§ãƒ³</div>
            <div style="margin-bottom: 12px;">
              <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">è¦‹å‡ºã—ã‚¹ã‚¿ã‚¤ãƒ«</label>
              <select id="cfg-aiHeadingStyle" class="form-control" onchange="cfgUpdateAiConfigPreview()">
                <option value="emoji">çµµæ–‡å­—ä»˜ãï¼ˆä¾‹: ğŸ· ãƒ–ãƒ©ãƒ³ãƒ‰æƒ…å ±ï¼‰</option>
                <option value="brackets">ã€ã€‘æ‹¬å¼§ä»˜ãï¼ˆä¾‹: ã€ãƒ–ãƒ©ãƒ³ãƒ‰æƒ…å ±ã€‘ï¼‰</option>
                <option value="square">â–  è¨˜å·ä»˜ãï¼ˆä¾‹: â–  ãƒ–ãƒ©ãƒ³ãƒ‰æƒ…å ±ï¼‰</option>
                <option value="none">ãªã—ï¼ˆè¦‹å‡ºã—ãªã—ï¼‰</option>
              </select>
            </div>
            <div style="margin-bottom: 12px;">
              <label style="display: flex; align-items: center; justify-content: space-between;">
                <span style="font-size: 13px; font-weight: 500; color: #374151;">æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°</span>
                <span id="cfg-aiMaxTokensDisplay" style="font-size: 13px; color: #6b7280;">500</span>
              </label>
              <input type="range" id="cfg-aiMaxTokens" min="100" max="2000" step="50" value="500"
                style="width: 100%; margin-top: 4px;"
                oninput="document.getElementById('cfg-aiMaxTokensDisplay').textContent = this.value; cfgUpdateAiConfigPreview();">
              <div style="display: flex; justify-content: space-between; font-size: 10px; color: #9ca3af; margin-top: 2px;">
                <span>100</span><span>500</span><span>1000</span><span>2000</span>
              </div>
            </div>
          </div>

          <!-- å«ã‚ã‚‹è¦ç´  -->
          <div class="cfg-card" style="margin-bottom: 12px;">
            <div class="cfg-card-title"><i class="bi bi-list-check"></i> å«ã‚ã‚‹è¦ç´ </div>
            <div style="background: #f0f9ff; border-left: 3px solid #0ea5e9; padding: 10px 12px; border-radius: 0 8px 8px 0; margin-bottom: 14px; font-size: 12px; color: #0369a1;">
              ğŸ’¡ AIç”Ÿæˆæ–‡ã«å«ã‚ã‚‹æƒ…å ±ã‚’é¸æŠã—ã¾ã™
            </div>
            <div id="cfg-aiIncludeElements" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
              <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f9fafb; border-radius: 8px; font-size: 13px; cursor: pointer;">
                <input type="checkbox" id="cfg-aiElem-brand" checked onchange="cfgUpdateAiConfigPreview()"> ãƒ–ãƒ©ãƒ³ãƒ‰æƒ…å ±
              </label>
              <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f9fafb; border-radius: 8px; font-size: 13px; cursor: pointer;">
                <input type="checkbox" id="cfg-aiElem-category" checked onchange="cfgUpdateAiConfigPreview()"> ã‚«ãƒ†ã‚´ãƒªæƒ…å ±
              </label>
              <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f9fafb; border-radius: 8px; font-size: 13px; cursor: pointer;">
                <input type="checkbox" id="cfg-aiElem-size" checked onchange="cfgUpdateAiConfigPreview()"> ã‚µã‚¤ã‚ºæƒ…å ±
              </label>
              <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f9fafb; border-radius: 8px; font-size: 13px; cursor: pointer;">
                <input type="checkbox" id="cfg-aiElem-material" checked onchange="cfgUpdateAiConfigPreview()"> ç´ ææƒ…å ±
              </label>
              <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f9fafb; border-radius: 8px; font-size: 13px; cursor: pointer;">
                <input type="checkbox" id="cfg-aiElem-color" checked onchange="cfgUpdateAiConfigPreview()"> ã‚«ãƒ©ãƒ¼æƒ…å ±
              </label>
              <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f9fafb; border-radius: 8px; font-size: 13px; cursor: pointer;">
                <input type="checkbox" id="cfg-aiElem-attribute" checked onchange="cfgUpdateAiConfigPreview()"> å•†å“å±æ€§
              </label>
              <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f9fafb; border-radius: 8px; font-size: 13px; cursor: pointer;">
                <input type="checkbox" id="cfg-aiElem-condition" checked onchange="cfgUpdateAiConfigPreview()"> å•†å“çŠ¶æ…‹
              </label>
              <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f9fafb; border-radius: 8px; font-size: 13px; cursor: pointer;">
                <input type="checkbox" id="cfg-aiElem-coordinate" onchange="cfgUpdateAiConfigPreview()"> ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ãƒˆææ¡ˆ
              </label>
              <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f9fafb; border-radius: 8px; font-size: 13px; cursor: pointer;">
                <input type="checkbox" id="cfg-aiElem-scene" onchange="cfgUpdateAiConfigPreview()"> ç€ç”¨ã‚·ãƒ¼ãƒ³
              </label>
            </div>
          </div>

          <!-- AIè¨­å®šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
          <div class="cfg-card">
            <div class="cfg-preview">
              <div class="cfg-preview-label">è¨­å®šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
              <div id="cfg-aiConfigPreview" class="cfg-preview-value"></div>
            </div>
            <div style="margin-top: 12px; text-align: right;">
              <button type="button" onclick="cfgClearAiSettings()" style="padding: 8px 16px; background: white; color: #ef4444; border: 2px solid #ef4444; border-radius: 8px; font-size: 12px; font-weight: 500; cursor: pointer;">
                <i class="bi bi-arrow-counterclockwise"></i> ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
              </button>
            </div>
          </div>
        </div>

        <!-- é…ç½®é †åº -->
        <div class="cfg-subtab-pane" id="cfg-product-order">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-list-ol"></i> èª¬æ˜æ–‡ã®é…ç½®é †åº</div>
            <div class="cfg-card-desc">å•†å“èª¬æ˜æ–‡ã«è¡¨ç¤ºã™ã‚‹è¦ç´ ã®é †ç•ªã¨æœ‰åŠ¹/ç„¡åŠ¹ã‚’è¨­å®šã—ã¾ã™ã€‚ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆã§ãã¾ã™ã€‚</div>
            <div style="background: #f0f9ff; border-left: 3px solid #0ea5e9; padding: 10px 12px; border-radius: 0 8px 8px 0; margin-bottom: 14px; font-size: 12px; color: #0369a1;">
              ğŸ’¡ ä¸Šä¸‹ã«ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é †ç•ªã‚’å¤‰æ›´ã€ãƒˆã‚°ãƒ«ã§æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™
            </div>
            <div id="cfg-descriptionOrderList" style="display: flex; flex-direction: column; gap: 6px;"></div>
            <div style="margin-top: 12px; text-align: right;">
              <button type="button" onclick="cfgResetDescriptionOrder()" style="padding: 8px 16px; background: white; color: #ef4444; border: 2px solid #ef4444; border-radius: 8px; font-size: 12px; font-weight: 500; cursor: pointer;">
                <i class="bi bi-arrow-counterclockwise"></i> ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
              </button>
            </div>
            <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div class="cfg-preview" style="margin-top: 16px;">
              <div class="cfg-preview-label">é…ç½®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
              <div id="cfg-descriptionOrderPreview" class="cfg-preview-value" style="white-space: pre-line;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–ãƒšã‚¤ãƒ³: ã‚·ã‚¹ãƒ†ãƒ è¨­å®š -->
    <div class="cfg-tab-pane" id="cfg-system">
      <!-- ã‚µãƒ–ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
      <div class="cfg-subtabs" id="cfg-systemConfigTabs">
        <button class="cfg-subtab active" data-target="cfg-system-basic"><i class="bi bi-person-circle"></i> åŸºæœ¬è¨­å®š</button>
        <button class="cfg-subtab" data-target="cfg-system-management"><i class="bi bi-123"></i> ç®¡ç†ç•ªå·</button>
        <button class="cfg-subtab" data-target="cfg-system-shipping"><i class="bi bi-box-seam"></i> é…é€</button>
        <button class="cfg-subtab" data-target="cfg-system-procure"><i class="bi bi-briefcase"></i> ä»•å…¥ãƒ»å‡ºå“</button>
        <button class="cfg-subtab" data-target="cfg-system-platform"><i class="bi bi-globe"></i> ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </button>
        <button class="cfg-subtab" data-target="cfg-system-users"><i class="bi bi-people"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</button>
        <button class="cfg-subtab" data-target="cfg-system-compensation"><i class="bi bi-currency-yen"></i> å ±é…¬</button>
        <button class="cfg-subtab" data-target="cfg-system-permission"><i class="bi bi-shield-lock"></i> æ¨©é™</button>
      </div>
      <!-- ã‚µãƒ–ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <div id="cfg-systemConfigTabContent" class="cfg-subtab-content">
        <!-- åŸºæœ¬è¨­å®š -->
        <div class="cfg-subtab-pane active" id="cfg-system-basic">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-person-circle"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š</div>
            <div id="cfg-basicSettingsLoading" style="text-align: center; padding: 20px;">
              <div style="font-size: 14px; color: #6b7280;">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
            <div id="cfg-basicSettingsContent" style="display: none;">
              <!-- ã‚¢ã‚¤ã‚³ãƒ³ -->
              <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                <div id="cfg-basicUserIconPreview" style="width: 56px; height: 56px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer;" onclick="document.getElementById('cfg-basicUserIconInput').click()">
                  <i class="bi bi-person-fill" style="font-size: 28px; color: #9ca3af;"></i>
                </div>
                <input type="file" id="cfg-basicUserIconInput" accept="image/*" style="display: none;">
                <div>
                  <div style="font-size: 13px; color: #6b7280;">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã‚’ã‚¿ãƒƒãƒ—ã§å¤‰æ›´</div>
                </div>
              </div>
              <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼å -->
              <div style="margin-bottom: 12px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                <div style="position: relative;">
                  <input type="text" id="cfg-basicUserName" class="form-control" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›" style="font-size: 14px; padding-right: 32px;">
                  <button id="cfg-clearUserNameBtn" type="button" style="display: none; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #9ca3af; cursor: pointer; font-size: 16px;" onclick="document.getElementById('cfg-basicUserName').value=''; this.style.display='none';">
                    <i class="bi bi-x-circle-fill"></i>
                  </button>
                </div>
              </div>
              <!-- ãƒ¡ãƒ¼ãƒ« -->
              <div style="margin-bottom: 12px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                <input type="email" id="cfg-basicUserEmail" class="form-control" disabled style="font-size: 14px; background: #f9fafb; color: #6b7280;">
              </div>
              <!-- æ¨©é™ãƒãƒƒã‚¸ -->
              <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">æ¨©é™</label>
                <span id="cfg-basicUserPermissionBadge"></span>
              </div>
              <!-- é€šçŸ¥è¨­å®š -->
              <div style="border-top: 1px solid #e5e7eb; padding-top: 12px;">
                <div style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 10px;">é€šçŸ¥è¨­å®š</div>
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                  <label for="cfg-basicNotificationEnabled" style="font-size: 13px; cursor: pointer;">ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹</label>
                  <label class="cfg-toggle-switch">
                    <input type="checkbox" id="cfg-basicNotificationEnabled" checked>
                    <span class="cfg-toggle-slider"></span>
                  </label>
                </div>
                <div style="display: flex; align-items: center; justify-content: space-between;">
                  <label for="cfg-basicNotificationSound" style="font-size: 13px; cursor: pointer;">é€šçŸ¥éŸ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹</label>
                  <label class="cfg-toggle-switch">
                    <input type="checkbox" id="cfg-basicNotificationSound" checked>
                    <span class="cfg-toggle-slider"></span>
                  </label>
                </div>
              </div>
            </div>
          </div>
          <!-- ç™ºé€å…ˆæƒ…å ± -->
          <div class="cfg-card" style="margin-top: 12px;" id="cfg-shippingInfoSection">
            <div class="cfg-card-title"><i class="bi bi-geo-alt"></i> ç™ºé€å…ˆæƒ…å ±</div>
            <div id="cfg-shippingInfoStatus" style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">æœªç™»éŒ²</div>
            <button type="button" onclick="cfgOpenShippingInfoModal()" style="width: 100%; padding: 10px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px; cursor: pointer;">
              <i class="bi bi-pencil"></i> ç™ºé€å…ˆæƒ…å ±ã‚’ç·¨é›†
            </button>
          </div>
          <!-- å£åº§æƒ…å ± -->
          <div class="cfg-card" style="margin-top: 12px;" id="cfg-bankAccountSection">
            <div class="cfg-card-title"><i class="bi bi-bank"></i> å£åº§æƒ…å ±</div>
            <div id="cfg-bankAccountStatus" style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">æœªç™»éŒ²</div>
            <button type="button" onclick="cfgOpenBankAccountModal()" style="width: 100%; padding: 10px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px; cursor: pointer;">
              <i class="bi bi-pencil"></i> å£åº§æƒ…å ±ã‚’ç·¨é›†
            </button>
          </div>
        </div>

        <!-- ç®¡ç†ç•ªå·è¨­å®šï¼ˆæ—§ç‰ˆManagementNumberBuilderç§»æ¤ï¼‰ -->
        <div class="cfg-subtab-pane" id="cfg-system-management">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-123"></i> ç®¡ç†ç•ªå·è¨­å®š</div>
            <div class="cfg-card-desc">ç®¡ç†ç•ªå·ã®è‡ªå‹•ç”Ÿæˆãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¾ã™</div>

            <div class="mnb-container" id="cfg-mnbContainer">
              <input type="hidden" id="cfg-mnbPresetSelect" value="">

              <!-- ç¾åœ¨ã®è¨­å®šè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
              <div id="cfg-mnbFormatDisplay" style="margin-bottom: 16px;">
                <!-- è¨­å®šãŒãªã„å ´åˆ -->
                <div id="cfg-mnbNoSettingsMessage" style="padding: 24px; text-align: center; background: #f9fafb; border: 2px dashed #d1d5db; border-radius: 12px;">
                  <div style="font-size: 32px; margin-bottom: 8px;"><i class="bi bi-clipboard"></i></div>
                  <div style="font-size: 14px; color: #6b7280; margin-bottom: 12px;">ç®¡ç†ç•ªå·ã®è¨­å®šãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</div>
                  <div style="font-size: 12px; color: #9ca3af;">ä¸‹ã®ã€Œãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é¸æŠã€ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„</div>
                </div>

                <!-- è¨­å®šãŒã‚ã‚‹å ´åˆ -->
                <div id="cfg-mnbCurrentSettings" style="display: none;">
                  <div style="padding: 16px; background: white; border: 1px solid #e5e7eb; border-radius: 8px;">
                    <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin: 0 0 12px 0;"><i class="bi bi-file-text"></i> ç®¡ç†ç•ªå·ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</h4>

                    <div style="padding: 16px; background: #f9fafb; border-radius: 8px; text-align: center; border: 1px solid #e5e7eb; margin-bottom: 12px;">
                      <div id="cfg-mnbCurrentPresetName" style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;"><i class="bi bi-box-seam" style="margin-right: 4px;"></i>æ£šç•ªå· + é€£ç•ª</div>
                      <div style="border-top: 1px solid #e5e7eb; margin: 8px 0; padding-top: 8px;">
                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">ç”Ÿæˆã•ã‚Œã‚‹ç®¡ç†ç•ªå·ã®ä¾‹</div>
                        <div id="cfg-mnbCurrentPreview" style="font-family: monospace; font-size: 24px; color: #374151; font-weight: 700; letter-spacing: 1px;">AA-001</div>
                      </div>
                    </div>

                    <!-- ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé¸æŠã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ -->
                    <div class="mnb-accordion-header" id="cfg-mnbPresetHeader" onclick="cfgToggleMnbAccordion('preset')" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; background: #eff6ff; color: #1d4ed8; border: 1px solid #3b82f6; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <i class="bi bi-pencil" style="font-size: 16px;"></i>
                        <span style="font-size: 13px; font-weight: 600; color: #1d4ed8;">ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é¸æŠãƒ»ç·¨é›†</span>
                      </div>
                      <span id="cfg-mnbPresetArrow" style="font-size: 16px; font-weight: bold; color: #3b82f6; transition: transform 0.3s;">+</span>
                    </div>
                    <div id="cfg-mnbPresetContent" style="display: none; padding: 12px 0 0 0;">
                      <div id="cfg-mnbPresetCards" style="display: flex; flex-direction: column; gap: 10px;">
                        <!-- ã‚·ãƒ³ãƒ—ãƒ«é€£ç•ª -->
                        <div class="mnb-preset-card" data-preset="simple" onclick="cfgSelectPresetCard('simple')" style="padding: 14px; background: white; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer;">
                          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <i class="bi bi-123" style="font-size: 20px; color: #374151;"></i>
                            <span style="font-size: 14px; font-weight: 600; color: #1f2937;">ã‚·ãƒ³ãƒ—ãƒ«é€£ç•ª</span>
                          </div>
                          <div style="background: #f1f5f9; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px;">
                            <span style="font-family: monospace; font-size: 15px; color: #3b82f6; font-weight: 600;">001 â†’ 002 â†’ 003</span>
                          </div>
                          <div style="font-size: 11px; color: #64748b; line-height: 1.4;">ã‚·ãƒ³ãƒ—ãƒ«ã«ç•ªå·ã ã‘ã§ç®¡ç†ã€‚å°‘é‡ã®å•†å“ã‚’æ‰±ã†æ–¹ã‚„ã€åˆã‚ã¦ã®æ–¹å‘ã‘</div>
                        </div>

                        <!-- æ£šç•ªå· + é€£ç•ªï¼ˆãŠã™ã™ã‚ï¼‰ -->
                        <div class="mnb-preset-card" data-preset="shelf" onclick="cfgSelectPresetCard('shelf')" style="padding: 14px; background: white; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer;">
                          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <i class="bi bi-box-seam" style="font-size: 20px; color: #374151;"></i>
                            <span style="font-size: 14px; font-weight: 600; color: #1f2937;">æ£šç•ªå· + é€£ç•ª</span>
                            <span style="background: linear-gradient(90deg, #f59e0b, #f97316); color: white; font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 4px; white-space: nowrap;"><i class="bi bi-star-fill" style="font-size: 8px;"></i> ãŠã™ã™ã‚</span>
                          </div>
                          <div style="background: #f1f5f9; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px;">
                            <span style="font-family: monospace; font-size: 15px; color: #3b82f6; font-weight: 600;">AA-001, AB-001, BA-001</span>
                          </div>
                          <div style="font-size: 11px; color: #64748b; line-height: 1.4;">åç´å ´æ‰€ï¼ˆæ£šãƒ»ãƒ©ãƒƒã‚¯ï¼‰ã”ã¨ã«åˆ†é¡ã€‚åœ¨åº«ã®å ´æ‰€ãŒã™ãã‚ã‹ã‚‹</div>
                        </div>

                        <!-- ã‚«ãƒ†ã‚´ãƒª + æ—¥ä»˜ + é€£ç•ª -->
                        <div class="mnb-preset-card" data-preset="category_date" onclick="cfgSelectPresetCard('category_date')" style="padding: 14px; background: white; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer;">
                          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <i class="bi bi-calendar-date" style="font-size: 20px; color: #374151;"></i>
                            <span style="font-size: 14px; font-weight: 600; color: #1f2937;">ã‚«ãƒ†ã‚´ãƒª + æ—¥ä»˜ + é€£ç•ª</span>
                          </div>
                          <div style="background: #f1f5f9; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px;">
                            <span style="font-family: monospace; font-size: 15px; color: #3b82f6; font-weight: 600;">T-260101-001, B-260101-002</span>
                          </div>
                          <div style="font-size: 11px; color: #64748b; line-height: 1.4;">å•†å“ã‚«ãƒ†ã‚´ãƒªã¨ç™»éŒ²æ—¥ã§åˆ†é¡ã€‚ã„ã¤ãƒ»ä½•ã‚’ç™»éŒ²ã—ãŸã‹ä¸€ç›®ç­ç„¶</div>
                        </div>

                        <!-- æ£šç•ªå· + æ—¥ä»˜ + é€£ç•ª -->
                        <div class="mnb-preset-card" data-preset="shelf_date" onclick="cfgSelectPresetCard('shelf_date')" style="padding: 14px; background: white; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer;">
                          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <i class="bi bi-calendar" style="font-size: 20px; color: #374151;"></i>
                            <span style="font-size: 14px; font-weight: 600; color: #1f2937;">æ£šç•ªå· + æ—¥ä»˜ + é€£ç•ª</span>
                          </div>
                          <div style="background: #f1f5f9; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px;">
                            <span style="font-family: monospace; font-size: 15px; color: #3b82f6; font-weight: 600;">AA-260101-001, AB-260101-002</span>
                          </div>
                          <div style="font-size: 11px; color: #64748b; line-height: 1.4;">åç´å ´æ‰€ã¨ç™»éŒ²æ—¥ã®ä¸¡æ–¹ã§ç®¡ç†ã€‚å¤§é‡ã®åœ¨åº«ã‚’æ‰±ã†æ–¹å‘ã‘</div>
                        </div>

                        <!-- ã‚«ãƒ†ã‚´ãƒª + ãƒ©ãƒ³ã‚¯ + é€£ç•ª -->
                        <div class="mnb-preset-card" data-preset="category_rank" onclick="cfgSelectPresetCard('category_rank')" style="padding: 14px; background: white; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer;">
                          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <i class="bi bi-star" style="font-size: 20px; color: #374151;"></i>
                            <span style="font-size: 14px; font-weight: 600; color: #1f2937;">ã‚«ãƒ†ã‚´ãƒª + ãƒ©ãƒ³ã‚¯ + é€£ç•ª</span>
                          </div>
                          <div style="background: #f1f5f9; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px;">
                            <span style="font-family: monospace; font-size: 15px; color: #3b82f6; font-weight: 600;">T-S-001, B-A-002, O-B-003</span>
                          </div>
                          <div style="font-size: 11px; color: #64748b; line-height: 1.4;">ã‚«ãƒ†ã‚´ãƒªã¨å•†å“ãƒ©ãƒ³ã‚¯ï¼ˆS/A/B/Cï¼‰ã§åˆ†é¡ã€‚ä¾¡å€¤åˆ¥ã®ç®¡ç†ã«æœ€é©</div>
                        </div>

                        <!-- ã‚«ã‚¹ã‚¿ãƒ è¨­å®š -->
                        <div class="mnb-preset-card" data-preset="custom" onclick="cfgSelectPresetCard('custom')" style="padding: 14px; background: white; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer;">
                          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <i class="bi bi-tools" style="font-size: 20px; color: #374151;"></i>
                            <span style="font-size: 14px; font-weight: 600; color: #1f2937;">ã‚«ã‚¹ã‚¿ãƒ è¨­å®š</span>
                          </div>
                          <div style="background: #f1f5f9; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px;">
                            <span style="font-family: monospace; font-size: 15px; color: #3b82f6; font-weight: 600;">è‡ªç”±ã«çµ„ã¿åˆã‚ã›</span>
                          </div>
                          <div style="font-size: 11px; color: #64748b; line-height: 1.4;">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è‡ªç”±ã«è¿½åŠ ãƒ»ç·¨é›†ã€‚ç‹¬è‡ªã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ä½œæˆ</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ç®¡ç†ç•ªå·ã®è¡¨ç¤ºå½¢å¼ -->
              <div style="margin-top: 16px; padding: 16px; background: white; border: 1px solid #e5e7eb; border-radius: 8px;">
                <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">
                  <i class="bi bi-palette"></i> ç®¡ç†ç•ªå·ã®è¡¨ç¤ºå½¢å¼
                </div>
                <div style="font-size: 12px; color: #6b7280; margin-bottom: 12px; line-height: 1.5;">ç®¡ç†ç•ªå·ã‚’å›²ã‚€è¨˜å·ã‚’é¸æŠã§ãã¾ã™</div>

                <!-- å•†å“åã§ã®è¡¨ç¤ºå½¢å¼ -->
                <div style="margin-bottom: 16px;">
                  <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">å•†å“åã§ã®è¡¨ç¤ºå½¢å¼</label>
                  <select id="cfg-mnb-titleFormat" class="form-control" style="font-size: 16px; margin-bottom: 8px;" onchange="cfgUpdateMnbFormatPreview()">
                    <option value="ã€ã€‘">ã€AA-1001ã€‘</option>
                    <option value="ï¼ˆï¼‰">ï¼ˆAA-1001ï¼‰</option>
                    <option value="ã€ã€">ã€AA-1001ã€</option>
                    <option value="ã€Œã€">ã€ŒAA-1001ã€</option>
                    <option value="none">AA-1001</option>
                  </select>
                  <div class="cfg-preview" style="margin-top: 8px;">
                    <div class="cfg-preview-label">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
                    <div id="cfg-mnb-titleFormatPreview" class="cfg-preview-value">UNIQLO ã‚¦ãƒ«ãƒˆãƒ©ãƒ©ã‚¤ãƒˆãƒ€ã‚¦ãƒ³ã€AA-1001ã€‘</div>
                  </div>
                </div>

                <!-- èª¬æ˜æ–‡ã§ã®è¡¨ç¤ºå½¢å¼ -->
                <div>
                  <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">èª¬æ˜æ–‡ã§ã®è¡¨ç¤ºå½¢å¼</label>
                  <select id="cfg-mnb-descFormat" class="form-control" style="font-size: 16px; margin-bottom: 8px;" onchange="cfgUpdateMnbFormatPreview()">
                    <option value="ã€ã€‘">ã€AA-1001ã€‘</option>
                    <option value="ï¼ˆï¼‰">ï¼ˆAA-1001ï¼‰</option>
                    <option value="ã€ã€">ã€AA-1001ã€</option>
                    <option value="ã€Œã€">ã€ŒAA-1001ã€</option>
                    <option value="none">AA-1001</option>
                  </select>
                  <div class="cfg-preview" style="margin-top: 8px;">
                    <div class="cfg-preview-label">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
                    <div id="cfg-mnb-descFormatPreview" class="cfg-preview-value">ç®¡ç†ç•ªå·ï¼šã€AA-1001ã€‘</div>
                  </div>
                </div>
              </div>

              <!-- ç®¡ç†ç•ªå·ã®é…ç½®è¨­å®š -->
              <div style="margin-top: 16px; padding: 16px; background: white; border: 1px solid #e5e7eb; border-radius: 8px;">
                <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">
                  <i class="bi bi-geo-alt"></i> ç®¡ç†ç•ªå·ã®é…ç½®
                </div>
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px;">
                  <div style="display: flex; align-items: center; gap: 6px;">
                    <input type="checkbox" id="cfg-mnb-showInTitle" style="width: 16px; height: 16px; cursor: pointer;">
                    <label for="cfg-mnb-showInTitle" style="font-size: 13px; cursor: pointer; margin: 0;">å•†å“åã«è¡¨ç¤º</label>
                  </div>
                  <div style="display: flex; align-items: center; gap: 6px;">
                    <input type="checkbox" id="cfg-mnb-showInDescription" style="width: 16px; height: 16px; cursor: pointer;">
                    <label for="cfg-mnb-showInDescription" style="font-size: 13px; cursor: pointer; margin: 0;">èª¬æ˜æ–‡ã«è¡¨ç¤º</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- é…é€è¨­å®š -->
        <div class="cfg-subtab-pane" id="cfg-system-shipping">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-truck"></i> é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š</div>
            <div class="cfg-card-desc">å•†å“ç™»éŒ²æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé…é€è¨­å®šã‚’è¨­å®šã—ã¾ã™</div>
            <div style="background: #f0f9ff; border-left: 3px solid #0ea5e9; padding: 10px 12px; border-radius: 0 8px 8px 0; margin-bottom: 14px; font-size: 12px; color: #0369a1;">
              ğŸ’¡ å•†å“ç™»éŒ²æ™‚ã«è‡ªå‹•é¸æŠã•ã‚Œã‚‹é…é€ã®åˆæœŸå€¤ã‚’è¨­å®šã—ã¾ã™
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">é…é€æ–™ã®è² æ‹…</label>
                <select id="cfg-é…é€æ–™ã®è² æ‹…" class="form-control">
                  <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">é…é€ã®æ–¹æ³•</label>
                <select id="cfg-é…é€ã®æ–¹æ³•" class="form-control">
                  <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">ç™ºé€å…ƒã®åœ°åŸŸ</label>
                <select id="cfg-ç™ºé€å…ƒã®åœ°åŸŸ" class="form-control">
                  <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">ç™ºé€ã¾ã§ã®æ—¥æ•°</label>
                <select id="cfg-ç™ºé€ã¾ã§ã®æ—¥æ•°" class="form-control">
                  <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
              </div>
            </div>
            <div style="margin-top: 14px; text-align: right;">
              <button type="button" onclick="cfgClearShippingDefaults()" style="padding: 8px 16px; background: white; color: #ef4444; border: 2px solid #ef4444; border-radius: 8px; font-size: 12px; font-weight: 500; cursor: pointer;">
                <i class="bi bi-trash"></i> ã‚¯ãƒªã‚¢
              </button>
            </div>
          </div>
        </div>

        <!-- ä»•å…¥ãƒ»å‡ºå“è¨­å®š -->
        <div class="cfg-subtab-pane" id="cfg-system-procure">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-cart"></i> ä»•å…¥ãƒ»å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š</div>
            <div class="cfg-card-desc">å•†å“ç™»éŒ²æ™‚ã®ä»•å…¥ãƒ»å‡ºå“ã«é–¢ã™ã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šã—ã¾ã™</div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">ä»•å…¥å…ˆ</label>
                <select id="cfg-ä»•å…¥å…ˆ" class="form-control">
                  <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">ä»•å…¥æ—¥</label>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; cursor: pointer;">
                    <input type="radio" name="cfg-procureDateMode" value="today" checked onchange="cfgToggleProcureDateField(this.value)"> ä»Šæ—¥ã®æ—¥ä»˜
                  </label>
                  <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; cursor: pointer;">
                    <input type="radio" name="cfg-procureDateMode" value="fixed" onchange="cfgToggleProcureDateField(this.value)"> å›ºå®šæ—¥ä»˜
                  </label>
                </div>
                <input type="date" id="cfg-ä»•å…¥æ—¥" class="form-control" style="display: none; margin-top: 6px;">
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">å‡ºå“å…ˆ</label>
                <select id="cfg-å‡ºå“å…ˆ" class="form-control">
                  <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">å‡ºå“æ—¥</label>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; cursor: pointer;">
                    <input type="radio" name="cfg-listingDateMode" value="today" checked onchange="cfgToggleListingDateField(this.value)"> ä»Šæ—¥ã®æ—¥ä»˜
                  </label>
                  <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; cursor: pointer;">
                    <input type="radio" name="cfg-listingDateMode" value="fixed" onchange="cfgToggleListingDateField(this.value)"> å›ºå®šæ—¥ä»˜
                  </label>
                </div>
                <input type="date" id="cfg-å‡ºå“æ—¥" class="form-control" style="display: none; margin-top: 6px;">
              </div>
            </div>
            <div style="margin-top: 14px; text-align: right;">
              <button type="button" onclick="cfgClearProcureListingDefaults()" style="padding: 8px 16px; background: white; color: #ef4444; border: 2px solid #ef4444; border-radius: 8px; font-size: 12px; font-weight: 500; cursor: pointer;">
                <i class="bi bi-trash"></i> ã‚¯ãƒªã‚¢
              </button>
            </div>
          </div>
        </div>

        <!-- ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š -->
        <div class="cfg-subtab-pane" id="cfg-system-platform">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-grid"></i> ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š</div>
            <div class="cfg-card-desc">å‡ºå“å…ˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’è¨­å®šã—ã¾ã™</div>
            <!-- ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ -->
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰</label>
              <div style="display: flex; gap: 8px;">
                <label onclick="cfgSelectRegistrationMode('individual')" style="flex: 1; padding: 10px; border: 2px solid #40B4E5; border-radius: 8px; text-align: center; cursor: pointer; font-size: 13px; font-weight: 600; color: #374151; background: #f0f9ff;">
                  <input type="radio" name="cfg-registrationMode" id="cfg-modeIndividual" value="individual" checked style="display: none;">
                  å€‹åˆ¥ç™»éŒ²
                </label>
                <label onclick="cfgSelectRegistrationMode('batch')" style="flex: 1; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; text-align: center; cursor: pointer; font-size: 13px; font-weight: 600; color: #374151;">
                  <input type="radio" name="cfg-registrationMode" id="cfg-modeBatch" value="batch" style="display: none;">
                  ä¸€æ‹¬ç™»éŒ²
                </label>
              </div>
            </div>
            <!-- ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ä¸€è¦§ -->
            <div id="cfg-enabledPlatformsList"></div>
            <button type="button" onclick="cfgOpenPlatformSelectModal()" style="margin-top: 12px; padding: 10px; width: 100%; background: #f3f4f6; color: #374151; border: 2px dashed #d1d5db; border-radius: 8px; font-size: 13px; cursor: pointer;">
              <i class="bi bi-plus-lg"></i> ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’è¿½åŠ 
            </button>
          </div>
        </div>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† -->
        <div class="cfg-subtab-pane" id="cfg-system-users">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-people"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</div>
            <div id="cfg-userManagementLoading" style="text-align: center; padding: 40px;">
              <div style="font-size: 14px; color: #6b7280;">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
            <div id="cfg-userManagementContent" style="display: none;">
              <!-- æ¤œç´¢ -->
              <div style="margin-bottom: 12px;">
                <input type="text" id="cfg-userSearchInput" oninput="cfgFilterUserList()" class="form-control" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ»ãƒ¡ãƒ¼ãƒ«ã§æ¤œç´¢..." style="font-size: 13px;">
              </div>
              <!-- æ‰¿èªå¾…ã¡ -->
              <div id="cfg-pendingSection" style="display: none; margin-bottom: 16px;">
                <div onclick="cfgToggleSection('pending')" style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #fff7ed; border-radius: 8px; cursor: pointer; margin-bottom: 8px;">
                  <span style="font-size: 13px; font-weight: 600; color: #c2410c;">æ‰¿èªå¾…ã¡</span>
                  <span id="cfg-pendingUsersCount" style="background: #ef4444; color: white; font-size: 11px; padding: 2px 8px; border-radius: 10px;">0</span>
                  <span id="cfg-pendingToggle" style="margin-left: auto; font-size: 10px; color: #6b7280;">â–¼</span>
                </div>
                <div id="cfg-pendingUsersList"></div>
              </div>
              <!-- æ¨©é™ã‚°ãƒ«ãƒ¼ãƒ— -->
              <div id="cfg-permissionGroups"></div>
              <!-- ç„¡åŠ¹ãƒ¦ãƒ¼ã‚¶ãƒ¼ -->
              <div id="cfg-inactiveSection" style="display: none; margin-top: 16px;">
                <div onclick="cfgToggleSection('inactive')" style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #f3f4f6; border-radius: 8px; cursor: pointer; margin-bottom: 8px;">
                  <span style="font-size: 13px; font-weight: 600; color: #6b7280;">ç„¡åŠ¹ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
                  <span id="cfg-inactiveUsersCount" style="background: #6b7280; color: white; font-size: 11px; padding: 2px 8px; border-radius: 10px;">0</span>
                  <span id="cfg-inactiveToggle" style="margin-left: auto; font-size: 10px; color: #6b7280;">â–¶</span>
                </div>
                <div id="cfg-inactiveUsersList" style="display: none;"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- å ±é…¬è¨­å®š -->
        <div class="cfg-subtab-pane" id="cfg-system-compensation">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-currency-yen"></i> ã‚¿ã‚¹ã‚¯åˆ¥å ±é…¬å˜ä¾¡</div>
            <div class="cfg-card-desc">å„ã‚¿ã‚¹ã‚¯ã®1ä»¶ã‚ãŸã‚Šã®å ±é…¬å˜ä¾¡ã‚’è¨­å®šã—ã¾ã™</div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                <div style="width: 40px; height: 40px; background: #dbeafe; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ“¦</div>
                <div style="flex: 1; font-size: 14px; font-weight: 500; color: #374151;">å•†å“å‡ºå“</div>
                <div style="display: flex; align-items: center; gap: 4px;">
                  <span style="font-size: 14px; color: #6b7280;">Â¥</span>
                  <input type="number" id="cfg-compensation-listing" value="100" min="0" step="10" style="width: 80px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; text-align: right;">
                  <span style="font-size: 12px; color: #6b7280;">/ä»¶</span>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                <div style="width: 40px; height: 40px; background: #fef3c7; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸšš</div>
                <div style="flex: 1; font-size: 14px; font-weight: 500; color: #374151;">æ¢±åŒ…ãƒ»ç™ºé€</div>
                <div style="display: flex; align-items: center; gap: 4px;">
                  <span style="font-size: 14px; color: #6b7280;">Â¥</span>
                  <input type="number" id="cfg-compensation-shipping" value="100" min="0" step="10" style="width: 80px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; text-align: right;">
                  <span style="font-size: 12px; color: #6b7280;">/ä»¶</span>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                <div style="width: 40px; height: 40px; background: #d1fae5; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ“¸</div>
                <div style="flex: 1; font-size: 14px; font-weight: 500; color: #374151;">å•†å“æ’®å½±</div>
                <div style="display: flex; align-items: center; gap: 4px;">
                  <span style="font-size: 14px; color: #6b7280;">Â¥</span>
                  <input type="number" id="cfg-compensation-photography" value="50" min="0" step="10" style="width: 80px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; text-align: right;">
                  <span style="font-size: 12px; color: #6b7280;">/ä»¶</span>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                <div style="width: 40px; height: 40px; background: #fce7f3; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ”</div>
                <div style="flex: 1; font-size: 14px; font-weight: 500; color: #374151;">æ¤œå“ä½œæ¥­</div>
                <div style="display: flex; align-items: center; gap: 4px;">
                  <span style="font-size: 14px; color: #6b7280;">Â¥</span>
                  <input type="number" id="cfg-compensation-inspection" value="30" min="0" step="10" style="width: 80px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; text-align: right;">
                  <span style="font-size: 12px; color: #6b7280;">/ä»¶</span>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                <div style="width: 40px; height: 40px; background: #ede9fe; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ“‹</div>
                <div style="flex: 1; font-size: 14px; font-weight: 500; color: #374151;">æ£šå¸</div>
                <div style="display: flex; align-items: center; gap: 4px;">
                  <span style="font-size: 14px; color: #6b7280;">Â¥</span>
                  <input type="number" id="cfg-compensation-stocktaking" value="20" min="0" step="10" style="width: 80px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; text-align: right;">
                  <span style="font-size: 12px; color: #6b7280;">/ä»¶</span>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                <div style="width: 40px; height: 40px; background: #fef3c7; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">âœï¸</div>
                <div style="flex: 1; font-size: 14px; font-weight: 500; color: #374151;">è¿½åŠ ç·¨é›†</div>
                <div style="display: flex; align-items: center; gap: 4px;">
                  <span style="font-size: 14px; color: #6b7280;">Â¥</span>
                  <input type="number" id="cfg-compensation-editing" value="50" min="0" step="10" style="width: 80px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; text-align: right;">
                  <span style="font-size: 12px; color: #6b7280;">/ä»¶</span>
                </div>
              </div>
            </div>
            <!-- ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¹ã‚¯ -->
            <div id="cfg-customCompensationTasks" style="display: none; margin-top: 12px;">
              <div style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¹ã‚¯</div>
              <div id="cfg-customTasksContainer"></div>
            </div>
            <button type="button" onclick="cfgAddCustomCompensationTask()" style="margin-top: 12px; padding: 10px; width: 100%; background: #f3f4f6; color: #374151; border: 2px dashed #d1d5db; border-radius: 8px; font-size: 13px; cursor: pointer;">
              <i class="bi bi-plus-lg"></i> ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
            </button>
          </div>

          <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®š -->
          <div class="cfg-card" style="margin-top: 12px;">
            <div class="cfg-card-title">ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®š</div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                <span style="font-size: 13px; color: #374151;">å‡ºå“æ™‚ã«è‡ªå‹•è¨˜éŒ²</span>
                <label class="cfg-toggle"><input type="checkbox" id="cfg-autoRecordListing" checked><span class="slider"></span></label>
              </label>
              <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                <span style="font-size: 13px; color: #374151;">ç™ºé€æ™‚ã«è‡ªå‹•è¨˜éŒ²</span>
                <label class="cfg-toggle"><input type="checkbox" id="cfg-autoRecordShipping" checked><span class="slider"></span></label>
              </label>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">ç· ã‚æ—¥</label>
                <select id="cfg-compensationCutoffDay" class="form-control">
                  <option value="æœ«æ—¥">æœ«æ—¥</option>
                  <option value="15æ—¥">15æ—¥</option>
                  <option value="20æ—¥">20æ—¥</option>
                  <option value="25æ—¥">25æ—¥</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">æ”¯æ‰•æ—¥</label>
                <select id="cfg-compensationPaymentDay" class="form-control">
                  <option value="ç¿Œæœˆ5æ—¥">ç¿Œæœˆ5æ—¥</option>
                  <option value="ç¿Œæœˆ10æ—¥">ç¿Œæœˆ10æ—¥</option>
                  <option value="ç¿Œæœˆ15æ—¥">ç¿Œæœˆ15æ—¥</option>
                  <option value="ç¿Œæœˆ20æ—¥">ç¿Œæœˆ20æ—¥</option>
                  <option value="ç¿Œæœˆ25æ—¥">ç¿Œæœˆ25æ—¥</option>
                  <option value="ç¿Œæœˆæœ«æ—¥">ç¿Œæœˆæœ«æ—¥</option>
                </select>
              </div>
              <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                <span style="font-size: 13px; color: #374151;">çµŒè²»ã¨ã—ã¦è¨˜éŒ²</span>
                <label class="cfg-toggle"><input type="checkbox" id="cfg-recordAsExpense" checked><span class="slider"></span></label>
              </label>
            </div>
          </div>

          <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚¿ã‚¹ã‚¯æ‹…å½“è¨­å®š -->
          <div class="cfg-card" style="margin-top: 12px;">
            <div class="cfg-card-title"><i class="bi bi-person-check"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚¿ã‚¹ã‚¯æ‹…å½“</div>
            <div class="cfg-card-desc">å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ‹…å½“ã‚¿ã‚¹ã‚¯ã‚’å‰²ã‚Šå½“ã¦ã¾ã™</div>
            <button type="button" onclick="cfgAssignAllTasksToAll()" style="margin-bottom: 12px; padding: 8px 16px; background: #eff6ff; color: #1d4ed8; border: 1px solid #bfdbfe; border-radius: 6px; font-size: 12px; cursor: pointer;">å…¨å“¡ã«å…¨ã‚¿ã‚¹ã‚¯ã‚’å‰²ã‚Šå½“ã¦</button>
            <div id="cfg-userTaskAssignmentList" style="display: flex; flex-direction: column; gap: 8px;"></div>
          </div>

          <!-- å ±é…¬ç®¡ç†ã¸ã®ãƒªãƒ³ã‚¯ -->
          <div class="cfg-card" style="margin-top: 12px;">
            <button type="button" onclick="cfgOpenCompensationManagement()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #40B4E5 0%, #2196F3 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
              <i class="bi bi-arrow-right-circle"></i> å ±é…¬ç®¡ç†ç”»é¢ã‚’é–‹ã
            </button>
          </div>
        </div>

        <!-- æ¨©é™è¨­å®š -->
        <div class="cfg-subtab-pane" id="cfg-system-permission">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-shield-lock"></i> æ¨©é™è¨­å®š</div>
            <div class="cfg-card-desc">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ã¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’è¨­å®šã—ã¾ã™</div>
            <div id="cfg-permissionSettingsLoading" style="text-align: center; padding: 40px;">
              <div style="font-size: 14px; color: #6b7280;">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
            <div id="cfg-permissionSettingsContent" style="display: none;">
              <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ -->
              <div style="margin-bottom: 20px;">
                <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™</div>
                <div id="cfg-userPermissionList" style="display: flex; flex-direction: column; gap: 8px;"></div>
              </div>
              <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºæ¨©é™ -->
              <div>
                <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºæ¨©é™</div>
                <div id="cfg-menuPermissionList"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
  <div class="cfg-save-footer">
    <button class="cfg-save-btn" onclick="cfgSaveConfig()">
      <i class="bi bi-check-lg"></i> è¨­å®šã‚’ä¿å­˜
    </button>
  </div>

  <!-- ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="cfg-modal-overlay" id="cfg-platformSelectModal">
    <div class="cfg-modal-content">
      <div class="cfg-modal-header">
        <h3>ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’è¿½åŠ </h3>
        <button class="cfg-modal-close" onclick="cfgClosePlatformSelectModal()">&times;</button>
      </div>
      <div class="cfg-modal-body">
        <div id="cfg-platformSelectList"></div>
      </div>
    </div>
  </div>

  <!-- ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="cfg-modal-overlay" id="cfg-platformEditModal">
    <div class="cfg-modal-content">
      <div class="cfg-modal-header">
        <h3>ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’ç·¨é›†</h3>
        <button class="cfg-modal-close" onclick="cfgClosePlatformEditModal()">&times;</button>
      </div>
      <div class="cfg-modal-body">
        <input type="hidden" id="cfg-editPlatformId">
        <div style="margin-bottom: 12px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">è¡¨ç¤ºå</label>
          <input type="text" id="cfg-editPlatformName" class="form-control" placeholder="ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å">
        </div>
        <div style="margin-bottom: 12px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">èª¬æ˜</label>
          <input type="text" id="cfg-editPlatformDesc" class="form-control" placeholder="ç°¡å˜ãªèª¬æ˜">
        </div>
        <div style="margin-bottom: 12px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">ã‚¢ã‚¤ã‚³ãƒ³</label>
          <div style="display: flex; align-items: center; gap: 12px;">
            <div id="cfg-platformIconPreview" style="width: 48px; height: 48px; border-radius: 8px; border: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; overflow: hidden;">
              <span style="color: #9ca3af; font-size: 12px;">æœªè¨­å®š</span>
            </div>
            <div style="flex: 1;">
              <input type="file" id="cfg-platformIconInput" accept="image/*" onchange="cfgPreviewPlatformIcon(event)" style="font-size: 12px;">
              <div id="cfg-platformIconUploadStatus" style="font-size: 11px; margin-top: 4px;"></div>
            </div>
          </div>
        </div>
        <div style="display: flex; gap: 8px; margin-top: 16px;">
          <button type="button" onclick="cfgClosePlatformEditModal()" class="cfg-btn-secondary" style="flex: 1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" onclick="cfgSavePlatformEdit()" class="cfg-btn-primary" style="flex: 1;">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç™ºé€å…ˆæƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="cfg-modal-overlay" id="cfg-shippingInfoModal">
    <div class="cfg-modal-content">
      <div class="cfg-modal-header">
        <h3>ç™ºé€å…ˆæƒ…å ±ã‚’å…¥åŠ›</h3>
        <button class="cfg-modal-close" onclick="cfgCloseShippingInfoModal()">&times;</button>
      </div>
      <div class="cfg-modal-body">
        <div style="display: flex; gap: 8px; margin-bottom: 16px;">
          <div style="flex: 1;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">å§“<span style="color: #ef4444;">*</span></label>
            <input type="text" id="cfg-shippingLastName" class="form-control" placeholder="å±±ç”°" maxlength="20">
          </div>
          <div style="flex: 1;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">å<span style="color: #ef4444;">*</span></label>
            <input type="text" id="cfg-shippingFirstName" class="form-control" placeholder="å¤ªéƒ" maxlength="20">
          </div>
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">éƒµä¾¿ç•ªå·<span style="color: #ef4444;">*</span></label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <span style="font-size: 13px; color: #6b7280;">ã€’</span>
            <input type="text" id="cfg-shippingPostalCode" class="form-control" placeholder="000-0000" maxlength="8" style="width: 120px;" oninput="cfgFormatPostalCode(this)">
            <button type="button" onclick="cfgSearchShippingAddress()" style="background: #e5e7eb; color: #374151; border: none; padding: 6px 10px; border-radius: 6px; font-size: 11px; white-space: nowrap; cursor: pointer;">ä½æ‰€æ¤œç´¢</button>
          </div>
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">éƒ½é“åºœçœŒ<span style="color: #ef4444;">*</span></label>
          <input type="text" id="cfg-shippingPrefecture" class="form-control" placeholder="æ±äº¬éƒ½" maxlength="10">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">å¸‚åŒºç”ºæ‘ãƒ»ç•ªåœ°<span style="color: #ef4444;">*</span></label>
          <input type="text" id="cfg-shippingCity" class="form-control" placeholder="æ¸‹è°·åŒºæ¸‹è°·1-2-3" maxlength="100">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">å»ºç‰©åãƒ»éƒ¨å±‹ç•ªå·</label>
          <input type="text" id="cfg-shippingBuilding" class="form-control" placeholder="ãƒ•ãƒªãƒ©ãƒ“ãƒ«101å·å®¤ï¼ˆä»»æ„ï¼‰" maxlength="100">
        </div>
        <div style="display: flex; gap: 8px;">
          <button type="button" onclick="cfgCloseShippingInfoModal()" class="cfg-btn-secondary" style="flex: 1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" onclick="cfgSaveShippingInfo()" class="cfg-btn-primary" style="flex: 1;">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- å£åº§æƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="cfg-modal-overlay" id="cfg-bankAccountModal">
    <div class="cfg-modal-content">
      <div class="cfg-modal-header">
        <h3>å£åº§æƒ…å ±ã‚’å…¥åŠ›</h3>
        <button class="cfg-modal-close" onclick="cfgCloseBankAccountModal()">&times;</button>
      </div>
      <div class="cfg-modal-body">
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">éŠ€è¡Œå<span style="color: #ef4444;">*</span></label>
          <input type="text" id="cfg-bankName" class="form-control" placeholder="ä¾‹: ä¸‰è±UFJéŠ€è¡Œ" maxlength="50">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">æ”¯åº—å<span style="color: #ef4444;">*</span></label>
          <input type="text" id="cfg-bankBranch" class="form-control" placeholder="ä¾‹: æ¸‹è°·æ”¯åº—" maxlength="50">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">å£åº§ç¨®åˆ¥<span style="color: #ef4444;">*</span></label>
          <select id="cfg-bankAccountType" class="form-control">
            <option value="æ™®é€š">æ™®é€š</option>
            <option value="å½“åº§">å½“åº§</option>
          </select>
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">å£åº§ç•ªå·<span style="color: #ef4444;">*</span></label>
          <input type="text" id="cfg-bankAccountNumber" class="form-control" placeholder="1234567" maxlength="10" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">å£åº§åç¾©ï¼ˆã‚«ã‚¿ã‚«ãƒŠï¼‰<span style="color: #ef4444;">*</span></label>
          <input type="text" id="cfg-bankAccountHolder" class="form-control" placeholder="ä¾‹: ãƒ¤ãƒãƒ€ ã‚¿ãƒ­ã‚¦" maxlength="50">
        </div>
        <div style="display: flex; gap: 8px;">
          <button type="button" onclick="cfgCloseBankAccountModal()" class="cfg-btn-secondary" style="flex: 1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" onclick="cfgSaveBankAccount()" class="cfg-btn-primary" style="flex: 1;">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="cfg-userDetailModal">
    <div class="cfg-modal-sheet">
      <div class="cfg-modal-sheet-header">
        <h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°</h3>
        <button class="cfg-modal-close" onclick="cfgCloseUserDetailModal()" style="padding: 8px;">&times;</button>
      </div>
      <div class="cfg-modal-sheet-body" id="cfg-userDetailContent"></div>
      <div class="cfg-modal-sheet-footer" id="cfg-userDetailActions"></div>
    </div>
  </div>

  <!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç®¡ç†ç•ªå·ãƒ“ãƒ«ãƒ€ãƒ¼ç”¨ï¼‰ -->
  <div id="cfg-mnbModal" class="mnb-modal">
    <div class="mnb-modal-content">
      <div class="mnb-modal-title" id="cfg-mnbModalTitle">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ </div>

      <!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—é¸æŠ -->
      <div class="mnb-form-group" id="cfg-mnbTypeGridContainer">
        <label class="mnb-form-label">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—</label>
        <div class="mnb-type-grid" id="cfg-mnbTypeGrid">
          <!-- å‹•çš„ã«ç”Ÿæˆ -->
        </div>
      </div>

      <!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¨­å®šï¼ˆã‚¿ã‚¤ãƒ—ã«ã‚ˆã£ã¦å¤‰ã‚ã‚‹ï¼‰ -->
      <div id="cfg-mnbSegmentConfig">
        <!-- å‹•çš„ã«ç”Ÿæˆ -->
      </div>

      <!-- åŒºåˆ‡ã‚Šæ–‡å­— -->
      <div class="mnb-form-group">
        <label class="mnb-form-label">åŒºåˆ‡ã‚Šæ–‡å­—ï¼ˆã“ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®å¾Œï¼‰</label>
        <select class="mnb-form-select" id="cfg-mnbSeparator">
          <option value="-">- (ãƒã‚¤ãƒ•ãƒ³)</option>
          <option value="_">_ (ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢)</option>
          <option value="">ï¼ˆãªã—ï¼‰</option>
          <option value=".">. (ãƒ‰ãƒƒãƒˆ)</option>
          <option value=" ">ã€€(ã‚¹ãƒšãƒ¼ã‚¹)</option>
        </select>
      </div>

      <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="mnb-modal-actions">
        <button type="button" class="mnb-modal-btn mnb-modal-btn-secondary" onclick="cfgCloseSegmentModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="button" class="mnb-modal-btn mnb-modal-btn-primary" onclick="cfgSaveSegment()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // Config SPA Fragment - JavaScript
    // Prefix: cfg (functions), _cfg_ (variables)
    // ============================================

    // --- Modal Helper (iOS PWA stacking context fix) ---
    // [data-spa-page]ã®overflow-y:auto + -webkit-overflow-scrolling:touchãŒ
    // iOSã§ã‚¹ã‚¿ãƒƒã‚­ãƒ³ã‚°ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆã—ã€position:fixedãƒ¢ãƒ¼ãƒ€ãƒ«ã®
    // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã€‚ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’bodyã«ç§»å‹•ã—ã¦å›é¿ã€‚
    function _cfgShowModal(modalId) {
      var modal = document.getElementById(modalId);
      if (!modal) return null;
      modal._cfgOrigParent = modal.parentNode;
      modal._cfgOrigNext = modal.nextSibling;
      document.body.appendChild(modal);
      modal.classList.add('active');
      return modal;
    }
    function _cfgHideModal(modalId) {
      var modal = document.getElementById(modalId);
      if (!modal) return;
      modal.classList.remove('active');
      if (modal._cfgOrigParent) {
        if (modal._cfgOrigNext && modal._cfgOrigNext.parentNode === modal._cfgOrigParent) {
          modal._cfgOrigParent.insertBefore(modal, modal._cfgOrigNext);
        } else {
          modal._cfgOrigParent.appendChild(modal);
        }
      }
    }

    // --- State Variables ---
    var _cfg_initialized = false;
    var _cfg_destroyed = false;
    var _cfg_onlineInterval = null;
    var _cfg_pendingUserIconData = null;
    var _cfg_customTaskCounter = 0;
    var _cfg_draggedElement = null;

    // Condition states & presets
    var _cfg_CONDITION_STATES = [
      { value: 'æ–°å“ã€æœªä½¿ç”¨', label: 'æ–°å“ãƒ»æœªä½¿ç”¨', color: '#10b981' },
      { value: 'æœªä½¿ç”¨ã«è¿‘ã„', label: 'æœªä½¿ç”¨ã«è¿‘ã„', color: '#06b6d4' },
      { value: 'ç›®ç«‹ã£ãŸå‚·ã‚„æ±šã‚Œãªã—', label: 'ç›®ç«‹ã£ãŸå‚·ã‚„æ±šã‚Œãªã—', color: '#3b82f6' },
      { value: 'ã‚„ã‚„å‚·ã‚„æ±šã‚Œã‚ã‚Š', label: 'ã‚„ã‚„å‚·ã‚„æ±šã‚Œã‚ã‚Š', color: '#f59e0b' },
      { value: 'å‚·ã‚„æ±šã‚Œã‚ã‚Š', label: 'å‚·ã‚„æ±šã‚Œã‚ã‚Š', color: '#ef4444' },
      { value: 'å…¨ä½“çš„ã«çŠ¶æ…‹ãŒæ‚ªã„', label: 'å…¨ä½“çš„ã«çŠ¶æ…‹ãŒæ‚ªã„', color: '#6b7280' }
    ];

    var _cfg_CONDITION_BUTTON_PRESETS = {
      'æ–°å“ã€æœªä½¿ç”¨': [
        { label: 'ã‚¿ã‚°ä»˜ãæœªä½¿ç”¨', text: 'ã‚¿ã‚°ä»˜ãæœªä½¿ç”¨å“ã§ã™ã€‚' },
        { label: 'ç®±ä»˜ãæ–°å“', text: 'æ–°å“æœªä½¿ç”¨å“ã§ã™ã€‚ç®±ãƒ»ä»˜å±å“ã‚‚ã™ã¹ã¦æƒã£ã¦ã„ã¾ã™ã€‚' },
        { label: 'æœªé–‹å°å“', text: 'æœªé–‹å°ã®æ–°å“ã§ã™ã€‚' }
      ],
      'æœªä½¿ç”¨ã«è¿‘ã„': [
        { label: 'è©¦ç€ã®ã¿', text: 'è©¦ç€ã®ã¿ã§ç€ç”¨ã—ã¦ãŠã‚Šã¾ã›ã‚“ã€‚' },
        { label: 'æ•°å›ä½¿ç”¨', text: 'æ•°å›ä½¿ç”¨ã—ã¾ã—ãŸãŒã€ç›®ç«‹ã¤å‚·ã‚„æ±šã‚Œãªãæœªä½¿ç”¨ã«è¿‘ã„çŠ¶æ…‹ã§ã™ã€‚' },
        { label: 'ä¿ç®¡å“', text: 'è‡ªå®…ä¿ç®¡å“ã§ã™ãŒã€ä½¿ç”¨æ„Ÿãªããã‚Œã„ãªçŠ¶æ…‹ã§ã™ã€‚' }
      ],
      'ç›®ç«‹ã£ãŸå‚·ã‚„æ±šã‚Œãªã—': [
        { label: 'é€šå¸¸ä½¿ç”¨', text: 'é€šå¸¸ä½¿ç”¨ã«ã‚ˆã‚‹å¤šå°‘ã®ä½¿ç”¨æ„Ÿã¯ã‚ã‚Šã¾ã™ãŒã€ç›®ç«‹ã£ãŸå‚·ã‚„æ±šã‚Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚' },
        { label: 'ç¾å“', text: 'å…¨ä½“çš„ã«ãã‚Œã„ãªçŠ¶æ…‹ã§ã™ã€‚ç›®ç«‹ã¤ãƒ€ãƒ¡ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚' }
      ],
      'ã‚„ã‚„å‚·ã‚„æ±šã‚Œã‚ã‚Š': [
        { label: 'ä½¿ç”¨æ„Ÿã‚ã‚Š', text: 'ä½¿ç”¨æ„ŸãŒã‚ã‚Šã€å¤šå°‘ã®å‚·ã‚„æ±šã‚ŒãŒã‚ã‚Šã¾ã™ã€‚å†™çœŸã‚’ã”ç¢ºèªãã ã•ã„ã€‚' },
        { label: 'å°ã‚­ã‚ºã‚ã‚Š', text: 'å°ã•ãªå‚·ãŒã‚ã‚Šã¾ã™ãŒã€ä½¿ç”¨ã«ã¯å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚' }
      ],
      'å‚·ã‚„æ±šã‚Œã‚ã‚Š': [
        { label: 'å‚·æ±šã‚Œç›®ç«‹ã¤', text: 'å‚·ã‚„æ±šã‚ŒãŒç›®ç«‹ã¡ã¾ã™ã€‚å†™çœŸã«ã¦ã”ç¢ºèªãã ã•ã„ã€‚' },
        { label: 'ã‚¸ãƒ£ãƒ³ã‚¯å“', text: 'å‚·ã‚„æ±šã‚ŒãŒã‚ã‚Šã€çŠ¶æ…‹ã¯è‰¯ãã‚ã‚Šã¾ã›ã‚“ã€‚ã”äº†æ‰¿ã®ä¸Šã”è³¼å…¥ãã ã•ã„ã€‚' }
      ],
      'å…¨ä½“çš„ã«çŠ¶æ…‹ãŒæ‚ªã„': [
        { label: 'é›£ã‚ã‚Š', text: 'å…¨ä½“çš„ã«çŠ¶æ…‹ãŒæ‚ªãã€é›£ãŒã‚ã‚Šã¾ã™ã€‚ã”ç†è§£ã®ã‚ã‚‹æ–¹ã®ã¿ã”è³¼å…¥ãã ã•ã„ã€‚' }
      ]
    };

    // Platform master data
    var _cfg_defaultPlatformDefs = [
      { id: 'mercari', name: 'ãƒ¡ãƒ«ã‚«ãƒª', description: 'ãƒ•ãƒªãƒã‚¢ãƒ—ãƒªæœ€å¤§æ‰‹', icon: 'https://asset.mercari.com/assets/img/common/touchicon/mercari.png' },
      { id: 'mercari-shops', name: 'ãƒ¡ãƒ«ã‚«ãƒªShops', description: 'ãƒ¡ãƒ«ã‚«ãƒªã®ECãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ', icon: 'https://asset.mercari.com/assets/img/common/touchicon/mercari.png' },
      { id: 'rakuma', name: 'ãƒ©ã‚¯ãƒ', description: 'æ¥½å¤©ã®ãƒ•ãƒªãƒã‚¢ãƒ—ãƒª', icon: '/Images/rakuma-icon.webp' },
      { id: 'yahoo-fleamarket', name: 'Yahoo!ãƒ•ãƒªãƒ', description: 'Yahoo!ã®ãƒ•ãƒªãƒã‚µãƒ¼ãƒ“ã‚¹', icon: '/Images/yahoo-fleamarket-icon.webp' },
      { id: 'yahoo-auction', name: 'Yahoo!ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³', description: 'æ—¥æœ¬æœ€å¤§ã®ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³', icon: '/Images/yahoo-auction-icon.webp' },
      { id: 'amazon', name: 'Amazon', description: 'ä¸–ç•Œæœ€å¤§ã®ECã‚µã‚¤ãƒˆ', icon: '/Images/amazon-icon.webp' },
      { id: 'base', name: 'BASE', description: 'ç„¡æ–™ãƒãƒƒãƒˆã‚·ãƒ§ãƒƒãƒ—ä½œæˆ', icon: '/Images/base-icon.webp' },
      { id: 'minne', name: 'minne', description: 'ãƒãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ‰ãƒãƒ¼ã‚±ãƒƒãƒˆ', icon: '/Images/minne-icon.webp' },
      { id: 'stores', name: 'STORES', description: 'ãƒãƒƒãƒˆã‚·ãƒ§ãƒƒãƒ—é–‹è¨­', icon: '/Images/stores-icon.webp' },
      { id: 'booth', name: 'BOOTH', description: 'ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã‚ºãƒãƒ¼ã‚±ãƒƒãƒˆ', icon: '/Images/booth-icon.webp' }
    ];
    var _cfg_customPlatforms = [];
    var _cfg_enabledPlatformIds = ['mercari'];
    var _cfg_platformMaster = [];
    var _cfg_platformEdits = {};
    var _cfg_currentEditingPlatformId = null;
    var _cfg_pendingIconFile = null;

    // Config storage keysï¼ˆæ—§ç‰ˆäº’æ›: rebornConfig_* ã‚­ãƒ¼ï¼‰
    var _cfg_CONFIG_STORAGE_KEYS = {
      CONDITION_BUTTONS: 'rebornConfig_conditionButtons',
      HASHTAG: 'rebornConfig_hashtag',
      DISCOUNT: 'rebornConfig_discount',
      SHIPPING_DEFAULT: 'rebornConfig_shippingDefault',
      PROCURE_LISTING_DEFAULT: 'rebornConfig_procureListingDefault',
      MANAGEMENT_NUMBER: 'rebornConfig_managementNumber',
      SALESWORD: 'rebornConfig_salesword',
      AI_SETTINGS: 'rebornConfig_aiSettings',
      DESIGN_THEME: 'rebornTheme',
      IMAGE_SAVE: 'enableProductImageSave',
      PLATFORM: 'config_platform',
      DESCRIPTION_ORDER: 'config_descriptionOrder'
    };

    // Salesword
    var _cfg_SALESWORD_LIST = [];
    var _cfg_pendingSaleswordConfig = null; // ãƒã‚¹ã‚¿ãƒ­ãƒ¼ãƒ‰å¾Œã®å†æç”»ç”¨

    // Description elements (for order)
    var _cfg_DESCRIPTION_ELEMENTS = [
      { id: 'brand', label: 'ãƒ–ãƒ©ãƒ³ãƒ‰æƒ…å ±', enabled: true },
      { id: 'color', label: 'ã‚«ãƒ©ãƒ¼(è©³ç´°)', enabled: true },
      { id: 'size', label: 'ã‚µã‚¤ã‚ºæƒ…å ±', enabled: true },
      { id: 'material', label: 'ç´ ææƒ…å ±', enabled: true },
      { id: 'accessories', label: 'ä»˜å±å“', enabled: true },
      { id: 'condition', label: 'å•†å“ã®çŠ¶æ…‹', enabled: true },
      { id: 'ai', label: 'AIç”Ÿæˆæ–‡', enabled: true },
      { id: 'management', label: 'ç®¡ç†ç•ªå·', enabled: true },
      { id: 'discount', label: 'å‰²å¼•æƒ…å ±', enabled: true },
      { id: 'hashtag', label: 'ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°', enabled: true }
    ];

    // Permission
    var _cfg_permissionSettingsLoaded = false;
    var _cfg_usersData = [];
    var _cfg_menuPermissions = {};
    var _cfg_allUsersData = [];

    var _cfg_PERMISSION_DEFINITIONS = {
      owner: { id: 'owner', label: 'ç®¡ç†è€…', order: 1 },
      employee: { id: 'employee', label: 'ç¤¾å“¡', order: 2 },
      staff: { id: 'staff', label: 'ã‚¹ã‚¿ãƒƒãƒ•', order: 3 },
      leader: { id: 'leader', label: 'ãƒªãƒ¼ãƒ€ãƒ¼', order: 4 },
      contractor: { id: 'contractor', label: 'å¤–æ³¨', order: 5 }
    };

    var _cfg_MENU_DEFINITIONS = [
      { id: 'product', label: 'å•†å“ç™»éŒ²', defaultOwnerOnly: false },
      { id: 'inventory', label: 'åœ¨åº«ç®¡ç†', defaultOwnerOnly: false },
      { id: 'inventory_history', label: 'å…¥å‡ºåº«å±¥æ­´', defaultOwnerOnly: false },
      { id: 'stocktaking', label: 'æ£šå¸', defaultOwnerOnly: false },
      { id: 'purchase', label: 'ä»•å…¥ç®¡ç†', defaultOwnerOnly: false },
      { id: 'sales', label: 'å£²ä¸Šç®¡ç†', defaultOwnerOnly: false },
      { id: 'accounting', label: 'ç¢ºå®šç”³å‘Š', defaultOwnerOnly: false },
      { id: 'compensation', label: 'å ±é…¬ç®¡ç†', defaultOwnerOnly: false },
      // { id: 'pickup-management', label: 'å›åç®¡ç†', defaultOwnerOnly: true }, // ä¸€æ™‚çš„ã«éè¡¨ç¤º
      {
        id: 'master', label: 'ãƒã‚¹ã‚¿ç®¡ç†', isTopGroup: true,
        children: [
          { id: 'master-product', label: 'å•†å“ãƒã‚¹ã‚¿ç®¡ç†', isGroup: true, children: [
            { id: 'master-brand', label: 'ãƒ–ãƒ©ãƒ³ãƒ‰', defaultOwnerOnly: false },
            { id: 'master-category', label: 'ã‚«ãƒ†ã‚´ãƒª', defaultOwnerOnly: false },
            { id: 'master-size', label: 'ã‚µã‚¤ã‚º', defaultOwnerOnly: false },
            { id: 'master-condition', label: 'å•†å“ã®çŠ¶æ…‹', defaultOwnerOnly: false },
            { id: 'master-material', label: 'ç´ æ', defaultOwnerOnly: false },
            { id: 'master-colorDetail', label: 'ã‚«ãƒ©ãƒ¼(è©³ç´°)', defaultOwnerOnly: false },
            { id: 'master-accessory', label: 'ä»˜å±å“', defaultOwnerOnly: false },
            { id: 'master-sizeLabel', label: 'ã‚µã‚¤ã‚º(è¡¨è¨˜)', defaultOwnerOnly: false },
            { id: 'master-salesword', label: 'ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰', defaultOwnerOnly: false },
            { id: 'master-attribute', label: 'å•†å“å±æ€§', defaultOwnerOnly: false },
            { id: 'master-conditionRank', label: 'ãƒ©ãƒ³ã‚¯', defaultOwnerOnly: false }
          ]},
          { id: 'master-business', label: 'æ¥­å‹™ãƒã‚¹ã‚¿ç®¡ç†', isGroup: true, children: [
            { id: 'master-shipping', label: 'ç™ºé€æ–¹æ³•', defaultOwnerOnly: false },
            { id: 'master-shippingBurden', label: 'é…é€æ–™ã®è² æ‹…', defaultOwnerOnly: false },
            { id: 'master-shippingRegion', label: 'ç™ºé€å…ƒã®åœ°åŸŸ', defaultOwnerOnly: false },
            { id: 'master-shippingDays', label: 'ç™ºé€ã¾ã§ã®æ—¥æ•°', defaultOwnerOnly: false },
            { id: 'master-packaging', label: 'æ¢±åŒ…è³‡æ', defaultOwnerOnly: false },
            { id: 'master-supplier', label: 'ä»•å…¥å…ˆ', defaultOwnerOnly: false },
            { id: 'master-marketplace', label: 'å‡ºå“å…ˆ', defaultOwnerOnly: false },
            { id: 'master-managementNumber', label: 'ç®¡ç†ç•ªå·', defaultOwnerOnly: false }
          ]}
        ]
      },
      {
        id: 'config', label: 'è¨­å®šç®¡ç†', isTopGroup: true,
        children: [
          { id: 'config-product', label: 'å•†å“ç™»éŒ²è¨­å®š', isGroup: true, children: [
            { id: 'product-salesword', label: 'ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š', defaultOwnerOnly: true },
            { id: 'product-condition', label: 'å•†å“çŠ¶æ…‹è¨­å®š', defaultOwnerOnly: true },
            { id: 'product-hashtag', label: 'ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°è¨­å®š', defaultOwnerOnly: true },
            { id: 'product-discount', label: 'å‰²å¼•è¨­å®š', defaultOwnerOnly: true },
            { id: 'product-ai', label: 'AIç”Ÿæˆè¨­å®š', defaultOwnerOnly: true },
            { id: 'product-order', label: 'é…ç½®é †åº', defaultOwnerOnly: true }
          ]},
          { id: 'config-system', label: 'ã‚·ã‚¹ãƒ†ãƒ è¨­å®š', isGroup: true, children: [
            { id: 'system-management', label: 'ç®¡ç†ç•ªå·è¨­å®š', defaultOwnerOnly: true },
            { id: 'system-shipping', label: 'é…é€è¨­å®š', defaultOwnerOnly: true },
            { id: 'system-procure', label: 'ä»•å…¥ãƒ»å‡ºå“è¨­å®š', defaultOwnerOnly: true },
            { id: 'system-platform', label: 'ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ', defaultOwnerOnly: true },
            { id: 'system-users', label: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†', defaultOwnerOnly: true, alwaysOwnerOnly: true },
            { id: 'system-compensation', label: 'å ±é…¬è¨­å®š', defaultOwnerOnly: true, alwaysOwnerOnly: true },
            { id: 'system-permission', label: 'æ¨©é™è¨­å®š', defaultOwnerOnly: true, alwaysOwnerOnly: true }
          ]}
        ]
      }
    ];

    // ManagementNumberBuilderï¼ˆæ—§ç‰ˆå®Œå…¨ç§»æ¤ï¼‰
    var _cfgMNB = {
      segments: [],
      currentEditingIndex: null,
      selectedType: null,
      sortableInstance: null,

      segmentTypes: {
        shelf: {
          icon: '\u{1F3F7}\u{FE0F}', name: 'æ£šç•ªå·', desc: 'AA, BB ãªã©ã®æ£šç•ªå·',
          fields: [
            { id: 'format', label: 'æ£šç•ªå·å½¢å¼', type: 'select', options: [
              { value: 'AA', label: 'ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ2æ–‡å­— (AA)' }, { value: 'A', label: 'ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ1æ–‡å­— (A)' },
              { value: '01', label: 'æ•°å­—2æ¡ (01)' }, { value: '001', label: 'æ•°å­—3æ¡ (001)' },
              { value: 'custom', label: 'ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›' }
            ]},
            { id: 'code', label: 'æ£šç•ªå·', type: 'text', placeholder: 'AA', conditional: { field: 'format', value: 'custom' } }
          ],
          preview: function(c) { return (c.format === 'custom') ? (c.code || 'AA') : (c.format || 'AA'); }
        },
        sequence: {
          icon: '\u{1F522}', name: 'é€£ç•ª', desc: '001, 0001 ãªã©ã®é€£ç•ª',
          fields: [
            { id: 'digits', label: 'æ¡æ•°', type: 'select', options: [
              { value: '2', label: '2æ¡ (01)' }, { value: '3', label: '3æ¡ (001)' },
              { value: '4', label: '4æ¡ (0001)' }, { value: '5', label: '5æ¡ (00001)' },
              { value: '6', label: '6æ¡ (000001)' }
            ]},
            { id: 'start', label: 'é–‹å§‹ç•ªå·', type: 'number', placeholder: '1' }
          ],
          preview: function(c) { var n = c.start || 1; var d = parseInt(c.digits) || 3; return String(n).padStart(d, '0'); }
        },
        category: {
          icon: '\u{1F4C1}', name: 'ã‚«ãƒ†ã‚´ãƒªã‚³ãƒ¼ãƒ‰', desc: 'ãƒã‚¹ã‚¿ç®¡ç†ã§è¨­å®šã—ãŸã‚«ãƒ†ã‚´ãƒª',
          fields: [{ id: 'code', label: 'ã‚«ãƒ†ã‚´ãƒª', type: 'select', dynamicOptions: 'categoryCodes', options: [{ value: '', label: '-- èª­ã¿è¾¼ã¿ä¸­ --' }] }],
          preview: function(c) { return c.code || '?'; }
        },
        date: {
          icon: '\u{1F4C5}', name: 'ç™»éŒ²æ—¥', desc: 'æ—¥ä»˜å½¢å¼ã‚’é¸æŠ',
          fields: [{ id: 'format', label: 'å½¢å¼', type: 'select', options: [
            { value: 'YYMMDD', label: 'YYMMDD (241007)' }, { value: 'YYYYMMDD', label: 'YYYYMMDD (20241007)' },
            { value: 'YYMD', label: 'YYMD (24107)' }, { value: 'YYMM', label: 'YYMM (2410)' }
          ]}],
          preview: function(c) {
            var now = new Date(), y = now.getFullYear(), m = String(now.getMonth()+1).padStart(2,'0'), d = String(now.getDate()).padStart(2,'0');
            switch(c.format) { case 'YYYYMMDD': return ''+y+m+d; case 'YYMD': return String(y).slice(2)+parseInt(m)+parseInt(d); case 'YYMM': return String(y).slice(2)+m; default: return String(y).slice(2)+m+d; }
          }
        },
        rank: {
          icon: '\u{2B50}', name: 'å“è³ªãƒ©ãƒ³ã‚¯', desc: 'A, B, C ãªã©ã®ãƒ©ãƒ³ã‚¯',
          fields: [{ id: 'value', label: 'ãƒ©ãƒ³ã‚¯å€¤', type: 'text', placeholder: 'A' }],
          preview: function(c) { return c.value || 'A'; }
        },
        size: {
          icon: '\u{1F4CF}', name: 'ã‚µã‚¤ã‚ºã‚³ãƒ¼ãƒ‰', desc: 'S, M, L ãªã©ã®ã‚µã‚¤ã‚º',
          fields: [{ id: 'code', label: 'ã‚µã‚¤ã‚ºã‚³ãƒ¼ãƒ‰', type: 'text', placeholder: 'M' }],
          preview: function(c) { return c.code || 'M'; }
        },
        color: {
          icon: '\u{1F3A8}', name: 'è‰²ã‚³ãƒ¼ãƒ‰', desc: 'DB, R ãªã©ã®è‰²ã‚³ãƒ¼ãƒ‰',
          fields: [{ id: 'code', label: 'è‰²ã‚³ãƒ¼ãƒ‰', type: 'text', placeholder: 'DB' }],
          preview: function(c) { return c.code || 'DB'; }
        },
        custom: {
          icon: '\u{270F}\u{FE0F}', name: 'ã‚«ã‚¹ã‚¿ãƒ å›ºå®šå€¤', desc: 'ä»»æ„ã®å›ºå®šæ–‡å­—åˆ—',
          fields: [{ id: 'value', label: 'å›ºå®šå€¤', type: 'text', placeholder: 'XXX' }],
          preview: function(c) { return c.value || 'XXX'; }
        }
      },

      presets: {
        simple: [{ type: 'sequence', config: { digits: '3', start: '1' }, separator: '' }],
        shelf: [{ type: 'shelf', config: { format: 'AA' }, separator: '-' }, { type: 'sequence', config: { digits: '3', start: '1' }, separator: '' }],
        category_date: [{ type: 'category', config: { code: 'K' }, separator: '-' }, { type: 'date', config: { format: 'YYMMDD' }, separator: '-' }, { type: 'sequence', config: { digits: '3', start: '1' }, separator: '' }],
        shelf_date: [{ type: 'shelf', config: { format: 'AA' }, separator: '-' }, { type: 'date', config: { format: 'YYMMDD' }, separator: '-' }, { type: 'sequence', config: { digits: '3', start: '1' }, separator: '' }],
        category_rank: [{ type: 'category', config: { code: 'K' }, separator: '-' }, { type: 'rank', config: { value: 'A' }, separator: '-' }, { type: 'sequence', config: { digits: '3', start: '1' }, separator: '' }]
      },

      init: function() { this.renderTypeGrid(); this.updatePreview(); },

      loadCategoryCodes: function() {
        var self = this, db = window.db;
        if (!db) return Promise.resolve();
        return db.collection('categoryCodes').orderBy('code', 'asc').get().then(function(snap) {
          var codes = [];
          snap.forEach(function(doc) { var d = doc.data(); if (d.code && d.name) codes.push({ value: d.code, label: d.code + ' (' + d.name + ')' }); });
          self.segmentTypes.category.fields[0].options = codes.length > 0 ? codes : [{ value: '', label: '-- ãƒã‚¹ã‚¿ç®¡ç†ã§è¿½åŠ ã—ã¦ãã ã•ã„ --' }];
        }).catch(function(e) { console.error('[MNB] ã‚«ãƒ†ã‚´ãƒªã‚³ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e); });
      },

      applyPresetFromCard: function(key) {
        if (!key || key === 'custom') return;
        var preset = this.presets[key];
        if (!preset) return;
        this.segments = JSON.parse(JSON.stringify(preset));
        this.renderSegments();
        this.updatePreview();
      },

      loadSettings: function() {
        var self = this, db = window.db;
        if (!db) return;
        db.collection('settings').doc('common').get().then(function(docSnap) {
          if (!docSnap.exists) return;
          var mn = (docSnap.data() || {}).managementNumber;
          if (!mn) return;

          var presetKey = mn.presetKey || '';
          var saved = mn.segments || [];
          var hidden = document.getElementById('cfg-mnbPresetSelect');
          if (hidden && presetKey) hidden.value = presetKey;

          if (presetKey) {
            document.querySelectorAll('#spa-page-config .mnb-preset-card').forEach(function(c) { c.classList.remove('selected'); });
            var sel = document.querySelector('#spa-page-config .mnb-preset-card[data-preset="' + presetKey + '"]');
            if (sel) sel.classList.add('selected');
          }

          if (saved.length > 0) { self.segments = saved; }
          else if (presetKey && presetKey !== 'custom' && self.presets[presetKey]) { self.segments = JSON.parse(JSON.stringify(self.presets[presetKey])); }
          self.renderSegments();
          self.updatePreview();
          cfgUpdateCurrentSettingsView();

          var showT = document.getElementById('cfg-mnb-showInTitle');
          var showD = document.getElementById('cfg-mnb-showInDescription');
          var tFmt = document.getElementById('cfg-mnb-titleFormat');
          var dFmt = document.getElementById('cfg-mnb-descFormat');
          if (showT && mn.showInTitle !== undefined) showT.checked = mn.showInTitle;
          if (showD && mn.showInDescription !== undefined) showD.checked = mn.showInDescription;
          if (tFmt && mn.titleFormat) tFmt.value = mn.titleFormat;
          if (dFmt && mn.descFormat) dFmt.value = mn.descFormat;
          cfgUpdateMnbFormatPreview();
        }).catch(function(e) { console.error('[MNB] Firestoreèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e); });
      },

      renderTypeGrid: function() {
        var self = this, grid = document.getElementById('cfg-mnbTypeGrid');
        if (!grid) return;
        grid.innerHTML = '';
        Object.keys(this.segmentTypes).forEach(function(k) {
          var t = self.segmentTypes[k], card = document.createElement('div');
          card.className = 'mnb-type-card';
          card.onclick = function() { self.selectType(k); };
          card.innerHTML = '<div class="mnb-type-card-icon">' + t.icon + '</div><div class="mnb-type-card-name">' + t.name + '</div><div class="mnb-type-card-desc">' + t.desc + '</div>';
          grid.appendChild(card);
        });
      },

      selectType: function(typeKey) {
        this.selectedType = typeKey;
        var grid = document.getElementById('cfg-mnbTypeGrid');
        if (grid) {
          grid.querySelectorAll('.mnb-type-card').forEach(function(c) { c.classList.remove('selected'); });
          var keys = Object.keys(this.segmentTypes), idx = keys.indexOf(typeKey);
          var cards = grid.querySelectorAll('.mnb-type-card');
          if (cards[idx]) cards[idx].classList.add('selected');
        }
        this.renderConfigFields(typeKey);
      },

      renderConfigFields: function(typeKey) {
        var self = this, type = this.segmentTypes[typeKey];
        var container = document.getElementById('cfg-mnbSegmentConfig');
        if (!container) return;
        container.innerHTML = '';
        type.fields.forEach(function(field) {
          var group = document.createElement('div');
          group.className = 'mnb-form-group';
          if (field.conditional) { group.style.display = 'none'; group.setAttribute('data-conditional-field', field.conditional.field); group.setAttribute('data-conditional-value', field.conditional.value); }
          var lbl = document.createElement('label'); lbl.className = 'mnb-form-label'; lbl.textContent = field.label; group.appendChild(lbl);
          if (field.type === 'select') {
            var sel = document.createElement('select'); sel.className = 'mnb-form-select'; sel.id = 'cfg-mnbField_' + field.id;
            field.options.forEach(function(o) { var opt = document.createElement('option'); opt.value = o.value; opt.textContent = o.label; sel.appendChild(opt); });
            sel.addEventListener('change', function() { self.updateConditionalFields(field.id, sel.value); });
            group.appendChild(sel);
          } else {
            var inp = document.createElement('input'); inp.className = 'mnb-form-input'; inp.type = field.type; inp.id = 'cfg-mnbField_' + field.id; inp.placeholder = field.placeholder || '';
            group.appendChild(inp);
          }
          container.appendChild(group);
        });
      },

      updateConditionalFields: function(fieldId, value) {
        var container = document.getElementById('cfg-mnbSegmentConfig');
        if (!container) return;
        container.querySelectorAll('[data-conditional-field="' + fieldId + '"]').forEach(function(f) {
          f.style.display = (value === f.getAttribute('data-conditional-value')) ? 'block' : 'none';
        });
      },

      addSegment: function(seg) { this.segments.push(seg); this.renderSegments(); this.updatePreview(); },
      updateSegment: function(i, seg) { this.segments[i] = seg; this.renderSegments(); this.updatePreview(); },
      removeSegment: function(i) { this.segments.splice(i, 1); this.renderSegments(); this.updatePreview(); },
      moveSegment: function(from, to) { var s = this.segments.splice(from, 1)[0]; this.segments.splice(to, 0, s); this.renderSegments(); this.updatePreview(); },
      renderSegments: function() { /* ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³UIä½¿ç”¨ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ— */ },

      generatePreview: function() {
        if (this.segments.length === 0) return '';
        var self = this, preview = '';
        this.segments.forEach(function(seg, i) {
          var t = self.segmentTypes[seg.type]; if (!t) return;
          preview += t.preview(seg.config);
          if (i < self.segments.length - 1 && seg.separator) preview += seg.separator;
        });
        return preview;
      },

      updatePreview: function() { cfgUpdateCurrentSettingsView(); cfgUpdateMnbFormatPreview(); },

      editSegment: function(index) {
        this.currentEditingIndex = index;
        var seg = this.segments[index], type = this.segmentTypes[seg.type];
        document.getElementById('cfg-mnbModalTitle').textContent = type.icon + ' ' + type.name + 'ã‚’ç·¨é›†';
        document.getElementById('cfg-mnbTypeGridContainer').style.display = 'none';
        this.selectType(seg.type);
        var self = this;
        type.fields.forEach(function(field) {
          var elem = document.getElementById('cfg-mnbField_' + field.id);
          if (elem) { elem.value = seg.config[field.id] || ''; if (field.type === 'select') self.updateConditionalFields(field.id, elem.value); }
        });
        document.getElementById('cfg-mnbSeparator').value = seg.separator || '-';
        _cfgShowModal('cfg-mnbModal');
      },

      getData: function() { return { segments: this.segments }; },
      setData: function(data) { this.segments = data.segments || []; this.renderSegments(); this.updatePreview(); }
    };

    // User task assignment
    var _cfg_userTaskAssignmentRetryCount = 0;
    var _cfg_USER_TASK_ASSIGNMENT_MAX_RETRIES = 5;
    window.cfgUserTaskAssignments = {};

    // ============================================
    // Lifecycle: initConfigPage / destroyConfigPage
    // ============================================

    function initConfigPage() {
      if (_cfg_initialized) {
        console.log('[config-fragment] Already initialized, skipping');
        return;
      }
      _cfg_initialized = true;
      _cfg_destroyed = false;
      console.log('[config-fragment] initConfigPage()');

      // Detect which tab to show based on SPA page key
      var currentPage = (typeof getCurrentSpaPage === 'function') ? getCurrentSpaPage() : 'config';
      var headerTitle = document.getElementById('cfg-page-header-title');

      if (currentPage === 'config-product') {
        cfgShowMainTab('product');
        if (headerTitle) headerTitle.textContent = 'å•†å“ç™»éŒ²è¨­å®š';
      } else if (currentPage === 'config-permission-users') {
        cfgShowMainTab('system');
        if (headerTitle) headerTitle.textContent = 'ã‚·ã‚¹ãƒ†ãƒ è¨­å®š';
        // Activate users subtab after a tick + load data
        setTimeout(function() {
          cfgActivateSubtab('cfg-system-users');
          cfgLoadUserManagement();
        }, 50);
      } else {
        // config-system or config (default to system)
        cfgShowMainTab('system');
        if (headerTitle) headerTitle.textContent = 'ã‚·ã‚¹ãƒ†ãƒ è¨­å®š';
      }

      // Setup subtab click handlers
      cfgSetupSubtabs();

      // Load all config
      cfgLoadAllConfig();

      // Initialize platform master
      _cfg_platformMaster = _cfg_defaultPlatformDefs.slice();

      // Load data from Firestore
      cfgInitFirestoreData();

      // Start online status updates
      cfgStartOnlineStatusUpdates();

      console.log('[config-fragment] initConfigPage() complete');
    }
    window.initConfigPage = initConfigPage;

    function destroyConfigPage() {
      console.log('[config-fragment] destroyConfigPage()');
      _cfg_initialized = false;
      _cfg_destroyed = true;

      // Clear online interval
      if (_cfg_onlineInterval) {
        clearInterval(_cfg_onlineInterval);
        _cfg_onlineInterval = null;
      }

      // Reset state
      _cfg_permissionSettingsLoaded = false;
      _cfg_usersData = [];
      _cfg_allUsersData = [];
      _cfg_SALESWORD_LIST = [];
      _cfg_pendingSaleswordConfig = null;
      _cfg_wordOverrides = [];
      _cfg_saleswordFavorites = [];
      _cfg_customTaskCounter = 0;
      _cfg_userTaskAssignmentRetryCount = 0;

      // bodyç›´ä¸‹ã«æ®‹ã£ãŸãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å…ƒã«æˆ»ã™
      ['cfg-platformSelectModal', 'cfg-platformEditModal', 'cfg-shippingInfoModal', 'cfg-bankAccountModal', 'cfg-mnbModal', 'cfg-userDetailModal'].forEach(function(id) {
        _cfgHideModal(id);
      });
    }
    window.destroyConfigPage = destroyConfigPage;

    // ============================================
    // Tab Switching (custom, no Bootstrap)
    // ============================================

    function cfgShowMainTab(tabName) {
      var productPane = document.getElementById('cfg-product');
      var systemPane = document.getElementById('cfg-system');
      if (!productPane || !systemPane) return;

      if (tabName === 'product') {
        productPane.classList.add('active');
        systemPane.classList.remove('active');
      } else {
        systemPane.classList.add('active');
        productPane.classList.remove('active');
      }
    }

    function cfgSetupSubtabs() {
      // Product subtabs
      var productTabs = document.querySelectorAll('#cfg-productConfigTabs .cfg-subtab');
      productTabs.forEach(function(tab) {
        tab.addEventListener('click', function() {
          cfgActivateSubtab(this.getAttribute('data-target'));
        });
      });

      // System subtabs
      var systemTabs = document.querySelectorAll('#cfg-systemConfigTabs .cfg-subtab');
      systemTabs.forEach(function(tab) {
        tab.addEventListener('click', function() {
          var target = this.getAttribute('data-target');
          cfgActivateSubtab(target);
          // Lazy load certain tabs
          if (target === 'cfg-system-permission') cfgLoadPermissionSettings();
          if (target === 'cfg-system-users') cfgLoadUserManagement();
          if (target === 'cfg-system-compensation') {
            cfgLoadCompensationSettingsFromFirestore();
            cfgLoadUserTaskAssignmentList();
          }
        });
      });
    }

    function cfgActivateSubtab(targetId) {
      if (!targetId) return;
      // Find parent tabs container
      var targetPane = document.getElementById(targetId);
      if (!targetPane) return;

      var parentContent = targetPane.parentElement;
      if (!parentContent) return;

      // Determine which tabs container
      var tabsContainerId = parentContent.id === 'cfg-productConfigTabContent' ? 'cfg-productConfigTabs' : 'cfg-systemConfigTabs';
      var tabsContainer = document.getElementById(tabsContainerId);
      if (!tabsContainer) return;

      // Deactivate all subtabs and panes in this group
      tabsContainer.querySelectorAll('.cfg-subtab').forEach(function(t) { t.classList.remove('active'); });
      parentContent.querySelectorAll('.cfg-subtab-pane').forEach(function(p) { p.classList.remove('active'); });

      // Activate target
      targetPane.classList.add('active');
      var targetTab = tabsContainer.querySelector('[data-target="' + targetId + '"]');
      if (targetTab) {
        targetTab.classList.add('active');
        targetTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      }
    }

    // ============================================
    // Firestore Data Loading
    // ============================================

    var _cfg_firestoreRetryCount = 0;
    async function cfgInitFirestoreData() {
      var db = (typeof getCompatDb === 'function') ? getCompatDb() : window.db;
      if (!db || typeof db.collection !== 'function') {
        _cfg_firestoreRetryCount++;
        if (_cfg_firestoreRetryCount < 10) {
          console.log('[config-fragment] Waiting for Firestore compat... (' + _cfg_firestoreRetryCount + ')');
          setTimeout(cfgInitFirestoreData, 500);
        }
        return;
      }

      try {
        // Load shipping dropdowns
        await Promise.all([
          cfgLoadShippingBurden(),
          cfgLoadShippingMethodCategories(),
          cfgLoadShippingRegions(),
          cfgLoadShippingDays()
        ]);

        // é…é€ã‚ªãƒ—ã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ä¿å­˜æ¸ˆã¿è¨­å®šå€¤ã‚’å†é©ç”¨
        // ï¼ˆcfgLoadAllConfigãŒã‚ªãƒ—ã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿å‰ã«å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§å†è¨­å®šãŒå¿…è¦ï¼‰
        try {
          var sd = localStorage.getItem(_cfg_CONFIG_STORAGE_KEYS.SHIPPING_DEFAULT);
          var shippingConfig = sd ? JSON.parse(sd) : null;
          if (!shippingConfig && window.db) {
            var doc = await window.db.collection('settings').doc('common').get();
            if (doc.exists && doc.data().shippingDefault) shippingConfig = doc.data().shippingDefault;
          }
          if (shippingConfig) cfgRenderShippingDefaults(shippingConfig);
        } catch (e) { console.warn('[config] shipping defaults re-apply error:', e); }

        // Load procure/listing dropdowns
        await cfgInitProcureListingDropdowns();

        // ä»•å…¥å‡ºå“ã‚ªãƒ—ã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ä¿å­˜æ¸ˆã¿è¨­å®šå€¤ã‚’å†é©ç”¨
        try {
          var pl = localStorage.getItem(_cfg_CONFIG_STORAGE_KEYS.PROCURE_LISTING_DEFAULT);
          var plConfig = pl ? JSON.parse(pl) : null;
          if (!plConfig && window.db) {
            var doc2 = await window.db.collection('settings').doc('common').get();
            if (doc2.exists && doc2.data().procureListingDefault) plConfig = doc2.data().procureListingDefault;
          }
          if (plConfig) cfgRenderProcureListingDefaults(plConfig);
        } catch (e) { console.warn('[config] procure/listing defaults re-apply error:', e); }

        // Load platforms from Firestore
        await cfgLoadPlatformsFromFirestore();

        // Load MNB category codes and settings
        // MNBåˆæœŸåŒ–
        _cfgMNB.init();
        await _cfgMNB.loadCategoryCodes();
        _cfgMNB.loadSettings();

        // Load platform settings
        var config = JSON.parse(localStorage.getItem('config') || '{}');
        cfgLoadPlatformSettings(config);

        // Load compensation
        await cfgLoadCompensationSettingsFromFirestore();

        // Check user permissions
        await cfgCheckUserPermissionAndUpdateUI();

        // Load salesword master
        await cfgLoadSaleswordMasterData();

        // Load basic settings (user profile, notifications)
        await cfgLoadBasicSettings();

        // Init user icon file handler
        cfgInitUserIconHandler();

        console.log('[config-fragment] Firestore data loaded');
      } catch (error) {
        console.error('[config-fragment] Firestore init error:', error);
      }
    }

    // ============================================
    // Config Load / Save (hybrid localStorage + Firestore)
    // ============================================

    async function cfgLoadAllConfig() {
      console.log('[config-fragment] Loading all config...');
      try {
        // 1. æ—§ç‰ˆäº’æ›: rebornConfig_* å€‹åˆ¥ã‚­ãƒ¼ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆé«˜é€Ÿï¼‰
        var config = {};
        var cb = localStorage.getItem(_cfg_CONFIG_STORAGE_KEYS.CONDITION_BUTTONS);
        if (cb) config['å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³'] = JSON.parse(cb);
        var ht = localStorage.getItem(_cfg_CONFIG_STORAGE_KEYS.HASHTAG);
        if (ht) config['ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°'] = JSON.parse(ht);
        var dc = localStorage.getItem(_cfg_CONFIG_STORAGE_KEYS.DISCOUNT);
        if (dc) config['å‰²å¼•æƒ…å ±'] = JSON.parse(dc);
        var sd = localStorage.getItem(_cfg_CONFIG_STORAGE_KEYS.SHIPPING_DEFAULT);
        if (sd) config['é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ'] = JSON.parse(sd);
        var pl = localStorage.getItem(_cfg_CONFIG_STORAGE_KEYS.PROCURE_LISTING_DEFAULT);
        if (pl) config['ä»•å…¥å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ'] = JSON.parse(pl);
        var mn = localStorage.getItem(_cfg_CONFIG_STORAGE_KEYS.MANAGEMENT_NUMBER);
        if (mn) config['ç®¡ç†ç•ªå·è¨­å®š'] = JSON.parse(mn);
        var sw = localStorage.getItem(_cfg_CONFIG_STORAGE_KEYS.SALESWORD);
        if (sw) config['ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰'] = JSON.parse(sw);
        var ai = localStorage.getItem(_cfg_CONFIG_STORAGE_KEYS.AI_SETTINGS);
        if (ai) config['AIç”Ÿæˆè¨­å®š'] = JSON.parse(ai);

        // config ã‚­ãƒ¼ã‹ã‚‰ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã‚’èª­ã¿è¾¼ã¿
        var cfgObj = JSON.parse(localStorage.getItem('config') || '{}');
        if (cfgObj['ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š']) config['ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š'] = cfgObj['ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š'];
        // descriptionOrder ã¯æ–°ã‚­ãƒ¼ã‹ã‚‰ï¼ˆæ—§ç‰ˆã«ã¯ãªã„ï¼‰
        if (cfgObj.descriptionOrder) config.descriptionOrder = cfgObj.descriptionOrder;

        // 2. Firestore settings/common ã‚’ç¢ºèªï¼ˆæ¨©å¨ã‚½ãƒ¼ã‚¹ï¼‰
        if (window.db) {
          try {
            var doc = await window.db.collection('settings').doc('common').get();
            if (doc.exists) {
              var fsConfig = doc.data();
              // Firestoreã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åâ†’æ—¥æœ¬èªã‚­ãƒ¼å¤‰æ›
              if (fsConfig.conditionButtons) config['å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³'] = fsConfig.conditionButtons;
              if (fsConfig.hashtag) config['ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°'] = fsConfig.hashtag;
              if (fsConfig.discount) config['å‰²å¼•æƒ…å ±'] = fsConfig.discount;
              if (fsConfig.shippingDefault) config['é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ'] = fsConfig.shippingDefault;
              if (fsConfig.procureListingDefault) config['ä»•å…¥å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ'] = fsConfig.procureListingDefault;
              if (fsConfig.managementNumber) config['ç®¡ç†ç•ªå·è¨­å®š'] = fsConfig.managementNumber;
              if (fsConfig.salesword) config['ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰'] = fsConfig.salesword;
              if (fsConfig.aiSettings) config['AIç”Ÿæˆè¨­å®š'] = fsConfig.aiSettings;
              console.log('[config-fragment] Loaded config from Firestore settings/common');
            }
          } catch (e) {
            console.warn('[config-fragment] Firestore config load failed, using localStorage:', e);
          }
        }

        cfgRenderAllConfig(config);
      } catch (error) {
        console.error('[config-fragment] Config load error:', error);
      }
    }

    function cfgRenderAllConfig(config) {
      if (!config) config = {};

      // Condition buttons
      if (config['å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³']) cfgRenderConditionButtons(config['å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³']);
      else cfgRenderConditionButtons(null);

      // Hashtags
      if (config['ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°']) cfgRenderHashtagConfig(config['ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°']);

      // Discounts
      if (config['å‰²å¼•æƒ…å ±']) cfgRenderDiscountConfig(config['å‰²å¼•æƒ…å ±']);

      // AI settings
      if (config['AIç”Ÿæˆè¨­å®š']) cfgRenderAiSettings(config['AIç”Ÿæˆè¨­å®š']);
      else cfgApplyAiPreset('casual');

      // Shipping defaults
      if (config['é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ']) cfgRenderShippingDefaults(config['é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ']);

      // Procure/Listing defaults
      if (config['ä»•å…¥å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ']) cfgRenderProcureListingDefaults(config['ä»•å…¥å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ']);

      // Saleswordï¼ˆãƒã‚¹ã‚¿æœªãƒ­ãƒ¼ãƒ‰æ™‚ã¯ä¿ç•™ã—ã¦å¾Œã§å†æç”»ï¼‰
      if (config['ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰']) {
        if (_cfg_SALESWORD_LIST.length > 0) {
          cfgRenderSaleswordConfig(config['ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰']);
        } else {
          _cfg_pendingSaleswordConfig = config['ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰'];
        }
      }

      // Description order
      if (config.descriptionOrder) cfgRenderDescriptionOrder(config.descriptionOrder);
      else cfgRenderDescriptionOrder(null);

      // Platform
      if (config['ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š']) cfgLoadPlatformSettings(config);

      console.log('[config-fragment] All config rendered');
    }

    // ä»•å…¥ãƒ»å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’UIã«åæ˜ 
    function cfgRenderProcureListingDefaults(defaults) {
      if (!defaults) return;
      var el;
      // ä»•å…¥å…ˆï¼ˆæ–°ã‚­ãƒ¼: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥å…ˆ / æ—§ã‚­ãƒ¼: ä»•å…¥å…ˆï¼‰
      el = document.getElementById('cfg-ä»•å…¥å…ˆ');
      if (el) {
        var supplier = defaults['ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥å…ˆ'] || defaults['ä»•å…¥å…ˆ'] || '';
        if (supplier) el.value = supplier;
      }
      // ä»•å…¥æ—¥
      el = document.getElementById('cfg-ä»•å…¥æ—¥');
      var procureDate = defaults['ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥æ—¥'] || defaults['ä»•å…¥æ—¥'] || '';
      if (el && procureDate) el.value = procureDate;
      // ä»•å…¥æ—¥ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ–°ã‚­ãƒ¼: ä»•å…¥æ—¥_ä»Šæ—¥=false â†’ fixed / æ—§ã‚­ãƒ¼: ä»•å…¥æ—¥ãƒ¢ãƒ¼ãƒ‰='fixed'ï¼‰
      var procureIsFixed = defaults['ä»•å…¥æ—¥_ä»Šæ—¥'] === false || defaults['ä»•å…¥æ—¥ãƒ¢ãƒ¼ãƒ‰'] === 'fixed';
      if (procureIsFixed) {
        var radio = document.querySelector('input[name="cfg-procureDateMode"][value="fixed"]');
        if (radio) { radio.checked = true; cfgToggleProcureDateField('fixed'); }
      }
      // å‡ºå“å…ˆï¼ˆæ–°ã‚­ãƒ¼: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“å…ˆ / æ—§ã‚­ãƒ¼: å‡ºå“å…ˆï¼‰
      el = document.getElementById('cfg-å‡ºå“å…ˆ');
      if (el) {
        var salesCh = defaults['ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“å…ˆ'] || defaults['å‡ºå“å…ˆ'] || '';
        if (salesCh) el.value = salesCh;
      }
      // å‡ºå“æ—¥
      el = document.getElementById('cfg-å‡ºå“æ—¥');
      var listingDate = defaults['ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“æ—¥'] || defaults['å‡ºå“æ—¥'] || '';
      if (el && listingDate) el.value = listingDate;
      // å‡ºå“æ—¥ãƒ¢ãƒ¼ãƒ‰
      var listingIsFixed = defaults['å‡ºå“æ—¥_ä»Šæ—¥'] === false || defaults['å‡ºå“æ—¥ãƒ¢ãƒ¼ãƒ‰'] === 'fixed';
      if (listingIsFixed) {
        var radio2 = document.querySelector('input[name="cfg-listingDateMode"][value="fixed"]');
        if (radio2) { radio2.checked = true; cfgToggleListingDateField('fixed'); }
      }
    }

    async function cfgSaveConfig() {
      console.log('[config-fragment] Saving config...');

      try {
        var managementConfig = cfgCollectManagementConfig();

        // ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
        if (_cfg_pendingUserIconData) {
          await cfgUploadUserIcon();
        }

        // ç”»åƒç®¡ç†è¨­å®šã‚’LocalStorageã«ä¿å­˜
        var imageCheckbox = document.getElementById('cfg-enableProductImageSave');
        if (imageCheckbox) {
          localStorage.setItem(_cfg_CONFIG_STORAGE_KEYS.IMAGE_SAVE, imageCheckbox.checked.toString());
        }

        // å…¨è¨­å®šã‚’åé›†ï¼ˆæ—§ç‰ˆäº’æ›: æ—¥æœ¬èªã‚­ãƒ¼ï¼‰
        var newConfig = {
          'å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³': cfgCollectConditionButtons(),
          'ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°': cfgCollectHashtagConfig(),
          'å‰²å¼•æƒ…å ±': cfgCollectDiscountConfig(),
          'é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ': cfgCollectShippingDefaults(),
          'ä»•å…¥å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ': cfgCollectProcureListingDefaults(),
          'ç®¡ç†ç•ªå·è¨­å®š': managementConfig,
          'ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰': cfgCollectSaleswordConfig(),
          'AIç”Ÿæˆè¨­å®š': cfgCollectAiSettings(),
          'ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ': '',
          'ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š': cfgCollectPlatformSettings()
        };

        // 1. localStorage ã«å€‹åˆ¥ã‚­ãƒ¼ã§ä¿å­˜ï¼ˆæ—§ç‰ˆäº’æ›: rebornConfig_*ï¼‰
        cfgSaveConfigToLocalStorage(newConfig);
        console.log('[config-fragment] Saved to localStorage (rebornConfig_* keys)');

        // 2. Firestore settings/common ã«ä¿å­˜ï¼ˆæ—§ç‰ˆäº’æ›ï¼‰
        cfgSaveConfigToFirestore(newConfig);

        // 3. å ±é…¬è¨­å®šã‚’åˆ¥é€”ä¿å­˜
        await cfgSaveCompensationSettings();

        // 4. ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚¿ã‚¹ã‚¯æ‹…å½“è¨­å®šã‚’ä¿å­˜
        await cfgSaveUserTaskAssignments();

        // 5. æ¨©é™è¨­å®šã‚’ä¿å­˜
        await cfgSavePermissionSettings(false);

        // 6. åŸºæœ¬è¨­å®šï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ»é€šçŸ¥ï¼‰ã‚’ä¿å­˜
        await cfgSaveBasicSettings(true);

        // 7. è¨­å®šå¤‰æ›´ã‚’é€šçŸ¥ï¼ˆpostMessage + BroadcastChannelï¼‰
        cfgNotifyConfigChange();

        alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      } catch (error) {
        console.error('[config-fragment] Save error:', error);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }
    window.cfgSaveConfig = cfgSaveConfig;

    // localStorage ã«æ—§ç‰ˆäº’æ›ã®å€‹åˆ¥ã‚­ãƒ¼ã§ä¿å­˜
    function cfgSaveConfigToLocalStorage(config) {
      try {
        localStorage.setItem(_cfg_CONFIG_STORAGE_KEYS.CONDITION_BUTTONS, JSON.stringify(config['å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³']));
        localStorage.setItem(_cfg_CONFIG_STORAGE_KEYS.HASHTAG, JSON.stringify(config['ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°']));
        localStorage.setItem(_cfg_CONFIG_STORAGE_KEYS.DISCOUNT, JSON.stringify(config['å‰²å¼•æƒ…å ±']));
        localStorage.setItem(_cfg_CONFIG_STORAGE_KEYS.SHIPPING_DEFAULT, JSON.stringify(config['é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ']));
        localStorage.setItem(_cfg_CONFIG_STORAGE_KEYS.PROCURE_LISTING_DEFAULT, JSON.stringify(config['ä»•å…¥å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ']));
        localStorage.setItem(_cfg_CONFIG_STORAGE_KEYS.MANAGEMENT_NUMBER, JSON.stringify(config['ç®¡ç†ç•ªå·è¨­å®š']));
        localStorage.setItem('managementConfigTimestamp', Date.now().toString());
        localStorage.setItem(_cfg_CONFIG_STORAGE_KEYS.SALESWORD, JSON.stringify(config['ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰']));
        localStorage.setItem(_cfg_CONFIG_STORAGE_KEYS.AI_SETTINGS, JSON.stringify(config['AIç”Ÿæˆè¨­å®š']));
        if (config['ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ']) {
          localStorage.setItem(_cfg_CONFIG_STORAGE_KEYS.DESIGN_THEME, config['ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ']);
        }

        // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã‚’ config ã‚­ãƒ¼ã«ã‚‚ä¿å­˜ï¼ˆproduct.htmläº’æ›ï¼‰
        var existing = JSON.parse(localStorage.getItem('config') || '{}');
        existing['ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š'] = config['ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š'];
        localStorage.setItem('config', JSON.stringify(existing));

        console.log('[config-fragment] localStorageä¿å­˜å®Œäº†ï¼ˆrebornConfig_* keysï¼‰');
        return true;
      } catch (e) {
        console.error('[config-fragment] localStorageä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
        return false;
      }
    }

    // Firestore settings/common ã«æ—§ç‰ˆäº’æ›ã§ä¿å­˜
    function cfgSaveConfigToFirestore(config) {
      if (!window.db) {
        console.warn('[config-fragment] FirestoreæœªåˆæœŸåŒ–');
        return;
      }
      window.db.collection('settings').doc('common').set({
        conditionButtons: config['å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³'] || [],
        hashtag: config['ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°'] || {},
        discount: config['å‰²å¼•æƒ…å ±'] || {},
        shippingDefault: config['é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ'] || {},
        procureListingDefault: config['ä»•å…¥å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ'] || {},
        managementNumber: config['ç®¡ç†ç•ªå·è¨­å®š'] || {},
        salesword: config['ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰'] || {},
        aiSettings: config['AIç”Ÿæˆè¨­å®š'] || {},
        designTheme: config['ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ'] || 'modern',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(function() {
        console.log('[config-fragment] Firestore settings/common ä¿å­˜å®Œäº†');
      }).catch(function(e) {
        console.warn('[config-fragment] Firestoreä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
      });
    }

    function cfgNotifyConfigChange() {
      try {
        // åŒä¸€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é€šçŸ¥
        window.postMessage({ type: 'configChanged', timestamp: Date.now() }, '*');

        // BroadcastChannel ã§å…¨ã‚¿ãƒ–ã«é€šçŸ¥
        if ('BroadcastChannel' in window) {
          var channel = new BroadcastChannel('reborn_config_updates');
          channel.postMessage({ type: 'configChanged', timestamp: Date.now() });
          channel.close();
        }
      } catch (e) { /* ignore */ }
    }

    // ä»•å…¥ãƒ»å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’åé›†
    function cfgCollectProcureListingDefaults() {
      var procureDateMode = (document.querySelector('input[name="cfg-procureDateMode"]:checked') || {}).value || 'today';
      var listingDateMode = (document.querySelector('input[name="cfg-listingDateMode"]:checked') || {}).value || 'today';
      var result = {
        'ä»•å…¥æ—¥_ä»Šæ—¥': procureDateMode === 'today',
        'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥æ—¥': (document.getElementById('cfg-ä»•å…¥æ—¥') || {}).value || '',
        'å‡ºå“æ—¥_ä»Šæ—¥': listingDateMode === 'today',
        'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“æ—¥': (document.getElementById('cfg-å‡ºå“æ—¥') || {}).value || ''
      };
      var supplier = (document.getElementById('cfg-ä»•å…¥å…ˆ') || {}).value || '';
      if (supplier) result['ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥å…ˆ'] = supplier;
      var salesChannel = (document.getElementById('cfg-å‡ºå“å…ˆ') || {}).value || '';
      if (salesChannel) result['ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“å…ˆ'] = salesChannel;
      return result;
    }

    // ============================================
    // Condition Buttons
    // ============================================

    function cfgRenderConditionButtons(buttons) {
      var container = document.getElementById('cfg-conditionButtonsContainer');
      if (!container) return;
      container.innerHTML = '';

      // buttons: [{å•†å“ã®çŠ¶æ…‹, ãƒœã‚¿ãƒ³ãƒ©ãƒ™ãƒ«, ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ}, ...] (é…åˆ—) or null
      // çŠ¶æ…‹åˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      var grouped = {};
      if (buttons && Array.isArray(buttons) && buttons.length > 0) {
        buttons.forEach(function(btn) {
          var state = btn['å•†å“ã®çŠ¶æ…‹'] || btn['å•†å“ã®çŠ¶æ…‹'] || '';
          if (!state) return;
          if (!grouped[state]) grouped[state] = [];
          grouped[state].push({
            label: btn['ãƒœã‚¿ãƒ³ãƒ©ãƒ™ãƒ«'] || btn['ãƒ©ãƒ™ãƒ«'] || '',
            text: btn['ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ'] || btn['ãƒ†ã‚­ã‚¹ãƒˆ'] || ''
          });
        });
      }

      _cfg_CONDITION_STATES.forEach(function(state) {
        var stateKey = state.value;
        var safeId = stateKey.replace(/[ã€ãƒ»]/g, '');
        var items = grouped[stateKey] || [];
        var isOpen = items.length > 0;

        var section = document.createElement('div');
        section.style.cssText = 'border: 1px solid #e5e7eb; border-radius: 10px; overflow: hidden;';

        // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼
        var header = document.createElement('div');
        header.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; cursor: pointer; background: ' + state.color + '12;';
        header.onclick = function() { cfgToggleConditionAccordion(safeId); };
        header.innerHTML =
          '<div style="display: flex; align-items: center; gap: 8px;">' +
            '<span style="width: 10px; height: 10px; border-radius: 50%; background: ' + state.color + '; display: inline-block;"></span>' +
            '<span style="font-size: 13px; font-weight: 600; color: #1f2937;">' + state.label + '</span>' +
            '<span id="cfg-condition-count-' + safeId + '" style="font-size: 11px; color: #6b7280;">(' + items.length + 'ä»¶)</span>' +
          '</div>' +
          '<div style="display: flex; align-items: center; gap: 8px;">' +
            '<button type="button" onclick="event.stopPropagation(); cfgAddConditionButton(\'' + stateKey + '\')" style="background: ' + state.color + '; color: white; border: none; border-radius: 6px; padding: 4px 10px; font-size: 11px; cursor: pointer;"><i class="bi bi-plus-lg"></i> è¿½åŠ </button>' +
            '<i id="cfg-condition-chevron-' + safeId + '" class="bi bi-chevron-' + (isOpen ? 'up' : 'down') + '" style="color: #6b7280; font-size: 14px;"></i>' +
          '</div>';
        section.appendChild(header);

        // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒœãƒ‡ã‚£
        var body = document.createElement('div');
        body.id = 'cfg-condition-' + safeId;
        body.style.cssText = 'padding: 8px 12px; display: ' + (isOpen ? 'flex' : 'none') + '; flex-direction: column; gap: 6px;';
        body.dataset.state = stateKey;

        items.forEach(function(item, idx) {
          body.appendChild(cfgCreateConditionButtonItem(stateKey, idx, item.label, item.text));
        });

        section.appendChild(body);
        container.appendChild(section);
      });
    }

    function cfgCreateConditionButtonItem(state, index, label, text) {
      var item = document.createElement('div');
      item.style.cssText = 'display: flex; align-items: flex-start; gap: 6px; padding: 10px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px;';
      item.dataset.condIndex = index;
      item.dataset.condState = state;

      item.innerHTML =
        '<div style="flex: 1; display: flex; flex-direction: column; gap: 6px;">' +
          '<div>' +
            '<div style="font-size: 11px; color: #6b7280; margin-bottom: 2px;">ãƒœã‚¿ãƒ³å</div>' +
            '<input type="text" class="cfg-cond-label form-control" value="' + (label || '').replace(/"/g, '&quot;') + '" placeholder="ä¾‹: ã‚¿ã‚°ä»˜ãæœªä½¿ç”¨" style="font-size: 13px; font-weight: 500; padding: 6px 10px;">' +
          '</div>' +
          '<div>' +
            '<div style="font-size: 11px; color: #6b7280; margin-bottom: 2px;">æŒ¿å…¥ãƒ†ã‚­ã‚¹ãƒˆ</div>' +
            '<input type="text" class="cfg-cond-text form-control" value="' + (text || '').replace(/"/g, '&quot;') + '" placeholder="ä¾‹: ã‚¿ã‚°ä»˜ãæœªä½¿ç”¨å“ã§ã™ã€‚" style="font-size: 12px; padding: 6px 10px;">' +
          '</div>' +
        '</div>' +
        '<button type="button" onclick="cfgRemoveConditionButton(\'' + state + '\', this)" style="background: none; border: none; color: #ef4444; font-size: 16px; cursor: pointer; padding: 4px; margin-top: 12px;"><i class="bi bi-x-lg"></i></button>';

      return item;
    }

    function cfgToggleConditionAccordion(safeId) {
      var body = document.getElementById('cfg-condition-' + safeId);
      var chevron = document.getElementById('cfg-condition-chevron-' + safeId);
      if (!body) return;
      var isHidden = body.style.display === 'none';
      body.style.display = isHidden ? 'flex' : 'none';
      if (chevron) {
        chevron.className = 'bi bi-chevron-' + (isHidden ? 'up' : 'down');
      }
    }
    window.cfgToggleConditionAccordion = cfgToggleConditionAccordion;

    function cfgAddConditionButton(state) {
      var safeId = state.replace(/[ã€ãƒ»]/g, '');
      var body = document.getElementById('cfg-condition-' + safeId);
      if (!body) return;
      // è¡¨ç¤ºã‚’é–‹ã
      body.style.display = 'flex';
      var chevron = document.getElementById('cfg-condition-chevron-' + safeId);
      if (chevron) chevron.className = 'bi bi-chevron-up';
      var index = body.children.length;
      body.appendChild(cfgCreateConditionButtonItem(state, index, '', ''));
      // ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
      var countEl = document.getElementById('cfg-condition-count-' + safeId);
      if (countEl) countEl.textContent = '(' + (index + 1) + 'ä»¶)';
    }
    window.cfgAddConditionButton = cfgAddConditionButton;

    function cfgRemoveConditionButton(state, btn) {
      var item = btn.closest('[data-cond-index]');
      if (!item) return;
      var safeId = state.replace(/[ã€ãƒ»]/g, '');
      item.remove();
      // ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
      var body = document.getElementById('cfg-condition-' + safeId);
      if (body) {
        Array.from(body.children).forEach(function(child, i) {
          child.dataset.condIndex = i;
        });
        var countEl = document.getElementById('cfg-condition-count-' + safeId);
        if (countEl) countEl.textContent = '(' + body.children.length + 'ä»¶)';
      }
    }
    window.cfgRemoveConditionButton = cfgRemoveConditionButton;

    function cfgCollectConditionButtons() {
      var result = [];
      _cfg_CONDITION_STATES.forEach(function(state) {
        var safeId = state.value.replace(/[ã€ãƒ»]/g, '');
        var body = document.getElementById('cfg-condition-' + safeId);
        if (!body) return;
        body.querySelectorAll('[data-cond-index]').forEach(function(item) {
          var label = (item.querySelector('.cfg-cond-label') || {}).value || '';
          var text = (item.querySelector('.cfg-cond-text') || {}).value || '';
          label = label.trim();
          text = text.trim();
          if (label || text) {
            result.push({
              'å•†å“ã®çŠ¶æ…‹': state.value,
              'ãƒœã‚¿ãƒ³ãƒ©ãƒ™ãƒ«': label,
              'ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ': text
            });
          }
        });
      });
      return result;
    }

    // ============================================
    // Hashtag Config
    // ============================================

    // ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚¿ã‚¤ãƒ—å®šç¾©
    var CFG_HASHTAG_TYPES = {
      'å…¨å•†å“': { icon: 'ğŸŒ', defaultSuffix: 'å…¨å•†å“' },
      'ãƒ–ãƒ©ãƒ³ãƒ‰': { icon: 'ğŸ‘”', defaultSuffix: '' },
      'ã‚«ãƒ†ã‚´ãƒª': { icon: 'ğŸ“', defaultSuffix: '' },
      'ã‚«ãƒ©ãƒ¼': { icon: 'ğŸ¨', defaultSuffix: '' },
      'ã‚µã‚¤ã‚º': { icon: 'ğŸ“', defaultSuffix: '' }
    };

    // ã‚«ãƒ†ã‚´ãƒªã‚ªãƒ—ã‚·ãƒ§ãƒ³å®šç¾©
    var CFG_CATEGORY_OPTIONS = ['å¤§åˆ†é¡', 'ä¸­åˆ†é¡', 'å°åˆ†é¡', 'ç´°åˆ†é¡1', 'ç´°åˆ†é¡2', 'ã‚¢ã‚¤ãƒ†ãƒ å'];

    function cfgRenderHashtagConfig(config) {
      var container = document.getElementById('cfg-hashtagItemsContainer');
      if (!container) return;
      container.innerHTML = '';

      // å…±é€šãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹å¾©å…ƒï¼ˆ#ã‚’é™¤å»ã—ã¦è¡¨ç¤ºï¼‰
      var prefixInput = document.getElementById('cfg-hashtagCommonPrefix');
      if (prefixInput && config && config.commonPrefix) {
        var p = config.commonPrefix;
        // å…ˆé ­ã®#ã‚’é™¤å»
        if (p.charAt(0) === '#') p = p.substring(1);
        prefixInput.value = p;
      }

      if (!config || !config.hashtags || !Array.isArray(config.hashtags)) return;

      config.hashtags.forEach(function(item, idx) {
        var itemEl = cfgCreateHashtagItem(idx, item);
        container.appendChild(itemEl);
      });

      cfgUpdateAllHashtagPreviews();
    }

    function cfgCreateHashtagItem(index, data) {
      var title = data.title || 'å…¨å•†å“';
      var icon = data.icon || (CFG_HASHTAG_TYPES[title] ? CFG_HASHTAG_TYPES[title].icon : 'ğŸ·ï¸');
      var suffix = data.suffix || '';
      var categoryOptions = data.categoryOptions || [];

      var div = document.createElement('div');
      div.className = 'cfg-card';
      div.style.cssText = 'padding: 12px; margin-bottom: 8px; border: 1px solid #e5e7eb;';
      div.dataset.hashtagIndex = index;

      // ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹é¸æŠè‚¢ï¼ˆã‚¿ã‚¤ãƒ—åˆ¥ï¼‰
      var suffixSelectHtml = '';
      if (title === 'å…¨å•†å“') {
        suffixSelectHtml = '<select class="cfg-hashtag-suffix-select form-control" style="font-size: 12px; max-width: 160px;" onchange="cfgHandleHashtagItemSuffixChange(' + index + ')">' +
          '<option value="å…¨å•†å“"' + (suffix === 'å…¨å•†å“' ? ' selected' : '') + '>å…¨å•†å“</option>' +
          '<option value="æ–°ç€"' + (suffix === 'æ–°ç€' ? ' selected' : '') + '>æ–°ç€</option>' +
          '<option value="custom"' + (suffix !== 'å…¨å•†å“' && suffix !== 'æ–°ç€' && suffix !== '' ? ' selected' : '') + '>ã‚«ã‚¹ã‚¿ãƒ </option>' +
          '</select>' +
          '<input type="text" class="cfg-hashtag-suffix-custom form-control" placeholder="ã‚«ã‚¹ã‚¿ãƒ å€¤" value="' + (suffix !== 'å…¨å•†å“' && suffix !== 'æ–°ç€' ? suffix : '') + '" style="font-size: 12px; max-width: 140px; display: ' + (suffix !== 'å…¨å•†å“' && suffix !== 'æ–°ç€' && suffix !== '' ? 'block' : 'none') + ';" oninput="cfgUpdateHashtagItemPreview(' + index + ')">';
      } else if (title === 'ãƒ–ãƒ©ãƒ³ãƒ‰') {
        suffixSelectHtml = '<select class="cfg-hashtag-suffix-select form-control" style="font-size: 12px; max-width: 160px;" onchange="cfgHandleHashtagItemSuffixChange(' + index + ')">' +
          '<option value=""' + (suffix === '' ? ' selected' : '') + '>ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ãªã—</option>' +
          '<option value="ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§"' + (suffix === 'ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§' ? ' selected' : '') + '>ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§</option>' +
          '<option value="custom"' + (suffix !== '' && suffix !== 'ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§' ? ' selected' : '') + '>ã‚«ã‚¹ã‚¿ãƒ </option>' +
          '</select>' +
          '<input type="text" class="cfg-hashtag-suffix-custom form-control" placeholder="ã‚«ã‚¹ã‚¿ãƒ å€¤" value="' + (suffix !== '' && suffix !== 'ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§' ? suffix : '') + '" style="font-size: 12px; max-width: 140px; display: ' + (suffix !== '' && suffix !== 'ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§' ? 'block' : 'none') + ';" oninput="cfgUpdateHashtagItemPreview(' + index + ')">';
      } else if (title === 'ã‚«ãƒ†ã‚´ãƒª') {
        suffixSelectHtml = '<select class="cfg-hashtag-suffix-select form-control" style="font-size: 12px; max-width: 160px;" onchange="cfgHandleHashtagItemSuffixChange(' + index + ')">' +
          '<option value=""' + (suffix === '' ? ' selected' : '') + '>ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ãªã—</option>' +
          '<option value="ä¸€è¦§"' + (suffix === 'ä¸€è¦§' ? ' selected' : '') + '>ä¸€è¦§</option>' +
          '<option value="custom"' + (suffix !== '' && suffix !== 'ä¸€è¦§' ? ' selected' : '') + '>ã‚«ã‚¹ã‚¿ãƒ </option>' +
          '</select>' +
          '<input type="text" class="cfg-hashtag-suffix-custom form-control" placeholder="ã‚«ã‚¹ã‚¿ãƒ å€¤" value="' + (suffix !== '' && suffix !== 'ä¸€è¦§' ? suffix : '') + '" style="font-size: 12px; max-width: 140px; display: ' + (suffix !== '' && suffix !== 'ä¸€è¦§' ? 'block' : 'none') + ';" oninput="cfgUpdateHashtagItemPreview(' + index + ')">';
      } else {
        suffixSelectHtml = '<select class="cfg-hashtag-suffix-select form-control" style="font-size: 12px; max-width: 160px;" onchange="cfgHandleHashtagItemSuffixChange(' + index + ')">' +
          '<option value=""' + (suffix === '' ? ' selected' : '') + '>ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ãªã—</option>' +
          '<option value="custom"' + (suffix !== '' ? ' selected' : '') + '>ã‚«ã‚¹ã‚¿ãƒ </option>' +
          '</select>' +
          '<input type="text" class="cfg-hashtag-suffix-custom form-control" placeholder="ã‚«ã‚¹ã‚¿ãƒ å€¤" value="' + suffix + '" style="font-size: 12px; max-width: 140px; display: ' + (suffix !== '' ? 'block' : 'none') + ';" oninput="cfgUpdateHashtagItemPreview(' + index + ')">';
      }

      // ã‚«ãƒ†ã‚´ãƒªã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆã‚«ãƒ†ã‚´ãƒªã‚¿ã‚¤ãƒ—ã®ã¿ï¼‰
      var categoryHtml = '';
      if (title === 'ã‚«ãƒ†ã‚´ãƒª') {
        categoryHtml = '<div style="margin-top: 8px; padding: 8px; background: #f9fafb; border-radius: 6px;">' +
          '<div style="font-size: 11px; font-weight: 600; color: #6b7280; margin-bottom: 4px;">çµåˆã™ã‚‹ã‚«ãƒ†ã‚´ãƒª:</div>' +
          '<div style="display: flex; flex-wrap: wrap; gap: 6px;">';
        CFG_CATEGORY_OPTIONS.forEach(function(opt) {
          var checked = categoryOptions.indexOf(opt) >= 0 ? ' checked' : '';
          categoryHtml += '<label style="display: flex; align-items: center; gap: 3px; font-size: 12px; cursor: pointer;">' +
            '<input type="checkbox" class="cfg-hashtag-category-opt" value="' + opt + '"' + checked + ' onchange="cfgUpdateHashtagItemPreview(' + index + ')">' +
            opt + '</label>';
        });
        categoryHtml += '</div></div>';
      }

      div.innerHTML =
        '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">' +
          '<span style="font-size: 13px; font-weight: 600; color: #374151;">' + icon + ' ' + title + '</span>' +
          '<button type="button" onclick="cfgRemoveHashtagItem(' + index + ')" style="background: none; border: none; color: #ef4444; font-size: 16px; cursor: pointer; padding: 4px;"><i class="bi bi-x-lg"></i></button>' +
        '</div>' +
        '<div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">' +
          '<span style="font-size: 12px; color: #6b7280;">ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹:</span>' +
          suffixSelectHtml +
        '</div>' +
        categoryHtml +
        '<div class="cfg-hashtag-item-preview" style="margin-top: 6px; font-size: 11px; color: #0ea5e9;"></div>';

      return div;
    }

    function cfgShowHashtagTypeSelector() {
      var sel = document.getElementById('cfg-hashtagTypeSelector');
      if (sel) sel.style.display = 'block';
    }
    window.cfgShowHashtagTypeSelector = cfgShowHashtagTypeSelector;

    function cfgHideHashtagTypeSelector() {
      var sel = document.getElementById('cfg-hashtagTypeSelector');
      if (sel) sel.style.display = 'none';
    }
    window.cfgHideHashtagTypeSelector = cfgHideHashtagTypeSelector;

    function cfgAddHashtagItemByType(type) {
      cfgHideHashtagTypeSelector();
      var container = document.getElementById('cfg-hashtagItemsContainer');
      if (!container) return;

      var typeDef = CFG_HASHTAG_TYPES[type] || { icon: 'ğŸ·ï¸', defaultSuffix: '' };
      var newItem = {
        title: type,
        icon: typeDef.icon,
        suffix: typeDef.defaultSuffix,
        categoryOptions: type === 'ã‚«ãƒ†ã‚´ãƒª' ? ['å¤§åˆ†é¡', 'ä¸­åˆ†é¡'] : []
      };

      var index = container.children.length;
      var itemEl = cfgCreateHashtagItem(index, newItem);
      container.appendChild(itemEl);
      cfgUpdateHashtagItemPreview(index);
    }
    window.cfgAddHashtagItemByType = cfgAddHashtagItemByType;

    function cfgRemoveHashtagItem(index) {
      var container = document.getElementById('cfg-hashtagItemsContainer');
      if (!container) return;
      var item = container.querySelector('[data-hashtag-index="' + index + '"]');
      if (item) {
        item.remove();
        cfgReindexHashtagItems();
        cfgUpdateAllHashtagPreviews();
      }
    }
    window.cfgRemoveHashtagItem = cfgRemoveHashtagItem;

    function cfgReindexHashtagItems() {
      var container = document.getElementById('cfg-hashtagItemsContainer');
      if (!container) return;
      var items = container.querySelectorAll('[data-hashtag-index]');
      items.forEach(function(item, newIdx) {
        item.dataset.hashtagIndex = newIdx;
        // onclickå±æ€§ã‚’æ›´æ–°
        var removeBtn = item.querySelector('button[onclick*="cfgRemoveHashtagItem"]');
        if (removeBtn) removeBtn.setAttribute('onclick', 'cfgRemoveHashtagItem(' + newIdx + ')');
        var suffixSelect = item.querySelector('.cfg-hashtag-suffix-select');
        if (suffixSelect) suffixSelect.setAttribute('onchange', 'cfgHandleHashtagItemSuffixChange(' + newIdx + ')');
        var suffixCustom = item.querySelector('.cfg-hashtag-suffix-custom');
        if (suffixCustom) suffixCustom.setAttribute('oninput', 'cfgUpdateHashtagItemPreview(' + newIdx + ')');
        item.querySelectorAll('.cfg-hashtag-category-opt').forEach(function(cb) {
          cb.setAttribute('onchange', 'cfgUpdateHashtagItemPreview(' + newIdx + ')');
        });
      });
    }

    function cfgHandleHashtagItemSuffixChange(index) {
      var container = document.getElementById('cfg-hashtagItemsContainer');
      if (!container) return;
      var item = container.querySelector('[data-hashtag-index="' + index + '"]');
      if (!item) return;
      var sel = item.querySelector('.cfg-hashtag-suffix-select');
      var custom = item.querySelector('.cfg-hashtag-suffix-custom');
      if (!sel || !custom) return;
      custom.style.display = sel.value === 'custom' ? 'block' : 'none';
      cfgUpdateHashtagItemPreview(index);
    }
    window.cfgHandleHashtagItemSuffixChange = cfgHandleHashtagItemSuffixChange;

    function cfgUpdateHashtagItemPreview(index) {
      var container = document.getElementById('cfg-hashtagItemsContainer');
      if (!container) return;
      var item = container.querySelector('[data-hashtag-index="' + index + '"]');
      if (!item) return;
      var previewEl = item.querySelector('.cfg-hashtag-item-preview');
      if (!previewEl) return;

      var prefixInput = document.getElementById('cfg-hashtagCommonPrefix');
      var rawPrefix = prefixInput ? prefixInput.value.trim() : '';
      var prefix = '#' + rawPrefix;

      var sel = item.querySelector('.cfg-hashtag-suffix-select');
      var custom = item.querySelector('.cfg-hashtag-suffix-custom');
      var suffix = '';
      if (sel) {
        suffix = sel.value === 'custom' ? (custom ? custom.value.trim() : '') : sel.value;
      }

      // ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
      var titleEl = item.querySelector('span[style*="font-weight: 600"]');
      var titleText = titleEl ? titleEl.textContent.replace(/^[^\s]+\s/, '') : '';

      var previewText = prefix;
      if (titleText === 'ãƒ–ãƒ©ãƒ³ãƒ‰') {
        previewText += 'ãƒ–ãƒ©ãƒ³ãƒ‰å' + suffix;
      } else if (titleText === 'ã‚«ãƒ†ã‚´ãƒª') {
        var catOpts = [];
        item.querySelectorAll('.cfg-hashtag-category-opt:checked').forEach(function(cb) {
          catOpts.push(cb.value);
        });
        previewText += (catOpts.length > 0 ? catOpts.join('+') : 'ã‚«ãƒ†ã‚´ãƒª') + suffix;
      } else if (titleText === 'ã‚«ãƒ©ãƒ¼') {
        previewText += 'ã‚«ãƒ©ãƒ¼å' + suffix;
      } else if (titleText === 'ã‚µã‚¤ã‚º') {
        previewText += 'ã‚µã‚¤ã‚ºå' + suffix;
      } else {
        previewText += suffix;
      }

      previewEl.textContent = 'â†’ ' + previewText;

      // å…¨ä½“ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚æ›´æ–°
      cfgUpdateHashtagGlobalPreview();
    }
    window.cfgUpdateHashtagItemPreview = cfgUpdateHashtagItemPreview;

    function cfgUpdateAllHashtagPreviews() {
      var container = document.getElementById('cfg-hashtagItemsContainer');
      if (!container) return;
      container.querySelectorAll('[data-hashtag-index]').forEach(function(item) {
        var idx = parseInt(item.dataset.hashtagIndex);
        cfgUpdateHashtagItemPreview(idx);
      });
    }
    window.cfgUpdateAllHashtagPreviews = cfgUpdateAllHashtagPreviews;

    function cfgUpdateHashtagGlobalPreview() {
      var preview = document.getElementById('cfg-hashtagPreview');
      if (!preview) return;
      var container = document.getElementById('cfg-hashtagItemsContainer');
      if (!container) { preview.textContent = 'ï¼ˆãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°æœªè¨­å®šï¼‰'; return; }

      var prefixInput = document.getElementById('cfg-hashtagCommonPrefix');
      var rawPrefix = prefixInput ? prefixInput.value.trim() : '';
      var prefix = '#' + rawPrefix;

      var lines = [];
      container.querySelectorAll('[data-hashtag-index]').forEach(function(item) {
        var sel = item.querySelector('.cfg-hashtag-suffix-select');
        var custom = item.querySelector('.cfg-hashtag-suffix-custom');
        var suffix = '';
        if (sel) {
          suffix = sel.value === 'custom' ? (custom ? custom.value.trim() : '') : sel.value;
        }

        var titleEl = item.querySelector('span[style*="font-weight: 600"]');
        var titleText = titleEl ? titleEl.textContent.replace(/^[^\s]+\s/, '') : '';

        if (titleText === 'ãƒ–ãƒ©ãƒ³ãƒ‰') {
          lines.push(prefix + '[ãƒ–ãƒ©ãƒ³ãƒ‰å]' + suffix);
        } else if (titleText === 'ã‚«ãƒ†ã‚´ãƒª') {
          var catOpts = [];
          item.querySelectorAll('.cfg-hashtag-category-opt:checked').forEach(function(cb) {
            catOpts.push(cb.value);
          });
          lines.push(prefix + '[' + (catOpts.length > 0 ? catOpts.join('+') : 'ã‚«ãƒ†ã‚´ãƒª') + ']' + suffix);
        } else if (titleText === 'ã‚«ãƒ©ãƒ¼') {
          lines.push(prefix + '[ã‚«ãƒ©ãƒ¼å]' + suffix);
        } else if (titleText === 'ã‚µã‚¤ã‚º') {
          lines.push(prefix + '[ã‚µã‚¤ã‚ºå]' + suffix);
        } else {
          lines.push(prefix + suffix);
        }
      });

      preview.textContent = lines.length > 0 ? lines.join('\n') : 'ï¼ˆãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°æœªè¨­å®šï¼‰';
    }

    function cfgCollectHashtagConfig() {
      var prefixInput = document.getElementById('cfg-hashtagCommonPrefix');
      var rawPrefix = prefixInput ? prefixInput.value.trim() : '';
      // #ã‚’ä»˜åŠ ã—ã¦ä¿å­˜ï¼ˆproduct-scripts.jsãŒæœŸå¾…ã™ã‚‹å½¢å¼ï¼‰
      var commonPrefix = '#' + rawPrefix;

      var hashtags = [];
      var container = document.getElementById('cfg-hashtagItemsContainer');
      if (container) {
        container.querySelectorAll('[data-hashtag-index]').forEach(function(item) {
          var titleEl = item.querySelector('span[style*="font-weight: 600"]');
          var title = titleEl ? titleEl.textContent.replace(/^[^\s]+\s/, '') : '';

          var iconMatch = titleEl ? titleEl.textContent.match(/^([^\s]+)/) : null;
          var icon = iconMatch ? iconMatch[1] : 'ğŸ·ï¸';

          var sel = item.querySelector('.cfg-hashtag-suffix-select');
          var custom = item.querySelector('.cfg-hashtag-suffix-custom');
          var suffix = '';
          if (sel) {
            suffix = sel.value === 'custom' ? (custom ? custom.value.trim() : '') : sel.value;
          }

          var hashtagObj = {
            title: title,
            icon: icon,
            suffix: suffix
          };

          // ã‚«ãƒ†ã‚´ãƒªã®å ´åˆã¯categoryOptionsã‚’åé›†
          if (title === 'ã‚«ãƒ†ã‚´ãƒª') {
            var categoryOptions = [];
            item.querySelectorAll('.cfg-hashtag-category-opt:checked').forEach(function(cb) {
              categoryOptions.push(cb.value);
            });
            hashtagObj.categoryOptions = categoryOptions;
          }

          hashtags.push(hashtagObj);
        });
      }

      return { commonPrefix: commonPrefix, hashtags: hashtags };
    }

    // ============================================
    // Discount Config
    // ============================================

    // å‰²å¼•ã‚¿ã‚¤ãƒ—å®šç¾©
    var CFG_DISCOUNT_ICONS = {
      'ãƒ•ã‚©ãƒ­ãƒ¼å‰²': 'ğŸ¤',
      'ãƒªãƒ”ãƒ¼ãƒˆå‰²': 'ğŸ”„',
      'ã¾ã¨ã‚å‰²': 'ğŸ“¦'
    };

    var CFG_DEFAULT_DISCOUNT_TYPES = ['ãƒ•ã‚©ãƒ­ãƒ¼å‰²', 'ãƒªãƒ”ãƒ¼ãƒˆå‰²', 'ã¾ã¨ã‚å‰²'];

    function cfgRenderDiscountConfig(config) {
      var container = document.getElementById('cfg-discountTypesList');
      if (!container) return;
      container.innerHTML = '';

      if (!config) return;

      // ã‚¿ã‚¤ãƒˆãƒ«å¾©å…ƒ
      var titleSelect = document.getElementById('cfg-discountTitleSelect');
      var titleCustom = document.getElementById('cfg-discountTitleCustom');
      if (titleSelect && config['ã‚¿ã‚¤ãƒˆãƒ«']) {
        var titleVal = config['ã‚¿ã‚¤ãƒˆãƒ«'];
        var found = false;
        for (var i = 0; i < titleSelect.options.length; i++) {
          if (titleSelect.options[i].value === titleVal) {
            titleSelect.value = titleVal;
            found = true;
            break;
          }
        }
        if (!found) {
          titleSelect.value = 'custom';
          if (titleCustom) {
            titleCustom.value = titleVal;
            titleCustom.style.display = 'block';
          }
        }
      }

      // å‰²å¼•ã‚¿ã‚¤ãƒ—é †åºã‹ã‚‰å¾©å…ƒ
      var typeOrder = config['å‰²å¼•ã‚¿ã‚¤ãƒ—é †åº'] || [];
      // é †åºãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé †ã§ã‚­ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
      if (typeOrder.length === 0) {
        CFG_DEFAULT_DISCOUNT_TYPES.forEach(function(t) {
          if (config[t] && config[t].length > 0) typeOrder.push(t);
        });
      }

      typeOrder.forEach(function(typeName) {
        var icon = config[typeName + '_ã‚¢ã‚¤ã‚³ãƒ³'] || CFG_DISCOUNT_ICONS[typeName] || 'ğŸ’°';
        var ranges = config[typeName] || [];
        var description = config[typeName + '_èª¬æ˜æ–‡'] || '';
        var block = cfgCreateDiscountTypeBlock(typeName, icon, ranges, description);
        container.appendChild(block);
      });

      cfgUpdateDiscountPreview();
    }

    function cfgCreateDiscountTypeBlock(typeName, icon, ranges, description) {
      var div = document.createElement('div');
      div.className = 'cfg-card';
      div.style.cssText = 'padding: 12px; margin-bottom: 8px; border: 1px solid #e5e7eb;';
      div.dataset.discountType = typeName;

      var isRepeat = typeName === 'ãƒªãƒ”ãƒ¼ãƒˆå‰²';

      // ç¯„å›²+å‰²å¼•é¡ã®è¡Œã‚’ç”Ÿæˆ
      var rangesHtml = '';
      if (ranges.length === 0) {
        ranges = isRepeat ? [{ å‰²å¼•é¡: '' }] : [{ ç¯„å›²: '', å‰²å¼•é¡: '' }];
      }
      ranges.forEach(function(r, rIdx) {
        rangesHtml += cfgCreateDiscountRangeItemHtml(typeName, rIdx, r['ç¯„å›²'] || '', r['å‰²å¼•é¡'] || '', isRepeat);
      });

      div.innerHTML =
        '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">' +
          '<span style="font-size: 13px; font-weight: 600; color: #374151;">' + icon + ' ' + typeName + '</span>' +
          '<button type="button" onclick="cfgRemoveDiscountType(\'' + typeName + '\')" style="background: none; border: none; color: #ef4444; font-size: 16px; cursor: pointer; padding: 4px;"><i class="bi bi-x-lg"></i></button>' +
        '</div>' +
        '<div class="cfg-discount-ranges">' + rangesHtml + '</div>' +
        (isRepeat ? '' : '<button type="button" onclick="cfgAddDiscountRange(\'' + typeName + '\')" style="margin-top: 4px; padding: 4px 10px; background: #f9fafb; color: #6b7280; border: 1px dashed #d1d5db; border-radius: 6px; font-size: 11px; cursor: pointer;"><i class="bi bi-plus"></i> ç¯„å›²è¿½åŠ </button>') +
        '<div style="margin-top: 8px;">' +
          '<label style="font-size: 11px; color: #6b7280;">èª¬æ˜æ–‡ï¼ˆä»»æ„ï¼‰:</label>' +
          '<input type="text" class="cfg-discount-description form-control" value="' + (description || '').replace(/"/g, '&quot;') + '" placeholder="ä¾‹: ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ãŸã ãã ã‘ã§å‰²å¼•ï¼" style="font-size: 12px;" oninput="cfgUpdateDiscountPreview()">' +
        '</div>';

      return div;
    }

    function cfgCreateDiscountRangeItemHtml(typeName, index, range, amount, isRepeat) {
      if (isRepeat) {
        return '<div class="cfg-discount-range-row" style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px;">' +
          '<span style="font-size: 12px; color: #6b7280; white-space: nowrap;">å‰²å¼•é¡:</span>' +
          '<input type="text" class="cfg-discount-amount form-control" value="' + amount + '" placeholder="ä¾‹: 100å††å¼•ã" style="font-size: 12px; flex: 1;" oninput="cfgUpdateDiscountPreview()">' +
        '</div>';
      }
      return '<div class="cfg-discount-range-row" style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px;">' +
        '<input type="text" class="cfg-discount-range form-control" value="' + range + '" placeholder="ä¾‹: 3000å††ä»¥ä¸Š" style="font-size: 12px; flex: 1;" oninput="cfgUpdateDiscountPreview()">' +
        '<span style="font-size: 12px; color: #6b7280;">â‡’</span>' +
        '<input type="text" class="cfg-discount-amount form-control" value="' + amount + '" placeholder="ä¾‹: 100å††å¼•ã" style="font-size: 12px; flex: 1;" oninput="cfgUpdateDiscountPreview()">' +
        '<button type="button" onclick="cfgRemoveDiscountRange(\'' + typeName + '\',' + index + ')" style="background: none; border: none; color: #ef4444; font-size: 16px; cursor: pointer; padding: 4px;"><i class="bi bi-x-lg"></i></button>' +
      '</div>';
    }

    function cfgAddDiscountRange(typeName) {
      var container = document.getElementById('cfg-discountTypesList');
      if (!container) return;
      var typeBlock = container.querySelector('[data-discount-type="' + typeName + '"]');
      if (!typeBlock) return;
      var rangesDiv = typeBlock.querySelector('.cfg-discount-ranges');
      if (!rangesDiv) return;
      var idx = rangesDiv.querySelectorAll('.cfg-discount-range-row').length;
      rangesDiv.insertAdjacentHTML('beforeend', cfgCreateDiscountRangeItemHtml(typeName, idx, '', '', false));
    }
    window.cfgAddDiscountRange = cfgAddDiscountRange;

    function cfgRemoveDiscountRange(typeName, index) {
      var container = document.getElementById('cfg-discountTypesList');
      if (!container) return;
      var typeBlock = container.querySelector('[data-discount-type="' + typeName + '"]');
      if (!typeBlock) return;
      var rows = typeBlock.querySelectorAll('.cfg-discount-range-row');
      if (rows.length <= 1) return; // æœ€ä½1è¡Œã¯æ®‹ã™
      if (rows[index]) {
        rows[index].remove();
        cfgUpdateDiscountPreview();
      }
    }
    window.cfgRemoveDiscountRange = cfgRemoveDiscountRange;

    function cfgAddDiscountType() {
      var sel = document.getElementById('cfg-discountTypeSelector');
      if (sel) sel.style.display = 'block';
    }
    window.cfgAddDiscountType = cfgAddDiscountType;

    function cfgConfirmAddDiscountType(typeName) {
      var sel = document.getElementById('cfg-discountTypeSelector');
      if (sel) sel.style.display = 'none';

      // æ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      var container = document.getElementById('cfg-discountTypesList');
      if (!container) return;
      if (container.querySelector('[data-discount-type="' + typeName + '"]')) {
        alert(typeName + 'ã¯æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚');
        return;
      }

      var icon = CFG_DISCOUNT_ICONS[typeName] || 'ğŸ’°';
      var isRepeat = typeName === 'ãƒªãƒ”ãƒ¼ãƒˆå‰²';
      var defaultRanges = isRepeat ? [{ å‰²å¼•é¡: '' }] : [{ ç¯„å›²: '', å‰²å¼•é¡: '' }];
      var block = cfgCreateDiscountTypeBlock(typeName, icon, defaultRanges, '');
      container.appendChild(block);
      cfgUpdateDiscountPreview();
    }
    window.cfgConfirmAddDiscountType = cfgConfirmAddDiscountType;

    function cfgCancelAddDiscountType() {
      var sel = document.getElementById('cfg-discountTypeSelector');
      if (sel) sel.style.display = 'none';
    }
    window.cfgCancelAddDiscountType = cfgCancelAddDiscountType;

    function cfgRemoveDiscountType(typeName) {
      var container = document.getElementById('cfg-discountTypesList');
      if (!container) return;
      var typeBlock = container.querySelector('[data-discount-type="' + typeName + '"]');
      if (typeBlock) {
        typeBlock.remove();
        cfgUpdateDiscountPreview();
      }
    }
    window.cfgRemoveDiscountType = cfgRemoveDiscountType;

    function cfgHandleDiscountTitleChange() {
      var sel = document.getElementById('cfg-discountTitleSelect');
      var custom = document.getElementById('cfg-discountTitleCustom');
      if (!sel || !custom) return;
      custom.style.display = sel.value === 'custom' ? 'block' : 'none';
      cfgUpdateDiscountPreview();
    }
    window.cfgHandleDiscountTitleChange = cfgHandleDiscountTitleChange;

    function cfgUpdateDiscountPreview() {
      var preview = document.getElementById('cfg-discountPreview');
      if (!preview) return;

      // ã‚¿ã‚¤ãƒˆãƒ«å–å¾—
      var titleSelect = document.getElementById('cfg-discountTitleSelect');
      var titleCustom = document.getElementById('cfg-discountTitleCustom');
      var title = '';
      if (titleSelect) {
        title = titleSelect.value === 'custom' ? (titleCustom ? titleCustom.value.trim() : '') : titleSelect.value;
      }

      var container = document.getElementById('cfg-discountTypesList');
      if (!container || container.children.length === 0) {
        preview.textContent = 'ï¼ˆå‰²å¼•æœªè¨­å®šï¼‰';
        return;
      }

      var lines = [];
      if (title) lines.push(title);
      lines.push('');

      container.querySelectorAll('[data-discount-type]').forEach(function(typeBlock) {
        var typeName = typeBlock.dataset.discountType;
        var isRepeat = typeName === 'ãƒªãƒ”ãƒ¼ãƒˆå‰²';

        lines.push('â–  ' + typeName);

        if (isRepeat) {
          var amountInput = typeBlock.querySelector('.cfg-discount-amount');
          var amount = amountInput ? amountInput.value.trim() : '';
          if (amount) {
            lines.push('æ¬¡å›è³¼å…¥æ™‚ã«' + amount);
          }
        } else {
          typeBlock.querySelectorAll('.cfg-discount-range-row').forEach(function(row) {
            var rangeInput = row.querySelector('.cfg-discount-range');
            var amountInput = row.querySelector('.cfg-discount-amount');
            var range = rangeInput ? rangeInput.value.trim() : '';
            var amount = amountInput ? amountInput.value.trim() : '';
            if (range && amount) {
              lines.push(range + ' â‡’ ' + amount);
            }
          });
        }

        var descInput = typeBlock.querySelector('.cfg-discount-description');
        var desc = descInput ? descInput.value.trim() : '';
        if (desc) lines.push(desc);

        lines.push('');
      });

      preview.textContent = lines.join('\n').trim() || 'ï¼ˆå‰²å¼•æœªè¨­å®šï¼‰';
    }
    window.cfgUpdateDiscountPreview = cfgUpdateDiscountPreview;

    function cfgCollectDiscountConfig() {
      var titleSelect = document.getElementById('cfg-discountTitleSelect');
      var titleCustom = document.getElementById('cfg-discountTitleCustom');
      var title = '';
      if (titleSelect) {
        title = titleSelect.value === 'custom' ? (titleCustom ? titleCustom.value.trim() : '') : titleSelect.value;
      }

      var result = {
        'ã‚¿ã‚¤ãƒˆãƒ«': title || 'ã€ãŠå¾—ãªå‰²å¼•æƒ…å ±ã€‘',
        'å‰²å¼•ã‚¿ã‚¤ãƒ—é †åº': []
      };

      var container = document.getElementById('cfg-discountTypesList');
      if (!container) return result;

      container.querySelectorAll('[data-discount-type]').forEach(function(typeBlock) {
        var typeName = typeBlock.dataset.discountType;
        var isRepeat = typeName === 'ãƒªãƒ”ãƒ¼ãƒˆå‰²';

        result['å‰²å¼•ã‚¿ã‚¤ãƒ—é †åº'].push(typeName);

        // ã‚¢ã‚¤ã‚³ãƒ³
        var titleEl = typeBlock.querySelector('span[style*="font-weight: 600"]');
        var iconMatch = titleEl ? titleEl.textContent.match(/^([^\s]+)/) : null;
        result[typeName + '_ã‚¢ã‚¤ã‚³ãƒ³'] = iconMatch ? iconMatch[1] : (CFG_DISCOUNT_ICONS[typeName] || 'ğŸ’°');

        // ç¯„å›²ãƒ‡ãƒ¼ã‚¿
        var ranges = [];
        typeBlock.querySelectorAll('.cfg-discount-range-row').forEach(function(row) {
          if (isRepeat) {
            var amountInput = row.querySelector('.cfg-discount-amount');
            ranges.push({ 'å‰²å¼•é¡': amountInput ? amountInput.value.trim() : '' });
          } else {
            var rangeInput = row.querySelector('.cfg-discount-range');
            var amountInput = row.querySelector('.cfg-discount-amount');
            ranges.push({
              'ç¯„å›²': rangeInput ? rangeInput.value.trim() : '',
              'å‰²å¼•é¡': amountInput ? amountInput.value.trim() : ''
            });
          }
        });
        result[typeName] = ranges;

        // èª¬æ˜æ–‡
        var descInput = typeBlock.querySelector('.cfg-discount-description');
        result[typeName + '_èª¬æ˜æ–‡'] = descInput ? descInput.value.trim() : '';
      });

      return result;
    }

    // ============================================
    // Salesword Config
    // ============================================

    // ---è¡¨ç¤ºå½¢å¼ ---

    function cfgHandlePrefixChange() {
      var sel = document.getElementById('cfg-saleswordPrefixSelect');
      var custom = document.getElementById('cfg-saleswordPrefixCustom');
      if (!sel || !custom) return;
      custom.style.display = sel.value === 'custom' ? 'block' : 'none';
      cfgUpdateSaleswordFormatPreview();
    }
    window.cfgHandlePrefixChange = cfgHandlePrefixChange;

    function cfgHandleSuffixChange() {
      var sel = document.getElementById('cfg-saleswordSuffixSelect');
      var custom = document.getElementById('cfg-saleswordSuffixCustom');
      if (!sel || !custom) return;
      custom.style.display = sel.value === 'custom' ? 'block' : 'none';
      cfgUpdateSaleswordFormatPreview();
    }
    window.cfgHandleSuffixChange = cfgHandleSuffixChange;

    function cfgGetCurrentPrefix() {
      var sel = document.getElementById('cfg-saleswordPrefixSelect');
      if (!sel) return '';
      if (sel.value === 'custom') {
        var custom = document.getElementById('cfg-saleswordPrefixCustom');
        return custom ? custom.value : '';
      }
      return sel.value;
    }

    function cfgGetCurrentSuffix() {
      var sel = document.getElementById('cfg-saleswordSuffixSelect');
      if (!sel) return '';
      if (sel.value === 'custom') {
        var custom = document.getElementById('cfg-saleswordSuffixCustom');
        return custom ? custom.value : '';
      }
      return sel.value;
    }

    function cfgUpdateSaleswordFormatPreview() {
      var preview = document.getElementById('cfg-saleswordFormatPreview');
      if (!preview) return;
      var prefix = cfgGetCurrentPrefix();
      var suffix = cfgGetCurrentSuffix();
      preview.textContent = (prefix || '') + 'ç¾å“' + (suffix || '');
    }
    window.cfgUpdateSaleswordFormatPreview = cfgUpdateSaleswordFormatPreview;

    // ãƒ¯ãƒ¼ãƒ‰åˆ¥å€‹åˆ¥è¨­å®š
    var _cfg_wordOverrides = [];

    function cfgAddWordOverride() {
      _cfg_wordOverrides.push({ category: '', word: '', prefix: '', suffix: '' });
      cfgRenderWordOverrides();
    }
    window.cfgAddWordOverride = cfgAddWordOverride;

    function cfgRemoveWordOverride(index) {
      _cfg_wordOverrides.splice(index, 1);
      cfgRenderWordOverrides();
    }
    window.cfgRemoveWordOverride = cfgRemoveWordOverride;

    var _cfgOvPrefixPresets = ['', 'ã€', 'ã€', 'ã€Œ', 'ï¼ˆ', 'â˜…', 'â˜†', 'â—†', 'â—‡', 'â– ', 'â–¡', 'â—', 'â—‹', 'â–¶', 'âœ¨', 'ğŸ”¥'];
    var _cfgOvSuffixPresets = ['', 'ã€‘', 'ã€', 'ã€', 'ï¼‰', 'â˜…', 'â˜†', 'â—†', 'â—‡', 'â– ', 'â–¡', 'â—', 'â—‹', 'â—€', 'âœ¨', 'ğŸ”¥'];

    function _cfgOvIsCustomPrefix(val) { return val && _cfgOvPrefixPresets.indexOf(val) === -1; }
    function _cfgOvIsCustomSuffix(val) { return val && _cfgOvSuffixPresets.indexOf(val) === -1; }

    function _cfgOvBuildPrefixOptions(current) {
      var isCustom = _cfgOvIsCustomPrefix(current);
      return _cfgOvPrefixPresets.map(function(v) {
        return '<option value="' + v + '"' + (!isCustom && v === current ? ' selected' : '') + '>' + (v || 'ãªã—') + '</option>';
      }).join('') + '<option value="custom"' + (isCustom ? ' selected' : '') + '>ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›...</option>';
    }

    function _cfgOvBuildSuffixOptions(current) {
      var isCustom = _cfgOvIsCustomSuffix(current);
      return _cfgOvSuffixPresets.map(function(v) {
        return '<option value="' + v + '"' + (!isCustom && v === current ? ' selected' : '') + '>' + (v || 'ãªã—') + '</option>';
      }).join('') + '<option value="custom"' + (isCustom ? ' selected' : '') + '>ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›...</option>';
    }

    function cfgOvPrefixChange(idx, sel) {
      var customInput = sel.parentNode.querySelector('.cfg-ov-prefix-custom');
      if (sel.value === 'custom') {
        customInput.style.display = '';
        customInput.focus();
        _cfg_wordOverrides[idx].prefix = customInput.value;
      } else {
        customInput.style.display = 'none';
        _cfg_wordOverrides[idx].prefix = sel.value;
      }
      cfgUpdateWordOverridePreview(idx);
    }
    window.cfgOvPrefixChange = cfgOvPrefixChange;

    function cfgOvSuffixChange(idx, sel) {
      var customInput = sel.parentNode.querySelector('.cfg-ov-suffix-custom');
      if (sel.value === 'custom') {
        customInput.style.display = '';
        customInput.focus();
        _cfg_wordOverrides[idx].suffix = customInput.value;
      } else {
        customInput.style.display = 'none';
        _cfg_wordOverrides[idx].suffix = sel.value;
      }
      cfgUpdateWordOverridePreview(idx);
    }
    window.cfgOvSuffixChange = cfgOvSuffixChange;

    function cfgRenderWordOverrides() {
      var container = document.getElementById('cfg-wordOverrideList');
      if (!container) return;
      container.innerHTML = '';

      _cfg_wordOverrides.forEach(function(ov, idx) {
        var categories = cfgGetSaleswordCategories();
        var catOptions = '<option value="">-- ã‚«ãƒ†ã‚´ãƒª --</option>' + categories.map(function(c) {
          return '<option value="' + c + '"' + (ov.category === c ? ' selected' : '') + '>' + c + '</option>';
        }).join('');

        var words = ov.category ? cfgGetSaleswordsByCategory(ov.category) : [];
        var wordOptions = '<option value="">-- ãƒ¯ãƒ¼ãƒ‰ --</option>' + words.map(function(w) {
          return '<option value="' + w + '"' + (ov.word === w ? ' selected' : '') + '>' + w + '</option>';
        }).join('');

        var previewText = (ov.prefix || '') + (ov.word || '...') + (ov.suffix || '');

        var div = document.createElement('div');
        div.style.cssText = 'background: #f8f9fa; padding: 14px; border-radius: 10px; position: relative;';
        div.innerHTML =
          '<button type="button" onclick="cfgRemoveWordOverride(' + idx + ')" style="position: absolute; top: 8px; right: 8px; background: none; border: none; color: #ef4444; font-size: 16px; cursor: pointer; padding: 4px; line-height: 1;" title="å‰Šé™¤"><i class="bi bi-x-lg"></i></button>' +
          '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">' +
            '<div>' +
              '<label style="font-size: 11px; color: #6b7280; display: block; margin-bottom: 3px;">ã‚«ãƒ†ã‚´ãƒª</label>' +
              '<select class="form-control cfg-ov-cat" data-idx="' + idx + '" style="font-size: 16px;" onchange="cfgHandleWordCategoryChange(' + idx + ', this.value)">' + catOptions + '</select>' +
            '</div>' +
            '<div>' +
              '<label style="font-size: 11px; color: #6b7280; display: block; margin-bottom: 3px;">ãƒ¯ãƒ¼ãƒ‰</label>' +
              '<select class="form-control cfg-ov-word" data-idx="' + idx + '" style="font-size: 16px;" onchange="_cfg_wordOverrides[' + idx + '].word = this.value; cfgUpdateWordOverridePreview(' + idx + ')">' + wordOptions + '</select>' +
            '</div>' +
          '</div>' +
          '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">' +
            '<div>' +
              '<label style="font-size: 11px; color: #6b7280; display: block; margin-bottom: 3px;">å‰è¨˜å·</label>' +
              '<select class="form-control cfg-ov-prefix-sel" data-idx="' + idx + '" style="font-size: 16px;" onchange="cfgOvPrefixChange(' + idx + ', this)">' +
                _cfgOvBuildPrefixOptions(ov.prefix) +
              '</select>' +
              '<input type="text" class="form-control cfg-ov-prefix-custom" data-idx="' + idx + '" value="' + (ov.prefix || '') + '" maxlength="5" placeholder="ã‚«ã‚¹ã‚¿ãƒ å‰è¨˜å·" style="font-size: 16px; text-align: center; margin-top: 4px;' + (_cfgOvIsCustomPrefix(ov.prefix) ? '' : ' display: none;') + '" oninput="_cfg_wordOverrides[' + idx + '].prefix = this.value; cfgUpdateWordOverridePreview(' + idx + ')">' +
            '</div>' +
            '<div>' +
              '<label style="font-size: 11px; color: #6b7280; display: block; margin-bottom: 3px;">å¾Œè¨˜å·</label>' +
              '<select class="form-control cfg-ov-suffix-sel" data-idx="' + idx + '" style="font-size: 16px;" onchange="cfgOvSuffixChange(' + idx + ', this)">' +
                _cfgOvBuildSuffixOptions(ov.suffix) +
              '</select>' +
              '<input type="text" class="form-control cfg-ov-suffix-custom" data-idx="' + idx + '" value="' + (ov.suffix || '') + '" maxlength="5" placeholder="ã‚«ã‚¹ã‚¿ãƒ å¾Œè¨˜å·" style="font-size: 16px; text-align: center; margin-top: 4px;' + (_cfgOvIsCustomSuffix(ov.suffix) ? '' : ' display: none;') + '" oninput="_cfg_wordOverrides[' + idx + '].suffix = this.value; cfgUpdateWordOverridePreview(' + idx + ')">' +
            '</div>' +
          '</div>' +
          '<div class="cfg-preview">' +
            '<div class="cfg-preview-label">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>' +
            '<div id="cfg-ovPreview-' + idx + '" class="cfg-preview-value">' + previewText + '</div>' +
          '</div>';
        container.appendChild(div);
      });
    }

    function cfgUpdateWordOverridePreview(index) {
      var ov = _cfg_wordOverrides[index];
      if (!ov) return;
      var el = document.getElementById('cfg-ovPreview-' + index);
      if (el) el.textContent = (ov.prefix || '') + (ov.word || '...') + (ov.suffix || '');
    }
    window.cfgUpdateWordOverridePreview = cfgUpdateWordOverridePreview;

    function cfgHandleWordCategoryChange(index, category) {
      _cfg_wordOverrides[index].category = category;
      _cfg_wordOverrides[index].word = '';
      cfgRenderWordOverrides();
    }
    window.cfgHandleWordCategoryChange = cfgHandleWordCategoryChange;

    // --- ã‚«ãƒ†ã‚´ãƒªãƒ»ãƒ¯ãƒ¼ãƒ‰ ãƒ˜ãƒ«ãƒ‘ãƒ¼ ---

    function cfgGetSaleswordCategories() {
      var cats = [];
      _cfg_SALESWORD_LIST.forEach(function(sw) {
        if (cats.indexOf(sw.category) === -1) cats.push(sw.category);
      });
      return cats;
    }

    function cfgGetSaleswordsByCategory(category) {
      return _cfg_SALESWORD_LIST.filter(function(sw) {
        return sw.category === category;
      }).map(function(sw) { return sw.name; });
    }

    // ---ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¯ãƒ¼ãƒ‰ ---

    function cfgInitDefaultSaleswordDropdowns() {
      var catSelect = document.getElementById('cfg-defaultSaleswordCategory');
      if (!catSelect) return;
      var categories = cfgGetSaleswordCategories();
      catSelect.innerHTML = '<option value="">-- ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ --</option>' +
        categories.map(function(c) {
          return '<option value="' + c + '">' + c + '</option>';
        }).join('');
    }

    function cfgUpdateDefaultSaleswordOptions() {
      var catSelect = document.getElementById('cfg-defaultSaleswordCategory');
      var wordSelect = document.getElementById('cfg-defaultSalesword');
      if (!catSelect || !wordSelect) return;
      var cat = catSelect.value;
      if (!cat) {
        wordSelect.innerHTML = '<option value="">-- ãƒ¯ãƒ¼ãƒ‰ã‚’é¸æŠ --</option>';
        return;
      }
      var words = cfgGetSaleswordsByCategory(cat);
      wordSelect.innerHTML = '<option value="">-- ãƒ¯ãƒ¼ãƒ‰ã‚’é¸æŠ --</option>' +
        words.map(function(w) {
          return '<option value="' + w + '">' + w + '</option>';
        }).join('');
    }
    window.cfgUpdateDefaultSaleswordOptions = cfgUpdateDefaultSaleswordOptions;

    // ---ã‚ˆãä½¿ã†ãƒ¯ãƒ¼ãƒ‰ ---

    var _cfg_saleswordFavorites = [];

    function cfgInitFavoriteSaleswordDropdowns() {
      var catSelect = document.getElementById('cfg-saleswordCategory');
      if (!catSelect) return;
      var categories = cfgGetSaleswordCategories();
      // ç‰¹æ®Šã‚«ãƒ†ã‚´ãƒªã€Œâ­ã‚ˆãä½¿ã†ãƒ¯ãƒ¼ãƒ‰ã€ã‚’å…ˆé ­ã«è¿½åŠ 
      catSelect.innerHTML = '<option value="">-- ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ --</option>' +
        '<option value="__favorites__">â­ ã‚ˆãä½¿ã†ãƒ¯ãƒ¼ãƒ‰</option>' +
        categories.map(function(c) {
          return '<option value="' + c + '">' + c + '</option>';
        }).join('');
    }

    function cfgUpdateSaleswordOptions() {
      var catSelect = document.getElementById('cfg-saleswordCategory');
      var wordSelect = document.getElementById('cfg-saleswordSelect');
      if (!catSelect || !wordSelect) return;
      var cat = catSelect.value;
      if (!cat) {
        wordSelect.innerHTML = '<option value="">-- ãƒ¯ãƒ¼ãƒ‰ã‚’é¸æŠ --</option>';
        return;
      }
      var words;
      if (cat === '__favorites__') {
        words = _cfg_saleswordFavorites;
      } else {
        words = cfgGetSaleswordsByCategory(cat);
      }
      wordSelect.innerHTML = '<option value="">-- ãƒ¯ãƒ¼ãƒ‰ã‚’é¸æŠ --</option>' +
        words.map(function(w) {
          return '<option value="' + w + '">' + w + '</option>';
        }).join('');
    }
    window.cfgUpdateSaleswordOptions = cfgUpdateSaleswordOptions;

    function cfgAddSaleswordFromDropdown() {
      var wordSelect = document.getElementById('cfg-saleswordSelect');
      if (!wordSelect || !wordSelect.value) {
        alert('è¿½åŠ ã™ã‚‹ãƒ¯ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      var word = wordSelect.value;
      // é‡è¤‡ãƒã‚§ãƒƒã‚¯
      if (_cfg_saleswordFavorites.indexOf(word) !== -1) {
        alert('ã€Œ' + word + 'ã€ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
        return;
      }
      _cfg_saleswordFavorites.push(word);
      cfgRenderSaleswordList();
      wordSelect.value = '';
    }
    window.cfgAddSaleswordFromDropdown = cfgAddSaleswordFromDropdown;

    function cfgRenderSaleswordList() {
      var container = document.getElementById('cfg-saleswordList');
      var emptyMsg = document.getElementById('cfg-saleswordEmptyMsg');
      if (!container) return;
      container.innerHTML = '';

      if (_cfg_saleswordFavorites.length === 0) {
        if (emptyMsg) emptyMsg.style.display = 'block';
        return;
      }
      if (emptyMsg) emptyMsg.style.display = 'none';

      _cfg_saleswordFavorites.forEach(function(word, idx) {
        var master = _cfg_SALESWORD_LIST.find(function(sw) { return sw.name === word; });
        var catLabel = master ? master.category : '';
        var div = document.createElement('div');
        div.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: #f9fafb; border-radius: 8px;';
        div.innerHTML =
          '<span style="flex: 1; font-size: 14px; font-weight: 500; color: #1f2937;">' + word +
            (catLabel ? ' <span style="font-size: 11px; color: #9ca3af;">(' + catLabel + ')</span>' : '') +
          '</span>' +
          '<button type="button" onclick="cfgRemoveSalesword(' + idx + ')" style="background: none; border: none; color: #ef4444; font-size: 16px; cursor: pointer; padding: 4px;" title="å‰Šé™¤"><i class="bi bi-x-lg"></i></button>';
        container.appendChild(div);
      });
    }

    function cfgRemoveSalesword(index) {
      _cfg_saleswordFavorites.splice(index, 1);
      cfgRenderSaleswordList();
    }
    window.cfgRemoveSalesword = cfgRemoveSalesword;

    // --- åé›†/å¾©å…ƒ ---

    function cfgCollectSaleswordFormat() {
      var globalPrefix = cfgGetCurrentPrefix();
      var globalSuffix = cfgGetCurrentSuffix();

      return {
        globalPrefix: globalPrefix,
        globalSuffix: globalSuffix,
        wordOverrides: _cfg_wordOverrides.filter(function(ov) { return ov.word; }).map(function(ov) {
          return { word: ov.word, prefix: ov.prefix || '', suffix: ov.suffix || '' };
        })
      };
    }

    function cfgCollectSaleswordConfig() {
      var defaultCatEl = document.getElementById('cfg-defaultSaleswordCategory');
      var defaultWordEl = document.getElementById('cfg-defaultSalesword');

      return {
        ã‚ˆãä½¿ã†: _cfg_saleswordFavorites.slice(),
        è¡¨ç¤ºå½¢å¼: cfgCollectSaleswordFormat(),
        ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: {
          ã‚«ãƒ†ã‚´ãƒª: defaultCatEl ? defaultCatEl.value : '',
          ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰: defaultWordEl ? defaultWordEl.value : ''
        }
      };
    }

    function cfgRenderSaleswordFormat(config) {
      if (!config) return;
      var format = config.è¡¨ç¤ºå½¢å¼ || config;

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«Prefixå¾©å…ƒ
      if (format.globalPrefix) {
        var prefixSel = document.getElementById('cfg-saleswordPrefixSelect');
        var prefixCustom = document.getElementById('cfg-saleswordPrefixCustom');
        if (prefixSel) {
          // ãƒ—ãƒªã‚»ãƒƒãƒˆä¸€è¦§ã«ã‚ã‚‹ã‹ç¢ºèª
          var found = false;
          for (var i = 0; i < prefixSel.options.length; i++) {
            if (prefixSel.options[i].value === format.globalPrefix) {
              prefixSel.value = format.globalPrefix;
              found = true;
              break;
            }
          }
          if (!found) {
            prefixSel.value = 'custom';
            if (prefixCustom) { prefixCustom.value = format.globalPrefix; prefixCustom.style.display = 'block'; }
          }
        }
      }

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«Suffixå¾©å…ƒ
      if (format.globalSuffix) {
        var suffixSel = document.getElementById('cfg-saleswordSuffixSelect');
        var suffixCustom = document.getElementById('cfg-saleswordSuffixCustom');
        if (suffixSel) {
          var found2 = false;
          for (var j = 0; j < suffixSel.options.length; j++) {
            if (suffixSel.options[j].value === format.globalSuffix) {
              suffixSel.value = format.globalSuffix;
              found2 = true;
              break;
            }
          }
          if (!found2) {
            suffixSel.value = 'custom';
            if (suffixCustom) { suffixCustom.value = format.globalSuffix; suffixCustom.style.display = 'block'; }
          }
        }
      }

      // æ—§bracketå½¢å¼äº’æ›
      if (format.bracket && !format.globalPrefix) {
        var bracketMap = { 'round': ['ï¼ˆ','ï¼‰'], 'square': ['[',']'], 'angle': ['ï¼œ','ï¼'], 'emoji': ['âœ¨','âœ¨'] };
        var pair = bracketMap[format.bracket];
        if (pair) {
          var ps = document.getElementById('cfg-saleswordPrefixSelect');
          var ss = document.getElementById('cfg-saleswordSuffixSelect');
          if (ps) ps.value = pair[0];
          if (ss) ss.value = pair[1];
        }
      }

      // ãƒ¯ãƒ¼ãƒ‰åˆ¥ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰å¾©å…ƒ
      if (format.wordOverrides && format.wordOverrides.length > 0) {
        _cfg_wordOverrides = format.wordOverrides.map(function(ov) {
          var master = _cfg_SALESWORD_LIST.find(function(sw) { return sw.name === ov.word; });
          return { category: master ? master.category : '', word: ov.word, prefix: ov.prefix || '', suffix: ov.suffix || '' };
        });
        cfgRenderWordOverrides();
      }

      cfgUpdateSaleswordFormatPreview();
    }

    function cfgRenderDefaultSalesword(config) {
      if (!config || !config.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ) return;
      var def = config.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ;
      var catSelect = document.getElementById('cfg-defaultSaleswordCategory');
      if (catSelect && def.ã‚«ãƒ†ã‚´ãƒª) {
        catSelect.value = def.ã‚«ãƒ†ã‚´ãƒª;
        cfgUpdateDefaultSaleswordOptions();
        var wordSelect = document.getElementById('cfg-defaultSalesword');
        if (wordSelect && def.ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰) {
          wordSelect.value = def.ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰;
        }
      }
    }

    function cfgRenderSaleswordConfig(saleswordConfig) {
      if (!saleswordConfig) return;

      // ã‚ˆãä½¿ã†ãƒ¯ãƒ¼ãƒ‰å¾©å…ƒ
      _cfg_saleswordFavorites = [];
      if (saleswordConfig.ã‚ˆãä½¿ã† && Array.isArray(saleswordConfig.ã‚ˆãä½¿ã†)) {
        _cfg_saleswordFavorites = saleswordConfig.ã‚ˆãä½¿ã†.slice();
      }
      cfgRenderSaleswordList();

      // è¡¨ç¤ºå½¢å¼å¾©å…ƒ
      if (saleswordConfig.è¡¨ç¤ºå½¢å¼) {
        cfgRenderSaleswordFormat(saleswordConfig);
      }

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¯ãƒ¼ãƒ‰å¾©å…ƒ
      cfgRenderDefaultSalesword(saleswordConfig);

      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–
      cfgInitDefaultSaleswordDropdowns();
      cfgInitFavoriteSaleswordDropdowns();

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’å†è¨­å®šï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–å¾Œï¼‰
      if (saleswordConfig.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ && saleswordConfig.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ.ã‚«ãƒ†ã‚´ãƒª) {
        var catSel = document.getElementById('cfg-defaultSaleswordCategory');
        if (catSel) {
          catSel.value = saleswordConfig.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ.ã‚«ãƒ†ã‚´ãƒª;
          cfgUpdateDefaultSaleswordOptions();
          var wordSel = document.getElementById('cfg-defaultSalesword');
          if (wordSel && saleswordConfig.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ.ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰) {
            wordSel.value = saleswordConfig.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ.ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰;
          }
        }
      }
    }

    async function cfgLoadSaleswordMasterData() {
      if (!window.db) return;
      try {
        var snapshot = await window.db.collection('saleswords').orderBy('order', 'asc').get();
        _cfg_SALESWORD_LIST = [];
        snapshot.forEach(function(doc) {
          var data = doc.data();
          var category = data.category || doc.id;
          var words = data.words || [];
          // ã‚«ãƒ†ã‚´ãƒªâ†’ãƒ¯ãƒ¼ãƒ‰é…åˆ—ã‚’ãƒ•ãƒ©ãƒƒãƒˆãƒªã‚¹ãƒˆã«å¤‰æ›
          words.forEach(function(word) {
            _cfg_SALESWORD_LIST.push({ id: category + '/' + word, name: word, category: category });
          });
        });
        console.log('[config-fragment] Salesword master loaded:', _cfg_SALESWORD_LIST.length);
        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–
        cfgInitDefaultSaleswordDropdowns();
        cfgInitFavoriteSaleswordDropdowns();
        // ãƒã‚¹ã‚¿ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã€ä¿ç•™ä¸­ã®ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã‚’å†æç”»
        if (_cfg_pendingSaleswordConfig) {
          cfgRenderSaleswordConfig(_cfg_pendingSaleswordConfig);
          _cfg_pendingSaleswordConfig = null;
        }
      } catch (e) {
        console.error('[config-fragment] Salesword master error:', e);
      }
    }

    // ============================================
    // AI Settings
    // ============================================

    function cfgRenderAiSettings(ai) {
      if (!ai) return;
      var tone = document.getElementById('cfg-aiTone');
      var length = document.getElementById('cfg-aiLength');
      var temp = document.getElementById('cfg-aiTemperature');
      var prompt = document.getElementById('cfg-aiCustomPrompt');

      if (tone && ai.tone) tone.value = ai.tone;
      if (length && ai.length) length.value = ai.length;
      if (temp && ai.temperature !== undefined) {
        temp.value = ai.temperature;
        cfgUpdateTempDisplay(ai.temperature);
      }
      if (prompt && ai.customPrompt) prompt.value = ai.customPrompt;

      // å¾©å…ƒ: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
      var tmpl = document.getElementById('cfg-aiPromptTemplate');
      if (tmpl && ai.promptTemplate) tmpl.value = ai.promptTemplate;

      // å¾©å…ƒ: è¦‹å‡ºã—ã‚¹ã‚¿ã‚¤ãƒ«
      var heading = document.getElementById('cfg-aiHeadingStyle');
      if (heading && ai.headingStyle) heading.value = ai.headingStyle;

      // å¾©å…ƒ: æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°
      var maxTokens = document.getElementById('cfg-aiMaxTokens');
      var maxTokensDisp = document.getElementById('cfg-aiMaxTokensDisplay');
      if (maxTokens && ai.maxTokens !== undefined) {
        maxTokens.value = ai.maxTokens;
        if (maxTokensDisp) maxTokensDisp.textContent = ai.maxTokens;
      }

      // å¾©å…ƒ: å«ã‚ã‚‹è¦ç´ 
      if (ai.includeElements) {
        var elems = ['brand', 'category', 'size', 'material', 'color', 'attribute', 'condition', 'coordinate', 'scene'];
        elems.forEach(function(key) {
          var cb = document.getElementById('cfg-aiElem-' + key);
          if (cb && ai.includeElements[key] !== undefined) cb.checked = ai.includeElements[key];
        });
      }

      cfgRenderAiPresetButtons(ai.preset || null);
      cfgUpdateAiConfigPreview();
    }

    function cfgRenderAiPresetButtons(activePreset) {
      var container = document.getElementById('cfg-aiPresetButtons');
      if (!container) return;
      var presets = [
        { id: 'casual', label: 'ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«' },
        { id: 'formal', label: 'ãƒ•ã‚©ãƒ¼ãƒãƒ«' },
        { id: 'friendly', label: 'ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼' },
        { id: 'professional', label: 'ãƒ—ãƒ­' },
        { id: 'detailed', label: 'è©³ç´°' },
        { id: 'minimal', label: 'ã‚·ãƒ³ãƒ—ãƒ«' }
      ];
      container.innerHTML = presets.map(function(p) {
        var isActive = activePreset === p.id;
        return '<button type="button" onclick="cfgApplyAiPreset(\'' + p.id + '\')" style="padding: 6px 12px; border: 1.5px solid ' + (isActive ? '#40B4E5' : '#e5e7eb') + '; border-radius: 6px; background: ' + (isActive ? '#f0f9ff' : 'white') + '; color: ' + (isActive ? '#0369a1' : '#374151') + '; font-size: 12px; font-weight: 500; cursor: pointer;">' + p.label + '</button>';
      }).join('');
    }

    function cfgApplyAiPreset(presetId) {
      var presets = {
        casual: { tone: 'casual', length: 'medium', temperature: 0.7, customPrompt: '' },
        formal: { tone: 'formal', length: 'medium', temperature: 0.3, customPrompt: '' },
        friendly: { tone: 'friendly', length: 'medium', temperature: 0.8, customPrompt: '' },
        professional: { tone: 'professional', length: 'long', temperature: 0.5, customPrompt: '' },
        detailed: { tone: 'formal', length: 'long', temperature: 0.4, customPrompt: 'å•†å“ã®ç‰¹å¾´ã‚’è©³ã—ãèª¬æ˜ã—ã¦ãã ã•ã„' },
        minimal: { tone: 'casual', length: 'short', temperature: 0.6, customPrompt: '' }
      };

      var preset = presets[presetId] || presets.casual;
      var tone = document.getElementById('cfg-aiTone');
      var length = document.getElementById('cfg-aiLength');
      var temp = document.getElementById('cfg-aiTemperature');
      var prompt = document.getElementById('cfg-aiCustomPrompt');

      if (tone) tone.value = preset.tone;
      if (length) length.value = preset.length;
      if (temp) { temp.value = preset.temperature; cfgUpdateTempDisplay(preset.temperature); }
      if (prompt) prompt.value = preset.customPrompt;

      cfgRenderAiPresetButtons(presetId);
      cfgUpdateAiConfigPreview();
    }
    window.cfgApplyAiPreset = cfgApplyAiPreset;

    function cfgUpdateTempDisplay(val) {
      var el = document.getElementById('cfg-aiTempDisplay');
      if (el) el.textContent = parseFloat(val).toFixed(1);
    }
    window.cfgUpdateTempDisplay = cfgUpdateTempDisplay;

    function cfgInsertTemplateVar(varName) {
      var textarea = document.getElementById('cfg-aiPromptTemplate');
      if (!textarea) return;
      var start = textarea.selectionStart;
      var end = textarea.selectionEnd;
      var text = textarea.value;
      textarea.value = text.substring(0, start) + varName + text.substring(end);
      textarea.selectionStart = textarea.selectionEnd = start + varName.length;
      textarea.focus();
      cfgUpdateAiConfigPreview();
    }
    window.cfgInsertTemplateVar = cfgInsertTemplateVar;

    function cfgUpdateAiConfigPreview() {
      var preview = document.getElementById('cfg-aiConfigPreview');
      if (!preview) return;
      var tone = document.getElementById('cfg-aiTone');
      var length = document.getElementById('cfg-aiLength');
      var temp = document.getElementById('cfg-aiTemperature');
      var prompt = document.getElementById('cfg-aiCustomPrompt');
      var heading = document.getElementById('cfg-aiHeadingStyle');
      var maxTokens = document.getElementById('cfg-aiMaxTokens');
      var tmpl = document.getElementById('cfg-aiPromptTemplate');

      var lines = [];
      if (tone && tone.selectedIndex >= 0) lines.push('ãƒˆãƒ¼ãƒ³: ' + tone.options[tone.selectedIndex].text);
      if (length && length.selectedIndex >= 0) lines.push('é•·ã•: ' + length.options[length.selectedIndex].text);
      if (temp) lines.push('æ¸©åº¦: ' + parseFloat(temp.value).toFixed(1));
      if (heading && heading.selectedIndex >= 0) lines.push('è¦‹å‡ºã—: ' + heading.options[heading.selectedIndex].text);
      if (maxTokens) lines.push('æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³: ' + maxTokens.value);
      if (prompt && prompt.value.trim()) lines.push('è¿½åŠ æŒ‡ç¤º: ' + prompt.value.trim());
      if (tmpl && tmpl.value.trim()) lines.push('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: ã‚ã‚Š');

      // å«ã‚ã‚‹è¦ç´ 
      var elems = ['brand', 'category', 'size', 'material', 'color', 'attribute', 'condition', 'coordinate', 'scene'];
      var elemLabels = { brand: 'ãƒ–ãƒ©ãƒ³ãƒ‰', category: 'ã‚«ãƒ†ã‚´ãƒª', size: 'ã‚µã‚¤ã‚º', material: 'ç´ æ', color: 'ã‚«ãƒ©ãƒ¼', attribute: 'å±æ€§', condition: 'çŠ¶æ…‹', coordinate: 'ã‚³ãƒ¼ãƒ‡', scene: 'ã‚·ãƒ¼ãƒ³' };
      var activeElems = [];
      elems.forEach(function(key) {
        var cb = document.getElementById('cfg-aiElem-' + key);
        if (cb && cb.checked) activeElems.push(elemLabels[key]);
      });
      if (activeElems.length > 0) lines.push('è¦ç´ : ' + activeElems.join(', '));

      preview.innerHTML = lines.map(function(l) { return '<div>' + l + '</div>'; }).join('');
    }
    window.cfgUpdateAiConfigPreview = cfgUpdateAiConfigPreview;

    function cfgClearAiSettings() {
      if (!confirm('AIç”Ÿæˆè¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) return;
      cfgApplyAiPreset('casual');
      // è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ãƒªã‚»ãƒƒãƒˆ
      var tmpl = document.getElementById('cfg-aiPromptTemplate');
      if (tmpl) tmpl.value = '';
      var heading = document.getElementById('cfg-aiHeadingStyle');
      if (heading) heading.value = 'emoji';
      var maxTokens = document.getElementById('cfg-aiMaxTokens');
      var maxTokensDisp = document.getElementById('cfg-aiMaxTokensDisplay');
      if (maxTokens) { maxTokens.value = 500; if (maxTokensDisp) maxTokensDisp.textContent = '500'; }
      // å«ã‚ã‚‹è¦ç´ ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«
      var defaultOn = ['brand', 'category', 'size', 'material', 'color', 'attribute', 'condition'];
      var defaultOff = ['coordinate', 'scene'];
      defaultOn.forEach(function(k) { var cb = document.getElementById('cfg-aiElem-' + k); if (cb) cb.checked = true; });
      defaultOff.forEach(function(k) { var cb = document.getElementById('cfg-aiElem-' + k); if (cb) cb.checked = false; });
      cfgUpdateAiConfigPreview();
      alert('AIç”Ÿæˆè¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ï¼‰ã«æˆ»ã—ã¾ã—ãŸã€‚');
    }
    window.cfgClearAiSettings = cfgClearAiSettings;

    function cfgCollectAiSettings() {
      var tone = document.getElementById('cfg-aiTone');
      var length = document.getElementById('cfg-aiLength');
      var temp = document.getElementById('cfg-aiTemperature');
      var prompt = document.getElementById('cfg-aiCustomPrompt');
      var tmpl = document.getElementById('cfg-aiPromptTemplate');
      var heading = document.getElementById('cfg-aiHeadingStyle');
      var maxTokens = document.getElementById('cfg-aiMaxTokens');

      // å«ã‚ã‚‹è¦ç´ 
      var elems = ['brand', 'category', 'size', 'material', 'color', 'attribute', 'condition', 'coordinate', 'scene'];
      var includeElements = {};
      elems.forEach(function(key) {
        var cb = document.getElementById('cfg-aiElem-' + key);
        includeElements[key] = cb ? cb.checked : true;
      });

      return {
        tone: tone ? tone.value : 'casual',
        length: length ? length.value : 'medium',
        temperature: temp ? parseFloat(temp.value) : 0.7,
        customPrompt: prompt ? prompt.value.trim() : '',
        promptTemplate: tmpl ? tmpl.value.trim() : '',
        headingStyle: heading ? heading.value : 'emoji',
        maxTokens: maxTokens ? parseInt(maxTokens.value) : 500,
        includeElements: includeElements
      };
    }

    // ============================================
    // Shipping Defaults
    // ============================================

    function cfgRenderShippingDefaults(defaults) {
      if (!defaults) return;
      var fields = ['é…é€æ–™ã®è² æ‹…', 'é…é€ã®æ–¹æ³•', 'ç™ºé€å…ƒã®åœ°åŸŸ', 'ç™ºé€ã¾ã§ã®æ—¥æ•°'];
      fields.forEach(function(field) {
        var el = document.getElementById('cfg-' + field);
        if (el && defaults[field]) el.value = defaults[field];
      });
    }

    function cfgCollectShippingDefaults() {
      var result = {};
      var fields = ['é…é€æ–™ã®è² æ‹…', 'é…é€ã®æ–¹æ³•', 'ç™ºé€å…ƒã®åœ°åŸŸ', 'ç™ºé€ã¾ã§ã®æ—¥æ•°'];
      fields.forEach(function(field) {
        var el = document.getElementById('cfg-' + field);
        if (el && el.value) result[field] = el.value;
      });
      return result;
    }

    function cfgCollectManagementConfig() {
      // _cfgMNB.getData() ã§ segments é…åˆ—ã‚’å–å¾—ï¼ˆproduct-scripts.jsäº’æ›ï¼‰
      var mnbData = _cfgMNB.getData();
      var presetKey = (document.getElementById('cfg-mnbPresetSelect') || {}).value || '';

      var showInTitle = document.getElementById('cfg-mnb-showInTitle');
      var showInDesc = document.getElementById('cfg-mnb-showInDescription');
      var titleFormat = document.getElementById('cfg-mnb-titleFormat');
      var descFormat = document.getElementById('cfg-mnb-descFormat');

      var data = {
        segments: mnbData.segments,
        presetKey: presetKey,
        showInTitle: showInTitle ? showInTitle.checked : false,
        showInDescription: showInDesc ? showInDesc.checked : false,
        titleFormat: titleFormat ? titleFormat.value : 'ã€ã€‘',
        titlePosition: 'end',
        descFormat: descFormat ? descFormat.value : 'ã€ã€‘',
        descPosition: 'order'
      };

      // managementNumberPlacement ã‚’localStorageã«ä¿å­˜ï¼ˆproduct.htmläº’æ›ï¼‰
      try {
        var placementSettings = {
          inTitle: data.showInTitle,
          inDesc: data.showInDescription,
          format: data.titleFormat,
          position: data.titlePosition,
          descFormat: data.descFormat,
          descPosition: data.descPosition
        };
        localStorage.setItem('managementNumberPlacement', JSON.stringify(placementSettings));
      } catch (e) { console.error('managementNumberPlacementä¿å­˜ã‚¨ãƒ©ãƒ¼:', e); }

      return data;
    }

    // ============================================
    // Shipping Dropdown Loading (Firestore)
    // ============================================

    async function cfgLoadShippingBurden() {
      if (!window.db) return;
      try {
        var snapshot = await window.db.collection('shippingBurden').orderBy('displayOrder', 'asc').get();
        var select = document.getElementById('cfg-é…é€æ–™ã®è² æ‹…');
        if (!select) return;
        while (select.options.length > 1) select.remove(1);
        snapshot.forEach(function(doc) {
          var data = doc.data();
          var opt = document.createElement('option');
          opt.value = data.name || data.value || doc.id;
          opt.textContent = opt.value;
          select.appendChild(opt);
        });
      } catch (e) { console.error('[config-fragment] shippingBurden error:', e); }
    }

    async function cfgLoadShippingMethodCategories() {
      if (!window.db) return;
      try {
        var snapshot = await window.db.collection('shippingMethods')
          .where('platform', 'in', ['mercari', 'mercari-shops'])
          .orderBy('order', 'asc').get();
        var select = document.getElementById('cfg-é…é€ã®æ–¹æ³•');
        if (!select) return;
        while (select.options.length > 1) select.remove(1);
        var added = new Set();
        snapshot.forEach(function(doc) {
          var name = doc.data().category || doc.id;
          if (!added.has(name)) {
            added.add(name);
            var opt = document.createElement('option');
            opt.value = name; opt.textContent = name;
            select.appendChild(opt);
          }
        });
      } catch (e) { console.error('[config-fragment] shippingMethods error:', e); }
    }

    async function cfgLoadShippingRegions() {
      if (!window.db) return;
      try {
        var snapshot = await window.db.collection('shippingRegion').orderBy('displayOrder', 'asc').get();
        var select = document.getElementById('cfg-ç™ºé€å…ƒã®åœ°åŸŸ');
        if (!select) return;
        while (select.options.length > 1) select.remove(1);
        snapshot.forEach(function(doc) {
          var data = doc.data();
          var opt = document.createElement('option');
          opt.value = data.name || data.value || doc.id;
          opt.textContent = opt.value;
          select.appendChild(opt);
        });
      } catch (e) { console.error('[config-fragment] shippingRegion error:', e); }
    }

    async function cfgLoadShippingDays() {
      if (!window.db) return;
      try {
        var snapshot = await window.db.collection('shippingDays').where('platform', '==', 'mercari').get();
        var select = document.getElementById('cfg-ç™ºé€ã¾ã§ã®æ—¥æ•°');
        if (!select) return;
        while (select.options.length > 1) select.remove(1);
        var items = [];
        snapshot.forEach(function(doc) {
          var data = doc.data();
          items.push({ name: data.name || data.value || doc.id, order: data.displayOrder || data.order || 999 });
        });
        items.sort(function(a, b) { return a.order - b.order; });
        var added = new Set();
        items.forEach(function(item) {
          if (!added.has(item.name)) {
            added.add(item.name);
            var opt = document.createElement('option');
            opt.value = item.name; opt.textContent = item.name;
            select.appendChild(opt);
          }
        });
      } catch (e) { console.error('[config-fragment] shippingDays error:', e); }
    }

    // ============================================
    // Procure/Listing Dropdowns
    // ============================================

    async function cfgInitProcureListingDropdowns() {
      if (!window.db) return;
      try {
        // ä»•å…¥å…ˆ
        var supplierSnap = await window.db.collection('suppliers').orderBy('name', 'asc').get();
        var supplierSelect = document.getElementById('cfg-ä»•å…¥å…ˆ');
        if (supplierSelect) {
          while (supplierSelect.options.length > 1) supplierSelect.remove(1);
          supplierSnap.forEach(function(doc) {
            var data = doc.data();
            var opt = document.createElement('option');
            opt.value = data.name || doc.id; opt.textContent = opt.value;
            supplierSelect.appendChild(opt);
          });
        }
        // å‡ºå“å…ˆï¼ˆmasterOptionsã‹ã‚‰å–å¾— = å•†å“ç™»éŒ²ç”»é¢ã¨åŒã˜ã‚½ãƒ¼ã‚¹ï¼‰
        var marketplaceSelect = document.getElementById('cfg-å‡ºå“å…ˆ');
        if (marketplaceSelect) {
          while (marketplaceSelect.options.length > 1) marketplaceSelect.remove(1);
          try {
            var moSnap = await window.db.collection('masterOptions')
              .where('fieldName', '==', 'å‡ºå“å…ˆ').get();
            if (!moSnap.empty) {
              moSnap.forEach(function(doc) {
                var data = doc.data();
                (data.items || []).forEach(function(name) {
                  var opt = document.createElement('option');
                  opt.value = name; opt.textContent = name;
                  marketplaceSelect.appendChild(opt);
                });
              });
            } else {
              // masterOptionsã«ç„¡ã„å ´åˆã¯salesChannelsã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
              var chSnap = await window.db.collection('salesChannels').orderBy('name', 'asc').get();
              chSnap.forEach(function(doc) {
                var data = doc.data();
                var opt = document.createElement('option');
                opt.value = data.name || doc.id; opt.textContent = opt.value;
                marketplaceSelect.appendChild(opt);
              });
            }
          } catch(e) { console.error('[config] å‡ºå“å…ˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e); }
        }
      } catch (e) { console.error('[config-fragment] procure dropdown error:', e); }
    }

    function cfgToggleProcureDateField(mode) {
      var el = document.getElementById('cfg-ä»•å…¥æ—¥');
      if (el) el.style.display = mode === 'fixed' ? 'block' : 'none';
    }
    window.cfgToggleProcureDateField = cfgToggleProcureDateField;

    function cfgToggleListingDateField(mode) {
      var el = document.getElementById('cfg-å‡ºå“æ—¥');
      if (el) el.style.display = mode === 'fixed' ? 'block' : 'none';
    }
    window.cfgToggleListingDateField = cfgToggleListingDateField;

    // ============================================
    // Platform Settings
    // ============================================

    async function cfgLoadPlatformsFromFirestore() {
      if (!window.db) return;
      try {
        var snapshot = await window.db.collection('platforms').get();
        if (!snapshot.empty) {
          _cfg_customPlatforms = [];
          snapshot.forEach(function(doc) {
            var data = doc.data();
            if (data.isCustom) {
              _cfg_customPlatforms.push({ id: doc.id, ...data });
            } else {
              // Update default platform data
              var idx = _cfg_defaultPlatformDefs.findIndex(function(p) { return p.id === doc.id; });
              if (idx !== -1) {
                Object.assign(_cfg_defaultPlatformDefs[idx], data);
              }
            }
          });
          _cfg_platformMaster = _cfg_defaultPlatformDefs.concat(_cfg_customPlatforms);
        }
      } catch (e) { console.error('[config-fragment] platforms load error:', e); }
    }

    function cfgLoadPlatformSettings(config) {
      if (!config || !config['ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š']) {
        _cfg_enabledPlatformIds = ['mercari'];
        cfgRenderEnabledPlatforms();
        return;
      }
      var settings = config['ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š'];
      if (settings.enabledPlatformIds && Array.isArray(settings.enabledPlatformIds)) {
        _cfg_enabledPlatformIds = settings.enabledPlatformIds;
      } else if (settings.platforms && Array.isArray(settings.platforms)) {
        _cfg_enabledPlatformIds = settings.platforms.filter(function(p) { return p.enabled; }).map(function(p) { return p.id; });
      }
      if (_cfg_enabledPlatformIds.length === 0) _cfg_enabledPlatformIds = ['mercari'];

      // Registration mode
      if (settings.registrationMode) {
        var modeRadio = document.getElementById(settings.registrationMode === 'batch' ? 'cfg-modeBatch' : 'cfg-modeIndividual');
        if (modeRadio) { modeRadio.checked = true; cfgSelectRegistrationMode(settings.registrationMode); }
      }

      cfgRenderEnabledPlatforms();
    }

    function cfgRenderEnabledPlatforms() {
      var container = document.getElementById('cfg-enabledPlatformsList');
      if (!container) return;
      container.innerHTML = _cfg_enabledPlatformIds.map(function(id) {
        var platform = _cfg_platformMaster.find(function(p) { return p.id === id; });
        if (!platform) return '';
        return '<div style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 10px; margin-bottom: 8px; background: white;">' +
          '<img src="' + (platform.icon || '') + '" alt="' + platform.name + '" style="width: 40px; height: 40px; object-fit: contain; border-radius: 6px;" onerror="this.style.display=\'none\'">' +
          '<div style="flex: 1;">' +
            '<div style="font-weight: 600; color: #374151; font-size: 14px;">' + platform.name + '</div>' +
            '<div style="font-size: 11px; color: #6b7280;">' + (platform.description || '') + '</div>' +
          '</div>' +
          '<button onclick="cfgOpenPlatformEditModal(\'' + id + '\')" style="background: none; border: none; color: #6b7280; font-size: 16px; cursor: pointer; padding: 4px;"><i class="bi bi-pencil"></i></button>' +
          '<button onclick="cfgRemovePlatformFromEnabled(\'' + id + '\')" style="background: none; border: none; color: #ef4444; font-size: 16px; cursor: pointer; padding: 4px;" title="å‰Šé™¤"><i class="bi bi-x-lg"></i></button>' +
        '</div>';
      }).join('');
    }

    function cfgSelectRegistrationMode(mode) {
      var indLabel = document.querySelector('#spa-page-config label[onclick*="individual"]');
      var batchLabel = document.querySelector('#spa-page-config label[onclick*="batch"]');
      if (indLabel && batchLabel) {
        if (mode === 'individual') {
          indLabel.style.borderColor = '#40B4E5'; indLabel.style.background = '#f0f9ff';
          batchLabel.style.borderColor = '#e5e7eb'; batchLabel.style.background = 'transparent';
        } else {
          batchLabel.style.borderColor = '#40B4E5'; batchLabel.style.background = '#f0f9ff';
          indLabel.style.borderColor = '#e5e7eb'; indLabel.style.background = 'transparent';
        }
      }
    }
    window.cfgSelectRegistrationMode = cfgSelectRegistrationMode;

    function cfgOpenPlatformSelectModal() {
      _cfgShowModal('cfg-platformSelectModal');
      cfgRenderPlatformSelectList();
    }
    window.cfgOpenPlatformSelectModal = cfgOpenPlatformSelectModal;

    function cfgClosePlatformSelectModal() {
      _cfgHideModal('cfg-platformSelectModal');
    }
    window.cfgClosePlatformSelectModal = cfgClosePlatformSelectModal;

    function cfgRenderPlatformSelectList() {
      var container = document.getElementById('cfg-platformSelectList');
      if (!container) return;
      var available = _cfg_platformMaster.filter(function(p) { return !_cfg_enabledPlatformIds.includes(p.id); });
      if (available.length === 0) {
        container.innerHTML = '<div style="color: #9ca3af; font-size: 13px; padding: 20px; text-align: center;">è¿½åŠ ã§ãã‚‹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      container.innerHTML = available.map(function(p) {
        return '<div onclick="cfgAddPlatformToEnabled(\'' + p.id + '\')" style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; cursor: pointer;" onmouseover="this.style.background=\'#f9fafb\'" onmouseout="this.style.background=\'white\'">' +
          '<img src="' + (p.icon || '') + '" alt="' + p.name + '" style="width: 40px; height: 40px; object-fit: contain; border-radius: 6px;" onerror="this.style.display=\'none\'">' +
          '<div style="flex: 1;"><div style="font-weight: 600; color: #374151; font-size: 14px;">' + p.name + '</div><div style="font-size: 11px; color: #6b7280;">' + (p.description || '') + '</div></div>' +
          '<span style="color: #40B4E5; font-size: 20px;">+</span></div>';
      }).join('');
    }

    async function cfgAddPlatformToEnabled(platformId) {
      if (!_cfg_enabledPlatformIds.includes(platformId)) {
        _cfg_enabledPlatformIds.push(platformId);
        cfgRenderEnabledPlatforms();
        cfgRenderPlatformSelectList();
        await cfgPersistPlatformSettings();
      }
      var available = _cfg_platformMaster.filter(function(p) { return !_cfg_enabledPlatformIds.includes(p.id); });
      if (available.length === 0) cfgClosePlatformSelectModal();
    }
    window.cfgAddPlatformToEnabled = cfgAddPlatformToEnabled;

    async function cfgRemovePlatformFromEnabled(platformId) {
      var idx = _cfg_enabledPlatformIds.indexOf(platformId);
      if (idx > -1) {
        _cfg_enabledPlatformIds.splice(idx, 1);
        cfgRenderEnabledPlatforms();
        await cfgPersistPlatformSettings();
      }
    }
    window.cfgRemovePlatformFromEnabled = cfgRemovePlatformFromEnabled;

    function cfgCollectPlatformSettings() {
      var modeRadio = document.querySelector('#spa-page-config input[name="cfg-registrationMode"]:checked');
      var platforms = _cfg_enabledPlatformIds.map(function(id) {
        var p = _cfg_platformMaster.find(function(x) { return x.id === id; });
        if (!p) return null;
        return { id: id, name: p.name, description: p.description, icon: p.icon, enabled: true };
      }).filter(function(p) { return p; });
      return {
        registrationMode: modeRadio ? modeRadio.value : 'individual',
        platforms: platforms,
        enabledPlatformIds: _cfg_enabledPlatformIds,
        platformOrder: _cfg_enabledPlatformIds
      };
    }

    async function cfgPersistPlatformSettings() {
      try {
        var settings = cfgCollectPlatformSettings();
        localStorage.setItem(_cfg_CONFIG_STORAGE_KEYS.PLATFORM, JSON.stringify(settings));
        if (window.db) {
          var userId = localStorage.getItem('reborn_user_id') || localStorage.getItem('userId');
          if (userId) {
            await window.db.collection('configs').doc(userId).set({ 'ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š': settings, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
          }
        }
      } catch (e) { console.error('[config-fragment] persist platform error:', e); }
    }

    // Platform edit modal
    function cfgOpenPlatformEditModal(platformId) {
      _cfg_currentEditingPlatformId = platformId;
      _cfg_pendingIconFile = null;
      var platform = _cfg_platformEdits[platformId] || _cfg_customPlatforms.find(function(p) { return p.id === platformId; }) || _cfg_defaultPlatformDefs.find(function(p) { return p.id === platformId; });
      if (!platform) return;

      var editId = document.getElementById('cfg-editPlatformId');
      var editName = document.getElementById('cfg-editPlatformName');
      var editDesc = document.getElementById('cfg-editPlatformDesc');
      if (editId) editId.value = platform.id;
      if (editName) editName.value = platform.name;
      if (editDesc) editDesc.value = platform.description || '';

      var preview = document.getElementById('cfg-platformIconPreview');
      if (preview) {
        if (platform.icon) {
          preview.innerHTML = '<img src="' + platform.icon + '" style="width: 100%; height: 100%; object-fit: contain;">';
        } else {
          preview.innerHTML = '<span style="color: #9ca3af; font-size: 12px;">æœªè¨­å®š</span>';
        }
      }

      _cfgShowModal('cfg-platformEditModal');
    }
    window.cfgOpenPlatformEditModal = cfgOpenPlatformEditModal;

    function cfgClosePlatformEditModal() {
      _cfgHideModal('cfg-platformEditModal');
      _cfg_currentEditingPlatformId = null;
      _cfg_pendingIconFile = null;
    }
    window.cfgClosePlatformEditModal = cfgClosePlatformEditModal;

    function cfgPreviewPlatformIcon(event) {
      var file = event.target.files[0];
      if (!file) return;
      if (file.size > 2 * 1024 * 1024) { alert('ç”»åƒã‚µã‚¤ã‚ºã¯2MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚'); return; }
      _cfg_pendingIconFile = file;
      var reader = new FileReader();
      reader.onload = function(e) {
        var preview = document.getElementById('cfg-platformIconPreview');
        if (preview) preview.innerHTML = '<img src="' + e.target.result + '" style="width: 100%; height: 100%; object-fit: contain;">';
        var status = document.getElementById('cfg-platformIconUploadStatus');
        if (status) { status.textContent = 'ç”»åƒã‚’é¸æŠã—ã¾ã—ãŸ'; status.style.color = '#10b981'; }
      };
      reader.readAsDataURL(file);
    }
    window.cfgPreviewPlatformIcon = cfgPreviewPlatformIcon;

    async function cfgSavePlatformEdit() {
      if (!_cfg_currentEditingPlatformId) return;
      var name = document.getElementById('cfg-editPlatformName').value.trim();
      if (!name) { alert('è¡¨ç¤ºåã¯å¿…é ˆã§ã™ã€‚'); return; }
      var description = document.getElementById('cfg-editPlatformDesc').value.trim();

      // Update platform in master
      var idx = _cfg_defaultPlatformDefs.findIndex(function(p) { return p.id === _cfg_currentEditingPlatformId; });
      if (idx !== -1) {
        _cfg_defaultPlatformDefs[idx].name = name;
        _cfg_defaultPlatformDefs[idx].description = description;
      }
      _cfg_platformMaster = _cfg_defaultPlatformDefs.concat(_cfg_customPlatforms);

      cfgRenderEnabledPlatforms();
      cfgClosePlatformEditModal();
      await cfgPersistPlatformSettings();
    }
    window.cfgSavePlatformEdit = cfgSavePlatformEdit;

    // ============================================
    // Description Order
    // ============================================

    function cfgRenderDescriptionOrder(order) {
      var container = document.getElementById('cfg-descriptionOrderList');
      if (!container) return;
      container.innerHTML = '';

      var elements = (order && order.length > 0) ? order : _cfg_DESCRIPTION_ELEMENTS;

      // Add missing new elements
      if (order && order.length > 0) {
        var existingIds = order.map(function(e) { return e.id; });
        var newElements = _cfg_DESCRIPTION_ELEMENTS.filter(function(e) { return !existingIds.includes(e.id); });
        if (newElements.length > 0) elements = order.concat(newElements);
      }

      elements.forEach(function(element) {
        var item = document.createElement('div');
        item.draggable = true;
        item.dataset.elementId = element.id;
        item.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; cursor: move; user-select: none;';

        var handle = document.createElement('span');
        handle.textContent = '\u22EE\u22EE';
        handle.style.cssText = 'font-size: 16px; color: #9ca3af; cursor: move;';
        item.appendChild(handle);

        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = element.enabled !== false;
        checkbox.style.cssText = 'width: 18px; height: 18px; cursor: pointer;';
        checkbox.addEventListener('change', cfgUpdateDescriptionOrderPreview);
        item.appendChild(checkbox);

        var label = document.createElement('span');
        label.textContent = element.label;
        label.style.cssText = 'flex: 1; font-size: 13px; font-weight: 500; color: #374151;';
        item.appendChild(label);

        // Drag events
        item.addEventListener('dragstart', function(e) {
          _cfg_draggedElement = item;
          e.dataTransfer.effectAllowed = 'move';
          item.style.opacity = '0.5';
        });
        item.addEventListener('dragend', function() {
          item.style.opacity = '1';
          _cfg_draggedElement = null;
        });
        item.addEventListener('dragover', function(e) {
          e.preventDefault();
          if (_cfg_draggedElement && _cfg_draggedElement !== item) {
            item.style.borderColor = '#3b82f6';
          }
        });
        item.addEventListener('dragleave', function() {
          item.style.borderColor = '#e5e7eb';
        });
        item.addEventListener('drop', function(e) {
          e.preventDefault();
          item.style.borderColor = '#e5e7eb';
          if (_cfg_draggedElement && _cfg_draggedElement !== item) {
            var allItems = Array.from(container.children);
            var draggedIndex = allItems.indexOf(_cfg_draggedElement);
            var targetIndex = allItems.indexOf(item);
            if (draggedIndex < targetIndex) {
              container.insertBefore(_cfg_draggedElement, item.nextSibling);
            } else {
              container.insertBefore(_cfg_draggedElement, item);
            }
            cfgUpdateDescriptionOrderPreview();
          }
        });

        container.appendChild(item);
      });

      cfgUpdateDescriptionOrderPreview();
    }

    function cfgUpdateDescriptionOrderPreview() {
      var container = document.getElementById('cfg-descriptionOrderList');
      var preview = document.getElementById('cfg-descriptionOrderPreview');
      if (!container || !preview) return;

      var sampleTexts = {
        brand: 'ãƒ–ãƒ©ãƒ³ãƒ‰åï¼šUNIQLO',
        color: 'ã‚«ãƒ©ãƒ¼ï¼ˆè©³ç´°ï¼‰ï¼šãƒ–ãƒ©ãƒƒã‚¯',
        size: 'ã‚µã‚¤ã‚ºï¼šM',
        material: 'ç´ æï¼šãƒŠã‚¤ãƒ­ãƒ³ 100%',
        accessories: 'ä»˜å±å“ï¼šä¿å­˜è¢‹',
        condition: 'å•†å“çŠ¶æ…‹ï¼šç›®ç«‹ã£ãŸå‚·ã‚„æ±šã‚Œãªã—',
        ai: 'ã€å•†å“èª¬æ˜ã€‘UNIQLOã®å®šç•ªã‚¢ã‚¤ãƒ†ãƒ ã§ã™ã€‚',
        management: 'ç®¡ç†ç•ªå·ï¼šã€AA-1001ã€‘',
        discount: 'ãƒ•ã‚©ãƒ­ãƒ¼å‰²ã‚ã‚Šã¾ã™',
        hashtag: '#REBORN_å…¨å•†å“'
      };

      var items = Array.from(container.children);
      var enabledItems = items.filter(function(item) {
        return item.querySelector('input[type="checkbox"]').checked;
      });

      if (enabledItems.length === 0) {
        preview.textContent = 'ï¼ˆã™ã¹ã¦éè¡¨ç¤ºï¼‰';
        preview.style.color = '#ef4444';
      } else {
        var text = enabledItems.map(function(item) {
          return sampleTexts[item.dataset.elementId] || '';
        }).filter(function(t) { return t; }).join('\n\n');
        preview.textContent = text;
        preview.style.color = '#374151';
        preview.style.whiteSpace = 'pre-line';
      }
    }
    window.cfgUpdateDescriptionOrderPreview = cfgUpdateDescriptionOrderPreview;

    function cfgCollectDescriptionOrder() {
      var container = document.getElementById('cfg-descriptionOrderList');
      if (!container) return _cfg_DESCRIPTION_ELEMENTS;
      return Array.from(container.children).map(function(item) {
        var elementId = item.dataset.elementId;
        var element = _cfg_DESCRIPTION_ELEMENTS.find(function(e) { return e.id === elementId; });
        return {
          id: elementId,
          label: element ? element.label : '',
          enabled: item.querySelector('input[type="checkbox"]').checked
        };
      });
    }

    function cfgResetDescriptionOrder() {
      if (!confirm('é…ç½®é †åºã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) return;
      cfgRenderDescriptionOrder(_cfg_DESCRIPTION_ELEMENTS);
      alert('é…ç½®é †åºã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸã€‚');
    }
    window.cfgResetDescriptionOrder = cfgResetDescriptionOrder;

    // ============================================
    // Management Number Builder - Helper Functions
    // ============================================

    function cfgOpenAddSegmentModal() {
      _cfgMNB.currentEditingIndex = null;
      _cfgMNB.selectedType = null;
      document.getElementById('cfg-mnbModalTitle').textContent = 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ';
      document.getElementById('cfg-mnbSegmentConfig').innerHTML = '';
      document.getElementById('cfg-mnbSeparator').value = '-';
      document.getElementById('cfg-mnbTypeGridContainer').style.display = 'block';
      var grid = document.getElementById('cfg-mnbTypeGrid');
      if (grid) grid.querySelectorAll('.mnb-type-card').forEach(function(c) { c.classList.remove('selected'); });
      _cfgShowModal('cfg-mnbModal');
    }
    window.cfgOpenAddSegmentModal = cfgOpenAddSegmentModal;

    function cfgCloseSegmentModal() {
      _cfgHideModal('cfg-mnbModal');
    }
    window.cfgCloseSegmentModal = cfgCloseSegmentModal;

    function cfgSaveSegment() {
      if (!_cfgMNB.selectedType) { alert('ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
      var type = _cfgMNB.segmentTypes[_cfgMNB.selectedType];
      var config = {};
      type.fields.forEach(function(field) {
        var elem = document.getElementById('cfg-mnbField_' + field.id);
        if (elem) config[field.id] = elem.value;
      });
      var segment = { type: _cfgMNB.selectedType, config: config, separator: document.getElementById('cfg-mnbSeparator').value };
      if (_cfgMNB.currentEditingIndex !== null) {
        _cfgMNB.updateSegment(_cfgMNB.currentEditingIndex, segment);
      } else {
        _cfgMNB.addSegment(segment);
      }
      cfgCloseSegmentModal();
      // ã‚«ã‚¹ã‚¿ãƒ è¨­å®šé¸æŠä¸­ãªã‚‰UIãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
      var hidden = document.getElementById('cfg-mnbPresetSelect');
      if (hidden && hidden.value === 'custom') {
        var customCard = document.querySelector('#spa-page-config .mnb-preset-card[data-preset="custom"]');
        if (customCard) cfgRenderInlineCustomSettings(customCard);
      }
    }
    window.cfgSaveSegment = cfgSaveSegment;

    function cfgSelectPresetCard(presetKey) {
      var allCards = document.querySelectorAll('#spa-page-config .mnb-preset-card');
      allCards.forEach(function(card) {
        card.classList.remove('selected');
        var existing = card.querySelector('.mnb-inline-settings');
        if (existing) existing.remove();
      });
      var selectedCard = document.querySelector('#spa-page-config .mnb-preset-card[data-preset="' + presetKey + '"]');
      if (selectedCard) selectedCard.classList.add('selected');
      var hidden = document.getElementById('cfg-mnbPresetSelect');
      if (hidden) hidden.value = presetKey;
      _cfgMNB.applyPresetFromCard(presetKey);
      if (selectedCard) {
        if (presetKey === 'custom') { cfgRenderInlineCustomSettings(selectedCard); }
        else if (presetKey) { cfgRenderInlinePresetSettings(selectedCard); }
      }
      cfgUpdateCurrentSettingsView();
    }
    window.cfgSelectPresetCard = cfgSelectPresetCard;

    function cfgRenderInlinePresetSettings(cardElement) {
      var segments = _cfgMNB.segments;
      var segmentTypes = _cfgMNB.segmentTypes;
      if (!segments || segments.length === 0) return;
      var existing = cardElement.querySelector('.mnb-inline-settings');
      if (existing) existing.remove();

      var panel = document.createElement('div');
      panel.className = 'mnb-inline-settings';
      panel.style.cssText = 'margin-top: 12px; padding-top: 12px; border-top: 1px dashed #cbd5e1;';
      panel.onclick = function(e) { e.stopPropagation(); };
      var html = '';

      segments.forEach(function(segment, index) {
        var type = segmentTypes[segment.type];
        if (!type) return;
        if (type.fields && type.fields.length > 0) {
          type.fields.forEach(function(field) {
            if (field.conditional) {
              var cv = segment.config[field.conditional.field];
              if (cv !== field.conditional.value) return;
            }
            var fieldId = 'cfg-mnbInlineField_' + index + '_' + field.id;
            var currentValue = segment.config[field.id] || '';
            html += '<div style="margin-bottom: 8px;">';
            html += '<label style="font-size: 11px; color: #64748b; display: block; margin-bottom: 3px;">' + field.label + '</label>';
            if (field.type === 'select') {
              html += '<select id="' + fieldId + '" class="form-control" style="font-size: 16px;" onchange="cfgUpdateInlineSegmentConfig(' + index + ', \'' + field.id + '\', this.value)">';
              field.options.forEach(function(opt) {
                html += '<option value="' + opt.value + '"' + (opt.value === currentValue ? ' selected' : '') + '>' + opt.label + '</option>';
              });
              html += '</select>';
            } else if (field.type === 'number') {
              html += '<input type="number" id="' + fieldId + '" style="width: 100%; font-size: 16px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 6px; background: #f9fafb; box-sizing: border-box;" value="' + currentValue + '" placeholder="' + (field.placeholder || '') + '" onchange="cfgUpdateInlineSegmentConfig(' + index + ', \'' + field.id + '\', this.value)">';
            } else {
              html += '<input type="text" id="' + fieldId + '" style="width: 100%; font-size: 16px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 6px; background: #f9fafb; box-sizing: border-box;" value="' + currentValue + '" placeholder="' + (field.placeholder || '') + '" onchange="cfgUpdateInlineSegmentConfig(' + index + ', \'' + field.id + '\', this.value)">';
            }
            html += '</div>';
          });
        }
        if (index < segments.length - 1) {
          html += '<div style="margin-bottom: 8px;">';
          html += '<label style="font-size: 11px; color: #64748b; display: block; margin-bottom: 3px;">åŒºåˆ‡ã‚Š</label>';
          html += '<select id="cfg-mnbInlineSeparator_' + index + '" class="form-control" style="font-size: 16px;" onchange="cfgUpdateInlineSegmentSeparator(' + index + ', this.value)">';
          html += '<option value="-"' + (segment.separator === '-' ? ' selected' : '') + '>ãƒã‚¤ãƒ•ãƒ³ (-)</option>';
          html += '<option value="_"' + (segment.separator === '_' ? ' selected' : '') + '>ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ (_)</option>';
          html += '<option value="/"' + (segment.separator === '/' ? ' selected' : '') + '>ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ (/)</option>';
          html += '<option value=""' + (segment.separator === '' ? ' selected' : '') + '>ãªã—</option>';
          html += '</select></div>';
        }
      });

      html += '<div style="margin-top: 6px; padding: 6px 10px; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 5px; display: flex; align-items: center; justify-content: space-between;">';
      html += '<span style="font-size: 11px; color: #3b82f6;">ç”Ÿæˆä¾‹</span>';
      html += '<span id="cfg-mnbInlineTotalPreview" style="font-family: monospace; font-size: 14px; color: #1e40af; font-weight: 700;">' + _cfgMNB.generatePreview() + '</span></div>';

      panel.innerHTML = html;
      cardElement.appendChild(panel);
    }
    window.cfgRenderInlinePresetSettings = cfgRenderInlinePresetSettings;

    function cfgRenderInlineCustomSettings(cardElement) {
      var segments = _cfgMNB.segments;
      var segmentTypes = _cfgMNB.segmentTypes;
      var existing = cardElement.querySelector('.mnb-inline-settings');
      if (existing) existing.remove();

      var panel = document.createElement('div');
      panel.className = 'mnb-inline-settings';
      panel.style.cssText = 'margin-top: 12px; padding-top: 12px; border-top: 1px dashed #cbd5e1;';
      panel.onclick = function(e) { e.stopPropagation(); };
      var html = '';

      if (segments.length > 0) {
        html += '<div style="margin-bottom: 10px;">';
        segments.forEach(function(seg, i) {
          var type = segmentTypes[seg.type]; if (!type) return;
          var preview = type.preview(seg.config);
          var sep = (i < segments.length - 1 && seg.separator) ? seg.separator : '';
          html += '<div style="display: flex; align-items: center; gap: 6px; padding: 8px 10px; background: #f8fafc; border-radius: 6px; margin-bottom: 6px;">';
          html += '<span style="font-size: 16px;">' + type.icon + '</span>';
          html += '<span style="flex: 1; font-size: 13px; color: #374151;">' + type.name + '</span>';
          html += '<span style="font-family: monospace; font-size: 13px; color: #3b82f6; font-weight: 600;">' + preview + (sep ? '<span style="color: #f97316;">' + sep + '</span>' : '') + '</span>';
          html += '<button onclick="event.stopPropagation(); _cfgMNB.editSegment(' + i + ')" style="padding: 3px 8px; font-size: 11px; background: #e5e7eb; color: #374151; border: none; border-radius: 4px; cursor: pointer;">ç·¨é›†</button>';
          html += '<button onclick="event.stopPropagation(); cfgRemoveCustomSegmentAndRefresh(' + i + ')" style="padding: 3px 8px; font-size: 11px; background: #fee2e2; color: #dc2626; border: none; border-radius: 4px; cursor: pointer;">å‰Šé™¤</button>';
          html += '</div>';
        });
        html += '</div>';
      } else {
        html += '<div style="text-align: center; padding: 12px; color: #94a3b8; font-size: 12px; background: #f8fafc; border-radius: 6px; margin-bottom: 10px;">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>';
      }

      html += '<button onclick="event.stopPropagation(); cfgOpenAddSegmentModal()" style="width: 100%; padding: 10px; font-size: 13px; font-weight: 600; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">';
      html += '<span style="font-size: 16px;">+</span> ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ </button>';

      var previewStr = _cfgMNB.generatePreview();
      if (previewStr) {
        html += '<div style="margin-top: 10px; padding: 6px 10px; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 5px; display: flex; align-items: center; justify-content: space-between;">';
        html += '<span style="font-size: 11px; color: #3b82f6;">ç”Ÿæˆä¾‹</span>';
        html += '<span id="cfg-mnbInlineTotalPreview" style="font-family: monospace; font-size: 14px; color: #1e40af; font-weight: 700;">' + previewStr + '</span></div>';
      }

      panel.innerHTML = html;
      cardElement.appendChild(panel);
    }
    window.cfgRenderInlineCustomSettings = cfgRenderInlineCustomSettings;

    function cfgRemoveCustomSegmentAndRefresh(index) {
      _cfgMNB.removeSegment(index);
      var customCard = document.querySelector('#spa-page-config .mnb-preset-card[data-preset="custom"]');
      if (customCard) cfgRenderInlineCustomSettings(customCard);
    }
    window.cfgRemoveCustomSegmentAndRefresh = cfgRemoveCustomSegmentAndRefresh;

    function cfgUpdateInlineSegmentConfig(segIndex, fieldId, value) {
      if (!_cfgMNB.segments[segIndex]) return;
      _cfgMNB.segments[segIndex].config[fieldId] = value;
      cfgUpdateInlineTotalPreview();
      _cfgMNB.updatePreview();
    }
    window.cfgUpdateInlineSegmentConfig = cfgUpdateInlineSegmentConfig;

    function cfgUpdateInlineSegmentSeparator(segIndex, value) {
      if (!_cfgMNB.segments[segIndex]) return;
      _cfgMNB.segments[segIndex].separator = value;
      cfgUpdateInlineTotalPreview();
      _cfgMNB.updatePreview();
    }
    window.cfgUpdateInlineSegmentSeparator = cfgUpdateInlineSegmentSeparator;

    function cfgUpdateInlineTotalPreview() {
      var el = document.getElementById('cfg-mnbInlineTotalPreview');
      if (el) el.textContent = _cfgMNB.generatePreview();
    }

    function cfgUpdateCurrentSettingsView() {
      var noMsg = document.getElementById('cfg-mnbNoSettingsMessage');
      var curSettings = document.getElementById('cfg-mnbCurrentSettings');
      var presetNameElem = document.getElementById('cfg-mnbCurrentPresetName');
      var previewElem = document.getElementById('cfg-mnbCurrentPreview');
      var segments = _cfgMNB.segments || [];

      if (segments.length === 0) {
        if (noMsg) noMsg.style.display = 'block';
        if (curSettings) curSettings.style.display = 'none';
        return;
      }
      if (noMsg) noMsg.style.display = 'none';
      if (curSettings) curSettings.style.display = 'block';

      var presetKey = (document.getElementById('cfg-mnbPresetSelect') || {}).value || '';
      var presetNames = {
        'simple': '<i class="bi bi-123" style="margin-right: 4px;"></i>ã‚·ãƒ³ãƒ—ãƒ«é€£ç•ª',
        'shelf': '<i class="bi bi-box-seam" style="margin-right: 4px;"></i>æ£šç•ªå· + é€£ç•ª',
        'category_date': '<i class="bi bi-calendar-date" style="margin-right: 4px;"></i>ã‚«ãƒ†ã‚´ãƒª + æ—¥ä»˜ + é€£ç•ª',
        'shelf_date': '<i class="bi bi-calendar" style="margin-right: 4px;"></i>æ£šç•ªå· + æ—¥ä»˜ + é€£ç•ª',
        'category_rank': '<i class="bi bi-star" style="margin-right: 4px;"></i>ã‚«ãƒ†ã‚´ãƒª + ãƒ©ãƒ³ã‚¯ + é€£ç•ª',
        'custom': '<i class="bi bi-tools" style="margin-right: 4px;"></i>ã‚«ã‚¹ã‚¿ãƒ è¨­å®š'
      };
      if (presetNameElem) presetNameElem.innerHTML = presetNames[presetKey] || presetNames['custom'];
      if (previewElem) previewElem.textContent = _cfgMNB.generatePreview() || '---';
    }
    window.cfgUpdateCurrentSettingsView = cfgUpdateCurrentSettingsView;

    function cfgUpdateMnbFormatPreview() {
      var titleFormat = document.getElementById('cfg-mnb-titleFormat');
      var descFormat = document.getElementById('cfg-mnb-descFormat');
      var titlePreview = document.getElementById('cfg-mnb-titleFormatPreview');
      var descPreview = document.getElementById('cfg-mnb-descFormatPreview');
      if (!titlePreview || !descPreview) return;

      var currentPreview = document.getElementById('cfg-mnbCurrentPreview');
      var mn = currentPreview ? currentPreview.textContent : 'AA-1001';
      if (mn === '---') mn = 'AA-001';

      // å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      if (titleFormat) {
        var fmt = titleFormat.value;
        var formatted = (fmt === 'none') ? mn : fmt.charAt(0) + mn + fmt.charAt(1);
        titlePreview.textContent = 'UNIQLO ã‚¦ãƒ«ãƒˆãƒ©ãƒ©ã‚¤ãƒˆãƒ€ã‚¦ãƒ³' + formatted;
        // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒ©ãƒ™ãƒ«æ›´æ–°
        var opts = titleFormat.options;
        for (var i = 0; i < opts.length; i++) {
          var v = opts[i].value;
          if (v === 'ã€ã€‘') opts[i].text = 'ã€' + mn + 'ã€‘';
          else if (v === 'ï¼ˆï¼‰') opts[i].text = 'ï¼ˆ' + mn + 'ï¼‰';
          else if (v === 'ã€ã€') opts[i].text = 'ã€' + mn + 'ã€';
          else if (v === 'ã€Œã€') opts[i].text = 'ã€Œ' + mn + 'ã€';
          else if (v === 'none') opts[i].text = mn;
        }
      }
      // èª¬æ˜æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      if (descFormat) {
        var fmt2 = descFormat.value;
        var formatted2 = (fmt2 === 'none') ? mn : fmt2.charAt(0) + mn + fmt2.charAt(1);
        descPreview.textContent = 'ç®¡ç†ç•ªå·ï¼š' + formatted2;
        var opts2 = descFormat.options;
        for (var j = 0; j < opts2.length; j++) {
          var v2 = opts2[j].value;
          if (v2 === 'ã€ã€‘') opts2[j].text = 'ã€' + mn + 'ã€‘';
          else if (v2 === 'ï¼ˆï¼‰') opts2[j].text = 'ï¼ˆ' + mn + 'ï¼‰';
          else if (v2 === 'ã€ã€') opts2[j].text = 'ã€' + mn + 'ã€';
          else if (v2 === 'ã€Œã€') opts2[j].text = 'ã€Œ' + mn + 'ã€';
          else if (v2 === 'none') opts2[j].text = mn;
        }
      }
    }
    window.cfgUpdateMnbFormatPreview = cfgUpdateMnbFormatPreview;

    function cfgToggleMnbAccordion(section) {
      if (section === 'preset') {
        var content = document.getElementById('cfg-mnbPresetContent');
        var arrow = document.getElementById('cfg-mnbPresetArrow');
        if (!content || !arrow) return;
        var isOpen = content.style.display !== 'none';
        if (isOpen) { content.style.display = 'none'; arrow.textContent = '+'; }
        else {
          content.style.display = 'block'; arrow.textContent = '-';
          var curKey = (document.getElementById('cfg-mnbPresetSelect') || {}).value || '';
          if (curKey) {
            document.querySelectorAll('#spa-page-config .mnb-preset-card').forEach(function(c) {
              c.classList.remove('selected');
              var p = c.querySelector('.mnb-inline-settings'); if (p) p.remove();
            });
            var sel = document.querySelector('#spa-page-config .mnb-preset-card[data-preset="' + curKey + '"]');
            if (sel) {
              sel.classList.add('selected');
              if (curKey === 'custom') cfgRenderInlineCustomSettings(sel);
              else cfgRenderInlinePresetSettings(sel);
            }
          }
        }
      }
    }
    window.cfgToggleMnbAccordion = cfgToggleMnbAccordion;

    // ============================================
    // Basic Settings (ãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬è¨­å®š)
    // ============================================

    async function cfgLoadBasicSettings() {
      try {
        var userName = localStorage.getItem('reborn_user_name') || '';
        var userEmail = localStorage.getItem('reborn_user_email') || '';
        var permissionId = localStorage.getItem('reborn_user_permission_id') || 'staff';

        // Firestoreã‹ã‚‰æœ€æ–°æ¨©é™ã‚’å–å¾—
        if (window.db && userEmail) {
          try {
            var userDoc = await window.db.collection('users').doc(userEmail).get();
            if (userDoc.exists) {
              var userData = userDoc.data();
              permissionId = userData.permissionId || permissionId;
              localStorage.setItem('reborn_user_permission_id', permissionId);
              if (userData.userName) userName = userData.userName;

              // ç™ºé€å…ˆãƒ»å£åº§æƒ…å ±ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
              cfgUpdateShippingInfoStatus(userData.shippingInfo || {});
              cfgUpdateBankAccountStatus(userData.bankAccount || {});

              // ç®¡ç†è€…ã¯ç™ºé€å…ˆãƒ»å£åº§ã‚»ã‚¯ã‚·ãƒ§ãƒ³éè¡¨ç¤º
              if (permissionId === 'owner') {
                var ss = document.getElementById('cfg-shippingInfoSection');
                var bs = document.getElementById('cfg-bankAccountSection');
                if (ss) ss.style.display = 'none';
                if (bs) bs.style.display = 'none';
              }
            }
          } catch (e) { console.warn('[config] Firestoreæ¨©é™å–å¾—å¤±æ•—:', e); }
        }

        // æ¨©é™ãƒãƒƒã‚¸
        var badge = document.getElementById('cfg-basicUserPermissionBadge');
        if (badge) badge.innerHTML = cfgGetPermissionBadgeHTML(permissionId);

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å
        var nameInput = document.getElementById('cfg-basicUserName');
        if (nameInput) {
          nameInput.value = userName;
          var clearBtn = document.getElementById('cfg-clearUserNameBtn');
          if (clearBtn) clearBtn.style.display = userName ? 'block' : 'none';
          nameInput.addEventListener('input', function() {
            if (clearBtn) clearBtn.style.display = this.value ? 'block' : 'none';
          });
        }

        // ãƒ¡ãƒ¼ãƒ«
        var emailInput = document.getElementById('cfg-basicUserEmail');
        if (emailInput) emailInput.value = userEmail;

        // é€šçŸ¥è¨­å®š
        var config = {};
        try { config = JSON.parse(localStorage.getItem('config') || '{}'); } catch(e) {}
        var notifCheckbox = document.getElementById('cfg-basicNotificationEnabled');
        var soundCheckbox = document.getElementById('cfg-basicNotificationSound');
        if (notifCheckbox) notifCheckbox.checked = config.notificationEnabled !== false;
        if (soundCheckbox) soundCheckbox.checked = config.notificationSound !== false;

        // ã‚¢ã‚¤ã‚³ãƒ³
        var iconUrl = localStorage.getItem('reborn_user_icon_url');
        var iconPreview = document.getElementById('cfg-basicUserIconPreview');
        if (iconPreview && iconUrl) {
          iconPreview.innerHTML = '<img src="' + iconUrl + '" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">';
        }

        console.log('[config] åŸºæœ¬è¨­å®šèª­ã¿è¾¼ã¿å®Œäº†:', { userName: userName, permissionId: permissionId });
      } catch (e) {
        console.error('[config] åŸºæœ¬è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
      }

      var loading = document.getElementById('cfg-basicSettingsLoading');
      var content = document.getElementById('cfg-basicSettingsContent');
      if (loading) loading.style.display = 'none';
      if (content) content.style.display = 'block';
    }

    async function cfgSaveBasicSettings(silent) {
      var nameInput = document.getElementById('cfg-basicUserName');
      var userName = nameInput ? nameInput.value.trim() : '';
      if (!userName) {
        if (!silent) alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      var settings = {
        userName: userName,
        notificationEnabled: document.getElementById('cfg-basicNotificationEnabled')?.checked !== false,
        notificationSound: document.getElementById('cfg-basicNotificationSound')?.checked !== false
      };

      try {
        // localStorageä¿å­˜
        var config = {};
        try { config = JSON.parse(localStorage.getItem('config') || '{}'); } catch(e) {}
        config.userName = settings.userName;
        config.notificationEnabled = settings.notificationEnabled;
        config.notificationSound = settings.notificationSound;
        localStorage.setItem('config', JSON.stringify(config));
        localStorage.setItem('reborn_user_name', settings.userName);

        // IndexedDBä¿å­˜ï¼ˆSWç”¨ï¼‰
        try { await cfgSaveNotificationSoundToIndexedDB(settings.notificationSound); } catch(e) {}

        // Firestoreä¿å­˜
        var userEmail = localStorage.getItem('reborn_user_email');
        if (userEmail && window.db) {
          await window.db.collection('users').doc(userEmail).set({
            userName: settings.userName,
            notificationEnabled: settings.notificationEnabled,
            notificationSound: settings.notificationSound,
            lastUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });

          await window.db.collection('activeDevices').doc(userEmail).set({
            notificationEnabled: settings.notificationEnabled,
            notificationSound: settings.notificationSound,
            lastUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        }

        var clearBtn = document.getElementById('cfg-clearUserNameBtn');
        if (clearBtn) clearBtn.style.display = settings.userName ? 'block' : 'none';

        if (!silent) alert('åŸºæœ¬è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      } catch (e) {
        console.error('[config] åŸºæœ¬è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
        if (!silent) alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    }
    window.cfgSaveBasicSettings = cfgSaveBasicSettings;

    function cfgSaveNotificationSoundToIndexedDB(soundEnabled) {
      return new Promise(function(resolve, reject) {
        var req = indexedDB.open('SettingsDB', 1);
        req.onupgradeneeded = function(e) {
          var db = e.target.result;
          if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings');
        };
        req.onsuccess = function() {
          var db = req.result;
          try {
            var tx = db.transaction('settings', 'readwrite');
            tx.objectStore('settings').put(soundEnabled, 'notificationSound');
            tx.oncomplete = function() { db.close(); resolve(true); };
            tx.onerror = function() { db.close(); reject(tx.error); };
          } catch (e) { db.close(); reject(e); }
        };
        req.onerror = function() { reject(req.error); };
      });
    }

    function cfgGetPermissionBadgeHTML(permissionId) {
      var colors = { owner: '#dc2626', manager: '#2563eb', staff: '#059669' };
      var labels = { owner: 'ã‚ªãƒ¼ãƒŠãƒ¼', manager: 'ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼', staff: 'ã‚¹ã‚¿ãƒƒãƒ•' };
      var color = colors[permissionId] || '#6b7280';
      var label = labels[permissionId] || permissionId;
      return '<span style="display: inline-block; padding: 2px 10px; background: ' + color + '; color: white; border-radius: 10px; font-size: 12px; font-weight: 600;">' + label + '</span>';
    }

    function cfgUpdateShippingInfoStatus(info) {
      var el = document.getElementById('cfg-shippingInfoStatus');
      if (!el) return;
      if (info && info.name) {
        el.innerHTML = '<span style="color: #059669;"><i class="bi bi-check-circle-fill"></i> ç™»éŒ²æ¸ˆã¿</span>';
      } else {
        el.innerHTML = '<span style="color: #ef4444;"><i class="bi bi-exclamation-circle-fill"></i> æœªç™»éŒ²</span>';
      }
    }

    function cfgUpdateBankAccountStatus(info) {
      var el = document.getElementById('cfg-bankAccountStatus');
      if (!el) return;
      if (info && info.bankName) {
        el.innerHTML = '<span style="color: #059669;"><i class="bi bi-check-circle-fill"></i> ç™»éŒ²æ¸ˆã¿</span>';
      } else {
        el.innerHTML = '<span style="color: #ef4444;"><i class="bi bi-exclamation-circle-fill"></i> æœªç™»éŒ²</span>';
      }
    }

    // ============================================
    // Compensation Settings
    // ============================================

    function cfgCollectCompensationSettings() {
      return {
        taskRates: {
          listing: parseInt(document.getElementById('cfg-compensation-listing')?.value) || 100,
          shipping: parseInt(document.getElementById('cfg-compensation-shipping')?.value) || 100,
          photography: parseInt(document.getElementById('cfg-compensation-photography')?.value) || 50,
          inspection: parseInt(document.getElementById('cfg-compensation-inspection')?.value) || 30,
          stocktaking: parseInt(document.getElementById('cfg-compensation-stocktaking')?.value) || 20,
          editing: parseInt(document.getElementById('cfg-compensation-editing')?.value) || 50
        },
        customTasks: cfgCollectCustomTasks(),
        options: {
          autoRecordListing: document.getElementById('cfg-autoRecordListing')?.checked ?? true,
          autoRecordShipping: document.getElementById('cfg-autoRecordShipping')?.checked ?? true,
          cutoffDay: document.getElementById('cfg-compensationCutoffDay')?.value || 'æœ«æ—¥',
          paymentDay: document.getElementById('cfg-compensationPaymentDay')?.value || 'ç¿Œæœˆ5æ—¥',
          recordAsExpense: document.getElementById('cfg-recordAsExpense')?.checked ?? true
        }
      };
    }

    function cfgCollectCustomTasks() {
      var tasks = [];
      var container = document.getElementById('cfg-customTasksContainer');
      if (!container) return tasks;
      container.querySelectorAll('.custom-task-item').forEach(function(item) {
        var nameInput = item.querySelector('.custom-task-name');
        var rateInput = item.querySelector('.custom-task-rate');
        if (nameInput && rateInput && nameInput.value.trim()) {
          tasks.push({ id: item.dataset.taskId || 'custom_' + Date.now(), name: nameInput.value.trim(), rate: parseInt(rateInput.value) || 0 });
        }
      });
      return tasks;
    }

    async function cfgLoadCompensationSettingsFromFirestore() {
      if (!window.db) return;
      try {
        var doc = await window.db.collection('settings').doc('compensation').get();
        if (doc.exists) {
          cfgLoadCompensationSettings({ 'å ±é…¬è¨­å®š': doc.data() });
        }
      } catch (e) { console.error('[config-fragment] compensation load error:', e); }
    }

    function cfgLoadCompensationSettings(config) {
      if (!config || !config['å ±é…¬è¨­å®š']) return;
      var settings = config['å ±é…¬è¨­å®š'];
      if (settings.taskRates) {
        ['listing', 'shipping', 'photography', 'inspection', 'stocktaking', 'editing'].forEach(function(task) {
          if (settings.taskRates[task] !== undefined) {
            var el = document.getElementById('cfg-compensation-' + task);
            if (el) el.value = settings.taskRates[task];
          }
        });
      }
      if (settings.customTasks) {
        settings.customTasks.forEach(function(task) {
          cfgAddCustomCompensationTask(task.name, task.rate, task.id);
        });
      }
      if (settings.options) {
        var opts = settings.options;
        var autoListing = document.getElementById('cfg-autoRecordListing');
        if (autoListing) autoListing.checked = opts.autoRecordListing ?? true;
        var autoShipping = document.getElementById('cfg-autoRecordShipping');
        if (autoShipping) autoShipping.checked = opts.autoRecordShipping ?? true;
        var cutoff = document.getElementById('cfg-compensationCutoffDay');
        if (cutoff) cutoff.value = opts.cutoffDay || 'æœ«æ—¥';
        var payment = document.getElementById('cfg-compensationPaymentDay');
        if (payment) payment.value = opts.paymentDay || 'ç¿Œæœˆ5æ—¥';
        var expense = document.getElementById('cfg-recordAsExpense');
        if (expense) expense.checked = opts.recordAsExpense ?? true;
      }
    }

    async function cfgSaveCompensationSettings() {
      if (!window.db) return;
      try {
        var settings = cfgCollectCompensationSettings();
        settings.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
        await window.db.collection('settings').doc('compensation').set(settings, { merge: true });
      } catch (e) { console.error('[config-fragment] compensation save error:', e); }
    }

    function cfgAddCustomCompensationTask(name, rate, taskId) {
      var container = document.getElementById('cfg-customTasksContainer');
      var wrapper = document.getElementById('cfg-customCompensationTasks');
      if (!container || !wrapper) return;
      wrapper.style.display = 'block';
      var id = taskId || 'custom_' + (++_cfg_customTaskCounter);
      var html = '<div class="custom-task-item" data-task-id="' + id + '" style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb; margin-bottom: 6px;">' +
        '<div style="flex: 1;"><input type="text" class="custom-task-name form-control" value="' + (name || '') + '" placeholder="ã‚¿ã‚¹ã‚¯å" style="font-size: 14px;"></div>' +
        '<div style="display: flex; align-items: center; gap: 4px;"><span style="font-size: 14px; color: #6b7280;">Â¥</span><input type="number" class="custom-task-rate" value="' + (rate || 0) + '" min="0" step="10" style="width: 80px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; text-align: right;"><span style="font-size: 12px; color: #6b7280;">/ä»¶</span></div>' +
        '<button type="button" onclick="cfgRemoveCustomCompensationTask(this)" style="background: none; border: none; color: #ef4444; font-size: 16px; cursor: pointer; padding: 4px;" title="å‰Šé™¤"><i class="bi bi-x-lg"></i></button></div>';
      container.insertAdjacentHTML('beforeend', html);
    }
    window.cfgAddCustomCompensationTask = cfgAddCustomCompensationTask;

    function cfgRemoveCustomCompensationTask(btn) {
      var item = btn.closest('.custom-task-item');
      if (item) {
        item.remove();
        var container = document.getElementById('cfg-customTasksContainer');
        var wrapper = document.getElementById('cfg-customCompensationTasks');
        if (container && wrapper && container.children.length === 0) wrapper.style.display = 'none';
      }
    }
    window.cfgRemoveCustomCompensationTask = cfgRemoveCustomCompensationTask;

    function cfgOpenCompensationManagement() {
      if (typeof navigateToPage === 'function') {
        navigateToPage('compensation');
      }
    }
    window.cfgOpenCompensationManagement = cfgOpenCompensationManagement;

    function cfgAssignAllTasksToAll() {
      document.querySelectorAll('#spa-page-config .task-assign-checkbox').forEach(function(cb) { cb.checked = true; });
      document.querySelectorAll('#spa-page-config [id^="cfg-task-accordion-"]').forEach(function(el) {
        if (!el.id.includes('-badge') && !el.id.includes('-arrow')) cfgUpdateTaskBadge(el.id);
      });
    }
    window.cfgAssignAllTasksToAll = cfgAssignAllTasksToAll;

    // User task assignment
    async function cfgLoadUserTaskAssignmentList() {
      var container = document.getElementById('cfg-userTaskAssignmentList');
      if (!container || !window.db) return;
      try {
        var snapshot = await window.db.collection('users').get();
        var users = [];
        var permLabels = { owner: 'ç®¡ç†è€…', admin: 'ç®¡ç†è€…', employee: 'ç¤¾å“¡', staff: 'ã‚¹ã‚¿ãƒƒãƒ•', leader: 'ãƒªãƒ¼ãƒ€ãƒ¼', contractor: 'å¤–æ³¨' };
        snapshot.forEach(function(docSnap) {
          var data = docSnap.data();
          var permId = data.permissionId || 'staff';
          users.push({
            email: docSnap.id, name: data.userName || docSnap.id,
            permissionId: permId, permissionDisplay: permLabels[permId] || 'ã‚¹ã‚¿ãƒƒãƒ•',
            assignedTasks: data.assignedTasks || ['listing', 'shipping', 'photography', 'stocktaking', 'editing']
          });
        });
        users.sort(function(a, b) { var order = { owner: 1, admin: 2, staff: 3 }; return (order[a.permissionId] || 99) - (order[b.permissionId] || 99); });

        var tasks = [
          { id: 'listing', name: 'å•†å“å‡ºå“' }, { id: 'shipping', name: 'æ¢±åŒ…ãƒ»ç™ºé€' },
          { id: 'photography', name: 'å•†å“æ’®å½±' }, { id: 'inspection', name: 'æ¤œå“ä½œæ¥­' },
          { id: 'stocktaking', name: 'æ£šå¸' }, { id: 'editing', name: 'è¿½åŠ ç·¨é›†' }
        ];

        container.innerHTML = users.map(function(user, index) {
          var accordionId = 'cfg-task-accordion-' + index;
          var taskItems = tasks.map(function(task) {
            var checked = user.assignedTasks.includes(task.id) ? 'checked' : '';
            return '<label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;">' +
              '<input type="checkbox" class="task-assign-checkbox" data-email="' + user.email + '" data-task="' + task.id + '" ' + checked + ' style="width: 22px; height: 22px;" onchange="cfgUpdateTaskBadge(\'' + accordionId + '\')">' +
              '<span style="font-size: 14px; color: #374151;">' + task.name + '</span></label>';
          }).join('');

          return '<div style="border: 1px solid #e5e7eb; border-radius: 10px; overflow: hidden; background: white;">' +
            '<div onclick="cfgToggleTaskAccordion(\'' + accordionId + '\')" style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; cursor: pointer;">' +
              '<div style="flex: 1;"><div style="font-size: 14px; font-weight: 600;">' + cfgEscapeHtml(user.name) + '</div><span style="font-size: 11px; color: #9ca3af;">' + user.permissionDisplay + '</span></div>' +
              '<span id="' + accordionId + '-badge" style="color: #6b7280; font-size: 12px;">' + user.assignedTasks.length + 'ä»¶</span>' +
              '<i id="' + accordionId + '-arrow" class="bi bi-chevron-right" style="font-size: 12px; color: #9ca3af;"></i>' +
            '</div>' +
            '<div id="' + accordionId + '" style="display: none; border-top: 1px solid #e5e7eb; background: #f9fafb; padding: 12px;"><div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">' + taskItems + '</div></div></div>';
        }).join('');
      } catch (e) { console.error('[config-fragment] task assignment error:', e); }
    }

    function cfgToggleTaskAccordion(accordionId) {
      var content = document.getElementById(accordionId);
      var arrow = document.getElementById(accordionId + '-arrow');
      if (!content || !arrow) return;
      if (content.style.display === 'none') { content.style.display = 'block'; arrow.style.transform = 'rotate(90deg)'; }
      else { content.style.display = 'none'; arrow.style.transform = 'rotate(0deg)'; }
    }
    window.cfgToggleTaskAccordion = cfgToggleTaskAccordion;

    function cfgUpdateTaskBadge(accordionId) {
      var content = document.getElementById(accordionId);
      if (!content) return;
      var count = content.querySelectorAll('.task-assign-checkbox:checked').length;
      var badge = document.getElementById(accordionId + '-badge');
      if (badge) badge.textContent = count + 'ä»¶';
    }
    window.cfgUpdateTaskBadge = cfgUpdateTaskBadge;

    async function cfgSaveUserTaskAssignments() {
      if (!window.db) return;
      var assignments = {};
      document.querySelectorAll('#spa-page-config .task-assign-checkbox').forEach(function(cb) {
        var email = cb.dataset.email;
        if (!assignments[email]) assignments[email] = [];
        if (cb.checked) assignments[email].push(cb.dataset.task);
      });
      try {
        var batch = window.db.batch();
        Object.keys(assignments).forEach(function(email) {
          batch.update(window.db.collection('users').doc(email), { assignedTasks: assignments[email], updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        });
        await batch.commit();
      } catch (e) { console.error('[config-fragment] task save error:', e); }
    }

    // ============================================
    // User Management
    // ============================================

    async function cfgLoadUserManagement() {
      var loadingDiv = document.getElementById('cfg-userManagementLoading');
      var contentDiv = document.getElementById('cfg-userManagementContent');
      if (!loadingDiv || !contentDiv) return;

      var permissionId = localStorage.getItem('reborn_user_permission_id')
                      || localStorage.getItem('reborn_user_permission');
      if (permissionId !== 'owner') {
        loadingDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 14px; color: #dc2626;">ã“ã®æ©Ÿèƒ½ã¯ç®¡ç†è€…ã®ã¿åˆ©ç”¨ã§ãã¾ã™</div></div>';
        return;
      }

      if (!window.db) { setTimeout(cfgLoadUserManagement, 500); return; }

      try {
        var snapshot = await window.db.collection('users').get();
        var users = [];
        snapshot.forEach(function(doc) { users.push({ id: doc.id, ...doc.data() }); });
        _cfg_allUsersData = users;
        cfgRenderAllUsers(users);
        loadingDiv.style.display = 'none';
        contentDiv.style.display = 'block';
      } catch (e) {
        console.error('[config-fragment] user management error:', e);
        loadingDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #dc2626;">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      }
    }

    function cfgRenderAllUsers(users) {
      var pending = users.filter(function(u) { return u.status === 'pending'; });
      var active = users.filter(function(u) { return u.status === 'active' || !u.status; });
      var inactive = users.filter(function(u) { return u.status === 'inactive' || u.status === 'rejected'; });

      var pendingCount = document.getElementById('cfg-pendingUsersCount');
      var inactiveCount = document.getElementById('cfg-inactiveUsersCount');
      if (pendingCount) pendingCount.textContent = pending.length;
      if (inactiveCount) inactiveCount.textContent = inactive.length;

      // Pending
      var pendingSection = document.getElementById('cfg-pendingSection');
      if (pending.length > 0 && pendingSection) {
        pendingSection.style.display = 'block';
        document.getElementById('cfg-pendingUsersList').innerHTML = cfgRenderUserRows(users.filter(function(u) { return u.status === 'pending'; }), 'pending');
      } else if (pendingSection) { pendingSection.style.display = 'none'; }

      // Permission groups
      var groupsContainer = document.getElementById('cfg-permissionGroups');
      if (groupsContainer) {
        var permGroups = {};
        var permOrder = ['owner', 'employee', 'leader', 'staff', 'contractor'];
        active.forEach(function(u) {
          var perm = u.permissionId || 'staff';
          if (!permGroups[perm]) permGroups[perm] = [];
          permGroups[perm].push(u);
        });
        var html = '';
        permOrder.forEach(function(permId) {
          var grpUsers = permGroups[permId];
          if (!grpUsers || grpUsers.length === 0) return;
          var permDef = _cfg_PERMISSION_DEFINITIONS[permId] || { label: permId };
          html += '<div style="background: white; border-radius: 8px; border: 1px solid #e5e7eb; overflow: hidden; margin-bottom: 8px;">' +
            '<div style="padding: 12px 16px; background: #f9fafb; display: flex; align-items: center; gap: 8px;">' +
              '<span style="font-size: 14px; font-weight: 600; color: #374151;">' + permDef.label + '</span>' +
              '<span style="background: #e5e7eb; font-size: 11px; padding: 2px 8px; border-radius: 10px;">' + grpUsers.length + '</span></div>' +
            '<div style="padding: 8px;">' + cfgRenderUserRows(grpUsers, 'active') + '</div></div>';
        });
        groupsContainer.innerHTML = html || '<div style="text-align: center; color: #9ca3af; padding: 20px;">æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“</div>';
      }

      // Inactive
      var inactiveSection = document.getElementById('cfg-inactiveSection');
      if (inactive.length > 0 && inactiveSection) {
        inactiveSection.style.display = 'block';
        document.getElementById('cfg-inactiveUsersList').innerHTML = cfgRenderUserRows(inactive, 'inactive');
      } else if (inactiveSection) { inactiveSection.style.display = 'none'; }
    }

    function cfgRenderUserRows(users, status) {
      var now = Date.now();
      return users.map(function(user) {
        var userName = user.userName || user.name || 'Unknown';
        var isOnline = false;
        if (user.lastActiveAt) {
          var lastActive = typeof user.lastActiveAt === 'string' ? new Date(user.lastActiveAt).getTime() : (user.lastActiveAt.toDate ? user.lastActiveAt.toDate().getTime() : 0);
          isOnline = (now - lastActive) < 300000;
        }
        var userData = encodeURIComponent(JSON.stringify(user));
        return '<div onclick="cfgOpenUserDetailModal(\'' + userData + '\', \'' + status + '\')" style="display: flex; align-items: center; gap: 12px; padding: 10px 12px; margin-bottom: 4px; background: #f9fafb; border-radius: 8px; cursor: pointer;">' +
          '<div style="flex-shrink: 0; position: relative;">' +
            (user.photoURL ? '<img src="' + user.photoURL + '" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">' : '<div style="width: 40px; height: 40px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center;"><i class="bi bi-person" style="font-size: 20px; color: #9ca3af;"></i></div>') +
            '<div style="position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; background: ' + (isOnline ? '#10b981' : '#d1d5db') + '; border: 2px solid white; border-radius: 50%;"></div>' +
          '</div>' +
          '<div style="flex: 1;"><div style="font-size: 14px; font-weight: 500;">' + cfgEscapeHtml(userName) + '</div></div>' +
          '<div style="color: #9ca3af;">></div></div>';
      }).join('');
    }

    function cfgOpenUserDetailModal(encodedData, status) {
      var user = JSON.parse(decodeURIComponent(encodedData));
      var modal = document.getElementById('cfg-userDetailModal');
      var content = document.getElementById('cfg-userDetailContent');
      var actionsDiv = document.getElementById('cfg-userDetailActions');
      if (!modal || !content || !actionsDiv) return;

      var userName = user.userName || user.name || 'Unknown';
      var userEmail = user.userEmail || user.email || '';
      var permId = user.permissionId || 'staff';
      var permDef = _cfg_PERMISSION_DEFINITIONS[permId] || { label: permId };

      var statusLabel = status === 'active' ? 'æœ‰åŠ¹' : status === 'pending' ? 'æ‰¿èªå¾…ã¡' : 'ç„¡åŠ¹';
      var statusColor = status === 'active' ? '#10b981' : status === 'pending' ? '#f59e0b' : '#6b7280';
      content.innerHTML = '<div style="text-align: center; margin-bottom: 24px; padding-top: 4px;">' +
        (user.photoURL ? '<img src="' + user.photoURL + '" style="width: 64px; height: 64px; border-radius: 50%; object-fit: cover; margin-bottom: 12px;">' : '<div style="width: 64px; height: 64px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px;"><i class="bi bi-person" style="font-size: 28px; color: #9ca3af;"></i></div>') +
        '<div style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">' + cfgEscapeHtml(userName) + '</div>' +
        '<div style="font-size: 13px; color: #6b7280;">' + cfgEscapeHtml(userEmail) + '</div></div>' +
        '<div style="background: #f9fafb; border-radius: 12px; padding: 16px;">' +
          '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;"><span style="color: #6b7280; font-size: 13px;">æ¨©é™</span><span style="font-size: 13px; font-weight: 500;">' + permDef.label + '</span></div>' +
          '<div style="display: flex; justify-content: space-between; align-items: center;"><span style="color: #6b7280; font-size: 13px;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span><span style="font-size: 13px; font-weight: 500; color: ' + statusColor + ';">' + statusLabel + '</span></div></div>';

      var currentEmail = localStorage.getItem('reborn_user_email');
      var isSelf = userEmail === currentEmail;
      var actionButtons = '';

      if (status === 'pending') {
        actionButtons = '<div style="display: flex; gap: 12px;">' +
          '<button onclick="cfgRejectUser(\'' + user.id + '\')" style="flex: 1; padding: 12px; background: #fee2e2; color: #dc2626; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer;">æ‹’å¦</button>' +
          '<button onclick="cfgApproveUser(\'' + user.id + '\')" style="flex: 1; padding: 12px; background: #10b981; color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer;">æ‰¿èª</button>' +
          '</div>';
      } else if (status === 'active' && !isSelf) {
        var permOptions = Object.keys(_cfg_PERMISSION_DEFINITIONS).map(function(key) {
          var def = _cfg_PERMISSION_DEFINITIONS[key];
          return '<option value="' + key + '"' + (key === permId ? ' selected' : '') + '>' + def.label + '</option>';
        }).join('');
        actionButtons = '<div style="margin-bottom: 12px;">' +
          '<label style="font-size: 12px; color: #6b7280; display: block; margin-bottom: 4px;">æ¨©é™ã‚’å¤‰æ›´</label>' +
          '<select class="form-control" onchange="cfgChangeUserPermission(\'' + user.id + '\', this.value)" style="font-size: 14px;">' + permOptions + '</select></div>' +
          '<button onclick="cfgDisableUser(\'' + user.id + '\')" style="width: 100%; padding: 10px; background: #fee2e2; color: #dc2626; border: none; border-radius: 8px; font-size: 13px; cursor: pointer;">ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç„¡åŠ¹åŒ–</button>';
      } else if (status === 'inactive') {
        actionButtons = '<button onclick="cfgEnableUser(\'' + user.id + '\')" style="width: 100%; padding: 10px; background: #10b981; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; margin-bottom: 8px;">æœ‰åŠ¹åŒ–</button>' +
          '<button onclick="cfgDeleteUser(\'' + user.id + '\', \'' + cfgEscapeHtml(userName) + '\')" style="width: 100%; padding: 10px; background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; border-radius: 8px; font-size: 13px; cursor: pointer;">ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å®Œå…¨ã«å‰Šé™¤</button>';
      }

      actionsDiv.innerHTML = actionButtons;
      // bodyç›´ä¸‹ã«ç§»å‹•ï¼ˆiOS PWAã‚¹ã‚¿ãƒƒã‚­ãƒ³ã‚°ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå¯¾å¿œï¼‰
      modal._cfgOrigParent = modal.parentNode;
      modal._cfgOrigNext = modal.nextSibling;
      document.body.appendChild(modal);
      modal.style.display = 'flex';
    }
    window.cfgOpenUserDetailModal = cfgOpenUserDetailModal;

    function cfgCloseUserDetailModal() {
      var modal = document.getElementById('cfg-userDetailModal');
      if (!modal) return;
      modal.style.display = 'none';
      if (modal._cfgOrigParent) {
        if (modal._cfgOrigNext && modal._cfgOrigNext.parentNode === modal._cfgOrigParent) {
          modal._cfgOrigParent.insertBefore(modal, modal._cfgOrigNext);
        } else {
          modal._cfgOrigParent.appendChild(modal);
        }
      }
    }
    window.cfgCloseUserDetailModal = cfgCloseUserDetailModal;

    async function cfgApproveUser(userId) {
      if (!confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ')) return;
      try {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
        var userDoc = await window.db.collection('users').doc(userId).get();
        var userData = userDoc.exists ? userDoc.data() : {};
        var userName = userData.userName || userId.split('@')[0];

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æœ‰åŠ¹ã«æ›´æ–°
        await window.db.collection('users').doc(userId).update({
          status: 'active', permissionId: 'staff', permissionDisplay: 'ã‚¹ã‚¿ãƒƒãƒ•',
          approvedAt: firebase.firestore.FieldValue.serverTimestamp(), approvedBy: localStorage.getItem('reborn_user_email')
        });

        // ç®¡ç†è€…ã®æ‰¿èªå¾…ã¡ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã«ã™ã‚‹
        try { await cfgCompletePendingUserTask(userId); } catch (e) { console.error('[Approve] ã‚¿ã‚¹ã‚¯å®Œäº†ã‚¨ãƒ©ãƒ¼:', e); }

        // ã‚¦ã‚§ãƒ«ã‚«ãƒ é€šçŸ¥ãƒ»ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆï¼ˆç™ºé€å…ˆãƒ»å£åº§ç™»éŒ²ï¼‰
        try { await cfgCreateWelcomeAnnouncements(userId, userName); } catch (e) { console.error('[Approve] ã‚¦ã‚§ãƒ«ã‚«ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:', e); }

        // æ‰¿èªãƒ¡ãƒ¼ãƒ«é€ä¿¡
        try { await cfgSendApprovalEmail(userId, userName); } catch (e) { console.error('[Approve] ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼:', e); }

        cfgCloseUserDetailModal();
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ‰¿èªã—ã¾ã—ãŸ');
        cfgLoadUserManagement();
      } catch (e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); }
    }
    window.cfgApproveUser = cfgApproveUser;

    // ç®¡ç†è€…ã®æ‰¿èªå¾…ã¡ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã«ã™ã‚‹
    async function cfgCompletePendingUserTask(pendingUserEmail) {
      var ownersSnapshot = await window.db.collection('users').where('permissionId', '==', 'owner').get();
      if (ownersSnapshot.empty) return;
      for (var i = 0; i < ownersSnapshot.docs.length; i++) {
        var ownerEmail = ownersSnapshot.docs[i].data().userEmail;
        var tasksRef = window.db.collection('userTasks').doc(ownerEmail).collection('tasks');
        var tasksSnapshot = await tasksRef.where('type', '==', 'pending_user_approval').where('completed', '==', false).get();
        for (var j = 0; j < tasksSnapshot.docs.length; j++) {
          var taskData = tasksSnapshot.docs[j].data();
          if (taskData.relatedData && taskData.relatedData.pendingUserEmail === pendingUserEmail) {
            await tasksSnapshot.docs[j].ref.update({ completed: true, completedAt: firebase.firestore.FieldValue.serverTimestamp() });
            console.log('[Approve] âœ… ç®¡ç†è€…ã‚¿ã‚¹ã‚¯å®Œäº†:', ownerEmail, pendingUserEmail);
          }
        }
      }
    }

    // ã‚¦ã‚§ãƒ«ã‚«ãƒ é€šçŸ¥ã¨ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ
    async function cfgCreateWelcomeAnnouncements(userEmail, userName) {
      var personalRef = window.db.collection('users').doc(userEmail).collection('personalAnnouncements');
      var tasksRef = window.db.collection('userTasks').doc(userEmail).collection('tasks');

      // é€šçŸ¥1 + ã‚¿ã‚¹ã‚¯1: ç™ºé€å…ˆæƒ…å ±ç™»éŒ²
      await personalRef.add({
        title: 'ç™ºé€å…ˆæƒ…å ±ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„',
        body: 'ãƒ•ãƒªãƒ©ã¸ã‚ˆã†ã“ãï¼\n\nå•†å“ãŒå£²ã‚ŒãŸéš›ã®ç™ºé€æº–å‚™ã«å¿…è¦ãªæƒ…å ±ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚\n\nã€ç™»éŒ²æ‰‹é †ã€‘\n1. ç”»é¢ä¸‹éƒ¨ã®ã€Œãƒã‚¤ãƒšãƒ¼ã‚¸ã€ã‚’ã‚¿ãƒƒãƒ—\n2. æ­¯è»Šã‚¢ã‚¤ã‚³ãƒ³ï¼ˆè¨­å®šï¼‰ã‚’ã‚¿ãƒƒãƒ—\n3. ã€Œè¨­å®šç®¡ç†ã€ã‚’é¸æŠ\n4. ã€Œç™ºé€å…ˆæƒ…å ±ã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—\n5. å¿…è¦æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ä¿å­˜',
        priority: 'normal', createdAt: firebase.firestore.FieldValue.serverTimestamp(), type: 'shipping_request'
      });
      await tasksRef.add({
        type: 'shipping_info_registration', title: 'ç™ºé€å…ˆæƒ…å ±ã‚’ç™»éŒ²',
        description: 'ãƒã‚¤ãƒšãƒ¼ã‚¸ > å³ä¸Šãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆâ‰¡ï¼‰ > å€‹äººæƒ…å ±è¨­å®š',
        link: 'mypage-personal-info', createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        completed: false, read: false
      });

      // é€šçŸ¥2 + ã‚¿ã‚¹ã‚¯2: å£åº§æƒ…å ±ç™»éŒ²
      await personalRef.add({
        title: 'å£åº§æƒ…å ±ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„',
        body: 'å ±é…¬ã®å—ã‘å–ã‚Šã«å¿…è¦ãªå£åº§æƒ…å ±ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚\n\nã€ç™»éŒ²æ‰‹é †ã€‘\n1. ç”»é¢ä¸‹éƒ¨ã®ã€Œãƒã‚¤ãƒšãƒ¼ã‚¸ã€ã‚’ã‚¿ãƒƒãƒ—\n2. æ­¯è»Šã‚¢ã‚¤ã‚³ãƒ³ï¼ˆè¨­å®šï¼‰ã‚’ã‚¿ãƒƒãƒ—\n3. ã€Œè¨­å®šç®¡ç†ã€ã‚’é¸æŠ\n4. ã€Œå£åº§æƒ…å ±ã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—\n5. å¿…è¦æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ä¿å­˜',
        priority: 'normal', createdAt: firebase.firestore.FieldValue.serverTimestamp(), type: 'bank_request'
      });
      await tasksRef.add({
        type: 'bank_account_registration', title: 'å£åº§æƒ…å ±ã‚’ç™»éŒ²',
        description: 'ãƒã‚¤ãƒšãƒ¼ã‚¸ > å³ä¸Šãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆâ‰¡ï¼‰ > å€‹äººæƒ…å ±è¨­å®š',
        link: 'mypage-personal-info', createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        completed: false, read: false
      });

      console.log('[Approve] âœ… ã‚¦ã‚§ãƒ«ã‚«ãƒ é€šçŸ¥ãƒ»ã‚¿ã‚¹ã‚¯ä½œæˆå®Œäº†:', userEmail);
    }

    async function cfgRejectUser(userId) {
      if (!confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™»éŒ²ã‚’æ‹’å¦ã—ã¾ã™ã‹ï¼Ÿ')) return;
      try {
        await window.db.collection('users').doc(userId).update({
          status: 'rejected',
          rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
          rejectedBy: localStorage.getItem('reborn_user_email')
        });
        cfgCloseUserDetailModal();
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ‹’å¦ã—ã¾ã—ãŸ');
        cfgLoadUserManagement();
      } catch (e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); }
    }
    window.cfgRejectUser = cfgRejectUser;

    async function cfgDisableUser(userId) {
      if (!confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™ã‹ï¼Ÿ')) return;
      try {
        await window.db.collection('users').doc(userId).update({ status: 'inactive', disabledAt: firebase.firestore.FieldValue.serverTimestamp() });
        cfgCloseUserDetailModal(); alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸ'); cfgLoadUserManagement();
      } catch (e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); }
    }
    window.cfgDisableUser = cfgDisableUser;

    async function cfgEnableUser(userId) {
      if (!confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã™ã‹ï¼Ÿ')) return;
      try {
        await window.db.collection('users').doc(userId).update({ status: 'active', enabledAt: firebase.firestore.FieldValue.serverTimestamp() });
        cfgCloseUserDetailModal(); alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ'); cfgLoadUserManagement();
      } catch (e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); }
    }
    window.cfgEnableUser = cfgEnableUser;

    async function cfgChangeUserPermission(userId, newPermissionId) {
      var permDef = _cfg_PERMISSION_DEFINITIONS[newPermissionId];
      if (!permDef) return;
      if (!confirm('æ¨©é™ã‚’ã€Œ' + permDef.label + 'ã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ')) {
        cfgLoadUserManagement();
        return;
      }
      try {
        await window.db.collection('users').doc(userId).update({
          permissionId: newPermissionId,
          permissionDisplay: permDef.label,
          permissionUpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          permissionUpdatedBy: localStorage.getItem('reborn_user_email')
        });
        cfgCloseUserDetailModal();
        alert('æ¨©é™ã‚’ã€Œ' + permDef.label + 'ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ');
        cfgLoadUserManagement();
      } catch (error) {
        console.error('[USER] æ¨©é™å¤‰æ›´ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }
    window.cfgChangeUserPermission = cfgChangeUserPermission;

    async function cfgDeleteUser(userId, userName) {
      if (!confirm('ã€Œ' + userName + 'ã€ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ï¼š\nãƒ»ãŠçŸ¥ã‚‰ã›\nãƒ»ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±\nãƒ»ã‚¿ã‚¹ã‚¯\nãƒ»æœˆé–“ç›®æ¨™\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;
      try {
        console.log('[USER] ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤é–‹å§‹:', userId);
        var collections = [
          { ref: window.db.collection('users').doc(userId).collection('personalAnnouncements'), name: 'ãŠçŸ¥ã‚‰ã›' },
          { ref: window.db.collection('users').doc(userId).collection('devices'), name: 'ãƒ‡ãƒã‚¤ã‚¹' },
          { ref: window.db.collection('userTasks').doc(userId).collection('tasks'), name: 'ã‚¿ã‚¹ã‚¯' }
        ];
        for (var i = 0; i < collections.length; i++) {
          var snap = await collections[i].ref.get();
          for (var j = 0; j < snap.docs.length; j++) { await snap.docs[j].ref.delete(); }
          console.log('[USER] ' + collections[i].name + 'å‰Šé™¤:', snap.size, 'ä»¶');
        }
        var goalsSnap = await window.db.collection('userGoals').where('email', '==', userId).get();
        for (var k = 0; k < goalsSnap.docs.length; k++) { await goalsSnap.docs[k].ref.delete(); }
        console.log('[USER] æœˆé–“ç›®æ¨™å‰Šé™¤:', goalsSnap.size, 'ä»¶');
        await window.db.collection('users').doc(userId).delete();
        console.log('[USER] ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤å®Œäº†:', userId);
        cfgCloseUserDetailModal();
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        cfgLoadUserManagement();
      } catch (error) {
        console.error('[USER] å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }
    window.cfgDeleteUser = cfgDeleteUser;

    async function cfgSendApprovalEmail(userEmail, userName) {
      try {
        var response = await fetch('https://reborn-fcm-worker.mercari-yasuhirotakuji.workers.dev/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            to: userEmail,
            subject: 'ğŸ‰ ãƒ•ãƒªãƒ©ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæ‰¿èªã•ã‚Œã¾ã—ãŸ',
            body: userName + 'ã•ã‚“\n\nãƒ•ãƒªãƒ©ã¸ã‚ˆã†ã“ãï¼\nã‚ãªãŸã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæ‰¿èªã•ã‚Œã¾ã—ãŸã€‚\n\nã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚\nhttps://furira.jp\n\n---\nãƒ•ãƒªãƒ©ç‰©è²©ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ '
          })
        });
        if (!response.ok) throw new Error('ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—: ' + response.status);
        console.log('[Approve] æ‰¿èªãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ:', userEmail);
      } catch (e) {
        console.error('[Approve] ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    function cfgToggleSection(section) {
      var list = document.getElementById('cfg-' + section + 'UsersList');
      var toggle = document.getElementById('cfg-' + section + 'Toggle');
      if (!list || !toggle) return;
      if (list.style.display === 'none') { list.style.display = 'block'; toggle.textContent = '\u25BC'; }
      else { list.style.display = 'none'; toggle.textContent = '\u25B6'; }
    }
    window.cfgToggleSection = cfgToggleSection;

    function cfgFilterUserList() {
      var query = (document.getElementById('cfg-userSearchInput')?.value || '').toLowerCase().trim();
      if (!query) { cfgRenderAllUsers(_cfg_allUsersData); return; }
      var filtered = _cfg_allUsersData.filter(function(u) {
        return ((u.userName || u.name || '') + (u.userEmail || u.email || '')).toLowerCase().includes(query);
      });
      cfgRenderAllUsers(filtered);
    }
    window.cfgFilterUserList = cfgFilterUserList;

    // ============================================
    // Permission Settings
    // ============================================

    async function cfgLoadPermissionSettings() {
      if (_cfg_permissionSettingsLoaded) return;
      if (!window.db || typeof window.db.collection !== 'function') { setTimeout(cfgLoadPermissionSettings, 500); return; }
      try {
        console.log('[config-fragment] Loading permission settings...');
        var usersSnapshot = await window.db.collection('users').get();
        _cfg_usersData = [];
        usersSnapshot.forEach(function(doc) {
          var data = doc.data();
          _cfg_usersData.push({ email: doc.id, userName: data.userName || doc.id, permissionId: data.permissionId || 'staff' });
        });

        var menuPermDoc = await window.db.collection('settings').doc('menuPermissions').get();
        _cfg_menuPermissions = menuPermDoc.exists ? menuPermDoc.data() : {};

        cfgRenderUserPermissionList();
        cfgRenderMenuPermissionList();

        document.getElementById('cfg-permissionSettingsLoading').style.display = 'none';
        document.getElementById('cfg-permissionSettingsContent').style.display = 'block';
        _cfg_permissionSettingsLoaded = true;
        console.log('[config-fragment] Permission settings loaded successfully');
      } catch (e) {
        console.error('[config-fragment] permission load error:', e);
        var loadingEl = document.getElementById('cfg-permissionSettingsLoading');
        if (loadingEl) {
          loadingEl.innerHTML = '<div style="color: #ef4444; font-size: 14px;">æ¨©é™è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>' +
            '<div style="color: #6b7280; font-size: 12px; margin-top: 8px;">' + (e.message || e) + '</div>' +
            '<button onclick="cfgRetryLoadPermission()" style="margin-top: 12px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">å†è©¦è¡Œ</button>';
        }
      }
    }

    function cfgRetryLoadPermission() {
      _cfg_permissionSettingsLoaded = false;
      var loadingEl = document.getElementById('cfg-permissionSettingsLoading');
      if (loadingEl) {
        loadingEl.innerHTML = '<div style="font-size: 14px; color: #6b7280;">èª­ã¿è¾¼ã¿ä¸­...</div>';
        loadingEl.style.display = '';
      }
      document.getElementById('cfg-permissionSettingsContent').style.display = 'none';
      cfgLoadPermissionSettings();
    }
    window.cfgRetryLoadPermission = cfgRetryLoadPermission;

    function cfgGetActivePermissions() {
      var activeIds = new Set(['owner']);
      _cfg_usersData.forEach(function(u) { if (u.permissionId) activeIds.add(u.permissionId); });
      return Array.from(activeIds).filter(function(id) { return _cfg_PERMISSION_DEFINITIONS[id]; })
        .sort(function(a, b) { return _cfg_PERMISSION_DEFINITIONS[a].order - _cfg_PERMISSION_DEFINITIONS[b].order; });
    }

    function cfgRenderUserPermissionList() {
      var container = document.getElementById('cfg-userPermissionList');
      if (!container) return;
      var currentEmail = localStorage.getItem('reborn_user_email');
      var allPerms = Object.keys(_cfg_PERMISSION_DEFINITIONS).sort(function(a, b) { return _cfg_PERMISSION_DEFINITIONS[a].order - _cfg_PERMISSION_DEFINITIONS[b].order; });

      container.innerHTML = _cfg_usersData.map(function(user) {
        var isSelf = user.email === currentEmail && user.permissionId === 'owner';
        var options = allPerms.map(function(p) {
          return '<option value="' + p + '"' + (user.permissionId === p ? ' selected' : '') + '>' + _cfg_PERMISSION_DEFINITIONS[p].label + '</option>';
        }).join('');
        return '<div style="padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">' +
          '<div style="font-size: 14px; font-weight: 600; margin-bottom: 6px;">' + cfgEscapeHtml(user.userName) + '</div>' +
          '<select class="form-control" data-email="' + user.email + '" onchange="cfgUpdateUserPermission(this)" style="font-size: 14px;"' + (isSelf ? ' disabled' : '') + '>' + options + '</select></div>';
      }).join('');
    }

    function cfgUpdateUserPermission(sel) {
      var email = sel.dataset.email;
      var newPerm = sel.value;
      var user = _cfg_usersData.find(function(u) { return u.email === email; });
      if (user) { user.permissionId = newPerm; cfgRenderMenuPermissionList(); }
    }
    window.cfgUpdateUserPermission = cfgUpdateUserPermission;

    function cfgRenderMenuPermissionList() {
      var container = document.getElementById('cfg-menuPermissionList');
      if (!container) return;
      var activePerms = cfgGetActivePermissions().filter(function(id) { return id !== 'owner'; });

      // Simplified: show main menus only
      var mainMenus = _cfg_MENU_DEFINITIONS.filter(function(m) { return !m.isTopGroup && !m.isGroup; });
      var html = mainMenus.map(function(menu) {
        // v580: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’_cfg_menuPermissionsã«æ›¸ãè¾¼ã¿ï¼ˆä¿å­˜æ™‚ã«Firestoreã«åæ˜ ã•ã‚Œã‚‹ï¼‰
        if (!_cfg_menuPermissions[menu.id]) {
          _cfg_menuPermissions[menu.id] = { visibleTo: menu.defaultOwnerOnly ? ['owner'] : ['owner'].concat(activePerms) };
        }
        var perm = _cfg_menuPermissions[menu.id];
        var toggles = activePerms.map(function(permId) {
          var isOn = perm.visibleTo && perm.visibleTo.includes(permId);
          return '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">' +
            '<div onclick="cfgToggleMenuPermission(\'' + menu.id + '\', \'' + permId + '\', this)" data-menu="' + menu.id + '" data-role="' + permId + '" data-on="' + isOn + '" style="width: 44px; height: 24px; background: ' + (isOn ? '#3b82f6' : '#d1d5db') + '; border-radius: 12px; position: relative; cursor: pointer;">' +
              '<div style="width: 20px; height: 20px; background: white; border-radius: 50%; position: absolute; top: 2px; transform: ' + (isOn ? 'translateX(20px)' : 'translateX(2px)') + '; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div></div>' +
            '<span style="font-size: 12px;">' + _cfg_PERMISSION_DEFINITIONS[permId].label + '</span></label>';
        }).join('');
        return '<div style="padding: 10px 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb; margin-bottom: 6px;">' +
          '<div style="font-size: 13px; font-weight: 600; margin-bottom: 8px;">' + menu.label + '</div>' +
          '<div style="display: flex; gap: 8px; flex-wrap: wrap;">' + toggles + '</div></div>';
      }).join('');
      container.innerHTML = html;
    }

    function cfgToggleMenuPermission(menuId, role, element) {
      var isOn = element.dataset.on === 'true';
      var newState = !isOn;
      element.dataset.on = String(newState);
      element.style.background = newState ? '#3b82f6' : '#d1d5db';
      element.querySelector('div').style.transform = newState ? 'translateX(20px)' : 'translateX(2px)';
      if (!_cfg_menuPermissions[menuId]) _cfg_menuPermissions[menuId] = { visibleTo: ['owner'] };
      var vis = _cfg_menuPermissions[menuId].visibleTo;
      if (newState && !vis.includes(role)) vis.push(role);
      else if (!newState && vis.includes(role)) { var idx = vis.indexOf(role); vis.splice(idx, 1); }
    }
    window.cfgToggleMenuPermission = cfgToggleMenuPermission;

    async function cfgSavePermissionSettings(showAlert) {
      if (!_cfg_permissionSettingsLoaded || !window.db) return true;
      try {
        var batch = window.db.batch();
        _cfg_usersData.forEach(function(user) {
          batch.update(window.db.collection('users').doc(user.email), {
            permissionId: user.permissionId,
            permissionDisplay: (_cfg_PERMISSION_DEFINITIONS[user.permissionId] || {}).label || user.permissionId,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
        batch.set(window.db.collection('settings').doc('menuPermissions'), Object.assign({}, _cfg_menuPermissions, { updatedAt: firebase.firestore.FieldValue.serverTimestamp() }));
        await batch.commit();
        return true;
      } catch (e) {
        console.error('[config-fragment] permission save error:', e);
        if (showAlert) alert('æ¨©é™è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        return false;
      }
    }

    // ============================================
    // Permission Check (UI visibility)
    // ============================================

    async function cfgCheckUserPermissionAndUpdateUI() {
      try {
        var userEmail = localStorage.getItem('reborn_user_email');
        if (!userEmail || !window.db) return;
        var userDoc = await window.db.collection('users').doc(userEmail).get();
        if (!userDoc.exists) return;
        var permissionId = userDoc.data().permissionId || 'staff';
        localStorage.setItem('reborn_user_permission', permissionId);
        if (permissionId === 'owner') return; // Admin sees all

        var menuPermDoc = await window.db.collection('settings').doc('menuPermissions').get();
        var menuPerms = menuPermDoc.exists ? menuPermDoc.data() : {};

        // Product subtabs (all default visible to everyone)
        cfgApplySubTabPermissions('cfg-productConfigTabs', 'cfg-productConfigTabContent', [
          { id: 'product-salesword', target: 'cfg-product-salesword', defaultOwnerOnly: false },
          { id: 'product-condition', target: 'cfg-product-condition', defaultOwnerOnly: false },
          { id: 'product-hashtag', target: 'cfg-product-hashtag', defaultOwnerOnly: false },
          { id: 'product-discount', target: 'cfg-product-discount', defaultOwnerOnly: false },
          { id: 'product-ai', target: 'cfg-product-ai', defaultOwnerOnly: false },
          { id: 'product-order', target: 'cfg-product-order', defaultOwnerOnly: false }
        ], menuPerms, permissionId);

        // System subtabs
        cfgApplySubTabPermissions('cfg-systemConfigTabs', 'cfg-systemConfigTabContent', [
          { id: 'system-basic', target: 'cfg-system-basic', defaultOwnerOnly: false },
          { id: 'system-management', target: 'cfg-system-management', defaultOwnerOnly: true },
          { id: 'system-shipping', target: 'cfg-system-shipping', defaultOwnerOnly: true },
          { id: 'system-procure', target: 'cfg-system-procure', defaultOwnerOnly: true },
          { id: 'system-platform', target: 'cfg-system-platform', defaultOwnerOnly: true },
          { id: 'system-users', target: 'cfg-system-users', alwaysOwnerOnly: true },
          { id: 'system-compensation', target: 'cfg-system-compensation', alwaysOwnerOnly: true },
          { id: 'system-permission', target: 'cfg-system-permission', alwaysOwnerOnly: true }
        ], menuPerms, permissionId);
      } catch (e) { console.error('[config-fragment] permission check error:', e); }
    }

    function cfgApplySubTabPermissions(tabsContainerId, contentContainerId, subTabs, menuPerms, permissionId) {
      var visibleCount = 0;
      var firstVisibleTarget = null;
      var allPerms = ['owner', 'employee', 'staff', 'leader', 'outsource'];

      subTabs.forEach(function(subTab) {
        if (subTab.alwaysOwnerOnly) {
          if (permissionId !== 'owner') {
            cfgHideSubtab(subTab.target);
            return;
          }
        }

        var defaultVisibleTo = subTab.defaultOwnerOnly === false ? allPerms : ['owner'];
        var perm = menuPerms[subTab.id] || { visibleTo: defaultVisibleTo };
        var isVisible = perm.visibleTo && perm.visibleTo.indexOf(permissionId) !== -1;

        if (isVisible) {
          visibleCount++;
          if (!firstVisibleTarget) firstVisibleTarget = subTab.target;
        } else {
          cfgHideSubtab(subTab.target);
        }
      });

      if (visibleCount === 0) {
        var tabsContainer = document.getElementById(tabsContainerId);
        if (tabsContainer) tabsContainer.style.display = 'none';
        var contentContainer = document.getElementById(contentContainerId);
        if (contentContainer) {
          contentContainer.innerHTML = '<div style="padding: 40px; text-align: center; color: #6b7280;">' +
            '<i class="bi bi-lock" style="font-size: 48px; display: block; margin-bottom: 16px;"></i>' +
            'ã“ã®è¨­å®šã¯ç®¡ç†è€…ã®ã¿ç·¨é›†ã§ãã¾ã™ã€‚<br>è¨­å®šã®å¤‰æ›´ãŒå¿…è¦ãªå ´åˆã¯ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</div>';
        }
      } else if (firstVisibleTarget) {
        // Activate first visible tab if current active is hidden
        var activePane = document.querySelector('#' + contentContainerId + ' .cfg-subtab-pane.active');
        if (activePane && activePane.style.display === 'none') {
          activePane.classList.remove('active');
          var firstPane = document.getElementById(firstVisibleTarget);
          if (firstPane) firstPane.classList.add('active');
          var tabsContainer = document.getElementById(tabsContainerId);
          if (tabsContainer) {
            tabsContainer.querySelectorAll('.cfg-subtab').forEach(function(t) { t.classList.remove('active'); });
            var firstBtn = tabsContainer.querySelector('[data-target="' + firstVisibleTarget + '"]');
            if (firstBtn) firstBtn.classList.add('active');
          }
        }
      }
    }

    function cfgHideSubtab(targetId) {
      var pane = document.getElementById(targetId);
      if (pane) { pane.style.display = 'none'; pane.classList.remove('active'); }
      // Hide corresponding tab button
      var tabsContainers = ['cfg-productConfigTabs', 'cfg-systemConfigTabs'];
      tabsContainers.forEach(function(containerId) {
        var container = document.getElementById(containerId);
        if (!container) return;
        var btn = container.querySelector('[data-target="' + targetId + '"]');
        if (btn) btn.style.display = 'none';
      });
    }

    // ============================================
    // Shipping/Bank Info Modals
    // ============================================

    function cfgFormatPostalCode(input) {
      var value = input.value.replace(/[^0-9]/g, '');
      if (value.length > 3) value = value.slice(0, 3) + '-' + value.slice(3, 7);
      input.value = value;
    }
    window.cfgFormatPostalCode = cfgFormatPostalCode;

    async function cfgSearchShippingAddress() {
      var postalCode = document.getElementById('cfg-shippingPostalCode').value.replace(/-/g, '');
      if (postalCode.length !== 7) { alert('éƒµä¾¿ç•ªå·ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ7æ¡ï¼‰'); return; }
      try {
        var response = await fetch('https://zipcloud.ibsnet.co.jp/api/search?zipcode=' + postalCode);
        var data = await response.json();
        if (data.results && data.results.length > 0) {
          var result = data.results[0];
          document.getElementById('cfg-shippingPrefecture').value = result.address1;
          document.getElementById('cfg-shippingCity').value = result.address2 + result.address3;
        } else { alert('è©²å½“ã™ã‚‹ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'); }
      } catch (e) { alert('ä½æ‰€æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    }
    window.cfgSearchShippingAddress = cfgSearchShippingAddress;

    async function cfgOpenShippingInfoModal() {
      _cfgShowModal('cfg-shippingInfoModal');
      await cfgLoadShippingInfo();
    }
    window.cfgOpenShippingInfoModal = cfgOpenShippingInfoModal;

    async function cfgLoadShippingInfo() {
      var userEmail = localStorage.getItem('reborn_user_email');
      if (!userEmail || !window.db) return;
      try {
        var userDoc = await window.db.collection('users').doc(userEmail).get();
        if (userDoc.exists) {
          var shipping = userDoc.data().shippingInfo || {};
          var fields = { 'cfg-shippingLastName': 'lastName', 'cfg-shippingFirstName': 'firstName', 'cfg-shippingPostalCode': 'postalCode', 'cfg-shippingPrefecture': 'prefecture', 'cfg-shippingCity': 'city', 'cfg-shippingBuilding': 'building' };
          Object.keys(fields).forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.value = shipping[fields[id]] || '';
          });
        }
      } catch (e) { console.error('[config] ç™ºé€å…ˆæƒ…å ±èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e); }
    }

    function cfgCloseShippingInfoModal() {
      _cfgHideModal('cfg-shippingInfoModal');
    }
    window.cfgCloseShippingInfoModal = cfgCloseShippingInfoModal;

    async function cfgSaveShippingInfo() {
      var userEmail = localStorage.getItem('reborn_user_email');
      if (!userEmail || !window.db) { alert('FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“'); return; }
      var info = {
        lastName: document.getElementById('cfg-shippingLastName').value.trim(),
        firstName: document.getElementById('cfg-shippingFirstName').value.trim(),
        postalCode: document.getElementById('cfg-shippingPostalCode').value.trim(),
        prefecture: document.getElementById('cfg-shippingPrefecture').value.trim(),
        city: document.getElementById('cfg-shippingCity').value.trim(),
        building: document.getElementById('cfg-shippingBuilding').value.trim()
      };
      if (!info.lastName || !info.firstName || !info.postalCode || !info.prefecture || !info.city) {
        alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return;
      }
      try {
        await window.db.collection('users').doc(userEmail).set({
          shippingInfo: info,
          shippingInfoUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        cfgUpdateShippingInfoStatus(info);
        await cfgCompleteSettingTask('shipping_info_registration');
        alert('ç™ºé€å…ˆæƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        cfgCloseShippingInfoModal();
      } catch (e) { alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message); }
    }
    window.cfgSaveShippingInfo = cfgSaveShippingInfo;

    async function cfgOpenBankAccountModal() {
      _cfgShowModal('cfg-bankAccountModal');
      await cfgLoadBankAccountInfo();
    }
    window.cfgOpenBankAccountModal = cfgOpenBankAccountModal;

    async function cfgLoadBankAccountInfo() {
      var userEmail = localStorage.getItem('reborn_user_email');
      if (!userEmail || !window.db) return;
      try {
        var userDoc = await window.db.collection('users').doc(userEmail).get();
        if (userDoc.exists) {
          var bank = userDoc.data().bankAccount || {};
          var fields = { 'cfg-bankName': 'bankName', 'cfg-bankBranch': 'branchName', 'cfg-bankAccountType': 'accountType', 'cfg-bankAccountNumber': 'accountNumber', 'cfg-bankAccountHolder': 'accountHolder' };
          Object.keys(fields).forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.value = bank[fields[id]] || '';
          });
        }
      } catch (e) { console.error('[config] å£åº§æƒ…å ±èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e); }
    }

    function cfgCloseBankAccountModal() {
      _cfgHideModal('cfg-bankAccountModal');
    }
    window.cfgCloseBankAccountModal = cfgCloseBankAccountModal;

    async function cfgSaveBankAccount() {
      var userEmail = localStorage.getItem('reborn_user_email');
      if (!userEmail || !window.db) { alert('FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“'); return; }
      var info = {
        bankName: document.getElementById('cfg-bankName').value.trim(),
        branchName: document.getElementById('cfg-bankBranch').value.trim(),
        accountType: document.getElementById('cfg-bankAccountType').value,
        accountNumber: document.getElementById('cfg-bankAccountNumber').value.trim(),
        accountHolder: document.getElementById('cfg-bankAccountHolder').value.trim()
      };
      if (!info.bankName || !info.branchName || !info.accountNumber || !info.accountHolder) {
        alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return;
      }
      try {
        await window.db.collection('users').doc(userEmail).set({
          bankAccount: info,
          bankAccountUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        cfgUpdateBankAccountStatus(info);
        await cfgCompleteSettingTask('bank_account_registration');
        alert('å£åº§æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        cfgCloseBankAccountModal();
      } catch (e) { alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message); }
    }
    window.cfgSaveBankAccount = cfgSaveBankAccount;

    async function cfgCompleteSettingTask(taskId) {
      var userEmail = localStorage.getItem('reborn_user_email');
      if (!userEmail || !window.db) return;
      try {
        var taskDoc = await window.db.collection('userTasks').doc(userEmail).collection('tasks').doc(taskId).get();
        if (taskDoc.exists && !taskDoc.data().completed) {
          await window.db.collection('userTasks').doc(userEmail).collection('tasks').doc(taskId).update({
            completed: true,
            completedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          console.log('[config] ã‚¿ã‚¹ã‚¯å®Œäº†:', taskId);
        }
      } catch (e) { console.warn('[config] ã‚¿ã‚¹ã‚¯å®Œäº†å‡¦ç†ã‚¨ãƒ©ãƒ¼:', e); }
    }

    // ============================================
    // User Icon Upload
    // ============================================

    async function cfgUploadUserIcon() {
      if (!_cfg_pendingUserIconData) return;
      try {
        var userEmail = localStorage.getItem('reborn_user_email');
        if (!userEmail || !window.db) return;
        await window.db.collection('users').doc(userEmail).set({ userIconUrl: _cfg_pendingUserIconData, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
        localStorage.setItem('reborn_user_icon_url', _cfg_pendingUserIconData);
        _cfg_pendingUserIconData = null;
      } catch (e) { console.error('[config-fragment] icon upload error:', e); }
    }

    function cfgInitUserIconHandler() {
      var input = document.getElementById('cfg-basicUserIconInput');
      if (!input) return;
      input.addEventListener('change', function(e) {
        var file = e.target.files[0];
        if (!file) return;
        if (file.size > 2 * 1024 * 1024) { alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯2MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„'); return; }

        var reader = new FileReader();
        reader.onload = function(event) {
          var img = new Image();
          img.onload = function() {
            var canvas = document.createElement('canvas');
            var maxSize = 200;
            var width = img.width;
            var height = img.height;
            if (width > height) {
              if (width > maxSize) { height = Math.round((height * maxSize) / width); width = maxSize; }
            } else {
              if (height > maxSize) { width = Math.round((width * maxSize) / height); height = maxSize; }
            }
            canvas.width = width;
            canvas.height = height;
            canvas.getContext('2d').drawImage(img, 0, 0, width, height);
            var resizedBase64 = canvas.toDataURL('image/jpeg', 0.8);
            if (resizedBase64.length > 45000) { alert('ç”»åƒãŒå¤§ãã™ãã¾ã™ã€‚ã‚ˆã‚Šå°ã•ã„ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return; }

            var preview = document.getElementById('cfg-basicUserIconPreview');
            if (preview) preview.innerHTML = '<img src="' + resizedBase64 + '" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">';
            _cfg_pendingUserIconData = resizedBase64;
            console.log('[config] ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒé¸æŠå®Œäº†ã€ä¿å­˜æ™‚ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰');
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // ============================================
    // Online Status
    // ============================================

    function cfgStartOnlineStatusUpdates() {
      var check = function() {
        if (!window.db) { setTimeout(check, 500); return; }
        cfgUpdateLastActiveAt();
        _cfg_onlineInterval = setInterval(cfgUpdateLastActiveAt, 3 * 60 * 1000);
      };
      check();
    }

    async function cfgUpdateLastActiveAt() {
      try {
        var email = localStorage.getItem('reborn_user_email');
        if (!email || !window.db) return;
        await window.db.collection('users').doc(email).update({ lastActiveAt: firebase.firestore.FieldValue.serverTimestamp() });
      } catch (e) { /* ignore */ }
    }

    // ============================================
    // Clear / Reset functions
    // ============================================

    function cfgClearManagementNumberSettings() {
      if (!confirm('ç®¡ç†ç•ªå·è¨­å®šã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ»ã™ã¹ã¦ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã™\nãƒ»ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠã‚‚ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™')) return;
      _cfgMNB.segments = [];
      var presetSelect = document.getElementById('cfg-mnbPresetSelect');
      if (presetSelect) presetSelect.value = '';
      document.querySelectorAll('#spa-page-config .mnb-preset-card').forEach(function(c) {
        c.classList.remove('selected');
        var p = c.querySelector('.mnb-inline-settings'); if (p) p.remove();
      });
      cfgUpdateCurrentSettingsView();
      cfgUpdateMnbFormatPreview();
      alert('ç®¡ç†ç•ªå·è¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚\nå¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã€Œè¨­å®šã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
    }
    window.cfgClearManagementNumberSettings = cfgClearManagementNumberSettings;

    function cfgClearAllHashtags() {
      if (!confirm('ã™ã¹ã¦ã®ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
      var container = document.getElementById('cfg-hashtagItemsContainer');
      if (container) container.innerHTML = '';
      var preview = document.getElementById('cfg-hashtagPreview');
      if (preview) preview.textContent = 'ï¼ˆãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°æœªè¨­å®šï¼‰';
      alert('ã™ã¹ã¦ã®ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚\nå¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã€Œè¨­å®šã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
    }
    window.cfgClearAllHashtags = cfgClearAllHashtags;

    function cfgClearAllDiscounts() {
      if (!confirm('ã™ã¹ã¦ã®å‰²å¼•è¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) return;
      var container = document.getElementById('cfg-discountTypesList');
      if (container) container.innerHTML = '';
      var preview = document.getElementById('cfg-discountPreview');
      if (preview) preview.textContent = 'ï¼ˆå‰²å¼•æœªè¨­å®šï¼‰';
      alert('å‰²å¼•è¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚\nå¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã€Œè¨­å®šã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
    }
    window.cfgClearAllDiscounts = cfgClearAllDiscounts;

    function cfgClearShippingDefaults() {
      if (!confirm('é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) return;
      ['é…é€æ–™ã®è² æ‹…', 'é…é€ã®æ–¹æ³•', 'ç™ºé€å…ƒã®åœ°åŸŸ', 'ç™ºé€ã¾ã§ã®æ—¥æ•°'].forEach(function(field) {
        var el = document.getElementById('cfg-' + field);
        if (el) el.value = '';
      });
      alert('é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚\nå¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã€Œè¨­å®šã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
    }
    window.cfgClearShippingDefaults = cfgClearShippingDefaults;

    function cfgClearProcureListingDefaults() {
      if (!confirm('ä»•å…¥ãƒ»å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) return;
      var el;
      el = document.getElementById('cfg-ä»•å…¥å…ˆ');
      if (el) el.value = '';
      el = document.getElementById('cfg-ä»•å…¥æ—¥');
      if (el) el.value = '';
      el = document.getElementById('cfg-å‡ºå“å…ˆ');
      if (el) el.value = '';
      el = document.getElementById('cfg-å‡ºå“æ—¥');
      if (el) el.value = '';
      var radioToday = document.querySelector('input[name="cfg-procureDateMode"][value="today"]');
      if (radioToday) { radioToday.checked = true; cfgToggleProcureDateField('today'); }
      var radioToday2 = document.querySelector('input[name="cfg-listingDateMode"][value="today"]');
      if (radioToday2) { radioToday2.checked = true; cfgToggleListingDateField('today'); }
      alert('ä»•å…¥ãƒ»å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚\nå¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã€Œè¨­å®šã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
    }
    window.cfgClearProcureListingDefaults = cfgClearProcureListingDefaults;

    function cfgClearConditionButtons() {
      if (!confirm('å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³è¨­å®šã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\n\nå…¨ã‚«ãƒ†ã‚´ãƒªã®ã‚«ã‚¹ã‚¿ãƒ ãƒœã‚¿ãƒ³ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) return;
      _cfg_CONDITION_STATES.forEach(function(state) {
        var safeId = state.value.replace(/[ã€ãƒ»]/g, '');
        var container = document.getElementById('cfg-condition-' + safeId);
        if (container) container.innerHTML = '';
        var countEl = document.getElementById('cfg-condition-count-' + safeId);
        if (countEl) countEl.textContent = '(0ä»¶)';
      });
      alert('å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³è¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚\nå¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã€Œè¨­å®šã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
    }
    window.cfgClearConditionButtons = cfgClearConditionButtons;

    function cfgClearAllSaleswordSettings() {
      if (!confirm('ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) return;
      // ã‚ˆãä½¿ã†ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒªã‚¢
      _cfg_saleswordFavorites = [];
      cfgRenderSaleswordList();
      // è¡¨ç¤ºå½¢å¼ã‚¯ãƒªã‚¢
      var prefixSel = document.getElementById('cfg-saleswordPrefixSelect');
      if (prefixSel) prefixSel.value = '';
      var suffixSel = document.getElementById('cfg-saleswordSuffixSelect');
      if (suffixSel) suffixSel.value = '';
      var prefixCustom = document.getElementById('cfg-saleswordPrefixCustom');
      if (prefixCustom) { prefixCustom.value = ''; prefixCustom.style.display = 'none'; }
      var suffixCustom = document.getElementById('cfg-saleswordSuffixCustom');
      if (suffixCustom) { suffixCustom.value = ''; suffixCustom.style.display = 'none'; }
      // ãƒ¯ãƒ¼ãƒ‰åˆ¥ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚¯ãƒªã‚¢
      _cfg_wordOverrides = [];
      cfgRenderWordOverrides();
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒªã‚¢
      var defCat = document.getElementById('cfg-defaultSaleswordCategory');
      if (defCat) defCat.value = '';
      var defWord = document.getElementById('cfg-defaultSalesword');
      if (defWord) defWord.innerHTML = '<option value="">-- ãƒ¯ãƒ¼ãƒ‰ã‚’é¸æŠ --</option>';
      cfgUpdateSaleswordFormatPreview();
      alert('ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚\nå¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã€Œè¨­å®šã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
    }
    window.cfgClearAllSaleswordSettings = cfgClearAllSaleswordSettings;

    function cfgClearProcureDefaults() {
      if (!confirm('ä»•å…¥ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) return;
      var supplier = document.getElementById('cfg-ä»•å…¥å…ˆ');
      if (supplier) supplier.value = '';
      var dateInput = document.getElementById('cfg-ä»•å…¥æ—¥');
      if (dateInput) dateInput.value = '';
      var todayRadio = document.querySelector('input[name="cfg-procureDateMode"][value="today"]');
      if (todayRadio) todayRadio.checked = true;
      if (dateInput) dateInput.style.display = 'none';
      alert('ä»•å…¥ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚\nå¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã€Œè¨­å®šã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
    }
    window.cfgClearProcureDefaults = cfgClearProcureDefaults;

    function cfgClearListingDefaults() {
      if (!confirm('å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) return;
      var platform = document.getElementById('cfg-å‡ºå“å…ˆ');
      if (platform) platform.value = '';
      var dateInput = document.getElementById('cfg-å‡ºå“æ—¥');
      if (dateInput) dateInput.value = '';
      var todayRadio = document.querySelector('input[name="cfg-listingDateMode"][value="today"]');
      if (todayRadio) todayRadio.checked = true;
      if (dateInput) dateInput.style.display = 'none';
      alert('å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚\nå¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã€Œè¨­å®šã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
    }
    window.cfgClearListingDefaults = cfgClearListingDefaults;

    // ============================================
    // Utility
    // ============================================

    function cfgEscapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/[&<>"']/g, function(c) {
        return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c];
      });
    }

    function cfgGetPermissionBadgeHTML(permissionId) {
      var perm = _cfg_PERMISSION_DEFINITIONS[permissionId] || _cfg_PERMISSION_DEFINITIONS['staff'];
      return '<span style="display: inline-block; padding: 4px 12px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; font-weight: 500;">' + perm.label + '</span>';
    }

    // ============================================
    // Swipe gesture for subtabs
    // ============================================

    (function() {
      function setupSwipe(tabContentId, tabsId) {
        var tabContent = document.getElementById(tabContentId);
        if (!tabContent) return;

        var touchStartX = 0, touchStartY = 0;
        tabContent.addEventListener('touchstart', function(e) {
          touchStartX = e.changedTouches[0].screenX;
          touchStartY = e.changedTouches[0].screenY;
        }, { passive: true });

        tabContent.addEventListener('touchend', function(e) {
          var diffX = touchStartX - e.changedTouches[0].screenX;
          var diffY = touchStartY - e.changedTouches[0].screenY;
          if (Math.abs(diffX) < 50 || Math.abs(diffY) > Math.abs(diffX)) return;

          var tabsContainer = document.getElementById(tabsId);
          if (!tabsContainer) return;
          var tabs = Array.from(tabsContainer.querySelectorAll('.cfg-subtab'));
          var activeIdx = tabs.findIndex(function(t) { return t.classList.contains('active'); });
          if (activeIdx === -1) return;

          var nextIdx = diffX > 0 ? activeIdx + 1 : activeIdx - 1;
          if (nextIdx < 0 || nextIdx >= tabs.length) return;

          var target = tabs[nextIdx].getAttribute('data-target');
          cfgActivateSubtab(target);
        }, { passive: true });
      }

      // Defer setup until DOM is ready within fragment
      setTimeout(function() {
        setupSwipe('cfg-productConfigTabContent', 'cfg-productConfigTabs');
        setupSwipe('cfg-systemConfigTabContent', 'cfg-systemConfigTabs');
      }, 100);
    })();
  </script>
</div>
