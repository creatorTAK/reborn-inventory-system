<!-- SPA Fragment: config.html -->
<!-- Prefix: cfg- (CSS scoped, functions prefixed with cfg, variables with _cfg_) -->
<!-- Page keys: config-product, config-system, config-permission-users, config -->
<div id="spa-page-config">
  <style>
    #spa-page-config {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      background: #f5f6fa;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
      margin: 0;
      padding: 0;
    }

    #spa-page-config * {
      box-sizing: border-box;
    }

    /* ============================================ */
    /* ã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼ */
    /* ============================================ */
    #spa-page-config .sub-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: white;
      padding: 10px 16px;
      border-bottom: 1px solid #e0e0e0;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    #spa-page-config .sub-header .back-btn {
      background: none;
      border: none;
      font-size: 20px;
      color: #40B4E5;
      cursor: pointer;
      padding: 4px 8px;
    }

    #spa-page-config .sub-header .page-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }

    #spa-page-config .sub-header .header-icons {
      display: flex;
      gap: 8px;
    }

    #spa-page-config .sub-header .header-icons button {
      background: none;
      border: none;
      font-size: 18px;
      color: #6b7280;
      cursor: pointer;
      padding: 4px;
    }

    /* ============================================ */
    /* ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–ï¼ˆå•†å“ç™»éŒ²è¨­å®š / ã‚·ã‚¹ãƒ†ãƒ è¨­å®šï¼‰ */
    /* ============================================ */
    #spa-page-config .cfg-main-tabs {
      display: flex;
      background: white;
      border-bottom: 2px solid #e5e7eb;
      position: sticky;
      top: 44px;
      z-index: 99;
    }

    #spa-page-config .cfg-main-tabs .cfg-main-tab {
      flex: 1;
      text-align: center;
      padding: 12px 8px;
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
    }

    #spa-page-config .cfg-main-tabs .cfg-main-tab.active {
      color: #40B4E5;
      border-bottom-color: #40B4E5;
    }

    /* ============================================ */
    /* ã‚¿ãƒ–ãƒšã‚¤ãƒ³ */
    /* ============================================ */
    #spa-page-config .cfg-tab-pane {
      display: none;
    }

    #spa-page-config .cfg-tab-pane.active {
      display: block;
    }

    /* ============================================ */
    /* ã‚µãƒ–ã‚¿ãƒ–ï¼ˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰â€” ãƒã‚¹ã‚¿ç®¡ç†ã¨çµ±ä¸€ */
    /* ============================================ */
    #spa-page-config .cfg-subtabs {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      background: #f8f9fa;
      border-bottom: none;
      padding: 8px 8px 0 8px;
      gap: 0;
      scrollbar-width: thin;
    }

    #spa-page-config .cfg-subtabs::-webkit-scrollbar {
      height: 4px;
    }

    #spa-page-config .cfg-subtabs::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 2px;
    }

    #spa-page-config .cfg-subtabs .cfg-subtab {
      flex-shrink: 0;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 500;
      color: #6c757d;
      border: 1px solid transparent;
      border-radius: 6px 6px 0 0;
      background: transparent;
      cursor: pointer;
      white-space: nowrap;
      margin-right: 4px;
      transition: all 0.2s;
    }

    #spa-page-config .cfg-subtabs .cfg-subtab:hover {
      background: #e9ecef;
      color: #495057;
    }

    #spa-page-config .cfg-subtabs .cfg-subtab.active {
      color: #212529;
      background: white;
      border-color: #dee2e6 #dee2e6 white;
      font-weight: 600;
    }

    /* ============================================ */
    /* ã‚µãƒ–ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    /* ============================================ */
    #spa-page-config .cfg-subtab-content {
      background: white;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    #spa-page-config .cfg-subtab-pane {
      display: none;
      padding: 16px;
    }

    #spa-page-config .cfg-subtab-pane.active {
      display: block;
    }

    /* ============================================ */
    /* è¨­å®šã‚«ãƒ¼ãƒ‰ */
    /* ============================================ */
    #spa-page-config .config-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 0 0 120px 0;
    }

    #spa-page-config .cfg-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    #spa-page-config .cfg-card-title {
      font-size: 15px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #spa-page-config .cfg-card-desc {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 12px;
    }

    /* ============================================ */
    /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
    /* ============================================ */
    #spa-page-config .form-control {
      width: 100%;
      padding: 10px 12px;
      border: 1.5px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    #spa-page-config .form-control:focus {
      border-color: #40B4E5;
    }

    #spa-page-config select.form-control {
      background: white;
      cursor: pointer;
    }

    /* ============================================ */
    /* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ */
    /* ============================================ */
    #spa-page-config .cfg-toggle {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 28px;
    }

    #spa-page-config .cfg-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    #spa-page-config .cfg-toggle .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #e5e7eb;
      transition: 0.3s;
      border-radius: 28px;
    }

    #spa-page-config .cfg-toggle input:checked + .slider {
      background-color: #34C759;
    }

    #spa-page-config .cfg-toggle .slider::before {
      content: '';
      position: absolute;
      height: 24px;
      width: 24px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    #spa-page-config .cfg-toggle input:checked + .slider::before {
      transform: translateX(20px);
    }

    /* ============================================ */
    /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ */
    /* ============================================ */
    #spa-page-config .cfg-accordion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 4px;
    }

    #spa-page-config .cfg-accordion-header .cfg-accordion-icon {
      transition: transform 0.2s;
      font-size: 12px;
      color: #9ca3af;
    }

    #spa-page-config .cfg-accordion-content {
      display: none;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-top: none;
      border-radius: 0 0 8px 8px;
      background: white;
    }

    #spa-page-config .cfg-accordion-content.open {
      display: block;
    }

    /* ============================================ */
    /* ãƒœã‚¿ãƒ³ */
    /* ============================================ */
    #spa-page-config .cfg-btn-primary {
      background: #40B4E5;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    #spa-page-config .cfg-btn-primary:hover {
      background: #2da0d1;
    }

    #spa-page-config .cfg-btn-secondary {
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #d1d5db;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    #spa-page-config .cfg-btn-danger {
      background: #fee2e2;
      color: #dc2626;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    /* ============================================ */
    /* ä¿å­˜ãƒœã‚¿ãƒ³ï¼ˆå›ºå®šãƒ•ãƒƒã‚¿ãƒ¼ï¼‰ */
    /* ============================================ */
    #spa-page-config .cfg-save-footer {
      position: fixed;
      bottom: 60px;
      left: 0;
      right: 0;
      background: white;
      padding: 12px 16px;
      border-top: 1px solid #e5e7eb;
      z-index: 100;
      display: flex;
      justify-content: center;
    }

    #spa-page-config .cfg-save-footer .cfg-save-btn {
      width: 100%;
      max-width: 600px;
      padding: 14px;
      background: linear-gradient(135deg, #40B4E5 0%, #2196F3 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(64, 180, 229, 0.3);
    }

    /* ============================================ */
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    /* ============================================ */
    #spa-page-config .cfg-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    #spa-page-config .cfg-modal-overlay.active {
      display: flex;
    }

    #spa-page-config .cfg-modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      max-height: 90vh;
      overflow-y: auto;
    }

    #spa-page-config .cfg-modal-header {
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #spa-page-config .cfg-modal-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }

    #spa-page-config .cfg-modal-close {
      background: none;
      border: none;
      font-size: 20px;
      color: #6b7280;
      cursor: pointer;
    }

    #spa-page-config .cfg-modal-body {
      padding: 16px;
    }

    /* ============================================ */
    /* ç®¡ç†ç•ªå·ãƒ“ãƒ«ãƒ€ãƒ¼ */
    /* ============================================ */
    #spa-page-config .mnb-container {
      padding: 0;
    }

    #spa-page-config .mnb-section {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid #e5e7eb;
    }

    #spa-page-config .mnb-section-title {
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #spa-page-config .mnb-format-display {
      background: #f0f9ff;
      border: 2px solid #bae6fd;
      border-radius: 10px;
      padding: 14px;
      text-align: center;
      font-family: 'SF Mono', 'Menlo', 'Monaco', monospace;
      font-size: 18px;
      font-weight: 700;
      color: #0369a1;
      letter-spacing: 1px;
      margin-bottom: 8px;
      word-break: break-all;
    }

    #spa-page-config .mnb-part-card {
      border: 1.5px solid #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 8px;
      transition: border-color 0.2s;
    }

    #spa-page-config .mnb-part-card.enabled {
      border-color: #93c5fd;
    }

    #spa-page-config .mnb-part-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: #fafafa;
      border-bottom: 1px solid #e5e7eb;
    }

    #spa-page-config .mnb-part-body {
      padding: 10px 12px;
      display: none;
    }

    #spa-page-config .mnb-part-card.enabled .mnb-part-body {
      display: block;
    }

    #spa-page-config .mnb-toggle {
      position: relative;
      width: 44px;
      height: 24px;
      flex-shrink: 0;
    }

    #spa-page-config .mnb-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    #spa-page-config .mnb-toggle .mnb-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #e5e7eb;
      transition: 0.3s;
      border-radius: 24px;
    }

    #spa-page-config .mnb-toggle input:checked + .mnb-slider {
      background-color: #3b82f6;
    }

    #spa-page-config .mnb-toggle .mnb-slider::before {
      content: '';
      position: absolute;
      height: 20px;
      width: 20px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    #spa-page-config .mnb-toggle input:checked + .mnb-slider::before {
      transform: translateX(20px);
    }

    #spa-page-config .mnb-separator-selector {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    #spa-page-config .mnb-separator-btn {
      padding: 6px 14px;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: #374151;
      transition: all 0.2s;
    }

    #spa-page-config .mnb-separator-btn.active {
      background: #eff6ff;
      border-color: #3b82f6;
      color: #1d4ed8;
    }

    #spa-page-config .mnb-digits-control {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    #spa-page-config .mnb-digits-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1.5px solid #e5e7eb;
      background: white;
      font-size: 18px;
      font-weight: 600;
      color: #374151;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    #spa-page-config .mnb-digits-btn:hover {
      border-color: #3b82f6;
      color: #3b82f6;
    }

    #spa-page-config .mnb-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }

    #spa-page-config .mnb-modal-overlay.active {
      display: flex;
    }

    #spa-page-config .mnb-modal-content {
      background: white;
      border-radius: 12px;
      max-width: 400px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 20px;
    }

    #spa-page-config .mnb-category-btn {
      display: block;
      width: 100%;
      text-align: left;
      padding: 10px 14px;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-size: 13px;
      color: #374151;
      margin-bottom: 6px;
      transition: all 0.2s;
    }

    #spa-page-config .mnb-category-btn:hover {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    #spa-page-config .mnb-category-btn.selected {
      border-color: #3b82f6;
      background: #eff6ff;
      color: #1d4ed8;
      font-weight: 600;
    }

    /* ============================================ */
    /* ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« */
    /* ============================================ */
    #spa-page-config .platform-select-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    #spa-page-config .platform-select-modal.active {
      display: flex;
    }

    /* ============================================ */
    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ»æ¨©é™è¨­å®š */
    /* ============================================ */
    #spa-page-config .cfg-user-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    #spa-page-config .cfg-user-card:hover {
      background: #f3f4f6;
    }

    /* ============================================ */
    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« */
    /* ============================================ */
    #spa-page-config #cfg-userDetailModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 10000;
      justify-content: center;
      align-items: flex-end;
    }

    #spa-page-config #cfg-userDetailModal .cfg-modal-sheet {
      background: white;
      border-radius: 16px 16px 0 0;
      width: 100%;
      max-width: 500px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
    }

    #spa-page-config #cfg-userDetailModal .cfg-modal-sheet-header {
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e5e7eb;
    }

    #spa-page-config #cfg-userDetailModal .cfg-modal-sheet-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    #spa-page-config #cfg-userDetailModal .cfg-modal-sheet-footer {
      padding: 16px;
      border-top: 1px solid #e5e7eb;
    }

    /* ============================================ */
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    /* ============================================ */
    @media (max-width: 768px) {
      #spa-page-config .cfg-subtabs .cfg-subtab {
        font-size: 12px;
        padding: 8px 12px;
      }
    }
  </style>

  <!-- ============================================ -->
  <!-- ã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <!-- ============================================ -->
  <div class="sub-header">
    <button class="back-btn" id="cfg-back-button" onclick="spaGoBack()">
      <i class="bi bi-chevron-left"></i>
    </button>
    <span class="page-title" id="cfg-page-header-title">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</span>
    <div class="header-icons">
      <!-- å°†æ¥ã®æ‹¡å¼µç”¨ -->
    </div>
  </div>

  <!-- ============================================ -->
  <!-- è¨­å®šã‚³ãƒ³ãƒ†ãƒŠ -->
  <!-- ============================================ -->
  <div class="config-container" id="cfg-configContainer">

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–ãƒšã‚¤ãƒ³: å•†å“ç™»éŒ²è¨­å®š -->
    <div class="cfg-tab-pane" id="cfg-product">
      <!-- ã‚µãƒ–ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
      <div class="cfg-subtabs" id="cfg-productConfigTabs">
        <button class="cfg-subtab active" data-target="cfg-product-salesword"><i class="bi bi-chat-quote"></i> ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰</button>
        <button class="cfg-subtab" data-target="cfg-product-condition"><i class="bi bi-toggle-on"></i> å•†å“çŠ¶æ…‹</button>
        <button class="cfg-subtab" data-target="cfg-product-hashtag"><i class="bi bi-tag"></i> ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°</button>
        <button class="cfg-subtab" data-target="cfg-product-discount"><i class="bi bi-percent"></i> å‰²å¼•</button>
        <button class="cfg-subtab" data-target="cfg-product-ai"><i class="bi bi-stars"></i> AIç”Ÿæˆ</button>
        <button class="cfg-subtab" data-target="cfg-product-order"><i class="bi bi-sort-numeric-down"></i> é…ç½®é †åº</button>
      </div>
      <!-- ã‚µãƒ–ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <div id="cfg-productConfigTabContent" class="cfg-subtab-content">
        <!-- ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š -->
        <div class="cfg-subtab-pane active" id="cfg-product-salesword">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-megaphone"></i> ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š</div>
            <div class="cfg-card-desc">å•†å“èª¬æ˜ã«è¿½åŠ ã™ã‚‹ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¾ã™</div>
            <div id="cfg-saleswordConfigContainer">
              <div id="cfg-saleswordList" style="display: flex; flex-direction: column; gap: 8px;"></div>
              <button type="button" onclick="cfgAddSaleswordItem()" style="margin-top: 12px; padding: 10px; width: 100%; background: #f3f4f6; color: #374151; border: 2px dashed #d1d5db; border-radius: 8px; font-size: 13px; cursor: pointer;">
                <i class="bi bi-plus-lg"></i> ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ 
              </button>
            </div>
          </div>
          <!-- ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰å½¢å¼è¨­å®š -->
          <div class="cfg-card" style="margin-top: 12px;">
            <div class="cfg-card-title"><i class="bi bi-gear"></i> ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰å½¢å¼</div>
            <div style="margin-bottom: 12px;">
              <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">åŒºåˆ‡ã‚Šæ–‡å­—</label>
              <select id="cfg-saleswordSeparator" class="form-control">
                <option value=" / "> / ï¼ˆã‚¹ãƒ©ãƒƒã‚·ãƒ¥ï¼‰</option>
                <option value=" | "> | ï¼ˆãƒ‘ã‚¤ãƒ—ï¼‰</option>
                <option value=" ãƒ» "> ãƒ» ï¼ˆä¸­ç‚¹ï¼‰</option>
                <option value="  ">   ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ï¼‰</option>
                <option value="\n">æ”¹è¡Œ</option>
              </select>
            </div>
            <div>
              <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">æ‹¬å¼§ã®ã‚¹ã‚¿ã‚¤ãƒ«</label>
              <select id="cfg-saleswordBracket" class="form-control">
                <option value="none">ãªã—</option>
                <option value="round">ï¼ˆ ï¼‰ä¸¸æ‹¬å¼§</option>
                <option value="square">[ ] è§’æ‹¬å¼§</option>
                <option value="angle">ï¼œ ï¼å±±æ‹¬å¼§</option>
                <option value="emoji">âœ¨ âœ¨ è£…é£¾</option>
              </select>
            </div>
          </div>
        </div>

        <!-- å•†å“çŠ¶æ…‹è¨­å®š -->
        <div class="cfg-subtab-pane" id="cfg-product-condition">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-check-circle"></i> å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³è¨­å®š</div>
            <div class="cfg-card-desc">å•†å“ç™»éŒ²ç”»é¢ã®çŠ¶æ…‹ãƒœã‚¿ãƒ³ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¾ã™</div>
            <div id="cfg-conditionButtonsContainer"></div>
            <button type="button" onclick="cfgAddConditionButton()" style="margin-top: 12px; padding: 10px; width: 100%; background: #f3f4f6; color: #374151; border: 2px dashed #d1d5db; border-radius: 8px; font-size: 13px; cursor: pointer;">
              <i class="bi bi-plus-lg"></i> ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            </button>
          </div>
        </div>

        <!-- ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°è¨­å®š -->
        <div class="cfg-subtab-pane" id="cfg-product-hashtag">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-hash"></i> ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°è¨­å®š</div>
            <div class="cfg-card-desc">å•†å“èª¬æ˜ã«è‡ªå‹•è¿½åŠ ã™ã‚‹ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’è¨­å®šã—ã¾ã™</div>
            <div id="cfg-hashtagConfigContainer"></div>
            <button type="button" onclick="cfgAddHashtagGroup()" style="margin-top: 12px; padding: 10px; width: 100%; background: #f3f4f6; color: #374151; border: 2px dashed #d1d5db; border-radius: 8px; font-size: 13px; cursor: pointer;">
              <i class="bi bi-plus-lg"></i> ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¿½åŠ 
            </button>
            <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div style="margin-top: 16px; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
              <div style="font-size: 12px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
              <div id="cfg-hashtagPreview" style="font-size: 13px; color: #374151; white-space: pre-line;"></div>
            </div>
          </div>
        </div>

        <!-- å‰²å¼•è¨­å®š -->
        <div class="cfg-subtab-pane" id="cfg-product-discount">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-percent"></i> å‰²å¼•è¨­å®š</div>
            <div class="cfg-card-desc">å•†å“èª¬æ˜ã«è¡¨ç¤ºã™ã‚‹å‰²å¼•æƒ…å ±ã‚’è¨­å®šã—ã¾ã™</div>
            <div id="cfg-discountConfigContainer"></div>
            <button type="button" onclick="cfgAddDiscountBlock()" style="margin-top: 12px; padding: 10px; width: 100%; background: #f3f4f6; color: #374151; border: 2px dashed #d1d5db; border-radius: 8px; font-size: 13px; cursor: pointer;">
              <i class="bi bi-plus-lg"></i> å‰²å¼•ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ 
            </button>
            <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div style="margin-top: 16px; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
              <div style="font-size: 12px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
              <div id="cfg-discountPreview" style="font-size: 13px; color: #374151; white-space: pre-line;"></div>
            </div>
          </div>
        </div>

        <!-- AIç”Ÿæˆè¨­å®š -->
        <div class="cfg-subtab-pane" id="cfg-product-ai">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-stars"></i> AIç”Ÿæˆè¨­å®š</div>
            <div class="cfg-card-desc">AIã«ã‚ˆã‚‹å•†å“èª¬æ˜æ–‡ã®ç”Ÿæˆè¨­å®šã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¾ã™</div>
            <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠ -->
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
              <div id="cfg-aiPresetButtons" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
            </div>
            <!-- è©³ç´°è¨­å®š -->
            <div id="cfg-aiDetailSettings">
              <div style="margin-bottom: 12px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">ãƒˆãƒ¼ãƒ³</label>
                <select id="cfg-aiTone" class="form-control" onchange="cfgUpdateAiConfigPreview()">
                  <option value="casual">ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«</option>
                  <option value="formal">ãƒ•ã‚©ãƒ¼ãƒãƒ«</option>
                  <option value="friendly">ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼</option>
                  <option value="professional">ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«</option>
                </select>
              </div>
              <div style="margin-bottom: 12px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">é•·ã•</label>
                <select id="cfg-aiLength" class="form-control" onchange="cfgUpdateAiConfigPreview()">
                  <option value="short">çŸ­ã‚ï¼ˆ50-100æ–‡å­—ï¼‰</option>
                  <option value="medium">æ™®é€šï¼ˆ100-200æ–‡å­—ï¼‰</option>
                  <option value="long">é•·ã‚ï¼ˆ200-400æ–‡å­—ï¼‰</option>
                </select>
              </div>
              <div style="margin-bottom: 12px;">
                <label style="display: flex; align-items: center; justify-content: space-between;">
                  <span style="font-size: 13px; font-weight: 500; color: #374151;">æ¸©åº¦ï¼ˆå‰µé€ æ€§ï¼‰</span>
                  <span id="cfg-aiTempDisplay" style="font-size: 13px; color: #6b7280;">0.7</span>
                </label>
                <input type="range" id="cfg-aiTemperature" min="0" max="1" step="0.1" value="0.7"
                  style="width: 100%; margin-top: 4px;"
                  oninput="cfgUpdateTempDisplay(this.value); cfgUpdateAiConfigPreview();">
              </div>
              <div style="margin-bottom: 12px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">è¿½åŠ æŒ‡ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                <textarea id="cfg-aiCustomPrompt" class="form-control" rows="3" placeholder="ä¾‹: è‹¥ã„å¥³æ€§å‘ã‘ã®è¡¨ç¾ã‚’ä½¿ã£ã¦ãã ã•ã„" onchange="cfgUpdateAiConfigPreview()"></textarea>
              </div>
            </div>
            <!-- AIè¨­å®šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div style="margin-top: 12px; padding: 12px; background: #f0f9ff; border-radius: 8px; border: 1px solid #bae6fd;">
              <div style="font-size: 12px; font-weight: 600; color: #0369a1; margin-bottom: 8px;">è¨­å®šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
              <div id="cfg-aiConfigPreview" style="font-size: 12px; color: #374151;"></div>
            </div>
            <div style="margin-top: 12px; text-align: right;">
              <button type="button" onclick="cfgClearAiSettings()" class="cfg-btn-secondary" style="font-size: 12px; padding: 6px 12px;">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
            </div>
          </div>
        </div>

        <!-- é…ç½®é †åº -->
        <div class="cfg-subtab-pane" id="cfg-product-order">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-list-ol"></i> èª¬æ˜æ–‡ã®é…ç½®é †åº</div>
            <div class="cfg-card-desc">å•†å“èª¬æ˜æ–‡ã«è¡¨ç¤ºã™ã‚‹è¦ç´ ã®é †ç•ªã¨æœ‰åŠ¹/ç„¡åŠ¹ã‚’è¨­å®šã—ã¾ã™ã€‚ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆã§ãã¾ã™ã€‚</div>
            <div id="cfg-descriptionOrderList" style="display: flex; flex-direction: column; gap: 6px;"></div>
            <div style="margin-top: 12px; text-align: right;">
              <button type="button" onclick="cfgResetDescriptionOrder()" class="cfg-btn-secondary" style="font-size: 12px; padding: 6px 12px;">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
            </div>
            <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div style="margin-top: 16px; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
              <div style="font-size: 12px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">é…ç½®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
              <div id="cfg-descriptionOrderPreview" style="font-size: 12px; color: #374151; white-space: pre-line;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–ãƒšã‚¤ãƒ³: ã‚·ã‚¹ãƒ†ãƒ è¨­å®š -->
    <div class="cfg-tab-pane" id="cfg-system">
      <!-- ã‚µãƒ–ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
      <div class="cfg-subtabs" id="cfg-systemConfigTabs">
        <button class="cfg-subtab active" data-target="cfg-system-management"><i class="bi bi-123"></i> ç®¡ç†ç•ªå·</button>
        <button class="cfg-subtab" data-target="cfg-system-shipping"><i class="bi bi-box-seam"></i> é…é€</button>
        <button class="cfg-subtab" data-target="cfg-system-procure"><i class="bi bi-briefcase"></i> ä»•å…¥ãƒ»å‡ºå“</button>
        <button class="cfg-subtab" data-target="cfg-system-platform"><i class="bi bi-globe"></i> ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </button>
        <button class="cfg-subtab" data-target="cfg-system-users"><i class="bi bi-people"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</button>
        <button class="cfg-subtab" data-target="cfg-system-compensation"><i class="bi bi-currency-yen"></i> å ±é…¬</button>
        <button class="cfg-subtab" data-target="cfg-system-permission"><i class="bi bi-shield-lock"></i> æ¨©é™</button>
      </div>
      <!-- ã‚µãƒ–ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <div id="cfg-systemConfigTabContent" class="cfg-subtab-content">
        <!-- ç®¡ç†ç•ªå·è¨­å®š -->
        <div class="cfg-subtab-pane active" id="cfg-system-management">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-123"></i> ç®¡ç†ç•ªå·è¨­å®š</div>
            <div class="cfg-card-desc">ç®¡ç†ç•ªå·ã®è‡ªå‹•ç”Ÿæˆãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¾ã™</div>
            <!-- ManagementNumberBuilder -->
            <div class="mnb-container" id="cfg-mnbContainer">
              <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
              <div class="mnb-section">
                <div class="mnb-section-title">ç®¡ç†ç•ªå·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
                <div class="mnb-format-display" id="cfg-mnb-preview">---</div>
                <div style="text-align: center; font-size: 11px; color: #6b7280; margin-top: 4px;">
                  ã“ã®å½¢å¼ã§ç®¡ç†ç•ªå·ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™
                </div>
              </div>

              <!-- ãƒ‘ãƒ¼ãƒ„è¨­å®š -->
              <div class="mnb-section">
                <div class="mnb-section-title">æ§‹æˆãƒ‘ãƒ¼ãƒ„</div>

                <!-- ã‚«ãƒ†ã‚´ãƒªã‚³ãƒ¼ãƒ‰ -->
                <div class="mnb-part-card enabled" id="cfg-mnb-part-category">
                  <div class="mnb-part-header">
                    <label class="mnb-toggle">
                      <input type="checkbox" checked onchange="cfgMnbTogglePart('category', this.checked)">
                      <span class="mnb-slider"></span>
                    </label>
                    <div style="flex: 1;">
                      <div style="font-size: 13px; font-weight: 600; color: #374151;">ã‚«ãƒ†ã‚´ãƒªã‚³ãƒ¼ãƒ‰</div>
                      <div style="font-size: 11px; color: #6b7280;">ä¾‹: TP, BT, JK</div>
                    </div>
                  </div>
                  <div class="mnb-part-body">
                    <div style="margin-bottom: 8px;">
                      <label style="font-size: 12px; color: #6b7280;">ã‚«ãƒ†ã‚´ãƒªã‚³ãƒ¼ãƒ‰ã®å–å¾—å…ƒ</label>
                      <select id="cfg-mnb-categorySource" class="form-control" style="margin-top: 4px;" onchange="cfgMnbUpdatePreview()">
                        <option value="master">ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è‡ªå‹•å–å¾—</option>
                        <option value="manual">æ‰‹å‹•å…¥åŠ›</option>
                      </select>
                    </div>
                    <button type="button" onclick="cfgMnbOpenCategoryModal()" style="width: 100%; padding: 8px; background: #eff6ff; color: #1d4ed8; border: 1px solid #bfdbfe; border-radius: 6px; font-size: 12px; cursor: pointer;">
                      ã‚«ãƒ†ã‚´ãƒªã‚³ãƒ¼ãƒ‰ä¸€è¦§ã‚’ç¢ºèª
                    </button>
                  </div>
                </div>

                <!-- é€£ç•ª -->
                <div class="mnb-part-card enabled" id="cfg-mnb-part-serial">
                  <div class="mnb-part-header">
                    <label class="mnb-toggle">
                      <input type="checkbox" checked onchange="cfgMnbTogglePart('serial', this.checked)">
                      <span class="mnb-slider"></span>
                    </label>
                    <div style="flex: 1;">
                      <div style="font-size: 13px; font-weight: 600; color: #374151;">é€£ç•ª</div>
                      <div style="font-size: 11px; color: #6b7280;">ä¾‹: 001, 0001</div>
                    </div>
                  </div>
                  <div class="mnb-part-body">
                    <label style="font-size: 12px; color: #6b7280;">æ¡æ•°</label>
                    <div class="mnb-digits-control" style="margin-top: 4px;">
                      <button type="button" class="mnb-digits-btn" onclick="cfgMnbChangeDigits(-1)">-</button>
                      <span id="cfg-mnb-serialDigits" style="font-size: 18px; font-weight: 700; color: #374151; min-width: 30px; text-align: center;">3</span>
                      <button type="button" class="mnb-digits-btn" onclick="cfgMnbChangeDigits(1)">+</button>
                    </div>
                  </div>
                </div>

                <!-- æ—¥ä»˜ã‚³ãƒ¼ãƒ‰ -->
                <div class="mnb-part-card" id="cfg-mnb-part-date">
                  <div class="mnb-part-header">
                    <label class="mnb-toggle">
                      <input type="checkbox" onchange="cfgMnbTogglePart('date', this.checked)">
                      <span class="mnb-slider"></span>
                    </label>
                    <div style="flex: 1;">
                      <div style="font-size: 13px; font-weight: 600; color: #374151;">æ—¥ä»˜ã‚³ãƒ¼ãƒ‰</div>
                      <div style="font-size: 11px; color: #6b7280;">ä¾‹: 240115, 2401</div>
                    </div>
                  </div>
                  <div class="mnb-part-body">
                    <label style="font-size: 12px; color: #6b7280;">ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</label>
                    <select id="cfg-mnb-dateFormat" class="form-control" style="margin-top: 4px;" onchange="cfgMnbUpdatePreview()">
                      <option value="YYMMDD">YYMMDDï¼ˆä¾‹: 240115ï¼‰</option>
                      <option value="YYMM">YYMMï¼ˆä¾‹: 2401ï¼‰</option>
                      <option value="MMDD">MMDDï¼ˆä¾‹: 0115ï¼‰</option>
                    </select>
                  </div>
                </div>

                <!-- ã‚¤ãƒ‹ã‚·ãƒ£ãƒ« -->
                <div class="mnb-part-card" id="cfg-mnb-part-initial">
                  <div class="mnb-part-header">
                    <label class="mnb-toggle">
                      <input type="checkbox" onchange="cfgMnbTogglePart('initial', this.checked)">
                      <span class="mnb-slider"></span>
                    </label>
                    <div style="flex: 1;">
                      <div style="font-size: 13px; font-weight: 600; color: #374151;">æ‹…å½“è€…ã‚¤ãƒ‹ã‚·ãƒ£ãƒ«</div>
                      <div style="font-size: 11px; color: #6b7280;">ä¾‹: YT, KS</div>
                    </div>
                  </div>
                  <div class="mnb-part-body">
                    <label style="font-size: 12px; color: #6b7280;">ã‚¤ãƒ‹ã‚·ãƒ£ãƒ«ã®å–å¾—å…ƒ</label>
                    <select id="cfg-mnb-initialSource" class="form-control" style="margin-top: 4px;" onchange="cfgMnbUpdatePreview()">
                      <option value="auto">ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰è‡ªå‹•å–å¾—</option>
                      <option value="manual">æ‰‹å‹•å…¥åŠ›</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- åŒºåˆ‡ã‚Šæ–‡å­— -->
              <div class="mnb-section">
                <div class="mnb-section-title">åŒºåˆ‡ã‚Šæ–‡å­—</div>
                <div class="mnb-separator-selector" id="cfg-mnb-separatorSelector">
                  <button type="button" class="mnb-separator-btn active" data-sep="-" onclick="cfgMnbSelectSeparator(this)">-ï¼ˆãƒã‚¤ãƒ•ãƒ³ï¼‰</button>
                  <button type="button" class="mnb-separator-btn" data-sep="_" onclick="cfgMnbSelectSeparator(this)">_ï¼ˆã‚¢ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ï¼‰</button>
                  <button type="button" class="mnb-separator-btn" data-sep="" onclick="cfgMnbSelectSeparator(this)">ãªã—</button>
                </div>
              </div>

              <!-- ãƒ‘ãƒ¼ãƒ„ã®ä¸¦ã³é † -->
              <div class="mnb-section">
                <div class="mnb-section-title">ãƒ‘ãƒ¼ãƒ„ã®ä¸¦ã³é †</div>
                <div id="cfg-mnb-partOrder" style="display: flex; flex-direction: column; gap: 6px;"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- é…é€è¨­å®š -->
        <div class="cfg-subtab-pane" id="cfg-system-shipping">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-truck"></i> é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š</div>
            <div class="cfg-card-desc">å•†å“ç™»éŒ²æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé…é€è¨­å®šã‚’è¨­å®šã—ã¾ã™</div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">é…é€æ–™ã®è² æ‹…</label>
                <select id="cfg-é…é€æ–™ã®è² æ‹…" class="form-control">
                  <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">é…é€ã®æ–¹æ³•</label>
                <select id="cfg-é…é€ã®æ–¹æ³•" class="form-control">
                  <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">ç™ºé€å…ƒã®åœ°åŸŸ</label>
                <select id="cfg-ç™ºé€å…ƒã®åœ°åŸŸ" class="form-control">
                  <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">ç™ºé€ã¾ã§ã®æ—¥æ•°</label>
                <select id="cfg-ç™ºé€ã¾ã§ã®æ—¥æ•°" class="form-control">
                  <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- ä»•å…¥ãƒ»å‡ºå“è¨­å®š -->
        <div class="cfg-subtab-pane" id="cfg-system-procure">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-cart"></i> ä»•å…¥ãƒ»å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š</div>
            <div class="cfg-card-desc">å•†å“ç™»éŒ²æ™‚ã®ä»•å…¥ãƒ»å‡ºå“ã«é–¢ã™ã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šã—ã¾ã™</div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">ä»•å…¥å…ˆ</label>
                <select id="cfg-ä»•å…¥å…ˆ" class="form-control">
                  <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">ä»•å…¥æ—¥</label>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; cursor: pointer;">
                    <input type="radio" name="cfg-procureDateMode" value="today" checked onchange="cfgToggleProcureDateField(this.value)"> ä»Šæ—¥ã®æ—¥ä»˜
                  </label>
                  <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; cursor: pointer;">
                    <input type="radio" name="cfg-procureDateMode" value="fixed" onchange="cfgToggleProcureDateField(this.value)"> å›ºå®šæ—¥ä»˜
                  </label>
                </div>
                <input type="date" id="cfg-ä»•å…¥æ—¥" class="form-control" style="display: none; margin-top: 6px;">
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">å‡ºå“å…ˆ</label>
                <select id="cfg-å‡ºå“å…ˆ" class="form-control">
                  <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">å‡ºå“æ—¥</label>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; cursor: pointer;">
                    <input type="radio" name="cfg-listingDateMode" value="today" checked onchange="cfgToggleListingDateField(this.value)"> ä»Šæ—¥ã®æ—¥ä»˜
                  </label>
                  <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; cursor: pointer;">
                    <input type="radio" name="cfg-listingDateMode" value="fixed" onchange="cfgToggleListingDateField(this.value)"> å›ºå®šæ—¥ä»˜
                  </label>
                </div>
                <input type="date" id="cfg-å‡ºå“æ—¥" class="form-control" style="display: none; margin-top: 6px;">
              </div>
            </div>
          </div>
        </div>

        <!-- ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š -->
        <div class="cfg-subtab-pane" id="cfg-system-platform">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-grid"></i> ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š</div>
            <div class="cfg-card-desc">å‡ºå“å…ˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’è¨­å®šã—ã¾ã™</div>
            <!-- ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ -->
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰</label>
              <div style="display: flex; gap: 8px;">
                <label onclick="cfgSelectRegistrationMode('individual')" style="flex: 1; padding: 10px; border: 2px solid #40B4E5; border-radius: 8px; text-align: center; cursor: pointer; font-size: 13px; font-weight: 600; color: #374151; background: #f0f9ff;">
                  <input type="radio" name="cfg-registrationMode" id="cfg-modeIndividual" value="individual" checked style="display: none;">
                  å€‹åˆ¥ç™»éŒ²
                </label>
                <label onclick="cfgSelectRegistrationMode('batch')" style="flex: 1; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; text-align: center; cursor: pointer; font-size: 13px; font-weight: 600; color: #374151;">
                  <input type="radio" name="cfg-registrationMode" id="cfg-modeBatch" value="batch" style="display: none;">
                  ä¸€æ‹¬ç™»éŒ²
                </label>
              </div>
            </div>
            <!-- ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ä¸€è¦§ -->
            <div id="cfg-enabledPlatformsList"></div>
            <button type="button" onclick="cfgOpenPlatformSelectModal()" style="margin-top: 12px; padding: 10px; width: 100%; background: #f3f4f6; color: #374151; border: 2px dashed #d1d5db; border-radius: 8px; font-size: 13px; cursor: pointer;">
              <i class="bi bi-plus-lg"></i> ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’è¿½åŠ 
            </button>
          </div>
        </div>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† -->
        <div class="cfg-subtab-pane" id="cfg-system-users">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-people"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</div>
            <div id="cfg-userManagementLoading" style="text-align: center; padding: 40px;">
              <div style="font-size: 14px; color: #6b7280;">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
            <div id="cfg-userManagementContent" style="display: none;">
              <!-- æ¤œç´¢ -->
              <div style="margin-bottom: 12px;">
                <input type="text" id="cfg-userSearchInput" oninput="cfgFilterUserList()" class="form-control" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ»ãƒ¡ãƒ¼ãƒ«ã§æ¤œç´¢..." style="font-size: 13px;">
              </div>
              <!-- æ‰¿èªå¾…ã¡ -->
              <div id="cfg-pendingSection" style="display: none; margin-bottom: 16px;">
                <div onclick="cfgToggleSection('pending')" style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #fff7ed; border-radius: 8px; cursor: pointer; margin-bottom: 8px;">
                  <span style="font-size: 13px; font-weight: 600; color: #c2410c;">æ‰¿èªå¾…ã¡</span>
                  <span id="cfg-pendingUsersCount" style="background: #ef4444; color: white; font-size: 11px; padding: 2px 8px; border-radius: 10px;">0</span>
                  <span id="cfg-pendingToggle" style="margin-left: auto; font-size: 10px; color: #6b7280;">â–¼</span>
                </div>
                <div id="cfg-pendingUsersList"></div>
              </div>
              <!-- æ¨©é™ã‚°ãƒ«ãƒ¼ãƒ— -->
              <div id="cfg-permissionGroups"></div>
              <!-- ç„¡åŠ¹ãƒ¦ãƒ¼ã‚¶ãƒ¼ -->
              <div id="cfg-inactiveSection" style="display: none; margin-top: 16px;">
                <div onclick="cfgToggleSection('inactive')" style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #f3f4f6; border-radius: 8px; cursor: pointer; margin-bottom: 8px;">
                  <span style="font-size: 13px; font-weight: 600; color: #6b7280;">ç„¡åŠ¹ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
                  <span id="cfg-inactiveUsersCount" style="background: #6b7280; color: white; font-size: 11px; padding: 2px 8px; border-radius: 10px;">0</span>
                  <span id="cfg-inactiveToggle" style="margin-left: auto; font-size: 10px; color: #6b7280;">â–¶</span>
                </div>
                <div id="cfg-inactiveUsersList" style="display: none;"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- å ±é…¬è¨­å®š -->
        <div class="cfg-subtab-pane" id="cfg-system-compensation">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-currency-yen"></i> ã‚¿ã‚¹ã‚¯åˆ¥å ±é…¬å˜ä¾¡</div>
            <div class="cfg-card-desc">å„ã‚¿ã‚¹ã‚¯ã®1ä»¶ã‚ãŸã‚Šã®å ±é…¬å˜ä¾¡ã‚’è¨­å®šã—ã¾ã™</div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                <div style="width: 40px; height: 40px; background: #dbeafe; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ“¦</div>
                <div style="flex: 1; font-size: 14px; font-weight: 500; color: #374151;">å•†å“å‡ºå“</div>
                <div style="display: flex; align-items: center; gap: 4px;">
                  <span style="font-size: 14px; color: #6b7280;">Â¥</span>
                  <input type="number" id="cfg-compensation-listing" value="100" min="0" step="10" style="width: 80px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; text-align: right;">
                  <span style="font-size: 12px; color: #6b7280;">/ä»¶</span>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                <div style="width: 40px; height: 40px; background: #fef3c7; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸšš</div>
                <div style="flex: 1; font-size: 14px; font-weight: 500; color: #374151;">æ¢±åŒ…ãƒ»ç™ºé€</div>
                <div style="display: flex; align-items: center; gap: 4px;">
                  <span style="font-size: 14px; color: #6b7280;">Â¥</span>
                  <input type="number" id="cfg-compensation-shipping" value="100" min="0" step="10" style="width: 80px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; text-align: right;">
                  <span style="font-size: 12px; color: #6b7280;">/ä»¶</span>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                <div style="width: 40px; height: 40px; background: #d1fae5; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ“¸</div>
                <div style="flex: 1; font-size: 14px; font-weight: 500; color: #374151;">å•†å“æ’®å½±</div>
                <div style="display: flex; align-items: center; gap: 4px;">
                  <span style="font-size: 14px; color: #6b7280;">Â¥</span>
                  <input type="number" id="cfg-compensation-photography" value="50" min="0" step="10" style="width: 80px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; text-align: right;">
                  <span style="font-size: 12px; color: #6b7280;">/ä»¶</span>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                <div style="width: 40px; height: 40px; background: #fce7f3; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ”</div>
                <div style="flex: 1; font-size: 14px; font-weight: 500; color: #374151;">æ¤œå“ä½œæ¥­</div>
                <div style="display: flex; align-items: center; gap: 4px;">
                  <span style="font-size: 14px; color: #6b7280;">Â¥</span>
                  <input type="number" id="cfg-compensation-inspection" value="30" min="0" step="10" style="width: 80px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; text-align: right;">
                  <span style="font-size: 12px; color: #6b7280;">/ä»¶</span>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                <div style="width: 40px; height: 40px; background: #ede9fe; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ“‹</div>
                <div style="flex: 1; font-size: 14px; font-weight: 500; color: #374151;">æ£šå¸</div>
                <div style="display: flex; align-items: center; gap: 4px;">
                  <span style="font-size: 14px; color: #6b7280;">Â¥</span>
                  <input type="number" id="cfg-compensation-stocktaking" value="20" min="0" step="10" style="width: 80px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; text-align: right;">
                  <span style="font-size: 12px; color: #6b7280;">/ä»¶</span>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                <div style="width: 40px; height: 40px; background: #fef3c7; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">âœï¸</div>
                <div style="flex: 1; font-size: 14px; font-weight: 500; color: #374151;">è¿½åŠ ç·¨é›†</div>
                <div style="display: flex; align-items: center; gap: 4px;">
                  <span style="font-size: 14px; color: #6b7280;">Â¥</span>
                  <input type="number" id="cfg-compensation-editing" value="50" min="0" step="10" style="width: 80px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; text-align: right;">
                  <span style="font-size: 12px; color: #6b7280;">/ä»¶</span>
                </div>
              </div>
            </div>
            <!-- ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¹ã‚¯ -->
            <div id="cfg-customCompensationTasks" style="display: none; margin-top: 12px;">
              <div style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¹ã‚¯</div>
              <div id="cfg-customTasksContainer"></div>
            </div>
            <button type="button" onclick="cfgAddCustomCompensationTask()" style="margin-top: 12px; padding: 10px; width: 100%; background: #f3f4f6; color: #374151; border: 2px dashed #d1d5db; border-radius: 8px; font-size: 13px; cursor: pointer;">
              <i class="bi bi-plus-lg"></i> ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
            </button>
          </div>

          <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®š -->
          <div class="cfg-card" style="margin-top: 12px;">
            <div class="cfg-card-title">ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®š</div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                <span style="font-size: 13px; color: #374151;">å‡ºå“æ™‚ã«è‡ªå‹•è¨˜éŒ²</span>
                <label class="cfg-toggle"><input type="checkbox" id="cfg-autoRecordListing" checked><span class="slider"></span></label>
              </label>
              <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                <span style="font-size: 13px; color: #374151;">ç™ºé€æ™‚ã«è‡ªå‹•è¨˜éŒ²</span>
                <label class="cfg-toggle"><input type="checkbox" id="cfg-autoRecordShipping" checked><span class="slider"></span></label>
              </label>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">ç· ã‚æ—¥</label>
                <select id="cfg-compensationCutoffDay" class="form-control">
                  <option value="æœ«æ—¥">æœ«æ—¥</option>
                  <option value="15æ—¥">15æ—¥</option>
                  <option value="20æ—¥">20æ—¥</option>
                  <option value="25æ—¥">25æ—¥</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">æ”¯æ‰•æ—¥</label>
                <select id="cfg-compensationPaymentDay" class="form-control">
                  <option value="ç¿Œæœˆ5æ—¥">ç¿Œæœˆ5æ—¥</option>
                  <option value="ç¿Œæœˆ10æ—¥">ç¿Œæœˆ10æ—¥</option>
                  <option value="ç¿Œæœˆ15æ—¥">ç¿Œæœˆ15æ—¥</option>
                  <option value="ç¿Œæœˆæœ«æ—¥">ç¿Œæœˆæœ«æ—¥</option>
                </select>
              </div>
              <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                <span style="font-size: 13px; color: #374151;">çµŒè²»ã¨ã—ã¦è¨˜éŒ²</span>
                <label class="cfg-toggle"><input type="checkbox" id="cfg-recordAsExpense" checked><span class="slider"></span></label>
              </label>
            </div>
          </div>

          <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚¿ã‚¹ã‚¯æ‹…å½“è¨­å®š -->
          <div class="cfg-card" style="margin-top: 12px;">
            <div class="cfg-card-title"><i class="bi bi-person-check"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚¿ã‚¹ã‚¯æ‹…å½“</div>
            <div class="cfg-card-desc">å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ‹…å½“ã‚¿ã‚¹ã‚¯ã‚’å‰²ã‚Šå½“ã¦ã¾ã™</div>
            <button type="button" onclick="cfgAssignAllTasksToAll()" style="margin-bottom: 12px; padding: 8px 16px; background: #eff6ff; color: #1d4ed8; border: 1px solid #bfdbfe; border-radius: 6px; font-size: 12px; cursor: pointer;">å…¨å“¡ã«å…¨ã‚¿ã‚¹ã‚¯ã‚’å‰²ã‚Šå½“ã¦</button>
            <div id="cfg-userTaskAssignmentList" style="display: flex; flex-direction: column; gap: 8px;"></div>
          </div>

          <!-- å ±é…¬ç®¡ç†ã¸ã®ãƒªãƒ³ã‚¯ -->
          <div class="cfg-card" style="margin-top: 12px;">
            <button type="button" onclick="cfgOpenCompensationManagement()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #40B4E5 0%, #2196F3 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
              <i class="bi bi-arrow-right-circle"></i> å ±é…¬ç®¡ç†ç”»é¢ã‚’é–‹ã
            </button>
          </div>
        </div>

        <!-- æ¨©é™è¨­å®š -->
        <div class="cfg-subtab-pane" id="cfg-system-permission">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-shield-lock"></i> æ¨©é™è¨­å®š</div>
            <div class="cfg-card-desc">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ã¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’è¨­å®šã—ã¾ã™</div>
            <div id="cfg-permissionSettingsLoading" style="text-align: center; padding: 40px;">
              <div style="font-size: 14px; color: #6b7280;">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
            <div id="cfg-permissionSettingsContent" style="display: none;">
              <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ -->
              <div style="margin-bottom: 20px;">
                <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™</div>
                <div id="cfg-userPermissionList" style="display: flex; flex-direction: column; gap: 8px;"></div>
              </div>
              <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºæ¨©é™ -->
              <div>
                <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºæ¨©é™</div>
                <div id="cfg-menuPermissionList"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
  <div class="cfg-save-footer">
    <button class="cfg-save-btn" onclick="cfgSaveConfig()">
      <i class="bi bi-check-lg"></i> è¨­å®šã‚’ä¿å­˜
    </button>
  </div>

  <!-- ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="cfg-modal-overlay" id="cfg-platformSelectModal">
    <div class="cfg-modal-content">
      <div class="cfg-modal-header">
        <h3>ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’è¿½åŠ </h3>
        <button class="cfg-modal-close" onclick="cfgClosePlatformSelectModal()">&times;</button>
      </div>
      <div class="cfg-modal-body">
        <div id="cfg-platformSelectList"></div>
      </div>
    </div>
  </div>

  <!-- ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="cfg-modal-overlay" id="cfg-platformEditModal">
    <div class="cfg-modal-content">
      <div class="cfg-modal-header">
        <h3>ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’ç·¨é›†</h3>
        <button class="cfg-modal-close" onclick="cfgClosePlatformEditModal()">&times;</button>
      </div>
      <div class="cfg-modal-body">
        <input type="hidden" id="cfg-editPlatformId">
        <div style="margin-bottom: 12px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">è¡¨ç¤ºå</label>
          <input type="text" id="cfg-editPlatformName" class="form-control" placeholder="ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å">
        </div>
        <div style="margin-bottom: 12px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">èª¬æ˜</label>
          <input type="text" id="cfg-editPlatformDesc" class="form-control" placeholder="ç°¡å˜ãªèª¬æ˜">
        </div>
        <div style="margin-bottom: 12px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">ã‚¢ã‚¤ã‚³ãƒ³</label>
          <div style="display: flex; align-items: center; gap: 12px;">
            <div id="cfg-platformIconPreview" style="width: 48px; height: 48px; border-radius: 8px; border: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; overflow: hidden;">
              <span style="color: #9ca3af; font-size: 12px;">æœªè¨­å®š</span>
            </div>
            <div style="flex: 1;">
              <input type="file" id="cfg-platformIconInput" accept="image/*" onchange="cfgPreviewPlatformIcon(event)" style="font-size: 12px;">
              <div id="cfg-platformIconUploadStatus" style="font-size: 11px; margin-top: 4px;"></div>
            </div>
          </div>
        </div>
        <div style="display: flex; gap: 8px; margin-top: 16px;">
          <button type="button" onclick="cfgClosePlatformEditModal()" class="cfg-btn-secondary" style="flex: 1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" onclick="cfgSavePlatformEdit()" class="cfg-btn-primary" style="flex: 1;">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç™ºé€å…ˆæƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="cfg-modal-overlay" id="cfg-shippingInfoModal">
    <div class="cfg-modal-content">
      <div class="cfg-modal-header">
        <h3>ç™ºé€å…ˆæƒ…å ±ã‚’å…¥åŠ›</h3>
        <button class="cfg-modal-close" onclick="cfgCloseShippingInfoModal()">&times;</button>
      </div>
      <div class="cfg-modal-body">
        <div style="display: flex; gap: 8px; margin-bottom: 16px;">
          <div style="flex: 1;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">å§“<span style="color: #ef4444;">*</span></label>
            <input type="text" id="cfg-shippingLastName" class="form-control" placeholder="å±±ç”°" maxlength="20">
          </div>
          <div style="flex: 1;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">å<span style="color: #ef4444;">*</span></label>
            <input type="text" id="cfg-shippingFirstName" class="form-control" placeholder="å¤ªéƒ" maxlength="20">
          </div>
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">éƒµä¾¿ç•ªå·<span style="color: #ef4444;">*</span></label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <span style="font-size: 13px; color: #6b7280;">ã€’</span>
            <input type="text" id="cfg-shippingPostalCode" class="form-control" placeholder="000-0000" maxlength="8" style="width: 120px;" oninput="cfgFormatPostalCode(this)">
            <button type="button" onclick="cfgSearchShippingAddress()" style="background: #e5e7eb; color: #374151; border: none; padding: 6px 10px; border-radius: 6px; font-size: 11px; white-space: nowrap; cursor: pointer;">ä½æ‰€æ¤œç´¢</button>
          </div>
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">éƒ½é“åºœçœŒ<span style="color: #ef4444;">*</span></label>
          <input type="text" id="cfg-shippingPrefecture" class="form-control" placeholder="æ±äº¬éƒ½" maxlength="10">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">å¸‚åŒºç”ºæ‘ãƒ»ç•ªåœ°<span style="color: #ef4444;">*</span></label>
          <input type="text" id="cfg-shippingCity" class="form-control" placeholder="æ¸‹è°·åŒºæ¸‹è°·1-2-3" maxlength="100">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">å»ºç‰©åãƒ»éƒ¨å±‹ç•ªå·</label>
          <input type="text" id="cfg-shippingBuilding" class="form-control" placeholder="ãƒ•ãƒªãƒ©ãƒ“ãƒ«101å·å®¤ï¼ˆä»»æ„ï¼‰" maxlength="100">
        </div>
        <div style="display: flex; gap: 8px;">
          <button type="button" onclick="cfgCloseShippingInfoModal()" class="cfg-btn-secondary" style="flex: 1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" onclick="cfgSaveShippingInfo()" class="cfg-btn-primary" style="flex: 1;">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- å£åº§æƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="cfg-modal-overlay" id="cfg-bankAccountModal">
    <div class="cfg-modal-content">
      <div class="cfg-modal-header">
        <h3>å£åº§æƒ…å ±ã‚’å…¥åŠ›</h3>
        <button class="cfg-modal-close" onclick="cfgCloseBankAccountModal()">&times;</button>
      </div>
      <div class="cfg-modal-body">
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">éŠ€è¡Œå<span style="color: #ef4444;">*</span></label>
          <input type="text" id="cfg-bankName" class="form-control" placeholder="ä¾‹: ä¸‰è±UFJéŠ€è¡Œ" maxlength="50">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">æ”¯åº—å<span style="color: #ef4444;">*</span></label>
          <input type="text" id="cfg-bankBranch" class="form-control" placeholder="ä¾‹: æ¸‹è°·æ”¯åº—" maxlength="50">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">å£åº§ç¨®åˆ¥<span style="color: #ef4444;">*</span></label>
          <select id="cfg-bankAccountType" class="form-control">
            <option value="æ™®é€š">æ™®é€š</option>
            <option value="å½“åº§">å½“åº§</option>
          </select>
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">å£åº§ç•ªå·<span style="color: #ef4444;">*</span></label>
          <input type="text" id="cfg-bankAccountNumber" class="form-control" placeholder="1234567" maxlength="10" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">å£åº§åç¾©ï¼ˆã‚«ã‚¿ã‚«ãƒŠï¼‰<span style="color: #ef4444;">*</span></label>
          <input type="text" id="cfg-bankAccountHolder" class="form-control" placeholder="ä¾‹: ãƒ¤ãƒãƒ€ ã‚¿ãƒ­ã‚¦" maxlength="50">
        </div>
        <div style="display: flex; gap: 8px;">
          <button type="button" onclick="cfgCloseBankAccountModal()" class="cfg-btn-secondary" style="flex: 1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" onclick="cfgSaveBankAccount()" class="cfg-btn-primary" style="flex: 1;">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="cfg-userDetailModal">
    <div class="cfg-modal-sheet">
      <div class="cfg-modal-sheet-header">
        <span style="font-size: 16px; font-weight: 600;">ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°</span>
        <button onclick="cfgCloseUserDetailModal()" style="background: none; border: none; font-size: 20px; color: #6b7280; cursor: pointer;">&times;</button>
      </div>
      <div class="cfg-modal-sheet-body" id="cfg-userDetailContent"></div>
      <div class="cfg-modal-sheet-footer" id="cfg-userDetailActions"></div>
    </div>
  </div>

  <!-- ã‚«ãƒ†ã‚´ãƒªã‚³ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç®¡ç†ç•ªå·ãƒ“ãƒ«ãƒ€ãƒ¼ç”¨ï¼‰ -->
  <div class="mnb-modal-overlay" id="cfg-mnb-categoryModal">
    <div class="mnb-modal-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3 style="margin: 0; font-size: 16px; font-weight: 600;">ã‚«ãƒ†ã‚´ãƒªã‚³ãƒ¼ãƒ‰ä¸€è¦§</h3>
        <button onclick="cfgMnbCloseCategoryModal()" style="background: none; border: none; font-size: 20px; color: #6b7280; cursor: pointer;">&times;</button>
      </div>
      <div id="cfg-mnb-categoryList" style="display: flex; flex-direction: column; gap: 6px;"></div>
    </div>
  </div>

  <script>
    // ============================================
    // Config SPA Fragment - JavaScript
    // Prefix: cfg (functions), _cfg_ (variables)
    // ============================================

    // --- State Variables ---
    var _cfg_initialized = false;
    var _cfg_destroyed = false;
    var _cfg_onlineInterval = null;
    var _cfg_pendingUserIconData = null;
    var _cfg_customTaskCounter = 0;
    var _cfg_draggedElement = null;

    // Condition states & presets
    var _cfg_CONDITION_STATES = [
      { value: 'æ–°å“ã€æœªä½¿ç”¨', label: 'æ–°å“ãƒ»æœªä½¿ç”¨', color: '#10b981' },
      { value: 'æœªä½¿ç”¨ã«è¿‘ã„', label: 'æœªä½¿ç”¨ã«è¿‘ã„', color: '#059669' },
      { value: 'ç›®ç«‹ã£ãŸå‚·ã‚„æ±šã‚Œãªã—', label: 'ç›®ç«‹ã£ãŸå‚·ã‚„æ±šã‚Œãªã—', color: '#3b82f6' },
      { value: 'ã‚„ã‚„å‚·ã‚„æ±šã‚Œã‚ã‚Š', label: 'ã‚„ã‚„å‚·ã‚„æ±šã‚Œã‚ã‚Š', color: '#f59e0b' },
      { value: 'å‚·ã‚„æ±šã‚Œã‚ã‚Š', label: 'å‚·ã‚„æ±šã‚Œã‚ã‚Š', color: '#ef4444' },
      { value: 'å…¨ä½“çš„ã«çŠ¶æ…‹ãŒæ‚ªã„', label: 'å…¨ä½“çš„ã«çŠ¶æ…‹ãŒæ‚ªã„', color: '#6b7280' }
    ];

    var _cfg_CONDITION_BUTTON_PRESETS = {
      'Sï¼ˆæ–°å“ï¼‰': 'æ–°å“ã€æœªä½¿ç”¨',
      'Aï¼ˆæœªä½¿ç”¨ã«è¿‘ã„ï¼‰': 'æœªä½¿ç”¨ã«è¿‘ã„',
      'Bï¼ˆç›®ç«‹ã£ãŸå‚·ãªã—ï¼‰': 'ç›®ç«‹ã£ãŸå‚·ã‚„æ±šã‚Œãªã—',
      'Cï¼ˆã‚„ã‚„å‚·ã‚ã‚Šï¼‰': 'ã‚„ã‚„å‚·ã‚„æ±šã‚Œã‚ã‚Š',
      'Dï¼ˆå‚·ã‚ã‚Šï¼‰': 'å‚·ã‚„æ±šã‚Œã‚ã‚Š',
      'Eï¼ˆçŠ¶æ…‹æ‚ªã„ï¼‰': 'å…¨ä½“çš„ã«çŠ¶æ…‹ãŒæ‚ªã„'
    };

    // Platform master data
    var _cfg_defaultPlatformDefs = [
      { id: 'mercari', name: 'ãƒ¡ãƒ«ã‚«ãƒª', description: 'ãƒ•ãƒªãƒã‚¢ãƒ—ãƒªæœ€å¤§æ‰‹', icon: 'https://asset.mercari.com/assets/img/common/touchicon/mercari.png' },
      { id: 'mercari-shops', name: 'ãƒ¡ãƒ«ã‚«ãƒªShops', description: 'ãƒ¡ãƒ«ã‚«ãƒªã®ECãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ', icon: 'https://asset.mercari.com/assets/img/common/touchicon/mercari.png' },
      { id: 'rakuma', name: 'ãƒ©ã‚¯ãƒ', description: 'æ¥½å¤©ã®ãƒ•ãƒªãƒã‚¢ãƒ—ãƒª', icon: '/Images/rakuma-icon.webp' },
      { id: 'yahoo-fleamarket', name: 'Yahoo!ãƒ•ãƒªãƒ', description: 'Yahoo!ã®ãƒ•ãƒªãƒã‚µãƒ¼ãƒ“ã‚¹', icon: '/Images/yahoo-fleamarket-icon.webp' },
      { id: 'yahoo-auction', name: 'Yahoo!ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³', description: 'æ—¥æœ¬æœ€å¤§ã®ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³', icon: '/Images/yahoo-auction-icon.webp' },
      { id: 'amazon', name: 'Amazon', description: 'ä¸–ç•Œæœ€å¤§ã®ECã‚µã‚¤ãƒˆ', icon: '/Images/amazon-icon.webp' },
      { id: 'base', name: 'BASE', description: 'ç„¡æ–™ãƒãƒƒãƒˆã‚·ãƒ§ãƒƒãƒ—ä½œæˆ', icon: '/Images/base-icon.webp' },
      { id: 'minne', name: 'minne', description: 'ãƒãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ‰ãƒãƒ¼ã‚±ãƒƒãƒˆ', icon: '/Images/minne-icon.webp' },
      { id: 'stores', name: 'STORES', description: 'ãƒãƒƒãƒˆã‚·ãƒ§ãƒƒãƒ—é–‹è¨­', icon: '/Images/stores-icon.webp' },
      { id: 'booth', name: 'BOOTH', description: 'ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã‚ºãƒãƒ¼ã‚±ãƒƒãƒˆ', icon: '/Images/booth-icon.webp' }
    ];
    var _cfg_customPlatforms = [];
    var _cfg_enabledPlatformIds = ['mercari'];
    var _cfg_platformMaster = [];
    var _cfg_platformEdits = {};
    var _cfg_currentEditingPlatformId = null;
    var _cfg_pendingIconFile = null;

    // Config storage keys
    var _cfg_CONFIG_STORAGE_KEYS = {
      CONDITION: 'config_conditionButtons',
      HASHTAG: 'config_hashtags',
      DISCOUNT: 'config_discount',
      SALESWORD: 'config_salesword',
      AI: 'config_ai',
      SHIPPING: 'config_shippingDefaults',
      MANAGEMENT: 'config_management',
      PLATFORM: 'config_platform',
      DESCRIPTION_ORDER: 'config_descriptionOrder'
    };

    // Salesword
    var _cfg_SALESWORD_LIST = [];

    // Description elements (for order)
    var _cfg_DESCRIPTION_ELEMENTS = [
      { id: 'brand', label: 'ãƒ–ãƒ©ãƒ³ãƒ‰æƒ…å ±', enabled: true },
      { id: 'color', label: 'ã‚«ãƒ©ãƒ¼(è©³ç´°)', enabled: true },
      { id: 'size', label: 'ã‚µã‚¤ã‚ºæƒ…å ±', enabled: true },
      { id: 'material', label: 'ç´ ææƒ…å ±', enabled: true },
      { id: 'accessories', label: 'ä»˜å±å“', enabled: true },
      { id: 'condition', label: 'å•†å“ã®çŠ¶æ…‹', enabled: true },
      { id: 'ai', label: 'AIç”Ÿæˆæ–‡', enabled: true },
      { id: 'management', label: 'ç®¡ç†ç•ªå·', enabled: true },
      { id: 'discount', label: 'å‰²å¼•æƒ…å ±', enabled: true },
      { id: 'hashtag', label: 'ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°', enabled: true }
    ];

    // Permission
    var _cfg_permissionSettingsLoaded = false;
    var _cfg_usersData = [];
    var _cfg_menuPermissions = {};
    var _cfg_allUsersData = [];

    var _cfg_PERMISSION_DEFINITIONS = {
      owner: { id: 'owner', label: 'ç®¡ç†è€…', order: 1 },
      employee: { id: 'employee', label: 'ç¤¾å“¡', order: 2 },
      staff: { id: 'staff', label: 'ã‚¹ã‚¿ãƒƒãƒ•', order: 3 },
      leader: { id: 'leader', label: 'ãƒªãƒ¼ãƒ€ãƒ¼', order: 4 },
      contractor: { id: 'contractor', label: 'å¤–æ³¨', order: 5 }
    };

    var _cfg_MENU_DEFINITIONS = [
      { id: 'product', label: 'å•†å“ç™»éŒ²', defaultOwnerOnly: false },
      { id: 'inventory', label: 'åœ¨åº«ç®¡ç†', defaultOwnerOnly: false },
      { id: 'inventory_history', label: 'å…¥å‡ºåº«å±¥æ­´', defaultOwnerOnly: false },
      { id: 'stocktaking', label: 'æ£šå¸', defaultOwnerOnly: false },
      { id: 'purchase', label: 'ä»•å…¥ç®¡ç†', defaultOwnerOnly: false },
      { id: 'sales', label: 'å£²ä¸Šç®¡ç†', defaultOwnerOnly: false },
      { id: 'accounting', label: 'ç¢ºå®šç”³å‘Š', defaultOwnerOnly: false },
      { id: 'compensation', label: 'å ±é…¬ç®¡ç†', defaultOwnerOnly: false },
      { id: 'pickup-management', label: 'å›åç®¡ç†', defaultOwnerOnly: true },
      {
        id: 'master', label: 'ãƒã‚¹ã‚¿ç®¡ç†', isTopGroup: true,
        children: [
          { id: 'master-product', label: 'å•†å“ãƒã‚¹ã‚¿ç®¡ç†', isGroup: true, children: [
            { id: 'master-brand', label: 'ãƒ–ãƒ©ãƒ³ãƒ‰', defaultOwnerOnly: false },
            { id: 'master-category', label: 'ã‚«ãƒ†ã‚´ãƒª', defaultOwnerOnly: false },
            { id: 'master-size', label: 'ã‚µã‚¤ã‚º', defaultOwnerOnly: false },
            { id: 'master-condition', label: 'å•†å“ã®çŠ¶æ…‹', defaultOwnerOnly: false },
            { id: 'master-material', label: 'ç´ æ', defaultOwnerOnly: false },
            { id: 'master-colorDetail', label: 'ã‚«ãƒ©ãƒ¼(è©³ç´°)', defaultOwnerOnly: false },
            { id: 'master-accessory', label: 'ä»˜å±å“', defaultOwnerOnly: false },
            { id: 'master-sizeLabel', label: 'ã‚µã‚¤ã‚º(è¡¨è¨˜)', defaultOwnerOnly: false },
            { id: 'master-salesword', label: 'ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰', defaultOwnerOnly: false },
            { id: 'master-attribute', label: 'å•†å“å±æ€§', defaultOwnerOnly: false },
            { id: 'master-conditionRank', label: 'ãƒ©ãƒ³ã‚¯', defaultOwnerOnly: false }
          ]},
          { id: 'master-business', label: 'æ¥­å‹™ãƒã‚¹ã‚¿ç®¡ç†', isGroup: true, children: [
            { id: 'master-shipping', label: 'ç™ºé€æ–¹æ³•', defaultOwnerOnly: false },
            { id: 'master-shippingBurden', label: 'é…é€æ–™ã®è² æ‹…', defaultOwnerOnly: false },
            { id: 'master-shippingRegion', label: 'ç™ºé€å…ƒã®åœ°åŸŸ', defaultOwnerOnly: false },
            { id: 'master-shippingDays', label: 'ç™ºé€ã¾ã§ã®æ—¥æ•°', defaultOwnerOnly: false },
            { id: 'master-packaging', label: 'æ¢±åŒ…è³‡æ', defaultOwnerOnly: false },
            { id: 'master-supplier', label: 'ä»•å…¥å…ˆ', defaultOwnerOnly: false },
            { id: 'master-marketplace', label: 'å‡ºå“å…ˆ', defaultOwnerOnly: false },
            { id: 'master-managementNumber', label: 'ç®¡ç†ç•ªå·', defaultOwnerOnly: false }
          ]}
        ]
      },
      {
        id: 'config', label: 'è¨­å®šç®¡ç†', isTopGroup: true,
        children: [
          { id: 'config-product', label: 'å•†å“ç™»éŒ²è¨­å®š', isGroup: true, children: [
            { id: 'product-salesword', label: 'ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š', defaultOwnerOnly: true },
            { id: 'product-condition', label: 'å•†å“çŠ¶æ…‹è¨­å®š', defaultOwnerOnly: true },
            { id: 'product-hashtag', label: 'ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°è¨­å®š', defaultOwnerOnly: true },
            { id: 'product-discount', label: 'å‰²å¼•è¨­å®š', defaultOwnerOnly: true },
            { id: 'product-ai', label: 'AIç”Ÿæˆè¨­å®š', defaultOwnerOnly: true },
            { id: 'product-order', label: 'é…ç½®é †åº', defaultOwnerOnly: true }
          ]},
          { id: 'config-system', label: 'ã‚·ã‚¹ãƒ†ãƒ è¨­å®š', isGroup: true, children: [
            { id: 'system-management', label: 'ç®¡ç†ç•ªå·è¨­å®š', defaultOwnerOnly: true },
            { id: 'system-shipping', label: 'é…é€è¨­å®š', defaultOwnerOnly: true },
            { id: 'system-procure', label: 'ä»•å…¥ãƒ»å‡ºå“è¨­å®š', defaultOwnerOnly: true },
            { id: 'system-platform', label: 'ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ', defaultOwnerOnly: true },
            { id: 'system-users', label: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†', defaultOwnerOnly: true, alwaysOwnerOnly: true },
            { id: 'system-compensation', label: 'å ±é…¬è¨­å®š', defaultOwnerOnly: true, alwaysOwnerOnly: true },
            { id: 'system-permission', label: 'æ¨©é™è¨­å®š', defaultOwnerOnly: true, alwaysOwnerOnly: true }
          ]}
        ]
      }
    ];

    // ManagementNumberBuilder state
    var _cfg_mnbSettings = {
      parts: { category: true, serial: true, date: false, initial: false },
      separator: '-',
      serialDigits: 3,
      dateFormat: 'YYMMDD',
      categorySource: 'master',
      initialSource: 'auto',
      partOrder: ['category', 'serial', 'date', 'initial'],
      categoryCodes: {}
    };

    // User task assignment
    var _cfg_userTaskAssignmentRetryCount = 0;
    var _cfg_USER_TASK_ASSIGNMENT_MAX_RETRIES = 5;
    window.cfgUserTaskAssignments = {};

    // ============================================
    // Lifecycle: initConfigPage / destroyConfigPage
    // ============================================

    function initConfigPage() {
      if (_cfg_initialized) {
        console.log('[config-fragment] Already initialized, skipping');
        return;
      }
      _cfg_initialized = true;
      _cfg_destroyed = false;
      console.log('[config-fragment] initConfigPage()');

      // Detect which tab to show based on SPA page key
      var currentPage = (typeof getCurrentSpaPage === 'function') ? getCurrentSpaPage() : 'config';
      var headerTitle = document.getElementById('cfg-page-header-title');

      if (currentPage === 'config-product') {
        cfgShowMainTab('product');
        if (headerTitle) headerTitle.textContent = 'å•†å“ç™»éŒ²è¨­å®š';
      } else if (currentPage === 'config-permission-users') {
        cfgShowMainTab('system');
        if (headerTitle) headerTitle.textContent = 'ã‚·ã‚¹ãƒ†ãƒ è¨­å®š';
        // Activate users subtab after a tick
        setTimeout(function() { cfgActivateSubtab('cfg-system-users'); }, 50);
      } else {
        // config-system or config (default to system)
        cfgShowMainTab('system');
        if (headerTitle) headerTitle.textContent = 'ã‚·ã‚¹ãƒ†ãƒ è¨­å®š';
      }

      // Setup subtab click handlers
      cfgSetupSubtabs();

      // Load all config
      cfgLoadAllConfig();

      // Initialize platform master
      _cfg_platformMaster = _cfg_defaultPlatformDefs.slice();

      // Load data from Firestore
      cfgInitFirestoreData();

      // Start online status updates
      cfgStartOnlineStatusUpdates();

      console.log('[config-fragment] initConfigPage() complete');
    }
    window.initConfigPage = initConfigPage;

    function destroyConfigPage() {
      console.log('[config-fragment] destroyConfigPage()');
      _cfg_initialized = false;
      _cfg_destroyed = true;

      // Clear online interval
      if (_cfg_onlineInterval) {
        clearInterval(_cfg_onlineInterval);
        _cfg_onlineInterval = null;
      }

      // Reset state
      _cfg_permissionSettingsLoaded = false;
      _cfg_usersData = [];
      _cfg_allUsersData = [];
      _cfg_SALESWORD_LIST = [];
      _cfg_customTaskCounter = 0;
      _cfg_userTaskAssignmentRetryCount = 0;
    }
    window.destroyConfigPage = destroyConfigPage;

    // ============================================
    // Tab Switching (custom, no Bootstrap)
    // ============================================

    function cfgShowMainTab(tabName) {
      var productPane = document.getElementById('cfg-product');
      var systemPane = document.getElementById('cfg-system');
      if (!productPane || !systemPane) return;

      if (tabName === 'product') {
        productPane.classList.add('active');
        systemPane.classList.remove('active');
      } else {
        systemPane.classList.add('active');
        productPane.classList.remove('active');
      }
    }

    function cfgSetupSubtabs() {
      // Product subtabs
      var productTabs = document.querySelectorAll('#cfg-productConfigTabs .cfg-subtab');
      productTabs.forEach(function(tab) {
        tab.addEventListener('click', function() {
          cfgActivateSubtab(this.getAttribute('data-target'));
        });
      });

      // System subtabs
      var systemTabs = document.querySelectorAll('#cfg-systemConfigTabs .cfg-subtab');
      systemTabs.forEach(function(tab) {
        tab.addEventListener('click', function() {
          var target = this.getAttribute('data-target');
          cfgActivateSubtab(target);
          // Lazy load certain tabs
          if (target === 'cfg-system-permission') cfgLoadPermissionSettings();
          if (target === 'cfg-system-users') cfgLoadUserManagement();
          if (target === 'cfg-system-compensation') {
            cfgLoadCompensationSettingsFromFirestore();
            cfgLoadUserTaskAssignmentList();
          }
        });
      });
    }

    function cfgActivateSubtab(targetId) {
      if (!targetId) return;
      // Find parent tabs container
      var targetPane = document.getElementById(targetId);
      if (!targetPane) return;

      var parentContent = targetPane.parentElement;
      if (!parentContent) return;

      // Determine which tabs container
      var tabsContainerId = parentContent.id === 'cfg-productConfigTabContent' ? 'cfg-productConfigTabs' : 'cfg-systemConfigTabs';
      var tabsContainer = document.getElementById(tabsContainerId);
      if (!tabsContainer) return;

      // Deactivate all subtabs and panes in this group
      tabsContainer.querySelectorAll('.cfg-subtab').forEach(function(t) { t.classList.remove('active'); });
      parentContent.querySelectorAll('.cfg-subtab-pane').forEach(function(p) { p.classList.remove('active'); });

      // Activate target
      targetPane.classList.add('active');
      var targetTab = tabsContainer.querySelector('[data-target="' + targetId + '"]');
      if (targetTab) {
        targetTab.classList.add('active');
        targetTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      }
    }

    // ============================================
    // Firestore Data Loading
    // ============================================

    var _cfg_firestoreRetryCount = 0;
    async function cfgInitFirestoreData() {
      var db = (typeof getCompatDb === 'function') ? getCompatDb() : window.db;
      if (!db || typeof db.collection !== 'function') {
        _cfg_firestoreRetryCount++;
        if (_cfg_firestoreRetryCount < 10) {
          console.log('[config-fragment] Waiting for Firestore compat... (' + _cfg_firestoreRetryCount + ')');
          setTimeout(cfgInitFirestoreData, 500);
        }
        return;
      }

      try {
        // Load shipping dropdowns
        await Promise.all([
          cfgLoadShippingBurden(),
          cfgLoadShippingMethodCategories(),
          cfgLoadShippingRegions(),
          cfgLoadShippingDays()
        ]);

        // Load procure/listing dropdowns
        cfgInitProcureListingDropdowns();

        // Load platforms from Firestore
        await cfgLoadPlatformsFromFirestore();

        // Load MNB category codes and settings
        await cfgMnbLoadCategoryCodes();
        cfgMnbLoadSettings();

        // Load platform settings
        var config = JSON.parse(localStorage.getItem('config') || '{}');
        cfgLoadPlatformSettings(config);

        // Load compensation
        await cfgLoadCompensationSettingsFromFirestore();

        // Check user permissions
        await cfgCheckUserPermissionAndUpdateUI();

        // Load salesword master
        cfgLoadSaleswordMasterData();

        console.log('[config-fragment] Firestore data loaded');
      } catch (error) {
        console.error('[config-fragment] Firestore init error:', error);
      }
    }

    // ============================================
    // Config Load / Save (hybrid localStorage + Firestore)
    // ============================================

    async function cfgLoadAllConfig() {
      console.log('[config-fragment] Loading all config...');
      try {
        // 1. Try localStorage first (fast)
        var config = JSON.parse(localStorage.getItem('config') || '{}');

        // 2. Try Firestore (authoritative)
        if (window.db) {
          var userId = localStorage.getItem('reborn_user_id') || localStorage.getItem('userId');
          if (userId) {
            try {
              var doc = await window.db.collection('configs').doc(userId).get();
              if (doc.exists) {
                var fsConfig = doc.data();
                config = Object.assign(config, fsConfig);
                localStorage.setItem('config', JSON.stringify(config));
                console.log('[config-fragment] Loaded config from Firestore');
              }
            } catch (e) {
              console.warn('[config-fragment] Firestore config load failed, using localStorage:', e);
            }
          }
        }

        cfgRenderAllConfig(config);
      } catch (error) {
        console.error('[config-fragment] Config load error:', error);
      }
    }

    function cfgRenderAllConfig(config) {
      if (!config) config = {};

      // Condition buttons
      if (config.conditionButtons) cfgRenderConditionButtons(config.conditionButtons);
      else cfgRenderConditionButtons(null);

      // Hashtags
      if (config.hashtags) cfgRenderHashtagConfig(config.hashtags);

      // Discounts
      if (config.discounts) cfgRenderDiscountConfig(config.discounts);

      // AI settings
      if (config.ai) cfgRenderAiSettings(config.ai);
      else cfgApplyAiPreset('casual');

      // Shipping defaults
      if (config.shippingDefaults) cfgRenderShippingDefaults(config.shippingDefaults);

      // Salesword
      if (config.salesword) cfgRenderSaleswordConfig(config.salesword);

      // Description order
      if (config.descriptionOrder) cfgRenderDescriptionOrder(config.descriptionOrder);
      else cfgRenderDescriptionOrder(null);

      // Platform
      if (config['ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š']) cfgLoadPlatformSettings(config);

      console.log('[config-fragment] All config rendered');
    }

    async function cfgSaveConfig() {
      console.log('[config-fragment] Saving config...');

      try {
        var config = {};

        // Collect all settings
        config.conditionButtons = cfgCollectConditionButtons();
        config.hashtags = cfgCollectHashtagConfig();
        config.discounts = cfgCollectDiscountConfig();
        config.ai = cfgCollectAiSettings();
        config.shippingDefaults = cfgCollectShippingDefaults();
        config.salesword = cfgCollectSaleswordConfig();
        config.managementConfig = cfgCollectManagementConfig();
        config.descriptionOrder = cfgCollectDescriptionOrder();
        config['ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š'] = cfgCollectPlatformSettings();

        // Save to localStorage
        var existing = JSON.parse(localStorage.getItem('config') || '{}');
        Object.assign(existing, config);
        localStorage.setItem('config', JSON.stringify(existing));
        console.log('[config-fragment] Saved to localStorage');

        // Save to Firestore
        if (window.db) {
          var userId = localStorage.getItem('reborn_user_id') || localStorage.getItem('userId');
          if (userId) {
            await window.db.collection('configs').doc(userId).set(config, { merge: true });
            console.log('[config-fragment] Saved to Firestore');
          }
        }

        // Save compensation (separate collection)
        await cfgSaveCompensationSettings();

        // Save user task assignments
        await cfgSaveUserTaskAssignments();

        // Save permission settings
        await cfgSavePermissionSettings(false);

        // Upload user icon if pending
        if (_cfg_pendingUserIconData) {
          await cfgUploadUserIcon();
        }

        // Notify config change
        cfgNotifyConfigChange();

        alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      } catch (error) {
        console.error('[config-fragment] Save error:', error);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }
    window.cfgSaveConfig = cfgSaveConfig;

    function cfgNotifyConfigChange() {
      // Notify parent SPA that config changed
      try {
        window.postMessage({ type: 'configChanged' }, '*');
      } catch (e) { /* ignore */ }
    }

    // ============================================
    // Condition Buttons
    // ============================================

    function cfgRenderConditionButtons(buttons) {
      var container = document.getElementById('cfg-conditionButtonsContainer');
      if (!container) return;
      container.innerHTML = '';

      if (!buttons || buttons.length === 0) {
        // Default buttons
        buttons = [
          { label: 'S', value: 'æ–°å“ã€æœªä½¿ç”¨' },
          { label: 'A', value: 'æœªä½¿ç”¨ã«è¿‘ã„' },
          { label: 'B', value: 'ç›®ç«‹ã£ãŸå‚·ã‚„æ±šã‚Œãªã—' },
          { label: 'C', value: 'ã‚„ã‚„å‚·ã‚„æ±šã‚Œã‚ã‚Š' }
        ];
      }

      buttons.forEach(function(btn, index) {
        container.appendChild(cfgCreateButtonConfigItem(btn, index));
      });
    }

    function cfgCreateButtonConfigItem(btn, index) {
      var item = document.createElement('div');
      item.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 10px; background: #f9fafb; border-radius: 8px; margin-bottom: 6px;';
      item.dataset.index = index;

      var presetOptions = Object.keys(_cfg_CONDITION_BUTTON_PRESETS).map(function(key) {
        return '<option value="' + key + '"' + (btn.label === key.split('ï¼ˆ')[0] ? ' selected' : '') + '>' + key + '</option>';
      }).join('');

      item.innerHTML =
        '<div style="flex: 1;">' +
          '<input type="text" class="cfg-btn-label-input form-control" value="' + (btn.label || '') + '" placeholder="ãƒœã‚¿ãƒ³ãƒ©ãƒ™ãƒ«" style="margin-bottom: 4px; font-size: 13px;">' +
          '<select class="cfg-btn-value-select form-control" style="font-size: 12px;" onchange="cfgHandleLabelPresetChange(this)">' +
            '<option value="">-- ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰é¸æŠ --</option>' +
            presetOptions +
            '<option value="custom">ã‚«ã‚¹ã‚¿ãƒ ...</option>' +
          '</select>' +
          '<input type="text" class="cfg-btn-value-input form-control" value="' + (btn.value || '') + '" placeholder="ãƒ¡ãƒ«ã‚«ãƒªä¸Šã®çŠ¶æ…‹å€¤" style="margin-top: 4px; font-size: 12px; display: ' + (btn.value && !Object.values(_cfg_CONDITION_BUTTON_PRESETS).includes(btn.value) ? 'block' : 'none') + ';">' +
        '</div>' +
        '<button type="button" onclick="cfgRemoveConditionButton(this)" style="background: none; border: none; color: #ef4444; font-size: 18px; cursor: pointer; padding: 4px;"><i class="bi bi-trash"></i></button>';

      return item;
    }

    function cfgHandleLabelPresetChange(select) {
      var item = select.closest('[data-index]');
      if (!item) return;
      var customInput = item.querySelector('.cfg-btn-value-input');
      if (select.value === 'custom') {
        customInput.style.display = 'block';
      } else if (select.value) {
        customInput.style.display = 'none';
        customInput.value = _cfg_CONDITION_BUTTON_PRESETS[select.value] || '';
        // Auto-fill label
        var labelInput = item.querySelector('.cfg-btn-label-input');
        if (labelInput && !labelInput.value) {
          labelInput.value = select.value.split('ï¼ˆ')[0];
        }
      }
    }
    window.cfgHandleLabelPresetChange = cfgHandleLabelPresetChange;

    function cfgAddConditionButton() {
      var container = document.getElementById('cfg-conditionButtonsContainer');
      if (!container) return;
      var index = container.children.length;
      container.appendChild(cfgCreateButtonConfigItem({ label: '', value: '' }, index));
    }
    window.cfgAddConditionButton = cfgAddConditionButton;

    function cfgRemoveConditionButton(btn) {
      var item = btn.closest('[data-index]');
      if (item) item.remove();
    }
    window.cfgRemoveConditionButton = cfgRemoveConditionButton;

    function cfgCollectConditionButtons() {
      var container = document.getElementById('cfg-conditionButtonsContainer');
      if (!container) return [];
      var buttons = [];
      container.querySelectorAll('[data-index]').forEach(function(item) {
        var label = item.querySelector('.cfg-btn-label-input').value.trim();
        var select = item.querySelector('.cfg-btn-value-select');
        var customInput = item.querySelector('.cfg-btn-value-input');
        var value = '';
        if (select.value === 'custom' || customInput.style.display !== 'none') {
          value = customInput.value.trim();
        } else if (select.value) {
          value = _cfg_CONDITION_BUTTON_PRESETS[select.value] || customInput.value.trim();
        } else {
          value = customInput.value.trim();
        }
        if (label || value) {
          buttons.push({ label: label, value: value });
        }
      });
      return buttons;
    }

    // ============================================
    // Hashtag Config
    // ============================================

    function cfgRenderHashtagConfig(hashtags) {
      var container = document.getElementById('cfg-hashtagConfigContainer');
      if (!container) return;
      container.innerHTML = '';

      if (!hashtags || !hashtags.groups) return;

      hashtags.groups.forEach(function(group, gIdx) {
        var groupDiv = document.createElement('div');
        groupDiv.className = 'cfg-card';
        groupDiv.style.cssText = 'padding: 12px; margin-bottom: 8px; border: 1px solid #e5e7eb;';
        groupDiv.dataset.groupIndex = gIdx;

        var tagsHtml = '';
        if (group.tags) {
          group.tags.forEach(function(tag, tIdx) {
            tagsHtml += '<div style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px;">' +
              '<span style="color: #6b7280; font-size: 13px;">#</span>' +
              '<input type="text" class="cfg-hashtag-input form-control" value="' + (tag || '') + '" placeholder="ã‚¿ã‚°å" style="font-size: 13px;" oninput="cfgUpdateHashtagPreview()">' +
              '<button type="button" onclick="cfgRemoveHashtag(this)" style="background: none; border: none; color: #ef4444; font-size: 14px; cursor: pointer;"><i class="bi bi-x-lg"></i></button>' +
            '</div>';
          });
        }

        groupDiv.innerHTML =
          '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">' +
            '<input type="text" class="cfg-hashtag-group-name form-control" value="' + (group.name || 'ã‚°ãƒ«ãƒ¼ãƒ— ' + (gIdx + 1)) + '" placeholder="ã‚°ãƒ«ãƒ¼ãƒ—å" style="font-size: 13px; font-weight: 600; max-width: 200px;">' +
            '<button type="button" onclick="cfgRemoveHashtagGroup(this)" style="background: none; border: none; color: #ef4444; font-size: 14px; cursor: pointer;"><i class="bi bi-trash"></i></button>' +
          '</div>' +
          '<div class="cfg-hashtag-tags">' + tagsHtml + '</div>' +
          '<button type="button" onclick="cfgAddHashtag(this)" style="margin-top: 6px; padding: 6px; width: 100%; background: #f9fafb; color: #6b7280; border: 1px dashed #d1d5db; border-radius: 6px; font-size: 12px; cursor: pointer;"><i class="bi bi-plus"></i> ã‚¿ã‚°è¿½åŠ </button>';

        container.appendChild(groupDiv);
      });

      cfgUpdateHashtagPreview();
    }

    function cfgAddHashtagGroup() {
      var container = document.getElementById('cfg-hashtagConfigContainer');
      if (!container) return;
      var gIdx = container.children.length;
      var group = { name: 'ã‚°ãƒ«ãƒ¼ãƒ— ' + (gIdx + 1), tags: [''] };
      cfgRenderHashtagConfig({ groups: cfgCollectHashtagConfigGroups().concat([group]) });
    }
    window.cfgAddHashtagGroup = cfgAddHashtagGroup;

    function cfgCollectHashtagConfigGroups() {
      var container = document.getElementById('cfg-hashtagConfigContainer');
      if (!container) return [];
      var groups = [];
      container.querySelectorAll('[data-group-index]').forEach(function(groupDiv) {
        var name = groupDiv.querySelector('.cfg-hashtag-group-name').value.trim();
        var tags = [];
        groupDiv.querySelectorAll('.cfg-hashtag-input').forEach(function(input) {
          if (input.value.trim()) tags.push(input.value.trim());
        });
        groups.push({ name: name, tags: tags });
      });
      return groups;
    }

    function cfgRemoveHashtagGroup(btn) {
      var groupDiv = btn.closest('[data-group-index]');
      if (groupDiv) {
        groupDiv.remove();
        cfgUpdateHashtagPreview();
      }
    }
    window.cfgRemoveHashtagGroup = cfgRemoveHashtagGroup;

    function cfgAddHashtag(btn) {
      var tagsDiv = btn.parentElement.querySelector('.cfg-hashtag-tags');
      if (!tagsDiv) return;
      var tagHtml = '<div style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px;">' +
        '<span style="color: #6b7280; font-size: 13px;">#</span>' +
        '<input type="text" class="cfg-hashtag-input form-control" value="" placeholder="ã‚¿ã‚°å" style="font-size: 13px;" oninput="cfgUpdateHashtagPreview()">' +
        '<button type="button" onclick="cfgRemoveHashtag(this)" style="background: none; border: none; color: #ef4444; font-size: 14px; cursor: pointer;"><i class="bi bi-x-lg"></i></button>' +
      '</div>';
      tagsDiv.insertAdjacentHTML('beforeend', tagHtml);
    }
    window.cfgAddHashtag = cfgAddHashtag;

    function cfgRemoveHashtag(btn) {
      var tagDiv = btn.parentElement;
      if (tagDiv) {
        tagDiv.remove();
        cfgUpdateHashtagPreview();
      }
    }
    window.cfgRemoveHashtag = cfgRemoveHashtag;

    function cfgUpdateHashtagPreview() {
      var preview = document.getElementById('cfg-hashtagPreview');
      if (!preview) return;
      var groups = cfgCollectHashtagConfigGroups();
      var lines = [];
      groups.forEach(function(g) {
        g.tags.forEach(function(t) {
          if (t) lines.push('#' + t);
        });
      });
      preview.textContent = lines.join('\n') || 'ï¼ˆãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°æœªè¨­å®šï¼‰';
    }
    window.cfgUpdateHashtagPreview = cfgUpdateHashtagPreview;

    function cfgCollectHashtagConfig() {
      return { groups: cfgCollectHashtagConfigGroups() };
    }

    // ============================================
    // Discount Config
    // ============================================

    function cfgRenderDiscountConfig(discounts) {
      var container = document.getElementById('cfg-discountConfigContainer');
      if (!container) return;
      container.innerHTML = '';

      if (!discounts || !discounts.blocks) return;

      discounts.blocks.forEach(function(block, idx) {
        var blockDiv = document.createElement('div');
        blockDiv.className = 'cfg-card';
        blockDiv.style.cssText = 'padding: 12px; margin-bottom: 8px; border: 1px solid #e5e7eb;';
        blockDiv.dataset.blockIndex = idx;
        blockDiv.innerHTML =
          '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">' +
            '<span style="font-size: 13px; font-weight: 600; color: #374151;">å‰²å¼•ãƒ–ãƒ­ãƒƒã‚¯ ' + (idx + 1) + '</span>' +
            '<button type="button" onclick="cfgRemoveDiscountBlock(this)" style="background: none; border: none; color: #ef4444; cursor: pointer;"><i class="bi bi-trash"></i></button>' +
          '</div>' +
          '<textarea class="cfg-discount-text form-control" rows="3" placeholder="å‰²å¼•æƒ…å ±ã‚’å…¥åŠ›..." style="font-size: 13px;" oninput="cfgUpdateDiscountPreview()">' + (block.text || '') + '</textarea>';
        container.appendChild(blockDiv);
      });
      cfgUpdateDiscountPreview();
    }

    function cfgAddDiscountBlock() {
      var container = document.getElementById('cfg-discountConfigContainer');
      if (!container) return;
      var blocks = cfgCollectDiscountBlocks();
      blocks.push({ text: '' });
      cfgRenderDiscountConfig({ blocks: blocks });
    }
    window.cfgAddDiscountBlock = cfgAddDiscountBlock;

    function cfgRemoveDiscountBlock(btn) {
      var blockDiv = btn.closest('[data-block-index]');
      if (blockDiv) { blockDiv.remove(); cfgUpdateDiscountPreview(); }
    }
    window.cfgRemoveDiscountBlock = cfgRemoveDiscountBlock;

    function cfgCollectDiscountBlocks() {
      var container = document.getElementById('cfg-discountConfigContainer');
      if (!container) return [];
      var blocks = [];
      container.querySelectorAll('[data-block-index]').forEach(function(blockDiv) {
        var text = blockDiv.querySelector('.cfg-discount-text').value.trim();
        blocks.push({ text: text });
      });
      return blocks;
    }

    function cfgUpdateDiscountPreview() {
      var preview = document.getElementById('cfg-discountPreview');
      if (!preview) return;
      var blocks = cfgCollectDiscountBlocks();
      var texts = blocks.map(function(b) { return b.text; }).filter(function(t) { return t; });
      preview.textContent = texts.join('\n\n') || 'ï¼ˆå‰²å¼•æœªè¨­å®šï¼‰';
    }
    window.cfgUpdateDiscountPreview = cfgUpdateDiscountPreview;

    function cfgCollectDiscountConfig() {
      return { blocks: cfgCollectDiscountBlocks() };
    }

    // ============================================
    // Salesword Config
    // ============================================

    function cfgRenderSaleswordConfig(saleswordConfig) {
      var container = document.getElementById('cfg-saleswordList');
      if (!container) return;
      container.innerHTML = '';

      if (!saleswordConfig || !saleswordConfig.items) return;

      saleswordConfig.items.forEach(function(item, idx) {
        cfgAddSaleswordItemToDOM(item, idx);
      });

      // Format settings
      if (saleswordConfig.separator) {
        var sep = document.getElementById('cfg-saleswordSeparator');
        if (sep) sep.value = saleswordConfig.separator;
      }
      if (saleswordConfig.bracket) {
        var bracket = document.getElementById('cfg-saleswordBracket');
        if (bracket) bracket.value = saleswordConfig.bracket;
      }
    }

    function cfgAddSaleswordItemToDOM(item, idx) {
      var container = document.getElementById('cfg-saleswordList');
      if (!container) return;

      var div = document.createElement('div');
      div.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px; background: #f9fafb; border-radius: 8px;';
      div.dataset.saleswordIndex = idx !== undefined ? idx : container.children.length;

      var masterOptions = _cfg_SALESWORD_LIST.map(function(sw) {
        var selected = (item && item.masterId === sw.id) ? ' selected' : '';
        return '<option value="' + sw.id + '"' + selected + '>' + sw.name + '</option>';
      }).join('');

      div.innerHTML =
        '<select class="cfg-salesword-select form-control" style="flex: 1; font-size: 13px;">' +
          '<option value="">-- é¸æŠ --</option>' +
          masterOptions +
          '<option value="custom">ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›</option>' +
        '</select>' +
        '<input type="text" class="cfg-salesword-custom form-control" value="' + ((item && item.custom) || '') + '" placeholder="ã‚«ã‚¹ã‚¿ãƒ ãƒ¯ãƒ¼ãƒ‰" style="flex: 1; font-size: 13px; display: ' + ((item && item.custom) ? 'block' : 'none') + ';">' +
        '<button type="button" onclick="cfgRemoveSaleswordItem(this)" style="background: none; border: none; color: #ef4444; font-size: 16px; cursor: pointer;"><i class="bi bi-x-lg"></i></button>';

      // Handle select change to show/hide custom input
      var select = div.querySelector('.cfg-salesword-select');
      var customInput = div.querySelector('.cfg-salesword-custom');
      select.addEventListener('change', function() {
        customInput.style.display = this.value === 'custom' ? 'block' : 'none';
      });

      container.appendChild(div);
    }

    function cfgAddSaleswordItem() {
      cfgAddSaleswordItemToDOM(null);
    }
    window.cfgAddSaleswordItem = cfgAddSaleswordItem;

    function cfgRemoveSaleswordItem(btn) {
      var div = btn.closest('[data-salesword-index]');
      if (div) div.remove();
    }
    window.cfgRemoveSaleswordItem = cfgRemoveSaleswordItem;

    function cfgCollectSaleswordConfig() {
      var container = document.getElementById('cfg-saleswordList');
      if (!container) return { items: [], separator: ' / ', bracket: 'none' };
      var items = [];
      container.querySelectorAll('[data-salesword-index]').forEach(function(div) {
        var select = div.querySelector('.cfg-salesword-select');
        var customInput = div.querySelector('.cfg-salesword-custom');
        if (select.value === 'custom') {
          items.push({ masterId: null, custom: customInput.value.trim() });
        } else if (select.value) {
          items.push({ masterId: select.value, custom: null });
        }
      });
      var sep = document.getElementById('cfg-saleswordSeparator');
      var bracket = document.getElementById('cfg-saleswordBracket');
      return {
        items: items,
        separator: sep ? sep.value : ' / ',
        bracket: bracket ? bracket.value : 'none'
      };
    }

    async function cfgLoadSaleswordMasterData() {
      if (!window.db) return;
      try {
        var snapshot = await window.db.collection('saleswords').orderBy('order', 'asc').get();
        _cfg_SALESWORD_LIST = [];
        snapshot.forEach(function(doc) {
          _cfg_SALESWORD_LIST.push({ id: doc.id, ...doc.data() });
        });
        console.log('[config-fragment] Salesword master loaded:', _cfg_SALESWORD_LIST.length);
      } catch (e) {
        console.error('[config-fragment] Salesword master error:', e);
      }
    }

    // ============================================
    // AI Settings
    // ============================================

    function cfgRenderAiSettings(ai) {
      if (!ai) return;
      var tone = document.getElementById('cfg-aiTone');
      var length = document.getElementById('cfg-aiLength');
      var temp = document.getElementById('cfg-aiTemperature');
      var prompt = document.getElementById('cfg-aiCustomPrompt');

      if (tone && ai.tone) tone.value = ai.tone;
      if (length && ai.length) length.value = ai.length;
      if (temp && ai.temperature !== undefined) {
        temp.value = ai.temperature;
        cfgUpdateTempDisplay(ai.temperature);
      }
      if (prompt && ai.customPrompt) prompt.value = ai.customPrompt;

      cfgRenderAiPresetButtons(ai.preset || null);
      cfgUpdateAiConfigPreview();
    }

    function cfgRenderAiPresetButtons(activePreset) {
      var container = document.getElementById('cfg-aiPresetButtons');
      if (!container) return;
      var presets = [
        { id: 'casual', label: 'ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«' },
        { id: 'formal', label: 'ãƒ•ã‚©ãƒ¼ãƒãƒ«' },
        { id: 'friendly', label: 'ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼' },
        { id: 'professional', label: 'ãƒ—ãƒ­' },
        { id: 'detailed', label: 'è©³ç´°' },
        { id: 'minimal', label: 'ã‚·ãƒ³ãƒ—ãƒ«' }
      ];
      container.innerHTML = presets.map(function(p) {
        var isActive = activePreset === p.id;
        return '<button type="button" onclick="cfgApplyAiPreset(\'' + p.id + '\')" style="padding: 6px 12px; border: 1.5px solid ' + (isActive ? '#40B4E5' : '#e5e7eb') + '; border-radius: 6px; background: ' + (isActive ? '#f0f9ff' : 'white') + '; color: ' + (isActive ? '#0369a1' : '#374151') + '; font-size: 12px; font-weight: 500; cursor: pointer;">' + p.label + '</button>';
      }).join('');
    }

    function cfgApplyAiPreset(presetId) {
      var presets = {
        casual: { tone: 'casual', length: 'medium', temperature: 0.7, customPrompt: '' },
        formal: { tone: 'formal', length: 'medium', temperature: 0.3, customPrompt: '' },
        friendly: { tone: 'friendly', length: 'medium', temperature: 0.8, customPrompt: '' },
        professional: { tone: 'professional', length: 'long', temperature: 0.5, customPrompt: '' },
        detailed: { tone: 'formal', length: 'long', temperature: 0.4, customPrompt: 'å•†å“ã®ç‰¹å¾´ã‚’è©³ã—ãèª¬æ˜ã—ã¦ãã ã•ã„' },
        minimal: { tone: 'casual', length: 'short', temperature: 0.6, customPrompt: '' }
      };

      var preset = presets[presetId] || presets.casual;
      var tone = document.getElementById('cfg-aiTone');
      var length = document.getElementById('cfg-aiLength');
      var temp = document.getElementById('cfg-aiTemperature');
      var prompt = document.getElementById('cfg-aiCustomPrompt');

      if (tone) tone.value = preset.tone;
      if (length) length.value = preset.length;
      if (temp) { temp.value = preset.temperature; cfgUpdateTempDisplay(preset.temperature); }
      if (prompt) prompt.value = preset.customPrompt;

      cfgRenderAiPresetButtons(presetId);
      cfgUpdateAiConfigPreview();
    }
    window.cfgApplyAiPreset = cfgApplyAiPreset;

    function cfgUpdateTempDisplay(val) {
      var el = document.getElementById('cfg-aiTempDisplay');
      if (el) el.textContent = parseFloat(val).toFixed(1);
    }
    window.cfgUpdateTempDisplay = cfgUpdateTempDisplay;

    function cfgUpdateAiConfigPreview() {
      var preview = document.getElementById('cfg-aiConfigPreview');
      if (!preview) return;
      var tone = document.getElementById('cfg-aiTone');
      var length = document.getElementById('cfg-aiLength');
      var temp = document.getElementById('cfg-aiTemperature');
      var prompt = document.getElementById('cfg-aiCustomPrompt');

      var lines = [];
      if (tone) lines.push('ãƒˆãƒ¼ãƒ³: ' + tone.options[tone.selectedIndex].text);
      if (length) lines.push('é•·ã•: ' + length.options[length.selectedIndex].text);
      if (temp) lines.push('æ¸©åº¦: ' + parseFloat(temp.value).toFixed(1));
      if (prompt && prompt.value.trim()) lines.push('è¿½åŠ æŒ‡ç¤º: ' + prompt.value.trim());
      preview.textContent = lines.join(' | ');
    }
    window.cfgUpdateAiConfigPreview = cfgUpdateAiConfigPreview;

    function cfgClearAiSettings() {
      if (!confirm('AIç”Ÿæˆè¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) return;
      cfgApplyAiPreset('casual');
      alert('AIç”Ÿæˆè¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ï¼‰ã«æˆ»ã—ã¾ã—ãŸã€‚');
    }
    window.cfgClearAiSettings = cfgClearAiSettings;

    function cfgCollectAiSettings() {
      var tone = document.getElementById('cfg-aiTone');
      var length = document.getElementById('cfg-aiLength');
      var temp = document.getElementById('cfg-aiTemperature');
      var prompt = document.getElementById('cfg-aiCustomPrompt');
      return {
        tone: tone ? tone.value : 'casual',
        length: length ? length.value : 'medium',
        temperature: temp ? parseFloat(temp.value) : 0.7,
        customPrompt: prompt ? prompt.value.trim() : ''
      };
    }

    // ============================================
    // Shipping Defaults
    // ============================================

    function cfgRenderShippingDefaults(defaults) {
      if (!defaults) return;
      var fields = ['é…é€æ–™ã®è² æ‹…', 'é…é€ã®æ–¹æ³•', 'ç™ºé€å…ƒã®åœ°åŸŸ', 'ç™ºé€ã¾ã§ã®æ—¥æ•°'];
      fields.forEach(function(field) {
        var el = document.getElementById('cfg-' + field);
        if (el && defaults[field]) el.value = defaults[field];
      });
    }

    function cfgCollectShippingDefaults() {
      var result = {};
      var fields = ['é…é€æ–™ã®è² æ‹…', 'é…é€ã®æ–¹æ³•', 'ç™ºé€å…ƒã®åœ°åŸŸ', 'ç™ºé€ã¾ã§ã®æ—¥æ•°'];
      fields.forEach(function(field) {
        var el = document.getElementById('cfg-' + field);
        if (el) result[field] = el.value;
      });
      return result;
    }

    function cfgCollectManagementConfig() {
      return _cfg_mnbSettings;
    }

    // ============================================
    // Shipping Dropdown Loading (Firestore)
    // ============================================

    async function cfgLoadShippingBurden() {
      if (!window.db) return;
      try {
        var snapshot = await window.db.collection('shippingBurden').orderBy('displayOrder', 'asc').get();
        var select = document.getElementById('cfg-é…é€æ–™ã®è² æ‹…');
        if (!select) return;
        while (select.options.length > 1) select.remove(1);
        snapshot.forEach(function(doc) {
          var data = doc.data();
          var opt = document.createElement('option');
          opt.value = data.name || data.value || doc.id;
          opt.textContent = opt.value;
          select.appendChild(opt);
        });
      } catch (e) { console.error('[config-fragment] shippingBurden error:', e); }
    }

    async function cfgLoadShippingMethodCategories() {
      if (!window.db) return;
      try {
        var snapshot = await window.db.collection('shippingMethods')
          .where('platform', 'in', ['mercari', 'mercari-shops'])
          .orderBy('order', 'asc').get();
        var select = document.getElementById('cfg-é…é€ã®æ–¹æ³•');
        if (!select) return;
        while (select.options.length > 1) select.remove(1);
        var added = new Set();
        snapshot.forEach(function(doc) {
          var name = doc.data().category || doc.id;
          if (!added.has(name)) {
            added.add(name);
            var opt = document.createElement('option');
            opt.value = name; opt.textContent = name;
            select.appendChild(opt);
          }
        });
      } catch (e) { console.error('[config-fragment] shippingMethods error:', e); }
    }

    async function cfgLoadShippingRegions() {
      if (!window.db) return;
      try {
        var snapshot = await window.db.collection('shippingRegion').orderBy('displayOrder', 'asc').get();
        var select = document.getElementById('cfg-ç™ºé€å…ƒã®åœ°åŸŸ');
        if (!select) return;
        while (select.options.length > 1) select.remove(1);
        snapshot.forEach(function(doc) {
          var data = doc.data();
          var opt = document.createElement('option');
          opt.value = data.name || data.value || doc.id;
          opt.textContent = opt.value;
          select.appendChild(opt);
        });
      } catch (e) { console.error('[config-fragment] shippingRegion error:', e); }
    }

    async function cfgLoadShippingDays() {
      if (!window.db) return;
      try {
        var snapshot = await window.db.collection('shippingDays').where('platform', '==', 'mercari').get();
        var select = document.getElementById('cfg-ç™ºé€ã¾ã§ã®æ—¥æ•°');
        if (!select) return;
        while (select.options.length > 1) select.remove(1);
        var items = [];
        snapshot.forEach(function(doc) {
          var data = doc.data();
          items.push({ name: data.name || data.value || doc.id, order: data.displayOrder || data.order || 999 });
        });
        items.sort(function(a, b) { return a.order - b.order; });
        var added = new Set();
        items.forEach(function(item) {
          if (!added.has(item.name)) {
            added.add(item.name);
            var opt = document.createElement('option');
            opt.value = item.name; opt.textContent = item.name;
            select.appendChild(opt);
          }
        });
      } catch (e) { console.error('[config-fragment] shippingDays error:', e); }
    }

    // ============================================
    // Procure/Listing Dropdowns
    // ============================================

    async function cfgInitProcureListingDropdowns() {
      if (!window.db) return;
      try {
        // ä»•å…¥å…ˆ
        var supplierSnap = await window.db.collection('suppliers').orderBy('displayOrder', 'asc').get();
        var supplierSelect = document.getElementById('cfg-ä»•å…¥å…ˆ');
        if (supplierSelect) {
          while (supplierSelect.options.length > 1) supplierSelect.remove(1);
          supplierSnap.forEach(function(doc) {
            var data = doc.data();
            var opt = document.createElement('option');
            opt.value = data.name || doc.id; opt.textContent = opt.value;
            supplierSelect.appendChild(opt);
          });
        }
        // å‡ºå“å…ˆ
        var marketplaceSnap = await window.db.collection('salesChannels').orderBy('name', 'asc').get();
        var marketplaceSelect = document.getElementById('cfg-å‡ºå“å…ˆ');
        if (marketplaceSelect) {
          while (marketplaceSelect.options.length > 1) marketplaceSelect.remove(1);
          marketplaceSnap.forEach(function(doc) {
            var data = doc.data();
            var opt = document.createElement('option');
            opt.value = data.name || doc.id; opt.textContent = opt.value;
            marketplaceSelect.appendChild(opt);
          });
        }
      } catch (e) { console.error('[config-fragment] procure dropdown error:', e); }
    }

    function cfgToggleProcureDateField(mode) {
      var el = document.getElementById('cfg-ä»•å…¥æ—¥');
      if (el) el.style.display = mode === 'fixed' ? 'block' : 'none';
    }
    window.cfgToggleProcureDateField = cfgToggleProcureDateField;

    function cfgToggleListingDateField(mode) {
      var el = document.getElementById('cfg-å‡ºå“æ—¥');
      if (el) el.style.display = mode === 'fixed' ? 'block' : 'none';
    }
    window.cfgToggleListingDateField = cfgToggleListingDateField;

    // ============================================
    // Platform Settings
    // ============================================

    async function cfgLoadPlatformsFromFirestore() {
      if (!window.db) return;
      try {
        var snapshot = await window.db.collection('platforms').get();
        if (!snapshot.empty) {
          _cfg_customPlatforms = [];
          snapshot.forEach(function(doc) {
            var data = doc.data();
            if (data.isCustom) {
              _cfg_customPlatforms.push({ id: doc.id, ...data });
            } else {
              // Update default platform data
              var idx = _cfg_defaultPlatformDefs.findIndex(function(p) { return p.id === doc.id; });
              if (idx !== -1) {
                Object.assign(_cfg_defaultPlatformDefs[idx], data);
              }
            }
          });
          _cfg_platformMaster = _cfg_defaultPlatformDefs.concat(_cfg_customPlatforms);
        }
      } catch (e) { console.error('[config-fragment] platforms load error:', e); }
    }

    function cfgLoadPlatformSettings(config) {
      if (!config || !config['ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š']) {
        _cfg_enabledPlatformIds = ['mercari'];
        cfgRenderEnabledPlatforms();
        return;
      }
      var settings = config['ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š'];
      if (settings.enabledPlatformIds && Array.isArray(settings.enabledPlatformIds)) {
        _cfg_enabledPlatformIds = settings.enabledPlatformIds;
      } else if (settings.platforms && Array.isArray(settings.platforms)) {
        _cfg_enabledPlatformIds = settings.platforms.filter(function(p) { return p.enabled; }).map(function(p) { return p.id; });
      }
      if (_cfg_enabledPlatformIds.length === 0) _cfg_enabledPlatformIds = ['mercari'];

      // Registration mode
      if (settings.registrationMode) {
        var modeRadio = document.getElementById(settings.registrationMode === 'batch' ? 'cfg-modeBatch' : 'cfg-modeIndividual');
        if (modeRadio) { modeRadio.checked = true; cfgSelectRegistrationMode(settings.registrationMode); }
      }

      cfgRenderEnabledPlatforms();
    }

    function cfgRenderEnabledPlatforms() {
      var container = document.getElementById('cfg-enabledPlatformsList');
      if (!container) return;
      container.innerHTML = _cfg_enabledPlatformIds.map(function(id) {
        var platform = _cfg_platformMaster.find(function(p) { return p.id === id; });
        if (!platform) return '';
        return '<div style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 10px; margin-bottom: 8px; background: white;">' +
          '<img src="' + (platform.icon || '') + '" alt="' + platform.name + '" style="width: 40px; height: 40px; object-fit: contain; border-radius: 6px;" onerror="this.style.display=\'none\'">' +
          '<div style="flex: 1;">' +
            '<div style="font-weight: 600; color: #374151; font-size: 14px;">' + platform.name + '</div>' +
            '<div style="font-size: 11px; color: #6b7280;">' + (platform.description || '') + '</div>' +
          '</div>' +
          '<button onclick="cfgOpenPlatformEditModal(\'' + id + '\')" style="background: none; border: none; color: #6b7280; font-size: 16px; cursor: pointer; padding: 4px;"><i class="bi bi-pencil"></i></button>' +
          '<button onclick="cfgRemovePlatformFromEnabled(\'' + id + '\')" style="background: none; border: none; color: #ef4444; font-size: 16px; cursor: pointer; padding: 4px;"><i class="bi bi-trash"></i></button>' +
        '</div>';
      }).join('');
    }

    function cfgSelectRegistrationMode(mode) {
      var indLabel = document.querySelector('#spa-page-config label[onclick*="individual"]');
      var batchLabel = document.querySelector('#spa-page-config label[onclick*="batch"]');
      if (indLabel && batchLabel) {
        if (mode === 'individual') {
          indLabel.style.borderColor = '#40B4E5'; indLabel.style.background = '#f0f9ff';
          batchLabel.style.borderColor = '#e5e7eb'; batchLabel.style.background = 'transparent';
        } else {
          batchLabel.style.borderColor = '#40B4E5'; batchLabel.style.background = '#f0f9ff';
          indLabel.style.borderColor = '#e5e7eb'; indLabel.style.background = 'transparent';
        }
      }
    }
    window.cfgSelectRegistrationMode = cfgSelectRegistrationMode;

    function cfgOpenPlatformSelectModal() {
      var modal = document.getElementById('cfg-platformSelectModal');
      if (modal) { modal.classList.add('active'); cfgRenderPlatformSelectList(); }
    }
    window.cfgOpenPlatformSelectModal = cfgOpenPlatformSelectModal;

    function cfgClosePlatformSelectModal() {
      var modal = document.getElementById('cfg-platformSelectModal');
      if (modal) modal.classList.remove('active');
    }
    window.cfgClosePlatformSelectModal = cfgClosePlatformSelectModal;

    function cfgRenderPlatformSelectList() {
      var container = document.getElementById('cfg-platformSelectList');
      if (!container) return;
      var available = _cfg_platformMaster.filter(function(p) { return !_cfg_enabledPlatformIds.includes(p.id); });
      if (available.length === 0) {
        container.innerHTML = '<div style="color: #9ca3af; font-size: 13px; padding: 20px; text-align: center;">è¿½åŠ ã§ãã‚‹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      container.innerHTML = available.map(function(p) {
        return '<div onclick="cfgAddPlatformToEnabled(\'' + p.id + '\')" style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; cursor: pointer;" onmouseover="this.style.background=\'#f9fafb\'" onmouseout="this.style.background=\'white\'">' +
          '<img src="' + (p.icon || '') + '" alt="' + p.name + '" style="width: 40px; height: 40px; object-fit: contain; border-radius: 6px;" onerror="this.style.display=\'none\'">' +
          '<div style="flex: 1;"><div style="font-weight: 600; color: #374151; font-size: 14px;">' + p.name + '</div><div style="font-size: 11px; color: #6b7280;">' + (p.description || '') + '</div></div>' +
          '<span style="color: #40B4E5; font-size: 20px;">+</span></div>';
      }).join('');
    }

    async function cfgAddPlatformToEnabled(platformId) {
      if (!_cfg_enabledPlatformIds.includes(platformId)) {
        _cfg_enabledPlatformIds.push(platformId);
        cfgRenderEnabledPlatforms();
        cfgRenderPlatformSelectList();
        await cfgPersistPlatformSettings();
      }
      var available = _cfg_platformMaster.filter(function(p) { return !_cfg_enabledPlatformIds.includes(p.id); });
      if (available.length === 0) cfgClosePlatformSelectModal();
    }
    window.cfgAddPlatformToEnabled = cfgAddPlatformToEnabled;

    async function cfgRemovePlatformFromEnabled(platformId) {
      var idx = _cfg_enabledPlatformIds.indexOf(platformId);
      if (idx > -1) {
        _cfg_enabledPlatformIds.splice(idx, 1);
        cfgRenderEnabledPlatforms();
        await cfgPersistPlatformSettings();
      }
    }
    window.cfgRemovePlatformFromEnabled = cfgRemovePlatformFromEnabled;

    function cfgCollectPlatformSettings() {
      var modeRadio = document.querySelector('#spa-page-config input[name="cfg-registrationMode"]:checked');
      var platforms = _cfg_enabledPlatformIds.map(function(id) {
        var p = _cfg_platformMaster.find(function(x) { return x.id === id; });
        if (!p) return null;
        return { id: id, name: p.name, description: p.description, icon: p.icon, enabled: true };
      }).filter(function(p) { return p; });
      return {
        registrationMode: modeRadio ? modeRadio.value : 'individual',
        platforms: platforms,
        enabledPlatformIds: _cfg_enabledPlatformIds,
        platformOrder: _cfg_enabledPlatformIds
      };
    }

    async function cfgPersistPlatformSettings() {
      try {
        var settings = cfgCollectPlatformSettings();
        localStorage.setItem(_cfg_CONFIG_STORAGE_KEYS.PLATFORM, JSON.stringify(settings));
        if (window.db) {
          var userId = localStorage.getItem('reborn_user_id') || localStorage.getItem('userId');
          if (userId) {
            await window.db.collection('configs').doc(userId).set({ 'ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š': settings }, { merge: true });
          }
        }
      } catch (e) { console.error('[config-fragment] persist platform error:', e); }
    }

    // Platform edit modal
    function cfgOpenPlatformEditModal(platformId) {
      _cfg_currentEditingPlatformId = platformId;
      _cfg_pendingIconFile = null;
      var platform = _cfg_platformEdits[platformId] || _cfg_customPlatforms.find(function(p) { return p.id === platformId; }) || _cfg_defaultPlatformDefs.find(function(p) { return p.id === platformId; });
      if (!platform) return;

      var editId = document.getElementById('cfg-editPlatformId');
      var editName = document.getElementById('cfg-editPlatformName');
      var editDesc = document.getElementById('cfg-editPlatformDesc');
      if (editId) editId.value = platform.id;
      if (editName) editName.value = platform.name;
      if (editDesc) editDesc.value = platform.description || '';

      var preview = document.getElementById('cfg-platformIconPreview');
      if (preview) {
        if (platform.icon) {
          preview.innerHTML = '<img src="' + platform.icon + '" style="width: 100%; height: 100%; object-fit: contain;">';
        } else {
          preview.innerHTML = '<span style="color: #9ca3af; font-size: 12px;">æœªè¨­å®š</span>';
        }
      }

      var modal = document.getElementById('cfg-platformEditModal');
      if (modal) modal.classList.add('active');
    }
    window.cfgOpenPlatformEditModal = cfgOpenPlatformEditModal;

    function cfgClosePlatformEditModal() {
      var modal = document.getElementById('cfg-platformEditModal');
      if (modal) modal.classList.remove('active');
      _cfg_currentEditingPlatformId = null;
      _cfg_pendingIconFile = null;
    }
    window.cfgClosePlatformEditModal = cfgClosePlatformEditModal;

    function cfgPreviewPlatformIcon(event) {
      var file = event.target.files[0];
      if (!file) return;
      if (file.size > 2 * 1024 * 1024) { alert('ç”»åƒã‚µã‚¤ã‚ºã¯2MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚'); return; }
      _cfg_pendingIconFile = file;
      var reader = new FileReader();
      reader.onload = function(e) {
        var preview = document.getElementById('cfg-platformIconPreview');
        if (preview) preview.innerHTML = '<img src="' + e.target.result + '" style="width: 100%; height: 100%; object-fit: contain;">';
        var status = document.getElementById('cfg-platformIconUploadStatus');
        if (status) { status.textContent = 'ç”»åƒã‚’é¸æŠã—ã¾ã—ãŸ'; status.style.color = '#10b981'; }
      };
      reader.readAsDataURL(file);
    }
    window.cfgPreviewPlatformIcon = cfgPreviewPlatformIcon;

    async function cfgSavePlatformEdit() {
      if (!_cfg_currentEditingPlatformId) return;
      var name = document.getElementById('cfg-editPlatformName').value.trim();
      if (!name) { alert('è¡¨ç¤ºåã¯å¿…é ˆã§ã™ã€‚'); return; }
      var description = document.getElementById('cfg-editPlatformDesc').value.trim();

      // Update platform in master
      var idx = _cfg_defaultPlatformDefs.findIndex(function(p) { return p.id === _cfg_currentEditingPlatformId; });
      if (idx !== -1) {
        _cfg_defaultPlatformDefs[idx].name = name;
        _cfg_defaultPlatformDefs[idx].description = description;
      }
      _cfg_platformMaster = _cfg_defaultPlatformDefs.concat(_cfg_customPlatforms);

      cfgRenderEnabledPlatforms();
      cfgClosePlatformEditModal();
      await cfgPersistPlatformSettings();
    }
    window.cfgSavePlatformEdit = cfgSavePlatformEdit;

    // ============================================
    // Description Order
    // ============================================

    function cfgRenderDescriptionOrder(order) {
      var container = document.getElementById('cfg-descriptionOrderList');
      if (!container) return;
      container.innerHTML = '';

      var elements = (order && order.length > 0) ? order : _cfg_DESCRIPTION_ELEMENTS;

      // Add missing new elements
      if (order && order.length > 0) {
        var existingIds = order.map(function(e) { return e.id; });
        var newElements = _cfg_DESCRIPTION_ELEMENTS.filter(function(e) { return !existingIds.includes(e.id); });
        if (newElements.length > 0) elements = order.concat(newElements);
      }

      elements.forEach(function(element) {
        var item = document.createElement('div');
        item.draggable = true;
        item.dataset.elementId = element.id;
        item.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; cursor: move; user-select: none;';

        var handle = document.createElement('span');
        handle.textContent = '\u22EE\u22EE';
        handle.style.cssText = 'font-size: 16px; color: #9ca3af; cursor: move;';
        item.appendChild(handle);

        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = element.enabled !== false;
        checkbox.style.cssText = 'width: 18px; height: 18px; cursor: pointer;';
        checkbox.addEventListener('change', cfgUpdateDescriptionOrderPreview);
        item.appendChild(checkbox);

        var label = document.createElement('span');
        label.textContent = element.label;
        label.style.cssText = 'flex: 1; font-size: 13px; font-weight: 500; color: #374151;';
        item.appendChild(label);

        // Drag events
        item.addEventListener('dragstart', function(e) {
          _cfg_draggedElement = item;
          e.dataTransfer.effectAllowed = 'move';
          item.style.opacity = '0.5';
        });
        item.addEventListener('dragend', function() {
          item.style.opacity = '1';
          _cfg_draggedElement = null;
        });
        item.addEventListener('dragover', function(e) {
          e.preventDefault();
          if (_cfg_draggedElement && _cfg_draggedElement !== item) {
            item.style.borderColor = '#3b82f6';
          }
        });
        item.addEventListener('dragleave', function() {
          item.style.borderColor = '#e5e7eb';
        });
        item.addEventListener('drop', function(e) {
          e.preventDefault();
          item.style.borderColor = '#e5e7eb';
          if (_cfg_draggedElement && _cfg_draggedElement !== item) {
            var allItems = Array.from(container.children);
            var draggedIndex = allItems.indexOf(_cfg_draggedElement);
            var targetIndex = allItems.indexOf(item);
            if (draggedIndex < targetIndex) {
              container.insertBefore(_cfg_draggedElement, item.nextSibling);
            } else {
              container.insertBefore(_cfg_draggedElement, item);
            }
            cfgUpdateDescriptionOrderPreview();
          }
        });

        container.appendChild(item);
      });

      cfgUpdateDescriptionOrderPreview();
    }

    function cfgUpdateDescriptionOrderPreview() {
      var container = document.getElementById('cfg-descriptionOrderList');
      var preview = document.getElementById('cfg-descriptionOrderPreview');
      if (!container || !preview) return;

      var sampleTexts = {
        brand: 'ãƒ–ãƒ©ãƒ³ãƒ‰åï¼šUNIQLO',
        color: 'ã‚«ãƒ©ãƒ¼ï¼ˆè©³ç´°ï¼‰ï¼šãƒ–ãƒ©ãƒƒã‚¯',
        size: 'ã‚µã‚¤ã‚ºï¼šM',
        material: 'ç´ æï¼šãƒŠã‚¤ãƒ­ãƒ³ 100%',
        accessories: 'ä»˜å±å“ï¼šä¿å­˜è¢‹',
        condition: 'å•†å“çŠ¶æ…‹ï¼šç›®ç«‹ã£ãŸå‚·ã‚„æ±šã‚Œãªã—',
        ai: 'ã€å•†å“èª¬æ˜ã€‘UNIQLOã®å®šç•ªã‚¢ã‚¤ãƒ†ãƒ ã§ã™ã€‚',
        management: 'ç®¡ç†ç•ªå·ï¼šã€AA-1001ã€‘',
        discount: 'ãƒ•ã‚©ãƒ­ãƒ¼å‰²ã‚ã‚Šã¾ã™',
        hashtag: '#REBORN_å…¨å•†å“'
      };

      var items = Array.from(container.children);
      var enabledItems = items.filter(function(item) {
        return item.querySelector('input[type="checkbox"]').checked;
      });

      if (enabledItems.length === 0) {
        preview.textContent = 'ï¼ˆã™ã¹ã¦éè¡¨ç¤ºï¼‰';
        preview.style.color = '#ef4444';
      } else {
        var text = enabledItems.map(function(item) {
          return sampleTexts[item.dataset.elementId] || '';
        }).filter(function(t) { return t; }).join('\n\n');
        preview.textContent = text;
        preview.style.color = '#374151';
        preview.style.whiteSpace = 'pre-line';
      }
    }
    window.cfgUpdateDescriptionOrderPreview = cfgUpdateDescriptionOrderPreview;

    function cfgCollectDescriptionOrder() {
      var container = document.getElementById('cfg-descriptionOrderList');
      if (!container) return _cfg_DESCRIPTION_ELEMENTS;
      return Array.from(container.children).map(function(item) {
        var elementId = item.dataset.elementId;
        var element = _cfg_DESCRIPTION_ELEMENTS.find(function(e) { return e.id === elementId; });
        return {
          id: elementId,
          label: element ? element.label : '',
          enabled: item.querySelector('input[type="checkbox"]').checked
        };
      });
    }

    function cfgResetDescriptionOrder() {
      if (!confirm('é…ç½®é †åºã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) return;
      cfgRenderDescriptionOrder(_cfg_DESCRIPTION_ELEMENTS);
      alert('é…ç½®é †åºã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸã€‚');
    }
    window.cfgResetDescriptionOrder = cfgResetDescriptionOrder;

    // ============================================
    // Management Number Builder (MNB)
    // ============================================

    function cfgMnbTogglePart(partName, enabled) {
      _cfg_mnbSettings.parts[partName] = enabled;
      var card = document.getElementById('cfg-mnb-part-' + partName);
      if (card) {
        if (enabled) card.classList.add('enabled');
        else card.classList.remove('enabled');
      }
      cfgMnbUpdatePreview();
    }
    window.cfgMnbTogglePart = cfgMnbTogglePart;

    function cfgMnbChangeDigits(delta) {
      _cfg_mnbSettings.serialDigits = Math.max(1, Math.min(6, _cfg_mnbSettings.serialDigits + delta));
      var el = document.getElementById('cfg-mnb-serialDigits');
      if (el) el.textContent = _cfg_mnbSettings.serialDigits;
      cfgMnbUpdatePreview();
    }
    window.cfgMnbChangeDigits = cfgMnbChangeDigits;

    function cfgMnbSelectSeparator(btn) {
      var selector = document.getElementById('cfg-mnb-separatorSelector');
      if (selector) {
        selector.querySelectorAll('.mnb-separator-btn').forEach(function(b) { b.classList.remove('active'); });
      }
      btn.classList.add('active');
      _cfg_mnbSettings.separator = btn.dataset.sep;
      cfgMnbUpdatePreview();
    }
    window.cfgMnbSelectSeparator = cfgMnbSelectSeparator;

    function cfgMnbUpdatePreview() {
      var preview = document.getElementById('cfg-mnb-preview');
      if (!preview) return;
      var parts = [];
      var sep = _cfg_mnbSettings.separator;

      // Build preview based on enabled parts and order
      var order = _cfg_mnbSettings.partOrder || ['category', 'serial', 'date', 'initial'];
      order.forEach(function(partName) {
        if (!_cfg_mnbSettings.parts[partName]) return;
        switch (partName) {
          case 'category': parts.push('TP'); break;
          case 'serial': parts.push('0'.repeat(_cfg_mnbSettings.serialDigits - 1) + '1'); break;
          case 'date':
            var now = new Date();
            var yy = String(now.getFullYear()).slice(2);
            var mm = String(now.getMonth() + 1).padStart(2, '0');
            var dd = String(now.getDate()).padStart(2, '0');
            var fmt = _cfg_mnbSettings.dateFormat || 'YYMMDD';
            if (fmt === 'YYMMDD') parts.push(yy + mm + dd);
            else if (fmt === 'YYMM') parts.push(yy + mm);
            else if (fmt === 'MMDD') parts.push(mm + dd);
            break;
          case 'initial': parts.push('YT'); break;
        }
      });
      preview.textContent = parts.join(sep) || '---';
    }

    function cfgMnbOpenCategoryModal() {
      var modal = document.getElementById('cfg-mnb-categoryModal');
      if (modal) { modal.classList.add('active'); cfgMnbRenderCategoryList(); }
    }
    window.cfgMnbOpenCategoryModal = cfgMnbOpenCategoryModal;

    function cfgMnbCloseCategoryModal() {
      var modal = document.getElementById('cfg-mnb-categoryModal');
      if (modal) modal.classList.remove('active');
    }
    window.cfgMnbCloseCategoryModal = cfgMnbCloseCategoryModal;

    function cfgMnbRenderCategoryList() {
      var container = document.getElementById('cfg-mnb-categoryList');
      if (!container) return;
      var codes = _cfg_mnbSettings.categoryCodes || {};
      var keys = Object.keys(codes);
      if (keys.length === 0) {
        container.innerHTML = '<div style="color: #9ca3af; font-size: 13px; text-align: center; padding: 20px;">ã‚«ãƒ†ã‚´ãƒªã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      container.innerHTML = keys.map(function(key) {
        return '<div class="mnb-category-btn" style="display: flex; justify-content: space-between;"><span>' + key + '</span><span style="color: #6b7280; font-weight: 600;">' + codes[key] + '</span></div>';
      }).join('');
    }

    async function cfgMnbLoadCategoryCodes() {
      if (!window.db) return;
      try {
        var snapshot = await window.db.collection('categoryCodes').get();
        _cfg_mnbSettings.categoryCodes = {};
        snapshot.forEach(function(doc) {
          var data = doc.data();
          _cfg_mnbSettings.categoryCodes[data.name || doc.id] = data.code || doc.id;
        });
      } catch (e) { console.error('[config-fragment] category codes error:', e); }
    }

    function cfgMnbLoadSettings() {
      try {
        var saved = localStorage.getItem('managementNumberSettings');
        if (saved) {
          var settings = JSON.parse(saved);
          Object.assign(_cfg_mnbSettings, settings);
        }
      } catch (e) { /* ignore */ }

      // Apply to UI
      ['category', 'serial', 'date', 'initial'].forEach(function(part) {
        var card = document.getElementById('cfg-mnb-part-' + part);
        var checkbox = card ? card.querySelector('input[type="checkbox"]') : null;
        if (checkbox) {
          checkbox.checked = !!_cfg_mnbSettings.parts[part];
          if (_cfg_mnbSettings.parts[part]) card.classList.add('enabled');
          else card.classList.remove('enabled');
        }
      });

      var digitsEl = document.getElementById('cfg-mnb-serialDigits');
      if (digitsEl) digitsEl.textContent = _cfg_mnbSettings.serialDigits;

      var dateFormat = document.getElementById('cfg-mnb-dateFormat');
      if (dateFormat) dateFormat.value = _cfg_mnbSettings.dateFormat || 'YYMMDD';

      // Separator
      var sepSelector = document.getElementById('cfg-mnb-separatorSelector');
      if (sepSelector) {
        sepSelector.querySelectorAll('.mnb-separator-btn').forEach(function(btn) {
          btn.classList.toggle('active', btn.dataset.sep === _cfg_mnbSettings.separator);
        });
      }

      cfgMnbUpdatePreview();
    }

    // ============================================
    // Compensation Settings
    // ============================================

    function cfgCollectCompensationSettings() {
      return {
        taskRates: {
          listing: parseInt(document.getElementById('cfg-compensation-listing')?.value) || 100,
          shipping: parseInt(document.getElementById('cfg-compensation-shipping')?.value) || 100,
          photography: parseInt(document.getElementById('cfg-compensation-photography')?.value) || 50,
          inspection: parseInt(document.getElementById('cfg-compensation-inspection')?.value) || 30,
          stocktaking: parseInt(document.getElementById('cfg-compensation-stocktaking')?.value) || 20,
          editing: parseInt(document.getElementById('cfg-compensation-editing')?.value) || 50
        },
        customTasks: cfgCollectCustomTasks(),
        options: {
          autoRecordListing: document.getElementById('cfg-autoRecordListing')?.checked ?? true,
          autoRecordShipping: document.getElementById('cfg-autoRecordShipping')?.checked ?? true,
          cutoffDay: document.getElementById('cfg-compensationCutoffDay')?.value || 'æœ«æ—¥',
          paymentDay: document.getElementById('cfg-compensationPaymentDay')?.value || 'ç¿Œæœˆ5æ—¥',
          recordAsExpense: document.getElementById('cfg-recordAsExpense')?.checked ?? true
        }
      };
    }

    function cfgCollectCustomTasks() {
      var tasks = [];
      var container = document.getElementById('cfg-customTasksContainer');
      if (!container) return tasks;
      container.querySelectorAll('.custom-task-item').forEach(function(item) {
        var nameInput = item.querySelector('.custom-task-name');
        var rateInput = item.querySelector('.custom-task-rate');
        if (nameInput && rateInput && nameInput.value.trim()) {
          tasks.push({ id: item.dataset.taskId || 'custom_' + Date.now(), name: nameInput.value.trim(), rate: parseInt(rateInput.value) || 0 });
        }
      });
      return tasks;
    }

    async function cfgLoadCompensationSettingsFromFirestore() {
      if (!window.db) return;
      try {
        var doc = await window.db.collection('settings').doc('compensation').get();
        if (doc.exists) {
          cfgLoadCompensationSettings({ 'å ±é…¬è¨­å®š': doc.data() });
        }
      } catch (e) { console.error('[config-fragment] compensation load error:', e); }
    }

    function cfgLoadCompensationSettings(config) {
      if (!config || !config['å ±é…¬è¨­å®š']) return;
      var settings = config['å ±é…¬è¨­å®š'];
      if (settings.taskRates) {
        ['listing', 'shipping', 'photography', 'inspection', 'stocktaking', 'editing'].forEach(function(task) {
          if (settings.taskRates[task] !== undefined) {
            var el = document.getElementById('cfg-compensation-' + task);
            if (el) el.value = settings.taskRates[task];
          }
        });
      }
      if (settings.customTasks) {
        settings.customTasks.forEach(function(task) {
          cfgAddCustomCompensationTask(task.name, task.rate, task.id);
        });
      }
      if (settings.options) {
        var opts = settings.options;
        var autoListing = document.getElementById('cfg-autoRecordListing');
        if (autoListing) autoListing.checked = opts.autoRecordListing ?? true;
        var autoShipping = document.getElementById('cfg-autoRecordShipping');
        if (autoShipping) autoShipping.checked = opts.autoRecordShipping ?? true;
        var cutoff = document.getElementById('cfg-compensationCutoffDay');
        if (cutoff) cutoff.value = opts.cutoffDay || 'æœ«æ—¥';
        var payment = document.getElementById('cfg-compensationPaymentDay');
        if (payment) payment.value = opts.paymentDay || 'ç¿Œæœˆ5æ—¥';
        var expense = document.getElementById('cfg-recordAsExpense');
        if (expense) expense.checked = opts.recordAsExpense ?? true;
      }
    }

    async function cfgSaveCompensationSettings() {
      if (!window.db) return;
      try {
        var settings = cfgCollectCompensationSettings();
        await window.db.collection('settings').doc('compensation').set(settings, { merge: true });
      } catch (e) { console.error('[config-fragment] compensation save error:', e); }
    }

    function cfgAddCustomCompensationTask(name, rate, taskId) {
      var container = document.getElementById('cfg-customTasksContainer');
      var wrapper = document.getElementById('cfg-customCompensationTasks');
      if (!container || !wrapper) return;
      wrapper.style.display = 'block';
      var id = taskId || 'custom_' + (++_cfg_customTaskCounter);
      var html = '<div class="custom-task-item" data-task-id="' + id + '" style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb; margin-bottom: 6px;">' +
        '<div style="flex: 1;"><input type="text" class="custom-task-name form-control" value="' + (name || '') + '" placeholder="ã‚¿ã‚¹ã‚¯å" style="font-size: 14px;"></div>' +
        '<div style="display: flex; align-items: center; gap: 4px;"><span style="font-size: 14px; color: #6b7280;">Â¥</span><input type="number" class="custom-task-rate" value="' + (rate || 0) + '" min="0" step="10" style="width: 80px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; text-align: right;"><span style="font-size: 12px; color: #6b7280;">/ä»¶</span></div>' +
        '<button type="button" onclick="cfgRemoveCustomCompensationTask(this)" style="background: none; border: none; color: #ef4444; font-size: 18px; cursor: pointer;"><i class="bi bi-trash"></i></button></div>';
      container.insertAdjacentHTML('beforeend', html);
    }
    window.cfgAddCustomCompensationTask = cfgAddCustomCompensationTask;

    function cfgRemoveCustomCompensationTask(btn) {
      var item = btn.closest('.custom-task-item');
      if (item) {
        item.remove();
        var container = document.getElementById('cfg-customTasksContainer');
        var wrapper = document.getElementById('cfg-customCompensationTasks');
        if (container && wrapper && container.children.length === 0) wrapper.style.display = 'none';
      }
    }
    window.cfgRemoveCustomCompensationTask = cfgRemoveCustomCompensationTask;

    function cfgOpenCompensationManagement() {
      if (typeof navigateToPage === 'function') {
        navigateToPage('compensation');
      }
    }
    window.cfgOpenCompensationManagement = cfgOpenCompensationManagement;

    function cfgAssignAllTasksToAll() {
      document.querySelectorAll('#spa-page-config .task-assign-checkbox').forEach(function(cb) { cb.checked = true; });
      document.querySelectorAll('#spa-page-config [id^="cfg-task-accordion-"]').forEach(function(el) {
        if (!el.id.includes('-badge') && !el.id.includes('-arrow')) cfgUpdateTaskBadge(el.id);
      });
    }
    window.cfgAssignAllTasksToAll = cfgAssignAllTasksToAll;

    // User task assignment
    async function cfgLoadUserTaskAssignmentList() {
      var container = document.getElementById('cfg-userTaskAssignmentList');
      if (!container || !window.db) return;
      try {
        var snapshot = await window.db.collection('users').get();
        var users = [];
        var permLabels = { owner: 'ç®¡ç†è€…', admin: 'ç®¡ç†è€…', employee: 'ç¤¾å“¡', staff: 'ã‚¹ã‚¿ãƒƒãƒ•', leader: 'ãƒªãƒ¼ãƒ€ãƒ¼', contractor: 'å¤–æ³¨' };
        snapshot.forEach(function(docSnap) {
          var data = docSnap.data();
          var permId = data.permissionId || 'staff';
          users.push({
            email: docSnap.id, name: data.userName || docSnap.id,
            permissionId: permId, permissionDisplay: permLabels[permId] || 'ã‚¹ã‚¿ãƒƒãƒ•',
            assignedTasks: data.assignedTasks || ['listing', 'shipping', 'photography', 'stocktaking', 'editing']
          });
        });
        users.sort(function(a, b) { var order = { owner: 1, admin: 2, staff: 3 }; return (order[a.permissionId] || 99) - (order[b.permissionId] || 99); });

        var tasks = [
          { id: 'listing', name: 'å•†å“å‡ºå“' }, { id: 'shipping', name: 'æ¢±åŒ…ãƒ»ç™ºé€' },
          { id: 'photography', name: 'å•†å“æ’®å½±' }, { id: 'inspection', name: 'æ¤œå“ä½œæ¥­' },
          { id: 'stocktaking', name: 'æ£šå¸' }, { id: 'editing', name: 'è¿½åŠ ç·¨é›†' }
        ];

        container.innerHTML = users.map(function(user, index) {
          var accordionId = 'cfg-task-accordion-' + index;
          var taskItems = tasks.map(function(task) {
            var checked = user.assignedTasks.includes(task.id) ? 'checked' : '';
            return '<label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;">' +
              '<input type="checkbox" class="task-assign-checkbox" data-email="' + user.email + '" data-task="' + task.id + '" ' + checked + ' style="width: 22px; height: 22px;" onchange="cfgUpdateTaskBadge(\'' + accordionId + '\')">' +
              '<span style="font-size: 14px; color: #374151;">' + task.name + '</span></label>';
          }).join('');

          return '<div style="border: 1px solid #e5e7eb; border-radius: 10px; overflow: hidden; background: white;">' +
            '<div onclick="cfgToggleTaskAccordion(\'' + accordionId + '\')" style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; cursor: pointer;">' +
              '<div style="flex: 1;"><div style="font-size: 14px; font-weight: 600;">' + cfgEscapeHtml(user.name) + '</div><span style="font-size: 11px; color: #9ca3af;">' + user.permissionDisplay + '</span></div>' +
              '<span id="' + accordionId + '-badge" style="color: #6b7280; font-size: 12px;">' + user.assignedTasks.length + 'ä»¶</span>' +
              '<i id="' + accordionId + '-arrow" class="bi bi-chevron-right" style="font-size: 12px; color: #9ca3af;"></i>' +
            '</div>' +
            '<div id="' + accordionId + '" style="display: none; border-top: 1px solid #e5e7eb; background: #f9fafb; padding: 12px;"><div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">' + taskItems + '</div></div></div>';
        }).join('');
      } catch (e) { console.error('[config-fragment] task assignment error:', e); }
    }

    function cfgToggleTaskAccordion(accordionId) {
      var content = document.getElementById(accordionId);
      var arrow = document.getElementById(accordionId + '-arrow');
      if (!content || !arrow) return;
      if (content.style.display === 'none') { content.style.display = 'block'; arrow.style.transform = 'rotate(90deg)'; }
      else { content.style.display = 'none'; arrow.style.transform = 'rotate(0deg)'; }
    }
    window.cfgToggleTaskAccordion = cfgToggleTaskAccordion;

    function cfgUpdateTaskBadge(accordionId) {
      var content = document.getElementById(accordionId);
      if (!content) return;
      var count = content.querySelectorAll('.task-assign-checkbox:checked').length;
      var badge = document.getElementById(accordionId + '-badge');
      if (badge) badge.textContent = count + 'ä»¶';
    }
    window.cfgUpdateTaskBadge = cfgUpdateTaskBadge;

    async function cfgSaveUserTaskAssignments() {
      if (!window.db) return;
      var assignments = {};
      document.querySelectorAll('#spa-page-config .task-assign-checkbox').forEach(function(cb) {
        var email = cb.dataset.email;
        if (!assignments[email]) assignments[email] = [];
        if (cb.checked) assignments[email].push(cb.dataset.task);
      });
      try {
        var batch = window.db.batch();
        Object.keys(assignments).forEach(function(email) {
          batch.update(window.db.collection('users').doc(email), { assignedTasks: assignments[email] });
        });
        await batch.commit();
      } catch (e) { console.error('[config-fragment] task save error:', e); }
    }

    // ============================================
    // User Management
    // ============================================

    async function cfgLoadUserManagement() {
      var loadingDiv = document.getElementById('cfg-userManagementLoading');
      var contentDiv = document.getElementById('cfg-userManagementContent');
      if (!loadingDiv || !contentDiv) return;

      var permissionId = localStorage.getItem('reborn_user_permission_id');
      if (permissionId !== 'owner') {
        loadingDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 14px; color: #dc2626;">ã“ã®æ©Ÿèƒ½ã¯ç®¡ç†è€…ã®ã¿åˆ©ç”¨ã§ãã¾ã™</div></div>';
        return;
      }

      if (!window.db) { setTimeout(cfgLoadUserManagement, 500); return; }

      try {
        var snapshot = await window.db.collection('users').get();
        var users = [];
        snapshot.forEach(function(doc) { users.push({ id: doc.id, ...doc.data() }); });
        _cfg_allUsersData = users;
        cfgRenderAllUsers(users);
        loadingDiv.style.display = 'none';
        contentDiv.style.display = 'block';
      } catch (e) {
        console.error('[config-fragment] user management error:', e);
        loadingDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #dc2626;">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      }
    }

    function cfgRenderAllUsers(users) {
      var pending = users.filter(function(u) { return u.status === 'pending'; });
      var active = users.filter(function(u) { return u.status === 'active' || !u.status; });
      var inactive = users.filter(function(u) { return u.status === 'inactive'; });

      var pendingCount = document.getElementById('cfg-pendingUsersCount');
      var inactiveCount = document.getElementById('cfg-inactiveUsersCount');
      if (pendingCount) pendingCount.textContent = pending.length;
      if (inactiveCount) inactiveCount.textContent = inactive.length;

      // Pending
      var pendingSection = document.getElementById('cfg-pendingSection');
      if (pending.length > 0 && pendingSection) {
        pendingSection.style.display = 'block';
        document.getElementById('cfg-pendingUsersList').innerHTML = cfgRenderUserRows(users.filter(function(u) { return u.status === 'pending'; }), 'pending');
      } else if (pendingSection) { pendingSection.style.display = 'none'; }

      // Permission groups
      var groupsContainer = document.getElementById('cfg-permissionGroups');
      if (groupsContainer) {
        var permGroups = {};
        var permOrder = ['owner', 'employee', 'leader', 'staff', 'contractor'];
        active.forEach(function(u) {
          var perm = u.permissionId || 'staff';
          if (!permGroups[perm]) permGroups[perm] = [];
          permGroups[perm].push(u);
        });
        var html = '';
        permOrder.forEach(function(permId) {
          var grpUsers = permGroups[permId];
          if (!grpUsers || grpUsers.length === 0) return;
          var permDef = _cfg_PERMISSION_DEFINITIONS[permId] || { label: permId };
          html += '<div style="background: white; border-radius: 8px; border: 1px solid #e5e7eb; overflow: hidden; margin-bottom: 8px;">' +
            '<div style="padding: 12px 16px; background: #f9fafb; display: flex; align-items: center; gap: 8px;">' +
              '<span style="font-size: 14px; font-weight: 600; color: #374151;">' + permDef.label + '</span>' +
              '<span style="background: #e5e7eb; font-size: 11px; padding: 2px 8px; border-radius: 10px;">' + grpUsers.length + '</span></div>' +
            '<div style="padding: 8px;">' + cfgRenderUserRows(grpUsers, 'active') + '</div></div>';
        });
        groupsContainer.innerHTML = html || '<div style="text-align: center; color: #9ca3af; padding: 20px;">æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“</div>';
      }

      // Inactive
      var inactiveSection = document.getElementById('cfg-inactiveSection');
      if (inactive.length > 0 && inactiveSection) {
        inactiveSection.style.display = 'block';
        document.getElementById('cfg-inactiveUsersList').innerHTML = cfgRenderUserRows(inactive, 'inactive');
      } else if (inactiveSection) { inactiveSection.style.display = 'none'; }
    }

    function cfgRenderUserRows(users, status) {
      var now = Date.now();
      return users.map(function(user) {
        var userName = user.userName || user.name || 'Unknown';
        var isOnline = false;
        if (user.lastActiveAt) {
          var lastActive = typeof user.lastActiveAt === 'string' ? new Date(user.lastActiveAt).getTime() : (user.lastActiveAt.toDate ? user.lastActiveAt.toDate().getTime() : 0);
          isOnline = (now - lastActive) < 300000;
        }
        var userData = encodeURIComponent(JSON.stringify(user));
        return '<div onclick="cfgOpenUserDetailModal(\'' + userData + '\', \'' + status + '\')" style="display: flex; align-items: center; gap: 12px; padding: 10px 12px; margin-bottom: 4px; background: #f9fafb; border-radius: 8px; cursor: pointer;">' +
          '<div style="flex-shrink: 0; position: relative;">' +
            (user.photoURL ? '<img src="' + user.photoURL + '" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">' : '<div style="width: 40px; height: 40px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center;"><i class="bi bi-person" style="font-size: 20px; color: #9ca3af;"></i></div>') +
            '<div style="position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; background: ' + (isOnline ? '#10b981' : '#d1d5db') + '; border: 2px solid white; border-radius: 50%;"></div>' +
          '</div>' +
          '<div style="flex: 1;"><div style="font-size: 14px; font-weight: 500;">' + cfgEscapeHtml(userName) + '</div></div>' +
          '<div style="color: #9ca3af;">></div></div>';
      }).join('');
    }

    function cfgOpenUserDetailModal(encodedData, status) {
      var user = JSON.parse(decodeURIComponent(encodedData));
      var modal = document.getElementById('cfg-userDetailModal');
      var content = document.getElementById('cfg-userDetailContent');
      var actionsDiv = document.getElementById('cfg-userDetailActions');
      if (!modal || !content || !actionsDiv) return;

      var userName = user.userName || user.name || 'Unknown';
      var userEmail = user.userEmail || user.email || '';
      var permId = user.permissionId || 'staff';
      var permDef = _cfg_PERMISSION_DEFINITIONS[permId] || { label: permId };

      content.innerHTML = '<div style="text-align: center; margin-bottom: 16px;">' +
        '<div style="font-size: 16px; font-weight: 600;">' + cfgEscapeHtml(userName) + '</div>' +
        '<div style="font-size: 12px; color: #6b7280;">' + cfgEscapeHtml(userEmail) + '</div></div>' +
        '<div style="background: #f9fafb; border-radius: 8px; padding: 12px;">' +
          '<div style="display: flex; justify-content: space-between; margin-bottom: 8px;"><span style="color: #6b7280; font-size: 12px;">æ¨©é™</span><span style="font-size: 12px;">' + permDef.label + '</span></div>' +
          '<div style="display: flex; justify-content: space-between;"><span style="color: #6b7280; font-size: 12px;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span><span style="font-size: 12px;">' + (status === 'active' ? 'æœ‰åŠ¹' : status === 'pending' ? 'æ‰¿èªå¾…ã¡' : 'ç„¡åŠ¹') + '</span></div></div>';

      var currentEmail = localStorage.getItem('reborn_user_email');
      var isSelf = userEmail === currentEmail;
      var actionButtons = '';

      if (status === 'pending') {
        actionButtons = '<button onclick="cfgApproveUser(\'' + user.id + '\')" style="width: 100%; padding: 10px; background: #10b981; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">æ‰¿èª</button>';
      } else if (status === 'active' && !isSelf) {
        actionButtons = '<button onclick="cfgDisableUser(\'' + user.id + '\')" style="width: 100%; padding: 10px; background: #fee2e2; color: #dc2626; border: none; border-radius: 8px; font-size: 13px; cursor: pointer;">ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç„¡åŠ¹åŒ–</button>';
      } else if (status === 'inactive') {
        actionButtons = '<button onclick="cfgEnableUser(\'' + user.id + '\')" style="width: 100%; padding: 10px; background: #10b981; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; margin-bottom: 8px;">æœ‰åŠ¹åŒ–</button>';
      }

      actionsDiv.innerHTML = actionButtons;
      modal.style.display = 'flex';
    }
    window.cfgOpenUserDetailModal = cfgOpenUserDetailModal;

    function cfgCloseUserDetailModal() {
      var modal = document.getElementById('cfg-userDetailModal');
      if (modal) modal.style.display = 'none';
    }
    window.cfgCloseUserDetailModal = cfgCloseUserDetailModal;

    async function cfgApproveUser(userId) {
      if (!confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ')) return;
      try {
        await window.db.collection('users').doc(userId).update({
          status: 'active', permissionId: 'staff', permissionDisplay: 'ã‚¹ã‚¿ãƒƒãƒ•',
          approvedAt: new Date().toISOString(), approvedBy: localStorage.getItem('reborn_user_email')
        });
        cfgCloseUserDetailModal();
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ‰¿èªã—ã¾ã—ãŸ');
        cfgLoadUserManagement();
      } catch (e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); }
    }
    window.cfgApproveUser = cfgApproveUser;

    async function cfgDisableUser(userId) {
      if (!confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™ã‹ï¼Ÿ')) return;
      try {
        await window.db.collection('users').doc(userId).update({ status: 'inactive', disabledAt: new Date().toISOString() });
        cfgCloseUserDetailModal(); alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸ'); cfgLoadUserManagement();
      } catch (e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); }
    }
    window.cfgDisableUser = cfgDisableUser;

    async function cfgEnableUser(userId) {
      if (!confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã™ã‹ï¼Ÿ')) return;
      try {
        await window.db.collection('users').doc(userId).update({ status: 'active', enabledAt: new Date().toISOString() });
        cfgCloseUserDetailModal(); alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ'); cfgLoadUserManagement();
      } catch (e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); }
    }
    window.cfgEnableUser = cfgEnableUser;

    function cfgToggleSection(section) {
      var list = document.getElementById('cfg-' + section + 'UsersList');
      var toggle = document.getElementById('cfg-' + section + 'Toggle');
      if (!list || !toggle) return;
      if (list.style.display === 'none') { list.style.display = 'block'; toggle.textContent = '\u25BC'; }
      else { list.style.display = 'none'; toggle.textContent = '\u25B6'; }
    }
    window.cfgToggleSection = cfgToggleSection;

    function cfgFilterUserList() {
      var query = (document.getElementById('cfg-userSearchInput')?.value || '').toLowerCase().trim();
      if (!query) { cfgRenderAllUsers(_cfg_allUsersData); return; }
      var filtered = _cfg_allUsersData.filter(function(u) {
        return ((u.userName || u.name || '') + (u.userEmail || u.email || '')).toLowerCase().includes(query);
      });
      cfgRenderAllUsers(filtered);
    }
    window.cfgFilterUserList = cfgFilterUserList;

    // ============================================
    // Permission Settings
    // ============================================

    async function cfgLoadPermissionSettings() {
      if (_cfg_permissionSettingsLoaded) return;
      if (!window.db || typeof window.db.collection !== 'function') { setTimeout(cfgLoadPermissionSettings, 500); return; }
      try {
        console.log('[config-fragment] Loading permission settings...');
        var usersSnapshot = await window.db.collection('users').get();
        _cfg_usersData = [];
        usersSnapshot.forEach(function(doc) {
          var data = doc.data();
          _cfg_usersData.push({ email: doc.id, userName: data.userName || doc.id, permissionId: data.permissionId || 'staff' });
        });

        var menuPermDoc = await window.db.collection('settings').doc('menuPermissions').get();
        _cfg_menuPermissions = menuPermDoc.exists ? menuPermDoc.data() : {};

        cfgRenderUserPermissionList();
        cfgRenderMenuPermissionList();

        document.getElementById('cfg-permissionSettingsLoading').style.display = 'none';
        document.getElementById('cfg-permissionSettingsContent').style.display = 'block';
        _cfg_permissionSettingsLoaded = true;
        console.log('[config-fragment] Permission settings loaded successfully');
      } catch (e) {
        console.error('[config-fragment] permission load error:', e);
        var loadingEl = document.getElementById('cfg-permissionSettingsLoading');
        if (loadingEl) {
          loadingEl.innerHTML = '<div style="color: #ef4444; font-size: 14px;">æ¨©é™è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>' +
            '<div style="color: #6b7280; font-size: 12px; margin-top: 8px;">' + (e.message || e) + '</div>' +
            '<button onclick="cfgRetryLoadPermission()" style="margin-top: 12px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">å†è©¦è¡Œ</button>';
        }
      }
    }

    function cfgRetryLoadPermission() {
      _cfg_permissionSettingsLoaded = false;
      var loadingEl = document.getElementById('cfg-permissionSettingsLoading');
      if (loadingEl) {
        loadingEl.innerHTML = '<div style="font-size: 14px; color: #6b7280;">èª­ã¿è¾¼ã¿ä¸­...</div>';
        loadingEl.style.display = '';
      }
      document.getElementById('cfg-permissionSettingsContent').style.display = 'none';
      cfgLoadPermissionSettings();
    }
    window.cfgRetryLoadPermission = cfgRetryLoadPermission;

    function cfgGetActivePermissions() {
      var activeIds = new Set(['owner']);
      _cfg_usersData.forEach(function(u) { if (u.permissionId) activeIds.add(u.permissionId); });
      return Array.from(activeIds).filter(function(id) { return _cfg_PERMISSION_DEFINITIONS[id]; })
        .sort(function(a, b) { return _cfg_PERMISSION_DEFINITIONS[a].order - _cfg_PERMISSION_DEFINITIONS[b].order; });
    }

    function cfgRenderUserPermissionList() {
      var container = document.getElementById('cfg-userPermissionList');
      if (!container) return;
      var currentEmail = localStorage.getItem('reborn_user_email');
      var allPerms = Object.keys(_cfg_PERMISSION_DEFINITIONS).sort(function(a, b) { return _cfg_PERMISSION_DEFINITIONS[a].order - _cfg_PERMISSION_DEFINITIONS[b].order; });

      container.innerHTML = _cfg_usersData.map(function(user) {
        var isSelf = user.email === currentEmail && user.permissionId === 'owner';
        var options = allPerms.map(function(p) {
          return '<option value="' + p + '"' + (user.permissionId === p ? ' selected' : '') + '>' + _cfg_PERMISSION_DEFINITIONS[p].label + '</option>';
        }).join('');
        return '<div style="padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">' +
          '<div style="font-size: 14px; font-weight: 600; margin-bottom: 6px;">' + cfgEscapeHtml(user.userName) + '</div>' +
          '<select data-email="' + user.email + '" onchange="cfgUpdateUserPermission(this)" style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 14px;"' + (isSelf ? ' disabled' : '') + '>' + options + '</select></div>';
      }).join('');
    }

    function cfgUpdateUserPermission(sel) {
      var email = sel.dataset.email;
      var newPerm = sel.value;
      var user = _cfg_usersData.find(function(u) { return u.email === email; });
      if (user) { user.permissionId = newPerm; cfgRenderMenuPermissionList(); }
    }
    window.cfgUpdateUserPermission = cfgUpdateUserPermission;

    function cfgRenderMenuPermissionList() {
      var container = document.getElementById('cfg-menuPermissionList');
      if (!container) return;
      var activePerms = cfgGetActivePermissions().filter(function(id) { return id !== 'owner'; });

      // Simplified: show main menus only
      var mainMenus = _cfg_MENU_DEFINITIONS.filter(function(m) { return !m.isTopGroup && !m.isGroup; });
      var html = mainMenus.map(function(menu) {
        var perm = _cfg_menuPermissions[menu.id] || { visibleTo: menu.defaultOwnerOnly ? ['owner'] : ['owner'].concat(activePerms) };
        var toggles = activePerms.map(function(permId) {
          var isOn = perm.visibleTo && perm.visibleTo.includes(permId);
          return '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">' +
            '<div onclick="cfgToggleMenuPermission(\'' + menu.id + '\', \'' + permId + '\', this)" data-menu="' + menu.id + '" data-role="' + permId + '" data-on="' + isOn + '" style="width: 44px; height: 24px; background: ' + (isOn ? '#3b82f6' : '#d1d5db') + '; border-radius: 12px; position: relative; cursor: pointer;">' +
              '<div style="width: 20px; height: 20px; background: white; border-radius: 50%; position: absolute; top: 2px; transform: ' + (isOn ? 'translateX(20px)' : 'translateX(2px)') + '; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div></div>' +
            '<span style="font-size: 12px;">' + _cfg_PERMISSION_DEFINITIONS[permId].label + '</span></label>';
        }).join('');
        return '<div style="padding: 10px 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb; margin-bottom: 6px;">' +
          '<div style="font-size: 13px; font-weight: 600; margin-bottom: 8px;">' + menu.label + '</div>' +
          '<div style="display: flex; gap: 8px; flex-wrap: wrap;">' + toggles + '</div></div>';
      }).join('');
      container.innerHTML = html;
    }

    function cfgToggleMenuPermission(menuId, role, element) {
      var isOn = element.dataset.on === 'true';
      var newState = !isOn;
      element.dataset.on = String(newState);
      element.style.background = newState ? '#3b82f6' : '#d1d5db';
      element.querySelector('div').style.transform = newState ? 'translateX(20px)' : 'translateX(2px)';
      if (!_cfg_menuPermissions[menuId]) _cfg_menuPermissions[menuId] = { visibleTo: ['owner'] };
      var vis = _cfg_menuPermissions[menuId].visibleTo;
      if (newState && !vis.includes(role)) vis.push(role);
      else if (!newState && vis.includes(role)) { var idx = vis.indexOf(role); vis.splice(idx, 1); }
    }
    window.cfgToggleMenuPermission = cfgToggleMenuPermission;

    async function cfgSavePermissionSettings(showAlert) {
      if (!_cfg_permissionSettingsLoaded || !window.db) return true;
      try {
        var batch = window.db.batch();
        _cfg_usersData.forEach(function(user) {
          batch.update(window.db.collection('users').doc(user.email), {
            permissionId: user.permissionId,
            permissionDisplay: (_cfg_PERMISSION_DEFINITIONS[user.permissionId] || {}).label || user.permissionId
          });
        });
        batch.set(window.db.collection('settings').doc('menuPermissions'), _cfg_menuPermissions);
        await batch.commit();
        return true;
      } catch (e) {
        console.error('[config-fragment] permission save error:', e);
        if (showAlert) alert('æ¨©é™è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        return false;
      }
    }

    // ============================================
    // Permission Check (UI visibility)
    // ============================================

    async function cfgCheckUserPermissionAndUpdateUI() {
      try {
        var userEmail = localStorage.getItem('reborn_user_email');
        if (!userEmail || !window.db) return;
        var userDoc = await window.db.collection('users').doc(userEmail).get();
        if (!userDoc.exists) return;
        var permissionId = userDoc.data().permissionId || 'staff';
        localStorage.setItem('reborn_user_permission', permissionId);
        if (permissionId === 'owner') return; // Admin sees all

        // Hide restricted subtabs based on permission
        var menuPermDoc = await window.db.collection('settings').doc('menuPermissions').get();
        var menuPerms = menuPermDoc.exists ? menuPermDoc.data() : {};

        // System subtabs that are always owner-only
        ['cfg-system-users', 'cfg-system-compensation', 'cfg-system-permission'].forEach(function(tabId) {
          if (permissionId !== 'owner') {
            cfgHideSubtab(tabId);
          }
        });
      } catch (e) { console.error('[config-fragment] permission check error:', e); }
    }

    function cfgHideSubtab(targetId) {
      var pane = document.getElementById(targetId);
      if (pane) { pane.style.display = 'none'; pane.classList.remove('active'); }
      // Hide corresponding tab button
      var tabsContainers = ['cfg-productConfigTabs', 'cfg-systemConfigTabs'];
      tabsContainers.forEach(function(containerId) {
        var container = document.getElementById(containerId);
        if (!container) return;
        var btn = container.querySelector('[data-target="' + targetId + '"]');
        if (btn) btn.style.display = 'none';
      });
    }

    // ============================================
    // Shipping/Bank Info Modals
    // ============================================

    function cfgFormatPostalCode(input) {
      var value = input.value.replace(/[^0-9]/g, '');
      if (value.length > 3) value = value.slice(0, 3) + '-' + value.slice(3, 7);
      input.value = value;
    }
    window.cfgFormatPostalCode = cfgFormatPostalCode;

    async function cfgSearchShippingAddress() {
      var postalCode = document.getElementById('cfg-shippingPostalCode').value.replace(/-/g, '');
      if (postalCode.length !== 7) { alert('éƒµä¾¿ç•ªå·ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ7æ¡ï¼‰'); return; }
      try {
        var response = await fetch('https://zipcloud.ibsnet.co.jp/api/search?zipcode=' + postalCode);
        var data = await response.json();
        if (data.results && data.results.length > 0) {
          var result = data.results[0];
          document.getElementById('cfg-shippingPrefecture').value = result.address1;
          document.getElementById('cfg-shippingCity').value = result.address2 + result.address3;
        } else { alert('è©²å½“ã™ã‚‹ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'); }
      } catch (e) { alert('ä½æ‰€æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    }
    window.cfgSearchShippingAddress = cfgSearchShippingAddress;

    function cfgCloseShippingInfoModal() {
      var modal = document.getElementById('cfg-shippingInfoModal');
      if (modal) modal.classList.remove('active');
    }
    window.cfgCloseShippingInfoModal = cfgCloseShippingInfoModal;

    async function cfgSaveShippingInfo() {
      var userEmail = localStorage.getItem('reborn_user_email');
      if (!userEmail || !window.db) { alert('FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“'); return; }
      var info = {
        lastName: document.getElementById('cfg-shippingLastName').value.trim(),
        firstName: document.getElementById('cfg-shippingFirstName').value.trim(),
        postalCode: document.getElementById('cfg-shippingPostalCode').value.trim(),
        prefecture: document.getElementById('cfg-shippingPrefecture').value.trim(),
        city: document.getElementById('cfg-shippingCity').value.trim(),
        building: document.getElementById('cfg-shippingBuilding').value.trim()
      };
      if (!info.lastName || !info.firstName || !info.postalCode || !info.prefecture || !info.city) {
        alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return;
      }
      try {
        await window.db.collection('users').doc(userEmail).set({ shippingInfo: info }, { merge: true });
        alert('ç™ºé€å…ˆæƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        cfgCloseShippingInfoModal();
      } catch (e) { alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message); }
    }
    window.cfgSaveShippingInfo = cfgSaveShippingInfo;

    function cfgCloseBankAccountModal() {
      var modal = document.getElementById('cfg-bankAccountModal');
      if (modal) modal.classList.remove('active');
    }
    window.cfgCloseBankAccountModal = cfgCloseBankAccountModal;

    async function cfgSaveBankAccount() {
      var userEmail = localStorage.getItem('reborn_user_email');
      if (!userEmail || !window.db) { alert('FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“'); return; }
      var info = {
        bankName: document.getElementById('cfg-bankName').value.trim(),
        branchName: document.getElementById('cfg-bankBranch').value.trim(),
        accountType: document.getElementById('cfg-bankAccountType').value,
        accountNumber: document.getElementById('cfg-bankAccountNumber').value.trim(),
        accountHolder: document.getElementById('cfg-bankAccountHolder').value.trim()
      };
      if (!info.bankName || !info.branchName || !info.accountNumber || !info.accountHolder) {
        alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return;
      }
      try {
        await window.db.collection('users').doc(userEmail).set({ bankAccount: info }, { merge: true });
        alert('å£åº§æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        cfgCloseBankAccountModal();
      } catch (e) { alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message); }
    }
    window.cfgSaveBankAccount = cfgSaveBankAccount;

    // ============================================
    // User Icon Upload
    // ============================================

    async function cfgUploadUserIcon() {
      if (!_cfg_pendingUserIconData) return;
      try {
        var userEmail = localStorage.getItem('reborn_user_email');
        if (!userEmail || !window.db) return;
        await window.db.collection('users').doc(userEmail).set({ userIconUrl: _cfg_pendingUserIconData }, { merge: true });
        localStorage.setItem('reborn_user_icon_url', _cfg_pendingUserIconData);
        _cfg_pendingUserIconData = null;
      } catch (e) { console.error('[config-fragment] icon upload error:', e); }
    }

    // ============================================
    // Online Status
    // ============================================

    function cfgStartOnlineStatusUpdates() {
      var check = function() {
        if (!window.db) { setTimeout(check, 500); return; }
        cfgUpdateLastActiveAt();
        _cfg_onlineInterval = setInterval(cfgUpdateLastActiveAt, 3 * 60 * 1000);
      };
      check();
    }

    async function cfgUpdateLastActiveAt() {
      try {
        var email = localStorage.getItem('reborn_user_email');
        if (!email || !window.db) return;
        await window.db.collection('users').doc(email).update({ lastActiveAt: new Date().toISOString() });
      } catch (e) { /* ignore */ }
    }

    // ============================================
    // Utility
    // ============================================

    function cfgEscapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/[&<>"']/g, function(c) {
        return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c];
      });
    }

    function cfgGetPermissionBadgeHTML(permissionId) {
      var perm = _cfg_PERMISSION_DEFINITIONS[permissionId] || _cfg_PERMISSION_DEFINITIONS['staff'];
      return '<span style="display: inline-block; padding: 4px 12px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; font-weight: 500;">' + perm.label + '</span>';
    }

    // ============================================
    // Swipe gesture for subtabs
    // ============================================

    (function() {
      function setupSwipe(tabContentId, tabsId) {
        var tabContent = document.getElementById(tabContentId);
        if (!tabContent) return;

        var touchStartX = 0, touchStartY = 0;
        tabContent.addEventListener('touchstart', function(e) {
          touchStartX = e.changedTouches[0].screenX;
          touchStartY = e.changedTouches[0].screenY;
        }, { passive: true });

        tabContent.addEventListener('touchend', function(e) {
          var diffX = touchStartX - e.changedTouches[0].screenX;
          var diffY = touchStartY - e.changedTouches[0].screenY;
          if (Math.abs(diffX) < 50 || Math.abs(diffY) > Math.abs(diffX)) return;

          var tabsContainer = document.getElementById(tabsId);
          if (!tabsContainer) return;
          var tabs = Array.from(tabsContainer.querySelectorAll('.cfg-subtab'));
          var activeIdx = tabs.findIndex(function(t) { return t.classList.contains('active'); });
          if (activeIdx === -1) return;

          var nextIdx = diffX > 0 ? activeIdx + 1 : activeIdx - 1;
          if (nextIdx < 0 || nextIdx >= tabs.length) return;

          var target = tabs[nextIdx].getAttribute('data-target');
          cfgActivateSubtab(target);
        }, { passive: true });
      }

      // Defer setup until DOM is ready within fragment
      setTimeout(function() {
        setupSwipe('cfg-productConfigTabContent', 'cfg-productConfigTabs');
        setupSwipe('cfg-systemConfigTabContent', 'cfg-systemConfigTabs');
      }, 100);
    })();
  </script>
</div>
