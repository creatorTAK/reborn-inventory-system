<!-- SPA Fragment: config.html -->
<!-- Prefix: cfg- (CSS scoped, functions prefixed with cfg, variables with _cfg_) -->
<!-- Page keys: config-product, config-system, config-permission-users, config -->
<div id="spa-page-config">
  <style>
    #spa-page-config {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      background: #f5f6fa;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
      margin: 0;
      padding: 0;
    }

    #spa-page-config * {
      box-sizing: border-box;
    }

    /* ============================================ */
    /* サブヘッダー */
    /* ============================================ */
    #spa-page-config .sub-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: white;
      padding: 10px 16px;
      border-bottom: 1px solid #e0e0e0;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    #spa-page-config .sub-header .back-btn {
      background: none;
      border: none;
      font-size: 20px;
      color: #40B4E5;
      cursor: pointer;
      padding: 4px 8px;
    }

    #spa-page-config .sub-header .page-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }

    #spa-page-config .sub-header .header-icons {
      display: flex;
      gap: 8px;
    }

    #spa-page-config .sub-header .header-icons button {
      background: none;
      border: none;
      font-size: 18px;
      color: #6b7280;
      cursor: pointer;
      padding: 4px;
    }

    /* ============================================ */
    /* メインタブ（商品登録設定 / システム設定） */
    /* ============================================ */
    #spa-page-config .cfg-main-tabs {
      display: flex;
      background: white;
      border-bottom: 2px solid #e5e7eb;
      position: sticky;
      top: 44px;
      z-index: 99;
    }

    #spa-page-config .cfg-main-tabs .cfg-main-tab {
      flex: 1;
      text-align: center;
      padding: 12px 8px;
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
    }

    #spa-page-config .cfg-main-tabs .cfg-main-tab.active {
      color: #40B4E5;
      border-bottom-color: #40B4E5;
    }

    /* ============================================ */
    /* タブペイン */
    /* ============================================ */
    #spa-page-config .cfg-tab-pane {
      display: none;
    }

    #spa-page-config .cfg-tab-pane.active {
      display: block;
    }

    /* ============================================ */
    /* サブタブ（ナビゲーション）— マスタ管理と統一 */
    /* ============================================ */
    #spa-page-config .cfg-subtabs {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      background: #f8f9fa;
      border-bottom: none;
      padding: 8px 8px 0 8px;
      gap: 0;
      scrollbar-width: thin;
    }

    #spa-page-config .cfg-subtabs::-webkit-scrollbar {
      height: 4px;
    }

    #spa-page-config .cfg-subtabs::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 2px;
    }

    #spa-page-config .cfg-subtabs .cfg-subtab {
      flex-shrink: 0;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 500;
      color: #6c757d;
      border: 1px solid transparent;
      border-radius: 6px 6px 0 0;
      background: transparent;
      cursor: pointer;
      white-space: nowrap;
      margin-right: 4px;
      transition: all 0.2s;
    }

    #spa-page-config .cfg-subtabs .cfg-subtab:hover {
      background: #e9ecef;
      color: #495057;
    }

    #spa-page-config .cfg-subtabs .cfg-subtab.active {
      color: #212529;
      background: white;
      border-color: #dee2e6 #dee2e6 white;
      font-weight: 600;
    }

    /* ============================================ */
    /* サブタブコンテンツ */
    /* ============================================ */
    #spa-page-config .cfg-subtab-content {
      background: white;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    #spa-page-config .cfg-subtab-pane {
      display: none;
      padding: 16px;
    }

    #spa-page-config .cfg-subtab-pane.active {
      display: block;
    }

    /* ============================================ */
    /* 設定カード */
    /* ============================================ */
    #spa-page-config .config-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 0 0 100px 0;
    }

    #spa-page-config .cfg-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    #spa-page-config .cfg-card-title {
      font-size: 15px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #spa-page-config .cfg-card-desc {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 12px;
    }

    /* ============================================ */
    /* フォーム要素 */
    /* ============================================ */
    #spa-page-config .form-control {
      width: 100%;
      padding: 10px 12px;
      border: 1.5px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    #spa-page-config .form-control:focus {
      border-color: #40B4E5;
    }

    #spa-page-config select.form-control {
      background: white;
      cursor: pointer;
    }

    /* ============================================ */
    /* トグルスイッチ */
    /* ============================================ */
    #spa-page-config .cfg-toggle {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 28px;
    }

    #spa-page-config .cfg-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    #spa-page-config .cfg-toggle .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #e5e7eb;
      transition: 0.3s;
      border-radius: 28px;
    }

    #spa-page-config .cfg-toggle input:checked + .slider {
      background-color: #34C759;
    }

    #spa-page-config .cfg-toggle .slider::before {
      content: '';
      position: absolute;
      height: 24px;
      width: 24px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    #spa-page-config .cfg-toggle input:checked + .slider::before {
      transform: translateX(20px);
    }

    /* ============================================ */
    /* アコーディオン */
    /* ============================================ */
    #spa-page-config .cfg-accordion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 4px;
    }

    #spa-page-config .cfg-accordion-header .cfg-accordion-icon {
      transition: transform 0.2s;
      font-size: 12px;
      color: #9ca3af;
    }

    #spa-page-config .cfg-accordion-content {
      display: none;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-top: none;
      border-radius: 0 0 8px 8px;
      background: white;
    }

    #spa-page-config .cfg-accordion-content.open {
      display: block;
    }

    /* ============================================ */
    /* ボタン */
    /* ============================================ */
    #spa-page-config .cfg-btn-primary {
      background: #40B4E5;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    #spa-page-config .cfg-btn-primary:hover {
      background: #2da0d1;
    }

    #spa-page-config .cfg-btn-secondary {
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #d1d5db;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    #spa-page-config .cfg-btn-danger {
      background: #fee2e2;
      color: #dc2626;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    /* ============================================ */
    /* 保存ボタン（固定フッター） */
    /* ============================================ */
    #spa-page-config .cfg-save-footer {
      position: fixed;
      bottom: 82px;
      left: 0;
      right: 0;
      background: white;
      padding: 12px 16px;
      border-top: 1px solid #e5e7eb;
      z-index: 100;
      display: flex;
      justify-content: center;
    }

    #spa-page-config .cfg-save-footer .cfg-save-btn {
      width: 100%;
      max-width: 600px;
      padding: 14px;
      background: linear-gradient(135deg, #40B4E5 0%, #2196F3 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(64, 180, 229, 0.3);
    }

    /* ============================================ */
    /* モーダルオーバーレイ */
    /* ============================================ */
    #spa-page-config .cfg-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    #spa-page-config .cfg-modal-overlay.active {
      display: flex;
    }

    #spa-page-config .cfg-modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      max-height: 90vh;
      overflow-y: auto;
    }

    #spa-page-config .cfg-modal-header {
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #spa-page-config .cfg-modal-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }

    #spa-page-config .cfg-modal-close {
      background: none;
      border: none;
      font-size: 20px;
      color: #6b7280;
      cursor: pointer;
    }

    #spa-page-config .cfg-modal-body {
      padding: 16px;
    }

    /* ============================================ */
    /* 管理番号ビルダー */
    /* ============================================ */
    #spa-page-config .mnb-container {
      padding: 0;
    }

    #spa-page-config .mnb-section {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid #e5e7eb;
    }

    #spa-page-config .mnb-section-title {
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #spa-page-config .mnb-format-display {
      background: #f0f9ff;
      border: 2px solid #bae6fd;
      border-radius: 10px;
      padding: 14px;
      text-align: center;
      font-family: 'SF Mono', 'Menlo', 'Monaco', monospace;
      font-size: 18px;
      font-weight: 700;
      color: #0369a1;
      letter-spacing: 1px;
      margin-bottom: 8px;
      word-break: break-all;
    }

    #spa-page-config .mnb-part-card {
      border: 1.5px solid #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 8px;
      transition: border-color 0.2s;
    }

    #spa-page-config .mnb-part-card.enabled {
      border-color: #93c5fd;
    }

    #spa-page-config .mnb-part-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: #fafafa;
      border-bottom: 1px solid #e5e7eb;
    }

    #spa-page-config .mnb-part-body {
      padding: 10px 12px;
      display: none;
    }

    #spa-page-config .mnb-part-card.enabled .mnb-part-body {
      display: block;
    }

    #spa-page-config .mnb-toggle {
      position: relative;
      width: 44px;
      height: 24px;
      flex-shrink: 0;
    }

    #spa-page-config .mnb-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    #spa-page-config .mnb-toggle .mnb-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #e5e7eb;
      transition: 0.3s;
      border-radius: 24px;
    }

    #spa-page-config .mnb-toggle input:checked + .mnb-slider {
      background-color: #3b82f6;
    }

    #spa-page-config .mnb-toggle .mnb-slider::before {
      content: '';
      position: absolute;
      height: 20px;
      width: 20px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    #spa-page-config .mnb-toggle input:checked + .mnb-slider::before {
      transform: translateX(20px);
    }

    #spa-page-config .mnb-separator-selector {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    #spa-page-config .mnb-separator-btn {
      padding: 6px 14px;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: #374151;
      transition: all 0.2s;
    }

    #spa-page-config .mnb-separator-btn.active {
      background: #eff6ff;
      border-color: #3b82f6;
      color: #1d4ed8;
    }

    #spa-page-config .mnb-digits-control {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    #spa-page-config .mnb-digits-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1.5px solid #e5e7eb;
      background: white;
      font-size: 18px;
      font-weight: 600;
      color: #374151;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    #spa-page-config .mnb-digits-btn:hover {
      border-color: #3b82f6;
      color: #3b82f6;
    }

    #spa-page-config .mnb-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }

    #spa-page-config .mnb-modal-overlay.active {
      display: flex;
    }

    #spa-page-config .mnb-modal-content {
      background: white;
      border-radius: 12px;
      max-width: 400px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 20px;
    }

    #spa-page-config .mnb-category-btn {
      display: block;
      width: 100%;
      text-align: left;
      padding: 10px 14px;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-size: 13px;
      color: #374151;
      margin-bottom: 6px;
      transition: all 0.2s;
    }

    #spa-page-config .mnb-category-btn:hover {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    #spa-page-config .mnb-category-btn.selected {
      border-color: #3b82f6;
      background: #eff6ff;
      color: #1d4ed8;
      font-weight: 600;
    }

    /* ============================================ */
    /* プラットフォーム選択モーダル */
    /* ============================================ */
    #spa-page-config .platform-select-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    #spa-page-config .platform-select-modal.active {
      display: flex;
    }

    /* ============================================ */
    /* ユーザー管理・権限設定 */
    /* ============================================ */
    #spa-page-config .cfg-user-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    #spa-page-config .cfg-user-card:hover {
      background: #f3f4f6;
    }

    /* ============================================ */
    /* ユーザー詳細モーダル */
    /* ============================================ */
    #spa-page-config #cfg-userDetailModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }

    #spa-page-config #cfg-userDetailModal .cfg-modal-sheet {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 400px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
    }

    #spa-page-config #cfg-userDetailModal .cfg-modal-sheet-header {
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e5e7eb;
    }

    #spa-page-config #cfg-userDetailModal .cfg-modal-sheet-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    #spa-page-config #cfg-userDetailModal .cfg-modal-sheet-footer {
      padding: 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
      border-top: 1px solid #e5e7eb;
    }

    /* ============================================ */
    /* レスポンシブ */
    /* ============================================ */
    @media (max-width: 768px) {
      #spa-page-config .cfg-subtabs .cfg-subtab {
        font-size: 12px;
        padding: 8px 12px;
      }
    }
  </style>

  <!-- ============================================ -->
  <!-- サブヘッダー -->
  <!-- ============================================ -->
  <div class="sub-header">
    <button class="back-btn" id="cfg-back-button" onclick="spaGoBack()">
      <i class="bi bi-chevron-left"></i>
    </button>
    <span class="page-title" id="cfg-page-header-title">システム設定</span>
    <div class="header-icons">
      <!-- 将来の拡張用 -->
    </div>
  </div>

  <!-- ============================================ -->
  <!-- 設定コンテナ -->
  <!-- ============================================ -->
  <div class="config-container" id="cfg-configContainer">

    <!-- メインタブペイン: 商品登録設定 -->
    <div class="cfg-tab-pane" id="cfg-product">
      <!-- サブタブナビゲーション -->
      <div class="cfg-subtabs" id="cfg-productConfigTabs">
        <button class="cfg-subtab active" data-target="cfg-product-salesword"><i class="bi bi-chat-quote"></i> セールスワード</button>
        <button class="cfg-subtab" data-target="cfg-product-condition"><i class="bi bi-toggle-on"></i> 商品状態</button>
        <button class="cfg-subtab" data-target="cfg-product-hashtag"><i class="bi bi-tag"></i> ハッシュタグ</button>
        <button class="cfg-subtab" data-target="cfg-product-discount"><i class="bi bi-percent"></i> 割引</button>
        <button class="cfg-subtab" data-target="cfg-product-ai"><i class="bi bi-stars"></i> AI生成</button>
        <button class="cfg-subtab" data-target="cfg-product-order"><i class="bi bi-sort-numeric-down"></i> 配置順序</button>
      </div>
      <!-- サブタブコンテンツ -->
      <div id="cfg-productConfigTabContent" class="cfg-subtab-content">
        <!-- セールスワード設定 -->
        <div class="cfg-subtab-pane active" id="cfg-product-salesword">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-megaphone"></i> セールスワード設定</div>
            <div class="cfg-card-desc">商品説明に追加するセールスワードを設定します</div>
            <div id="cfg-saleswordConfigContainer">
              <div id="cfg-saleswordList" style="display: flex; flex-direction: column; gap: 8px;"></div>
              <button type="button" onclick="cfgAddSaleswordItem()" style="margin-top: 12px; padding: 10px; width: 100%; background: #f3f4f6; color: #374151; border: 2px dashed #d1d5db; border-radius: 8px; font-size: 13px; cursor: pointer;">
                <i class="bi bi-plus-lg"></i> セールスワードを追加
              </button>
            </div>
          </div>
          <!-- セールスワード形式設定 -->
          <div class="cfg-card" style="margin-top: 12px;">
            <div class="cfg-card-title"><i class="bi bi-gear"></i> セールスワード形式</div>
            <div style="margin-bottom: 12px;">
              <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">区切り文字</label>
              <select id="cfg-saleswordSeparator" class="form-control">
                <option value=" / "> / （スラッシュ）</option>
                <option value=" | "> | （パイプ）</option>
                <option value=" ・ "> ・ （中点）</option>
                <option value="  ">   （スペース）</option>
                <option value="\n">改行</option>
              </select>
            </div>
            <div>
              <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">括弧のスタイル</label>
              <select id="cfg-saleswordBracket" class="form-control">
                <option value="none">なし</option>
                <option value="round">（ ）丸括弧</option>
                <option value="square">[ ] 角括弧</option>
                <option value="angle">＜ ＞山括弧</option>
                <option value="emoji">✨ ✨ 装飾</option>
              </select>
            </div>
          </div>
        </div>

        <!-- 商品状態設定 -->
        <div class="cfg-subtab-pane" id="cfg-product-condition">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-check-circle"></i> 商品状態ボタン設定</div>
            <div class="cfg-card-desc">商品登録画面の状態ボタンをカスタマイズします</div>
            <div id="cfg-conditionButtonsContainer"></div>
            <button type="button" onclick="cfgAddConditionButton()" style="margin-top: 12px; padding: 10px; width: 100%; background: #f3f4f6; color: #374151; border: 2px dashed #d1d5db; border-radius: 8px; font-size: 13px; cursor: pointer;">
              <i class="bi bi-plus-lg"></i> ボタンを追加
            </button>
          </div>
        </div>

        <!-- ハッシュタグ設定 -->
        <div class="cfg-subtab-pane" id="cfg-product-hashtag">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-hash"></i> ハッシュタグ設定</div>
            <div class="cfg-card-desc">商品説明に自動追加するハッシュタグを設定します</div>
            <div id="cfg-hashtagConfigContainer"></div>
            <button type="button" onclick="cfgAddHashtagGroup()" style="margin-top: 12px; padding: 10px; width: 100%; background: #f3f4f6; color: #374151; border: 2px dashed #d1d5db; border-radius: 8px; font-size: 13px; cursor: pointer;">
              <i class="bi bi-plus-lg"></i> ハッシュタググループを追加
            </button>
            <!-- プレビュー -->
            <div style="margin-top: 16px; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
              <div style="font-size: 12px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">プレビュー</div>
              <div id="cfg-hashtagPreview" style="font-size: 13px; color: #374151; white-space: pre-line;"></div>
            </div>
          </div>
        </div>

        <!-- 割引設定 -->
        <div class="cfg-subtab-pane" id="cfg-product-discount">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-percent"></i> 割引設定</div>
            <div class="cfg-card-desc">商品説明に表示する割引情報を設定します</div>
            <div id="cfg-discountConfigContainer"></div>
            <button type="button" onclick="cfgAddDiscountBlock()" style="margin-top: 12px; padding: 10px; width: 100%; background: #f3f4f6; color: #374151; border: 2px dashed #d1d5db; border-radius: 8px; font-size: 13px; cursor: pointer;">
              <i class="bi bi-plus-lg"></i> 割引ブロックを追加
            </button>
            <!-- プレビュー -->
            <div style="margin-top: 16px; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
              <div style="font-size: 12px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">プレビュー</div>
              <div id="cfg-discountPreview" style="font-size: 13px; color: #374151; white-space: pre-line;"></div>
            </div>
          </div>
        </div>

        <!-- AI生成設定 -->
        <div class="cfg-subtab-pane" id="cfg-product-ai">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-stars"></i> AI生成設定</div>
            <div class="cfg-card-desc">AIによる商品説明文の生成設定をカスタマイズします</div>
            <!-- プリセット選択 -->
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">プリセット</label>
              <div id="cfg-aiPresetButtons" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
            </div>
            <!-- 詳細設定 -->
            <div id="cfg-aiDetailSettings">
              <div style="margin-bottom: 12px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">トーン</label>
                <select id="cfg-aiTone" class="form-control" onchange="cfgUpdateAiConfigPreview()">
                  <option value="casual">カジュアル</option>
                  <option value="formal">フォーマル</option>
                  <option value="friendly">フレンドリー</option>
                  <option value="professional">プロフェッショナル</option>
                </select>
              </div>
              <div style="margin-bottom: 12px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">長さ</label>
                <select id="cfg-aiLength" class="form-control" onchange="cfgUpdateAiConfigPreview()">
                  <option value="short">短め（50-100文字）</option>
                  <option value="medium">普通（100-200文字）</option>
                  <option value="long">長め（200-400文字）</option>
                </select>
              </div>
              <div style="margin-bottom: 12px;">
                <label style="display: flex; align-items: center; justify-content: space-between;">
                  <span style="font-size: 13px; font-weight: 500; color: #374151;">温度（創造性）</span>
                  <span id="cfg-aiTempDisplay" style="font-size: 13px; color: #6b7280;">0.7</span>
                </label>
                <input type="range" id="cfg-aiTemperature" min="0" max="1" step="0.1" value="0.7"
                  style="width: 100%; margin-top: 4px;"
                  oninput="cfgUpdateTempDisplay(this.value); cfgUpdateAiConfigPreview();">
              </div>
              <div style="margin-bottom: 12px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">追加指示（オプション）</label>
                <textarea id="cfg-aiCustomPrompt" class="form-control" rows="3" placeholder="例: 若い女性向けの表現を使ってください" onchange="cfgUpdateAiConfigPreview()"></textarea>
              </div>
            </div>
            <!-- AI設定プレビュー -->
            <div style="margin-top: 12px; padding: 12px; background: #f0f9ff; border-radius: 8px; border: 1px solid #bae6fd;">
              <div style="font-size: 12px; font-weight: 600; color: #0369a1; margin-bottom: 8px;">設定プレビュー</div>
              <div id="cfg-aiConfigPreview" style="font-size: 12px; color: #374151;"></div>
            </div>
            <div style="margin-top: 12px; text-align: right;">
              <button type="button" onclick="cfgClearAiSettings()" class="cfg-btn-secondary" style="font-size: 12px; padding: 6px 12px;">デフォルトに戻す</button>
            </div>
          </div>
        </div>

        <!-- 配置順序 -->
        <div class="cfg-subtab-pane" id="cfg-product-order">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-list-ol"></i> 説明文の配置順序</div>
            <div class="cfg-card-desc">商品説明文に表示する要素の順番と有効/無効を設定します。ドラッグで並び替えできます。</div>
            <div id="cfg-descriptionOrderList" style="display: flex; flex-direction: column; gap: 6px;"></div>
            <div style="margin-top: 12px; text-align: right;">
              <button type="button" onclick="cfgResetDescriptionOrder()" class="cfg-btn-secondary" style="font-size: 12px; padding: 6px 12px;">デフォルトに戻す</button>
            </div>
            <!-- プレビュー -->
            <div style="margin-top: 16px; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
              <div style="font-size: 12px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">配置プレビュー</div>
              <div id="cfg-descriptionOrderPreview" style="font-size: 12px; color: #374151; white-space: pre-line;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- メインタブペイン: システム設定 -->
    <div class="cfg-tab-pane" id="cfg-system">
      <!-- サブタブナビゲーション -->
      <div class="cfg-subtabs" id="cfg-systemConfigTabs">
        <button class="cfg-subtab active" data-target="cfg-system-basic"><i class="bi bi-person-circle"></i> 基本</button>
        <button class="cfg-subtab" data-target="cfg-system-management"><i class="bi bi-123"></i> 管理番号</button>
        <button class="cfg-subtab" data-target="cfg-system-shipping"><i class="bi bi-box-seam"></i> 配送</button>
        <button class="cfg-subtab" data-target="cfg-system-procure"><i class="bi bi-briefcase"></i> 仕入・出品</button>
        <button class="cfg-subtab" data-target="cfg-system-platform"><i class="bi bi-globe"></i> プラットフォーム</button>
        <button class="cfg-subtab" data-target="cfg-system-users"><i class="bi bi-people"></i> ユーザー管理</button>
        <button class="cfg-subtab" data-target="cfg-system-compensation"><i class="bi bi-currency-yen"></i> 報酬</button>
        <button class="cfg-subtab" data-target="cfg-system-permission"><i class="bi bi-shield-lock"></i> 権限</button>
      </div>
      <!-- サブタブコンテンツ -->
      <div id="cfg-systemConfigTabContent" class="cfg-subtab-content">
        <!-- 基本設定 -->
        <div class="cfg-subtab-pane active" id="cfg-system-basic">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-person-circle"></i> ユーザー設定</div>
            <div id="cfg-basicSettingsLoading" style="text-align: center; padding: 20px;">
              <div style="font-size: 14px; color: #6b7280;">読み込み中...</div>
            </div>
            <div id="cfg-basicSettingsContent" style="display: none;">
              <!-- アイコン -->
              <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                <div id="cfg-basicUserIconPreview" style="width: 56px; height: 56px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer;" onclick="document.getElementById('cfg-basicUserIconInput').click()">
                  <i class="bi bi-person-fill" style="font-size: 28px; color: #9ca3af;"></i>
                </div>
                <input type="file" id="cfg-basicUserIconInput" accept="image/*" style="display: none;">
                <div>
                  <div style="font-size: 13px; color: #6b7280;">プロフィール画像をタップで変更</div>
                </div>
              </div>
              <!-- ユーザー名 -->
              <div style="margin-bottom: 12px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">ユーザー名</label>
                <div style="position: relative;">
                  <input type="text" id="cfg-basicUserName" class="form-control" placeholder="ユーザー名を入力" style="font-size: 14px; padding-right: 32px;">
                  <button id="cfg-clearUserNameBtn" type="button" style="display: none; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #9ca3af; cursor: pointer; font-size: 16px;" onclick="document.getElementById('cfg-basicUserName').value=''; this.style.display='none';">
                    <i class="bi bi-x-circle-fill"></i>
                  </button>
                </div>
              </div>
              <!-- メール -->
              <div style="margin-bottom: 12px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">メールアドレス</label>
                <input type="email" id="cfg-basicUserEmail" class="form-control" disabled style="font-size: 14px; background: #f9fafb; color: #6b7280;">
              </div>
              <!-- 権限バッジ -->
              <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">権限</label>
                <span id="cfg-basicUserPermissionBadge"></span>
              </div>
              <!-- 通知設定 -->
              <div style="border-top: 1px solid #e5e7eb; padding-top: 12px;">
                <div style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 10px;">通知設定</div>
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                  <label for="cfg-basicNotificationEnabled" style="font-size: 13px; cursor: pointer;">プッシュ通知を有効にする</label>
                  <input type="checkbox" id="cfg-basicNotificationEnabled" checked style="width: 16px; height: 16px; cursor: pointer;">
                </div>
                <div style="display: flex; align-items: center; justify-content: space-between;">
                  <label for="cfg-basicNotificationSound" style="font-size: 13px; cursor: pointer;">通知音を有効にする</label>
                  <input type="checkbox" id="cfg-basicNotificationSound" checked style="width: 16px; height: 16px; cursor: pointer;">
                </div>
              </div>
              <!-- 保存ボタン -->
              <button type="button" onclick="cfgSaveBasicSettings()" style="margin-top: 16px; width: 100%; padding: 12px; background: #40B4E5; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
                基本設定を保存
              </button>
            </div>
          </div>
          <!-- 発送先情報 -->
          <div class="cfg-card" style="margin-top: 12px;" id="cfg-shippingInfoSection">
            <div class="cfg-card-title"><i class="bi bi-geo-alt"></i> 発送先情報</div>
            <div id="cfg-shippingInfoStatus" style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">未登録</div>
            <button type="button" onclick="cfgOpenShippingInfoModal()" style="width: 100%; padding: 10px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px; cursor: pointer;">
              <i class="bi bi-pencil"></i> 発送先情報を編集
            </button>
          </div>
          <!-- 口座情報 -->
          <div class="cfg-card" style="margin-top: 12px;" id="cfg-bankAccountSection">
            <div class="cfg-card-title"><i class="bi bi-bank"></i> 口座情報</div>
            <div id="cfg-bankAccountStatus" style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">未登録</div>
            <button type="button" onclick="cfgOpenBankAccountModal()" style="width: 100%; padding: 10px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px; cursor: pointer;">
              <i class="bi bi-pencil"></i> 口座情報を編集
            </button>
          </div>
        </div>

        <!-- 管理番号設定 -->
        <div class="cfg-subtab-pane" id="cfg-system-management">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-123"></i> 管理番号設定</div>
            <div class="cfg-card-desc">管理番号の自動生成ルールを設定します</div>
            <!-- ManagementNumberBuilder -->
            <div class="mnb-container" id="cfg-mnbContainer">
              <!-- プレビュー -->
              <div class="mnb-section">
                <div class="mnb-section-title">管理番号プレビュー</div>
                <div class="mnb-format-display" id="cfg-mnb-preview">---</div>
                <div style="text-align: center; font-size: 11px; color: #6b7280; margin-top: 4px;">
                  この形式で管理番号が自動生成されます
                </div>
              </div>

              <!-- パーツ設定 -->
              <div class="mnb-section">
                <div class="mnb-section-title">構成パーツ</div>

                <!-- カテゴリコード -->
                <div class="mnb-part-card enabled" id="cfg-mnb-part-category">
                  <div class="mnb-part-header">
                    <label class="mnb-toggle">
                      <input type="checkbox" checked onchange="cfgMnbTogglePart('category', this.checked)">
                      <span class="mnb-slider"></span>
                    </label>
                    <div style="flex: 1;">
                      <div style="font-size: 13px; font-weight: 600; color: #374151;">カテゴリコード</div>
                      <div style="font-size: 11px; color: #6b7280;">例: TP, BT, JK</div>
                    </div>
                  </div>
                  <div class="mnb-part-body">
                    <div style="margin-bottom: 8px;">
                      <label style="font-size: 12px; color: #6b7280;">カテゴリコードの取得元</label>
                      <select id="cfg-mnb-categorySource" class="form-control" style="margin-top: 4px;" onchange="cfgMnbUpdatePreview()">
                        <option value="master">マスタデータから自動取得</option>
                        <option value="manual">手動入力</option>
                      </select>
                    </div>
                    <button type="button" onclick="cfgMnbOpenCategoryModal()" style="width: 100%; padding: 8px; background: #eff6ff; color: #1d4ed8; border: 1px solid #bfdbfe; border-radius: 6px; font-size: 12px; cursor: pointer;">
                      カテゴリコード一覧を確認
                    </button>
                  </div>
                </div>

                <!-- 連番 -->
                <div class="mnb-part-card enabled" id="cfg-mnb-part-serial">
                  <div class="mnb-part-header">
                    <label class="mnb-toggle">
                      <input type="checkbox" checked onchange="cfgMnbTogglePart('serial', this.checked)">
                      <span class="mnb-slider"></span>
                    </label>
                    <div style="flex: 1;">
                      <div style="font-size: 13px; font-weight: 600; color: #374151;">連番</div>
                      <div style="font-size: 11px; color: #6b7280;">例: 001, 0001</div>
                    </div>
                  </div>
                  <div class="mnb-part-body">
                    <label style="font-size: 12px; color: #6b7280;">桁数</label>
                    <div class="mnb-digits-control" style="margin-top: 4px;">
                      <button type="button" class="mnb-digits-btn" onclick="cfgMnbChangeDigits(-1)">-</button>
                      <span id="cfg-mnb-serialDigits" style="font-size: 18px; font-weight: 700; color: #374151; min-width: 30px; text-align: center;">3</span>
                      <button type="button" class="mnb-digits-btn" onclick="cfgMnbChangeDigits(1)">+</button>
                    </div>
                  </div>
                </div>

                <!-- 日付コード -->
                <div class="mnb-part-card" id="cfg-mnb-part-date">
                  <div class="mnb-part-header">
                    <label class="mnb-toggle">
                      <input type="checkbox" onchange="cfgMnbTogglePart('date', this.checked)">
                      <span class="mnb-slider"></span>
                    </label>
                    <div style="flex: 1;">
                      <div style="font-size: 13px; font-weight: 600; color: #374151;">日付コード</div>
                      <div style="font-size: 11px; color: #6b7280;">例: 240115, 2401</div>
                    </div>
                  </div>
                  <div class="mnb-part-body">
                    <label style="font-size: 12px; color: #6b7280;">フォーマット</label>
                    <select id="cfg-mnb-dateFormat" class="form-control" style="margin-top: 4px;" onchange="cfgMnbUpdatePreview()">
                      <option value="YYMMDD">YYMMDD（例: 240115）</option>
                      <option value="YYMM">YYMM（例: 2401）</option>
                      <option value="MMDD">MMDD（例: 0115）</option>
                    </select>
                  </div>
                </div>

                <!-- イニシャル -->
                <div class="mnb-part-card" id="cfg-mnb-part-initial">
                  <div class="mnb-part-header">
                    <label class="mnb-toggle">
                      <input type="checkbox" onchange="cfgMnbTogglePart('initial', this.checked)">
                      <span class="mnb-slider"></span>
                    </label>
                    <div style="flex: 1;">
                      <div style="font-size: 13px; font-weight: 600; color: #374151;">担当者イニシャル</div>
                      <div style="font-size: 11px; color: #6b7280;">例: YT, KS</div>
                    </div>
                  </div>
                  <div class="mnb-part-body">
                    <label style="font-size: 12px; color: #6b7280;">イニシャルの取得元</label>
                    <select id="cfg-mnb-initialSource" class="form-control" style="margin-top: 4px;" onchange="cfgMnbUpdatePreview()">
                      <option value="auto">ログインユーザーから自動取得</option>
                      <option value="manual">手動入力</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- 区切り文字 -->
              <div class="mnb-section">
                <div class="mnb-section-title">区切り文字</div>
                <div class="mnb-separator-selector" id="cfg-mnb-separatorSelector">
                  <button type="button" class="mnb-separator-btn active" data-sep="-" onclick="cfgMnbSelectSeparator(this)">-（ハイフン）</button>
                  <button type="button" class="mnb-separator-btn" data-sep="_" onclick="cfgMnbSelectSeparator(this)">_（アンダーバー）</button>
                  <button type="button" class="mnb-separator-btn" data-sep="" onclick="cfgMnbSelectSeparator(this)">なし</button>
                </div>
              </div>

              <!-- パーツの並び順 -->
              <div class="mnb-section">
                <div class="mnb-section-title">パーツの並び順</div>
                <div id="cfg-mnb-partOrder" style="display: flex; flex-direction: column; gap: 6px;"></div>
              </div>

              <!-- 管理番号の配置設定 -->
              <div class="mnb-section">
                <div class="mnb-section-title">管理番号の配置</div>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="cfg-mnb-showInTitle" style="width: 16px; height: 16px; cursor: pointer;">
                    <label for="cfg-mnb-showInTitle" style="font-size: 13px; cursor: pointer; margin: 0;">商品名に表示</label>
                  </div>
                  <div id="cfg-mnb-titleFormatRow" style="display: none; margin-left: 26px;">
                    <label style="font-size: 12px; color: #6b7280;">形式</label>
                    <select id="cfg-mnb-titleFormat" class="form-control" style="margin-top: 4px;">
                      <option value="【】">【管理番号】</option>
                      <option value="[]">[管理番号]</option>
                      <option value="()">（管理番号）</option>
                      <option value="plain">管理番号（装飾なし）</option>
                    </select>
                  </div>
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="cfg-mnb-showInDescription" style="width: 16px; height: 16px; cursor: pointer;">
                    <label for="cfg-mnb-showInDescription" style="font-size: 13px; cursor: pointer; margin: 0;">説明文に表示</label>
                  </div>
                  <div id="cfg-mnb-descFormatRow" style="display: none; margin-left: 26px;">
                    <label style="font-size: 12px; color: #6b7280;">形式</label>
                    <select id="cfg-mnb-descFormat" class="form-control" style="margin-top: 4px;">
                      <option value="【】">【管理番号】</option>
                      <option value="[]">[管理番号]</option>
                      <option value="()">（管理番号）</option>
                      <option value="plain">管理番号（装飾なし）</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 配送設定 -->
        <div class="cfg-subtab-pane" id="cfg-system-shipping">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-truck"></i> 配送デフォルト設定</div>
            <div class="cfg-card-desc">商品登録時のデフォルト配送設定を設定します</div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">配送料の負担</label>
                <select id="cfg-配送料の負担" class="form-control">
                  <option value="">選択してください</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">配送の方法</label>
                <select id="cfg-配送の方法" class="form-control">
                  <option value="">選択してください</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">発送元の地域</label>
                <select id="cfg-発送元の地域" class="form-control">
                  <option value="">選択してください</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">発送までの日数</label>
                <select id="cfg-発送までの日数" class="form-control">
                  <option value="">選択してください</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- 仕入・出品設定 -->
        <div class="cfg-subtab-pane" id="cfg-system-procure">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-cart"></i> 仕入・出品デフォルト設定</div>
            <div class="cfg-card-desc">商品登録時の仕入・出品に関するデフォルト値を設定します</div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">仕入先</label>
                <select id="cfg-仕入先" class="form-control">
                  <option value="">選択してください</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">仕入日</label>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; cursor: pointer;">
                    <input type="radio" name="cfg-procureDateMode" value="today" checked onchange="cfgToggleProcureDateField(this.value)"> 今日の日付
                  </label>
                  <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; cursor: pointer;">
                    <input type="radio" name="cfg-procureDateMode" value="fixed" onchange="cfgToggleProcureDateField(this.value)"> 固定日付
                  </label>
                </div>
                <input type="date" id="cfg-仕入日" class="form-control" style="display: none; margin-top: 6px;">
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">出品先</label>
                <select id="cfg-出品先" class="form-control">
                  <option value="">選択してください</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">出品日</label>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; cursor: pointer;">
                    <input type="radio" name="cfg-listingDateMode" value="today" checked onchange="cfgToggleListingDateField(this.value)"> 今日の日付
                  </label>
                  <label style="display: flex; align-items: center; gap: 4px; font-size: 13px; cursor: pointer;">
                    <input type="radio" name="cfg-listingDateMode" value="fixed" onchange="cfgToggleListingDateField(this.value)"> 固定日付
                  </label>
                </div>
                <input type="date" id="cfg-出品日" class="form-control" style="display: none; margin-top: 6px;">
              </div>
            </div>
          </div>
        </div>

        <!-- プラットフォーム設定 -->
        <div class="cfg-subtab-pane" id="cfg-system-platform">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-grid"></i> プラットフォーム設定</div>
            <div class="cfg-card-desc">出品先プラットフォームの有効/無効を設定します</div>
            <!-- 登録モード -->
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">登録モード</label>
              <div style="display: flex; gap: 8px;">
                <label onclick="cfgSelectRegistrationMode('individual')" style="flex: 1; padding: 10px; border: 2px solid #40B4E5; border-radius: 8px; text-align: center; cursor: pointer; font-size: 13px; font-weight: 600; color: #374151; background: #f0f9ff;">
                  <input type="radio" name="cfg-registrationMode" id="cfg-modeIndividual" value="individual" checked style="display: none;">
                  個別登録
                </label>
                <label onclick="cfgSelectRegistrationMode('batch')" style="flex: 1; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; text-align: center; cursor: pointer; font-size: 13px; font-weight: 600; color: #374151;">
                  <input type="radio" name="cfg-registrationMode" id="cfg-modeBatch" value="batch" style="display: none;">
                  一括登録
                </label>
              </div>
            </div>
            <!-- プラットフォーム一覧 -->
            <div id="cfg-enabledPlatformsList"></div>
            <button type="button" onclick="cfgOpenPlatformSelectModal()" style="margin-top: 12px; padding: 10px; width: 100%; background: #f3f4f6; color: #374151; border: 2px dashed #d1d5db; border-radius: 8px; font-size: 13px; cursor: pointer;">
              <i class="bi bi-plus-lg"></i> プラットフォームを追加
            </button>
          </div>
        </div>

        <!-- ユーザー管理 -->
        <div class="cfg-subtab-pane" id="cfg-system-users">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-people"></i> ユーザー管理</div>
            <div id="cfg-userManagementLoading" style="text-align: center; padding: 40px;">
              <div style="font-size: 14px; color: #6b7280;">読み込み中...</div>
            </div>
            <div id="cfg-userManagementContent" style="display: none;">
              <!-- 検索 -->
              <div style="margin-bottom: 12px;">
                <input type="text" id="cfg-userSearchInput" oninput="cfgFilterUserList()" class="form-control" placeholder="ユーザー名・メールで検索..." style="font-size: 13px;">
              </div>
              <!-- 承認待ち -->
              <div id="cfg-pendingSection" style="display: none; margin-bottom: 16px;">
                <div onclick="cfgToggleSection('pending')" style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #fff7ed; border-radius: 8px; cursor: pointer; margin-bottom: 8px;">
                  <span style="font-size: 13px; font-weight: 600; color: #c2410c;">承認待ち</span>
                  <span id="cfg-pendingUsersCount" style="background: #ef4444; color: white; font-size: 11px; padding: 2px 8px; border-radius: 10px;">0</span>
                  <span id="cfg-pendingToggle" style="margin-left: auto; font-size: 10px; color: #6b7280;">▼</span>
                </div>
                <div id="cfg-pendingUsersList"></div>
              </div>
              <!-- 権限グループ -->
              <div id="cfg-permissionGroups"></div>
              <!-- 無効ユーザー -->
              <div id="cfg-inactiveSection" style="display: none; margin-top: 16px;">
                <div onclick="cfgToggleSection('inactive')" style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #f3f4f6; border-radius: 8px; cursor: pointer; margin-bottom: 8px;">
                  <span style="font-size: 13px; font-weight: 600; color: #6b7280;">無効ユーザー</span>
                  <span id="cfg-inactiveUsersCount" style="background: #6b7280; color: white; font-size: 11px; padding: 2px 8px; border-radius: 10px;">0</span>
                  <span id="cfg-inactiveToggle" style="margin-left: auto; font-size: 10px; color: #6b7280;">▶</span>
                </div>
                <div id="cfg-inactiveUsersList" style="display: none;"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- 報酬設定 -->
        <div class="cfg-subtab-pane" id="cfg-system-compensation">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-currency-yen"></i> タスク別報酬単価</div>
            <div class="cfg-card-desc">各タスクの1件あたりの報酬単価を設定します</div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                <div style="width: 40px; height: 40px; background: #dbeafe; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">📦</div>
                <div style="flex: 1; font-size: 14px; font-weight: 500; color: #374151;">商品出品</div>
                <div style="display: flex; align-items: center; gap: 4px;">
                  <span style="font-size: 14px; color: #6b7280;">¥</span>
                  <input type="number" id="cfg-compensation-listing" value="100" min="0" step="10" style="width: 80px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; text-align: right;">
                  <span style="font-size: 12px; color: #6b7280;">/件</span>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                <div style="width: 40px; height: 40px; background: #fef3c7; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">🚚</div>
                <div style="flex: 1; font-size: 14px; font-weight: 500; color: #374151;">梱包・発送</div>
                <div style="display: flex; align-items: center; gap: 4px;">
                  <span style="font-size: 14px; color: #6b7280;">¥</span>
                  <input type="number" id="cfg-compensation-shipping" value="100" min="0" step="10" style="width: 80px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; text-align: right;">
                  <span style="font-size: 12px; color: #6b7280;">/件</span>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                <div style="width: 40px; height: 40px; background: #d1fae5; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">📸</div>
                <div style="flex: 1; font-size: 14px; font-weight: 500; color: #374151;">商品撮影</div>
                <div style="display: flex; align-items: center; gap: 4px;">
                  <span style="font-size: 14px; color: #6b7280;">¥</span>
                  <input type="number" id="cfg-compensation-photography" value="50" min="0" step="10" style="width: 80px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; text-align: right;">
                  <span style="font-size: 12px; color: #6b7280;">/件</span>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                <div style="width: 40px; height: 40px; background: #fce7f3; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">🔍</div>
                <div style="flex: 1; font-size: 14px; font-weight: 500; color: #374151;">検品作業</div>
                <div style="display: flex; align-items: center; gap: 4px;">
                  <span style="font-size: 14px; color: #6b7280;">¥</span>
                  <input type="number" id="cfg-compensation-inspection" value="30" min="0" step="10" style="width: 80px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; text-align: right;">
                  <span style="font-size: 12px; color: #6b7280;">/件</span>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                <div style="width: 40px; height: 40px; background: #ede9fe; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">📋</div>
                <div style="flex: 1; font-size: 14px; font-weight: 500; color: #374151;">棚卸</div>
                <div style="display: flex; align-items: center; gap: 4px;">
                  <span style="font-size: 14px; color: #6b7280;">¥</span>
                  <input type="number" id="cfg-compensation-stocktaking" value="20" min="0" step="10" style="width: 80px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; text-align: right;">
                  <span style="font-size: 12px; color: #6b7280;">/件</span>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                <div style="width: 40px; height: 40px; background: #fef3c7; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">✏️</div>
                <div style="flex: 1; font-size: 14px; font-weight: 500; color: #374151;">追加編集</div>
                <div style="display: flex; align-items: center; gap: 4px;">
                  <span style="font-size: 14px; color: #6b7280;">¥</span>
                  <input type="number" id="cfg-compensation-editing" value="50" min="0" step="10" style="width: 80px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; text-align: right;">
                  <span style="font-size: 12px; color: #6b7280;">/件</span>
                </div>
              </div>
            </div>
            <!-- カスタムタスク -->
            <div id="cfg-customCompensationTasks" style="display: none; margin-top: 12px;">
              <div style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">カスタムタスク</div>
              <div id="cfg-customTasksContainer"></div>
            </div>
            <button type="button" onclick="cfgAddCustomCompensationTask()" style="margin-top: 12px; padding: 10px; width: 100%; background: #f3f4f6; color: #374151; border: 2px dashed #d1d5db; border-radius: 8px; font-size: 13px; cursor: pointer;">
              <i class="bi bi-plus-lg"></i> カスタムタスクを追加
            </button>
          </div>

          <!-- オプション設定 -->
          <div class="cfg-card" style="margin-top: 12px;">
            <div class="cfg-card-title">オプション設定</div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                <span style="font-size: 13px; color: #374151;">出品時に自動記録</span>
                <label class="cfg-toggle"><input type="checkbox" id="cfg-autoRecordListing" checked><span class="slider"></span></label>
              </label>
              <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                <span style="font-size: 13px; color: #374151;">発送時に自動記録</span>
                <label class="cfg-toggle"><input type="checkbox" id="cfg-autoRecordShipping" checked><span class="slider"></span></label>
              </label>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">締め日</label>
                <select id="cfg-compensationCutoffDay" class="form-control">
                  <option value="末日">末日</option>
                  <option value="15日">15日</option>
                  <option value="20日">20日</option>
                  <option value="25日">25日</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">支払日</label>
                <select id="cfg-compensationPaymentDay" class="form-control">
                  <option value="翌月5日">翌月5日</option>
                  <option value="翌月10日">翌月10日</option>
                  <option value="翌月15日">翌月15日</option>
                  <option value="翌月末日">翌月末日</option>
                </select>
              </div>
              <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                <span style="font-size: 13px; color: #374151;">経費として記録</span>
                <label class="cfg-toggle"><input type="checkbox" id="cfg-recordAsExpense" checked><span class="slider"></span></label>
              </label>
            </div>
          </div>

          <!-- ユーザー別タスク担当設定 -->
          <div class="cfg-card" style="margin-top: 12px;">
            <div class="cfg-card-title"><i class="bi bi-person-check"></i> ユーザー別タスク担当</div>
            <div class="cfg-card-desc">各ユーザーに担当タスクを割り当てます</div>
            <button type="button" onclick="cfgAssignAllTasksToAll()" style="margin-bottom: 12px; padding: 8px 16px; background: #eff6ff; color: #1d4ed8; border: 1px solid #bfdbfe; border-radius: 6px; font-size: 12px; cursor: pointer;">全員に全タスクを割り当て</button>
            <div id="cfg-userTaskAssignmentList" style="display: flex; flex-direction: column; gap: 8px;"></div>
          </div>

          <!-- 報酬管理へのリンク -->
          <div class="cfg-card" style="margin-top: 12px;">
            <button type="button" onclick="cfgOpenCompensationManagement()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #40B4E5 0%, #2196F3 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
              <i class="bi bi-arrow-right-circle"></i> 報酬管理画面を開く
            </button>
          </div>
        </div>

        <!-- 権限設定 -->
        <div class="cfg-subtab-pane" id="cfg-system-permission">
          <div class="cfg-card">
            <div class="cfg-card-title"><i class="bi bi-shield-lock"></i> 権限設定</div>
            <div class="cfg-card-desc">ユーザーの権限とメニューのアクセス制御を設定します</div>
            <div id="cfg-permissionSettingsLoading" style="text-align: center; padding: 40px;">
              <div style="font-size: 14px; color: #6b7280;">読み込み中...</div>
            </div>
            <div id="cfg-permissionSettingsContent" style="display: none;">
              <!-- ユーザー権限 -->
              <div style="margin-bottom: 20px;">
                <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">ユーザー権限</div>
                <div id="cfg-userPermissionList" style="display: flex; flex-direction: column; gap: 8px;"></div>
              </div>
              <!-- メニュー表示権限 -->
              <div>
                <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">メニュー表示権限</div>
                <div id="cfg-menuPermissionList"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 保存ボタン -->
  <div class="cfg-save-footer">
    <button class="cfg-save-btn" onclick="cfgSaveConfig()">
      <i class="bi bi-check-lg"></i> 設定を保存
    </button>
  </div>

  <!-- プラットフォーム選択モーダル -->
  <div class="cfg-modal-overlay" id="cfg-platformSelectModal">
    <div class="cfg-modal-content">
      <div class="cfg-modal-header">
        <h3>プラットフォームを追加</h3>
        <button class="cfg-modal-close" onclick="cfgClosePlatformSelectModal()">&times;</button>
      </div>
      <div class="cfg-modal-body">
        <div id="cfg-platformSelectList"></div>
      </div>
    </div>
  </div>

  <!-- プラットフォーム編集モーダル -->
  <div class="cfg-modal-overlay" id="cfg-platformEditModal">
    <div class="cfg-modal-content">
      <div class="cfg-modal-header">
        <h3>プラットフォームを編集</h3>
        <button class="cfg-modal-close" onclick="cfgClosePlatformEditModal()">&times;</button>
      </div>
      <div class="cfg-modal-body">
        <input type="hidden" id="cfg-editPlatformId">
        <div style="margin-bottom: 12px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">表示名</label>
          <input type="text" id="cfg-editPlatformName" class="form-control" placeholder="プラットフォーム名">
        </div>
        <div style="margin-bottom: 12px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">説明</label>
          <input type="text" id="cfg-editPlatformDesc" class="form-control" placeholder="簡単な説明">
        </div>
        <div style="margin-bottom: 12px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">アイコン</label>
          <div style="display: flex; align-items: center; gap: 12px;">
            <div id="cfg-platformIconPreview" style="width: 48px; height: 48px; border-radius: 8px; border: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; overflow: hidden;">
              <span style="color: #9ca3af; font-size: 12px;">未設定</span>
            </div>
            <div style="flex: 1;">
              <input type="file" id="cfg-platformIconInput" accept="image/*" onchange="cfgPreviewPlatformIcon(event)" style="font-size: 12px;">
              <div id="cfg-platformIconUploadStatus" style="font-size: 11px; margin-top: 4px;"></div>
            </div>
          </div>
        </div>
        <div style="display: flex; gap: 8px; margin-top: 16px;">
          <button type="button" onclick="cfgClosePlatformEditModal()" class="cfg-btn-secondary" style="flex: 1;">キャンセル</button>
          <button type="button" onclick="cfgSavePlatformEdit()" class="cfg-btn-primary" style="flex: 1;">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 発送先情報モーダル -->
  <div class="cfg-modal-overlay" id="cfg-shippingInfoModal">
    <div class="cfg-modal-content">
      <div class="cfg-modal-header">
        <h3>発送先情報を入力</h3>
        <button class="cfg-modal-close" onclick="cfgCloseShippingInfoModal()">&times;</button>
      </div>
      <div class="cfg-modal-body">
        <div style="display: flex; gap: 8px; margin-bottom: 16px;">
          <div style="flex: 1;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">姓<span style="color: #ef4444;">*</span></label>
            <input type="text" id="cfg-shippingLastName" class="form-control" placeholder="山田" maxlength="20">
          </div>
          <div style="flex: 1;">
            <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">名<span style="color: #ef4444;">*</span></label>
            <input type="text" id="cfg-shippingFirstName" class="form-control" placeholder="太郎" maxlength="20">
          </div>
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">郵便番号<span style="color: #ef4444;">*</span></label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <span style="font-size: 13px; color: #6b7280;">〒</span>
            <input type="text" id="cfg-shippingPostalCode" class="form-control" placeholder="000-0000" maxlength="8" style="width: 120px;" oninput="cfgFormatPostalCode(this)">
            <button type="button" onclick="cfgSearchShippingAddress()" style="background: #e5e7eb; color: #374151; border: none; padding: 6px 10px; border-radius: 6px; font-size: 11px; white-space: nowrap; cursor: pointer;">住所検索</button>
          </div>
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">都道府県<span style="color: #ef4444;">*</span></label>
          <input type="text" id="cfg-shippingPrefecture" class="form-control" placeholder="東京都" maxlength="10">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">市区町村・番地<span style="color: #ef4444;">*</span></label>
          <input type="text" id="cfg-shippingCity" class="form-control" placeholder="渋谷区渋谷1-2-3" maxlength="100">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">建物名・部屋番号</label>
          <input type="text" id="cfg-shippingBuilding" class="form-control" placeholder="フリラビル101号室（任意）" maxlength="100">
        </div>
        <div style="display: flex; gap: 8px;">
          <button type="button" onclick="cfgCloseShippingInfoModal()" class="cfg-btn-secondary" style="flex: 1;">キャンセル</button>
          <button type="button" onclick="cfgSaveShippingInfo()" class="cfg-btn-primary" style="flex: 1;">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 口座情報モーダル -->
  <div class="cfg-modal-overlay" id="cfg-bankAccountModal">
    <div class="cfg-modal-content">
      <div class="cfg-modal-header">
        <h3>口座情報を入力</h3>
        <button class="cfg-modal-close" onclick="cfgCloseBankAccountModal()">&times;</button>
      </div>
      <div class="cfg-modal-body">
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">銀行名<span style="color: #ef4444;">*</span></label>
          <input type="text" id="cfg-bankName" class="form-control" placeholder="例: 三菱UFJ銀行" maxlength="50">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">支店名<span style="color: #ef4444;">*</span></label>
          <input type="text" id="cfg-bankBranch" class="form-control" placeholder="例: 渋谷支店" maxlength="50">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">口座種別<span style="color: #ef4444;">*</span></label>
          <select id="cfg-bankAccountType" class="form-control">
            <option value="普通">普通</option>
            <option value="当座">当座</option>
          </select>
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">口座番号<span style="color: #ef4444;">*</span></label>
          <input type="text" id="cfg-bankAccountNumber" class="form-control" placeholder="1234567" maxlength="10" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;">口座名義（カタカナ）<span style="color: #ef4444;">*</span></label>
          <input type="text" id="cfg-bankAccountHolder" class="form-control" placeholder="例: ヤマダ タロウ" maxlength="50">
        </div>
        <div style="display: flex; gap: 8px;">
          <button type="button" onclick="cfgCloseBankAccountModal()" class="cfg-btn-secondary" style="flex: 1;">キャンセル</button>
          <button type="button" onclick="cfgSaveBankAccount()" class="cfg-btn-primary" style="flex: 1;">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ユーザー詳細モーダル -->
  <div id="cfg-userDetailModal">
    <div class="cfg-modal-sheet">
      <div class="cfg-modal-sheet-header">
        <span style="font-size: 16px; font-weight: 600;">ユーザー詳細</span>
        <button onclick="cfgCloseUserDetailModal()" style="background: none; border: none; font-size: 20px; color: #6b7280; cursor: pointer;">&times;</button>
      </div>
      <div class="cfg-modal-sheet-body" id="cfg-userDetailContent"></div>
      <div class="cfg-modal-sheet-footer" id="cfg-userDetailActions"></div>
    </div>
  </div>

  <!-- カテゴリコードモーダル（管理番号ビルダー用） -->
  <div class="mnb-modal-overlay" id="cfg-mnb-categoryModal">
    <div class="mnb-modal-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3 style="margin: 0; font-size: 16px; font-weight: 600;">カテゴリコード一覧</h3>
        <button onclick="cfgMnbCloseCategoryModal()" style="background: none; border: none; font-size: 20px; color: #6b7280; cursor: pointer;">&times;</button>
      </div>
      <div id="cfg-mnb-categoryList" style="display: flex; flex-direction: column; gap: 6px;"></div>
    </div>
  </div>

  <script>
    // ============================================
    // Config SPA Fragment - JavaScript
    // Prefix: cfg (functions), _cfg_ (variables)
    // ============================================

    // --- State Variables ---
    var _cfg_initialized = false;
    var _cfg_destroyed = false;
    var _cfg_onlineInterval = null;
    var _cfg_pendingUserIconData = null;
    var _cfg_customTaskCounter = 0;
    var _cfg_draggedElement = null;

    // Condition states & presets
    var _cfg_CONDITION_STATES = [
      { value: '新品、未使用', label: '新品・未使用', color: '#10b981' },
      { value: '未使用に近い', label: '未使用に近い', color: '#059669' },
      { value: '目立った傷や汚れなし', label: '目立った傷や汚れなし', color: '#3b82f6' },
      { value: 'やや傷や汚れあり', label: 'やや傷や汚れあり', color: '#f59e0b' },
      { value: '傷や汚れあり', label: '傷や汚れあり', color: '#ef4444' },
      { value: '全体的に状態が悪い', label: '全体的に状態が悪い', color: '#6b7280' }
    ];

    var _cfg_CONDITION_BUTTON_PRESETS = {
      'S（新品）': '新品、未使用',
      'A（未使用に近い）': '未使用に近い',
      'B（目立った傷なし）': '目立った傷や汚れなし',
      'C（やや傷あり）': 'やや傷や汚れあり',
      'D（傷あり）': '傷や汚れあり',
      'E（状態悪い）': '全体的に状態が悪い'
    };

    // Platform master data
    var _cfg_defaultPlatformDefs = [
      { id: 'mercari', name: 'メルカリ', description: 'フリマアプリ最大手', icon: 'https://asset.mercari.com/assets/img/common/touchicon/mercari.png' },
      { id: 'mercari-shops', name: 'メルカリShops', description: 'メルカリのECプラットフォーム', icon: 'https://asset.mercari.com/assets/img/common/touchicon/mercari.png' },
      { id: 'rakuma', name: 'ラクマ', description: '楽天のフリマアプリ', icon: '/Images/rakuma-icon.webp' },
      { id: 'yahoo-fleamarket', name: 'Yahoo!フリマ', description: 'Yahoo!のフリマサービス', icon: '/Images/yahoo-fleamarket-icon.webp' },
      { id: 'yahoo-auction', name: 'Yahoo!オークション', description: '日本最大のオークション', icon: '/Images/yahoo-auction-icon.webp' },
      { id: 'amazon', name: 'Amazon', description: '世界最大のECサイト', icon: '/Images/amazon-icon.webp' },
      { id: 'base', name: 'BASE', description: '無料ネットショップ作成', icon: '/Images/base-icon.webp' },
      { id: 'minne', name: 'minne', description: 'ハンドメイドマーケット', icon: '/Images/minne-icon.webp' },
      { id: 'stores', name: 'STORES', description: 'ネットショップ開設', icon: '/Images/stores-icon.webp' },
      { id: 'booth', name: 'BOOTH', description: 'クリエイターズマーケット', icon: '/Images/booth-icon.webp' }
    ];
    var _cfg_customPlatforms = [];
    var _cfg_enabledPlatformIds = ['mercari'];
    var _cfg_platformMaster = [];
    var _cfg_platformEdits = {};
    var _cfg_currentEditingPlatformId = null;
    var _cfg_pendingIconFile = null;

    // Config storage keys（旧版互換: rebornConfig_* キー）
    var _cfg_CONFIG_STORAGE_KEYS = {
      CONDITION_BUTTONS: 'rebornConfig_conditionButtons',
      HASHTAG: 'rebornConfig_hashtag',
      DISCOUNT: 'rebornConfig_discount',
      SHIPPING_DEFAULT: 'rebornConfig_shippingDefault',
      PROCURE_LISTING_DEFAULT: 'rebornConfig_procureListingDefault',
      MANAGEMENT_NUMBER: 'rebornConfig_managementNumber',
      SALESWORD: 'rebornConfig_salesword',
      AI_SETTINGS: 'rebornConfig_aiSettings',
      DESIGN_THEME: 'rebornTheme',
      IMAGE_SAVE: 'enableProductImageSave',
      PLATFORM: 'config_platform',
      DESCRIPTION_ORDER: 'config_descriptionOrder'
    };

    // Salesword
    var _cfg_SALESWORD_LIST = [];
    var _cfg_pendingSaleswordConfig = null; // マスタロード後の再描画用

    // Description elements (for order)
    var _cfg_DESCRIPTION_ELEMENTS = [
      { id: 'brand', label: 'ブランド情報', enabled: true },
      { id: 'color', label: 'カラー(詳細)', enabled: true },
      { id: 'size', label: 'サイズ情報', enabled: true },
      { id: 'material', label: '素材情報', enabled: true },
      { id: 'accessories', label: '付属品', enabled: true },
      { id: 'condition', label: '商品の状態', enabled: true },
      { id: 'ai', label: 'AI生成文', enabled: true },
      { id: 'management', label: '管理番号', enabled: true },
      { id: 'discount', label: '割引情報', enabled: true },
      { id: 'hashtag', label: 'ハッシュタグ', enabled: true }
    ];

    // Permission
    var _cfg_permissionSettingsLoaded = false;
    var _cfg_usersData = [];
    var _cfg_menuPermissions = {};
    var _cfg_allUsersData = [];

    var _cfg_PERMISSION_DEFINITIONS = {
      owner: { id: 'owner', label: '管理者', order: 1 },
      employee: { id: 'employee', label: '社員', order: 2 },
      staff: { id: 'staff', label: 'スタッフ', order: 3 },
      leader: { id: 'leader', label: 'リーダー', order: 4 },
      contractor: { id: 'contractor', label: '外注', order: 5 }
    };

    var _cfg_MENU_DEFINITIONS = [
      { id: 'product', label: '商品登録', defaultOwnerOnly: false },
      { id: 'inventory', label: '在庫管理', defaultOwnerOnly: false },
      { id: 'inventory_history', label: '入出庫履歴', defaultOwnerOnly: false },
      { id: 'stocktaking', label: '棚卸', defaultOwnerOnly: false },
      { id: 'purchase', label: '仕入管理', defaultOwnerOnly: false },
      { id: 'sales', label: '売上管理', defaultOwnerOnly: false },
      { id: 'accounting', label: '確定申告', defaultOwnerOnly: false },
      { id: 'compensation', label: '報酬管理', defaultOwnerOnly: false },
      // { id: 'pickup-management', label: '回収管理', defaultOwnerOnly: true }, // 一時的に非表示
      {
        id: 'master', label: 'マスタ管理', isTopGroup: true,
        children: [
          { id: 'master-product', label: '商品マスタ管理', isGroup: true, children: [
            { id: 'master-brand', label: 'ブランド', defaultOwnerOnly: false },
            { id: 'master-category', label: 'カテゴリ', defaultOwnerOnly: false },
            { id: 'master-size', label: 'サイズ', defaultOwnerOnly: false },
            { id: 'master-condition', label: '商品の状態', defaultOwnerOnly: false },
            { id: 'master-material', label: '素材', defaultOwnerOnly: false },
            { id: 'master-colorDetail', label: 'カラー(詳細)', defaultOwnerOnly: false },
            { id: 'master-accessory', label: '付属品', defaultOwnerOnly: false },
            { id: 'master-sizeLabel', label: 'サイズ(表記)', defaultOwnerOnly: false },
            { id: 'master-salesword', label: 'セールスワード', defaultOwnerOnly: false },
            { id: 'master-attribute', label: '商品属性', defaultOwnerOnly: false },
            { id: 'master-conditionRank', label: 'ランク', defaultOwnerOnly: false }
          ]},
          { id: 'master-business', label: '業務マスタ管理', isGroup: true, children: [
            { id: 'master-shipping', label: '発送方法', defaultOwnerOnly: false },
            { id: 'master-shippingBurden', label: '配送料の負担', defaultOwnerOnly: false },
            { id: 'master-shippingRegion', label: '発送元の地域', defaultOwnerOnly: false },
            { id: 'master-shippingDays', label: '発送までの日数', defaultOwnerOnly: false },
            { id: 'master-packaging', label: '梱包資材', defaultOwnerOnly: false },
            { id: 'master-supplier', label: '仕入先', defaultOwnerOnly: false },
            { id: 'master-marketplace', label: '出品先', defaultOwnerOnly: false },
            { id: 'master-managementNumber', label: '管理番号', defaultOwnerOnly: false }
          ]}
        ]
      },
      {
        id: 'config', label: '設定管理', isTopGroup: true,
        children: [
          { id: 'config-product', label: '商品登録設定', isGroup: true, children: [
            { id: 'product-salesword', label: 'セールスワード設定', defaultOwnerOnly: true },
            { id: 'product-condition', label: '商品状態設定', defaultOwnerOnly: true },
            { id: 'product-hashtag', label: 'ハッシュタグ設定', defaultOwnerOnly: true },
            { id: 'product-discount', label: '割引設定', defaultOwnerOnly: true },
            { id: 'product-ai', label: 'AI生成設定', defaultOwnerOnly: true },
            { id: 'product-order', label: '配置順序', defaultOwnerOnly: true }
          ]},
          { id: 'config-system', label: 'システム設定', isGroup: true, children: [
            { id: 'system-management', label: '管理番号設定', defaultOwnerOnly: true },
            { id: 'system-shipping', label: '配送設定', defaultOwnerOnly: true },
            { id: 'system-procure', label: '仕入・出品設定', defaultOwnerOnly: true },
            { id: 'system-platform', label: 'プラットフォーム', defaultOwnerOnly: true },
            { id: 'system-users', label: 'ユーザー管理', defaultOwnerOnly: true, alwaysOwnerOnly: true },
            { id: 'system-compensation', label: '報酬設定', defaultOwnerOnly: true, alwaysOwnerOnly: true },
            { id: 'system-permission', label: '権限設定', defaultOwnerOnly: true, alwaysOwnerOnly: true }
          ]}
        ]
      }
    ];

    // ManagementNumberBuilder state
    var _cfg_mnbSettings = {
      parts: { category: true, serial: true, date: false, initial: false },
      separator: '-',
      serialDigits: 3,
      dateFormat: 'YYMMDD',
      categorySource: 'master',
      initialSource: 'auto',
      partOrder: ['category', 'serial', 'date', 'initial'],
      categoryCodes: {}
    };

    // User task assignment
    var _cfg_userTaskAssignmentRetryCount = 0;
    var _cfg_USER_TASK_ASSIGNMENT_MAX_RETRIES = 5;
    window.cfgUserTaskAssignments = {};

    // ============================================
    // Lifecycle: initConfigPage / destroyConfigPage
    // ============================================

    function initConfigPage() {
      if (_cfg_initialized) {
        console.log('[config-fragment] Already initialized, skipping');
        return;
      }
      _cfg_initialized = true;
      _cfg_destroyed = false;
      console.log('[config-fragment] initConfigPage()');

      // Detect which tab to show based on SPA page key
      var currentPage = (typeof getCurrentSpaPage === 'function') ? getCurrentSpaPage() : 'config';
      var headerTitle = document.getElementById('cfg-page-header-title');

      if (currentPage === 'config-product') {
        cfgShowMainTab('product');
        if (headerTitle) headerTitle.textContent = '商品登録設定';
      } else if (currentPage === 'config-permission-users') {
        cfgShowMainTab('system');
        if (headerTitle) headerTitle.textContent = 'システム設定';
        // Activate users subtab after a tick + load data
        setTimeout(function() {
          cfgActivateSubtab('cfg-system-users');
          cfgLoadUserManagement();
        }, 50);
      } else {
        // config-system or config (default to system)
        cfgShowMainTab('system');
        if (headerTitle) headerTitle.textContent = 'システム設定';
      }

      // Setup subtab click handlers
      cfgSetupSubtabs();

      // Load all config
      cfgLoadAllConfig();

      // Initialize platform master
      _cfg_platformMaster = _cfg_defaultPlatformDefs.slice();

      // Load data from Firestore
      cfgInitFirestoreData();

      // Start online status updates
      cfgStartOnlineStatusUpdates();

      console.log('[config-fragment] initConfigPage() complete');
    }
    window.initConfigPage = initConfigPage;

    function destroyConfigPage() {
      console.log('[config-fragment] destroyConfigPage()');
      _cfg_initialized = false;
      _cfg_destroyed = true;

      // Clear online interval
      if (_cfg_onlineInterval) {
        clearInterval(_cfg_onlineInterval);
        _cfg_onlineInterval = null;
      }

      // Reset state
      _cfg_permissionSettingsLoaded = false;
      _cfg_usersData = [];
      _cfg_allUsersData = [];
      _cfg_SALESWORD_LIST = [];
      _cfg_pendingSaleswordConfig = null;
      _cfg_customTaskCounter = 0;
      _cfg_userTaskAssignmentRetryCount = 0;
    }
    window.destroyConfigPage = destroyConfigPage;

    // ============================================
    // Tab Switching (custom, no Bootstrap)
    // ============================================

    function cfgShowMainTab(tabName) {
      var productPane = document.getElementById('cfg-product');
      var systemPane = document.getElementById('cfg-system');
      if (!productPane || !systemPane) return;

      if (tabName === 'product') {
        productPane.classList.add('active');
        systemPane.classList.remove('active');
      } else {
        systemPane.classList.add('active');
        productPane.classList.remove('active');
      }
    }

    function cfgSetupSubtabs() {
      // Product subtabs
      var productTabs = document.querySelectorAll('#cfg-productConfigTabs .cfg-subtab');
      productTabs.forEach(function(tab) {
        tab.addEventListener('click', function() {
          cfgActivateSubtab(this.getAttribute('data-target'));
        });
      });

      // System subtabs
      var systemTabs = document.querySelectorAll('#cfg-systemConfigTabs .cfg-subtab');
      systemTabs.forEach(function(tab) {
        tab.addEventListener('click', function() {
          var target = this.getAttribute('data-target');
          cfgActivateSubtab(target);
          // Lazy load certain tabs
          if (target === 'cfg-system-permission') cfgLoadPermissionSettings();
          if (target === 'cfg-system-users') cfgLoadUserManagement();
          if (target === 'cfg-system-compensation') {
            cfgLoadCompensationSettingsFromFirestore();
            cfgLoadUserTaskAssignmentList();
          }
        });
      });
    }

    function cfgActivateSubtab(targetId) {
      if (!targetId) return;
      // Find parent tabs container
      var targetPane = document.getElementById(targetId);
      if (!targetPane) return;

      var parentContent = targetPane.parentElement;
      if (!parentContent) return;

      // Determine which tabs container
      var tabsContainerId = parentContent.id === 'cfg-productConfigTabContent' ? 'cfg-productConfigTabs' : 'cfg-systemConfigTabs';
      var tabsContainer = document.getElementById(tabsContainerId);
      if (!tabsContainer) return;

      // Deactivate all subtabs and panes in this group
      tabsContainer.querySelectorAll('.cfg-subtab').forEach(function(t) { t.classList.remove('active'); });
      parentContent.querySelectorAll('.cfg-subtab-pane').forEach(function(p) { p.classList.remove('active'); });

      // Activate target
      targetPane.classList.add('active');
      var targetTab = tabsContainer.querySelector('[data-target="' + targetId + '"]');
      if (targetTab) {
        targetTab.classList.add('active');
        targetTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      }
    }

    // ============================================
    // Firestore Data Loading
    // ============================================

    var _cfg_firestoreRetryCount = 0;
    async function cfgInitFirestoreData() {
      var db = (typeof getCompatDb === 'function') ? getCompatDb() : window.db;
      if (!db || typeof db.collection !== 'function') {
        _cfg_firestoreRetryCount++;
        if (_cfg_firestoreRetryCount < 10) {
          console.log('[config-fragment] Waiting for Firestore compat... (' + _cfg_firestoreRetryCount + ')');
          setTimeout(cfgInitFirestoreData, 500);
        }
        return;
      }

      try {
        // Load shipping dropdowns
        await Promise.all([
          cfgLoadShippingBurden(),
          cfgLoadShippingMethodCategories(),
          cfgLoadShippingRegions(),
          cfgLoadShippingDays()
        ]);

        // Load procure/listing dropdowns
        await cfgInitProcureListingDropdowns();

        // Load platforms from Firestore
        await cfgLoadPlatformsFromFirestore();

        // Load MNB category codes and settings
        await cfgMnbLoadCategoryCodes();
        cfgMnbLoadSettings();

        // Load platform settings
        var config = JSON.parse(localStorage.getItem('config') || '{}');
        cfgLoadPlatformSettings(config);

        // Load compensation
        await cfgLoadCompensationSettingsFromFirestore();

        // Check user permissions
        await cfgCheckUserPermissionAndUpdateUI();

        // Load salesword master
        await cfgLoadSaleswordMasterData();

        // Load basic settings (user profile, notifications)
        await cfgLoadBasicSettings();

        // Init user icon file handler
        cfgInitUserIconHandler();

        console.log('[config-fragment] Firestore data loaded');
      } catch (error) {
        console.error('[config-fragment] Firestore init error:', error);
      }
    }

    // ============================================
    // Config Load / Save (hybrid localStorage + Firestore)
    // ============================================

    async function cfgLoadAllConfig() {
      console.log('[config-fragment] Loading all config...');
      try {
        // 1. 旧版互換: rebornConfig_* 個別キーから読み込み（高速）
        var config = {};
        var cb = localStorage.getItem(_cfg_CONFIG_STORAGE_KEYS.CONDITION_BUTTONS);
        if (cb) config['商品状態ボタン'] = JSON.parse(cb);
        var ht = localStorage.getItem(_cfg_CONFIG_STORAGE_KEYS.HASHTAG);
        if (ht) config['ハッシュタグ'] = JSON.parse(ht);
        var dc = localStorage.getItem(_cfg_CONFIG_STORAGE_KEYS.DISCOUNT);
        if (dc) config['割引情報'] = JSON.parse(dc);
        var sd = localStorage.getItem(_cfg_CONFIG_STORAGE_KEYS.SHIPPING_DEFAULT);
        if (sd) config['配送デフォルト'] = JSON.parse(sd);
        var pl = localStorage.getItem(_cfg_CONFIG_STORAGE_KEYS.PROCURE_LISTING_DEFAULT);
        if (pl) config['仕入出品デフォルト'] = JSON.parse(pl);
        var mn = localStorage.getItem(_cfg_CONFIG_STORAGE_KEYS.MANAGEMENT_NUMBER);
        if (mn) config['管理番号設定'] = JSON.parse(mn);
        var sw = localStorage.getItem(_cfg_CONFIG_STORAGE_KEYS.SALESWORD);
        if (sw) config['よく使うセールスワード'] = JSON.parse(sw);
        var ai = localStorage.getItem(_cfg_CONFIG_STORAGE_KEYS.AI_SETTINGS);
        if (ai) config['AI生成設定'] = JSON.parse(ai);

        // config キーからプラットフォーム設定を読み込み
        var cfgObj = JSON.parse(localStorage.getItem('config') || '{}');
        if (cfgObj['プラットフォーム設定']) config['プラットフォーム設定'] = cfgObj['プラットフォーム設定'];
        // descriptionOrder は新キーから（旧版にはない）
        if (cfgObj.descriptionOrder) config.descriptionOrder = cfgObj.descriptionOrder;

        // 2. Firestore settings/common を確認（権威ソース）
        if (window.db) {
          try {
            var doc = await window.db.collection('settings').doc('common').get();
            if (doc.exists) {
              var fsConfig = doc.data();
              // Firestoreのフィールド名→日本語キー変換
              if (fsConfig.conditionButtons) config['商品状態ボタン'] = fsConfig.conditionButtons;
              if (fsConfig.hashtag) config['ハッシュタグ'] = fsConfig.hashtag;
              if (fsConfig.discount) config['割引情報'] = fsConfig.discount;
              if (fsConfig.shippingDefault) config['配送デフォルト'] = fsConfig.shippingDefault;
              if (fsConfig.procureListingDefault) config['仕入出品デフォルト'] = fsConfig.procureListingDefault;
              if (fsConfig.managementNumber) config['管理番号設定'] = fsConfig.managementNumber;
              if (fsConfig.salesword) config['よく使うセールスワード'] = fsConfig.salesword;
              if (fsConfig.aiSettings) config['AI生成設定'] = fsConfig.aiSettings;
              console.log('[config-fragment] Loaded config from Firestore settings/common');
            }
          } catch (e) {
            console.warn('[config-fragment] Firestore config load failed, using localStorage:', e);
          }
        }

        cfgRenderAllConfig(config);
      } catch (error) {
        console.error('[config-fragment] Config load error:', error);
      }
    }

    function cfgRenderAllConfig(config) {
      if (!config) config = {};

      // Condition buttons
      if (config['商品状態ボタン']) cfgRenderConditionButtons(config['商品状態ボタン']);
      else cfgRenderConditionButtons(null);

      // Hashtags
      if (config['ハッシュタグ']) cfgRenderHashtagConfig(config['ハッシュタグ']);

      // Discounts
      if (config['割引情報']) cfgRenderDiscountConfig(config['割引情報']);

      // AI settings
      if (config['AI生成設定']) cfgRenderAiSettings(config['AI生成設定']);
      else cfgApplyAiPreset('casual');

      // Shipping defaults
      if (config['配送デフォルト']) cfgRenderShippingDefaults(config['配送デフォルト']);

      // Procure/Listing defaults
      if (config['仕入出品デフォルト']) cfgRenderProcureListingDefaults(config['仕入出品デフォルト']);

      // Salesword（マスタ未ロード時は保留して後で再描画）
      if (config['よく使うセールスワード']) {
        if (_cfg_SALESWORD_LIST.length > 0) {
          cfgRenderSaleswordConfig(config['よく使うセールスワード']);
        } else {
          _cfg_pendingSaleswordConfig = config['よく使うセールスワード'];
        }
      }

      // Description order
      if (config.descriptionOrder) cfgRenderDescriptionOrder(config.descriptionOrder);
      else cfgRenderDescriptionOrder(null);

      // Platform
      if (config['プラットフォーム設定']) cfgLoadPlatformSettings(config);

      console.log('[config-fragment] All config rendered');
    }

    // 仕入・出品デフォルト設定をUIに反映
    function cfgRenderProcureListingDefaults(defaults) {
      if (!defaults) return;
      var el;
      el = document.getElementById('cfg-仕入先');
      if (el && defaults['仕入先']) el.value = defaults['仕入先'];
      el = document.getElementById('cfg-仕入日');
      if (el && defaults['仕入日']) el.value = defaults['仕入日'];
      if (defaults['仕入日モード'] === 'fixed') {
        var radio = document.querySelector('input[name="cfg-procureDateMode"][value="fixed"]');
        if (radio) { radio.checked = true; cfgToggleProcureDateField('fixed'); }
      }
      el = document.getElementById('cfg-出品先');
      if (el && defaults['出品先']) el.value = defaults['出品先'];
      el = document.getElementById('cfg-出品日');
      if (el && defaults['出品日']) el.value = defaults['出品日'];
      if (defaults['出品日モード'] === 'fixed') {
        var radio2 = document.querySelector('input[name="cfg-listingDateMode"][value="fixed"]');
        if (radio2) { radio2.checked = true; cfgToggleListingDateField('fixed'); }
      }
    }

    async function cfgSaveConfig() {
      console.log('[config-fragment] Saving config...');

      try {
        var managementConfig = cfgCollectManagementConfig();

        // アイコン画像をアップロード（選択されている場合）
        if (_cfg_pendingUserIconData) {
          await cfgUploadUserIcon();
        }

        // 画像管理設定をLocalStorageに保存
        var imageCheckbox = document.getElementById('cfg-enableProductImageSave');
        if (imageCheckbox) {
          localStorage.setItem(_cfg_CONFIG_STORAGE_KEYS.IMAGE_SAVE, imageCheckbox.checked.toString());
        }

        // 全設定を収集（旧版互換: 日本語キー）
        var newConfig = {
          '商品状態ボタン': cfgCollectConditionButtons(),
          'ハッシュタグ': cfgCollectHashtagConfig(),
          '割引情報': cfgCollectDiscountConfig(),
          '配送デフォルト': cfgCollectShippingDefaults(),
          '仕入出品デフォルト': cfgCollectProcureListingDefaults(),
          '管理番号設定': managementConfig,
          'よく使うセールスワード': cfgCollectSaleswordConfig(),
          'AI生成設定': cfgCollectAiSettings(),
          'デザインテーマ': '',
          'プラットフォーム設定': cfgCollectPlatformSettings()
        };

        // 1. localStorage に個別キーで保存（旧版互換: rebornConfig_*）
        cfgSaveConfigToLocalStorage(newConfig);
        console.log('[config-fragment] Saved to localStorage (rebornConfig_* keys)');

        // 2. Firestore settings/common に保存（旧版互換）
        cfgSaveConfigToFirestore(newConfig);

        // 3. 報酬設定を別途保存
        await cfgSaveCompensationSettings();

        // 4. ユーザー別タスク担当設定を保存
        await cfgSaveUserTaskAssignments();

        // 5. 権限設定を保存
        await cfgSavePermissionSettings(false);

        // 6. 設定変更を通知（postMessage + BroadcastChannel）
        cfgNotifyConfigChange();

        alert('設定を保存しました');
      } catch (error) {
        console.error('[config-fragment] Save error:', error);
        alert('保存に失敗しました: ' + error.message);
      }
    }
    window.cfgSaveConfig = cfgSaveConfig;

    // localStorage に旧版互換の個別キーで保存
    function cfgSaveConfigToLocalStorage(config) {
      try {
        localStorage.setItem(_cfg_CONFIG_STORAGE_KEYS.CONDITION_BUTTONS, JSON.stringify(config['商品状態ボタン']));
        localStorage.setItem(_cfg_CONFIG_STORAGE_KEYS.HASHTAG, JSON.stringify(config['ハッシュタグ']));
        localStorage.setItem(_cfg_CONFIG_STORAGE_KEYS.DISCOUNT, JSON.stringify(config['割引情報']));
        localStorage.setItem(_cfg_CONFIG_STORAGE_KEYS.SHIPPING_DEFAULT, JSON.stringify(config['配送デフォルト']));
        localStorage.setItem(_cfg_CONFIG_STORAGE_KEYS.PROCURE_LISTING_DEFAULT, JSON.stringify(config['仕入出品デフォルト']));
        localStorage.setItem(_cfg_CONFIG_STORAGE_KEYS.MANAGEMENT_NUMBER, JSON.stringify(config['管理番号設定']));
        localStorage.setItem('managementConfigTimestamp', Date.now().toString());
        localStorage.setItem(_cfg_CONFIG_STORAGE_KEYS.SALESWORD, JSON.stringify(config['よく使うセールスワード']));
        localStorage.setItem(_cfg_CONFIG_STORAGE_KEYS.AI_SETTINGS, JSON.stringify(config['AI生成設定']));
        if (config['デザインテーマ']) {
          localStorage.setItem(_cfg_CONFIG_STORAGE_KEYS.DESIGN_THEME, config['デザインテーマ']);
        }

        // プラットフォーム設定を config キーにも保存（product.html互換）
        var existing = JSON.parse(localStorage.getItem('config') || '{}');
        existing['プラットフォーム設定'] = config['プラットフォーム設定'];
        localStorage.setItem('config', JSON.stringify(existing));

        console.log('[config-fragment] localStorage保存完了（rebornConfig_* keys）');
        return true;
      } catch (e) {
        console.error('[config-fragment] localStorage保存エラー:', e);
        return false;
      }
    }

    // Firestore settings/common に旧版互換で保存
    function cfgSaveConfigToFirestore(config) {
      if (!window.db) {
        console.warn('[config-fragment] Firestore未初期化');
        return;
      }
      window.db.collection('settings').doc('common').set({
        conditionButtons: config['商品状態ボタン'] || [],
        hashtag: config['ハッシュタグ'] || {},
        discount: config['割引情報'] || {},
        shippingDefault: config['配送デフォルト'] || {},
        procureListingDefault: config['仕入出品デフォルト'] || {},
        managementNumber: config['管理番号設定'] || {},
        salesword: config['よく使うセールスワード'] || {},
        aiSettings: config['AI生成設定'] || {},
        designTheme: config['デザインテーマ'] || 'modern',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(function() {
        console.log('[config-fragment] Firestore settings/common 保存完了');
      }).catch(function(e) {
        console.warn('[config-fragment] Firestore保存エラー:', e);
      });
    }

    function cfgNotifyConfigChange() {
      try {
        // 同一ウィンドウ通知
        window.postMessage({ type: 'configChanged', timestamp: Date.now() }, '*');

        // BroadcastChannel で全タブに通知
        if ('BroadcastChannel' in window) {
          var channel = new BroadcastChannel('reborn_config_updates');
          channel.postMessage({ type: 'configChanged', timestamp: Date.now() });
          channel.close();
        }
      } catch (e) { /* ignore */ }
    }

    // 仕入・出品デフォルト値を収集
    function cfgCollectProcureListingDefaults() {
      return {
        '仕入先': (document.getElementById('cfg-仕入先') || {}).value || '',
        '仕入日モード': (document.querySelector('input[name="cfg-procureDateMode"]:checked') || {}).value || 'today',
        '仕入日': (document.getElementById('cfg-仕入日') || {}).value || '',
        '出品先': (document.getElementById('cfg-出品先') || {}).value || '',
        '出品日モード': (document.querySelector('input[name="cfg-listingDateMode"]:checked') || {}).value || 'today',
        '出品日': (document.getElementById('cfg-出品日') || {}).value || ''
      };
    }

    // ============================================
    // Condition Buttons
    // ============================================

    function cfgRenderConditionButtons(buttons) {
      var container = document.getElementById('cfg-conditionButtonsContainer');
      if (!container) return;
      container.innerHTML = '';

      if (!buttons || buttons.length === 0) {
        // Default buttons
        buttons = [
          { label: 'S', value: '新品、未使用' },
          { label: 'A', value: '未使用に近い' },
          { label: 'B', value: '目立った傷や汚れなし' },
          { label: 'C', value: 'やや傷や汚れあり' }
        ];
      }

      buttons.forEach(function(btn, index) {
        container.appendChild(cfgCreateButtonConfigItem(btn, index));
      });
    }

    function cfgCreateButtonConfigItem(btn, index) {
      var item = document.createElement('div');
      item.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 10px; background: #f9fafb; border-radius: 8px; margin-bottom: 6px;';
      item.dataset.index = index;

      var presetOptions = Object.keys(_cfg_CONDITION_BUTTON_PRESETS).map(function(key) {
        return '<option value="' + key + '"' + (btn.label === key.split('（')[0] ? ' selected' : '') + '>' + key + '</option>';
      }).join('');

      item.innerHTML =
        '<div style="flex: 1;">' +
          '<input type="text" class="cfg-btn-label-input form-control" value="' + (btn.label || '') + '" placeholder="ボタンラベル" style="margin-bottom: 4px; font-size: 13px;">' +
          '<select class="cfg-btn-value-select form-control" style="font-size: 12px;" onchange="cfgHandleLabelPresetChange(this)">' +
            '<option value="">-- プリセットから選択 --</option>' +
            presetOptions +
            '<option value="custom">カスタム...</option>' +
          '</select>' +
          '<input type="text" class="cfg-btn-value-input form-control" value="' + (btn.value || '') + '" placeholder="メルカリ上の状態値" style="margin-top: 4px; font-size: 12px; display: ' + (btn.value && !Object.values(_cfg_CONDITION_BUTTON_PRESETS).includes(btn.value) ? 'block' : 'none') + ';">' +
        '</div>' +
        '<button type="button" onclick="cfgRemoveConditionButton(this)" style="background: none; border: none; color: #ef4444; font-size: 18px; cursor: pointer; padding: 4px;"><i class="bi bi-trash"></i></button>';

      return item;
    }

    function cfgHandleLabelPresetChange(select) {
      var item = select.closest('[data-index]');
      if (!item) return;
      var customInput = item.querySelector('.cfg-btn-value-input');
      if (select.value === 'custom') {
        customInput.style.display = 'block';
      } else if (select.value) {
        customInput.style.display = 'none';
        customInput.value = _cfg_CONDITION_BUTTON_PRESETS[select.value] || '';
        // Auto-fill label
        var labelInput = item.querySelector('.cfg-btn-label-input');
        if (labelInput && !labelInput.value) {
          labelInput.value = select.value.split('（')[0];
        }
      }
    }
    window.cfgHandleLabelPresetChange = cfgHandleLabelPresetChange;

    function cfgAddConditionButton() {
      var container = document.getElementById('cfg-conditionButtonsContainer');
      if (!container) return;
      var index = container.children.length;
      container.appendChild(cfgCreateButtonConfigItem({ label: '', value: '' }, index));
    }
    window.cfgAddConditionButton = cfgAddConditionButton;

    function cfgRemoveConditionButton(btn) {
      var item = btn.closest('[data-index]');
      if (item) item.remove();
    }
    window.cfgRemoveConditionButton = cfgRemoveConditionButton;

    function cfgCollectConditionButtons() {
      var container = document.getElementById('cfg-conditionButtonsContainer');
      if (!container) return [];
      var buttons = [];
      container.querySelectorAll('[data-index]').forEach(function(item) {
        var label = item.querySelector('.cfg-btn-label-input').value.trim();
        var select = item.querySelector('.cfg-btn-value-select');
        var customInput = item.querySelector('.cfg-btn-value-input');
        var value = '';
        if (select.value === 'custom' || customInput.style.display !== 'none') {
          value = customInput.value.trim();
        } else if (select.value) {
          value = _cfg_CONDITION_BUTTON_PRESETS[select.value] || customInput.value.trim();
        } else {
          value = customInput.value.trim();
        }
        if (label || value) {
          buttons.push({ label: label, value: value });
        }
      });
      return buttons;
    }

    // ============================================
    // Hashtag Config
    // ============================================

    function cfgRenderHashtagConfig(hashtags) {
      var container = document.getElementById('cfg-hashtagConfigContainer');
      if (!container) return;
      container.innerHTML = '';

      if (!hashtags || !hashtags.groups) return;

      hashtags.groups.forEach(function(group, gIdx) {
        var groupDiv = document.createElement('div');
        groupDiv.className = 'cfg-card';
        groupDiv.style.cssText = 'padding: 12px; margin-bottom: 8px; border: 1px solid #e5e7eb;';
        groupDiv.dataset.groupIndex = gIdx;

        var tagsHtml = '';
        if (group.tags) {
          group.tags.forEach(function(tag, tIdx) {
            tagsHtml += '<div style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px;">' +
              '<span style="color: #6b7280; font-size: 13px;">#</span>' +
              '<input type="text" class="cfg-hashtag-input form-control" value="' + (tag || '') + '" placeholder="タグ名" style="font-size: 13px;" oninput="cfgUpdateHashtagPreview()">' +
              '<button type="button" onclick="cfgRemoveHashtag(this)" style="background: none; border: none; color: #ef4444; font-size: 14px; cursor: pointer;"><i class="bi bi-x-lg"></i></button>' +
            '</div>';
          });
        }

        groupDiv.innerHTML =
          '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">' +
            '<input type="text" class="cfg-hashtag-group-name form-control" value="' + (group.name || 'グループ ' + (gIdx + 1)) + '" placeholder="グループ名" style="font-size: 13px; font-weight: 600; max-width: 200px;">' +
            '<button type="button" onclick="cfgRemoveHashtagGroup(this)" style="background: none; border: none; color: #ef4444; font-size: 14px; cursor: pointer;"><i class="bi bi-trash"></i></button>' +
          '</div>' +
          '<div class="cfg-hashtag-tags">' + tagsHtml + '</div>' +
          '<button type="button" onclick="cfgAddHashtag(this)" style="margin-top: 6px; padding: 6px; width: 100%; background: #f9fafb; color: #6b7280; border: 1px dashed #d1d5db; border-radius: 6px; font-size: 12px; cursor: pointer;"><i class="bi bi-plus"></i> タグ追加</button>';

        container.appendChild(groupDiv);
      });

      cfgUpdateHashtagPreview();
    }

    function cfgAddHashtagGroup() {
      var container = document.getElementById('cfg-hashtagConfigContainer');
      if (!container) return;
      var gIdx = container.children.length;
      var group = { name: 'グループ ' + (gIdx + 1), tags: [''] };
      cfgRenderHashtagConfig({ groups: cfgCollectHashtagConfigGroups().concat([group]) });
    }
    window.cfgAddHashtagGroup = cfgAddHashtagGroup;

    function cfgCollectHashtagConfigGroups() {
      var container = document.getElementById('cfg-hashtagConfigContainer');
      if (!container) return [];
      var groups = [];
      container.querySelectorAll('[data-group-index]').forEach(function(groupDiv) {
        var name = groupDiv.querySelector('.cfg-hashtag-group-name').value.trim();
        var tags = [];
        groupDiv.querySelectorAll('.cfg-hashtag-input').forEach(function(input) {
          if (input.value.trim()) tags.push(input.value.trim());
        });
        groups.push({ name: name, tags: tags });
      });
      return groups;
    }

    function cfgRemoveHashtagGroup(btn) {
      var groupDiv = btn.closest('[data-group-index]');
      if (groupDiv) {
        groupDiv.remove();
        cfgUpdateHashtagPreview();
      }
    }
    window.cfgRemoveHashtagGroup = cfgRemoveHashtagGroup;

    function cfgAddHashtag(btn) {
      var tagsDiv = btn.parentElement.querySelector('.cfg-hashtag-tags');
      if (!tagsDiv) return;
      var tagHtml = '<div style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px;">' +
        '<span style="color: #6b7280; font-size: 13px;">#</span>' +
        '<input type="text" class="cfg-hashtag-input form-control" value="" placeholder="タグ名" style="font-size: 13px;" oninput="cfgUpdateHashtagPreview()">' +
        '<button type="button" onclick="cfgRemoveHashtag(this)" style="background: none; border: none; color: #ef4444; font-size: 14px; cursor: pointer;"><i class="bi bi-x-lg"></i></button>' +
      '</div>';
      tagsDiv.insertAdjacentHTML('beforeend', tagHtml);
    }
    window.cfgAddHashtag = cfgAddHashtag;

    function cfgRemoveHashtag(btn) {
      var tagDiv = btn.parentElement;
      if (tagDiv) {
        tagDiv.remove();
        cfgUpdateHashtagPreview();
      }
    }
    window.cfgRemoveHashtag = cfgRemoveHashtag;

    function cfgUpdateHashtagPreview() {
      var preview = document.getElementById('cfg-hashtagPreview');
      if (!preview) return;
      var groups = cfgCollectHashtagConfigGroups();
      var lines = [];
      groups.forEach(function(g) {
        g.tags.forEach(function(t) {
          if (t) lines.push('#' + t);
        });
      });
      preview.textContent = lines.join('\n') || '（ハッシュタグ未設定）';
    }
    window.cfgUpdateHashtagPreview = cfgUpdateHashtagPreview;

    function cfgCollectHashtagConfig() {
      return { groups: cfgCollectHashtagConfigGroups() };
    }

    // ============================================
    // Discount Config
    // ============================================

    function cfgRenderDiscountConfig(discounts) {
      var container = document.getElementById('cfg-discountConfigContainer');
      if (!container) return;
      container.innerHTML = '';

      if (!discounts || !discounts.blocks) return;

      discounts.blocks.forEach(function(block, idx) {
        var blockDiv = document.createElement('div');
        blockDiv.className = 'cfg-card';
        blockDiv.style.cssText = 'padding: 12px; margin-bottom: 8px; border: 1px solid #e5e7eb;';
        blockDiv.dataset.blockIndex = idx;
        blockDiv.innerHTML =
          '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">' +
            '<span style="font-size: 13px; font-weight: 600; color: #374151;">割引ブロック ' + (idx + 1) + '</span>' +
            '<button type="button" onclick="cfgRemoveDiscountBlock(this)" style="background: none; border: none; color: #ef4444; cursor: pointer;"><i class="bi bi-trash"></i></button>' +
          '</div>' +
          '<textarea class="cfg-discount-text form-control" rows="3" placeholder="割引情報を入力..." style="font-size: 13px;" oninput="cfgUpdateDiscountPreview()">' + (block.text || '') + '</textarea>';
        container.appendChild(blockDiv);
      });
      cfgUpdateDiscountPreview();
    }

    function cfgAddDiscountBlock() {
      var container = document.getElementById('cfg-discountConfigContainer');
      if (!container) return;
      var blocks = cfgCollectDiscountBlocks();
      blocks.push({ text: '' });
      cfgRenderDiscountConfig({ blocks: blocks });
    }
    window.cfgAddDiscountBlock = cfgAddDiscountBlock;

    function cfgRemoveDiscountBlock(btn) {
      var blockDiv = btn.closest('[data-block-index]');
      if (blockDiv) { blockDiv.remove(); cfgUpdateDiscountPreview(); }
    }
    window.cfgRemoveDiscountBlock = cfgRemoveDiscountBlock;

    function cfgCollectDiscountBlocks() {
      var container = document.getElementById('cfg-discountConfigContainer');
      if (!container) return [];
      var blocks = [];
      container.querySelectorAll('[data-block-index]').forEach(function(blockDiv) {
        var text = blockDiv.querySelector('.cfg-discount-text').value.trim();
        blocks.push({ text: text });
      });
      return blocks;
    }

    function cfgUpdateDiscountPreview() {
      var preview = document.getElementById('cfg-discountPreview');
      if (!preview) return;
      var blocks = cfgCollectDiscountBlocks();
      var texts = blocks.map(function(b) { return b.text; }).filter(function(t) { return t; });
      preview.textContent = texts.join('\n\n') || '（割引未設定）';
    }
    window.cfgUpdateDiscountPreview = cfgUpdateDiscountPreview;

    function cfgCollectDiscountConfig() {
      return { blocks: cfgCollectDiscountBlocks() };
    }

    // ============================================
    // Salesword Config
    // ============================================

    function cfgRenderSaleswordConfig(saleswordConfig) {
      var container = document.getElementById('cfg-saleswordList');
      if (!container) return;
      container.innerHTML = '';

      if (!saleswordConfig) return;

      // 旧形式（よく使う）対応
      if (saleswordConfig.よく使う && Array.isArray(saleswordConfig.よく使う)) {
        saleswordConfig.よく使う.forEach(function(word, idx) {
          var master = _cfg_SALESWORD_LIST.find(function(sw) { return sw.name === word; });
          if (master) {
            cfgAddSaleswordItemToDOM({ masterId: master.id, custom: null }, idx);
          } else {
            cfgAddSaleswordItemToDOM({ masterId: null, custom: word }, idx);
          }
        });
      } else if (saleswordConfig.items) {
        // 新形式（items）対応
        saleswordConfig.items.forEach(function(item, idx) {
          cfgAddSaleswordItemToDOM(item, idx);
        });
      }

      // 表示形式の復元
      if (saleswordConfig.表示形式) {
        var format = saleswordConfig.表示形式;
        if (format.separator) {
          var sep = document.getElementById('cfg-saleswordSeparator');
          if (sep) sep.value = format.separator;
        }
        if (format.bracket) {
          var bracketEl = document.getElementById('cfg-saleswordBracket');
          if (bracketEl) bracketEl.value = format.bracket;
        } else if (format.globalPrefix || format.globalSuffix) {
          // bracket未保存の場合、prefix/suffixから推定
          var bracketEl = document.getElementById('cfg-saleswordBracket');
          if (bracketEl) {
            if (format.globalPrefix === '（') bracketEl.value = 'round';
            else if (format.globalPrefix === '[') bracketEl.value = 'square';
            else if (format.globalPrefix === '＜') bracketEl.value = 'angle';
            else if (format.globalPrefix === '✨') bracketEl.value = 'emoji';
            else bracketEl.value = 'none';
          }
        }
      } else {
        // フラット形式（separator, bracket直下）
        if (saleswordConfig.separator) {
          var sep = document.getElementById('cfg-saleswordSeparator');
          if (sep) sep.value = saleswordConfig.separator;
        }
        if (saleswordConfig.bracket) {
          var bracketEl = document.getElementById('cfg-saleswordBracket');
          if (bracketEl) bracketEl.value = saleswordConfig.bracket;
        }
      }
    }

    function cfgAddSaleswordItemToDOM(item, idx) {
      var container = document.getElementById('cfg-saleswordList');
      if (!container) return;

      var div = document.createElement('div');
      div.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px; background: #f9fafb; border-radius: 8px;';
      div.dataset.saleswordIndex = idx !== undefined ? idx : container.children.length;

      var masterOptions = _cfg_SALESWORD_LIST.map(function(sw) {
        var selected = (item && item.masterId === sw.id) ? ' selected' : '';
        return '<option value="' + sw.id + '"' + selected + '>' + sw.name + '</option>';
      }).join('');

      div.innerHTML =
        '<select class="cfg-salesword-select form-control" style="flex: 1; font-size: 13px;">' +
          '<option value="">-- 選択 --</option>' +
          masterOptions +
          '<option value="custom">カスタム入力</option>' +
        '</select>' +
        '<input type="text" class="cfg-salesword-custom form-control" value="' + ((item && item.custom) || '') + '" placeholder="カスタムワード" style="flex: 1; font-size: 13px; display: ' + ((item && item.custom) ? 'block' : 'none') + ';">' +
        '<button type="button" onclick="cfgRemoveSaleswordItem(this)" style="background: none; border: none; color: #ef4444; font-size: 16px; cursor: pointer;"><i class="bi bi-x-lg"></i></button>';

      // Handle select change to show/hide custom input
      var select = div.querySelector('.cfg-salesword-select');
      var customInput = div.querySelector('.cfg-salesword-custom');
      select.addEventListener('change', function() {
        customInput.style.display = this.value === 'custom' ? 'block' : 'none';
      });

      container.appendChild(div);
    }

    function cfgAddSaleswordItem() {
      cfgAddSaleswordItemToDOM(null);
    }
    window.cfgAddSaleswordItem = cfgAddSaleswordItem;

    function cfgRemoveSaleswordItem(btn) {
      var div = btn.closest('[data-salesword-index]');
      if (div) div.remove();
    }
    window.cfgRemoveSaleswordItem = cfgRemoveSaleswordItem;

    function cfgCollectSaleswordConfig() {
      var container = document.getElementById('cfg-saleswordList');
      var words = [];

      if (container) {
        container.querySelectorAll('[data-salesword-index]').forEach(function(div) {
          var select = div.querySelector('.cfg-salesword-select');
          var customInput = div.querySelector('.cfg-salesword-custom');
          if (select.value === 'custom') {
            var customVal = customInput ? customInput.value.trim() : '';
            if (customVal) words.push(customVal);
          } else if (select.value) {
            var master = _cfg_SALESWORD_LIST.find(function(sw) { return sw.id === select.value; });
            words.push(master ? master.name : select.value);
          }
        });
      }

      var sepEl = document.getElementById('cfg-saleswordSeparator');
      var bracketEl = document.getElementById('cfg-saleswordBracket');
      var separator = sepEl ? sepEl.value : ' / ';
      var bracket = bracketEl ? bracketEl.value : 'none';

      var prefixMap = { 'none': '', 'round': '（', 'square': '[', 'angle': '＜', 'emoji': '✨' };
      var suffixMap = { 'none': '', 'round': '）', 'square': ']', 'angle': '＞', 'emoji': '✨' };

      return {
        よく使う: words,
        表示形式: {
          globalPrefix: prefixMap[bracket] || '',
          globalSuffix: suffixMap[bracket] || '',
          separator: separator,
          bracket: bracket,
          wordOverrides: []
        },
        デフォルト: {
          カテゴリ: '',
          セールスワード: ''
        }
      };
    }

    async function cfgLoadSaleswordMasterData() {
      if (!window.db) return;
      try {
        var snapshot = await window.db.collection('saleswords').orderBy('order', 'asc').get();
        _cfg_SALESWORD_LIST = [];
        snapshot.forEach(function(doc) {
          var data = doc.data();
          var category = data.category || doc.id;
          var words = data.words || [];
          // カテゴリ→ワード配列をフラットリストに変換
          words.forEach(function(word) {
            _cfg_SALESWORD_LIST.push({ id: category + '/' + word, name: word, category: category });
          });
        });
        console.log('[config-fragment] Salesword master loaded:', _cfg_SALESWORD_LIST.length);
        // マスタロード完了後、保留中のセールスワード設定を再描画
        if (_cfg_pendingSaleswordConfig) {
          cfgRenderSaleswordConfig(_cfg_pendingSaleswordConfig);
          _cfg_pendingSaleswordConfig = null;
        }
      } catch (e) {
        console.error('[config-fragment] Salesword master error:', e);
      }
    }

    // ============================================
    // AI Settings
    // ============================================

    function cfgRenderAiSettings(ai) {
      if (!ai) return;
      var tone = document.getElementById('cfg-aiTone');
      var length = document.getElementById('cfg-aiLength');
      var temp = document.getElementById('cfg-aiTemperature');
      var prompt = document.getElementById('cfg-aiCustomPrompt');

      if (tone && ai.tone) tone.value = ai.tone;
      if (length && ai.length) length.value = ai.length;
      if (temp && ai.temperature !== undefined) {
        temp.value = ai.temperature;
        cfgUpdateTempDisplay(ai.temperature);
      }
      if (prompt && ai.customPrompt) prompt.value = ai.customPrompt;

      cfgRenderAiPresetButtons(ai.preset || null);
      cfgUpdateAiConfigPreview();
    }

    function cfgRenderAiPresetButtons(activePreset) {
      var container = document.getElementById('cfg-aiPresetButtons');
      if (!container) return;
      var presets = [
        { id: 'casual', label: 'カジュアル' },
        { id: 'formal', label: 'フォーマル' },
        { id: 'friendly', label: 'フレンドリー' },
        { id: 'professional', label: 'プロ' },
        { id: 'detailed', label: '詳細' },
        { id: 'minimal', label: 'シンプル' }
      ];
      container.innerHTML = presets.map(function(p) {
        var isActive = activePreset === p.id;
        return '<button type="button" onclick="cfgApplyAiPreset(\'' + p.id + '\')" style="padding: 6px 12px; border: 1.5px solid ' + (isActive ? '#40B4E5' : '#e5e7eb') + '; border-radius: 6px; background: ' + (isActive ? '#f0f9ff' : 'white') + '; color: ' + (isActive ? '#0369a1' : '#374151') + '; font-size: 12px; font-weight: 500; cursor: pointer;">' + p.label + '</button>';
      }).join('');
    }

    function cfgApplyAiPreset(presetId) {
      var presets = {
        casual: { tone: 'casual', length: 'medium', temperature: 0.7, customPrompt: '' },
        formal: { tone: 'formal', length: 'medium', temperature: 0.3, customPrompt: '' },
        friendly: { tone: 'friendly', length: 'medium', temperature: 0.8, customPrompt: '' },
        professional: { tone: 'professional', length: 'long', temperature: 0.5, customPrompt: '' },
        detailed: { tone: 'formal', length: 'long', temperature: 0.4, customPrompt: '商品の特徴を詳しく説明してください' },
        minimal: { tone: 'casual', length: 'short', temperature: 0.6, customPrompt: '' }
      };

      var preset = presets[presetId] || presets.casual;
      var tone = document.getElementById('cfg-aiTone');
      var length = document.getElementById('cfg-aiLength');
      var temp = document.getElementById('cfg-aiTemperature');
      var prompt = document.getElementById('cfg-aiCustomPrompt');

      if (tone) tone.value = preset.tone;
      if (length) length.value = preset.length;
      if (temp) { temp.value = preset.temperature; cfgUpdateTempDisplay(preset.temperature); }
      if (prompt) prompt.value = preset.customPrompt;

      cfgRenderAiPresetButtons(presetId);
      cfgUpdateAiConfigPreview();
    }
    window.cfgApplyAiPreset = cfgApplyAiPreset;

    function cfgUpdateTempDisplay(val) {
      var el = document.getElementById('cfg-aiTempDisplay');
      if (el) el.textContent = parseFloat(val).toFixed(1);
    }
    window.cfgUpdateTempDisplay = cfgUpdateTempDisplay;

    function cfgUpdateAiConfigPreview() {
      var preview = document.getElementById('cfg-aiConfigPreview');
      if (!preview) return;
      var tone = document.getElementById('cfg-aiTone');
      var length = document.getElementById('cfg-aiLength');
      var temp = document.getElementById('cfg-aiTemperature');
      var prompt = document.getElementById('cfg-aiCustomPrompt');

      var lines = [];
      if (tone && tone.selectedIndex >= 0) lines.push('トーン: ' + tone.options[tone.selectedIndex].text);
      if (length && length.selectedIndex >= 0) lines.push('長さ: ' + length.options[length.selectedIndex].text);
      if (temp) lines.push('温度: ' + parseFloat(temp.value).toFixed(1));
      if (prompt && prompt.value.trim()) lines.push('追加指示: ' + prompt.value.trim());
      preview.textContent = lines.join(' | ');
    }
    window.cfgUpdateAiConfigPreview = cfgUpdateAiConfigPreview;

    function cfgClearAiSettings() {
      if (!confirm('AI生成設定をデフォルトに戻しますか？')) return;
      cfgApplyAiPreset('casual');
      alert('AI生成設定をデフォルト（カジュアル）に戻しました。');
    }
    window.cfgClearAiSettings = cfgClearAiSettings;

    function cfgCollectAiSettings() {
      var tone = document.getElementById('cfg-aiTone');
      var length = document.getElementById('cfg-aiLength');
      var temp = document.getElementById('cfg-aiTemperature');
      var prompt = document.getElementById('cfg-aiCustomPrompt');
      return {
        tone: tone ? tone.value : 'casual',
        length: length ? length.value : 'medium',
        temperature: temp ? parseFloat(temp.value) : 0.7,
        customPrompt: prompt ? prompt.value.trim() : ''
      };
    }

    // ============================================
    // Shipping Defaults
    // ============================================

    function cfgRenderShippingDefaults(defaults) {
      if (!defaults) return;
      var fields = ['配送料の負担', '配送の方法', '発送元の地域', '発送までの日数'];
      fields.forEach(function(field) {
        var el = document.getElementById('cfg-' + field);
        if (el && defaults[field]) el.value = defaults[field];
      });
    }

    function cfgCollectShippingDefaults() {
      var result = {};
      var fields = ['配送料の負担', '配送の方法', '発送元の地域', '発送までの日数'];
      fields.forEach(function(field) {
        var el = document.getElementById('cfg-' + field);
        if (el) result[field] = el.value;
      });
      return result;
    }

    function cfgCollectManagementConfig() {
      var data = Object.assign({}, _cfg_mnbSettings);

      // 配置設定を追加
      var showInTitle = document.getElementById('cfg-mnb-showInTitle');
      var showInDesc = document.getElementById('cfg-mnb-showInDescription');
      var titleFormat = document.getElementById('cfg-mnb-titleFormat');
      var descFormat = document.getElementById('cfg-mnb-descFormat');

      data.showInTitle = showInTitle ? showInTitle.checked : false;
      data.showInDescription = showInDesc ? showInDesc.checked : false;
      data.titleFormat = titleFormat ? titleFormat.value : '【】';
      data.titlePosition = 'end';
      data.descFormat = descFormat ? descFormat.value : '【】';
      data.descPosition = 'order';

      // managementNumberPlacement をlocalStorageに保存（product.html互換）
      try {
        var placementSettings = {
          inTitle: data.showInTitle,
          inDesc: data.showInDescription,
          format: data.titleFormat,
          position: data.titlePosition,
          descFormat: data.descFormat,
          descPosition: data.descPosition
        };
        localStorage.setItem('managementNumberPlacement', JSON.stringify(placementSettings));
      } catch (e) { console.error('managementNumberPlacement保存エラー:', e); }

      return data;
    }

    // ============================================
    // Shipping Dropdown Loading (Firestore)
    // ============================================

    async function cfgLoadShippingBurden() {
      if (!window.db) return;
      try {
        var snapshot = await window.db.collection('shippingBurden').orderBy('displayOrder', 'asc').get();
        var select = document.getElementById('cfg-配送料の負担');
        if (!select) return;
        while (select.options.length > 1) select.remove(1);
        snapshot.forEach(function(doc) {
          var data = doc.data();
          var opt = document.createElement('option');
          opt.value = data.name || data.value || doc.id;
          opt.textContent = opt.value;
          select.appendChild(opt);
        });
      } catch (e) { console.error('[config-fragment] shippingBurden error:', e); }
    }

    async function cfgLoadShippingMethodCategories() {
      if (!window.db) return;
      try {
        var snapshot = await window.db.collection('shippingMethods')
          .where('platform', 'in', ['mercari', 'mercari-shops'])
          .orderBy('order', 'asc').get();
        var select = document.getElementById('cfg-配送の方法');
        if (!select) return;
        while (select.options.length > 1) select.remove(1);
        var added = new Set();
        snapshot.forEach(function(doc) {
          var name = doc.data().category || doc.id;
          if (!added.has(name)) {
            added.add(name);
            var opt = document.createElement('option');
            opt.value = name; opt.textContent = name;
            select.appendChild(opt);
          }
        });
      } catch (e) { console.error('[config-fragment] shippingMethods error:', e); }
    }

    async function cfgLoadShippingRegions() {
      if (!window.db) return;
      try {
        var snapshot = await window.db.collection('shippingRegion').orderBy('displayOrder', 'asc').get();
        var select = document.getElementById('cfg-発送元の地域');
        if (!select) return;
        while (select.options.length > 1) select.remove(1);
        snapshot.forEach(function(doc) {
          var data = doc.data();
          var opt = document.createElement('option');
          opt.value = data.name || data.value || doc.id;
          opt.textContent = opt.value;
          select.appendChild(opt);
        });
      } catch (e) { console.error('[config-fragment] shippingRegion error:', e); }
    }

    async function cfgLoadShippingDays() {
      if (!window.db) return;
      try {
        var snapshot = await window.db.collection('shippingDays').where('platform', '==', 'mercari').get();
        var select = document.getElementById('cfg-発送までの日数');
        if (!select) return;
        while (select.options.length > 1) select.remove(1);
        var items = [];
        snapshot.forEach(function(doc) {
          var data = doc.data();
          items.push({ name: data.name || data.value || doc.id, order: data.displayOrder || data.order || 999 });
        });
        items.sort(function(a, b) { return a.order - b.order; });
        var added = new Set();
        items.forEach(function(item) {
          if (!added.has(item.name)) {
            added.add(item.name);
            var opt = document.createElement('option');
            opt.value = item.name; opt.textContent = item.name;
            select.appendChild(opt);
          }
        });
      } catch (e) { console.error('[config-fragment] shippingDays error:', e); }
    }

    // ============================================
    // Procure/Listing Dropdowns
    // ============================================

    async function cfgInitProcureListingDropdowns() {
      if (!window.db) return;
      try {
        // 仕入先
        var supplierSnap = await window.db.collection('suppliers').orderBy('displayOrder', 'asc').get();
        var supplierSelect = document.getElementById('cfg-仕入先');
        if (supplierSelect) {
          while (supplierSelect.options.length > 1) supplierSelect.remove(1);
          supplierSnap.forEach(function(doc) {
            var data = doc.data();
            var opt = document.createElement('option');
            opt.value = data.name || doc.id; opt.textContent = opt.value;
            supplierSelect.appendChild(opt);
          });
        }
        // 出品先
        var marketplaceSnap = await window.db.collection('salesChannels').orderBy('name', 'asc').get();
        var marketplaceSelect = document.getElementById('cfg-出品先');
        if (marketplaceSelect) {
          while (marketplaceSelect.options.length > 1) marketplaceSelect.remove(1);
          marketplaceSnap.forEach(function(doc) {
            var data = doc.data();
            var opt = document.createElement('option');
            opt.value = data.name || doc.id; opt.textContent = opt.value;
            marketplaceSelect.appendChild(opt);
          });
        }
      } catch (e) { console.error('[config-fragment] procure dropdown error:', e); }
    }

    function cfgToggleProcureDateField(mode) {
      var el = document.getElementById('cfg-仕入日');
      if (el) el.style.display = mode === 'fixed' ? 'block' : 'none';
    }
    window.cfgToggleProcureDateField = cfgToggleProcureDateField;

    function cfgToggleListingDateField(mode) {
      var el = document.getElementById('cfg-出品日');
      if (el) el.style.display = mode === 'fixed' ? 'block' : 'none';
    }
    window.cfgToggleListingDateField = cfgToggleListingDateField;

    // ============================================
    // Platform Settings
    // ============================================

    async function cfgLoadPlatformsFromFirestore() {
      if (!window.db) return;
      try {
        var snapshot = await window.db.collection('platforms').get();
        if (!snapshot.empty) {
          _cfg_customPlatforms = [];
          snapshot.forEach(function(doc) {
            var data = doc.data();
            if (data.isCustom) {
              _cfg_customPlatforms.push({ id: doc.id, ...data });
            } else {
              // Update default platform data
              var idx = _cfg_defaultPlatformDefs.findIndex(function(p) { return p.id === doc.id; });
              if (idx !== -1) {
                Object.assign(_cfg_defaultPlatformDefs[idx], data);
              }
            }
          });
          _cfg_platformMaster = _cfg_defaultPlatformDefs.concat(_cfg_customPlatforms);
        }
      } catch (e) { console.error('[config-fragment] platforms load error:', e); }
    }

    function cfgLoadPlatformSettings(config) {
      if (!config || !config['プラットフォーム設定']) {
        _cfg_enabledPlatformIds = ['mercari'];
        cfgRenderEnabledPlatforms();
        return;
      }
      var settings = config['プラットフォーム設定'];
      if (settings.enabledPlatformIds && Array.isArray(settings.enabledPlatformIds)) {
        _cfg_enabledPlatformIds = settings.enabledPlatformIds;
      } else if (settings.platforms && Array.isArray(settings.platforms)) {
        _cfg_enabledPlatformIds = settings.platforms.filter(function(p) { return p.enabled; }).map(function(p) { return p.id; });
      }
      if (_cfg_enabledPlatformIds.length === 0) _cfg_enabledPlatformIds = ['mercari'];

      // Registration mode
      if (settings.registrationMode) {
        var modeRadio = document.getElementById(settings.registrationMode === 'batch' ? 'cfg-modeBatch' : 'cfg-modeIndividual');
        if (modeRadio) { modeRadio.checked = true; cfgSelectRegistrationMode(settings.registrationMode); }
      }

      cfgRenderEnabledPlatforms();
    }

    function cfgRenderEnabledPlatforms() {
      var container = document.getElementById('cfg-enabledPlatformsList');
      if (!container) return;
      container.innerHTML = _cfg_enabledPlatformIds.map(function(id) {
        var platform = _cfg_platformMaster.find(function(p) { return p.id === id; });
        if (!platform) return '';
        return '<div style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 10px; margin-bottom: 8px; background: white;">' +
          '<img src="' + (platform.icon || '') + '" alt="' + platform.name + '" style="width: 40px; height: 40px; object-fit: contain; border-radius: 6px;" onerror="this.style.display=\'none\'">' +
          '<div style="flex: 1;">' +
            '<div style="font-weight: 600; color: #374151; font-size: 14px;">' + platform.name + '</div>' +
            '<div style="font-size: 11px; color: #6b7280;">' + (platform.description || '') + '</div>' +
          '</div>' +
          '<button onclick="cfgOpenPlatformEditModal(\'' + id + '\')" style="background: none; border: none; color: #6b7280; font-size: 16px; cursor: pointer; padding: 4px;"><i class="bi bi-pencil"></i></button>' +
          '<button onclick="cfgRemovePlatformFromEnabled(\'' + id + '\')" style="background: none; border: none; color: #ef4444; font-size: 16px; cursor: pointer; padding: 4px;"><i class="bi bi-trash"></i></button>' +
        '</div>';
      }).join('');
    }

    function cfgSelectRegistrationMode(mode) {
      var indLabel = document.querySelector('#spa-page-config label[onclick*="individual"]');
      var batchLabel = document.querySelector('#spa-page-config label[onclick*="batch"]');
      if (indLabel && batchLabel) {
        if (mode === 'individual') {
          indLabel.style.borderColor = '#40B4E5'; indLabel.style.background = '#f0f9ff';
          batchLabel.style.borderColor = '#e5e7eb'; batchLabel.style.background = 'transparent';
        } else {
          batchLabel.style.borderColor = '#40B4E5'; batchLabel.style.background = '#f0f9ff';
          indLabel.style.borderColor = '#e5e7eb'; indLabel.style.background = 'transparent';
        }
      }
    }
    window.cfgSelectRegistrationMode = cfgSelectRegistrationMode;

    function cfgOpenPlatformSelectModal() {
      var modal = document.getElementById('cfg-platformSelectModal');
      if (modal) { modal.classList.add('active'); cfgRenderPlatformSelectList(); }
    }
    window.cfgOpenPlatformSelectModal = cfgOpenPlatformSelectModal;

    function cfgClosePlatformSelectModal() {
      var modal = document.getElementById('cfg-platformSelectModal');
      if (modal) modal.classList.remove('active');
    }
    window.cfgClosePlatformSelectModal = cfgClosePlatformSelectModal;

    function cfgRenderPlatformSelectList() {
      var container = document.getElementById('cfg-platformSelectList');
      if (!container) return;
      var available = _cfg_platformMaster.filter(function(p) { return !_cfg_enabledPlatformIds.includes(p.id); });
      if (available.length === 0) {
        container.innerHTML = '<div style="color: #9ca3af; font-size: 13px; padding: 20px; text-align: center;">追加できるプラットフォームがありません</div>';
        return;
      }
      container.innerHTML = available.map(function(p) {
        return '<div onclick="cfgAddPlatformToEnabled(\'' + p.id + '\')" style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; cursor: pointer;" onmouseover="this.style.background=\'#f9fafb\'" onmouseout="this.style.background=\'white\'">' +
          '<img src="' + (p.icon || '') + '" alt="' + p.name + '" style="width: 40px; height: 40px; object-fit: contain; border-radius: 6px;" onerror="this.style.display=\'none\'">' +
          '<div style="flex: 1;"><div style="font-weight: 600; color: #374151; font-size: 14px;">' + p.name + '</div><div style="font-size: 11px; color: #6b7280;">' + (p.description || '') + '</div></div>' +
          '<span style="color: #40B4E5; font-size: 20px;">+</span></div>';
      }).join('');
    }

    async function cfgAddPlatformToEnabled(platformId) {
      if (!_cfg_enabledPlatformIds.includes(platformId)) {
        _cfg_enabledPlatformIds.push(platformId);
        cfgRenderEnabledPlatforms();
        cfgRenderPlatformSelectList();
        await cfgPersistPlatformSettings();
      }
      var available = _cfg_platformMaster.filter(function(p) { return !_cfg_enabledPlatformIds.includes(p.id); });
      if (available.length === 0) cfgClosePlatformSelectModal();
    }
    window.cfgAddPlatformToEnabled = cfgAddPlatformToEnabled;

    async function cfgRemovePlatformFromEnabled(platformId) {
      var idx = _cfg_enabledPlatformIds.indexOf(platformId);
      if (idx > -1) {
        _cfg_enabledPlatformIds.splice(idx, 1);
        cfgRenderEnabledPlatforms();
        await cfgPersistPlatformSettings();
      }
    }
    window.cfgRemovePlatformFromEnabled = cfgRemovePlatformFromEnabled;

    function cfgCollectPlatformSettings() {
      var modeRadio = document.querySelector('#spa-page-config input[name="cfg-registrationMode"]:checked');
      var platforms = _cfg_enabledPlatformIds.map(function(id) {
        var p = _cfg_platformMaster.find(function(x) { return x.id === id; });
        if (!p) return null;
        return { id: id, name: p.name, description: p.description, icon: p.icon, enabled: true };
      }).filter(function(p) { return p; });
      return {
        registrationMode: modeRadio ? modeRadio.value : 'individual',
        platforms: platforms,
        enabledPlatformIds: _cfg_enabledPlatformIds,
        platformOrder: _cfg_enabledPlatformIds
      };
    }

    async function cfgPersistPlatformSettings() {
      try {
        var settings = cfgCollectPlatformSettings();
        localStorage.setItem(_cfg_CONFIG_STORAGE_KEYS.PLATFORM, JSON.stringify(settings));
        if (window.db) {
          var userId = localStorage.getItem('reborn_user_id') || localStorage.getItem('userId');
          if (userId) {
            await window.db.collection('configs').doc(userId).set({ 'プラットフォーム設定': settings, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
          }
        }
      } catch (e) { console.error('[config-fragment] persist platform error:', e); }
    }

    // Platform edit modal
    function cfgOpenPlatformEditModal(platformId) {
      _cfg_currentEditingPlatformId = platformId;
      _cfg_pendingIconFile = null;
      var platform = _cfg_platformEdits[platformId] || _cfg_customPlatforms.find(function(p) { return p.id === platformId; }) || _cfg_defaultPlatformDefs.find(function(p) { return p.id === platformId; });
      if (!platform) return;

      var editId = document.getElementById('cfg-editPlatformId');
      var editName = document.getElementById('cfg-editPlatformName');
      var editDesc = document.getElementById('cfg-editPlatformDesc');
      if (editId) editId.value = platform.id;
      if (editName) editName.value = platform.name;
      if (editDesc) editDesc.value = platform.description || '';

      var preview = document.getElementById('cfg-platformIconPreview');
      if (preview) {
        if (platform.icon) {
          preview.innerHTML = '<img src="' + platform.icon + '" style="width: 100%; height: 100%; object-fit: contain;">';
        } else {
          preview.innerHTML = '<span style="color: #9ca3af; font-size: 12px;">未設定</span>';
        }
      }

      var modal = document.getElementById('cfg-platformEditModal');
      if (modal) modal.classList.add('active');
    }
    window.cfgOpenPlatformEditModal = cfgOpenPlatformEditModal;

    function cfgClosePlatformEditModal() {
      var modal = document.getElementById('cfg-platformEditModal');
      if (modal) modal.classList.remove('active');
      _cfg_currentEditingPlatformId = null;
      _cfg_pendingIconFile = null;
    }
    window.cfgClosePlatformEditModal = cfgClosePlatformEditModal;

    function cfgPreviewPlatformIcon(event) {
      var file = event.target.files[0];
      if (!file) return;
      if (file.size > 2 * 1024 * 1024) { alert('画像サイズは2MB以下にしてください。'); return; }
      _cfg_pendingIconFile = file;
      var reader = new FileReader();
      reader.onload = function(e) {
        var preview = document.getElementById('cfg-platformIconPreview');
        if (preview) preview.innerHTML = '<img src="' + e.target.result + '" style="width: 100%; height: 100%; object-fit: contain;">';
        var status = document.getElementById('cfg-platformIconUploadStatus');
        if (status) { status.textContent = '画像を選択しました'; status.style.color = '#10b981'; }
      };
      reader.readAsDataURL(file);
    }
    window.cfgPreviewPlatformIcon = cfgPreviewPlatformIcon;

    async function cfgSavePlatformEdit() {
      if (!_cfg_currentEditingPlatformId) return;
      var name = document.getElementById('cfg-editPlatformName').value.trim();
      if (!name) { alert('表示名は必須です。'); return; }
      var description = document.getElementById('cfg-editPlatformDesc').value.trim();

      // Update platform in master
      var idx = _cfg_defaultPlatformDefs.findIndex(function(p) { return p.id === _cfg_currentEditingPlatformId; });
      if (idx !== -1) {
        _cfg_defaultPlatformDefs[idx].name = name;
        _cfg_defaultPlatformDefs[idx].description = description;
      }
      _cfg_platformMaster = _cfg_defaultPlatformDefs.concat(_cfg_customPlatforms);

      cfgRenderEnabledPlatforms();
      cfgClosePlatformEditModal();
      await cfgPersistPlatformSettings();
    }
    window.cfgSavePlatformEdit = cfgSavePlatformEdit;

    // ============================================
    // Description Order
    // ============================================

    function cfgRenderDescriptionOrder(order) {
      var container = document.getElementById('cfg-descriptionOrderList');
      if (!container) return;
      container.innerHTML = '';

      var elements = (order && order.length > 0) ? order : _cfg_DESCRIPTION_ELEMENTS;

      // Add missing new elements
      if (order && order.length > 0) {
        var existingIds = order.map(function(e) { return e.id; });
        var newElements = _cfg_DESCRIPTION_ELEMENTS.filter(function(e) { return !existingIds.includes(e.id); });
        if (newElements.length > 0) elements = order.concat(newElements);
      }

      elements.forEach(function(element) {
        var item = document.createElement('div');
        item.draggable = true;
        item.dataset.elementId = element.id;
        item.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; cursor: move; user-select: none;';

        var handle = document.createElement('span');
        handle.textContent = '\u22EE\u22EE';
        handle.style.cssText = 'font-size: 16px; color: #9ca3af; cursor: move;';
        item.appendChild(handle);

        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = element.enabled !== false;
        checkbox.style.cssText = 'width: 18px; height: 18px; cursor: pointer;';
        checkbox.addEventListener('change', cfgUpdateDescriptionOrderPreview);
        item.appendChild(checkbox);

        var label = document.createElement('span');
        label.textContent = element.label;
        label.style.cssText = 'flex: 1; font-size: 13px; font-weight: 500; color: #374151;';
        item.appendChild(label);

        // Drag events
        item.addEventListener('dragstart', function(e) {
          _cfg_draggedElement = item;
          e.dataTransfer.effectAllowed = 'move';
          item.style.opacity = '0.5';
        });
        item.addEventListener('dragend', function() {
          item.style.opacity = '1';
          _cfg_draggedElement = null;
        });
        item.addEventListener('dragover', function(e) {
          e.preventDefault();
          if (_cfg_draggedElement && _cfg_draggedElement !== item) {
            item.style.borderColor = '#3b82f6';
          }
        });
        item.addEventListener('dragleave', function() {
          item.style.borderColor = '#e5e7eb';
        });
        item.addEventListener('drop', function(e) {
          e.preventDefault();
          item.style.borderColor = '#e5e7eb';
          if (_cfg_draggedElement && _cfg_draggedElement !== item) {
            var allItems = Array.from(container.children);
            var draggedIndex = allItems.indexOf(_cfg_draggedElement);
            var targetIndex = allItems.indexOf(item);
            if (draggedIndex < targetIndex) {
              container.insertBefore(_cfg_draggedElement, item.nextSibling);
            } else {
              container.insertBefore(_cfg_draggedElement, item);
            }
            cfgUpdateDescriptionOrderPreview();
          }
        });

        container.appendChild(item);
      });

      cfgUpdateDescriptionOrderPreview();
    }

    function cfgUpdateDescriptionOrderPreview() {
      var container = document.getElementById('cfg-descriptionOrderList');
      var preview = document.getElementById('cfg-descriptionOrderPreview');
      if (!container || !preview) return;

      var sampleTexts = {
        brand: 'ブランド名：UNIQLO',
        color: 'カラー（詳細）：ブラック',
        size: 'サイズ：M',
        material: '素材：ナイロン 100%',
        accessories: '付属品：保存袋',
        condition: '商品状態：目立った傷や汚れなし',
        ai: '【商品説明】UNIQLOの定番アイテムです。',
        management: '管理番号：【AA-1001】',
        discount: 'フォロー割あります',
        hashtag: '#REBORN_全商品'
      };

      var items = Array.from(container.children);
      var enabledItems = items.filter(function(item) {
        return item.querySelector('input[type="checkbox"]').checked;
      });

      if (enabledItems.length === 0) {
        preview.textContent = '（すべて非表示）';
        preview.style.color = '#ef4444';
      } else {
        var text = enabledItems.map(function(item) {
          return sampleTexts[item.dataset.elementId] || '';
        }).filter(function(t) { return t; }).join('\n\n');
        preview.textContent = text;
        preview.style.color = '#374151';
        preview.style.whiteSpace = 'pre-line';
      }
    }
    window.cfgUpdateDescriptionOrderPreview = cfgUpdateDescriptionOrderPreview;

    function cfgCollectDescriptionOrder() {
      var container = document.getElementById('cfg-descriptionOrderList');
      if (!container) return _cfg_DESCRIPTION_ELEMENTS;
      return Array.from(container.children).map(function(item) {
        var elementId = item.dataset.elementId;
        var element = _cfg_DESCRIPTION_ELEMENTS.find(function(e) { return e.id === elementId; });
        return {
          id: elementId,
          label: element ? element.label : '',
          enabled: item.querySelector('input[type="checkbox"]').checked
        };
      });
    }

    function cfgResetDescriptionOrder() {
      if (!confirm('配置順序をデフォルトに戻しますか？')) return;
      cfgRenderDescriptionOrder(_cfg_DESCRIPTION_ELEMENTS);
      alert('配置順序をデフォルトに戻しました。');
    }
    window.cfgResetDescriptionOrder = cfgResetDescriptionOrder;

    // ============================================
    // Management Number Builder (MNB)
    // ============================================

    function cfgMnbTogglePart(partName, enabled) {
      _cfg_mnbSettings.parts[partName] = enabled;
      var card = document.getElementById('cfg-mnb-part-' + partName);
      if (card) {
        if (enabled) card.classList.add('enabled');
        else card.classList.remove('enabled');
      }
      cfgMnbUpdatePreview();
    }
    window.cfgMnbTogglePart = cfgMnbTogglePart;

    function cfgMnbChangeDigits(delta) {
      _cfg_mnbSettings.serialDigits = Math.max(1, Math.min(6, _cfg_mnbSettings.serialDigits + delta));
      var el = document.getElementById('cfg-mnb-serialDigits');
      if (el) el.textContent = _cfg_mnbSettings.serialDigits;
      cfgMnbUpdatePreview();
    }
    window.cfgMnbChangeDigits = cfgMnbChangeDigits;

    function cfgMnbSelectSeparator(btn) {
      var selector = document.getElementById('cfg-mnb-separatorSelector');
      if (selector) {
        selector.querySelectorAll('.mnb-separator-btn').forEach(function(b) { b.classList.remove('active'); });
      }
      btn.classList.add('active');
      _cfg_mnbSettings.separator = btn.dataset.sep;
      cfgMnbUpdatePreview();
    }
    window.cfgMnbSelectSeparator = cfgMnbSelectSeparator;

    function cfgMnbUpdatePreview() {
      var preview = document.getElementById('cfg-mnb-preview');
      if (!preview) return;
      var parts = [];
      var sep = _cfg_mnbSettings.separator;

      // Build preview based on enabled parts and order
      var order = _cfg_mnbSettings.partOrder || ['category', 'serial', 'date', 'initial'];
      order.forEach(function(partName) {
        if (!_cfg_mnbSettings.parts[partName]) return;
        switch (partName) {
          case 'category': parts.push('TP'); break;
          case 'serial': parts.push('0'.repeat(_cfg_mnbSettings.serialDigits - 1) + '1'); break;
          case 'date':
            var now = new Date();
            var yy = String(now.getFullYear()).slice(2);
            var mm = String(now.getMonth() + 1).padStart(2, '0');
            var dd = String(now.getDate()).padStart(2, '0');
            var fmt = _cfg_mnbSettings.dateFormat || 'YYMMDD';
            if (fmt === 'YYMMDD') parts.push(yy + mm + dd);
            else if (fmt === 'YYMM') parts.push(yy + mm);
            else if (fmt === 'MMDD') parts.push(mm + dd);
            break;
          case 'initial': parts.push('YT'); break;
        }
      });
      preview.textContent = parts.join(sep) || '---';
    }

    function cfgMnbOpenCategoryModal() {
      var modal = document.getElementById('cfg-mnb-categoryModal');
      if (modal) { modal.classList.add('active'); cfgMnbRenderCategoryList(); }
    }
    window.cfgMnbOpenCategoryModal = cfgMnbOpenCategoryModal;

    function cfgMnbCloseCategoryModal() {
      var modal = document.getElementById('cfg-mnb-categoryModal');
      if (modal) modal.classList.remove('active');
    }
    window.cfgMnbCloseCategoryModal = cfgMnbCloseCategoryModal;

    function cfgMnbRenderCategoryList() {
      var container = document.getElementById('cfg-mnb-categoryList');
      if (!container) return;
      var codes = _cfg_mnbSettings.categoryCodes || {};
      var keys = Object.keys(codes);
      if (keys.length === 0) {
        container.innerHTML = '<div style="color: #9ca3af; font-size: 13px; text-align: center; padding: 20px;">カテゴリコードがありません</div>';
        return;
      }
      container.innerHTML = keys.map(function(key) {
        return '<div class="mnb-category-btn" style="display: flex; justify-content: space-between;"><span>' + key + '</span><span style="color: #6b7280; font-weight: 600;">' + codes[key] + '</span></div>';
      }).join('');
    }

    async function cfgMnbLoadCategoryCodes() {
      if (!window.db) return;
      try {
        var snapshot = await window.db.collection('categoryCodes').get();
        _cfg_mnbSettings.categoryCodes = {};
        snapshot.forEach(function(doc) {
          var data = doc.data();
          _cfg_mnbSettings.categoryCodes[data.name || doc.id] = data.code || doc.id;
        });
      } catch (e) { console.error('[config-fragment] category codes error:', e); }
    }

    function cfgMnbLoadSettings() {
      try {
        var saved = localStorage.getItem('managementNumberSettings');
        if (saved) {
          var settings = JSON.parse(saved);
          Object.assign(_cfg_mnbSettings, settings);
        }
      } catch (e) { /* ignore */ }

      // Apply to UI
      ['category', 'serial', 'date', 'initial'].forEach(function(part) {
        var card = document.getElementById('cfg-mnb-part-' + part);
        var checkbox = card ? card.querySelector('input[type="checkbox"]') : null;
        if (checkbox) {
          checkbox.checked = !!_cfg_mnbSettings.parts[part];
          if (_cfg_mnbSettings.parts[part]) card.classList.add('enabled');
          else card.classList.remove('enabled');
        }
      });

      var digitsEl = document.getElementById('cfg-mnb-serialDigits');
      if (digitsEl) digitsEl.textContent = _cfg_mnbSettings.serialDigits;

      var dateFormat = document.getElementById('cfg-mnb-dateFormat');
      if (dateFormat) dateFormat.value = _cfg_mnbSettings.dateFormat || 'YYMMDD';

      // Separator
      var sepSelector = document.getElementById('cfg-mnb-separatorSelector');
      if (sepSelector) {
        sepSelector.querySelectorAll('.mnb-separator-btn').forEach(function(btn) {
          btn.classList.toggle('active', btn.dataset.sep === _cfg_mnbSettings.separator);
        });
      }

      // 配置設定の復元
      var showInTitle = document.getElementById('cfg-mnb-showInTitle');
      var showInDesc = document.getElementById('cfg-mnb-showInDescription');
      var titleFormat = document.getElementById('cfg-mnb-titleFormat');
      var descFormat = document.getElementById('cfg-mnb-descFormat');
      var titleFormatRow = document.getElementById('cfg-mnb-titleFormatRow');
      var descFormatRow = document.getElementById('cfg-mnb-descFormatRow');

      if (showInTitle) {
        showInTitle.checked = !!_cfg_mnbSettings.showInTitle;
        if (titleFormatRow) titleFormatRow.style.display = showInTitle.checked ? 'block' : 'none';
        showInTitle.addEventListener('change', function() {
          if (titleFormatRow) titleFormatRow.style.display = this.checked ? 'block' : 'none';
        });
      }
      if (showInDesc) {
        showInDesc.checked = !!_cfg_mnbSettings.showInDescription;
        if (descFormatRow) descFormatRow.style.display = showInDesc.checked ? 'block' : 'none';
        showInDesc.addEventListener('change', function() {
          if (descFormatRow) descFormatRow.style.display = this.checked ? 'block' : 'none';
        });
      }
      if (titleFormat && _cfg_mnbSettings.titleFormat) titleFormat.value = _cfg_mnbSettings.titleFormat;
      if (descFormat && _cfg_mnbSettings.descFormat) descFormat.value = _cfg_mnbSettings.descFormat;

      cfgMnbUpdatePreview();
    }

    // ============================================
    // Basic Settings (ユーザー基本設定)
    // ============================================

    async function cfgLoadBasicSettings() {
      try {
        var userName = localStorage.getItem('reborn_user_name') || '';
        var userEmail = localStorage.getItem('reborn_user_email') || '';
        var permissionId = localStorage.getItem('reborn_user_permission_id') || 'staff';

        // Firestoreから最新権限を取得
        if (window.db && userEmail) {
          try {
            var userDoc = await window.db.collection('users').doc(userEmail).get();
            if (userDoc.exists) {
              var userData = userDoc.data();
              permissionId = userData.permissionId || permissionId;
              localStorage.setItem('reborn_user_permission_id', permissionId);
              if (userData.userName) userName = userData.userName;

              // 発送先・口座情報ステータス
              cfgUpdateShippingInfoStatus(userData.shippingInfo || {});
              cfgUpdateBankAccountStatus(userData.bankAccount || {});

              // 管理者は発送先・口座セクション非表示
              if (permissionId === 'owner') {
                var ss = document.getElementById('cfg-shippingInfoSection');
                var bs = document.getElementById('cfg-bankAccountSection');
                if (ss) ss.style.display = 'none';
                if (bs) bs.style.display = 'none';
              }
            }
          } catch (e) { console.warn('[config] Firestore権限取得失敗:', e); }
        }

        // 権限バッジ
        var badge = document.getElementById('cfg-basicUserPermissionBadge');
        if (badge) badge.innerHTML = cfgGetPermissionBadgeHTML(permissionId);

        // ユーザー名
        var nameInput = document.getElementById('cfg-basicUserName');
        if (nameInput) {
          nameInput.value = userName;
          var clearBtn = document.getElementById('cfg-clearUserNameBtn');
          if (clearBtn) clearBtn.style.display = userName ? 'block' : 'none';
          nameInput.addEventListener('input', function() {
            if (clearBtn) clearBtn.style.display = this.value ? 'block' : 'none';
          });
        }

        // メール
        var emailInput = document.getElementById('cfg-basicUserEmail');
        if (emailInput) emailInput.value = userEmail;

        // 通知設定
        var config = {};
        try { config = JSON.parse(localStorage.getItem('config') || '{}'); } catch(e) {}
        var notifCheckbox = document.getElementById('cfg-basicNotificationEnabled');
        var soundCheckbox = document.getElementById('cfg-basicNotificationSound');
        if (notifCheckbox) notifCheckbox.checked = config.notificationEnabled !== false;
        if (soundCheckbox) soundCheckbox.checked = config.notificationSound !== false;

        // アイコン
        var iconUrl = localStorage.getItem('reborn_user_icon_url');
        var iconPreview = document.getElementById('cfg-basicUserIconPreview');
        if (iconPreview && iconUrl) {
          iconPreview.innerHTML = '<img src="' + iconUrl + '" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">';
        }

        console.log('[config] 基本設定読み込み完了:', { userName: userName, permissionId: permissionId });
      } catch (e) {
        console.error('[config] 基本設定読み込みエラー:', e);
      }

      var loading = document.getElementById('cfg-basicSettingsLoading');
      var content = document.getElementById('cfg-basicSettingsContent');
      if (loading) loading.style.display = 'none';
      if (content) content.style.display = 'block';
    }

    async function cfgSaveBasicSettings() {
      var nameInput = document.getElementById('cfg-basicUserName');
      var userName = nameInput ? nameInput.value.trim() : '';
      if (!userName) { alert('ユーザー名を入力してください'); return; }

      var settings = {
        userName: userName,
        notificationEnabled: document.getElementById('cfg-basicNotificationEnabled')?.checked !== false,
        notificationSound: document.getElementById('cfg-basicNotificationSound')?.checked !== false
      };

      try {
        // localStorage保存
        var config = {};
        try { config = JSON.parse(localStorage.getItem('config') || '{}'); } catch(e) {}
        config.userName = settings.userName;
        config.notificationEnabled = settings.notificationEnabled;
        config.notificationSound = settings.notificationSound;
        localStorage.setItem('config', JSON.stringify(config));
        localStorage.setItem('reborn_user_name', settings.userName);

        // IndexedDB保存（SW用）
        try { await cfgSaveNotificationSoundToIndexedDB(settings.notificationSound); } catch(e) {}

        // Firestore保存
        var userEmail = localStorage.getItem('reborn_user_email');
        if (userEmail && window.db) {
          await window.db.collection('users').doc(userEmail).set({
            userName: settings.userName,
            notificationEnabled: settings.notificationEnabled,
            notificationSound: settings.notificationSound,
            lastUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });

          await window.db.collection('activeDevices').doc(userEmail).set({
            notificationEnabled: settings.notificationEnabled,
            notificationSound: settings.notificationSound,
            lastUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        }

        var clearBtn = document.getElementById('cfg-clearUserNameBtn');
        if (clearBtn) clearBtn.style.display = settings.userName ? 'block' : 'none';

        alert('基本設定を保存しました');
      } catch (e) {
        console.error('[config] 基本設定保存エラー:', e);
        alert('保存に失敗しました: ' + e.message);
      }
    }
    window.cfgSaveBasicSettings = cfgSaveBasicSettings;

    function cfgSaveNotificationSoundToIndexedDB(soundEnabled) {
      return new Promise(function(resolve, reject) {
        var req = indexedDB.open('SettingsDB', 1);
        req.onupgradeneeded = function(e) {
          var db = e.target.result;
          if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings');
        };
        req.onsuccess = function() {
          var db = req.result;
          try {
            var tx = db.transaction('settings', 'readwrite');
            tx.objectStore('settings').put(soundEnabled, 'notificationSound');
            tx.oncomplete = function() { db.close(); resolve(true); };
            tx.onerror = function() { db.close(); reject(tx.error); };
          } catch (e) { db.close(); reject(e); }
        };
        req.onerror = function() { reject(req.error); };
      });
    }

    function cfgGetPermissionBadgeHTML(permissionId) {
      var colors = { owner: '#dc2626', manager: '#2563eb', staff: '#059669' };
      var labels = { owner: 'オーナー', manager: 'マネージャー', staff: 'スタッフ' };
      var color = colors[permissionId] || '#6b7280';
      var label = labels[permissionId] || permissionId;
      return '<span style="display: inline-block; padding: 2px 10px; background: ' + color + '; color: white; border-radius: 10px; font-size: 12px; font-weight: 600;">' + label + '</span>';
    }

    function cfgUpdateShippingInfoStatus(info) {
      var el = document.getElementById('cfg-shippingInfoStatus');
      if (!el) return;
      if (info && info.name) {
        el.innerHTML = '<span style="color: #059669;"><i class="bi bi-check-circle-fill"></i> 登録済み</span>';
      } else {
        el.innerHTML = '<span style="color: #ef4444;"><i class="bi bi-exclamation-circle-fill"></i> 未登録</span>';
      }
    }

    function cfgUpdateBankAccountStatus(info) {
      var el = document.getElementById('cfg-bankAccountStatus');
      if (!el) return;
      if (info && info.bankName) {
        el.innerHTML = '<span style="color: #059669;"><i class="bi bi-check-circle-fill"></i> 登録済み</span>';
      } else {
        el.innerHTML = '<span style="color: #ef4444;"><i class="bi bi-exclamation-circle-fill"></i> 未登録</span>';
      }
    }

    // ============================================
    // Compensation Settings
    // ============================================

    function cfgCollectCompensationSettings() {
      return {
        taskRates: {
          listing: parseInt(document.getElementById('cfg-compensation-listing')?.value) || 100,
          shipping: parseInt(document.getElementById('cfg-compensation-shipping')?.value) || 100,
          photography: parseInt(document.getElementById('cfg-compensation-photography')?.value) || 50,
          inspection: parseInt(document.getElementById('cfg-compensation-inspection')?.value) || 30,
          stocktaking: parseInt(document.getElementById('cfg-compensation-stocktaking')?.value) || 20,
          editing: parseInt(document.getElementById('cfg-compensation-editing')?.value) || 50
        },
        customTasks: cfgCollectCustomTasks(),
        options: {
          autoRecordListing: document.getElementById('cfg-autoRecordListing')?.checked ?? true,
          autoRecordShipping: document.getElementById('cfg-autoRecordShipping')?.checked ?? true,
          cutoffDay: document.getElementById('cfg-compensationCutoffDay')?.value || '末日',
          paymentDay: document.getElementById('cfg-compensationPaymentDay')?.value || '翌月5日',
          recordAsExpense: document.getElementById('cfg-recordAsExpense')?.checked ?? true
        }
      };
    }

    function cfgCollectCustomTasks() {
      var tasks = [];
      var container = document.getElementById('cfg-customTasksContainer');
      if (!container) return tasks;
      container.querySelectorAll('.custom-task-item').forEach(function(item) {
        var nameInput = item.querySelector('.custom-task-name');
        var rateInput = item.querySelector('.custom-task-rate');
        if (nameInput && rateInput && nameInput.value.trim()) {
          tasks.push({ id: item.dataset.taskId || 'custom_' + Date.now(), name: nameInput.value.trim(), rate: parseInt(rateInput.value) || 0 });
        }
      });
      return tasks;
    }

    async function cfgLoadCompensationSettingsFromFirestore() {
      if (!window.db) return;
      try {
        var doc = await window.db.collection('settings').doc('compensation').get();
        if (doc.exists) {
          cfgLoadCompensationSettings({ '報酬設定': doc.data() });
        }
      } catch (e) { console.error('[config-fragment] compensation load error:', e); }
    }

    function cfgLoadCompensationSettings(config) {
      if (!config || !config['報酬設定']) return;
      var settings = config['報酬設定'];
      if (settings.taskRates) {
        ['listing', 'shipping', 'photography', 'inspection', 'stocktaking', 'editing'].forEach(function(task) {
          if (settings.taskRates[task] !== undefined) {
            var el = document.getElementById('cfg-compensation-' + task);
            if (el) el.value = settings.taskRates[task];
          }
        });
      }
      if (settings.customTasks) {
        settings.customTasks.forEach(function(task) {
          cfgAddCustomCompensationTask(task.name, task.rate, task.id);
        });
      }
      if (settings.options) {
        var opts = settings.options;
        var autoListing = document.getElementById('cfg-autoRecordListing');
        if (autoListing) autoListing.checked = opts.autoRecordListing ?? true;
        var autoShipping = document.getElementById('cfg-autoRecordShipping');
        if (autoShipping) autoShipping.checked = opts.autoRecordShipping ?? true;
        var cutoff = document.getElementById('cfg-compensationCutoffDay');
        if (cutoff) cutoff.value = opts.cutoffDay || '末日';
        var payment = document.getElementById('cfg-compensationPaymentDay');
        if (payment) payment.value = opts.paymentDay || '翌月5日';
        var expense = document.getElementById('cfg-recordAsExpense');
        if (expense) expense.checked = opts.recordAsExpense ?? true;
      }
    }

    async function cfgSaveCompensationSettings() {
      if (!window.db) return;
      try {
        var settings = cfgCollectCompensationSettings();
        settings.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
        await window.db.collection('settings').doc('compensation').set(settings, { merge: true });
      } catch (e) { console.error('[config-fragment] compensation save error:', e); }
    }

    function cfgAddCustomCompensationTask(name, rate, taskId) {
      var container = document.getElementById('cfg-customTasksContainer');
      var wrapper = document.getElementById('cfg-customCompensationTasks');
      if (!container || !wrapper) return;
      wrapper.style.display = 'block';
      var id = taskId || 'custom_' + (++_cfg_customTaskCounter);
      var html = '<div class="custom-task-item" data-task-id="' + id + '" style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb; margin-bottom: 6px;">' +
        '<div style="flex: 1;"><input type="text" class="custom-task-name form-control" value="' + (name || '') + '" placeholder="タスク名" style="font-size: 14px;"></div>' +
        '<div style="display: flex; align-items: center; gap: 4px;"><span style="font-size: 14px; color: #6b7280;">¥</span><input type="number" class="custom-task-rate" value="' + (rate || 0) + '" min="0" step="10" style="width: 80px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; text-align: right;"><span style="font-size: 12px; color: #6b7280;">/件</span></div>' +
        '<button type="button" onclick="cfgRemoveCustomCompensationTask(this)" style="background: none; border: none; color: #ef4444; font-size: 18px; cursor: pointer;"><i class="bi bi-trash"></i></button></div>';
      container.insertAdjacentHTML('beforeend', html);
    }
    window.cfgAddCustomCompensationTask = cfgAddCustomCompensationTask;

    function cfgRemoveCustomCompensationTask(btn) {
      var item = btn.closest('.custom-task-item');
      if (item) {
        item.remove();
        var container = document.getElementById('cfg-customTasksContainer');
        var wrapper = document.getElementById('cfg-customCompensationTasks');
        if (container && wrapper && container.children.length === 0) wrapper.style.display = 'none';
      }
    }
    window.cfgRemoveCustomCompensationTask = cfgRemoveCustomCompensationTask;

    function cfgOpenCompensationManagement() {
      if (typeof navigateToPage === 'function') {
        navigateToPage('compensation');
      }
    }
    window.cfgOpenCompensationManagement = cfgOpenCompensationManagement;

    function cfgAssignAllTasksToAll() {
      document.querySelectorAll('#spa-page-config .task-assign-checkbox').forEach(function(cb) { cb.checked = true; });
      document.querySelectorAll('#spa-page-config [id^="cfg-task-accordion-"]').forEach(function(el) {
        if (!el.id.includes('-badge') && !el.id.includes('-arrow')) cfgUpdateTaskBadge(el.id);
      });
    }
    window.cfgAssignAllTasksToAll = cfgAssignAllTasksToAll;

    // User task assignment
    async function cfgLoadUserTaskAssignmentList() {
      var container = document.getElementById('cfg-userTaskAssignmentList');
      if (!container || !window.db) return;
      try {
        var snapshot = await window.db.collection('users').get();
        var users = [];
        var permLabels = { owner: '管理者', admin: '管理者', employee: '社員', staff: 'スタッフ', leader: 'リーダー', contractor: '外注' };
        snapshot.forEach(function(docSnap) {
          var data = docSnap.data();
          var permId = data.permissionId || 'staff';
          users.push({
            email: docSnap.id, name: data.userName || docSnap.id,
            permissionId: permId, permissionDisplay: permLabels[permId] || 'スタッフ',
            assignedTasks: data.assignedTasks || ['listing', 'shipping', 'photography', 'stocktaking', 'editing']
          });
        });
        users.sort(function(a, b) { var order = { owner: 1, admin: 2, staff: 3 }; return (order[a.permissionId] || 99) - (order[b.permissionId] || 99); });

        var tasks = [
          { id: 'listing', name: '商品出品' }, { id: 'shipping', name: '梱包・発送' },
          { id: 'photography', name: '商品撮影' }, { id: 'inspection', name: '検品作業' },
          { id: 'stocktaking', name: '棚卸' }, { id: 'editing', name: '追加編集' }
        ];

        container.innerHTML = users.map(function(user, index) {
          var accordionId = 'cfg-task-accordion-' + index;
          var taskItems = tasks.map(function(task) {
            var checked = user.assignedTasks.includes(task.id) ? 'checked' : '';
            return '<label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;">' +
              '<input type="checkbox" class="task-assign-checkbox" data-email="' + user.email + '" data-task="' + task.id + '" ' + checked + ' style="width: 22px; height: 22px;" onchange="cfgUpdateTaskBadge(\'' + accordionId + '\')">' +
              '<span style="font-size: 14px; color: #374151;">' + task.name + '</span></label>';
          }).join('');

          return '<div style="border: 1px solid #e5e7eb; border-radius: 10px; overflow: hidden; background: white;">' +
            '<div onclick="cfgToggleTaskAccordion(\'' + accordionId + '\')" style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; cursor: pointer;">' +
              '<div style="flex: 1;"><div style="font-size: 14px; font-weight: 600;">' + cfgEscapeHtml(user.name) + '</div><span style="font-size: 11px; color: #9ca3af;">' + user.permissionDisplay + '</span></div>' +
              '<span id="' + accordionId + '-badge" style="color: #6b7280; font-size: 12px;">' + user.assignedTasks.length + '件</span>' +
              '<i id="' + accordionId + '-arrow" class="bi bi-chevron-right" style="font-size: 12px; color: #9ca3af;"></i>' +
            '</div>' +
            '<div id="' + accordionId + '" style="display: none; border-top: 1px solid #e5e7eb; background: #f9fafb; padding: 12px;"><div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">' + taskItems + '</div></div></div>';
        }).join('');
      } catch (e) { console.error('[config-fragment] task assignment error:', e); }
    }

    function cfgToggleTaskAccordion(accordionId) {
      var content = document.getElementById(accordionId);
      var arrow = document.getElementById(accordionId + '-arrow');
      if (!content || !arrow) return;
      if (content.style.display === 'none') { content.style.display = 'block'; arrow.style.transform = 'rotate(90deg)'; }
      else { content.style.display = 'none'; arrow.style.transform = 'rotate(0deg)'; }
    }
    window.cfgToggleTaskAccordion = cfgToggleTaskAccordion;

    function cfgUpdateTaskBadge(accordionId) {
      var content = document.getElementById(accordionId);
      if (!content) return;
      var count = content.querySelectorAll('.task-assign-checkbox:checked').length;
      var badge = document.getElementById(accordionId + '-badge');
      if (badge) badge.textContent = count + '件';
    }
    window.cfgUpdateTaskBadge = cfgUpdateTaskBadge;

    async function cfgSaveUserTaskAssignments() {
      if (!window.db) return;
      var assignments = {};
      document.querySelectorAll('#spa-page-config .task-assign-checkbox').forEach(function(cb) {
        var email = cb.dataset.email;
        if (!assignments[email]) assignments[email] = [];
        if (cb.checked) assignments[email].push(cb.dataset.task);
      });
      try {
        var batch = window.db.batch();
        Object.keys(assignments).forEach(function(email) {
          batch.update(window.db.collection('users').doc(email), { assignedTasks: assignments[email], updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        });
        await batch.commit();
      } catch (e) { console.error('[config-fragment] task save error:', e); }
    }

    // ============================================
    // User Management
    // ============================================

    async function cfgLoadUserManagement() {
      var loadingDiv = document.getElementById('cfg-userManagementLoading');
      var contentDiv = document.getElementById('cfg-userManagementContent');
      if (!loadingDiv || !contentDiv) return;

      var permissionId = localStorage.getItem('reborn_user_permission_id')
                      || localStorage.getItem('reborn_user_permission');
      if (permissionId !== 'owner') {
        loadingDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 14px; color: #dc2626;">この機能は管理者のみ利用できます</div></div>';
        return;
      }

      if (!window.db) { setTimeout(cfgLoadUserManagement, 500); return; }

      try {
        var snapshot = await window.db.collection('users').get();
        var users = [];
        snapshot.forEach(function(doc) { users.push({ id: doc.id, ...doc.data() }); });
        _cfg_allUsersData = users;
        cfgRenderAllUsers(users);
        loadingDiv.style.display = 'none';
        contentDiv.style.display = 'block';
      } catch (e) {
        console.error('[config-fragment] user management error:', e);
        loadingDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #dc2626;">読み込みに失敗しました</div>';
      }
    }

    function cfgRenderAllUsers(users) {
      var pending = users.filter(function(u) { return u.status === 'pending'; });
      var active = users.filter(function(u) { return u.status === 'active' || !u.status; });
      var inactive = users.filter(function(u) { return u.status === 'inactive' || u.status === 'rejected'; });

      var pendingCount = document.getElementById('cfg-pendingUsersCount');
      var inactiveCount = document.getElementById('cfg-inactiveUsersCount');
      if (pendingCount) pendingCount.textContent = pending.length;
      if (inactiveCount) inactiveCount.textContent = inactive.length;

      // Pending
      var pendingSection = document.getElementById('cfg-pendingSection');
      if (pending.length > 0 && pendingSection) {
        pendingSection.style.display = 'block';
        document.getElementById('cfg-pendingUsersList').innerHTML = cfgRenderUserRows(users.filter(function(u) { return u.status === 'pending'; }), 'pending');
      } else if (pendingSection) { pendingSection.style.display = 'none'; }

      // Permission groups
      var groupsContainer = document.getElementById('cfg-permissionGroups');
      if (groupsContainer) {
        var permGroups = {};
        var permOrder = ['owner', 'employee', 'leader', 'staff', 'contractor'];
        active.forEach(function(u) {
          var perm = u.permissionId || 'staff';
          if (!permGroups[perm]) permGroups[perm] = [];
          permGroups[perm].push(u);
        });
        var html = '';
        permOrder.forEach(function(permId) {
          var grpUsers = permGroups[permId];
          if (!grpUsers || grpUsers.length === 0) return;
          var permDef = _cfg_PERMISSION_DEFINITIONS[permId] || { label: permId };
          html += '<div style="background: white; border-radius: 8px; border: 1px solid #e5e7eb; overflow: hidden; margin-bottom: 8px;">' +
            '<div style="padding: 12px 16px; background: #f9fafb; display: flex; align-items: center; gap: 8px;">' +
              '<span style="font-size: 14px; font-weight: 600; color: #374151;">' + permDef.label + '</span>' +
              '<span style="background: #e5e7eb; font-size: 11px; padding: 2px 8px; border-radius: 10px;">' + grpUsers.length + '</span></div>' +
            '<div style="padding: 8px;">' + cfgRenderUserRows(grpUsers, 'active') + '</div></div>';
        });
        groupsContainer.innerHTML = html || '<div style="text-align: center; color: #9ca3af; padding: 20px;">有効なユーザーはいません</div>';
      }

      // Inactive
      var inactiveSection = document.getElementById('cfg-inactiveSection');
      if (inactive.length > 0 && inactiveSection) {
        inactiveSection.style.display = 'block';
        document.getElementById('cfg-inactiveUsersList').innerHTML = cfgRenderUserRows(inactive, 'inactive');
      } else if (inactiveSection) { inactiveSection.style.display = 'none'; }
    }

    function cfgRenderUserRows(users, status) {
      var now = Date.now();
      return users.map(function(user) {
        var userName = user.userName || user.name || 'Unknown';
        var isOnline = false;
        if (user.lastActiveAt) {
          var lastActive = typeof user.lastActiveAt === 'string' ? new Date(user.lastActiveAt).getTime() : (user.lastActiveAt.toDate ? user.lastActiveAt.toDate().getTime() : 0);
          isOnline = (now - lastActive) < 300000;
        }
        var userData = encodeURIComponent(JSON.stringify(user));
        return '<div onclick="cfgOpenUserDetailModal(\'' + userData + '\', \'' + status + '\')" style="display: flex; align-items: center; gap: 12px; padding: 10px 12px; margin-bottom: 4px; background: #f9fafb; border-radius: 8px; cursor: pointer;">' +
          '<div style="flex-shrink: 0; position: relative;">' +
            (user.photoURL ? '<img src="' + user.photoURL + '" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">' : '<div style="width: 40px; height: 40px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center;"><i class="bi bi-person" style="font-size: 20px; color: #9ca3af;"></i></div>') +
            '<div style="position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; background: ' + (isOnline ? '#10b981' : '#d1d5db') + '; border: 2px solid white; border-radius: 50%;"></div>' +
          '</div>' +
          '<div style="flex: 1;"><div style="font-size: 14px; font-weight: 500;">' + cfgEscapeHtml(userName) + '</div></div>' +
          '<div style="color: #9ca3af;">></div></div>';
      }).join('');
    }

    function cfgOpenUserDetailModal(encodedData, status) {
      var user = JSON.parse(decodeURIComponent(encodedData));
      var modal = document.getElementById('cfg-userDetailModal');
      var content = document.getElementById('cfg-userDetailContent');
      var actionsDiv = document.getElementById('cfg-userDetailActions');
      if (!modal || !content || !actionsDiv) return;

      var userName = user.userName || user.name || 'Unknown';
      var userEmail = user.userEmail || user.email || '';
      var permId = user.permissionId || 'staff';
      var permDef = _cfg_PERMISSION_DEFINITIONS[permId] || { label: permId };

      content.innerHTML = '<div style="text-align: center; margin-bottom: 16px;">' +
        '<div style="font-size: 16px; font-weight: 600;">' + cfgEscapeHtml(userName) + '</div>' +
        '<div style="font-size: 12px; color: #6b7280;">' + cfgEscapeHtml(userEmail) + '</div></div>' +
        '<div style="background: #f9fafb; border-radius: 8px; padding: 12px;">' +
          '<div style="display: flex; justify-content: space-between; margin-bottom: 8px;"><span style="color: #6b7280; font-size: 12px;">権限</span><span style="font-size: 12px;">' + permDef.label + '</span></div>' +
          '<div style="display: flex; justify-content: space-between;"><span style="color: #6b7280; font-size: 12px;">ステータス</span><span style="font-size: 12px;">' + (status === 'active' ? '有効' : status === 'pending' ? '承認待ち' : '無効') + '</span></div></div>';

      var currentEmail = localStorage.getItem('reborn_user_email');
      var isSelf = userEmail === currentEmail;
      var actionButtons = '';

      if (status === 'pending') {
        actionButtons = '<div style="display: flex; gap: 8px;">' +
          '<button onclick="cfgRejectUser(\'' + user.id + '\')" style="flex: 1; padding: 10px; background: #fee2e2; color: #dc2626; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">拒否</button>' +
          '<button onclick="cfgApproveUser(\'' + user.id + '\')" style="flex: 1; padding: 10px; background: #10b981; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">承認</button>' +
          '</div>';
      } else if (status === 'active' && !isSelf) {
        var permOptions = Object.keys(_cfg_PERMISSION_DEFINITIONS).map(function(key) {
          var def = _cfg_PERMISSION_DEFINITIONS[key];
          return '<option value="' + key + '"' + (key === permId ? ' selected' : '') + '>' + def.label + '</option>';
        }).join('');
        actionButtons = '<div style="margin-bottom: 12px;">' +
          '<label style="font-size: 12px; color: #6b7280; display: block; margin-bottom: 4px;">権限を変更</label>' +
          '<select onchange="cfgChangeUserPermission(\'' + user.id + '\', this.value)" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">' + permOptions + '</select></div>' +
          '<button onclick="cfgDisableUser(\'' + user.id + '\')" style="width: 100%; padding: 10px; background: #fee2e2; color: #dc2626; border: none; border-radius: 8px; font-size: 13px; cursor: pointer;">このユーザーを無効化</button>';
      } else if (status === 'inactive') {
        actionButtons = '<button onclick="cfgEnableUser(\'' + user.id + '\')" style="width: 100%; padding: 10px; background: #10b981; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; margin-bottom: 8px;">有効化</button>' +
          '<button onclick="cfgDeleteUser(\'' + user.id + '\', \'' + cfgEscapeHtml(userName) + '\')" style="width: 100%; padding: 10px; background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; border-radius: 8px; font-size: 13px; cursor: pointer;">このユーザーを完全に削除</button>';
      }

      actionsDiv.innerHTML = actionButtons;
      modal.style.display = 'flex';
      // ボトムナビを非表示（z-indexスタッキングコンテキスト問題の回避）
      var bottomNav = document.getElementById('bottom-nav');
      if (bottomNav) bottomNav.style.display = 'none';
    }
    window.cfgOpenUserDetailModal = cfgOpenUserDetailModal;

    function cfgCloseUserDetailModal() {
      var modal = document.getElementById('cfg-userDetailModal');
      if (modal) modal.style.display = 'none';
      // ボトムナビを復元
      var bottomNav = document.getElementById('bottom-nav');
      if (bottomNav) bottomNav.style.display = '';
    }
    window.cfgCloseUserDetailModal = cfgCloseUserDetailModal;

    async function cfgApproveUser(userId) {
      if (!confirm('このユーザーを承認しますか？')) return;
      try {
        // ユーザー情報を取得
        var userDoc = await window.db.collection('users').doc(userId).get();
        var userData = userDoc.exists ? userDoc.data() : {};
        var userName = userData.userName || userId.split('@')[0];

        // ステータスを有効に更新
        await window.db.collection('users').doc(userId).update({
          status: 'active', permissionId: 'staff', permissionDisplay: 'スタッフ',
          approvedAt: firebase.firestore.FieldValue.serverTimestamp(), approvedBy: localStorage.getItem('reborn_user_email')
        });

        // 管理者の承認待ちタスクを完了にする
        try { await cfgCompletePendingUserTask(userId); } catch (e) { console.error('[Approve] タスク完了エラー:', e); }

        // ウェルカム通知・タスクを作成（発送先・口座登録）
        try { await cfgCreateWelcomeAnnouncements(userId, userName); } catch (e) { console.error('[Approve] ウェルカム作成エラー:', e); }

        // 承認メール送信
        try { await cfgSendApprovalEmail(userId, userName); } catch (e) { console.error('[Approve] メール送信エラー:', e); }

        cfgCloseUserDetailModal();
        alert('ユーザーを承認しました');
        cfgLoadUserManagement();
      } catch (e) { alert('エラー: ' + e.message); }
    }
    window.cfgApproveUser = cfgApproveUser;

    // 管理者の承認待ちタスクを完了にする
    async function cfgCompletePendingUserTask(pendingUserEmail) {
      var ownersSnapshot = await window.db.collection('users').where('permissionId', '==', 'owner').get();
      if (ownersSnapshot.empty) return;
      for (var i = 0; i < ownersSnapshot.docs.length; i++) {
        var ownerEmail = ownersSnapshot.docs[i].data().userEmail;
        var tasksRef = window.db.collection('userTasks').doc(ownerEmail).collection('tasks');
        var tasksSnapshot = await tasksRef.where('type', '==', 'pending_user_approval').where('completed', '==', false).get();
        for (var j = 0; j < tasksSnapshot.docs.length; j++) {
          var taskData = tasksSnapshot.docs[j].data();
          if (taskData.relatedData && taskData.relatedData.pendingUserEmail === pendingUserEmail) {
            await tasksSnapshot.docs[j].ref.update({ completed: true, completedAt: firebase.firestore.FieldValue.serverTimestamp() });
            console.log('[Approve] ✅ 管理者タスク完了:', ownerEmail, pendingUserEmail);
          }
        }
      }
    }

    // ウェルカム通知とタスクを作成
    async function cfgCreateWelcomeAnnouncements(userEmail, userName) {
      var personalRef = window.db.collection('users').doc(userEmail).collection('personalAnnouncements');
      var tasksRef = window.db.collection('userTasks').doc(userEmail).collection('tasks');

      // 通知1 + タスク1: 発送先情報登録
      await personalRef.add({
        title: '発送先情報を登録してください',
        body: 'フリラへようこそ！\n\n商品が売れた際の発送準備に必要な情報を登録してください。\n\n【登録手順】\n1. 画面下部の「マイページ」をタップ\n2. 歯車アイコン（設定）をタップ\n3. 「設定管理」を選択\n4. 「発送先情報」ボタンをタップ\n5. 必要情報を入力して保存',
        priority: 'normal', createdAt: firebase.firestore.FieldValue.serverTimestamp(), type: 'shipping_request'
      });
      await tasksRef.add({
        type: 'shipping_info_registration', title: '発送先情報を登録',
        description: 'マイページ > 右上メニュー（≡） > 個人情報設定',
        link: 'mypage-personal-info', createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        completed: false, read: false
      });

      // 通知2 + タスク2: 口座情報登録
      await personalRef.add({
        title: '口座情報を登録してください',
        body: '報酬の受け取りに必要な口座情報を登録してください。\n\n【登録手順】\n1. 画面下部の「マイページ」をタップ\n2. 歯車アイコン（設定）をタップ\n3. 「設定管理」を選択\n4. 「口座情報」ボタンをタップ\n5. 必要情報を入力して保存',
        priority: 'normal', createdAt: firebase.firestore.FieldValue.serverTimestamp(), type: 'bank_request'
      });
      await tasksRef.add({
        type: 'bank_account_registration', title: '口座情報を登録',
        description: 'マイページ > 右上メニュー（≡） > 個人情報設定',
        link: 'mypage-personal-info', createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        completed: false, read: false
      });

      console.log('[Approve] ✅ ウェルカム通知・タスク作成完了:', userEmail);
    }

    async function cfgRejectUser(userId) {
      if (!confirm('このユーザーの登録を拒否しますか？')) return;
      try {
        await window.db.collection('users').doc(userId).update({
          status: 'rejected',
          rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
          rejectedBy: localStorage.getItem('reborn_user_email')
        });
        cfgCloseUserDetailModal();
        alert('ユーザーを拒否しました');
        cfgLoadUserManagement();
      } catch (e) { alert('エラー: ' + e.message); }
    }
    window.cfgRejectUser = cfgRejectUser;

    async function cfgDisableUser(userId) {
      if (!confirm('このユーザーを無効化しますか？')) return;
      try {
        await window.db.collection('users').doc(userId).update({ status: 'inactive', disabledAt: firebase.firestore.FieldValue.serverTimestamp() });
        cfgCloseUserDetailModal(); alert('ユーザーを無効化しました'); cfgLoadUserManagement();
      } catch (e) { alert('エラー: ' + e.message); }
    }
    window.cfgDisableUser = cfgDisableUser;

    async function cfgEnableUser(userId) {
      if (!confirm('このユーザーを有効化しますか？')) return;
      try {
        await window.db.collection('users').doc(userId).update({ status: 'active', enabledAt: firebase.firestore.FieldValue.serverTimestamp() });
        cfgCloseUserDetailModal(); alert('ユーザーを有効化しました'); cfgLoadUserManagement();
      } catch (e) { alert('エラー: ' + e.message); }
    }
    window.cfgEnableUser = cfgEnableUser;

    async function cfgChangeUserPermission(userId, newPermissionId) {
      var permDef = _cfg_PERMISSION_DEFINITIONS[newPermissionId];
      if (!permDef) return;
      if (!confirm('権限を「' + permDef.label + '」に変更しますか？')) {
        cfgLoadUserManagement();
        return;
      }
      try {
        await window.db.collection('users').doc(userId).update({
          permissionId: newPermissionId,
          permissionDisplay: permDef.label,
          permissionUpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          permissionUpdatedBy: localStorage.getItem('reborn_user_email')
        });
        cfgCloseUserDetailModal();
        alert('権限を「' + permDef.label + '」に変更しました');
        cfgLoadUserManagement();
      } catch (error) {
        console.error('[USER] 権限変更エラー:', error);
        alert('エラー: ' + error.message);
      }
    }
    window.cfgChangeUserPermission = cfgChangeUserPermission;

    async function cfgDeleteUser(userId, userName) {
      if (!confirm('「' + userName + '」を完全に削除しますか？\n\n以下のデータも削除されます：\n・お知らせ\n・デバイス情報\n・タスク\n・月間目標\n\nこの操作は取り消せません。')) return;
      try {
        console.log('[USER] ユーザー削除開始:', userId);
        var collections = [
          { ref: window.db.collection('users').doc(userId).collection('personalAnnouncements'), name: 'お知らせ' },
          { ref: window.db.collection('users').doc(userId).collection('devices'), name: 'デバイス' },
          { ref: window.db.collection('userTasks').doc(userId).collection('tasks'), name: 'タスク' }
        ];
        for (var i = 0; i < collections.length; i++) {
          var snap = await collections[i].ref.get();
          for (var j = 0; j < snap.docs.length; j++) { await snap.docs[j].ref.delete(); }
          console.log('[USER] ' + collections[i].name + '削除:', snap.size, '件');
        }
        var goalsSnap = await window.db.collection('userGoals').where('email', '==', userId).get();
        for (var k = 0; k < goalsSnap.docs.length; k++) { await goalsSnap.docs[k].ref.delete(); }
        console.log('[USER] 月間目標削除:', goalsSnap.size, '件');
        await window.db.collection('users').doc(userId).delete();
        console.log('[USER] ユーザー削除完了:', userId);
        cfgCloseUserDetailModal();
        alert('ユーザーと関連データを削除しました');
        cfgLoadUserManagement();
      } catch (error) {
        console.error('[USER] 削除エラー:', error);
        alert('エラー: ' + error.message);
      }
    }
    window.cfgDeleteUser = cfgDeleteUser;

    async function cfgSendApprovalEmail(userEmail, userName) {
      try {
        var response = await fetch('https://reborn-fcm-worker.mercari-yasuhirotakuji.workers.dev/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            to: userEmail,
            subject: '🎉 フリラアカウントが承認されました',
            body: userName + 'さん\n\nフリラへようこそ！\nあなたのアカウントが承認されました。\n\nアプリを開いてご利用ください。\nhttps://furira.jp\n\n---\nフリラ物販管理システム'
          })
        });
        if (!response.ok) throw new Error('メール送信失敗: ' + response.status);
        console.log('[Approve] 承認メール送信成功:', userEmail);
      } catch (e) {
        console.error('[Approve] メール送信エラー:', e);
      }
    }

    function cfgToggleSection(section) {
      var list = document.getElementById('cfg-' + section + 'UsersList');
      var toggle = document.getElementById('cfg-' + section + 'Toggle');
      if (!list || !toggle) return;
      if (list.style.display === 'none') { list.style.display = 'block'; toggle.textContent = '\u25BC'; }
      else { list.style.display = 'none'; toggle.textContent = '\u25B6'; }
    }
    window.cfgToggleSection = cfgToggleSection;

    function cfgFilterUserList() {
      var query = (document.getElementById('cfg-userSearchInput')?.value || '').toLowerCase().trim();
      if (!query) { cfgRenderAllUsers(_cfg_allUsersData); return; }
      var filtered = _cfg_allUsersData.filter(function(u) {
        return ((u.userName || u.name || '') + (u.userEmail || u.email || '')).toLowerCase().includes(query);
      });
      cfgRenderAllUsers(filtered);
    }
    window.cfgFilterUserList = cfgFilterUserList;

    // ============================================
    // Permission Settings
    // ============================================

    async function cfgLoadPermissionSettings() {
      if (_cfg_permissionSettingsLoaded) return;
      if (!window.db || typeof window.db.collection !== 'function') { setTimeout(cfgLoadPermissionSettings, 500); return; }
      try {
        console.log('[config-fragment] Loading permission settings...');
        var usersSnapshot = await window.db.collection('users').get();
        _cfg_usersData = [];
        usersSnapshot.forEach(function(doc) {
          var data = doc.data();
          _cfg_usersData.push({ email: doc.id, userName: data.userName || doc.id, permissionId: data.permissionId || 'staff' });
        });

        var menuPermDoc = await window.db.collection('settings').doc('menuPermissions').get();
        _cfg_menuPermissions = menuPermDoc.exists ? menuPermDoc.data() : {};

        cfgRenderUserPermissionList();
        cfgRenderMenuPermissionList();

        document.getElementById('cfg-permissionSettingsLoading').style.display = 'none';
        document.getElementById('cfg-permissionSettingsContent').style.display = 'block';
        _cfg_permissionSettingsLoaded = true;
        console.log('[config-fragment] Permission settings loaded successfully');
      } catch (e) {
        console.error('[config-fragment] permission load error:', e);
        var loadingEl = document.getElementById('cfg-permissionSettingsLoading');
        if (loadingEl) {
          loadingEl.innerHTML = '<div style="color: #ef4444; font-size: 14px;">権限設定の読み込みに失敗しました</div>' +
            '<div style="color: #6b7280; font-size: 12px; margin-top: 8px;">' + (e.message || e) + '</div>' +
            '<button onclick="cfgRetryLoadPermission()" style="margin-top: 12px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">再試行</button>';
        }
      }
    }

    function cfgRetryLoadPermission() {
      _cfg_permissionSettingsLoaded = false;
      var loadingEl = document.getElementById('cfg-permissionSettingsLoading');
      if (loadingEl) {
        loadingEl.innerHTML = '<div style="font-size: 14px; color: #6b7280;">読み込み中...</div>';
        loadingEl.style.display = '';
      }
      document.getElementById('cfg-permissionSettingsContent').style.display = 'none';
      cfgLoadPermissionSettings();
    }
    window.cfgRetryLoadPermission = cfgRetryLoadPermission;

    function cfgGetActivePermissions() {
      var activeIds = new Set(['owner']);
      _cfg_usersData.forEach(function(u) { if (u.permissionId) activeIds.add(u.permissionId); });
      return Array.from(activeIds).filter(function(id) { return _cfg_PERMISSION_DEFINITIONS[id]; })
        .sort(function(a, b) { return _cfg_PERMISSION_DEFINITIONS[a].order - _cfg_PERMISSION_DEFINITIONS[b].order; });
    }

    function cfgRenderUserPermissionList() {
      var container = document.getElementById('cfg-userPermissionList');
      if (!container) return;
      var currentEmail = localStorage.getItem('reborn_user_email');
      var allPerms = Object.keys(_cfg_PERMISSION_DEFINITIONS).sort(function(a, b) { return _cfg_PERMISSION_DEFINITIONS[a].order - _cfg_PERMISSION_DEFINITIONS[b].order; });

      container.innerHTML = _cfg_usersData.map(function(user) {
        var isSelf = user.email === currentEmail && user.permissionId === 'owner';
        var options = allPerms.map(function(p) {
          return '<option value="' + p + '"' + (user.permissionId === p ? ' selected' : '') + '>' + _cfg_PERMISSION_DEFINITIONS[p].label + '</option>';
        }).join('');
        return '<div style="padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">' +
          '<div style="font-size: 14px; font-weight: 600; margin-bottom: 6px;">' + cfgEscapeHtml(user.userName) + '</div>' +
          '<select data-email="' + user.email + '" onchange="cfgUpdateUserPermission(this)" style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 14px;"' + (isSelf ? ' disabled' : '') + '>' + options + '</select></div>';
      }).join('');
    }

    function cfgUpdateUserPermission(sel) {
      var email = sel.dataset.email;
      var newPerm = sel.value;
      var user = _cfg_usersData.find(function(u) { return u.email === email; });
      if (user) { user.permissionId = newPerm; cfgRenderMenuPermissionList(); }
    }
    window.cfgUpdateUserPermission = cfgUpdateUserPermission;

    function cfgRenderMenuPermissionList() {
      var container = document.getElementById('cfg-menuPermissionList');
      if (!container) return;
      var activePerms = cfgGetActivePermissions().filter(function(id) { return id !== 'owner'; });

      // Simplified: show main menus only
      var mainMenus = _cfg_MENU_DEFINITIONS.filter(function(m) { return !m.isTopGroup && !m.isGroup; });
      var html = mainMenus.map(function(menu) {
        // v580: デフォルト値を_cfg_menuPermissionsに書き込み（保存時にFirestoreに反映される）
        if (!_cfg_menuPermissions[menu.id]) {
          _cfg_menuPermissions[menu.id] = { visibleTo: menu.defaultOwnerOnly ? ['owner'] : ['owner'].concat(activePerms) };
        }
        var perm = _cfg_menuPermissions[menu.id];
        var toggles = activePerms.map(function(permId) {
          var isOn = perm.visibleTo && perm.visibleTo.includes(permId);
          return '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">' +
            '<div onclick="cfgToggleMenuPermission(\'' + menu.id + '\', \'' + permId + '\', this)" data-menu="' + menu.id + '" data-role="' + permId + '" data-on="' + isOn + '" style="width: 44px; height: 24px; background: ' + (isOn ? '#3b82f6' : '#d1d5db') + '; border-radius: 12px; position: relative; cursor: pointer;">' +
              '<div style="width: 20px; height: 20px; background: white; border-radius: 50%; position: absolute; top: 2px; transform: ' + (isOn ? 'translateX(20px)' : 'translateX(2px)') + '; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div></div>' +
            '<span style="font-size: 12px;">' + _cfg_PERMISSION_DEFINITIONS[permId].label + '</span></label>';
        }).join('');
        return '<div style="padding: 10px 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb; margin-bottom: 6px;">' +
          '<div style="font-size: 13px; font-weight: 600; margin-bottom: 8px;">' + menu.label + '</div>' +
          '<div style="display: flex; gap: 8px; flex-wrap: wrap;">' + toggles + '</div></div>';
      }).join('');
      container.innerHTML = html;
    }

    function cfgToggleMenuPermission(menuId, role, element) {
      var isOn = element.dataset.on === 'true';
      var newState = !isOn;
      element.dataset.on = String(newState);
      element.style.background = newState ? '#3b82f6' : '#d1d5db';
      element.querySelector('div').style.transform = newState ? 'translateX(20px)' : 'translateX(2px)';
      if (!_cfg_menuPermissions[menuId]) _cfg_menuPermissions[menuId] = { visibleTo: ['owner'] };
      var vis = _cfg_menuPermissions[menuId].visibleTo;
      if (newState && !vis.includes(role)) vis.push(role);
      else if (!newState && vis.includes(role)) { var idx = vis.indexOf(role); vis.splice(idx, 1); }
    }
    window.cfgToggleMenuPermission = cfgToggleMenuPermission;

    async function cfgSavePermissionSettings(showAlert) {
      if (!_cfg_permissionSettingsLoaded || !window.db) return true;
      try {
        var batch = window.db.batch();
        _cfg_usersData.forEach(function(user) {
          batch.update(window.db.collection('users').doc(user.email), {
            permissionId: user.permissionId,
            permissionDisplay: (_cfg_PERMISSION_DEFINITIONS[user.permissionId] || {}).label || user.permissionId,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
        batch.set(window.db.collection('settings').doc('menuPermissions'), Object.assign({}, _cfg_menuPermissions, { updatedAt: firebase.firestore.FieldValue.serverTimestamp() }));
        await batch.commit();
        return true;
      } catch (e) {
        console.error('[config-fragment] permission save error:', e);
        if (showAlert) alert('権限設定の保存に失敗しました');
        return false;
      }
    }

    // ============================================
    // Permission Check (UI visibility)
    // ============================================

    async function cfgCheckUserPermissionAndUpdateUI() {
      try {
        var userEmail = localStorage.getItem('reborn_user_email');
        if (!userEmail || !window.db) return;
        var userDoc = await window.db.collection('users').doc(userEmail).get();
        if (!userDoc.exists) return;
        var permissionId = userDoc.data().permissionId || 'staff';
        localStorage.setItem('reborn_user_permission', permissionId);
        if (permissionId === 'owner') return; // Admin sees all

        var menuPermDoc = await window.db.collection('settings').doc('menuPermissions').get();
        var menuPerms = menuPermDoc.exists ? menuPermDoc.data() : {};

        // Product subtabs (all default visible to everyone)
        cfgApplySubTabPermissions('cfg-productConfigTabs', 'cfg-productConfigTabContent', [
          { id: 'product-salesword', target: 'cfg-product-salesword', defaultOwnerOnly: false },
          { id: 'product-condition', target: 'cfg-product-condition', defaultOwnerOnly: false },
          { id: 'product-hashtag', target: 'cfg-product-hashtag', defaultOwnerOnly: false },
          { id: 'product-discount', target: 'cfg-product-discount', defaultOwnerOnly: false },
          { id: 'product-ai', target: 'cfg-product-ai', defaultOwnerOnly: false },
          { id: 'product-order', target: 'cfg-product-order', defaultOwnerOnly: false }
        ], menuPerms, permissionId);

        // System subtabs
        cfgApplySubTabPermissions('cfg-systemConfigTabs', 'cfg-systemConfigTabContent', [
          { id: 'system-basic', target: 'cfg-system-basic', defaultOwnerOnly: false },
          { id: 'system-management', target: 'cfg-system-management', defaultOwnerOnly: true },
          { id: 'system-shipping', target: 'cfg-system-shipping', defaultOwnerOnly: true },
          { id: 'system-procure', target: 'cfg-system-procure', defaultOwnerOnly: true },
          { id: 'system-platform', target: 'cfg-system-platform', defaultOwnerOnly: true },
          { id: 'system-users', target: 'cfg-system-users', alwaysOwnerOnly: true },
          { id: 'system-compensation', target: 'cfg-system-compensation', alwaysOwnerOnly: true },
          { id: 'system-permission', target: 'cfg-system-permission', alwaysOwnerOnly: true }
        ], menuPerms, permissionId);
      } catch (e) { console.error('[config-fragment] permission check error:', e); }
    }

    function cfgApplySubTabPermissions(tabsContainerId, contentContainerId, subTabs, menuPerms, permissionId) {
      var visibleCount = 0;
      var firstVisibleTarget = null;
      var allPerms = ['owner', 'employee', 'staff', 'leader', 'outsource'];

      subTabs.forEach(function(subTab) {
        if (subTab.alwaysOwnerOnly) {
          if (permissionId !== 'owner') {
            cfgHideSubtab(subTab.target);
            return;
          }
        }

        var defaultVisibleTo = subTab.defaultOwnerOnly === false ? allPerms : ['owner'];
        var perm = menuPerms[subTab.id] || { visibleTo: defaultVisibleTo };
        var isVisible = perm.visibleTo && perm.visibleTo.indexOf(permissionId) !== -1;

        if (isVisible) {
          visibleCount++;
          if (!firstVisibleTarget) firstVisibleTarget = subTab.target;
        } else {
          cfgHideSubtab(subTab.target);
        }
      });

      if (visibleCount === 0) {
        var tabsContainer = document.getElementById(tabsContainerId);
        if (tabsContainer) tabsContainer.style.display = 'none';
        var contentContainer = document.getElementById(contentContainerId);
        if (contentContainer) {
          contentContainer.innerHTML = '<div style="padding: 40px; text-align: center; color: #6b7280;">' +
            '<i class="bi bi-lock" style="font-size: 48px; display: block; margin-bottom: 16px;"></i>' +
            'この設定は管理者のみ編集できます。<br>設定の変更が必要な場合は管理者にお問い合わせください。</div>';
        }
      } else if (firstVisibleTarget) {
        // Activate first visible tab if current active is hidden
        var activePane = document.querySelector('#' + contentContainerId + ' .cfg-subtab-pane.active');
        if (activePane && activePane.style.display === 'none') {
          activePane.classList.remove('active');
          var firstPane = document.getElementById(firstVisibleTarget);
          if (firstPane) firstPane.classList.add('active');
          var tabsContainer = document.getElementById(tabsContainerId);
          if (tabsContainer) {
            tabsContainer.querySelectorAll('.cfg-subtab').forEach(function(t) { t.classList.remove('active'); });
            var firstBtn = tabsContainer.querySelector('[data-target="' + firstVisibleTarget + '"]');
            if (firstBtn) firstBtn.classList.add('active');
          }
        }
      }
    }

    function cfgHideSubtab(targetId) {
      var pane = document.getElementById(targetId);
      if (pane) { pane.style.display = 'none'; pane.classList.remove('active'); }
      // Hide corresponding tab button
      var tabsContainers = ['cfg-productConfigTabs', 'cfg-systemConfigTabs'];
      tabsContainers.forEach(function(containerId) {
        var container = document.getElementById(containerId);
        if (!container) return;
        var btn = container.querySelector('[data-target="' + targetId + '"]');
        if (btn) btn.style.display = 'none';
      });
    }

    // ============================================
    // Shipping/Bank Info Modals
    // ============================================

    function cfgFormatPostalCode(input) {
      var value = input.value.replace(/[^0-9]/g, '');
      if (value.length > 3) value = value.slice(0, 3) + '-' + value.slice(3, 7);
      input.value = value;
    }
    window.cfgFormatPostalCode = cfgFormatPostalCode;

    async function cfgSearchShippingAddress() {
      var postalCode = document.getElementById('cfg-shippingPostalCode').value.replace(/-/g, '');
      if (postalCode.length !== 7) { alert('郵便番号を正しく入力してください（7桁）'); return; }
      try {
        var response = await fetch('https://zipcloud.ibsnet.co.jp/api/search?zipcode=' + postalCode);
        var data = await response.json();
        if (data.results && data.results.length > 0) {
          var result = data.results[0];
          document.getElementById('cfg-shippingPrefecture').value = result.address1;
          document.getElementById('cfg-shippingCity').value = result.address2 + result.address3;
        } else { alert('該当する住所が見つかりませんでした'); }
      } catch (e) { alert('住所検索に失敗しました'); }
    }
    window.cfgSearchShippingAddress = cfgSearchShippingAddress;

    async function cfgOpenShippingInfoModal() {
      var modal = document.getElementById('cfg-shippingInfoModal');
      if (modal) {
        modal.classList.add('active');
        await cfgLoadShippingInfo();
      }
    }
    window.cfgOpenShippingInfoModal = cfgOpenShippingInfoModal;

    async function cfgLoadShippingInfo() {
      var userEmail = localStorage.getItem('reborn_user_email');
      if (!userEmail || !window.db) return;
      try {
        var userDoc = await window.db.collection('users').doc(userEmail).get();
        if (userDoc.exists) {
          var shipping = userDoc.data().shippingInfo || {};
          var fields = { 'cfg-shippingLastName': 'lastName', 'cfg-shippingFirstName': 'firstName', 'cfg-shippingPostalCode': 'postalCode', 'cfg-shippingPrefecture': 'prefecture', 'cfg-shippingCity': 'city', 'cfg-shippingBuilding': 'building' };
          Object.keys(fields).forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.value = shipping[fields[id]] || '';
          });
        }
      } catch (e) { console.error('[config] 発送先情報読み込みエラー:', e); }
    }

    function cfgCloseShippingInfoModal() {
      var modal = document.getElementById('cfg-shippingInfoModal');
      if (modal) modal.classList.remove('active');
    }
    window.cfgCloseShippingInfoModal = cfgCloseShippingInfoModal;

    async function cfgSaveShippingInfo() {
      var userEmail = localStorage.getItem('reborn_user_email');
      if (!userEmail || !window.db) { alert('Firestoreが初期化されていません'); return; }
      var info = {
        lastName: document.getElementById('cfg-shippingLastName').value.trim(),
        firstName: document.getElementById('cfg-shippingFirstName').value.trim(),
        postalCode: document.getElementById('cfg-shippingPostalCode').value.trim(),
        prefecture: document.getElementById('cfg-shippingPrefecture').value.trim(),
        city: document.getElementById('cfg-shippingCity').value.trim(),
        building: document.getElementById('cfg-shippingBuilding').value.trim()
      };
      if (!info.lastName || !info.firstName || !info.postalCode || !info.prefecture || !info.city) {
        alert('必須項目を入力してください'); return;
      }
      try {
        await window.db.collection('users').doc(userEmail).set({
          shippingInfo: info,
          shippingInfoUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        cfgUpdateShippingInfoStatus(info);
        await cfgCompleteSettingTask('shipping_info_registration');
        alert('発送先情報を保存しました');
        cfgCloseShippingInfoModal();
      } catch (e) { alert('保存に失敗しました: ' + e.message); }
    }
    window.cfgSaveShippingInfo = cfgSaveShippingInfo;

    async function cfgOpenBankAccountModal() {
      var modal = document.getElementById('cfg-bankAccountModal');
      if (modal) {
        modal.classList.add('active');
        await cfgLoadBankAccountInfo();
      }
    }
    window.cfgOpenBankAccountModal = cfgOpenBankAccountModal;

    async function cfgLoadBankAccountInfo() {
      var userEmail = localStorage.getItem('reborn_user_email');
      if (!userEmail || !window.db) return;
      try {
        var userDoc = await window.db.collection('users').doc(userEmail).get();
        if (userDoc.exists) {
          var bank = userDoc.data().bankAccount || {};
          var fields = { 'cfg-bankName': 'bankName', 'cfg-bankBranch': 'branchName', 'cfg-bankAccountType': 'accountType', 'cfg-bankAccountNumber': 'accountNumber', 'cfg-bankAccountHolder': 'accountHolder' };
          Object.keys(fields).forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.value = bank[fields[id]] || '';
          });
        }
      } catch (e) { console.error('[config] 口座情報読み込みエラー:', e); }
    }

    function cfgCloseBankAccountModal() {
      var modal = document.getElementById('cfg-bankAccountModal');
      if (modal) modal.classList.remove('active');
    }
    window.cfgCloseBankAccountModal = cfgCloseBankAccountModal;

    async function cfgSaveBankAccount() {
      var userEmail = localStorage.getItem('reborn_user_email');
      if (!userEmail || !window.db) { alert('Firestoreが初期化されていません'); return; }
      var info = {
        bankName: document.getElementById('cfg-bankName').value.trim(),
        branchName: document.getElementById('cfg-bankBranch').value.trim(),
        accountType: document.getElementById('cfg-bankAccountType').value,
        accountNumber: document.getElementById('cfg-bankAccountNumber').value.trim(),
        accountHolder: document.getElementById('cfg-bankAccountHolder').value.trim()
      };
      if (!info.bankName || !info.branchName || !info.accountNumber || !info.accountHolder) {
        alert('必須項目を入力してください'); return;
      }
      try {
        await window.db.collection('users').doc(userEmail).set({
          bankAccount: info,
          bankAccountUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        cfgUpdateBankAccountStatus(info);
        await cfgCompleteSettingTask('bank_account_registration');
        alert('口座情報を保存しました');
        cfgCloseBankAccountModal();
      } catch (e) { alert('保存に失敗しました: ' + e.message); }
    }
    window.cfgSaveBankAccount = cfgSaveBankAccount;

    async function cfgCompleteSettingTask(taskId) {
      var userEmail = localStorage.getItem('reborn_user_email');
      if (!userEmail || !window.db) return;
      try {
        var taskDoc = await window.db.collection('userTasks').doc(userEmail).collection('tasks').doc(taskId).get();
        if (taskDoc.exists && !taskDoc.data().completed) {
          await window.db.collection('userTasks').doc(userEmail).collection('tasks').doc(taskId).update({
            completed: true,
            completedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          console.log('[config] タスク完了:', taskId);
        }
      } catch (e) { console.warn('[config] タスク完了処理エラー:', e); }
    }

    // ============================================
    // User Icon Upload
    // ============================================

    async function cfgUploadUserIcon() {
      if (!_cfg_pendingUserIconData) return;
      try {
        var userEmail = localStorage.getItem('reborn_user_email');
        if (!userEmail || !window.db) return;
        await window.db.collection('users').doc(userEmail).set({ userIconUrl: _cfg_pendingUserIconData, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
        localStorage.setItem('reborn_user_icon_url', _cfg_pendingUserIconData);
        _cfg_pendingUserIconData = null;
      } catch (e) { console.error('[config-fragment] icon upload error:', e); }
    }

    function cfgInitUserIconHandler() {
      var input = document.getElementById('cfg-basicUserIconInput');
      if (!input) return;
      input.addEventListener('change', function(e) {
        var file = e.target.files[0];
        if (!file) return;
        if (file.size > 2 * 1024 * 1024) { alert('ファイルサイズは2MB以下にしてください'); return; }

        var reader = new FileReader();
        reader.onload = function(event) {
          var img = new Image();
          img.onload = function() {
            var canvas = document.createElement('canvas');
            var maxSize = 200;
            var width = img.width;
            var height = img.height;
            if (width > height) {
              if (width > maxSize) { height = Math.round((height * maxSize) / width); width = maxSize; }
            } else {
              if (height > maxSize) { width = Math.round((width * maxSize) / height); height = maxSize; }
            }
            canvas.width = width;
            canvas.height = height;
            canvas.getContext('2d').drawImage(img, 0, 0, width, height);
            var resizedBase64 = canvas.toDataURL('image/jpeg', 0.8);
            if (resizedBase64.length > 45000) { alert('画像が大きすぎます。より小さい画像を選択してください。'); return; }

            var preview = document.getElementById('cfg-basicUserIconPreview');
            if (preview) preview.innerHTML = '<img src="' + resizedBase64 + '" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">';
            _cfg_pendingUserIconData = resizedBase64;
            console.log('[config] アイコン画像選択完了、保存時にアップロード');
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // ============================================
    // Online Status
    // ============================================

    function cfgStartOnlineStatusUpdates() {
      var check = function() {
        if (!window.db) { setTimeout(check, 500); return; }
        cfgUpdateLastActiveAt();
        _cfg_onlineInterval = setInterval(cfgUpdateLastActiveAt, 3 * 60 * 1000);
      };
      check();
    }

    async function cfgUpdateLastActiveAt() {
      try {
        var email = localStorage.getItem('reborn_user_email');
        if (!email || !window.db) return;
        await window.db.collection('users').doc(email).update({ lastActiveAt: firebase.firestore.FieldValue.serverTimestamp() });
      } catch (e) { /* ignore */ }
    }

    // ============================================
    // Clear / Reset functions
    // ============================================

    function cfgClearManagementNumberSettings() {
      if (!confirm('管理番号設定をすべてクリアしますか？\n\n・すべてのセグメントが削除されます\n・設定がリセットされます')) return;
      _cfg_mnbSettings = { parts: { category: true, serial: true, date: false, initial: false }, serialDigits: 3, separator: '-', dateFormat: 'YYMMDD', initialSource: 'platform', categorySource: 'category', partOrder: ['category', 'serial', 'date', 'initial'] };
      cfgMnbRenderSettings();
      cfgMnbUpdatePreview();
      alert('管理番号設定をクリアしました。\n変更を保存するには「設定を保存」ボタンをクリックしてください。');
    }
    window.cfgClearManagementNumberSettings = cfgClearManagementNumberSettings;

    function cfgClearAllHashtags() {
      if (!confirm('すべてのハッシュタグをクリアしてよろしいですか？')) return;
      var container = document.getElementById('cfg-hashtagConfigContainer');
      if (container) container.innerHTML = '';
      alert('すべてのハッシュタグをクリアしました。\n変更を保存するには「設定を保存」ボタンをクリックしてください。');
    }
    window.cfgClearAllHashtags = cfgClearAllHashtags;

    function cfgClearAllDiscounts() {
      if (!confirm('すべての割引設定をクリアしますか？')) return;
      var container = document.getElementById('cfg-discountConfigContainer');
      if (container) container.innerHTML = '';
      var preview = document.getElementById('cfg-discountPreview');
      if (preview) preview.textContent = '';
      alert('割引設定をクリアしました。\n変更を保存するには「設定を保存」ボタンをクリックしてください。');
    }
    window.cfgClearAllDiscounts = cfgClearAllDiscounts;

    function cfgClearShippingDefaults() {
      if (!confirm('配送デフォルト設定をすべてクリアしますか？')) return;
      ['配送料の負担', '配送の方法', '発送元の地域', '発送までの日数'].forEach(function(field) {
        var el = document.getElementById('cfg-' + field);
        if (el) el.value = '';
      });
      alert('配送デフォルト設定をクリアしました。\n変更を保存するには「設定を保存」ボタンをクリックしてください。');
    }
    window.cfgClearShippingDefaults = cfgClearShippingDefaults;

    function cfgClearConditionButtons() {
      if (!confirm('商品状態ボタン設定をすべてクリアしますか？\n\n全カテゴリのカスタムボタンが削除されます。')) return;
      _cfg_CONDITION_STATES.forEach(function(state) {
        var container = document.getElementById('cfg-condition-' + state.value.replace(/[、・]/g, ''));
        if (container) container.innerHTML = '';
      });
      alert('商品状態ボタン設定をクリアしました。\n変更を保存するには「設定を保存」ボタンをクリックしてください。');
    }
    window.cfgClearConditionButtons = cfgClearConditionButtons;

    function cfgClearAllSaleswordSettings() {
      if (!confirm('セールスワード設定をすべてクリアしますか？')) return;
      var list = document.getElementById('cfg-saleswordList');
      if (list) list.innerHTML = '';
      var separator = document.getElementById('cfg-saleswordSeparator');
      if (separator) separator.value = ' ';
      var bracket = document.getElementById('cfg-saleswordBracket');
      if (bracket) bracket.value = '【】';
      alert('セールスワード設定をクリアしました。\n変更を保存するには「設定を保存」ボタンをクリックしてください。');
    }
    window.cfgClearAllSaleswordSettings = cfgClearAllSaleswordSettings;

    function cfgClearProcureDefaults() {
      if (!confirm('仕入デフォルト設定をクリアしますか？')) return;
      var supplier = document.getElementById('cfg-仕入先');
      if (supplier) supplier.value = '';
      var dateInput = document.getElementById('cfg-仕入日');
      if (dateInput) dateInput.value = '';
      var todayRadio = document.querySelector('input[name="cfg-procureDateMode"][value="today"]');
      if (todayRadio) todayRadio.checked = true;
      if (dateInput) dateInput.style.display = 'none';
      alert('仕入デフォルト設定をクリアしました。\n変更を保存するには「設定を保存」ボタンをクリックしてください。');
    }
    window.cfgClearProcureDefaults = cfgClearProcureDefaults;

    function cfgClearListingDefaults() {
      if (!confirm('出品デフォルト設定をクリアしますか？')) return;
      var platform = document.getElementById('cfg-出品先');
      if (platform) platform.value = '';
      var dateInput = document.getElementById('cfg-出品日');
      if (dateInput) dateInput.value = '';
      var todayRadio = document.querySelector('input[name="cfg-listingDateMode"][value="today"]');
      if (todayRadio) todayRadio.checked = true;
      if (dateInput) dateInput.style.display = 'none';
      alert('出品デフォルト設定をクリアしました。\n変更を保存するには「設定を保存」ボタンをクリックしてください。');
    }
    window.cfgClearListingDefaults = cfgClearListingDefaults;

    // ============================================
    // Utility
    // ============================================

    function cfgEscapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/[&<>"']/g, function(c) {
        return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c];
      });
    }

    function cfgGetPermissionBadgeHTML(permissionId) {
      var perm = _cfg_PERMISSION_DEFINITIONS[permissionId] || _cfg_PERMISSION_DEFINITIONS['staff'];
      return '<span style="display: inline-block; padding: 4px 12px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; font-weight: 500;">' + perm.label + '</span>';
    }

    // ============================================
    // Swipe gesture for subtabs
    // ============================================

    (function() {
      function setupSwipe(tabContentId, tabsId) {
        var tabContent = document.getElementById(tabContentId);
        if (!tabContent) return;

        var touchStartX = 0, touchStartY = 0;
        tabContent.addEventListener('touchstart', function(e) {
          touchStartX = e.changedTouches[0].screenX;
          touchStartY = e.changedTouches[0].screenY;
        }, { passive: true });

        tabContent.addEventListener('touchend', function(e) {
          var diffX = touchStartX - e.changedTouches[0].screenX;
          var diffY = touchStartY - e.changedTouches[0].screenY;
          if (Math.abs(diffX) < 50 || Math.abs(diffY) > Math.abs(diffX)) return;

          var tabsContainer = document.getElementById(tabsId);
          if (!tabsContainer) return;
          var tabs = Array.from(tabsContainer.querySelectorAll('.cfg-subtab'));
          var activeIdx = tabs.findIndex(function(t) { return t.classList.contains('active'); });
          if (activeIdx === -1) return;

          var nextIdx = diffX > 0 ? activeIdx + 1 : activeIdx - 1;
          if (nextIdx < 0 || nextIdx >= tabs.length) return;

          var target = tabs[nextIdx].getAttribute('data-target');
          cfgActivateSubtab(target);
        }, { passive: true });
      }

      // Defer setup until DOM is ready within fragment
      setTimeout(function() {
        setupSwipe('cfg-productConfigTabContent', 'cfg-productConfigTabs');
        setupSwipe('cfg-systemConfigTabContent', 'cfg-systemConfigTabs');
      }, 100);
    })();
  </script>
</div>
