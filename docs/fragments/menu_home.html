<!-- SPA Fragment: menu_home (ホーム画面) -->
<div id="spa-page-menu-home">
  <style>
    #spa-page-menu-home {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      min-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    #spa-page-menu-home .menu-container {
      position: relative;
      width: 100%;
      max-width: 500px;
      max-height: calc(100% - 24px);
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 24px 16px;
      margin: 0 auto;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    #spa-page-menu-home .menu-items {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    #spa-page-menu-home .menu-header {
      text-align: center;
      margin-bottom: 20px;
    }
    #spa-page-menu-home .menu-logo {
      width: min(280px, 70vw);
      height: auto;
      margin: -35px auto -45px;
      display: block;
    }
    #spa-page-menu-home .menu-subtitle {
      font-size: 14px;
      color: #6b7280;
    }
    #spa-page-menu-home .menu-item {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 6px 16px;
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: space-between;
      text-decoration: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    #spa-page-menu-home .menu-item.full-width { grid-column: 1 / -1; }
    #spa-page-menu-home .menu-item:active { transform: scale(0.98); background: #f9fafb; }
    #spa-page-menu-home .menu-item:hover { border-color: var(--reborn-primary); background: var(--reborn-primary-lightest); }
    #spa-page-menu-home .menu-item.disabled { opacity: 0.5; cursor: not-allowed; background: #f9fafb; }
    #spa-page-menu-home .menu-item.disabled:active { transform: none; }
    #spa-page-menu-home .menu-item-content { display: flex; align-items: center; gap: 8px; flex-wrap: nowrap; }
    #spa-page-menu-home .menu-item-content > span { white-space: nowrap; flex-shrink: 0; }
    #spa-page-menu-home .menu-item-icon {
      font-size: 18px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    #spa-page-menu-home .menu-item-icon img { width: 100%; height: 100%; object-fit: contain; }
    #spa-page-menu-home .menu-item-arrow { font-size: 14px; color: #9ca3af; transition: transform 0.2s; }
    #spa-page-menu-home .accordion-menu {
      background: white; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden; transition: all 0.2s; grid-column: 1 / -1;
    }
    #spa-page-menu-home .accordion-header {
      padding: 6px 20px; font-size: 16px; font-weight: 600; color: #1f2937; cursor: pointer;
      display: flex; align-items: center; justify-content: space-between;
      user-select: none; -webkit-tap-highlight-color: transparent; transition: background 0.2s;
    }
    #spa-page-menu-home .accordion-header:active { background: #f9fafb; }
    #spa-page-menu-home .accordion-header:hover { background: #eff6ff; }
    #spa-page-menu-home .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background: #f9fafb; }
    #spa-page-menu-home .accordion-content.open { max-height: 1000px; }
    #spa-page-menu-home .accordion-item {
      padding: 14px 20px 14px 56px; font-size: 15px; color: #4b5563; cursor: pointer;
      display: flex; align-items: center; gap: 10px; text-decoration: none;
      transition: background 0.2s; user-select: none; -webkit-tap-highlight-color: transparent; border-top: 1px solid #e5e7eb;
    }
    #spa-page-menu-home .accordion-item:active { background: #f3f4f6; }
    #spa-page-menu-home .accordion-item:hover { background: #f3f4f6; }
    #spa-page-menu-home .accordion-arrow { transition: transform 0.3s; font-size: 14px; color: #9ca3af; }
    #spa-page-menu-home .accordion-arrow.open { transform: rotate(180deg); }
    #spa-page-menu-home .menu-item-badge {
      background: #ef4444; color: white; border-radius: 10px; min-width: 18px; height: 18px;
      display: none; align-items: center; justify-content: center; font-size: 10px; font-weight: 700;
      padding: 0 5px; margin-left: auto;
    }
    #spa-page-menu-home .menu-item-badge.active { display: flex; }

    /* フォーカス抑制: ページ表示時に報酬管理等にフォーカスが当たるのを防止 */
    #spa-page-menu-home .menu-item:focus,
    #spa-page-menu-home .accordion-header:focus,
    #spa-page-menu-home .accordion-item:focus,
    #spa-page-menu-home a:focus {
      outline: none;
      box-shadow: none;
    }

    @media (max-width: 480px) {
      #spa-page-menu-home .menu-container { padding: 20px 14px; }
      #spa-page-menu-home .menu-header { margin-bottom: 16px; }
      #spa-page-menu-home .menu-logo { margin: -30px auto -40px; }
      #spa-page-menu-home .menu-items { gap: 8px; }
      #spa-page-menu-home .menu-item { padding: 5px 14px; font-size: 15px; }
      #spa-page-menu-home .menu-item-icon { width: 44px; height: 44px; }
      #spa-page-menu-home .accordion-header { padding: 5px 16px; font-size: 14px; }
      #spa-page-menu-home .accordion-item { padding: 12px 16px 12px 48px; font-size: 14px; }
    }
    @media (max-height: 700px) {
      #spa-page-menu-home .menu-container { padding: 16px 12px; }
      #spa-page-menu-home .menu-header { margin-bottom: 12px; }
      #spa-page-menu-home .menu-logo { width: min(240px, 62vw); margin: -25px auto -35px; }
      #spa-page-menu-home .menu-subtitle { font-size: 13px; }
      #spa-page-menu-home .menu-items { gap: 6px; }
      #spa-page-menu-home .menu-item { padding: 4px 12px; font-size: 14px; border-radius: 10px; }
      #spa-page-menu-home .menu-item-icon { width: 40px; height: 40px; }
      #spa-page-menu-home .accordion-menu { border-radius: 10px; }
      #spa-page-menu-home .accordion-header { padding: 4px 14px; font-size: 13px; }
      #spa-page-menu-home .accordion-item { padding: 10px 14px 10px 44px; font-size: 13px; }
    }
    @media (max-height: 600px) {
      #spa-page-menu-home { padding: 10px; }
      #spa-page-menu-home .menu-container { padding: 12px 10px; max-height: calc(100% - 20px); }
      #spa-page-menu-home .menu-header { margin-bottom: 8px; }
      #spa-page-menu-home .menu-logo { width: min(200px, 56vw); margin: -20px auto -28px; }
      #spa-page-menu-home .menu-items { gap: 5px; }
      #spa-page-menu-home .menu-item { padding: 3px 10px; font-size: 13px; border-width: 1px; }
      #spa-page-menu-home .menu-item-icon { width: 36px; height: 36px; }
      #spa-page-menu-home .accordion-header { padding: 3px 12px; font-size: 12px; }
      #spa-page-menu-home .accordion-item { padding: 8px 12px 8px 40px; font-size: 12px; }
    }
  </style>

  <div class="menu-container">
    <div class="menu-header">
      <img src="/images/furira-square-logo.png?v=20251209" alt="Furira" class="menu-logo" onerror="this.style.display='none';">
      <div class="menu-subtitle">物販管理システム</div>
    </div>

    <div class="menu-items" style="visibility:hidden">
      <a href="#" onclick="navigateToPage('product'); return false;" class="menu-item" id="mh-menu-product">
        <div class="menu-item-content">
          <span class="menu-item-icon"><img src="/images/menu-icons/menu-product.png?v=3" alt=""></span>
          <span>商品登録</span>
        </div>
      </a>
      <a href="#" onclick="navigateToPage('inventory'); return false;" class="menu-item" id="mh-menu-inventory">
        <div class="menu-item-content">
          <span class="menu-item-icon"><img src="/images/menu-icons/menu-inventory.png?v=3" alt=""></span>
          <span>在庫管理</span>
        </div>
      </a>
      <a href="#" onclick="navigateToPage('inventory_history'); return false;" class="menu-item" id="mh-menu-inventory_history">
        <div class="menu-item-content">
          <span class="menu-item-icon"><img src="/images/menu-icons/menu-history.png?v=7" alt=""></span>
          <span>資材管理</span>
        </div>
      </a>
      <a href="#" onclick="navigateToPage('stocktaking'); return false;" class="menu-item" id="mh-menu-stocktaking">
        <div class="menu-item-content">
          <span class="menu-item-icon"><img src="/images/menu-icons/menu-stocktaking.png?v=5" alt=""></span>
          <span>棚卸</span>
        </div>
      </a>
      <a href="#" onclick="navigateToPage('purchase'); return false;" class="menu-item" id="mh-menu-purchase">
        <div class="menu-item-content">
          <span class="menu-item-icon"><img src="/images/menu-icons/menu-purchase.png?v=4" alt=""></span>
          <span>仕入管理</span>
        </div>
      </a>
      <a href="#" onclick="navigateToPage('sales'); return false;" class="menu-item" id="mh-menu-sales">
        <div class="menu-item-content">
          <span class="menu-item-icon"><img src="/images/menu-icons/menu-sales.png?v=4" alt=""></span>
          <span>売上管理</span>
        </div>
      </a>
      <a href="#" onclick="navigateToPage('accounting'); return false;" class="menu-item" id="mh-menu-accounting">
        <div class="menu-item-content">
          <span class="menu-item-icon"><img src="/images/menu-icons/menu-accounting.png?v=3" alt=""></span>
          <span>確定申告</span>
        </div>
      </a>
      <a href="#" onclick="navigateToPage('compensation'); return false;" class="menu-item" id="mh-menu-compensation">
        <div class="menu-item-content">
          <span class="menu-item-icon"><img src="/images/menu-icons/menu-compensation.png?v=3" alt=""></span>
          <span>報酬管理</span>
        </div>
      </a>
      <!-- 回収管理: 一時的に非表示（改善後に復活予定）
      <a href="#" onclick="navigateToPage('pickup-management'); return false;" class="menu-item" id="mh-menu-pickup">
        <div class="menu-item-content">
          <span class="menu-item-icon"><i class="bi bi-box-seam" style="font-size: 24px; color: #40B4E5;"></i></span>
          <span>回収管理</span>
        </div>
      </a>
      -->

      <div class="accordion-menu">
        <div class="accordion-header" onclick="mhToggleAccordion('master')">
          <div class="menu-item-content">
            <span class="menu-item-icon"><img src="/images/menu-icons/menu-master.png?v=3" alt=""></span>
            <span>マスタ管理</span>
          </div>
          <span class="accordion-arrow" id="mh-master-arrow">▼</span>
        </div>
        <div class="accordion-content" id="mh-master-content">
          <a href="#" onclick="navigateToPage('master-product'); return false;" class="accordion-item" id="mh-menu-master-product">
            <img src="/images/menu-icons/menu-master-product.png?v=3" alt="" style="width: 28px; height: 28px; margin-right: 8px; vertical-align: middle;">商品マスタ管理
          </a>
          <a href="#" onclick="navigateToPage('master-business'); return false;" class="accordion-item" id="mh-menu-master-business">
            <img src="/images/menu-icons/menu-master-business.png?v=3" alt="" style="width: 28px; height: 28px; margin-right: 8px; vertical-align: middle;">業務マスタ管理
          </a>
        </div>
      </div>

      <div class="accordion-menu">
        <div class="accordion-header" onclick="mhToggleAccordion('config')">
          <div class="menu-item-content">
            <span class="menu-item-icon"><img src="/images/menu-icons/menu-config.png?v=3" alt=""></span>
            <span>設定管理</span>
          </div>
          <span class="accordion-arrow" id="mh-config-arrow">▼</span>
        </div>
        <div class="accordion-content" id="mh-config-content">
          <a href="#" onclick="navigateToPage('config-system'); return false;" class="accordion-item">
            <img src="/images/menu-icons/menu-config-system.png?v=3" alt="" style="width: 28px; height: 28px; margin-right: 8px; vertical-align: middle;">システム設定
          </a>
          <a href="#" onclick="navigateToPage('config-product'); return false;" class="accordion-item" id="mh-menu-config-product">
            <img src="/images/menu-icons/menu-config-product.png?v=3" alt="" style="width: 28px; height: 28px; margin-right: 8px; vertical-align: middle;">商品登録設定
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // menu_home Fragment — グローバル関数
  // v580: Firestoreにデータ無しの場合、owner-onlyとして非表示にするメニュー
  var _mhDefaultOwnerOnly = []; // pickup-management 一時非表示
  var _mhMenuIdMap = {
    'product': 'mh-menu-product',
    'inventory': 'mh-menu-inventory',
    'inventory_history': 'mh-menu-inventory_history',
    'stocktaking': 'mh-menu-stocktaking',
    'purchase': 'mh-menu-purchase',
    'sales': 'mh-menu-sales',
    'accounting': 'mh-menu-accounting',
    'compensation': 'mh-menu-compensation',
    // 'pickup-management': 'mh-menu-pickup', // 一時非表示
    'master-product': 'mh-menu-master-product',
    'master-business': 'mh-menu-master-business',
    'config-product': 'mh-menu-config-product',
    'config-system': 'mh-menu-config-system'
  };

  function initMenuHomePage() {
    console.log('[SPA menu_home] init開始');

    // フォーカス抑制: 全メニューアイテムからフォーカスを外す
    if (document.activeElement && document.activeElement !== document.body) {
      document.activeElement.blur();
    }
    var menuItems = document.querySelectorAll('#spa-page-menu-home a, #spa-page-menu-home .accordion-header');
    for (var i = 0; i < menuItems.length; i++) {
      menuItems[i].setAttribute('tabindex', '-1');
    }
    // 少し遅延してもう一度blur（SPA遷移アニメーション後対策）
    setTimeout(function() {
      if (document.activeElement && document.activeElement !== document.body) {
        document.activeElement.blur();
      }
    }, 100);

    // v587: キャッシュ済み非表示メニューを即時適用（チラつき防止）
    var permissionId = localStorage.getItem('reborn_user_permission_id')
                    || localStorage.getItem('reborn_user_permission');
    if (permissionId && permissionId !== 'owner') {
      // 前回のFirestoreチェック結果をキャッシュから即時適用
      try {
        var cached = JSON.parse(localStorage.getItem('reborn_hidden_menus') || '[]');
        for (var i = 0; i < cached.length; i++) {
          var cachedEl = document.getElementById(_mhMenuIdMap[cached[i]]);
          if (cachedEl) cachedEl.style.display = 'none';
        }
      } catch(e) {}
      // config-productは常に非表示（ハードコード）
      var el = document.getElementById('mh-menu-config-product');
      if (el) el.style.display = 'none';
    }

    // 権限フィルタリング完了 → メニューグリッドを表示
    var menuItemsGrid = document.querySelector('#spa-page-menu-home .menu-items');
    if (menuItemsGrid) menuItemsGrid.style.visibility = 'visible';

    // Firestore権限チェック + バッジ取得（キャッシュ更新含む）
    _mhCheckPermissionAndBadges();
  }

  function destroyMenuHomePage() {
    // クリーンアップ不要（リスナーなし）
  }

  var _mhPermRetryCount = 0;
  async function _mhCheckPermissionAndBadges() {
    // 親のcompat Firestoreを使用
    var db = (typeof getCompatDb === 'function') ? getCompatDb() : window.db;
    if (!db || typeof db.collection !== 'function') {
      _mhPermRetryCount++;
      if (_mhPermRetryCount < 10) {
        console.warn('[SPA menu_home] Firestore未初期化、リトライ(' + _mhPermRetryCount + ')');
        setTimeout(_mhCheckPermissionAndBadges, 500);
      }
      return;
    }

    var userEmail = localStorage.getItem('reborn_user_email');
    if (!userEmail) return;

    try {
      // 権限チェック
      var userDoc = await db.collection('users').doc(userEmail).get();
      if (userDoc.exists) {
        var userData = userDoc.data();
        var permissionId = userData.permissionId || 'staff';
        localStorage.setItem('reborn_user_permission', permissionId);

        // v580b: メニュー権限設定を取得（owner含む全ユーザーで実行）
        var menuPermDoc = await db.collection('settings').doc('menuPermissions').get();
        var menuPermissions = menuPermDoc.exists ? menuPermDoc.data() : {};
        console.log('[SPA menu_home] 権限チェック: permissionId=' + permissionId + ', menuPermDoc.exists=' + menuPermDoc.exists);
        var hiddenMenus = [];
        for (var menuId in _mhMenuIdMap) {
          var menuPerm = menuPermissions[menuId];
          var element = document.getElementById(_mhMenuIdMap[menuId]);
          if (!element) continue;
          if (permissionId === 'owner') continue; // ownerは全表示
          var isVisible = menuPerm
            ? (!menuPerm.visibleTo || menuPerm.visibleTo.includes(permissionId))
            : (_mhDefaultOwnerOnly.indexOf(menuId) === -1);
          if (!isVisible) {
            element.style.display = 'none';
            hiddenMenus.push(menuId);
            console.log('[SPA menu_home] 非表示: ' + menuId + ' (permissionId=' + permissionId + ')');
          }
        }
        // v587: 非表示メニューをキャッシュ（次回即時適用用）
        localStorage.setItem('reborn_hidden_menus', JSON.stringify(hiddenMenus));
      }

      // バッジ取得（Todo未完了 + チャット未読）
      // Todo
      var tasksRef = db.collection('userTasks').doc(userEmail).collection('tasks');
      var todoSnapshot = await tasksRef.where('completed', '==', false).get();
      console.log('[SPA menu_home] Todo未完了:', todoSnapshot.size);

      // チャット未読
      var totalUnread = 0;
      var roomsSnapshot = await db.collection('rooms').where('members', 'array-contains', userEmail).get();
      var roomIds = [];
      roomsSnapshot.forEach(function(roomDoc) { roomIds.push(roomDoc.id); });

      var defaultRoomIds = ['room_default_all', 'system', 'system-notifications', 'room_inventory_alert'];
      defaultRoomIds.forEach(function(id) { if (roomIds.indexOf(id) === -1) roomIds.push(id); });

      for (var i = 0; i < roomIds.length; i++) {
        try {
          var unreadDoc = await db.collection('rooms').doc(roomIds[i]).collection('unreadCounts').doc(userEmail).get();
          if (unreadDoc.exists) {
            var unreadData = unreadDoc.data();
            totalUnread += (unreadData && unreadData.unreadCount) || 0;
          }
        } catch (e) { /* ignore */ }
      }
      console.log('[SPA menu_home] Chat未読:', totalUnread);

    } catch (error) {
      console.error('[SPA menu_home] 権限/バッジエラー:', error);
    }
  }

  function mhToggleAccordion(type) {
    var content = document.getElementById('mh-' + type + '-content');
    var arrow = document.getElementById('mh-' + type + '-arrow');
    if (!content || !arrow) return;

    if (content.classList.contains('open')) {
      content.classList.remove('open');
      arrow.classList.remove('open');
    } else {
      content.classList.add('open');
      arrow.classList.add('open');
    }
  }
</script>
