<!-- SPA Fragment: menu_home (ホーム画面) -->
<div id="spa-page-menu-home">
  <style>
    #spa-page-menu-home {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      min-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    #spa-page-menu-home .menu-container {
      position: relative;
      width: 100%;
      max-width: 500px;
      max-height: calc(100% - 24px);
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 24px 16px;
      margin: 0 auto;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    #spa-page-menu-home .menu-items {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    #spa-page-menu-home .menu-header {
      text-align: center;
      margin-bottom: 20px;
    }
    #spa-page-menu-home .menu-logo {
      width: min(280px, 70vw);
      height: auto;
      margin: -35px auto -45px;
      display: block;
    }
    #spa-page-menu-home .menu-subtitle {
      font-size: 14px;
      color: #6b7280;
    }
    #spa-page-menu-home .menu-item {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 6px 16px;
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: space-between;
      text-decoration: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    #spa-page-menu-home .menu-item.full-width { grid-column: 1 / -1; }
    #spa-page-menu-home .menu-item:active { transform: scale(0.98); background: #f9fafb; }
    #spa-page-menu-home .menu-item:hover { border-color: var(--reborn-primary); background: var(--reborn-primary-lightest); }
    #spa-page-menu-home .menu-item.disabled { opacity: 0.5; cursor: not-allowed; background: #f9fafb; }
    #spa-page-menu-home .menu-item.disabled:active { transform: none; }
    #spa-page-menu-home .menu-item-content { display: flex; align-items: center; gap: 8px; flex-wrap: nowrap; }
    #spa-page-menu-home .menu-item-content > span { white-space: nowrap; flex-shrink: 0; }
    #spa-page-menu-home .menu-item-icon {
      font-size: 18px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    #spa-page-menu-home .menu-item-icon img { width: 100%; height: 100%; object-fit: contain; }
    #spa-page-menu-home .menu-item-arrow { font-size: 14px; color: #9ca3af; transition: transform 0.2s; }
    #spa-page-menu-home .accordion-menu {
      background: white; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden; transition: all 0.2s; grid-column: 1 / -1;
    }
    #spa-page-menu-home .accordion-header {
      padding: 6px 20px; font-size: 16px; font-weight: 600; color: #1f2937; cursor: pointer;
      display: flex; align-items: center; justify-content: space-between;
      user-select: none; -webkit-tap-highlight-color: transparent; transition: background 0.2s;
    }
    #spa-page-menu-home .accordion-header:active { background: #f9fafb; }
    #spa-page-menu-home .accordion-header:hover { background: #eff6ff; }
    #spa-page-menu-home .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background: #f9fafb; }
    #spa-page-menu-home .accordion-content.open { max-height: 1000px; }
    #spa-page-menu-home .accordion-item {
      padding: 14px 20px 14px 56px; font-size: 15px; color: #4b5563; cursor: pointer;
      display: flex; align-items: center; gap: 10px; text-decoration: none;
      transition: background 0.2s; user-select: none; -webkit-tap-highlight-color: transparent; border-top: 1px solid #e5e7eb;
    }
    #spa-page-menu-home .accordion-item:active { background: #f3f4f6; }
    #spa-page-menu-home .accordion-item:hover { background: #f3f4f6; }
    #spa-page-menu-home .accordion-arrow { transition: transform 0.3s; font-size: 14px; color: #9ca3af; }
    #spa-page-menu-home .accordion-arrow.open { transform: rotate(180deg); }
    #spa-page-menu-home .menu-item-badge {
      background: #ef4444; color: white; border-radius: 10px; min-width: 18px; height: 18px;
      display: none; align-items: center; justify-content: center; font-size: 10px; font-weight: 700;
      padding: 0 5px; margin-left: auto;
    }
    #spa-page-menu-home .menu-item-badge.active { display: flex; }

    /* フォーカス抑制: ページ表示時に報酬管理等にフォーカスが当たるのを防止 */
    #spa-page-menu-home .menu-item:focus,
    #spa-page-menu-home .accordion-header:focus,
    #spa-page-menu-home .accordion-item:focus,
    #spa-page-menu-home a:focus {
      outline: none;
      box-shadow: none;
    }

    @media (max-width: 480px) {
      #spa-page-menu-home .menu-container { padding: 20px 14px; }
      #spa-page-menu-home .menu-header { margin-bottom: 16px; }
      #spa-page-menu-home .menu-logo { margin: -30px auto -40px; }
      #spa-page-menu-home .menu-items { gap: 8px; }
      #spa-page-menu-home .menu-item { padding: 5px 14px; font-size: 15px; }
      #spa-page-menu-home .menu-item-icon { width: 44px; height: 44px; }
      #spa-page-menu-home .accordion-header { padding: 5px 16px; font-size: 14px; }
      #spa-page-menu-home .accordion-item { padding: 12px 16px 12px 48px; font-size: 14px; }
    }
    @media (max-height: 700px) {
      #spa-page-menu-home .menu-container { padding: 16px 12px; }
      #spa-page-menu-home .menu-header { margin-bottom: 12px; }
      #spa-page-menu-home .menu-logo { width: min(240px, 62vw); margin: -25px auto -35px; }
      #spa-page-menu-home .menu-subtitle { font-size: 13px; }
      #spa-page-menu-home .menu-items { gap: 6px; }
      #spa-page-menu-home .menu-item { padding: 4px 12px; font-size: 14px; border-radius: 10px; }
      #spa-page-menu-home .menu-item-icon { width: 40px; height: 40px; }
      #spa-page-menu-home .accordion-menu { border-radius: 10px; }
      #spa-page-menu-home .accordion-header { padding: 4px 14px; font-size: 13px; }
      #spa-page-menu-home .accordion-item { padding: 10px 14px 10px 44px; font-size: 13px; }
    }
    @media (max-height: 600px) {
      #spa-page-menu-home { padding: 10px; }
      #spa-page-menu-home .menu-container { padding: 12px 10px; max-height: calc(100% - 20px); }
      #spa-page-menu-home .menu-header { margin-bottom: 8px; }
      #spa-page-menu-home .menu-logo { width: min(200px, 56vw); margin: -20px auto -28px; }
      #spa-page-menu-home .menu-items { gap: 5px; }
      #spa-page-menu-home .menu-item { padding: 3px 10px; font-size: 13px; border-width: 1px; }
      #spa-page-menu-home .menu-item-icon { width: 36px; height: 36px; }
      #spa-page-menu-home .accordion-header { padding: 3px 12px; font-size: 12px; }
      #spa-page-menu-home .accordion-item { padding: 8px 12px 8px 40px; font-size: 12px; }
    }
  </style>

  <div class="menu-container">
    <div class="menu-header">
      <img src="/images/furira-square-logo.png?v=20251209" alt="Furira" class="menu-logo" onerror="this.style.display='none';">
      <div class="menu-subtitle">物販管理システム</div>
    </div>

    <!-- メニューグリッド: 空。initMenuHomePageがJSで許可メニューのみ動的生成 -->
    <div class="menu-items"></div>
    <!-- デバッグパネル（問題解決後に削除） -->
    <pre id="mh-debug-panel" style="margin-top:12px;padding:8px;background:#111;color:#0f0;font-size:10px;border-radius:8px;white-space:pre-wrap;word-break:break-all;max-height:120px;overflow-y:auto;"></pre>
  </div>
</div>

<script>
  // menu_home Fragment — 完全JS動的生成方式
  // HTMLにメニュー要素を一切持たず、許可されたメニューのみJSで生成。
  // 回収管理と同じ原理: 存在しないDOM要素は絶対に描画されない。

  // メニュー定義（データのみ。DOM要素はinitで生成）
  var _mhMenuDefs = [
    { key: 'product',           id: 'mh-menu-product',           page: 'product',           icon: 'menu-product.png?v=3',           label: '商品登録' },
    { key: 'inventory',         id: 'mh-menu-inventory',         page: 'inventory',         icon: 'menu-inventory.png?v=3',         label: '在庫管理' },
    { key: 'inventory_history', id: 'mh-menu-inventory_history', page: 'inventory_history', icon: 'menu-history.png?v=7',           label: '資材管理' },
    { key: 'stocktaking',       id: 'mh-menu-stocktaking',       page: 'stocktaking',       icon: 'menu-stocktaking.png?v=5',       label: '棚卸' },
    { key: 'purchase',          id: 'mh-menu-purchase',          page: 'purchase',          icon: 'menu-purchase.png?v=4',          label: '仕入管理' },
    { key: 'sales',             id: 'mh-menu-sales',             page: 'sales',             icon: 'menu-sales.png?v=4',             label: '売上管理' },
    { key: 'accounting',        id: 'mh-menu-accounting',        page: 'accounting',        icon: 'menu-accounting.png?v=3',        label: '確定申告' },
    { key: 'compensation',      id: 'mh-menu-compensation',      page: 'compensation',      icon: 'menu-compensation.png?v=3',      label: '報酬管理' }
  ];
  // アコーディオンメニュー定義
  var _mhAccordionDefs = [
    {
      key: 'master', icon: 'menu-master.png?v=3', label: 'マスタ管理',
      children: [
        { key: 'master-product',  id: 'mh-menu-master-product',  page: 'master-product',  icon: 'menu-master-product.png?v=3',  label: '商品マスタ管理' },
        { key: 'master-business', id: 'mh-menu-master-business', page: 'master-business', icon: 'menu-master-business.png?v=3', label: '業務マスタ管理' }
      ]
    },
    {
      key: 'config', icon: 'menu-config.png?v=3', label: '設定管理',
      children: [
        { key: 'config-system',  page: 'config-system',  icon: 'menu-config-system.png?v=3',  label: 'システム設定' },
        { key: 'config-product', id: 'mh-menu-config-product', page: 'config-product', icon: 'menu-config-product.png?v=3', label: '商品登録設定' }
      ]
    }
  ];

  // _mhMenuIdMap（_mhCheckPermissionAndBadges等で参照）
  var _mhMenuIdMap = {};
  (function() {
    for (var i = 0; i < _mhMenuDefs.length; i++) _mhMenuIdMap[_mhMenuDefs[i].key] = _mhMenuDefs[i].id;
    for (var a = 0; a < _mhAccordionDefs.length; a++) {
      for (var c = 0; c < _mhAccordionDefs[a].children.length; c++) {
        var ch = _mhAccordionDefs[a].children[c];
        if (ch.id) _mhMenuIdMap[ch.key] = ch.id;
      }
    }
  })();
  var _mhDefaultOwnerOnly = [];

  // ★ スタッフのデフォルト非表示メニュー（静的定義）
  // Firestoreキャッシュがない場合に使用。オーナーがカスタマイズした場合は
  // Firestoreから取得したデータがlocalStorageにキャッシュされ、次回起動で反映。
  var _mhDefaultStaffHidden = ['purchase', 'sales', 'accounting', 'compensation', 'config-product'];

  // メニューグリッド構築（hiddenSetに含まれるメニューはDOM要素を生成しない）
  function _mhBuildMenuGrid(hiddenSet) {
    var grid = document.querySelector('#spa-page-menu-home .menu-items');
    if (!grid) return;
    _mhDebug('buildMenuGrid: hidden=' + Object.keys(hiddenSet).join(','));
    grid.innerHTML = ''; // 既存を消して再構築

    var frag = document.createDocumentFragment();

    // 通常メニュー
    for (var i = 0; i < _mhMenuDefs.length; i++) {
      var def = _mhMenuDefs[i];
      if (hiddenSet[def.key]) continue;
      var a = document.createElement('a');
      a.href = '#';
      a.className = 'menu-item';
      a.id = def.id;
      a.setAttribute('tabindex', '-1');
      a.onclick = (function(p) { return function() { navigateToPage(p); return false; }; })(def.page);
      a.innerHTML = '<div class="menu-item-content"><span class="menu-item-icon"><img src="/images/menu-icons/' + def.icon + '" alt=""></span><span>' + def.label + '</span></div>';
      frag.appendChild(a);
    }

    // アコーディオンメニュー
    for (var ai = 0; ai < _mhAccordionDefs.length; ai++) {
      var acc = _mhAccordionDefs[ai];
      var wrap = document.createElement('div');
      wrap.className = 'accordion-menu';
      var header = document.createElement('div');
      header.className = 'accordion-header';
      header.setAttribute('tabindex', '-1');
      header.onclick = (function(k) { return function() { mhToggleAccordion(k); }; })(acc.key);
      header.innerHTML = '<div class="menu-item-content"><span class="menu-item-icon"><img src="/images/menu-icons/' + acc.icon + '" alt=""></span><span>' + acc.label + '</span></div><span class="accordion-arrow" id="mh-' + acc.key + '-arrow">▼</span>';
      wrap.appendChild(header);
      var content = document.createElement('div');
      content.className = 'accordion-content';
      content.id = 'mh-' + acc.key + '-content';
      var hasChild = false;
      for (var c = 0; c < acc.children.length; c++) {
        var ch = acc.children[c];
        if (hiddenSet[ch.key]) continue;
        hasChild = true;
        var item = document.createElement('a');
        item.href = '#';
        item.className = 'accordion-item';
        if (ch.id) item.id = ch.id;
        item.setAttribute('tabindex', '-1');
        item.onclick = (function(p) { return function() { navigateToPage(p); return false; }; })(ch.page);
        item.innerHTML = '<img src="/images/menu-icons/' + ch.icon + '" alt="" style="width:28px;height:28px;margin-right:8px;vertical-align:middle;">' + ch.label;
        content.appendChild(item);
      }
      wrap.appendChild(content);
      if (hasChild) frag.appendChild(wrap);
    }

    grid.appendChild(frag);
  }

  // Firestore応答待ちフラグ & タイムアウト
  // デバッグ表示（問題解決後に削除）
  var _mhDebugLog = [];
  function _mhDebug(msg) {
    _mhDebugLog.push('[' + new Date().toLocaleTimeString() + '] ' + msg);
    var el = document.getElementById('mh-debug-panel');
    if (el) el.textContent = _mhDebugLog.join('\n');
  }

  function initMenuHomePage() {
    _mhDebugLog = [];
    _mhDebug('init開始');

    // フォーカス抑制
    if (document.activeElement && document.activeElement !== document.body) {
      document.activeElement.blur();
    }
    setTimeout(function() {
      if (document.activeElement && document.activeElement !== document.body) {
        document.activeElement.blur();
      }
    }, 100);

    var grid = document.querySelector('#spa-page-menu-home .menu-items');
    if (!grid) return;

    // 再訪問時（DOM保持済み）はFirestoreバッジのみ更新
    if (grid.children.length > 0) {
      _mhDebug('再訪問: children=' + grid.children.length);
      _mhCheckPermissionAndBadges();
      return;
    }

    // ---- 初回訪問: メニュー即時構築（Firestore待ち不要） ----
    var permissionId = localStorage.getItem('reborn_user_permission_id')
                    || localStorage.getItem('reborn_user_permission');

    var hiddenSet = {};

    if (permissionId === 'owner') {
      _mhDebug('→ owner即時構築');
    } else {
      // スタッフ or 権限不明: キャッシュ → 静的デフォルトの順で非表示セット決定
      var raw = localStorage.getItem('reborn_hidden_menus');
      if (raw) {
        try {
          var cached = JSON.parse(raw);
          for (var i = 0; i < cached.length; i++) hiddenSet[cached[i]] = true;
        } catch(e) {}
        _mhDebug('→ cache使用, hidden=' + Object.keys(hiddenSet).join(','));
      } else {
        // キャッシュなし → 静的デフォルト使用（Firestore待ち不要）
        for (var d = 0; d < _mhDefaultStaffHidden.length; d++) {
          hiddenSet[_mhDefaultStaffHidden[d]] = true;
        }
        _mhDebug('→ 静的デフォルト使用, hidden=' + _mhDefaultStaffHidden.join(','));
      }
      hiddenSet['config-product'] = true;
    }

    // ★ 同期的にメニュー構築（Firestore待ち不要 → カクつきなし）
    _mhBuildMenuGrid(hiddenSet);

    // バックグラウンドでFirestoreチェック（キャッシュ更新 + バッジ取得のみ）
    _mhCheckPermissionAndBadges();
  }

  function destroyMenuHomePage() {
    // クリーンアップ（将来用）
  }

  var _mhPermRetryCount = 0;
  async function _mhCheckPermissionAndBadges() {
    // 親のcompat Firestoreを使用
    var db = (typeof getCompatDb === 'function') ? getCompatDb() : window.db;
    if (!db || typeof db.collection !== 'function') {
      _mhPermRetryCount++;
      if (_mhPermRetryCount < 10) {
        setTimeout(_mhCheckPermissionAndBadges, 500);
      }
      return;
    }

    var userEmail = localStorage.getItem('reborn_user_email');
    if (!userEmail) return;

    try {
      // 権限チェック → localStorageキャッシュ更新（次回起動で反映）
      var userDoc = await db.collection('users').doc(userEmail).get();
      if (userDoc.exists) {
        var userData = userDoc.data();
        var permissionId = userData.permissionId || 'staff';
        localStorage.setItem('reborn_user_permission', permissionId);

        // メニュー権限設定を取得 → キャッシュ更新のみ（DOM操作なし）
        var menuPermDoc = await db.collection('settings').doc('menuPermissions').get();
        var menuPermissions = menuPermDoc.exists ? menuPermDoc.data() : {};
        _mhDebug('Firestore応答: perm=' + permissionId + ', menuPermKeys=' + Object.keys(menuPermissions).join(','));
        var hiddenMenus = [];
        for (var menuId in _mhMenuIdMap) {
          var menuPerm = menuPermissions[menuId];
          if (permissionId === 'owner') continue;
          var isVisible = menuPerm
            ? (!menuPerm.visibleTo || menuPerm.visibleTo.includes(permissionId))
            : (_mhDefaultOwnerOnly.indexOf(menuId) === -1);
          if (!isVisible) {
            hiddenMenus.push(menuId);
          }
        }
        localStorage.setItem('reborn_hidden_menus', JSON.stringify(hiddenMenus));
        _mhDebug('キャッシュ更新: hidden=' + hiddenMenus.join(','));
      }

      // バッジ取得（Todo未完了 + チャット未読）
      var tasksRef = db.collection('userTasks').doc(userEmail).collection('tasks');
      var todoSnapshot = await tasksRef.where('completed', '==', false).get();

      var totalUnread = 0;
      var roomsSnapshot = await db.collection('rooms').where('members', 'array-contains', userEmail).get();
      var roomIds = [];
      roomsSnapshot.forEach(function(roomDoc) { roomIds.push(roomDoc.id); });

      var defaultRoomIds = ['room_default_all', 'system', 'system-notifications', 'room_inventory_alert'];
      defaultRoomIds.forEach(function(id) { if (roomIds.indexOf(id) === -1) roomIds.push(id); });

      for (var i = 0; i < roomIds.length; i++) {
        try {
          var unreadDoc = await db.collection('rooms').doc(roomIds[i]).collection('unreadCounts').doc(userEmail).get();
          if (unreadDoc.exists) {
            var unreadData = unreadDoc.data();
            totalUnread += (unreadData && unreadData.unreadCount) || 0;
          }
        } catch (e) { /* ignore */ }
      }

    } catch (error) {
      console.error('[SPA menu_home] 権限/バッジエラー:', error);
    }
  }

  function mhToggleAccordion(type) {
    var content = document.getElementById('mh-' + type + '-content');
    var arrow = document.getElementById('mh-' + type + '-arrow');
    if (!content || !arrow) return;

    if (content.classList.contains('open')) {
      content.classList.remove('open');
      arrow.classList.remove('open');
    } else {
      content.classList.add('open');
      arrow.classList.add('open');
    }
  }
</script>
