<!-- SPA Fragment: plans (プラン管理) -->
<div id="spa-page-plans">
  <style>
    #spa-page-plans {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: #f8f9fa;
      min-height: 100vh;
    }
    #spa-page-plans .page-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      padding: 20px;
      padding-top: calc(20px + env(safe-area-inset-top, 0px));
      color: white;
      text-align: center;
      z-index: 1000;
    }
    #spa-page-plans .page-header h1 {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }
    #spa-page-plans .page-header .back-button {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      left: 16px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      width: 38px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: white;
      font-size: 18px;
      margin-top: calc(env(safe-area-inset-top, 0px) / 2);
    }
    #spa-page-plans .page-header .back-button:active {
      background: rgba(255, 255, 255, 0.3);
    }
    #spa-page-plans .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      padding-top: calc(70px + env(safe-area-inset-top, 0px));
    }
    #spa-page-plans .current-plan-banner {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    #spa-page-plans .current-plan-banner i { font-size: 24px; }
    #spa-page-plans .current-plan-info { flex: 1; }
    #spa-page-plans .current-plan-label { font-size: 12px; opacity: 0.9; }
    #spa-page-plans .current-plan-name { font-size: 18px; font-weight: 700; }
    #spa-page-plans .page-description {
      color: #6b7280;
      font-size: 14px;
      margin-bottom: 24px;
      line-height: 1.6;
      text-align: center;
    }
    #spa-page-plans .plans-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    @media (min-width: 768px) {
      #spa-page-plans .plans-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    #spa-page-plans .plan-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 2px solid transparent;
      transition: all 0.2s;
      position: relative;
    }
    #spa-page-plans .plan-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }
    #spa-page-plans .plan-card.recommended { border-color: #40B4E5; }
    #spa-page-plans .plan-card.current { border-color: #10b981; background: #f0fdf4; }
    #spa-page-plans .plan-badge {
      position: absolute;
      top: -12px;
      right: 16px;
      background: #40B4E5;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    #spa-page-plans .plan-badge.current { background: #10b981; }
    #spa-page-plans .plan-name { font-size: 20px; font-weight: 700; color: #1f2937; margin-bottom: 8px; }
    #spa-page-plans .plan-price { margin-bottom: 16px; }
    #spa-page-plans .plan-price .amount { font-size: 32px; font-weight: 800; color: #1f2937; }
    #spa-page-plans .plan-price .period { font-size: 14px; color: #6b7280; }
    #spa-page-plans .plan-description { font-size: 13px; color: #6b7280; margin-bottom: 20px; line-height: 1.5; }
    #spa-page-plans .plan-features { list-style: none; padding: 0; margin: 0 0 20px 0; }
    #spa-page-plans .plan-features li {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 8px 0;
      font-size: 14px;
      color: #374151;
      border-bottom: 1px solid #f3f4f6;
    }
    #spa-page-plans .plan-features li:last-child { border-bottom: none; }
    #spa-page-plans .plan-features li i { color: #10b981; font-size: 16px; margin-top: 2px; }
    #spa-page-plans .plan-features li i.disabled { color: #d1d5db; }
    #spa-page-plans .plan-features li.disabled { color: #9ca3af; text-decoration: line-through; }
    #spa-page-plans .plan-btn {
      width: 100%;
      padding: 14px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    #spa-page-plans .plan-btn.primary {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      color: white;
    }
    #spa-page-plans .plan-btn.primary:hover { opacity: 0.9; }
    #spa-page-plans .plan-btn.secondary { background: #f3f4f6; color: #6b7280; }
    #spa-page-plans .plan-btn.secondary:hover { background: #e5e7eb; }
    #spa-page-plans .plan-btn.current { background: #10b981; color: white; cursor: default; }
    #spa-page-plans .plan-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    #spa-page-plans .note {
      background: #fef3c7;
      border-radius: 8px;
      padding: 16px;
      font-size: 13px;
      color: #92400e;
      margin-top: 24px;
    }
    #spa-page-plans .note i { margin-right: 6px; }
    #spa-page-plans .note-title { font-weight: 600; margin-bottom: 8px; }
    #spa-page-plans .note ul { margin: 8px 0 0 0; padding-left: 20px; }
    #spa-page-plans .note li { margin-bottom: 4px; }
    #spa-page-plans .comparison-section { margin-top: 32px; }
    #spa-page-plans .comparison-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 16px;
      text-align: center;
    }
    #spa-page-plans .comparison-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    #spa-page-plans .comparison-table th,
    #spa-page-plans .comparison-table td {
      padding: 12px 16px;
      text-align: center;
      border-bottom: 1px solid #f3f4f6;
      font-size: 14px;
    }
    #spa-page-plans .comparison-table th {
      background: #f9fafb;
      font-weight: 600;
      color: #374151;
    }
    #spa-page-plans .comparison-table th:first-child,
    #spa-page-plans .comparison-table td:first-child {
      text-align: left;
      font-weight: 500;
    }
    #spa-page-plans .comparison-table tr:last-child td { border-bottom: none; }
    #spa-page-plans .comparison-table .check { color: #10b981; font-size: 18px; }
    #spa-page-plans .comparison-table .cross { color: #d1d5db; font-size: 18px; }
  </style>

  <div class="page-header">
    <button class="back-button" onclick="spaGoBack()">
      <i class="bi bi-chevron-left"></i>
    </button>
    <h1>プラン管理</h1>
  </div>

  <div class="container">
    <div class="current-plan-banner">
      <i class="bi bi-award"></i>
      <div class="current-plan-info">
        <div class="current-plan-label">現在のプラン</div>
        <div class="current-plan-name" id="plans-currentPlanName">Free</div>
      </div>
    </div>

    <p class="page-description">
      ビジネスの成長に合わせて、最適なプランをお選びください。<br>
      いつでもアップグレード・ダウングレードが可能です。
    </p>

    <div class="plans-grid">
      <div class="plan-card current" id="plans-planFree">
        <span class="plan-badge current">現在のプラン</span>
        <div class="plan-name">Free</div>
        <div class="plan-price">
          <span class="amount">¥0</span>
          <span class="period">/月</span>
        </div>
        <div class="plan-description">個人での小規模運用に最適。<br>基本機能をお試しください。</div>
        <ul class="plan-features">
          <li><i class="bi bi-check-circle-fill"></i> 商品登録 50件/月</li>
          <li><i class="bi bi-check-circle-fill"></i> 在庫管理</li>
          <li><i class="bi bi-check-circle-fill"></i> 販売記録</li>
          <li><i class="bi bi-check-circle-fill"></i> AIサポート 10回/月</li>
          <li class="disabled"><i class="bi bi-x-circle disabled"></i> チームメンバー追加</li>
          <li class="disabled"><i class="bi bi-x-circle disabled"></i> 自動化機能</li>
        </ul>
        <button class="plan-btn current" disabled>現在のプラン</button>
      </div>

      <div class="plan-card recommended" id="plans-planStandard">
        <span class="plan-badge">おすすめ</span>
        <div class="plan-name">Standard</div>
        <div class="plan-price">
          <span class="amount">¥980</span>
          <span class="period">/月</span>
        </div>
        <div class="plan-description">成長中のビジネスに最適。<br>チーム運用と効率化を実現。</div>
        <ul class="plan-features">
          <li><i class="bi bi-check-circle-fill"></i> 商品登録 無制限</li>
          <li><i class="bi bi-check-circle-fill"></i> 在庫管理</li>
          <li><i class="bi bi-check-circle-fill"></i> 販売記録</li>
          <li><i class="bi bi-check-circle-fill"></i> AIサポート 50回/月</li>
          <li><i class="bi bi-check-circle-fill"></i> チームメンバー 3人まで</li>
          <li class="disabled"><i class="bi bi-x-circle disabled"></i> 完全自動化</li>
        </ul>
        <button class="plan-btn primary" onclick="plansSelectPlan('standard')">アップグレード</button>
      </div>

      <div class="plan-card" id="plans-planPro">
        <div class="plan-name">Pro</div>
        <div class="plan-price">
          <span class="amount">¥2,980</span>
          <span class="period">/月</span>
        </div>
        <div class="plan-description">本格的なEC運営に。<br>完全自動化で業務効率を最大化。</div>
        <ul class="plan-features">
          <li><i class="bi bi-check-circle-fill"></i> 商品登録 無制限</li>
          <li><i class="bi bi-check-circle-fill"></i> 在庫管理</li>
          <li><i class="bi bi-check-circle-fill"></i> 販売記録</li>
          <li><i class="bi bi-check-circle-fill"></i> AIサポート 無制限</li>
          <li><i class="bi bi-check-circle-fill"></i> チームメンバー 無制限</li>
          <li><i class="bi bi-check-circle-fill"></i> 完全自動化機能</li>
        </ul>
        <button class="plan-btn primary" onclick="plansSelectPlan('pro')">アップグレード</button>
      </div>
    </div>

    <div class="comparison-section">
      <h2 class="comparison-title">機能比較表</h2>
      <table class="comparison-table">
        <thead>
          <tr><th>機能</th><th>Free</th><th>Standard</th><th>Pro</th></tr>
        </thead>
        <tbody>
          <tr><td>商品登録</td><td>50件/月</td><td>無制限</td><td>無制限</td></tr>
          <tr><td>AIサポート</td><td>10回/月</td><td>50回/月</td><td>無制限</td></tr>
          <tr><td>チームメンバー</td><td>1人</td><td>3人</td><td>無制限</td></tr>
          <tr><td>発送方法事前設定</td><td><i class="bi bi-x-lg cross"></i></td><td><i class="bi bi-check-lg check"></i></td><td><i class="bi bi-check-lg check"></i></td></tr>
          <tr><td>販売時自動入力</td><td><i class="bi bi-x-lg cross"></i></td><td><i class="bi bi-x-lg cross"></i></td><td><i class="bi bi-check-lg check"></i></td></tr>
          <tr><td>詳細レポート</td><td><i class="bi bi-x-lg cross"></i></td><td><i class="bi bi-check-lg check"></i></td><td><i class="bi bi-check-lg check"></i></td></tr>
          <tr><td>優先サポート</td><td><i class="bi bi-x-lg cross"></i></td><td><i class="bi bi-x-lg cross"></i></td><td><i class="bi bi-check-lg check"></i></td></tr>
        </tbody>
      </table>
    </div>

    <div class="note">
      <div class="note-title"><i class="bi bi-info-circle"></i> プラン変更について</div>
      <ul>
        <li>アップグレードは即時反映されます</li>
        <li>ダウングレードは次回請求日から適用されます</li>
        <li>年間プランは2ヶ月分お得です（近日公開予定）</li>
        <li>14日間の無料トライアル期間があります</li>
      </ul>
    </div>
  </div>
</div>

<script>
  // plans Fragment — グローバル関数
  var _plansCurrentPlan = 'free';

  function initPlansPage() {
    var savedPlan = localStorage.getItem('furira_plan') || 'free';
    _plansCurrentPlan = savedPlan;
    _plansUpdateDisplay();
  }

  function destroyPlansPage() {
    // クリーンアップ不要（リスナーなし）
  }

  function _plansUpdateDisplay() {
    var planNames = { 'free': 'Free', 'standard': 'Standard', 'pro': 'Pro' };
    var el = document.getElementById('plans-currentPlanName');
    if (el) el.textContent = planNames[_plansCurrentPlan] || 'Free';

    var cards = document.querySelectorAll('#spa-page-plans .plan-card');
    cards.forEach(function(card) {
      card.classList.remove('current');
      var badge = card.querySelector('.plan-badge');
      if (badge && badge.classList.contains('current')) badge.remove();
      var btn = card.querySelector('.plan-btn');
      if (btn) {
        btn.classList.remove('current');
        btn.disabled = false;
        if (card.id === 'plans-planFree') {
          btn.textContent = 'ダウングレード';
          btn.classList.add('secondary');
          btn.classList.remove('primary');
        } else {
          btn.textContent = 'アップグレード';
          btn.classList.add('primary');
          btn.classList.remove('secondary');
        }
      }
    });

    var currentCard = document.getElementById('plans-plan' + _plansCurrentPlan.charAt(0).toUpperCase() + _plansCurrentPlan.slice(1));
    if (currentCard) {
      currentCard.classList.add('current');
      var existingBadge = currentCard.querySelector('.plan-badge');
      if (existingBadge) {
        existingBadge.textContent = '現在のプラン';
        existingBadge.classList.add('current');
      } else {
        var badge = document.createElement('span');
        badge.className = 'plan-badge current';
        badge.textContent = '現在のプラン';
        currentCard.appendChild(badge);
      }
      var btn = currentCard.querySelector('.plan-btn');
      if (btn) {
        btn.textContent = '現在のプラン';
        btn.classList.add('current');
        btn.classList.remove('primary', 'secondary');
        btn.disabled = true;
      }
    }

    if (_plansCurrentPlan !== 'standard') {
      var standardCard = document.getElementById('plans-planStandard');
      if (standardCard) {
        var existingBadge = standardCard.querySelector('.plan-badge');
        if (!existingBadge) {
          var badge = document.createElement('span');
          badge.className = 'plan-badge';
          badge.textContent = 'おすすめ';
          standardCard.appendChild(badge);
        } else if (!existingBadge.classList.contains('current')) {
          existingBadge.textContent = 'おすすめ';
        }
      }
    }
  }

  function plansSelectPlan(plan) {
    var planNames = { 'free': 'Free', 'standard': 'Standard', 'pro': 'Pro' };
    var planPrices = { 'free': '¥0', 'standard': '¥980', 'pro': '¥2,980' };
    var isUpgrade = (_plansCurrentPlan === 'free') || (_plansCurrentPlan === 'standard' && plan === 'pro');
    var action = isUpgrade ? 'アップグレード' : 'ダウングレード';

    var confirmed = confirm(
      planNames[plan] + 'プラン（' + planPrices[plan] + '/月）に' + action + 'しますか？\n\n' +
      '※ 現在は開発中のため、実際の課金は発生しません。'
    );

    if (confirmed) {
      localStorage.setItem('furira_plan', plan);
      _plansCurrentPlan = plan;
      _plansUpdateDisplay();
      alert(planNames[plan] + 'プランへの' + action + 'が完了しました！\n\n（開発中のためデモ動作です）');
    }
  }
</script>
