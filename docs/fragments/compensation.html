<!-- SPA Fragment: compensation.html -->
<!-- Prefix: comp- -->
<div id="spa-page-compensation">
  <style>
    #spa-page-compensation {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    #spa-page-compensation .comp-content-container {
      padding: 16px;
      max-width: 1000px;
      margin: 0 auto;
    }

    /* タブ - Bootstrap互換インラインスタイル */
    #spa-page-compensation .comp-nav-tabs-custom {
      background: white;
      border-radius: 12px;
      padding: 8px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: flex;
      flex-wrap: wrap;
      list-style: none;
    }
    #spa-page-compensation .comp-nav-tabs-custom .comp-nav-link {
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      color: #6b7280;
      font-weight: 500;
      background: none;
      cursor: pointer;
      font-size: 14px;
    }
    #spa-page-compensation .comp-nav-tabs-custom .comp-nav-link.active {
      background: #40B4E5;
      color: white;
    }

    /* カード */
    #spa-page-compensation .comp-card-section {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    #spa-page-compensation .comp-card-section h6 {
      color: #374151;
      font-weight: 600;
      margin-bottom: 12px;
      font-size: 1rem;
    }

    /* サマリーグリッド */
    #spa-page-compensation .comp-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    #spa-page-compensation .comp-summary-card {
      background: white;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    #spa-page-compensation .comp-summary-card.highlight {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      color: white;
    }
    #spa-page-compensation .comp-summary-card.highlight .comp-summary-label { color: rgba(255,255,255,0.8); }
    #spa-page-compensation .comp-summary-card.highlight .comp-summary-value { color: white; }
    #spa-page-compensation .comp-summary-label {
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 4px;
    }
    #spa-page-compensation .comp-summary-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1f2937;
    }

    /* テーブル */
    #spa-page-compensation .comp-data-table {
      width: 100%;
      font-size: 0.875rem;
      border-collapse: collapse;
    }
    #spa-page-compensation .comp-data-table th {
      background: #f9fafb;
      padding: 12px 8px;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
      white-space: nowrap;
      text-align: left;
    }
    #spa-page-compensation .comp-data-table td {
      padding: 12px 8px;
      border-bottom: 1px solid #f3f4f6;
      vertical-align: middle;
    }
    #spa-page-compensation .comp-data-table tr:hover { background: #f9fafb; }

    /* スタッフカード */
    #spa-page-compensation .comp-staff-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      gap: 16px;
    }
    #spa-page-compensation .comp-staff-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    #spa-page-compensation .comp-staff-info { flex: 1; }
    #spa-page-compensation .comp-staff-name {
      font-weight: 600;
      color: #1f2937;
      font-size: 14px;
    }
    #spa-page-compensation .comp-staff-role {
      font-size: 12px;
      color: #6b7280;
    }
    #spa-page-compensation .comp-staff-stats { text-align: right; }
    #spa-page-compensation .comp-staff-amount {
      font-size: 18px;
      font-weight: 700;
      color: #40B4E5;
    }
    #spa-page-compensation .comp-staff-tasks {
      font-size: 12px;
      color: #6b7280;
    }

    /* ステータスバッジ */
    #spa-page-compensation .comp-status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    #spa-page-compensation .comp-status-badge.unpaid {
      background: #fef3c7;
      color: #b45309;
    }
    #spa-page-compensation .comp-status-badge.paid {
      background: #dcfce7;
      color: #166534;
    }

    /* ローディング */
    #spa-page-compensation .comp-loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    /* 期間選択 */
    #spa-page-compensation .comp-period-selector {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* サブヘッダー */
    #spa-page-compensation .comp-sub-header {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 56px;
      padding: 0 16px;
      background: #ffffff;
      border-bottom: 1px solid #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    #spa-page-compensation .comp-sub-header-back {
      position: absolute;
      left: 16px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 20px;
      transition: background 0.2s;
    }
    #spa-page-compensation .comp-sub-header-back:hover { background: #f2f2f2; }
    #spa-page-compensation .comp-sub-header-back:active { background: #e5e5e5; }
    #spa-page-compensation .comp-sub-header-title {
      font-weight: 600;
      font-size: 16px;
      color: #1f2937;
    }
    #spa-page-compensation .comp-sub-header-icons {
      position: absolute;
      right: 16px;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    #spa-page-compensation .comp-sub-header-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 20px;
      transition: background 0.2s;
      position: relative;
    }
    #spa-page-compensation .comp-sub-header-icon:hover { background: #f2f2f2; }
    #spa-page-compensation .comp-announce-dot {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      display: none;
    }
    #spa-page-compensation .comp-settings-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 200px;
      padding: 8px 0;
      display: none;
      z-index: 1001;
    }
    #spa-page-compensation .comp-settings-dropdown.active { display: block; }
    #spa-page-compensation .comp-settings-dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border: none;
      background: none;
      width: 100%;
      font-size: 14px;
      color: #374151;
      cursor: pointer;
      text-align: left;
    }
    #spa-page-compensation .comp-settings-dropdown-item:hover { background: #f3f4f6; }
    #spa-page-compensation .comp-settings-dropdown-item i {
      font-size: 18px;
      color: #6b7280;
      width: 20px;
      text-align: center;
    }

    /* タブコンテンツ */
    #spa-page-compensation .comp-tab-pane { display: none; }
    #spa-page-compensation .comp-tab-pane.active { display: block; }

    /* フォームスタイル */
    #spa-page-compensation select,
    #spa-page-compensation input[type="date"],
    #spa-page-compensation input[type="number"] {
      padding: 6px 12px;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      font-size: 14px;
    }

    #spa-page-compensation .comp-btn-primary {
      background: #40B4E5;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
    }
    #spa-page-compensation .comp-btn-primary:hover { background: #1E8FBF; }

    #spa-page-compensation .comp-btn-outline {
      background: white;
      color: #6b7280;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
    }

    /* レスポンシブ */
    @media (max-width: 576px) {
      #spa-page-compensation .comp-summary-grid { grid-template-columns: repeat(2, 1fr); }
      #spa-page-compensation .comp-staff-card { flex-wrap: wrap; }
      #spa-page-compensation .comp-staff-stats { width: 100%; text-align: left; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb; }
    }

    #spa-page-compensation .text-end { text-align: right; }
    #spa-page-compensation .text-center { text-align: center; }
    #spa-page-compensation .text-muted { color: #6b7280; }
    #spa-page-compensation .fw-bold { font-weight: 700; }
    #spa-page-compensation .py-4 { padding-top: 1.5rem; padding-bottom: 1.5rem; }
    #spa-page-compensation .small { font-size: 0.875rem; }
    #spa-page-compensation .mb-0 { margin-bottom: 0; }
    #spa-page-compensation .w-100 { width: 100%; }
    #spa-page-compensation .table-responsive { overflow-x: auto; }

    #spa-page-compensation .comp-row { display: flex; flex-wrap: wrap; gap: 8px; }
    #spa-page-compensation .comp-col { flex: 1; min-width: 120px; }
  </style>

  <!-- ローディング -->
  <div class="comp-loading-overlay" id="comp-loadingOverlay">
    <div style="text-align: center;">
      <div style="width:32px;height:32px;border:4px solid #e5e7eb;border-top-color:#40B4E5;border-radius:50%;animation:compSpin 1s linear infinite;margin:0 auto;"></div>
      <p style="margin-top:8px;color:#6b7280;">データを読み込んでいます...</p>
    </div>
  </div>
  <style>
    @keyframes compSpin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>

  <!-- サブヘッダー -->
  <div class="comp-sub-header">
    <button class="comp-sub-header-back" onclick="compGoBack()" title="戻る">
      <i class="bi bi-chevron-left"></i>
    </button>
    <span class="comp-sub-header-title">報酬管理</span>
    <div class="comp-sub-header-icons">
      <button class="comp-sub-header-icon" title="通知" onclick="compOpenAnnouncePage()">
        <i class="bi bi-bell"></i>
        <span class="comp-announce-dot" id="comp-announceDot"></span>
      </button>
      <div style="position: relative;">
        <button class="comp-sub-header-icon" title="メニュー" onclick="compToggleSettingsDropdown(event)">
          <i class="bi bi-list"></i>
        </button>
        <div class="comp-settings-dropdown" id="comp-settingsDropdown">
          <button class="comp-settings-dropdown-item" onclick="compExportToCSV()">
            <i class="bi bi-download"></i>
            <span>CSVエクスポート</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="comp-content-container">
    <!-- 期間選択 -->
    <div class="comp-card-section">
      <div class="comp-period-selector">
        <label class="small fw-bold mb-0">対象期間:</label>
        <select id="comp-periodYear" style="width: auto;" onchange="compLoadCompensationData()"></select>
        <select id="comp-periodMonth" style="width: auto;" onchange="compLoadCompensationData()">
          <option value="all">全月</option>
          <option value="1">1月</option>
          <option value="2">2月</option>
          <option value="3">3月</option>
          <option value="4">4月</option>
          <option value="5">5月</option>
          <option value="6">6月</option>
          <option value="7">7月</option>
          <option value="8">8月</option>
          <option value="9">9月</option>
          <option value="10">10月</option>
          <option value="11">11月</option>
          <option value="12">12月</option>
        </select>
        <span class="text-muted small" id="comp-periodDisplay"></span>
      </div>
    </div>

    <!-- タブ -->
    <ul class="comp-nav-tabs-custom">
      <li><button class="comp-nav-link active" onclick="compSwitchTab('comp-summary-tab', this)"><i class="bi bi-bar-chart-line"></i> サマリー</button></li>
      <li><button class="comp-nav-link" onclick="compSwitchTab('comp-staff-tab', this)"><i class="bi bi-person"></i> 担当者別</button></li>
      <li><button class="comp-nav-link" onclick="compSwitchTab('comp-detail-tab', this)"><i class="bi bi-list-ul"></i> 明細</button></li>
      <li><button class="comp-nav-link" onclick="compSwitchTab('comp-payment-tab', this)"><i class="bi bi-credit-card"></i> 支払管理</button></li>
    </ul>

    <!-- タブコンテンツ -->
    <!-- サマリータブ -->
    <div class="comp-tab-pane active" id="comp-summary-tab">
      <div class="comp-summary-grid">
        <div class="comp-summary-card highlight">
          <div class="comp-summary-label">報酬総額</div>
          <div class="comp-summary-value" id="comp-kpi-total">&yen;0</div>
        </div>
        <div class="comp-summary-card">
          <div class="comp-summary-label">未払い</div>
          <div class="comp-summary-value" id="comp-kpi-unpaid">&yen;0</div>
        </div>
        <div class="comp-summary-card">
          <div class="comp-summary-label">支払済</div>
          <div class="comp-summary-value" id="comp-kpi-paid">&yen;0</div>
        </div>
        <div class="comp-summary-card">
          <div class="comp-summary-label">対象件数</div>
          <div class="comp-summary-value" id="comp-kpi-count">0件</div>
        </div>
      </div>

      <div class="comp-card-section">
        <h6><i class="bi bi-pie-chart"></i> タスク種別内訳</h6>
        <div class="table-responsive">
          <table class="comp-data-table">
            <thead>
              <tr>
                <th>タスク</th>
                <th class="text-end">件数</th>
                <th class="text-end">単価</th>
                <th class="text-end">金額</th>
              </tr>
            </thead>
            <tbody id="comp-taskBreakdownBody">
              <tr><td colspan="4" class="text-center text-muted py-4">データがありません</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="comp-card-section">
        <h6><i class="bi bi-graph-up"></i> 月別推移</h6>
        <div class="table-responsive">
          <table class="comp-data-table">
            <thead>
              <tr>
                <th>月</th>
                <th class="text-end">件数</th>
                <th class="text-end">報酬額</th>
              </tr>
            </thead>
            <tbody id="comp-monthlyTrendBody">
              <tr><td colspan="3" class="text-center text-muted py-4">データがありません</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 担当者別タブ -->
    <div class="comp-tab-pane" id="comp-staff-tab">
      <div id="comp-staffList">
        <div class="text-center text-muted py-4">データを読み込んでいます...</div>
      </div>
    </div>

    <!-- 明細タブ -->
    <div class="comp-tab-pane" id="comp-detail-tab">
      <div class="comp-card-section">
        <div class="comp-row">
          <div class="comp-col">
            <select id="comp-filterStaff" onchange="compFilterRecords()" style="width:100%;padding:6px;border:1px solid #dee2e6;border-radius:6px;">
              <option value="">全担当者</option>
            </select>
          </div>
          <div class="comp-col">
            <select id="comp-filterTask" onchange="compFilterRecords()" style="width:100%;padding:6px;border:1px solid #dee2e6;border-radius:6px;">
              <option value="">全タスク</option>
              <option value="listing">商品出品</option>
              <option value="shipping">梱包・発送</option>
              <option value="photography">商品撮影</option>
              <option value="inspection">検品作業</option>
            </select>
          </div>
          <div class="comp-col">
            <select id="comp-filterStatus" onchange="compFilterRecords()" style="width:100%;padding:6px;border:1px solid #dee2e6;border-radius:6px;">
              <option value="">全ステータス</option>
              <option value="unpaid">未払い</option>
              <option value="paid">支払済</option>
            </select>
          </div>
          <div class="comp-col">
            <button class="comp-btn-outline w-100" onclick="compResetFilters()">
              <i class="bi bi-x-circle"></i> リセット
            </button>
          </div>
        </div>
      </div>

      <div class="comp-card-section">
        <div class="table-responsive">
          <table class="comp-data-table">
            <thead>
              <tr>
                <th>日付</th>
                <th>担当者</th>
                <th>タスク</th>
                <th>商品</th>
                <th class="text-end">金額</th>
                <th>ステータス</th>
              </tr>
            </thead>
            <tbody id="comp-detailBody">
              <tr><td colspan="6" class="text-center text-muted py-4">データがありません</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 支払管理タブ -->
    <div class="comp-tab-pane" id="comp-payment-tab">
      <div class="comp-card-section">
        <h6><i class="bi bi-cash-stack"></i> 支払処理</h6>
        <div class="comp-row">
          <div class="comp-col">
            <label class="small">担当者</label>
            <select id="comp-paymentStaff" style="width:100%;padding:6px;border:1px solid #dee2e6;border-radius:6px;">
              <option value="">選択してください</option>
            </select>
          </div>
          <div class="comp-col">
            <label class="small">支払日</label>
            <input type="date" id="comp-paymentDate" style="width:100%;padding:6px;border:1px solid #dee2e6;border-radius:6px;">
          </div>
          <div class="comp-col">
            <label class="small">支払金額</label>
            <input type="number" id="comp-paymentAmount" readonly style="width:100%;padding:6px;border:1px solid #dee2e6;border-radius:6px;background:#f3f4f6;">
          </div>
          <div class="comp-col" style="display:flex;align-items:flex-end;">
            <button class="comp-btn-primary w-100" onclick="compProcessPayment()">
              <i class="bi bi-check-circle"></i> 支払処理
            </button>
          </div>
        </div>
      </div>

      <div class="comp-card-section">
        <h6><i class="bi bi-clock-history"></i> 支払履歴</h6>
        <div class="table-responsive">
          <table class="comp-data-table">
            <thead>
              <tr>
                <th>支払日</th>
                <th>担当者</th>
                <th class="text-end">支払額</th>
                <th>件数</th>
                <th>メモ</th>
              </tr>
            </thead>
            <tbody id="comp-paymentHistoryBody">
              <tr><td colspan="5" class="text-center text-muted py-4">支払履歴がありません</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // Compensation Page SPA Fragment
    // ============================================

    var _compCurrentRecords = [];
    var _compCurrentPayments = [];
    var _compCurrentStaffStats = {};
    var _compCompensationSettings = {};

    function compShowLoading() { var el = document.getElementById('comp-loadingOverlay'); if (el) el.style.display = 'flex'; }
    function compHideLoading() { var el = document.getElementById('comp-loadingOverlay'); if (el) el.style.display = 'none'; }

    function compFormatCurrency(amount) {
      if (amount === null || amount === undefined || isNaN(amount)) return '\u00A50';
      return '\u00A5' + Math.round(amount).toLocaleString();
    }

    function compFormatDate(date) {
      if (!date) return '-';
      var d = date.toDate ? date.toDate() : new Date(date);
      return d.toLocaleDateString('ja-JP');
    }

    // タブ切り替え
    function compSwitchTab(tabId, btnEl) {
      document.querySelectorAll('#spa-page-compensation .comp-tab-pane').forEach(function(p) { p.classList.remove('active'); });
      document.querySelectorAll('#spa-page-compensation .comp-nav-link').forEach(function(b) { b.classList.remove('active'); });
      var tab = document.getElementById(tabId);
      if (tab) tab.classList.add('active');
      if (btnEl) btnEl.classList.add('active');
    }

    // 戻るボタン
    function compGoBack() {
      if (typeof navigateToPage === 'function') {
        navigateToPage('home');
      } else if (typeof spaGoBack === 'function') {
        spaGoBack();
      }
    }

    // 通知ページを開く
    function compOpenAnnouncePage() {
      if (typeof navigateToPage === 'function') {
        navigateToPage('announce');
      }
    }

    // 設定ドロップダウン
    function compToggleSettingsDropdown(event) {
      event.stopPropagation();
      var dropdown = document.getElementById('comp-settingsDropdown');
      if (dropdown) dropdown.classList.toggle('active');
    }

    // ドロップダウンを閉じる
    var _compDropdownClickHandler = function(event) {
      var dropdown = document.getElementById('comp-settingsDropdown');
      if (dropdown && !event.target.closest('.comp-settings-dropdown') && !event.target.closest('.comp-sub-header-icon')) {
        dropdown.classList.remove('active');
      }
    };
    document.addEventListener('click', _compDropdownClickHandler);

    // Firebase operations using parent's globals
    async function compGetCompensationRecords(year, month) {
      var db = window.firebaseDB;
      var recordsRef = window.firestoreCollection(db, 'compensationRecords');
      var snapshot = await window.firestoreGetDocs(recordsRef);
      var records = [];
      snapshot.forEach(function(docSnap) {
        records.push({ id: docSnap.id, ...docSnap.data() });
      });

      return records.filter(function(r) {
        if (!r.completedAt && !r.recordedAt) return false;
        var dateStr = r.completedAt || r.recordedAt;
        var date = typeof dateStr === 'string' ? new Date(dateStr) : (dateStr.toDate ? dateStr.toDate() : new Date(dateStr));
        if (date.getFullYear() !== year) return false;
        if (month !== 'all' && (date.getMonth() + 1) !== parseInt(month)) return false;
        return true;
      });
    }

    async function compGetPaymentRecords(year) {
      var db = window.firebaseDB;
      var paymentsRef = window.firestoreCollection(db, 'compensationPayments');
      var snapshot = await window.firestoreGetDocs(paymentsRef);
      var payments = [];
      snapshot.forEach(function(docSnap) {
        payments.push({ id: docSnap.id, ...docSnap.data() });
      });

      return payments.filter(function(p) {
        if (!p.paymentDate) return false;
        var date = new Date(p.paymentDate);
        return date.getFullYear() === year;
      });
    }

    function compGetCompensationSettings() {
      try {
        var config = JSON.parse(localStorage.getItem('config') || '{}');
        return config['\u5831\u916C\u8A2D\u5B9A'] || {
          taskRates: { listing: 100, shipping: 100, photography: 50, inspection: 30 },
          customTasks: [],
          options: {}
        };
      } catch (e) {
        return { taskRates: { listing: 100, shipping: 100, photography: 50, inspection: 30 }, customTasks: [], options: {} };
      }
    }

    async function compSavePayment(paymentData) {
      var db = window.firebaseDB;
      var paymentId = 'pay_' + Date.now();
      var paymentRef = window.firestoreDoc(db, 'compensationPayments', paymentId);
      await window.firestoreSetDoc(paymentRef, {
        ...paymentData,
        id: paymentId,
        createdAt: new Date().toISOString()
      });
      return paymentId;
    }

    // CSVエクスポート
    function compExportToCSV() {
      var dropdown = document.getElementById('comp-settingsDropdown');
      if (dropdown) dropdown.classList.remove('active');

      if (_compCurrentRecords.length === 0) {
        alert('エクスポートするデータがありません');
        return;
      }

      var year = document.getElementById('comp-periodYear').value;
      var month = document.getElementById('comp-periodMonth').value;
      var periodLabel = month === 'all' ? year + '\u5E74' : year + '\u5E74' + month + '\u6708';

      var headers = ['\u65E5\u4ED8', '\u62C5\u5F53\u8005', '\u5831\u916C\u30BF\u30A4\u30D7', '\u5546\u54C1\u540D', '\u91D1\u984D'];
      var rows = _compCurrentRecords.map(function(record) {
        var date = record.paidDate ? new Date(record.paidDate.seconds * 1000).toLocaleDateString('ja-JP') : '';
        return [date, record.staffName || '', record.compensationType || '', record.productName || '', record.amount || 0];
      });

      var csvContent = '\uFEFF' + [headers].concat(rows)
        .map(function(row) { return row.map(function(cell) { return '"' + String(cell).replace(/"/g, '""') + '"'; }).join(','); })
        .join('\n');

      var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      var link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = '\u5831\u916C\u30C7\u30FC\u30BF_' + periodLabel + '.csv';
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function compInitializePage() {
      var yearSelect = document.getElementById('comp-periodYear');
      if (!yearSelect) return;
      var thisYear = new Date().getFullYear();
      yearSelect.innerHTML = '';
      for (var y = thisYear; y >= thisYear - 3; y--) {
        var opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y + '\u5E74';
        if (y === thisYear) opt.selected = true;
        yearSelect.appendChild(opt);
      }

      var monthSelect = document.getElementById('comp-periodMonth');
      if (monthSelect) {
        var thisMonth = new Date().getMonth() + 1;
        monthSelect.value = thisMonth.toString();
      }

      var paymentDate = document.getElementById('comp-paymentDate');
      if (paymentDate) paymentDate.value = new Date().toISOString().split('T')[0];

      compLoadCompensationData();
    }

    async function compGetProductTaskCounts(year, month) {
      if (!window.db) return {};
      try {
        var snapshot = await window.db.collection('products').get();
        var staffStats = {};
        snapshot.forEach(function(docSnap) {
          var data = docSnap.data();
          var date = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate() : (data.createdAt ? new Date(data.createdAt) : null);
          if (!date) return;
          if (date.getFullYear() !== year) return;
          if (month !== 'all' && (date.getMonth() + 1) !== parseInt(month)) return;

          var staff = data.assignedTo || data.createdBy || '不明';
          if (!staffStats[staff]) staffStats[staff] = { listing: 0, shipping: 0, photography: 0, inspection: 0 };
          if (data.status === '出品中' || data.status === '販売済み') staffStats[staff].listing++;
          if (data.status === '販売済み' && data.shippingCompleted) staffStats[staff].shipping++;
        });
        return staffStats;
      } catch (e) { console.error('[Comp] productTaskCounts error:', e); return {}; }
    }

    async function compLoadCompensationData() {
      compShowLoading();
      try {
        var year = parseInt(document.getElementById('comp-periodYear').value);
        var month = document.getElementById('comp-periodMonth').value;

        _compCompensationSettings = compGetCompensationSettings();
        _compCurrentRecords = await compGetCompensationRecords(year, month);
        console.log('[Comp SPA] 報酬記録取得:', _compCurrentRecords.length, '件');

        _compCurrentStaffStats = compCalculateStaffStatsFromRecords(_compCurrentRecords);
        _compCurrentPayments = await compGetPaymentRecords(year);

        compUpdatePeriodDisplay();
        compRenderSummary();
        compRenderStaffList();
        compRenderDetail();
        compRenderPaymentHistory();
        compPopulateStaffSelects();
      } catch (error) {
        console.error('データ読み込みエラー:', error);
        alert('データの読み込みに失敗しました');
      } finally {
        compHideLoading();
      }
    }

    function compCalculateStaffStatsFromRecords(records) {
      var staffStats = {};
      records.forEach(function(r) {
        var staffEmail = r.staffEmail || 'unknown';
        var staffName = r.staffName || staffEmail.split('@')[0] || '\u4E0D\u660E';
        if (!staffStats[staffName]) {
          staffStats[staffName] = { email: staffEmail, listing: 0, shipping: 0, photography: 0, inspection: 0, totalAmount: 0, records: [] };
        }
        var taskType = r.taskTypeKey || (r.taskType ? r.taskType.replace('_approval', '').replace('_task', '') : 'listing');
        if (staffStats[staffName][taskType] !== undefined) staffStats[staffName][taskType]++;
        staffStats[staffName].totalAmount += r.unitPrice || 0;
        staffStats[staffName].records.push(r);
      });
      return staffStats;
    }

    function compUpdatePeriodDisplay() {
      var year = document.getElementById('comp-periodYear').value;
      var month = document.getElementById('comp-periodMonth').value;
      var display = document.getElementById('comp-periodDisplay');
      if (display) display.textContent = month === 'all' ? year + '\u5E74 \u5168\u671F\u9593' : year + '\u5E74' + month + '\u6708';
    }

    function compRenderSummary() {
      var rates = _compCompensationSettings.taskRates || { listing: 100, shipping: 100, photography: 50, inspection: 30 };
      var totalTasks = 0, totalAmount = 0;
      var taskBreakdown = {
        listing: { count: 0, rate: rates.listing, amount: 0 },
        shipping: { count: 0, rate: rates.shipping, amount: 0 },
        photography: { count: 0, rate: rates.photography, amount: 0 },
        inspection: { count: 0, rate: rates.inspection, amount: 0 }
      };

      _compCurrentRecords.forEach(function(r) {
        var taskType = r.taskTypeKey || 'listing';
        if (taskBreakdown[taskType]) {
          taskBreakdown[taskType].count++;
          taskBreakdown[taskType].amount += r.unitPrice || rates[taskType] || 0;
          totalTasks++;
          totalAmount += r.unitPrice || rates[taskType] || 0;
        }
      });

      var paidAmount = _compCurrentPayments.reduce(function(sum, p) { return sum + (p.amount || 0); }, 0);
      var unpaidAmount = Math.max(0, totalAmount - paidAmount);

      var el;
      el = document.getElementById('comp-kpi-total'); if (el) el.textContent = compFormatCurrency(totalAmount);
      el = document.getElementById('comp-kpi-unpaid'); if (el) el.textContent = compFormatCurrency(unpaidAmount);
      el = document.getElementById('comp-kpi-paid'); if (el) el.textContent = compFormatCurrency(paidAmount);
      el = document.getElementById('comp-kpi-count'); if (el) el.textContent = totalTasks + '\u4EF6';

      var taskNames = { listing: '\u5546\u54C1\u51FA\u54C1', shipping: '\u68B1\u5305\u30FB\u767A\u9001', photography: '\u5546\u54C1\u64AE\u5F71', inspection: '\u691C\u54C1\u4F5C\u696D' };
      var breakdownHtml = '';
      Object.entries(taskBreakdown).forEach(function(entry) {
        var task = entry[0], data = entry[1];
        if (data.count > 0) {
          breakdownHtml += '<tr><td>' + taskNames[task] + '</td><td class="text-end">' + data.count + '\u4EF6</td><td class="text-end">' + compFormatCurrency(data.rate) + '</td><td class="text-end fw-bold">' + compFormatCurrency(data.amount) + '</td></tr>';
        }
      });

      if (!breakdownHtml) {
        breakdownHtml = '<tr><td colspan="4" class="text-center text-muted py-4">データがありません</td></tr>';
      } else {
        breakdownHtml += '<tr style="background:#f9fafb;font-weight:600;"><td>\u5408\u8A08</td><td class="text-end">' + totalTasks + '\u4EF6</td><td class="text-end">-</td><td class="text-end">' + compFormatCurrency(totalAmount) + '</td></tr>';
      }
      el = document.getElementById('comp-taskBreakdownBody'); if (el) el.innerHTML = breakdownHtml;
    }

    function compRenderStaffList() {
      var rates = _compCompensationSettings.taskRates || { listing: 100, shipping: 100, photography: 50, inspection: 30 };
      var staffList = document.getElementById('comp-staffList');
      if (!staffList) return;

      if (Object.keys(_compCurrentStaffStats).length === 0) {
        staffList.innerHTML = '<div class="text-center text-muted py-4">対象期間のデータがありません</div>';
        return;
      }

      var html = '';
      Object.entries(_compCurrentStaffStats).forEach(function(entry) {
        var staffName = entry[0], stats = entry[1];
        var totalTasks = stats.listing + stats.shipping + stats.photography + stats.inspection;
        var totalAmount = (stats.listing * rates.listing) + (stats.shipping * rates.shipping) + (stats.photography * rates.photography) + (stats.inspection * rates.inspection);
        html += '<div class="comp-staff-card"><div class="comp-staff-avatar">&#x1F464;</div><div class="comp-staff-info"><div class="comp-staff-name">' + staffName + '</div><div class="comp-staff-role">\u51FA\u54C1: ' + stats.listing + '\u4EF6 / \u767A\u9001: ' + stats.shipping + '\u4EF6</div></div><div class="comp-staff-stats"><div class="comp-staff-amount">' + compFormatCurrency(totalAmount) + '</div><div class="comp-staff-tasks">' + totalTasks + '\u4EF6\u306E\u30BF\u30B9\u30AF</div></div></div>';
      });
      staffList.innerHTML = html;
    }

    function compRenderDetail() {
      var taskNames = { listing: '\u5546\u54C1\u51FA\u54C1', shipping: '\u68B1\u5305\u30FB\u767A\u9001', photography: '\u5546\u54C1\u64AE\u5F71', inspection: '\u691C\u54C1\u4F5C\u696D', listing_approval: '\u51FA\u54C1\u78BA\u8A8D', shipping_task: '\u68B1\u5305\u30FB\u767A\u9001' };
      var html = '';
      var sorted = [].concat(_compCurrentRecords).sort(function(a, b) {
        return new Date(b.completedAt || b.recordedAt || 0) - new Date(a.completedAt || a.recordedAt || 0);
      });

      sorted.forEach(function(r) {
        var dateStr = r.completedAt || r.recordedAt;
        var displayDate = dateStr ? new Date(dateStr).toLocaleDateString('ja-JP') : '-';
        var staffName = r.staffName || '\u4E0D\u660E';
        var taskType = r.taskTypeKey || r.taskType || 'listing';
        var taskName = taskNames[taskType] || r.description || '\u30BF\u30B9\u30AF';
        var productInfo = r.managementNumber || '-';
        var amount = r.unitPrice || 0;
        var isPaid = r.paidAt ? true : false;
        html += '<tr><td>' + displayDate + '</td><td>' + staffName + '</td><td>' + taskName + '</td><td>' + productInfo + '</td><td class="text-end">' + compFormatCurrency(amount) + '</td><td><span class="comp-status-badge ' + (isPaid ? 'paid' : 'unpaid') + '">' + (isPaid ? '\u652F\u6255\u6E08' : '\u672A\u6255\u3044') + '</span></td></tr>';
      });

      if (!html) html = '<tr><td colspan="6" class="text-center text-muted py-4">データがありません</td></tr>';
      var el = document.getElementById('comp-detailBody'); if (el) el.innerHTML = html;
    }

    function compRenderPaymentHistory() {
      var tbody = document.getElementById('comp-paymentHistoryBody');
      if (!tbody) return;
      if (_compCurrentPayments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">支払履歴がありません</td></tr>';
        return;
      }
      var html = '';
      _compCurrentPayments.forEach(function(payment) {
        html += '<tr><td>' + compFormatDate(payment.paymentDate) + '</td><td>' + (payment.staffName || '-') + '</td><td class="text-end fw-bold">' + compFormatCurrency(payment.amount) + '</td><td>' + (payment.taskCount || '-') + '\u4EF6</td><td>' + (payment.memo || '-') + '</td></tr>';
      });
      tbody.innerHTML = html;
    }

    function compPopulateStaffSelects() {
      var staffNames = Object.keys(_compCurrentStaffStats);

      var filterStaff = document.getElementById('comp-filterStaff');
      if (filterStaff) {
        filterStaff.innerHTML = '<option value="">\u5168\u62C5\u5F53\u8005</option>';
        staffNames.forEach(function(name) { filterStaff.innerHTML += '<option value="' + name + '">' + name + '</option>'; });
      }

      var paymentStaff = document.getElementById('comp-paymentStaff');
      if (paymentStaff) {
        paymentStaff.innerHTML = '<option value="">\u9078\u629E\u3057\u3066\u304F\u3060\u3055\u3044</option>';
        staffNames.forEach(function(name) { paymentStaff.innerHTML += '<option value="' + name + '">' + name + '</option>'; });

        paymentStaff.onchange = function() {
          var rates = _compCompensationSettings.taskRates || { listing: 100, shipping: 100, photography: 50, inspection: 30 };
          var stats = _compCurrentStaffStats[this.value];
          var amountEl = document.getElementById('comp-paymentAmount');
          if (stats && amountEl) {
            amountEl.value = (stats.listing * rates.listing) + (stats.shipping * rates.shipping) + (stats.photography * rates.photography) + (stats.inspection * rates.inspection);
          } else if (amountEl) {
            amountEl.value = 0;
          }
        };
      }
    }

    function compFilterRecords() { compRenderDetail(); }

    function compResetFilters() {
      var el;
      el = document.getElementById('comp-filterStaff'); if (el) el.value = '';
      el = document.getElementById('comp-filterTask'); if (el) el.value = '';
      el = document.getElementById('comp-filterStatus'); if (el) el.value = '';
      compFilterRecords();
    }

    async function compProcessPayment() {
      var staffName = document.getElementById('comp-paymentStaff').value;
      var paymentDate = document.getElementById('comp-paymentDate').value;
      var amount = parseInt(document.getElementById('comp-paymentAmount').value) || 0;

      if (!staffName) { alert('\u62C5\u5F53\u8005\u3092\u9078\u629E\u3057\u3066\u304F\u3060\u3055\u3044'); return; }
      if (amount <= 0) { alert('\u652F\u6255\u91D1\u984D\u304C\u3042\u308A\u307E\u305B\u3093'); return; }
      if (!confirm(staffName + '\u3055\u3093\u306B' + compFormatCurrency(amount) + '\u3092\u652F\u6255\u3044\u6E08\u307F\u3068\u3057\u3066\u8A18\u9332\u3057\u307E\u3059\u304B\uFF1F')) return;

      compShowLoading();
      try {
        await compSavePayment({
          staffName: staffName,
          paymentDate: paymentDate,
          amount: amount,
          taskCount: _compCurrentStaffStats[staffName] ? Object.values(_compCurrentStaffStats[staffName]).reduce(function(a, b) { return a + (typeof b === 'number' ? b : 0); }, 0) : 0,
          memo: ''
        });
        alert('\u652F\u6255\u51E6\u7406\u304C\u5B8C\u4E86\u3057\u307E\u3057\u305F');
        compLoadCompensationData();
      } catch (error) {
        console.error('\u652F\u6255\u51E6\u7406\u30A8\u30E9\u30FC:', error);
        alert('\u652F\u6255\u51E6\u7406\u306B\u5931\u6557\u3057\u307E\u3057\u305F');
      } finally {
        compHideLoading();
      }
    }

    // ============================================
    // SPA Lifecycle
    // ============================================

    function initCompensationPage() {
      console.log('[Comp SPA] initCompensationPage called');
      compInitializePage();
    }

    function destroyCompensationPage() {
      console.log('[Comp SPA] destroyCompensationPage called');
      // ドキュメントレベルのリスナーを解除
      if (_compDropdownClickHandler) {
        document.removeEventListener('click', _compDropdownClickHandler);
      }
      _compCurrentRecords = [];
      _compCurrentPayments = [];
      _compCurrentStaffStats = {};
      _compCompensationSettings = {};
    }
  </script>
</div>
