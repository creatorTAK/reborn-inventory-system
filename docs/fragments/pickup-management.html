<!-- SPA Fragment: pickup-management.html -->
<!-- Prefix: pkup- -->
<div id="spa-page-pickup">
  <style>
    #spa-page-pickup {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }

    #spa-page-pickup .pkup-content-container {
      padding: 16px;
      max-width: 800px;
      margin: 0 auto;
    }

    #spa-page-pickup .pkup-page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e5e7eb;
    }

    #spa-page-pickup .pkup-page-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1f2937;
      margin: 0;
    }

    #spa-page-pickup .pkup-refresh-btn {
      background: none;
      border: none;
      color: #6b7280;
      font-size: 1.25rem;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.2s;
    }

    #spa-page-pickup .pkup-refresh-btn:hover {
      background: #f3f4f6;
    }

    #spa-page-pickup .pkup-refresh-btn.spinning i {
      animation: pkupSpin 1s linear infinite;
    }

    @keyframes pkupSpin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* フィルタータブ */
    #spa-page-pickup .pkup-filter-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    #spa-page-pickup .pkup-filter-tab {
      padding: 8px 16px;
      border-radius: 20px;
      background: #fff;
      border: 1px solid #e5e7eb;
      font-size: 14px;
      font-weight: 500;
      color: #6b7280;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }

    #spa-page-pickup .pkup-filter-tab:hover {
      border-color: #40B4E5;
    }

    #spa-page-pickup .pkup-filter-tab.active {
      background: #40B4E5;
      border-color: #40B4E5;
      color: #fff;
    }

    #spa-page-pickup .pkup-filter-tab .pkup-count {
      background: rgba(0,0,0,0.1);
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: 6px;
      font-size: 12px;
    }

    #spa-page-pickup .pkup-filter-tab.active .pkup-count {
      background: rgba(255,255,255,0.3);
    }

    /* リクエストカード */
    #spa-page-pickup .pkup-request-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      margin-bottom: 12px;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    #spa-page-pickup .pkup-request-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }

    #spa-page-pickup .pkup-request-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      border-bottom: 1px solid #f3f4f6;
    }

    #spa-page-pickup .pkup-request-status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    #spa-page-pickup .pkup-request-status.new {
      background: #fee2e2;
      color: #dc2626;
    }

    #spa-page-pickup .pkup-request-status.contacting {
      background: #fef3c7;
      color: #d97706;
    }

    #spa-page-pickup .pkup-request-status.scheduled {
      background: #dbeafe;
      color: #2563eb;
    }

    #spa-page-pickup .pkup-request-status.collected {
      background: #d1fae5;
      color: #059669;
    }

    #spa-page-pickup .pkup-request-status.processed {
      background: #e5e7eb;
      color: #6b7280;
    }

    #spa-page-pickup .pkup-request-date {
      font-size: 12px;
      color: #9ca3af;
    }

    #spa-page-pickup .pkup-request-card-body {
      padding: 16px;
    }

    #spa-page-pickup .pkup-request-name {
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 8px;
    }

    #spa-page-pickup .pkup-request-info {
      display: grid;
      gap: 6px;
    }

    #spa-page-pickup .pkup-request-info-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 14px;
      color: #4b5563;
    }

    #spa-page-pickup .pkup-request-info-row i {
      color: #9ca3af;
      width: 18px;
      text-align: center;
      flex-shrink: 0;
      margin-top: 2px;
    }

    #spa-page-pickup .pkup-request-card-footer {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      background: #f9fafb;
      border-top: 1px solid #f3f4f6;
    }

    #spa-page-pickup .pkup-action-btn {
      flex: 1;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    #spa-page-pickup .pkup-action-btn.primary {
      background: #40B4E5;
      color: #fff;
    }

    #spa-page-pickup .pkup-action-btn.primary:hover {
      background: #1E8FBF;
    }

    #spa-page-pickup .pkup-action-btn.secondary {
      background: #e5e7eb;
      color: #4b5563;
    }

    #spa-page-pickup .pkup-action-btn.secondary:hover {
      background: #d1d5db;
    }

    /* 空状態 */
    #spa-page-pickup .pkup-empty-state {
      text-align: center;
      padding: 48px 24px;
      color: #9ca3af;
    }

    #spa-page-pickup .pkup-empty-state i {
      font-size: 48px;
      margin-bottom: 16px;
    }

    #spa-page-pickup .pkup-empty-state p {
      font-size: 16px;
    }

    /* ローディング */
    #spa-page-pickup .pkup-loading-state {
      text-align: center;
      padding: 48px 24px;
      color: #9ca3af;
    }

    #spa-page-pickup .pkup-loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e5e7eb;
      border-top-color: #40B4E5;
      border-radius: 50%;
      animation: pkupSpin 1s linear infinite;
      margin: 0 auto 16px;
    }

    /* モーダル */
    #spa-page-pickup .pkup-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    #spa-page-pickup .pkup-modal-backdrop.active {
      display: flex;
    }

    #spa-page-pickup .pkup-modal-content {
      background: #fff;
      border-radius: 16px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    #spa-page-pickup .pkup-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    #spa-page-pickup .pkup-modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      margin: 0;
    }

    #spa-page-pickup .pkup-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: #9ca3af;
      cursor: pointer;
      padding: 4px;
    }

    #spa-page-pickup .pkup-modal-body {
      padding: 20px;
    }

    #spa-page-pickup .pkup-form-group {
      margin-bottom: 16px;
    }

    #spa-page-pickup .pkup-form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 6px;
    }

    #spa-page-pickup .pkup-form-group select,
    #spa-page-pickup .pkup-form-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
    }

    #spa-page-pickup .pkup-form-group select:focus,
    #spa-page-pickup .pkup-form-group input:focus {
      outline: none;
      border-color: #40B4E5;
      box-shadow: 0 0 0 3px rgba(64, 180, 229, 0.15);
    }

    #spa-page-pickup .pkup-modal-footer {
      display: flex;
      gap: 12px;
      padding: 16px 20px;
      border-top: 1px solid #e5e7eb;
    }

    /* 予定日時表示 */
    #spa-page-pickup .pkup-scheduled-info {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 8px;
      padding: 12px;
      margin-top: 8px;
    }

    #spa-page-pickup .pkup-scheduled-info-title {
      font-size: 12px;
      color: #3b82f6;
      font-weight: 600;
      margin-bottom: 4px;
    }

    #spa-page-pickup .pkup-scheduled-info-value {
      font-size: 16px;
      color: #1e40af;
      font-weight: 600;
    }

    /* 統計カード */
    #spa-page-pickup .pkup-stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    #spa-page-pickup .pkup-stat-card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    #spa-page-pickup .pkup-stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #1f2937;
    }

    #spa-page-pickup .pkup-stat-label {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }

    /* レスポンシブ */
    @media (max-width: 480px) {
      #spa-page-pickup .pkup-stats-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }

      #spa-page-pickup .pkup-stat-card {
        padding: 12px 8px;
      }

      #spa-page-pickup .pkup-stat-value {
        font-size: 24px;
      }

      #spa-page-pickup .pkup-stat-label {
        font-size: 11px;
      }
    }
  </style>

  <div class="pkup-content-container">
    <!-- ヘッダー -->
    <div class="pkup-page-header">
      <h1 class="pkup-page-title">
        <i class="bi bi-box-seam" style="margin-right:8px;"></i>回収管理
      </h1>
      <button class="pkup-refresh-btn" onclick="pkupLoadRequests()" title="更新">
        <i class="bi bi-arrow-clockwise"></i>
      </button>
    </div>

    <!-- 統計 -->
    <div class="pkup-stats-grid">
      <div class="pkup-stat-card">
        <div class="pkup-stat-value" id="pkup-stat-new">-</div>
        <div class="pkup-stat-label">新規</div>
      </div>
      <div class="pkup-stat-card">
        <div class="pkup-stat-value" id="pkup-stat-scheduled">-</div>
        <div class="pkup-stat-label">予定</div>
      </div>
      <div class="pkup-stat-card">
        <div class="pkup-stat-value" id="pkup-stat-total">-</div>
        <div class="pkup-stat-label">累計</div>
      </div>
    </div>

    <!-- フィルタータブ -->
    <div class="pkup-filter-tabs">
      <button class="pkup-filter-tab active" data-filter="all" onclick="pkupSetFilter('all')">
        すべて<span class="pkup-count" id="pkup-count-all">0</span>
      </button>
      <button class="pkup-filter-tab" data-filter="new" onclick="pkupSetFilter('new')">
        新規<span class="pkup-count" id="pkup-count-new">0</span>
      </button>
      <button class="pkup-filter-tab" data-filter="contacting" onclick="pkupSetFilter('contacting')">
        連絡中<span class="pkup-count" id="pkup-count-contacting">0</span>
      </button>
      <button class="pkup-filter-tab" data-filter="scheduled" onclick="pkupSetFilter('scheduled')">
        予定<span class="pkup-count" id="pkup-count-scheduled">0</span>
      </button>
      <button class="pkup-filter-tab" data-filter="collected" onclick="pkupSetFilter('collected')">
        回収済<span class="pkup-count" id="pkup-count-collected">0</span>
      </button>
    </div>

    <!-- リクエスト一覧 -->
    <div id="pkup-requests-container">
      <div class="pkup-loading-state">
        <div class="pkup-loading-spinner"></div>
        <p>読み込み中...</p>
      </div>
    </div>
  </div>

  <!-- 詳細モーダル -->
  <div class="pkup-modal-backdrop" id="pkup-detail-modal">
    <div class="pkup-modal-content">
      <div class="pkup-modal-header">
        <h2 class="pkup-modal-title">回収依頼詳細</h2>
        <button class="pkup-modal-close" onclick="pkupCloseModal()">&times;</button>
      </div>
      <div class="pkup-modal-body" id="pkup-modal-body">
        <!-- 動的に生成 -->
      </div>
      <div class="pkup-modal-footer">
        <button class="pkup-action-btn secondary" onclick="pkupCloseModal()">閉じる</button>
        <button class="pkup-action-btn primary" id="pkup-modal-action-btn" onclick="pkupSaveChanges()">保存</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // Pickup Management Page SPA Fragment
    // ============================================

    var _pkupAllRequests = [];
    var _pkupCurrentFilter = 'all';
    var _pkupSelectedRequest = null;

    var PKUP_STATUS_LABELS = {
      'new': '\u65B0\u898F',
      'contacting': '\u9023\u7D61\u4E2D',
      'scheduled': '\u4E88\u5B9A',
      'collected': '\u56DE\u53CE\u6E08',
      'processed': '\u51E6\u7406\u5B8C\u4E86'
    };

    var PKUP_PREFERRED_DAY_LABELS = {
      'weekday': '\u5E73\u65E5',
      'weekend': '\u571F\u65E5',
      'any': '\u3069\u3061\u3089\u3067\u3082'
    };

    var PKUP_PREFERRED_TIME_LABELS = {
      'morning': '\u5348\u524D',
      'afternoon': '\u5348\u5F8C',
      'evening': '\u5915\u65B9',
      'any': '\u6307\u5B9A\u306A\u3057'
    };

    var PKUP_AMOUNT_LABELS = {
      '1': '1\u888B',
      '2-3': '2\u301C3\u888B',
      '4+': '4\u888B\u4EE5\u4E0A'
    };

    // データ読み込み
    async function pkupLoadRequests() {
      var container = document.getElementById('pkup-requests-container');
      var refreshBtn = document.querySelector('#spa-page-pickup .pkup-refresh-btn');

      if (refreshBtn) refreshBtn.classList.add('spinning');
      if (container) {
        container.innerHTML = '<div class="pkup-loading-state"><div class="pkup-loading-spinner"></div><p>\u8AAD\u307F\u8FBC\u307F\u4E2D...</p></div>';
      }

      try {
        var db = window.firebaseDB;
        var q = window.firestoreQuery(
          window.firestoreCollection(db, 'pickup_requests'),
          window.firestoreOrderBy('createdAt', 'desc')
        );

        var snapshot = await window.firestoreGetDocs(q);
        _pkupAllRequests = snapshot.docs.map(function(docSnap) {
          return Object.assign({ id: docSnap.id }, docSnap.data());
        });

        pkupUpdateStats();
        pkupRenderRequests();
      } catch (error) {
        console.error('[Pickup SPA] データ取得エラー:', error);
        if (container) {
          container.innerHTML = '<div class="pkup-empty-state"><i class="bi bi-exclamation-triangle"></i><p>\u30C7\u30FC\u30BF\u306E\u53D6\u5F97\u306B\u5931\u6557\u3057\u307E\u3057\u305F</p></div>';
        }
      } finally {
        if (refreshBtn) refreshBtn.classList.remove('spinning');
      }
    }

    // 統計更新
    function pkupUpdateStats() {
      var newCount = _pkupAllRequests.filter(function(r) { return r.status === 'new'; }).length;
      var scheduledCount = _pkupAllRequests.filter(function(r) { return r.status === 'scheduled'; }).length;

      var el;
      el = document.getElementById('pkup-stat-new'); if (el) el.textContent = newCount;
      el = document.getElementById('pkup-stat-scheduled'); if (el) el.textContent = scheduledCount;
      el = document.getElementById('pkup-stat-total'); if (el) el.textContent = _pkupAllRequests.length;

      el = document.getElementById('pkup-count-all'); if (el) el.textContent = _pkupAllRequests.length;
      el = document.getElementById('pkup-count-new'); if (el) el.textContent = newCount;
      el = document.getElementById('pkup-count-contacting'); if (el) el.textContent = _pkupAllRequests.filter(function(r) { return r.status === 'contacting'; }).length;
      el = document.getElementById('pkup-count-scheduled'); if (el) el.textContent = scheduledCount;
      el = document.getElementById('pkup-count-collected'); if (el) el.textContent = _pkupAllRequests.filter(function(r) { return r.status === 'collected' || r.status === 'processed'; }).length;
    }

    // フィルター設定
    function pkupSetFilter(filter) {
      _pkupCurrentFilter = filter;
      document.querySelectorAll('#spa-page-pickup .pkup-filter-tab').forEach(function(tab) {
        tab.classList.toggle('active', tab.dataset.filter === filter);
      });
      pkupRenderRequests();
    }

    // リクエスト一覧表示
    function pkupRenderRequests() {
      var container = document.getElementById('pkup-requests-container');
      if (!container) return;

      var filtered = _pkupAllRequests;
      if (_pkupCurrentFilter !== 'all') {
        if (_pkupCurrentFilter === 'collected') {
          filtered = _pkupAllRequests.filter(function(r) { return r.status === 'collected' || r.status === 'processed'; });
        } else {
          filtered = _pkupAllRequests.filter(function(r) { return r.status === _pkupCurrentFilter; });
        }
      }

      if (filtered.length === 0) {
        container.innerHTML = '<div class="pkup-empty-state"><i class="bi bi-inbox"></i><p>\u8A72\u5F53\u3059\u308B\u4F9D\u983C\u304C\u3042\u308A\u307E\u305B\u3093</p></div>';
        return;
      }

      container.innerHTML = filtered.map(function(request) { return pkupCreateRequestCard(request); }).join('');
    }

    // HTMLエスケープ
    function pkupEscapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }

    // リクエストカード生成
    function pkupCreateRequestCard(request) {
      var createdAt = (request.createdAt && request.createdAt.toDate) ? request.createdAt.toDate() : new Date(request.createdAt);
      var dateStr = createdAt.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });

      var scheduledHtml = '';
      if (request.scheduledDate) {
        scheduledHtml = '<div class="pkup-scheduled-info"><div class="pkup-scheduled-info-title">\u56DE\u53CE\u4E88\u5B9A</div><div class="pkup-scheduled-info-value">' + request.scheduledDate + ' ' + (request.scheduledTime || '') + '</div></div>';
      }

      var methodBadge = request.collectMethod === 'shipping'
        ? '<span style="background:#fef3c7;color:#d97706;padding:2px 8px;border-radius:4px;font-size:11px;margin-left:8px;">\u90F5\u9001</span>'
        : '<span style="background:#d1fae5;color:#059669;padding:2px 8px;border-radius:4px;font-size:11px;margin-left:8px;">\u56DE\u53CE</span>';

      var paymentHtml = '';
      if (request.weight && request.payment) {
        paymentHtml = '<div class="pkup-request-info-row" style="color:#059669;font-weight:600;"><i class="bi bi-cash"></i><span>' + request.weight + 'kg \u2192 ' + request.payment.toLocaleString() + '\u5186</span></div>';
      }

      var contactInfo = request.contactMethod === 'line'
        ? '<i class="bi bi-line"></i> LINE'
        : '<i class="bi bi-telephone"></i> ' + (request.phone || '');

      return '<div class="pkup-request-card" data-id="' + request.id + '">' +
        '<div class="pkup-request-card-header">' +
        '<span class="pkup-request-status ' + request.status + '">' + (PKUP_STATUS_LABELS[request.status] || request.status) + '</span>' +
        methodBadge +
        '<span class="pkup-request-date" style="margin-left:auto;">' + dateStr + '</span>' +
        '</div>' +
        '<div class="pkup-request-card-body">' +
        '<div class="pkup-request-name">' + pkupEscapeHtml(request.name) + '\u69D8</div>' +
        '<div class="pkup-request-info">' +
        '<div class="pkup-request-info-row"><i class="bi bi-geo-alt"></i><span>' + pkupEscapeHtml(request.address || '\u90F5\u9001') + '</span></div>' +
        '<div class="pkup-request-info-row">' + contactInfo + '</div>' +
        '<div class="pkup-request-info-row"><i class="bi bi-calendar"></i><span>' + (PKUP_PREFERRED_DAY_LABELS[request.preferredDay] || request.preferredDay || '-') + ' / ' + (PKUP_PREFERRED_TIME_LABELS[request.preferredTime] || request.preferredTime || '-') + '</span></div>' +
        '<div class="pkup-request-info-row"><i class="bi bi-bag"></i><span>' + (PKUP_AMOUNT_LABELS[request.estimatedAmount] || request.estimatedAmount || '-') + '</span></div>' +
        paymentHtml +
        '</div>' +
        scheduledHtml +
        '</div>' +
        '<div class="pkup-request-card-footer">' +
        '<button class="pkup-action-btn secondary" onclick="pkupOpenDetail(\'' + request.id + '\')"><i class="bi bi-pencil" style="margin-right:4px;"></i>\u7DE8\u96C6</button>' +
        pkupGetQuickActionButton(request) +
        '</div></div>';
    }

    // クイックアクションボタン
    function pkupGetQuickActionButton(request) {
      switch (request.status) {
        case 'new':
          return '<button class="pkup-action-btn primary" onclick="pkupQuickUpdateStatus(\'' + request.id + '\', \'contacting\')">\u9023\u7D61\u3059\u308B</button>';
        case 'contacting':
          return '<button class="pkup-action-btn primary" onclick="pkupOpenDetail(\'' + request.id + '\')">\u4E88\u5B9A\u3092\u8A2D\u5B9A</button>';
        case 'scheduled':
          return '<button class="pkup-action-btn primary" onclick="pkupQuickUpdateStatus(\'' + request.id + '\', \'collected\')">\u56DE\u53CE\u5B8C\u4E86</button>';
        case 'collected':
          return '<button class="pkup-action-btn primary" onclick="pkupQuickUpdateStatus(\'' + request.id + '\', \'processed\')">\u51E6\u7406\u5B8C\u4E86</button>';
        default:
          return '';
      }
    }

    // クイックステータス更新
    async function pkupQuickUpdateStatus(id, newStatus) {
      try {
        var db = window.firebaseDB;
        var docRef = window.firestoreDoc(db, 'pickup_requests', id);
        var updateData = {
          status: newStatus,
          updatedAt: window.firestoreTimestamp.now()
        };
        if (newStatus === 'collected') updateData.collectedAt = window.firestoreTimestamp.now();
        if (newStatus === 'processed') updateData.processedAt = window.firestoreTimestamp.now();

        await window.firestoreUpdateDoc(docRef, updateData);
        await pkupLoadRequests();
      } catch (error) {
        console.error('[Pickup SPA] \u66F4\u65B0\u30A8\u30E9\u30FC:', error);
        alert('\u66F4\u65B0\u306B\u5931\u6557\u3057\u307E\u3057\u305F');
      }
    }

    // 詳細モーダルを開く
    function pkupOpenDetail(id) {
      _pkupSelectedRequest = _pkupAllRequests.find(function(r) { return r.id === id; });
      if (!_pkupSelectedRequest) return;

      var modalBody = document.getElementById('pkup-modal-body');
      if (!modalBody) return;

      modalBody.innerHTML =
        '<div class="pkup-form-group"><label>\u304A\u540D\u524D</label><input type="text" id="pkup-edit-name" value="' + pkupEscapeHtml(_pkupSelectedRequest.name) + '" readonly style="background:#f3f4f6;"></div>' +
        '<div class="pkup-form-group"><label>\u4F4F\u6240</label><input type="text" id="pkup-edit-address" value="' + pkupEscapeHtml(_pkupSelectedRequest.address) + '" readonly style="background:#f3f4f6;"></div>' +
        '<div class="pkup-form-group"><label>\u9023\u7D61\u5148</label><input type="text" value="' + (_pkupSelectedRequest.contactMethod === 'line' ? 'LINE' : _pkupSelectedRequest.phone || '') + '" readonly style="background:#f3f4f6;"></div>' +
        '<div class="pkup-form-group"><label>\u5099\u8003</label><input type="text" value="' + pkupEscapeHtml(_pkupSelectedRequest.note || '\u306A\u3057') + '" readonly style="background:#f3f4f6;"></div>' +
        '<hr>' +
        '<div class="pkup-form-group"><label>\u30B9\u30C6\u30FC\u30BF\u30B9</label>' +
        '<select id="pkup-edit-status">' +
        '<option value="new"' + (_pkupSelectedRequest.status === 'new' ? ' selected' : '') + '>\u65B0\u898F</option>' +
        '<option value="contacting"' + (_pkupSelectedRequest.status === 'contacting' ? ' selected' : '') + '>\u9023\u7D61\u4E2D</option>' +
        '<option value="scheduled"' + (_pkupSelectedRequest.status === 'scheduled' ? ' selected' : '') + '>\u4E88\u5B9A</option>' +
        '<option value="collected"' + (_pkupSelectedRequest.status === 'collected' ? ' selected' : '') + '>\u56DE\u53CE\u6E08</option>' +
        '<option value="processed"' + (_pkupSelectedRequest.status === 'processed' ? ' selected' : '') + '>\u51E6\u7406\u5B8C\u4E86</option>' +
        '</select></div>' +
        '<div class="pkup-form-group"><label>\u56DE\u53CE\u4E88\u5B9A\u65E5</label><input type="date" id="pkup-edit-scheduled-date" value="' + (_pkupSelectedRequest.scheduledDate || '') + '"></div>' +
        '<div class="pkup-form-group"><label>\u56DE\u53CE\u4E88\u5B9A\u6642\u9593</label><input type="time" id="pkup-edit-scheduled-time" value="' + (_pkupSelectedRequest.scheduledTime || '') + '"></div>' +
        '<hr>' +
        '<div class="pkup-form-group"><label>\u56DE\u53CE\u65B9\u6CD5</label>' +
        '<select id="pkup-edit-collect-method">' +
        '<option value="pickup"' + ((_pkupSelectedRequest.collectMethod || 'pickup') === 'pickup' ? ' selected' : '') + '>\u56DE\u53CE\uFF08\u5CA1\u5C71\u5E02\u5185\uFF09</option>' +
        '<option value="shipping"' + (_pkupSelectedRequest.collectMethod === 'shipping' ? ' selected' : '') + '>\u90F5\u9001\uFF08\u5168\u56FD\uFF09</option>' +
        '</select></div>' +
        '<div class="pkup-form-group" id="pkup-weight-group"><label>\u91CD\u91CF\uFF08kg\uFF09\u203B\u56DE\u53CE\u306E\u5834\u5408\u306E\u307F</label><input type="number" id="pkup-edit-weight" step="0.1" min="0" placeholder="\u4F8B: 5.5" value="' + (_pkupSelectedRequest.weight || '') + '" onchange="pkupCalculatePayment()"></div>' +
        '<div class="pkup-form-group" id="pkup-payment-group"><label>\u8CB7\u53D6\u91D1\u984D\uFF08\u5186\uFF09</label><input type="number" id="pkup-edit-payment" readonly style="background:#f3f4f6;font-weight:bold;color:#059669;" value="' + (_pkupSelectedRequest.payment || '') + '"><small style="color:#6b7280;">\u203B\u56DE\u53CE\u306E\u5834\u5408: 1kg = 100\u5186\u3067\u81EA\u52D5\u8A08\u7B97</small></div>';

      var modal = document.getElementById('pkup-detail-modal');
      if (modal) modal.classList.add('active');
    }

    // 買取金額を計算
    function pkupCalculatePayment() {
      var methodEl = document.getElementById('pkup-edit-collect-method');
      var weightEl = document.getElementById('pkup-edit-weight');
      var paymentEl = document.getElementById('pkup-edit-payment');
      if (!methodEl || !weightEl || !paymentEl) return;

      var method = methodEl.value;
      var weight = parseFloat(weightEl.value) || 0;

      if (method === 'pickup' && weight > 0) {
        paymentEl.value = Math.floor(weight * 100);
      } else {
        paymentEl.value = 0;
      }
    }

    // モーダルを閉じる
    function pkupCloseModal() {
      var modal = document.getElementById('pkup-detail-modal');
      if (modal) modal.classList.remove('active');
      _pkupSelectedRequest = null;
    }

    // 変更を保存
    async function pkupSaveChanges() {
      if (!_pkupSelectedRequest) return;

      var status = document.getElementById('pkup-edit-status').value;
      var scheduledDate = document.getElementById('pkup-edit-scheduled-date').value;
      var scheduledTime = document.getElementById('pkup-edit-scheduled-time').value;
      var collectMethod = document.getElementById('pkup-edit-collect-method').value;
      var weight = parseFloat(document.getElementById('pkup-edit-weight').value) || null;
      var payment = parseInt(document.getElementById('pkup-edit-payment').value) || 0;

      try {
        var db = window.firebaseDB;
        var docRef = window.firestoreDoc(db, 'pickup_requests', _pkupSelectedRequest.id);
        await window.firestoreUpdateDoc(docRef, {
          status: status,
          scheduledDate: scheduledDate || null,
          scheduledTime: scheduledTime || null,
          collectMethod: collectMethod,
          weight: weight,
          payment: payment,
          updatedAt: window.firestoreTimestamp.now()
        });

        pkupCloseModal();
        await pkupLoadRequests();
      } catch (error) {
        console.error('[Pickup SPA] \u4FDD\u5B58\u30A8\u30E9\u30FC:', error);
        alert('\u4FDD\u5B58\u306B\u5931\u6557\u3057\u307E\u3057\u305F');
      }
    }

    // ============================================
    // SPA Lifecycle
    // ============================================

    function initPickupPage() {
      console.log('[Pickup SPA] initPickupPage called');
      pkupLoadRequests();
    }

    function destroyPickupPage() {
      console.log('[Pickup SPA] destroyPickupPage called');
      pkupCloseModal();
      _pkupAllRequests = [];
      _pkupCurrentFilter = 'all';
      _pkupSelectedRequest = null;
    }
  </script>
</div>
