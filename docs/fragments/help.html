<!-- SPA Fragment: help.html -->
<!-- Prefix: help- -->
<div id="spa-page-help">
  <style>
    #spa-page-help {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      padding-bottom: 80px;
    }

    /* v324: シンプル白背景ヘッダーに変更 */
    #spa-page-help .help-header {
      background: #ffffff;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 1px solid #e5e7eb;
    }

    #spa-page-help .help-header h1 {
      font-size: 17px;
      font-weight: 600;
      margin: 0;
      color: #111827;
      flex: 1;
      text-align: center;
      padding-right: 28px;
    }

    #spa-page-help .help-header h1 i {
      display: none;
    }

    #spa-page-help .help-container {
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
    }

    #spa-page-help .help-section {
      background: white;
      border-radius: 12px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      overflow: hidden;
    }

    #spa-page-help .help-section-title {
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      padding: 12px 16px 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    #spa-page-help .help-item {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid #f3f4f6;
      cursor: pointer;
      transition: background 0.2s;
      text-decoration: none;
      color: inherit;
    }

    #spa-page-help .help-item:last-child {
      border-bottom: none;
    }

    #spa-page-help .help-item:active {
      background: #f9fafb;
    }

    #spa-page-help .help-item-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: var(--reborn-primary-lightest, #E8F7FC);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      flex-shrink: 0;
    }

    #spa-page-help .help-item-icon i {
      font-size: 20px;
      color: var(--reborn-primary, #40B4E5);
    }

    #spa-page-help .help-item-content {
      flex: 1;
    }

    #spa-page-help .help-item-title {
      font-size: 15px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 2px;
    }

    #spa-page-help .help-item-desc {
      font-size: 13px;
      color: #6b7280;
    }

    #spa-page-help .help-item-arrow {
      color: #9ca3af;
      font-size: 18px;
    }

    /* FAQ アコーディオン */
    #spa-page-help .help-faq-item {
      border-bottom: 1px solid #f3f4f6;
    }

    #spa-page-help .help-faq-item:last-child {
      border-bottom: none;
    }

    #spa-page-help .help-faq-question {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      cursor: pointer;
      transition: background 0.2s;
    }

    #spa-page-help .help-faq-question:active {
      background: #f9fafb;
    }

    #spa-page-help .help-faq-question-icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--reborn-primary, #40B4E5);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      margin-right: 12px;
      flex-shrink: 0;
    }

    #spa-page-help .help-faq-question-text {
      flex: 1;
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
    }

    #spa-page-help .help-faq-toggle {
      color: #9ca3af;
      font-size: 18px;
      transition: transform 0.3s;
    }

    #spa-page-help .help-faq-item.open .help-faq-toggle {
      transform: rotate(180deg);
    }

    #spa-page-help .help-faq-answer {
      display: none;
      padding: 0 16px 14px 56px;
      font-size: 14px;
      color: #4b5563;
      line-height: 1.6;
    }

    #spa-page-help .help-faq-item.open .help-faq-answer {
      display: block;
    }

    /* フッター */
    #spa-page-help .help-footer {
      padding: 24px 20px;
      text-align: center;
    }

    #spa-page-help .help-footer-links {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 12px;
    }

    #spa-page-help .help-footer-links a {
      color: #6b7280;
      font-size: 13px;
      text-decoration: none;
    }

    #spa-page-help .help-footer-links a:hover {
      color: var(--reborn-primary);
      text-decoration: underline;
    }

    #spa-page-help .help-footer-copyright {
      color: #9ca3af;
      font-size: 12px;
    }

    /* 戻るボタン */
    #spa-page-help .help-back-button {
      background: none;
      border: none;
      padding: 8px;
      margin: -8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #374151;
      font-size: 20px;
    }

    #spa-page-help .help-back-button:active {
      opacity: 0.6;
    }

    /* ========================================
       AIチャットボット UI（ChatGPT風）
       ======================================== */

    /* チャットボタン（FAB） */
    #spa-page-help .help-chat-fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--reborn-primary, #40B4E5) 0%, var(--reborn-primary-dark, #1E8FBF) 100%);
      color: white;
      border: none;
      box-shadow: 0 4px 12px rgba(64, 180, 229, 0.4);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      z-index: 1000;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    #spa-page-help .help-chat-fab:active {
      transform: scale(0.95);
    }

    #spa-page-help .help-chat-fab:hover {
      box-shadow: 0 6px 16px rgba(64, 180, 229, 0.5);
    }

    /* チャット全画面コンテナ */
    #spa-page-help .help-chat-fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #f5f5f5;
      z-index: 2000;
      display: none;
      flex-direction: row;
    }

    #spa-page-help .help-chat-fullscreen.open {
      display: flex;
    }

    /* サイドバー（会話一覧） */
    #spa-page-help .help-chat-sidebar {
      width: 280px;
      background: #1f2937;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    @media (max-width: 768px) {
      #spa-page-help .help-chat-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: 280px;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        z-index: 2100;
      }

      #spa-page-help .help-chat-sidebar.open {
        transform: translateX(0);
      }

      #spa-page-help .help-sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2050;
        display: none;
      }

      #spa-page-help .help-sidebar-overlay.open {
        display: block;
      }
    }

    #spa-page-help .help-sidebar-header {
      padding: 16px;
      border-bottom: 1px solid #374151;
    }

    #spa-page-help .help-new-chat-btn {
      width: 100%;
      padding: 12px 16px;
      background: transparent;
      border: 1px solid #4b5563;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
    }

    #spa-page-help .help-new-chat-btn:hover {
      background: #374151;
    }

    #spa-page-help .help-new-chat-btn i {
      font-size: 16px;
    }

    #spa-page-help .help-sidebar-conversations {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    #spa-page-help .help-conversation-item {
      padding: 12px;
      border-radius: 8px;
      color: #d1d5db;
      cursor: pointer;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.2s;
    }

    #spa-page-help .help-conversation-item:hover {
      background: #374151;
    }

    #spa-page-help .help-conversation-item.active {
      background: #374151;
    }

    #spa-page-help .help-conversation-item i {
      font-size: 16px;
      flex-shrink: 0;
    }

    #spa-page-help .help-conversation-title {
      flex: 1;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #spa-page-help .help-conversation-delete {
      opacity: 0;
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: opacity 0.2s, color 0.2s;
    }

    #spa-page-help .help-conversation-item:hover .help-conversation-delete {
      opacity: 1;
    }

    #spa-page-help .help-conversation-delete:hover {
      color: #ef4444;
    }

    #spa-page-help .help-sidebar-footer {
      padding: 16px;
      border-top: 1px solid #374151;
    }

    #spa-page-help .help-close-chat-btn {
      width: 100%;
      padding: 10px 16px;
      background: #374151;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: background 0.2s;
    }

    #spa-page-help .help-close-chat-btn:hover {
      background: #4b5563;
    }

    /* メインチャットエリア */
    #spa-page-help .help-chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
      min-width: 0;
    }

    /* チャットヘッダー */
    #spa-page-help .help-chat-main-header {
      background: linear-gradient(135deg, var(--reborn-primary, #40B4E5) 0%, var(--reborn-primary-dark, #1E8FBF) 100%);
      color: white;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    #spa-page-help .help-chat-header-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    #spa-page-help .help-chat-header-btn:active {
      background: rgba(255, 255, 255, 0.3);
    }

    #spa-page-help .help-chat-main-header-avatar {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      overflow: hidden;
      flex-shrink: 0;
      background: white;
    }

    #spa-page-help .help-chat-main-header-avatar img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    #spa-page-help .help-chat-main-header-info {
      flex: 1;
    }

    #spa-page-help .help-chat-main-header-title {
      font-size: 16px;
      font-weight: 600;
    }

    #spa-page-help .help-chat-main-header-status {
      font-size: 12px;
      opacity: 0.9;
    }

    /* チャットメッセージエリア */
    #spa-page-help .help-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background: #f9fafb;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #spa-page-help .help-chat-message {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.6;
      word-wrap: break-word;
    }

    #spa-page-help .help-chat-message.user {
      align-self: flex-end;
      background: var(--reborn-primary, #40B4E5);
      color: white;
      border-bottom-right-radius: 4px;
    }

    #spa-page-help .help-chat-message.ai {
      align-self: flex-start;
      background: white;
      color: #1f2937;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    #spa-page-help .help-chat-message.ai.typing {
      color: #9ca3af;
    }

    #spa-page-help .help-typing-indicator {
      display: flex;
      gap: 4px;
      padding: 4px 0;
    }

    #spa-page-help .help-typing-indicator span {
      width: 8px;
      height: 8px;
      background: #9ca3af;
      border-radius: 50%;
      animation: helpTyping 1.4s infinite ease-in-out;
    }

    #spa-page-help .help-typing-indicator span:nth-child(1) { animation-delay: 0s; }
    #spa-page-help .help-typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    #spa-page-help .help-typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes helpTyping {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
      30% { transform: translateY(-4px); opacity: 1; }
    }

    /* ウェルカムメッセージ */
    #spa-page-help .help-chat-welcome {
      text-align: center;
      padding: 40px 20px;
      color: #6b7280;
    }

    #spa-page-help .help-chat-welcome-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    #spa-page-help .help-chat-welcome-title {
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 8px;
    }

    #spa-page-help .help-chat-welcome-desc {
      font-size: 14px;
      max-width: 400px;
      margin: 0 auto;
    }

    /* クイックアクション */
    #spa-page-help .help-chat-quick-actions {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      background: #f9fafb;
    }

    #spa-page-help .help-quick-action-btn {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 13px;
      color: #374151;
      cursor: pointer;
      transition: all 0.2s;
    }

    #spa-page-help .help-quick-action-btn:hover {
      background: var(--reborn-primary-lightest, #E8F7FC);
      border-color: var(--reborn-primary, #40B4E5);
    }

    #spa-page-help .help-quick-action-btn:active {
      background: #e5e7eb;
    }

    /* チャット入力エリア */
    #spa-page-help .help-chat-input-area {
      padding: 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
      background: white;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    #spa-page-help .help-chat-input {
      flex: 1;
      border: 1px solid #e5e7eb;
      border-radius: 24px;
      padding: 12px 20px;
      font-size: 16px;
      resize: none;
      max-height: 120px;
      min-height: 48px;
      line-height: 1.4;
      outline: none;
      transition: border-color 0.2s;
    }

    #spa-page-help .help-chat-input:focus {
      border-color: var(--reborn-primary, #40B4E5);
    }

    #spa-page-help .help-chat-send-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--reborn-primary, #40B4E5);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
      transition: background 0.2s, opacity 0.2s;
    }

    #spa-page-help .help-chat-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #spa-page-help .help-chat-send-btn:not(:disabled):active {
      background: var(--reborn-primary-dark, #1E8FBF);
    }

    /* 会話なしの状態 */
    #spa-page-help .help-no-conversations {
      color: #6b7280;
      font-size: 13px;
      text-align: center;
      padding: 20px;
    }

    /* ローディング */
    #spa-page-help .help-loading-conversations {
      color: #9ca3af;
      font-size: 13px;
      text-align: center;
      padding: 20px;
    }

    /* 日付区切り */
    #spa-page-help .help-conversation-date-divider {
      font-size: 11px;
      color: #6b7280;
      padding: 8px 12px 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
  </style>

  <div class="help-header">
    <button class="help-back-button" onclick="helpGoBack()" title="戻る">
      <i class="bi bi-chevron-left"></i>
    </button>
    <h1>ヘルプ</h1>
  </div>

  <div class="help-container">
    <!-- よくある質問 -->
    <div class="help-section">
      <div class="help-section-title">よくある質問</div>

      <div class="help-faq-item" onclick="helpToggleFaq(this)">
        <div class="help-faq-question">
          <span class="help-faq-question-icon">Q</span>
          <span class="help-faq-question-text">商品を登録するにはどうすればいいですか？</span>
          <i class="bi bi-chevron-down help-faq-toggle"></i>
        </div>
        <div class="help-faq-answer">
          画面下部の「登録」ボタンをタップするか、メニューから「商品登録」を選択してください。カメラで商品を撮影し、必要な情報を入力して保存できます。
        </div>
      </div>

      <div class="help-faq-item" onclick="helpToggleFaq(this)">
        <div class="help-faq-question">
          <span class="help-faq-question-icon">Q</span>
          <span class="help-faq-question-text">チャットで通知が届きません</span>
          <i class="bi bi-chevron-down help-faq-toggle"></i>
        </div>
        <div class="help-faq-answer">
          1. 端末の通知設定でフリラの通知が許可されているか確認してください。<br>
          2. マイページ→基本設定から通知設定を確認してください。<br>
          3. アプリを再起動してみてください。
        </div>
      </div>

      <div class="help-faq-item" onclick="helpToggleFaq(this)">
        <div class="help-faq-question">
          <span class="help-faq-question-icon">Q</span>
          <span class="help-faq-question-text">データはどこに保存されますか？</span>
          <i class="bi bi-chevron-down help-faq-toggle"></i>
        </div>
        <div class="help-faq-answer">
          データはクラウド（Firestore）に安全に保存されます。インターネット接続があれば、どの端末からでもアクセスできます。
        </div>
      </div>

      <div class="help-faq-item" onclick="helpToggleFaq(this)">
        <div class="help-faq-question">
          <span class="help-faq-question-icon">Q</span>
          <span class="help-faq-question-text">アプリをアップデートするには？</span>
          <i class="bi bi-chevron-down help-faq-toggle"></i>
        </div>
        <div class="help-faq-answer">
          フリラはPWA（Progressive Web App）のため、自動的に最新版に更新されます。更新が反映されない場合は、アプリを完全に終了してから再度開いてください。
        </div>
      </div>
    </div>

    <!-- 操作ガイド -->
    <div class="help-section">
      <div class="help-section-title">操作ガイド</div>

      <a class="help-item" href="#" onclick="helpShowGuide('product'); return false;">
        <div class="help-item-icon">
          <i class="bi bi-camera"></i>
        </div>
        <div class="help-item-content">
          <div class="help-item-title">商品登録の使い方</div>
          <div class="help-item-desc">写真撮影から登録完了まで</div>
        </div>
        <i class="bi bi-chevron-right help-item-arrow"></i>
      </a>

      <a class="help-item" href="#" onclick="helpShowGuide('inventory'); return false;">
        <div class="help-item-icon">
          <i class="bi bi-box-seam"></i>
        </div>
        <div class="help-item-content">
          <div class="help-item-title">在庫管理の使い方</div>
          <div class="help-item-desc">在庫確認・ステータス変更</div>
        </div>
        <i class="bi bi-chevron-right help-item-arrow"></i>
      </a>

      <a class="help-item" href="#" onclick="helpShowGuide('chat'); return false;">
        <div class="help-item-icon">
          <i class="bi bi-chat"></i>
        </div>
        <div class="help-item-content">
          <div class="help-item-title">チャットの使い方</div>
          <div class="help-item-desc">チーム連絡・通知設定</div>
        </div>
        <i class="bi bi-chevron-right help-item-arrow"></i>
      </a>
    </div>

    <!-- AIサポート -->
    <div class="help-section">
      <div class="help-section-title">AIサポート</div>

      <a class="help-item" href="#" onclick="helpOpenChatFullscreen(); return false;">
        <div class="help-item-icon" style="background: linear-gradient(135deg, var(--reborn-primary, #40B4E5) 0%, var(--reborn-primary-dark, #1E8FBF) 100%);">
          <i class="bi bi-chat-dots-fill" style="color: white;"></i>
        </div>
        <div class="help-item-content">
          <div class="help-item-title">AIに質問する</div>
          <div class="help-item-desc">フリラの使い方を何でも聞けます</div>
        </div>
        <i class="bi bi-chevron-right help-item-arrow"></i>
      </a>
    </div>

    <!-- お問い合わせ -->
    <div class="help-section">
      <div class="help-section-title">サポート</div>

      <a class="help-item" href="mailto:support@furira.jp">
        <div class="help-item-icon">
          <i class="bi bi-envelope"></i>
        </div>
        <div class="help-item-content">
          <div class="help-item-title">メールでお問い合わせ</div>
          <div class="help-item-desc">support@furira.jp</div>
        </div>
        <i class="bi bi-chevron-right help-item-arrow"></i>
      </a>
    </div>

    <!-- アプリ情報 -->
    <div class="help-section">
      <div class="help-section-title">アプリ情報</div>

      <div class="help-item" style="cursor: default;">
        <div class="help-item-icon">
          <i class="bi bi-info-circle"></i>
        </div>
        <div class="help-item-content">
          <div class="help-item-title">バージョン</div>
          <div class="help-item-desc" id="help-app-version">v321</div>
        </div>
      </div>
    </div>
  </div>

  <!-- フッター -->
  <div class="help-footer">
    <div class="help-footer-links">
      <a href="/privacy-policy.html" target="_blank">プライバシーポリシー</a>
      <a href="/terms-of-service.html" target="_blank">利用規約</a>
    </div>
    <div class="help-footer-copyright">&copy; 2025 フリラ</div>
  </div>

  <!-- AIチャットボット FAB -->
  <button class="help-chat-fab" onclick="helpOpenChatFullscreen()" title="AIに質問する">
    <i class="bi bi-chat-dots-fill"></i>
  </button>

  <!-- AIチャット全画面UI（ChatGPT風） -->
  <div class="help-chat-fullscreen" id="help-chatFullscreen">
    <!-- サイドバー（会話一覧） -->
    <div class="help-chat-sidebar" id="help-chatSidebar">
      <div class="help-sidebar-header">
        <button class="help-new-chat-btn" onclick="helpStartNewConversation()">
          <i class="bi bi-plus-lg"></i>
          <span>新しいチャット</span>
        </button>
      </div>
      <div class="help-sidebar-conversations" id="help-conversationList">
        <div class="help-loading-conversations">読み込み中...</div>
      </div>
      <div class="help-sidebar-footer">
        <button class="help-close-chat-btn" onclick="helpCloseChatFullscreen()">
          <i class="bi bi-x-lg"></i>
          <span>チャットを閉じる</span>
        </button>
      </div>
    </div>

    <!-- オーバーレイ（モバイル用） -->
    <div class="help-sidebar-overlay" id="help-sidebarOverlay" onclick="helpToggleSidebar()"></div>

    <!-- メインチャットエリア -->
    <div class="help-chat-main">
      <div class="help-chat-main-header">
        <button class="help-chat-header-btn" onclick="helpCloseChatFullscreen()" title="閉じる">
          <i class="bi bi-chevron-left"></i>
        </button>
        <div class="help-chat-main-header-avatar"><img src="/chatboticon.png" alt="AIサポート"></div>
        <div class="help-chat-main-header-info">
          <div class="help-chat-main-header-title">フリラ AIサポート</div>
          <div class="help-chat-main-header-status">オンライン</div>
        </div>
        <button class="help-chat-header-btn" onclick="helpToggleSidebar()" title="会話履歴">
          <i class="bi bi-clock-history"></i>
        </button>
      </div>

      <div class="help-chat-messages" id="help-chatMessages">
        <div class="help-chat-welcome">
          <div class="help-chat-welcome-icon">&#x1F44B;</div>
          <div class="help-chat-welcome-title">こんにちは！</div>
          <div class="help-chat-welcome-desc">フリラの使い方について何でも聞いてください。<br>会話履歴は自動で保存されます。</div>
        </div>
      </div>

      <div class="help-chat-quick-actions" id="help-quickActions">
        <button class="help-quick-action-btn" onclick="helpSendQuickMessage('商品登録の方法を教えて')">&#x1F4E6; 商品登録の方法</button>
        <button class="help-quick-action-btn" onclick="helpSendQuickMessage('通知が届かない')">&#x1F514; 通知が届かない</button>
        <button class="help-quick-action-btn" onclick="helpSendQuickMessage('在庫管理の使い方')">&#x1F4CA; 在庫管理</button>
        <button class="help-quick-action-btn" onclick="helpSendQuickMessage('チャットの使い方')">&#x1F4AC; チャット</button>
      </div>

      <div class="help-chat-input-area">
        <textarea
          class="help-chat-input"
          id="help-chatInput"
          placeholder="質問を入力..."
          rows="1"
          onkeydown="helpHandleKeyDown(event)"
          oninput="helpAutoResize(this)"
        ></textarea>
        <button class="help-chat-send-btn" id="help-chatSendBtn" onclick="helpSendMessage()" disabled>
          <i class="bi bi-send-fill"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // Help Page SPA Fragment
    // ============================================

    // State variables (scoped to this page)
    var _helpCurrentUserId = null;
    var _helpCurrentConversationId = null;
    var _helpConversationHistory = [];

    // Cloudflare Worker エンドポイント
    var HELP_CHATBOT_API_ENDPOINT = 'https://reborn-help-chatbot.mercari-yasuhirotakuji.workers.dev/chat';

    // Use parent's Firebase globals
    var _helpDb = window.firebaseDB;

    // ユーザーID取得
    function helpGetUserId() {
      var userEmail = localStorage.getItem('reborn_user_email');
      if (userEmail) return userEmail;
      var firebaseUid = localStorage.getItem('reborn_firebase_uid');
      if (firebaseUid) return firebaseUid;
      var deviceId = localStorage.getItem('help_chat_device_id');
      if (!deviceId) {
        deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('help_chat_device_id', deviceId);
      }
      return deviceId;
    }

    // 初期化
    function helpInitChat() {
      _helpCurrentUserId = helpGetUserId();
      console.log('[Help SPA] ユーザーID:', _helpCurrentUserId);
      helpLoadConversations();
    }

    // 会話一覧を読み込み
    async function helpLoadConversations() {
      var conversationListEl = document.getElementById('help-conversationList');
      if (!conversationListEl) return;
      conversationListEl.innerHTML = '<div class="help-loading-conversations">読み込み中...</div>';

      var q = window.firestoreQuery(
        window.firestoreCollection(_helpDb, 'help_conversations'),
        window.firestoreWhere('userId', '==', _helpCurrentUserId),
        window.firestoreOrderBy('updatedAt', 'desc')
      );

      try {
        var snapshot = await window.firestoreGetDocs(q);
        var conversations = [];
        snapshot.forEach(function(docSnap) {
          conversations.push({ id: docSnap.id, ...docSnap.data() });
        });
        helpRenderConversationList(conversations);
        console.log('[Help SPA] 会話一覧取得完了:', conversations.length + '件');
      } catch (error) {
        console.error('[Help SPA] 会話一覧読み込みエラー:', error);
        conversationListEl.innerHTML = '<div class="help-no-conversations">会話履歴を読み込めませんでした</div>';
      }
    }

    // 会話一覧を描画
    function helpRenderConversationList(conversations) {
      var conversationListEl = document.getElementById('help-conversationList');
      if (!conversationListEl) return;

      if (conversations.length === 0) {
        conversationListEl.innerHTML = '<div class="help-no-conversations">会話履歴がありません</div>';
        return;
      }

      var html = '';
      var lastDate = '';

      conversations.forEach(function(conv) {
        var convDate = conv.updatedAt && conv.updatedAt.toDate ? conv.updatedAt.toDate() : new Date();
        var dateStr = helpFormatDateDivider(convDate);
        if (dateStr !== lastDate) {
          html += '<div class="help-conversation-date-divider">' + dateStr + '</div>';
          lastDate = dateStr;
        }

        var activeClass = conv.id === _helpCurrentConversationId ? 'active' : '';
        html += '<div class="help-conversation-item ' + activeClass + '" onclick="helpSelectConversation(\'' + conv.id + '\')" data-id="' + conv.id + '">' +
          '<i class="bi bi-chat-left-text"></i>' +
          '<span class="help-conversation-title">' + helpEscapeHtml(conv.title || '新しい会話') + '</span>' +
          '<button class="help-conversation-delete" onclick="event.stopPropagation(); helpDeleteConversation(\'' + conv.id + '\')" title="削除">' +
          '<i class="bi bi-trash"></i></button></div>';
      });

      conversationListEl.innerHTML = html;
    }

    // 日付区切りフォーマット
    function helpFormatDateDivider(date) {
      var now = new Date();
      var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      var yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
      var targetDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

      if (targetDate.getTime() === today.getTime()) return '今日';
      if (targetDate.getTime() === yesterday.getTime()) return '昨日';
      if (targetDate.getTime() > today.getTime() - 7 * 24 * 60 * 60 * 1000) return '過去7日間';
      if (targetDate.getTime() > today.getTime() - 30 * 24 * 60 * 60 * 1000) return '過去30日間';
      return date.getFullYear() + '年' + (date.getMonth() + 1) + '月';
    }

    // HTMLエスケープ
    function helpEscapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // 会話を選択
    async function helpSelectConversation(conversationId) {
      _helpCurrentConversationId = conversationId;

      document.querySelectorAll('#spa-page-help .help-conversation-item').forEach(function(el) {
        el.classList.toggle('active', el.dataset.id === conversationId);
      });

      try {
        var docRef = window.firestoreDoc(_helpDb, 'help_conversations', conversationId);
        var docSnap = await window.firestoreGetDoc(docRef);

        if (docSnap.exists()) {
          var data = docSnap.data();
          _helpConversationHistory = data.messages || [];
          helpRenderMessages();
        }
      } catch (error) {
        console.error('[Help SPA] 会話読み込みエラー:', error);
      }

      if (window.innerWidth <= 768) {
        helpToggleSidebar();
      }
    }

    // メッセージを描画
    function helpRenderMessages() {
      var messagesEl = document.getElementById('help-chatMessages');
      if (!messagesEl) return;

      if (_helpConversationHistory.length === 0) {
        messagesEl.innerHTML =
          '<div class="help-chat-welcome">' +
          '<div class="help-chat-welcome-icon">&#x1F44B;</div>' +
          '<div class="help-chat-welcome-title">こんにちは！</div>' +
          '<div class="help-chat-welcome-desc">フリラの使い方について何でも聞いてください。<br>会話履歴は自動で保存されます。</div>' +
          '</div>';
        var qa = document.getElementById('help-quickActions');
        if (qa) qa.style.display = 'flex';
        return;
      }

      var qa = document.getElementById('help-quickActions');
      if (qa) qa.style.display = 'none';

      var html = '';
      _helpConversationHistory.forEach(function(msg) {
        var roleClass = msg.role === 'user' ? 'user' : 'ai';
        html += '<div class="help-chat-message ' + roleClass + '">' + helpEscapeHtml(msg.content) + '</div>';
      });

      messagesEl.innerHTML = html;
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // 新しい会話を開始
    function helpStartNewConversation() {
      _helpCurrentConversationId = null;
      _helpConversationHistory = [];

      document.querySelectorAll('#spa-page-help .help-conversation-item').forEach(function(el) {
        el.classList.remove('active');
      });

      helpRenderMessages();

      if (window.innerWidth <= 768) {
        helpToggleSidebar();
      }
    }

    // 会話を削除
    async function helpDeleteConversation(conversationId) {
      if (!confirm('この会話を削除しますか？')) return;

      try {
        await window.firestoreDeleteDoc(window.firestoreDoc(_helpDb, 'help_conversations', conversationId));
        console.log('[Help SPA] 会話削除完了:', conversationId);

        if (_helpCurrentConversationId === conversationId) {
          helpStartNewConversation();
        }
        helpLoadConversations();
      } catch (error) {
        console.error('[Help SPA] 会話削除エラー:', error);
        alert('削除に失敗しました');
      }
    }

    // メッセージ送信
    async function helpSendMessage() {
      var input = document.getElementById('help-chatInput');
      if (!input) return;
      var message = input.value.trim();
      if (!message) return;

      input.value = '';
      helpAutoResize(input);
      var sendBtn = document.getElementById('help-chatSendBtn');
      if (sendBtn) sendBtn.disabled = true;

      var qa = document.getElementById('help-quickActions');
      if (qa) qa.style.display = 'none';

      var welcome = document.querySelector('#spa-page-help .help-chat-welcome');
      if (welcome) welcome.remove();

      helpAddMessageToUI(message, 'user');

      _helpConversationHistory.push({ role: 'user', content: message, timestamp: new Date().toISOString() });

      if (!_helpCurrentConversationId) {
        try {
          var title = message.length > 30 ? message.substring(0, 30) + '...' : message;
          var docRef = await window.firestoreAddDoc(window.firestoreCollection(_helpDb, 'help_conversations'), {
            userId: _helpCurrentUserId,
            title: title,
            messages: _helpConversationHistory,
            createdAt: window.firestoreServerTimestamp(),
            updatedAt: window.firestoreServerTimestamp()
          });
          _helpCurrentConversationId = docRef.id;
          console.log('[Help SPA] 新しい会話作成:', _helpCurrentConversationId);
          helpLoadConversations();
        } catch (error) {
          console.error('[Help SPA] 会話作成エラー:', error);
        }
      }

      var typingId = helpShowTypingIndicator();

      try {
        var response = await fetch(HELP_CHATBOT_API_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: message,
            history: _helpConversationHistory.slice(-10)
          }),
        });

        helpRemoveTypingIndicator(typingId);

        if (!response.ok) throw new Error('HTTP error! status: ' + response.status);

        var data = await response.json();
        if (data.error) throw new Error(data.error);

        var aiResponse = data.response || 'すみません、回答を生成できませんでした。';
        helpAddMessageToUI(aiResponse, 'ai');

        _helpConversationHistory.push({ role: 'assistant', content: aiResponse, timestamp: new Date().toISOString() });

        if (_helpCurrentConversationId) {
          try {
            await window.firestoreUpdateDoc(window.firestoreDoc(_helpDb, 'help_conversations', _helpCurrentConversationId), {
              messages: _helpConversationHistory,
              updatedAt: window.firestoreServerTimestamp()
            });
          } catch (error) {
            console.error('[Help SPA] 会話更新エラー:', error);
          }
        }

      } catch (error) {
        console.error('チャットエラー:', error);
        helpRemoveTypingIndicator(typingId);
        helpAddMessageToUI('申し訳ございません。現在AIサポートに接続できません。しばらく経ってから再度お試しください。', 'ai');
      }
    }

    // UIにメッセージを追加
    function helpAddMessageToUI(text, type) {
      var messagesContainer = document.getElementById('help-chatMessages');
      if (!messagesContainer) return;
      var messageDiv = document.createElement('div');
      messageDiv.className = 'help-chat-message ' + type;
      messageDiv.textContent = text;
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // タイピングインジケーターを表示
    function helpShowTypingIndicator() {
      var messagesContainer = document.getElementById('help-chatMessages');
      if (!messagesContainer) return '';
      var typingDiv = document.createElement('div');
      var typingId = 'help-typing-' + Date.now();
      typingDiv.id = typingId;
      typingDiv.className = 'help-chat-message ai typing';
      typingDiv.innerHTML = '<div class="help-typing-indicator"><span></span><span></span><span></span></div>';
      messagesContainer.appendChild(typingDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      return typingId;
    }

    // タイピングインジケーターを削除
    function helpRemoveTypingIndicator(typingId) {
      var typingDiv = document.getElementById(typingId);
      if (typingDiv) typingDiv.remove();
    }

    // テキストエリアの自動リサイズ
    function helpAutoResize(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
      var sendBtn = document.getElementById('help-chatSendBtn');
      if (sendBtn) sendBtn.disabled = !textarea.value.trim();
    }

    // Enterキーで送信
    function helpHandleKeyDown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        helpSendMessage();
      }
    }

    // クイックメッセージ送信
    function helpSendQuickMessage(message) {
      var input = document.getElementById('help-chatInput');
      if (input) {
        input.value = message;
        helpSendMessage();
      }
    }

    // サイドバーの開閉
    function helpToggleSidebar() {
      var sidebar = document.getElementById('help-chatSidebar');
      var overlay = document.getElementById('help-sidebarOverlay');
      if (sidebar) sidebar.classList.toggle('open');
      if (overlay) overlay.classList.toggle('open');
    }

    // チャット全画面を開く
    function helpOpenChatFullscreen() {
      var fullscreen = document.getElementById('help-chatFullscreen');
      if (fullscreen) fullscreen.classList.add('open');

      // ボトムナビを非表示
      var bottomNav = document.getElementById('bottom-nav');
      if (bottomNav) bottomNav.style.display = 'none';

      if (!_helpCurrentUserId) {
        helpInitChat();
      }
    }

    // チャット全画面を閉じる
    function helpCloseChatFullscreen() {
      var fullscreen = document.getElementById('help-chatFullscreen');
      if (fullscreen) fullscreen.classList.remove('open');

      // ボトムナビを復元
      var bottomNav = document.getElementById('bottom-nav');
      if (bottomNav) bottomNav.style.display = '';

      var sidebar = document.getElementById('help-chatSidebar');
      var overlay = document.getElementById('help-sidebarOverlay');
      if (sidebar) sidebar.classList.remove('open');
      if (overlay) overlay.classList.remove('open');
    }

    // FAQアコーディオン
    function helpToggleFaq(element) {
      document.querySelectorAll('#spa-page-help .help-faq-item.open').forEach(function(item) {
        if (item !== element) item.classList.remove('open');
      });
      element.classList.toggle('open');
    }

    // 操作ガイド表示
    function helpShowGuide(type) {
      alert('「' + type + '」のガイドは準備中です。');
    }

    // 戻るボタン
    function helpGoBack() {
      if (typeof spaGoBack === 'function') {
        spaGoBack();
      } else if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'requestBack' }, '*');
      } else {
        window.history.back();
      }
    }

    // ============================================
    // SPA Lifecycle
    // ============================================

    function initHelpPage() {
      console.log('[Help SPA] initHelpPage called');
      _helpDb = window.firebaseDB;

      // Restore conversations from parent if available
      if (window.helpConversations && window.helpConversations.length > 0) {
        _helpConversationHistory = window.helpConversations;
      }

      // Setup input listener
      var input = document.getElementById('help-chatInput');
      if (input) {
        input.addEventListener('input', function() {
          helpAutoResize(this);
        });
      }
    }

    function destroyHelpPage() {
      console.log('[Help SPA] destroyHelpPage called');
      // Close fullscreen chat if open
      helpCloseChatFullscreen();
      // Clear state
      _helpCurrentUserId = null;
      _helpCurrentConversationId = null;
      _helpConversationHistory = [];
    }
  </script>
</div>
