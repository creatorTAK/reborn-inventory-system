<!-- SPA Fragment: chat_ui_firestore.html -->
<!-- Prefix: cui -->
<!-- SPA Page Key: chat-room -->
<!-- Source: docs/chat_ui_firestore.html (9,249 lines) -->
<!-- Conversion: Full inline (no iframe) -->
<div id="spa-page-chat-ui">
  <style>
    /* ========================================
       Scoped CSS for Chat UI Fragment
       All selectors prefixed with #spa-page-chat-ui
       ======================================== */
    #spa-page-chat-ui {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      margin: 0;
      padding: 0;
      padding-top: calc(env(safe-area-inset-top, 0px) + 56px); /* セーフエリア + ヘッダー分のスペース */
      box-sizing: border-box;
      overflow: hidden;
      background-color: #f8f9fa;
      display: flex;
      flex-direction: column;
      /* 長押しメニュー表示時のテキスト選択を無効化 */
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 50;
    }

    /* ヘッダー */
    #spa-page-chat-ui .chat-header {
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      color: white;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      flex-shrink: 0;
      position: relative;
    }
    #spa-page-chat-ui .chat-header h1 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
      padding-left: 40px; /* 戻るボタンのスペースを確保 */
    }
    #spa-page-chat-ui .chat-header .channel-info {
      font-size: 0.875rem;
      opacity: 0.9;
      margin-top: 4px;
      padding-left: 40px; /* 戻るボタンのスペースを確保 */
    }
    #spa-page-chat-ui .version-badge {
      font-size: 0.7rem;
      opacity: 0.6;
      margin-left: 8px;
      padding: 2px 6px;
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
    }
    /* 戻るボタン（LINE風） */
    #spa-page-chat-ui .back-btn {
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: white;
      font-size: 32px;
      padding: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      transition: opacity 0.2s;
      font-weight: 300;
    }
    #spa-page-chat-ui .back-btn:hover {
      opacity: 0.8;
    }
    #spa-page-chat-ui .back-btn:active {
      opacity: 0.6;
    }
    /* 戻るボタン未読数（LINE風） */
    #spa-page-chat-ui .back-unread-count {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-left: 2px;
    }

    /* 検索ボタン（白ヘッダー用） */
    #spa-page-chat-ui .search-button {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 20px;
      -webkit-tap-highlight-color: transparent;
      outline: none;
    }
    #spa-page-chat-ui .call-button {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 18px;
      -webkit-tap-highlight-color: transparent;
      outline: none;
    }

    /* ヘッダーコンテンツ */
    #spa-page-chat-ui .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 56px;
      padding: 0 8px;
      position: relative;
    }

    /* ヘッダータイトル */
    #spa-page-chat-ui .header-title {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 8px;
      color: #1f2937;
      font-size: 17px;
      font-weight: 600;
      pointer-events: auto;
    }
    /* ヘッダー右側ボタングループ */
    #spa-page-chat-ui .header-right-buttons {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    /* 設定ボタン（白ヘッダー用） */
    #spa-page-chat-ui .settings-button {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 20px;
      position: relative;
      -webkit-tap-highlight-color: transparent;
      outline: none;
    }

    /* チャット設定ドロップダウン */
    #spa-page-chat-ui .chat-settings-dropdown {
      position: absolute;
      top: 100%;
      right: 8px;
      margin-top: 4px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 180px;
      overflow: hidden;
      display: none;
      z-index: 1001;
    }
    #spa-page-chat-ui .chat-settings-dropdown.active {
      display: block;
    }
    #spa-page-chat-ui .chat-settings-item {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      padding: 14px 16px;
      border: none;
      background: transparent;
      font-size: 15px;
      color: #1f2937;
      cursor: pointer;
      text-align: left;
      transition: background 0.2s;
    }
    #spa-page-chat-ui .chat-settings-item:hover {
      background: #f5f5f5;
    }
    #spa-page-chat-ui .chat-settings-item:active {
      background: #e5e5e5;
    }
    #spa-page-chat-ui .chat-settings-item i {
      font-size: 18px;
      color: #606060;
    }
    #spa-page-chat-ui .chat-settings-item.danger {
      color: #ef4444;
    }
    #spa-page-chat-ui .chat-settings-item.danger i {
      color: #ef4444;
    }
    #spa-page-chat-ui .chat-settings-divider {
      height: 1px;
      background: #e5e7eb;
      margin: 4px 0;
    }

    /* トーストアニメーション */
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
      15% { opacity: 1; transform: translateX(-50%) translateY(0); }
      85% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
    }

    /* 検索モード */
    #spa-page-chat-ui .header-search-mode {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #spa-page-chat-ui .search-input-container {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
    }
    #spa-page-chat-ui .search-input {
      width: 100%;
      height: 36px;
      border: none;
      border-radius: 8px;
      padding: 0 36px 0 12px;
      font-size: 16px; /* iOS auto-zoom防止（16px以上必須） */
      background: #f3f4f6; /* 薄いグレー */
      color: #1f2937;
    }
    #spa-page-chat-ui .search-input:focus {
      outline: none;
    }
    #spa-page-chat-ui .search-input::placeholder {
      color: #9ca3af;
    }
    #spa-page-chat-ui .search-clear-btn {
      position: absolute;
      right: 8px;
      width: 24px;
      height: 24px;
      border: none;
      background: #e5e7eb;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #6b7280;
      font-size: 14px;
    }
    #spa-page-chat-ui .search-nav-buttons {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    #spa-page-chat-ui .search-count {
      font-size: 12px;
      color: #6b7280;
      min-width: 40px;
      text-align: center;
    }
    #spa-page-chat-ui .search-nav-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: white;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #374151;
      font-size: 14px;
    }
    #spa-page-chat-ui .search-nav-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    #spa-page-chat-ui .search-close-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #6b7280;
      font-size: 20px;
      margin-left: 4px;
      flex-shrink: 0;
    }
    #spa-page-chat-ui .search-close-btn:hover {
      color: #374151;
    }

    /* 検索ハイライト */
    #spa-page-chat-ui .search-highlight {
      background: #fef08a;
      padding: 1px 2px;
      border-radius: 2px;
    }
    #spa-page-chat-ui .search-highlight-current {
      background: #fef08a;
      padding: 1px 2px;
      border-radius: 2px;
      border: 2px solid #fb923c;
      box-shadow: 0 0 4px rgba(251, 146, 60, 0.5);
    }
    /* 自分のメッセージ（青背景）用のハイライト - 白背景+青文字で反転 */
    #spa-page-chat-ui .message-item-mine .search-highlight {
      background: rgba(255, 255, 255, 0.95);
      color: #1a73e8;
      padding: 1px 4px;
    }
    #spa-page-chat-ui .message-item-mine .search-highlight-current {
      background: rgba(255, 255, 255, 0.95);
      color: #1a73e8;
      padding: 1px 4px;
      border: 2px solid #fb923c;
      box-shadow: 0 0 4px rgba(251, 146, 60, 0.5);
    }

    /* メッセージリスト */
    #spa-page-chat-ui .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      padding-bottom: 80px;
      background-color: #f8f9fa;
      /* テキスト選択を無効化（長押しメニュー干渉防止） */
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    /* キーボード表示時：下部余白を縮小 */
    #spa-page-chat-ui .messages-container.keyboard-visible {
      padding-bottom: 16px;
    }

    /* キーボード表示時：入力エリアの下部余白も縮小 */
    #spa-page-chat-ui .input-container.keyboard-visible {
      padding-bottom: 8px;
    }

    /* 日付セパレータ（インライン表示用） */
    #spa-page-chat-ui .date-separator {
      text-align: center;
      padding: 8px 0;
    }
    #spa-page-chat-ui .date-separator-badge {
      display: inline-block;
      background-color: rgba(0, 0, 0, 0.15);
      color: #555;
      font-size: 0.7rem;
      padding: 4px 12px;
      border-radius: 12px;
    }
    /* 固定日付バッジ（LINE風：ヘッダー直下に固定） */
    #spa-page-chat-ui .sticky-date-badge {
      position: fixed;
      top: calc(env(safe-area-inset-top, 0px) + 68px); /* セーフエリア + ヘッダー(56px) + 余白(12px) */
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.15);
      color: #555;
      font-size: 0.7rem;
      padding: 4px 12px;
      border-radius: 12px;
      z-index: 101; /* ヘッダー(100)より上に表示 */
      pointer-events: none;
      transition: opacity 0.2s;
    }
    #spa-page-chat-ui .sticky-date-badge.hidden {
      opacity: 0;
    }

    #spa-page-chat-ui .message-item {
      margin-bottom: 16px;
      animation: fadeIn 0.3s ease-in;
      display: flex;
      /* iOSのテキスト選択・コールアウトを無効化 */
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
      15% { opacity: 1; transform: translateX(-50%) translateY(0); }
      85% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
    }

    /* メッセージコンテント（アイコン + バブル + 時間） */
    #spa-page-chat-ui .message-content {
      display: flex;
      align-items: flex-start;
      max-width: 80%;
      gap: 8px;
    }

    /* 自分のメッセージ（右寄せ・青） */
    #spa-page-chat-ui .message-item-mine {
      justify-content: flex-end;
    }
    #spa-page-chat-ui .message-item-mine .message-content {
      flex-direction: row;
    }
    #spa-page-chat-ui .message-item-mine .message-bubble {
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      color: white;
      padding: 10px 14px;
      border-radius: 18px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    /* 他人のメッセージ（左寄せ・グレー） */
    #spa-page-chat-ui .message-item-other {
      justify-content: flex-start;
    }
    #spa-page-chat-ui .message-item-other .message-content {
      flex-direction: row;
    }
    #spa-page-chat-ui .message-item-other .message-bubble {
      background-color: white;
      color: #2d3748;
      padding: 10px 14px;
      border-radius: 18px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    /* システムメッセージ（LINE風センター配置） */
    #spa-page-chat-ui .message-item-system {
      justify-content: center;
      padding: 4px 16px;
    }
    #spa-page-chat-ui .message-item-system .system-message-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }
    #spa-page-chat-ui .message-item-system .system-time {
      font-size: 11px;
      color: #6b7280;
    }
    #spa-page-chat-ui .message-item-system .system-bubble {
      background: rgba(0, 0, 0, 0.06);
      color: #4b5563;
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 14px;
      text-align: center;
      max-width: 100%;
    }

    /* メッセージバブル（横幅は親要素に依存、LINE風の自然な改行） */
    #spa-page-chat-ui .message-bubble {
      /* max-width指定なし - 親要素の幅で自然に改行 */
    }

    /* 取り消し済みメッセージ */
    #spa-page-chat-ui .message-bubble.deleted {
      background: transparent !important;
      box-shadow: none !important;
      padding: 8px 0 !important;
    }
    #spa-page-chat-ui .message-bubble.deleted .message-text {
      color: #9ca3af;
      font-style: italic;
      font-size: 13px;
    }
    #spa-page-chat-ui .message-item-mine .message-bubble.deleted .message-text {
      color: #9ca3af;
    }

    #spa-page-chat-ui .message-header {
      display: none; /* ヘッダーは非表示 */
    }

    /* 画像メッセージ */
    #spa-page-chat-ui .message-image {
      max-width: 180px;
      max-height: 250px;
      width: 100%;
      height: auto;
      border-radius: 12px;
      display: block;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    #spa-page-chat-ui .message-image:hover {
      opacity: 0.9;
    }
    #spa-page-chat-ui .message-image:active {
      opacity: 0.8;
    }

    /* 画像メッセージのバブルは余白を調整 */
    #spa-page-chat-ui .message-bubble:has(.message-image) {
      padding: 0;
      background: transparent;
      box-shadow: none;
    }

    /* 画像 + キャプションの場合 */
    #spa-page-chat-ui .message-bubble .message-image + .message-text {
      margin-top: 8px;
      padding: 0 10px 6px 10px;
    }

    /* ファイルメッセージ - バブルに溶け込むデザイン */
    #spa-page-chat-ui .message-file-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 6px 2px;
      background: transparent;
      text-decoration: none;
      color: inherit;
      transition: opacity 0.2s;
    }
    #spa-page-chat-ui .message-file-link:hover {
      opacity: 0.8;
    }
    #spa-page-chat-ui .message-file-icon {
      font-size: 20px;
      flex-shrink: 0;
      color: #374151;
    }
    #spa-page-chat-ui .message-file-info {
      flex: 1;
      min-width: 0;
    }
    #spa-page-chat-ui .message-file-name {
      font-weight: 500;
      font-size: 14px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    #spa-page-chat-ui .message-file-size {
      font-size: 12px;
      color: #718096;
      margin-top: 2px;
    }
    /* 自分が送ったファイルメッセージ */
    #spa-page-chat-ui .message-item-mine .message-file-icon {
      color: white;
    }
    #spa-page-chat-ui .message-item-mine .message-file-name {
      color: white;
    }
    #spa-page-chat-ui .message-item-mine .message-file-size {
      color: rgba(255, 255, 255, 0.8);
    }

    /* ユーザーアイコン（LINE風） */
    #spa-page-chat-ui .user-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #e2e8f0;
      flex-shrink: 0;
      cursor: pointer;
    }
    #spa-page-chat-ui .user-icon-placeholder {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 16px;
      border: 2px solid #e2e8f0;
      flex-shrink: 0;
      cursor: pointer;
    }

    /* プロフィールポップアップ */
    #spa-page-chat-ui .profile-popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    #spa-page-chat-ui .profile-popup-overlay.active {
      display: flex;
    }
    #spa-page-chat-ui .profile-popup {
      background: white;
      border-radius: 20px;
      width: 280px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: popupSlideIn 0.3s ease-out;
    }
    @keyframes popupSlideIn {
      from { opacity: 0; transform: translateY(20px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    #spa-page-chat-ui .profile-popup-header {
      background: linear-gradient(135deg, var(--reborn-primary), var(--reborn-primary-dark));
      padding: 30px 20px 20px;
      text-align: center;
      position: relative;
      background-size: cover;
      background-position: center;
    }
    #spa-page-chat-ui .profile-popup-close {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #spa-page-chat-ui .profile-popup-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    #spa-page-chat-ui .profile-popup-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid white;
      object-fit: cover;
      margin-bottom: 12px;
    }
    #spa-page-chat-ui .profile-popup-avatar-initial {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid white;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 32px;
      font-weight: 600;
      margin: 0 auto 12px;
    }
    #spa-page-chat-ui .profile-popup-name {
      color: white;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    #spa-page-chat-ui .profile-popup-status {
      color: rgba(255, 255, 255, 0.8);
      font-size: 13px;
    }
    #spa-page-chat-ui .profile-popup-actions {
      display: flex;
      justify-content: center;
      gap: 32px;
      padding: 24px 20px;
      background: white;
    }
    #spa-page-chat-ui .profile-popup-action {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 12px;
      transition: background 0.2s;
    }
    #spa-page-chat-ui .profile-popup-action:hover {
      background: #f3f4f6;
    }
    #spa-page-chat-ui .profile-popup-action-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }
    #spa-page-chat-ui .profile-popup-action-icon.chat {
      background: var(--reborn-primary);
      color: white;
    }
    #spa-page-chat-ui .profile-popup-action-icon.call {
      background: #22c55e;
      color: white;
    }
    #spa-page-chat-ui .profile-popup-action-label {
      font-size: 12px;
      color: #4b5563;
      font-weight: 500;
    }

    /* バブルコンテナ（ユーザー名 + バブル を縦に配置） */
    #spa-page-chat-ui .bubble-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    #spa-page-chat-ui .message-item-mine .bubble-container {
      align-items: flex-end;
    }

    /* グループチャット時の送信者名（相手のメッセージのみ） */
    #spa-page-chat-ui .message-sender {
      display: none; /* デフォルトは非表示 */
    }
    #spa-page-chat-ui .message-sender.show-in-group {
      display: block;
      font-size: 0.7rem;
      color: #666;
      margin-bottom: 2px;
      margin-left: 2px;
    }

    /* メッセージラッパー（バブル + 時間） */
    #spa-page-chat-ui .message-wrapper {
      display: flex;
      flex-direction: row;
      align-items: flex-end;
      gap: 6px;
    }
    /* 自分のメッセージ: バブルが右、メタ情報（既読+時間）がバブルの左 */
    #spa-page-chat-ui .message-item-mine .message-wrapper {
      flex-direction: row;
      justify-content: flex-end;
    }

    /* 既読+時間を縦に並べるコンテナ */
    #spa-page-chat-ui .message-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 1px;
      flex-shrink: 0;
    }

    #spa-page-chat-ui .message-time {
      font-size: 0.65rem;
      color: #718096;
      opacity: 0.8;
      padding: 0;
    }
    #spa-page-chat-ui .message-read-status {
      font-size: 0.6rem;
      color: #718096;
      opacity: 0.9;
      padding: 0;
    }
    #spa-page-chat-ui .message-text {
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.5;
      font-size: 15px;
      /* テキスト選択を完全に無効化 */
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 50;
    }
    #spa-page-chat-ui .delete-button {
      background: none;
      border: none;
      color: #ef4444;
      cursor: pointer;
      font-size: 0.875rem;
      padding: 4px 8px;
      margin-left: 8px;
      opacity: 0.6;
      transition: opacity 0.2s;
    }
    #spa-page-chat-ui .delete-button:hover {
      opacity: 1;
    }

    /* 画像プレビューエリア（LINE風） */
    #spa-page-chat-ui .image-preview-container {
      background-color: white;
      border-top: 1px solid #e2e8f0;
      padding: 8px 12px;
      max-height: 160px;
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;
    }
    #spa-page-chat-ui .image-preview-list {
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }
    #spa-page-chat-ui .image-preview-item {
      position: relative;
      display: inline-block;
      flex-shrink: 0;
    }
    #spa-page-chat-ui .image-preview-item img {
      max-width: 100px;
      max-height: 100px;
      border-radius: 8px;
      object-fit: cover;
    }
    #spa-page-chat-ui .image-preview-item .remove-btn {
      position: absolute;
      top: -6px;
      right: -6px;
      background: rgba(0, 0, 0, 0.7);
      border: none;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
    }
    #spa-page-chat-ui .image-preview-item .remove-btn svg {
      width: 14px;
      height: 14px;
      stroke: white;
    }
    #spa-page-chat-ui .image-preview-count {
      display: inline-flex;
      align-items: center;
      background: #06c755;
      color: white;
      padding: 4px 10px;
      border-radius: 16px;
      font-size: 13px;
      font-weight: 500;
      margin-left: 8px;
    }
    #spa-page-chat-ui .image-preview-content {
      position: relative;
      display: inline-block;
      max-width: 100%;
    }
    #spa-page-chat-ui .image-preview-close {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.6);
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
      z-index: 10;
    }
    #spa-page-chat-ui .image-preview-close:hover {
      background: rgba(0, 0, 0, 0.8);
    }
    #spa-page-chat-ui .image-preview-close svg {
      color: white;
      width: 18px;
      height: 18px;
    }
    #spa-page-chat-ui #imagePreview {
      max-width: 100%;
      max-height: 120px;
      border-radius: 8px;
      display: block;
    }

    /* ブロック中バナー */
    #spa-page-chat-ui .blocked-banner {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      background: #fef2f2;
      border-top: 1px solid #fecaca;
      color: #dc2626;
      font-size: 14px;
      font-weight: 500;
    }
    #spa-page-chat-ui .blocked-banner i {
      font-size: 18px;
    }

    /* 入力エリア */
    #spa-page-chat-ui .input-container {
      padding: 12px 16px;
      padding-left: 8px; /* 左側の余白を減らす */
      padding-bottom: 24px; /* 下の余白を調整 */
      background-color: white;
      border-top: 1px solid #e2e8f0;
      flex-shrink: 0;
      position: relative; /* メンション候補リスト用 */
    }
    #spa-page-chat-ui .input-wrapper {
      display: flex;
      gap: 4px;
      align-items: center; /* ボタンと入力欄を垂直中央揃え */
    }
    #spa-page-chat-ui .action-button {
      background: transparent;
      border: none;
      color: #606060;
      cursor: pointer;
      padding: 0;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      align-self: center;
      -webkit-tap-highlight-color: transparent;
      outline: none;
    }
    #spa-page-chat-ui .action-button i {
      font-size: 22px;
    }
    #spa-page-chat-ui .action-button.expand-button i {
      font-size: 24px;
    }
    #spa-page-chat-ui .attachment-menu {
      position: absolute;
      bottom: 80px;
      left: 16px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      padding: 8px;
      z-index: 100;
    }
    #spa-page-chat-ui .attachment-menu-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: transparent;
      border: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
      border-radius: 8px;
      transition: background-color 0.2s;
      color: #2d3748;
      font-size: 0.95rem;
    }
    #spa-page-chat-ui .attachment-menu-item:hover {
      background-color: #f7fafc;
    }
    #spa-page-chat-ui .attachment-menu-item i {
      font-size: 20px;
      color: #606060;
    }

    /* 録音中オーバーレイ */
    #spa-page-chat-ui .voice-recording-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #spa-page-chat-ui .voice-recording-content {
      text-align: center;
      color: white;
    }
    #spa-page-chat-ui .voice-recording-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    #spa-page-chat-ui .voice-recording-dot {
      width: 16px;
      height: 16px;
      background: #ef4444;
      border-radius: 50%;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.1); }
    }
    #spa-page-chat-ui .voice-recording-time {
      font-size: 48px;
      font-weight: 300;
      font-variant-numeric: tabular-nums;
    }
    #spa-page-chat-ui .voice-recording-text {
      font-size: 16px;
      opacity: 0.8;
      margin-bottom: 32px;
    }
    #spa-page-chat-ui .voice-recording-buttons {
      display: flex;
      justify-content: center;
      gap: 32px;
    }
    #spa-page-chat-ui .voice-cancel-btn,
    #spa-page-chat-ui .voice-send-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      background: transparent;
      border: none;
      color: white;
      cursor: pointer;
      padding: 12px;
      -webkit-tap-highlight-color: transparent;
    }
    #spa-page-chat-ui .voice-cancel-btn i,
    #spa-page-chat-ui .voice-send-btn i {
      font-size: 32px;
    }
    #spa-page-chat-ui .voice-cancel-btn span,
    #spa-page-chat-ui .voice-send-btn span {
      font-size: 14px;
      opacity: 0.8;
    }
    #spa-page-chat-ui .voice-cancel-btn:active,
    #spa-page-chat-ui .voice-send-btn:active {
      opacity: 0.7;
    }
    #spa-page-chat-ui .voice-send-btn {
      color: var(--reborn-primary);
    }

    /* 音声メッセージ表示 - バブルに溶け込むデザイン */
    #spa-page-chat-ui .voice-message {
      display: flex;
      align-items: center;
      gap: 10px;
      background: transparent;
      padding: 6px 2px;
      min-width: 160px;
    }
    #spa-page-chat-ui .voice-play-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: white;
      color: var(--reborn-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      -webkit-tap-highlight-color: transparent;
    }
    #spa-page-chat-ui .voice-play-btn i {
      font-size: 16px;
      margin-left: 2px;
    }
    #spa-page-chat-ui .voice-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
    }
    #spa-page-chat-ui .voice-waveform {
      height: 24px;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    #spa-page-chat-ui .voice-waveform-bar {
      width: 3px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 2px;
    }
    #spa-page-chat-ui .voice-duration {
      font-size: 12px;
      color: #666;
    }
    /* 自分が送った音声メッセージ */
    #spa-page-chat-ui .message-item-mine .voice-play-btn {
      background: rgba(255, 255, 255, 0.9);
    }
    #spa-page-chat-ui .message-item-mine .voice-waveform-bar {
      background: rgba(255, 255, 255, 0.6);
    }
    #spa-page-chat-ui .message-item-mine .voice-duration {
      color: rgba(255, 255, 255, 0.85);
    }

    /* ノート共有カード - バブルに溶け込むデザイン */
    #spa-page-chat-ui .note-share-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 4px;
      background: transparent;
      cursor: pointer;
      transition: opacity 0.2s;
      min-width: 180px;
    }
    #spa-page-chat-ui .note-share-card:hover {
      opacity: 0.8;
    }
    #spa-page-chat-ui .note-share-card:active {
      opacity: 0.6;
    }
    #spa-page-chat-ui .note-share-icon {
      font-size: 22px;
      flex-shrink: 0;
      color: #374151;
    }

    /* 通話履歴カード - バブルに溶け込むデザイン */
    #spa-page-chat-ui .call-history-card {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 2px;
      background: transparent;
      min-width: 140px;
    }
    #spa-page-chat-ui .call-history-icon {
      font-size: 18px;
      color: #374151;
      flex-shrink: 0;
    }
    #spa-page-chat-ui .call-history-info {
      flex: 1;
      min-width: 0;
    }
    #spa-page-chat-ui .call-history-label {
      font-size: 13px;
      color: #374151;
      font-weight: 500;
    }
    #spa-page-chat-ui .call-history-duration {
      font-size: 12px;
      color: #6b7280;
    }
    /* 自分が送った通話履歴カード */
    #spa-page-chat-ui .message-item-mine .call-history-icon {
      color: white;
    }
    #spa-page-chat-ui .message-item-mine .call-history-label {
      color: white;
    }
    #spa-page-chat-ui .message-item-mine .call-history-duration {
      color: rgba(255,255,255,0.85);
    }
    #spa-page-chat-ui .note-share-info {
      flex: 1;
      min-width: 0;
    }
    #spa-page-chat-ui .note-share-label {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 2px;
    }
    #spa-page-chat-ui .note-share-title {
      font-size: 14px;
      font-weight: 600;
      color: #1e293b;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    #spa-page-chat-ui .note-share-arrow {
      color: #94a3b8;
      font-size: 16px;
      flex-shrink: 0;
    }
    /* 自分が送ったノートカードのスタイル */
    #spa-page-chat-ui .message-item-mine .note-share-label {
      color: rgba(255,255,255,0.8);
    }
    #spa-page-chat-ui .message-item-mine .note-share-title {
      color: white;
    }
    #spa-page-chat-ui .message-item-mine .note-share-arrow {
      color: rgba(255,255,255,0.7);
    }
    #spa-page-chat-ui .message-item-mine .note-share-icon {
      color: white;
    }

    /* メッセージ入力エリア - シンプルtextarea（iOS対応） */
    #spa-page-chat-ui .message-input-wrapper {
      flex: 1;
      position: relative;
      margin-right: 4px;
    }

    /* メンションタグ表示エリア（入力欄の上部） */
    #spa-page-chat-ui .mention-tags {
      display: none;
      flex-wrap: wrap;
      gap: 6px;
      padding: 8px 12px;
      background-color: #f5f5f5;
      border: 1px solid #cbd5e0;
      border-bottom: none;
      border-radius: 20px 20px 0 0;
    }

    #spa-page-chat-ui .mention-tags.has-tags {
      display: flex;
    }

    #spa-page-chat-ui .mention-tags + .message-input {
      border-radius: 0 0 20px 20px;
    }

    #spa-page-chat-ui .mention-tags:not(.has-tags) + .message-input {
      border-radius: 20px;
    }

    /* メンションタグ（チップスタイル） */
    #spa-page-chat-ui .mention-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: linear-gradient(135deg, var(--reborn-primary), #0056cc);
      color: white;
      font-size: 0.85rem;
      font-weight: 500;
      border-radius: 16px;
      white-space: nowrap;
    }

    #spa-page-chat-ui .mention-tag-remove {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      background: rgba(255, 255, 255, 0.3);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 12px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    #spa-page-chat-ui .mention-tag-remove:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    /* リプライプレビュー（入力欄の上部、LINE風） */
    #spa-page-chat-ui .reply-preview {
      display: none;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background-color: #f0f4f8;
      border: 1px solid #cbd5e0;
      border-bottom: none;
      border-radius: 16px 16px 0 0;
    }

    #spa-page-chat-ui .reply-preview.active {
      display: flex;
    }

    #spa-page-chat-ui .reply-preview.active + .mention-tags + .message-input,
    #spa-page-chat-ui .reply-preview.active + .mention-tags:not(.has-tags) + .message-input {
      border-radius: 0 0 20px 20px;
    }

    #spa-page-chat-ui .reply-preview-icon {
      width: 32px;
      height: 32px;
      min-width: 32px;
      border-radius: 50%;
      object-fit: cover;
      background-color: #e2e8f0;
    }

    #spa-page-chat-ui .reply-preview-icon-placeholder {
      width: 32px;
      height: 32px;
      min-width: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--reborn-primary), #0056cc);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 600;
    }

    #spa-page-chat-ui .reply-preview-content {
      flex: 1;
      min-width: 0;
    }

    #spa-page-chat-ui .reply-preview-user {
      font-size: 0.75rem;
      font-weight: 600;
      color: #718096;
      margin-bottom: 2px;
    }

    #spa-page-chat-ui .reply-preview-text {
      font-size: 0.85rem;
      color: #4a5568;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #spa-page-chat-ui .reply-preview-close {
      width: 24px;
      height: 24px;
      min-width: 24px;
      border: none;
      background: #cbd5e0;
      border-radius: 50%;
      color: #4a5568;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    #spa-page-chat-ui .reply-preview-close:hover {
      background: #a0aec0;
    }

    /* メッセージバブル内のリプライ表示（LINE風） */
    #spa-page-chat-ui .message-reply-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 0 8px 0;
      margin: 0 -12px 8px -12px;
      padding-left: 12px;
      padding-right: 12px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    #spa-page-chat-ui .message-item-mine .message-reply-header {
      border-bottom-color: rgba(255, 255, 255, 0.2);
    }

    #spa-page-chat-ui .reply-header-icon {
      width: 20px;
      height: 20px;
      min-width: 20px;
      border-radius: 50%;
      object-fit: cover;
    }

    #spa-page-chat-ui .reply-header-icon-placeholder {
      width: 20px;
      height: 20px;
      min-width: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, #718096, #4a5568);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      font-weight: 600;
    }

    #spa-page-chat-ui .reply-header-content {
      flex: 1;
      min-width: 0;
    }

    #spa-page-chat-ui .reply-header-user {
      font-size: 0.7rem;
      font-weight: 600;
      color: #1a202c;
    }

    #spa-page-chat-ui .message-item-mine .reply-header-user {
      color: rgba(255, 255, 255, 1);
    }

    #spa-page-chat-ui .reply-header-text {
      font-size: 0.75rem;
      color: #a0aec0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }

    #spa-page-chat-ui .message-item-mine .reply-header-text {
      color: rgba(255, 255, 255, 0.7);
    }

    /* リプライヘッダーのクリック可能スタイル */
    #spa-page-chat-ui .message-reply-header {
      cursor: pointer;
    }

    #spa-page-chat-ui .message-reply-header:active {
      opacity: 0.7;
    }

    /* メッセージ揺れアニメーション（リプライジャンプ時） */
    @keyframes message-shake {
      0%, 100% { margin-left: 0; margin-right: 0; }
      10%, 30%, 50%, 70%, 90% { margin-left: -4px; margin-right: 4px; }
      20%, 40%, 60%, 80% { margin-left: 4px; margin-right: -4px; }
    }

    #spa-page-chat-ui .message-item.highlight-shake {
      animation: message-shake 0.5s ease-in-out;
    }

    /* textarea（シンプルな入力欄） */
    #spa-page-chat-ui .message-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #cbd5e0;
      border-radius: 20px;
      font-size: 1rem;
      min-height: 44px;
      max-height: 120px;
      background-color: #f5f5f5;
      color: #1a202c;
      caret-color: var(--reborn-primary);
      resize: none;
      overflow-y: auto;
      /* iOS対策 */
      -webkit-appearance: none;
      appearance: none;
      font-family: inherit;
      line-height: 1.4;
    }

    #spa-page-chat-ui .message-input:focus {
      outline: none;
      border-color: var(--reborn-primary);
    }

    #spa-page-chat-ui .message-input::placeholder {
      color: #9ca3af;
    }

    /* メンション候補リスト */
    #spa-page-chat-ui .mention-suggestions {
      display: none;
      position: absolute;
      bottom: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      margin-bottom: 8px;
    }
    #spa-page-chat-ui .mention-suggestions.show {
      display: block;
    }
    #spa-page-chat-ui .mention-suggestion-item {
      display: flex;
      align-items: center;
      padding: 10px 14px;
      cursor: pointer;
      transition: background-color 0.15s;
    }
    #spa-page-chat-ui .mention-suggestion-item:hover,
    #spa-page-chat-ui .mention-suggestion-item.selected {
      background-color: #f3f4f6;
    }
    #spa-page-chat-ui .mention-suggestion-item:first-child {
      border-radius: 12px 12px 0 0;
    }
    #spa-page-chat-ui .mention-suggestion-item:last-child {
      border-radius: 0 0 12px 12px;
    }
    #spa-page-chat-ui .mention-suggestion-item:only-child {
      border-radius: 12px;
    }
    #spa-page-chat-ui .mention-suggestion-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      margin-right: 10px;
      object-fit: cover;
    }
    #spa-page-chat-ui .mention-suggestion-icon-placeholder {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
      margin-right: 10px;
    }
    #spa-page-chat-ui .mention-all-icon {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
      font-size: 18px;
    }
    #spa-page-chat-ui .mention-suggestion-name {
      font-size: 15px;
      color: #1f2937;
    }

    /* メンションハイライト（メッセージ表示時） */
    #spa-page-chat-ui .mention-highlight {
      color: var(--reborn-primary);
      font-weight: 500;
    }
    #spa-page-chat-ui .message-item-mine .mention-highlight {
      color: #1565c0; /* 濃い青（LINE風） */
      font-weight: 600;
    }

    #spa-page-chat-ui .send-button {
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      color: white;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      font-size: 1.25rem;
      cursor: pointer;
      transition: transform 0.2s;
      flex-shrink: 0;
      align-self: center; /* 入力欄と垂直中央揃え */
    }
    #spa-page-chat-ui .send-button:hover {
      transform: scale(1.05);
    }
    #spa-page-chat-ui .send-button:active {
      transform: scale(0.95);
    }
    #spa-page-chat-ui .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ユーザー名選択（GAS版のみ） */
    #spa-page-chat-ui #userSelectContainer {
      margin-bottom: 8px;
    }

    /* 選択削除モード（LINE風） */
    #spa-page-chat-ui .selection-mode-bar {
      display: none;
      background-color: #ffffff;
      padding: 12px 16px;
      border-bottom: 1px solid #e5e7eb;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    #spa-page-chat-ui .selection-mode-bar.active {
      display: flex;
    }
    #spa-page-chat-ui .selection-mode-info {
      font-size: 0.9rem;
      color: #2d3748;
      font-weight: 500;
    }
    #spa-page-chat-ui .selection-mode-buttons {
      display: flex;
      gap: 12px;
    }
    #spa-page-chat-ui .selection-mode-buttons button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
      font-weight: 500;
    }
    #spa-page-chat-ui .selection-mode-buttons button:active {
      transform: scale(0.95);
    }
    #spa-page-chat-ui .btn-delete-selected {
      background-color: #ef4444;
      color: white;
    }
    #spa-page-chat-ui .btn-delete-selected:hover {
      background-color: #dc2626;
    }
    #spa-page-chat-ui .btn-cancel-selection {
      background-color: #f3f4f6;
      color: #4b5563;
    }
    #spa-page-chat-ui .btn-cancel-selection:hover {
      background-color: #e5e7eb;
    }
    #spa-page-chat-ui .message-checkbox {
      display: none;
      margin-right: 12px;
      width: 22px;
      height: 22px;
      cursor: pointer;
      flex-shrink: 0;
      align-self: center;
      accent-color: var(--reborn-primary);
      order: -1; /* 常に左端に配置 */
    }
    #spa-page-chat-ui .selection-mode .message-checkbox {
      display: block;
    }

    /* チェックボックスを左端に配置するためにcontentのorderを調整 */
    #spa-page-chat-ui .message-item .message-content {
      order: 0;
    }
    #spa-page-chat-ui .toggle-selection-btn {
      background-color: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.4);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      margin-left: 12px;
    }
    #spa-page-chat-ui .toggle-selection-btn:hover {
      background-color: rgba(255,255,255,0.3);
    }

    /* 長押しメニュー（LINE風グリッドポップアップ） */
    #spa-page-chat-ui #contextMenu {
      position: absolute;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.2);
      z-index: 3000;
      display: none;
      opacity: 0;
      transform: scale(0.9);
      transition: opacity 0.15s ease, transform 0.15s ease;
      padding: 0;
      min-width: 200px;
      overflow: hidden;
    }
    #spa-page-chat-ui #contextMenu.active {
      display: block;
      opacity: 1;
      transform: scale(1);
    }
    #spa-page-chat-ui .context-menu-items {
      display: flex;
      flex-wrap: nowrap;
    }
    #spa-page-chat-ui .context-menu-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px 4px;
      background: transparent;
      cursor: pointer;
      transition: background 0.15s;
      border: none;
      border-right: 1px solid #e5e7eb;
      border-radius: 0;
      font-family: inherit;
      font-size: 10px;
      color: #6b7280;
      white-space: nowrap;
      min-width: 52px;
      flex: 1;
      aspect-ratio: 1 / 1;
    }
    #spa-page-chat-ui .context-menu-item:last-child {
      border-right: none;
    }
    #spa-page-chat-ui .context-menu-item i {
      font-size: 20px;
      color: #374151;
      margin-bottom: 1px;
    }
    #spa-page-chat-ui .context-menu-item:active {
      background: #f3f4f6;
    }
    #spa-page-chat-ui .context-menu-item.danger {
      color: #ef4444;
    }
    #spa-page-chat-ui .context-menu-item.danger i {
      color: #ef4444;
    }
    #spa-page-chat-ui #contextMenuOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.1);
      z-index: 2999;
      display: none;
    }
    #spa-page-chat-ui #contextMenuOverlay.active {
      display: block;
    }

    /* 転送先選択モーダル */
    #spa-page-chat-ui .forward-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 4000;
      display: none;
    }
    #spa-page-chat-ui .forward-modal-overlay.active {
      display: block;
    }
    #spa-page-chat-ui .forward-modal {
      position: fixed;
      bottom: -100%;
      left: 0;
      right: 0;
      max-height: 70vh;
      background: white;
      border-radius: 16px 16px 0 0;
      z-index: 4001;
      transition: bottom 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    #spa-page-chat-ui .forward-modal.active {
      bottom: 0;
    }
    #spa-page-chat-ui .forward-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      font-weight: 600;
      font-size: 16px;
    }
    #spa-page-chat-ui .forward-modal-close {
      background: none;
      border: none;
      padding: 8px;
      cursor: pointer;
      color: #6b7280;
    }
    #spa-page-chat-ui .forward-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }
    #spa-page-chat-ui .forward-room-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.15s;
    }
    #spa-page-chat-ui .forward-room-item:hover {
      background: #f3f4f6;
    }
    #spa-page-chat-ui .forward-room-item:active {
      background: #e5e7eb;
    }
    #spa-page-chat-ui .forward-room-icon {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      color: white;
      font-size: 18px;
    }
    #spa-page-chat-ui .forward-room-info {
      flex: 1;
    }
    #spa-page-chat-ui .forward-room-name {
      font-weight: 500;
      font-size: 15px;
      color: #1f2937;
    }
    #spa-page-chat-ui .forward-room-members {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 2px;
    }
    #spa-page-chat-ui .forward-loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 32px;
      color: #9ca3af;
    }
    #spa-page-chat-ui .forward-loading .spin {
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* ノート一覧モーダル */
    #spa-page-chat-ui .note-list-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 4000;
      display: none;
    }
    #spa-page-chat-ui .note-list-modal-overlay.active {
      display: block;
    }
    #spa-page-chat-ui .note-list-modal {
      position: fixed;
      bottom: -100%;
      left: 0;
      right: 0;
      max-height: 70vh;
      background: white;
      border-radius: 16px 16px 0 0;
      z-index: 4001;
      transition: bottom 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    #spa-page-chat-ui .note-list-modal.active {
      bottom: 0;
    }
    #spa-page-chat-ui .note-list-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      font-weight: 600;
      font-size: 16px;
    }
    #spa-page-chat-ui .note-list-modal-close {
      background: none;
      border: none;
      padding: 8px;
      cursor: pointer;
      color: #6b7280;
    }
    #spa-page-chat-ui .note-list-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }
    #spa-page-chat-ui .note-list-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.15s;
      gap: 12px;
    }
    #spa-page-chat-ui .note-list-item:hover {
      background: #f3f4f6;
    }
    #spa-page-chat-ui .note-list-item:active {
      background: #e5e7eb;
    }
    #spa-page-chat-ui .note-list-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #64748b;
      font-size: 20px;
      flex-shrink: 0;
    }
    #spa-page-chat-ui .note-list-info {
      flex: 1;
      min-width: 0;
    }
    #spa-page-chat-ui .note-list-title {
      font-weight: 500;
      font-size: 15px;
      color: #1f2937;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #spa-page-chat-ui .note-list-meta {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 2px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #spa-page-chat-ui .note-list-sender {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    #spa-page-chat-ui .note-list-sender-avatar {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    #spa-page-chat-ui .note-list-sender-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #spa-page-chat-ui .note-list-sender-avatar i {
      font-size: 10px;
      color: #9ca3af;
    }
    #spa-page-chat-ui .note-list-arrow {
      color: #9ca3af;
      font-size: 18px;
    }
    #spa-page-chat-ui .note-list-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 48px 24px;
      color: #9ca3af;
      text-align: center;
    }
    #spa-page-chat-ui .note-list-empty i {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    #spa-page-chat-ui .note-list-empty p {
      font-size: 14px;
      margin: 0;
    }
    #spa-page-chat-ui .note-list-loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 32px;
      color: #9ca3af;
    }
    #spa-page-chat-ui .note-list-loading .spin {
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    /* Keep選択モーダル */
    #spa-page-chat-ui .keep-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 4000;
      display: none;
    }
    #spa-page-chat-ui .keep-modal-overlay.active {
      display: block;
    }
    #spa-page-chat-ui .keep-modal {
      position: fixed;
      bottom: -100%;
      left: 0;
      right: 0;
      max-height: 70vh;
      background: white;
      border-radius: 16px 16px 0 0;
      z-index: 4001;
      transition: bottom 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    #spa-page-chat-ui .keep-modal.active {
      bottom: 0;
    }
    #spa-page-chat-ui .keep-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      font-weight: 600;
      font-size: 16px;
    }
    #spa-page-chat-ui .keep-modal-close {
      background: none;
      border: none;
      padding: 8px;
      cursor: pointer;
      color: #6b7280;
    }
    #spa-page-chat-ui .keep-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
      max-height: calc(70vh - 60px);
    }
    #spa-page-chat-ui .keep-item {
      display: flex;
      align-items: flex-start;
      padding: 12px 16px;
      cursor: pointer;
      transition: background-color 0.2s;
      border-bottom: 1px solid #f3f4f6;
    }
    #spa-page-chat-ui .keep-item:hover {
      background: #f9fafb;
    }
    #spa-page-chat-ui .keep-item:active {
      background: #f3f4f6;
    }
    #spa-page-chat-ui .keep-item-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      color: white;
      font-size: 16px;
      flex-shrink: 0;
    }
    #spa-page-chat-ui .keep-item-content {
      flex: 1;
      min-width: 0;
    }
    #spa-page-chat-ui .keep-item-text {
      font-size: 14px;
      color: #1f2937;
      line-height: 1.4;
      word-break: break-word;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    #spa-page-chat-ui .keep-item-date {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }
    #spa-page-chat-ui .keep-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 48px 24px;
      color: #9ca3af;
    }
    #spa-page-chat-ui .keep-empty i {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    #spa-page-chat-ui .keep-empty-text {
      font-size: 14px;
      text-align: center;
    }
    #spa-page-chat-ui .keep-loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 32px;
      color: #9ca3af;
    }

    /* アコーディオン収納用のトランジション */
    #spa-page-chat-ui .collapsible-button {
      transition: width 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
      overflow: hidden;
    }
    #spa-page-chat-ui .collapsible-button.collapsed {
      width: 0;
      opacity: 0;
      margin: 0;
      padding: 0;
      border: none;
    }
    #spa-page-chat-ui .expand-button {
      transition: opacity 0.3s ease;
    }
    #spa-page-chat-ui .expand-button svg {
      width: 32px;
      height: 32px;
    }

    /* 画像ビューアー（LINE風） */
    #spa-page-chat-ui .image-viewer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.95);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    #spa-page-chat-ui .image-viewer.active {
      opacity: 1;
    }
    #spa-page-chat-ui .image-viewer-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
      z-index: 10000;
    }
    #spa-page-chat-ui .image-viewer-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    #spa-page-chat-ui .image-viewer-close svg {
      color: white;
    }
    #spa-page-chat-ui #imageViewerImg {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
      border-radius: 0;
    }

    /* ダウンロードボタン（LINE風） */
    #spa-page-chat-ui .image-viewer-download {
      position: absolute;
      bottom: 24px;
      right: 24px;
      background: rgba(0, 0, 0, 0.6);
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
      z-index: 10000;
    }
    #spa-page-chat-ui .image-viewer-download:active {
      background: rgba(0, 0, 0, 0.8);
    }
    #spa-page-chat-ui .image-viewer-download svg {
      color: white;
    }

    /* メンバーアイコン行（グループチャット用）- オーバーレイ表示 */
    #spa-page-chat-ui .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: #ffffff;
      border-bottom: 1px solid #f0f0f0;
      padding-top: env(safe-area-inset-top, 0px); /* iOSノッチ対応 */
    }
    #spa-page-chat-ui .header .back-button {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 20px;
      -webkit-tap-highlight-color: transparent;
      outline: none;
    }
    #spa-page-chat-ui .member-icons-bar {
      display: none;
      background: white;
      padding: 2px 16px;
      align-items: center;
      gap: 8px;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      z-index: 999;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #spa-page-chat-ui .member-icons-bar.show {
      display: flex;
    }
    #spa-page-chat-ui .member-icons-bar .member-icons {
      display: flex;
      flex: 1;
      gap: 6px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    #spa-page-chat-ui .member-icons-bar .member-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      flex-shrink: 0;
      object-fit: cover;
      border: 2px solid white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    #spa-page-chat-ui .member-icons-bar .member-icon-placeholder {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
      flex-shrink: 0;
      border: 2px solid white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    #spa-page-chat-ui .member-icons-bar .member-more {
      color: #6b7280;
      font-size: 26px;
      padding: 0 4px;
      cursor: pointer;
    }

    /* メンバー管理モーダル */
    #spa-page-chat-ui .member-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 5000;
      display: none;
    }
    #spa-page-chat-ui .member-modal-overlay.active {
      display: block;
    }
    #spa-page-chat-ui .member-modal {
      position: fixed;
      top: 0;
      right: -100%;
      width: 100%;
      height: 100%;
      background: white;
      z-index: 5001;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    #spa-page-chat-ui .member-modal.active {
      right: 0;
    }
    #spa-page-chat-ui .member-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 16px;
      border-bottom: 1px solid #e5e7eb;
      background: white;
    }
    #spa-page-chat-ui .member-modal-header .back-btn {
      position: static;
      transform: none;
      background: none;
      border: none;
      font-size: 20px;
      color: #374151;
      cursor: pointer;
      padding: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #spa-page-chat-ui .member-modal-header .title {
      font-weight: 600;
      font-size: 17px;
      color: #1f2937;
    }
    #spa-page-chat-ui .member-modal-header .edit-btn {
      background: none;
      border: none;
      font-size: 15px;
      color: var(--reborn-primary);
      cursor: pointer;
      padding: 4px 8px;
    }
    #spa-page-chat-ui .member-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 0;
    }
    #spa-page-chat-ui .member-count {
      padding: 12px 16px;
      font-size: 13px;
      color: #6b7280;
      background: white;
      border-bottom: 1px solid #e5e7eb;
    }
    #spa-page-chat-ui .member-invite-btn {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      border: none;
      background: white;
      width: 100%;
      cursor: pointer;
      border-bottom: 1px solid #e5e7eb;
    }
    #spa-page-chat-ui .member-invite-btn:active {
      background: #f3f4f6;
    }
    #spa-page-chat-ui .member-invite-btn .icon {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      font-size: 22px;
      color: #374151;
    }
    #spa-page-chat-ui .member-invite-btn .text {
      font-size: 15px;
      color: #1f2937;
    }
    #spa-page-chat-ui .member-list-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid #f3f4f6;
    }
    #spa-page-chat-ui .member-list-item .avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      margin-right: 12px;
      object-fit: cover;
    }
    #spa-page-chat-ui .member-list-item .avatar-placeholder {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 18px;
      margin-right: 12px;
    }
    #spa-page-chat-ui .member-list-item .info {
      flex: 1;
    }
    #spa-page-chat-ui .member-list-item .name {
      font-size: 15px;
      font-weight: 500;
      color: #1f2937;
    }
    #spa-page-chat-ui .member-list-item .email {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 2px;
    }
    #spa-page-chat-ui .member-list-item .delete-btn {
      display: none;
      background: #ef4444;
      border: none;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      font-size: 16px;
      cursor: pointer;
    }
    #spa-page-chat-ui .member-list-item.edit-mode .delete-btn {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* 招待モーダル */
    #spa-page-chat-ui .invite-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 6000;
      display: none;
    }
    #spa-page-chat-ui .invite-modal-overlay.active {
      display: block;
    }
    #spa-page-chat-ui .invite-modal {
      position: fixed;
      bottom: -100%;
      left: 0;
      right: 0;
      max-height: 80vh;
      background: white;
      border-radius: 16px 16px 0 0;
      z-index: 6001;
      transition: bottom 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    #spa-page-chat-ui .invite-modal.active {
      bottom: 0;
    }
    #spa-page-chat-ui .invite-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
    }
    #spa-page-chat-ui .invite-modal-header .title {
      font-weight: 600;
      font-size: 16px;
    }
    #spa-page-chat-ui .invite-modal-header .close-btn {
      background: none;
      border: none;
      font-size: 20px;
      color: #6b7280;
      cursor: pointer;
    }
    #spa-page-chat-ui .invite-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }
    #spa-page-chat-ui .invite-user-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      cursor: pointer;
    }
    #spa-page-chat-ui .invite-user-item:active {
      background: #f3f4f6;
    }
    #spa-page-chat-ui .invite-user-item.disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    #spa-page-chat-ui .invite-user-item .avatar-placeholder {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 18px;
      margin-right: 12px;
    }
    #spa-page-chat-ui .invite-user-item .info {
      flex: 1;
    }
    #spa-page-chat-ui .invite-user-item .name {
      font-size: 15px;
      font-weight: 500;
      color: #1f2937;
    }
    #spa-page-chat-ui .invite-user-item .already-member {
      font-size: 12px;
      color: #9ca3af;
    }


    /* ========== 通話モーダル用CSS ========== */
#spa-page-chat-ui .call-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
}

#spa-page-chat-ui .call-modal-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  height: 100%;
  padding: 60px 20px 40px;
  box-sizing: border-box;
}

#spa-page-chat-ui .call-user-info {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-top: 40px;
}

#spa-page-chat-ui .call-user-avatar {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: rgba(255,255,255,0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 24px;
}

#spa-page-chat-ui .call-user-avatar i {
  font-size: 60px;
  color: rgba(255,255,255,0.7);
}

#spa-page-chat-ui .call-user-avatar img {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  object-fit: cover;
}

#spa-page-chat-ui .call-user-name {
  font-size: 24px;
  font-weight: 600;
  color: white;
  margin-bottom: 8px;
}

#spa-page-chat-ui .call-status {
  font-size: 16px;
  color: rgba(255,255,255,0.7);
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 0.7; }
  50% { opacity: 1; }
}

#spa-page-chat-ui .call-timer {
  font-size: 20px;
  color: white;
  font-weight: 500;
  margin-top: 8px;
}

#spa-page-chat-ui .call-controls {
  display: flex;
  gap: 32px;
  margin-bottom: 40px;
}

#spa-page-chat-ui .call-control-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  background: none;
  border: none;
  cursor: pointer;
  padding: 12px;
}

#spa-page-chat-ui .call-control-btn i {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: rgba(255,255,255,0.15);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
  transition: all 0.2s;
}

#spa-page-chat-ui .call-control-btn span {
  font-size: 12px;
  color: rgba(255,255,255,0.8);
}

#spa-page-chat-ui .call-control-btn:active i {
  transform: scale(0.95);
}

#spa-page-chat-ui .call-control-btn.active i {
  background: white;
  color: #1a1a2e;
}

#spa-page-chat-ui .call-end-btn i {
  background: #e53935 !important;
  color: white !important;
}

#spa-page-chat-ui .call-end-btn:active i {
  background: #c62828 !important;
}

/* 着信モーダル用CSS */
#spa-page-chat-ui .incoming-pulse {
  animation: incoming-ring 1s ease-in-out infinite;
}

@keyframes incoming-ring {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

#spa-page-chat-ui .incoming-controls {
  gap: 60px !important;
}

#spa-page-chat-ui .call-decline-btn i {
  background: #e53935 !important;
  color: white !important;
}

#spa-page-chat-ui .call-accept-btn i {
  background: #4caf50 !important;
  color: white !important;
}

#spa-page-chat-ui .call-accept-btn:active i {
  background: #388e3c !important;
}

#spa-page-chat-ui .call-decline-btn:active i {
  background: #c62828 !important;
}

  </style>

  <!-- Chat UI HTML Content -->
  <!-- 統一ヘッダー -->
  <div class="header">
    <!-- 通常モード -->
    <div class="header-content" id="headerNormal">
      <button class="back-button" id="back-button">
        <i class="bi bi-chevron-left"></i><span class="back-unread-count" id="backUnreadCount"></span>
      </button>
      <div class="header-title" id="headerTitle" style="cursor: pointer;">
        <i class="bi bi-chat-dots" id="headerRoomIcon"></i>
        <span id="headerRoomName">チャット</span>
      </div>
      <div class="header-right-buttons">
        <button class="search-button" id="searchButton" onclick="openSearchMode()">
          <i class="bi bi-search"></i>
        </button>
        <button class="call-button" id="callButton" onclick="showCallPreparing()">
          <i class="bi bi-telephone"></i>
        </button>
        <button class="settings-button" id="chatSettingsButton" onclick="toggleChatSettings(event)">
          <i class="bi bi-list"></i>
        </button>
      </div>
      <!-- チャット設定ドロップダウン -->
      <div class="chat-settings-dropdown" id="chatSettingsDropdown">
        <button class="chat-settings-item" id="blockUserBtn" onclick="toggleBlockUser()">
          <i class="bi bi-slash-circle"></i>
          <span id="blockUserText">ブロックする</span>
        </button>
        <button class="chat-settings-item" id="muteRoomBtn" onclick="toggleMuteRoom()">
          <i class="bi bi-bell-slash"></i>
          <span id="muteRoomText">通知をオフ</span>
        </button>
        <button class="chat-settings-item" onclick="openNoteListModal()">
          <i class="bi bi-journal-text"></i>
          <span>ノート一覧</span>
        </button>
        <div class="chat-settings-divider"></div>
        <button class="chat-settings-item danger" id="leaveRoomBtn" onclick="confirmLeaveRoom()">
          <i class="bi bi-box-arrow-right"></i>
          <span>退出する</span>
        </button>
      </div>
    </div>
    <!-- 検索モード -->
    <div class="header-content header-search-mode" id="headerSearch" style="display: none;">
      <button class="back-button" onclick="goBack()">
        <i class="bi bi-chevron-left"></i>
      </button>
      <div class="search-input-container">
        <input type="text" id="searchInput" class="search-input" placeholder="メッセージを検索..." oninput="searchMessages()">
        <button class="search-clear-btn" id="searchClearBtn" onclick="clearSearch()" style="display: none;">
          <i class="bi bi-x"></i>
        </button>
      </div>
      <div class="search-nav-buttons" id="searchNavButtons" style="display: none;">
        <span class="search-count" id="searchCount">0/0</span>
        <button class="search-nav-btn" onclick="navigateSearch('prev')"><i class="bi bi-chevron-up"></i></button>
        <button class="search-nav-btn" onclick="navigateSearch('next')"><i class="bi bi-chevron-down"></i></button>
      </div>
      <button class="search-close-btn" onclick="closeSearchMode()" title="検索を閉じる">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <!-- メンバーアイコン行（グループチャットのみ）- ヘッダー内に配置 -->
    <div class="member-icons-bar" id="memberIconsBar">
      <div class="member-icons" id="memberIcons"></div>
      <span class="member-more" id="memberMoreBtn">›</span>
    </div>
  </div>

  <!-- チャンネル情報バー -->
  <div style="background: #f8f9fa; padding: 8px 16px; border-bottom: 1px solid #e5e7eb; display: none;">
    <!-- 選択削除ボタンは削除（長押しで選択モード開始） -->
  </div>

    <!-- GAS版：ユーザー名選択ドロップダウン -->
    <div id="userSelectContainer" style="display: none; margin-top: 8px;">
      <label style="font-size: 12px; margin-right: 4px;">送信者:</label>
      <select id="userSelect" style="background: white; border: 1px solid #d1d5db; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
        <option value="">選択してください</option>
      </select>
    </div>

    <!-- PWA版：ユーザー名入力 -->
    <div id="userNameInputContainer" style="display: none; margin-top: 8px;">
      <label style="font-size: 12px; margin-right: 4px;">あなたの名前:</label>
      <input type="text" id="userNameInput" placeholder="名前を入力" style="background: white; border: 1px solid #d1d5db; padding: 4px 8px; border-radius: 4px; font-size: 12px; width: 150px;">
      <button id="saveUserNameBtn" style="background: white; border: 1px solid #d1d5db; padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-left: 4px;">保存</button>
    </div>
  </div>

  <!-- Keep選択モーダル -->
  <div class="keep-modal-overlay" id="keepModalOverlay" onclick="closeKeepModal(event)">
    <div class="keep-modal" id="keepModal">
      <div class="keep-modal-header">
        <span><i class="bi bi-bookmark" style="color: #f59e0b; margin-right: 8px;"></i>Keepから送信</span>
        <button class="keep-modal-close" onclick="closeKeepModal()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      <div class="keep-modal-body" id="keepModalBody">
        <div class="keep-loading">
          <i class="bi bi-arrow-repeat spin"></i>
          読み込み中...
        </div>
      </div>
    </div>
  </div>

  <!-- メンバー管理モーダル -->
  <div class="member-modal-overlay" id="memberModalOverlay"></div>
  <div class="member-modal" id="memberModal">
    <div class="member-modal-header">
      <button class="back-btn" id="memberModalBackBtn"><i class="bi bi-chevron-left"></i></button>
      <span class="title">メンバー</span>
      <button class="edit-btn" id="memberEditBtn">編集</button>
    </div>
    <div class="member-modal-body">
      <div class="member-count" id="memberCount">メンバー 0</div>
      <button class="member-invite-btn" id="memberInviteBtn">
        <span class="icon">+</span>
        <span class="text">メンバーを招待</span>
      </button>
      <div id="memberList"></div>
    </div>
  </div>

  <!-- 招待モーダル -->
  <div class="invite-modal-overlay" id="inviteModalOverlay"></div>
  <div class="invite-modal" id="inviteModal">
    <div class="invite-modal-header">
      <span class="title">メンバーを招待</span>
      <button class="close-btn" id="inviteModalCloseBtn">×</button>
    </div>
    <div class="invite-modal-body" id="inviteUserList"></div>
  </div>

  <!-- プロフィールポップアップ -->
  <div class="profile-popup-overlay" id="profilePopupOverlay" onclick="closeProfilePopup(event)">
    <div class="profile-popup" onclick="event.stopPropagation()">
      <div class="profile-popup-header" id="profilePopupHeader">
        <button class="profile-popup-close" onclick="closeProfilePopup(event)">
          <i class="bi bi-x"></i>
        </button>
        <div id="profilePopupAvatar"></div>
        <div class="profile-popup-name" id="profilePopupName"></div>
        <div class="profile-popup-status" id="profilePopupStatus">メンバー</div>
      </div>
      <div class="profile-popup-actions">
        <button class="profile-popup-action" id="profilePopupChatBtn">
          <div class="profile-popup-action-icon chat">
            <i class="bi bi-chat-dots-fill"></i>
          </div>
          <span class="profile-popup-action-label">トーク</span>
        </button>
        <button class="profile-popup-action" id="profilePopupCallBtn">
          <div class="profile-popup-action-icon call">
            <i class="bi bi-telephone-fill"></i>
          </div>
          <span class="profile-popup-action-label">通話</span>
        </button>
      </div>
    </div>
  </div>

  <!-- 選択削除モードバー -->
  <div class="selection-mode-bar" id="selectionModeBar">
    <div class="selection-mode-info">
      <span id="selectedCount">0</span> 件選択中
    </div>
    <div class="selection-mode-buttons">
      <button class="btn-delete-selected" onclick="deleteSelectedMessages()">削除</button>
      <button class="btn-cancel-selection" onclick="toggleSelectionMode()">キャンセル</button>
    </div>
  </div>

  <!-- メッセージエリア（固定日付バッジ付き） -->
  <div class="messages-wrapper" style="position: relative; flex: 1; display: flex; flex-direction: column; overflow: hidden;">
    <div class="sticky-date-badge hidden" id="stickyDateBadge">今日</div>
    <div class="messages-container" id="messagesContainer"></div>
  </div>

  <!-- 画像プレビューエリア（複数対応） -->
  <div class="image-preview-container" id="imagePreviewContainer" style="display: none;">
    <div class="image-preview-list" id="imagePreviewList">
      <!-- 選択された画像がここに追加される -->
    </div>
    <span class="image-preview-count" id="imagePreviewCount" style="display: none;">0枚</span>
  </div>

  <!-- ブロック中バナー -->
  <div class="blocked-banner" id="blockedBanner" style="display: none;">
    <i class="bi bi-slash-circle"></i>
    <span>ブロック中のため、メッセージを送信できません</span>
  </div>

  <div class="input-container">
    <!-- メンション候補リスト -->
    <div class="mention-suggestions" id="mentionSuggestions"></div>

    <!-- 添付メニュー（+ボタンで展開） -->
    <div class="attachment-menu" id="attachmentMenu" style="display: none;">
      <button class="attachment-menu-item" onclick="openKeepSelectModal()">
        <i class="bi bi-bookmark"></i>
        <span>Keepから送信</span>
      </button>
      <button class="attachment-menu-item" onclick="openMyNoteSelectModal()">
        <i class="bi bi-journal-text"></i>
        <span>ノートを送信</span>
      </button>
      <button class="attachment-menu-item" onclick="startVoiceRecording()">
        <i class="bi bi-mic"></i>
        <span>音声メッセージ</span>
      </button>
    </div>

    <!-- 録音中オーバーレイ -->
    <div class="voice-recording-overlay" id="voiceRecordingOverlay" style="display: none;">
      <div class="voice-recording-content">
        <div class="voice-recording-indicator">
          <div class="voice-recording-dot"></div>
          <span class="voice-recording-time" id="voiceRecordingTime">0:00</span>
        </div>
        <p class="voice-recording-text">録音中...</p>
        <div class="voice-recording-buttons">
          <button class="voice-cancel-btn" onclick="cancelVoiceRecording()">
            <i class="bi bi-x-lg"></i>
            <span>キャンセル</span>
          </button>
          <button class="voice-send-btn" onclick="sendVoiceMessage()">
            <i class="bi bi-send-fill"></i>
            <span>送信</span>
          </button>
        </div>
      </div>
    </div>

    <div class="input-wrapper">
      <!-- 展開ボタン（収納時に表示） -->
      <button class="action-button expand-button" id="expandButton" style="display: none;">
        <i class="bi bi-chevron-right"></i>
      </button>

      <!-- アクションボタン群 -->
      <button class="action-button collapsible-button" id="toggleMenuBtn" onclick="toggleAttachmentMenu()" title="メニュー">
        <i class="bi bi-plus-lg"></i>
      </button>

      <button class="action-button collapsible-button" onclick="openCamera()" title="カメラ">
        <i class="bi bi-camera"></i>
      </button>

      <button class="action-button collapsible-button" onclick="selectImage()" title="画像">
        <i class="bi bi-image"></i>
      </button>

      <div class="message-input-wrapper">
        <!-- リプライプレビュー（LINE風） -->
        <div id="replyPreview" class="reply-preview">
          <div id="replyPreviewIcon"></div>
          <div class="reply-preview-content">
            <div id="replyPreviewUser" class="reply-preview-user"></div>
            <div id="replyPreviewText" class="reply-preview-text"></div>
          </div>
          <button class="reply-preview-close" onclick="cancelReply()">✕</button>
        </div>
        <!-- メンションタグ表示エリア -->
        <div id="mentionTags" class="mention-tags"></div>
        <textarea
          id="messageInput"
          class="message-input"
          placeholder="メッセージを入力..."
          inputmode="text"
          autocapitalize="off"
          autocomplete="off"
          autocorrect="off"
          spellcheck="false"
          rows="1"></textarea>
      </div>

      <button class="send-button" id="sendButton" onclick="sendMessage()" disabled>
        <i class="bi bi-send-fill"></i>
      </button>
    </div>

    <!-- 隠しファイル入力 -->
    <input type="file" id="imageInput" accept="image/*" multiple style="display: none;" onchange="handleImageSelect(event)">
    <input type="file" id="fileInput" accept="*/*" style="display: none;" onchange="handleFileSelect(event)">
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" onchange="handleCameraCapture(event)">
  </div>

  <!-- 長押しメニュー（LINEライクなポップアップ） -->
  <div id="contextMenuOverlay" onclick="closeContextMenu()"></div>
  <div id="contextMenu">
    <div class="context-menu-items">
      <button class="context-menu-item" id="contextMenuCopy">
        <i class="bi bi-clipboard"></i>
        <span>コピー</span>
      </button>
      <button class="context-menu-item" id="contextMenuReply">
        <i class="bi bi-reply"></i>
        <span>リプライ</span>
      </button>
      <button class="context-menu-item" id="contextMenuForward">
        <i class="bi bi-box-arrow-up-right"></i>
        <span>転送</span>
      </button>
      <button class="context-menu-item" id="contextMenuKeep">
        <i class="bi bi-bookmark"></i>
        <span>Keep</span>
      </button>
      <button class="context-menu-item" id="contextMenuDelete">
        <i class="bi bi-trash"></i>
        <span>削除</span>
      </button>
      <button class="context-menu-item danger" id="contextMenuUnsend" style="display: none;">
        <i class="bi bi-arrow-counterclockwise"></i>
        <span>送信取消</span>
      </button>
    </div>
  </div>

  <!-- 転送先選択モーダル -->
  <div id="forwardModalOverlay" class="forward-modal-overlay" onclick="closeForwardModal()"></div>
  <div id="forwardModal" class="forward-modal">
    <div class="forward-modal-header">
      <span>転送先を選択</span>
      <button class="forward-modal-close" onclick="closeForwardModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="forward-modal-body" id="forwardRoomList">
      <!-- ルーム一覧がここに動的に追加される -->
    </div>
  </div>

  <!-- ノート一覧モーダル -->
  <div id="noteListModalOverlay" class="note-list-modal-overlay" onclick="closeNoteListModal()"></div>
  <div id="noteListModal" class="note-list-modal">
    <div class="note-list-modal-header">
      <span>共有ノート一覧</span>
      <button class="note-list-modal-close" onclick="closeNoteListModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="note-list-modal-body" id="noteListContent">
      <!-- ノート一覧がここに動的に追加される -->
    </div>
  </div>

  <!-- 自分のノート選択モーダル -->
  <div id="myNoteSelectModalOverlay" class="note-list-modal-overlay" onclick="closeMyNoteSelectModal()"></div>
  <div id="myNoteSelectModal" class="note-list-modal">
    <div class="note-list-modal-header">
      <span>ノートを選択</span>
      <button class="note-list-modal-close" onclick="closeMyNoteSelectModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="note-list-modal-body" id="myNoteSelectContent">
      <!-- 自分のノート一覧がここに動的に追加される -->
    </div>
  </div>

<!-- 画像ビューアー（LINE風） -->
<div class="image-viewer" id="imageViewer" style="display: none;">
  <button class="image-viewer-close" id="imageViewerClose">
    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="18" y1="6" x2="6" y2="18"></line>
      <line x1="6" y1="6" x2="18" y2="18"></line>
    </svg>
  </button>
  <img id="imageViewerImg" src="" alt="画像">
  <!-- ダウンロードボタン -->
  <button class="image-viewer-download" id="imageViewerDownload">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
      <polyline points="7 10 12 15 17 10"></polyline>
      <line x1="12" y1="15" x2="12" y2="3"></line>
    </svg>
  </button>
</div>

<!-- ========== 通話モーダル（発信側） ========== -->
<div class="call-modal" id="callModal" style="display: none;">
  <div class="call-modal-content">
    <!-- 相手情報 -->
    <div class="call-user-info">
      <div class="call-user-avatar" id="callUserAvatar">
        <i class="bi bi-person-fill"></i>
      </div>
      <div class="call-user-name" id="callUserName">相手の名前</div>
      <div class="call-status" id="callStatus">発信中...</div>
      <div class="call-timer" id="callTimer" style="display: none;">00:00</div>
    </div>

    <!-- 通話コントロール -->
    <div class="call-controls">
      <button class="call-control-btn" id="callMuteBtn" onclick="toggleCallMute()">
        <i class="bi bi-mic-fill" id="callMuteIcon"></i>
        <span>ミュート</span>
      </button>
      <button class="call-control-btn call-end-btn" id="callEndBtn" onclick="endCall()">
        <i class="bi bi-telephone-x-fill"></i>
        <span>終了</span>
      </button>
      <button class="call-control-btn" id="callSpeakerBtn" onclick="toggleCallSpeaker()">
        <i class="bi bi-volume-up-fill" id="callSpeakerIcon"></i>
        <span>スピーカー</span>
      </button>
    </div>
  </div>
</div>

<!-- ========== 着信モーダル ========== -->
<div class="call-modal" id="incomingCallModal" style="display: none;">
  <div class="call-modal-content">
    <!-- 発信者情報 -->
    <div class="call-user-info">
      <div class="call-user-avatar incoming-pulse" id="incomingCallerAvatar">
        <i class="bi bi-telephone-inbound-fill"></i>
      </div>
      <div class="call-user-name" id="incomingCallerName">発信者</div>
      <div class="call-status" id="incomingCallStatus">着信中...</div>
    </div>

    <!-- 着信コントロール（応答/拒否） -->
    <div class="call-controls incoming-controls">
      <button class="call-control-btn call-decline-btn" onclick="declineCall()">
        <i class="bi bi-telephone-x-fill"></i>
        <span>拒否</span>
      </button>
      <button class="call-control-btn call-accept-btn" onclick="acceptCall()">
        <i class="bi bi-telephone-fill"></i>
        <span>応答</span>
      </button>
    </div>
  </div>
</div>


  <script>
    // ========================================
    // SPA Fragment: Chat UI (chat-room)
    // Converted from standalone HTML to SPA fragment
    // No IIFE - global scope as required
    // ========================================

    // === Firebase aliases (from parent SPA globals) ===
    // _cuiDb / _cuiStorage are prefixed to avoid conflicts with local IndexedDB 'db' vars
    // Firestore functions use original names so existing code works without renaming
    var _cuiDb, _cuiStorage;
    var collection, addDoc, query, where, orderBy, limit, onSnapshot, serverTimestamp;
    var doc, updateDoc, getDoc, setDoc, getDocs, arrayUnion, arrayRemove, increment;
    var writeBatch, collectionGroup;
    var ref, uploadBytes, getDownloadURL;

    function _cuiInitFirebaseAliases() {
      _cuiDb = window.firebaseDB || window.db;
      _cuiStorage = window.firebaseStorage;
      collection = window.firestoreCollection;
      addDoc = window.firestoreAddDoc;
      query = window.firestoreQuery;
      where = window.firestoreWhere;
      orderBy = window.firestoreOrderBy;
      limit = window.firestoreLimit;
      onSnapshot = window.firestoreOnSnapshot;
      serverTimestamp = window.firestoreServerTimestamp;
      doc = window.firestoreDoc;
      updateDoc = window.firestoreUpdateDoc;
      getDoc = window.firestoreGetDoc;
      setDoc = window.firestoreSetDoc;
      getDocs = window.firestoreGetDocs;
      arrayUnion = window.firestoreArrayUnion;
      arrayRemove = window.firestoreArrayRemove;
      increment = window.firestoreIncrement;
      writeBatch = window.firestoreWriteBatch;
      collectionGroup = window.firestoreCollectionGroup;
      ref = window.storageRef;
      uploadBytes = window.storageUploadBytes;
      getDownloadURL = window.storageGetDownloadURL;

      // 検証: 必須関数がセットされているか確認
      if (!_cuiDb) console.error('[Chat UI] _cuiDb is null - firebaseDB:', !!window.firebaseDB, 'db:', !!window.db);
      if (!doc) console.error('[Chat UI] doc function is undefined - firestoreDoc:', !!window.firestoreDoc);
      if (!getDoc) console.error('[Chat UI] getDoc function is undefined');
    }

    // === Global State Variables (cui prefix) ===
    var cuiCurrentUserName = '';
    var cuiCurrentUserEmail = '';
    var cuiCurrentRoomId = '';
    var cuiCurrentRoomName = '';
    var cuiCurrentRoomType = '';
    var cuiCurrentRoomMemberCount = 0;
    var cuiCurrentRoomMembers = [];
    var cuiUsersCache = [];
    var cuiMemberEditMode = false;
    var cuiMemberIconsBarExpanded = false;
    var cuiCurrentProfileUser = null;
    var cuiCurrentReplyTo = null;
    var cuiIsBlockedByMe = false;
    var cuiIsBlockedByOther = false;
    var cuiOtherUserEmail = '';
    var cuiIsPWA = true;
    var cuiIsGAS = false;
    var cuiIsFirstMessageLoad = true;
    var cuiIsInitialLoad = true;
    var cuiUnsubscribeMessages = null;
    var cuiIncomingCallListener = null;
    var cuiCurrentCallDocListener = null;
    var cuiSearchQueryParam = '';

    // Agora state
    var _cuiAgoraLoaded = false;
    var cuiAgoraClient = null;
    var cuiLocalAudioTrack = null;
    var cuiCallTimerInterval = null;
    var cuiCallStartTime = null;
    var cuiIsMuted = false;
    var cuiIsSpeakerOn = true;
    var cuiCurrentCallDocId = null;
    var cuiCurrentIncomingCall = null;
    var cuiRingtoneInterval = null;
    var cuiRingtoneContext = null;
    var AGORA_APP_ID = '10d16f783ccd4c97867c92475fa3fbc2';

    // Voice recording state
    var cuiVoiceMediaRecorder = null;
    var cuiVoiceAudioChunks = [];
    var cuiVoiceRecordingStartTime = null;
    var cuiVoiceRecordingTimer = null;
    var cuiVoiceAudioStream = null;
    var cuiCurrentVoiceAudio = null;
    var cuiCurrentVoiceButton = null;
    var cuiCurrentVoiceMsgId = null;

    // Image selection state
    var cuiSelectedImageFiles = [];
    var CUI_MAX_IMAGES = 10;

    // Context menu state
    var cuiContextMenuData = {
      messageId: null, messageText: null, isMine: false,
      item: null, fileUrl: null, fileName: null, senderName: null
    };
    var cuiLongPressTimer = null;
    var CUI_LONG_PRESS_DURATION = 500;

    // Search state
    var cuiSearchResults = [];
    var cuiCurrentSearchIndex = -1;
    var cuiOriginalMessages = new Map();

    // Mention state
    var cuiIsComposing = false;
    var cuiJustInsertedMention = false;
    var cuiInsertedMentions = [];
    var cuiForwardMessageData = null;

    // Event listener cleanup references
    var _cuiEventListeners = [];
    var _cuiStickyBadgeHideTimer = null;

    // URL/localStorage parameter variables (SPA: read from localStorage, GAS params are empty)
    var pwaUserNameParam = '';
    var pwaUserEmailParam = '';
    var pwaRoomIdParam = '';
    var gasUserNameParam = '';
    var gasRoomIdParam = '';
    var fcmTokenParam = '';
    var gasBaseUrlParam = '';
    var sessionIdParam = '';

    // Gradient presets
    var GRADIENT_PRESETS = [
      { id: 'blue', gradient: 'linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%)' },
      { id: 'purple', gradient: 'linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%)' },
      { id: 'pink', gradient: 'linear-gradient(135deg, #EC4899 0%, #BE185D 100%)' },
      { id: 'orange', gradient: 'linear-gradient(135deg, #F97316 0%, #EA580C 100%)' },
      { id: 'green', gradient: 'linear-gradient(135deg, #22C55E 0%, #15803D 100%)' },
      { id: 'teal', gradient: 'linear-gradient(135deg, #14B8A6 0%, #0F766E 100%)' },
      { id: 'indigo', gradient: 'linear-gradient(135deg, #6366F1 0%, #4338CA 100%)' },
      { id: 'rose', gradient: 'linear-gradient(135deg, #F43F5E 0%, #BE123C 100%)' },
      { id: 'amber', gradient: 'linear-gradient(135deg, #F59E0B 0%, #D97706 100%)' },
      { id: 'cyan', gradient: 'linear-gradient(135deg, #06B6D4 0%, #0891B2 100%)' },
      { id: 'lime', gradient: 'linear-gradient(135deg, #84CC16 0%, #65A30D 100%)' },
      { id: 'slate', gradient: 'linear-gradient(135deg, #64748B 0%, #475569 100%)' },
    ];

    // === Agora SDK lazy loading (Rule 11) ===
    function _cuiLoadScript(url) {
      return new Promise(function(resolve, reject) {
        var script = document.createElement('script');
        script.src = url;
        script.onload = resolve;
        script.onerror = function() { reject(new Error('Script load failed: ' + url)); };
        document.head.appendChild(script);
      });
    }

    // === SPA Lifecycle: initChatUiPage ===
    function initChatUiPage() {
      console.log('[Chat UI SPA] initChatUiPage called');

      // Initialize Firebase aliases
      _cuiInitFirebaseAliases();

      // Read parameters from localStorage (SPA replaces URL params)
      cuiCurrentRoomId = localStorage.getItem('current_chat_room_id') || '';
      cuiCurrentUserName = localStorage.getItem('reborn_user_name') || '';
      cuiCurrentUserEmail = localStorage.getItem('reborn_user_email') || '';
      cuiSearchQueryParam = '';

      // Set pwa* params so cuiInitialize() can use them
      pwaRoomIdParam = cuiCurrentRoomId;
      pwaUserNameParam = JSON.stringify(cuiCurrentUserName); // cuiInitialize does JSON.parse
      pwaUserEmailParam = JSON.stringify(cuiCurrentUserEmail); // cuiInitialize does JSON.parse
      sessionIdParam = 'spa_' + Date.now();

      // Reset state
      cuiIsFirstMessageLoad = true;
      cuiIsInitialLoad = true;
      cuiUnsubscribeMessages = null;
      cuiIncomingCallListener = null;
      cuiCurrentCallDocListener = null;
      cuiCurrentReplyTo = null;
      cuiIsBlockedByMe = false;
      cuiIsBlockedByOther = false;
      cuiSelectedImageFiles = [];
      cuiSearchResults = [];
      cuiCurrentSearchIndex = -1;
      cuiInsertedMentions = [];
      cuiContextMenuData = {
        messageId: null, messageText: null, isMine: false,
        item: null, fileUrl: null, fileName: null, senderName: null
      };

      // Hide bottom nav (直接DOM操作 - SPA FragmentではpostMessage経由のhideBottomNavが使えない)
      var bottomNav = document.getElementById('bottom-nav');
      if (bottomNav) bottomNav.classList.add('hidden');
      var spaContent = document.getElementById('spa-content');
      if (spaContent) spaContent.style.bottom = '0';

      // Hide SPA header
      var spaHeader = document.getElementById('spa-header');
      if (spaHeader) spaHeader.style.display = 'none';

      // Make the fragment visible
      var container = document.getElementById('spa-page-chat-ui');
      if (container) container.style.display = 'flex';

      // Run the main initialization
      cuiInitialize();

      // Setup DOM listeners (back button, accordion, etc.)
      cuiSetupDOMListeners();

      // Setup image viewer event listeners
      cuiSetupImageViewer();
    }

    // === SPA Lifecycle: destroyChatUiPage ===
    function destroyChatUiPage() {
      console.log('[Chat UI SPA] destroyChatUiPage called');

      // 1. Unsubscribe all Firestore listeners
      if (cuiUnsubscribeMessages) {
        try { cuiUnsubscribeMessages(); } catch(e) {}
        cuiUnsubscribeMessages = null;
      }
      if (cuiIncomingCallListener) {
        try { cuiIncomingCallListener(); } catch(e) {}
        cuiIncomingCallListener = null;
      }
      if (cuiCurrentCallDocListener) {
        try { cuiCurrentCallDocListener(); } catch(e) {}
        cuiCurrentCallDocListener = null;
      }

      // 2. Stop Agora if active
      if (cuiAgoraClient) {
        try {
          if (cuiLocalAudioTrack) {
            cuiLocalAudioTrack.close();
            cuiLocalAudioTrack = null;
          }
          cuiAgoraClient.leave();
          cuiAgoraClient = null;
        } catch(e) {
          console.error('[Chat UI SPA] Agora cleanup error:', e);
        }
      }
      if (cuiCallTimerInterval) {
        clearInterval(cuiCallTimerInterval);
        cuiCallTimerInterval = null;
      }

      // 3. Stop voice recording if active
      if (cuiVoiceMediaRecorder && cuiVoiceMediaRecorder.state !== 'inactive') {
        try { cuiVoiceMediaRecorder.stop(); } catch(e) {}
      }
      if (cuiVoiceRecordingTimer) {
        clearInterval(cuiVoiceRecordingTimer);
        cuiVoiceRecordingTimer = null;
      }
      if (cuiVoiceAudioStream) {
        cuiVoiceAudioStream.getTracks().forEach(function(t) { t.stop(); });
        cuiVoiceAudioStream = null;
      }
      if (cuiCurrentVoiceAudio) {
        cuiCurrentVoiceAudio.pause();
        cuiCurrentVoiceAudio = null;
      }

      // 4. Stop ringtone
      if (cuiRingtoneInterval) {
        clearInterval(cuiRingtoneInterval);
        cuiRingtoneInterval = null;
      }
      if (cuiRingtoneContext) {
        try { cuiRingtoneContext.close(); } catch(e) {}
        cuiRingtoneContext = null;
      }

      // 5. Clear timers
      if (_cuiStickyBadgeHideTimer) {
        clearTimeout(_cuiStickyBadgeHideTimer);
        _cuiStickyBadgeHideTimer = null;
      }

      // 6. Remove registered event listeners
      _cuiEventListeners.forEach(function(entry) {
        try { entry.target.removeEventListener(entry.type, entry.handler, entry.options); } catch(e) {}
      });
      _cuiEventListeners = [];

      // 7. Clear Firestore viewing status
      cuiClearViewingStatus();

      // 8. Show bottom nav and SPA header (直接DOM操作で復元)
      var bottomNav = document.getElementById('bottom-nav');
      if (bottomNav) bottomNav.classList.remove('hidden');
      var spaContent = document.getElementById('spa-content');
      if (spaContent) spaContent.style.bottom = '';
      var spaHeader = document.getElementById('spa-header');
      if (spaHeader) spaHeader.style.display = '';

      // 9. Reset state
      cuiCurrentUserName = '';
      cuiCurrentUserEmail = '';
      cuiCurrentRoomId = '';
      cuiSelectedImageFiles = [];

      console.log('[Chat UI SPA] destroyChatUiPage complete');
    }

    // Helper to track event listeners for cleanup
    function _cuiAddEventListener(target, type, handler, options) {
      target.addEventListener(type, handler, options);
      _cuiEventListeners.push({ target: target, type: type, handler: handler, options: options });
    }

    // === Converted JavaScript (from module script) ===
    // URLパラメータ取得用のヘルパー関数
    function getQueryParam(key) {
      try {
        return new URLSearchParams(location.search).get(key) || '';
      } catch(e) {
        return '';
      }
    }


    // GRADIENT_PRESETS defined above in globals



    // SPA初期化（initChatUiPageから呼ばれる）
    async function cuiInitialize() {
      console.log('[Chat UI] 初期化開始');

      // ボトムナビを非表示（initChatUiPage側で既に処理済み）
      console.log('[Chat UI] ボトムナビ非表示は initChatUiPage で処理済み');

      // メンバー管理関連のイベントリスナー設定
      document.getElementById('headerTitle').addEventListener('click', function() {
        console.log('[HeaderTitle] クリック検出');
        if (cuiCurrentRoomType === 'direct') return;
        cuiMemberIconsBarExpanded = !cuiMemberIconsBarExpanded;
        console.log('[MemberIconsBar] トグル:', cuiMemberIconsBarExpanded, 'メンバー:', cuiCurrentRoomMembers, 'cuiUsersCache:', cuiUsersCache);
        updateMemberIconsBar();
      });
      document.getElementById('memberMoreBtn').addEventListener('click', function() {
        console.log('[MemberMoreBtn] クリック検出');
        openMemberModal();
      });
      document.getElementById('memberModalOverlay').addEventListener('click', function() { closeMemberModal(); });
      document.getElementById('memberModalBackBtn').addEventListener('click', function() { closeMemberModal(); });
      document.getElementById('memberEditBtn').addEventListener('click', function() { toggleMemberEditMode(); });
      document.getElementById('memberInviteBtn').addEventListener('click', function() { openInviteModal(); });
      document.getElementById('inviteModalOverlay').addEventListener('click', function() { closeInviteModal(); });
      document.getElementById('inviteModalCloseBtn').addEventListener('click', function() { closeInviteModal(); });

      // プロフィールポップアップのボタン
      document.getElementById('profilePopupChatBtn').addEventListener('click', function() {
        if (cuiCurrentProfileUser) {
          // 既にこのルームにいる場合は閉じるだけ
          closeProfilePopup();
        }
      });
      document.getElementById('profilePopupCallBtn').addEventListener('click', function() {
        if (cuiCurrentProfileUser) {
          // プロフィールから通話を開始
          var userName = cuiCurrentProfileUser.userName;
          var iconUrl = cuiCurrentProfileUser.iconUrl;
          closeProfilePopup();
          showCallPreparing(userName, iconUrl);
        }
      });

      // roomId設定
      if (cuiIsGAS) {
        cuiCurrentRoomId = gasRoomIdParam || 'room_all';
      } else {
        cuiCurrentRoomId = pwaRoomIdParam || 'room_all';
      }
      console.log('[Room] roomId設定:', cuiCurrentRoomId);

      // ⚠️ 重要: ユーザー名を先に設定してから、ルーム情報を取得する
      // （個別チャットで相手の名前を判定するため、currentUserNameが必要）

      // ユーザー名設定
      if (cuiIsGAS) {
        // GAS版：FCM通知登録シートから自動取得
        if (gasUserNameParam && gasUserNameParam.trim() !== '') {
          // JSON.parse()でダブルクォーテーションを削除
          try {
            cuiCurrentUserName = JSON.parse(gasUserNameParam);
          } catch (e) {
            // パースできない場合はそのまま使用
            cuiCurrentUserName = gasUserNameParam;
          }
          console.log('[GAS] ユーザー名自動設定:', cuiCurrentUserName);
          console.log('[GAS] cuiCurrentUserName length:', cuiCurrentUserName.length);
        } else {
          // ユーザー名が取得できなかった場合、ドロップダウン表示
          console.log('[GAS] ユーザー名が取得できませんでした。ドロップダウンを表示');
          showUserSelect();
        }
      } else {
        // PWA版：URLパラメータから取得（親ページのlocalStorageから渡される）
        // JSON.parse()でダブルクォーテーションを削除
        try {
          cuiCurrentUserName = JSON.parse(pwaUserNameParam);
        } catch (e) {
          // パースできない場合はそのまま使用
          cuiCurrentUserName = pwaUserNameParam;
        }

        try {
          cuiCurrentUserEmail = JSON.parse(pwaUserEmailParam);
        } catch (e) {
          cuiCurrentUserEmail = pwaUserEmailParam;
        }

        console.log('[PWA] pwaUserNameParam受信:', pwaUserNameParam);
        console.log('[PWA] pwaUserEmailParam受信:', pwaUserEmailParam);
        console.log('[PWA] currentUserName設定:', cuiCurrentUserName);
        console.log('[PWA] currentUserEmail設定:', cuiCurrentUserEmail);
        console.log('[PWA] cuiCurrentUserName length:', cuiCurrentUserName.length);

        if (cuiCurrentUserName && cuiCurrentUserName.trim() !== '') {
          console.log('[PWA] ユーザー名表示完了:', cuiCurrentUserName);
        } else {
          // ユーザー名が未設定の場合、入力UIを表示
          console.log('[PWA] ユーザー名未設定 - 入力UIを表示');
          var container = document.getElementById('userNameInputContainer');
          if (container) {
            container.style.display = 'block';
            console.log('[PWA] ユーザー名入力UI表示完了');
          } else {
            console.error('[PWA] userNameInputContainer が見つかりません');
          }
        }
      }

      // ルーム情報を取得してヘッダーに表示
      console.log('[Room] ルーム情報取得開始 - roomId:', cuiCurrentRoomId);
      console.log('[Room] cuiCurrentUserName:', cuiCurrentUserName);
      try {
        var roomRef = doc(_cuiDb, 'rooms', cuiCurrentRoomId);
        console.log('[Room] roomRef作成完了');
        var roomDoc = await getDoc(roomRef);
        console.log('[Room] getDoc完了 - exists:', roomDoc.exists());

        if (roomDoc.exists()) {
          var roomData = roomDoc.data();
          console.log('[Room] roomData取得:', roomData);

          // 個別チャット（type: 'direct'）の場合は相手のユーザー名を動的生成
          if (roomData.type === 'direct' && roomData.members && Array.isArray(roomData.members)) {
            console.log('[Room] 個別チャット検出 - members:', roomData.members, 'cuiCurrentUserName:', cuiCurrentUserName);
            var otherMember = roomData.members.find(m => m !== cuiCurrentUserName);
            cuiCurrentRoomName = otherMember || '不明なユーザー';
            console.log('[Room] 相手のユーザー名:', cuiCurrentRoomName);
          } else {
            // ルーム名から先頭の絵文字を削除（アイコンは別途表示するため重複回避）
            var rawName = roomData.name || '不明なルーム';
            cuiCurrentRoomName = rawName.replace(/^[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]+\s*/u, '');
          }

          // ルームアイコン（system-notificationsは👑、それ以外はroom.iconまたは💬）
          var roomIcon = (cuiCurrentRoomId === 'system-notifications') ? '👑' : (roomData.icon || '💬');

          // ルームタイプとメンバー情報を保存（既読機能・メンバー管理用）
          cuiCurrentRoomType = roomData.type || 'group';
          cuiCurrentRoomMembers = (roomData.members && Array.isArray(roomData.members)) ? roomData.members : [];
          cuiCurrentRoomMemberCount = cuiCurrentRoomMembers.length;
          console.log('[Room] ルームタイプ:', cuiCurrentRoomType, 'メンバー数:', cuiCurrentRoomMemberCount, 'メンバー:', cuiCurrentRoomMembers);

          // ヘッダーのルーム名を更新（個別チャット・Keepは名前のみ、それ以外はアイコン付き）
          if (roomData.type === 'direct' || roomData.type === 'keep') {
            // 個別チャット・Keep：アイコン非表示、名前のみ、メンバーアイコン行非表示
            document.getElementById('headerRoomIcon').style.display = 'none';
            document.getElementById('headerRoomName').textContent = cuiCurrentRoomName;
            document.getElementById('memberIconsBar').classList.remove('show');
            console.log('[Room] 個別/Keepチャットヘッダー更新（名前のみ）:', cuiCurrentRoomName);
          } else {
            // グループチャット：アイコン+名前
            // メンバーアイコン行は最初は非表示（タップで開閉）
            document.getElementById('headerRoomIcon').style.display = 'none'; // デフォルトアイコンは非表示
            document.getElementById('headerRoomName').textContent = `${roomIcon} ${cuiCurrentRoomName}`;
            cuiMemberIconsBarExpanded = false; // ルーム切り替え時は閉じた状態でスタート
            updateMemberIconsBar();
            console.log('[Room] グループチャットヘッダー更新（アイコン付き）:', `${roomIcon} ${cuiCurrentRoomName}`);
          }


          console.log('[Room] ルーム名表示完了:', cuiCurrentRoomName);
        } else {
          console.error('[Room] ルームが見つかりません:', cuiCurrentRoomId);
        }
      } catch (error) {
        console.error('[Room] ルーム情報取得エラー:', error);
      }

      // ユーザー名設定
      if (cuiIsGAS) {
        // GAS版：FCM通知登録シートから自動取得
        if (gasUserNameParam && gasUserNameParam.trim() !== '') {
          // JSON.parse()でダブルクォーテーションを削除
          try {
            cuiCurrentUserName = JSON.parse(gasUserNameParam);
          } catch (e) {
            // パースできない場合はそのまま使用
            cuiCurrentUserName = gasUserNameParam;
          }
          console.log('[GAS] ユーザー名自動設定:', cuiCurrentUserName);
          console.log('[GAS] cuiCurrentUserName length:', cuiCurrentUserName.length);
        } else {
          // ユーザー名が取得できなかった場合、ドロップダウン表示
          console.log('[GAS] ユーザー名が取得できませんでした。ドロップダウンを表示');
          showUserSelect();
        }
      } else {
        // PWA版：URLパラメータから取得（親ページのlocalStorageから渡される）
        // JSON.parse()でダブルクォーテーションを削除
        try {
          cuiCurrentUserName = JSON.parse(pwaUserNameParam);
        } catch (e) {
          // パースできない場合はそのまま使用
          cuiCurrentUserName = pwaUserNameParam;
        }

        try {
          cuiCurrentUserEmail = JSON.parse(pwaUserEmailParam);
        } catch (e) {
          cuiCurrentUserEmail = pwaUserEmailParam;
        }

        console.log('[PWA] pwaUserNameParam受信:', pwaUserNameParam);
        console.log('[PWA] pwaUserEmailParam受信:', pwaUserEmailParam);
        console.log('[PWA] currentUserName設定:', cuiCurrentUserName);
        console.log('[PWA] currentUserEmail設定:', cuiCurrentUserEmail);
        console.log('[PWA] cuiCurrentUserName length:', cuiCurrentUserName.length);

        if (cuiCurrentUserName && cuiCurrentUserName.trim() !== '') {
          console.log('[PWA] ユーザー名表示完了:', cuiCurrentUserName);
        } else {
          // ユーザー名が未設定の場合、入力UIを表示
          console.log('[PWA] ユーザー名未設定 - 入力UIを表示');
          var container = document.getElementById('userNameInputContainer');
          if (container) {
            container.style.display = 'block';
            console.log('[PWA] ユーザー名入力UI表示完了');
          } else {
            console.error('[PWA] userNameInputContainer が見つかりません');
          }
        }
      }

      // ユーザー一覧を取得してキャッシュ（アイコン表示用）
      if (cuiIsPWA) {
        // PWA版：getUserList()はapi.jsに依存しているためスキップ
        // 直接Firestoreからユーザー一覧を取得
        console.log('[User Cache] Firestoreから直接ユーザー一覧取得開始');

        getDocs(collection(_cuiDb, 'users'))
          .then(snapshot => {
            var users = [];
            snapshot.forEach(doc => {
              users.push({ id: doc.id, ...doc.data() });
            });

            console.log('[User Cache] ユーザーデータ受信:', users);
            if (users.length > 0) {
              cuiUsersCache = users;
              console.log('[User Cache] ユーザー一覧キャッシュ完了:', cuiUsersCache.length + '件');
            } else {
              console.warn('[User Cache] ユーザー一覧が空です');
            }

            // メッセージを表示
            console.log('[User Cache] キャッシュ取得完了、メッセージリスニング開始');
            startListening();
          })
          .catch(error => {
            console.error('[User Cache] ユーザー一覧取得エラー:', error);
            // エラーの場合でもメッセージは表示する
            startListening();
          });
      } else if (typeof google !== 'undefined' && google.script && google.script.run) {
        // GAS版：google.script.runで呼び出し
        google.script.run
          .withSuccessHandler(function(users) {
            if (users && users.length > 0) {
              cuiUsersCache = users;
              console.log('[User Cache] GAS版 ユーザー一覧キャッシュ完了:', cuiUsersCache.length + '件');
            }
          })
          .withFailureHandler(function(error) {
            console.error('[User Cache] GAS版 ユーザー一覧取得エラー:', error);
          })
          .getUserListForUI();
      }

      // メッセージ入力（hidden textarea パターン）
      var messageInput = document.getElementById('messageInput'); // textarea

      // IME変換状態の監視
      messageInput.addEventListener('compositionstart', function() {
        cuiIsComposing = true;
        console.log('[IME] compositionstart - 変換開始');
      });
      messageInput.addEventListener('compositionend', function() {
        cuiIsComposing = false;
        console.log('[IME] compositionend - 変換終了');
        // IME確定後にメンションチェック
        checkMentionInput(this);
      });

      // 入力イベント（IME変換中は候補表示しない）
      messageInput.addEventListener('input', function() {
        // メンション挿入直後フラグをリセット（他の文字入力があった場合）
        cuiJustInsertedMention = false;
        // IME変換中でなければメンションチェック
        if (!cuiIsComposing) {
          checkMentionInput(this);
        }
        // 送信ボタンの有効/無効を更新
        updateSendButtonState();

        // テキストエリアの高さを自動調整（LINE風）
        autoResizeTextarea(this);
      });

      // テキストエリアの高さを自動調整する関数
      function autoResizeTextarea(textarea) {
        // 一旦高さをリセットしてscrollHeightを正確に取得
        textarea.style.height = 'auto';
        // scrollHeightに合わせて高さを設定（max-heightはCSSで制限）
        var newHeight = Math.min(textarea.scrollHeight, 120); // max 120px
        textarea.style.height = newHeight + 'px';
      }

      // Enterキーで送信（メンション選択中は候補選択）
      messageInput.addEventListener('keydown', function(e) {
        // メンション候補が表示されている場合
        if (isMentionSuggestionsVisible()) {
          if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectNextMentionSuggestion();
            return;
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectPrevMentionSuggestion();
            return;
          } else if (e.key === 'Enter') {
            e.preventDefault();
            insertSelectedMention();
            cuiJustInsertedMention = true;
            console.log('[Mention] メンション挿入完了、改行フラグON');
            return;
          } else if (e.key === 'Escape') {
            e.preventDefault();
            hideMentionSuggestions();
            return;
          }
        }

        // Enterキーの処理（LINE同様、Enterは改行・送信ボタンで送信）
        if (e.key === 'Enter') {
          // メンション挿入直後のEnterは改行として処理
          if (cuiJustInsertedMention) {
            console.log('[Mention] メンション直後のEnter → 改行として処理');
            cuiJustInsertedMention = false;
          }
          // Enterキーは常に改行（送信は送信ボタンで行う）
          // デフォルト動作（改行）をそのまま許可するため、何もしない
        }
      });

      // 未読カウントリセット（このルームを開いたので既読にする）
      try {
        if (cuiCurrentRoomId && cuiCurrentUserEmail) {
          var unreadRef = doc(_cuiDb, `rooms/${cuiCurrentRoomId}/unreadCounts/${cuiCurrentUserEmail}`);
          await setDoc(unreadRef, {
            userId: cuiCurrentUserEmail,
            unreadCount: 0,
            lastReadAt: serverTimestamp()
          }, { merge: true });

          console.log('[Firestore] 未読カウントリセット完了:', cuiCurrentUserEmail);

          // アプリバッジもクリア（チャットルームを開いたので既読）
          clearAppBadge();
        }
      } catch (error) {
        console.error('[Firestore] 未読カウントリセットエラー:', error);
      }

      // 戻るボタンに他のルームの未読数を表示
      loadOtherRoomsUnreadCount();

      // Service Workerに閲覧中であることを通知（バッジ制御用）
      notifySwViewingRoom(cuiCurrentRoomId);

      // 🎯 Firestoreに閲覧中状態を書き込み（サーバー側で通知除外に使用）
      setViewingStatus(cuiCurrentRoomId);

      // 🎯 着信リスナーを開始
      if (typeof startIncomingCallListener === 'function') {
        startIncomingCallListener();
      }

      // ページ離脱時にSWへ通知 + Firestore更新 + リスナークリーンアップ
      window.addEventListener('pagehide', () => {
        notifySwLeftRoom();
        clearViewingStatus();
        // 🔧 パフォーマンス改善: Firestoreリスナーを解除
        if (cuiUnsubscribeMessages) { try { cuiUnsubscribeMessages(); } catch(e) {} cuiUnsubscribeMessages = null; }
        if (cuiIncomingCallListener) { try { cuiIncomingCallListener(); } catch(e) {} cuiIncomingCallListener = null; }
        if (cuiCurrentCallDocListener) { try { cuiCurrentCallDocListener(); } catch(e) {} cuiCurrentCallDocListener = null; }
      });
      window.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
          notifySwLeftRoom();
          clearViewingStatus();
        } else if (document.visibilityState === 'visible') {
          notifySwViewingRoom(cuiCurrentRoomId);
          setViewingStatus(cuiCurrentRoomId);
          // 着信リスナー再開
          if (typeof startIncomingCallListener === 'function') {
            startIncomingCallListener();
          }
        }
      });

      // beforeunload でも閲覧終了を記録（pagehideが発火しない場合の保険）
      window.addEventListener('beforeunload', () => {
        clearViewingStatus();
        // 🔧 パフォーマンス改善: Firestoreリスナーを解除
        if (cuiUnsubscribeMessages) { try { cuiUnsubscribeMessages(); } catch(e) {} cuiUnsubscribeMessages = null; }
        if (cuiIncomingCallListener) { try { cuiIncomingCallListener(); } catch(e) {} cuiIncomingCallListener = null; }
        if (cuiCurrentCallDocListener) { try { cuiCurrentCallDocListener(); } catch(e) {} cuiCurrentCallDocListener = null; }
      });

      // ルームのmembersに自分を追加（未追加の場合）
      try {
        if (cuiCurrentRoomId && cuiCurrentUserName) {
          var roomRef = doc(_cuiDb, 'rooms', cuiCurrentRoomId);
          await updateDoc(roomRef, {
            members: arrayUnion(cuiCurrentUserName)
          });

          console.log('[Firestore] ルームメンバーに追加:', cuiCurrentUserName);
        }
      } catch (error) {
        console.error('[Firestore] メンバー追加エラー:', error);
      }

      // メッセージのリアルタイムリスニングは、ユーザーキャッシュ取得後に開始
      // ユーザーキャッシュが取得できない場合は3秒後に開始
      if (!cuiIsPWA) {
        // GAS版は即座にstartListening
        startListening();
      }
      // PWA版はfetch完了後またはタイムアウト後にstartListeningを呼び出す

      // LINE風スティッキー日付バッジのスクロール監視
      var messagesContainer = document.getElementById('messagesContainer');
      var stickyDateBadge = document.getElementById('stickyDateBadge');
      var stickyBadgeHideTimer = null; // バッジ自動非表示用タイマー
      
      messagesContainer.addEventListener('scroll', function() {
        updateStickyDateBadge();
        
        // スクロール中はタイマーをリセット
        if (stickyBadgeHideTimer) {
          clearTimeout(stickyBadgeHideTimer);
          stickyBadgeHideTimer = null;
        }
        
        // スクロールが止まったら1.5秒後にバッジを非表示（LINE風）
        stickyBadgeHideTimer = setTimeout(() => {
          stickyDateBadge.classList.add('hidden');
        }, 1500);
      });

      function updateStickyDateBadge() {
        var container = document.getElementById('messagesContainer');
        var dateSeparators = container.querySelectorAll('.date-separator');
        
        if (dateSeparators.length === 0) {
          stickyDateBadge.classList.add('hidden');
          return;
        }

        // コンテナの上端を基準
        var containerRect = container.getBoundingClientRect();
        var containerTop = containerRect.top;
        var containerBottom = containerRect.bottom;

        // 現在表示されている日付を検出
        var currentDate = null;
        var isAnyDateSeparatorVisible = false;
        
        for (varsep of dateSeparators) {
          var sepRect = sep.getBoundingClientRect();
          
          // 日付区切りが画面内に見えているかチェック
          if (sepRect.top >= containerTop && sepRect.bottom <= containerBottom) {
            isAnyDateSeparatorVisible = true;
          }
          
          // 日付区切りがコンテナ上端より下にある場合、その前の日付が現在の日付
          if (sepRect.top > containerTop + 10) {
            break;
          }
          currentDate = sep.dataset.date;
        }

        // インラインの日付区切りが見えている場合は固定バッジを非表示
        if (isAnyDateSeparatorVisible) {
          stickyDateBadge.classList.add('hidden');
        } else if (currentDate) {
          stickyDateBadge.textContent = currentDate;
          stickyDateBadge.classList.remove('hidden');
        } else {
          // 最初の日付区切りより上にスクロールしている場合は非表示
          stickyDateBadge.classList.add('hidden');
        }
      }
    }

    // GAS版：ユーザー選択ドロップダウン表示
    function showUserSelect() {
      var container = document.getElementById('userSelectContainer');
      var select = document.getElementById('userSelect');

      container.style.display = 'block';

      // FCM通知登録シートからユーザーリスト取得
      google.script.run
        .withSuccessHandler(function(users) {
          console.log('[GAS] ユーザー取得成功:', users);

          if (!users || users.length === 0) {
            console.error('[GAS] ユーザーが見つかりません');
            return;
          }

          // ユーザー一覧をキャッシュ（アイコン表示用）
          cuiUsersCache = users;
          console.log('[User Cache] ユーザー一覧キャッシュ完了:', cuiUsersCache.length + '件');

          // 前回選択したユーザー名を取得
          var savedUserName = localStorage.getItem('reborn_chat_user_name');

          // ドロップダウンに追加
          select.innerHTML = '<option value="">選択してください</option>';
          users.forEach(function(user) {
            var option = document.createElement('option');
            option.value = user.userName;
            option.textContent = user.userName;

            if (savedUserName && user.userName === savedUserName) {
              option.selected = true;
              cuiCurrentUserName = user.userName;
            }

            select.appendChild(option);
          });

          // 選択変更時
          select.addEventListener('change', function() {
            cuiCurrentUserName = this.value;
            localStorage.setItem('reborn_chat_user_name', cuiCurrentUserName);
            console.log('[GAS] ユーザー名選択:', cuiCurrentUserName);
          });
        })
        .withFailureHandler(function(error) {
          console.error('[GAS] エラー:', error);
        })
        .getActiveUsers();
    }

    // PWA版：ユーザー名入力UI表示
    function showUserNameInput() {
      var container = document.getElementById('userNameInputContainer');
      var input = document.getElementById('userNameInput');
      var saveBtn = document.getElementById('saveUserNameBtn');

      container.style.display = 'block';

      // 既存の値があれば pre-fill
      if (cuiCurrentUserName) {
        input.value = cuiCurrentUserName;
      }

      // 保存ボタンのクリックハンドラー
      saveBtn.addEventListener('click', function() {
        var userName = input.value.trim();

        if (!userName) {
          alert('名前を入力してください');
          return;
        }

        // localStorage に保存
        localStorage.setItem('reborn_user_name', userName);
        cuiCurrentUserName = userName;

        // 入力UIを非表示
        container.style.display = 'none';

        console.log('[PWA] ユーザー名保存:', userName);
      });
    }

    // ユーザーアイコンURLを取得
    function getUserIconUrl(userName) {
      if (!userName || !cuiUsersCache || cuiUsersCache.length === 0) return null;
      var user = cuiUsersCache.find(u => u.userName === userName);
      return (user && user.userIconUrl) ? user.userIconUrl : null;
    }

    // 既読状態を更新（メッセージを閲覧したことをFirestoreに記録）
    async function markMessagesAsRead(messageIds) {
      if (!cuiCurrentUserEmail || !cuiCurrentRoomId || messageIds.length === 0) return;

      console.log('[既読] 既読更新開始:', messageIds.length, '件');

      try {
        // バッチ更新で効率化
        var batch = writeBatch(_cuiDb);

        for (varmsgId of messageIds) {
          var msgRef = doc(_cuiDb, `rooms/${cuiCurrentRoomId}/messages/${msgId}`);
          // arrayUnion で重複なく追加
          batch.update(msgRef, {
            readBy: arrayUnion(cuiCurrentUserEmail)
          });
        }

        await batch.commit();
        console.log('[既読] 既読更新完了:', messageIds.length, '件');
      } catch (error) {
        console.error('[既読] 既読更新エラー:', error);
      }
    }

    // Service Workerに閲覧中のルームを通知
    function notifySwViewingRoom(roomId) {
      if (navigator.serviceWorker && navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({
          type: 'VIEWING_ROOM',
          roomId: roomId
        });
        console.log('[SW通知] 閲覧中ルームを通知:', roomId);
      } else {
        console.log('[SW通知] Service Workerが利用できません');
      }
    }

    // Service Workerにルーム閲覧終了を通知
    function notifySwLeftRoom() {
      if (navigator.serviceWorker && navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({
          type: 'VIEWING_ROOM',
          roomId: null
        });
        console.log('[SW通知] ルーム閲覧終了を通知');
      }
    }

    // 🎯 アプリバッジをクリア（Service Worker経由 + クライアント両方）
    function clearAppBadge() {
      // 1. Service Workerにバッジクリア命令を送信（最重要）
      if (navigator.serviceWorker && navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({
          type: 'CLEAR_BADGE'
        });
        console.log('[Badge] SW へバッジクリア命令送信');
      }

      // 2. クライアント側でもNavigator Badge APIを呼ぶ（フォールバック）
      if ('clearAppBadge' in navigator) {
        navigator.clearAppBadge().catch(err => {
          console.error('[Badge] clearAppBadge エラー:', err);
        });
        console.log('[Badge] アプリバッジクリア（クライアント側）');
      }

      // 3. IndexedDBのバッジカウントもリセット（クライアント側フォールバック）
      resetBadgeDB('RebornBadgeDB');
      resetBadgeDB('SystemNotificationDB');
    }

    // IndexedDBのバッジカウントをリセット
    function resetBadgeDB(dbName) {
      try {
        var req = indexedDB.open(dbName, 1);
        req.onupgradeneeded = (e) => {
          var db = e.target.result;
          if (!db.objectStoreNames.contains('badge')) {
            db.createObjectStore('badge');
          }
        };
        req.onsuccess = () => {
          var db = req.result;
          if (db.objectStoreNames.contains('badge')) {
            var tx = db.transaction('badge', 'readwrite');
            var store = tx.objectStore('badge');
            store.put(0, 'count');
            tx.oncomplete = () => {
              db.close();
              console.log(`[Badge] ${dbName} カウントリセット`);
            };
          } else {
            db.close();
          }
        };
        req.onerror = () => {
          console.error(`[Badge] ${dbName} open エラー:`, req.error);
        };
      } catch (error) {
        console.error(`[Badge] ${dbName} エラー:`, error);
      }
    }

    // 🎯 Firestoreに閲覧中状態を書き込み（サーバー側で通知除外に使用）
    async function setViewingStatus(roomId) {
      if (!cuiCurrentUserEmail || !roomId) return;

      try {
        var viewingRef = doc(_cuiDb, 'viewingStatus', cuiCurrentUserEmail);
        await setDoc(viewingRef, {
          roomId: roomId,
          lastUpdated: serverTimestamp()
        });
        console.log('[閲覧状態] Firestore更新: 閲覧中 -', roomId);
      } catch (error) {
        console.error('[閲覧状態] Firestore書き込みエラー:', error);
      }
    }

    // 🎯 Firestoreから閲覧中状態をクリア
    async function clearViewingStatus() {
      if (!cuiCurrentUserEmail) return;

      try {
        var viewingRef = doc(_cuiDb, 'viewingStatus', cuiCurrentUserEmail);
        await setDoc(viewingRef, {
          roomId: null,
          lastUpdated: serverTimestamp()
        });
        console.log('[閲覧状態] Firestore更新: 閲覧終了');
      } catch (error) {
        console.error('[閲覧状態] Firestoreクリアエラー:', error);
      }
    }

    // リアルタイムで未読カウントをリセット（チャットルームを開いている間）
    async function resetUnreadCountRealtime() {
      if (!cuiCurrentUserEmail || !cuiCurrentRoomId) return;

      try {
        var unreadRef = doc(_cuiDb, `rooms/${cuiCurrentRoomId}/unreadCounts/${cuiCurrentUserEmail}`);
        await setDoc(unreadRef, {
          userId: cuiCurrentUserEmail,
          unreadCount: 0,
          lastReadAt: serverTimestamp()
        }, { merge: true });

        console.log('[未読] リアルタイム未読カウントリセット完了');

        // アプリバッジもクリア（チャットルームを開いている間は常にクリア）
        clearAppBadge();
      } catch (error) {
        console.error('[未読] リアルタイム未読カウントリセットエラー:', error);
      }
    }

    // 既読数を計算（自分を除く）
    function getReadCount(readBy) {
      if (!readBy || !Array.isArray(readBy)) return 0;
      // 自分を除いた既読者数
      return readBy.filter(email => email !== cuiCurrentUserEmail).length;
    }

    // メンバーアイコン行を更新（展開状態に応じて表示）
    function updateMemberIconsBar(forceShow = null) {
      var bar = document.getElementById('memberIconsBar');
      var iconsContainer = document.getElementById('memberIcons');

      // 個別チャットの場合は非表示
      if (cuiCurrentRoomType === 'direct' || cuiCurrentRoomMembers.length === 0) {
        bar.classList.remove('show');
        return;
      }

      // 展開状態に応じてバーを表示/非表示
      if (forceShow !== null) {
        cuiMemberIconsBarExpanded = forceShow;
      }

      if (cuiMemberIconsBarExpanded) {
        bar.classList.add('show');
      } else {
        bar.classList.remove('show');
      }

      // アイコンを描画
      iconsContainer.innerHTML = '';

      // 最大5人まで表示
      var displayMembers = cuiCurrentRoomMembers.slice(0, 5);
      displayMembers.forEach(memberName => {
        // currentRoomMembersには名前が入っているので、userNameでマッチング
        var user = cuiUsersCache.find(u => u.userName === memberName);
        var iconUrl = user ? user.userIconUrl : null;

        console.log('[MemberIcon] memberName:', memberName, 'user:', user, 'iconUrl:', iconUrl);

        if (iconUrl) {
          var img = document.createElement('img');
          img.className = 'member-icon';
          img.src = iconUrl;
          img.alt = memberName;
          iconsContainer.appendChild(img);
        } else {
          var placeholder = document.createElement('div');
          placeholder.className = 'member-icon-placeholder';
          placeholder.textContent = (memberName || '?').charAt(0);
          iconsContainer.appendChild(placeholder);
        }
      });
    }

    // メンバーアイコン行の開閉トグル
    window.toggleMemberIconsBar = function() {
      if (cuiCurrentRoomType === 'direct') return; // 個別チャットでは無効
      cuiMemberIconsBarExpanded = !cuiMemberIconsBarExpanded;
      console.log('[MemberIconsBar] トグル:', cuiMemberIconsBarExpanded, 'メンバー:', cuiCurrentRoomMembers, 'cuiUsersCache:', cuiUsersCache);
      updateMemberIconsBar();
    };

    // メンバー管理モーダルを開く
    window.openMemberModal = function() {
      document.getElementById('memberModalOverlay').classList.add('active');
      document.getElementById('memberModal').classList.add('active');
      renderMemberList();
    };

    // メンバー管理モーダルを閉じる
    window.closeMemberModal = function() {
      document.getElementById('memberModalOverlay').classList.remove('active');
      document.getElementById('memberModal').classList.remove('active');
      cuiMemberEditMode = false;
      document.getElementById('memberEditBtn').textContent = '編集';
      // メンバーアイコンバーを閉じる
      cuiMemberIconsBarExpanded = false;
      document.getElementById('memberIconsBar').classList.remove('show');
    };

    // ========================================
    // プロフィールポップアップ
    // ========================================

    // プロフィールポップアップを開く
    window.openProfilePopup = async function(userName, iconUrl) {
      console.log('[Profile Popup] 開く:', userName);
      cuiCurrentProfileUser = { userName, iconUrl };

      // アバター表示
      var avatarContainer = document.getElementById('profilePopupAvatar');
      var initial = userName.charAt(0).toUpperCase();

      if (iconUrl) {
        avatarContainer.innerHTML = `<img src="${iconUrl}" class="profile-popup-avatar" onerror="this.outerHTML='<div class=\\'profile-popup-avatar-initial\\'>${initial}</div>'">`;
      } else {
        avatarContainer.innerHTML = `<div class="profile-popup-avatar-initial">${initial}</div>`;
      }

      // 名前表示
      document.getElementById('profilePopupName').textContent = userName;

      // ユーザーの背景設定と権限を取得して適用
      var header = document.getElementById('profilePopupHeader');
      var statusEl = document.getElementById('profilePopupStatus');
      try {
        // usersCacheからユーザーのメールを取得
        var user = cuiUsersCache.find(u => u.userName === userName);
        if (user && user.id) {
          var userRef = doc(_cuiDb, 'users', user.id);
          var userSnap = await getDoc(userRef);
          if (userSnap.exists()) {
            var userData = userSnap.data();

            // 権限表示を設定
            statusEl.textContent = userData.permissionDisplay || 'メンバー';

            if (userData.profileBackground) {
              var bg = userData.profileBackground;
              if (bg.type === 'image' && bg.value) {
                header.style.backgroundImage = `url('${bg.value}')`;
                header.style.backgroundSize = 'cover';
                header.style.backgroundPosition = 'center';
                header.style.background = '';
                header.style.backgroundImage = `url('${bg.value}')`;
              } else if (bg.type === 'gradient') {
                var preset = GRADIENT_PRESETS.find(p => p.id === bg.value) || GRADIENT_PRESETS[0];
                header.style.backgroundImage = '';
                header.style.background = preset.gradient;
              }
              console.log('[Profile Popup] 背景設定適用:', bg);
            } else {
              // デフォルト背景
              header.style.backgroundImage = '';
              header.style.background = 'linear-gradient(135deg, var(--reborn-primary), var(--reborn-primary-dark))';
            }
          } else {
            statusEl.textContent = 'メンバー';
          }
        } else {
          // デフォルト背景・権限
          header.style.backgroundImage = '';
          header.style.background = 'linear-gradient(135deg, var(--reborn-primary), var(--reborn-primary-dark))';
          statusEl.textContent = 'メンバー';
        }
      } catch (error) {
        console.error('[Profile Popup] 背景設定取得エラー:', error);
        // デフォルト背景・権限
        header.style.backgroundImage = '';
        header.style.background = 'linear-gradient(135deg, var(--reborn-primary), var(--reborn-primary-dark))';
        statusEl.textContent = 'メンバー';
      }

      // ポップアップ表示
      document.getElementById('profilePopupOverlay').classList.add('active');
    };

    // プロフィールポップアップを閉じる
    window.closeProfilePopup = function(event) {
      if (event) event.stopPropagation();
      document.getElementById('profilePopupOverlay').classList.remove('active');
      cuiCurrentProfileUser = null;
    };

    // ========================================
    // メンション機能（hidden textarea パターン）
    // ========================================
    // iOS Safari の IME 問題を回避するため、実際の入力は hidden textarea で行い、
    // 表示用の div (messageInputDisplay) に同期する方式
    
    var mentionStartIndex = -1;       // @の位置（textarea.value内）
    var mentionQuery = '';            // @以降の検索クエリ
    var selectedMentionIndex = 0;     // 選択中の候補インデックス
    var filteredMentionUsers = [];    // フィルタされた候補ユーザー
    var cuiJustInsertedMention = false;  // メンション挿入直後フラグ
    var cuiIsComposing = false;          // IME変換中フラグ

    // 保存済みメンション情報（表示用divと同期するために使用）
    // 形式: [{ start: number, end: number, userName: string }, ...]
    var cuiInsertedMentions = [];

    // メンション入力を検知（textarea用）
    function checkMentionInput(textarea) {
      var text = textarea.value;
      var cursorPos = textarea.selectionStart;

      // カーソル位置より前のテキストで最後の@を探す（半角・全角両対応）
      var textBeforeCursor = text.substring(0, cursorPos);
      // 全角@を半角@に変換して検索
      var normalizedText = textBeforeCursor.replace(/＠/g, '@');
      var lastAtIndex = normalizedText.lastIndexOf('@');

      if (lastAtIndex === -1) {
        hideMentionSuggestions();
        return;
      }

      // @の前が空白か先頭かチェック（正規化前のテキストで確認）
      if (lastAtIndex > 0 && !/\s/.test(normalizedText[lastAtIndex - 1])) {
        hideMentionSuggestions();
        return;
      }

      // @以降のテキスト（スペースが含まれていたら無効）
      var queryText = normalizedText.substring(lastAtIndex + 1);
      if (/\s/.test(queryText)) {
        hideMentionSuggestions();
        return;
      }

      mentionStartIndex = lastAtIndex;
      mentionQuery = queryText.toLowerCase();

      // メンバーをフィルタリング
      filterAndShowMentionSuggestions();
    }

    // textarea用：プレーンテキストを取得（後方互換性のため残す）
    function getPlainText(element) {
      // textareaの場合はvalueを返す
      if (element.tagName === 'TEXTAREA') {
        return element.value || '';
      }
      // 表示用divの場合はtextContentを返す
      return element.textContent || '';
    }

    // メンションタグを追加（タグ方式）
    function addMentionTag(userName) {
      var tagsContainer = document.getElementById('mentionTags');
      if (!tagsContainer) return;

      // 既に同じユーザーのタグがあれば追加しない
      if (cuiInsertedMentions.some(m => m.userName === userName)) {
        console.log('[Mention] 既に追加済み:', userName);
        return;
      }

      // タグ要素を作成
      var tag = document.createElement('span');
      tag.className = 'mention-tag';
      tag.dataset.userName = userName;
      tag.innerHTML = '@' + userName + '<button class="mention-tag-remove" type="button">×</button>';

      // 削除ボタンのイベント
      tag.querySelector('.mention-tag-remove').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        removeMentionTag(userName);
      });

      tagsContainer.appendChild(tag);
      tagsContainer.classList.add('has-tags');

      // 挿入済みメンションを記録
      cuiInsertedMentions.push({ userName: userName });

      console.log('[Mention] タグ追加:', userName);
    }

    // メンションタグを削除
    function removeMentionTag(userName) {
      var tagsContainer = document.getElementById('mentionTags');
      if (!tagsContainer) return;

      var tag = tagsContainer.querySelector('[data-user-name="' + userName + '"]');
      if (tag) {
        tag.remove();
      }

      // 挿入済みメンションから削除
      cuiInsertedMentions = cuiInsertedMentions.filter(m => m.userName !== userName);

      // タグがなくなったらコンテナを非表示
      if (cuiInsertedMentions.length === 0) {
        tagsContainer.classList.remove('has-tags');
      }

      console.log('[Mention] タグ削除:', userName);
    }

    // 全てのメンションタグをクリア
    function clearMentionTags() {
      var tagsContainer = document.getElementById('mentionTags');
      if (!tagsContainer) return;

      tagsContainer.innerHTML = '';
      tagsContainer.classList.remove('has-tags');
      cuiInsertedMentions = [];
    }

    // メンションを挿入（タグ方式 + textareaの@を削除）
    function insertMentionViaTextarea(userName) {
      var textarea = document.getElementById('messageInput');
      if (!textarea) return;

      // IME変換中なら終わるまで待つ
      if (cuiIsComposing) {
        var capturedUserName = userName;
        var retry = function() {
          if (!cuiIsComposing) {
            insertMentionViaTextarea(capturedUserName);
          } else {
            setTimeout(retry, 20);
          }
        };
        setTimeout(retry, 20);
        return;
      }

      // textareaから@と入力中のクエリを削除
      var start = textarea.selectionStart;
      var replaceStart = mentionStartIndex >= 0 ? mentionStartIndex : start;
      var replaceEnd = start;

      console.log('[Mention] 挿入:', userName, 'replaceStart:', replaceStart, 'replaceEnd:', replaceEnd);

      try {
        // @と入力中テキストを削除（空文字で置換）
        if (typeof textarea.setRangeText === 'function') {
          textarea.setRangeText('', replaceStart, replaceEnd, 'end');
        } else {
          var val = textarea.value;
          textarea.value = val.slice(0, replaceStart) + val.slice(replaceEnd);
          textarea.setSelectionRange(replaceStart, replaceStart);
        }
      } catch (err) {
        console.error('[Mention] テキスト削除エラー:', err);
      }

      // タグとして追加
      addMentionTag(userName);

      // リセット
      mentionStartIndex = -1;
      mentionQuery = '';
      hideMentionSuggestions();

      // フォーカスを維持
      textarea.focus();

      cuiJustInsertedMention = true;
    }

    // 入力フィールド内のメンションをハイライト表示（送信後の表示時のみ - 入力中はプレーンテキスト）
    function highlightMentionsInInput(element) {
      // シンプルtextareaではハイライトなし（送信後のメッセージ表示時のみハイライト）
    }

    // textarea用：改行を挿入
    function insertLineBreak() {
      var textarea = document.getElementById('messageInput');
      if (!textarea) return;
      
      var start = textarea.selectionStart;
      var end = textarea.selectionEnd;
      var value = textarea.value;
      
      // 改行を挿入
      textarea.value = value.substring(0, start) + '\n' + value.substring(end);

      // カーソルを改行の後ろに移動
      var newPos = start + 1;
      textarea.setSelectionRange(newPos, newPos);
    }

    // メンション候補をフィルタリングして表示
    function filterAndShowMentionSuggestions() {
      // 現在のルームメンバーまたは全ユーザーからフィルタリング
      var users = cuiCurrentRoomMembers.length > 0 ? cuiCurrentRoomMembers : Object.keys(cuiUsersCache);

      if (users.length === 0) {
        hideMentionSuggestions();
        return;
      }

      // 自分を除外し、クエリでフィルタリング
      var filtered = users.filter(userName => {
        if (userName === cuiCurrentUserName) return false;
        if (mentionQuery === '') return true;
        return userName.toLowerCase().includes(mentionQuery);
      });

      // @All（全員）を先頭に追加（クエリが空または"all"を含む場合）
      var allLabel = 'All';
      if (mentionQuery === '' || allLabel.toLowerCase().includes(mentionQuery)) {
        filtered = [allLabel, ...filtered];
      }

      filteredMentionUsers = filtered;

      if (filteredMentionUsers.length === 0) {
        hideMentionSuggestions();
        return;
      }

      selectedMentionIndex = 0;
      renderMentionSuggestions();
    }

    // メンション選択処理（タップ/クリック共通）- hidden textarea パターン
    function processMentionSelection(capturedUserName) {
      console.log('[Mention] processMentionSelection:', capturedUserName);
      
      // hidden textarea パターンでは insertMentionViaTextarea を使用
      insertMentionViaTextarea(capturedUserName);
    }

    // メンション候補リストを描画
    function renderMentionSuggestions() {
      var container = document.getElementById('mentionSuggestions');
      container.innerHTML = '';

      filteredMentionUsers.forEach((userName, index) => {
        var item = document.createElement('div');
        item.className = 'mention-suggestion-item' + (index === selectedMentionIndex ? ' selected' : '');
        item.dataset.userName = userName;

        // アイコン（@Allの場合は特別なアイコン）
        if (userName === 'All') {
          var allIcon = document.createElement('div');
          allIcon.className = 'mention-suggestion-icon-placeholder mention-all-icon';
          allIcon.innerHTML = '👥';
          item.appendChild(allIcon);
        } else {
          var iconUrl = getUserIconUrl(userName);
          if (iconUrl) {
            var icon = document.createElement('img');
            icon.className = 'mention-suggestion-icon';
            icon.src = iconUrl;
            icon.alt = userName;
            icon.onerror = function() {
              var placeholder = document.createElement('div');
              placeholder.className = 'mention-suggestion-icon-placeholder';
              placeholder.textContent = userName.charAt(0);
              this.replaceWith(placeholder);
            };
            item.appendChild(icon);
          } else {
            var placeholder = document.createElement('div');
            placeholder.className = 'mention-suggestion-icon-placeholder';
            placeholder.textContent = userName.charAt(0);
            item.appendChild(placeholder);
          }
        }

        // 名前（@Allの場合は「全員」と表示）
        var name = document.createElement('span');
        name.className = 'mention-suggestion-name';
        name.textContent = userName === 'All' ? '全員 (All)' : userName;
        item.appendChild(name);

        // タップ/クリックで選択（hidden textarea パターン）
        // 重要：クロージャでuserNameをキャプチャ
        (function(capturedUserName) {
          var touchHandled = false;

          // iOS/モバイル: touchstartで即座に処理
          // hidden textarea パターンでは blur() 不要、直接挿入可能
          item.addEventListener('touchstart', function(e) {
            e.preventDefault(); // デフォルト動作を防ぐ
            e.stopPropagation(); // イベント伝播を止める
            touchHandled = true;
            console.log('[Mention] touchstart発火:', capturedUserName);
            
            // IME変換中フラグをリセット
            cuiIsComposing = false;
            
            // hidden textarea パターン: 直接挿入（blur不要）
            processMentionSelection(capturedUserName);
          }, { passive: false });

          // PC: click（touchstartで処理済みならスキップ）
          item.addEventListener('click', function(e) {
            if (touchHandled) {
              touchHandled = false;
              return;
            }
            console.log('[Mention] click発火:', capturedUserName);
            processMentionSelection(capturedUserName);
          });
        })(userName);

        container.appendChild(item);
      });

      container.classList.add('show');
    }

    // メンション候補が表示されているか
    function isMentionSuggestionsVisible() {
      var container = document.getElementById('mentionSuggestions');
      return container && container.classList.contains('show');
    }

    // メンション候補を非表示
    function hideMentionSuggestions() {
      var container = document.getElementById('mentionSuggestions');
      if (container) {
        container.classList.remove('show');
      }
      mentionStartIndex = -1;
      mentionQuery = '';
      filteredMentionUsers = [];
      mentionRange = null; // Rangeもリセット
    }

    // 次の候補を選択
    function selectNextMentionSuggestion() {
      if (filteredMentionUsers.length === 0) return;
      selectedMentionIndex = (selectedMentionIndex + 1) % filteredMentionUsers.length;
      renderMentionSuggestions();
    }

    // 前の候補を選択
    function selectPrevMentionSuggestion() {
      if (filteredMentionUsers.length === 0) return;
      selectedMentionIndex = (selectedMentionIndex - 1 + filteredMentionUsers.length) % filteredMentionUsers.length;
      renderMentionSuggestions();
    }

    // ユーザー名を直接指定してメンションを挿入（後方互換性）
    function insertSelectedMentionByName(userName) {
      insertMentionViaTextarea(userName);
    }

    // 選択されたメンションを挿入（キーボード操作用）
    function insertSelectedMention() {
      if (filteredMentionUsers.length === 0) return;
      var userName = filteredMentionUsers[selectedMentionIndex];
      insertMentionViaTextarea(userName);
    }

    // メンションを解析してユーザー名リストを返す
    function parseMentions(text) {
      var mentionRegex = /@([^\s@]+)/g;
      var mentions = [];
      var match;

      while ((match = mentionRegex.exec(text)) !== null) {
        var userName = match[1];
        // @All は特別扱い
        if (userName === 'All') {
          mentions.push('All');
        }
        // 実在するユーザーかチェック
        else if (cuiCurrentRoomMembers.includes(userName) || cuiUsersCache[userName]) {
          mentions.push(userName);
        }
      }

      return [...new Set(mentions)]; // 重複排除
    }

    // メンションをハイライト表示用HTMLに変換
    function highlightMentions(text, mentions) {
      if (!text || !mentions || mentions.length === 0) {
        return escapeHtml(text);
      }

      var result = escapeHtml(text);

      // 各メンションをハイライト
      mentions.forEach(userName => {
        var escapedUserName = escapeHtml(userName);
        var regex = new RegExp(`@${escapeRegExp(escapedUserName)}(?=\\s|$)`, 'g');
        result = result.replace(regex, `<span class="mention-highlight">@${escapedUserName}</span>`);
      });

      return result;
    }

    // HTML特殊文字をエスケープ
    function escapeHtml(text) {
      if (!text) return '';
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // 正規表現の特殊文字をエスケープ
    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // メンバー編集モード切替
    window.toggleMemberEditMode = function() {
      cuiMemberEditMode = !cuiMemberEditMode;
      document.getElementById('memberEditBtn').textContent = cuiMemberEditMode ? '完了' : '編集';
      renderMemberList();
    };

    // メンバーリストを描画
    function renderMemberList() {
      var container = document.getElementById('memberList');
      var countEl = document.getElementById('memberCount');

      countEl.textContent = `メンバー ${cuiCurrentRoomMembers.length}`;
      container.innerHTML = '';

      cuiCurrentRoomMembers.forEach(memberName => {
        // currentRoomMembersには名前が入っているので、userNameでマッチング
        var user = cuiUsersCache.find(u => u.userName === memberName);
        var iconUrl = user ? user.userIconUrl : null;

        var item = document.createElement('div');
        item.className = 'member-list-item' + (cuiMemberEditMode ? ' edit-mode' : '');

        if (iconUrl) {
          var img = document.createElement('img');
          img.className = 'avatar';
          img.src = iconUrl;
          img.alt = memberName;
          item.appendChild(img);
        } else {
          var placeholder = document.createElement('div');
          placeholder.className = 'avatar-placeholder';
          placeholder.textContent = (memberName || '?').charAt(0);
          item.appendChild(placeholder);
        }

        var info = document.createElement('div');
        info.className = 'info';
        info.innerHTML = `<div class="name">${memberName}</div>`;
        item.appendChild(info);

        // 削除ボタン（編集モード時のみ表示、自分以外のみ削除可能）
        if (memberName !== cuiCurrentUserName) {
          var deleteBtn = document.createElement('button');
          deleteBtn.className = 'delete-btn';
          deleteBtn.textContent = '−';
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            removeMember(memberName);
          };
          item.appendChild(deleteBtn);
        }

        container.appendChild(item);
      });
    }

    // 招待モーダルを開く
    window.openInviteModal = function() {
      document.getElementById('inviteModalOverlay').classList.add('active');
      document.getElementById('inviteModal').classList.add('active');
      renderInviteList();
    };

    // 招待モーダルを閉じる
    window.closeInviteModal = function() {
      document.getElementById('inviteModalOverlay').classList.remove('active');
      document.getElementById('inviteModal').classList.remove('active');
    };

    // 招待可能ユーザーリストを描画
    function renderInviteList() {
      var container = document.getElementById('inviteUserList');
      container.innerHTML = '';

      cuiUsersCache.forEach(user => {
        // currentRoomMembersには名前が入っているので、userNameでマッチング
        var userName = user.userName;
        var userIconUrl = user.userIconUrl;
        var isMember = cuiCurrentRoomMembers.includes(userName);

        var item = document.createElement('div');
        item.className = 'invite-user-item' + (isMember ? ' disabled' : '');

        if (userIconUrl) {
          var img = document.createElement('img');
          img.className = 'avatar';
          img.src = userIconUrl;
          img.alt = userName;
          img.style.cssText = 'width: 40px; height: 40px; border-radius: 50%; object-fit: cover;';
          item.appendChild(img);
        } else {
          var placeholder = document.createElement('div');
          placeholder.className = 'avatar-placeholder';
          placeholder.textContent = (userName || '?').charAt(0);
          item.appendChild(placeholder);
        }

        var info = document.createElement('div');
        info.className = 'info';
        if (isMember) {
          info.innerHTML = `<div class="name">${userName}</div><div class="already-member">すでにメンバーです</div>`;
        } else {
          info.innerHTML = `<div class="name">${userName}</div>`;
        }
        item.appendChild(info);

        if (!isMember) {
          item.onclick = () => addMember(userName);
        }

        container.appendChild(item);
      });
    }

    // メンバーを追加（名前ベース）
    async function addMember(memberName) {
      if (!cuiCurrentRoomId || cuiCurrentRoomMembers.includes(memberName)) return;

      try {
        var roomRef = doc(_cuiDb, 'rooms', cuiCurrentRoomId);
        await updateDoc(roomRef, {
          members: arrayUnion(memberName)
        });

        // システムメッセージを送信
        await addDoc(collection(_cuiDb, `rooms/${cuiCurrentRoomId}/messages`), {
          text: `${cuiCurrentUserName} が ${memberName} をグループに追加しました。`,
          userName: 'システム',
          userEmail: 'system@furira.com',
          timestamp: serverTimestamp(),
          type: 'system'
        });

        // ローカル状態を更新
        cuiCurrentRoomMembers.push(memberName);
        cuiCurrentRoomMemberCount = cuiCurrentRoomMembers.length;

        closeInviteModal();
        renderMemberList();
        updateMemberIconsBar();

        console.log('[Member] メンバー追加完了:', memberName);
      } catch (error) {
        console.error('[Member] メンバー追加エラー:', error);
        alert('メンバーの追加に失敗しました');
      }
    }

    // メンバーを削除（名前ベース）
    async function removeMember(memberName) {
      if (!cuiCurrentRoomId || !cuiCurrentRoomMembers.includes(memberName)) return;

      if (!confirm(`${memberName} をグループから削除しますか？`)) return;

      try {
        var roomRef = doc(_cuiDb, 'rooms', cuiCurrentRoomId);
        await updateDoc(roomRef, {
          members: arrayRemove(memberName)
        });

        // システムメッセージを送信
        await addDoc(collection(_cuiDb, `rooms/${cuiCurrentRoomId}/messages`), {
          text: `${cuiCurrentUserName} が ${memberName} をグループから削除しました。`,
          userName: 'システム',
          userEmail: 'system@furira.com',
          timestamp: serverTimestamp(),
          type: 'system'
        });

        // ローカル状態を更新
        cuiCurrentRoomMembers = cuiCurrentRoomMembers.filter(name => name !== memberName);
        cuiCurrentRoomMemberCount = cuiCurrentRoomMembers.length;

        renderMemberList();
        updateMemberIconsBar();

        console.log('[Member] メンバー削除完了:', memberName);
      } catch (error) {
        console.error('[Member] メンバー削除エラー:', error);
        alert('メンバーの削除に失敗しました');
      }
    }

    // 初回メッセージ読み込み完了フラグ（検索キーワード引き継ぎ用）

    // 既読ラベルだけを更新する関数（レイアウトシフト防止）
    function updateReadStatusOnly(msgId, readBy) {
      var msgElement = document.querySelector(`[data-message-id="${msgId}"]`);
      if (!msgElement) return;
      
      var readStatusEl = msgElement.querySelector('.message-read-status');
      if (!readStatusEl) return;
      
      var readCount = getReadCount(readBy);
      if (readCount > 0) {
        if (cuiCurrentRoomType === 'direct') {
          readStatusEl.textContent = '既読';
        } else {
          readStatusEl.textContent = `既読 ${readCount}`;
        }
        readStatusEl.style.visibility = 'visible';
      }
    }

    // ブロック状態をチェック（LINE風）
    async function checkBlockStatus() {
      // 個別チャット以外はブロック機能なし
      if (cuiCurrentRoomType !== 'direct' || !cuiCurrentUserEmail) {
        cuiIsBlockedByMe = false;
        cuiIsBlockedByOther = false;
        return;
      }

      try {
        // ルーム情報から相手のユーザー名を取得
        var roomRef = doc(_cuiDb, 'rooms', cuiCurrentRoomId);
        var roomDoc = await getDoc(roomRef);
        if (!roomDoc.exists()) return;

        var roomData = roomDoc.data();
        if (!roomData.members || !Array.isArray(roomData.members)) return;

        // メンバーにはユーザー名が入っている（メールではない）
        // currentUserNameと比較して相手を特定
        cuiOtherUserEmail = roomData.members.find(m => m !== cuiCurrentUserName) || '';
        console.log('[Block] 相手のユーザー名:', cuiOtherUserEmail);

        if (!cuiOtherUserEmail) return;

        // 自分が相手をブロックしているかチェック
        var myUserRef = doc(_cuiDb, 'users', cuiCurrentUserEmail);
        var myUserDoc = await getDoc(myUserRef);
        if (myUserDoc.exists()) {
          var myData = myUserDoc.data();
          var myBlockedList = myData.blockedUsers || [];

          // 自分自身がブロックリストに入っている場合はクリーンアップ
          var selfInList = myBlockedList.some(u => u === cuiCurrentUserName || u === cuiCurrentUserEmail);
          if (selfInList) {
            console.log('[Block] ⚠️ 自分自身がブロックリストに入っています。クリーンアップします...');
            // Firestoreから自分を削除
            await updateDoc(myUserRef, {
              blockedUsers: arrayRemove(cuiCurrentUserName)
            });
            await updateDoc(myUserRef, {
              blockedUsers: arrayRemove(cuiCurrentUserEmail)
            });
            // ローカルリストからも除外
            myBlockedList = myBlockedList.filter(u => u !== cuiCurrentUserName && u !== cuiCurrentUserEmail);
            console.log('[Block] ✅ 自分自身をブロックリストから削除しました');
          }

          cuiIsBlockedByMe = myBlockedList.includes(cuiOtherUserEmail);
          console.log('[Block] 自分→相手ブロック:', cuiIsBlockedByMe);
        }

        // 相手が自分をブロックしているかチェック
        // 注意: usersコレクションはメールアドレスをキーにしているため、
        // ユーザー名からは検索できない。isBlockedByOtherは常にfalse。
        // LINEと同様、ブロックされた側は気づかない仕様。
        cuiIsBlockedByOther = false;
        console.log('[Block] 相手→自分ブロック: チェック省略（メール不明）');

        // UIを更新
        updateBlockedUI();

      } catch (error) {
        console.error('[Block] ブロック状態チェックエラー:', error);
      }
    }

    // ブロック状態に応じたUI更新
    function updateBlockedUI() {
      var inputContainer = document.querySelector('.input-container');
      var blockedBanner = document.getElementById('blockedBanner');

      if (cuiIsBlockedByMe) {
        // 自分が相手をブロックしている場合
        // 入力欄を非表示、バナー表示
        if (inputContainer) inputContainer.style.display = 'none';
        if (blockedBanner) {
          blockedBanner.textContent = 'ブロック中のため、メッセージを送信できません';
          blockedBanner.style.display = 'flex';
        }
        console.log('[Block] UI更新: ブロック中表示');
      } else if (cuiIsBlockedByOther) {
        // 相手が自分をブロックしている場合（LINEと同様、明示的には表示しない）
        // 送信時にエラーにする
        console.log('[Block] UI更新: 相手にブロックされている（送信時に無効化）');
      } else {
        // ブロックなし - CSSのデフォルト表示に戻す
        if (inputContainer) inputContainer.style.display = '';
        if (blockedBanner) blockedBanner.style.display = 'none';
      }
    }

    // Firestoreメッセージをリアルタイムリスニング
    async function startListening() {
      // 既存リスナーを解除（二重登録防止）
      if (cuiUnsubscribeMessages) {
        try { cuiUnsubscribeMessages(); } catch(e) {}
        cuiUnsubscribeMessages = null;
      }

      // 先にブロック状態をチェック
      await checkBlockStatus();

      var q = query(
        collection(_cuiDb, `rooms/${cuiCurrentRoomId}/messages`),
        orderBy('timestamp', 'desc'),
        limit(50)
      );

      cuiUnsubscribeMessages = onSnapshot(q, (snapshot) => {
        console.log('[Firestore] メッセージ更新:', snapshot.size + '件');

        var container = document.getElementById('messagesContainer');
        var changes = snapshot.docChanges();

        // ========================================
        // 🔧 パフォーマンス改善: 差分レンダリング
        // 初回のみ全描画、以降はdocChanges()で差分更新
        // ========================================

        if (!cuiIsInitialLoad) {
          // --- 差分更新モード ---
          var hasNewMessages = false;
          var unreadMessageIds = [];

          changes.forEach(change => {
            var msgData = { id: change.doc.id, ...change.doc.data() };

            if (change.type === 'modified') {
              // 既読更新 or メッセージ編集 → DOM要素を更新
              updateReadStatusOnly(msgData.id, msgData.readBy);
            } else if (change.type === 'added') {
              // 新メッセージ → DOMに追加
              // ブロックチェック
              if (cuiIsBlockedByMe) {
                var blockedName = (cuiOtherUserEmail || '').trim().toLowerCase();
                var msgUserName = (msgData.userName || '').trim().toLowerCase();
                var msgUserEmail = (msgData.userEmail || '').trim().toLowerCase();
                if (blockedName === msgUserName || blockedName === msgUserEmail) {
                  return;
                }
              }

              // 日付セパレータチェック
              if (msgData.timestamp && msgData.timestamp.toDate) {
                var msgDate = msgData.timestamp.toDate();
                var dateStr = formatDateForSeparator(msgDate);
                // 最後の日付セパレータと異なれば追加
                var lastSep = container.querySelector('.date-separator:last-of-type');
                var lastSepText = lastSep?.textContent?.trim();
                if (dateStr !== lastSepText) {
                  appendDateSeparator(dateStr);
                }
              }

              appendMessage(msgData);
              hasNewMessages = true;

              // 未読チェック
              if (msgData.userEmail !== cuiCurrentUserEmail) {
                var readBy = msgData.readBy || [];
                if (!readBy.includes(cuiCurrentUserEmail)) {
                  unreadMessageIds.push(change.doc.id);
                }
              }
            } else if (change.type === 'removed') {
              // メッセージ削除 → DOM要素を削除
              var msgEl = container.querySelector(`[data-message-id="${msgData.id}"]`);
              if (msgEl) msgEl.remove();
            }
          });

          // 新メッセージがあった場合のみスクロール
          if (hasNewMessages) {
            // スクロールが最下部付近にある場合のみ自動スクロール
            var isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 100;
            if (isNearBottom) {
              container.scrollTop = container.scrollHeight;
            }

            // 固定日付バッジを更新
            setTimeout(() => { container.dispatchEvent(new Event('scroll')); }, 100);
          }

          // 未読処理
          if (unreadMessageIds.length > 0) {
            markMessagesAsRead(unreadMessageIds);
            resetUnreadCountRealtime();
          }
          clearAppBadge();
          return;
        }

        // --- 初回全描画モード ---
        console.log('[Firestore] 初回全体描画');
        cuiIsInitialLoad = false;
        container.innerHTML = '';

        // 新しい順で取得したので、逆順で表示
        var messages = [];
        var unreadMessageIds = [];
        snapshot.forEach((doc) => {
          var msgData = { id: doc.id, ...doc.data() };

          // ブロック中の相手からのメッセージはスキップ（LINE風）
          if (cuiIsBlockedByMe) {
            var blockedName = (cuiOtherUserEmail || '').trim().toLowerCase();
            var msgUserName = (msgData.userName || '').trim().toLowerCase();
            var msgUserEmail = (msgData.userEmail || '').trim().toLowerCase();

            if (blockedName === msgUserName || blockedName === msgUserEmail) {
              return;
            }
          }

          messages.unshift(msgData);

          // 自分以外のメッセージで、まだ自分が既読にしていないもの
          if (msgData.userEmail !== cuiCurrentUserEmail) {
            var readBy = msgData.readBy || [];
            if (!readBy.includes(cuiCurrentUserEmail)) {
              unreadMessageIds.push(doc.id);
            }
          }
        });

        // 日付セパレータを挿入しながらメッセージを表示
        var lastDateStr = null;
        messages.forEach((msg) => {
          if (msg.timestamp && msg.timestamp.toDate) {
            var msgDate = msg.timestamp.toDate();
            var dateStr = formatDateForSeparator(msgDate);
            if (dateStr !== lastDateStr) {
              appendDateSeparator(dateStr);
              lastDateStr = dateStr;
            }
          }
          appendMessage(msg);
        });

        // 最下部にスクロール
        container.scrollTop = container.scrollHeight;

        // 固定日付バッジを更新
        setTimeout(() => { container.dispatchEvent(new Event('scroll')); }, 100);

        // 未読メッセージがあれば既読にする
        if (unreadMessageIds.length > 0) {
          markMessagesAsRead(unreadMessageIds);
          resetUnreadCountRealtime();
        }
        clearAppBadge();

        // 初回読み込み時、検索キーワードが引き継がれていたら自動検索を実行
        if (cuiIsFirstMessageLoad && cuiSearchQueryParam) {
          cuiIsFirstMessageLoad = false;
          console.log('[Search] 検索キーワード引き継ぎ:', cuiSearchQueryParam);
          setTimeout(() => {
            openSearchMode();
            var searchInput = document.getElementById('searchInput');
            if (searchInput) {
              searchInput.value = cuiSearchQueryParam;
              searchMessages();
            }
          }, 300);
        } else if (cuiIsFirstMessageLoad) {
          cuiIsFirstMessageLoad = false;
        }
      }, (error) => {
        console.error('[Firestore] リスニングエラー:', error);
        alert('メッセージの受信に失敗しました: ' + error.message);
      });
    }

    // ファイルサイズをフォーマット
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      var k = 1024;
      var sizes = ['B', 'KB', 'MB', 'GB'];
      var i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // 日付セパレータ用のフォーマット（LINE風: 11/26(火)）
    function formatDateForSeparator(date) {
      var dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'];
      var month = date.getMonth() + 1;
      var day = date.getDate();
      var dow = dayOfWeek[date.getDay()];
      
      // 今日・昨日の判定
      var today = new Date();
      var yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      
      var isToday = date.toDateString() === today.toDateString();
      var isYesterday = date.toDateString() === yesterday.toDateString();
      
      if (isToday) {
        return '今日';
      } else if (isYesterday) {
        return '昨日';
      } else {
        return `${month}/${day}(${dow})`;
      }
    }

    // 日付セパレータをUIに追加
    function appendDateSeparator(dateStr) {
      var container = document.getElementById('messagesContainer');
      var separator = document.createElement('div');
      separator.className = 'date-separator';
      separator.dataset.date = dateStr; // スクロール監視用
      
      var badge = document.createElement('span');
      badge.className = 'date-separator-badge';
      badge.textContent = dateStr;
      
      separator.appendChild(badge);
      container.appendChild(separator);
    }

    // メッセージをUIに追加
    function appendMessage(msg) {
      var container = document.getElementById('messagesContainer');

      var item = document.createElement('div');

      // msg.userNameもJSON.parseして正規化（古いメッセージ対応）
      // senderNameがある場合はフォールバック（index.htmlのsendSystemChatMessage旧仕様対応）
      var messageUserName = msg.userName || msg.senderName;
      try {
        // ダブルクォートで囲まれている場合はパース
        if (typeof messageUserName === 'string' && messageUserName.startsWith('"') && messageUserName.endsWith('"')) {
          messageUserName = JSON.parse(messageUserName);
        }
      } catch (e) {
        // パースできない場合はそのまま使用
      }

      // 自分が削除したメッセージはスキップ（正規化したcurrentUserNameで判定）
      if (msg.deletedBy) {
        // deletedBy配列の各要素も正規化して比較
        var normalizedDeletedBy = msg.deletedBy.map(name => {
          try {
            if (typeof name === 'string' && name.startsWith('"') && name.endsWith('"')) {
              return JSON.parse(name);
            }
            return name;
          } catch (e) {
            return name;
          }
        });

        if (normalizedDeletedBy.includes(cuiCurrentUserName)) {
          return;
        }
      }

      // システムメッセージの場合は特別なレンダリング（LINE風センター配置）
      if (messageUserName === 'システム') {
        item.className = 'message-item message-item-system';
        item.dataset.messageId = msg.id;

        var systemContainer = document.createElement('div');
        systemContainer.className = 'system-message-container';

        // 時間
        var time = document.createElement('span');
        time.className = 'system-time';
        if (msg.timestamp && msg.timestamp.toDate) {
          var date = msg.timestamp.toDate();
          var hours = String(date.getHours()).padStart(2, '0');
          var minutes = String(date.getMinutes()).padStart(2, '0');
          time.textContent = `${hours}:${minutes}`;
        }
        systemContainer.appendChild(time);

        // メッセージバブル
        var bubble = document.createElement('div');
        bubble.className = 'system-bubble';
        bubble.textContent = msg.text || '';
        systemContainer.appendChild(bubble);

        item.appendChild(systemContainer);
        container.appendChild(item);
        return;
      }

      // 自分のメッセージか他人のメッセージかで分岐
      var isMine = messageUserName === cuiCurrentUserName;

      item.className = isMine ? 'message-item message-item-mine' : 'message-item message-item-other';
      item.dataset.messageId = msg.id;

      // チェックボックス（選択モード用）
      var checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'message-checkbox';
      checkbox.dataset.messageId = msg.id;
      checkbox.addEventListener('change', updateSelectionCount);
      item.appendChild(checkbox);

      // メッセージコンテント（アイコン + ラッパー）
      var content = document.createElement('div');
      content.className = 'message-content';

      // ユーザーアイコン（LINE風）- 相手のメッセージのみ表示
      if (!isMine) {
        var iconUrl = getUserIconUrl(messageUserName);
        if (iconUrl) {
          // アイコン画像がある場合
          var icon = document.createElement('img');
          icon.className = 'user-icon';
          icon.src = iconUrl;
          icon.alt = messageUserName || '匿名';
          icon.onerror = function() {
            // 画像読み込みエラー時はプレースホルダーに切り替え
            var placeholder = document.createElement('div');
            placeholder.className = 'user-icon-placeholder';
            placeholder.textContent = (messageUserName || '匿').charAt(0);
            placeholder.onclick = () => openProfilePopup(messageUserName, null);
            this.replaceWith(placeholder);
          };
          // クリックでプロフィールポップアップを開く
          icon.onclick = () => openProfilePopup(messageUserName, iconUrl);
          content.appendChild(icon);
        } else {
          // アイコン画像がない場合はプレースホルダー
          var placeholder = document.createElement('div');
          placeholder.className = 'user-icon-placeholder';
          placeholder.textContent = (messageUserName || '匿').charAt(0);
          // クリックでプロフィールポップアップを開く
          placeholder.onclick = () => openProfilePopup(messageUserName, null);
          content.appendChild(placeholder);
        }
      }

      // メッセージラッパー（バブル + 時間）
      var wrapper = document.createElement('div');
      wrapper.className = 'message-wrapper';

      // バブルコンテナ（ユーザー名 + バブル を縦に配置）
      var bubbleContainer = document.createElement('div');
      bubbleContainer.className = 'bubble-container';

      // グループチャット時、相手のメッセージにはユーザー名を表示
      if (!isMine && cuiCurrentRoomType !== 'direct') {
        var sender = document.createElement('div');
        sender.className = 'message-sender show-in-group';
        sender.textContent = messageUserName || '匿名';
        bubbleContainer.appendChild(sender);
      }

      // メッセージバブル
      var bubble = document.createElement('div');
      bubble.className = 'message-bubble';

      // リプライヘッダー（LINE風）
      if (msg.replyTo && msg.replyTo.userName) {
        var replyHeader = document.createElement('div');
        replyHeader.className = 'message-reply-header';

        // リプライ先のアイコン
        var replyIconUrl = msg.replyTo.userIcon || getUserIconUrl(msg.replyTo.userName);
        if (replyIconUrl) {
          var replyIcon = document.createElement('img');
          replyIcon.className = 'reply-header-icon';
          replyIcon.src = replyIconUrl;
          replyIcon.alt = msg.replyTo.userName;
          replyIcon.onerror = function() {
            var placeholder = document.createElement('div');
            placeholder.className = 'reply-header-icon-placeholder';
            placeholder.textContent = (msg.replyTo.userName || '?').charAt(0);
            this.replaceWith(placeholder);
          };
          replyHeader.appendChild(replyIcon);
        } else {
          var placeholder = document.createElement('div');
          placeholder.className = 'reply-header-icon-placeholder';
          placeholder.textContent = (msg.replyTo.userName || '?').charAt(0);
          replyHeader.appendChild(placeholder);
        }

        // リプライ先のコンテンツ
        var replyContent = document.createElement('div');
        replyContent.className = 'reply-header-content';

        var replyUser = document.createElement('div');
        replyUser.className = 'reply-header-user';
        replyUser.textContent = msg.replyTo.userName;

        var replyText = document.createElement('div');
        replyText.className = 'reply-header-text';
        replyText.textContent = msg.replyTo.text || '';

        replyContent.appendChild(replyUser);
        replyContent.appendChild(replyText);
        replyHeader.appendChild(replyContent);

        // リプライヘッダーをタップでリプライ元メッセージにジャンプ
        replyHeader.addEventListener('click', function(e) {
          e.stopPropagation(); // 長押しメニューが開かないように
          scrollToMessage(msg.replyTo.messageId);
        });

        bubble.appendChild(replyHeader);
      }

      // デバッグ: メッセージタイプを確認
      console.log('[Message] id:', msg.id, 'type:', msg.type, 'voiceUrl:', msg.voiceUrl, 'text:', msg.text?.substring(0, 20));

      // 取り消し済みメッセージの場合
      if (msg.deleted === true) {
        bubble.classList.add('deleted');
        var text = document.createElement('div');
        text.className = 'message-text';
        text.textContent = 'メッセージが取り消されました';
        bubble.appendChild(text);
      }
      // 画像メッセージの場合
      else if (msg.type === 'image' && msg.fileUrl) {
        var img = document.createElement('img');
        img.className = 'message-image';
        img.src = msg.fileUrl;
        img.alt = msg.fileName || '画像';
        img.loading = 'lazy';
        // 画像クリックで画像ビューアーを表示
        img.onclick = function() {
          openImageViewer(msg.fileUrl);
        };
        bubble.appendChild(img);

        // キャプション（テキストがある場合）
        if (msg.text && msg.text.trim()) {
          var caption = document.createElement('div');
          caption.className = 'message-text';
          caption.textContent = msg.text;
          bubble.appendChild(caption);
        }
      }
      // ファイルメッセージの場合
      else if (msg.type === 'file' && msg.fileUrl) {
        var fileLink = document.createElement('a');
        fileLink.className = 'message-file-link';
        fileLink.href = msg.fileUrl;
        fileLink.target = '_blank';
        fileLink.download = msg.fileName || 'file';

        // ファイルアイコン
        var fileIcon = document.createElement('div');
        fileIcon.className = 'message-file-icon';
        fileIcon.innerHTML = '<i class="bi bi-file-earmark-fill"></i>';

        // ファイル情報
        var fileInfo = document.createElement('div');
        fileInfo.className = 'message-file-info';

        var fileName = document.createElement('div');
        fileName.className = 'message-file-name';
        fileName.textContent = msg.fileName || 'ファイル';

        var fileSize = document.createElement('div');
        fileSize.className = 'message-file-size';
        fileSize.textContent = formatFileSize(msg.fileSize || 0);

        fileInfo.appendChild(fileName);
        fileInfo.appendChild(fileSize);

        fileLink.appendChild(fileIcon);
        fileLink.appendChild(fileInfo);
        bubble.appendChild(fileLink);

        // キャプション（テキストがある場合）
        if (msg.text && msg.text.trim()) {
          var caption = document.createElement('div');
          caption.className = 'message-text';
          caption.textContent = msg.text;
          bubble.appendChild(caption);
        }
      }
      // 音声メッセージの場合
      else if (msg.type === 'voice' && msg.voiceUrl) {
        console.log('[Voice] 音声メッセージ表示:', msg.id, msg.voiceUrl, msg.voiceDuration);
        var voiceContainer = document.createElement('div');
        voiceContainer.className = 'voice-message' + (isMine ? ' sent' : '');
        
        // 再生ボタン
        var playBtn = document.createElement('button');
        playBtn.className = 'voice-play-btn';
        playBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
        playBtn.dataset.voiceUrl = msg.voiceUrl;
        playBtn.dataset.msgId = msg.id;
        playBtn.onclick = function(e) {
          e.stopPropagation();
          toggleVoicePlayback(msg.voiceUrl, msg.id, playBtn);
        };
        
        // 音声情報
        var voiceInfo = document.createElement('div');
        voiceInfo.className = 'voice-info';
        
        // 波形（簡易表示）
        var waveform = document.createElement('div');
        waveform.className = 'voice-waveform';
        // ランダムな高さの波形バーを生成
        var barHeights = [12, 18, 24, 16, 20, 14, 22, 18, 12, 16, 20, 24, 18, 14];
        barHeights.forEach(h => {
          var bar = document.createElement('div');
          bar.className = 'voice-waveform-bar';
          bar.style.height = h + 'px';
          waveform.appendChild(bar);
        });
        
        // 再生時間
        var duration = document.createElement('span');
        duration.className = 'voice-duration';
        duration.id = 'voiceDuration_' + msg.id;
        var mins = Math.floor((msg.voiceDuration || 0) / 60);
        var secs = (msg.voiceDuration || 0) % 60;
        duration.textContent = mins + ':' + String(secs).padStart(2, '0');
        
        voiceInfo.appendChild(waveform);
        voiceInfo.appendChild(duration);
        
        voiceContainer.appendChild(playBtn);
        voiceContainer.appendChild(voiceInfo);
        bubble.appendChild(voiceContainer);
      }
      // ノート共有メッセージの場合
      else if (msg.type === 'note-share' && msg.noteShareData) {
        var noteCard = document.createElement('div');
        noteCard.className = 'note-share-card';
        noteCard.onclick = function() {
          window.open(msg.noteShareData.url, '_blank');
        };

        // ノートアイコン
        var noteIcon = document.createElement('div');
        noteIcon.className = 'note-share-icon';
        noteIcon.innerHTML = '<i class="bi bi-journal-text"></i>';
        noteCard.appendChild(noteIcon);

        // ノート情報
        var noteInfo = document.createElement('div');
        noteInfo.className = 'note-share-info';

        var noteLabel = document.createElement('div');
        noteLabel.className = 'note-share-label';
        noteLabel.textContent = 'ノートを共有しました';

        var noteTitle = document.createElement('div');
        noteTitle.className = 'note-share-title';
        noteTitle.textContent = msg.noteShareData.title || '無題のノート';

        noteInfo.appendChild(noteLabel);
        noteInfo.appendChild(noteTitle);
        noteCard.appendChild(noteInfo);

        // 矢印アイコン
        var noteArrow = document.createElement('div');
        noteArrow.className = 'note-share-arrow';
        noteArrow.innerHTML = '<i class="bi bi-chevron-right"></i>';
        noteCard.appendChild(noteArrow);

        bubble.appendChild(noteCard);
      }
      // 通話履歴メッセージの場合
      else if (msg.type === 'call') {
        var callCard = document.createElement('div');
        callCard.className = 'call-history-card';

        // 通話アイコン（シンプルな黒）
        var callIcon = document.createElement('div');
        callIcon.className = 'call-history-icon';
        callIcon.innerHTML = '<i class="bi bi-telephone-fill"></i>';
        callCard.appendChild(callIcon);

        // 通話情報
        var callInfo = document.createElement('div');
        callInfo.className = 'call-history-info';

        var callLabel = document.createElement('div');
        callLabel.className = 'call-history-label';
        callLabel.textContent = '通話終了';

        var callDuration = document.createElement('div');
        callDuration.className = 'call-history-duration';
        // 通話時間を表示
        if (msg.callDuration) {
          var minutes = Math.floor(msg.callDuration / 60);
          var seconds = msg.callDuration % 60;
          callDuration.textContent = minutes > 0 ? `${minutes}分${seconds}秒` : `${seconds}秒`;
        } else {
          // 古い形式のメッセージからパース
          var match = (msg.text || '').match(/\((.+)\)/);
          callDuration.textContent = match ? match[1] : '';
        }

        callInfo.appendChild(callLabel);
        callInfo.appendChild(callDuration);
        callCard.appendChild(callInfo);

        bubble.appendChild(callCard);
      }
      // テキストメッセージの場合
      else {
        var text = document.createElement('div');
        text.className = 'message-text';
        // メンションがある場合はハイライト表示
        if (msg.mentions && msg.mentions.length > 0) {
          text.innerHTML = highlightMentions(msg.text || '', msg.mentions);
        } else {
          text.textContent = msg.text || '';
        }
        bubble.appendChild(text);
      }

      // 時間（LINE風：時:分のみ）
      var time = document.createElement('span');
      time.className = 'message-time';
      if (msg.timestamp && msg.timestamp.toDate) {
        var date = msg.timestamp.toDate();
        var hours = String(date.getHours()).padStart(2, '0');
        var minutes = String(date.getMinutes()).padStart(2, '0');
        time.textContent = `${hours}:${minutes}`;
      } else {
        var date = new Date();
        var hours = String(date.getHours()).padStart(2, '0');
        var minutes = String(date.getMinutes()).padStart(2, '0');
        time.textContent = `${hours}:${minutes}`;
      }

      // メタ情報コンテナ（既読 + 時間）
      var meta = document.createElement('div');
      meta.className = 'message-meta';

      // 既読表示（自分のメッセージのみ）- バブルの左側に配置
      // レイアウトシフト防止のため、常にスペースを確保
      if (isMine) {
        var readStatus = document.createElement('span');
        readStatus.className = 'message-read-status';
        var readCount = getReadCount(msg.readBy);
        if (readCount > 0) {
          // ダイレクトチャットは「既読」、グループは「既読 N」
          if (cuiCurrentRoomType === 'direct') {
            readStatus.textContent = '既読';
          } else {
            readStatus.textContent = `既読 ${readCount}`;
          }
        } else {
          // 未読時は空白を表示してスペースを確保（visibility: hiddenで非表示だが領域確保）
          readStatus.textContent = '既読';
          readStatus.style.visibility = 'hidden';
        }
        meta.appendChild(readStatus);
      }

      meta.appendChild(time);
      
      // バブルをバブルコンテナに追加
      bubbleContainer.appendChild(bubble);
      
      // 自分のメッセージ: メタ情報→バブルコンテナ（左から右）
      // 相手のメッセージ: バブルコンテナ→メタ情報（左から右）
      if (isMine) {
        wrapper.appendChild(meta);
        wrapper.appendChild(bubbleContainer);
      } else {
        wrapper.appendChild(bubbleContainer);
        wrapper.appendChild(meta);
      }

      content.appendChild(wrapper);
      item.appendChild(content);

      // 長押しイベントリスナーを追加
      console.log('[Message] Adding long press listener for message:', msg.id);
      addLongPressListener(item, msg.id, msg.text || '', isMine, msg.fileUrl || null, msg.fileName || null, messageUserName || '');

      container.appendChild(item);
    }

    // 送信ボタンの有効/無効を更新
    function updateSendButtonState() {
      var input = document.getElementById('messageInput');
      var sendBtn = document.getElementById('sendButton');
      if (!input || !sendBtn) return;

      var hasText = input.value.trim().length > 0;
      var hasImages = cuiSelectedImageFiles && cuiSelectedImageFiles.length > 0;
      sendBtn.disabled = !(hasText || hasImages);
    }

    // メッセージ送信
    window.sendMessage = async function() {
      console.log('[sendMessage] 関数呼び出し開始');

      // ブロックチェック（LINE風：相手にブロックされている場合は無言で送信失敗）
      if (cuiIsBlockedByOther) {
        console.log('[sendMessage] 相手にブロックされているため送信スキップ');
        // 入力欄をクリアして送信したように見せる（LINE風）
        var input = document.getElementById('messageInput');
        if (input) {
          input.value = '';
          cuiInsertedMentions = [];
          clearMentionTags();
          updateSendButtonState();
        }
        return;
      }

      var input = document.getElementById('messageInput');
      var textMessage = getPlainText(input).trim();

      // タグからメンションを取得してテキストに結合
      var mentionTexts = cuiInsertedMentions.map(m => '@' + m.userName).join(' ');
      var message = mentionTexts ? (mentionTexts + ' ' + textMessage).trim() : textMessage;

      console.log('[sendMessage] textMessage:', textMessage);
      console.log('[sendMessage] mentionTexts:', mentionTexts);
      console.log('[sendMessage] message:', message);
      console.log('[sendMessage] cuiSelectedImageFiles:', cuiSelectedImageFiles.length, '枚');
      console.log('[sendMessage] cuiCurrentUserName:', cuiCurrentUserName);
      console.log('[sendMessage] cuiCurrentRoomId:', cuiCurrentRoomId);

      // ユーザー名チェック
      if (!cuiCurrentUserName) {
        console.error('[sendMessage] ユーザー名未設定');
        alert('ユーザー名を選択してください');
        return;
      }

      // roomIdチェック
      if (!cuiCurrentRoomId) {
        console.error('[sendMessage] ルームID未設定');
        alert('ルームIDが設定されていません');
        return;
      }

      // 画像が選択されている場合は画像送信（複数対応）
      if (cuiSelectedImageFiles.length > 0) {
        console.log('[Send] 画像送信モード開始 -', cuiSelectedImageFiles.length, '枚');
        var sendButton = document.getElementById('sendButton');
        sendButton.disabled = true;

        try {
          // 最初の画像にはキャプション（テキスト）を付ける
          // 2枚目以降はキャプションなし
          for (let i = 0; i < cuiSelectedImageFiles.length; i++) {
            var file = cuiSelectedImageFiles[i];
            var caption = (i === 0) ? message : '';
            console.log('[Send] 画像送信中:', i + 1, '/', cuiSelectedImageFiles.length, file.name);
            await uploadAndSendFile(file, 'image', caption);
          }
          console.log('[Send] 全画像送信完了');
        } catch (error) {
          console.error('[Send] 画像送信エラー:', error);
          alert('画像の送信に失敗しました: ' + error.message);
          sendButton.disabled = false;
          return;
        }

        // プレビューをクリア
        cuiSelectedImageFiles = [];
        updateImagePreview();

        // 入力欄クリア
        input.value = '';
        cuiInsertedMentions = []; // 挿入済みメンションもリセット
        clearMentionTags(); // メンションタグもクリア
        updateSendButtonState(); // 送信後は無効化

        return;
      }

      // テキストのみの場合
      if (!message) {
        return;
      }

      try {
        console.log('[Firestore] メッセージ送信中...');

        // メンションを解析
        var mentions = parseMentions(message);
        console.log('[Mention] 検出されたメンション:', mentions);

        // @Allが含まれる場合、全メンバーを通知対象に展開
        if (mentions.includes('All')) {
          // 自分以外の全メンバーをmentionsに追加
          var allMembers = cuiCurrentRoomMembers.filter(m => m !== cuiCurrentUserName);
          // 'All'は残しつつ、全メンバーも追加（重複排除）
          mentions = [...new Set([...mentions, ...allMembers])];
          console.log('[Mention] @All展開後:', mentions);
        }

        // メッセージを送信（サブコレクション）
        var messageData = {
          text: message,
          userName: cuiCurrentUserName,
          userEmail: cuiCurrentUserEmail, // Firebase Functions 高速化用
          timestamp: serverTimestamp(),
          deleted: []
        };

        // メンションがある場合は追加
        if (mentions.length > 0) {
          messageData.mentions = mentions;
        }

        // リプライ情報がある場合は追加（LINE風）
        if (cuiCurrentReplyTo) {
          messageData.replyTo = {
            messageId: cuiCurrentReplyTo.messageId,
            userName: cuiCurrentReplyTo.userName,
            text: cuiCurrentReplyTo.text.length > 100 
              ? cuiCurrentReplyTo.text.substring(0, 100) + '...' 
              : cuiCurrentReplyTo.text,
            userIcon: cuiCurrentReplyTo.userIcon || null
          };
          console.log('[Reply] リプライ情報を追加:', messageData.replyTo);
        }

        await addDoc(collection(_cuiDb, `rooms/${cuiCurrentRoomId}/messages`), messageData);

        console.log('[Firestore] メッセージ送信完了');

        // roomsコレクションのlastMessageを更新
        var roomRef = doc(_cuiDb, 'rooms', cuiCurrentRoomId);
        await updateDoc(roomRef, {
          lastMessage: message,
          lastMessageAt: serverTimestamp(),
          lastMessageBy: cuiCurrentUserName
        });

        console.log('[Firestore] ルーム情報更新完了');

        // 🔧 v297: 未読カウント更新とプッシュ通知はFirebase Functions (onChatMessageCreated) に任せる
        // クライアント側での更新は削除（Firebase Functionsと重複するため）

        // 入力欄クリア
        input.value = '';
        cuiInsertedMentions = []; // 挿入済みメンションもリセット
        clearMentionTags(); // メンションタグもクリア
        updateSendButtonState(); // 送信後は無効化

        // リプライプレビューをクリア
        cancelReply();

      } catch (error) {
        console.error('[Firestore] 送信エラー:', error);
        alert('メッセージの送信に失敗しました: ' + error.message);
      }
    };

    // 添付メニュー切り替え
    window.toggleAttachmentMenu = function() {
      var menu = document.getElementById('attachmentMenu');
      var btn = document.getElementById('toggleMenuBtn');

      if (menu.style.display === 'none') {
        menu.style.display = 'block';
        btn.classList.add('active');
      } else {
        menu.style.display = 'none';
        btn.classList.remove('active');
      }
    };

    // 画像選択
    window.selectImage = function() {
      document.getElementById('imageInput').click();
    };

    // ファイル選択（音声メッセージに置き換え済みのため未使用）
    window.selectFile = function() {
      document.getElementById('fileInput').click();
      // メニューを閉じる
      document.getElementById('attachmentMenu').style.display = 'none';
      document.getElementById('toggleMenuBtn').classList.remove('active');
    };

    // ========== 音声メッセージ機能 ==========

    // 録音開始
    window.startVoiceRecording = async function() {
      // メニューを閉じる
      document.getElementById('attachmentMenu').style.display = 'none';
      document.getElementById('toggleMenuBtn').classList.remove('active');

      // iOS判定（PWAでMediaRecorderが正常動作しないため）
      var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
        (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      
      if (isIOS) {
        alert('申し訳ありません。音声メッセージ機能はiOSでは現在対応しておりません。\n\nAndroid端末またはPCのChromeブラウザからご利用ください。');
        return;
      }

      try {
        // マイクの許可を取得
        cuiVoiceAudioStream = await navigator.mediaDevices.getUserMedia({
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            sampleRate: 44100
          }
        });

        // MediaRecorderを作成
        // iOS Safariでサポートされる形式を確認
        var testTypes = [
          'audio/mp4',
          'audio/aac',
          'audio/mpeg',
          'audio/mp4;codecs=mp4a.40.2',
          'audio/webm',
          'audio/webm;codecs=opus',
          'audio/ogg',
          'audio/ogg;codecs=opus',
          'audio/wav',
          ''  // デフォルト
        ];
        console.log('[Voice] MediaRecorder サポート形式チェック:');
        testTypes.forEach(type => {
          if (type) {
            console.log(`  ${type}: ${MediaRecorder.isTypeSupported(type)}`);
          }
        });
        
        // mimeTypeを指定せずにMediaRecorderを作成（ブラウザのデフォルトを使用）
        // iOS Safariではこの方法が最も互換性が高い
        var recorderOptions = {};
        
        // 優先順位でサポートされる形式を探す
        var preferredTypes = [
          'audio/mp4',
          'audio/aac', 
          'audio/mp4;codecs=mp4a.40.2',
          'audio/webm;codecs=opus',
          'audio/webm'
        ];
        
        for (vartype of preferredTypes) {
          if (MediaRecorder.isTypeSupported(type)) {
            recorderOptions.mimeType = type;
            break;
          }
        }
        
        // サポートされる形式が見つからない場合はデフォルトを使用
        if (recorderOptions.mimeType) {
          console.log('[Voice] 選択された録音形式:', recorderOptions.mimeType);
          cuiVoiceMediaRecorder = new MediaRecorder(cuiVoiceAudioStream, recorderOptions);
        } else {
          console.log('[Voice] デフォルト形式を使用');
          cuiVoiceMediaRecorder = new MediaRecorder(cuiVoiceAudioStream);
        }
        console.log('[Voice] 実際のmimeType:', cuiVoiceMediaRecorder.mimeType);
        cuiVoiceAudioChunks = [];

        cuiVoiceMediaRecorder.ondataavailable = (event) => {
          console.log('[Voice] ondataavailable:', event.data.size, 'bytes');
          if (event.data.size > 0) {
            cuiVoiceAudioChunks.push(event.data);
          }
        };

        // 録音開始（iOSではtimesliceを指定しない方が安定）
        cuiVoiceMediaRecorder.start(); // stop()時にまとめてデータを取得
        cuiVoiceRecordingStartTime = Date.now();

        // オーバーレイを表示
        document.getElementById('voiceRecordingOverlay').style.display = 'flex';

        // タイマー更新開始
        cuiVoiceRecordingTimer = setInterval(updateVoiceRecordingTime, 100);

      } catch (error) {
        console.error('[Voice] マイク許可エラー:', error);
        if (error.name === 'NotAllowedError') {
          alert('マイクの使用が許可されていません。設定からマイクへのアクセスを許可してください。');
        } else {
          alert('録音を開始できませんでした: ' + error.message);
        }
      }
    };

    // 録音時間更新
    function updateVoiceRecordingTime() {
      if (!cuiVoiceRecordingStartTime) return;
      var elapsed = Math.floor((Date.now() - cuiVoiceRecordingStartTime) / 1000);
      var minutes = Math.floor(elapsed / 60);
      var seconds = elapsed % 60;
      document.getElementById('voiceRecordingTime').textContent =
        `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    // 録音キャンセル
    window.cancelVoiceRecording = function() {
      if (cuiVoiceMediaRecorder && cuiVoiceMediaRecorder.state !== 'inactive') {
        cuiVoiceMediaRecorder.stop();
      }
      cleanupVoiceRecording();
      document.getElementById('voiceRecordingOverlay').style.display = 'none';
    };

    // 録音クリーンアップ
    function cleanupVoiceRecording() {
      if (cuiVoiceRecordingTimer) {
        clearInterval(cuiVoiceRecordingTimer);
        cuiVoiceRecordingTimer = null;
      }
      if (cuiVoiceAudioStream) {
        cuiVoiceAudioStream.getTracks().forEach(track => track.stop());
        cuiVoiceAudioStream = null;
      }
      cuiVoiceMediaRecorder = null;
      cuiVoiceAudioChunks = [];
      cuiVoiceRecordingStartTime = null;
      document.getElementById('voiceRecordingTime').textContent = '0:00';
    }

    // 音声メッセージ送信
    window.sendVoiceMessage = async function() {
      if (!cuiVoiceMediaRecorder || cuiVoiceMediaRecorder.state === 'inactive') {
        alert('録音データがありません');
        return;
      }

      var duration = Math.floor((Date.now() - cuiVoiceRecordingStartTime) / 1000);

      // 録音を停止してBlobを取得
      cuiVoiceMediaRecorder.stop();

      // onstopイベントを待つ
      cuiVoiceMediaRecorder.onstop = async () => {
        try {
          var mimeType = cuiVoiceMediaRecorder.mimeType;
          var audioBlob = new Blob(cuiVoiceAudioChunks, { type: mimeType });

          // 最小録音時間チェック（1秒未満は送信しない）
          if (duration < 1) {
            alert('録音時間が短すぎます');
            cleanupVoiceRecording();
            document.getElementById('voiceRecordingOverlay').style.display = 'none';
            return;
          }

          console.log('[Voice] 録音完了:', audioBlob.size, 'bytes, duration:', duration, 's');

          // Firebase Storageにアップロード（拡張子を形式から決定）
          console.log('[Voice] 保存するmimeType:', mimeType);
          var extension = 'm4a'; // デフォルト
          if (mimeType.includes('webm')) extension = 'webm';
          else if (mimeType.includes('ogg')) extension = 'ogg';
          else if (mimeType.includes('mp4') || mimeType.includes('m4a') || mimeType.includes('aac') || mimeType.includes('mpeg')) extension = 'm4a';
          var fileName = `voice_${Date.now()}.${extension}`;
          var storageRef = ref(_cuiStorage, `chat/${cuiCurrentRoomId}/voice/${fileName}`);

          var snapshot = await uploadBytes(storageRef, audioBlob);
          console.log('[Voice] アップロード完了:', snapshot.metadata.fullPath);

          var downloadURL = await getDownloadURL(storageRef);
          console.log('[Voice] URL取得完了:', downloadURL);

          // Firestoreにメッセージを保存
          await addDoc(collection(_cuiDb, 'rooms', cuiCurrentRoomId, 'messages'), {
            type: 'voice',
            voiceUrl: downloadURL,
            voiceDuration: duration,
            voiceMimeType: mimeType,
            sender: cuiCurrentUserEmail,
            senderName: cuiCurrentUserName,
            timestamp: serverTimestamp(),
            readBy: [cuiCurrentUserEmail]
          });

          console.log('[Voice] メッセージ保存完了');

          // roomsコレクションのlastMessageを更新（チャット一覧に反映）
          var roomRef = doc(_cuiDb, 'rooms', cuiCurrentRoomId);
          await updateDoc(roomRef, {
            lastMessage: '音声メッセージ',
            lastMessageAt: serverTimestamp(),
            lastMessageBy: cuiCurrentUserName
          });

          console.log('[Voice] ルーム情報更新完了');

        } catch (error) {
          console.error('[Voice] 送信エラー:', error);
          alert('音声メッセージの送信に失敗しました: ' + error.message);
        } finally {
          cleanupVoiceRecording();
          document.getElementById('voiceRecordingOverlay').style.display = 'none';
        }
      };
    };

    // 音声メッセージ再生用のAudioオブジェクト管理

    // 音声メッセージの再生/一時停止
    window.toggleVoicePlayback = function(voiceUrl, msgId, playBtn) {
      // 同じメッセージを再度クリックした場合は再生/一時停止を切り替え
      if (cuiCurrentVoiceMsgId === msgId && cuiCurrentVoiceAudio) {
        if (cuiCurrentVoiceAudio.paused) {
          cuiCurrentVoiceAudio.play();
          playBtn.classList.add('playing');
          playBtn.innerHTML = '<i class="bi bi-pause-fill"></i>';
        } else {
          cuiCurrentVoiceAudio.pause();
          playBtn.classList.remove('playing');
          playBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
        }
        return;
      }

      // 別のメッセージの音声が再生中の場合は停止
      if (cuiCurrentVoiceAudio) {
        cuiCurrentVoiceAudio.pause();
        cuiCurrentVoiceAudio = null;
        if (cuiCurrentVoiceButton) {
          cuiCurrentVoiceButton.classList.remove('playing');
          cuiCurrentVoiceButton.innerHTML = '<i class="bi bi-play-fill"></i>';
        }
      }

      // 新しい音声を再生
      console.log('[Voice] 再生開始:', voiceUrl);
      
      var audio = new Audio();
      
      // 形式チェック（webmがサポートされているか）
      var isWebm = voiceUrl.includes('.webm');
      if (isWebm) {
        var canPlayWebm = audio.canPlayType('audio/webm');
        console.log('[Voice] webm対応:', canPlayWebm);
        if (!canPlayWebm || canPlayWebm === '') {
          alert('このデバイスではwebm形式の音声を再生できません。録音したデバイスで再生してください。');
          return;
        }
      }
      
      audio.src = voiceUrl;
      cuiCurrentVoiceAudio = audio;
      cuiCurrentVoiceButton = playBtn;
      cuiCurrentVoiceMsgId = msgId;

      playBtn.classList.add('playing');
      playBtn.innerHTML = '<i class="bi bi-pause-fill"></i>';

      audio.play().catch(err => {
        console.error('[Voice] 再生エラー:', err.name, err.message);
        alert('音声の再生に失敗しました: ' + err.message);
        playBtn.classList.remove('playing');
        playBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
        cuiCurrentVoiceAudio = null;
        cuiCurrentVoiceButton = null;
        cuiCurrentVoiceMsgId = null;
      });

      // 再生完了時
      audio.onended = function() {
        playBtn.classList.remove('playing');
        playBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
        cuiCurrentVoiceAudio = null;
        cuiCurrentVoiceButton = null;
        cuiCurrentVoiceMsgId = null;
      };

      // エラー時
      audio.onerror = function(e) {
        console.error('[Voice] 音声読み込みエラー:', audio.error?.code, audio.error?.message);
        playBtn.classList.remove('playing');
        playBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
        cuiCurrentVoiceAudio = null;
        cuiCurrentVoiceButton = null;
        cuiCurrentVoiceMsgId = null;
      };
    };

    // カメラ起動
    window.openCamera = function() {
      document.getElementById('cameraInput').click();
    };

    // 画面外タップで添付メニューを閉じる
    document.addEventListener('click', function(e) {
      var menu = document.getElementById('attachmentMenu');
      var btn = document.getElementById('toggleMenuBtn');
      if (menu && menu.style.display !== 'none') {
        if (!menu.contains(e.target) && !btn.contains(e.target)) {
          menu.style.display = 'none';
          btn.classList.remove('active');
        }
      }
    });

    // 画像選択時の処理
    // 選択中の画像ファイルを保持
    // 複数画像対応

    window.handleImageSelect = function(event) {
      var files = Array.from(event.target.files);
      if (!files.length) return;

      console.log('[Image] 画像選択:', files.length, '枚');

      // ファイルサイズチェック（10MB制限）
      var maxSize = 10 * 1024 * 1024; // 10MB
      var validFiles = [];

      for (varfile of files) {
        if (file.size > maxSize) {
          alert(`${file.name} は10MBを超えています。スキップします。`);
          continue;
        }
        validFiles.push(file);
      }

      if (!validFiles.length) {
        event.target.value = '';
        return;
      }

      // 最大枚数チェック
      var totalCount = cuiSelectedImageFiles.length + validFiles.length;
      if (totalCount > CUI_MAX_IMAGES) {
        alert(`画像は最大${CUI_MAX_IMAGES}枚までです。現在${cuiSelectedImageFiles.length}枚選択中です。`);
        var allowedCount = CUI_MAX_IMAGES - cuiSelectedImageFiles.length;
        validFiles.splice(allowedCount);
      }

      // 選択した画像を追加
      cuiSelectedImageFiles = [...cuiSelectedImageFiles, ...validFiles];
      console.log('[Image] 合計選択枚数:', cuiSelectedImageFiles.length);

      // プレビュー表示を更新
      updateImagePreview();

      // 送信ボタンの状態を更新
      updateSendButtonState();

      // input をリセット（同じファイルを再選択可能にする）
      event.target.value = '';
    };

    // プレビュー表示を更新する関数
    function updateImagePreview() {
      var container = document.getElementById('imagePreviewContainer');
      var list = document.getElementById('imagePreviewList');
      var countBadge = document.getElementById('imagePreviewCount');

      // リストをクリア
      list.innerHTML = '';

      if (cuiSelectedImageFiles.length === 0) {
        container.style.display = 'none';
        return;
      }

      // 各画像のプレビューを作成
      cuiSelectedImageFiles.forEach((file, index) => {
        var item = document.createElement('div');
        item.className = 'image-preview-item';
        item.dataset.index = index;

        var img = document.createElement('img');
        var reader = new FileReader();
        reader.onload = function(e) {
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);

        var removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
        removeBtn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          removeImageAtIndex(index);
        };

        item.appendChild(img);
        item.appendChild(removeBtn);
        list.appendChild(item);
      });

      // 枚数バッジを更新
      countBadge.textContent = `${cuiSelectedImageFiles.length}枚`;
      countBadge.style.display = cuiSelectedImageFiles.length > 1 ? 'inline-flex' : 'none';

      container.style.display = 'block';
      console.log('[Image] プレビュー表示更新完了');
    }

    // 指定インデックスの画像を削除
    function removeImageAtIndex(index) {
      console.log('[Image] 画像削除:', index);
      cuiSelectedImageFiles.splice(index, 1);
      updateImagePreview();
      updateSendButtonState();
    }

    // すべての画像をクリア
    function clearAllImages() {
      cuiSelectedImageFiles = [];
      updateImagePreview();
      updateSendButtonState();
    }

    // ファイル選択時の処理
    window.handleFileSelect = async function(event) {
      var file = event.target.files[0];
      if (!file) return;

      console.log('[File] ファイル選択:', file.name, file.size, 'bytes');
      await uploadAndSendFile(file, 'file');

      // input をリセット
      event.target.value = '';
    };

    // カメラ撮影時の処理
    window.handleCameraCapture = async function(event) {
      var file = event.target.files[0];
      if (!file) return;

      console.log('[Camera] 撮影完了:', file.name, file.size, 'bytes');
      await uploadAndSendFile(file, 'image');

      // input をリセット
      event.target.value = '';
    };

    // ファイルアップロード＆送信（共通関数）
    async function uploadAndSendFile(file, type, caption = '') {
      console.log('[uploadAndSendFile] 関数呼び出し:', { file, type, caption });
      console.log('[uploadAndSendFile] storage:', storage);
      console.log('[uploadAndSendFile] cuiCurrentRoomId:', cuiCurrentRoomId);

      try {
        // ファイルサイズチェック（10MB制限）
        var maxSize = 10 * 1024 * 1024; // 10MB
        if (file.size > maxSize) {
          console.error('[uploadAndSendFile] ファイルサイズ超過:', file.size);
          alert('ファイルサイズは10MB以下にしてください');
          return;
        }

        console.log('[Upload] アップロード開始:', file.name, 'size:', file.size);

        // Firebase Storageにアップロード
        var storageRef = ref(_cuiStorage, `chat/${cuiCurrentRoomId}/${Date.now()}_${file.name}`);
        var snapshot = await uploadBytes(storageRef, file);
        console.log('[Upload] アップロード完了:', snapshot.metadata.fullPath);

        // ダウンロードURLを取得
        var downloadURL = await getDownloadURL(storageRef);
        console.log('[Upload] URL取得完了:', downloadURL);

        // Firestoreにメッセージを保存
        var messageData = {
          text: caption || '', // キャプション（テキスト）
          userName: cuiCurrentUserName,
          userEmail: cuiCurrentUserEmail, // Firebase Functions 高速化用
          timestamp: serverTimestamp(),
          deleted: [],
          type: type, // 'image' or 'file'
          fileUrl: downloadURL,
          fileName: file.name,
          fileSize: file.size,
          mimeType: file.type
        };

        await addDoc(collection(_cuiDb, `rooms/${cuiCurrentRoomId}/messages`), messageData);
        console.log('[Upload] メッセージ送信完了');

        // roomsコレクションのlastMessageを更新
        var roomRef = doc(_cuiDb, 'rooms', cuiCurrentRoomId);
        await updateDoc(roomRef, {
          lastMessage: caption || '画像を送信しました',
          lastMessageAt: serverTimestamp(),
          lastMessageBy: cuiCurrentUserName
        });
        console.log('[Upload] ルーム情報更新完了');

        // 🔧 v297: 未読カウント更新とプッシュ通知はFirebase Functions (onChatMessageCreated) に任せる

      } catch (error) {
        console.error('[Upload] エラー:', error);
        alert('アップロードに失敗しました: ' + error.message);
      }
    }

    // 🔧 v297: この関数はFirebase Functionsと重複するため使用停止
    // Firebase Functions (onChatMessageCreated) が未読カウントを更新する
    async function updateUnreadCountsForOthers() {
      try {
        // ルーム情報を取得
        var roomRef = doc(_cuiDb, `rooms/${cuiCurrentRoomId}`);
        var roomSnap = await getDoc(roomRef);

        if (!roomSnap.exists()) return;

        var roomData = roomSnap.data();
        // memberEmailsを使用（DM/グループチャット対応）
        // memberEmailsがない場合はmembersにフォールバック（旧形式互換）
        var memberEmails = roomData.memberEmails || roomData.members || [];

        console.log('[Unread] メンバーメール一覧:', memberEmails, '自分:', cuiCurrentUserEmail);

        // 自分以外のメンバーの未読カウントを+1
        for (varmemberEmail of memberEmails) {
          if (memberEmail !== cuiCurrentUserEmail) {
            var unreadRef = doc(_cuiDb, `rooms/${cuiCurrentRoomId}/unreadCounts/${memberEmail}`);
            await setDoc(unreadRef, {
              userId: memberEmail,
              unreadCount: increment(1),
              lastUpdatedAt: serverTimestamp()
            }, { merge: true });
            console.log('[Unread] +1:', memberEmail);
          }
        }

        console.log('[Unread] 未読カウント更新完了');
      } catch (error) {
        console.error('[Unread] 未読カウント更新エラー:', error);
      }
    }

    // 🔧 v296: Cloudflare Worker経由でプッシュ通知を送信（Firebase Functions不要）
    async function sendChatPushNotification(message, roomName) {
      try {
        console.log('[Push] チャット通知送信開始');

        // ルーム情報を取得
        var roomRef = doc(_cuiDb, `rooms/${cuiCurrentRoomId}`);
        var roomSnap = await getDoc(roomRef);
        if (!roomSnap.exists()) {
          console.log('[Push] ルームが見つかりません');
          return;
        }

        var roomData = roomSnap.data();
        var memberEmails = roomData.memberEmails || [];

        if (memberEmails.length === 0) {
          console.log('[Push] メンバーメールがありません');
          return;
        }

        // 自分以外のメンバーのFCMトークンを取得
        var tokens = [];
        for (varmemberEmail of memberEmails) {
          if (memberEmail === cuiCurrentUserEmail) continue; // 自分はスキップ

          // 閲覧中チェック
          try {
            var viewingRef = doc(_cuiDb, 'viewingStatus', memberEmail);
            var viewingSnap = await getDoc(viewingRef);
            if (viewingSnap.exists()) {
              var viewingData = viewingSnap.data();
              if (viewingData.roomId === cuiCurrentRoomId) {
                var lastUpdated = viewingData.lastUpdated?.toMillis?.() || 0;
                var now = Date.now();
                if ((now - lastUpdated) < 5 * 60 * 1000) { // 5分以内
                  console.log('[Push] 閲覧中のためスキップ:', memberEmail);
                  continue;
                }
              }
            }
          } catch (e) {
            // viewingStatus取得エラーは無視
          }

          // デバイスからFCMトークンを取得
          try {
            var devicesRef = collection(_cuiDb, `users/${memberEmail}/devices`);
            var devicesQuery = query(devicesRef, where('active', '==', true));
            var devicesSnap = await getDocs(devicesQuery);

            devicesSnap.forEach(deviceDoc => {
              var deviceData = deviceDoc.data();
              if (deviceData.fcmToken) {
                tokens.push(deviceData.fcmToken);
                console.log('[Push] トークン取得:', memberEmail, deviceData.fcmToken.substring(0, 20) + '...');
              }
            });
          } catch (e) {
            console.error('[Push] デバイス取得エラー:', memberEmail, e);
          }
        }

        if (tokens.length === 0) {
          console.log('[Push] 送信先トークンがありません');
          return;
        }

        console.log('[Push] 送信先トークン数:', tokens.length);

        // Cloudflare Worker経由でプッシュ送信
        var displayRoomName = roomName || roomData.name || '個別チャット';
        var response = await fetch('https://reborn-fcm-worker.mercari-yasuhirotakuji.workers.dev/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tokens: tokens,
            title: `💬 ${displayRoomName}`,
            body: `${cuiCurrentUserName}: ${message.substring(0, 100)}`,
            data: {
              type: 'chat_message',
              roomId: cuiCurrentRoomId,
              senderName: cuiCurrentUserName
            }
          })
        });

        var result = await response.json().catch(() => ({}));
        console.log('[Push] 送信結果:', result);

      } catch (error) {
        console.error('[Push] チャット通知送信エラー:', error);
        // 通知送信失敗してもメッセージ送信自体は成功させる
      }
    }

    // 他のルームの未読数合計を取得して戻るボタンに表示
    async function loadOtherRoomsUnreadCount() {
      if (!cuiCurrentUserEmail) {
        console.log('[Back Unread] ユーザーメールがないためスキップ');
        return;
      }

      try {
        console.log('[Back Unread] 他のルームの未読数取得開始');

        // 全ルームを取得
        var roomsSnapshot = await getDocs(collection(_cuiDb, 'rooms'));
        var totalUnread = 0;

        // 各ルームの未読数を取得（現在のルームを除く）
        for (var roomDoc of roomsSnapshot.docs) {
          if (roomDoc.id === cuiCurrentRoomId) continue; // 現在のルームはスキップ

          var unreadRef = doc(_cuiDb, `rooms/${roomDoc.id}/unreadCounts/${cuiCurrentUserEmail}`);
          var unreadDoc = await getDoc(unreadRef);

          if (unreadDoc.exists()) {
            var unreadData = unreadDoc.data();
            var count = unreadData.unreadCount || 0;
            if (count > 0) {
              totalUnread += count;
            }
          }
        }

        console.log('[Back Unread] 合計未読数:', totalUnread);

        // 戻るボタンに表示
        var backUnreadEl = document.getElementById('backUnreadCount');
        if (backUnreadEl) {
          if (totalUnread > 0) {
            backUnreadEl.textContent = totalUnread > 99 ? '99+' : totalUnread.toString();
          } else {
            backUnreadEl.textContent = '';
          }
        }
      } catch (error) {
        console.error('[Back Unread] エラー:', error);
      }
    }

    // ================================================================================
    // メッセージ検索機能
    // ================================================================================

    // 検索モードを開く
    window.openSearchMode = function() {
      document.getElementById('headerNormal').style.display = 'none';
      document.getElementById('headerSearch').style.display = 'flex';
      document.getElementById('searchInput').focus();
    };

    // 検索モードを閉じる
    window.closeSearchMode = function() {
      document.getElementById('headerNormal').style.display = 'flex';
      document.getElementById('headerSearch').style.display = 'none';
      clearSearch();
    };

    // 検索をクリア
    window.clearSearch = function() {
      document.getElementById('searchInput').value = '';
      document.getElementById('searchClearBtn').style.display = 'none';
      document.getElementById('searchNavButtons').style.display = 'none';

      // ハイライトを削除
      removeAllHighlights();
      cuiSearchResults = [];
      cuiCurrentSearchIndex = -1;
    };

    // ハイライトを全て削除
    function removeAllHighlights() {
      var container = document.getElementById('messagesContainer');
      var highlights = container.querySelectorAll('.search-highlight, .search-highlight-current');
      highlights.forEach(el => {
        var parent = el.parentNode;
        parent.replaceChild(document.createTextNode(el.textContent), el);
        parent.normalize();
      });
    }

    // メッセージを検索
    window.searchMessages = function() {
      var query = document.getElementById('searchInput').value.trim().toLowerCase();

      // クリアボタンの表示切替
      document.getElementById('searchClearBtn').style.display = query ? 'flex' : 'none';

      // 以前のハイライトを削除
      removeAllHighlights();
      cuiSearchResults = [];
      cuiCurrentSearchIndex = -1;

      if (!query) {
        document.getElementById('searchNavButtons').style.display = 'none';
        return;
      }

      // メッセージ要素を検索
      var container = document.getElementById('messagesContainer');
      var messageElements = container.querySelectorAll('.message-bubble');

      messageElements.forEach((msgEl, index) => {
        var textContent = msgEl.textContent.toLowerCase();
        if (textContent.includes(query)) {
          // テキストをハイライト
          highlightText(msgEl, query);
          cuiSearchResults.push(msgEl);
        }
      });

      // 検索結果の表示
      var navButtons = document.getElementById('searchNavButtons');
      var countEl = document.getElementById('searchCount');

      if (cuiSearchResults.length > 0) {
        navButtons.style.display = 'flex';
        cuiCurrentSearchIndex = 0;
        updateSearchNavigation();
        scrollToCurrentResult();
      } else {
        navButtons.style.display = 'flex';
        countEl.textContent = '0/0';
      }
    };

    // テキストをハイライト
    function highlightText(element, query) {
      var walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
      var textNodes = [];

      while (walker.nextNode()) {
        textNodes.push(walker.currentNode);
      }

      textNodes.forEach(node => {
        var text = node.textContent;
        var lowerText = text.toLowerCase();
        var index = lowerText.indexOf(query);

        if (index !== -1) {
          var before = text.substring(0, index);
          var match = text.substring(index, index + query.length);
          var after = text.substring(index + query.length);

          var span = document.createElement('span');
          span.className = 'search-highlight';
          span.textContent = match;

          var fragment = document.createDocumentFragment();
          if (before) fragment.appendChild(document.createTextNode(before));
          fragment.appendChild(span);
          if (after) fragment.appendChild(document.createTextNode(after));

          node.parentNode.replaceChild(fragment, node);
        }
      });
    }

    // 検索ナビゲーションを更新
    function updateSearchNavigation() {
      var countEl = document.getElementById('searchCount');
      countEl.textContent = `${cuiCurrentSearchIndex + 1}/${cuiSearchResults.length}`;

      // 全てのハイライトをリセット
      document.querySelectorAll('.search-highlight-current').forEach(el => {
        el.className = 'search-highlight';
      });

      // 現在の結果をハイライト
      if (cuiSearchResults[cuiCurrentSearchIndex]) {
        var currentHighlight = cuiSearchResults[cuiCurrentSearchIndex].querySelector('.search-highlight');
        if (currentHighlight) {
          currentHighlight.className = 'search-highlight-current';
        }
      }
    }

    // 現在の検索結果にスクロール
    function scrollToCurrentResult() {
      if (cuiSearchResults[cuiCurrentSearchIndex]) {
        cuiSearchResults[cuiCurrentSearchIndex].scrollIntoView({
          behavior: 'smooth',
          block: 'center'
        });
      }
    }

    // 検索結果をナビゲート
    window.navigateSearch = function(direction) {
      if (cuiSearchResults.length === 0) return;

      if (direction === 'next') {
        cuiCurrentSearchIndex = (cuiCurrentSearchIndex + 1) % cuiSearchResults.length;
      } else {
        cuiCurrentSearchIndex = (cuiCurrentSearchIndex - 1 + cuiSearchResults.length) % cuiSearchResults.length;
      }

      updateSearchNavigation();
      scrollToCurrentResult();
    };

    // チャット一覧に戻る（LINE風）
    window.goBackToList = async function() {
      console.log('========================================');
      console.log('[Navigation] 🔙 チャット一覧に戻る - 関数実行開始');
      console.log('[Navigation] cuiIsPWA:', cuiIsPWA);
      console.log('========================================');

      if (cuiIsPWA) {
        // PWA版: Firestoreで親ウィンドウに通知
        try {
          console.log('[Navigation] ========== goBackToList開始 ==========');
          console.log('[Navigation] 戻る方式: Firestore');
          console.log('[Navigation] 🔍 sessionIdParam:', sessionIdParam);

          // Firestoreのnavigationコレクションに書き込み
          await setDoc(doc(_cuiDb, 'navigation', 'chatControl'), {
            action: 'goBackToList',
            sessionId: sessionIdParam,
            timestamp: serverTimestamp(),
            from: 'chat_iframe'
          });

          console.log('[Navigation] ✅ Firestore書き込み成功');
          console.log('[Navigation] ========== goBackToList完了 ==========');

        } catch (error) {
          console.error('[Navigation] ❌ Firestoreエラー:', error);
          console.error('[Navigation] error.stack:', error.stack);

          // フォールバック: history.back()
          console.warn('[Navigation] フォールバック: history.back()');
          window.history.back();
        }
      } else {
        // GAS版: メニュー画面に戻る
        console.log('[Navigation] GAS版: google.script.run 呼び出し');
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          google.script.run.showChatRoomsList();
        } else {
          console.error('[Navigation] google.script.run が利用できません');
        }
      }
    };

    // メッセージ削除（論理削除 - 自分の画面からのみ削除）
    async function deleteMessage(messageId) {
      // ユーザー名チェック
      if (!cuiCurrentUserName) {
        alert('ユーザー名を選択してください');
        return;
      }

      if (!confirm('このメッセージを削除しますか？')) {
        return;
      }

      try {
        console.log('[Firestore] メッセージ削除中...', messageId);
        console.log('[Firestore] 削除ユーザー:', cuiCurrentUserName);

        var messageRef = doc(_cuiDb, 'messages', messageId);
        var messageDoc = await getDoc(messageRef);

        if (!messageDoc.exists()) {
          console.error('[Firestore] メッセージが存在しません');
          return;
        }

        var messageData = messageDoc.data();
        // deletedBy が配列でない場合も考慮して、確実に配列化
        var deletedByArray = messageData.deletedBy;
        if (!Array.isArray(deletedByArray)) {
          deletedByArray = [];
        }

        // 自分のユーザー名を deletedBy 配列に追加
        if (!deletedByArray.includes(cuiCurrentUserName)) {
          deletedByArray.push(cuiCurrentUserName);
        }

        await updateDoc(messageRef, {
          deletedBy: deletedByArray,
          lastDeletedAt: serverTimestamp()
        });

        console.log('[Firestore] メッセージ削除完了（自分の画面からのみ）');

      } catch (error) {
        console.error('[Firestore] 削除エラー:', error);
        alert('メッセージの削除に失敗しました: ' + error.message);
      }
    }

    // 選択削除モードの切り替え
    window.toggleSelectionMode = function() {
      var container = document.getElementById('messagesContainer');
      var bar = document.getElementById('selectionModeBar');

      if (container.classList.contains('selection-mode')) {
        // 選択モード終了
        container.classList.remove('selection-mode');
        bar.classList.remove('active');

        // すべてのチェックボックスをクリア
        var checkboxes = document.querySelectorAll('.message-checkbox');
        checkboxes.forEach(cb => cb.checked = false);
        updateSelectionCount();
      } else {
        // 選択モード開始
        container.classList.add('selection-mode');
        bar.classList.add('active');
      }
    };

    // 選択カウント更新
    function updateSelectionCount() {
      var checkboxes = document.querySelectorAll('.message-checkbox:checked');
      var count = checkboxes.length;
      document.getElementById('selectedCount').textContent = count;
    }

    // 選択したメッセージを一括削除（自分の画面からのみ削除）
    window.deleteSelectedMessages = async function() {
      var checkboxes = document.querySelectorAll('.message-checkbox:checked');

      if (checkboxes.length === 0) {
        alert('削除するメッセージを選択してください');
        return;
      }

      if (!confirm(`${checkboxes.length}件のメッセージを削除しますか？`)) {
        return;
      }

      try {
        console.log('[Firestore] 一括削除開始:', checkboxes.length + '件');

        // 並列で削除処理
        var deletePromises = Array.from(checkboxes).map(async (checkbox) => {
          var messageId = checkbox.dataset.messageId;
          var messageRef = doc(_cuiDb, 'messages', messageId);
          var messageDoc = await getDoc(messageRef);

          if (messageDoc.exists()) {
            var messageData = messageDoc.data();
            // deletedBy が配列でない場合も考慮して、確実に配列化
            var deletedByArray = messageData.deletedBy;
            if (!Array.isArray(deletedByArray)) {
              deletedByArray = [];
            }

            // 自分のユーザー名を deletedBy 配列に追加
            if (!deletedByArray.includes(cuiCurrentUserName)) {
              deletedByArray.push(cuiCurrentUserName);
            }

            await updateDoc(messageRef, {
              deletedBy: deletedByArray,
              lastDeletedAt: serverTimestamp()
            });
          }
        });

        await Promise.all(deletePromises);

        console.log('[Firestore] 一括削除完了（自分の画面からのみ）');

        // 選択モード終了
        toggleSelectionMode();

      } catch (error) {
        console.error('[Firestore] 一括削除エラー:', error);
        alert('メッセージの削除に失敗しました: ' + error.message);
      }
    };

    // 長押しメニュー関連

    // 長押しメニューを開く（メッセージの近くに表示）
    function openContextMenu(messageId, messageText, targetElement, isMine = false, fileUrl = null, fileName = null, senderName = null) {
      console.log('[ContextMenu] Opening menu for message:', messageId, 'isMine:', isMine);
      cuiContextMenuData.messageId = messageId;
      cuiContextMenuData.messageText = messageText;
      cuiContextMenuData.isMine = isMine;
      cuiContextMenuData.item = targetElement;
      cuiContextMenuData.fileUrl = fileUrl;
      cuiContextMenuData.fileName = fileName;
      cuiContextMenuData.senderName = senderName;

      // 送信取り消しボタンの表示/非表示（自分のメッセージのみ表示）
      var unsendBtn = document.getElementById('contextMenuUnsend');
      var deleteBtn = document.getElementById('contextMenuDelete');
      unsendBtn.style.display = isMine ? 'flex' : 'none';
      // 送信取消が非表示の場合、削除ボタンの右ボーダーを消す
      deleteBtn.style.borderRight = isMine ? '1px solid #e5e7eb' : 'none';

      var menu = document.getElementById('contextMenu');
      var overlay = document.getElementById('contextMenuOverlay');

      console.log('[ContextMenu] Menu element:', menu);
      console.log('[ContextMenu] Overlay element:', overlay);

      // メニュー表示（位置計算のため一時的に表示）
      menu.style.display = 'block';
      menu.style.opacity = '0';

      // メッセージ要素の位置を取得
      var rect = targetElement.getBoundingClientRect();
      var menuRect = menu.getBoundingClientRect();

      console.log('[ContextMenu] Target rect:', rect);
      console.log('[ContextMenu] Menu rect:', menuRect);

      // メニューをメッセージの上部中央に配置
      var top = rect.top - menuRect.height - 10; // メッセージの上に10px隙間
      var left = rect.left + (rect.width / 2) - (menuRect.width / 2); // 中央揃え

      // 画面上部にはみ出す場合はメッセージの下に表示
      if (top < 10) {
        top = rect.bottom + 10;
      }

      // 画面左右にはみ出さないように調整
      if (left < 10) {
        left = 10;
      } else if (left + menuRect.width > window.innerWidth - 10) {
        left = window.innerWidth - menuRect.width - 10;
      }

      // 位置を設定
      menu.style.top = top + 'px';
      menu.style.left = left + 'px';

      console.log('[ContextMenu] Final position - top:', top, 'left:', left);

      // メニュー表示（アニメーション付き）
      overlay.classList.add('active');
      menu.classList.add('active');

      // CSSのtransitionを有効にするため、次のフレームでopacityをリセット
      setTimeout(() => {
        menu.style.opacity = '1';
      }, 10);

      console.log('[ContextMenu] Menu classes:', menu.className);
      console.log('[ContextMenu] Overlay classes:', overlay.className);
    }

    // 長押しメニューを閉じる
    window.closeContextMenu = function() {
      var menu = document.getElementById('contextMenu');
      var overlay = document.getElementById('contextMenuOverlay');

      overlay.classList.remove('active');
      menu.classList.remove('active');

      // 次回のために opacity を 0 に戻す
      setTimeout(() => {
        menu.style.opacity = '0';
      }, 200); // transitionの時間（0.2s）後に実行

      cuiContextMenuData = { messageId: null, messageText: null, item: null, fileUrl: null, fileName: null, senderName: null };
    };

    // コンテキストメニューボタンのイベントリスナー設定
    // タッチ用
    document.getElementById('contextMenuCopy').addEventListener('touchend', function(e) {
      e.preventDefault();
      e.stopPropagation();
      copyMessage();
    });
    document.getElementById('contextMenuReply').addEventListener('touchend', function(e) {
      e.preventDefault();
      e.stopPropagation();
      replyMessage();
    });
    document.getElementById('contextMenuForward').addEventListener('touchend', function(e) {
      e.preventDefault();
      e.stopPropagation();
      forwardMessage();
    });
    document.getElementById('contextMenuDelete').addEventListener('touchend', function(e) {
      e.preventDefault();
      e.stopPropagation();
      deleteMessageFromMenu();
    });
    document.getElementById('contextMenuUnsend').addEventListener('touchend', function(e) {
      e.preventDefault();
      e.stopPropagation();
      unsendMessage();
    });
    document.getElementById('contextMenuKeep').addEventListener('touchend', function(e) {
      e.preventDefault();
      e.stopPropagation();
      saveToKeep();
    });

    // PC用: クリックイベントも追加
    document.getElementById('contextMenuCopy').addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      copyMessage();
    });
    document.getElementById('contextMenuReply').addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      replyMessage();
    });
    document.getElementById('contextMenuForward').addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      forwardMessage();
    });
    document.getElementById('contextMenuDelete').addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      deleteMessageFromMenu();
    });
    document.getElementById('contextMenuUnsend').addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      unsendMessage();
    });
    document.getElementById('contextMenuKeep').addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      saveToKeep();
    });

    // コピー機能
    window.copyMessage = function() {
      if (!cuiContextMenuData.messageText) return;

      // クリップボードにコピー
      navigator.clipboard.writeText(cuiContextMenuData.messageText)
        .then(() => {
          console.log('[Copy] メッセージをコピーしました');
          closeContextMenu();
        })
        .catch(err => {
          console.error('[Copy] コピーエラー:', err);
          // フォールバック: textareaを使った古い方法
          var textarea = document.createElement('textarea');
          textarea.value = cuiContextMenuData.messageText;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          closeContextMenu();
        });
    };

    // Keepに保存機能
    window.saveToKeep = async function() {
      if (!cuiContextMenuData.messageText && !cuiContextMenuData.fileUrl) {
        console.log('[Keep] 保存するコンテンツがありません');
        return;
      }

      if (!cuiCurrentUserName) {
        alert('ユーザー情報が取得できません');
        return;
      }

      // データを保存してからメニューを閉じる
      var messageText = cuiContextMenuData.messageText;
      var fileUrl = cuiContextMenuData.fileUrl;
      var fileName = cuiContextMenuData.fileName;
      var senderName = cuiContextMenuData.senderName || '不明';

      closeContextMenu();

      try {
        // 既存のKeepメモルームを検索
        var q = query(
          collection(_cuiDb, 'rooms'),
          where('type', '==', 'keep'),
          where('createdBy', '==', cuiCurrentUserName)
        );
        var snapshot = await getDocs(q);

        var keepRoomId;

        if (!snapshot.empty) {
          // 既存のKeepメモルームがある場合
          keepRoomId = snapshot.docs[0].id;
          console.log('[Keep] 既存のKeepメモルームを使用:', keepRoomId);
        } else {
          // Keepメモルームを新規作成
          console.log('[Keep] Keepメモルームを新規作成');
          var newRoom = await addDoc(collection(_cuiDb, 'rooms'), {
            name: 'Keepメモ',
            icon: '',
            createdBy: cuiCurrentUserName,
            createdAt: serverTimestamp(),
            lastMessageAt: serverTimestamp(),
            lastMessageText: '',
            lastMessageSender: '',
            members: [cuiCurrentUserName],
            type: 'keep'
          });
          keepRoomId = newRoom.id;
          console.log('[Keep] Keepメモルーム作成完了:', keepRoomId);
        }

        // 保存するメッセージの内容を構築
        var keepMessage = '';
        if (messageText) {
          keepMessage = `${senderName}さんのメッセージ:\n${messageText}`;
        } else if (fileUrl) {
          keepMessage = `${senderName}さんのファイル`;
        }

        // Keepメモルームにメッセージを保存
        var messageData = {
          text: keepMessage,
          userName: cuiCurrentUserName,
          userEmail: cuiCurrentUserEmail || '',
          timestamp: serverTimestamp(),
          deleted: []
        };

        // 画像/ファイルがある場合は添付
        if (fileUrl) {
          messageData.fileUrl = fileUrl;
          messageData.fileName = fileName || 'ファイル';
          messageData.type = 'file';
        }

        await addDoc(collection(_cuiDb, 'rooms', keepRoomId, 'messages'), messageData);

        // Keepルームの最終メッセージを更新
        await updateDoc(doc(_cuiDb, 'rooms', keepRoomId), {
          lastMessageAt: serverTimestamp(),
          lastMessageText: messageText || '（ファイル）',
          lastMessageSender: cuiCurrentUserName
        });

        console.log('[Keep] メッセージをKeepに保存しました');

        // Keepドット表示のためにlocalStorageを更新
        localStorage.setItem('keepDotActive', 'true');

        // 成功通知（簡易トースト）
        showKeepToast('Keepに保存しました');

      } catch (error) {
        console.error('[Keep] 保存エラー:', error);
        alert('Keepへの保存に失敗しました: ' + error.message);
      }
    };

    // Keep保存完了トースト表示
    function showKeepToast(message) {
      var toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 24px;
        border-radius: 24px;
        font-size: 14px;
        z-index: 10000;
        animation: fadeInOut 2s ease-in-out;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 2000);
    }

    // リプライ機能（LINE風）
    window.replyMessage = function() {
      if (!cuiContextMenuData.messageText && !cuiContextMenuData.fileUrl) return;

      // closeContextMenu()の前にデータを保存
      var messageId = cuiContextMenuData.messageId;
      var messageText = cuiContextMenuData.messageText || '（画像）';
      var senderName = cuiContextMenuData.senderName || '不明';

      // 送信者のアイコンURLを取得
      var senderIcon = getUserIconUrl(senderName);

      closeContextMenu();

      // リプライ情報を保存
      cuiCurrentReplyTo = {
        messageId: messageId,
        userName: senderName,
        text: messageText,
        userIcon: senderIcon
      };

      // リプライプレビューを表示
      showReplyPreview();

      // 入力欄にフォーカス
      var messageInput = document.getElementById('messageInput');
      messageInput.focus();
    };

    // リプライプレビュー表示
    function showReplyPreview() {
      if (!cuiCurrentReplyTo) return;

      var preview = document.getElementById('replyPreview');
      var iconContainer = document.getElementById('replyPreviewIcon');
      var userElement = document.getElementById('replyPreviewUser');
      var textElement = document.getElementById('replyPreviewText');

      // アイコン設定
      iconContainer.innerHTML = '';
      if (cuiCurrentReplyTo.userIcon) {
        var img = document.createElement('img');
        img.className = 'reply-preview-icon';
        img.src = cuiCurrentReplyTo.userIcon;
        img.alt = cuiCurrentReplyTo.userName;
        img.onerror = function() {
          var placeholder = document.createElement('div');
          placeholder.className = 'reply-preview-icon-placeholder';
          placeholder.textContent = (cuiCurrentReplyTo.userName || '?').charAt(0);
          this.replaceWith(placeholder);
        };
        iconContainer.appendChild(img);
      } else {
        var placeholder = document.createElement('div');
        placeholder.className = 'reply-preview-icon-placeholder';
        placeholder.textContent = (cuiCurrentReplyTo.userName || '?').charAt(0);
        iconContainer.appendChild(placeholder);
      }

      // ユーザー名とテキスト設定
      userElement.textContent = cuiCurrentReplyTo.userName;
      textElement.textContent = cuiCurrentReplyTo.text.length > 50
        ? cuiCurrentReplyTo.text.substring(0, 50) + '...'
        : cuiCurrentReplyTo.text;

      // プレビュー表示
      preview.classList.add('active');

      // 入力エリアのborder-radius調整
      adjustInputBorderRadius();
    }

    // リプライキャンセル
    window.cancelReply = function() {
      cuiCurrentReplyTo = null;
      var preview = document.getElementById('replyPreview');
      preview.classList.remove('active');

      // 入力エリアのborder-radius調整
      adjustInputBorderRadius();
    };

    // 入力エリアのborder-radius調整
    function adjustInputBorderRadius() {
      var replyPreview = document.getElementById('replyPreview');
      var mentionTags = document.getElementById('mentionTags');
      var messageInput = document.getElementById('messageInput');

      var hasReply = replyPreview.classList.contains('active');
      var hasMentions = mentionTags.classList.contains('has-tags');

      if (hasReply && hasMentions) {
        messageInput.style.borderRadius = '0 0 20px 20px';
        mentionTags.style.borderRadius = '0';
      } else if (hasReply) {
        messageInput.style.borderRadius = '0 0 20px 20px';
      } else if (hasMentions) {
        messageInput.style.borderRadius = '0 0 20px 20px';
      } else {
        messageInput.style.borderRadius = '20px';
      }
    }

    // リプライ元メッセージにジャンプ（揺れるアニメーション付き）
    function scrollToMessage(messageId) {
      if (!messageId) return;

      // メッセージ要素を検索
      var targetMessage = document.querySelector(`.message-item[data-message-id="${messageId}"]`);
      
      if (targetMessage) {
        // メッセージコンテナを取得
        var messagesContainer = document.getElementById('messagesContainer');
        
        // 手動でスクロール位置を計算（scrollIntoViewを使わない）
        var containerRect = messagesContainer.getBoundingClientRect();
        var targetRect = targetMessage.getBoundingClientRect();
        var currentScrollTop = messagesContainer.scrollTop;
        
        // ターゲットを中央に配置するスクロール位置を計算
        var targetCenter = targetRect.top - containerRect.top + currentScrollTop - (containerRect.height / 2) + (targetRect.height / 2);
        
        // 即座にスクロール
        messagesContainer.scrollTop = targetCenter;

        // 揺れアニメーション
        requestAnimationFrame(() => {
          targetMessage.classList.remove('highlight-shake');
          void targetMessage.offsetWidth;
          targetMessage.classList.add('highlight-shake');

          setTimeout(() => {
            targetMessage.classList.remove('highlight-shake');
          }, 600);
        });
      } else {
        console.log('[Reply Jump] メッセージが見つかりません:', messageId);
      }
    }

    // 送信取り消し機能（LINE方式）
    window.unsendMessage = async function() {
      if (!cuiContextMenuData.messageId) return;
      if (!cuiContextMenuData.isMine) {
        alert('自分のメッセージのみ取り消しできます');
        return;
      }

      // closeContextMenu()の前にデータを保存
      var messageId = cuiContextMenuData.messageId;
      var messageItem = cuiContextMenuData.item;

      closeContextMenu();

      // 確認ダイアログ
      if (!confirm('このメッセージを取り消しますか？')) {
        return;
      }

      try {
        console.log('[Unsend] 送信取り消し開始:', messageId);

        // Firestoreのメッセージを更新（deleted: trueフラグを追加）
        var messageRef = doc(_cuiDb, 'rooms', cuiCurrentRoomId, 'messages', messageId);
        await updateDoc(messageRef, {
          deleted: true,
          deletedAt: serverTimestamp(),
          originalText: cuiContextMenuData.messageText || '', // 元のテキストを保存（管理用）
          text: null,
          type: 'deleted',
          fileUrl: null,
          fileName: null
        });

        console.log('[Unsend] 送信取り消し完了');

        // UIを即座に更新（onSnapshotで自動更新されるが、念のため）
        if (messageItem) {
          var bubble = messageItem.querySelector('.message-bubble');
          if (bubble) {
            bubble.classList.add('deleted');
            bubble.innerHTML = '<div class="message-text">メッセージが取り消されました</div>';
          }
        }

      } catch (error) {
        console.error('[Unsend] 送信取り消しエラー:', error);
        alert('送信取り消しに失敗しました: ' + error.message);
      }
    };

    // 転送機能

    window.forwardMessage = async function() {
      if (!cuiContextMenuData.messageText && !cuiContextMenuData.fileUrl) return;

      // データを保存
      cuiForwardMessageData = {
        text: cuiContextMenuData.messageText,
        fileUrl: cuiContextMenuData.fileUrl || null,
        fileName: cuiContextMenuData.fileName || null,
        originalSender: cuiContextMenuData.senderName || ''
      };

      closeContextMenu();
      openForwardModal();
    };

    async function openForwardModal() {
      var overlay = document.getElementById('forwardModalOverlay');
      var modal = document.getElementById('forwardModal');
      var roomList = document.getElementById('forwardRoomList');

      // ローディング表示
      roomList.innerHTML = '<div class="forward-loading"><i class="bi bi-arrow-repeat spin"></i> 読み込み中...</div>';

      overlay.classList.add('active');
      setTimeout(() => modal.classList.add('active'), 10);

      try {
        // 全ルームを取得
        var roomsSnapshot = await getDocs(collection(_cuiDb, 'rooms'));
        var rooms = [];

        roomsSnapshot.forEach(roomDoc => {
          // 現在のルームは除外
          if (roomDoc.id === cuiCurrentRoomId) return;

          var data = roomDoc.data();
          var members = data.members || [];
          var roomType = data.type || '';

          // アクセス可能なルームかチェック
          // 1. システムルーム（type未設定 or 'group'）は全員アクセス可能
          // 2. 個別チャット（type='direct'）は自分がメンバーの場合のみ
          var isSystemRoom = !roomType || roomType === 'group' || roomType === 'system';
          var isMember = members.includes(cuiCurrentUserEmail) || members.includes(cuiCurrentUserName);

          if (!isSystemRoom && !isMember) return;

          // 表示名を決定（個別チャットは相手の名前を表示）
          var displayName = data.name || 'チャットルーム';
          if (roomType === 'direct' && members.length > 0) {
            // 自分以外のメンバー名を取得
            var otherMember = members.find(m => m !== cuiCurrentUserName && m !== cuiCurrentUserEmail);
            if (otherMember) {
              displayName = otherMember;
            }
          }

          rooms.push({
            id: roomDoc.id,
            name: displayName,
            members: members,
            type: roomType,
            icon: data.icon || null
          });
        });

        // ルーム一覧を表示
        if (rooms.length === 0) {
          roomList.innerHTML = '<div class="forward-loading">転送先がありません</div>';
          return;
        }

        roomList.innerHTML = rooms.map(room => {
          var iconHtml;

          if (room.type === 'direct') {
            // 個別チャットの場合は相手のアイコンを取得
            var iconUrl = getUserIconUrl(room.name);
            var initial = (room.name || '?').charAt(0);
            iconHtml = iconUrl
              ? `<img src="${iconUrl}" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`
              : `<span style="font-size:18px;font-weight:600;color:#fff;">${initial}</span>`;
          } else if (room.icon) {
            // システムルームで絵文字アイコンがある場合
            iconHtml = `<span style="font-size:24px;">${room.icon}</span>`;
          } else {
            // デフォルトアイコン
            iconHtml = `<i class="bi bi-chat-dots"></i>`;
          }

          return `
            <div class="forward-room-item" onclick="executeForward('${room.id}', '${room.name.replace(/'/g, "\\'")}')">
              <div class="forward-room-icon">
                ${iconHtml}
              </div>
              <div class="forward-room-info">
                <div class="forward-room-name">${room.name}</div>
              </div>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('[Forward] ルーム取得エラー:', error);
        roomList.innerHTML = '<div class="forward-loading">エラーが発生しました</div>';
      }
    }

    window.closeForwardModal = function() {
      var overlay = document.getElementById('forwardModalOverlay');
      var modal = document.getElementById('forwardModal');

      modal.classList.remove('active');
      setTimeout(() => {
        overlay.classList.remove('active');
      }, 300);
    };

    // ========== ノート一覧モーダル ==========
    window.openNoteListModal = async function() {
      console.log('[NoteList] モーダルを開く roomId:', cuiCurrentRoomId);

      // 設定ドロップダウンを閉じる
      document.getElementById('chatSettingsDropdown').classList.remove('active');

      var overlay = document.getElementById('noteListModalOverlay');
      var modal = document.getElementById('noteListModal');
      var content = document.getElementById('noteListContent');

      // ローディング表示
      content.innerHTML = `
        <div class="note-list-loading">
          <i class="bi bi-arrow-clockwise spin"></i>
          読み込み中...
        </div>
      `;

      // モーダル表示
      overlay.classList.add('active');
      setTimeout(() => {
        modal.classList.add('active');
      }, 10);

      // ノート一覧を取得
      await loadSharedNotes();
    };

    window.closeNoteListModal = function() {
      var overlay = document.getElementById('noteListModalOverlay');
      var modal = document.getElementById('noteListModal');

      modal.classList.remove('active');
      setTimeout(() => {
        overlay.classList.remove('active');
      }, 300);
    };

    async function loadSharedNotes() {
      var content = document.getElementById('noteListContent');

      try {
        // このルームのメッセージからtype='note-share'を検索
        var messagesRef = collection(_cuiDb, `rooms/${cuiCurrentRoomId}/messages`);
        var q = query(
          messagesRef,
          where('type', '==', 'note-share'),
          orderBy('timestamp', 'desc'),
          limit(50)
        );

        var snapshot = await getDocs(q);

        if (snapshot.empty) {
          content.innerHTML = `
            <div class="note-list-empty">
              <i class="bi bi-journal-text"></i>
              <p>このチャットで共有されたノートはありません</p>
            </div>
          `;
          return;
        }

        // ノート一覧を表示
        var html = '';
        snapshot.forEach(docSnap => {
          var msg = docSnap.data();
          var noteData = msg.noteShareData || {};
          var title = noteData.title || '無題のノート';
          var url = noteData.url || '#';
          var senderName = msg.userName || '不明';
          var senderEmail = msg.userEmail || '';

          // 送信日時
          var dateStr = '';
          if (msg.timestamp) {
            var date = msg.timestamp.toDate ? msg.timestamp.toDate() : new Date(msg.timestamp);
            dateStr = date.toLocaleDateString('ja-JP', {
              month: 'short',
              day: 'numeric'
            });
          }

          // 送信者のアイコンを取得
          var senderIconUrl = getUserIconUrl(senderName) || '';

          html += `
            <div class="note-list-item" onclick="window.open('${url}', '_blank')">
              <div class="note-list-icon">
                <i class="bi bi-journal-text"></i>
              </div>
              <div class="note-list-info">
                <div class="note-list-title">${escapeHtml(title)}</div>
                <div class="note-list-meta">
                  <div class="note-list-sender">
                    <div class="note-list-sender-avatar">
                      ${senderIconUrl
                        ? `<img src="${senderIconUrl}" alt="${escapeHtml(senderName)}" onerror="this.outerHTML='<i class=\\'bi bi-person\\'></i>'">`
                        : `<i class="bi bi-person"></i>`}
                    </div>
                    <span>${escapeHtml(senderName)}</span>
                  </div>
                  <span>${dateStr}</span>
                </div>
              </div>
              <div class="note-list-arrow">
                <i class="bi bi-chevron-right"></i>
              </div>
            </div>
          `;
        });

        content.innerHTML = html;

      } catch (error) {
        console.error('[NoteList] 読み込みエラー:', error);
        // インデックス作成リンクがある場合は表示
        var errorMsg = error.message || '';
        var helpText = '';
        if (errorMsg.includes('index')) {
          helpText = '<br><small>（Firestoreインデックスの作成が必要です）</small>';
        }
        content.innerHTML = `
          <div class="note-list-empty">
            <i class="bi bi-exclamation-circle"></i>
            <p>ノート一覧の読み込みに失敗しました${helpText}</p>
            <p style="font-size: 11px; color: #9ca3af; margin-top: 8px; word-break: break-all;">${escapeHtml(errorMsg)}</p>
          </div>
        `;
      }
    }

    // ========== 自分のノート選択モーダル ==========
    window.openMyNoteSelectModal = async function() {
      console.log('[MyNoteSelect] モーダルを開く userEmail:', cuiCurrentUserEmail);

      // 添付メニューを閉じる
      document.getElementById('attachmentMenu').style.display = 'none';
      document.getElementById('toggleMenuBtn').classList.remove('active');

      var overlay = document.getElementById('myNoteSelectModalOverlay');
      var modal = document.getElementById('myNoteSelectModal');
      var content = document.getElementById('myNoteSelectContent');

      // ローディング表示
      content.innerHTML = `
        <div class="note-list-loading">
          <i class="bi bi-arrow-clockwise spin"></i>
          読み込み中...
        </div>
      `;

      // モーダル表示
      overlay.classList.add('active');
      setTimeout(() => {
        modal.classList.add('active');
      }, 10);

      // 自分のノート一覧を取得
      await loadMyNotes();
    };

    window.closeMyNoteSelectModal = function() {
      var overlay = document.getElementById('myNoteSelectModalOverlay');
      var modal = document.getElementById('myNoteSelectModal');

      modal.classList.remove('active');
      setTimeout(() => {
        overlay.classList.remove('active');
      }, 300);
    };

    async function loadMyNotes() {
      var content = document.getElementById('myNoteSelectContent');

      try {
        // 自分のノート一覧を取得
        var notesRef = collection(_cuiDb, `users/${cuiCurrentUserEmail}/notes`);
        var q = query(notesRef, orderBy('updatedAt', 'desc'), limit(50));
        var snapshot = await getDocs(q);

        if (snapshot.empty) {
          content.innerHTML = `
            <div class="note-list-empty">
              <i class="bi bi-journal-text"></i>
              <p>ノートがありません</p>
              <p style="font-size: 12px; margin-top: 8px;">マイページからノートを作成してください</p>
            </div>
          `;
          return;
        }

        // ノート一覧を表示
        var html = '';
        snapshot.forEach(docSnap => {
          var note = docSnap.data();
          var noteId = docSnap.id;
          var title = note.title || '無題のノート';

          // 更新日時
          var dateStr = '';
          if (note.updatedAt) {
            var date = note.updatedAt.toDate ? note.updatedAt.toDate() : new Date(note.updatedAt);
            dateStr = date.toLocaleDateString('ja-JP', {
              month: 'short',
              day: 'numeric'
            });
          }

          // ブロック数
          var blockCount = note.blocks ? note.blocks.length : 0;

          html += `
            <div class="note-list-item" onclick="sendNoteToChat('${noteId}', '${escapeHtml(title).replace(/'/g, "\\'")}')">
              <div class="note-list-icon">
                <i class="bi bi-journal-text"></i>
              </div>
              <div class="note-list-info">
                <div class="note-list-title">${escapeHtml(title)}</div>
                <div class="note-list-meta">
                  <span>${blockCount}ブロック</span>
                  <span>${dateStr}</span>
                </div>
              </div>
              <div class="note-list-arrow">
                <i class="bi bi-send"></i>
              </div>
            </div>
          `;
        });

        content.innerHTML = html;

      } catch (error) {
        console.error('[MyNoteSelect] 読み込みエラー:', error);
        content.innerHTML = `
          <div class="note-list-empty">
            <i class="bi bi-exclamation-circle"></i>
            <p>ノート一覧の読み込みに失敗しました</p>
            <p style="font-size: 11px; color: #9ca3af; margin-top: 8px;">${escapeHtml(error.message || '')}</p>
          </div>
        `;
      }
    }

    // ノートをチャットに送信
    window.sendNoteToChat = async function(noteId, noteTitle) {
      console.log('[SendNote] ノート送信開始:', noteId, noteTitle);

      closeMyNoteSelectModal();

      try {
        // 共有リンクを生成（既存のshareIdがあれば使用、なければ新規作成）
        var noteRef = doc(_cuiDb, `users/${cuiCurrentUserEmail}/notes`, noteId);
        var noteSnap = await getDoc(noteRef);

        if (!noteSnap.exists()) {
          alert('ノートが見つかりません');
          return;
        }

        var noteData = noteSnap.data();
        var shareId = noteData.shareId;

        // shareIdがない場合は新規作成
        if (!shareId) {
          shareId = generateShareId();

          // ノートにshareIdを保存
          await updateDoc(noteRef, {
            shareId: shareId,
            isPublic: true
          });

          // noteSharesコレクションに登録
          await setDoc(doc(_cuiDb, 'noteShares', shareId), {
            noteId: noteId,
            ownerEmail: cuiCurrentUserEmail,
            createdAt: serverTimestamp(),
            isActive: true
          });
        }

        var shareUrl = `${window.location.origin}/note-view.html?id=${shareId}`;

        // チャットにメッセージ送信
        var messagesRef = collection(_cuiDb, `rooms/${cuiCurrentRoomId}/messages`);
        await addDoc(messagesRef, {
          text: `ノートを共有しました\n\n「${noteTitle}」\n${shareUrl}`,
          userName: cuiCurrentUserName,
          userEmail: cuiCurrentUserEmail,
          timestamp: serverTimestamp(),
          type: 'note-share',
          noteShareData: {
            shareId: shareId,
            noteId: noteId,
            title: noteTitle,
            url: shareUrl
          }
        });

        // ルームのlastMessageを更新
        var roomRef = doc(_cuiDb, 'rooms', cuiCurrentRoomId);
        await updateDoc(roomRef, {
          lastMessage: 'ノートを共有しました',
          lastMessageAt: serverTimestamp()
        });

        console.log('[SendNote] ノート送信完了');

      } catch (error) {
        console.error('[SendNote] 送信エラー:', error);
        alert('ノートの送信に失敗しました: ' + error.message);
      }
    };

    // 共有ID生成（ランダム文字列）
    function generateShareId() {
      var chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      var result = '';
      for (let i = 0; i < 16; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    window.executeForward = async function(targetRoomId, targetRoomName) {
      if (!cuiForwardMessageData) return;

      closeForwardModal();

      try {
        console.log('[Forward] 転送開始:', targetRoomId);

        // 転送メッセージを作成（LINE方式：転送ラベルなし）
        var messageText = cuiForwardMessageData.text || '';

        var messageData = {
          text: messageText,
          userName: cuiCurrentUserName,      // 表示用（appendMessage参照）
          userEmail: cuiCurrentUserEmail,    // Firebase Functions用（通知フィルタリング）
          timestamp: serverTimestamp(),
          forwarded: true,
          originalSender: cuiForwardMessageData.originalSender
        };

        // 画像の場合はfileUrlも追加
        if (cuiForwardMessageData.fileUrl) {
          messageData.fileUrl = cuiForwardMessageData.fileUrl;
          messageData.fileName = cuiForwardMessageData.fileName;
          messageData.type = 'image';
        }

        // 転送先にメッセージを追加
        await addDoc(collection(_cuiDb, `rooms/${targetRoomId}/messages`), messageData);

        // 転送先のlastMessageを更新
        var roomRef = doc(_cuiDb, 'rooms', targetRoomId);
        var lastMessagePreview = messageText || '画像';
        await updateDoc(roomRef, {
          lastMessage: lastMessagePreview.substring(0, 50),
          lastMessageAt: serverTimestamp()
        });

        console.log('[Forward] 転送完了');
        alert(`「${targetRoomName}」に転送しました`);

      } catch (error) {
        console.error('[Forward] 転送エラー:', error);
        alert('転送に失敗しました: ' + error.message);
      }

      cuiForwardMessageData = null;
    };

    // ========================================
    // Keep選択モーダル機能
    // ========================================

    // Keep選択モーダルを開く
    window.openKeepSelectModal = async function() {
      console.log('[Keep] Keep選択モーダルを開く');

      // 添付メニューを閉じる
      document.getElementById('attachmentMenu').style.display = 'none';
      document.getElementById('toggleMenuBtn').classList.remove('active');

      var overlay = document.getElementById('keepModalOverlay');
      var modal = document.getElementById('keepModal');
      var body = document.getElementById('keepModalBody');

      // ローディング表示
      body.innerHTML = '<div class="keep-loading"><i class="bi bi-arrow-repeat spin"></i> 読み込み中...</div>';

      overlay.classList.add('active');
      setTimeout(() => modal.classList.add('active'), 10);

      try {
        // 自分のKeepメモルームを検索
        var q = query(
          collection(_cuiDb, 'rooms'),
          where('type', '==', 'keep'),
          where('createdBy', '==', cuiCurrentUserName)
        );
        var roomSnapshot = await getDocs(q);

        if (roomSnapshot.empty) {
          // Keepメモがない場合
          body.innerHTML = `
            <div class="keep-empty">
              <i class="bi bi-bookmark"></i>
              <div class="keep-empty-text">
                Keepメモがありません<br>
                <small>トーク一覧の<i class="bi bi-bookmark"></i>から<br>メモを保存できます</small>
              </div>
            </div>
          `;
          return;
        }

        // Keepメモルームのメッセージを取得
        var keepRoomId = roomSnapshot.docs[0].id;
        var messagesQuery = query(
          collection(_cuiDb, 'rooms', keepRoomId, 'messages'),
          orderBy('timestamp', 'desc'),
          limit(50)
        );
        var messagesSnapshot = await getDocs(messagesQuery);

        if (messagesSnapshot.empty) {
          body.innerHTML = `
            <div class="keep-empty">
              <i class="bi bi-bookmark"></i>
              <div class="keep-empty-text">
                Keepメモが空です<br>
                <small>トーク一覧の<i class="bi bi-bookmark"></i>から<br>メモを保存できます</small>
              </div>
            </div>
          `;
          return;
        }

        // メッセージ一覧を表示
        body.innerHTML = '';
        messagesSnapshot.forEach(msgDoc => {
          var msg = msgDoc.data();

          // テキストメッセージのみ表示（音声・画像は除外）
          if (!msg.text) return;

          var item = document.createElement('div');
          item.className = 'keep-item';
          item.onclick = () => sendKeepMessage(msg.text);

          // 日時フォーマット
          var dateStr = '';
          if (msg.timestamp) {
            var date = msg.timestamp.toDate ? msg.timestamp.toDate() : new Date(msg.timestamp);
            var now = new Date();
            var diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
            if (diffDays === 0) {
              dateStr = date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays === 1) {
              dateStr = '昨日';
            } else if (diffDays < 7) {
              dateStr = diffDays + '日前';
            } else {
              dateStr = date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
            }
          }

          item.innerHTML = `
            <div class="keep-item-icon">
              <i class="bi bi-bookmark-fill"></i>
            </div>
            <div class="keep-item-content">
              <div class="keep-item-text">${escapeHtml(msg.text)}</div>
              <div class="keep-item-date">${dateStr}</div>
            </div>
          `;
          body.appendChild(item);
        });

      } catch (error) {
        console.error('[Keep] エラー:', error);
        body.innerHTML = `
          <div class="keep-empty">
            <i class="bi bi-exclamation-circle"></i>
            <div class="keep-empty-text">
              Keepの読み込みに失敗しました<br>
              <small>${escapeHtml(error.message)}</small>
            </div>
          </div>
        `;
      }
    };

    // Keep選択モーダルを閉じる
    window.closeKeepModal = function(event) {
      // オーバーレイ直接クリック時のみ閉じる
      if (event && event.target.id !== 'keepModalOverlay') return;

      var overlay = document.getElementById('keepModalOverlay');
      var modal = document.getElementById('keepModal');

      modal.classList.remove('active');
      setTimeout(() => {
        overlay.classList.remove('active');
      }, 300);
    };

    // KeepメッセージをチャットにKeepメッセージとして送信
    window.sendKeepMessage = async function(text) {
      console.log('[Keep] Keepメッセージを送信:', text.substring(0, 50) + '...');

      // モーダルを閉じる
      closeKeepModal();

      try {
        // Keepからのメッセージとして送信
        await addDoc(collection(_cuiDb, 'rooms', cuiCurrentRoomId, 'messages'), {
          text: text,
          userName: cuiCurrentUserName,
          userEmail: cuiCurrentUserEmail,
          sender: cuiCurrentUserEmail,
          senderName: cuiCurrentUserName,
          timestamp: serverTimestamp(),
          readBy: [cuiCurrentUserEmail],
          fromKeep: true  // Keepからの送信であることを示すフラグ
        });

        // ルームの最終メッセージを更新
        var roomRef = doc(_cuiDb, 'rooms', cuiCurrentRoomId);
        await updateDoc(roomRef, {
          lastMessage: text.length > 30 ? text.substring(0, 30) + '...' : text,
          lastMessageAt: serverTimestamp(),
          lastMessageBy: cuiCurrentUserName
        });

        console.log('[Keep] 送信完了');
      } catch (error) {
        console.error('[Keep] 送信エラー:', error);
        alert('送信に失敗しました: ' + error.message);
      }
    };

    // 削除機能（メニューから）→ 選択モード開始に変更（現在は未使用）
    window.deleteMessageFromMenu = function() {
      if (!cuiContextMenuData.messageId) return;

      // closeContextMenu()でcontextMenuDataがリセットされる前にIDとitemを保存
      var messageId = cuiContextMenuData.messageId;
      var messageItem = cuiContextMenuData.item;

      closeContextMenu();

      // 選択モード開始
      var container = document.getElementById('messagesContainer');
      var bar = document.getElementById('selectionModeBar');

      if (!container.classList.contains('selection-mode')) {
        container.classList.add('selection-mode');
        bar.classList.add('active');
      }

      // 選択したメッセージを自動選択
      if (messageItem) {
        var checkbox = messageItem.querySelector('.message-checkbox');
        if (checkbox) {
          checkbox.checked = true;
          updateSelectionCount();
        }
      }
    };

    // メッセージアイテムに長押しイベントを追加
    function addLongPressListener(item, messageId, messageText, isMine = false, fileUrl = null, fileName = null, senderName = null) {
      var touchStartTime = 0;
      var touchMoved = false;

      // タッチ開始
      item.addEventListener('touchstart', (e) => {
        console.log('[LongPress] touchstart');
        touchStartTime = Date.now();
        touchMoved = false;

        cuiLongPressTimer = setTimeout(() => {
          console.log('[LongPress] Timer fired, touchMoved:', touchMoved);
          if (!touchMoved) {
            console.log('[LongPress] Opening context menu, isMine:', isMine);
            openContextMenu(messageId, messageText, item, isMine, fileUrl, fileName, senderName);
            // 振動フィードバック（対応ブラウザのみ）
            if ('vibrate' in navigator) {
              navigator.vibrate(50);
            }
          }
        }, CUI_LONG_PRESS_DURATION);
      });

      // タッチ移動（スクロール検出）
      item.addEventListener('touchmove', () => {
        console.log('[LongPress] touchmove - canceling');
        touchMoved = true;
        if (cuiLongPressTimer) {
          clearTimeout(cuiLongPressTimer);
          cuiLongPressTimer = null;
        }
      });

      // タッチ終了
      item.addEventListener('touchend', () => {
        if (cuiLongPressTimer) {
          clearTimeout(cuiLongPressTimer);
          cuiLongPressTimer = null;
        }
      });

      // タッチキャンセル
      item.addEventListener('touchcancel', () => {
        if (cuiLongPressTimer) {
          clearTimeout(cuiLongPressTimer);
          cuiLongPressTimer = null;
        }
      });

      // PC用: 右クリック
      item.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        openContextMenu(messageId, messageText, item, isMine, fileUrl, fileName, senderName);
      });
    }

    // ========================================
    // 画像ビューアー機能
    // ========================================

    // 画像ビューアーを開く
    function openImageViewer(imageUrl) {
      console.log('[ImageViewer] 画像ビューアーを開く:', imageUrl);
      var viewer = document.getElementById('imageViewer');
      var viewerImg = document.getElementById('imageViewerImg');

      viewerImg.src = imageUrl;
      viewer.style.display = 'flex';

      // フェードイン用のクラスを追加（少し遅延させて適用）
      setTimeout(() => {
        viewer.classList.add('active');
      }, 10);
    }

    // 画像ビューアーを閉じる
    function closeImageViewer() {
      console.log('[ImageViewer] 画像ビューアーを閉じる');
      var viewer = document.getElementById('imageViewer');
      var viewerImg = document.getElementById('imageViewerImg');

      // フェードアウト
      viewer.classList.remove('active');

      // アニメーション完了後に非表示
      setTimeout(() => {
        viewer.style.display = 'none';
        viewerImg.src = ''; // メモリ解放
      }, 300); // CSSのtransition時間と合わせる
    }

    // 画像ビューアーのイベントリスナー設定
    function cuiSetupImageViewer() {
      var viewer = document.getElementById('imageViewer');
      var closeButton = document.getElementById('imageViewerClose');
      var viewerImg = document.getElementById('imageViewerImg');

      // ×ボタンクリックで閉じる
      if (closeButton) {
        closeButton.addEventListener('click', (e) => {
          e.stopPropagation();
          closeImageViewer();
        });
      }

      // 背景クリックで閉じる（画像自体のクリックでは閉じない）
      if (viewer) {
        viewer.addEventListener('click', (e) => {
          if (e.target === viewer) {
            closeImageViewer();
          }
        });
      }

      // 画像クリックでは閉じない（拡大表示維持）
      if (viewerImg) {
        viewerImg.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      }

      // ダウンロードボタンのイベント
      var downloadButton = document.getElementById('imageViewerDownload');
      if (downloadButton) {
        downloadButton.addEventListener('click', (e) => {
          e.stopPropagation();
          downloadImage();
        });
      }
    }

    // 画像をダウンロード（シンプル版：新規タブで直接開く）
    function downloadImage() {
      var viewerImg = document.getElementById('imageViewerImg');
      var imageUrl = viewerImg.src;

      // 新規タブで画像URLを直接開く（最もシンプルで確実）
      window.open(imageUrl, '_blank');
      showToast('画像を長押しで保存できます');
    }

    // トースト通知を表示
    function showToast(message) {
      // 既存のトーストがあれば削除
      var existingToast = document.getElementById('downloadToast');
      if (existingToast) {
        existingToast.remove();
      }

      // トーストを作成
      var toast = document.createElement('div');
      toast.id = 'downloadToast';
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        z-index: 10002;
        opacity: 0;
        transition: opacity 0.3s ease;
      `;
      document.body.appendChild(toast);

      // フェードイン
      setTimeout(() => {
        toast.style.opacity = '1';
      }, 10);

      // 1秒後にフェードアウトして削除
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
          toast.remove();
        }, 300);
      }, 1000);
    }

    // ========== Agora通話機能 ==========
    // テストモード（APP IDのみ、トークン不要）
    var AGORA_APP_ID = '10d16f783ccd4c97867c92475fa3fbc2';

    // Agoraチャンネル名サニタイズ（64バイト以内、英数字と_のみ）
    var sanitizeChannelName = (roomId) => {
      var safe = (roomId || '').replace(/[^a-zA-Z0-9_]/g, '');
      return 'room_' + safe.substring(0, 58);
    };


    // 🔧 パフォーマンス改善: Agora SDKの遅延読み込み（300KB削減）
    var _cuiAgoraLoaded = false;
    function loadAgoraSDK() {
      if (_cuiAgoraLoaded || typeof AgoraRTC !== 'undefined') {
        _cuiAgoraLoaded = true;
        return Promise.resolve();
      }
      return _cuiLoadScript('https://download.agora.io/sdk/release/AgoraRTC_N-4.20.0.js').then(function() { _cuiAgoraLoaded = true; });
    }

    // 通話開始
    // targetUserName, targetIconUrl: プロフィールポップアップからの通話時に指定
    window.showCallPreparing = async function(targetUserName, targetIconUrl) {
      var callButton = document.getElementById('callButton');
      if (callButton) callButton.blur();

      // チャットルームが必要
      if (!cuiCurrentRoomId) {
        alert('チャットルームを選択してください');
        return;
      }

      // マイク権限を確認
      try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch (err) {
        alert('マイクへのアクセスを許可してください');
        return;
      }

      // 通話モーダルを表示
      var modal = document.getElementById('callModal');
      modal.style.display = 'flex';

      // 相手の名前を設定（引数があればそれを使用、なければルーム名から取得）
      var displayName = targetUserName || document.getElementById('headerRoomName').textContent;
      document.getElementById('callUserName').textContent = displayName;
      document.getElementById('callStatus').textContent = '接続中...';

      // 相手のアバター画像を設定
      var avatarContainer = document.getElementById('callUserAvatar');
      var iconUrl = targetIconUrl || getUserIconUrl(displayName);
      if (iconUrl) {
        avatarContainer.innerHTML = `<img src="${iconUrl}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" onerror="this.outerHTML='<i class=\\'bi bi-person-fill\\'></i>'">`;
      } else {
        avatarContainer.innerHTML = '<i class="bi bi-person-fill"></i>';
      }
      document.getElementById('callTimer').style.display = 'none';

      // Agora通話を開始
      try {
        await startAgoraCall();
      } catch (err) {
        console.error('通話開始エラー:', err);
        // エラーコード別のメッセージ
        var errorMsg = '接続に失敗しました';
        if (err.code === 'INVALID_OPERATION') {
          errorMsg = 'トークンが必要です';
        } else if (err.code === 'UID_CONFLICT') {
          errorMsg = 'ユーザーIDの重複';
        } else if (err.code === 'INVALID_PARAMS') {
          errorMsg = 'パラメータエラー';
        } else if (err.message) {
          errorMsg = err.message.substring(0, 30);
        }
        document.getElementById('callStatus').textContent = errorMsg;
        alert('通話エラー: ' + (err.message || err.code || '不明なエラー'));
        setTimeout(() => endCall(), 3000);
      }
    };

    // Agora通話開始
    async function startAgoraCall() {
      // Agora SDKを遅延読み込み
      await loadAgoraSDK();
      // Agoraクライアント作成
      cuiAgoraClient = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });

      // イベントリスナー設定
      // ユーザー参加イベント
      cuiAgoraClient.on('user-joined', (user) => {
        console.log('★ユーザーがチャンネルに参加:', user.uid);
        document.getElementById('callStatus').textContent = '相手が参加しました...';
      });

      cuiAgoraClient.on('user-published', async (user, mediaType) => {
        console.log('★ユーザーが公開:', user.uid, mediaType);
        await cuiAgoraClient.subscribe(user, mediaType);
        console.log('★購読完了:', user.uid);

        if (mediaType === 'audio') {
          user.audioTrack.play();
          // 通話開始
          document.getElementById('callStatus').textContent = '通話中';
          document.getElementById('callStatus').style.animation = 'none';
          startCallTimer();
        }
      });

      cuiAgoraClient.on('user-unpublished', (user) => {
        console.log('リモートユーザー退出:', user.uid);
      });

      cuiAgoraClient.on('user-left', (user) => {
        console.log('リモートユーザーが退出しました');
        document.getElementById('callStatus').textContent = '相手が退出しました';
        setTimeout(() => endCall(), 2000);
      });

      // 接続状態変化
      cuiAgoraClient.on('connection-state-change', (curState, prevState) => {
        console.log('★接続状態:', prevState, '->', curState);
      });

      // チャンネルに参加（チャンネル名 = ルームIDをサニタイズ）
      var channelName = sanitizeChannelName(cuiCurrentRoomId);
      console.log('★Agoraチャンネル名:', channelName, '元RoomID:', cuiCurrentRoomId);
      var uid = await cuiAgoraClient.join(AGORA_APP_ID, channelName, null, null);
      console.log('★Agoraチャンネル参加成功! チャンネル:', channelName, 'UID:', uid);

      // 音声トラック作成・公開
      cuiLocalAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
      await cuiAgoraClient.publish([cuiLocalAudioTrack]);
      console.log('★音声トラック公開完了');

      // チャンネル名を表示（デバッグ用）
      document.getElementById('callStatus').textContent = '呼び出し中...';

      // 相手への通知をFirestoreに送信
      sendCallNotification();
    }

    // 通話通知をFirestoreに送信

    async function sendCallNotification() {
      if (!_cuiDb || !cuiCurrentRoomId || !cuiCurrentUserEmail) return;

      try {
        // Firebase v9 modular syntax
        var callsRef = collection(_cuiDb, 'rooms', cuiCurrentRoomId, 'calls');
        var callerIconUrl = getUserIconUrl(cuiCurrentUserName) || null;
        var docRef = await addDoc(callsRef, {
          callerId: cuiCurrentUserEmail,
          callerName: cuiCurrentUserName || cuiCurrentUserEmail.split('@')[0],
          callerIcon: callerIconUrl,
          channelName: sanitizeChannelName(cuiCurrentRoomId),
          roomId: cuiCurrentRoomId,
          status: 'calling',
          createdAt: serverTimestamp()
        });
        cuiCurrentCallDocId = docRef.id;
        console.log('★通話通知送信:', cuiCurrentCallDocId);
      } catch (err) {
        console.error('通話通知送信エラー:', err);
      }
    }

    // ========== 着信検知 ==========

    // 着信音を再生
    function playRingtone() {
      stopRingtone(); // 既存の着信音を停止

      // バイブレーションパターン（音が鳴らない場合のフォールバック）
      var vibratePattern = () => {
        if ('vibrate' in navigator) {
          navigator.vibrate([200, 100, 200, 100, 200]); // ブルブル
        }
      };

      // バイブレーションを繰り返し
      vibratePattern();
      cuiRingtoneInterval = setInterval(vibratePattern, 2000);

      // Web Audio APIで着信音（ブラウザポリシーで鳴らない場合あり）
      try {
        cuiRingtoneContext = new (window.AudioContext || window.webkitAudioContext)();

        // Suspended状態の場合はresume試行
        if (cuiRingtoneContext.state === 'suspended') {
          cuiRingtoneContext.resume();
        }

        var playTone = (frequency, duration) => {
          if (cuiRingtoneContext.state !== 'running') return;
          var oscillator = cuiRingtoneContext.createOscillator();
          var gainNode = cuiRingtoneContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(cuiRingtoneContext.destination);

          oscillator.frequency.value = frequency;
          oscillator.type = 'sine';

          gainNode.gain.setValueAtTime(0.3, cuiRingtoneContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, cuiRingtoneContext.currentTime + duration);

          oscillator.start(cuiRingtoneContext.currentTime);
          oscillator.stop(cuiRingtoneContext.currentTime + duration);
        };

        // 着信音パターン
        var ringPattern = () => {
          playTone(880, 0.15);
          setTimeout(() => playTone(440, 0.15), 150);
          setTimeout(() => playTone(880, 0.15), 300);
        };

        setTimeout(ringPattern, 100); // 少し遅延して再生
      } catch (err) {
        console.log('着信音エラー:', err);
      }
    }

    // 着信音を停止
    function stopRingtone() {
      if (cuiRingtoneInterval) {
        clearInterval(cuiRingtoneInterval);
        cuiRingtoneInterval = null;
      }
      if (cuiRingtoneContext) {
        cuiRingtoneContext.close().catch(() => {});
        cuiRingtoneContext = null;
      }
      // バイブレーション停止
      if ('vibrate' in navigator) {
        navigator.vibrate(0);
      }
    }

    // 着信リスナーを開始
    function startIncomingCallListener() {
      if (!_cuiDb || !cuiCurrentRoomId || !cuiCurrentUserEmail) return;

      // 既存のリスナーを解除
      if (cuiIncomingCallListener) {
        cuiIncomingCallListener();
      }

      console.log('★着信リスナー開始:', cuiCurrentRoomId);

      // Firebase v9 modular syntax
      var callsRef = collection(_cuiDb, 'rooms', cuiCurrentRoomId, 'calls');
      var callsQuery = query(callsRef, where('status', '==', 'calling'));

      // 現在のルームの通話を監視
      cuiIncomingCallListener = onSnapshot(callsQuery, (snapshot) => {
        snapshot.docChanges().forEach(change => {
          if (change.type === 'added') {
            var callData = change.doc.data();
            console.log('★通話検知:', callData);

            // 自分が発信者でない場合は着信として処理
            if (callData.callerId !== cuiCurrentUserEmail) {
              showIncomingCall(change.doc.id, callData);
            }
          } else if (change.type === 'modified') {
            var callData = change.doc.data();
            // 通話がキャンセルされた場合
            if (callData.status === 'cancelled' || callData.status === 'ended') {
              hideIncomingCall();
            }
          } else if (change.type === 'removed') {
            hideIncomingCall();
          }
        });
      });
    }

    // 着信中の通話ドキュメント監視用リスナー
    var cuiCurrentCallDocListener = null;

    // 着信モーダルを表示
    function showIncomingCall(callId, callData) {
      cuiCurrentIncomingCall = { id: callId, ...callData };

      document.getElementById('incomingCallerName').textContent = callData.callerName || '不明';
      document.getElementById('incomingCallStatus').textContent = '着信中...';

      // 発信者のアバター画像を設定
      var avatarContainer = document.getElementById('incomingCallerAvatar');
      if (avatarContainer) {
        if (callData.callerIcon) {
          avatarContainer.innerHTML = `<img src="${callData.callerIcon}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" onerror="this.outerHTML='<i class=\\'bi bi-telephone-inbound-fill\\'></i>'">`;
        } else {
          avatarContainer.innerHTML = '<i class="bi bi-telephone-inbound-fill"></i>';
        }
      }

      document.getElementById('incomingCallModal').style.display = 'flex';

      // 着信音を再生
      playRingtone();

      // この通話ドキュメントを直接監視（発信者がキャンセルした場合を検出）
      if (cuiCurrentCallDocListener) {
        cuiCurrentCallDocListener();
      }
      var callDocRef = doc(_cuiDb, 'rooms', cuiCurrentRoomId, 'calls', callId);
      cuiCurrentCallDocListener = onSnapshot(callDocRef, (docSnapshot) => {
        if (docSnapshot.exists()) {
          var data = docSnapshot.data();
          console.log('★通話ドキュメント変更:', data.status);
          if (data.status === 'cancelled' || data.status === 'ended' || data.status === 'declined') {
            console.log('★発信者がキャンセル/終了しました');
            hideIncomingCall();
          }
        } else {
          // ドキュメントが削除された
          console.log('★通話ドキュメント削除');
          hideIncomingCall();
        }
      });

      console.log('★着信表示:', callData.callerName);
    }

    // 着信モーダルを非表示
    function hideIncomingCall() {
      cuiCurrentIncomingCall = null;
      document.getElementById('incomingCallModal').style.display = 'none';
      stopRingtone(); // 着信音を停止

      // 通話ドキュメントリスナーを解除
      if (cuiCurrentCallDocListener) {
        cuiCurrentCallDocListener();
        cuiCurrentCallDocListener = null;
      }
    }

    // 着信に応答
    window.acceptCall = async function() {
      if (!cuiCurrentIncomingCall) return;

      console.log('★着信応答:', cuiCurrentIncomingCall);

      // 着信モーダルを閉じる・着信音停止
      document.getElementById('incomingCallModal').style.display = 'none';
      stopRingtone();

      // 通話モーダルを表示
      var modal = document.getElementById('callModal');
      modal.style.display = 'flex';
      document.getElementById('callUserName').textContent = cuiCurrentIncomingCall.callerName;
      document.getElementById('callStatus').textContent = '接続中...';

      // 発信者のアバター画像を設定
      var avatarContainer = document.getElementById('callUserAvatar');
      if (cuiCurrentIncomingCall.callerIcon) {
        avatarContainer.innerHTML = `<img src="${cuiCurrentIncomingCall.callerIcon}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" onerror="this.outerHTML='<i class=\\'bi bi-person-fill\\'></i>'">`;
      } else {
        avatarContainer.innerHTML = '<i class="bi bi-person-fill"></i>';
      }

      // マイク権限を確認
      try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch (err) {
        alert('マイクへのアクセスを許可してください');
        modal.style.display = 'none';
        return;
      }

      // Agora通話に参加
      try {
        await joinAgoraCall(cuiCurrentIncomingCall.channelName);

        // 通話ステータスを更新 (Firebase v9)
        var callDocRef = doc(_cuiDb, 'rooms', cuiCurrentRoomId, 'calls', cuiCurrentIncomingCall.id);
        await updateDoc(callDocRef, { status: 'answered' });

      } catch (err) {
        console.error('通話参加エラー:', err);
        alert('通話への参加に失敗しました');
        modal.style.display = 'none';
      }

      cuiCurrentIncomingCall = null;
    };

    // 着信を拒否
    window.declineCall = async function() {
      if (!cuiCurrentIncomingCall) return;

      console.log('★着信拒否');

      try {
        // 通話ステータスを更新 (Firebase v9)
        var callDocRef = doc(_cuiDb, 'rooms', cuiCurrentRoomId, 'calls', cuiCurrentIncomingCall.id);
        await updateDoc(callDocRef, { status: 'declined' });
      } catch (err) {
        console.error('拒否更新エラー:', err);
      }

      hideIncomingCall();
    };

    // Agoraチャンネルに参加（応答側用）
    async function joinAgoraCall(channelName) {
      // Agora SDKを遅延読み込み
      await loadAgoraSDK();
      // Agoraクライアント作成
      cuiAgoraClient = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });

      // イベントリスナー設定
      cuiAgoraClient.on('user-joined', (user) => {
        console.log('★ユーザーがチャンネルに参加:', user.uid);
      });

      cuiAgoraClient.on('user-published', async (user, mediaType) => {
        console.log('★ユーザーが公開:', user.uid, mediaType);
        await cuiAgoraClient.subscribe(user, mediaType);

        if (mediaType === 'audio') {
          user.audioTrack.play();
          document.getElementById('callStatus').textContent = '通話中';
          document.getElementById('callStatus').style.animation = 'none';
          startCallTimer();
        }
      });

      cuiAgoraClient.on('user-left', (user) => {
        console.log('★ユーザー退出');
        document.getElementById('callStatus').textContent = '相手が退出しました';
        setTimeout(() => endCall(), 2000);
      });

      // チャンネルに参加
      console.log('★応答側: チャンネル参加:', channelName);
      var uid = await cuiAgoraClient.join(AGORA_APP_ID, channelName, null, null);
      console.log('★応答側: 参加成功, UID:', uid);

      // 音声トラック作成・公開
      cuiLocalAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
      await cuiAgoraClient.publish([cuiLocalAudioTrack]);
      console.log('★応答側: 音声公開完了');

      document.getElementById('callStatus').textContent = '通話中';

      // タイマー開始（まだ開始されていない場合）
      if (!cuiCallStartTime) {
        startCallTimer();
      }
    }

    // 通話終了
    window.endCall = async function() {
      // 通話時間を計算
      var callDuration = 0;
      if (cuiCallStartTime) {
        callDuration = Math.floor((Date.now() - cuiCallStartTime) / 1000);
      }

      // タイマー停止
      if (cuiCallTimerInterval) {
        clearInterval(cuiCallTimerInterval);
        cuiCallTimerInterval = null;
      }

      // 音声トラック停止
      if (cuiLocalAudioTrack) {
        cuiLocalAudioTrack.stop();
        cuiLocalAudioTrack.close();
        cuiLocalAudioTrack = null;
      }

      // Agoraチャンネル退出
      if (cuiAgoraClient) {
        await cuiAgoraClient.leave();
        cuiAgoraClient = null;
      }

      // Firestoreの通話ステータスを更新（相手に通知）
      if (cuiCurrentCallDocId && db && cuiCurrentRoomId) {
        try {
          var callDocRef = doc(_cuiDb, 'rooms', cuiCurrentRoomId, 'calls', cuiCurrentCallDocId);
          await updateDoc(callDocRef, {
            status: callDuration > 0 ? 'ended' : 'cancelled',
            endedAt: serverTimestamp()
          });
          console.log('★通話ステータス更新:', callDuration > 0 ? 'ended' : 'cancelled');
        } catch (err) {
          console.error('通話ステータス更新エラー:', err);
        }
      }

      // 通話履歴をチャットに送信（通話が成立した場合のみ）
      if (callDuration > 0 && db && cuiCurrentRoomId && cuiCurrentUserName) {
        try {
          var minutes = Math.floor(callDuration / 60);
          var seconds = callDuration % 60;
          var durationText = minutes > 0
            ? `${minutes}分${seconds}秒`
            : `${seconds}秒`;

          await addDoc(collection(_cuiDb, `rooms/${cuiCurrentRoomId}/messages`), {
            text: `通話終了 (${durationText})`,
            userName: cuiCurrentUserName,
            userEmail: cuiCurrentUserEmail,
            timestamp: serverTimestamp(),
            deleted: [],
            type: 'call',
            callDuration: callDuration
          });

          // lastMessage更新
          var roomRef = doc(_cuiDb, 'rooms', cuiCurrentRoomId);
          await updateDoc(roomRef, {
            lastMessage: `通話 (${durationText})`,
            lastMessageAt: serverTimestamp(),
            lastMessageBy: cuiCurrentUserName
          });

          console.log('★通話履歴送信:', durationText);
        } catch (err) {
          console.error('通話履歴送信エラー:', err);
        }
      }

      // 状態リセット
      cuiIsMuted = false;
      cuiIsSpeakerOn = true;
      cuiCallStartTime = null;
      cuiCurrentCallDocId = null;
      document.getElementById('callMuteBtn').classList.remove('active');
      document.getElementById('callSpeakerBtn').classList.remove('active');
      document.getElementById('callMuteIcon').className = 'bi bi-mic-fill';

      // モーダルを閉じる
      document.getElementById('callModal').style.display = 'none';
    };

    // ミュート切り替え
    window.toggleCallMute = function() {
      if (!cuiLocalAudioTrack) return;

      cuiIsMuted = !cuiIsMuted;
      cuiLocalAudioTrack.setEnabled(!cuiIsMuted);

      var btn = document.getElementById('callMuteBtn');
      var icon = document.getElementById('callMuteIcon');

      if (cuiIsMuted) {
        btn.classList.add('active');
        icon.className = 'bi bi-mic-mute-fill';
      } else {
        btn.classList.remove('active');
        icon.className = 'bi bi-mic-fill';
      }
    };

    // スピーカー切り替え（プレースホルダー）
    window.toggleCallSpeaker = function() {
      cuiIsSpeakerOn = !cuiIsSpeakerOn;
      var btn = document.getElementById('callSpeakerBtn');
      var icon = document.getElementById('callSpeakerIcon');

      if (!cuiIsSpeakerOn) {
        btn.classList.add('active');
        icon.className = 'bi bi-volume-mute-fill';
      } else {
        btn.classList.remove('active');
        icon.className = 'bi bi-volume-up-fill';
      }
      // 実際の音量制御は端末依存のため限定的
    };

    // 通話タイマー開始
    function startCallTimer() {
      cuiCallStartTime = Date.now();
      document.getElementById('callTimer').style.display = 'block';

      cuiCallTimerInterval = setInterval(() => {
        var elapsed = Math.floor((Date.now() - cuiCallStartTime) / 1000);
        var minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
        var seconds = (elapsed % 60).toString().padStart(2, '0');
        document.getElementById('callTimer').textContent = `${minutes}:${seconds}`;
      }, 1000);
    }

    // ========== チャット設定ドロップダウン ==========
    function toggleChatSettings(event) {
      event.stopPropagation();
      var dropdown = document.getElementById('chatSettingsDropdown');
      dropdown.classList.toggle('active');

      // ドロップダウンを開いた時に状態を更新
      if (dropdown.classList.contains('active')) {
        updateSettingsMenuState();
      }
    }

    // 設定メニューの状態を更新
    async function updateSettingsMenuState() {
      if (!cuiCurrentRoomId || !cuiCurrentUserEmail) return;

      try {
        // 現在のルームのデータを取得（モジュラーAPI使用）
        var roomRef = doc(_cuiDb, 'rooms', cuiCurrentRoomId);
        var roomDoc = await getDoc(roomRef);
        var roomData = roomDoc.data();

        // ミュート状態を確認
        var cuiIsMuted = roomData.mutedBy && roomData.mutedBy.includes(cuiCurrentUserEmail);
        var muteText = document.getElementById('muteRoomText');
        var muteBtn = document.getElementById('muteRoomBtn');
        if (cuiIsMuted) {
          muteText.textContent = '通知をオン';
          muteBtn.querySelector('i').className = 'bi bi-bell';
        } else {
          muteText.textContent = '通知をオフ';
          muteBtn.querySelector('i').className = 'bi bi-bell-slash';
        }

        // ブロック状態を確認（個別チャットのみ）
        var blockBtn = document.getElementById('blockUserBtn');
        var blockText = document.getElementById('blockUserText');

        if (roomData.type === 'direct') {
          // 相手のユーザー名を特定（membersにはユーザー名が入っている）
          var cuiOtherUserEmail = roomData.members.find(m => m !== cuiCurrentUserName);

          // 自分のブロックリストを確認
          var userRef = doc(_cuiDb, 'users', cuiCurrentUserEmail);
          var userDoc = await getDoc(userRef);
          var userData = userDoc.data() || {};
          // 自分自身を除外したブロックリスト
          var blockedUsers = (userData.blockedUsers || []).filter(
            u => u !== cuiCurrentUserName && u !== cuiCurrentUserEmail
          );

          var isBlocked = blockedUsers.includes(cuiOtherUserEmail);
          if (isBlocked) {
            blockText.textContent = 'ブロック解除';
            blockBtn.querySelector('i').className = 'bi bi-slash-circle-fill';
          } else {
            blockText.textContent = 'ブロックする';
            blockBtn.querySelector('i').className = 'bi bi-slash-circle';
          }
          blockBtn.style.display = 'flex';
          blockBtn.dataset.targetUser = cuiOtherUserEmail;
        } else {
          // グループチャットではブロックボタン非表示
          blockBtn.style.display = 'none';
        }

        // 退出ボタンの表示（グループチャットのみ）
        var leaveBtn = document.getElementById('leaveRoomBtn');
        if (roomData.type === 'group') {
          leaveBtn.style.display = 'flex';
        } else {
          leaveBtn.style.display = 'none';
        }

      } catch (error) {
        console.error('[Settings] 状態取得エラー:', error);
      }
    }

    // ブロック/ブロック解除
    async function toggleBlockUser() {
      var blockBtn = document.getElementById('blockUserBtn');
      var targetUser = blockBtn.dataset.targetUser;
      var blockText = document.getElementById('blockUserText');

      console.log('[Block] targetUser:', targetUser, 'cuiCurrentUserEmail:', cuiCurrentUserEmail);

      if (!targetUser) {
        showSettingsToast('ブロック対象が見つかりません');
        console.error('[Block] targetUser is empty');
        return;
      }
      if (!cuiCurrentUserEmail) {
        showSettingsToast('ログイン情報が見つかりません');
        console.error('[Block] cuiCurrentUserEmail is empty');
        return;
      }

      // 自分自身をブロックしないようにガード
      if (targetUser === cuiCurrentUserName || targetUser === cuiCurrentUserEmail) {
        showSettingsToast('自分自身はブロックできません');
        console.error('[Block] 自分自身をブロックしようとしました');
        closeChatSettings();
        return;
      }

      var isCurrentlyBlocked = blockText.textContent === 'ブロック解除';

      // 確認ダイアログ
      var action = isCurrentlyBlocked ? 'ブロックを解除' : 'ブロック';
      if (!confirm(`このユーザーを${action}しますか？`)) {
        closeChatSettings();
        return;
      }

      try {
        var userRef = doc(_cuiDb, 'users', cuiCurrentUserEmail);

        if (isCurrentlyBlocked) {
          // ブロック解除
          await updateDoc(userRef, {
            blockedUsers: arrayRemove(targetUser)
          });

          // ルームの非表示も解除（ブロック時に非表示になっていた場合）
          console.log('[Block] 非表示解除チェック - cuiCurrentRoomId:', cuiCurrentRoomId, ', cuiCurrentUserName:', cuiCurrentUserName);
          if (cuiCurrentRoomId && cuiCurrentUserName) {
            try {
              var roomRef = doc(_cuiDb, 'rooms', cuiCurrentRoomId);
              // 更新前の状態を確認
              var roomSnap = await getDoc(roomRef);
              if (roomSnap.exists()) {
                var roomData = roomSnap.data();
                console.log('[Block] 更新前 hiddenBy:', roomData.hiddenBy);
              }

              await updateDoc(roomRef, {
                hiddenBy: arrayRemove(cuiCurrentUserName)
              });
              console.log('[Block] ✅ ルームの非表示も解除完了');
            } catch (unhideError) {
              console.error('[Block] ❌ 非表示解除エラー:', unhideError);
            }
          } else {
            console.warn('[Block] ⚠️ cuiCurrentRoomId or cuiCurrentUserName is empty, skipping unhide');
          }

          showSettingsToast('ブロックを解除しました');
          blockText.textContent = 'ブロックする';
          blockBtn.querySelector('i').className = 'bi bi-slash-circle';
          cuiIsBlockedByMe = false; // グローバル変数を更新
        } else {
          // ブロック
          await setDoc(userRef, {
            blockedUsers: arrayUnion(targetUser)
          }, { merge: true });
          showSettingsToast('ブロックしました');
          blockText.textContent = 'ブロック解除';
          blockBtn.querySelector('i').className = 'bi bi-slash-circle-fill';
          cuiIsBlockedByMe = true; // グローバル変数を更新
        }

        // UIを更新（入力欄の表示/非表示）
        updateBlockedUI();

        closeChatSettings();

        // ページをリロードしてメッセージ表示を更新
        setTimeout(() => {
          location.reload();
        }, 500);

      } catch (error) {
        console.error('[Block] Firestoreエラー:', error);
        showSettingsToast('ブロック処理に失敗しました: ' + (error.message || error.code || 'Unknown'));
      }
    }

    // ミュート/ミュート解除
    async function toggleMuteRoom() {
      if (!cuiCurrentRoomId || !cuiCurrentUserEmail) return;

      var muteText = document.getElementById('muteRoomText');
      var isCurrentlyMuted = muteText.textContent === '通知をオン';

      try {
        var roomRef = doc(_cuiDb, 'rooms', cuiCurrentRoomId);

        if (isCurrentlyMuted) {
          // ミュート解除
          await updateDoc(roomRef, {
            mutedBy: arrayRemove(cuiCurrentUserEmail)
          });
          showSettingsToast('通知をオンにしました');
          muteText.textContent = '通知をオフ';
          document.getElementById('muteRoomBtn').querySelector('i').className = 'bi bi-bell-slash';
        } else {
          // ミュート
          await updateDoc(roomRef, {
            mutedBy: arrayUnion(cuiCurrentUserEmail)
          });
          showSettingsToast('通知をオフにしました');
          muteText.textContent = '通知をオン';
          document.getElementById('muteRoomBtn').querySelector('i').className = 'bi bi-bell';
        }

        closeChatSettings();

      } catch (error) {
        console.error('[Mute] エラー:', error);
        showSettingsToast('エラーが発生しました');
      }
    }

    // グループ退出確認
    function confirmLeaveRoom() {
      if (!confirm('このグループから退出しますか？')) {
        closeChatSettings();
        return;
      }
      leaveRoom();
    }

    // グループ退出
    async function leaveRoom() {
      if (!cuiCurrentRoomId || !cuiCurrentUserEmail) return;

      try {
        var roomRef = doc(_cuiDb, 'rooms', cuiCurrentRoomId);

        // メンバーから削除
        await updateDoc(roomRef, {
          members: arrayRemove(cuiCurrentUserEmail)
        });

        showSettingsToast('グループから退出しました');
        closeChatSettings();

        // チャット一覧に戻る（SPA navigation）
        setTimeout(() => {
          if (typeof navigateToPage === 'function') {
            navigateToPage('chat');
          }
        }, 500);

      } catch (error) {
        console.error('[Leave] エラー:', error);
        showSettingsToast('エラーが発生しました');
      }
    }

    // 設定ドロップダウンを閉じる
    function closeChatSettings() {
      document.getElementById('chatSettingsDropdown').classList.remove('active');
    }

    // 画面外クリックで設定ドロップダウンを閉じる
    document.addEventListener('click', function(e) {
      var dropdown = document.getElementById('chatSettingsDropdown');
      var settingsBtn = document.getElementById('chatSettingsButton');
      if (dropdown && settingsBtn && !dropdown.contains(e.target) && !settingsBtn.contains(e.target)) {
        dropdown.classList.remove('active');
      }
    });

    // 設定用トースト表示
    function showSettingsToast(message) {
      var existingToast = document.getElementById('settingsToast');
      if (existingToast) existingToast.remove();

      var toast = document.createElement('div');
      toast.id = 'settingsToast';
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 24px;
        border-radius: 24px;
        font-size: 14px;
        z-index: 9999;
      `;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 2000);
    }

    // ========== グローバルスコープに関数を登録（onclick用） ==========
    window.toggleChatSettings = toggleChatSettings;
    window.toggleBlockUser = toggleBlockUser;
    window.toggleMuteRoom = toggleMuteRoom;
    window.confirmLeaveRoom = confirmLeaveRoom;



  console.log('[chat_ui_firestore] ✅ Script loaded - Version @902-whisper');
  
  async function goBack() {
    console.log('[chat_ui_firestore] >>> goBack() called at', new Date().toISOString());
    // SPA: 履歴スタックを使って戻る（ループ防止）
    if (typeof spaGoBack === 'function') {
      spaGoBack();
    } else if (typeof navigateToPage === 'function') {
      navigateToPage('chat');
    } else if (window.self !== window.top) {
      window.parent.postMessage({ type: 'navigateToChat' }, '*');
    } else {
      try { google.script.host.close(); } catch(e) {}
    }
  }

  function cuiSetupDOMListeners() {
    console.log('[chat_ui_firestore] cuiSetupDOMListeners called');
    var backButton = document.getElementById('back-button');
    console.log('[chat_ui_firestore] backButton element:', backButton);

    if (backButton) {
      backButton.addEventListener('click', goBack);
      console.log('[chat_ui_firestore] ✅ 戻るボタンにgoBack()イベントリスナーを設定しました');
    } else {
      console.error('[chat_ui_firestore] ❌ 戻るボタンが見つかりません');
    }

    // アコーディオン収納機能
    var messageInput = document.getElementById('messageInput');
    var expandButton = document.getElementById('expandButton');
    var collapsibleButtons = document.querySelectorAll('.collapsible-button');

    // メッセージ入力欄フォーカス時: 3つのボタンを収納、展開ボタンを表示
    messageInput.addEventListener('focus', function() {
      console.log('[Accordion] Input focused - collapsing buttons');
      collapsibleButtons.forEach(btn => {
        btn.classList.add('collapsed');
      });
      expandButton.style.display = 'flex';
      // キーボード表示時：余白を縮小
      document.getElementById('messagesContainer').classList.add('keyboard-visible');
      document.querySelector('.input-container').classList.add('keyboard-visible');
    });

    messageInput.addEventListener('blur', function() {
      // キーボード非表示時：余白を元に戻す
      document.getElementById('messagesContainer').classList.remove('keyboard-visible');
      document.querySelector('.input-container').classList.remove('keyboard-visible');
      
      // ボタンを再展開（展開ボタンを非表示、3つのボタンを表示）
      console.log('[Accordion] Input blurred - expanding buttons');
      collapsibleButtons.forEach(btn => {
        btn.classList.remove('collapsed');
      });
      expandButton.style.display = 'none';
    });

    // 展開ボタン：タッチ/クリックで3つのボタンを再表示
    var expandButtonProcessing = false;
    
    function handleExpandButton(e) {
      e.preventDefault();
      e.stopPropagation();
      
      // 二重実行防止
      if (expandButtonProcessing) return;
      expandButtonProcessing = true;
      
      console.log('[Accordion] Expand button activated - showing buttons');
      collapsibleButtons.forEach(btn => {
        btn.classList.remove('collapsed');
      });
      expandButton.style.display = 'none';
      messageInput.blur();
      
      // 少し待ってからフラグをリセット
      setTimeout(() => {
        expandButtonProcessing = false;
      }, 300);
    }
    
    expandButton.addEventListener('click', handleExpandButton);
    expandButton.addEventListener('touchend', handleExpandButton);

    // メッセージエリアをタップした時にキーボードを閉じる（LINE風）
    var messagesContainer = document.getElementById('messagesContainer');
    messagesContainer.addEventListener('touchstart', function(e) {
      // メッセージ入力欄にフォーカスがある場合のみ
      if (document.activeElement === messageInput) {
        console.log('[Accordion] Messages area tapped - closing keyboard');
        messageInput.blur();
      }
    });

    // 画像プレビューは各アイテムの×ボタンで個別削除
    // clearAllImages()で全削除も可能
  }


  </script>
</div>
