<!-- SPA Fragment: product.html -->
<!-- Prefix: prd- -->
<div id="spa-page-product">
  <style>
    #spa-page-product {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    #spa-page-product .sub-header {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 56px;
      padding: 0 16px;
      background: #ffffff;
      border-bottom: 1px solid #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    #spa-page-product .sub-header-back {
      position: absolute;
      left: 16px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      cursor: pointer;
      color: #606060;
      font-size: 20px;
      transition: background 0.2s;
    }
    #spa-page-product .sub-header-back:hover { background: #f2f2f2; }
    #spa-page-product .sub-header-back:active { background: #e5e5e5; }
    #spa-page-product .sub-header-title {
      font-weight: 600;
      font-size: 16px;
      color: #1f2937;
    }
    #spa-page-product .sub-header-menu,
    #spa-page-product .sub-header-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: transparent;
      border: none;
      color: #374151;
      font-size: 20px;
      cursor: pointer;
    }
    #spa-page-product .sub-header-menu:hover,
    #spa-page-product .sub-header-icon:hover { background: #f3f4f6; }
    #spa-page-product .sub-header-menu:active,
    #spa-page-product .sub-header-icon:active { background: #e5e7eb; }
    #spa-page-product .sub-header-icons {
      position: absolute;
      right: 8px;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    #spa-page-product .settings-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 200px;
      padding: 8px 0;
      display: none;
      z-index: 1001;
    }
    #spa-page-product .settings-dropdown.active { display: block; }
    #spa-page-product .settings-dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border: none;
      background: none;
      width: 100%;
      font-size: 14px;
      color: #374151;
      cursor: pointer;
      text-align: left;
    }
    #spa-page-product .settings-dropdown-item:hover { background: #f3f4f6; }
    #spa-page-product .settings-dropdown-item i { font-size: 18px; color: #6b7280; width: 20px; text-align: center; }
    #spa-page-product .settings-dropdown-toggle { justify-content: space-between; }
    #spa-page-product .settings-dropdown-divider { height: 1px; background: #e5e7eb; margin: 4px 0; }
    #spa-page-product .toggle-switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }
    #spa-page-product .toggle-switch input { opacity: 0; width: 0; height: 0; }
    #spa-page-product .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 24px;
    }
    #spa-page-product .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }
    #spa-page-product input:checked + .toggle-slider { background-color: #40B4E5; }
    #spa-page-product input:checked + .toggle-slider:before { transform: translateX(20px); }

    /* Notification animation */
    @keyframes prdSlideDown {
      from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
  </style>

<!-- サブページヘッダー -->
<div class="sub-header" id="pageHeader" style="display: none;">
  <button class="sub-header-back" onclick="spaGoBack()" title="戻る">
    <i class="bi bi-chevron-left"></i>
  </button>
  <span class="sub-header-title">商品登録</span>
  <div class="sub-header-icons">
    <button class="sub-header-icon" onclick="navigateToPage('chat')" title="お知らせ">
      <i class="bi bi-bell"></i>
    </button>
    <div style="position: relative;">
      <button class="sub-header-icon" onclick="prdToggleSettingsDropdown(event)" title="メニュー">
        <i class="bi bi-list"></i>
      </button>
      <div class="settings-dropdown" id="settingsDropdown">
        <div class="settings-dropdown-item settings-dropdown-toggle">
          <div style="display: flex; align-items: center; gap: 12px;">
            <i class="bi bi-lightbulb" id="guideModeIcon"></i>
            <span>ヒント</span>
          </div>
          <label class="toggle-switch" onclick="event.stopPropagation()">
            <input type="checkbox" id="guideModeToggle" onchange="prdToggleGuideModeFromToggle(this.checked)">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="settings-dropdown-divider"></div>
        <button class="settings-dropdown-item" onclick="navigateToPage('config-product')">
          <i class="bi bi-sliders"></i>
          <span>商品登録設定</span>
        </button>
        <button class="settings-dropdown-item" onclick="navigateToPage('config-system')">
          <i class="bi bi-gear-wide-connected"></i>
          <span>システム設定</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- メインフォームコンテンツ（QR自動表示時は最初非表示） -->
<div id="mainFormContent" style="display: none;">

<!-- プラットフォーム切り替えタブ -->
<div class="platform-tabs-container">
  <div class="platform-tabs" id="platformTabs">
    <button class="platform-tab active" data-platform="mercari" onclick="prdSelectPlatform('mercari')">
      <img src="/images/platform/mercari.png" alt="メルカリ" class="platform-logo" style="width:18px;height:18px;">
      <span>メルカリ</span>
    </button>
    <button class="platform-tab" data-platform="mercari-shops" onclick="prdSelectPlatform('mercari-shops')">
      <img src="/images/platform/mercari-shops.png" alt="メルカリShops" class="platform-logo" style="width:18px;height:18px;">
      <span>メルカリShops</span>
    </button>
    <button class="platform-tab" data-platform="yahoo-fleamarket" onclick="prdSelectPlatform('yahoo-fleamarket')">
      <img src="/images/platform/yahoo-fleamarket.png" alt="Yahoo!フリマ" class="platform-logo" style="width:18px;height:18px;">
      <span>Yahoo!フリマ</span>
    </button>
    <button class="platform-tab" data-platform="yahoo-auction" onclick="prdSelectPlatform('yahoo-auction')">
      <img src="/images/platform/yahoo-auction.png" alt="Yahoo!オークション" class="platform-logo" style="width:18px;height:18px;">
      <span>Yahoo!オークション</span>
    </button>
    <button class="platform-tab" data-platform="rakuma" onclick="prdSelectPlatform('rakuma')">
      <img src="/images/platform/rakuma.png" alt="ラクマ" class="platform-logo" style="width:18px;height:18px;">
      <span>ラクマ</span>
    </button>
    <button class="platform-tab" data-platform="base" onclick="prdSelectPlatform('base')">
      <img src="/images/platform/base.png" alt="BASE" class="platform-logo" style="width:18px;height:18px;">
      <span>BASE</span>
    </button>
  </div>
</div>

<!-- メルカリ用コンテンツ -->
<div id="platform-content-mercari" class="platform-content">
<div class="content-container">

<!-- 仕入商品紐付けステータス -->
<div class="group qr-status-section" id="qrStatusSection" style="display: none;">
  <div id="qrScanStatus" style="padding: 12px; border-radius: 8px; background: #d1fae5; border: 1px solid #10b981;"></div>
  <input type="hidden" id="invId" name="invId" value="">
</div>

<div class="group management-section">
  <div class="group-title">管理番号</div>
  <div class="guide-hint" style="font-size: 11px; color: #6b7280; padding: 8px; background: #f9fafb; border-radius: 6px; border-left: 3px solid #d1d5db; margin: 8px 12px 12px 12px;">
    管理番号は在庫を識別するための番号です。頭文字は設定管理で自由にカスタマイズできます。
  </div>
  <div class="form-section">
    <div id="managementNumberFields" style="display: none;"></div>
    <div id="managementNumberPreview" style="margin-top: 8px; display: none;">
      <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">使用可能な管理番号</label>
      <div style="display: flex; gap: 4px; align-items: stretch;">
        <input id="管理番号" type="text" readonly placeholder="自動採番されます" class="mgmt-number-field" style="flex: 1; background: #f3f4f6; color: #1f2937; font-weight: 600; text-align: left; border: 1px solid #d1d5db; padding: 6px 8px;">
        <button type="button" onclick="prdAdjustManagementNumber(1)" class="mgmt-adjust-btn" style="width: 32px; padding: 0; border: 1px solid #d1d5db; background: white; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; border-radius: 4px;">&#9650;</button>
        <button type="button" onclick="prdAdjustManagementNumber(-1)" class="mgmt-adjust-btn" style="width: 32px; padding: 0; border: 1px solid #d1d5db; background: white; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; border-radius: 4px;">&#9660;</button>
      </div>
    </div>
    <div id="qrCodeSection" style="margin-top: 12px; display: none;">
      <button type="button" onclick="prdShowQRCodeModal()" class="qr-code-btn" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
        <i class="bi bi-qr-code" style="font-size: 18px;"></i>
        QRコード表示・印刷
      </button>
    </div>
    <div style="margin-top: 12px;">
      <label>担当者</label>
      <input type="text" id="担当者" readonly style="background-color: #f3f4f6; cursor: not-allowed;">
    </div>
  </div>
</div>

<div class="group basic-section">
  <div class="group-title">基本情報</div>
  <div class="guide-hint" style="font-size: 11px; color: #6b7280; padding: 8px; background: #f9fafb; border-radius: 6px; border-left: 3px solid #d1d5db; margin: 8px 12px 12px 12px;">
    商品の基本的な分類情報を入力します。カテゴリとブランドは商品名やAI説明文の生成に使用されます。
  </div>
  <div class="form-section category-cascade-section">
    <div class="section-title">カテゴリー</div>
    <div style="margin-top: 4px;">
      <select id="特大分類" class="category-cascade-select">
        <option value="">--選択してください--</option>
        <option value="ファッション">ファッション</option>
        <option value="ベビー・キッズ">ベビー・キッズ</option>
        <option value="ゲーム・おもちゃ・グッズ">ゲーム・おもちゃ・グッズ</option>
        <option value="ホビー・楽器・アート">ホビー・楽器・アート</option>
        <option value="チケット">チケット</option>
        <option value="本・雑誌・漫画">本・雑誌・漫画</option>
        <option value="CD・DVD・ブルーレイ">CD・DVD・ブルーレイ</option>
        <option value="スマホ・タブレット・パソコン">スマホ・タブレット・パソコン</option>
        <option value="テレビ・オーディオ・カメラ">テレビ・オーディオ・カメラ</option>
        <option value="生活家電・空調">生活家電・空調</option>
        <option value="スポーツ">スポーツ</option>
        <option value="アウトドア・釣り・旅行用品">アウトドア・釣り・旅行用品</option>
        <option value="コスメ・美容">コスメ・美容</option>
        <option value="ダイエット・健康">ダイエット・健康</option>
        <option value="食品・飲料・酒">食品・飲料・酒</option>
        <option value="キッチン・日用品・その他">キッチン・日用品・その他</option>
        <option value="家具・インテリア">家具・インテリア</option>
        <option value="ペット用品">ペット用品</option>
        <option value="DIY・工具">DIY・工具</option>
        <option value="フラワー・ガーデニング">フラワー・ガーデニング</option>
        <option value="ハンドメイド・手芸">ハンドメイド・手芸</option>
        <option value="車・バイク・自転車">車・バイク・自転車</option>
      </select>
    </div>
    <div style="margin-top: 8px;">
      <select id="大分類(カテゴリ)" class="category-cascade-select" disabled>
        <option value="">--選択してください--</option>
      </select>
    </div>
    <div style="margin-top: 8px;">
      <select id="中分類(カテゴリ)" class="category-cascade-select" disabled>
        <option value="">--選択してください--</option>
      </select>
    </div>
    <div style="margin-top: 8px;">
      <select id="小分類(カテゴリ)" class="category-cascade-select" disabled>
        <option value="">--選択してください--</option>
      </select>
    </div>
    <div id="saibunruiRow" style="display: none; margin-top: 8px;">
      <select id="細分類(カテゴリ)" class="category-cascade-select" disabled>
        <option value="">--選択してください--</option>
      </select>
    </div>
    <div style="display: none; margin-top: 8px;" id="saibunrui2Container">
      <select id="細分類2" class="category-cascade-select" disabled>
        <option value="">--選択してください--</option>
      </select>
    </div>
    <div style="margin-top: 8px;">
      <label>アイテム名</label>
      <select id="アイテム名" class="full category-cascade-select" disabled>
        <option value="">--選択してください--</option>
      </select>
    </div>
    <div style="margin-top: 8px;">
      <label>サイズ</label>
      <select id="サイズ">
        <option value="">--選択してください--</option>
      </select>
    </div>
    <div style="margin-top: 8px;">
      <label>商品の状態</label>
      <select id="商品の状態" onchange="prdOnConditionChange()">
        <option value="">--選択してください--</option>
      </select>
    </div>
    <input type="hidden" id="ランク">
    <div class="brand-field" style="margin-top: 8px; position: relative;">
      <label>ブランド</label>
      <input id="ブランド(英語)" autocomplete="off" placeholder="入力すると候補が表示されます">
      <div class="suggest" id="suggest-ブランド(英語)" hidden></div>
      <input type="hidden" id="ブランド(カナ)">
    </div>
  </div>
</div>

<div class="group title-section">
  <div class="group-title">商品名</div>
  <div class="guide-hint" style="font-size: 11px; color: #6b7280; padding: 8px; background: #f9fafb; border-radius: 6px; border-left: 3px solid #d1d5db; margin: 8px 12px 12px 12px;">
    各ブロックを並び替えて商品名の表示順を変更できます。チェックボックスでON/OFFも可能です。
  </div>
  <div style="margin-bottom: 12px;">
    <label style="display: flex; justify-content: space-between; align-items: center;">
      <span>商品名プレビュー</span>
      <span class="counter" id="nameCounter">
        <span id="nameCount">0</span>/<span id="nameMax">40</span> 文字
      </span>
    </label>
    <div class="preview-wrapper">
      <textarea id="商品名プレビュー" rows="2" placeholder="選択した値をスペース区切りで自動表示されます" style="margin-top: 4px;"></textarea>
      <button type="button" class="copy-icon-btn" onclick="prdCopyToClipboard('商品名プレビュー', 'copyNameBtn')" id="copyNameBtn" title="コピー">
        <i class="bi bi-copy"></i>
      </button>
    </div>
    <input id="商品名(タイトル)" type="hidden">
  </div>

  <div id="titleBlockContainer">
    <!-- セールスワードセクション -->
    <div class="form-section title-draggable-block" data-block-id="salesword" draggable="true">
      <h3 class="section-title" style="display: flex; align-items: center; gap: 8px;">
        <span class="drag-handle" style="cursor: move; font-size: 16px; color: #9ca3af;">&#8942;&#8942;</span>
        セールスワード
        <button type="button" class="collapse-btn" onclick="prdToggleTitleBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">&#9660;</button>
      </h3>
      <div class="section-content">
        <div style="margin-bottom: 12px; position: relative;">
          <div class="search-input-wrapper">
            <i class="bi bi-search search-input-icon"></i>
            <input type="text" id="saleswordSearch" class="full search-input-with-icon" placeholder="キーワードを入力して検索..." autocomplete="off">
          </div>
          <div id="saleswordSuggestList" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
        </div>
        <div class="row">
          <div>
            <label>カテゴリ</label>
            <select id="セールスワード(カテゴリ)" class="full">
              <option value="">--選択してください--</option>
            </select>
          </div>
          <div>
            <label>キーワード</label>
            <select id="セールスワード" class="full">
              <option value="">--選択してください--</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- ブランド情報セクション -->
    <div class="form-section title-draggable-block" data-block-id="brand" draggable="true">
      <h3 class="section-title" style="display: flex; align-items: center; gap: 8px;">
        <span class="drag-handle" style="cursor: move; font-size: 16px; color: #9ca3af;">&#8942;&#8942;</span>
        ブランド情報
        <button type="button" class="collapse-btn" onclick="prdToggleTitleBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">&#9660;</button>
      </h3>
      <div class="section-content">
        <div class="row">
          <div class="brand-field" style="position: relative;">
            <label>ブランド(英語)</label>
            <div style="display: flex; align-items: center; gap: 4px; width: 100%;">
              <input type="checkbox" id="商品名_ブランド(英語)_チェック" checked onchange="prdUpdateNamePreview()" style="width: 20px; flex-shrink: 0;">
              <input id="商品名_ブランド(英語)" autocomplete="off" placeholder="入力すると候補が表示されます" style="flex: 1; min-width: 0;">
            </div>
            <div class="suggest" id="suggest-商品名_ブランド(英語)" hidden></div>
          </div>
          <div class="brand-field" style="position: relative;">
            <label>ブランド(カナ)</label>
            <div style="display: flex; align-items: center; gap: 4px; width: 100%;">
              <input type="checkbox" id="商品名_ブランド(カナ)_チェック" checked onchange="prdUpdateNamePreview()" style="width: 20px; flex-shrink: 0;">
              <input id="商品名_ブランド(カナ)" autocomplete="off" placeholder="入力すると候補が表示されます" style="flex: 1; min-width: 0;">
            </div>
            <div class="suggest" id="suggest-商品名_ブランド(カナ)" hidden></div>
          </div>
        </div>
      </div>
    </div>

    <!-- アイテム名セクション -->
    <div class="form-section title-draggable-block" data-block-id="item" draggable="true">
      <h3 class="section-title" style="display: flex; align-items: center; gap: 8px;">
        <span class="drag-handle" style="cursor: move; font-size: 16px; color: #9ca3af;">&#8942;&#8942;</span>
        アイテム名
        <button type="button" class="collapse-btn" onclick="prdToggleTitleBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">&#9660;</button>
      </h3>
      <div class="section-content">
        <input id="商品名_アイテム名" type="text" placeholder="基本情報のアイテム名を選択するか、ここに直接入力" onchange="prdUpdateNamePreview()" oninput="prdUpdateNamePreview()" style="width: 100%;">
      </div>
    </div>

    <!-- 商品属性セクション -->
    <div class="form-section title-draggable-block" data-block-id="attribute" draggable="true">
      <h3 class="section-title" style="display: flex; align-items: center; gap: 8px;">
        <span class="drag-handle" style="cursor: move; font-size: 16px; color: #9ca3af;">&#8942;&#8942;</span>
        商品属性
        <button type="button" class="collapse-btn" onclick="prdToggleTitleBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">&#9660;</button>
      </h3>
      <div class="section-content">
        <div id="attributeList">
          <div class="attribute-item" data-index="1">
            <div class="attribute-header">
              <span>属性 1</span>
              <button type="button" class="remove-attribute-btn" onclick="prdRemoveProductAttribute(1)" style="display:none;">削除</button>
            </div>
            <div class="attribute-search-wrapper" style="margin-bottom: 8px; position: relative;">
              <input type="text" class="attribute-search-input" data-index="1" placeholder="属性を検索..." autocomplete="off" style="font-size: 16px; width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <div class="attribute-suggest-list" data-index="1" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
            </div>
            <div class="row" style="margin-top: 6px;">
              <div>
                <label>カテゴリ</label>
                <select id="商品属性1_カテゴリ">
                  <option value="">--選択してください--</option>
                </select>
              </div>
              <div>
                <label>値</label>
                <select id="商品属性1_値" disabled>
                  <option value="">--カテゴリを選択してください--</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        <button type="button" id="addAttributeBtn" class="add-attribute-btn">+ 商品属性を追加</button>
      </div>
    </div>
  </div><!-- /titleBlockContainer -->
</div>

<div class="group description-section">
  <div class="group-title">商品の説明</div>
  <div class="guide-hint" style="font-size: 11px; color: #6b7280; padding: 8px; background: #f9fafb; border-radius: 6px; border-left: 3px solid #d1d5db; margin: 8px 12px 12px 12px;">
    各ブロックを並び替えて説明文の構成を自由に変更できます。AI生成で魅力的な説明文を自動作成することも可能です。
  </div>
  <div style="margin-bottom: 12px;">
    <label style="display: flex; justify-content: space-between; align-items: center;">
      <span>商品の説明</span>
      <span class="counter" id="descCounter">
        <span id="descCount">0</span>/<span id="descMax">1000</span> 文字
      </span>
    </label>
    <div class="preview-wrapper">
      <textarea id="商品の説明" placeholder="商品の状態・素材・サイズ感・ディテール・注意点などを記入してください" style="margin-top: 4px; min-height: 120px; resize: none;"></textarea>
      <button type="button" class="copy-icon-btn" onclick="prdCopyToClipboard('商品の説明', 'copyDescBtn')" id="copyDescBtn" title="コピー">
        <i class="bi bi-copy"></i>
      </button>
    </div>
  </div>

  <div id="descriptionBlocksContainer">
    <!-- ブランド名セクション -->
    <div id="brandNameSection" class="form-section desc-draggable-block" data-block-type="brandName" style="margin-bottom: 12px; display: none;">
      <h3 class="section-title" style="display: flex; align-items: center;">
        <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">&#8942;&#8942;</span>
        <span class="section-icon">&#127991;&#65039;</span>ブランド名
        <button type="button" class="collapse-btn" onclick="prdToggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">&#9660;</button>
      </h3>
      <div class="section-content">
        <div class="guide-hint" style="font-size: 11px; color: #6b7280; padding: 8px; background: #f9fafb; border-radius: 6px; border-left: 3px solid #d1d5db; margin-bottom: 12px;">
          基本情報で選択したブランド名が自動的にプレビューに表示されます。
        </div>
      </div>
    </div>

    <!-- サイズ情報セクション -->
    <div id="sizeSection" class="form-section desc-draggable-block" data-block-type="size" style="margin-bottom: 12px; display: none;">
      <h3 class="section-title" style="display: flex; align-items: center;">
        <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">&#8942;&#8942;</span>
        <span id="sizeLabelDisplay">サイズ</span>
        <button type="button" class="collapse-btn" onclick="prdToggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">&#9660;</button>
      </h3>
      <div class="section-content">
        <!-- トップス/アウター用サイズ -->
        <div id="topsSize" style="display: none;">
          <div style="margin-bottom: 12px;">
            <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">サイズ(表記)</label>
            <select id="サイズ(表記)_トップス" style="width: 100%;"><option value="">--</option></select>
          </div>
          <div style="margin-bottom: 8px;">
            <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">サイズ(実寸)</label>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 4px;">
            <div><label class="small" id="shoulderWidthLabel">肩幅</label><div style="display: flex; align-items: center; gap: 4px;"><select id="肩幅" style="flex: 1;"><option value="">--</option></select><span style="font-size: 12px; color: #6b7280;">cm</span></div></div>
            <div><label class="small">身幅</label><div style="display: flex; align-items: center; gap: 4px;"><select id="身幅" style="flex: 1;"><option value="">--</option></select><span style="font-size: 12px; color: #6b7280;">cm</span></div></div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <div><label class="small">袖丈</label><div style="display: flex; align-items: center; gap: 4px;"><select id="袖丈" style="flex: 1;"><option value="">--</option></select><span style="font-size: 12px; color: #6b7280;">cm</span></div></div>
            <div><label class="small">着丈</label><div style="display: flex; align-items: center; gap: 4px;"><select id="着丈" style="flex: 1;"><option value="">--</option></select><span style="font-size: 12px; color: #6b7280;">cm</span></div></div>
          </div>
        </div>
        <!-- パンツ用サイズ -->
        <div id="bottomsSize" style="display: none;">
          <div style="margin-bottom: 12px;">
            <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">サイズ(表記)</label>
            <select id="サイズ(表記)_ボトムス" style="width: 100%;"><option value="">--</option></select>
          </div>
          <div style="margin-bottom: 8px;"><label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">サイズ(実寸)</label></div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 4px;">
            <div><label class="small">ウエスト</label><div style="display: flex; align-items: center; gap: 4px;"><select id="ウエスト" style="flex: 1;"><option value="">--</option></select><span style="font-size: 12px; color: #6b7280;">cm</span></div></div>
            <div><label class="small">ヒップ</label><div style="display: flex; align-items: center; gap: 4px;"><select id="ヒップ" style="flex: 1;"><option value="">--</option></select><span style="font-size: 12px; color: #6b7280;">cm</span></div></div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <div><label class="small">股上</label><div style="display: flex; align-items: center; gap: 4px;"><select id="股上" style="flex: 1;"><option value="">--</option></select><span style="font-size: 12px; color: #6b7280;">cm</span></div></div>
            <div><label class="small">股下</label><div style="display: flex; align-items: center; gap: 4px;"><select id="股下" style="flex: 1;"><option value="">--</option></select><span style="font-size: 12px; color: #6b7280;">cm</span></div></div>
          </div>
        </div>
        <!-- 靴用サイズ -->
        <div id="shoesSize" style="display: none;">
          <div style="margin-bottom: 12px;"><label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">サイズ(表記)</label><select id="サイズ(表記)_靴" style="width: 100%;"><option value="">--</option></select></div>
          <div style="margin-bottom: 12px;"><label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">その他のサイズ表記</label><input type="text" id="その他のサイズ表記_靴" placeholder="例: US8, EU38" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;"></div>
          <div style="margin-bottom: 12px;"><label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">普段のサイズ</label><input type="text" id="普段のサイズ_靴" placeholder="例: 普段は25.0cmを履いています" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;"></div>
          <div style="margin-bottom: 12px;"><label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">フィット感・注意点</label><textarea id="フィット感_靴" placeholder="例: 細めの作りです。普段より0.5cm大きめをおすすめします" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; min-height: 60px; resize: vertical;"></textarea></div>
        </div>
      </div>
    </div>

    <!-- カラー(詳細)セクション -->
    <div class="form-section desc-draggable-block" data-block-type="color" style="margin-bottom: 12px;">
      <h3 class="section-title" style="display: flex; align-items: center;">
        <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">&#8942;&#8942;</span>
        カラー(詳細)
        <button type="button" class="collapse-btn" onclick="prdToggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">&#9660;</button>
      </h3>
      <div class="section-content">
        <div class="guide-hint" style="font-size: 11px; color: #6b7280; padding: 8px; background: #f9fafb; border-radius: 6px; border-left: 3px solid #d1d5db; margin-bottom: 12px;">
          複数カラーの商品は「カラーを追加」で登録できます。
        </div>
        <div id="colorList">
          <div class="color-item" data-index="1">
            <div class="color-header"><span>カラー 1</span><button type="button" class="remove-color-btn" onclick="prdRemoveColor(1)" style="display:none;">削除</button></div>
            <div class="color-search-wrapper" style="margin-bottom: 8px; position: relative;">
              <input type="text" class="color-search-input" data-index="1" placeholder="カラーを検索..." autocomplete="off" style="font-size: 16px; width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <div class="color-suggest-list" data-index="1" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
            </div>
            <div class="color-fields">
              <label>色:<select id="カラー1" class="color-select"><option value="">--</option></select></label>
            </div>
          </div>
        </div>
        <button type="button" id="addColorBtn" class="add-color-btn">+ カラーを追加</button>
      </div>
    </div>

    <!-- 商品状態(詳細)セクション -->
    <div class="form-section desc-draggable-block" data-block-type="condition" style="margin-bottom: 12px;">
      <h3 class="section-title" style="display: flex; align-items: center;">
        <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">&#8942;&#8942;</span>
        商品状態(詳細)
        <button type="button" class="collapse-btn" onclick="prdToggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">&#9660;</button>
      </h3>
      <div class="section-content">
        <div class="guide-hint" style="font-size: 11px; color: #6b7280; padding: 8px; background: #f9fafb; border-radius: 6px; border-left: 3px solid #d1d5db; margin-bottom: 12px;">
          ボタンをタップして定型文を素早く挿入できます。
        </div>
        <div id="conditionRankBadge" style="display: none; margin-bottom: 10px; padding: 6px 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px;">
          <span style="font-size: 13px; color: #495057;">ランク: <span id="conditionRankDisplay" style="font-weight: 600; color: #212529;"></span></span>
        </div>
        <div id="quickInsertButtonsContainer" class="quick-insert-buttons" style="margin-bottom: 8px;"></div>
        <div style="position: relative;">
          <textarea id="商品状態詳細" rows="3" placeholder="商品の詳細な状態を入力してください（傷、汚れ、使用感など）"></textarea>
          <div id="suggest-商品状態詳細" class="suggest" hidden></div>
        </div>
        <div id="damageMarkerPreviewSection" style="display: none; margin-top: 12px; padding: 12px; background: #fffbeb; border: 1px solid #fcd34d; border-radius: 8px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span style="font-size: 14px; font-weight: 600; color: #92400e;">傷・汚れマーキング</span>
            <span id="damageMarkerTypeLabel" style="font-size: 12px; color: #78716c;"></span>
          </div>
          <img id="damageMarkerPreviewImg" src="" alt="傷・汚れマーキング" style="max-width: 100%; border-radius: 6px; border: 1px solid #e5e7eb;">
          <div id="damageMarkerNoteSection" style="display: none; margin-top: 8px; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e5e7eb;">
            <div style="font-size: 11px; color: #78716c; margin-bottom: 4px;">補足説明</div>
            <div id="damageMarkerNoteText" style="font-size: 13px; color: #374151; white-space: pre-wrap;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 素材入力セクション -->
    <div class="form-section desc-draggable-block" data-block-type="material" style="margin-bottom: 12px;">
      <h3 class="section-title" style="display: flex; align-items: center;">
        <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">&#8942;&#8942;</span>
        素材
        <button type="button" class="collapse-btn" onclick="prdToggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">&#9660;</button>
      </h3>
      <div class="section-content">
        <div id="materialList">
          <div class="material-item" data-index="1">
            <div class="material-header"><span>素材 1</span><button type="button" class="remove-material-btn" onclick="prdRemoveMaterial(1)" style="display:none;">削除</button></div>
            <div class="material-fields">
              <label>箇所:<select id="素材1_箇所" class="material-location"><option value="">--</option></select></label>
              <div class="material-composition" data-material-index="1">
                <div class="composition-row" data-row-index="1">
                  <label>種類:<select id="素材1_種類1" class="material-type"><option value="">--</option></select></label>
                  <label>割合:<select id="素材1_％1" class="material-percent"><option value="">--%</option></select></label>
                  <button type="button" class="remove-composition-btn" onclick="prdRemoveCompositionRow(1, 1)" style="display:none;">&#215;</button>
                </div>
              </div>
              <button type="button" class="add-composition-btn" onclick="prdAddCompositionRow(1)">+ 種類を追加</button>
            </div>
          </div>
        </div>
        <button type="button" id="addMaterialBtn" class="add-material-btn">+ 素材を追加</button>
      </div>
    </div>

    <!-- 付属品セクション -->
    <div class="form-section desc-draggable-block" data-block-type="accessories" style="margin-bottom: 12px;">
      <h3 class="section-title" style="display: flex; align-items: center;">
        <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">&#8942;&#8942;</span>
        付属品
        <button type="button" class="collapse-btn" onclick="prdToggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">&#9660;</button>
      </h3>
      <div class="section-content">
        <div id="accessoriesCheckboxes" class="accessories-checkboxes" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
        <div id="accessoryOtherInputContainer" style="display: none; margin-top: 12px;">
          <label style="font-size: 12px; color: #374151; font-weight: 500;">その他の付属品（自由入力）</label>
          <input type="text" id="accessoryOtherText" placeholder="例: オリジナルハンガー、購入レシート" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; margin-top: 4px;">
        </div>
      </div>
    </div>

    <!-- AI生成ブロック -->
    <div class="form-section desc-draggable-block" data-block-type="aiGeneration" style="margin-bottom: 12px;">
      <h3 class="section-title" style="display: flex; align-items: center;">
        <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">&#8942;&#8942;</span>
        AI生成
        <button type="button" class="collapse-btn" onclick="prdToggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">&#9660;</button>
      </h3>
      <div class="section-content">
        <div class="guide-hint" style="font-size: 11px; color: #6b7280; margin-bottom: 12px; padding: 8px; background: #f9fafb; border-radius: 6px; border-left: 3px solid #d1d5db;">
          以下の情報を入力してAI生成ボタンを押すと、魅力的な商品説明文が自動生成されます。
        </div>
        <!-- 追加属性 -->
        <div class="ai-sub-block" style="margin-bottom: 12px; padding: 12px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px;">
          <h4 style="display: flex; align-items: center; margin: 0 0 8px 0; font-size: 13px; font-weight: 600; color: #374151; cursor: pointer;" onclick="prdToggleAiSubBlock(this)">
            追加属性（任意）
            <button type="button" class="ai-sub-collapse-btn" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 12px; color: #6b7280; padding: 0 8px;">&#9654;</button>
          </h4>
          <div class="ai-sub-content" style="display: none;">
            <textarea id="AI用商品属性" rows="3" placeholder="商品の詳細な属性を入力してください（例: ヴィンテージ、90年代、USA製）" style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 13px; font-family: inherit; resize: vertical;"></textarea>
          </div>
        </div>
        <!-- 品番・製番 -->
        <div class="ai-sub-block" style="margin-bottom: 12px; padding: 12px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px;">
          <h4 style="display: flex; align-items: center; margin: 0 0 8px 0; font-size: 13px; font-weight: 600; color: #374151; cursor: pointer;" onclick="prdToggleAiSubBlock(this)">
            品番・製番（任意）
            <button type="button" class="ai-sub-collapse-btn" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 12px; color: #6b7280; padding: 0 8px;">&#9654;</button>
          </h4>
          <div class="ai-sub-content" style="display: none;">
            <input type="text" id="品番型番" placeholder="例: 555088-101, DM0522-100" style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 13px;">
          </div>
        </div>
        <!-- 商品画像（AI用） -->
        <div class="ai-sub-block" style="margin-bottom: 12px; padding: 12px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px;">
          <h4 style="display: flex; align-items: center; margin: 0 0 8px 0; font-size: 13px; font-weight: 600; color: #374151; cursor: pointer;" onclick="prdToggleAiSubBlock(this)">
            商品画像（任意）
            <button type="button" class="ai-sub-collapse-btn" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 12px; color: #6b7280; padding: 0 8px;">&#9654;</button>
          </h4>
          <div class="ai-sub-content" style="display: none;">
            <input type="file" id="productImages" accept="image/*" multiple style="display: none;" onchange="prdHandleImageUpload(event)">
            <button type="button" onclick="document.getElementById('productImages').click()" style="padding: 10px 16px; background: #e0f2fe; border: 2px dashed #0ea5e9; border-radius: 6px; color: #0369a1; font-size: 13px; cursor: pointer; width: 100%; font-weight: 500; margin-bottom: 12px;">
              <i class="bi bi-camera" style="margin-right: 6px;"></i>画像を選択
            </button>
            <div id="imagePreviewContainer" style="display: none;">
              <div style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 8px;"><span>AI生成用: <span id="aiImageCount">0</span>/3</span></div>
              <div id="imagePreviewList" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
            </div>
          </div>
        </div>
        <div style="margin-top: 12px; text-align: center;">
          <a href="javascript:void(0);" class="btn btn-gradient" id="aiGenBtn" onclick="prdGenerateAiDescription()"><span>AI生成</span></a>
        </div>
      </div>
    </div>

    <!-- 割引情報 -->
    <div class="form-section desc-draggable-block" data-block-type="discount" style="margin-bottom: 12px;">
      <h3 class="section-title" style="display: flex; align-items: center;">
        <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">&#8942;&#8942;</span>
        割引情報
        <button type="button" class="collapse-btn" onclick="prdToggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">&#9660;</button>
      </h3>
      <div id="discountSection" class="section-content collapsible-content">
        <div id="discountCheckboxContainer" style="padding: 8px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
          <div style="font-size: 11px; color: #6b7280; text-align: center;">読み込み中...</div>
        </div>
      </div>
    </div>

    <!-- オリジナルハッシュタグ -->
    <div class="form-section desc-draggable-block" data-block-type="hashtag" style="margin-bottom: 12px;">
      <h3 class="section-title" style="display: flex; align-items: center;">
        <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">&#8942;&#8942;</span>
        オリジナルハッシュタグ
        <button type="button" class="collapse-btn" onclick="prdToggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">&#9660;</button>
      </h3>
      <div id="hashtagSection" class="section-content collapsible-content">
        <div id="hashtagCheckboxContainer" style="padding: 8px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
          <div style="font-size: 11px; color: #6b7280; text-align: center;">読み込み中...</div>
        </div>
      </div>
    </div>
  </div><!-- /descriptionBlocksContainer -->
</div>

<!-- 商品画像 -->
<div class="group product-images-section" id="productImagesBlock" style="display: none;">
  <div class="group-title">商品画像</div>
  <div class="guide-hint" style="font-size: 11px; color: #6b7280; padding: 8px; background: #f9fafb; border-radius: 6px; border-left: 3px solid #d1d5db; margin: 8px 12px 12px 12px; line-height: 1.6;">
    フリマ、ECサイトなどに出品する画像をアップロードします（最大20枚）
  </div>
  <div class="form-section">
    <div style="margin-bottom: 16px;">
      <input type="file" id="productImagesForSave" accept="image/*" multiple style="display: none;" onchange="prdHandleProductImageUpload(event)">
      <button type="button" onclick="document.getElementById('productImagesForSave').click()" style="padding: 10px 16px; background: #e0f2fe; border: 2px dashed #0ea5e9; border-radius: 6px; color: #0369a1; font-size: 13px; cursor: pointer; width: 100%; font-weight: 500;">
        <i class="bi bi-camera" style="margin-right: 6px;"></i>画像を選択
      </button>
    </div>
    <div id="productImagesPreviewContainer" style="display: none;">
      <div style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
        <span>アップロード済み（<span id="productImageCount">0</span>/20）</span>
        <button type="button" onclick="prdClearAllProductImages()" style="padding: 4px 8px; background: white; border: 1px solid #ef4444; border-radius: 4px; color: #ef4444; font-size: 11px; cursor: pointer; font-weight: 500;" title="すべての画像を削除">すべて削除</button>
      </div>
      <div id="productImagesPreviewList" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
    </div>
  </div>
</div>

<!-- 配送について -->
<div class="group shipping-section">
  <div class="group-title">配送について</div>
  <div class="form-section">
    <div class="row">
      <div><label>配送料の負担</label><select id="配送料の負担"><option value="">選択してください</option></select></div>
      <div><label>配送の方法</label><select id="配送の方法"><option value="">選択してください</option></select></div>
    </div>
    <div class="row" style="margin-top:4px;">
      <div><label>発送元の地域</label><select id="発送元の地域"><option value="">選択してください</option></select></div>
      <div><label>発送までの日数</label><select id="発送までの日数"><option value="">選択してください</option></select></div>
    </div>
  </div>
</div>

<!-- 仕入情報 -->
<div class="group purchase-section">
  <div class="group-title">仕入情報</div>
  <div class="form-section">
    <div class="row">
      <div><label>仕入日</label><input id="仕入日" type="date"></div>
      <div><label>仕入先</label><select id="仕入先"><option value="">--選択してください--</option></select></div>
    </div>
    <div style="margin-top: 8px;">
      <label>仕入金額</label>
      <input id="仕入金額" type="number" min="0" step="1" placeholder="0">
    </div>
  </div>
</div>

<!-- 出品情報 -->
<div class="group listing-section">
  <div class="group-title">出品情報</div>
  <div class="form-section">
    <div class="row">
      <div><label>出品日</label><input id="出品日" type="date"></div>
      <div><label>出品先</label><select id="出品先"><option value="">--選択してください--</option></select></div>
    </div>
    <div id="sales-type-container" style="margin-top: 8px; display: none;">
      <label style="font-size: 12px; color: #374151; margin-bottom: 4px; display: block;">販売タイプ</label>
      <select id="salesType" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background: white;">
        <option value="fixed" selected>価格を設定する</option>
        <option value="auction">オークション形式</option>
      </select>
    </div>
    <div style="margin-top: 8px;">
      <label id="listing-price-label">出品金額</label>
      <div style="position: relative;">
        <input id="出品金額" type="number" min="0" step="1" placeholder="0">
        <span id="auction-suffix" style="display: none; position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #6b7280; font-size: 14px;">~</span>
      </div>
    </div>
  </div>
</div>

<div class="actions">
  <button onclick="prdOnSave()">保存</button>
  <button id="resetButton" onclick="prdOnReset()">リセット</button>
</div>
<div class="msg" id="msg"></div>

</div><!-- /content-container -->
</div><!-- /platform-content-mercari -->

<!-- 他プラットフォーム（Coming Soon） -->
<div id="platform-content-mercari-shops" class="platform-content" style="display: none;">
  <div class="content-container"><div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; padding: 40px 20px; text-align: center;">
    <img src="/images/platform/mercari-shops.png" alt="メルカリShops" style="width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.6;">
    <h2 style="font-size: 20px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">メルカリShops</h2>
    <p style="font-size: 14px; color: #6b7280; margin: 0 0 24px 0;">このプラットフォームは現在開発中です</p>
    <span style="display: inline-block; background: #fef3c7; color: #b45309; font-size: 12px; font-weight: 600; padding: 6px 16px; border-radius: 20px;">Coming Soon</span>
  </div></div>
</div>
<div id="platform-content-yahoo-fleamarket" class="platform-content" style="display: none;">
  <div class="content-container"><div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; padding: 40px 20px; text-align: center;">
    <img src="/images/platform/yahoo-fleamarket.png" alt="Yahoo!フリマ" style="width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.6;">
    <h2 style="font-size: 20px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">Yahoo!フリマ</h2>
    <p style="font-size: 14px; color: #6b7280; margin: 0 0 24px 0;">このプラットフォームは現在開発中です</p>
    <span style="display: inline-block; background: #fef3c7; color: #b45309; font-size: 12px; font-weight: 600; padding: 6px 16px; border-radius: 20px;">Coming Soon</span>
  </div></div>
</div>
<div id="platform-content-yahoo-auction" class="platform-content" style="display: none;">
  <div class="content-container"><div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; padding: 40px 20px; text-align: center;">
    <img src="/images/platform/yahoo-auction.png" alt="Yahoo!オークション" style="width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.6;">
    <h2 style="font-size: 20px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">Yahoo!オークション</h2>
    <p style="font-size: 14px; color: #6b7280; margin: 0 0 24px 0;">このプラットフォームは現在開発中です</p>
    <span style="display: inline-block; background: #fef3c7; color: #b45309; font-size: 12px; font-weight: 600; padding: 6px 16px; border-radius: 20px;">Coming Soon</span>
  </div></div>
</div>
<div id="platform-content-rakuma" class="platform-content" style="display: none;">
  <div class="content-container"><div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; padding: 40px 20px; text-align: center;">
    <img src="/images/platform/rakuma.png" alt="ラクマ" style="width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.6;">
    <h2 style="font-size: 20px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">ラクマ</h2>
    <p style="font-size: 14px; color: #6b7280; margin: 0 0 24px 0;">このプラットフォームは現在開発中です</p>
    <span style="display: inline-block; background: #fef3c7; color: #b45309; font-size: 12px; font-weight: 600; padding: 6px 16px; border-radius: 20px;">Coming Soon</span>
  </div></div>
</div>
<div id="platform-content-base" class="platform-content" style="display: none;">
  <div class="content-container"><div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; padding: 40px 20px; text-align: center;">
    <img src="/images/platform/base.png" alt="BASE" style="width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.6;">
    <h2 style="font-size: 20px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">BASE</h2>
    <p style="font-size: 14px; color: #6b7280; margin: 0 0 24px 0;">このプラットフォームは現在開発中です</p>
    <span style="display: inline-block; background: #fef3c7; color: #b45309; font-size: 12px; font-weight: 600; padding: 6px 16px; border-radius: 20px;">Coming Soon</span>
  </div></div>
</div>

<!-- QRコードモーダル -->
<div id="qrCodeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
  <div style="background: white; border-radius: 16px; padding: 24px; max-width: 360px; width: 90%; text-align: center;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <h5 style="margin: 0; font-weight: 600;">QRコード</h5>
      <button onclick="prdCloseQRCodeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&#215;</button>
    </div>
    <div id="qrCodeContainer" style="margin: 16px auto; padding: 16px; background: white; border: 2px solid #e5e7eb; border-radius: 12px;">
      <canvas id="qrCodeCanvas"></canvas>
    </div>
    <div id="qrCodeInfo" style="margin-bottom: 16px; text-align: left; background: #f9fafb; border-radius: 8px; padding: 12px;">
      <div style="font-size: 12px; color: #6b7280;">管理番号</div>
      <div id="qrMgmtNumber" style="font-weight: 700; font-size: 18px; color: #1f2937;"></div>
      <div id="qrProductName" style="font-size: 13px; color: #374151; margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></div>
    </div>
    <div style="display: flex; gap: 8px;">
      <button onclick="prdDownloadQRCode()" style="flex: 1; padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;"><i class="bi bi-download"></i> 保存</button>
      <button onclick="prdPrintQRCode()" style="flex: 1; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;"><i class="bi bi-printer"></i> 印刷</button>
    </div>
    <div style="margin-top: 12px; font-size: 11px; color: #9ca3af;">棚卸時にスマホでスキャンすると<br>商品情報を素早く呼び出せます</div>
  </div>
</div>

<!-- QRスキャン フローティングボタン -->
<button id="qrFloatingBtn" onclick="prdOpenQRScanner()" style="position: fixed; bottom: calc(100px + env(safe-area-inset-bottom, 0px)); right: 20px; width: 68px; height: 68px; border-radius: 50%; background: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.25); cursor: pointer; z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 14px; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.3)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.25)';">
  <img src="/images/qr-scan-icon.png" alt="QRスキャン" style="width: 100%; height: 100%; object-fit: contain;">
</button>

</div><!-- /mainFormContent -->

<!-- QRスキャナーモーダル -->
<div id="qrScannerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center;">
  <div style="background: white; border-radius: 16px; width: 90%; max-width: 400px; overflow: hidden;">
    <div style="padding: 16px; background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%); color: white; position: relative; text-align: center;">
      <span style="font-weight: 600; font-size: 18px;">QRスキャン</span>
      <button onclick="prdCloseQRScanner()" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
    </div>
    <div style="position: relative; width: 100%;">
      <div id="qrReader" style="width: 100%;"></div>
      <div id="qrOverlayText" style="display: none; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; white-space: nowrap; pointer-events: none;">
        枠内にQRコードを合わせてください
      </div>
    </div>
    <div style="padding: 16px; text-align: center;">
      <p style="font-size: 14px; color: #6b7280; margin-bottom: 12px;">商品タグのQRコードをカメラにかざしてください</p>
      <button onclick="prdManualInvIdInput()" style="padding: 10px 20px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer;">
        <i class="bi bi-keyboard"></i> 手動で入力
      </button>
      <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
        <label style="display: flex; align-items: center; justify-content: center; gap: 12px; cursor: pointer; font-size: 14px; color: #374151;">
          <span>商品登録時に自動表示</span>
          <div style="position: relative; width: 50px; height: 28px;">
            <input type="checkbox" id="qrAutoOpenToggle" onchange="prdToggleQrAutoOpen()" style="opacity: 0; width: 0; height: 0;">
            <span id="qrToggleTrack" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e5e7eb; transition: 0.3s; border-radius: 28px;"></span>
            <span id="qrToggleThumb" style="position: absolute; content: ''; height: 22px; width: 22px; left: 3px; bottom: 3px; background-color: white; transition: 0.3s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
          </div>
        </label>
        <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">オフにすると、右下のボタンから手動で開けます</p>
      </div>
    </div>
  </div>
</div>

<script>
  // ============================================
  // SPA Fragment: product.html - Script Section
  // Prefix: prd (functions), _prd_ (variables)
  // ============================================

  // Fragment-scoped state
  var _prd_initialized = false;
  var _prd_scriptsLoaded = false;
  var _prd_dynamicCSSLink = null;
  var _prd_dropdownClickHandler = null;
  var _prd_messageHandler = null;
  var _prd_qrModalClickHandler = null;
  var _prd_mgmtNumberObserver = null;
  var _prd_mgmtNumberInputHandler = null;
  var _prd_mgmtNumberChangeHandler = null;
  var _prd_qrScanner = null;

  // ============================================
  // Dynamic script/CSS loading helpers
  // ============================================

  /**
   * Load an external script dynamically (non-module)
   */
  function _prdLoadScript(src) {
    return new Promise(function(resolve, reject) {
      var existing = document.querySelector('script[src="' + src + '"]');
      if (existing) {
        resolve();
        return;
      }
      var script = document.createElement('script');
      script.src = src;
      script.onload = resolve;
      script.onerror = function() { reject(new Error('Failed to load: ' + src)); };
      document.head.appendChild(script);
    });
  }

  /**
   * Load an external CSS file dynamically
   */
  function _prdLoadCSS(href) {
    var existing = document.querySelector('link[href="' + href + '"]');
    if (existing) return;
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = href;
    link.id = 'dynamic-css';
    document.head.appendChild(link);
    _prd_dynamicCSSLink = link;
  }

  /**
   * Remove dynamically loaded CSS
   */
  function _prdRemoveCSS() {
    if (_prd_dynamicCSSLink) {
      _prd_dynamicCSSLink.remove();
      _prd_dynamicCSSLink = null;
    }
    // Also check by ID
    var el = document.getElementById('dynamic-css');
    if (el) el.remove();
  }

  // ============================================
  // Settings Dropdown & Guide Mode (from line 247)
  // ============================================

  function prdToggleSettingsDropdown(event) {
    event.stopPropagation();
    var dropdown = document.getElementById('settingsDropdown');
    if (dropdown) dropdown.classList.toggle('active');
  }

  function prdToggleGuideModeFromToggle(isOn) {
    prdToggleGuideMode(isOn);
    prdUpdateGuideModeUI(isOn);
  }

  function prdToggleGuideMode(isOn) {
    var wrapper = document.getElementById('spa-page-product');
    if (isOn) {
      if (wrapper) wrapper.classList.add('guide-mode-on');
      localStorage.setItem('guideMode', 'on');
    } else {
      if (wrapper) wrapper.classList.remove('guide-mode-on');
      localStorage.setItem('guideMode', 'off');
    }
  }

  function prdUpdateGuideModeUI(isOn) {
    var toggle = document.getElementById('guideModeToggle');
    var icon = document.getElementById('guideModeIcon');
    if (toggle) toggle.checked = isOn;
    if (icon) icon.style.color = isOn ? '#40B4E5' : '';
  }

  function prdInitGuideMode() {
    var guideMode = localStorage.getItem('guideMode');
    if (guideMode === 'on') {
      var wrapper = document.getElementById('spa-page-product');
      if (wrapper) wrapper.classList.add('guide-mode-on');
      prdUpdateGuideModeUI(true);
    }
  }

  // ============================================
  // FCM Token (from line 1378)
  // ============================================
  // FCM token is set by parent SPA; we just ensure the global exists
  if (typeof window.GLOBAL_FCM_TOKEN === 'undefined') {
    window.GLOBAL_FCM_TOKEN = '';
  }

  // ============================================
  // Platform Switching (from line 1383)
  // ============================================

  // Platform state - use window globals since product-scripts.js references them
  if (!window.currentPlatform) window.currentPlatform = 'mercari';

  if (!window.platformConfig) {
    window.platformConfig = {
      'mercari': { name: 'メルカリ', enabled: true, color: '#FF0211', features: ['standard'] },
      'mercari-shops': { name: 'メルカリShops', enabled: false, color: '#FF5722', features: ['shops', 'business'] },
      'yahoo-fleamarket': { name: 'Yahoo!フリマ', enabled: false, color: '#FF0033', features: ['yahoo'] },
      'yahoo-auction': { name: 'ヤフオク!', enabled: false, color: '#FF6600', features: ['auction', 'bidding'] },
      'rakuma': { name: 'ラクマ', enabled: false, color: '#E91E63', features: ['rakuten'] },
      'base': { name: 'BASE', enabled: false, color: '#000000', features: ['ec', 'shop'] }
    };
  }

  if (!window.registrationMode) window.registrationMode = 'individual';

  function prdInitPlatformTabs() {
    try {
      var config = JSON.parse(localStorage.getItem('config') || '{}');
      var platformSettings = config['プラットフォーム設定'];

      if (!platformSettings) {
        console.log('[Prd Platform] 設定なし。デフォルト表示（メルカリのみ）');
        prdHidePlatformTabsExcept(['mercari']);
        return;
      }

      console.log('[Prd Platform] 設定を読み込み:', platformSettings);
      window.registrationMode = platformSettings.registrationMode || 'individual';

      if (platformSettings.platforms && Array.isArray(platformSettings.platforms)) {
        var enabledPlatforms = platformSettings.platforms.filter(function(p) { return p.enabled; });

        enabledPlatforms.forEach(function(p) {
          if (!window.platformConfig[p.id]) {
            prdAddCustomPlatformTab(p);
          }
        });

        var enabledIds = enabledPlatforms.map(function(p) { return p.id; });

        if (enabledIds.length > 0) {
          prdHidePlatformTabsExcept(enabledIds);
          prdSelectPlatform(enabledIds[0]);
        } else {
          prdHidePlatformTabsExcept(['mercari']);
        }
      }

      prdUpdateRegistrationModeUI();
    } catch (e) {
      console.error('[Prd Platform] 初期化エラー:', e);
      prdHidePlatformTabsExcept(['mercari']);
    }
  }

  function prdAddCustomPlatformTab(platform) {
    var tabsContainer = document.getElementById('platformTabs');
    if (!tabsContainer) return;

    if (tabsContainer.querySelector('.platform-tab[data-platform="' + platform.id + '"]')) return;

    var tabButton = document.createElement('button');
    tabButton.className = 'platform-tab';
    tabButton.dataset.platform = platform.id;
    tabButton.onclick = function() { prdSelectPlatform(platform.id); };

    var iconSrc = platform.icon || '/images/platform/default.png';
    tabButton.innerHTML = '<img src="' + iconSrc + '" alt="' + platform.name + '" class="platform-logo" style="width:18px;height:18px;" onerror="this.src=\'/images/platform/default.png\'">' +
      '<span>' + platform.name + '</span>';

    tabsContainer.appendChild(tabButton);

    window.platformConfig[platform.id] = {
      name: platform.name,
      enabled: true,
      color: '#40B4E5',
      features: ['custom'],
      isCustom: true
    };
  }

  function prdHidePlatformTabsExcept(enabledIds) {
    var wrapper = document.getElementById('spa-page-product');
    if (!wrapper) return;

    var tabs = wrapper.querySelectorAll('.platform-tab');
    tabs.forEach(function(tab) {
      var platformId = tab.dataset.platform;
      tab.style.display = enabledIds.indexOf(platformId) >= 0 ? '' : 'none';
    });

    var visibleTabs = wrapper.querySelectorAll('.platform-tab:not([style*="display: none"])');
    var tabsContainer = wrapper.querySelector('.platform-tabs-container');
    if (tabsContainer) {
      tabsContainer.style.display = visibleTabs.length <= 1 ? 'none' : '';
    }
  }

  function prdUpdateRegistrationModeUI() {
    if (window.registrationMode === 'batch') {
      console.log('[Prd Platform] 一括登録モード - UI調整（将来実装）');
    }
  }

  function prdSelectPlatform(platformId) {
    var config = window.platformConfig[platformId];
    if (!config) {
      console.error('[Prd Platform] 不明なプラットフォーム:', platformId);
      return;
    }

    var wrapper = document.getElementById('spa-page-product');
    if (!wrapper) return;

    var tabs = wrapper.querySelectorAll('.platform-tab');
    tabs.forEach(function(tab) {
      if (tab.dataset.platform === platformId) {
        tab.classList.add('active');
      } else {
        tab.classList.remove('active');
      }
    });

    var allContents = wrapper.querySelectorAll('.platform-content');
    allContents.forEach(function(content) { content.style.display = 'none'; });

    var contentId = 'platform-content-' + platformId;
    var targetContent = document.getElementById(contentId);

    if (!targetContent && config.isCustom) {
      contentId = 'platform-content-mercari';
      targetContent = document.getElementById(contentId);
    }

    if (targetContent) targetContent.style.display = 'block';

    window.currentPlatform = platformId;
    console.log('[Prd Platform] 切り替え:', config.name);
  }
  // Expose for HTML onclick handlers
  window.selectPlatform = prdSelectPlatform;

  // ============================================
  // Config Reload from localStorage (from line 1747)
  // ============================================

  function prdReloadConfigFromLocalStorage() {
    try {
      console.log('[Prd] localStorageから設定を再読み込み中...');

      if (!window.CACHED_CONFIG) window.CACHED_CONFIG = {};

      var keys = window.CONFIG_STORAGE_KEYS;
      if (!keys) {
        console.warn('[Prd] CONFIG_STORAGE_KEYS not available yet');
        return;
      }

      var conditionButtons = localStorage.getItem(keys.CONDITION_BUTTONS);
      var hashtag = localStorage.getItem(keys.HASHTAG);
      var discount = localStorage.getItem(keys.DISCOUNT);
      var shippingDefault = localStorage.getItem(keys.SHIPPING_DEFAULT);
      var procureListingDefault = localStorage.getItem(keys.PROCURE_LISTING_DEFAULT);
      var managementNumber = localStorage.getItem(keys.MANAGEMENT_NUMBER);
      var salesword = localStorage.getItem(keys.SALESWORD);
      var aiSettings = localStorage.getItem(keys.AI_SETTINGS);
      var theme = localStorage.getItem(keys.DESIGN_THEME);

      if (conditionButtons) window.CACHED_CONFIG['商品状態ボタン'] = JSON.parse(conditionButtons);
      if (hashtag) window.CACHED_CONFIG['ハッシュタグ'] = JSON.parse(hashtag);
      if (discount) window.CACHED_CONFIG['割引情報'] = JSON.parse(discount);
      if (shippingDefault) window.CACHED_CONFIG['配送デフォルト'] = JSON.parse(shippingDefault);
      if (procureListingDefault) window.CACHED_CONFIG['仕入出品デフォルト'] = JSON.parse(procureListingDefault);
      if (managementNumber) window.CACHED_CONFIG['管理番号設定'] = JSON.parse(managementNumber);
      if (salesword) window.CACHED_CONFIG['よく使うセールスワード'] = JSON.parse(salesword);
      if (aiSettings) window.CACHED_CONFIG['AI生成設定'] = JSON.parse(aiSettings);
      if (theme) window.CACHED_CONFIG['デザインテーマ'] = theme;

      // 商品画像ブロックの表示/非表示を更新
      if (typeof checkProductImageBlockVisibility === 'function') {
        checkProductImageBlockVisibility();
      }

      console.log('[Prd] window.CACHED_CONFIGを更新しました');
    } catch (e) {
      console.error('[Prd] localStorage読み込みエラー:', e);
    }
  }

  // ============================================
  // QR Code Section Visibility (from line 1843)
  // ============================================

  function prdUpdateQRCodeSectionVisibility() {
    var mgmtInput = document.getElementById('管理番号');
    var qrSection = document.getElementById('qrCodeSection');
    if (qrSection) {
      qrSection.style.display = (mgmtInput && mgmtInput.value) ? 'block' : 'none';
    }
  }

  function prdSetupMgmtNumberWatcher() {
    var mgmtNumberInput = document.getElementById('管理番号');
    if (!mgmtNumberInput) return;

    _prd_mgmtNumberObserver = new MutationObserver(function() { prdUpdateQRCodeSectionVisibility(); });
    _prd_mgmtNumberObserver.observe(mgmtNumberInput, { attributes: true, attributeFilter: ['value'] });

    _prd_mgmtNumberInputHandler = function() { prdUpdateQRCodeSectionVisibility(); };
    _prd_mgmtNumberChangeHandler = function() { prdUpdateQRCodeSectionVisibility(); };
    mgmtNumberInput.addEventListener('input', _prd_mgmtNumberInputHandler);
    mgmtNumberInput.addEventListener('change', _prd_mgmtNumberChangeHandler);

    setTimeout(prdUpdateQRCodeSectionVisibility, 1000);
  }

  // ============================================
  // QR Code Modal (from line 1868)
  // ============================================

  function prdShowQRCodeModal() {
    var mgmtInput = document.getElementById('管理番号');
    var mgmtNumber = mgmtInput ? mgmtInput.value : '';
    if (!mgmtNumber) {
      alert('管理番号がありません');
      return;
    }

    var productNameEl = document.getElementById('商品名') || document.getElementById('productName');
    var productName = productNameEl ? productNameEl.value : '';
    var brandEl = document.getElementById('ブランド');
    var brand = brandEl ? brandEl.value : '';

    var qrData = JSON.stringify({
      type: 'product',
      managementNumber: mgmtNumber,
      name: (brand + ' ' + productName).trim().slice(0, 50)
    });

    var canvas = document.getElementById('qrCodeCanvas');
    if (window.QRCode && canvas) {
      QRCode.toCanvas(canvas, qrData, {
        width: 200,
        margin: 2,
        errorCorrectionLevel: 'M',
        color: { dark: '#000000', light: '#ffffff' }
      }, function(error) {
        if (error) {
          console.error('QRコード生成エラー:', error);
          alert('QRコードの生成に失敗しました');
          return;
        }
      });
    }

    var qrMgmt = document.getElementById('qrMgmtNumber');
    var qrProdName = document.getElementById('qrProductName');
    if (qrMgmt) qrMgmt.textContent = mgmtNumber;
    if (qrProdName) qrProdName.textContent = (brand + ' ' + productName).trim() || '-';

    var modal = document.getElementById('qrCodeModal');
    if (modal) modal.style.display = 'flex';
  }
  window.showQRCodeModal = prdShowQRCodeModal;

  function prdCloseQRCodeModal() {
    var modal = document.getElementById('qrCodeModal');
    if (modal) modal.style.display = 'none';
  }
  window.closeQRCodeModal = prdCloseQRCodeModal;

  function prdDownloadQRCode() {
    var canvas = document.getElementById('qrCodeCanvas');
    var qrMgmt = document.getElementById('qrMgmtNumber');
    var mgmtNumber = qrMgmt ? qrMgmt.textContent : 'QR';

    var link = document.createElement('a');
    link.download = 'QR_' + mgmtNumber + '.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  }
  window.downloadQRCode = prdDownloadQRCode;

  function prdPrintQRCode() {
    var canvas = document.getElementById('qrCodeCanvas');
    var qrMgmt = document.getElementById('qrMgmtNumber');
    var qrProdName = document.getElementById('qrProductName');
    var mgmtNumber = qrMgmt ? qrMgmt.textContent : '';
    var productName = qrProdName ? qrProdName.textContent : '';

    var printWindow = window.open('', '_blank');
    printWindow.document.write(
      '<!DOCTYPE html><html><head><title>QRコード - ' + mgmtNumber + '</title>' +
      '<style>' +
      '@page { size: 62mm 29mm; margin: 0; }' +
      'body { margin: 0; padding: 4mm; font-family: -apple-system, BlinkMacSystemFont, sans-serif; display: flex; align-items: center; gap: 4mm; }' +
      '.qr-code { width: 20mm; height: 20mm; }' +
      '.info { flex: 1; }' +
      '.mgmt-number { font-size: 14pt; font-weight: bold; }' +
      '.product-name { font-size: 8pt; color: #666; margin-top: 2mm; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 30mm; }' +
      '.close-btn-container { position: fixed; bottom: 20px; left: 0; right: 0; text-align: center; z-index: 9999; }' +
      '.close-btn { background: #3b82f6; color: white; border: none; padding: 12px 32px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }' +
      '@media print { .close-btn-container { display: none !important; } }' +
      '</style></head><body>' +
      '<img src="' + canvas.toDataURL('image/png') + '" class="qr-code">' +
      '<div class="info"><div class="mgmt-number">' + mgmtNumber + '</div><div class="product-name">' + productName + '</div></div>' +
      '<div class="close-btn-container"><button class="close-btn" onclick="window.close(); history.back();">印刷完了・閉じる</button></div>' +
      '</body></html>'
    );
    printWindow.document.close();
    printWindow.onload = function() {
      printWindow.print();
      setTimeout(function() {
        try { printWindow.close(); } catch(e) {}
      }, 1000);
    };
  }
  window.printQRCode = prdPrintQRCode;

  // ============================================
  // QR Scanner Functions (from line 2009)
  // ============================================

  function prdOpenQRScanner() {
    var modal = document.getElementById('qrScannerModal');
    if (modal) {
      modal.style.display = 'flex';
      prdStartQRScanner();
    }
  }
  window.openQRScanner = prdOpenQRScanner;

  function prdCloseQRScanner() {
    var modal = document.getElementById('qrScannerModal');
    if (modal) modal.style.display = 'none';

    var overlay = document.getElementById('qrOverlayText');
    if (overlay) overlay.style.display = 'none';
    prdStopQRScanner();

    var pageHeader = document.getElementById('pageHeader');
    if (pageHeader) pageHeader.style.display = 'flex';
    var mainContent = document.getElementById('mainFormContent');
    if (mainContent) mainContent.style.display = 'block';
  }
  window.closeQRScanner = prdCloseQRScanner;

  function prdStartQRScanner() {
    var readerElement = document.getElementById('qrReader');
    if (!readerElement) return;

    if (typeof Html5Qrcode === 'undefined') {
      var script = document.createElement('script');
      script.src = 'https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js';
      script.onload = function() { prdInitQRScanner(); };
      document.head.appendChild(script);
    } else {
      prdInitQRScanner();
    }
  }

  function prdInitQRScanner() {
    _prd_qrScanner = new Html5Qrcode('qrReader');
    _prd_qrScanner.start(
      { facingMode: 'environment' },
      { fps: 10, qrbox: { width: 250, height: 250 } },
      prdOnQRScanSuccess,
      prdOnQRScanFailure
    ).then(function() {
      var overlay = document.getElementById('qrOverlayText');
      if (overlay) overlay.style.display = 'block';
    }).catch(function(err) {
      console.error('カメラ起動失敗:', err);
      var overlay = document.getElementById('qrOverlayText');
      if (overlay) overlay.style.display = 'none';
      var reader = document.getElementById('qrReader');
      if (reader) {
        reader.innerHTML =
          '<div style="text-align: center; padding: 20px; color: #ef4444;">' +
          '<i class="bi bi-camera-video-off" style="font-size: 48px;"></i>' +
          '<p>カメラにアクセスできません</p>' +
          '<button onclick="prdManualInvIdInput()" style="margin-top: 12px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">手動で入力</button>' +
          '</div>';
      }
    });
  }

  function prdStopQRScanner() {
    if (_prd_qrScanner) {
      _prd_qrScanner.stop().catch(function(err) { console.log('Scanner stop error:', err); });
      _prd_qrScanner = null;
    }
  }

  async function prdOnQRScanSuccess(decodedText) {
    console.log('[Prd] QRスキャン成功:', decodedText);

    prdStopQRScanner();
    prdCloseQRScanner();

    // INV-010: slotId形式のQRコード対応（BATCH-で始まる）
    if (decodedText.startsWith('BATCH-')) {
      try {
        var db = window.db;
        var slotDoc = await db.collection('purchaseSlots').doc(decodedText).get();
        if (!slotDoc.exists) {
          alert('このスロットは見つかりませんでした。');
          return;
        }
        var slotData = slotDoc.data();
        console.log('[Prd] slotId形式QRコード検出:', slotData);

        // INV-010: sku-based商品の場合は在庫追加モード対応
        if (slotData.itemType === 'sku-based' && slotData.skuId) {
          var existingProduct = await prdFindProductBySkuId(slotData.skuId);

          if (existingProduct) {
            var choice = confirm(
              '既存SKU商品が見つかりました\n\n' +
              '商品名: ' + (existingProduct['商品名'] || existingProduct.name || '未設定') + '\n' +
              '現在庫: ' + (existingProduct.stockQuantity || 0) + '点\n' +
              '追加数: ' + slotData.quantity + '点\n\n' +
              '【OK】在庫を追加（' + ((existingProduct.stockQuantity || 0) + slotData.quantity) + '点になります）\n' +
              '【キャンセル】新規商品として登録'
            );

            if (choice) {
              await prdAddStockToExistingSku(slotData.skuId, slotData.quantity, slotData.slotId);
              alert('在庫を追加しました\n\n商品: ' + (existingProduct['商品名'] || existingProduct.name) + '\n新在庫数: ' + ((existingProduct.stockQuantity || 0) + slotData.quantity) + '点');
              return;
            }
          } else {
            var result = confirm(
              '新品(複数)商品です\n\n' +
              '数量: ' + slotData.quantity + '点\n' +
              '仕入単価: ¥' + (slotData.unitPrice ? slotData.unitPrice.toLocaleString() : '-') + '\n' +
              'SKU: ' + slotData.skuId + '\n\n' +
              '商品登録を続けますか？'
            );
            if (!result) return;
          }
        } else if (slotData.itemType === 'sku-based') {
          var result2 = confirm(
            '新品(複数)商品です\n\n' +
            '数量: ' + slotData.quantity + '点\n' +
            '仕入単価: ¥' + (slotData.unitPrice ? slotData.unitPrice.toLocaleString() : '-') + '\n\n' +
            '商品登録を続けますか？'
          );
          if (!result2) return;
        }

        // qrDataフォーマットに変換
        var qrData = {
          s: slotData.slotId,
          n: slotData.slotNumber,
          d: slotData.purchaseDate,
          sup: slotData.supplier,
          amt: slotData.amount,
          asg: slotData.assignee,
          m: slotData.memo || '',
          cat: slotData.category || null,
          sz: slotData.size || '',
          br: slotData.brand || '',
          brk: slotData.brandKana || '',
          cnd: slotData.condition || '',
          acc: slotData.accessories || [],
          nt: slotData.note || '',
          itemType: slotData.itemType || 'unique',
          quantity: slotData.quantity || 1,
          skuId: slotData.skuId || null,
          unitPrice: slotData.unitPrice || null
        };

        prdSetInvId(slotData.slotId);
        prdApplyPurchaseQRData(qrData);
        return;
      } catch (error) {
        console.error('slotId QRコード処理エラー:', error);
        alert('データの取得に失敗しました。');
        return;
      }
    }

    // JSON形式の仕入QRコードかチェック
    var qrData2 = null;
    try {
      qrData2 = JSON.parse(decodedText);
    } catch (e) {
      // JSON形式でない場合は従来の処理
    }

    // 仕入QRコード（検品情報付き）の場合
    if (qrData2 && qrData2.s && qrData2.n) {
      console.log('[Prd] 仕入QRコード検出（検品情報付き）:', qrData2);
      prdSetInvId(qrData2.s);
      prdApplyPurchaseQRData(qrData2);
      return;
    }

    // 従来の処理（URLベースのinvId抽出）
    var invId = decodedText;
    try {
      var url = new URL(decodedText);
      invId = url.searchParams.get('inv') || decodedText;
    } catch (e) {
      // URLでない場合はそのまま使用
    }

    prdSetInvId(invId);
  }

  // ============================================
  // Apply Purchase QR Data to Form (from line 2229)
  // ============================================

  function prdApplyPurchaseQRData(qrData) {
    console.log('[Prd] 検品情報を自動反映中...');

    // Helper: set select value by matching option value or text
    function setSelectValue(elId, value) {
      var el = document.getElementById(elId);
      if (!el || !value) return;
      for (var i = 0; i < el.options.length; i++) {
        if (el.options[i].value === value || el.options[i].text.includes(value)) {
          el.selectedIndex = i;
          el.dispatchEvent(new Event('change', { bubbles: true }));
          break;
        }
      }
    }

    // Helper: set cascading category selects with delay
    function setCascadingCategory(catObj) {
      if (!catObj) return;

      var levels = [
        { key: 'superCategory', id: '特大分類' },
        { key: 'major', id: '大分類(カテゴリ)' },
        { key: 'middle', id: '中分類(カテゴリ)' },
        { key: 'small', id: '小分類(カテゴリ)' },
        { key: 'fine', id: '細分類(カテゴリ)' },
        { key: 'fine2', id: '細分類2' },
        { key: 'itemName', id: 'アイテム名' }
      ];

      function setLevel(index) {
        if (index >= levels.length) return;
        var level = levels[index];
        if (catObj[level.key]) {
          var el = document.getElementById(level.id);
          if (el) {
            for (var i = 0; i < el.options.length; i++) {
              if (el.options[i].value === catObj[level.key]) {
                el.selectedIndex = i;
                el.dispatchEvent(new Event('change', { bubbles: true }));
                break;
              }
            }
          }
          setTimeout(function() { setLevel(index + 1); }, 100);
        } else {
          setTimeout(function() { setLevel(index + 1); }, 100);
        }
      }

      setLevel(0);
    }

    // 仕入日
    if (qrData.d) {
      var purchaseDateEl = document.getElementById('仕入日');
      if (purchaseDateEl) purchaseDateEl.value = qrData.d;
    }

    // 仕入金額
    if (qrData.amt) {
      var purchaseAmountEl = document.getElementById('仕入金額');
      if (purchaseAmountEl) purchaseAmountEl.value = qrData.amt;
    }

    // 仕入先
    if (qrData.sup) setSelectValue('仕入先', qrData.sup);

    // カテゴリ（7階層対応）
    if (qrData.cat) {
      var categoryObj = typeof qrData.cat === 'object' ? qrData.cat : { superCategory: qrData.cat };
      setCascadingCategory(categoryObj);
    }

    // サイズ
    if (qrData.sz) {
      var sizeEl = document.getElementById('サイズ');
      if (sizeEl) sizeEl.value = qrData.sz;
    }

    // ブランド
    if (qrData.br) {
      var brandEl = document.getElementById('ブランド(英語)');
      if (brandEl) brandEl.value = qrData.br;
      var brandNameEl = document.getElementById('商品名_ブランド(英語)');
      if (brandNameEl) brandNameEl.value = qrData.br;
      if (qrData.brk) {
        var brandKanaEl = document.getElementById('ブランド(カナ)');
        if (brandKanaEl) brandKanaEl.value = qrData.brk;
        var brandNameKanaEl = document.getElementById('商品名_ブランド(カナ)');
        if (brandNameKanaEl) brandNameKanaEl.value = qrData.brk;
      }
    }

    // 商品の状態
    if (qrData.cnd) setSelectValue('商品の状態', qrData.cnd);

    // 付属品情報
    if (qrData.acc && qrData.acc.length > 0) {
      if (typeof window.setAccessoriesFromQR === 'function') {
        window.setAccessoriesFromQR(qrData.acc);
      } else {
        var accessoriesText = '【付属品】' + qrData.acc.join('、');
        var conditionDetailEl = document.getElementById('商品状態詳細');
        if (conditionDetailEl) {
          var current = conditionDetailEl.value;
          conditionDetailEl.value = current ? current + '\n' + accessoriesText : accessoriesText;
        }
      }
    }

    // 特記事項（検品メモ）
    if (qrData.nt) {
      var condDetailEl = document.getElementById('商品状態詳細');
      if (condDetailEl) {
        var cur = condDetailEl.value;
        var noteText = '【検品メモ】' + qrData.nt;
        condDetailEl.value = cur ? cur + '\n' + noteText : noteText;
      }
    }

    // メモ
    if (qrData.m) {
      var condDetailEl2 = document.getElementById('商品状態詳細');
      if (condDetailEl2) {
        var cur2 = condDetailEl2.value;
        var memoText = '【仕入メモ】' + qrData.m;
        condDetailEl2.value = cur2 ? cur2 + '\n' + memoText : memoText;
      }
    }

    // 傷・汚れマーキング画像をFirestoreから取得
    if (qrData.s && window.db) {
      prdLoadDamageMarkerFromFirestore(qrData.s);
    }

    // INV-010: SKU情報をグローバル変数に保持
    window.currentSkuInfo = {
      itemType: qrData.itemType || 'unique',
      quantity: qrData.quantity || 1,
      skuId: qrData.skuId || null,
      unitPrice: qrData.unitPrice || null
    };

    // INV-010: sku-based商品の場合は情報を表示
    if (qrData.itemType === 'sku-based') {
      prdShowSkuInfoBanner(qrData);
    }

    // 反映完了通知
    prdShowInspectionDataAppliedNotification(qrData);
    console.log('[Prd] 検品情報の自動反映完了');
  }

  // ============================================
  // SKU Info Banner (from line 2472)
  // ============================================

  function prdShowSkuInfoBanner(qrData) {
    var existingBanner = document.getElementById('skuInfoBanner');
    if (existingBanner) existingBanner.remove();

    var banner = document.createElement('div');
    banner.id = 'skuInfoBanner';
    banner.style.cssText = 'background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 1px solid #3b82f6; border-radius: 8px; padding: 12px 16px; margin: 12px 0; display: flex; align-items: center; gap: 12px;';
    banner.innerHTML =
      '<span style="font-size: 24px;">📦</span>' +
      '<div style="flex: 1;">' +
      '<div style="font-weight: 600; color: #1e40af; margin-bottom: 4px;">新品(複数)商品</div>' +
      '<div style="font-size: 13px; color: #1e3a8a;">' +
      '数量: <strong>' + qrData.quantity + '点</strong> ／ ' +
      '仕入単価: <strong>¥' + (qrData.unitPrice ? qrData.unitPrice.toLocaleString() : '-') + '</strong>' +
      (qrData.skuId ? ' ／ SKU: <code style="background:#e0f2fe; padding:2px 6px; border-radius:4px;">' + qrData.skuId + '</code>' : '') +
      '</div></div>';

    var invIdEl = document.getElementById('invId');
    if (invIdEl && invIdEl.parentElement) {
      invIdEl.parentElement.insertAdjacentElement('afterend', banner);
    }
  }

  // ============================================
  // Damage Marker (from line 2509)
  // ============================================

  // Global state for damage marker
  window.currentDamageMarker = { image: null, type: null, note: null };

  async function prdLoadDamageMarkerFromFirestore(slotId) {
    try {
      console.log('[Prd] マーキング画像取得中:', slotId);
      var slotDoc = await window.db.collection('purchaseSlots').doc(slotId).get();

      if (slotDoc.exists) {
        var slotData = slotDoc.data();

        if (slotData.damageMarkerImage) {
          console.log('[Prd] マーキング画像を検出');
          var previewSection = document.getElementById('damageMarkerPreviewSection');
          var previewImg = document.getElementById('damageMarkerPreviewImg');
          var typeLabel = document.getElementById('damageMarkerTypeLabel');
          var noteSection = document.getElementById('damageMarkerNoteSection');
          var noteText = document.getElementById('damageMarkerNoteText');

          if (previewImg) previewImg.src = slotData.damageMarkerImage;
          if (typeLabel) typeLabel.textContent = slotData.damageMarkerType || '';
          if (previewSection) previewSection.style.display = 'block';

          if (slotData.damageMarkerNote) {
            if (noteText) noteText.textContent = slotData.damageMarkerNote;
            if (noteSection) noteSection.style.display = 'block';
          } else {
            if (noteSection) noteSection.style.display = 'none';
          }

          window.currentDamageMarker = {
            image: slotData.damageMarkerImage,
            type: slotData.damageMarkerType || null,
            note: slotData.damageMarkerNote || null
          };
        } else {
          window.currentDamageMarker = { image: null, type: null, note: null };
        }
      }
    } catch (error) {
      console.error('[Prd] マーキング画像取得エラー:', error);
      window.currentDamageMarker = { image: null, type: null, note: null };
    }
  }

  // ============================================
  // Inspection Notification (from line 2565)
  // ============================================

  function prdShowInspectionDataAppliedNotification(qrData) {
    var appliedItems = [];
    if (qrData.d) appliedItems.push('仕入日');
    if (qrData.amt) appliedItems.push('仕入金額');
    if (qrData.sup) appliedItems.push('仕入先');
    if (qrData.cat) appliedItems.push('カテゴリ');
    if (qrData.br) appliedItems.push('ブランド');
    if (qrData.cnd) appliedItems.push('商品状態');
    if (qrData.acc && qrData.acc.length > 0) appliedItems.push('付属品');
    if (qrData.nt) appliedItems.push('検品メモ');

    var notification = document.createElement('div');
    notification.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 20000; font-weight: 600; text-align: center; max-width: 90%; animation: prdSlideDown 0.3s ease-out;';
    notification.innerHTML =
      '<div style="display: flex; align-items: center; gap: 12px;">' +
      '<i class="bi bi-check-circle-fill" style="font-size: 24px;"></i>' +
      '<div><div>検品情報を自動反映しました</div>' +
      '<div style="font-size: 12px; font-weight: 400; margin-top: 4px; opacity: 0.9;">' + appliedItems.join('、') + '</div>' +
      '</div></div>';

    if (!document.getElementById('inspection-notification-style')) {
      var style = document.createElement('style');
      style.id = 'inspection-notification-style';
      style.textContent = '@keyframes prdSlideDown { from { transform: translateX(-50%) translateY(-100%); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }';
      document.head.appendChild(style);
    }

    document.body.appendChild(notification);

    setTimeout(function() {
      notification.style.transition = 'opacity 0.3s, transform 0.3s';
      notification.style.opacity = '0';
      notification.style.transform = 'translateX(-50%) translateY(-20px)';
      setTimeout(function() { notification.remove(); }, 300);
    }, 3000);
  }

  function prdOnQRScanFailure(error) {
    // 継続してスキャン（エラーは無視）
  }

  // ============================================
  // SKU Search & Stock Add (from line 2636)
  // ============================================

  async function prdFindProductBySkuId(skuId) {
    try {
      var db = window.db;
      var snapshot = await db.collection('products')
        .where('skuId', '==', skuId)
        .limit(1)
        .get();

      if (snapshot.empty) return null;
      var docData = snapshot.docs[0].data();
      docData.id = snapshot.docs[0].id;
      return docData;
    } catch (error) {
      console.error('[Prd] SKU検索エラー:', error);
      return null;
    }
  }

  async function prdAddStockToExistingSku(skuId, quantity, slotId) {
    try {
      var db = window.db;
      var batch = db.batch();

      var productSnapshot = await db.collection('products')
        .where('skuId', '==', skuId)
        .limit(1)
        .get();

      if (!productSnapshot.empty) {
        var productRef = productSnapshot.docs[0].ref;
        batch.update(productRef, {
          stockQuantity: firebase.firestore.FieldValue.increment(quantity),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }

      var skuRef = db.collection('skus').doc(skuId);
      batch.set(skuRef, {
        currentStock: firebase.firestore.FieldValue.increment(quantity),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });

      var slotRef = db.collection('purchaseSlots').doc(slotId);
      batch.update(slotRef, {
        status: 'registered',
        registeredAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      await batch.commit();
      console.log('[Prd] 在庫追加完了:', { skuId: skuId, quantity: quantity, slotId: slotId });
    } catch (error) {
      console.error('[Prd] 在庫追加エラー:', error);
      throw error;
    }
  }

  // ============================================
  // setInvId / clearInvId / fetchSlot (from line 2695)
  // ============================================

  function prdSetInvId(invId) {
    var invIdEl = document.getElementById('invId');
    if (invIdEl) invIdEl.value = invId;

    var statusSection = document.getElementById('qrStatusSection');
    if (statusSection) statusSection.style.display = 'block';

    var statusDiv = document.getElementById('qrScanStatus');
    if (statusDiv) {
      statusDiv.innerHTML =
        '<div style="display: flex; align-items: center; gap: 8px;">' +
        '<i class="bi bi-hourglass-split" style="color: #f59e0b; font-size: 20px;"></i>' +
        '<div style="flex: 1;">' +
        '<div style="font-weight: 600; color: #92400e;">仕入情報を読み込み中...</div>' +
        '<div style="font-size: 12px; color: #b45309;">' + invId + '</div>' +
        '</div></div>';
    }

    var floatingBtn = document.getElementById('qrFloatingBtn');
    if (floatingBtn) floatingBtn.style.display = 'none';

    prdFetchAndApplyPurchaseSlotData(invId);
  }

  async function prdFetchAndApplyPurchaseSlotData(slotId) {
    var statusDiv = document.getElementById('qrScanStatus');

    try {
      console.log('[Prd] 仕入スロット取得開始:', slotId);
      var doc = await window.db.collection('purchaseSlots').doc(slotId).get();

      if (!doc.exists) {
        if (statusDiv) {
          statusDiv.innerHTML =
            '<div style="display: flex; align-items: center; gap: 8px;">' +
            '<i class="bi bi-exclamation-triangle-fill" style="color: #f59e0b; font-size: 20px;"></i>' +
            '<div style="flex: 1;">' +
            '<div style="font-weight: 600; color: #92400e;">仕入情報が見つかりません</div>' +
            '<div style="font-size: 12px; color: #b45309;">' + slotId + '</div>' +
            '</div>' +
            '<button onclick="prdClearInvId()" style="background: none; border: none; color: #6b7280; cursor: pointer; padding: 4px;"><i class="bi bi-x-lg"></i></button>' +
            '</div>';
        }
        return;
      }

      var slotData = doc.data();
      console.log('[Prd] 仕入スロットデータ:', slotData);

      if (statusDiv) {
        statusDiv.innerHTML =
          '<div style="display: flex; align-items: center; gap: 8px;">' +
          '<i class="bi bi-check-circle-fill" style="color: #10b981; font-size: 20px;"></i>' +
          '<div style="flex: 1;">' +
          '<div style="font-weight: 600; color: #065f46;">仕入商品と紐付け済み</div>' +
          '<div style="font-size: 12px; color: #047857;">' + slotId + '</div>' +
          '</div>' +
          '<button onclick="prdClearInvId()" style="background: none; border: none; color: #6b7280; cursor: pointer; padding: 4px;"><i class="bi bi-x-lg"></i></button>' +
          '</div>';
      }

      prdApplyPurchaseSlotDataToForm(slotData);
    } catch (error) {
      console.error('[Prd] 仕入スロット取得エラー:', error);
      if (statusDiv) {
        statusDiv.innerHTML =
          '<div style="display: flex; align-items: center; gap: 8px;">' +
          '<i class="bi bi-x-circle-fill" style="color: #ef4444; font-size: 20px;"></i>' +
          '<div style="flex: 1;">' +
          '<div style="font-weight: 600; color: #dc2626;">読み込みエラー</div>' +
          '<div style="font-size: 12px; color: #b91c1c;">' + slotId + '</div>' +
          '</div>' +
          '<button onclick="prdClearInvId()" style="background: none; border: none; color: #6b7280; cursor: pointer; padding: 4px;"><i class="bi bi-x-lg"></i></button>' +
          '</div>';
      }
    }
  }

  // ============================================
  // Apply Purchase Slot Data to Form (from line 2786)
  // ============================================

  function prdApplyPurchaseSlotDataToForm(slotData) {
    console.log('[Prd] 仕入情報をフォームに反映中...');

    function setSelectValue(elId, value) {
      var el = document.getElementById(elId);
      if (!el || !value) return;
      for (var i = 0; i < el.options.length; i++) {
        if (el.options[i].value === value || el.options[i].text.includes(value)) {
          el.selectedIndex = i;
          el.dispatchEvent(new Event('change', { bubbles: true }));
          break;
        }
      }
    }

    function setCascadingCategory(catObj) {
      if (!catObj) return;
      var levels = [
        { key: 'superCategory', id: '特大分類' },
        { key: 'major', id: '大分類(カテゴリ)' },
        { key: 'middle', id: '中分類(カテゴリ)' },
        { key: 'small', id: '小分類(カテゴリ)' },
        { key: 'fine', id: '細分類(カテゴリ)' },
        { key: 'fine2', id: '細分類2' },
        { key: 'itemName', id: 'アイテム名' }
      ];

      function setLevel(index) {
        if (index >= levels.length) return;
        var level = levels[index];
        if (catObj[level.key]) {
          var el = document.getElementById(level.id);
          if (el) {
            for (var i = 0; i < el.options.length; i++) {
              if (el.options[i].value === catObj[level.key]) {
                el.selectedIndex = i;
                el.dispatchEvent(new Event('change', { bubbles: true }));
                break;
              }
            }
          }
          setTimeout(function() { setLevel(index + 1); }, 100);
        } else {
          setTimeout(function() { setLevel(index + 1); }, 100);
        }
      }

      setLevel(0);
    }

    // 仕入日
    if (slotData.purchaseDate) {
      var pdEl = document.getElementById('仕入日');
      if (pdEl) pdEl.value = slotData.purchaseDate;
    }

    // 仕入金額
    if (slotData.amount) {
      var paEl = document.getElementById('仕入金額');
      if (paEl) paEl.value = slotData.amount;
    }

    // 仕入先
    if (slotData.supplier) setSelectValue('仕入先', slotData.supplier);

    // カテゴリ
    if (slotData.category) setCascadingCategory(slotData.category);

    // サイズ
    if (slotData.size) {
      var sizeEl = document.getElementById('サイズ');
      if (sizeEl) sizeEl.value = slotData.size;
    }

    // ブランド
    if (slotData.brand) {
      var brandEl = document.getElementById('ブランド(英語)');
      if (brandEl) brandEl.value = slotData.brand;
      var brandNameEl = document.getElementById('商品名_ブランド(英語)');
      if (brandNameEl) brandNameEl.value = slotData.brand;
    }
    if (slotData.brandKana) {
      var brandKanaEl = document.getElementById('ブランド(カナ)');
      if (brandKanaEl) brandKanaEl.value = slotData.brandKana;
      var brandNameKanaEl = document.getElementById('商品名_ブランド(カナ)');
      if (brandNameKanaEl) brandNameKanaEl.value = slotData.brandKana;
    }

    // 商品の状態
    if (slotData.condition) setSelectValue('商品の状態', slotData.condition);

    // 付属品
    if (slotData.accessories && slotData.accessories.length > 0) {
      if (typeof window.setAccessoriesFromQR === 'function') {
        window.setAccessoriesFromQR(slotData.accessories);
      }
    }

    // マーキング画像
    if (slotData.damageMarkerImage) {
      var previewSection = document.getElementById('damageMarkerPreviewSection');
      var previewImg = document.getElementById('damageMarkerPreviewImg');
      var typeLabel = document.getElementById('damageMarkerTypeLabel');
      var noteSection = document.getElementById('damageMarkerNoteSection');
      var noteText = document.getElementById('damageMarkerNoteText');

      if (previewSection && previewImg) {
        previewImg.src = slotData.damageMarkerImage;
        if (typeLabel) typeLabel.textContent = slotData.damageMarkerType || '';
        previewSection.style.display = 'block';

        if (slotData.damageMarkerNote && noteSection && noteText) {
          noteText.textContent = slotData.damageMarkerNote;
          noteSection.style.display = 'block';
        } else if (noteSection) {
          noteSection.style.display = 'none';
        }

        window.currentDamageMarker = {
          image: slotData.damageMarkerImage,
          type: slotData.damageMarkerType || null,
          note: slotData.damageMarkerNote || null
        };
      }
    }

    // メモ
    if (slotData.note || slotData.memo) {
      var noteTextVal = slotData.note || slotData.memo;
      var condDetailEl = document.getElementById('商品状態詳細');
      if (condDetailEl && noteTextVal) {
        var cur = condDetailEl.value;
        condDetailEl.value = cur ? cur + '\n' + noteTextVal : noteTextVal;
      }
    }

    console.log('[Prd] 仕入情報の反映完了');
  }

  // ============================================
  // Manual Input & Clear (from line 3015)
  // ============================================

  function prdManualInvIdInput() {
    var invId = prompt('仕入商品IDを入力してください\n例: INV-20251212-XXXX-001');
    if (invId && invId.trim()) {
      prdCloseQRScanner();
      prdSetInvId(invId.trim());
    }
  }
  window.manualInvIdInput = prdManualInvIdInput;

  function prdClearInvId() {
    var invIdEl = document.getElementById('invId');
    if (invIdEl) invIdEl.value = '';
    var statusSection = document.getElementById('qrStatusSection');
    if (statusSection) statusSection.style.display = 'none';

    var floatingBtn = document.getElementById('qrFloatingBtn');
    if (floatingBtn) {
      floatingBtn.style.display = 'flex';
      floatingBtn.style.background = 'white';
      floatingBtn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.25)';
      floatingBtn.innerHTML = '<img src="/images/qr-scan-icon.png" alt="QRスキャン" style="width: 100%; height: 100%; object-fit: contain;">';
    }
  }
  window.clearInvId = prdClearInvId;

  function prdCheckInvIdBeforeSave() {
    var invIdEl = document.getElementById('invId');
    var invId = invIdEl ? invIdEl.value : '';
    if (!invId) {
      var result = confirm('仕入商品との紐付けがされていません。\n\nQRコードをスキャンせずに登録すると、仕入情報との紐付けができなくなります。\n\n本当に登録しますか？');
      return result;
    }
    return true;
  }
  window.checkInvIdBeforeSave = prdCheckInvIdBeforeSave;

  // ============================================
  // QR Auto-Open Setting (from line 3128)
  // ============================================

  var _prd_QR_AUTO_OPEN_KEY = 'reborn_qr_auto_open';

  function prdInitQrAutoOpenSetting() {
    var saved = localStorage.getItem(_prd_QR_AUTO_OPEN_KEY);
    var isEnabled = saved === null ? true : saved === 'true';
    var toggle = document.getElementById('qrAutoOpenToggle');
    if (toggle) {
      toggle.checked = isEnabled;
      prdUpdateToggleVisual(isEnabled);
    }
    return isEnabled;
  }

  function prdUpdateToggleVisual(isEnabled) {
    var track = document.getElementById('qrToggleTrack');
    var thumb = document.getElementById('qrToggleThumb');
    if (track && thumb) {
      if (isEnabled) {
        track.style.backgroundColor = '#3b82f6';
        thumb.style.transform = 'translateX(22px)';
      } else {
        track.style.backgroundColor = '#e5e7eb';
        thumb.style.transform = 'translateX(0)';
      }
    }
  }

  function prdToggleQrAutoOpen() {
    var toggle = document.getElementById('qrAutoOpenToggle');
    var isEnabled = toggle ? toggle.checked : false;
    localStorage.setItem(_prd_QR_AUTO_OPEN_KEY, isEnabled.toString());
    prdUpdateToggleVisual(isEnabled);
    console.log('[Prd QR設定] 自動表示:', isEnabled ? 'オン' : 'オフ');
  }

  function prdAutoOpenQrScannerIfEnabled() {
    var isEnabled = prdInitQrAutoOpenSetting();
    var pageHeader = document.getElementById('pageHeader');
    var mainContent = document.getElementById('mainFormContent');

    if (isEnabled) {
      console.log('[Prd QR設定] 自動表示が有効 → QRスキャナーを開く');
      setTimeout(function() { prdOpenQRScanner(); }, 500);
    } else {
      console.log('[Prd QR設定] 自動表示が無効 → ヘッダー・メインコンテンツを表示');
      if (pageHeader) pageHeader.style.display = 'flex';
      if (mainContent) mainContent.style.display = 'block';
    }
  }

  // ============================================
  // Master Preload (from line 3204)
  // ============================================

  function prdPreloadMasterData() {
    setTimeout(async function() {
      if (window.masterCacheManager) {
        console.log('[Prd] マスタデータのバックグラウンドプリロード開始...');
        try {
          await window.masterCacheManager.preloadInBackground('categories');
          await window.masterCacheManager.preloadInBackground('brands');
          console.log('[Prd] マスタプリロード完了');
        } catch (e) {
          console.error('[Prd] プリロードエラー:', e);
        }
      }
    }, 3000);
  }

  // ============================================
  // Firebase Messaging (from line 1640) - SPA adapted
  // ============================================

  function prdInitFirebaseMessaging() {
    // In SPA context, parent handles messaging. Skip initialization here.
    // But set up foreground message handler if not already done.
    console.log('[Prd] Firebase Messaging: SPA context, parent handles');
  }

  // ============================================
  // Load Dependencies (External JS/CSS)
  // ============================================

  async function prdLoadDependencies() {
    if (_prd_scriptsLoaded) {
      console.log('[Prd SPA] Dependencies already loaded, skipping');
      return;
    }

    try {
      // 1. Load product-styles.css
      _prdLoadCSS('/css/product-styles.css?v=183-guide-toggle');

      var loadPromises = [];

      // 2. Load Algolia search SDK
      if (!window.algoliasearch) {
        loadPromises.push(_prdLoadScript('https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js'));
      }

      // 3. Load Sortable.js
      if (!window.Sortable) {
        loadPromises.push(_prdLoadScript('https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js'));
      }

      // 4. Load webhook-config.js
      if (!window.WEBHOOK_CONFIG && !window.sendWebhookNotification) {
        loadPromises.push(_prdLoadScript('/js/webhook-config.js'));
      }

      // Wait for above before loading product-scripts.js (it may depend on them)
      await Promise.all(loadPromises);
      console.log('[Prd SPA] Base dependencies loaded');

      // 5. Load product-scripts.js (the BIG one)
      if (!window.initLoadingOverlay) {
        await _prdLoadScript('/js/product-scripts.js?v=192-r2-storage');
        console.log('[Prd SPA] product-scripts.js loaded');
      }

      // 6. Load QRCode library
      if (!window.QRCode) {
        loadPromises = [];
        loadPromises.push(_prdLoadScript('https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js'));
        await Promise.all(loadPromises);
        console.log('[Prd SPA] qrcode.js loaded');
      }

      // 7. Load Firestore brand search module (ES module)
      try {
        if (!window.searchBrands) {
          var firestoreModule = await import('https://reborn-inventory-system.pages.dev/js/firestore-api.js');
          window.searchBrands = firestoreModule.searchBrands || (firestoreModule.default && firestoreModule.default.searchBrands);
          window.incrementBrandUsageCount = firestoreModule.incrementBrandUsageCount || (firestoreModule.default && firestoreModule.default.incrementBrandUsageCount);
          window.preloadBrandsInBackground = firestoreModule.preloadBrandsInBackground || (firestoreModule.default && firestoreModule.default.preloadBrandsInBackground);
          window.searchBrandsFromCache = firestoreModule.searchBrandsFromCache || (firestoreModule.default && firestoreModule.default.searchBrandsFromCache);
        }
        if (!window.algoliaBrandModulesLoaded) {
          await import('https://reborn-inventory-system.pages.dev/js/brand-suggest-algolia.js?v=98-minchars2');
          window.algoliaBrandModulesLoaded = true;
        }
        console.log('[Prd SPA] Brand modules loaded');
      } catch (importErr) {
        console.error('[Prd SPA] Brand module import error:', importErr);
      }

      _prd_scriptsLoaded = true;
      console.log('[Prd SPA] All dependencies loaded');

    } catch (err) {
      console.error('[Prd SPA] Dependency loading error:', err);
      // Continue with whatever loaded
      _prd_scriptsLoaded = true;
    }
  }

  // ============================================
  // SPA Lifecycle: init / destroy
  // ============================================

  async function initProductPage() {
    console.log('[Prd SPA] initProductPage called');

    if (_prd_initialized) {
      console.log('[Prd SPA] Already initialized, skipping');
      return;
    }

    try {
      // 初回ロード判定: スクリプトが既にロード済みなら再訪問
      var _prd_isRevisit = !!window.initLoadingOverlay;

      // Load all external dependencies
      await prdLoadDependencies();

      // Setup event listeners

      // 1. Dropdown close on outside click
      _prd_dropdownClickHandler = function(event) {
        var dropdown = document.getElementById('settingsDropdown');
        if (dropdown && !dropdown.contains(event.target) && !event.target.closest('.sub-header-icon')) {
          dropdown.classList.remove('active');
        }
      };
      document.addEventListener('click', _prd_dropdownClickHandler);

      // 2. QR Modal click outside to close
      var qrModal = document.getElementById('qrCodeModal');
      if (qrModal) {
        _prd_qrModalClickHandler = function(e) {
          if (e.target === qrModal) prdCloseQRCodeModal();
        };
        qrModal.addEventListener('click', _prd_qrModalClickHandler);
      }

      // 3. Message listener for config changes
      _prd_messageHandler = function(event) {
        if (event.data && event.data.type === 'configChanged') {
          console.log('[Prd] 設定変更通知を受信しました');
          prdReloadConfigFromLocalStorage();
        }
      };
      window.addEventListener('message', _prd_messageHandler);

      // Initialize guide mode
      prdInitGuideMode();

      // Initialize platform tabs
      prdInitPlatformTabs();

      // Initialize loading overlay (from product-scripts.js)
      if (typeof window.initLoadingOverlay === 'function') {
        window.initLoadingOverlay();
      }

      // Setup management number watcher
      prdSetupMgmtNumberWatcher();

      // Set operator name from localStorage (SPA mode has no URL params)
      var staffField = document.getElementById('担当者');
      if (staffField && !staffField.value) {
        var savedUserName = localStorage.getItem('reborn_user_name') || '';
        if (savedUserName) staffField.value = savedUserName;
      }

      // Check and apply slot data from sessionStorage
      if (typeof window.checkAndApplySlotData === 'function') {
        window.checkAndApplySlotData();
      }

      // Auto-open QR scanner if setting enabled (即座に実行、ユーザー体感を優先)
      prdAutoOpenQrScannerIfEnabled();

      // SPA再初期化: 再訪問時のみ実行（初回はauto-executingコードが処理する）
      // バックグラウンド実行でQRスキャンをブロックしない
      if (_prd_isRevisit && typeof window.reinitProductScripts === 'function') {
        console.log('[Prd SPA] Re-visit detected, running reinit in background');
        window.reinitProductScripts().catch(function(e) {
          console.error('[Prd SPA] reinit error:', e);
        });
      }

      // Preload master data in background
      prdPreloadMasterData();

      // Reload config from localStorage
      prdReloadConfigFromLocalStorage();

      _prd_initialized = true;
      console.log('[Prd SPA] Initialization complete');

    } catch (err) {
      console.error('[Prd SPA] Initialization error:', err);
      // Show header and content even if init fails
      var pageHeader = document.getElementById('pageHeader');
      var mainContent = document.getElementById('mainFormContent');
      if (pageHeader) pageHeader.style.display = 'flex';
      if (mainContent) mainContent.style.display = 'block';
    }
  }

  // ============================================
  // Bridge functions: prd-prefixed -> product-scripts.js globals
  // These map HTML onclick="prdXxx()" to the actual functions
  // defined in product-scripts.js (loaded dynamically).
  // ============================================

  function prdAdjustManagementNumber(n) {
    if (typeof adjustManagementNumber === 'function') return adjustManagementNumber(n);
  }
  function prdCopyToClipboard(id, btnId) {
    if (typeof copyToClipboard === 'function') return copyToClipboard(id, btnId);
  }
  function prdToggleTitleBlock(el) {
    if (typeof toggleTitleBlock === 'function') return toggleTitleBlock(el);
  }
  function prdToggleDescBlock(el) {
    if (typeof toggleDescBlock === 'function') return toggleDescBlock(el);
  }
  function prdRemoveProductAttribute(idx) {
    if (typeof removeProductAttribute === 'function') return removeProductAttribute(idx);
  }
  function prdRemoveColor(idx) {
    if (typeof removeColor === 'function') return removeColor(idx);
  }
  function prdRemoveMaterial(idx) {
    if (typeof removeMaterial === 'function') return removeMaterial(idx);
  }
  function prdRemoveCompositionRow(matIdx, rowIdx) {
    if (typeof removeCompositionRow === 'function') return removeCompositionRow(matIdx, rowIdx);
  }
  function prdAddCompositionRow(idx) {
    if (typeof addCompositionRow === 'function') return addCompositionRow(idx);
  }
  function prdToggleAiSubBlock(el) {
    if (typeof toggleAiSubBlock === 'function') return toggleAiSubBlock(el);
  }
  function prdGenerateAiDescription() {
    if (typeof generateAiDescription === 'function') return generateAiDescription();
  }
  function prdClearAllProductImages() {
    if (typeof clearAllProductImages === 'function') return clearAllProductImages();
  }
  function prdOnSave() {
    if (typeof onSave === 'function') return onSave();
  }
  function prdOnReset() {
    if (typeof onReset === 'function') return onReset();
  }
  function prdOnConditionChange() {
    if (typeof onConditionChange === 'function') return onConditionChange();
  }
  function prdUpdateNamePreview() {
    if (typeof updateNamePreview === 'function') return updateNamePreview();
  }
  function prdHandleImageUpload(event) {
    if (typeof handleImageUpload === 'function') return handleImageUpload(event);
  }
  function prdHandleProductImageUpload(event) {
    if (typeof handleProductImageUpload === 'function') return handleProductImageUpload(event);
  }

  // ============================================
  // SPA Lifecycle: destroy
  // ============================================

  function destroyProductPage() {
    console.log('[Prd SPA] destroyProductPage called');

    // Stop QR scanner if running
    if (_prd_qrScanner) {
      try {
        _prd_qrScanner.stop().catch(function(err) { console.log('[Prd SPA] Scanner stop:', err); });
      } catch (e) {
        console.log('[Prd SPA] Scanner stop error:', e);
      }
      _prd_qrScanner = null;
    }

    // Remove event listeners
    if (_prd_dropdownClickHandler) {
      document.removeEventListener('click', _prd_dropdownClickHandler);
      _prd_dropdownClickHandler = null;
    }

    if (_prd_messageHandler) {
      window.removeEventListener('message', _prd_messageHandler);
      _prd_messageHandler = null;
    }

    // Remove QR modal click handler
    var qrModal = document.getElementById('qrCodeModal');
    if (qrModal && _prd_qrModalClickHandler) {
      qrModal.removeEventListener('click', _prd_qrModalClickHandler);
      _prd_qrModalClickHandler = null;
    }

    // Remove management number observer
    if (_prd_mgmtNumberObserver) {
      _prd_mgmtNumberObserver.disconnect();
      _prd_mgmtNumberObserver = null;
    }
    var mgmtInput = document.getElementById('管理番号');
    if (mgmtInput) {
      if (_prd_mgmtNumberInputHandler) mgmtInput.removeEventListener('input', _prd_mgmtNumberInputHandler);
      if (_prd_mgmtNumberChangeHandler) mgmtInput.removeEventListener('change', _prd_mgmtNumberChangeHandler);
    }
    _prd_mgmtNumberInputHandler = null;
    _prd_mgmtNumberChangeHandler = null;

    // Remove loading overlay from body (product-scripts.js adds it to document.body)
    var loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) loadingOverlay.remove();

    // Remove dynamically loaded CSS
    _prdRemoveCSS();

    // Remove notification style
    var notifStyle = document.getElementById('inspection-notification-style');
    if (notifStyle) notifStyle.remove();

    // Close any open modals
    var scannerModal = document.getElementById('qrScannerModal');
    if (scannerModal) scannerModal.style.display = 'none';
    if (qrModal) qrModal.style.display = 'none';

    // Reset damage marker global
    window.currentDamageMarker = { image: null, type: null, note: null };
    window.currentSkuInfo = null;
    window.pendingSlotData = null;

    _prd_initialized = false;
    _prd_scriptsLoaded = false;
    console.log('[Prd SPA] Cleanup complete');
  }
</script>

</div><!-- /spa-page-product -->
