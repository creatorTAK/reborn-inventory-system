<!-- SPA Fragment: stocktaking.html -->
<!-- Prefix: stk- -->
<div id="spa-page-stocktaking">
  <style>
    #spa-page-stocktaking {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    #spa-page-stocktaking .stk-content-container {
      padding: 16px;
      max-width: 800px;
      margin: 0 auto;
    }

    /* ã‚¿ãƒ– */
    #spa-page-stocktaking .stk-nav-tabs-custom {
      background: white;
      border-radius: 12px;
      padding: 8px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: flex;
      gap: 8px;
      list-style: none;
    }
    #spa-page-stocktaking .stk-nav-tabs-custom .stk-nav-item {
      flex: 1;
    }
    #spa-page-stocktaking .stk-nav-tabs-custom .stk-nav-link {
      border: none;
      border-radius: 8px;
      padding: 12px 10px;
      color: #6b7280;
      font-weight: 500;
      font-size: 0.875rem;
      width: 100%;
      text-align: center;
      background: #f3f4f6;
      cursor: pointer;
      display: block;
    }
    #spa-page-stocktaking .stk-nav-tabs-custom .stk-nav-link:hover {
      background: #e0f7fa;
      color: #1E8FBF;
    }
    #spa-page-stocktaking .stk-nav-tabs-custom .stk-nav-link.active {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      color: white;
    }

    /* ã‚«ãƒ¼ãƒ‰ */
    #spa-page-stocktaking .stk-card-section {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    #spa-page-stocktaking .stk-card-section h6 {
      color: #374151;
      font-weight: 600;
      margin-bottom: 12px;
    }

    /* ã‚µãƒãƒªãƒ¼ã‚°ãƒªãƒƒãƒ‰ */
    #spa-page-stocktaking .stk-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    #spa-page-stocktaking .stk-summary-card {
      background: white;
      padding: 12px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    #spa-page-stocktaking .stk-summary-card.highlight {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    #spa-page-stocktaking .stk-summary-card.highlight .stk-summary-label { color: rgba(255,255,255,0.8); }
    #spa-page-stocktaking .stk-summary-card.highlight .stk-summary-value { color: white; }
    #spa-page-stocktaking .stk-summary-card.warning { border: 2px solid #f59e0b; }
    #spa-page-stocktaking .stk-summary-card.danger { border: 2px solid #ef4444; }
    #spa-page-stocktaking .stk-summary-label {
      font-size: 0.7rem;
      color: #6b7280;
      margin-bottom: 4px;
    }
    #spa-page-stocktaking .stk-summary-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: #1f2937;
    }

    /* æ£šå¸ãƒªã‚¹ãƒˆ */
    #spa-page-stocktaking .stk-check-item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: all 0.2s;
    }
    #spa-page-stocktaking .stk-check-item:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    #spa-page-stocktaking .stk-check-item.active {
      border: 2px solid #10b981;
    }
    #spa-page-stocktaking .stk-check-status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    #spa-page-stocktaking .stk-check-status.draft { background: #e5e7eb; color: #374151; }
    #spa-page-stocktaking .stk-check-status.in-progress { background: #fef3c7; color: #92400e; }
    #spa-page-stocktaking .stk-check-status.completed { background: #d1fae5; color: #065f46; }
    #spa-page-stocktaking .stk-check-status.adjusted { background: #dbeafe; color: #1e40af; }

    /* åœ¨åº«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ */
    #spa-page-stocktaking .stk-inventory-status {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      margin-left: 6px;
    }
    #spa-page-stocktaking .stk-inventory-status.purchased { background: #fef3c7; color: #92400e; }
    #spa-page-stocktaking .stk-inventory-status.registered { background: #d1fae5; color: #065f46; }
    #spa-page-stocktaking .stk-inventory-status.sold { background: #e5e7eb; color: #6b7280; }

    /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
    #spa-page-stocktaking .stk-progress-bar-custom {
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin: 8px 0;
    }
    #spa-page-stocktaking .stk-progress-bar-custom .stk-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #059669);
      transition: width 0.3s;
    }

    /* QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ */
    #spa-page-stocktaking #stk-qr-reader {
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
      border-radius: 12px;
      overflow: hidden;
    }
    #spa-page-stocktaking #stk-qr-reader video {
      border-radius: 12px;
    }
    #spa-page-stocktaking .stk-scan-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      z-index: 9999;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    #spa-page-stocktaking .stk-scan-overlay.active { display: flex; }
    #spa-page-stocktaking .stk-scan-header {
      color: white;
      text-align: center;
      margin-bottom: 20px;
    }
    #spa-page-stocktaking .stk-scan-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
    }

    /* ã‚«ã‚¦ãƒ³ãƒˆå…¥åŠ› */
    #spa-page-stocktaking .stk-count-input-card {
      background: #f0fdf4;
      border: 2px solid #10b981;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    #spa-page-stocktaking .stk-count-input-card .stk-product-info {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    #spa-page-stocktaking .stk-count-input-card .stk-product-image {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      background: #e5e7eb;
    }
    #spa-page-stocktaking .stk-count-input-card .stk-product-details {
      flex: 1;
    }
    #spa-page-stocktaking .stk-count-input-card .stk-product-name {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }
    #spa-page-stocktaking .stk-count-input-card .stk-product-meta {
      font-size: 0.8rem;
      color: #6b7280;
    }
    #spa-page-stocktaking .stk-count-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 12px;
    }
    #spa-page-stocktaking .stk-count-label {
      font-size: 0.875rem;
      color: #374151;
      min-width: 80px;
    }
    #spa-page-stocktaking .stk-count-value {
      font-size: 1.25rem;
      font-weight: 700;
    }
    #spa-page-stocktaking .stk-count-input {
      width: 80px;
      text-align: center;
      font-size: 1.25rem;
      font-weight: 700;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      padding: 8px;
    }
    #spa-page-stocktaking .stk-count-input:focus {
      border-color: #10b981;
      outline: none;
    }
    #spa-page-stocktaking .stk-diff-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: 600;
    }
    #spa-page-stocktaking .stk-diff-badge.match { background: #d1fae5; color: #065f46; }
    #spa-page-stocktaking .stk-diff-badge.over { background: #dbeafe; color: #1e40af; }
    #spa-page-stocktaking .stk-diff-badge.under { background: #fee2e2; color: #991b1b; }

    /* å·®ç•°ãƒªã‚¹ãƒˆ */
    #spa-page-stocktaking .stk-diff-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
    }
    #spa-page-stocktaking .stk-diff-item:last-child { border-bottom: none; }
    #spa-page-stocktaking .stk-diff-item .stk-item-info { flex: 1; }
    #spa-page-stocktaking .stk-diff-item .stk-item-name { font-weight: 600; font-size: 0.9rem; }
    #spa-page-stocktaking .stk-diff-item .stk-item-meta { font-size: 0.75rem; color: #6b7280; }
    #spa-page-stocktaking .stk-diff-item .stk-diff-values {
      text-align: right;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ« */
    #spa-page-stocktaking .stk-data-table {
      width: 100%;
      font-size: 0.8rem;
    }
    #spa-page-stocktaking .stk-data-table th {
      background: #f9fafb;
      padding: 10px 8px;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
      white-space: nowrap;
    }
    #spa-page-stocktaking .stk-data-table td {
      padding: 10px 8px;
      border-bottom: 1px solid #f3f4f6;
      vertical-align: middle;
    }
    #spa-page-stocktaking .stk-data-table tr:hover { background: #f9fafb; }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    #spa-page-stocktaking .stk-loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9998;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    #spa-page-stocktaking .stk-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9997;
    }
    #spa-page-stocktaking .stk-modal-overlay.active {
      display: flex;
    }
    #spa-page-stocktaking .stk-modal-content {
      background: white;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    #spa-page-stocktaking .stk-modal-header {
      padding: 16px 16px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #spa-page-stocktaking .stk-modal-header h5 {
      margin: 0;
      font-weight: 600;
    }
    #spa-page-stocktaking .stk-modal-body {
      padding: 16px;
    }
    #spa-page-stocktaking .stk-modal-footer {
      padding: 0 16px 16px;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    #spa-page-stocktaking .stk-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6b7280;
      line-height: 1;
    }

    /* FAB */
    #spa-page-stocktaking .stk-fab-container {
      position: fixed;
      bottom: 80px;
      right: 20px;
      z-index: 1000;
    }
    #spa-page-stocktaking .stk-fab-button {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    #spa-page-stocktaking .stk-fab-button:active { transform: scale(0.95); }

    /* INV-010: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ */
    #spa-page-stocktaking .stk-filter-btn {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 20px;
      border: 1px solid #d1d5db;
      background: white;
      color: #374151;
      cursor: pointer;
    }
    #spa-page-stocktaking .stk-filter-btn.active {
      background: #10b981;
      border-color: #10b981;
      color: white;
    }

    /* ã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼ */
    #spa-page-stocktaking .stk-sub-header {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 56px;
      padding: 0 16px;
      background: #ffffff;
      border-bottom: 1px solid #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    #spa-page-stocktaking .stk-sub-header-back {
      position: absolute;
      left: 16px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 20px;
      transition: background 0.2s;
    }
    #spa-page-stocktaking .stk-sub-header-back:hover { background: #f2f2f2; }
    #spa-page-stocktaking .stk-sub-header-back:active { background: #e5e5e5; }
    #spa-page-stocktaking .stk-sub-header-title {
      font-weight: 600;
      font-size: 16px;
      color: #1f2937;
    }
    #spa-page-stocktaking .stk-sub-header-icons {
      position: absolute;
      right: 16px;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    #spa-page-stocktaking .stk-sub-header-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 20px;
      transition: background 0.2s;
      position: relative;
    }
    #spa-page-stocktaking .stk-sub-header-icon:hover { background: #f2f2f2; }
    #spa-page-stocktaking .stk-sub-header-icon:active { background: #e5e5e5; }

    /* è¨­å®šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ */
    #spa-page-stocktaking .stk-settings-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 200px;
      padding: 8px 0;
      display: none;
      z-index: 1001;
    }
    #spa-page-stocktaking .stk-settings-dropdown.active {
      display: block;
    }
    #spa-page-stocktaking .stk-settings-dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border: none;
      background: none;
      width: 100%;
      font-size: 14px;
      color: #374151;
      cursor: pointer;
      text-align: left;
    }
    #spa-page-stocktaking .stk-settings-dropdown-item:hover {
      background: #f3f4f6;
    }
    #spa-page-stocktaking .stk-settings-dropdown-item i {
      font-size: 18px;
      color: #6b7280;
      width: 20px;
      text-align: center;
    }

    #spa-page-stocktaking .stk-announce-dot {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      display: none;
    }
    #spa-page-stocktaking .stk-announce-dot.visible {
      display: block;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 576px) {
      #spa-page-stocktaking .stk-summary-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div class="stk-loading-overlay" id="stk-loadingOverlay">
    <div style="text-align: center;">
      <div class="spinner-border text-success" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>
  </div>

  <!-- QRã‚¹ã‚­ãƒ£ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div class="stk-scan-overlay" id="stk-scanOverlay">
    <button class="stk-scan-close" onclick="stkStopScanner()">Ã—</button>
    <div class="stk-scan-header">
      <h5>QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</h5>
      <p class="small text-muted mb-0">å•†å“ã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„</p>
    </div>
    <div id="stk-qr-reader"></div>
    <button class="btn btn-outline-light mt-3" onclick="stkStopScanner()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>

  <!-- ã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="stk-sub-header">
    <button class="stk-sub-header-back" onclick="stkGoBack()" title="æˆ»ã‚‹">
      <i class="bi bi-chevron-left"></i>
    </button>
    <span class="stk-sub-header-title">æ£šå¸</span>
    <div class="stk-sub-header-icons">
      <button class="stk-sub-header-icon" title="é€šçŸ¥" onclick="stkOpenAnnouncePage()">
        <i class="bi bi-bell"></i>
        <span class="stk-announce-dot" id="stk-announceDot"></span>
      </button>
      <div style="position: relative;">
        <button class="stk-sub-header-icon" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼" onclick="stkToggleSettingsDropdown(event)">
          <i class="bi bi-list"></i>
        </button>
        <div class="stk-settings-dropdown" id="stk-settingsDropdown">
          <button class="stk-settings-dropdown-item" onclick="stkOpenNewCheckModal(); stkCloseSettingsDropdown();">
            <i class="bi bi-plus-lg"></i>
            <span>æ–°è¦æ£šå¸ï¼ˆå˜æ—¥ï¼‰</span>
          </button>
          <button class="stk-settings-dropdown-item" onclick="stkOpenStocktakingAdmin(); return false;">
            <i class="bi bi-calendar-range"></i>
            <span>æœŸé–“æ£šå¸ç®¡ç†</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="stk-content-container">
    <!-- æœŸé–“æ£šå¸ãƒãƒŠãƒ¼ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–æœŸé–“ãŒã‚ã‚‹å ´åˆã«è¡¨ç¤ºï¼‰ -->
    <div id="stk-periodBanner" class="stk-card-section" style="display: none; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; margin-bottom: 16px;">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="fw-bold" id="stk-periodBannerName">æœŸé–“æ£šå¸å®Ÿæ–½ä¸­</div>
          <div style="font-size: 0.85rem; opacity: 0.9;" id="stk-periodBannerInfo">æœŸé–“: - | æ®‹ã‚Š: -æ—¥</div>
        </div>
        <div id="stk-periodBannerProgress" style="text-align: right;">
          <div style="font-size: 1.5rem; font-weight: 700;">0%</div>
          <div style="font-size: 0.75rem; opacity: 0.9;">å®Œäº†</div>
        </div>
      </div>
      <div class="progress mt-2" style="height: 6px; background: rgba(255,255,255,0.3); border-radius: 3px;">
        <div class="progress-bar" id="stk-periodProgressBar" role="progressbar" style="width: 0%; background: white;"></div>
      </div>
    </div>

    <!-- ã‚¿ãƒ– -->
    <ul class="stk-nav-tabs-custom" role="tablist">
      <li class="stk-nav-item" role="presentation">
        <button class="stk-nav-link active" data-stk-tab="stk-list-tab" type="button" onclick="stkSwitchTab('stk-list-tab', this)">
          <i class="bi bi-list-ul"></i> ä¸€è¦§
        </button>
      </li>
      <li class="stk-nav-item" role="presentation">
        <button class="stk-nav-link" data-stk-tab="stk-count-tab" type="button" id="stk-count-tab-btn" onclick="stkSwitchTab('stk-count-tab', this)">
          <i class="bi bi-pencil-square"></i> ã‚«ã‚¦ãƒ³ãƒˆ
        </button>
      </li>
      <li class="stk-nav-item" role="presentation">
        <button class="stk-nav-link" data-stk-tab="stk-diff-tab" type="button" onclick="stkSwitchTab('stk-diff-tab', this)">
          <i class="bi bi-graph-up-arrow"></i> å·®ç•°åˆ†æ
        </button>
      </li>
    </ul>

    <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="stk-tab-content">
      <!-- ä¸€è¦§ã‚¿ãƒ– -->
      <div class="stk-tab-pane" id="stk-list-tab" style="display: block;">
        <!-- é€²è¡Œä¸­ã®æ£šå¸ -->
        <div class="stk-card-section">
          <h6><i class="bi bi-clock-history"></i> é€²è¡Œä¸­</h6>
          <div id="stk-inProgressList">
            <div class="text-center text-muted py-3">é€²è¡Œä¸­ã®æ£šå¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>
          </div>
        </div>

        <!-- å®Œäº†æ¸ˆã¿ -->
        <div class="stk-card-section">
          <h6><i class="bi bi-check-circle"></i> å®Œäº†æ¸ˆã¿</h6>
          <div id="stk-completedList">
            <div class="text-center text-muted py-3">å®Œäº†ã—ãŸæ£šå¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>
          </div>
        </div>
      </div>

      <!-- ã‚«ã‚¦ãƒ³ãƒˆã‚¿ãƒ– -->
      <div class="stk-tab-pane" id="stk-count-tab" style="display: none;">
        <!-- ç¾åœ¨ã®æ£šå¸æƒ…å ± -->
        <div id="stk-noActiveCheck" class="stk-card-section" style="text-align: center; padding: 24px 16px;">
          <i class="bi bi-clipboard-x text-muted" style="font-size: 48px;"></i>
          <p class="text-muted mt-2 mb-3">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ£šå¸ãŒã‚ã‚Šã¾ã›ã‚“</p>
          <button class="btn btn-success" onclick="stkOpenNewCheckModal()">
            <i class="bi bi-plus-lg"></i> æ–°è¦æ£šå¸ã‚’é–‹å§‹
          </button>
        </div>

        <div id="stk-activeCheckPanel" style="display: none;">
          <!-- é€²æ—ã‚µãƒãƒªãƒ¼ -->
          <div class="stk-summary-grid">
            <div class="stk-summary-card highlight">
              <div class="stk-summary-label">é€²æ—</div>
              <div class="stk-summary-value" id="stk-count-progress">0%</div>
            </div>
            <div class="stk-summary-card">
              <div class="stk-summary-label">å®Œäº†</div>
              <div class="stk-summary-value" id="stk-count-done">0</div>
            </div>
            <div class="stk-summary-card">
              <div class="stk-summary-label">æ®‹ã‚Š</div>
              <div class="stk-summary-value" id="stk-count-remaining">0</div>
            </div>
            <div class="stk-summary-card warning">
              <div class="stk-summary-label">å·®ç•°</div>
              <div class="stk-summary-value" id="stk-count-diff">0</div>
            </div>
          </div>

          <!-- INV-010: å•†å“ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
          <div class="stk-card-section">
            <div class="d-flex gap-2 mb-2">
              <button class="stk-filter-btn active" data-filter="all" onclick="stkSetItemFilter('all')">
                ã™ã¹ã¦
              </button>
              <button class="stk-filter-btn" data-filter="unique" onclick="stkSetItemFilter('unique')">
                1ç‚¹ç‰©
              </button>
              <button class="stk-filter-btn" data-filter="sku-based" onclick="stkSetItemFilter('sku-based')">
                SKUå•†å“
              </button>
            </div>
            <div id="stk-filterSummary" class="small text-muted mb-2"></div>
          </div>

          <!-- ã‚¹ã‚­ãƒ£ãƒ³/æ¤œç´¢ -->
          <div class="stk-card-section">
            <div class="row g-2">
              <div class="col">
                <button class="btn btn-success w-100" onclick="stkStartScanner()">
                  <i class="bi bi-qr-code-scan"></i> QRã‚¹ã‚­ãƒ£ãƒ³
                </button>
              </div>
              <div class="col">
                <div class="input-group">
                  <input type="text" class="form-control" id="stk-searchInput" placeholder="ç®¡ç†ç•ªå·ã§æ¤œç´¢">
                  <button class="btn btn-outline-secondary" onclick="stkSearchProduct()">
                    <i class="bi bi-search"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- ã‚«ã‚¦ãƒ³ãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ -->
          <div id="stk-countInputArea">
            <!-- å•†å“é¸æŠå¾Œã«è¡¨ç¤º -->
          </div>

          <!-- æœªã‚«ã‚¦ãƒ³ãƒˆãƒªã‚¹ãƒˆ -->
          <div class="stk-card-section">
            <h6><i class="bi bi-list-ul"></i> æœªã‚«ã‚¦ãƒ³ãƒˆå•†å“</h6>
            <div id="stk-uncountedList" style="max-height: 300px; overflow-y: auto;">
              <div class="text-center text-muted py-3">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- å·®ç•°åˆ†æã‚¿ãƒ– -->
      <div class="stk-tab-pane" id="stk-diff-tab" style="display: none;">
        <div id="stk-noDiffData" class="stk-card-section" style="text-align: center; padding: 24px 16px;">
          <i class="bi bi-bar-chart text-muted" style="font-size: 48px;"></i>
          <p class="text-muted mt-2">æ£šå¸ã‚’å®Œäº†ã™ã‚‹ã¨å·®ç•°åˆ†æãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
        </div>

        <div id="stk-diffPanel" style="display: none;">
          <!-- å·®ç•°ã‚µãƒãƒªãƒ¼ -->
          <div class="stk-summary-grid">
            <div class="stk-summary-card">
              <div class="stk-summary-label">ç·ã‚¢ã‚¤ãƒ†ãƒ </div>
              <div class="stk-summary-value" id="stk-diff-total">0</div>
            </div>
            <div class="stk-summary-card highlight">
              <div class="stk-summary-label">ä¸€è‡´</div>
              <div class="stk-summary-value" id="stk-diff-match">0</div>
            </div>
            <div class="stk-summary-card warning">
              <div class="stk-summary-label">éå‰°</div>
              <div class="stk-summary-value" id="stk-diff-over">0</div>
            </div>
            <div class="stk-summary-card danger">
              <div class="stk-summary-label">ä¸è¶³</div>
              <div class="stk-summary-value" id="stk-diff-under">0</div>
            </div>
          </div>

          <!-- å·®ç•°é‡‘é¡ -->
          <div class="stk-card-section">
            <h6><i class="bi bi-currency-yen"></i> å·®ç•°é‡‘é¡</h6>
            <div class="row text-center">
              <div class="col-6">
                <div class="text-muted small">éå‰°ï¼ˆæ£šå¸å¢—ï¼‰</div>
                <div class="text-primary fw-bold fs-5" id="stk-diff-over-amount">Â¥0</div>
              </div>
              <div class="col-6">
                <div class="text-muted small">ä¸è¶³ï¼ˆæ£šå¸æ¸›ï¼‰</div>
                <div class="text-danger fw-bold fs-5" id="stk-diff-under-amount">Â¥0</div>
              </div>
            </div>
          </div>

          <!-- å·®ç•°è©³ç´° -->
          <div class="stk-card-section">
            <h6><i class="bi bi-exclamation-triangle"></i> å·®ç•°è©³ç´°</h6>
            <div id="stk-diffDetailList" style="max-height: 400px; overflow-y: auto;">
              <div class="text-center text-muted py-3">å·®ç•°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
            </div>
          </div>

          <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="stk-card-section">
            <div class="row g-2">
              <div class="col-6">
                <button class="btn btn-outline-success w-100" onclick="stkExportDiffReport()">
                  <i class="bi bi-download"></i> ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
                </button>
              </div>
              <div class="col-6">
                <button class="btn btn-success w-100" onclick="stkApplyAdjustment()">
                  <i class="bi bi-check-lg"></i> åœ¨åº«èª¿æ•´ã‚’é©ç”¨
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FABï¼ˆã‚«ã‚¦ãƒ³ãƒˆä¸­ã®ã¿ï¼‰ -->
  <div class="stk-fab-container" id="stk-fabContainer" style="display: none;">
    <button class="stk-fab-button" onclick="stkStartScanner()">
      <i class="bi bi-qr-code-scan"></i>
    </button>
  </div>

  <!-- æ–°è¦æ£šå¸ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="stk-modal-overlay" id="stk-newCheckModal">
    <div class="stk-modal-content">
      <div class="stk-modal-header">
        <h5><i class="bi bi-plus-circle"></i> æ–°è¦æ£šå¸</h5>
        <button class="stk-modal-close" onclick="stkCloseNewCheckModal()">&times;</button>
      </div>
      <div class="stk-modal-body">
        <div class="mb-3">
          <label class="form-label fw-bold">æ£šå¸åç§°</label>
          <input type="text" class="form-control" id="stk-checkName" placeholder="ä¾‹: 2025å¹´12æœˆæ£šå¸">
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">å®Ÿæ–½æ—¥</label>
          <input type="date" class="form-control" id="stk-checkDate">
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">å¯¾è±¡</label>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="stk-targetProducts" checked>
            <label class="form-check-label" for="stk-targetProducts">å•†å“åœ¨åº«</label>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">ã‚«ã‚¦ãƒ³ãƒˆæ–¹å¼</label>
          <select class="form-select" id="stk-countMethod">
            <option value="all">å…¨æ•°æ£šå¸ï¼ˆå…¨å•†å“ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼‰</option>
            <option value="category">ã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼ˆç‰¹å®šã‚«ãƒ†ã‚´ãƒªã®ã¿ï¼‰</option>
          </select>
        </div>
      </div>
      <div class="stk-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="stkCloseNewCheckModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="button" class="btn btn-success" onclick="stkCreateNewCheck()">
          <i class="bi bi-play-fill"></i> é–‹å§‹
        </button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // Global variables (prefixed with _stk_)
    // ============================================
    var _stk_allPurchaseSlots = []; // ä»•å…¥å•†å“ï¼ˆæ£šå¸ã®ä¸»ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ï¼‰
    var _stk_allProducts = [];      // å•†å“ï¼ˆè£œåŠ©ãƒ‡ãƒ¼ã‚¿ï¼‰
    var _stk_allChecks = [];
    var _stk_activeCheck = null;
    var _stk_checkItems = {};
    var _stk_currentSlot = null;    // ç¾åœ¨é¸æŠä¸­ã®ä»•å…¥å•†å“
    var _stk_html5QrCode = null;
    var _stk_currentItemFilter = 'all'; // INV-010: å•†å“ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    var _stk_activePeriod = null;
    var _stk_currentUserEmail = null;
    var _stk_currentUserName = null;
    var _stk_periodCheckItems = {};
    var _stk_myStocktakingProducts = [];
    var _stk_dropdownClickHandler = null;
    var _stk_searchKeyHandler = null;

    // ============================================
    // StocktakingApi (uses parent Firebase globals)
    // ============================================
    var _stk_Api = {
      // ä»•å…¥å•†å“ä¸€è¦§å–å¾—ï¼ˆpurchaseSlotsãƒ™ãƒ¼ã‚¹ï¼‰
      async getPurchaseSlots() {
        var db = window.firebaseDB;
        var ref = window.firestoreCollection(db, 'purchaseSlots');
        var snapshot = await window.firestoreGetDocs(ref);
        var slots = [];
        snapshot.forEach(function(doc) { slots.push({ id: doc.id, ...doc.data() }); });
        return slots;
      },
      // å•†å“ä¸€è¦§å–å¾—ï¼ˆproducts - è£œåŠ©ç”¨ï¼‰
      async getProducts() {
        var db = window.firebaseDB;
        var ref = window.firestoreCollection(db, 'products');
        var snapshot = await window.firestoreGetDocs(ref);
        var products = [];
        snapshot.forEach(function(doc) { products.push({ id: doc.id, ...doc.data() }); });
        return products;
      },
      // æ£šå¸ä¸€è¦§å–å¾—
      async getChecks() {
        var db = window.firebaseDB;
        var ref = window.firestoreCollection(db, 'inventoryChecks');
        var snapshot = await window.firestoreGetDocs(ref);
        var checks = [];
        snapshot.forEach(function(doc) { checks.push({ id: doc.id, ...doc.data() }); });
        return checks.sort(function(a, b) { return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0); });
      },
      // æ£šå¸ä½œæˆ
      async createCheck(data) {
        var db = window.firebaseDB;
        var ref = window.firestoreCollection(db, 'inventoryChecks');
        var docRef = await window.firestoreAddDoc(ref, {
          ...data,
          status: 'in_progress',
          progress: 0,
          createdAt: window.firestoreServerTimestamp(),
          updatedAt: window.firestoreServerTimestamp()
        });
        return docRef.id;
      },
      // æ£šå¸æ›´æ–°
      async updateCheck(checkId, data) {
        var db = window.firebaseDB;
        var docRef = window.firestoreDoc(db, 'inventoryChecks', checkId);
        await window.firestoreUpdateDoc(docRef, {
          ...data,
          updatedAt: window.firestoreServerTimestamp()
        });
      },
      // ã‚«ã‚¦ãƒ³ãƒˆçµæœå–å¾—
      async getCheckItems(checkId) {
        var db = window.firebaseDB;
        var ref = window.firestoreCollection(db, 'inventoryChecks', checkId, 'items');
        var snapshot = await window.firestoreGetDocs(ref);
        var items = [];
        snapshot.forEach(function(doc) { items.push({ id: doc.id, ...doc.data() }); });
        return items;
      },
      // ã‚«ã‚¦ãƒ³ãƒˆçµæœä¿å­˜
      async saveCountItem(checkId, productId, data) {
        var db = window.firebaseDB;
        var docRef = window.firestoreDoc(db, 'inventoryChecks', checkId, 'items', productId);
        await window.firestoreSetDoc(docRef, {
          ...data,
          countedAt: window.firestoreServerTimestamp()
        });
      },
      // å•†å“ã®åœ¨åº«æ•°æ›´æ–°
      async updateProductQuantity(productId, quantity, itemData) {
        itemData = itemData || {};
        var db = window.firebaseDB;
        // INV-010: SKUå•†å“ã®å ´åˆã¯skusã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚‚æ›´æ–°
        if (itemData.itemType === 'sku-based' && itemData.skuId) {
          var prodRef = window.firestoreDoc(db, 'products', productId);
          await window.firestoreUpdateDoc(prodRef, {
            stockQuantity: quantity,
            updatedAt: window.firestoreServerTimestamp()
          });
          // skusã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚‚æ›´æ–°
          var skuRef = window.firestoreCollection(db, 'skus');
          var skuQuery = window.firestoreQuery(skuRef, window.firestoreWhere('skuId', '==', itemData.skuId));
          var skuSnapshot = await window.firestoreGetDocs(skuQuery);
          for (var i = 0; i < skuSnapshot.docs.length; i++) {
            var skuDoc = skuSnapshot.docs[i];
            var skuDocRef = window.firestoreDoc(db, 'skus', skuDoc.id);
            await window.firestoreUpdateDoc(skuDocRef, {
              currentStock: quantity,
              updatedAt: window.firestoreServerTimestamp()
            });
          }
        } else {
          // é€šå¸¸ã®1ç‚¹ç‰©
          var prodRef2 = window.firestoreDoc(db, 'products', productId);
          await window.firestoreUpdateDoc(prodRef2, {
            quantity: quantity,
            updatedAt: window.firestoreServerTimestamp()
          });
        }
      }
    };

    // ============================================
    // Tab switching (custom, no Bootstrap JS tabs)
    // ============================================
    function stkSwitchTab(tabId, btnEl) {
      // Hide all tab panes
      var panes = document.querySelectorAll('#spa-page-stocktaking .stk-tab-pane');
      for (var i = 0; i < panes.length; i++) {
        panes[i].style.display = 'none';
      }
      // Deactivate all tab buttons
      var btns = document.querySelectorAll('#spa-page-stocktaking .stk-nav-link');
      for (var j = 0; j < btns.length; j++) {
        btns[j].classList.remove('active');
      }
      // Show selected pane
      var target = document.getElementById(tabId);
      if (target) target.style.display = 'block';
      // Activate clicked button
      if (btnEl) btnEl.classList.add('active');
    }

    // ============================================
    // Utility functions
    // ============================================

    // æ—¥æœ¬æ™‚é–“ã§ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆYYYY-MM-DDå½¢å¼ï¼‰
    function stkGetJSTToday() {
      var now = new Date();
      var jst = new Date(now.getTime() + (9 * 60 + now.getTimezoneOffset()) * 60000);
      var year = jst.getFullYear();
      var month = String(jst.getMonth() + 1).padStart(2, '0');
      var day = String(jst.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }

    // æ—¥æœ¬æ™‚é–“ã®æ—¥ä»˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
    function stkGetJSTDate() {
      var now = new Date();
      return new Date(now.getTime() + (9 * 60 + now.getTimezoneOffset()) * 60000);
    }

    function stkShowLoading() {
      var el = document.getElementById('stk-loadingOverlay');
      if (el) el.style.display = 'flex';
    }
    function stkHideLoading() {
      var el = document.getElementById('stk-loadingOverlay');
      if (el) el.style.display = 'none';
    }

    function stkFormatCurrency(amount) {
      if (amount === null || amount === undefined || isNaN(amount)) return 'Â¥0';
      return 'Â¥' + Math.round(amount).toLocaleString();
    }

    function stkFormatDate(timestamp) {
      if (!timestamp) return '-';
      var date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      return date.toLocaleDateString('ja-JP');
    }

    // ============================================
    // Navigation
    // ============================================
    function stkGoBack() {
      if (typeof navigateToPage === 'function') {
        navigateToPage('home');
      } else if (typeof spaGoBack === 'function') {
        spaGoBack();
      }
    }

    function stkOpenAnnouncePage() {
      if (typeof navigateToPage === 'function') {
        navigateToPage('announce');
      }
    }

    function stkOpenStocktakingAdmin() {
      stkCloseSettingsDropdown();
      if (typeof navigateToPage === 'function') {
        navigateToPage('stocktaking-admin');
      }
    }

    // ============================================
    // Settings dropdown
    // ============================================
    function stkToggleSettingsDropdown(event) {
      event.stopPropagation();
      var dropdown = document.getElementById('stk-settingsDropdown');
      if (dropdown) dropdown.classList.toggle('active');
    }

    function stkCloseSettingsDropdown() {
      var dropdown = document.getElementById('stk-settingsDropdown');
      if (dropdown) dropdown.classList.remove('active');
    }

    // ============================================
    // Data loading
    // ============================================
    async function stkInitializePage() {
      console.log('[Stk SPA] stkInitializePage start');
      stkShowLoading();
      try {
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ—¥ä»˜ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰
        var dateEl = document.getElementById('stk-checkDate');
        if (dateEl) dateEl.value = stkGetJSTToday();
        var jstDate = stkGetJSTDate();
        var nameEl = document.getElementById('stk-checkName');
        if (nameEl) nameEl.value = jstDate.getFullYear() + 'å¹´' + (jstDate.getMonth() + 1) + 'æœˆæ£šå¸';

        await stkLoadData();

        // æœŸé–“ãƒ™ãƒ¼ã‚¹æ£šå¸ã®åˆæœŸåŒ–
        await stkInitializePeriodStocktaking();

        console.log('[Stk SPA] åˆæœŸåŒ–å®Œäº†');
      } catch (error) {
        console.error('[Stk SPA] åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      } finally {
        stkHideLoading();
      }
    }

    async function stkLoadData() {
      // purchaseSlotsã‚’ä¸»ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦å–å¾—
      _stk_allPurchaseSlots = await _stk_Api.getPurchaseSlots();
      // productsã‚‚è£œåŠ©ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦å–å¾—ï¼ˆå•†å“è©³ç´°æƒ…å ±ç”¨ï¼‰
      _stk_allProducts = await _stk_Api.getProducts();
      _stk_allChecks = await _stk_Api.getChecks();

      // productsã®æƒ…å ±ã‚’purchaseSlotsã«ãƒãƒ¼ã‚¸
      var productMap = {};
      _stk_allProducts.forEach(function(p) {
        productMap[p.id] = p;
        // purchaseSlotIdã§ã‚‚ãƒãƒƒãƒ—
        if (p.purchaseSlotId) {
          productMap[p.purchaseSlotId] = p;
        }
      });

      // purchaseSlotsã«å•†å“è©³ç´°ã‚’è¿½åŠ 
      _stk_allPurchaseSlots = _stk_allPurchaseSlots.map(function(slot) {
        var product = productMap[slot.productId] || productMap[slot.id];
        // INV-010: itemTypeã¨stockQuantityã‚’å–å¾—
        var itemType = slot.itemType || (product ? product.itemType : null) || 'unique';
        var stockQuantity = itemType === 'sku-based'
          ? ((product ? product.stockQuantity : null) || slot.quantity || 1)
          : ((product ? product.quantity : null) || 1);
        return {
          ...slot,
          productName: slot.productName || (product ? product.productName : '') || '',
          brand: slot.brand || (product ? product.brand : '') || '',
          category: slot.category || (product ? product.category : '') || '',
          images: product ? product.images : [] || [],
          quantity: stockQuantity,
          itemType: itemType,
          stockQuantity: stockQuantity,
          skuId: slot.skuId || (product ? product.skuId : null) || null,
          purchaseAmount: slot.purchasePrice || (product ? (product.purchase ? product.purchase.amount : product.purchaseAmount) : 0) || 0,
          displayStatus: stkGetDisplayStatus(slot, product, itemType)
        };
      });

      console.log('[Stk SPA] ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: purchaseSlots=' + _stk_allPurchaseSlots.length + ', products=' + _stk_allProducts.length);

      // é€²è¡Œä¸­ã®æ£šå¸ãŒã‚ã‚Œã°è¨­å®š
      _stk_activeCheck = _stk_allChecks.find(function(c) { return c.status === 'in_progress'; });
      if (_stk_activeCheck) {
        var items = await _stk_Api.getCheckItems(_stk_activeCheck.id);
        _stk_checkItems = {};
        items.forEach(function(item) { _stk_checkItems[item.id] = item; });
      }

      stkRenderCheckList();
      stkUpdateCountTab();
      stkUpdateDiffTab();
    }

    // è¡¨ç¤ºç”¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’åˆ¤å®š
    function stkGetDisplayStatus(slot, product, itemType) {
      itemType = itemType || 'unique';
      // å£²å´æ¸ˆãƒã‚§ãƒƒã‚¯
      if (slot.status === 'sold' || (product && product.status === 'è²©å£²æ¸ˆ')) {
        return { label: 'å£²å´æ¸ˆ', class: 'sold', color: '#6b7280' };
      }
      // INV-010: SKUå•†å“ã®å ´åˆã¯ç‰¹åˆ¥ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
      if (itemType === 'sku-based') {
        if (slot.status === 'registered' || slot.productId) {
          return { label: 'SKUå‡ºå“ä¸­', class: 'registered sku', color: '#3b82f6' };
        }
        return { label: 'SKUæœªç™»éŒ²', class: 'purchased sku', color: '#8b5cf6' };
      }
      // å•†å“ç™»éŒ²æ¸ˆãƒã‚§ãƒƒã‚¯
      if (slot.status === 'registered' || slot.productId) {
        return { label: 'å‡ºå“ä¸­', class: 'registered', color: '#10b981' };
      }
      // æœªç™»éŒ²
      return { label: 'æœªç™»éŒ²', class: 'purchased', color: '#f59e0b' };
    }

    // ============================================
    // Render check list (list tab)
    // ============================================
    function stkRenderCheckList() {
      // é€²è¡Œä¸­
      var inProgress = _stk_allChecks.filter(function(c) { return c.status === 'in_progress'; });
      var inProgressHtml = inProgress.length > 0 ? inProgress.map(function(c) {
        return '<div class="stk-check-item ' + (_stk_activeCheck && _stk_activeCheck.id === c.id ? 'active' : '') + '" onclick="stkSelectCheck(\'' + c.id + '\')">' +
          '<div class="d-flex justify-content-between align-items-start">' +
            '<div>' +
              '<div class="fw-bold">' + (c.name || 'æ£šå¸') + '</div>' +
              '<div class="small text-muted">å®Ÿæ–½æ—¥: ' + (c.checkDate || '-') + '</div>' +
            '</div>' +
            '<span class="stk-check-status in-progress">é€²è¡Œä¸­</span>' +
          '</div>' +
          '<div class="stk-progress-bar-custom">' +
            '<div class="stk-fill" style="width: ' + (c.progress || 0) + '%"></div>' +
          '</div>' +
          '<div class="small text-muted">' + (c.progress || 0) + '% å®Œäº†</div>' +
        '</div>';
      }).join('') : '<div class="text-center text-muted py-3">é€²è¡Œä¸­ã®æ£šå¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>';

      var inProgressEl = document.getElementById('stk-inProgressList');
      if (inProgressEl) inProgressEl.innerHTML = inProgressHtml;

      // å®Œäº†æ¸ˆã¿
      var completed = _stk_allChecks.filter(function(c) { return c.status === 'completed' || c.status === 'adjusted'; });
      var completedHtml = completed.length > 0 ? completed.map(function(c) {
        return '<div class="stk-check-item" onclick="stkViewCheckReport(\'' + c.id + '\')">' +
          '<div class="d-flex justify-content-between align-items-start">' +
            '<div>' +
              '<div class="fw-bold">' + (c.name || 'æ£šå¸') + '</div>' +
              '<div class="small text-muted">å®Œäº†æ—¥: ' + stkFormatDate(c.completedAt) + '</div>' +
            '</div>' +
            '<span class="stk-check-status ' + c.status + '">' + (c.status === 'adjusted' ? 'èª¿æ•´æ¸ˆ' : 'å®Œäº†') + '</span>' +
          '</div>' +
          '<div class="small text-muted mt-1">å·®ç•°: ' + (c.diffCount || 0) + 'ä»¶</div>' +
        '</div>';
      }).join('') : '<div class="text-center text-muted py-3">å®Œäº†ã—ãŸæ£šå¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>';

      var completedEl = document.getElementById('stk-completedList');
      if (completedEl) completedEl.innerHTML = completedHtml;
    }

    // ============================================
    // Select check / Filter
    // ============================================
    async function stkSelectCheck(checkId) {
      _stk_activeCheck = _stk_allChecks.find(function(c) { return c.id === checkId; });
      if (_stk_activeCheck) {
        var items = await _stk_Api.getCheckItems(checkId);
        _stk_checkItems = {};
        items.forEach(function(item) { _stk_checkItems[item.id] = item; });

        stkUpdateCountTab();
        // ã‚«ã‚¦ãƒ³ãƒˆã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
        var btn = document.getElementById('stk-count-tab-btn');
        stkSwitchTab('stk-count-tab', btn);
      }
    }

    // INV-010: å•†å“ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š
    function stkSetItemFilter(filter) {
      _stk_currentItemFilter = filter;
      // ãƒœã‚¿ãƒ³ã®activeçŠ¶æ…‹ã‚’æ›´æ–°
      var btns = document.querySelectorAll('#spa-page-stocktaking .stk-filter-btn');
      for (var i = 0; i < btns.length; i++) {
        btns[i].classList.remove('active');
        if (btns[i].dataset.filter === filter) {
          btns[i].classList.add('active');
        }
      }
      stkUpdateCountTab();
    }

    // ============================================
    // Count tab update
    // ============================================
    function stkUpdateCountTab() {
      if (!_stk_activeCheck) {
        var noActiveEl = document.getElementById('stk-noActiveCheck');
        if (noActiveEl) noActiveEl.style.display = 'block';
        var activePanel = document.getElementById('stk-activeCheckPanel');
        if (activePanel) activePanel.style.display = 'none';
        var fabEl = document.getElementById('stk-fabContainer');
        if (fabEl) fabEl.style.display = 'none';
        return;
      }

      var noActiveEl2 = document.getElementById('stk-noActiveCheck');
      if (noActiveEl2) noActiveEl2.style.display = 'none';
      var activePanel2 = document.getElementById('stk-activeCheckPanel');
      if (activePanel2) activePanel2.style.display = 'block';
      var fabEl2 = document.getElementById('stk-fabContainer');
      if (fabEl2) fabEl2.style.display = 'block';

      // é€²æ—è¨ˆç®—ï¼ˆå£²å´æ¸ˆä»¥å¤–ã®purchaseSlotsãŒå¯¾è±¡ï¼‰
      var allTargetSlots = _stk_allPurchaseSlots.filter(function(s) { return !s.displayStatus || s.displayStatus.class !== 'sold'; });

      // INV-010: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
      var targetSlots = _stk_currentItemFilter === 'all'
        ? allTargetSlots
        : allTargetSlots.filter(function(s) { return s.itemType === _stk_currentItemFilter; });

      // å…¨ä½“çµ±è¨ˆï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç„¡é–¢ä¿‚ï¼‰
      var totalAll = allTargetSlots.length;
      var countedAll = Object.keys(_stk_checkItems).length;
      var remainingAll = totalAll - countedAll;
      var progressAll = totalAll > 0 ? Math.round((countedAll / totalAll) * 100) : 0;
      var diffCount = Object.values(_stk_checkItems).filter(function(item) { return item.diff !== 0; }).length;

      var progressEl = document.getElementById('stk-count-progress');
      if (progressEl) progressEl.textContent = progressAll + '%';
      var doneEl = document.getElementById('stk-count-done');
      if (doneEl) doneEl.textContent = countedAll;
      var remainEl = document.getElementById('stk-count-remaining');
      if (remainEl) remainEl.textContent = remainingAll;
      var diffEl = document.getElementById('stk-count-diff');
      if (diffEl) diffEl.textContent = diffCount;

      // INV-010: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆ¥ã‚µãƒãƒªãƒ¼è¡¨ç¤º
      var uniqueCount = allTargetSlots.filter(function(s) { return s.itemType !== 'sku-based'; }).length;
      var skuCount = allTargetSlots.filter(function(s) { return s.itemType === 'sku-based'; }).length;
      var filterSummary = document.getElementById('stk-filterSummary');
      if (filterSummary) {
        filterSummary.innerHTML = '1ç‚¹ç‰©: ' + uniqueCount + 'ä»¶ / SKUå•†å“: ' + skuCount + 'ä»¶';
      }

      // æœªã‚«ã‚¦ãƒ³ãƒˆãƒªã‚¹ãƒˆï¼ˆpurchaseSlotsãƒ™ãƒ¼ã‚¹ï¼‰
      var uncounted = targetSlots.filter(function(s) { return !_stk_checkItems[s.id]; });
      var uncountedHtml = uncounted.length > 0 ? uncounted.slice(0, 50).map(function(s) {
        var isSku = s.itemType === 'sku-based';
        var typeIcon = isSku ? 'ğŸ“¦' : 'ğŸ‘•';
        var qtyLabel = isSku ? 'åœ¨åº«: ' + (s.stockQuantity || 1) + 'ç‚¹' : 'å¸³ç°¿: ' + (s.quantity || 1) + 'ç‚¹';
        return '<div class="stk-diff-item" onclick="stkSelectSlot(\'' + s.id + '\')">' +
          '<div class="stk-item-info">' +
            '<div class="stk-item-name">' +
              typeIcon + ' ' + (s.managementNumber || s.slotId || s.id) +
              ' <span class="badge" style="background: ' + (s.displayStatus ? s.displayStatus.color : '#6b7280') + '; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 6px;">' +
                (s.displayStatus ? s.displayStatus.label : 'ä¸æ˜') +
              '</span>' +
            '</div>' +
            '<div class="stk-item-meta">' + (s.productName || s.brand || '-') + (s.skuId ? ' (' + s.skuId + ')' : '') + '</div>' +
          '</div>' +
          '<div class="text-muted small">' + qtyLabel + '</div>' +
        '</div>';
      }).join('') : '<div class="text-center text-muted py-3">ã™ã¹ã¦ã‚«ã‚¦ãƒ³ãƒˆæ¸ˆã¿ã§ã™</div>';

      var uncountedEl = document.getElementById('stk-uncountedList');
      if (uncountedEl) uncountedEl.innerHTML = uncountedHtml;

      // æ£šå¸ã®é€²æ—ã‚’æ›´æ–°
      if (_stk_activeCheck.progress !== progressAll) {
        _stk_Api.updateCheck(_stk_activeCheck.id, { progress: progressAll });
      }
    }

    // ============================================
    // Select slot / product
    // ============================================
    function stkSelectSlot(slotId) {
      _stk_currentSlot = _stk_allPurchaseSlots.find(function(s) { return s.id === slotId; });
      if (!_stk_currentSlot) return;

      var existingCount = _stk_checkItems[slotId];
      var bookQty = _stk_currentSlot.quantity || 1;
      var actualQty = existingCount ? (existingCount.actualQuantity !== undefined ? existingCount.actualQuantity : '') : '';

      // INV-010: SKUå•†å“åˆ¤å®š
      var isSku = _stk_currentSlot.itemType === 'sku-based';
      var typeIcon = isSku ? 'ğŸ“¦' : 'ğŸ‘•';
      var typeLabel = isSku ? 'SKUå•†å“ï¼ˆè¤‡æ•°åœ¨åº«ï¼‰' : '1ç‚¹ç‰©';

      // ã‚«ãƒ†ã‚´ãƒªè¡¨ç¤ºç”¨ã®æ–‡å­—åˆ—ã‚’ç”Ÿæˆ
      var categoryText = _stk_currentSlot.category
        ? (typeof _stk_currentSlot.category === 'object'
            ? (_stk_currentSlot.category.itemName || _stk_currentSlot.category.small || _stk_currentSlot.category.middle || _stk_currentSlot.category.major || '')
            : _stk_currentSlot.category)
        : '';

      // ç”»åƒURLï¼ˆå•†å“ç”»åƒã‚’å„ªå…ˆã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
      var imageUrl = (_stk_currentSlot.images && _stk_currentSlot.images[0]) ? _stk_currentSlot.images[0] : '/images/no-image.png';

      // INV-010: SKUå•†å“ã®å ´åˆã¯ãƒ’ãƒ³ãƒˆè¡¨ç¤º
      var skuHint = isSku ? '<div class="alert alert-info py-2 px-3 mb-2" style="font-size: 12px;">' +
        '<i class="bi bi-info-circle"></i> ã“ã®SKUå•†å“ã¯<strong>' + bookQty + 'ç‚¹</strong>ã®åœ¨åº«ãŒå¸³ç°¿ä¸Šã«ã‚ã‚Šã¾ã™ã€‚å®Ÿéš›ã«æ•°ãˆãŸæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>' : '';

      var countInputArea = document.getElementById('stk-countInputArea');
      if (!countInputArea) return;

      countInputArea.innerHTML =
        '<div class="stk-count-input-card">' +
          '<div class="stk-product-info">' +
            '<img src="' + imageUrl + '" class="stk-product-image" onerror="this.src=\'/images/no-image.png\'">' +
            '<div class="stk-product-details">' +
              '<div class="stk-product-name">' +
                typeIcon + ' ' + (_stk_currentSlot.productName || _stk_currentSlot.brand || '-') +
                ' <span class="badge" style="background: ' + (_stk_currentSlot.displayStatus ? _stk_currentSlot.displayStatus.color : '#6b7280') + '; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 6px;">' +
                  (_stk_currentSlot.displayStatus ? _stk_currentSlot.displayStatus.label : 'ä¸æ˜') +
                '</span>' +
              '</div>' +
              '<div class="stk-product-meta">' +
                '<span class="badge bg-' + (isSku ? 'primary' : 'secondary') + '" style="font-size: 10px;">' + typeLabel + '</span><br>' +
                'ç®¡ç†ç•ªå·: ' + (_stk_currentSlot.managementNumber || '-') + '<br>' +
                (_stk_currentSlot.skuId ? 'SKU ID: ' + _stk_currentSlot.skuId + '<br>' : '') +
                'ä»•å…¥ID: ' + (_stk_currentSlot.slotId || _stk_currentSlot.id) + '<br>' +
                (_stk_currentSlot.brand || '') + (categoryText ? ' / ' + categoryText : '') +
              '</div>' +
            '</div>' +
          '</div>' +
          skuHint +
          '<div class="stk-count-row">' +
            '<span class="stk-count-label">å¸³ç°¿åœ¨åº«:</span>' +
            '<span class="stk-count-value">' + bookQty + 'ç‚¹</span>' +
          '</div>' +
          '<div class="stk-count-row">' +
            '<span class="stk-count-label">å®Ÿåœ¨åº«:</span>' +
            '<input type="number" class="stk-count-input" id="stk-actualQtyInput" value="' + actualQty + '" min="0" placeholder="' + (isSku ? bookQty : '0') + '" autofocus>' +
            '<span class="stk-count-label">ç‚¹</span>' +
            '<span class="stk-diff-badge" id="stk-diffBadge" style="display: none;"></span>' +
          '</div>' +
          '<div class="mt-3">' +
            '<input type="text" class="form-control form-control-sm" id="stk-countNote" placeholder="å‚™è€ƒï¼ˆä»»æ„ï¼‰" value="' + (existingCount ? (existingCount.note || '') : '') + '">' +
          '</div>' +
          '<div class="mt-3 d-flex gap-2">' +
            '<button class="btn btn-outline-secondary flex-fill" onclick="stkClearCountInput()">' +
              'ã‚­ãƒ£ãƒ³ã‚»ãƒ«' +
            '</button>' +
            '<button class="btn btn-success flex-fill" onclick="stkSaveCount(\'' + slotId + '\')">' +
              '<i class="bi bi-check-lg"></i> ä¿å­˜' +
            '</button>' +
          '</div>' +
        '</div>';

      // å·®ç•°è¡¨ç¤ºæ›´æ–°
      var actualInput = document.getElementById('stk-actualQtyInput');
      if (actualInput) {
        actualInput.addEventListener('input', function() {
          stkUpdateDiffBadge(bookQty, this.value);
        });
        if (actualQty !== '') {
          stkUpdateDiffBadge(bookQty, actualQty);
        }
        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        setTimeout(function() { actualInput.focus(); }, 100);
      }
    }

    // å¾Œæ–¹äº’æ›: selectProductã¯selectSlotã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    function stkSelectProduct(productId) {
      var slot = _stk_allPurchaseSlots.find(function(s) { return s.productId === productId || s.id === productId; });
      if (slot) {
        stkSelectSlot(slot.id);
      }
    }

    function stkUpdateDiffBadge(bookQty, actualQty) {
      var badge = document.getElementById('stk-diffBadge');
      if (!badge) return;
      var actual = parseInt(actualQty) || 0;
      var diff = actual - bookQty;

      if (actualQty === '' || actualQty === null) {
        badge.style.display = 'none';
        return;
      }

      badge.style.display = 'inline-block';
      if (diff === 0) {
        badge.className = 'stk-diff-badge match';
        badge.textContent = 'ä¸€è‡´';
      } else if (diff > 0) {
        badge.className = 'stk-diff-badge over';
        badge.textContent = '+' + diff;
      } else {
        badge.className = 'stk-diff-badge under';
        badge.textContent = '' + diff;
      }
    }

    function stkClearCountInput() {
      var el = document.getElementById('stk-countInputArea');
      if (el) el.innerHTML = '';
      _stk_currentSlot = null;
    }

    // ============================================
    // Save count
    // ============================================
    async function stkSaveCount(slotId) {
      // æœŸé–“æ£šå¸ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ´åˆã¯æœŸé–“ç”¨ã®ä¿å­˜ã‚’ä½¿ç”¨
      if (_stk_activePeriod) {
        var handled = await stkSavePeriodCount(slotId);
        if (handled) return;
      }

      // é€šå¸¸ã®ä¿å­˜
      var actualQtyEl = document.getElementById('stk-actualQtyInput');
      var noteEl = document.getElementById('stk-countNote');
      var actualQty = parseInt(actualQtyEl ? actualQtyEl.value : '');
      var note = noteEl ? noteEl.value : '';

      if (isNaN(actualQty) || actualQty < 0) {
        alert('å®Ÿåœ¨åº«æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      var slot = _stk_allPurchaseSlots.find(function(s) { return s.id === slotId; });
      var bookQty = slot ? (slot.quantity || 1) : 1;
      var diff = actualQty - bookQty;

      stkShowLoading();
      try {
        await _stk_Api.saveCountItem(_stk_activeCheck.id, slotId, {
          slotId: slotId,
          productId: slot ? (slot.productId || '') : '',
          managementNumber: slot ? (slot.managementNumber || '') : '',
          productName: slot ? (slot.productName || '') : '',
          brand: slot ? (slot.brand || '') : '',
          bookQuantity: bookQty,
          actualQuantity: actualQty,
          diff: diff,
          note: note,
          purchaseAmount: slot ? (slot.purchaseAmount || 0) : 0,
          status: slot && slot.displayStatus ? (slot.displayStatus.class || 'unknown') : 'unknown',
          itemType: slot ? (slot.itemType || 'unique') : 'unique',
          skuId: slot ? (slot.skuId || null) : null
        });

        // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°
        _stk_checkItems[slotId] = {
          id: slotId,
          managementNumber: slot ? (slot.managementNumber || '') : '',
          productName: slot ? (slot.productName || '') : '',
          bookQuantity: bookQty,
          actualQuantity: actualQty,
          diff: diff,
          note: note,
          purchaseAmount: slot ? (slot.purchaseAmount || 0) : 0,
          itemType: slot ? (slot.itemType || 'unique') : 'unique',
          skuId: slot ? (slot.skuId || null) : null
        };

        stkClearCountInput();
        stkUpdateCountTab();
        stkUpdateDiffTab();

        // å…¨å®Œäº†ãƒã‚§ãƒƒã‚¯
        var targetSlots = _stk_allPurchaseSlots.filter(function(s) { return !s.displayStatus || s.displayStatus.class !== 'sold'; });
        if (Object.keys(_stk_checkItems).length >= targetSlots.length) {
          if (confirm('ã™ã¹ã¦ã®åœ¨åº«ã®ã‚«ã‚¦ãƒ³ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚å·®ç•°åˆ†æã‚¿ãƒ–ã‚’é–‹ãã¾ã™ã‹ï¼Ÿ')) {
            var btn = document.querySelector('#spa-page-stocktaking .stk-nav-link[data-stk-tab="stk-diff-tab"]');
            stkSwitchTab('stk-diff-tab', btn);
          }
        }
      } catch (error) {
        console.error('[Stk SPA] ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        stkHideLoading();
      }
    }

    // ============================================
    // Diff tab update
    // ============================================
    function stkUpdateDiffTab() {
      var items = Object.values(_stk_checkItems);
      if (items.length === 0) {
        var noDiffEl = document.getElementById('stk-noDiffData');
        if (noDiffEl) noDiffEl.style.display = 'block';
        var diffPanel = document.getElementById('stk-diffPanel');
        if (diffPanel) diffPanel.style.display = 'none';
        return;
      }

      var noDiffEl2 = document.getElementById('stk-noDiffData');
      if (noDiffEl2) noDiffEl2.style.display = 'none';
      var diffPanel2 = document.getElementById('stk-diffPanel');
      if (diffPanel2) diffPanel2.style.display = 'block';

      var total = items.length;
      var match = items.filter(function(i) { return i.diff === 0; }).length;
      var over = items.filter(function(i) { return i.diff > 0; }).length;
      var under = items.filter(function(i) { return i.diff < 0; }).length;

      var totalEl = document.getElementById('stk-diff-total');
      if (totalEl) totalEl.textContent = total;
      var matchEl = document.getElementById('stk-diff-match');
      if (matchEl) matchEl.textContent = match;
      var overEl = document.getElementById('stk-diff-over');
      if (overEl) overEl.textContent = over;
      var underEl = document.getElementById('stk-diff-under');
      if (underEl) underEl.textContent = under;

      // å·®ç•°é‡‘é¡è¨ˆç®—
      var overAmount = 0, underAmount = 0;
      items.forEach(function(item) {
        var amount = (item.purchaseAmount || 0) * Math.abs(item.diff);
        if (item.diff > 0) overAmount += amount;
        else if (item.diff < 0) underAmount += amount;
      });

      var overAmountEl = document.getElementById('stk-diff-over-amount');
      if (overAmountEl) overAmountEl.textContent = stkFormatCurrency(overAmount);
      var underAmountEl = document.getElementById('stk-diff-under-amount');
      if (underAmountEl) underAmountEl.textContent = stkFormatCurrency(underAmount);

      // å·®ç•°è©³ç´°ï¼ˆå·®ç•°ã‚ã‚Šã®ã¿ï¼‰
      var diffItems = items.filter(function(i) { return i.diff !== 0; }).sort(function(a, b) { return Math.abs(b.diff) - Math.abs(a.diff); });
      var diffHtml = diffItems.length > 0 ? diffItems.map(function(item) {
        var isSku = item.itemType === 'sku-based';
        var typeIcon = isSku ? 'ğŸ“¦' : 'ğŸ‘•';
        return '<div class="stk-diff-item">' +
          '<div class="stk-item-info">' +
            '<div class="stk-item-name">' + typeIcon + ' ' + (item.managementNumber || '-') + '</div>' +
            '<div class="stk-item-meta">' + (item.productName || '-') + (item.skuId ? ' (' + item.skuId + ')' : '') + '</div>' +
          '</div>' +
          '<div class="stk-diff-values">' +
            '<div>å¸³ç°¿: ' + item.bookQuantity + ' â†’ å®Ÿ: ' + item.actualQuantity + '</div>' +
            '<span class="stk-diff-badge ' + (item.diff > 0 ? 'over' : 'under') + '">' + (item.diff > 0 ? '+' : '') + item.diff + '</span>' +
          '</div>' +
        '</div>';
      }).join('') : '<div class="text-center text-muted py-3">å·®ç•°ãªã—ï¼ˆã™ã¹ã¦ä¸€è‡´ï¼‰</div>';

      var diffDetailEl = document.getElementById('stk-diffDetailList');
      if (diffDetailEl) diffDetailEl.innerHTML = diffHtml;
    }

    // ============================================
    // QR Scanner
    // ============================================
    function stkStartScanner() {
      var overlay = document.getElementById('stk-scanOverlay');
      if (overlay) overlay.classList.add('active');

      if (typeof Html5Qrcode === 'undefined') {
        alert('QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        stkStopScanner();
        return;
      }

      _stk_html5QrCode = new Html5Qrcode("stk-qr-reader");
      _stk_html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        stkOnScanSuccess,
        stkOnScanFailure
      ).catch(function(err) {
        console.error('[Stk SPA] ã‚¹ã‚­ãƒ£ãƒŠãƒ¼èµ·å‹•ã‚¨ãƒ©ãƒ¼:', err);
        alert('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
        stkStopScanner();
      });
    }

    function stkStopScanner() {
      var overlay = document.getElementById('stk-scanOverlay');
      if (overlay) overlay.classList.remove('active');
      if (_stk_html5QrCode) {
        _stk_html5QrCode.stop().catch(function(err) { console.log('[Stk SPA] ã‚¹ã‚­ãƒ£ãƒŠãƒ¼åœæ­¢:', err); });
        _stk_html5QrCode = null;
      }
    }

    function stkOnScanSuccess(decodedText) {
      console.log('[Stk SPA] QRã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸ:', decodedText);
      stkStopScanner();

      var slot = null;
      var searchKey = decodedText;

      // 1. URLå½¢å¼ï¼ˆä»•å…¥QR: https://furira.jp/scan?inv=BATCH-XXXXï¼‰
      if (decodedText.includes('furira.jp/scan') || decodedText.includes('inv=')) {
        try {
          var url = new URL(decodedText);
          var invId = url.searchParams.get('inv');
          if (invId) {
            console.log('[Stk SPA] ä»•å…¥QRæ¤œå‡ºã€purchaseSlotsã§æ¤œç´¢:', invId);
            searchKey = invId;
            slot = _stk_allPurchaseSlots.find(function(s) { return s.id === invId || s.slotId === invId; });
          }
        } catch (e) {
          console.log('[Stk SPA] URLè§£æå¤±æ•—ã€ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å‡¦ç†');
        }
      }

      // 2. JSONå½¢å¼ï¼ˆå•†å“QR: {"type":"product","managementNumber":"XX-XXXX"}ï¼‰
      if (!slot) {
        try {
          var qrData = JSON.parse(decodedText);
          if (qrData.managementNumber) {
            searchKey = qrData.managementNumber;
            slot = _stk_allPurchaseSlots.find(function(s) { return s.managementNumber === qrData.managementNumber; });
          }
        } catch (e) {
          // JSONä»¥å¤–
        }
      }

      // 3. ç›´æ¥ãƒ†ã‚­ã‚¹ãƒˆï¼ˆç®¡ç†ç•ªå·ã€slotIdã€IDï¼‰
      if (!slot) {
        slot = _stk_allPurchaseSlots.find(function(s) {
          return s.managementNumber === searchKey ||
            s.slotId === searchKey ||
            s.id === searchKey ||
            s.productId === searchKey;
        });
      }

      if (slot) {
        stkSelectSlot(slot.id);
      } else {
        alert('åœ¨åº«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ' + searchKey);
      }
    }

    function stkOnScanFailure(error) {
      // ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—ã¯ç„¡è¦–ï¼ˆç¶™ç¶šã‚¹ã‚­ãƒ£ãƒ³ï¼‰
    }

    // ============================================
    // Search product
    // ============================================
    function stkSearchProduct() {
      var searchEl = document.getElementById('stk-searchInput');
      var queryText = searchEl ? searchEl.value.trim() : '';
      if (!queryText) return;

      var slot = _stk_allPurchaseSlots.find(function(s) {
        return (s.managementNumber && s.managementNumber.toLowerCase().includes(queryText.toLowerCase())) ||
          (s.productName && s.productName.toLowerCase().includes(queryText.toLowerCase())) ||
          (s.slotId && s.slotId.toLowerCase().includes(queryText.toLowerCase())) ||
          (s.brand && s.brand.toLowerCase().includes(queryText.toLowerCase()));
      });

      if (slot) {
        stkSelectSlot(slot.id);
        if (searchEl) searchEl.value = '';
      } else {
        alert('åœ¨åº«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }
    }

    // ============================================
    // New check modal
    // ============================================
    function stkOpenNewCheckModal() {
      var modal = document.getElementById('stk-newCheckModal');
      if (modal) modal.classList.add('active');
    }

    function stkCloseNewCheckModal() {
      var modal = document.getElementById('stk-newCheckModal');
      if (modal) modal.classList.remove('active');
    }

    async function stkCreateNewCheck() {
      var nameEl = document.getElementById('stk-checkName');
      var name = nameEl ? nameEl.value.trim() : '';
      var checkDateEl = document.getElementById('stk-checkDate');
      var checkDate = checkDateEl ? checkDateEl.value : '';

      if (!name) {
        alert('æ£šå¸åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      stkShowLoading();
      try {
        var methodEl = document.getElementById('stk-countMethod');
        var targetEl = document.getElementById('stk-targetProducts');

        var checkId = await _stk_Api.createCheck({
          name: name,
          checkDate: checkDate,
          method: methodEl ? methodEl.value : 'all',
          targetProducts: targetEl ? targetEl.checked : true
        });

        stkCloseNewCheckModal();

        // ãƒªãƒ­ãƒ¼ãƒ‰
        await stkLoadData();
        await stkSelectCheck(checkId);

        alert('æ£šå¸ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
      } catch (error) {
        console.error('[Stk SPA] ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
        alert('æ£šå¸ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        stkHideLoading();
      }
    }

    // ============================================
    // Apply adjustment
    // ============================================
    async function stkApplyAdjustment() {
      if (!_stk_activeCheck) return;

      var diffItems = Object.values(_stk_checkItems).filter(function(i) { return i.diff !== 0; });
      if (diffItems.length === 0) {
        alert('èª¿æ•´ãŒå¿…è¦ãªå·®ç•°ã¯ã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      if (!confirm(diffItems.length + 'ä»¶ã®åœ¨åº«ã‚’èª¿æ•´ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
        return;
      }

      stkShowLoading();
      try {
        // å„å•†å“ã®åœ¨åº«æ•°ã‚’æ›´æ–°
        for (var i = 0; i < diffItems.length; i++) {
          var item = diffItems[i];
          await _stk_Api.updateProductQuantity(
            item.productId || item.id,
            item.actualQuantity,
            { itemType: item.itemType, skuId: item.skuId }
          );
        }

        // æ£šå¸ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å®Œäº†ã«
        await _stk_Api.updateCheck(_stk_activeCheck.id, {
          status: 'adjusted',
          completedAt: new Date(),
          diffCount: diffItems.length
        });

        alert('åœ¨åº«èª¿æ•´ãŒå®Œäº†ã—ã¾ã—ãŸ');

        // ãƒªãƒ­ãƒ¼ãƒ‰
        await stkLoadData();
      } catch (error) {
        console.error('[Stk SPA] èª¿æ•´ã‚¨ãƒ©ãƒ¼:', error);
        alert('åœ¨åº«èª¿æ•´ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        stkHideLoading();
      }
    }

    // ============================================
    // Export report
    // ============================================
    function stkExportDiffReport() {
      var items = Object.values(_stk_checkItems);
      var bom = '\uFEFF';
      var csv = 'æ£šå¸ãƒ¬ãƒãƒ¼ãƒˆ - ' + (_stk_activeCheck ? (_stk_activeCheck.name || 'æ£šå¸') : 'æ£šå¸') + '\n';
      csv += 'å®Ÿæ–½æ—¥: ' + (_stk_activeCheck ? (_stk_activeCheck.checkDate || '-') : '-') + '\n\n';
      csv += 'ç®¡ç†ç•ªå·,å•†å“å,å¸³ç°¿åœ¨åº«,å®Ÿåœ¨åº«,å·®ç•°,å‚™è€ƒ\n';

      items.forEach(function(item) {
        csv += [
          item.managementNumber || '',
          '"' + (item.productName || '').replace(/"/g, '""') + '"',
          item.bookQuantity,
          item.actualQuantity,
          item.diff,
          '"' + (item.note || '').replace(/"/g, '""') + '"'
        ].join(',') + '\n';
      });

      var blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
      var link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'æ£šå¸ãƒ¬ãƒãƒ¼ãƒˆ_' + (_stk_activeCheck ? (_stk_activeCheck.checkDate || 'report') : 'report') + '.csv';
      link.click();
    }

    function stkViewCheckReport(checkId) {
      alert('ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤ºæ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™');
    }

    // ============================================
    // Period-based stocktaking
    // ============================================
    async function stkInitializePeriodStocktaking() {
      console.log('[Stk SPA æœŸé–“æ£šå¸] åˆæœŸåŒ–é–‹å§‹...');

      // localStorage ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
      var userName = localStorage.getItem('reborn_user_name');
      var userEmail = localStorage.getItem('reborn_user_email');

      if (!userName) {
        console.log('[Stk SPA æœŸé–“æ£šå¸] ãƒ¦ãƒ¼ã‚¶ãƒ¼åæœªå–å¾—');
        return;
      }

      _stk_currentUserName = userName;
      console.log('[Stk SPA æœŸé–“æ£šå¸] ãƒ¦ãƒ¼ã‚¶ãƒ¼å:', _stk_currentUserName);

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
      if (userEmail) {
        _stk_currentUserEmail = userEmail;
      } else {
        // compatç‰ˆdbã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
        try {
          var db = window.db;
          if (db && typeof db.collection === 'function') {
            var usersSnapshot = await db.collection('users').where('userName', '==', _stk_currentUserName).get();
            if (!usersSnapshot.empty) {
              var userData = usersSnapshot.docs[0].data();
              _stk_currentUserEmail = usersSnapshot.docs[0].id || userData.email;
              console.log('[Stk SPA æœŸé–“æ£šå¸] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«:', _stk_currentUserEmail);
            } else {
              _stk_currentUserEmail = _stk_currentUserName;
            }
          } else {
            _stk_currentUserEmail = _stk_currentUserName;
          }
        } catch (e) {
          console.log('[Stk SPA æœŸé–“æ£šå¸] ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
          _stk_currentUserEmail = _stk_currentUserName;
        }
      }

      // StocktakingPeriodAPIãŒæº–å‚™ã§ãã‚‹ã¾ã§å¾…æ©Ÿ
      var waitCount = 0;
      while (!window.StocktakingPeriodAPI && waitCount < 50) {
        await new Promise(function(r) { setTimeout(r, 100); });
        waitCount++;
      }

      if (!window.StocktakingPeriodAPI) {
        console.log('[Stk SPA æœŸé–“æ£šå¸] StocktakingPeriodAPIæœªèª­ã¿è¾¼ã¿');
        return;
      }

      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæœŸé–“ã‚’å–å¾—
      try {
        _stk_activePeriod = await StocktakingPeriodAPI.getActiveStocktakingPeriod();

        if (_stk_activePeriod) {
          console.log('[Stk SPA æœŸé–“æ£šå¸] ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æœŸé–“ã‚ã‚Š:', _stk_activePeriod.name);
          await stkLoadPeriodStocktakingData();
          stkShowPeriodBanner();
        } else {
          console.log('[Stk SPA æœŸé–“æ£šå¸] ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æœŸé–“ãªã—');
          stkHidePeriodBanner();
        }
      } catch (error) {
        console.error('[Stk SPA æœŸé–“æ£šå¸] åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    async function stkLoadPeriodStocktakingData() {
      if (!_stk_activePeriod || !_stk_currentUserEmail) return;

      try {
        // è‡ªåˆ†ã®ãƒã‚§ãƒƒã‚¯çµæœã‚’å–å¾—
        var results = await StocktakingPeriodAPI.getCheckResults(_stk_activePeriod.id, _stk_currentUserEmail);
        _stk_periodCheckItems = {};
        results.forEach(function(r) {
          _stk_periodCheckItems[r.slotId] = r;
        });

        // è‡ªåˆ†ã®é€²æ—ã‚’å–å¾—
        var progress = await StocktakingPeriodAPI.getStaffProgress(_stk_activePeriod.id, _stk_currentUserEmail);

        // ãƒãƒŠãƒ¼ã‚’æ›´æ–°
        if (progress) {
          stkUpdatePeriodBannerProgress(progress);
        }

        console.log('[Stk SPA æœŸé–“æ£šå¸] ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', Object.keys(_stk_periodCheckItems).length, 'ä»¶ãƒã‚§ãƒƒã‚¯æ¸ˆã¿');
      } catch (error) {
        console.error('[Stk SPA æœŸé–“æ£šå¸] ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    function stkShowPeriodBanner() {
      var banner = document.getElementById('stk-periodBanner');
      if (!banner || !_stk_activePeriod) return;

      banner.style.display = 'block';
      var nameEl = document.getElementById('stk-periodBannerName');
      if (nameEl) nameEl.textContent = _stk_activePeriod.name;

      var periodRange = StocktakingPeriodAPI.formatPeriodRange(_stk_activePeriod.startDate, _stk_activePeriod.endDate);
      var remainingDays = StocktakingPeriodAPI.getRemainingDays(_stk_activePeriod);
      var infoEl = document.getElementById('stk-periodBannerInfo');
      if (infoEl) {
        infoEl.textContent = 'æœŸé–“: ' + periodRange + ' | æ®‹ã‚Š: ' + (remainingDays > 0 ? remainingDays + 'æ—¥' : 'çµ‚äº†');
      }
    }

    function stkHidePeriodBanner() {
      var banner = document.getElementById('stk-periodBanner');
      if (banner) banner.style.display = 'none';
    }

    function stkUpdatePeriodBannerProgress(progress) {
      var percent = StocktakingPeriodAPI.calculateProgress(
        progress.checkedProducts || 0,
        progress.totalProducts || 0
      );

      var progressEl = document.getElementById('stk-periodBannerProgress');
      if (progressEl) {
        progressEl.innerHTML =
          '<div style="font-size: 1.5rem; font-weight: 700;">' + percent + '%</div>' +
          '<div style="font-size: 0.75rem; opacity: 0.9;">' + (progress.checkedProducts || 0) + '/' + (progress.totalProducts || 0) + 'ä»¶</div>';
      }
      var barEl = document.getElementById('stk-periodProgressBar');
      if (barEl) barEl.style.width = percent + '%';
    }

    async function stkSavePeriodCount(slotId) {
      if (!_stk_activePeriod) {
        return false;
      }

      var actualQtyEl = document.getElementById('stk-actualQtyInput');
      var noteEl = document.getElementById('stk-countNote');
      var actualQty = parseInt(actualQtyEl ? actualQtyEl.value : '');
      var note = noteEl ? noteEl.value : '';

      if (isNaN(actualQty) || actualQty < 0) {
        alert('å®Ÿåœ¨åº«æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return true; // å‡¦ç†æ¸ˆã¿
      }

      var slot = _stk_allPurchaseSlots.find(function(s) { return s.id === slotId; });
      var bookQty = slot ? (slot.quantity || 1) : 1;

      stkShowLoading();
      try {
        await StocktakingPeriodAPI.saveCheckResult(_stk_activePeriod.id, {
          slotId: slotId,
          productId: slot ? (slot.productId || '') : '',
          managementNumber: slot ? (slot.managementNumber || '') : '',
          productName: slot ? (slot.productName || '') : '',
          staffName: _stk_currentUserName || _stk_currentUserEmail,
          bookQuantity: bookQty,
          actualQuantity: actualQty,
          note: note
        });

        // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°
        _stk_periodCheckItems[slotId] = {
          slotId: slotId,
          bookQuantity: bookQty,
          actualQuantity: actualQty,
          difference: actualQty - bookQty
        };

        stkClearCountInput();

        // é€²æ—ã‚’å†èª­ã¿è¾¼ã¿
        await stkLoadPeriodStocktakingData();
        stkUpdateCountTab();

        // å®Œäº†ãƒã‚§ãƒƒã‚¯
        var progress = await StocktakingPeriodAPI.getStaffProgress(_stk_activePeriod.id, _stk_currentUserEmail);
        if (progress && progress.status === 'completed') {
          alert('å…¨å•†å“ã®ãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        }

      } catch (error) {
        console.error('[Stk SPA æœŸé–“æ£šå¸] ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        stkHideLoading();
      }

      return true; // å‡¦ç†æ¸ˆã¿
    }

    function stkGetMyAssignedSlots() {
      if (!_stk_currentUserEmail && !_stk_currentUserName) {
        return _stk_allPurchaseSlots;
      }

      return _stk_allPurchaseSlots.filter(function(slot) {
        var personEmail = slot.personEmail || '';
        var person = slot.person || '';

        return personEmail === _stk_currentUserEmail ||
               person === _stk_currentUserEmail ||
               person === _stk_currentUserName;
      });
    }

    function stkIsPeriodChecked(slotId) {
      return !!_stk_periodCheckItems[slotId];
    }

    // ============================================
    // Dynamic script loading helper
    // ============================================
    function _stkLoadScript(src) {
      return new Promise(function(resolve, reject) {
        // Check if already loaded
        var existing = document.querySelector('script[src="' + src + '"]');
        if (existing) {
          resolve();
          return;
        }
        var script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    // ============================================
    // SPA Lifecycle
    // ============================================
    function initStocktakingPage() {
      console.log('[Stk SPA] initStocktakingPage called');

      // Load external scripts dynamically
      var loadPromises = [];

      // Load html5-qrcode if not already loaded
      if (typeof Html5Qrcode === 'undefined') {
        loadPromises.push(_stkLoadScript('https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js'));
      }

      // Load stocktaking-period-api.js if not already loaded
      if (!window.StocktakingPeriodAPI) {
        loadPromises.push(_stkLoadScript('/js/stocktaking-period-api.js?v=3'));
      }

      // Set up event listeners
      _stk_dropdownClickHandler = function(event) {
        var dropdown = document.getElementById('stk-settingsDropdown');
        if (dropdown && !event.target.closest('.stk-settings-dropdown') && !event.target.closest('.stk-sub-header-icon')) {
          dropdown.classList.remove('active');
        }
      };
      document.addEventListener('click', _stk_dropdownClickHandler);

      // Enter key for search
      var searchInput = document.getElementById('stk-searchInput');
      if (searchInput) {
        _stk_searchKeyHandler = function(e) {
          if (e.key === 'Enter') stkSearchProduct();
        };
        searchInput.addEventListener('keypress', _stk_searchKeyHandler);
      }

      // Wait for scripts to load, then initialize page
      Promise.all(loadPromises).then(function() {
        console.log('[Stk SPA] External scripts loaded');
        stkInitializePage();
      }).catch(function(err) {
        console.error('[Stk SPA] Script loading error:', err);
        // Initialize anyway (QR scanner may not work)
        stkInitializePage();
      });
    }

    function destroyStocktakingPage() {
      console.log('[Stk SPA] destroyStocktakingPage called');

      // CRITICAL: Stop QR scanner if running
      if (_stk_html5QrCode) {
        try {
          _stk_html5QrCode.stop().catch(function(err) { console.log('[Stk SPA] Scanner stop on destroy:', err); });
        } catch (e) {
          console.log('[Stk SPA] Scanner stop error:', e);
        }
        _stk_html5QrCode = null;
      }

      // Close scan overlay
      var overlay = document.getElementById('stk-scanOverlay');
      if (overlay) overlay.classList.remove('active');

      // Remove event listeners
      if (_stk_dropdownClickHandler) {
        document.removeEventListener('click', _stk_dropdownClickHandler);
        _stk_dropdownClickHandler = null;
      }

      var searchInput = document.getElementById('stk-searchInput');
      if (searchInput && _stk_searchKeyHandler) {
        searchInput.removeEventListener('keypress', _stk_searchKeyHandler);
        _stk_searchKeyHandler = null;
      }

      // Reset state
      _stk_allPurchaseSlots = [];
      _stk_allProducts = [];
      _stk_allChecks = [];
      _stk_activeCheck = null;
      _stk_checkItems = {};
      _stk_currentSlot = null;
      _stk_currentItemFilter = 'all';
      _stk_activePeriod = null;
      _stk_currentUserEmail = null;
      _stk_currentUserName = null;
      _stk_periodCheckItems = {};
      _stk_myStocktakingProducts = [];
    }
  </script>
</div>
