<!-- SPA Fragment: inventory.html -->
<!-- Prefix: inv- -->
<div id="spa-page-inventory">
  <style>
    #spa-page-inventory {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    #spa-page-inventory .inv-content-container {
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }
    #spa-page-inventory .inv-dashboard-card {
      margin-bottom: 16px;
    }
    #spa-page-inventory .inv-dashboard-card .card {
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    #spa-page-inventory .inv-dashboard-card .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    #spa-page-inventory .inv-dashboard-card .card:active {
      transform: translateY(0);
    }
    #spa-page-inventory .inv-status-badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
    #spa-page-inventory .inv-product-card {
      margin-bottom: 12px;
      transition: transform 0.2s;
    }
    #spa-page-inventory .inv-product-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    #spa-page-inventory .inv-product-image {
      width: 100%;
      height: 170px;
      object-fit: contain;
      background-color: white;
      border-radius: 8px 8px 0 0;
      border-bottom: 1px solid #e9ecef;
    }
    @media (min-width: 768px) {
      #spa-page-inventory .inv-product-image {
        aspect-ratio: 1 / 1;
        height: auto;
        object-fit: cover;
      }
    }
    #spa-page-inventory .inv-filter-section {
      background: white;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    #spa-page-inventory .inv-pagination-container {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      padding-bottom: 24px;
    }
    #spa-page-inventory .form-control::placeholder {
      color: #adb5bd;
      opacity: 1;
    }
    #spa-page-inventory .inv-btn-clear-search {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      color: #6c757d;
      padding: 0.25rem;
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #spa-page-inventory .inv-btn-clear-search:hover {
      color: #dc3545;
    }
    #spa-page-inventory .inv-filter-subsection {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }
    #spa-page-inventory .inv-filter-subsection-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    #spa-page-inventory .inv-filter-subsection-title i {
      color: #6b7280;
    }
    #spa-page-inventory .inv-filter-subsection.inv-search-section {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
    }
    #spa-page-inventory .inv-search-group {
      padding-bottom: 12px;
      border-bottom: 1px solid #e0f2fe;
    }
    #spa-page-inventory .inv-search-group:last-of-type {
      border-bottom: none;
      padding-bottom: 0;
    }
    #spa-page-inventory .inv-search-group-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: #0369a1;
      margin-bottom: 8px;
    }
    #spa-page-inventory .inv-search-group-title i {
      color: #0ea5e9;
    }
    #spa-page-inventory .inv-search-section .accordion-button {
      background: #fff;
      border: 1px solid #dee2e6;
      font-size: 0.85rem;
      padding: 8px 12px;
      color: #495057;
    }
    #spa-page-inventory .inv-search-section .accordion-button:not(.collapsed) {
      background: #f8f9fa;
      color: #212529;
      border-color: #dee2e6;
    }
    #spa-page-inventory .inv-search-section .accordion-button:focus {
      box-shadow: none;
      border-color: #86b7fe;
    }
    #spa-page-inventory .inv-search-section .accordion-body {
      padding: 12px;
      background: #fff;
      border: 1px solid #dee2e6;
      border-top: none;
      border-radius: 0 0 6px 6px;
    }
    #spa-page-inventory .inv-filter-brand-suggest {
      position: relative;
    }
    #spa-page-inventory .inv-filter-brand-suggest-list {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #dee2e6;
      border-top: none;
      border-radius: 0 0 6px 6px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    #spa-page-inventory .inv-filter-brand-suggest-list .inv-suggest-item {
      padding: 8px 12px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    #spa-page-inventory .inv-filter-brand-suggest-list .inv-suggest-item:hover {
      background: #f0f9ff;
    }
    #spa-page-inventory .inv-custom-pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      flex-wrap: nowrap;
    }
    #spa-page-inventory .inv-custom-pagination .inv-page-btn {
      min-width: 36px;
      height: 36px;
      padding: 0 8px;
      border: 1px solid #dee2e6;
      background: #fff;
      border-radius: 6px;
      font-size: 13px;
      color: #0d6efd;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      white-space: nowrap;
    }
    #spa-page-inventory .inv-custom-pagination .inv-page-btn:hover {
      background: #e9ecef;
    }
    #spa-page-inventory .inv-custom-pagination .inv-page-btn.active {
      background: #0d6efd;
      color: #fff;
      border-color: #0d6efd;
      font-weight: bold;
    }
    #spa-page-inventory .inv-custom-pagination .inv-page-btn.disabled {
      color: #6c757d;
      pointer-events: none;
      background: #f8f9fa;
    }
    #spa-page-inventory .inv-custom-pagination .inv-page-dots {
      padding: 0 0.25rem;
      color: #6c757d;
    }
    #spa-page-inventory .inv-loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #spa-page-inventory .inv-loading-overlay .spinner-border {
      width: 3rem;
      height: 3rem;
    }
    #spa-page-inventory input[type="text"],
    #spa-page-inventory input[type="email"],
    #spa-page-inventory input[type="number"] {
      font-size: 16px !important;
    }
    /* Modal横スクロール防止 */
    #spa-page-inventory .inv-modal-body-detail {
      overflow-x: hidden;
      word-break: break-word;
    }
    #spa-page-inventory .inv-modal-body-detail .form-control-plaintext {
      word-break: break-word;
      overflow-wrap: break-word;
    }
    /* ライトボックス */
    #spa-page-inventory .inv-lightbox-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #spa-page-inventory .inv-lightbox-content {
      position: relative;
      max-width: 95%;
      max-height: 95%;
    }
    #spa-page-inventory .inv-lightbox-content img {
      max-width: 100%;
      max-height: 90vh;
      object-fit: contain;
      border-radius: 4px;
    }
    #spa-page-inventory .inv-lightbox-close {
      position: absolute;
      top: -55px;
      right: 0;
      color: #fff;
      font-size: 36px;
      font-weight: bold;
      cursor: pointer;
      padding: 5px 15px;
    }
    #spa-page-inventory .inv-lightbox-close:hover {
      color: #ccc;
    }
    #spa-page-inventory .inv-lightbox-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      color: #fff;
      font-size: 48px;
      cursor: pointer;
      padding: 20px;
      user-select: none;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    #spa-page-inventory .inv-lightbox-nav:hover {
      opacity: 1;
    }
    #spa-page-inventory .inv-lightbox-prev {
      left: 10px;
    }
    #spa-page-inventory .inv-lightbox-next {
      right: 10px;
    }
    #spa-page-inventory .inv-lightbox-counter {
      position: absolute;
      bottom: -35px;
      left: 50%;
      transform: translateX(-50%);
      color: #fff;
      font-size: 14px;
    }
    /* スケルトンローダー */
    @keyframes inv-skeleton-pulse {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    #spa-page-inventory .inv-image-wrapper {
      position: relative;
      display: inline-block;
      background: #f0f0f0;
      border-radius: 8px;
      overflow: hidden;
    }
    #spa-page-inventory .inv-image-wrapper.loading {
      min-width: 60px;
      min-height: 60px;
    }
    #spa-page-inventory .inv-image-wrapper.loading::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(90deg, #e0e0e0 25%, #f5f5f5 50%, #e0e0e0 75%);
      background-size: 200% 100%;
      animation: inv-skeleton-pulse 1.5s ease-in-out infinite;
      z-index: 1;
    }
    #spa-page-inventory .inv-image-wrapper img {
      display: block;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    #spa-page-inventory .inv-image-wrapper img.loaded {
      opacity: 1;
    }
    #spa-page-inventory .inv-product-card .inv-image-wrapper {
      width: 100%;
      height: 150px;
      border-radius: 0;
      background: #f5f5f5;
    }
    #spa-page-inventory .inv-product-card .inv-image-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    #spa-page-inventory .inv-image-wrapper.no-image::before {
      content: '画像なし';
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      color: #999;
      font-size: 12px;
      z-index: 2;
    }
    #spa-page-inventory .inv-image-wrapper.no-image {
      background: #e9ecef !important;
    }
    #spa-page-inventory .inv-image-wrapper.no-image::after {
      display: none !important;
      animation: none !important;
    }
    #spa-page-inventory .inv-thumb-wrapper {
      position: relative;
      overflow: hidden;
    }
    #spa-page-inventory .inv-thumb-wrapper.loading::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(90deg, #e0e0e0 25%, #f5f5f5 50%, #e0e0e0 75%);
      background-size: 200% 100%;
      animation: inv-skeleton-pulse 1.5s ease-in-out infinite;
      z-index: 1;
    }
    #spa-page-inventory .inv-thumb-wrapper img {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    #spa-page-inventory .inv-thumb-wrapper img.loaded {
      opacity: 1;
    }
    /* 詳細モーダルラベル */
    #spa-page-inventory .inv-detail-label {
      background: #f3f4f6;
      padding: 4px 8px 4px 10px;
      border-left: 3px solid #40B4E5;
      border-radius: 0 4px 4px 0;
      margin-bottom: 4px;
      display: block;
      color: #374151;
    }
    #spa-page-inventory .inv-detail-value {
      padding: 6px 8px;
      background: #ffffff;
      border-radius: 4px;
      border: 1px solid #e5e7eb;
      min-height: 32px;
    }
    #spa-page-inventory .inv-section-title {
      background: linear-gradient(90deg, #40B4E5 0%, transparent 100%);
      background-size: 100% 2px;
      background-position: bottom;
      background-repeat: no-repeat;
      padding-bottom: 8px;
      color: #1f2937;
      font-weight: 600;
    }
    /* 滞留状況バー */
    #spa-page-inventory .inv-aging-section {
      background: #fff;
      border-radius: 8px;
      padding: 12px;
      border: 1px solid #e5e7eb;
    }
    #spa-page-inventory .inv-aging-header {
      margin-bottom: 10px;
    }
    #spa-page-inventory .inv-aging-title {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }
    #spa-page-inventory .inv-aging-title i {
      margin-right: 6px;
      color: #6b7280;
    }
    #spa-page-inventory .inv-aging-bars {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #spa-page-inventory .inv-aging-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #spa-page-inventory .inv-aging-label {
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 80px;
      font-size: 12px;
      color: #6b7280;
    }
    #spa-page-inventory .inv-aging-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    #spa-page-inventory .inv-aging-dot.green { background: #10b981; }
    #spa-page-inventory .inv-aging-dot.yellow { background: #f59e0b; }
    #spa-page-inventory .inv-aging-dot.orange { background: #f97316; }
    #spa-page-inventory .inv-aging-dot.red { background: #ef4444; }
    #spa-page-inventory .inv-aging-bar-container {
      flex: 1;
      height: 16px;
      background: #f3f4f6;
      border-radius: 4px;
      overflow: hidden;
    }
    #spa-page-inventory .inv-aging-bar {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    #spa-page-inventory .inv-aging-bar.green { background: linear-gradient(90deg, #10b981, #34d399); }
    #spa-page-inventory .inv-aging-bar.yellow { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
    #spa-page-inventory .inv-aging-bar.orange { background: linear-gradient(90deg, #f97316, #fb923c); }
    #spa-page-inventory .inv-aging-bar.red { background: linear-gradient(90deg, #ef4444, #f87171); }
    #spa-page-inventory .inv-aging-count {
      min-width: 40px;
      text-align: right;
      font-size: 12px;
      font-weight: 600;
      color: #374151;
    }
    #spa-page-inventory .inv-aging-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 600;
      margin-left: 4px;
    }
    #spa-page-inventory .inv-aging-badge.green { background: #d1fae5; color: #065f46; }
    #spa-page-inventory .inv-aging-badge.yellow { background: #fef3c7; color: #92400e; }
    #spa-page-inventory .inv-aging-badge.orange { background: #ffedd5; color: #9a3412; }
    #spa-page-inventory .inv-aging-badge.red { background: #fee2e2; color: #991b1b; }
    /* Settings dropdown */
    #spa-page-inventory .inv-sub-header {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 56px;
      padding: 0 16px;
      background: #ffffff;
      border-bottom: 1px solid #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    #spa-page-inventory .inv-sub-header-back {
      position: absolute;
      left: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: transparent;
      border: none;
      color: #374151;
      font-size: 20px;
      cursor: pointer;
    }
    #spa-page-inventory .inv-sub-header-back:hover { background: #f3f4f6; }
    #spa-page-inventory .inv-sub-header-back:active { background: #e5e7eb; }
    #spa-page-inventory .inv-sub-header-title {
      font-size: 17px;
      font-weight: 600;
      color: #111827;
    }
    #spa-page-inventory .inv-sub-header-icons {
      position: absolute;
      right: 8px;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    #spa-page-inventory .inv-sub-header-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: transparent;
      border: none;
      color: #374151;
      font-size: 20px;
      cursor: pointer;
    }
    #spa-page-inventory .inv-sub-header-icon:hover { background: #f3f4f6; }
    #spa-page-inventory .inv-sub-header-icon:active { background: #e5e7eb; color: #6b7280; }
    #spa-page-inventory .inv-settings-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 180px;
      padding: 8px 0;
      display: none;
      z-index: 1001;
    }
    #spa-page-inventory .inv-settings-dropdown.show { display: block; }
    #spa-page-inventory .inv-settings-dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border: none;
      background: none;
      width: 100%;
      font-size: 14px;
      color: #374151;
      cursor: pointer;
      text-align: left;
    }
    #spa-page-inventory .inv-settings-dropdown-item:hover { background: #f3f4f6; }
    #spa-page-inventory .inv-settings-dropdown-item i { font-size: 18px; color: #6b7280; width: 20px; text-align: center; }
    #spa-page-inventory .inv-settings-dropdown-divider { height: 1px; background: #e5e7eb; margin: 4px 0; }
  </style>

  <!-- Sub Header -->
  <div class="inv-sub-header">
    <button class="inv-sub-header-back" onclick="invSmartBack()" title="戻る">
      <i class="bi bi-chevron-left"></i>
    </button>
    <span class="inv-sub-header-title">在庫管理</span>
    <div class="inv-sub-header-icons">
      <button class="inv-sub-header-icon" onclick="if(window.spaNavigate)spaNavigate('chat_rooms_list')" title="お知らせ">
        <i class="bi bi-bell"></i>
      </button>
      <div style="position: relative;">
        <button class="inv-sub-header-icon" onclick="invToggleSettingsDropdown(event)" title="メニュー">
          <i class="bi bi-list"></i>
        </button>
        <div class="inv-settings-dropdown" id="invSettingsDropdown">
          <button class="inv-settings-dropdown-item" onclick="if(window.spaNavigate)spaNavigate('config')">
            <i class="bi bi-gear-wide-connected"></i>
            <span>システム設定</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="inv-loading-overlay" id="invLoadingOverlay">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- 商品詳細モーダル -->
  <div class="modal fade" id="invProductDetailModal" tabindex="-1" aria-labelledby="invProductDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="invProductDetailModalLabel">商品詳細</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body inv-modal-body-detail" id="invProductDetailBody">
        </div>
        <div class="modal-footer" style="display: flex; gap: 8px; padding: 12px 16px;">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="flex: 1;">閉じる</button>
          <button type="button" class="btn btn-primary" id="invBtnSaveProductStatus" style="flex: 1;">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 在庫編集モーダル -->
  <div class="modal fade" id="invStockEditModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title">在庫数編集</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="invStockEditManagementNumber">
          <div class="mb-3">
            <label class="form-label">管理番号</label>
            <div id="invStockEditProductInfo" class="form-control-plaintext fw-bold"></div>
          </div>
          <div class="mb-3">
            <label class="form-label" for="invStockEditQuantity">在庫数</label>
            <div class="input-group">
              <button class="btn btn-outline-secondary" type="button" onclick="invAdjustStock(-1)">-</button>
              <input type="number" class="form-control text-center" id="invStockEditQuantity" min="0" value="1">
              <button class="btn btn-outline-secondary" type="button" onclick="invAdjustStock(1)">+</button>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-info" onclick="invSaveStockQuantity()">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 販売記録モーダル -->
  <div class="modal fade" id="invSalesRecordModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">販売記録</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- 基本情報 -->
          <div class="mb-4 p-3 bg-light rounded border border-2 shadow-sm">
            <h6 class="border-bottom border-2 border-primary pb-2 mb-3 fw-bold"><i class="bi bi-info-circle me-1"></i>基本情報</h6>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">販売日 <span class="text-danger">*</span></label>
                <input type="date" class="form-control" id="invSalesDate" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">販売先 <span class="text-danger">*</span></label>
                <select class="form-select" id="invSalesPlatform" required>
                  <option value="">読み込み中...</option>
                </select>
                <div id="invFeeTypeInputContainer" class="mt-2" style="display:none;"></div>
              </div>
              <div class="col-12">
                <label class="form-label">販売金額 <span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text">&#165;</span>
                  <input type="number" class="form-control" id="invSalesAmount" min="0" required>
                </div>
              </div>
            </div>
          </div>
          <!-- 発送情報 -->
          <div class="mb-4 p-3 bg-light rounded border border-2 shadow-sm">
            <h6 class="border-bottom border-2 border-primary pb-2 mb-3 fw-bold"><i class="bi bi-truck me-1"></i>発送情報</h6>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">発送方法（カテゴリ） <span class="text-danger">*</span></label>
                <select class="form-select" id="invShippingMethod1" required>
                  <option value="">選択してください</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">発送方法（詳細） <span class="text-danger">*</span></label>
                <select class="form-select" id="invShippingMethod2" required disabled>
                  <option value="">まず発送方法を選択してください</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">送料</label>
                <div class="input-group">
                  <span class="input-group-text">&#165;</span>
                  <input type="text" class="form-control bg-light" id="invShippingFee" readonly>
                </div>
              </div>
            </div>
          </div>
          <!-- プリセット選択ボタン -->
          <div class="mb-3 text-center">
            <button type="button" class="btn btn-outline-primary" onclick="invShowPresetSelector()">
              <i class="bi bi-list-check me-1"></i>プリセットから選択
            </button>
          </div>
          <!-- 梱包資材 -->
          <div class="mb-4 p-3 bg-light rounded border border-2 shadow-sm">
            <h6 class="border-bottom border-2 border-primary pb-2 mb-3 fw-bold"><i class="bi bi-box me-1"></i>梱包資材</h6>
            <div id="invPackagingMaterialsContainer"></div>
            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="invAddPackagingMaterial">
              <i class="bi bi-plus-circle"></i> 梱包資材を追加
            </button>
            <div class="mt-3">
              <strong>梱包資材費合計: </strong>
              <span id="invTotalPackagingCost">&#165;0.00</span>
            </div>
          </div>
          <!-- 手数料・利益 -->
          <div class="mb-4 p-3 bg-light rounded border border-2 shadow-sm">
            <h6 class="border-bottom border-2 border-success pb-2 mb-3 fw-bold"><i class="bi bi-calculator me-1"></i>利益計算</h6>
            <table class="table table-sm">
              <tbody>
                <tr><td>販売金額</td><td class="text-end" id="invProfitSalesAmount">&#165;0</td></tr>
                <tr><td>仕入金額</td><td class="text-end text-danger" id="invProfitPurchaseCost">- &#165;0</td></tr>
                <tr><td>プラットフォーム手数料 (<span id="invPlatformFeeRate">10</span>%)</td><td class="text-end text-danger" id="invProfitPlatformFee">- &#165;0</td></tr>
                <tr><td>決済手数料</td><td class="text-end text-danger" id="invProfitPaymentFee">- &#165;0</td></tr>
                <tr><td>送料</td><td class="text-end text-danger" id="invProfitShippingFee">- &#165;0</td></tr>
                <tr><td>梱包資材費</td><td class="text-end text-danger" id="invProfitPackagingCost">- &#165;0</td></tr>
                <tr class="table-primary fw-bold"><td>最終利益</td><td class="text-end" id="invFinalProfit">&#165;0</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="invSaveSalesRecord">販売記録を保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- プリセット選択モーダル -->
  <div class="modal fade" id="invPresetSelectorModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">プリセット選択</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="invPresetSelectorList"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 画像ライトボックス -->
  <div id="invImageLightbox" class="inv-lightbox-overlay" style="display: none;" data-current-index="0">
    <div class="inv-lightbox-content">
      <span class="inv-lightbox-close">&times;</span>
      <span class="inv-lightbox-nav inv-lightbox-prev">&#10094;</span>
      <img id="invLightboxImage" src="" alt="拡大画像">
      <span class="inv-lightbox-nav inv-lightbox-next">&#10095;</span>
      <div class="inv-lightbox-counter"><span id="invLightboxCounter">1/1</span></div>
    </div>
  </div>

  <!-- ダッシュボード -->
  <div class="inv-content-container">
    <div class="inv-dashboard-card" id="invDashboardSection">
      <div class="row g-2">
        <div class="col-6 col-md-4">
          <div class="card text-center" onclick="invFilterByStatus('all')" title="全商品を表示">
            <div class="card-body py-2">
              <div class="text-muted small">総商品数</div>
              <h5 class="mb-0" id="invStatTotal">-</h5>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-4">
          <div class="card text-center" onclick="invFilterByStatus('登録済み')" title="登録済みのみ表示">
            <div class="card-body py-2">
              <div class="text-muted small">登録済み</div>
              <h5 class="mb-0" id="invStatRegistered">-</h5>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-4">
          <div class="card text-center" onclick="invFilterByStatus('出品準備中')" title="出品準備中のみ表示">
            <div class="card-body py-2">
              <div class="text-muted small">出品準備中</div>
              <h5 class="mb-0" id="invStatPreparing">-</h5>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-4">
          <div class="card text-center bg-primary text-white" onclick="invFilterByStatus('出品中')" title="出品中のみ表示">
            <div class="card-body py-2">
              <div class="small">出品中</div>
              <h5 class="mb-0" id="invStatListed">-</h5>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-4">
          <div class="card text-center bg-success text-white" onclick="invFilterByStatus('販売済み')" title="販売済みのみ表示">
            <div class="card-body py-2">
              <div class="small">販売済み</div>
              <h5 class="mb-0" id="invStatSold">-</h5>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-4">
          <div class="card text-center" onclick="invFilterByStatus('取り下げ')" title="取り下げのみ表示">
            <div class="card-body py-2">
              <div class="text-muted small">取り下げ</div>
              <h5 class="mb-0" id="invStatWithdrawn">-</h5>
            </div>
          </div>
        </div>
      </div>
      <!-- 滞留状況 -->
      <div class="inv-aging-section mt-3" id="invAgingSection" style="display: none;">
        <div class="inv-aging-header">
          <span class="inv-aging-title"><i class="bi bi-clock-history"></i> 出品中 滞留状況</span>
        </div>
        <div class="inv-aging-bars">
          <div class="inv-aging-row">
            <div class="inv-aging-label"><span class="inv-aging-dot green"></span><span>7日以内</span></div>
            <div class="inv-aging-bar-container"><div class="inv-aging-bar green" id="invAgingBar7" style="width: 0%;"></div></div>
            <div class="inv-aging-count" id="invAgingCount7">0件</div>
          </div>
          <div class="inv-aging-row">
            <div class="inv-aging-label"><span class="inv-aging-dot yellow"></span><span>8-14日</span></div>
            <div class="inv-aging-bar-container"><div class="inv-aging-bar yellow" id="invAgingBar14" style="width: 0%;"></div></div>
            <div class="inv-aging-count" id="invAgingCount14">0件</div>
          </div>
          <div class="inv-aging-row">
            <div class="inv-aging-label"><span class="inv-aging-dot orange"></span><span>15-30日</span></div>
            <div class="inv-aging-bar-container"><div class="inv-aging-bar orange" id="invAgingBar30" style="width: 0%;"></div></div>
            <div class="inv-aging-count" id="invAgingCount30">0件</div>
          </div>
          <div class="inv-aging-row">
            <div class="inv-aging-label"><span class="inv-aging-dot red"></span><span>30日超過</span></div>
            <div class="inv-aging-bar-container"><div class="inv-aging-bar red" id="invAgingBarOver30" style="width: 0%;"></div></div>
            <div class="inv-aging-count" id="invAgingCountOver30">0件</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 検索・フィルタ -->
    <div class="inv-filter-section" id="invFilterSection">
      <h5 class="mb-3"><i class="bi bi-search" style="font-size: 18px;"></i> 検索・絞り込み</h5>
      <!-- ステータスフィルタ -->
      <div class="inv-filter-subsection">
        <div class="inv-filter-subsection-title"><i class="bi bi-tag"></i> ステータス（複数選択可）</div>
        <div class="d-flex flex-wrap gap-2">
          <div class="form-check"><input class="form-check-input" type="checkbox" value="登録済み" id="invStatus1" checked><label class="form-check-label small" for="invStatus1">登録済み</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" value="出品準備中" id="invStatus2" checked><label class="form-check-label small" for="invStatus2">出品準備中</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" value="出品中" id="invStatus3" checked><label class="form-check-label small" for="invStatus3">出品中</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" value="販売済み" id="invStatus4" checked><label class="form-check-label small" for="invStatus4">販売済み</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" value="取り下げ" id="invStatus5" checked><label class="form-check-label small" for="invStatus5">取り下げ</label></div>
        </div>
      </div>
      <!-- 並び順 -->
      <div class="row g-2 mb-3">
        <div class="col-6">
          <label for="invSortBy" class="form-label small">並び順</label>
          <select class="form-select form-select-sm" id="invSortBy">
            <option value="registeredAt">登録日時</option>
            <option value="listingDate">出品日</option>
            <option value="saleDate">販売日</option>
            <option value="profit">利益金額</option>
          </select>
        </div>
        <div class="col-6">
          <label for="invSortOrder" class="form-label small">順序</label>
          <select class="form-select form-select-sm" id="invSortOrder">
            <option value="desc">新しい順</option>
            <option value="asc">古い順</option>
          </select>
        </div>
      </div>
      <!-- 検索セクション -->
      <div class="inv-filter-subsection inv-search-section">
        <div class="inv-search-group mb-3">
          <div class="inv-search-group-title"><i class="bi bi-upc-scan"></i> 管理番号で検索</div>
          <div class="row g-2">
            <div class="col-4"><select class="form-select form-select-sm" id="invMgmtSearchFirst" onchange="invOnMgmtSearchFirstChange()"><option value="">頭文字</option></select></div>
            <div class="col-4"><select class="form-select form-select-sm" id="invMgmtSearchSecond" disabled onchange="invOnMgmtSearchSecondChange()"><option value="">棚番号</option></select></div>
            <div class="col-4"><input type="text" class="form-control form-control-sm" id="invMgmtSearchNumber" placeholder="連番" inputmode="numeric" pattern="[0-9]*"></div>
          </div>
          <input type="hidden" id="invMgmtSearchValue">
        </div>
        <div class="inv-search-group mb-3">
          <div class="inv-search-group-title"><i class="bi bi-box-seam"></i> 商品名・ブランドで検索</div>
          <div class="position-relative">
            <input type="text" class="form-control form-control-sm pe-5" id="invSearchText" placeholder="例: UNIQLO, Tシャツ">
            <button type="button" class="inv-btn-clear-search" id="invClearSearchText" style="display: none;" onclick="invClearSearchText()">
              <i class="bi bi-x-circle-fill"></i>
            </button>
          </div>
        </div>
        <!-- 詳細フィルタ -->
        <div class="accordion mb-3" id="invAdvancedFilters">
          <div class="accordion-item border-0">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed rounded" type="button" data-bs-toggle="collapse" data-bs-target="#invCollapseFilters">
                <i class="bi bi-sliders me-2"></i> 詳細フィルタ
              </button>
            </h2>
            <div id="invCollapseFilters" class="accordion-collapse collapse" data-bs-parent="#invAdvancedFilters">
              <div class="accordion-body">
                <div class="row g-2">
                  <div class="col-12">
                    <label for="invFilterBrand" class="form-label small">ブランド</label>
                    <div class="inv-filter-brand-suggest">
                      <input type="text" class="form-control form-control-sm" id="invFilterBrand" placeholder="ブランド名を入力..." autocomplete="off">
                      <div class="inv-filter-brand-suggest-list" id="invFilterBrandSuggestList"></div>
                    </div>
                  </div>
                  <div class="col-6">
                    <label for="invFilterCategory" class="form-label small">カテゴリ</label>
                    <select class="form-select form-select-sm" id="invFilterCategory"><option value="">すべて</option></select>
                  </div>
                  <div class="col-6">
                    <label for="invFilterSize" class="form-label small">サイズ</label>
                    <select class="form-select form-select-sm" id="invFilterSize"><option value="">すべて</option></select>
                  </div>
                  <div class="col-12">
                    <label for="invFilterColor" class="form-label small">カラー</label>
                    <select class="form-select form-select-sm" id="invFilterColor"><option value="">すべて</option></select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- 検索・リセットボタン -->
      <div class="d-flex gap-2 mt-3">
        <button class="btn btn-primary btn-sm flex-grow-1" id="invBtnSearch"><i class="bi bi-search"></i> 検索</button>
        <button class="btn btn-outline-secondary btn-sm" id="invBtnReset"><i class="bi bi-arrow-counterclockwise"></i> リセット</button>
      </div>
    </div>

    <!-- 検索結果 -->
    <div id="invResultsSection" style="display: none;">
      <div class="d-flex align-items-center gap-2 mb-3">
        <span class="text-muted small" id="invSearchSummary"></span>
      </div>
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">検索結果: <span id="invResultCount">0</span>件</h6>
        <select class="form-select form-select-sm" style="width: auto;" id="invPerPage">
          <option value="10" selected>10件/ページ</option>
          <option value="20">20件/ページ</option>
          <option value="50">50件/ページ</option>
          <option value="100">100件/ページ</option>
        </select>
      </div>
      <div id="invProductList"></div>
      <div class="inv-pagination-container" id="invPaginationContainer"></div>
    </div>
  </div>

  <script>
    // ===== Inventory SPA Fragment =====
    var invCurrentPage = 1;
    var INV_CACHE_DURATION_MS = 300000;
    var invCurrentFilters = {};
    var invCurrentSort = { sortBy: 'registeredAt', sortOrder: 'desc' };
    var invCurrentProduct = null;
    var invShippingMethodMaster = [];
    var invPackagingMaterialsMaster = [];
    var invPackagingMaterialsByCategory = {};
    var invPackagingMaterialCategories = [];
    var invSalesChannelsMaster = [];
    var invCurrentSalesProduct = null;
    var invPackagingMaterialCount = 3;
    var invCurrentSelectedFeeRate = null;
    var invMgmtNumberConfig = null;
    var inv_currentProductImages = [];
    var inv_lightboxFunctionsInitialized = false;
    var inv_lightboxListenersInitialized = false;
    var _inv_dropdownClickHandler = null;
    var _inv_eventListeners = [];

    var INV_CACHE_KEY_STATS = 'reborn_inventory_stats';
    var INV_CACHE_KEY_PRODUCTS = 'reborn_inventory_products';

    // Algolia settings
    var INV_ALGOLIA_APP_ID = 'P68RUXXTYN';
    var INV_ALGOLIA_SEARCH_KEY = '12758e11bbd889f72177b459d296ed50';
    var INV_ALGOLIA_INDEX_NAME = 'brands';

    // ===== Helper to add tracked event listeners (for cleanup) =====
    function invAddListener(el, event, handler, options) {
      if (!el) return;
      el.addEventListener(event, handler, options);
      _inv_eventListeners.push({ el: el, event: event, handler: handler, options: options });
    }

    // ===== Settings Dropdown =====
    function invToggleSettingsDropdown(event) {
      event.stopPropagation();
      var dropdown = document.getElementById('invSettingsDropdown');
      if (dropdown) dropdown.classList.toggle('show');
    }

    // ===== Inlined Firestore API functions (not in shared FirestoreApi) =====
    async function invGetShippingMethodMaster() {
      var db = window.db;
      var snapshot = await db.collection('shippingMethods').get();
      var methods = [];
      snapshot.forEach(function(docSnap) {
        var data = docSnap.data();
        if (data.items && Array.isArray(data.items)) {
          // カテゴリ別ドキュメント形式: {items: [{detail, price}, ...]}
          data.items.forEach(function(item) {
            methods.push({ method1: docSnap.id, method2: item.detail, fee: item.price });
          });
        } else {
          // 個別ドキュメント形式: {category, detail, price}
          methods.push({ method1: data.category, method2: data.detail, fee: data.price });
        }
      });
      methods.sort(function(a, b) { return (a.method1 || '').localeCompare(b.method1 || '', 'ja'); });
      return methods;
    }

    async function invGetPackagingMaterialsMaster() {
      var db = window.db;
      var snapshot = await db.collection('packagingMaterials').get();
      var byCategory = {};
      var categoriesSet = new Set();
      snapshot.forEach(function(docSnap) {
        var data = docSnap.data();
        var category = data.category || 'その他';
        categoriesSet.add(category);
        if (!byCategory[category]) byCategory[category] = [];
        var quantity = data.quantity || 1;
        var price = data.price || 0;
        var unitCost = quantity > 0 ? Math.round((price / quantity) * 100) / 100 : 0;
        byCategory[category].push({
          id: docSnap.id, productName: data.name, name: data.name,
          price: price, unitCost: unitCost, category: category
        });
      });
      var categories = Array.from(categoriesSet).sort(function(a, b) { return a.localeCompare(b, 'ja'); });
      return { data: byCategory, categories: categories };
    }

    async function invGetSalesChannelsMaster() {
      var db = window.db;
      var snapshot;
      try {
        snapshot = await db.collection('salesChannels').orderBy('order', 'asc').get();
      } catch (e) {
        snapshot = await db.collection('salesChannels').get();
      }
      var channels = [];
      snapshot.forEach(function(docSnap) {
        channels.push(Object.assign({ id: docSnap.id }, docSnap.data()));
      });
      return channels;
    }

    async function invSaveSalesRecordToFirestore(salesData) {
      try {
        var db = window.db;
        var serverTs = firebase.firestore.FieldValue.serverTimestamp;

        var snapshot = await db.collection('products').where('managementNumber', '==', salesData.managementNumber).limit(1).get();
        if (snapshot.empty) throw new Error('商品が見つかりません: ' + salesData.managementNumber);
        var productDocId = snapshot.docs[0].id;
        var productData = snapshot.docs[0].data();

        await db.collection('products').doc(productDocId).update({
          status: '販売済', saleDate: salesData.salesDate, saleAmount: salesData.salesAmount,
          salePlatform: salesData.salesPlatform, shippingMethod1: salesData.shippingMethod1,
          shippingMethod2: salesData.shippingMethod2, shippingFee: salesData.shippingFee,
          packagingMaterials: salesData.packagingMaterials, packagingCostTotal: salesData.packagingCostTotal,
          platformFee: salesData.platformFee, paymentFee: salesData.paymentFee,
          finalProfit: salesData.finalProfit, profitRate: salesData.profitRate,
          updatedAt: serverTs()
        });

        // 梱包資材の出庫処理
        if (salesData.packagingMaterials && salesData.packagingMaterials.length > 0) {
          for (var mi = 0; mi < salesData.packagingMaterials.length; mi++) {
            var material = salesData.packagingMaterials[mi];
            if (material.materialId) {
              try {
                await db.collection('packagingTransactions').add({
                  materialId: material.materialId, type: 'out', quantity: 1, reason: 'sale',
                  relatedSaleId: productDocId, notes: '販売: ' + salesData.managementNumber,
                  createdBy: (window.currentUser && window.currentUser.name) || 'unknown', createdAt: serverTs()
                });
                var materialDoc = await db.collection('packagingMaterials').doc(material.materialId).get();
                if (materialDoc.exists) {
                  var currentStock = (materialDoc.data() && materialDoc.data().currentStock) || 0;
                  var newStock = Math.max(0, currentStock - 1);
                  await db.collection('packagingMaterials').doc(material.materialId).update({ currentStock: newStock, updatedAt: serverTs() });
                }
              } catch (stockError) {
                console.warn('[inv] 出庫処理エラー:', material.productName, stockError);
              }
            }
          }
        }

        // 発送タスク追加
        if (productData) {
          await invAddShippingTaskToStaff(productData, salesData, productDocId);
        }
        return { success: true };
      } catch (error) {
        console.error('[inv] 販売記録保存エラー:', error);
        return { success: false, error: error.message };
      }
    }

    async function invAddShippingTaskToStaff(productData, salesData, productDocId) {
      try {
        var db = window.db;
        var serverTs = firebase.firestore.FieldValue.serverTimestamp;

        var staffName = productData.createdBy || '不明';
        var staffEmail = productData.createdByEmail || null;
        if (!staffEmail) return;

        var dueDate = null;
        try {
          var shippingDefaultStr = localStorage.getItem('rebornConfig_shippingDefault');
          if (shippingDefaultStr) {
            var shippingDefault = JSON.parse(shippingDefaultStr);
            var shippingDaysStr = shippingDefault['発送までの日数'] || '1~2日で発送';
            var match = shippingDaysStr.match(/(\d+)~(\d+)日/);
            var dueDays = match ? parseInt(match[2], 10) : 2;
            dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + dueDays);
            dueDate.setHours(23, 59, 59, 999);
          }
        } catch (e) {}

        var taskData = {
          type: 'shipping_task', title: '梱包・発送',
          description: '商品が売れました！梱包して発送してください。\n管理番号: ' + salesData.managementNumber + '\n売上: \\' + Number(salesData.salesAmount).toLocaleString(),
          link: '/product.html?edit=' + productDocId,
          relatedData: {
            productId: productDocId, managementNumber: salesData.managementNumber,
            staffName: staffName, staffEmail: staffEmail,
            saleAmount: salesData.salesAmount, salePlatform: salesData.salesPlatform
          }
        };

        await db.collection('userTasks').doc(staffEmail).collection('tasks').add(Object.assign({}, taskData, {
          createdAt: serverTs(),
          dueDate: dueDate ? firebase.firestore.Timestamp.fromDate(dueDate) : null,
          completed: false, read: false
        }));

        // Push notification
        try {
          var devicesSnapshot = await db.collection('users').doc(staffEmail).collection('devices').where('active', '==', true).get();
          var tokens = [];
          devicesSnapshot.forEach(function(deviceDoc) {
            var deviceData = deviceDoc.data();
            if (deviceData.fcmToken) tokens.push(deviceData.fcmToken);
          });
          if (tokens.length > 0) {
            fetch('https://reborn-fcm-worker.mercari-yasuhirotakuji.workers.dev/send', {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                tokens: tokens, title: '発送依頼',
                body: '商品が売れました！' + salesData.managementNumber + ' を梱包・発送してください',
                data: { type: 'shipping_task', productId: productDocId, managementNumber: salesData.managementNumber, badgeCount: '1' }
              })
            });
          }
        } catch (pushError) {
          console.error('[inv] プッシュ通知エラー:', pushError);
        }
      } catch (error) {
        console.error('[inv] 発送タスク追加エラー:', error);
      }
    }

    // ===== View toggle =====
    function _invScrollToTop() {
      var container = document.querySelector('[data-spa-page="inventory"]');
      if (container) container.scrollTop = 0;
    }

    function invShowResultsView() {
      document.getElementById('invDashboardSection').style.display = 'none';
      document.getElementById('invFilterSection').style.display = 'none';
      document.getElementById('invResultsSection').style.display = 'block';
      invUpdateSearchSummary();
      _invScrollToTop();
    }

    function invShowSearchView() {
      document.getElementById('invDashboardSection').style.display = 'block';
      document.getElementById('invFilterSection').style.display = 'block';
      document.getElementById('invResultsSection').style.display = 'none';
      _invScrollToTop();
    }

    // ヘッダー戻るボタン: 結果一覧なら検索条件へ、検索条件ならホームへ
    function invSmartBack() {
      var resultsSection = document.getElementById('invResultsSection');
      if (resultsSection && resultsSection.style.display !== 'none') {
        invShowSearchView();
      } else {
        spaGoBack();
      }
    }

    function invUpdateSearchSummary() {
      var summary = [];
      var checkedStatuses = [];
      for (var i = 1; i <= 5; i++) {
        var checkbox = document.getElementById('invStatus' + i);
        if (checkbox && checkbox.checked) checkedStatuses.push(checkbox.value);
      }
      if (checkedStatuses.length > 0 && checkedStatuses.length < 5) summary.push(checkedStatuses.join('・'));
      var searchText = document.getElementById('invSearchText').value.trim();
      if (searchText) summary.push('「' + searchText + '」');
      var summaryEl = document.getElementById('invSearchSummary');
      summaryEl.textContent = summary.length > 0 ? '条件: ' + summary.join(', ') : '全件表示';
    }

    // ===== Stats =====
    function invUpdateStatsDisplay(stats) {
      document.getElementById('invStatTotal').textContent = stats.total;
      document.getElementById('invStatRegistered').textContent = stats.statusCounts.registered;
      document.getElementById('invStatPreparing').textContent = stats.statusCounts.preparingListing;
      document.getElementById('invStatListed').textContent = stats.statusCounts.listed;
      document.getElementById('invStatSold').textContent = stats.statusCounts.sold;
      document.getElementById('invStatWithdrawn').textContent = stats.statusCounts.withdrawn;
    }

    function invCalculateStats(products) {
      return {
        total: products.length,
        statusCounts: {
          registered: products.filter(function(p) { return p.status === '登録済み'; }).length,
          preparingListing: products.filter(function(p) { return p.status === '出品準備中'; }).length,
          listed: products.filter(function(p) { return p.status === '出品中'; }).length,
          sold: products.filter(function(p) { return p.status === '販売済み'; }).length,
          withdrawn: products.filter(function(p) { return p.status === '取り下げ'; }).length
        },
        timestamp: Date.now()
      };
    }

    // ===== Loading =====
    function invShowLoading() {
      var el = document.getElementById('invLoadingOverlay');
      if (el) el.style.display = 'flex';
    }
    function invHideLoading() {
      var el = document.getElementById('invLoadingOverlay');
      if (el) el.style.display = 'none';
    }
    function invShowError(message) { alert(message); }

    // ===== Utility =====
    function invGetStatusClass(status) {
      var m = { '登録済み': 'bg-secondary', '出品準備中': 'bg-info', '出品中': 'bg-primary', '販売済み': 'bg-success', '取り下げ': 'bg-warning' };
      return m[status] || 'bg-secondary';
    }
    function invFormatCurrency(value) {
      if (!value && value !== 0) return '-';
      return '\u00a5' + Number(value).toLocaleString();
    }
    function invFormatDate(value) {
      if (!value) return '-';
      var d;
      if (value.toDate) d = value.toDate();
      else if (value.seconds) d = new Date(value.seconds * 1000);
      else d = new Date(value);
      if (isNaN(d.getTime())) return String(value);
      return d.getFullYear() + '/' + String(d.getMonth() + 1).padStart(2, '0') + '/' + String(d.getDate()).padStart(2, '0');
    }
    function invGetThumbUrl(originalUrl) {
      if (!originalUrl) return originalUrl;
      try {
        var url = new URL(originalUrl);
        var pathMatch = url.pathname.match(/\/o\/(.+)/);
        if (pathMatch) {
          var encodedPath = pathMatch[1];
          var decodedPath = decodeURIComponent(encodedPath);
          var pathParts = decodedPath.split('/');
          var fileName = pathParts.pop();
          var fileNameWithoutExt = fileName.replace(/\.[^.]+$/, '');
          var thumbFileName = fileNameWithoutExt + '_thumb_200.jpg';
          var thumbPath = pathParts.concat(['thumbs', thumbFileName]).join('/');
          var thumbEncodedPath = encodeURIComponent(thumbPath).replace(/%2F/g, '%2F');
          return url.origin + '/v0/b/' + url.pathname.split('/')[3] + '/o/' + thumbEncodedPath + '?alt=media';
        }
      } catch (e) {}
      return originalUrl;
    }
    function invEscapeHtml(str) {
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }
    function invHiraganaToKatakana(str) {
      return str.replace(/[\u3041-\u3096]/g, function(match) { return String.fromCharCode(match.charCodeAt(0) + 0x60); });
    }

    // ===== Dashboard load =====
    function invLoadDashboard() {
      var productList = document.getElementById('invProductList');
      var resultCount = document.getElementById('invResultCount');
      if (productList) productList.innerHTML = '';
      if (resultCount) resultCount.textContent = '0';

      try {
        var cachedStats = sessionStorage.getItem(INV_CACHE_KEY_STATS);
        if (cachedStats) {
          var stats = JSON.parse(cachedStats);
          var age = Date.now() - (stats.timestamp || 0);
          if (age < INV_CACHE_DURATION_MS) { invUpdateStatsDisplay(stats); return; }
          else { invUpdateStatsDisplay(stats); }
        }
      } catch (e) {}

      invShowLoading();
      var isCompleted = false;
      var fallbackCache = null;
      try {
        var cachedProducts = sessionStorage.getItem(INV_CACHE_KEY_PRODUCTS);
        if (cachedProducts) fallbackCache = JSON.parse(cachedProducts);
      } catch (e) {}

      var retryCount = 0;
      var maxRetries = 2;

      function handleFinalFailure(reason) {
        isCompleted = true;
        invHideLoading();
        if (fallbackCache && fallbackCache.length > 0) {
          var stats = invCalculateStats(fallbackCache);
          invUpdateStatsDisplay(stats);
          invUpdateAgingDisplay(fallbackCache);
          invShowError('接続に問題があります。キャッシュデータを表示中です。');
        } else {
          invShowError('接続がタイムアウトしました。ページを再読み込みしてください。');
        }
      }

      function fetchWithRetry() {
        var timeoutId = setTimeout(function() {
          if (!isCompleted) {
            if (retryCount < maxRetries) { retryCount++; fetchWithRetry(); }
            else { handleFinalFailure('全リトライ失敗（タイムアウト）'); }
          }
        }, 15000);

        window.FirestoreApi.getProductList().then(function(products) {
          if (isCompleted) return;
          isCompleted = true;
          clearTimeout(timeoutId);
          invHideLoading();
          var stats = invCalculateStats(products);
          invUpdateStatsDisplay(stats);
          try {
            sessionStorage.setItem(INV_CACHE_KEY_STATS, JSON.stringify(stats));
            sessionStorage.setItem(INV_CACHE_KEY_PRODUCTS, JSON.stringify(products));
          } catch (e) {}
          invUpdateAgingDisplay(products);
        }).catch(function(error) {
          clearTimeout(timeoutId);
          if (isCompleted) return;
          if (retryCount < maxRetries) { retryCount++; setTimeout(fetchWithRetry, 1000); }
          else { handleFinalFailure('全リトライ失敗（エラー: ' + (error ? error.message : 'Unknown') + '）'); }
        });
      }
      fetchWithRetry();
    }

    // ===== Aging display =====
    function invUpdateAgingDisplay(products) {
      var agingSection = document.getElementById('invAgingSection');
      if (!agingSection) return;
      var listedProducts = products.filter(function(p) { return p.status === '出品中'; });
      if (listedProducts.length === 0) { agingSection.style.display = 'none'; return; }

      var today = new Date(); today.setHours(0, 0, 0, 0);
      var categories = { within7: [], within14: [], within30: [], over30: [] };

      listedProducts.forEach(function(product) {
        var listingDate = null;
        if (product.listingDate) listingDate = product.listingDate.toDate ? product.listingDate.toDate() : new Date(product.listingDate);
        else if (product.listingStartDate) listingDate = product.listingStartDate.toDate ? product.listingStartDate.toDate() : new Date(product.listingStartDate);
        else if (product.createdAt) listingDate = product.createdAt.toDate ? product.createdAt.toDate() : new Date(product.createdAt);
        if (!listingDate || isNaN(listingDate.getTime())) { categories.over30.push(product); return; }
        listingDate.setHours(0, 0, 0, 0);
        var diffDays = Math.floor((today - listingDate) / (1000 * 60 * 60 * 24));
        if (diffDays <= 7) categories.within7.push(product);
        else if (diffDays <= 14) categories.within14.push(product);
        else if (diffDays <= 30) categories.within30.push(product);
        else categories.over30.push(product);
      });

      var total = listedProducts.length;
      document.getElementById('invAgingBar7').style.width = (categories.within7.length / total * 100).toFixed(1) + '%';
      document.getElementById('invAgingCount7').textContent = categories.within7.length + '件';
      document.getElementById('invAgingBar14').style.width = (categories.within14.length / total * 100).toFixed(1) + '%';
      document.getElementById('invAgingCount14').textContent = categories.within14.length + '件';
      document.getElementById('invAgingBar30').style.width = (categories.within30.length / total * 100).toFixed(1) + '%';
      document.getElementById('invAgingCount30').textContent = categories.within30.length + '件';
      document.getElementById('invAgingBarOver30').style.width = (categories.over30.length / total * 100).toFixed(1) + '%';
      document.getElementById('invAgingCountOver30').textContent = categories.over30.length + '件';
      agingSection.style.display = 'block';
    }

    function invCalculateAgingDays(product) {
      var today = new Date(); today.setHours(0, 0, 0, 0);
      var listingDate = null;
      if (product.listingDate) listingDate = product.listingDate.toDate ? product.listingDate.toDate() : new Date(product.listingDate);
      else if (product.listingStartDate) listingDate = product.listingStartDate.toDate ? product.listingStartDate.toDate() : new Date(product.listingStartDate);
      else if (product.createdAt) listingDate = product.createdAt.toDate ? product.createdAt.toDate() : new Date(product.createdAt);
      if (!listingDate || isNaN(listingDate.getTime())) return { days: -1, colorClass: '' };
      listingDate.setHours(0, 0, 0, 0);
      var diffDays = Math.floor((today - listingDate) / (1000 * 60 * 60 * 24));
      var colorClass = 'green';
      if (diffDays > 30) colorClass = 'red';
      else if (diffDays > 14) colorClass = 'orange';
      else if (diffDays > 7) colorClass = 'yellow';
      return { days: diffDays, colorClass: colorClass };
    }

    // ===== Filter params =====
    function invCollectFilterParams() {
      var statusCheckboxes = document.querySelectorAll('#spa-page-inventory input[type="checkbox"][id^="invStatus"]:checked');
      var statusValues = Array.from(statusCheckboxes).map(function(cb) { return cb.value; });
      var mgmtFirst = document.getElementById('invMgmtSearchFirst').value;
      var mgmtSecond = document.getElementById('invMgmtSearchSecond').value;
      var mgmtNumber = document.getElementById('invMgmtSearchNumber').value.trim();
      var mgmtSearchText = '';
      if (mgmtSecond && mgmtNumber) mgmtSearchText = mgmtSecond + '-' + mgmtNumber;
      else if (mgmtSecond) mgmtSearchText = mgmtSecond + '-';
      else if (mgmtFirst) mgmtSearchText = mgmtFirst;

      return {
        statuses: statusValues,
        searchText: document.getElementById('invSearchText').value.trim(),
        mgmtSearchText: mgmtSearchText,
        brand: document.getElementById('invFilterBrand').value.trim(),
        category: document.getElementById('invFilterCategory').value.trim(),
        size: document.getElementById('invFilterSize').value.trim(),
        color: document.getElementById('invFilterColor').value.trim(),
        page: invCurrentPage,
        limit: parseInt(document.getElementById('invPerPage').value) || 10,
        sortBy: document.getElementById('invSortBy').value,
        sortOrder: document.getElementById('invSortOrder').value
      };
    }

    // ===== Apply filters =====
    function invApplyFiltersAndDisplay(products, params) {
      var filtered = products;
      if (params.statuses && params.statuses.length > 0) filtered = filtered.filter(function(p) { return params.statuses.indexOf(p.status) !== -1; });
      if (params.mgmtSearchText) { var ml = params.mgmtSearchText.toLowerCase(); filtered = filtered.filter(function(p) { return p.managementNumber && p.managementNumber.toLowerCase().startsWith(ml); }); }
      if (params.searchText) { var sl = params.searchText.toLowerCase(); filtered = filtered.filter(function(p) { return (p.productName && p.productName.toLowerCase().indexOf(sl) !== -1) || (p.brand && p.brand.toLowerCase().indexOf(sl) !== -1); }); }
      if (params.brand) filtered = filtered.filter(function(p) { return p.brand === params.brand; });
      if (params.category) filtered = filtered.filter(function(p) { return p.category === params.category; });
      if (params.size) filtered = filtered.filter(function(p) { return p.size === params.size; });
      if (params.color) filtered = filtered.filter(function(p) { return p.color === params.color; });

      filtered.sort(function(a, b) {
        var aVal = a[params.sortBy] || '';
        var bVal = b[params.sortBy] || '';
        // Firestore Timestampを比較可能な値に変換
        if (aVal && aVal.toDate) aVal = aVal.toDate().getTime();
        else if (aVal && aVal.seconds) aVal = aVal.seconds * 1000;
        if (bVal && bVal.toDate) bVal = bVal.toDate().getTime();
        else if (bVal && bVal.seconds) bVal = bVal.seconds * 1000;
        return params.sortOrder === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
      });

      var totalCount = filtered.length;
      var totalPages = Math.ceil(totalCount / params.limit);
      var startIndex = (params.page - 1) * params.limit;
      var paginated = filtered.slice(startIndex, startIndex + params.limit);

      var stats = invCalculateStats(products);
      invUpdateStatsDisplay(stats);
      invDisplayProducts(paginated);
      invDisplayPagination(params.page, totalPages, totalCount);
      document.getElementById('invResultCount').textContent = totalCount;
      return { filteredProducts: filtered, paginatedProducts: paginated, stats: stats, totalCount: totalCount };
    }

    // ===== Load + Search =====
    function invLoadDashboardAndSearch(showLoadingIndicator) {
      if (showLoadingIndicator === undefined) showLoadingIndicator = true;
      var params = invCollectFilterParams();

      try {
        var cachedProducts = sessionStorage.getItem(INV_CACHE_KEY_PRODUCTS);
        if (cachedProducts) {
          var products = JSON.parse(cachedProducts);
          var cachedStats = sessionStorage.getItem(INV_CACHE_KEY_STATS);
          var stats = cachedStats ? JSON.parse(cachedStats) : null;
          var cacheAge = stats ? Date.now() - (stats.timestamp || 0) : Infinity;
          if (cacheAge < INV_CACHE_DURATION_MS) {
            invApplyFiltersAndDisplay(products, params);
            if (showLoadingIndicator) invHideLoading();
            return;
          } else {
            invApplyFiltersAndDisplay(products, params);
          }
        }
      } catch (e) {}

      if (showLoadingIndicator) invShowLoading();
      var isCompleted = false;
      var timeoutId = setTimeout(function() { if (!isCompleted) { isCompleted = true; if (showLoadingIndicator) invHideLoading(); } }, 10000);

      var firestoreFilters = {};
      if (params.statuses && params.statuses.length === 1) firestoreFilters.status = params.statuses[0];

      window.FirestoreApi.getProductList(firestoreFilters).then(function(products) {
        if (isCompleted) return;
        isCompleted = true;
        clearTimeout(timeoutId);
        if (showLoadingIndicator) invHideLoading();
        invApplyFiltersAndDisplay(products, params);
        if (Object.keys(firestoreFilters).length === 0) {
          try {
            var stats = invCalculateStats(products);
            sessionStorage.setItem(INV_CACHE_KEY_STATS, JSON.stringify(stats));
            sessionStorage.setItem(INV_CACHE_KEY_PRODUCTS, JSON.stringify(products));
          } catch (e) {}
        }
      }).catch(function(error) {
        if (isCompleted) return;
        isCompleted = true;
        clearTimeout(timeoutId);
        if (showLoadingIndicator) invHideLoading();
        invShowError('読み込みエラー: ' + (error ? (error.message || error) : 'Unknown error'));
      });
    }

    // ===== Display products =====
    function invDisplayProducts(products) {
      var container = document.getElementById('invProductList');
      if (!products || products.length === 0) {
        container.innerHTML = '<div class="alert alert-info">商品が見つかりませんでした。</div>';
        return;
      }
      var html = '<div class="row g-2">';
      products.forEach(function(product) {
        var statusClass = invGetStatusClass(product.status);
        var agingBadgeHtml = '';
        if (product.status === '出品中') {
          var agingInfo = invCalculateAgingDays(product);
          if (agingInfo.days >= 0) agingBadgeHtml = '<span class="inv-aging-badge ' + agingInfo.colorClass + '">' + agingInfo.days + '日</span>';
        }
        var originalImageUrl = (product.images && product.images.length > 0) ? product.images[0] : (product.imageUrl1 || '');
        var thumbImageUrl = originalImageUrl ? invGetThumbUrl(originalImageUrl) : '';
        var hasImage = !!originalImageUrl;
        var wrapperClass = hasImage ? 'inv-image-wrapper loading' : 'inv-image-wrapper no-image';

        html += '<div class="col-12 col-md-6"><div class="card inv-product-card">';
        html += '<div class="' + wrapperClass + '" style="width: 100%; height: 150px;">';
        if (hasImage) {
          html += '<img src="' + thumbImageUrl + '" class="inv-product-image" alt="" loading="lazy" referrerpolicy="no-referrer" crossorigin="anonymous"'
            + ' onload="this.classList.add(\'loaded\'); this.parentElement.classList.remove(\'loading\');"'
            + ' onerror="if(!this.dataset.retried){this.dataset.retried=\'1\';this.src=\'' + originalImageUrl + '\';}else{this.style.display=\'none\';this.parentElement.classList.remove(\'loading\');this.parentElement.classList.add(\'no-image\');}">';
        }
        html += '</div>';
        html += '<div class="card-body p-2">';
        html += '<div class="d-flex justify-content-between align-items-start mb-1"><div>';
        html += '<span class="badge ' + statusClass + ' inv-status-badge">' + product.status + '</span>' + agingBadgeHtml;
        html += '</div><small class="text-muted">' + product.managementNumber + '</small></div>';
        html += '<h6 class="card-title mb-1 small">' + (product.productName || '') + '</h6>';
        html += '<div class="small text-muted mb-2">' + (product.brand || '') + ' / ' + (product.category || '') + ' / ' + (product.size || '') + ' / ' + (product.color || '') + '</div>';
        html += '<div class="d-flex justify-content-between align-items-center"><div class="small">';
        html += '<strong>出品: ' + invFormatCurrency(product.listingAmount) + '</strong><br>';
        html += '<span class="text-success">利益: ' + invFormatCurrency(product.profit) + '</span>';
        if (product.itemType === 'sku-based') html += '<br><span class="badge bg-info">在庫: ' + (product.stockQuantity || 1) + '点</span>';
        html += '</div><div class="btn-group btn-group-sm">';
        html += '<button class="btn btn-outline-primary" onclick="invViewProduct(\'' + product.managementNumber + '\')">詳細</button>';
        if (product.itemType === 'sku-based') html += '<button class="btn btn-outline-info" onclick="invOpenStockEditModal(\'' + product.managementNumber + '\',' + (product.stockQuantity || 1) + ')">在庫</button>';
        html += '<button class="btn btn-outline-success" onclick="invOpenSalesRecordModal(\'' + product.managementNumber + '\')">販売</button>';
        html += '<button class="btn btn-outline-secondary" onclick="invDuplicateProduct(\'' + product.managementNumber + '\')">複製</button>';
        html += '</div></div></div></div></div>';
      });
      html += '</div>';
      container.innerHTML = html;
    }

    // ===== Pagination =====
    function invDisplayPagination(currentPg, totalPages, totalCount) {
      var container = document.getElementById('invPaginationContainer');
      if (totalPages <= 1) { container.innerHTML = ''; return; }
      var html = '<div class="inv-custom-pagination">';
      html += '<a class="inv-page-btn ' + (currentPg === 1 ? 'disabled' : '') + '" href="#" onclick="invChangePage(' + (currentPg - 1) + '); return false;">&lt;</a>';
      var startPage = Math.max(1, currentPg - 1);
      var endPage = Math.min(totalPages, currentPg + 1);
      if (startPage > 1) {
        html += '<a class="inv-page-btn" href="#" onclick="invChangePage(1); return false;">1</a>';
        if (startPage > 2) html += '<span class="inv-page-dots">…</span>';
      }
      for (var i = startPage; i <= endPage; i++) {
        html += '<a class="inv-page-btn ' + (i === currentPg ? 'active' : '') + '" href="#" onclick="invChangePage(' + i + '); return false;">' + i + '</a>';
      }
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) html += '<span class="inv-page-dots">…</span>';
        html += '<a class="inv-page-btn" href="#" onclick="invChangePage(' + totalPages + '); return false;">' + totalPages + '</a>';
      }
      html += '<a class="inv-page-btn ' + (currentPg === totalPages ? 'disabled' : '') + '" href="#" onclick="invChangePage(' + (currentPg + 1) + '); return false;">&gt;</a>';
      html += '</div>';
      container.innerHTML = html;
    }

    function invChangePage(page) {
      invCurrentPage = page;
      invLoadDashboardAndSearch();
      _invScrollToTop();
    }

    // ===== Search helpers =====
    function invClearSearchText() {
      var input = document.getElementById('invSearchText');
      input.value = '';
      document.getElementById('invClearSearchText').style.display = 'none';
      input.focus();
    }

    function invResetFilters() {
      document.getElementById('invSearchText').value = '';
      document.getElementById('invClearSearchText').style.display = 'none';
      document.getElementById('invFilterBrand').value = '';
      document.getElementById('invFilterCategory').value = '';
      document.getElementById('invFilterSize').value = '';
      document.getElementById('invFilterColor').value = '';
      var suggestList = document.getElementById('invFilterBrandSuggestList');
      if (suggestList) suggestList.style.display = 'none';
      invClearMgmtSearch();
      document.querySelectorAll('#spa-page-inventory input[type="checkbox"][id^="invStatus"]').forEach(function(cb) { cb.checked = true; });
      document.getElementById('invSortBy').value = 'registeredAt';
      document.getElementById('invSortOrder').value = 'desc';
      invCurrentPage = 1;
      invLoadDashboardAndSearch();
    }

    function invFilterByStatus(status) {
      document.getElementById('invSearchText').value = '';
      document.getElementById('invClearSearchText').style.display = 'none';
      invClearMgmtSearch();
      document.getElementById('invFilterBrand').value = '';
      document.getElementById('invFilterCategory').value = '';
      document.getElementById('invFilterSize').value = '';
      document.getElementById('invFilterColor').value = '';

      var statusMap = { '登録済み': 'invStatus1', '出品準備中': 'invStatus2', '出品中': 'invStatus3', '販売済み': 'invStatus4', '取り下げ': 'invStatus5' };
      if (status === 'all') {
        document.querySelectorAll('#spa-page-inventory input[type="checkbox"][id^="invStatus"]').forEach(function(cb) { cb.checked = true; });
      } else {
        document.querySelectorAll('#spa-page-inventory input[type="checkbox"][id^="invStatus"]').forEach(function(cb) { cb.checked = false; });
        var targetId = statusMap[status];
        if (targetId) document.getElementById(targetId).checked = true;
      }
      invCurrentPage = 1;
      invShowResultsView();
      invLoadDashboardAndSearch();
    }

    // ===== Management number search =====
    function invInitMgmtSearchDropdowns() {
      try {
        var configStr = localStorage.getItem('rebornConfig_managementNumber');
        if (configStr) invMgmtNumberConfig = JSON.parse(configStr);
      } catch (e) {}
      var firstSelect = document.getElementById('invMgmtSearchFirst');
      if (firstSelect) {
        var options = '<option value="">頭文字</option>';
        for (var i = 65; i <= 90; i++) { var char = String.fromCharCode(i); options += '<option value="' + char + '">' + char + '</option>'; }
        firstSelect.innerHTML = options;
      }
    }
    function invOnMgmtSearchFirstChange() {
      var firstSelect = document.getElementById('invMgmtSearchFirst');
      var secondSelect = document.getElementById('invMgmtSearchSecond');
      var firstChar = firstSelect.value;
      if (!firstChar) { secondSelect.innerHTML = '<option value="">棚番号</option>'; secondSelect.disabled = true; return; }
      var options = '<option value="">棚番号</option>';
      for (var i = 65; i <= 90; i++) { var char = String.fromCharCode(i); var shelfCode = firstChar + char; options += '<option value="' + shelfCode + '">' + shelfCode + '</option>'; }
      secondSelect.innerHTML = options;
      secondSelect.disabled = false;
    }
    function invOnMgmtSearchSecondChange() {}
    function invClearMgmtSearch() {
      document.getElementById('invMgmtSearchFirst').value = '';
      document.getElementById('invMgmtSearchSecond').value = '';
      document.getElementById('invMgmtSearchSecond').disabled = true;
      document.getElementById('invMgmtSearchSecond').innerHTML = '<option value="">棚番号</option>';
      document.getElementById('invMgmtSearchNumber').value = '';
      document.getElementById('invMgmtSearchValue').value = '';
    }

    // ===== Brand filter (Algolia) =====
    function invInitBrandFilter() {
      var input = document.getElementById('invFilterBrand');
      var suggestList = document.getElementById('invFilterBrandSuggestList');
      if (!input || !suggestList) return;
      if (typeof window.algoliasearch === 'undefined') return;
      var searchClient = window.algoliasearch(INV_ALGOLIA_APP_ID, INV_ALGOLIA_SEARCH_KEY);
      var index = searchClient.initIndex(INV_ALGOLIA_INDEX_NAME);
      var debounceTimer = null;
      invAddListener(input, 'input', function() {
        var query = input.value.trim();
        clearTimeout(debounceTimer);
        if (query.length < 1) { suggestList.style.display = 'none'; return; }
        debounceTimer = setTimeout(async function() {
          try {
            var convertedQuery = invHiraganaToKatakana(query);
            var results = await index.search(convertedQuery, { hitsPerPage: 10 });
            if (results.hits.length === 0) { suggestList.style.display = 'none'; return; }
            suggestList.innerHTML = results.hits.map(function(hit) {
              var displayName = hit.displayName || hit.name || hit.objectID;
              return '<div class="inv-suggest-item" data-value="' + invEscapeHtml(displayName) + '">' + invEscapeHtml(displayName) + '</div>';
            }).join('');
            suggestList.style.display = 'block';
          } catch (error) { console.error('Algolia検索エラー:', error); }
        }, 200);
      });
      invAddListener(suggestList, 'click', function(e) {
        if (e.target.classList.contains('inv-suggest-item')) { input.value = e.target.dataset.value; suggestList.style.display = 'none'; }
      });
      invAddListener(input, 'blur', function() { setTimeout(function() { suggestList.style.display = 'none'; }, 200); });
    }

    // ===== Filter dropdowns =====
    async function invInitFilterDropdowns() {
      if (!window.db) return;
      try {
        var db = window.db;

        var categorySelect = document.getElementById('invFilterCategory');
        if (categorySelect) {
          try {
            var catDocSnap = await db.collection('categories').doc('master').get();
            if (catDocSnap.exists) {
              var rows = catDocSnap.data().rows || [];
              var mainCategories = Array.from(new Set(rows.map(function(r) { return r['大分類']; }).filter(Boolean)));
              mainCategories.sort();
              mainCategories.forEach(function(cat) { var option = document.createElement('option'); option.value = cat; option.textContent = cat; categorySelect.appendChild(option); });
            }
          } catch (e) {}
        }

        var sizeSelect = document.getElementById('invFilterSize');
        var colorSelect = document.getElementById('invFilterColor');
        try {
          var snapshot = await db.collection('masterOptions').get();
          snapshot.forEach(function(docSnap) {
            var data = docSnap.data();
            if (data.fieldName === 'サイズ' && data.items && sizeSelect) {
              data.items.forEach(function(size) { var opt = document.createElement('option'); opt.value = size; opt.textContent = size; sizeSelect.appendChild(opt); });
            }
            if ((data.fieldName === 'カラー' || data.fieldName === 'カラー/配色/トーン') && data.items && colorSelect) {
              data.items.forEach(function(color) { var opt = document.createElement('option'); opt.value = color; opt.textContent = color; colorSelect.appendChild(opt); });
            }
          });
        } catch (e) {}
      } catch (error) { console.error('フィルタドロップダウン初期化エラー:', error); }
    }

    // ===== SPA内モーダル表示ヘルパー =====
    function invShowModal(modalId) {
      var el = document.getElementById(modalId);
      if (!el) return;
      // SPA内のモーダルをbodyに移動（backdropとの重なり防止）
      if (el.parentElement !== document.body) {
        document.body.appendChild(el);
      }
      var modal = bootstrap.Modal.getOrCreateInstance(el);
      modal.show();
    }

    // ===== View product detail =====
    function invViewProduct(managementNumber) {
      invShowLoading();
      window.FirestoreApi.getProductByManagementNumber(managementNumber).then(function(product) {
        invHideLoading();
        if (product) {
          invCurrentProduct = product;
          invDisplayProductDetail(product);
          invShowModal('invProductDetailModal');
        } else { invShowError('商品詳細の取得エラー: 商品が見つかりません'); }
      }).catch(function(error) { invHideLoading(); invShowError('商品詳細の取得エラー: ' + (error.message || error)); });
    }

    function invDisplayProductDetail(product) {
      var container = document.getElementById('invProductDetailBody');
      var isEditable = (product.status === '登録済み' || product.status === '出品準備中');

      // Images
      var imagesToDisplay = (product.images && product.images.length > 0) ? product.images : [product.imageUrl1, product.imageUrl2, product.imageUrl3].filter(function(url) { return url; });
      inv_currentProductImages = imagesToDisplay;

      var imageBlockHtml = '';
      if (imagesToDisplay.length > 0) {
        imageBlockHtml = '<div id="invThumbnailContainer" style="display: flex; gap: 8px; overflow-x: auto; padding: 4px 0; -webkit-overflow-scrolling: touch;">';
        imagesToDisplay.forEach(function(url, index) {
          var thumbUrl = invGetThumbUrl(url);
          imageBlockHtml += '<div class="inv-thumb-wrapper loading" data-index="' + index + '" style="width: 56px; height: 56px; flex-shrink: 0; border: 2px solid #e0e0e0; border-radius: 6px; cursor: pointer; background: #f5f5f5; position: relative;">';
          imageBlockHtml += '<img src="' + thumbUrl + '" data-index="' + index + '" data-original="' + url + '" style="width: 100%; height: 100%; object-fit: cover; display: block; border-radius: 4px;" alt="" onload="this.classList.add(\'loaded\'); this.parentElement.classList.remove(\'loading\');" onerror="this.src=\'' + url + '\'">';
          imageBlockHtml += '</div>';
        });
        imageBlockHtml += '</div>';
        imageBlockHtml += '<div class="text-muted small mt-1" style="text-align: center;">' + imagesToDisplay.length + '枚（タップで拡大・スワイプで切替）</div>';
      } else {
        imageBlockHtml = '<div style="width: 100%; height: 70px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; border-radius: 8px; color: #6c757d;"><span><i class="bi bi-image me-1"></i>画像なし</span></div>';
      }

      var statusOptions = ['登録済み', '出品準備中', '出品中', '販売済み', '取り下げ'];
      var statusSelectHtml = '<select class="form-select" id="invProductStatus">';
      statusOptions.forEach(function(s) { statusSelectHtml += '<option value="' + s + '"' + (s === product.status ? ' selected' : '') + '>' + s + '</option>'; });
      statusSelectHtml += '</select>';

      var createField = function(value, fieldName, fieldType) {
        fieldType = fieldType || 'text';
        if (isEditable) {
          if (fieldType === 'textarea') return '<textarea class="form-control form-control-sm" id="' + fieldName + '" rows="4">' + (value || '') + '</textarea>';
          if (fieldType === 'number') return '<input type="number" class="form-control form-control-sm" id="' + fieldName + '" value="' + (value || '') + '" min="0">';
          return '<input type="text" class="form-control form-control-sm" id="' + fieldName + '" value="' + (value || '') + '">';
        }
        if (fieldType === 'textarea') return '<div class="form-control-plaintext" style="white-space: pre-wrap;">' + (value || '-') + '</div>';
        if (fieldType === 'number') return '<div class="form-control-plaintext">' + invFormatCurrency(value) + '</div>';
        return '<div class="form-control-plaintext">' + (value || '-') + '</div>';
      };

      var catHierarchy = [product.superCategory, product.category, product.categoryMiddle, product.categoryMinor, product.categoryDetail1, product.categoryDetail2].filter(function(v) { return v && v.trim(); }).join(' > ') || '-';
      var rankDisplay = product.rank ? (product.rank.code ? product.rank.code + ' - ' + (product.rank.name || '') : product.rank) : '-';
      var salesTypeDisplay = product.salesType === 'auction' ? 'オークション形式' : (product.salesType === 'fixed' ? '価格を設定する' : '-');

      container.innerHTML = '<div class="row g-3">'
        + '<div class="col-12"><h6 class="border-bottom pb-2"><i class="bi bi-info-circle me-1"></i>基本情報</h6></div>'
        + '<div class="col-6"><label class="form-label fw-bold small mb-0">管理番号</label><div class="form-control-plaintext pt-0" style="font-size: 15px; font-weight: 600;">' + (product.managementNumber || '-') + '</div></div>'
        + '<div class="col-6"><label class="form-label fw-bold small mb-0">ステータス</label>' + statusSelectHtml + '</div>'
        + '<div class="col-6"><label class="form-label fw-bold small">担当者</label><div class="form-control-plaintext">' + (product.person || '-') + '</div></div>'
        + '<div class="col-12"><h6 class="border-bottom pb-2 mt-2"><i class="bi bi-tag me-1"></i>商品情報 ' + (isEditable ? '<span class="badge bg-success small">編集可能</span>' : '') + '</h6></div>'
        + '<div class="col-12"><label class="form-label fw-bold small">ブランド</label>' + createField(product.brand, 'invProductBrand') + '</div>'
        + '<div class="col-12"><label class="form-label fw-bold small">商品名(タイトル)</label>' + (isEditable ? '<textarea class="form-control form-control-sm" id="invProductName" rows="2">' + (product.productName || '') + '</textarea>' : '<div class="form-control-plaintext" style="word-break: break-all; white-space: normal;">' + (product.productName || '-') + '</div>') + '</div>'
        + '<div class="col-12"><label class="form-label fw-bold small">カテゴリー</label><div class="form-control-plaintext" style="font-size: 13px; line-height: 1.4;">' + catHierarchy + '</div></div>'
        + '<div class="col-6"><label class="form-label fw-bold small">サイズ</label>' + createField(product.size, 'invProductSize') + '</div>'
        + '<div class="col-6"><label class="form-label fw-bold small">商品の状態</label><div class="form-control-plaintext">' + (product.condition || '-') + '</div></div>'
        + '<div class="col-6"><label class="form-label fw-bold small">ランク</label><div class="form-control-plaintext">' + rankDisplay + '</div></div>'
        + '<div class="col-12"><label class="form-label fw-bold small" onclick="invToggleDescription()" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; user-select: none;">商品の説明 <span id="invDescToggleIcon" style="font-size: 12px; color: #6b7280;">&#9660; 全文表示</span></label>'
        + '<div id="invDescriptionDetailContainer" style="max-height: 100px; overflow: hidden; position: relative;">'
        + (isEditable ? '<textarea class="form-control form-control-sm" id="invProductDescription" rows="6">' + (product.productDescription || '') + '</textarea>' : '<div class="form-control-plaintext" style="white-space: pre-wrap; background: #f8f9fa; padding: 10px; border-radius: 6px; font-size: 13px; line-height: 1.5;">' + (product.productDescription || '-') + '</div>')
        + '<div id="invDescFadeOverlay" style="position: absolute; bottom: 0; left: 0; right: 0; height: 30px; background: linear-gradient(transparent, #f8f9fa); pointer-events: none;"></div>'
        + '</div></div>'
        + '<div class="col-12"><h6 class="border-bottom pb-2 mt-2"><i class="bi bi-images me-1"></i>画像情報</h6></div>'
        + '<div class="col-12">' + imageBlockHtml + '</div>'
        + (product.damageMarker && product.damageMarker.image ? '<div class="col-12"><h6 class="border-bottom pb-2 mt-2"><i class="bi bi-exclamation-triangle me-1"></i>傷・汚れマーキング</h6></div><div class="col-12"><div style="background: #fffbeb; border: 1px solid #fcd34d; border-radius: 8px; padding: 12px;"><div style="font-size: 12px; color: #78716c; margin-bottom: 8px;">' + (product.damageMarker.type || '') + '</div><img src="' + product.damageMarker.image + '" alt="傷・汚れマーキング" style="max-width: 100%; border-radius: 6px; border: 1px solid #e5e7eb;">' + (product.damageMarker.note ? '<div style="margin-top: 8px; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e5e7eb;"><div style="font-size: 11px; color: #78716c; margin-bottom: 4px;">補足説明</div><div style="font-size: 13px; color: #374151; white-space: pre-wrap;">' + product.damageMarker.note + '</div></div>' : '') + '</div></div>' : '')
        + '<div class="col-12"><h6 class="border-bottom pb-2 mt-2"><i class="bi bi-cart me-1"></i>仕入情報 ' + (isEditable ? '<span class="badge bg-success small">編集可能</span>' : '') + '</h6></div>'
        + '<div class="col-6"><label class="form-label fw-bold small">仕入日</label><div class="form-control-plaintext">' + invFormatDate(product.purchaseDate) + '</div></div>'
        + '<div class="col-6"><label class="form-label fw-bold small">仕入先</label><div class="form-control-plaintext">' + (product.supplier || '-') + '</div></div>'
        + '<div class="col-6"><label class="form-label fw-bold small">仕入金額</label>' + createField(product.purchaseAmount, 'invPurchaseAmount', 'number') + '</div>'
        + '<div class="col-12"><h6 class="border-bottom pb-2 mt-2"><i class="bi bi-megaphone me-1"></i>出品情報 ' + (isEditable ? '<span class="badge bg-success small">編集可能</span>' : '') + '</h6></div>'
        + '<div class="col-6"><label class="form-label fw-bold small">出品日</label><div class="form-control-plaintext">' + invFormatDate(product.listingDate) + '</div></div>'
        + '<div class="col-6"><label class="form-label fw-bold small">出品先</label><div class="form-control-plaintext">' + (product.listingDestination || '-') + '</div></div>'
        + '<div class="col-6"><label class="form-label fw-bold small">販売タイプ</label><div class="form-control-plaintext">' + salesTypeDisplay + '</div></div>'
        + '<div class="col-6"><label class="form-label fw-bold small">出品金額</label>' + createField(product.listingAmount, 'invListingAmount', 'number') + '</div>'
        + '<div class="col-12"><h6 class="border-bottom pb-2 mt-2"><i class="bi bi-currency-yen me-1"></i>販売情報</h6></div>'
        + '<div class="col-6"><label class="form-label fw-bold small">販売日</label><div class="form-control-plaintext">' + invFormatDate(product.saleDate) + '</div></div>'
        + '<div class="col-6"><label class="form-label fw-bold small">販売先</label><div class="form-control-plaintext">' + (product.salePlatform || '-') + '</div></div>'
        + '<div class="col-6"><label class="form-label fw-bold small">販売金額</label><div class="form-control-plaintext">' + invFormatCurrency(product.saleAmount) + '</div></div>'
        + '<div class="col-6"><label class="form-label fw-bold small">利益金額</label><div class="form-control-plaintext text-success fw-bold">' + invFormatCurrency(product.profit) + '</div></div>'
        + '<div class="col-6"><label class="form-label fw-bold small">在庫日数</label><div class="form-control-plaintext">' + (product.inventoryDays ? product.inventoryDays + '日' : '-') + '</div></div>'
        + '</div>';

      // Description toggle is handled by window.invToggleDescription (inline onclick)

      // Lightbox setup
      invSetupLightbox();

      var thumbnailContainer = document.getElementById('invThumbnailContainer');
      if (thumbnailContainer) {
        thumbnailContainer.onclick = function(e) {
          var thumbWrapper = e.target.closest('.inv-thumb-wrapper');
          if (!thumbWrapper && e.target.tagName === 'IMG') thumbWrapper = e.target.parentElement;
          if (thumbWrapper && thumbWrapper.dataset.index !== undefined) {
            var clickedIndex = parseInt(thumbWrapper.dataset.index, 10);
            if (inv_currentProductImages && inv_currentProductImages[clickedIndex]) {
              invShowLightboxImage(clickedIndex);
              document.getElementById('invImageLightbox').style.display = 'flex';
            }
          }
        };
      }
    }

    // ===== Lightbox =====
    function invShowLightboxImage(index) {
      var images = inv_currentProductImages;
      var lb = document.getElementById('invImageLightbox');
      var lbImg = document.getElementById('invLightboxImage');
      var lbCounter = document.getElementById('invLightboxCounter');
      if (!images || !images[index]) return;
      lb.dataset.currentIndex = index;
      lbImg.src = images[index];
      lbCounter.textContent = (index + 1) + '/' + images.length;
      var lbPrev = lb.querySelector('.inv-lightbox-prev');
      var lbNext = lb.querySelector('.inv-lightbox-next');
      if (lbPrev) lbPrev.style.display = images.length > 1 ? 'block' : 'none';
      if (lbNext) lbNext.style.display = images.length > 1 ? 'block' : 'none';
    }
    function invShowNextImage() {
      var images = inv_currentProductImages;
      var lb = document.getElementById('invImageLightbox');
      if (!images) return;
      var idx = (parseInt(lb.dataset.currentIndex || 0, 10) + 1) % images.length;
      invShowLightboxImage(idx);
    }
    function invShowPrevImage() {
      var images = inv_currentProductImages;
      var lb = document.getElementById('invImageLightbox');
      if (!images) return;
      var idx = (parseInt(lb.dataset.currentIndex || 0, 10) - 1 + images.length) % images.length;
      invShowLightboxImage(idx);
    }
    window.invToggleDescription = function() {
      var cnt = document.getElementById('invDescriptionDetailContainer');
      var icon = document.getElementById('invDescToggleIcon');
      var overlay = document.getElementById('invDescFadeOverlay');
      if (!cnt) return;
      var isCollapsed = !cnt.dataset.expanded || cnt.dataset.expanded === 'false';
      if (isCollapsed) {
        cnt.style.cssText = 'position: relative;';
        cnt.dataset.expanded = 'true';
        if (icon) icon.innerHTML = '&#9650; 閉じる';
        if (overlay) overlay.style.display = 'none';
        // 内部のテキスト要素のmax-heightも解除
        var inner = cnt.querySelector('.form-control-plaintext');
        if (inner) inner.style.cssText = inner.style.cssText + '; max-height: none; overflow: visible;';
        var ta = cnt.querySelector('textarea');
        if (ta) { ta.style.height = 'auto'; ta.style.height = ta.scrollHeight + 'px'; ta.rows = 20; }
      } else {
        cnt.style.cssText = 'max-height: 100px; overflow: hidden; position: relative;';
        cnt.dataset.expanded = 'false';
        if (icon) icon.innerHTML = '&#9660; 全文表示';
        if (overlay) overlay.style.display = 'block';
      }
    };

    function invCloseLightbox() {
      document.getElementById('invImageLightbox').style.display = 'none';
    }

    function invSetupLightbox() {
      if (inv_lightboxListenersInitialized) return;
      var lightbox = document.getElementById('invImageLightbox');
      if (!lightbox) return;
      var lightboxClose = lightbox.querySelector('.inv-lightbox-close');
      var lightboxPrev = lightbox.querySelector('.inv-lightbox-prev');
      var lightboxNext = lightbox.querySelector('.inv-lightbox-next');
      if (lightboxClose) invAddListener(lightboxClose, 'click', invCloseLightbox);
      invAddListener(lightbox, 'click', function(e) { if (e.target === lightbox) invCloseLightbox(); });
      if (lightboxPrev) invAddListener(lightboxPrev, 'click', function(e) { e.stopPropagation(); invShowPrevImage(); });
      if (lightboxNext) invAddListener(lightboxNext, 'click', function(e) { e.stopPropagation(); invShowNextImage(); });
      var touchStartX = 0;
      invAddListener(lightbox, 'touchstart', function(e) { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
      invAddListener(lightbox, 'touchend', function(e) {
        var diff = touchStartX - e.changedTouches[0].screenX;
        if (Math.abs(diff) > 50) { if (diff > 0) invShowNextImage(); else invShowPrevImage(); }
      }, { passive: true });
      inv_lightboxListenersInitialized = true;
    }

    // ===== Stock edit =====
    function invOpenStockEditModal(managementNumber, currentStock) {
      document.getElementById('invStockEditManagementNumber').value = managementNumber;
      document.getElementById('invStockEditProductInfo').textContent = managementNumber;
      document.getElementById('invStockEditQuantity').value = currentStock;
      invShowModal('invStockEditModal');
    }
    function invAdjustStock(delta) {
      var input = document.getElementById('invStockEditQuantity');
      input.value = Math.max(0, parseInt(input.value || 0) + delta);
    }
    async function invSaveStockQuantity() {
      var managementNumber = document.getElementById('invStockEditManagementNumber').value;
      var newQuantity = parseInt(document.getElementById('invStockEditQuantity').value) || 0;
      invShowLoading();
      try {
        var db = window.db;
        var serverTs = firebase.firestore.FieldValue.serverTimestamp;

        var snapshot = await db.collection('products').where('managementNumber', '==', managementNumber).limit(1).get();
        if (!snapshot.empty) {
          var productDoc = snapshot.docs[0];
          var productData = productDoc.data();
          await productDoc.ref.update({ stockQuantity: newQuantity, updatedAt: serverTs() });
          if (productData.skuId) {
            await db.collection('skus').doc(productData.skuId).update({ currentStock: newQuantity, updatedAt: serverTs() });
          }
          invHideLoading();
          bootstrap.Modal.getInstance(document.getElementById('invStockEditModal')).hide();
          alert('在庫数を更新しました\n\n' + managementNumber + ': ' + newQuantity + '点');
          invLoadDashboardAndSearch();
        } else { invHideLoading(); alert('商品が見つかりませんでした'); }
      } catch (error) { invHideLoading(); alert('在庫の更新に失敗しました: ' + error.message); }
    }

    // ===== Duplicate product (Firestore直接操作) =====
    async function invDuplicateProduct(managementNumber) {
      if (!confirm('商品「' + managementNumber + '」を複製しますか？')) return;
      invShowLoading();
      try {
        var db = window.db;
        var serverTs = firebase.firestore.FieldValue.serverTimestamp;

        // managementNumberフィールドで元商品を検索
        var sourceSnap = await db.collection('products').where('managementNumber', '==', managementNumber).limit(1).get();
        if (sourceSnap.empty) { invHideLoading(); invShowError('元の商品が見つかりません'); return; }
        var sourceData = sourceSnap.docs[0].data();

        // 新しい管理番号を生成（元の番号 + -C + 連番）
        var newManagementNumber;
        var suffix = 1;
        while (suffix <= 99) {
          newManagementNumber = managementNumber + '-C' + suffix;
          var existCheck = await db.collection('products').where('managementNumber', '==', newManagementNumber).limit(1).get();
          if (existCheck.empty) break;
          suffix++;
        }
        if (suffix > 99) { throw new Error('複製番号の生成に失敗しました'); }

        // 新ドキュメント作成（ステータス・販売情報リセット、IDは自動生成）
        var newData = Object.assign({}, sourceData, {
          managementNumber: newManagementNumber,
          status: '登録済み',
          saleDate: '', saleAmount: 0, profit: 0, profitRate: '',
          listingDate: '', listingAmount: 0,
          createdAt: serverTs(), updatedAt: serverTs()
        });
        if (newData.listing) { newData.listing = { date: '', amount: 0 }; }
        if (newData.sale) { delete newData.sale; }
        await db.collection('products').add(newData);

        invHideLoading();
        alert('商品を複製しました！\n新しい管理番号: ' + newManagementNumber);
        invLoadDashboardAndSearch();
      } catch (error) { invHideLoading(); invShowError('複製エラー: ' + (error.message || error)); }
    }

    // ===== Save product status =====
    async function invSaveProductStatus() {
      if (!invCurrentProduct) { invShowError('商品データが見つかりません'); return; }
      var newStatus = document.getElementById('invProductStatus').value;
      var oldStatus = invCurrentProduct.status;
      var isEditable = (oldStatus === '登録済み' || oldStatus === '出品準備中');
      var changedFields = [];
      if (isEditable) {
        var fieldMappings = [
          { id: 'invProductBrand', apiName: 'ブランド', oldValue: invCurrentProduct.brand },
          { id: 'invProductName', apiName: '商品名', oldValue: invCurrentProduct.productName },
          { id: 'invProductSize', apiName: 'サイズ', oldValue: invCurrentProduct.size },
          { id: 'invProductDescription', apiName: '商品説明', oldValue: invCurrentProduct.productDescription },
          { id: 'invPurchaseAmount', apiName: '仕入金額', oldValue: invCurrentProduct.purchaseAmount, isNumber: true },
          { id: 'invListingAmount', apiName: '出品金額', oldValue: invCurrentProduct.listingAmount, isNumber: true }
        ];
        fieldMappings.forEach(function(field) {
          var element = document.getElementById(field.id);
          if (element) {
            var newValue = element.value.trim();
            if (field.isNumber) newValue = newValue ? parseFloat(newValue) : '';
            if (String(newValue) !== String(field.oldValue || '')) changedFields.push({ field: field.apiName, value: newValue });
          }
        });
      }
      var statusChanged = (newStatus !== oldStatus);
      if (!statusChanged && changedFields.length === 0) { alert('変更がありません'); return; }

      var confirmMessage = '';
      if (statusChanged && changedFields.length > 0) confirmMessage = 'ステータスを「' + oldStatus + '」から「' + newStatus + '」に変更し、' + changedFields.length + '件のフィールドを更新しますか？';
      else if (statusChanged) confirmMessage = 'ステータスを「' + oldStatus + '」から「' + newStatus + '」に変更しますか？';
      else confirmMessage = changedFields.length + '件のフィールドを更新しますか？';
      if (!confirm(confirmMessage)) return;

      invShowLoading();
      try {
        var db = window.db;
        var serverTs = firebase.firestore.FieldValue.serverTimestamp;

        // invCurrentProduct.id は getProductByManagementNumber が返すFirestoreドキュメントID
        var updateData = { updatedAt: serverTs() };
        if (statusChanged) { updateData.status = newStatus; }

        // フィールド名マッピング（UI apiName → Firestoreフィールド）
        var fieldMapping = { 'ブランド': 'brand', '商品名': 'productName', 'サイズ': 'size', '商品説明': 'description', '仕入金額': 'purchaseAmount', '出品金額': 'listingAmount' };
        changedFields.forEach(function(change) {
          var firestoreField = fieldMapping[change.field] || change.field;
          updateData[firestoreField] = change.value;
        });

        await db.collection('products').doc(invCurrentProduct.id).update(updateData);
        invCompleteProductUpdate(statusChanged, newStatus, oldStatus);
      } catch (error) { invHideLoading(); invShowError('更新エラー: ' + (error.message || error)); }
    }

    function invCompleteProductUpdate(statusChanged, newStatus, oldStatus) {
      invHideLoading();
      alert('商品情報を更新しました');
      if (statusChanged && newStatus === '出品中' && oldStatus !== '出品中') {
        invAddListingApprovalTask(invCurrentProduct);
      }
      var modalElement = document.getElementById('invProductDetailModal');
      var modal = bootstrap.Modal.getInstance(modalElement);
      if (modal) modal.hide();
      invLoadDashboardAndSearch();
    }

    async function invAddListingApprovalTask(product) {
      try {
        var staffName = product.createdBy || localStorage.getItem('reborn_user_name') || '不明';
        var productId = product.id || product.productId;
        var taskData = {
          type: 'listing_approval', title: '出品確認',
          description: staffName + 'さんが商品を出品しました。\n管理番号: ' + product.managementNumber + '\n確認してOKなら完了にしてください。',
          link: '/product.html?edit=' + productId,
          relatedData: { productId: productId, managementNumber: product.managementNumber, staffName: staffName, listingAmount: product.listingAmount || 0 }
        };
        if (typeof addTaskToOwners === 'function') {
          addTaskToOwners(taskData);
        } else if (window.parent && window.parent !== window) {
          window.parent.postMessage({ type: 'addTaskToOwners', taskData: taskData }, '*');
        }
      } catch (error) { console.error('[inv] タスク追加エラー:', error); }
    }

    // ===== Sales record modal =====
    function invOpenSalesRecordModal(managementNumber) {
      invShowLoading();
      window.FirestoreApi.getProductByManagementNumber(managementNumber).then(function(product) {
        if (product) { invCurrentSalesProduct = product; invInitSalesRecordModal(); }
        else { invHideLoading(); invShowError('商品データの取得に失敗しました'); }
      }).catch(function(error) { invHideLoading(); invShowError('商品データの取得エラー: ' + (error.message || error)); });
    }

    function invInitSalesRecordModal() {
      invPackagingMaterialCount = 3;
      document.getElementById('invSalesDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('invSalesAmount').value = '';
      invLoadShippingMethodMaster();
      invLoadPackagingMaterialsMaster();
      invLoadSalesChannelsMaster();
      invSetupSalesRecordEventListeners();
      invHideLoading();
      invShowModal('invSalesRecordModal');
    }

    async function invLoadShippingMethodMaster() {
      try { invShippingMethodMaster = await invGetShippingMethodMaster(); invPopulateShippingMethod1(); }
      catch (error) { invShowError('発送方法マスタの読み込みに失敗しました: ' + (error.message || error)); }
    }
    async function invLoadPackagingMaterialsMaster() {
      try {
        var result = await invGetPackagingMaterialsMaster();
        invPackagingMaterialsByCategory = result.data;
        invPackagingMaterialCategories = result.categories;
        invRenderPackagingMaterials();
      } catch (error) { invShowError('備品在庫リストの読み込みに失敗しました: ' + (error.message || error)); }
    }
    async function invLoadSalesChannelsMaster() {
      try { invSalesChannelsMaster = await invGetSalesChannelsMaster(); invPopulateSalesChannels(); }
      catch (error) {
        var select = document.getElementById('invSalesPlatform');
        select.innerHTML = '<option value="">選択してください</option><option value="メルカリ">メルカリ</option><option value="ラクマ">ラクマ</option><option value="Yahoo!フリマ">Yahoo!フリマ</option><option value="その他">その他</option>';
      }
    }

    function invPopulateSalesChannels() {
      var select = document.getElementById('invSalesPlatform');
      select.innerHTML = '<option value="">選択してください</option>';
      invSalesChannelsMaster.forEach(function(channel) {
        if (channel.active !== false) {
          var option = document.createElement('option');
          option.value = channel.name;
          option.dataset.platformId = channel.platformId;
          option.dataset.feeType = channel.feeType || 'simple';
          option.textContent = channel.name;
          select.appendChild(option);
        }
      });
    }

    function invOnSalesPlatformChange() {
      var select = document.getElementById('invSalesPlatform');
      var container = document.getElementById('invFeeTypeInputContainer');
      var platformName = select.value;
      var channelData = invSalesChannelsMaster.find(function(c) { return c.name === platformName; });
      if (!channelData || !platformName) { container.style.display = 'none'; invCurrentSelectedFeeRate = null; invUpdateProfitCalculation(); return; }
      var feeType = channelData.feeType || 'simple';
      switch (feeType) {
        case 'simple':
          container.style.display = 'none';
          invCurrentSelectedFeeRate = channelData.commission || 0;
          break;
        case 'variable':
          var defaultRate = channelData.commissionDefault || channelData.commissionMax || 10;
          container.style.display = 'block';
          container.innerHTML = '<div class="card border-warning bg-warning bg-opacity-10"><div class="card-body py-2"><div class="d-flex justify-content-between align-items-center mb-2"><div class="d-flex align-items-center"><i class="bi bi-graph-up text-warning me-2"></i><small class="fw-bold">現在の設定: <span class="text-warning">' + defaultRate + '%</span></small></div><span class="badge bg-warning text-dark fs-6" id="invVariableFeeValue">' + defaultRate + '%</span></div><div class="d-flex align-items-center gap-2"><span class="text-muted small">' + (channelData.commissionMin || 4.5) + '%</span><input type="range" class="form-range flex-grow-1" id="invVariableFeeSlider" min="' + (channelData.commissionMin || 4.5) + '" max="' + (channelData.commissionMax || 10) + '" step="0.5" value="' + defaultRate + '"><span class="text-muted small">' + (channelData.commissionMax || 10) + '%</span></div></div></div>';
          invCurrentSelectedFeeRate = defaultRate;
          document.getElementById('invVariableFeeSlider').addEventListener('input', function() {
            invCurrentSelectedFeeRate = parseFloat(this.value);
            document.getElementById('invVariableFeeValue').textContent = this.value + '%';
            invUpdateProfitCalculation();
          });
          break;
        case 'complex':
          container.style.display = 'block';
          container.innerHTML = '<div class="card border-info bg-info bg-opacity-10"><div class="card-body py-2"><div class="d-flex align-items-center"><i class="bi bi-calculator text-info me-2"></i><div><small class="text-muted">複合計算式：</small><span class="fw-bold">' + (channelData.commissionFormula || '要確認') + '</span></div></div></div></div>';
          invCurrentSelectedFeeRate = invParseComplexFormula(channelData.commissionFormula, 0);
          break;
        case 'manual':
          container.style.display = 'block';
          container.innerHTML = '<div class="card border-secondary"><div class="card-body py-2"><div class="d-flex align-items-center mb-2"><i class="bi bi-pencil text-secondary me-2"></i><small class="text-muted">手動入力が必要なプラットフォームです</small></div><div class="input-group input-group-sm"><span class="input-group-text">手数料率</span><input type="number" class="form-control" id="invManualFeeInput" min="0" max="100" step="0.1" value="' + (channelData.feeEstimate || 10) + '" placeholder="例: 10"><span class="input-group-text">%</span></div></div></div>';
          invCurrentSelectedFeeRate = channelData.feeEstimate || 10;
          document.getElementById('invManualFeeInput').addEventListener('input', function() {
            invCurrentSelectedFeeRate = parseFloat(this.value) || 0;
            invUpdateProfitCalculation();
          });
          break;
        default:
          container.style.display = 'none';
          invCurrentSelectedFeeRate = 0;
      }
      invUpdateProfitCalculation();
    }

    function invParseComplexFormula(formula, salesAmount) {
      if (!formula) return 0;
      var percentPattern = /([\d.]+)%/g;
      var fixedPattern = /([\d,]+)円/g;
      var match;
      var totalPercent = 0;
      while ((match = percentPattern.exec(formula)) !== null) totalPercent += parseFloat(match[1]);
      var totalFixed = 0;
      while ((match = fixedPattern.exec(formula)) !== null) totalFixed += parseInt(match[1].replace(/,/g, ''));
      if (salesAmount > 0) return ((salesAmount * totalPercent / 100) + totalFixed) / salesAmount * 100;
      return totalPercent;
    }

    function invPopulateShippingMethod1() {
      var select = document.getElementById('invShippingMethod1');
      var cats = []; invShippingMethodMaster.forEach(function(item) { if (cats.indexOf(item.method1) === -1) cats.push(item.method1); });
      select.innerHTML = '<option value="">選択してください</option>';
      cats.forEach(function(category) { var opt = document.createElement('option'); opt.value = category; opt.textContent = category; select.appendChild(opt); });
    }
    function invOnShippingMethod1Change() {
      var method1 = document.getElementById('invShippingMethod1').value;
      var select2 = document.getElementById('invShippingMethod2');
      if (!method1) { select2.disabled = true; select2.innerHTML = '<option value="">まず発送方法を選択してください</option>'; document.getElementById('invShippingFee').value = ''; invUpdateProfitCalculation(); return; }
      var options = invShippingMethodMaster.filter(function(item) { return item.method1 === method1; });
      select2.disabled = false;
      select2.innerHTML = '<option value="">選択してください</option>';
      options.forEach(function(item) { var opt = document.createElement('option'); opt.value = item.method2; opt.dataset.fee = item.fee; opt.textContent = item.method2; select2.appendChild(opt); });
    }
    function invOnShippingMethod2Change() {
      var select2 = document.getElementById('invShippingMethod2');
      var selectedOption = select2.options[select2.selectedIndex];
      if (selectedOption && selectedOption.dataset.fee) { document.getElementById('invShippingFee').value = selectedOption.dataset.fee; invUpdateProfitCalculation(); }
    }

    function invRenderPackagingMaterials() {
      var container = document.getElementById('invPackagingMaterialsContainer');
      if (!container) return;
      container.innerHTML = '';
      for (var i = 1; i <= invPackagingMaterialCount; i++) {
        var div = document.createElement('div');
        div.className = 'mb-3 p-2 border rounded';
        div.innerHTML = '<div class="row g-2"><div class="col-md-4"><label class="form-label small">カテゴリ</label><select class="form-select form-select-sm" id="invPackagingCategory' + i + '"><option value="">選択してください</option></select></div><div class="col-md-5"><label class="form-label small">梱包資材' + i + '</label><select class="form-select form-select-sm" id="invPackagingMaterial' + i + '" disabled><option value="">カテゴリを選択してください</option></select></div><div class="col-md-3"><label class="form-label small">単価</label><input type="text" class="form-control form-control-sm bg-light" id="invPackagingCost' + i + '" readonly></div></div>';
        container.appendChild(div);
        invPopulatePackagingCategory(i);
      }
    }
    function invPopulatePackagingCategory(index) {
      var select = document.getElementById('invPackagingCategory' + index);
      if (!select) return;
      select.innerHTML = '<option value="">選択してください</option>';
      invPackagingMaterialCategories.forEach(function(category) { var opt = document.createElement('option'); opt.value = category; opt.textContent = category; select.appendChild(opt); });
      select.addEventListener('change', function() { invOnPackagingCategoryChange(index); });
    }
    function invOnPackagingCategoryChange(index) {
      var categorySelect = document.getElementById('invPackagingCategory' + index);
      var materialSelect = document.getElementById('invPackagingMaterial' + index);
      var category = categorySelect.value;
      if (!category) { materialSelect.disabled = true; materialSelect.innerHTML = '<option value="">カテゴリを選択してください</option>'; document.getElementById('invPackagingCost' + index).value = ''; invUpdatePackagingCostTotal(); invUpdateProfitCalculation(); return; }
      var materials = invPackagingMaterialsByCategory[category] || [];
      materialSelect.disabled = false;
      materialSelect.innerHTML = '<option value="">選択してください</option>';
      materials.forEach(function(item) { var opt = document.createElement('option'); opt.value = item.productName; opt.dataset.cost = item.unitCost; opt.dataset.materialId = item.id; opt.textContent = item.productName; materialSelect.appendChild(opt); });
      if (!materialSelect.dataset.listenerSet) {
        materialSelect.addEventListener('change', function() { invOnPackagingMaterialChange(index); });
        materialSelect.dataset.listenerSet = 'true';
      }
    }
    function invOnPackagingMaterialChange(index) {
      var materialSelect = document.getElementById('invPackagingMaterial' + index);
      var selectedOption = materialSelect.options[materialSelect.selectedIndex];
      var costInput = document.getElementById('invPackagingCost' + index);
      costInput.value = (selectedOption && selectedOption.dataset.cost) ? '\u00a5' + selectedOption.dataset.cost : '';
      invUpdatePackagingCostTotal();
      invUpdateProfitCalculation();
    }
    function invUpdatePackagingCostTotal() {
      var total = 0;
      for (var i = 1; i <= invPackagingMaterialCount; i++) {
        var select = document.getElementById('invPackagingMaterial' + i);
        if (!select) continue;
        var selectedOption = select.options[select.selectedIndex];
        if (selectedOption && selectedOption.dataset.cost) total += parseFloat(selectedOption.dataset.cost);
      }
      document.getElementById('invTotalPackagingCost').textContent = '\u00a5' + total.toFixed(2);
      return total;
    }
    function invUpdateProfitCalculation() {
      var salesAmount = parseFloat(document.getElementById('invSalesAmount').value) || 0;
      document.getElementById('invProfitSalesAmount').textContent = '\u00a5' + salesAmount.toLocaleString();
      var purchaseAmountValue = String((invCurrentSalesProduct && invCurrentSalesProduct.purchaseAmount) || '0').replace(/[\u00a5,]/g, '');
      var purchaseCost = parseFloat(purchaseAmountValue) || 0;
      document.getElementById('invProfitPurchaseCost').textContent = '- \u00a5' + purchaseCost.toLocaleString();
      var platformFeeRate = invGetPlatformFeeRate(document.getElementById('invSalesPlatform').value, salesAmount);
      document.getElementById('invPlatformFeeRate').textContent = platformFeeRate;
      var platformFee = Math.floor(salesAmount * (platformFeeRate / 100));
      document.getElementById('invProfitPlatformFee').textContent = '- \u00a5' + platformFee.toLocaleString();
      var paymentFee = 0;
      document.getElementById('invProfitPaymentFee').textContent = '- \u00a5' + paymentFee.toLocaleString();
      var shippingFee = parseFloat(document.getElementById('invShippingFee').value) || 0;
      document.getElementById('invProfitShippingFee').textContent = '- \u00a5' + shippingFee.toLocaleString();
      var packagingCost = invUpdatePackagingCostTotal();
      document.getElementById('invProfitPackagingCost').textContent = '- \u00a5' + packagingCost.toFixed(2);
      var finalProfit = salesAmount - purchaseCost - platformFee - paymentFee - shippingFee - packagingCost;
      var finalProfitElement = document.getElementById('invFinalProfit');
      finalProfitElement.textContent = '\u00a5' + Math.round(finalProfit).toLocaleString();
      finalProfitElement.className = finalProfit >= 0 ? 'text-end text-success fw-bold' : 'text-end text-danger fw-bold';
    }
    function invGetPlatformFeeRate(platform, salesAmount) {
      if (invCurrentSelectedFeeRate !== null) {
        var channelData = invSalesChannelsMaster.find(function(c) { return c.name === platform; });
        if (channelData && channelData.feeType === 'complex' && salesAmount > 0) return invParseComplexFormula(channelData.commissionFormula, salesAmount);
        return invCurrentSelectedFeeRate;
      }
      var channelData2 = invSalesChannelsMaster.find(function(c) { return c.name === platform; });
      if (channelData2) {
        switch (channelData2.feeType) {
          case 'simple': return channelData2.commission || 0;
          case 'variable': return channelData2.commissionDefault || channelData2.commissionMax || 10;
          case 'complex': return salesAmount > 0 ? invParseComplexFormula(channelData2.commissionFormula, salesAmount) : invParseComplexFormula(channelData2.commissionFormula, 0);
          case 'manual': return channelData2.feeEstimate || 10;
          default: return 0;
        }
      }
      var fallbackRates = { 'メルカリ': 10, 'メルカリShops': 10, 'ラクマ': 10, 'Yahoo!フリマ': 5, 'ヤフオク!': 10, 'BASE': 6.6, 'STORES': 3.6, 'Shopify': 3.55, 'その他': 0 };
      return fallbackRates[platform] || 0;
    }

    function invSetupSalesRecordEventListeners() {
      document.getElementById('invSalesAmount').addEventListener('input', invUpdateProfitCalculation);
      document.getElementById('invSalesPlatform').addEventListener('change', invOnSalesPlatformChange);
      document.getElementById('invShippingMethod1').addEventListener('change', invOnShippingMethod1Change);
      document.getElementById('invShippingMethod2').addEventListener('change', invOnShippingMethod2Change);
      document.getElementById('invAddPackagingMaterial').addEventListener('click', function() { invPackagingMaterialCount++; invRenderPackagingMaterials(); });
      document.getElementById('invSaveSalesRecord').addEventListener('click', invSaveSalesRecordAction);
    }

    async function invShowPresetSelector() {
      var container = document.getElementById('invPresetSelectorList');
      container.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div> 読み込み中...</div>';
      invShowModal('invPresetSelectorModal');
      try {
        var db = window.db;
        var snapshot = await db.collection('packagingPresets').get();
        if (snapshot.empty) { container.innerHTML = '<div class="text-center py-3 text-muted"><p>プリセットがまだ登録されていません</p></div>'; return; }
        var html = '<div class="list-group">';
        snapshot.forEach(function(docSnap) {
          var preset = docSnap.data();
          var materialsText = (preset.materials || []).map(function(m) {
            for (var cat in invPackagingMaterialsByCategory) {
              var found = invPackagingMaterialsByCategory[cat].find(function(item) { return item.id === m.materialId; });
              if (found) return found.productName + 'x' + m.quantity;
            }
            return '(不明)x' + m.quantity;
          }).join(', ');
          html += '<button type="button" class="list-group-item list-group-item-action" onclick="invApplyPreset(\'' + docSnap.id + '\')"><div class="d-flex w-100 justify-content-between"><h6 class="mb-1"><i class="bi bi-collection"></i> ' + preset.name + '</h6></div><p class="mb-1 small text-muted">' + (materialsText || '資材なし') + '</p></button>';
        });
        html += '</div>';
        container.innerHTML = html;
      } catch (error) { container.innerHTML = '<div class="text-danger">読み込みエラー: ' + error.message + '</div>'; }
    }

    async function invApplyPreset(presetId) {
      try {
        var db = window.db;
        var presetDoc = await db.collection('packagingPresets').doc(presetId).get();
        if (!presetDoc.exists) { alert('プリセットが見つかりません'); return; }
        var preset = presetDoc.data();
        var materials = preset.materials || [];
        invPackagingMaterialCount = materials.length;
        invRenderPackagingMaterials();
        materials.forEach(function(material, index) {
          var foundItem = null; var category = null;
          for (var cat in invPackagingMaterialsByCategory) {
            var found = invPackagingMaterialsByCategory[cat].find(function(m) { return m.id === material.materialId; });
            if (found) { foundItem = found; category = cat; break; }
          }
          if (category && foundItem) {
            var categorySelect = document.getElementById('invPackagingCategory' + (index + 1));
            if (categorySelect) {
              categorySelect.value = category;
              invOnPackagingCategoryChange(index + 1);
              setTimeout(function() {
                var materialSelect = document.getElementById('invPackagingMaterial' + (index + 1));
                if (materialSelect) { materialSelect.value = foundItem.productName; invOnPackagingMaterialChange(index + 1); }
              }, 100);
            }
          }
        });
        setTimeout(function() { invUpdatePackagingCostTotal(); invUpdateProfitCalculation(); }, 200);
        var modal = bootstrap.Modal.getInstance(document.getElementById('invPresetSelectorModal'));
        if (modal) modal.hide();
        alert('プリセット「' + preset.name + '」を適用しました');
      } catch (error) { alert('プリセット適用エラー: ' + error.message); }
    }

    function invSaveSalesRecordAction() {
      var salesDate = document.getElementById('invSalesDate').value;
      var salesPlatform = document.getElementById('invSalesPlatform').value;
      var salesAmount = parseFloat(document.getElementById('invSalesAmount').value);
      var shippingMethod1 = document.getElementById('invShippingMethod1').value;
      var shippingMethod2 = document.getElementById('invShippingMethod2').value;
      var shippingFee = parseFloat(document.getElementById('invShippingFee').value);
      if (!salesDate) { alert('販売日を入力してください'); return; }
      if (!salesPlatform) { alert('販売先を選択してください'); return; }
      if (!salesAmount || salesAmount <= 0) { alert('販売金額を入力してください'); return; }
      if (!shippingMethod1) { alert('発送方法（カテゴリ）を選択してください'); return; }
      if (!shippingMethod2) { alert('発送方法（詳細）を選択してください'); return; }

      var packagingMaterials = [];
      for (var i = 1; i <= invPackagingMaterialCount; i++) {
        var select = document.getElementById('invPackagingMaterial' + i);
        if (!select || !select.value) continue;
        var selectedOption = select.options[select.selectedIndex];
        packagingMaterials.push({ materialId: selectedOption.dataset.materialId || '', productName: select.value, unitCost: parseFloat(selectedOption.dataset.cost) });
      }

      var packagingCostTotal = invUpdatePackagingCostTotal();
      var platformFeeRate = invGetPlatformFeeRate(salesPlatform, salesAmount);
      var platformFee = Math.floor(salesAmount * (platformFeeRate / 100));
      var paymentFee = 0;
      var purchaseCost = parseFloat(invCurrentSalesProduct.purchaseAmount) || 0;
      var finalProfit = salesAmount - purchaseCost - platformFee - paymentFee - shippingFee - packagingCostTotal;

      var salesData = {
        managementNumber: invCurrentSalesProduct.managementNumber,
        salesDate: salesDate, salesPlatform: salesPlatform, salesAmount: salesAmount,
        shippingMethod1: shippingMethod1, shippingMethod2: shippingMethod2, shippingFee: shippingFee,
        packagingMaterials: packagingMaterials, packagingCostTotal: packagingCostTotal,
        platformFee: platformFee, paymentFee: paymentFee,
        finalProfit: Math.round(finalProfit), profitRate: salesAmount > 0 ? (finalProfit / salesAmount) * 100 : 0
      };

      if (!confirm('販売記録を保存しますか？\n\n管理番号: ' + invCurrentSalesProduct.managementNumber + '\n販売金額: \u00a5' + salesAmount.toLocaleString() + '\n最終利益: \u00a5' + Math.round(finalProfit).toLocaleString())) return;

      var modal = bootstrap.Modal.getInstance(document.getElementById('invSalesRecordModal'));
      modal.hide();
      invShowLoading();

      invSaveSalesRecordToFirestore(salesData).then(function(result) {
        invHideLoading();
        if (result && result.success) {
          setTimeout(function() { alert('販売記録を保存しました'); invLoadDashboardAndSearch(false); }, 100);
        } else {
          setTimeout(function() { alert('保存に失敗しました: ' + (result.message || result.error || '不明なエラー') + '\n\n再度販売記録を登録してください。'); }, 100);
        }
      }).catch(function(error) {
        invHideLoading();
        setTimeout(function() { alert('保存エラー: ' + (error ? (error.message || error) : 'Unknown error') + '\n\n再度販売記録を登録してください。'); }, 100);
      });
    }

    // ===== Lifecycle: Init =====
    function initInventoryPage() {
      console.log('[inv] initInventoryPage called');

      // Dropdown close handler
      _inv_dropdownClickHandler = function(e) {
        var dropdown = document.getElementById('invSettingsDropdown');
        if (dropdown && !e.target.closest('.inv-settings-dropdown') && !e.target.closest('.inv-sub-header-icon')) dropdown.classList.remove('show');
      };
      document.addEventListener('click', _inv_dropdownClickHandler);

      invInitMgmtSearchDropdowns();
      invInitBrandFilter();

      // Wait for FirestoreApi
      var waitCount = 0;
      function waitForApi() {
        waitCount++;
        if (typeof window.FirestoreApi !== 'undefined' && window.FirestoreApi.getProductList) {
          invLoadDashboard();
          invInitFilterDropdowns();
        } else if (waitCount > 300) {
          alert('Firebase初期化に時間がかかっています。ページを再読み込みしてください。');
        } else {
          setTimeout(waitForApi, 100);
        }
      }
      waitForApi();

      // Event listeners
      invAddListener(document.getElementById('invBtnSearch'), 'click', function() {
        invCurrentPage = 1; invShowResultsView(); invLoadDashboardAndSearch();
      });
      invAddListener(document.getElementById('invBtnReset'), 'click', invResetFilters);

      var searchTextInput = document.getElementById('invSearchText');
      var clearSearchBtn = document.getElementById('invClearSearchText');
      invAddListener(searchTextInput, 'input', function() { clearSearchBtn.style.display = this.value.length > 0 ? 'flex' : 'none'; });

      invAddListener(document.getElementById('invPerPage'), 'change', function() { invCurrentPage = 1; invLoadDashboardAndSearch(); });
      invAddListener(document.getElementById('invSortBy'), 'change', function() { invCurrentSort.sortBy = this.value; invLoadDashboardAndSearch(); });
      invAddListener(document.getElementById('invSortOrder'), 'change', function() { invCurrentSort.sortOrder = this.value; invLoadDashboardAndSearch(); });
      invAddListener(document.getElementById('invBtnSaveProductStatus'), 'click', invSaveProductStatus);

      console.log('[inv] initInventoryPage complete');
    }

    // ===== Lifecycle: Destroy =====
    function destroyInventoryPage() {
      console.log('[inv] destroyInventoryPage called');

      // Remove tracked event listeners
      _inv_eventListeners.forEach(function(item) {
        item.el.removeEventListener(item.event, item.handler, item.options);
      });
      _inv_eventListeners = [];

      // Remove dropdown handler
      if (_inv_dropdownClickHandler) {
        document.removeEventListener('click', _inv_dropdownClickHandler);
        _inv_dropdownClickHandler = null;
      }

      // Close any open modals and remove backdrops
      ['invProductDetailModal', 'invStockEditModal', 'invSalesRecordModal', 'invPresetSelectorModal'].forEach(function(id) {
        var el = document.getElementById(id);
        if (el) {
          var modal = bootstrap.Modal.getInstance(el);
          if (modal) modal.hide();
          el.classList.remove('show');
          el.setAttribute('aria-hidden', 'true');
          el.style.display = 'none';
        }
      });
      // Bootstrap backdrop除去
      document.querySelectorAll('.modal-backdrop').forEach(function(bd) { bd.remove(); });
      document.body.classList.remove('modal-open');
      document.body.style.removeProperty('overflow');
      document.body.style.removeProperty('padding-right');

      // Close lightbox
      var lb = document.getElementById('invImageLightbox');
      if (lb) lb.style.display = 'none';

      // Reset state
      invCurrentPage = 1;
      invCurrentFilters = {};
      invCurrentSort = { sortBy: 'registeredAt', sortOrder: 'desc' };
      invCurrentProduct = null;
      invShippingMethodMaster = [];
      invPackagingMaterialsMaster = [];
      invPackagingMaterialsByCategory = {};
      invPackagingMaterialCategories = [];
      invSalesChannelsMaster = [];
      invCurrentSalesProduct = null;
      invPackagingMaterialCount = 3;
      invCurrentSelectedFeeRate = null;
      invMgmtNumberConfig = null;
      inv_currentProductImages = [];
      inv_lightboxFunctionsInitialized = false;
      inv_lightboxListenersInitialized = false;

      console.log('[inv] destroyInventoryPage complete');
    }
  </script>
</div>
