<!-- SPA Fragment: purchase.html -->
<!-- Prefix: pur- -->
<div id="spa-page-purchase">
  <style>
    #spa-page-purchase {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    #spa-page-purchase .pur-content-container {
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* タブ - 2段構成（3列グリッド） */
    #spa-page-purchase .pur-nav-tabs-custom {
      background: white;
      border-radius: 12px;
      padding: 8px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      list-style: none;
    }
    #spa-page-purchase .pur-nav-tabs-custom .pur-nav-item {
      min-width: 0;
    }
    #spa-page-purchase .pur-nav-tabs-custom .pur-nav-link {
      border: none;
      border-radius: 8px;
      padding: 12px 10px;
      color: #6b7280;
      font-weight: 500;
      font-size: 0.875rem;
      width: 100%;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      background: #f3f4f6;
      cursor: pointer;
      display: block;
    }
    #spa-page-purchase .pur-nav-tabs-custom .pur-nav-link:hover {
      background: #dbeafe;
      color: #1d4ed8;
    }
    #spa-page-purchase .pur-nav-tabs-custom .pur-nav-link.active {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      color: white;
    }

    /* フィルタセクション */
    #spa-page-purchase .pur-filter-section {
      background: white;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    /* サマリーカード */
    #spa-page-purchase .pur-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    #spa-page-purchase .pur-summary-card {
      background: white;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    #spa-page-purchase .pur-summary-label {
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 4px;
    }
    #spa-page-purchase .pur-summary-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1f2937;
    }
    #spa-page-purchase .pur-summary-value.warning { color: #f59e0b; }
    #spa-page-purchase .pur-summary-value.danger { color: #ef4444; }

    /* テーブル */
    #spa-page-purchase .pur-data-table-container {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    #spa-page-purchase .pur-data-table {
      width: 100%;
      font-size: 0.875rem;
    }
    #spa-page-purchase .pur-data-table th {
      background: #f9fafb;
      padding: 12px 8px;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
      white-space: nowrap;
    }
    #spa-page-purchase .pur-data-table td {
      padding: 12px 8px;
      border-bottom: 1px solid #f3f4f6;
      vertical-align: middle;
    }
    #spa-page-purchase .pur-data-table tr:hover {
      background: #f9fafb;
    }

    /* ステータスバッジ */
    #spa-page-purchase .pur-status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    #spa-page-purchase .pur-status-paid { background: #d1fae5; color: #065f46; }
    #spa-page-purchase .pur-status-unpaid { background: #fee2e2; color: #991b1b; }
    #spa-page-purchase .pur-status-partial { background: #fef3c7; color: #92400e; }

    /* 仕入先グループ */
    #spa-page-purchase .pur-supplier-group {
      background: white;
      border-radius: 12px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    #spa-page-purchase .pur-supplier-header {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    #spa-page-purchase .pur-supplier-header h6 {
      margin: 0;
      font-weight: 600;
    }
    #spa-page-purchase .pur-supplier-body {
      padding: 16px;
    }
    #spa-page-purchase .pur-supplier-body-collapsed {
      display: none;
    }

    /* ローディング */
    #spa-page-purchase .pur-loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    /* レスポンシブ */
    @media (max-width: 576px) {
      #spa-page-purchase .pur-summary-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      #spa-page-purchase .pur-data-table {
        font-size: 0.75rem;
      }
      #spa-page-purchase .pur-data-table th, #spa-page-purchase .pur-data-table td {
        padding: 8px 4px;
      }
    }

    /* 入力モード切替タブ */
    #spa-page-purchase .pur-entry-mode-tabs {
      display: flex;
      gap: 8px;
    }
    #spa-page-purchase .pur-entry-mode-tab {
      flex: 1;
      padding: 12px 8px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      text-align: center;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    #spa-page-purchase .pur-entry-mode-tab:hover {
      border-color: #4ECDC4;
    }
    #spa-page-purchase .pur-entry-mode-tab.active {
      border-color: #4ECDC4;
      background: #e0f7f5;
      color: #00897B;
    }
    #spa-page-purchase .pur-entry-mode-tab i {
      display: block;
      font-size: 1.3rem;
      margin-bottom: 4px;
    }

    /* 仕入登録カード */
    #spa-page-purchase .pur-entry-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    /* 単価表示 */
    #spa-page-purchase .pur-entry-per-item {
      background: #e0f7f5;
      border-radius: 8px;
      padding: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #spa-page-purchase .pur-entry-per-item-label {
      font-size: 0.85rem;
      color: #666;
    }
    #spa-page-purchase .pur-entry-per-item-value {
      font-size: 1.25rem;
      font-weight: 600;
      color: #4ECDC4;
    }

    /* 個別入力商品リスト */
    #spa-page-purchase .pur-entry-item {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      margin-bottom: 8px;
      position: relative;
      overflow: hidden;
    }
    #spa-page-purchase .pur-entry-item.collapsed {
      background: #fff;
    }
    #spa-page-purchase .pur-entry-item-summary {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      cursor: pointer;
      gap: 8px;
      background: #f8f9fa;
      border-bottom: 1px solid transparent;
    }
    #spa-page-purchase .pur-entry-item.expanded .pur-entry-item-summary {
      border-bottom: 1px solid #e9ecef;
      background: #4ECDC4;
      color: white;
    }
    #spa-page-purchase .pur-entry-item-summary .pur-item-number {
      font-weight: 700;
      color: #4ECDC4;
      min-width: 28px;
    }
    #spa-page-purchase .pur-entry-item.expanded .pur-entry-item-summary .pur-item-number {
      color: white;
    }
    #spa-page-purchase .pur-entry-item-summary .pur-item-info {
      flex: 1;
      font-size: 0.8rem;
      color: #6b7280;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #spa-page-purchase .pur-entry-item.expanded .pur-entry-item-summary .pur-item-info {
      color: rgba(255,255,255,0.9);
    }
    #spa-page-purchase .pur-entry-item-summary .pur-item-toggle {
      color: #9ca3af;
      transition: transform 0.2s;
    }
    #spa-page-purchase .pur-entry-item.expanded .pur-entry-item-summary .pur-item-toggle {
      color: white;
      transform: rotate(180deg);
    }
    #spa-page-purchase .pur-entry-item-summary .pur-item-warning {
      color: #f59e0b;
      font-size: 0.85rem;
    }
    #spa-page-purchase .pur-entry-item.expanded .pur-entry-item-summary .pur-item-warning {
      color: #fef3c7;
    }
    #spa-page-purchase .pur-entry-item-summary .pur-item-reset {
      background: none;
      border: none;
      color: #6b7280;
      cursor: pointer;
      padding: 4px;
      font-size: 0.9rem;
      opacity: 0.7;
    }
    #spa-page-purchase .pur-entry-item-summary .pur-item-reset:hover {
      opacity: 1;
      color: #f59e0b;
    }
    #spa-page-purchase .pur-entry-item.expanded .pur-entry-item-summary .pur-item-reset {
      color: #fef3c7;
    }
    #spa-page-purchase .pur-entry-item-summary .pur-item-delete {
      background: none;
      border: none;
      color: #dc3545;
      cursor: pointer;
      padding: 4px;
      font-size: 0.9rem;
      opacity: 0.7;
    }
    #spa-page-purchase .pur-entry-item-summary .pur-item-delete:hover {
      opacity: 1;
    }
    #spa-page-purchase .pur-entry-item.expanded .pur-entry-item-summary .pur-item-delete {
      color: #fecaca;
    }
    #spa-page-purchase .pur-entry-item-body {
      display: none;
      padding: 12px;
    }
    #spa-page-purchase .pur-entry-item.expanded .pur-entry-item-body {
      display: block;
    }
    /* デフォルト設定セクション */
    #spa-page-purchase .pur-default-settings-section {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 8px;
      padding: 12px;
    }
    #spa-page-purchase .pur-default-settings-header {
      display: flex;
      align-items: center;
      font-weight: 600;
      color: #0369a1;
      font-size: 0.9rem;
    }
    #spa-page-purchase .pur-default-settings-header i {
      margin-right: 6px;
    }
    #spa-page-purchase .pur-default-settings-section .form-control,
    #spa-page-purchase .pur-default-settings-section .form-select {
      font-size: 16px;
    }
    #spa-page-purchase .pur-entry-item .form-control,
    #spa-page-purchase .pur-entry-item .form-select {
      padding: 8px 10px;
      font-size: 16px;
    }
    #spa-page-purchase .pur-entry-item .form-label {
      font-size: 0.75rem;
      margin-bottom: 4px;
    }

    /* 商品追加ボタン */
    #spa-page-purchase .pur-entry-add-item-btn {
      width: 100%;
      padding: 12px;
      border: 2px dashed #4ECDC4;
      border-radius: 8px;
      background: #f0fdfb;
      color: #4ECDC4;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.2s;
    }
    #spa-page-purchase .pur-entry-add-item-btn:hover {
      background: #e0f7f5;
      border-color: #26A69A;
    }

    /* 合計表示 */
    #spa-page-purchase .pur-entry-total-card {
      background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
      color: white;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
      text-align: center;
    }
    #spa-page-purchase .pur-entry-total-label {
      font-size: 0.85rem;
      opacity: 0.9;
    }
    #spa-page-purchase .pur-entry-total-value {
      font-size: 1.5rem;
      font-weight: 700;
    }
    #spa-page-purchase .pur-entry-total-count {
      font-size: 0.8rem;
      opacity: 0.8;
      margin-top: 4px;
    }

    /* QRコードグリッド */
    #spa-page-purchase .pur-qr-entry-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    #spa-page-purchase .pur-qr-entry-item {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 8px;
      text-align: center;
      width: 100px;
    }
    #spa-page-purchase .pur-qr-entry-item canvas {
      max-width: 100%;
      height: auto;
    }
    #spa-page-purchase .pur-qr-entry-item-label {
      font-size: 0.7rem;
      color: #666;
      margin-top: 6px;
      word-break: break-all;
    }

    /* 印刷モード選択 */
    #spa-page-purchase .pur-entry-print-mode-tabs {
      display: flex;
      gap: 8px;
    }
    #spa-page-purchase .pur-entry-print-mode-tab {
      flex: 1;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      text-align: center;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    #spa-page-purchase .pur-entry-print-mode-tab:hover {
      border-color: #4ECDC4;
    }
    #spa-page-purchase .pur-entry-print-mode-tab.active {
      border-color: #4ECDC4;
      background: #e0f7f5;
      color: #00897B;
    }

    /* ラベルプリセットボタン */
    #spa-page-purchase .pur-entry-label-preset-btn {
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      text-align: center;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    #spa-page-purchase .pur-entry-label-preset-btn:hover {
      border-color: #4ECDC4;
      background: #f0fdfb;
    }
    #spa-page-purchase .pur-entry-label-preset-btn.active {
      border-color: #4ECDC4;
      background: #e0f7f5;
    }
    #spa-page-purchase .pur-entry-label-preset-btn .pur-preset-name {
      font-weight: 600;
      color: #333;
    }
    #spa-page-purchase .pur-entry-label-preset-btn .pur-preset-info {
      font-size: 0.7rem;
      color: #666;
      margin-top: 2px;
    }

    /* カスタム設定パネル */
    #spa-page-purchase .pur-entry-custom-settings {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
    }
    #spa-page-purchase .pur-entry-custom-settings .form-label {
      font-size: 0.7rem;
      margin-bottom: 2px;
    }

    /* 仕入登録用緑ボタン */
    #spa-page-purchase .pur-btn-entry-teal {
      background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
      border: none;
      color: white;
      font-weight: 600;
    }
    #spa-page-purchase .pur-btn-entry-teal:hover {
      background: linear-gradient(135deg, #44A08D 0%, #3d9682 100%);
      color: white;
    }
    #spa-page-purchase .pur-btn-entry-teal-outline {
      background: white;
      border: 2px solid #4ECDC4;
      color: #4ECDC4;
      font-weight: 600;
    }
    #spa-page-purchase .pur-btn-entry-teal-outline:hover {
      background: #e0f7f5;
      border-color: #26A69A;
      color: #00897B;
    }

    /* ラベルシートプレビュー */
    #spa-page-purchase .pur-entry-label-sheet-preview {
      background: white;
      border: 1px solid #ccc;
      margin: 16px auto;
      position: relative;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #spa-page-purchase .pur-entry-label-cell {
      position: absolute;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    #spa-page-purchase .pur-entry-label-cell img {
      max-width: 100%;
      max-height: 100%;
    }
    #spa-page-purchase .pur-entry-label-cell-empty {
      background: #f5f5f5;
      border: 1px dashed #ccc;
    }

    /* QR確認カード */
    #spa-page-purchase .pur-qr-check-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    /* スキャン結果表示 */
    #spa-page-purchase .pur-qr-result-card {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      border: 2px solid #22c55e;
      border-radius: 12px;
      padding: 20px;
      margin-top: 16px;
    }
    #spa-page-purchase .pur-qr-result-card.error {
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      border-color: #ef4444;
    }
    #spa-page-purchase .pur-qr-result-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    #spa-page-purchase .pur-qr-result-header i {
      font-size: 1.5rem;
      color: #22c55e;
    }
    #spa-page-purchase .pur-qr-result-card.error .pur-qr-result-header i {
      color: #ef4444;
    }
    #spa-page-purchase .pur-qr-result-header span {
      font-weight: 600;
      font-size: 1.1rem;
    }
    #spa-page-purchase .pur-qr-result-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    #spa-page-purchase .pur-qr-result-row:last-child {
      border-bottom: none;
    }
    #spa-page-purchase .pur-qr-result-label {
      color: #6b7280;
      font-size: 0.9rem;
    }
    #spa-page-purchase .pur-qr-result-value {
      font-weight: 600;
      color: #1f2937;
      font-size: 0.95rem;
    }
    #spa-page-purchase .pur-qr-result-value.highlight {
      color: #059669;
      font-size: 1.1rem;
    }

    /* 検品情報セクション */
    #spa-page-purchase .pur-qr-result-section {
      background: #f0fdf4;
      border: 1px solid #86efac;
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
    }
    #spa-page-purchase .pur-qr-result-section-title {
      font-weight: 600;
      color: #059669;
      font-size: 0.95rem;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #86efac;
    }
    #spa-page-purchase .pur-qr-result-section .pur-qr-result-row {
      padding: 6px 0;
    }

    /* 傷汚れマーキング QR側 */
    #spa-page-purchase .pur-qr-dm-side-btn {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      color: #374151;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    #spa-page-purchase .pur-qr-dm-side-btn:hover {
      background: #e5e7eb;
    }
    #spa-page-purchase .pur-qr-dm-side-btn.active {
      background: #14b8a6;
      border-color: #14b8a6;
      color: white;
    }

    /* スキャン履歴 */
    #spa-page-purchase .pur-qr-history-item {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #spa-page-purchase .pur-qr-history-item .pur-history-info {
      flex: 1;
    }
    #spa-page-purchase .pur-qr-history-item .pur-history-number {
      font-weight: 600;
      color: #4ECDC4;
    }
    #spa-page-purchase .pur-qr-history-item .pur-history-amount {
      font-size: 0.9rem;
      color: #374151;
    }
    #spa-page-purchase .pur-qr-history-item .pur-history-time {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    /* 検品情報セクション */
    #spa-page-purchase .pur-inspection-section {
      background: #f0fdf4;
      border: 1px solid #86efac;
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
    }
    #spa-page-purchase .pur-inspection-section-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      cursor: pointer;
    }
    #spa-page-purchase .pur-inspection-section-header i {
      color: #22c55e;
    }
    #spa-page-purchase .pur-inspection-section-header span {
      font-weight: 600;
      font-size: 0.85rem;
      color: #166534;
    }
    #spa-page-purchase .pur-inspection-section-header .pur-toggle-icon {
      margin-left: auto;
      color: #6b7280;
    }
    #spa-page-purchase .pur-inspection-fields {
      display: grid;
      gap: 10px;
    }
    #spa-page-purchase .pur-inspection-fields .form-label {
      font-size: 0.75rem;
      margin-bottom: 2px;
      color: #374151;
    }
    #spa-page-purchase .pur-inspection-fields .form-control,
    #spa-page-purchase .pur-inspection-fields .form-select {
      font-size: 16px;
      padding: 6px 10px;
    }

    /* 付属品チェックボックス */
    #spa-page-purchase .pur-accessories-checkboxes {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    #spa-page-purchase .pur-accessory-checkbox {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.8rem;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 4px 8px;
      cursor: pointer;
    }
    #spa-page-purchase .pur-accessory-checkbox input {
      width: 14px;
      height: 14px;
    }
    #spa-page-purchase .pur-accessory-checkbox.checked {
      background: #dcfce7;
      border-color: #22c55e;
    }

    /* 傷・汚れマーキング機能 */
    #spa-page-purchase .pur-damage-marker-section {
      margin-top: 12px;
      padding: 12px;
      background: #fef3c7;
      border: 1px solid #fcd34d;
      border-radius: 8px;
    }
    #spa-page-purchase .pur-damage-marker-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    #spa-page-purchase .pur-damage-marker-header .pur-title {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      font-size: 0.85rem;
      color: #92400e;
    }
    #spa-page-purchase .pur-damage-marker-header .pur-title i {
      color: #f59e0b;
    }
    #spa-page-purchase .pur-damage-marker-toggle {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 4px;
      border: 1px solid #f59e0b;
      background: white;
      color: #92400e;
      cursor: pointer;
    }
    #spa-page-purchase .pur-damage-marker-toggle:hover {
      background: #fef3c7;
    }
    #spa-page-purchase .pur-damage-marker-canvas-container {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      width: 100%;
    }
    #spa-page-purchase .pur-damage-marker-canvas-container.active {
      display: flex;
    }
    #spa-page-purchase .pur-damage-marker-item-select {
      width: 100%;
      max-width: 300px;
    }
    #spa-page-purchase .pur-damage-marker-no-category {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 16px;
      background: #f3f4f6;
      border: 1px dashed #9ca3af;
      border-radius: 8px;
      color: #6b7280;
      font-size: 0.85rem;
    }
    #spa-page-purchase .pur-damage-marker-no-category i {
      font-size: 1.1rem;
    }
    #spa-page-purchase .pur-damage-marker-side-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    #spa-page-purchase .pur-side-toggle-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 16px;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      background: white;
      font-size: 0.9rem;
      font-weight: 600;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    #spa-page-purchase .pur-side-toggle-btn:hover {
      border-color: #f59e0b;
      color: #92400e;
    }
    #spa-page-purchase .pur-side-toggle-btn.active {
      border-color: #f59e0b;
      background: #fef3c7;
      color: #92400e;
    }
    #spa-page-purchase .pur-side-saved-badge {
      position: absolute;
      top: 4px;
      right: 8px;
      color: #22c55e;
      font-size: 0.6rem;
    }
    #spa-page-purchase .pur-damage-marker-canvas-wrapper {
      position: relative;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      background: white;
      overflow: hidden;
      touch-action: none;
      max-width: 280px;
    }
    #spa-page-purchase .pur-damage-marker-canvas {
      display: block;
      max-width: 100%;
      height: auto;
    }
    #spa-page-purchase .pur-damage-marker-note {
      width: 100%;
      max-width: 100%;
      padding: 0 8px;
      box-sizing: border-box;
    }
    #spa-page-purchase .pur-damage-marker-tools {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: center;
    }
    #spa-page-purchase .pur-damage-marker-tool {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      color: #6b7280;
      transition: all 0.15s ease;
    }
    #spa-page-purchase .pur-damage-marker-tool.active {
      background: #5eead4;
      border-color: #5eead4;
      color: #115e59;
      box-shadow: 0 2px 4px rgba(94, 234, 212, 0.4);
    }
    #spa-page-purchase .pur-damage-marker-tool:hover:not(.active) {
      background: #f3f4f6;
      border-color: #d1d5db;
    }
    #spa-page-purchase .pur-damage-marker-colors {
      display: flex;
      gap: 6px;
      margin-left: 8px;
      padding-left: 8px;
      border-left: 1px solid #e5e7eb;
    }
    #spa-page-purchase .pur-damage-marker-color {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 3px solid transparent;
      cursor: pointer;
      transition: all 0.15s ease;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    #spa-page-purchase .pur-damage-marker-color.active {
      border-color: #ffffff;
      transform: scale(1.1);
      box-shadow: 0 0 0 2px #0d9488, 0 2px 6px rgba(0,0,0,0.2);
    }
    #spa-page-purchase .pur-damage-marker-color:hover:not(.active) {
      transform: scale(1.05);
    }
    #spa-page-purchase .pur-damage-marker-color.red { background: #ef4444; }
    #spa-page-purchase .pur-damage-marker-color.blue { background: #3b82f6; }
    #spa-page-purchase .pur-damage-marker-color.black { background: #1f2937; }
    #spa-page-purchase .pur-damage-marker-actions {
      display: flex;
      gap: 8px;
    }
    #spa-page-purchase .pur-damage-marker-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      border: 1px solid #d1d5db;
      background: white;
    }
    #spa-page-purchase .pur-damage-marker-btn.primary {
      background: #f59e0b;
      border-color: #f59e0b;
      color: white;
    }
    #spa-page-purchase .pur-damage-marker-btn:hover {
      opacity: 0.9;
    }
    #spa-page-purchase .pur-damage-marker-preview {
      margin-top: 8px;
      text-align: center;
    }
    #spa-page-purchase .pur-damage-marker-preview img {
      max-width: 150px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
    }
    #spa-page-purchase .pur-damage-marker-preview-label {
      font-size: 0.7rem;
      color: #6b7280;
      margin-top: 4px;
    }
    #spa-page-purchase .pur-damage-marker-object-controls {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: #e0f2fe;
      border: 1px solid #7dd3fc;
      border-radius: 6px;
      flex-wrap: wrap;
      justify-content: center;
    }
    #spa-page-purchase .pur-object-controls-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: #0369a1;
    }
    #spa-page-purchase .pur-damage-marker-btn.danger {
      background: #fee2e2;
      border-color: #fca5a5;
      color: #dc2626;
    }
    #spa-page-purchase .pur-damage-marker-btn.danger:hover {
      background: #fecaca;
    }

    /* ブランドサジェスト用スタイル */
    #spa-page-purchase .pur-brand-field {
      position: relative;
    }
    #spa-page-purchase .pur-suggest {
      position: absolute;
      left: 0;
      right: 0;
      top: calc(100% + 2px);
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      max-height: 240px;
      overflow: auto;
      z-index: 10000;
    }
    #spa-page-purchase .pur-suggest.suggest-above {
      top: auto;
      bottom: calc(100% + 2px);
      box-shadow: 0 -10px 25px rgba(0, 0, 0, 0.15);
    }
    #spa-page-purchase .pur-suggest[hidden] { display: none; }
    #spa-page-purchase .pur-sug-item {
      padding: 8px 12px;
      cursor: pointer;
      font-size: 13px;
      border-bottom: 1px solid #f3f4f6;
      transition: background-color 0.1s ease;
    }
    #spa-page-purchase .pur-sug-item.brand-item {
      padding: 10px 12px;
      line-height: 1.3;
    }
    #spa-page-purchase .pur-brand-english {
      font-weight: 600;
      color: #1f2937;
      font-size: 13px;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #spa-page-purchase .pur-brand-kana {
      font-size: 11px;
      color: #6b7280;
      font-weight: 400;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #spa-page-purchase .pur-sug-item.brand-item:hover .pur-brand-english,
    #spa-page-purchase .pur-sug-item.brand-item.active .pur-brand-english {
      color: #5b21b6;
    }
    #spa-page-purchase .pur-sug-item.brand-item:hover .pur-brand-kana,
    #spa-page-purchase .pur-sug-item.brand-item.active .pur-brand-kana {
      color: #7c3aed;
    }
    #spa-page-purchase .pur-sug-item:hover,
    #spa-page-purchase .pur-sug-item.active {
      background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
      color: #5b21b6;
      font-weight: 500;
    }
    #spa-page-purchase .pur-sug-item:last-child {
      border-bottom: none;
    }

    /* 7階層カテゴリプルダウン用 */
    #spa-page-purchase .pur-inspection-category-selects select {
      margin-top: 6px;
    }
    #spa-page-purchase .pur-inspection-category-selects select:disabled {
      background-color: #f3f4f6;
      cursor: not-allowed;
      color: transparent;
    }
    #spa-page-purchase .pur-inspection-category-selects select:disabled option {
      color: transparent;
    }
    #spa-page-purchase .pur-inspection-category-selects select:not(:disabled) {
      color: #212529 !important;
    }
    #spa-page-purchase .pur-inspection-category-selects select:not(:disabled) option {
      color: #212529;
    }

    /* フローティングスキャンボタン */
    #spa-page-purchase .pur-qr-floating-btn {
      position: fixed;
      bottom: 70px;
      right: 20px;
      width: 68px;
      height: 68px;
      border-radius: 50%;
      background: white;
      border: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      cursor: pointer;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 14px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    #spa-page-purchase .pur-qr-floating-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(0,0,0,0.3);
    }
    #spa-page-purchase .pur-qr-floating-btn img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    /* サブページヘッダー */
    #spa-page-purchase .pur-sub-header {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 56px;
      padding: 0 16px;
      background: #ffffff;
      border-bottom: 1px solid #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    #spa-page-purchase .pur-sub-header-back {
      position: absolute;
      left: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: transparent;
      border: none;
      color: #374151;
      font-size: 20px;
      cursor: pointer;
    }
    #spa-page-purchase .pur-sub-header-back:hover { background: #f3f4f6; }
    #spa-page-purchase .pur-sub-header-back:active { background: #e5e7eb; }
    #spa-page-purchase .pur-sub-header-title {
      font-size: 17px;
      font-weight: 600;
      color: #111827;
    }
    #spa-page-purchase .pur-sub-header-icons {
      position: absolute;
      right: 8px;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    #spa-page-purchase .pur-sub-header-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: transparent;
      border: none;
      color: #374151;
      font-size: 20px;
      cursor: pointer;
      position: relative;
    }
    #spa-page-purchase .pur-sub-header-icon:hover { background: #f3f4f6; }
    #spa-page-purchase .pur-sub-header-icon:active { background: #e5e7eb; }
    #spa-page-purchase .pur-announce-dot {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      display: none;
    }
    #spa-page-purchase .pur-announce-dot.visible {
      display: block;
    }
    /* 設定ドロップダウン */
    #spa-page-purchase .pur-settings-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 200px;
      padding: 8px 0;
      display: none;
      z-index: 1001;
    }
    #spa-page-purchase .pur-settings-dropdown.active {
      display: block;
    }
    #spa-page-purchase .pur-settings-dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border: none;
      background: none;
      width: 100%;
      font-size: 14px;
      color: #374151;
      cursor: pointer;
      text-align: left;
    }
    #spa-page-purchase .pur-settings-dropdown-item:hover {
      background: #f3f4f6;
    }
    #spa-page-purchase .pur-settings-dropdown-item i {
      font-size: 18px;
      color: #6b7280;
      width: 20px;
      text-align: center;
    }
    /* サブタブ（買掛管理内） */
    #spa-page-purchase .pur-payable-sub-tabs {
      display: flex;
      gap: 4px;
      background: #f3f4f6;
      padding: 4px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    #spa-page-purchase .pur-payable-sub-tab {
      flex: 1;
      padding: 8px 12px;
      border: none;
      background: transparent;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    #spa-page-purchase .pur-payable-sub-tab:hover {
      color: #374151;
      background: rgba(255,255,255,0.5);
    }
    #spa-page-purchase .pur-payable-sub-tab.active {
      background: white;
      color: #f59e0b;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    #spa-page-purchase .pur-payable-sub-content {
      display: none;
    }
    #spa-page-purchase .pur-payable-sub-content.active {
      display: block;
    }

    /* タブコンテンツ */
    #spa-page-purchase .pur-tab-content {
      display: none;
    }
    #spa-page-purchase .pur-tab-content.active {
      display: block;
    }

    /* モーダルオーバーレイ */
    #spa-page-purchase .pur-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }
    #spa-page-purchase .pur-modal-overlay.active {
      display: flex;
    }
    #spa-page-purchase .pur-modal-dialog {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    #spa-page-purchase .pur-modal-dialog.modal-lg {
      max-width: 800px;
    }
    #spa-page-purchase .pur-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
    }
    #spa-page-purchase .pur-modal-header h5 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
    }
    #spa-page-purchase .pur-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6b7280;
      padding: 0;
      line-height: 1;
    }
    #spa-page-purchase .pur-modal-body {
      padding: 20px;
    }
    #spa-page-purchase .pur-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      padding: 16px 20px;
      border-top: 1px solid #e5e7eb;
    }

    /* 印刷用スタイル */
    @media print {
      #spa-page-purchase > *:not(#pur-entryLabelPrintArea) {
        display: none !important;
      }
      #spa-page-purchase #pur-entryLabelPrintArea {
        display: block !important;
        position: fixed !important;
        left: 0 !important;
        top: 0 !important;
        width: 210mm !important;
        height: auto !important;
        margin: 0 !important;
        padding: 0 !important;
        background: white !important;
        z-index: 999999 !important;
      }
      #spa-page-purchase .pur-entry-label-sheet-print-area {
        display: block !important;
        width: 210mm !important;
        height: 297mm !important;
        margin: 0 !important;
        padding: 0 !important;
        page-break-after: always;
        position: relative !important;
        background: white !important;
      }
      #spa-page-purchase .pur-entry-label-sheet-print-area:last-child {
        page-break-after: auto;
      }
      #spa-page-purchase #pur-entryLabelPrintArea img {
        display: block !important;
        max-width: none !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      @page {
        size: A4;
        margin: 0;
      }
    }
  </style>

  <!-- ローディングオーバーレイ -->
  <div class="pur-loading-overlay" id="pur-loadingOverlay" style="display: none;">
    <div style="text-align: center;">
      <div class="spinner-border text-warning" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted">データを読み込んでいます...</p>
    </div>
  </div>

  <!-- サブページヘッダー -->
  <div class="pur-sub-header">
    <button class="pur-sub-header-back" onclick="spaGoBack()" title="戻る">
      <i class="bi bi-chevron-left"></i>
    </button>
    <span class="pur-sub-header-title">仕入管理</span>
    <div class="pur-sub-header-icons">
      <button class="pur-sub-header-icon" title="通知" onclick="purOpenAnnouncePage()">
        <i class="bi bi-bell"></i>
        <span class="pur-announce-dot" id="pur-announceDot"></span>
      </button>
      <div style="position: relative;">
        <button class="pur-sub-header-icon" onclick="purToggleSettingsDropdown(event)" title="メニュー">
          <i class="bi bi-list"></i>
        </button>
        <div class="pur-settings-dropdown" id="pur-settingsDropdown">
          <button class="pur-settings-dropdown-item" onclick="purOpenLabelPrintHistoryModal(); purCloseSettingsDropdown();">
            <i class="bi bi-clock-history"></i>
            <span>ラベル印刷履歴</span>
          </button>
          <button class="pur-settings-dropdown-item" onclick="purOpenPaymentNoticeModal(); purCloseSettingsDropdown();">
            <i class="bi bi-file-text"></i>
            <span>支払通知書発行</span>
          </button>
          <button class="pur-settings-dropdown-item" onclick="purOpenExportModal(); purCloseSettingsDropdown();">
            <i class="bi bi-download"></i>
            <span>仕入帳出力</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="pur-content-container">
    <!-- タブ -->
    <ul class="pur-nav-tabs-custom">
      <li class="pur-nav-item">
        <button class="pur-nav-link active" data-pur-target="pur-entry-content" onclick="purSwitchTab('pur-entry-content')">
          <i class="bi bi-box-arrow-in-down"></i> 仕入登録
        </button>
      </li>
      <li class="pur-nav-item">
        <button class="pur-nav-link" data-pur-target="pur-purchase-content" onclick="purSwitchTab('pur-purchase-content')">
          <i class="bi bi-list-ul"></i> 仕入一覧
        </button>
      </li>
      <li class="pur-nav-item">
        <button class="pur-nav-link" data-pur-target="pur-payable-content" onclick="purSwitchTab('pur-payable-content')">
          <i class="bi bi-credit-card"></i> 買掛管理
        </button>
      </li>
      <li class="pur-nav-item">
        <button class="pur-nav-link" data-pur-target="pur-dispatch-progress-content" onclick="purSwitchTab('pur-dispatch-progress-content'); purLoadDispatchProgress();">
          <i class="bi bi-truck"></i> 発送進捗
        </button>
      </li>
      <li class="pur-nav-item">
        <button class="pur-nav-link" data-pur-target="pur-inspection-request-content" onclick="purSwitchTab('pur-inspection-request-content'); purLoadInspectionRequests();">
          <i class="bi bi-clipboard-check"></i> 検品依頼
        </button>
      </li>
    </ul>

    <!-- 仕入登録タブ -->
    <div class="pur-tab-content active" id="pur-entry-content">
      <!-- 入力モード切替 -->
      <div class="pur-entry-mode-tabs mb-3">
        <div class="pur-entry-mode-tab active" onclick="purSetEntryMode('individual')" id="pur-entryModeIndividual">
          <i class="bi bi-list-ol"></i>
          <span>個別入力</span>
          <small class="d-block text-muted" style="font-size: 10px;">異なる商品をそれぞれ詳細入力</small>
        </div>
        <div class="pur-entry-mode-tab" onclick="purSetEntryMode('batch')" id="pur-entryModeBatch">
          <i class="bi bi-collection"></i>
          <span>一括入力</span>
          <small class="d-block text-muted" style="font-size: 10px;">同じ条件で複数点を一括登録</small>
        </div>
      </div>

      <!-- 一括入力モード -->
      <div class="pur-entry-card" id="pur-batchEntrySection" style="display: none;">
        <div class="pur-default-settings-section mb-3">
          <div class="pur-default-settings-header">
            <i class="bi bi-gear"></i>
            <span>デフォルト設定</span>
            <small class="text-muted ms-2">（全商品に適用）</small>
          </div>
          <div class="mt-2">
            <label class="form-label">仕入日 <span class="text-danger">*</span></label>
            <input type="date" class="form-control" id="pur-entryPurchaseDate">
          </div>
          <div class="mt-2">
            <label class="form-label">仕入先 <span class="text-danger">*</span></label>
            <select class="form-select" id="pur-entrySupplier">
              <option value="">読み込み中...</option>
            </select>
          </div>
          <div class="mt-2">
            <label class="form-label">発送先 <span class="text-danger">*</span></label>
            <select class="form-select" id="pur-entryAssignee">
              <option value="">読み込み中...</option>
            </select>
          </div>
          <div class="mt-2">
            <label class="form-label">仕入金額 <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text">¥</span>
              <input type="number" class="form-control" id="pur-entryTotalAmount" min="0" onchange="purCalculateEntryPerItem()">
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">登録内容</label>
          <div>
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">仕入点数 <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="pur-entryItemCount" min="1" value="1" onchange="purCalculateEntryPerItem()">
              </div>
              <div class="col-6 d-flex align-items-end">
                <div class="pur-entry-per-item w-100">
                  <span class="pur-entry-per-item-label">1点あたり単価</span>
                  <span class="pur-entry-per-item-value" id="pur-entryPricePerItem">¥0</span>
                </div>
              </div>
            </div>

            <!-- 検品情報 -->
            <div class="pur-inspection-section mt-3" style="border: none; background: transparent; padding: 0;">
              <div style="font-weight: 600; color: #059669; font-size: 0.95rem; margin-bottom: 8px;">
                <i class="bi bi-clipboard-check"></i>
                <span>検品情報</span>
                <small class="text-muted">（商品登録時に自動反映）</small>
              </div>

              <!-- カテゴリー -->
              <div class="pur-inspection-category-selects mt-2">
                <label class="form-label">カテゴリー</label>
                <select class="form-select" id="pur-batch-cat-l0" onchange="purOnBatchCatL0Changed()">
                  <option value="">--選択してください--</option>
                </select>
                <select class="form-select" id="pur-batch-cat-l1" onchange="purOnBatchCatL1Changed()" disabled>
                  <option value="">--選択してください--</option>
                </select>
                <select class="form-select" id="pur-batch-cat-l2" onchange="purOnBatchCatL2Changed()" disabled>
                  <option value="">--選択してください--</option>
                </select>
                <select class="form-select" id="pur-batch-cat-l3" onchange="purOnBatchCatL3Changed()" disabled>
                  <option value="">--選択してください--</option>
                </select>
                <select class="form-select" id="pur-batch-cat-l4" onchange="purOnBatchCatL4Changed()" disabled style="display:none;">
                  <option value="">--選択してください--</option>
                </select>
                <select class="form-select" id="pur-batch-cat-l5" onchange="purOnBatchCatL5Changed()" disabled style="display:none;">
                  <option value="">--選択してください--</option>
                </select>
              </div>
              <div class="mt-2 pur-inspection-category-selects">
                <label class="form-label">アイテム名</label>
                <select class="form-select" id="pur-batch-cat-item" disabled>
                  <option value="">--選択してください--</option>
                </select>
              </div>

              <div class="mt-2">
                <label class="form-label">サイズ</label>
                <select class="form-select" id="pur-batchSize">
                  <option value="">--選択--</option>
                </select>
              </div>

              <div class="mt-2">
                <label class="form-label">商品の状態</label>
                <select class="form-select" id="pur-batchCondition">
                  <option value="">--選択--</option>
                </select>
              </div>

              <div class="pur-brand-field mt-2">
                <label class="form-label">ブランド</label>
                <input type="text" class="form-control" id="pur-batchBrand" autocomplete="off" placeholder="入力すると候補が表示されます" oninput="purOnBatchBrandInput()">
                <div class="pur-suggest" id="pur-suggest-batch-brand" hidden></div>
                <input type="hidden" id="pur-batchBrandKana">
              </div>

              <div class="mt-2">
                <label class="form-label">付属品</label>
                <div class="pur-accessories-checkboxes" id="pur-batch-accessories"></div>
                <div id="pur-batch-accessory-other-container" style="display: none; margin-top: 8px;">
                  <input type="text" class="form-control" id="pur-batch-accessory-other" placeholder="その他の付属品" style="font-size: 0.85rem;">
                </div>
              </div>

              <div class="mt-2">
                <label class="form-label">メモ</label>
                <input type="text" class="form-control" id="pur-entryMemo" placeholder="セット売り、まとめ売りなど">
              </div>

              <!-- 傷・汚れマーキング（一括入力用） -->
              <div class="pur-damage-marker-section">
                <div class="pur-damage-marker-header">
                  <div class="pur-title">
                    <i class="bi bi-pencil-square"></i>
                    <span>傷・汚れマーキング</span>
                  </div>
                  <button type="button" class="pur-damage-marker-toggle" onclick="purToggleBatchDamageMarker()">
                    <span id="pur-batch-damage-marker-toggle-text">開く</span>
                  </button>
                </div>

                <div class="pur-damage-marker-canvas-container" id="pur-batch-damage-marker-container">
                  <div id="pur-batch-damage-marker-no-category" class="pur-damage-marker-no-category">
                    <i class="bi bi-info-circle"></i>
                    <span>小分類を選択すると画像が表示されます</span>
                  </div>

                  <div class="pur-damage-marker-side-toggle" id="pur-batch-damage-marker-side-toggle" style="display: none;">
                    <button type="button" class="pur-side-toggle-btn active" id="pur-batch-side-front-btn" onclick="purSwitchBatchDamageMarkerSide('front')">
                      <i class="bi bi-front"></i> 表
                      <span class="pur-side-saved-badge" id="pur-batch-front-saved-badge" style="display: none;">&#9679;</span>
                    </button>
                    <button type="button" class="pur-side-toggle-btn" id="pur-batch-side-back-btn" onclick="purSwitchBatchDamageMarkerSide('back')">
                      <i class="bi bi-back"></i> 裏
                      <span class="pur-side-saved-badge" id="pur-batch-back-saved-badge" style="display: none;">&#9679;</span>
                    </button>
                  </div>

                  <div class="pur-damage-marker-canvas-wrapper" id="pur-batch-damage-marker-wrapper" style="display: none;">
                    <canvas id="pur-batch-damage-marker-canvas" class="pur-damage-marker-canvas" width="300" height="300"></canvas>
                  </div>

                  <div class="pur-damage-marker-tools" id="pur-batch-damage-marker-tools" style="display: none;">
                    <button type="button" class="pur-damage-marker-tool active" data-tool="circle" onclick="purSetBatchDamageMarkerTool('circle')" title="丸">
                      <i class="bi bi-circle"></i>
                    </button>
                    <button type="button" class="pur-damage-marker-tool" data-tool="text" onclick="purSetBatchDamageMarkerTool('text')" title="テキスト">
                      <i class="bi bi-fonts"></i>
                    </button>
                    <button type="button" class="pur-damage-marker-tool" data-tool="pen" onclick="purSetBatchDamageMarkerTool('pen')" title="ペン">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <div class="pur-damage-marker-colors">
                      <button type="button" class="pur-damage-marker-color red active" onclick="purSetBatchDamageMarkerColor('#ef4444')"></button>
                      <button type="button" class="pur-damage-marker-color blue" onclick="purSetBatchDamageMarkerColor('#3b82f6')"></button>
                      <button type="button" class="pur-damage-marker-color black" onclick="purSetBatchDamageMarkerColor('#1f2937')"></button>
                    </div>
                  </div>

                  <div class="pur-damage-marker-note" id="pur-batch-damage-marker-note" style="display: none; margin-top: 8px;">
                    <textarea id="pur-batch-damage-marker-note-text" placeholder="補足説明（例：左袖に汚れあり）" rows="2" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; resize: none;"></textarea>
                  </div>

                  <div class="pur-damage-marker-actions" id="pur-batch-damage-marker-actions" style="display: none;">
                    <button type="button" class="pur-damage-marker-btn" onclick="purClearBatchDamageMarker()">クリア</button>
                    <button type="button" class="pur-damage-marker-btn" onclick="purUndoBatchDamageMarker()" title="元に戻す"><i class="bi bi-arrow-counterclockwise"></i></button>
                    <button type="button" class="pur-damage-marker-btn" onclick="purRedoBatchDamageMarker()" title="やり直す"><i class="bi bi-arrow-clockwise"></i></button>
                    <button type="button" class="pur-damage-marker-btn primary" onclick="purSaveBatchDamageMarker()">保存</button>
                  </div>

                  <div class="pur-damage-marker-object-controls" id="pur-batch-damage-marker-object-controls" style="display: none;">
                    <span class="pur-object-controls-label">選択中:</span>
                    <button type="button" class="pur-damage-marker-btn" onclick="purShrinkBatchSelectedObject()">
                      <i class="bi bi-dash-circle"></i> 縮小
                    </button>
                    <button type="button" class="pur-damage-marker-btn" onclick="purEnlargeBatchSelectedObject()">
                      <i class="bi bi-plus-circle"></i> 拡大
                    </button>
                    <button type="button" class="pur-damage-marker-btn danger" onclick="purDeleteBatchSelectedObject()">
                      <i class="bi bi-eraser-fill"></i> 削除
                    </button>
                  </div>

                  <div class="pur-damage-marker-preview" id="pur-batch-damage-marker-preview" style="display: none;">
                    <img id="pur-batch-damage-marker-preview-img" src="" alt="保存済みマーキング">
                    <div class="pur-damage-marker-preview-label">保存済み</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 個別入力モード -->
      <div class="pur-entry-card" id="pur-individualEntrySection">
        <div class="pur-default-settings-section mb-3">
          <div class="pur-default-settings-header">
            <i class="bi bi-gear"></i>
            <span>デフォルト設定</span>
            <small class="text-muted ms-2">（変更すると全商品に反映）</small>
          </div>
          <div class="mt-2">
            <label class="form-label">仕入日</label>
            <input type="date" class="form-control" id="pur-defaultPurchaseDate" onchange="purApplyDefaultToAllItems('purchaseDate')">
          </div>
          <div class="mt-2">
            <label class="form-label">仕入先</label>
            <select class="form-select" id="pur-defaultSupplier" onchange="purApplyDefaultToAllItems('supplier')">
              <option value="">--選択--</option>
            </select>
          </div>
          <div class="mt-2">
            <label class="form-label">発送先</label>
            <select class="form-select" id="pur-entryAssigneeIndividual" onchange="purApplyDefaultToAllItems('assignee')">
              <option value="">--選択--</option>
            </select>
          </div>
          <div class="mt-2">
            <label class="form-label">仕入金額</label>
            <div class="input-group">
              <span class="input-group-text">¥</span>
              <input type="number" class="form-control" id="pur-defaultAmount" min="0" placeholder="0" onchange="purApplyDefaultToAllItems('amount')">
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">商品リスト</label>
          <div id="pur-entryItemsContainer">
            <div class="text-center text-muted py-3">
              <i class="bi bi-hourglass-split"></i> 読み込み中...
            </div>
          </div>
          <button type="button" class="pur-entry-add-item-btn" onclick="purAddEntryItem()">
            <i class="bi bi-plus-circle"></i> 商品を追加
          </button>
        </div>

        <div class="pur-entry-total-card">
          <div class="pur-entry-total-label">合計金額</div>
          <div class="pur-entry-total-value" id="pur-entryTotalValue">¥0</div>
          <div class="pur-entry-total-count" id="pur-entryTotalCount">0点</div>
        </div>
      </div>

      <!-- QRコード生成ボタン -->
      <div class="d-grid mt-3">
        <button class="btn pur-btn-entry-teal btn-lg" onclick="purGenerateEntryQRCodes()">
          <i class="bi bi-qr-code"></i> QRコードを生成
        </button>
      </div>

      <!-- QRコードプレビュー -->
      <div class="pur-entry-card" id="pur-qrEntryPreview" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="fw-bold"><i class="bi bi-grid-3x3"></i> QRコードプレビュー</div>
          <span class="badge bg-success" id="pur-qrEntryCount">0枚</span>
        </div>

        <div class="pur-entry-print-mode-tabs mb-3">
          <div class="pur-entry-print-mode-tab active" onclick="purSetEntryPrintMode('label')" id="pur-entryPrintModeLabel">
            <i class="bi bi-layout-wtf"></i> ラベルシート
          </div>
          <div class="pur-entry-print-mode-tab" onclick="purSetEntryPrintMode('simple')" id="pur-entryPrintModeSimple">
            <i class="bi bi-grid-3x3-gap"></i> シンプル
          </div>
        </div>

        <!-- シンプル印刷モード -->
        <div id="pur-entrySimplePrintSection" style="display: none;">
          <div class="d-flex gap-2 mb-3">
            <button class="btn btn-outline-warning flex-fill" onclick="purPrintEntrySimple()">
              <i class="bi bi-printer"></i> 印刷
            </button>
            <button class="btn btn-outline-warning flex-fill" onclick="purDownloadEntryQRCodes()">
              <i class="bi bi-download"></i> PDF保存
            </button>
          </div>

          <button class="btn btn-sm btn-outline-secondary w-100 mb-2" type="button" id="pur-simpleSettingsToggleBtn" onclick="purToggleSimpleSettings()">
            <i class="bi bi-sliders" id="pur-simpleSettingsIcon"></i> <span id="pur-simpleSettingsToggleText">詳細設定</span>
          </button>

          <div class="pur-entry-custom-settings mb-3" id="pur-simpleCustomSettings" style="display: none;">
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">上余白 (mm)</label>
                <input type="number" class="form-control form-control-sm" id="pur-simpleMarginTop" value="15" step="0.5">
              </div>
              <div class="col-6">
                <label class="form-label">左余白 (mm)</label>
                <input type="number" class="form-control form-control-sm" id="pur-simpleMarginLeft" value="15" step="0.5">
              </div>
              <div class="col-6">
                <label class="form-label">QRサイズ (mm)</label>
                <input type="number" class="form-control form-control-sm" id="pur-simpleQrSize" value="25" step="1">
              </div>
              <div class="col-6">
                <label class="form-label">間隔 (mm)</label>
                <input type="number" class="form-control form-control-sm" id="pur-simpleGap" value="10" step="1">
              </div>
            </div>
            <div class="d-flex gap-2 mt-2">
              <button class="btn btn-sm btn-primary flex-fill" onclick="purSaveSimpleSettings()">
                <i class="bi bi-check-lg"></i> 設定を保存
              </button>
              <button class="btn btn-sm btn-outline-secondary flex-fill" onclick="purResetSimpleSettings()">
                <i class="bi bi-arrow-counterclockwise"></i> デフォルト
              </button>
            </div>
          </div>

          <div class="pur-qr-entry-grid" id="pur-qrEntryGrid"></div>
        </div>

        <!-- ラベルシート印刷モード -->
        <div id="pur-entryLabelPrintSection">
          <div class="mb-3">
            <label class="form-label fw-bold">ラベルシートを選択</label>
            <div class="row g-2" id="pur-entryLabelPresets">
              <div class="col-6">
                <div class="pur-entry-label-preset-btn active" onclick="purSelectEntryLabelPreset('70face')" data-preset="70face">
                  <div class="pur-preset-name">70面</div>
                  <div class="pur-preset-info">20x20mm</div>
                </div>
              </div>
              <div class="col-6">
                <div class="pur-entry-label-preset-btn" onclick="purSelectEntryLabelPreset('24face')" data-preset="24face">
                  <div class="pur-preset-name">24面</div>
                  <div class="pur-preset-info">66x33.9mm</div>
                </div>
              </div>
              <div class="col-6">
                <div class="pur-entry-label-preset-btn" onclick="purSelectEntryLabelPreset('44face')" data-preset="44face">
                  <div class="pur-preset-name">44面</div>
                  <div class="pur-preset-info">48.3x25.4mm</div>
                </div>
              </div>
            </div>

            <button class="btn btn-sm btn-outline-secondary w-100 mt-2" type="button" id="pur-labelSettingsToggleBtn" onclick="purToggleLabelSettings()">
              <i class="bi bi-sliders" id="pur-labelSettingsIcon"></i> <span id="pur-labelSettingsToggleText">詳細設定</span>
            </button>

            <div class="pur-entry-custom-settings mt-2" id="pur-entryCustomSettings" style="display: none;">
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label">幅 (mm)</label>
                  <input type="number" class="form-control form-control-sm" id="pur-entryLabelWidth" value="20" onchange="purUpdateEntryLabelPreview()">
                </div>
                <div class="col-6">
                  <label class="form-label">高さ (mm)</label>
                  <input type="number" class="form-control form-control-sm" id="pur-entryLabelHeight" value="20" onchange="purUpdateEntryLabelPreview()">
                </div>
                <div class="col-6">
                  <label class="form-label">列数</label>
                  <input type="number" class="form-control form-control-sm" id="pur-entryLabelCols" value="7" onchange="purUpdateEntryLabelPreview()">
                </div>
                <div class="col-6">
                  <label class="form-label">行数</label>
                  <input type="number" class="form-control form-control-sm" id="pur-entryLabelRows" value="10" onchange="purUpdateEntryLabelPreview()">
                </div>
                <div class="col-6">
                  <label class="form-label">上余白 (mm)</label>
                  <input type="number" class="form-control form-control-sm" id="pur-entryMarginTop" value="22.5" step="0.5" onchange="purUpdateEntryLabelPreview()">
                </div>
                <div class="col-6">
                  <label class="form-label">左余白 (mm)</label>
                  <input type="number" class="form-control form-control-sm" id="pur-entryMarginLeft" value="23" step="0.5" onchange="purUpdateEntryLabelPreview()">
                </div>
                <div class="col-6">
                  <label class="form-label">横間隔 (mm)</label>
                  <input type="number" class="form-control form-control-sm" id="pur-entryGapX" value="4" step="0.5" onchange="purUpdateEntryLabelPreview()">
                </div>
                <div class="col-6">
                  <label class="form-label">縦間隔 (mm)</label>
                  <input type="number" class="form-control form-control-sm" id="pur-entryGapY" value="4" step="0.5" onchange="purUpdateEntryLabelPreview()">
                </div>
                <div class="col-6">
                  <label class="form-label">QRサイズ (mm)</label>
                  <input type="number" class="form-control form-control-sm" id="pur-entryQrSize" value="15" step="0.5" onchange="purUpdateEntryLabelPreview()">
                </div>
              </div>
              <div class="d-flex gap-2 mt-2">
                <button class="btn btn-sm btn-outline-primary" onclick="purSaveEntryLabelSettings()">
                  <i class="bi bi-save"></i> 設定を保存
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="purResetEntryLabelToDefault()">
                  <i class="bi bi-arrow-counterclockwise"></i> デフォルトに戻す
                </button>
              </div>
            </div>
          </div>

          <div class="alert alert-info py-2 small">
            <i class="bi bi-info-circle"></i>
            <span id="pur-entryLabelInfo">70面ラベル: 1シートあたり70枚印刷可能</span>
            <br>
            <span id="pur-entrySheetInfo">必要シート数: 1枚</span>
          </div>

          <div class="mb-3">
            <label class="form-label">印刷開始位置</label>
            <div class="input-group">
              <input type="number" class="form-control" id="pur-entryStartPosition" value="1" min="1" onchange="purUpdateEntryLabelPreview()">
              <span class="input-group-text">番目から</span>
            </div>
            <small class="text-muted">途中から印刷する場合に使用</small>
          </div>

          <div class="d-grid mb-3">
            <button class="btn pur-btn-entry-teal" onclick="purPrintEntryLabelSheet()">
              <i class="bi bi-printer"></i> ラベルシート印刷
            </button>
          </div>

          <div class="text-center">
            <small class="text-muted mb-2 d-block">プレビュー（縮小表示）</small>
          </div>
          <div id="pur-entryLabelSheetContainer"></div>
        </div>

        <div class="mt-3">
          <small class="text-muted">
            <i class="bi bi-info-circle"></i>
            QRコードを印刷して、各商品に貼り付けてください。
          </small>
        </div>
      </div>

      <!-- ラベルシート印刷用の隠しエリア -->
      <div id="pur-entryLabelPrintArea" style="display: none;"></div>

      <!-- 登録完了後のアクション -->
      <div class="pur-entry-card" id="pur-entryAfterActions" style="display: none;">
        <div class="d-flex align-items-center gap-2 mb-3">
          <i class="bi bi-check-circle-fill text-success fs-4"></i>
          <span class="fw-bold">仕入登録完了</span>
        </div>
        <p class="mb-3">仕入ID: <strong id="pur-entryPurchaseId"></strong></p>
        <p class="mb-2">発送先: <strong id="pur-entryAssigneeName"></strong></p>

        <div id="pur-dispatchNotificationArea" style="display: none;" class="mb-3">
          <div class="alert alert-info py-2 mb-2" style="font-size: 0.9rem;">
            <i class="bi bi-info-circle"></i> 発送先スタッフにタスク通知を送信できます
          </div>
          <button class="btn btn-primary w-100" onclick="purSendDispatchNotification()" id="pur-btnSendDispatch">
            <i class="bi bi-send"></i> 発送通知を送信
          </button>
          <div id="pur-dispatchNotificationSent" style="display: none;" class="alert alert-success py-2 mt-2">
            <i class="bi bi-check-circle"></i> 発送通知を送信しました
          </div>
        </div>

        <div class="d-grid gap-2">
          <button class="btn pur-btn-entry-teal" onclick="purResetEntryForm()">
            <i class="bi bi-plus-circle"></i> 続けて仕入登録
          </button>
        </div>
      </div>
    </div>

    <!-- 仕入一覧タブ -->
    <div class="pur-tab-content" id="pur-purchase-content">
      <div class="pur-filter-section">
        <div class="row g-2 align-items-center">
          <div class="col-auto">
            <label class="form-label mb-0 small fw-bold">期間:</label>
          </div>
          <div class="col">
            <input type="month" class="form-control form-control-sm" id="pur-purchaseMonth" onchange="purLoadPurchaseData()">
          </div>
          <div class="col-auto">
            <label class="form-label mb-0 small fw-bold">仕入先:</label>
          </div>
          <div class="col">
            <select class="form-select form-select-sm" id="pur-supplierFilter" onchange="purLoadPurchaseData()">
              <option value="">すべて</option>
            </select>
          </div>
        </div>
      </div>

      <div class="pur-summary-grid">
        <div class="pur-summary-card">
          <div class="pur-summary-label">仕入件数</div>
          <div class="pur-summary-value" id="pur-summary-purchaseCount">-</div>
        </div>
        <div class="pur-summary-card">
          <div class="pur-summary-label">仕入合計</div>
          <div class="pur-summary-value" id="pur-summary-purchaseAmount">-</div>
        </div>
        <div class="pur-summary-card">
          <div class="pur-summary-label">平均仕入単価</div>
          <div class="pur-summary-value" id="pur-summary-avgPurchase">-</div>
        </div>
        <div class="pur-summary-card">
          <div class="pur-summary-label">支払済</div>
          <div class="pur-summary-value" id="pur-summary-paidAmount">-</div>
        </div>
      </div>

      <div class="pur-data-table-container">
        <div class="table-responsive">
          <table class="pur-data-table">
            <thead>
              <tr>
                <th>仕入日</th>
                <th>管理番号</th>
                <th>商品名</th>
                <th>仕入先</th>
                <th class="text-end">仕入金額</th>
                <th>支払</th>
              </tr>
            </thead>
            <tbody id="pur-purchaseTableBody">
              <tr>
                <td colspan="6" class="text-center text-muted py-4">データを読み込んでいます...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 買掛管理タブ -->
    <div class="pur-tab-content" id="pur-payable-content">
      <div class="pur-summary-grid">
        <div class="pur-summary-card">
          <div class="pur-summary-label">買掛残高</div>
          <div class="pur-summary-value danger" id="pur-payable-balance">-</div>
        </div>
        <div class="pur-summary-card">
          <div class="pur-summary-label">未払件数</div>
          <div class="pur-summary-value" id="pur-payable-count">-</div>
        </div>
        <div class="pur-summary-card">
          <div class="pur-summary-label">今月支払予定</div>
          <div class="pur-summary-value warning" id="pur-payable-expected">-</div>
        </div>
      </div>

      <div class="alert alert-warning mb-3" id="pur-overduePayableAlert" style="display: none;">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <strong>支払遅延アラート:</strong> <span id="pur-overduePayableText"></span>
      </div>

      <div class="pur-payable-sub-tabs">
        <button class="pur-payable-sub-tab active" onclick="purSwitchPayableSubTab(this, 'list')">
          <i class="bi bi-list-ul"></i> 一覧
        </button>
        <button class="pur-payable-sub-tab" onclick="purSwitchPayableSubTab(this, 'supplier')">
          <i class="bi bi-shop"></i> 仕入先別
        </button>
        <button class="pur-payable-sub-tab" onclick="purSwitchPayableSubTab(this, 'schedule')">
          <i class="bi bi-calendar3"></i> 支払予定
        </button>
      </div>

      <div class="pur-payable-sub-content active" id="pur-payable-sub-list">
        <div class="pur-data-table-container">
          <div class="table-responsive">
            <table class="pur-data-table">
              <thead>
                <tr>
                  <th>仕入日</th>
                  <th>管理番号</th>
                  <th>仕入先</th>
                  <th class="text-end">仕入金額</th>
                  <th>ステータス</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="pur-payableTableBody">
                <tr>
                  <td colspan="6" class="text-center text-muted py-4">データを読み込んでいます...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="pur-payable-sub-content" id="pur-payable-sub-supplier">
        <div id="pur-supplierGroups">
          <div class="text-center text-muted py-4">データを読み込んでいます...</div>
        </div>
      </div>

      <div class="pur-payable-sub-content" id="pur-payable-sub-schedule">
        <h6 class="mb-3"><i class="bi bi-shop"></i> 仕入先別買掛残高</h6>
        <div class="pur-summary-grid mb-4" id="pur-supplierBalanceGrid"></div>

        <h6 class="mb-3"><i class="bi bi-calendar3"></i> 支払予定スケジュール</h6>
        <div class="alert alert-info small mb-3">
          <i class="bi bi-info-circle"></i> 支払予定日は仕入日から30日後を目安としています。
        </div>
        <div class="pur-data-table-container">
          <div class="table-responsive">
            <table class="pur-data-table">
              <thead>
                <tr>
                  <th>支払予定日</th>
                  <th>仕入先</th>
                  <th>件数</th>
                  <th class="text-end">支払予定額</th>
                  <th>状態</th>
                </tr>
              </thead>
              <tbody id="pur-paymentScheduleBody">
                <tr>
                  <td colspan="5" class="text-center text-muted py-4">データを読み込んでいます...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 発送進捗タブ -->
    <div class="pur-tab-content" id="pur-dispatch-progress-content">
      <div class="alert alert-info small mb-3">
        <i class="bi bi-info-circle"></i> 発送済みの仕入バッチの商品登録進捗を確認できます。
      </div>

      <div class="row g-2 mb-3">
        <div class="col-auto">
          <select class="form-select form-select-sm" id="pur-dispatchStatusFilter" onchange="purFilterDispatchProgress()">
            <option value="all">すべて</option>
            <option value="pending">未発送</option>
            <option value="shipped">発送済み</option>
            <option value="received">受取済み</option>
            <option value="registering">登録中</option>
            <option value="completed">完了</option>
          </select>
        </div>
      </div>

      <div class="pur-data-table-container">
        <div class="table-responsive">
          <table class="pur-data-table">
            <thead>
              <tr>
                <th>仕入日</th>
                <th>仕入先</th>
                <th>点数</th>
                <th>発送先</th>
                <th>検品担当</th>
                <th>検品</th>
                <th>ステータス</th>
                <th>登録進捗</th>
              </tr>
            </thead>
            <tbody id="pur-dispatchProgressBody">
              <tr>
                <td colspan="8" class="text-center text-muted py-4">タブをクリックしてデータを読み込んでください</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 検品依頼タブ -->
    <div class="pur-tab-content" id="pur-inspection-request-content">
      <div class="alert alert-info small mb-3">
        <i class="bi bi-info-circle"></i> 検品作業の依頼を作成・管理します。担当者にタスクとして割り当てられます。
      </div>

      <div class="mb-3">
        <button class="btn btn-warning" onclick="purShowCreateInspectionRequestModal()">
          <i class="bi bi-plus-circle"></i> 新規検品依頼
        </button>
      </div>

      <div class="row g-2 mb-3">
        <div class="col-auto">
          <select class="form-select form-select-sm" id="pur-inspectionRequestStatusFilter" onchange="purFilterInspectionRequests()">
            <option value="all">すべて</option>
            <option value="pending">未着手</option>
            <option value="in_progress">作業中</option>
            <option value="completed">完了</option>
          </select>
        </div>
      </div>

      <div class="pur-data-table-container">
        <div class="table-responsive">
          <table class="pur-data-table">
            <thead>
              <tr>
                <th>依頼日</th>
                <th>仕入先</th>
                <th>予定点数</th>
                <th>担当者</th>
                <th>期限</th>
                <th>進捗</th>
                <th>ステータス</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="pur-inspectionRequestBody">
              <tr>
                <td colspan="8" class="text-center text-muted py-4">タブをクリックしてデータを読み込んでください</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 支払記録モーダル -->
  <div class="pur-modal-overlay" id="pur-paymentModal">
    <div class="pur-modal-dialog">
      <div class="pur-modal-header">
        <h5>支払記録</h5>
        <button class="pur-modal-close" onclick="purCloseModal('pur-paymentModal')">&times;</button>
      </div>
      <div class="pur-modal-body">
        <div class="mb-3">
          <label class="form-label">管理番号</label>
          <input type="text" class="form-control" id="pur-paymentManagementNumber" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label">仕入先</label>
          <input type="text" class="form-control" id="pur-paymentSupplier" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label">仕入金額</label>
          <input type="text" class="form-control" id="pur-paymentPurchaseAmount" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label">支払日</label>
          <input type="date" class="form-control" id="pur-paymentDate">
        </div>
        <div class="mb-3">
          <label class="form-label">支払額</label>
          <input type="number" class="form-control" id="pur-paymentAmount" placeholder="支払額を入力">
        </div>
        <div class="mb-3">
          <label class="form-label">支払方法</label>
          <select class="form-select" id="pur-paymentMethod">
            <option value="現金">現金</option>
            <option value="銀行振込">銀行振込</option>
            <option value="クレジットカード">クレジットカード</option>
            <option value="電子マネー">電子マネー</option>
            <option value="その他">その他</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">備考</label>
          <textarea class="form-control" id="pur-paymentNote" rows="2" placeholder="振込手数料など"></textarea>
        </div>
      </div>
      <div class="pur-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="purCloseModal('pur-paymentModal')">キャンセル</button>
        <button type="button" class="btn btn-warning" onclick="purSavePayment()">支払を記録</button>
      </div>
    </div>
  </div>

  <!-- 帳簿出力モーダル -->
  <div class="pur-modal-overlay" id="pur-exportModal">
    <div class="pur-modal-dialog">
      <div class="pur-modal-header">
        <h5>仕入帳出力（確定申告用）</h5>
        <button class="pur-modal-close" onclick="purCloseModal('pur-exportModal')">&times;</button>
      </div>
      <div class="pur-modal-body">
        <div class="mb-3">
          <label class="form-label fw-bold">出力形式</label>
          <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="pur-exportFormat" id="pur-formatCSV" value="csv" checked>
            <label class="btn btn-outline-warning" for="pur-formatCSV">CSV</label>
            <input type="radio" class="btn-check" name="pur-exportFormat" id="pur-formatExcel" value="excel">
            <label class="btn btn-outline-warning" for="pur-formatExcel">Excel形式</label>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">出力期間</label>
          <select class="form-select" id="pur-exportPeriod" onchange="purUpdateExportDates()">
            <option value="month">月別</option>
            <option value="quarter">四半期</option>
            <option value="year">年度（確定申告用）</option>
            <option value="custom">カスタム</option>
          </select>
        </div>
        <div class="row g-2 mb-3" id="pur-exportDateRange">
          <div class="col-6">
            <label class="form-label">開始日</label>
            <input type="date" class="form-control" id="pur-exportStartDate">
          </div>
          <div class="col-6">
            <label class="form-label">終了日</label>
            <input type="date" class="form-control" id="pur-exportEndDate">
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">出力内容</label>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="pur-exportPurchaseDetail" checked>
            <label class="form-check-label" for="pur-exportPurchaseDetail">仕入明細</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="pur-exportPayable" checked>
            <label class="form-check-label" for="pur-exportPayable">買掛金一覧</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="pur-exportSupplierSummary" checked>
            <label class="form-check-label" for="pur-exportSupplierSummary">仕入先別集計</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="pur-exportMonthlySummary" checked>
            <label class="form-check-label" for="pur-exportMonthlySummary">月別サマリー（集計表）</label>
          </div>
        </div>
        <div class="alert alert-warning small mb-0">
          <i class="bi bi-info-circle"></i> 確定申告用には「年度」を選択し、全ての出力内容をチェックしてください。
        </div>
      </div>
      <div class="pur-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="purCloseModal('pur-exportModal')">キャンセル</button>
        <button type="button" class="btn btn-warning" onclick="purExportData()">
          <i class="bi bi-download"></i> ダウンロード
        </button>
      </div>
    </div>
  </div>

  <!-- 支払通知書発行モーダル -->
  <div class="pur-modal-overlay" id="pur-paymentNoticeModal">
    <div class="pur-modal-dialog modal-lg">
      <div class="pur-modal-header" style="background: #f59e0b; color: white;">
        <h5>支払通知書発行</h5>
        <button class="pur-modal-close" style="color: white;" onclick="purCloseModal('pur-paymentNoticeModal')">&times;</button>
      </div>
      <div class="pur-modal-body">
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label fw-bold">支払先（仕入先）</label>
            <input type="text" class="form-control" id="pur-paymentNoticeSupplier" placeholder="支払先名を入力">
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold">支払日</label>
            <input type="date" class="form-control" id="pur-paymentNoticeDate">
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label fw-bold">通知番号</label>
            <input type="text" class="form-control" id="pur-paymentNoticeNumber" placeholder="自動生成">
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold">支払方法</label>
            <select class="form-select" id="pur-paymentNoticeMethod">
              <option value="振込">銀行振込</option>
              <option value="現金">現金</option>
              <option value="クレジット">クレジットカード</option>
              <option value="その他">その他</option>
            </select>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">支払明細</label>
          <div class="table-responsive">
            <table class="table table-sm table-bordered" id="pur-paymentNoticeItemsTable">
              <thead class="table-light">
                <tr>
                  <th>仕入日</th>
                  <th>内容</th>
                  <th class="text-end" style="width: 120px;">金額</th>
                  <th style="width: 40px;"></th>
                </tr>
              </thead>
              <tbody id="pur-paymentNoticeItemsBody"></tbody>
              <tfoot>
                <tr>
                  <td colspan="4">
                    <button type="button" class="btn btn-sm btn-outline-warning" onclick="purAddPaymentNoticeItem()">
                      <i class="bi bi-plus"></i> 行を追加
                    </button>
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label">小計</label>
            <div class="input-group">
              <span class="input-group-text">¥</span>
              <input type="text" class="form-control text-end" id="pur-paymentNoticeSubtotal" readonly>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold">支払合計</label>
            <div class="input-group">
              <span class="input-group-text">¥</span>
              <input type="text" class="form-control text-end fw-bold" id="pur-paymentNoticeTotal" readonly>
            </div>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">備考</label>
          <textarea class="form-control" id="pur-paymentNoticeNote" rows="2" placeholder="振込先口座情報など"></textarea>
        </div>
      </div>
      <div class="pur-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="purCloseModal('pur-paymentNoticeModal')">キャンセル</button>
        <button type="button" class="btn btn-outline-warning" onclick="purPreviewPaymentNotice()">
          <i class="bi bi-eye"></i> プレビュー
        </button>
        <button type="button" class="btn btn-warning" onclick="purDownloadPaymentNoticePDF()">
          <i class="bi bi-download"></i> PDF出力
        </button>
      </div>
    </div>
  </div>

  <!-- 支払通知書プレビューモーダル -->
  <div class="pur-modal-overlay" id="pur-paymentNoticePreviewModal">
    <div class="pur-modal-dialog modal-lg">
      <div class="pur-modal-header" style="background: #f59e0b; color: white;">
        <h5>支払通知書プレビュー</h5>
        <button class="pur-modal-close" style="color: white;" onclick="purCloseModal('pur-paymentNoticePreviewModal')">&times;</button>
      </div>
      <div class="pur-modal-body" style="padding: 0;">
        <div id="pur-paymentNoticePreviewContent" style="background: white; padding: 40px;"></div>
      </div>
      <div class="pur-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="purCloseModal('pur-paymentNoticePreviewModal')">閉じる</button>
        <button type="button" class="btn btn-warning" onclick="purDownloadPaymentNoticePDF()">
          <i class="bi bi-download"></i> PDF出力
        </button>
      </div>
    </div>
  </div>

  <!-- ラベル印刷履歴モーダル -->
  <div class="pur-modal-overlay" id="pur-labelPrintHistoryModal">
    <div class="pur-modal-dialog">
      <div class="pur-modal-header">
        <h5><i class="bi bi-clock-history"></i> ラベル印刷履歴</h5>
        <button class="pur-modal-close" onclick="purCloseModal('pur-labelPrintHistoryModal')">&times;</button>
      </div>
      <div class="pur-modal-body" style="max-height: 400px; overflow-y: auto;">
        <div id="pur-labelPrintHistoryList" class="list-group list-group-flush"></div>
      </div>
    </div>
  </div>

  <!-- 検品依頼作成モーダル -->
  <div class="pur-modal-overlay" id="pur-createInspectionRequestModal">
    <div class="pur-modal-dialog">
      <div class="pur-modal-header" style="background: #f59e0b; color: white;">
        <h5>新規検品依頼</h5>
        <button class="pur-modal-close" style="color: white;" onclick="purCloseModal('pur-createInspectionRequestModal')">&times;</button>
      </div>
      <div class="pur-modal-body">
        <div class="mb-3">
          <label class="form-label">仕入先 <span class="text-danger">*</span></label>
          <select class="form-select" id="pur-inspectionRequestSupplier" required>
            <option value="">選択してください</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">予定点数 <span class="text-danger">*</span></label>
          <input type="number" class="form-control" id="pur-inspectionRequestCount" min="1" placeholder="商品点数を入力" required>
        </div>
        <div class="mb-3">
          <label class="form-label">担当者 <span class="text-danger">*</span></label>
          <select class="form-select" id="pur-inspectionRequestAssignee" required>
            <option value="">選択してください</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">期限</label>
          <input type="date" class="form-control" id="pur-inspectionRequestDueDate">
        </div>
        <div class="mb-3">
          <label class="form-label">備考</label>
          <textarea class="form-control" id="pur-inspectionRequestNote" rows="2" placeholder="特記事項があれば入力"></textarea>
        </div>
      </div>
      <div class="pur-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="purCloseModal('pur-createInspectionRequestModal')">キャンセル</button>
        <button type="button" class="btn btn-warning" onclick="purCreateInspectionRequest()">
          <i class="bi bi-check-circle"></i> 依頼を作成
        </button>
      </div>
    </div>
  </div>

  <!-- QR確認 フローティングボタン -->
  <button class="pur-qr-floating-btn" onclick="purOpenQRCheckScanner()" title="QRコードをスキャン">
    <img src="/images/qr-scan-icon.png" alt="QRスキャン">
  </button>

  <!-- QR確認スキャナーモーダル -->
  <div id="pur-qrCheckScannerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center;">
    <div style="background: white; border-radius: 16px; width: 90%; max-width: 400px; overflow: hidden;">
      <div style="padding: 16px; background: linear-gradient(135deg, #4ECDC4, #44A08D); color: white; display: flex; justify-content: space-between; align-items: center;">
        <span style="font-weight: 600;"><i class="bi bi-qr-code-scan"></i> QRコード情報確認</span>
        <button onclick="purCloseQRCheckScanner()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
      </div>
      <div id="pur-qrCheckReader" style="width: 100%;"></div>
      <div style="padding: 16px; text-align: center;">
        <p style="font-size: 14px; color: #6b7280; margin-bottom: 0;">仕入商品のQRコードをカメラにかざしてください</p>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // Purchase SPA Fragment - JavaScript
    // ============================================
    console.log('[Pur SPA] purchase fragment loaded');

    // ============================================
    // Global variables (prefixed _pur_)
    // ============================================
    var _pur_currentPurchaseData = [];
    var _pur_selectedProductForPayment = null;
    var _pur_entrySuppliersData = [];
    var _pur_entryAssigneesData = [];
    var _pur_currentEntryMode = 'individual';
    var _pur_entryItems = [];
    var _pur_entryCategoryRows = [];
    var _pur_entryMasterOptions = {};
    var _pur_entryGeneratedQRData = [];
    var _pur_currentEntryPrintMode = 'label';
    var _pur_dropdownClickHandler = null;
    var _pur_html5QrCode = null;
    var _pur_qrCheckHistory = [];
    var _pur_dispatchProgressData = [];
    var _pur_inspectionRequestsData = [];
    var _pur_damageMarkerState = new Map();
    var _pur_batchDamageMarkerState = {
      currentSide: 'front',
      currentTool: 'circle',
      currentColor: '#ef4444',
      objects: [],
      history: [],
      historyIndex: -1,
      selectedObject: null,
      isDragging: false,
      isResizing: false,
      canvas: null,
      ctx: null,
      bgImage: null,
      currentSubcategory: '',
      currentFineCategory: '',
      frontState: null,
      backState: null,
      savedFront: null,
      savedBack: null
    };
    var _pur_entryItemNextId = 1;

    // シンプル印刷設定
    var _pur_simpleSettingsDefault = { marginTop: 15, marginLeft: 15, qrSize: 25, gap: 10 };
    var _pur_currentSimpleSettings = { marginTop: 15, marginLeft: 15, qrSize: 25, gap: 10 };

    // ラベル設定
    var _pur_currentEntryLabelSettings = {
      name: '70面', labelWidth: 20, labelHeight: 20, cols: 7, rows: 10,
      marginTop: 22, marginLeft: 11.5, gapX: 4, gapY: 4, perSheet: 70
    };
    var _pur_currentEntryPresetKey = '70face';
    var _pur_entryLabelPresetsDefault = {
      '70face': { name: '70面', labelWidth: 20, labelHeight: 20, cols: 7, rows: 10, marginTop: 31.5, marginLeft: 24, gapX: 4, gapY: 4, qrSize: 15, perSheet: 70 },
      '24face': { name: '24面', labelWidth: 66, labelHeight: 33.9, cols: 3, rows: 8, marginTop: 8.5, marginLeft: 5, gapX: 2.5, gapY: 0, qrSize: 25, perSheet: 24 },
      '44face': { name: '44面', labelWidth: 48.3, labelHeight: 25.4, cols: 4, rows: 11, marginTop: 12.7, marginLeft: 7, gapX: 2.5, gapY: 0, qrSize: 19, perSheet: 44 }
    };
    var _pur_entryLabelPresets = {
      '70face': Object.assign({}, _pur_entryLabelPresetsDefault['70face']),
      '24face': Object.assign({}, _pur_entryLabelPresetsDefault['24face']),
      '44face': Object.assign({}, _pur_entryLabelPresetsDefault['44face'])
    };

    // マスタデータキャッシュ
    var _pur_MASTER_CACHE_KEY = 'reborn_master_cache';
    var _pur_MASTER_CACHE_EXPIRY = 24 * 60 * 60 * 1000;
    var _pur_saveDraftTimer = null;

    // ============================================
    // Dynamic script loading helper
    // ============================================
    function _purLoadScript(src) {
      return new Promise(function(resolve, reject) {
        var existing = document.querySelector('script[src="' + src + '"]');
        if (existing) { resolve(); return; }
        var script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    // ============================================
    // Utility functions
    // ============================================
    function purShowLoading() {
      var el = document.getElementById('pur-loadingOverlay');
      if (el) el.style.display = 'flex';
    }
    function purHideLoading() {
      var el = document.getElementById('pur-loadingOverlay');
      if (el) el.style.display = 'none';
    }
    function purFormatCurrency(amount) {
      if (amount === null || amount === undefined || isNaN(amount)) return '-';
      return '\u00a5' + Math.round(amount).toLocaleString();
    }
    function purGetJSTToday() {
      var now = new Date();
      var jst = new Date(now.getTime() + (9 * 60 + now.getTimezoneOffset()) * 60000);
      var year = jst.getFullYear();
      var month = String(jst.getMonth() + 1).padStart(2, '0');
      var day = String(jst.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }
    function purGetJSTMonth() {
      var now = new Date();
      var jst = new Date(now.getTime() + (9 * 60 + now.getTimezoneOffset()) * 60000);
      return jst.getFullYear() + '-' + String(jst.getMonth() + 1).padStart(2, '0');
    }
    function purFormatDateLocal(date) {
      var year = date.getFullYear();
      var month = String(date.getMonth() + 1).padStart(2, '0');
      var day = String(date.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }
    function purUniqKeepOrder(arr) {
      var seen = {};
      return arr.filter(function(v) { if (!v || seen[v]) return false; seen[v] = true; return true; });
    }
    function purFillSelectSafe(sel, values) {
      if (!sel) return;
      var current = sel.value;
      sel.innerHTML = '<option value="">--選択してください--</option>';
      values.forEach(function(v) {
        if (!v) return;
        var opt = document.createElement('option');
        opt.value = v; opt.textContent = v;
        sel.appendChild(opt);
      });
      sel.disabled = values.length === 0;
      if (current && values.indexOf(current) >= 0) sel.value = current;
    }
    function purResetEntrySelect(id, disable) {
      if (disable === undefined) disable = true;
      var sel = document.getElementById(id);
      if (sel) { sel.innerHTML = '<option value="">--選択してください--</option>'; sel.disabled = disable; }
    }
    function purEscapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
    }
    function purHiraganaToKatakana(str) {
      if (!str) return '';
      return str.replace(/[\u3041-\u3096]/g, function(m) { return String.fromCharCode(m.charCodeAt(0) + 0x60); });
    }

    function purOpenModal(id) {
      var el = document.getElementById(id);
      if (el) el.classList.add('active');
    }
    function purCloseModal(id) {
      var el = document.getElementById(id);
      if (el) el.classList.remove('active');
    }

    // ============================================
    // Tab switching (custom, no Bootstrap)
    // ============================================
    function purSwitchTab(targetId) {
      var container = document.getElementById('spa-page-purchase');
      if (!container) return;
      container.querySelectorAll('.pur-tab-content').forEach(function(el) { el.classList.remove('active'); });
      container.querySelectorAll('.pur-nav-link').forEach(function(el) { el.classList.remove('active'); });
      var target = document.getElementById(targetId);
      if (target) target.classList.add('active');
      var btn = container.querySelector('[data-pur-target="' + targetId + '"]');
      if (btn) btn.classList.add('active');

      // Load data for specific tabs
      if (targetId === 'pur-purchase-content' || targetId === 'pur-payable-content') {
        purLoadPurchaseData();
      }
    }

    // ============================================
    // Header functions
    // ============================================
    function purToggleSettingsDropdown(event) {
      event.stopPropagation();
      var dropdown = document.getElementById('pur-settingsDropdown');
      if (dropdown) dropdown.classList.toggle('active');
    }
    function purCloseSettingsDropdown() {
      var dropdown = document.getElementById('pur-settingsDropdown');
      if (dropdown) dropdown.classList.remove('active');
    }
    function purOpenAnnouncePage() {
      if (typeof navigateToPage === 'function') {
        navigateToPage('announce');
      }
    }

    // ============================================
    // Firebase API layer (uses parent window.db)
    // ============================================
    function purGetSuppliers() {
      return window.db.collection('suppliers').get().then(function(snapshot) {
        var suppliers = [];
        snapshot.forEach(function(docSnap) {
          var data = docSnap.data();
          if (data.name) suppliers.push(data.name);
        });
        return suppliers.sort(function(a, b) { return a.localeCompare(b, 'ja'); });
      });
    }

    function purGetPurchaseData(yearMonth, supplier) {
      console.log('[Pur] データ取得開始:', yearMonth, supplier);
      return window.db.collection('products').get().then(function(snapshot) {
        var purchaseList = [];
        var startDate = '', endDate = '';
        if (yearMonth) {
          startDate = yearMonth + '-01';
          var nextMonth = new Date(yearMonth + '-01');
          nextMonth.setMonth(nextMonth.getMonth() + 1);
          nextMonth.setDate(0);
          endDate = purFormatDateLocal(nextMonth);
        }
        snapshot.forEach(function(docSnapshot) {
          var data = docSnapshot.data();
          var purchaseDate = (data.purchase && data.purchase.date) || data.purchaseDate || '';
          var purchaseSupplier = data.supplier || '';
          var purchaseAmount = parseFloat((data.purchase && data.purchase.amount) || data.purchaseAmount || 0);
          if (!purchaseAmount || purchaseAmount <= 0) return;
          if (yearMonth && (purchaseDate < startDate || purchaseDate > endDate)) return;
          if (supplier && purchaseSupplier !== supplier) return;
          purchaseList.push({
            id: docSnapshot.id,
            managementNumber: data.managementNumber || '',
            productName: data.productName || '',
            purchaseDate: purchaseDate,
            supplier: purchaseSupplier,
            purchaseAmount: purchaseAmount,
            purchasePaymentStatus: data.purchasePaymentStatus || 'unpaid',
            purchasePaymentDate: data.purchasePaymentDate || '',
            purchasePaymentAmount: parseFloat(data.purchasePaymentAmount || 0),
            purchasePaymentMethod: data.purchasePaymentMethod || ''
          });
        });
        purchaseList.sort(function(a, b) { return (b.purchaseDate || '').localeCompare(a.purchaseDate || ''); });
        console.log('[Pur] 取得完了:', purchaseList.length + '件');
        return purchaseList;
      });
    }

    function purUpdatePurchasePaymentStatus(productId, paymentData) {
      return window.db.collection('products').doc(productId).update({
        purchasePaymentStatus: paymentData.status,
        purchasePaymentDate: paymentData.date,
        purchasePaymentAmount: paymentData.amount,
        purchasePaymentMethod: paymentData.method,
        purchasePaymentNote: paymentData.note,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    function purGetEntrySuppliersData() {
      return window.db.collection('suppliers').get().then(function(snapshot) {
        var suppliers = [];
        snapshot.forEach(function(docSnap) {
          suppliers.push(Object.assign({ id: docSnap.id }, docSnap.data()));
        });
        return suppliers.sort(function(a, b) { return (a.name || '').localeCompare(b.name || '', 'ja'); });
      });
    }

    function purGetEntryAssigneesData() {
      return window.db.collection('users').where('status', '==', 'active').get().then(function(snapshot) {
        var assignees = [];
        snapshot.forEach(function(docSnap) {
          var data = docSnap.data();
          assignees.push({
            id: docSnap.id,
            name: data.userName || docSnap.id.split('@')[0],
            email: docSnap.id,
            userId: docSnap.id,
            note: data.permissionDisplay || ''
          });
        });
        return assignees.sort(function(a, b) { return (a.name || '').localeCompare(b.name || '', 'ja'); });
      });
    }

    function purGetCategoryMaster() {
      return window.db.collection('categories').doc('master').get().then(function(docSnap) {
        if (docSnap.exists) {
          var data = docSnap.data();
          var rows = data.rows || [];
          return rows.map(function(r) {
            return {
              '\u7279\u5927\u5206\u985e': String(r['\u7279\u5927\u5206\u985e'] || '').trim(),
              '\u5927\u5206\u985e': String(r['\u5927\u5206\u985e'] || '').trim(),
              '\u4e2d\u5206\u985e': String(r['\u4e2d\u5206\u985e'] || '').trim(),
              '\u5c0f\u5206\u985e': String(r['\u5c0f\u5206\u985e'] || '').trim(),
              '\u7d30\u5206\u985e': String(r['\u7d30\u5206\u985e1'] || r['\u7d30\u5206\u985e'] || '').trim(),
              '\u7d30\u5206\u985e2': String(r['\u7d30\u5206\u985e2'] || '').trim(),
              '\u30a2\u30a4\u30c6\u30e0\u540d': String(r['\u30a2\u30a4\u30c6\u30e0\u540d'] || '').trim()
            };
          });
        }
        return [];
      }).catch(function(err) { console.error('カテゴリマスタ取得エラー:', err); return []; });
    }

    function purGetMasterOptions() {
      return window.db.collection('masterOptions').doc('options').get().then(function(docSnap) {
        if (docSnap.exists) return docSnap.data();
        return {};
      }).catch(function(err) { console.error('マスターオプション取得エラー:', err); return {}; });
    }

    function purGetAllLabelSettings() {
      return window.db.collection('settings').doc('labelSettings').get().then(function(settingsSnap) {
        if (settingsSnap.exists) {
          var data = settingsSnap.data();
          return data.presets || null;
        }
        return null;
      }).catch(function(err) { console.error('ラベル設定取得エラー:', err); return null; });
    }

    function purSaveEntryLabelSettingsToFirestore(presetKey, settings) {
      var updateData = {};
      updateData['presets.' + presetKey] = settings;
      return window.db.collection('settings').doc('labelSettings').set(updateData, { merge: true })
        .then(function() { return true; })
        .catch(function(err) { console.error('ラベル設定保存エラー:', err); return false; });
    }

    function purSavePurchaseBatch(batchData) {
      var dateStr = batchData.purchaseDate.replace(/-/g, '');
      var randomStr = Math.random().toString(36).substring(2, 8);
      var batchId = 'BATCH-' + dateStr + '-' + randomStr;

      return window.db.collection('purchaseBatches').doc(batchId).set({
        batchId: batchId,
        purchaseDate: batchData.purchaseDate,
        supplier: batchData.supplier,
        totalAmount: batchData.totalAmount,
        itemCount: batchData.itemCount,
        assignee: batchData.assignee || '',
        assigneeUserId: batchData.assigneeUserId || null,
        memo: batchData.memo || '',
        status: 'pending',
        remainingCount: batchData.itemCount,
        registeredCount: 0,
        inspectionAssignee: batchData.inspectionAssignee || '',
        inspectionAssigneeUserId: batchData.inspectionAssigneeUserId || null,
        inspectionAssigneeEmail: batchData.inspectionAssigneeEmail || '',
        inspectionStatus: batchData.inspectionAssignee ? 'pending' : 'not_assigned',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(function() {
        // 検品タスク作成
        if (batchData.inspectionAssigneeEmail) {
          var staffEmail = batchData.inspectionAssigneeEmail;
          window.db.collection('userTasks').doc(staffEmail).collection('tasks').doc().set({
            type: 'inspection_task',
            title: '\u691c\u54c1\u4f5c\u696d: ' + batchData.supplier + ' (' + batchData.itemCount + '\u70b9)',
            description: '\u4ed5\u5165\u5148: ' + batchData.supplier + '\n\u4ed5\u5165\u65e5: ' + batchData.purchaseDate + '\n\u70b9\u6570: ' + batchData.itemCount + '\u70b9',
            createdAt: new Date().toISOString(),
            completed: false,
            priority: 'normal',
            link: '/purchase.html',
            relatedData: {
              batchId: batchId,
              supplier: batchData.supplier,
              itemCount: batchData.itemCount,
              purchaseDate: batchData.purchaseDate,
              staffEmail: staffEmail,
              staffName: batchData.inspectionAssignee
            }
          }).catch(function(err) { console.error('検品タスク作成エラー:', err); });
        }

        // スロット保存
        var slotsPromise = Promise.resolve();
        var slots = [];
        for (var i = 1; i <= batchData.itemCount; i++) {
          (function(idx) {
            var slotId = batchId + '-' + String(idx).padStart(3, '0');
            var itemData = batchData.items ? batchData.items[idx - 1] : null;
            var slotData = {
              slotId: slotId, batchId: batchId, slotNumber: idx,
              amount: (itemData && itemData.amount) || Math.round(batchData.totalAmount / batchData.itemCount),
              memo: (itemData && itemData.memo) || '',
              supplier: batchData.supplier,
              purchaseDate: batchData.purchaseDate,
              assignee: batchData.assignee || '',
              productId: null, status: 'unregistered',
              itemType: (itemData && itemData.itemType) || 'unique',
              quantity: (itemData && itemData.quantity) || 1,
              skuId: (itemData && itemData.skuId) || null,
              unitPrice: (itemData && itemData.unitPrice) || null,
              damageMarkerImage: (itemData && itemData.damageMarkerImage) || null,
              damageMarkerType: (itemData && itemData.damageMarkerType) || null,
              damageMarkerNote: (itemData && itemData.damageMarkerNote) || null,
              category: (itemData && itemData.category) || null,
              size: (itemData && itemData.size) || '',
              brand: (itemData && itemData.brand) || '',
              brandKana: (itemData && itemData.brandKana) || '',
              condition: (itemData && itemData.condition) || '',
              accessories: (itemData && itemData.accessories) || [],
              note: (itemData && itemData.note) || '',
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            slotsPromise = slotsPromise.then(function() {
              return window.db.collection('purchaseSlots').doc(slotId).set(slotData);
            }).then(function() { slots.push(slotData); });
          })(i);
        }

        return slotsPromise.then(function() {
          console.log('[Pur] バッチ保存完了:', batchId, 'スロット:', slots.length);
          // 検品依頼更新
          purUpdateInspectionRequestProgress(batchData.supplier, batchData.itemCount).catch(function() {});
          return { batchId: batchId, slots: slots };
        });
      });
    }

    function purUpdateInspectionRequestProgress(supplier, addedCount) {
      var currentUserEmail = firebase.auth().currentUser ? firebase.auth().currentUser.email : null;
      if (!currentUserEmail) return Promise.resolve();

      return window.db.collection('inspectionRequests')
        .where('supplier', '==', supplier)
        .where('assigneeEmail', '==', currentUserEmail)
        .where('status', 'in', ['pending', 'in_progress'])
        .limit(1).get()
        .then(function(snapshot) {
          if (snapshot.empty) return;
          var requestDoc = snapshot.docs[0];
          var requestData = requestDoc.data();
          var newCount = (requestData.registeredCount || 0) + addedCount;
          var isCompleted = newCount >= requestData.expectedCount;
          return window.db.collection('inspectionRequests').doc(requestDoc.id).update({
            registeredCount: newCount,
            status: isCompleted ? 'completed' : 'in_progress',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
    }

    function purGetSlotBySlotId(slotId) {
      return window.db.collection('purchaseSlots').doc(slotId).get().then(function(snap) {
        return snap.exists ? snap.data() : null;
      }).catch(function() { return null; });
    }

    function purGenerateSkuIdForPurchase() {
      var now = new Date();
      var dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
      var randomPart = Math.random().toString(36).substring(2, 9).toUpperCase();
      return 'SKU-' + dateStr + '-' + randomPart;
    }

    // ============================================
    // Purchase data loading and rendering
    // ============================================
    function purLoadPurchaseData() {
      purShowLoading();
      var yearMonth = document.getElementById('pur-purchaseMonth') ? document.getElementById('pur-purchaseMonth').value : '';
      var supplier = document.getElementById('pur-supplierFilter') ? document.getElementById('pur-supplierFilter').value : '';

      return purGetPurchaseData(yearMonth, supplier).then(function(data) {
        _pur_currentPurchaseData = data;
        purRenderPurchaseTable();
        purRenderPayableTable();
        purRenderSupplierGroups();
        purUpdateSummary();
      }).catch(function(error) {
        console.error('仕入データ読み込みエラー:', error);
      }).then(function() { purHideLoading(); });
    }

    function purRenderPurchaseTable() {
      var tbody = document.getElementById('pur-purchaseTableBody');
      if (!tbody) return;
      if (_pur_currentPurchaseData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">該当する仕入データがありません</td></tr>';
        return;
      }
      var html = '';
      _pur_currentPurchaseData.forEach(function(item) {
        html += '<tr><td>' + (item.purchaseDate || '-') + '</td><td>' + item.managementNumber + '</td>' +
          '<td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + item.productName + '</td>' +
          '<td>' + (item.supplier || '-') + '</td><td class="text-end">' + purFormatCurrency(item.purchaseAmount) + '</td>' +
          '<td>' + purGetPaymentBadge(item.purchasePaymentStatus) + '</td></tr>';
      });
      tbody.innerHTML = html;
    }

    function purRenderPayableTable() {
      var tbody = document.getElementById('pur-payableTableBody');
      if (!tbody) return;
      var unpaidItems = _pur_currentPurchaseData.filter(function(item) { return item.purchasePaymentStatus !== 'paid'; });
      if (unpaidItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">未払いの仕入はありません</td></tr>';
        purUpdatePayableSummary(0, 0);
        var alertDiv = document.getElementById('pur-overduePayableAlert');
        if (alertDiv) alertDiv.style.display = 'none';
        purRenderPaymentScheduleTab([]);
        return;
      }
      var html = '';
      var totalUnpaid = 0, overdueCount = 0, overdueAmount = 0;
      var OVERDUE_DAYS = 30;
      unpaidItems.forEach(function(item) {
        var unpaidAmount = item.purchaseAmount - (item.purchasePaymentAmount || 0);
        totalUnpaid += unpaidAmount;
        var daysPassed = item.purchaseDate ? Math.floor((new Date() - new Date(item.purchaseDate)) / (1000*60*60*24)) : 0;
        var isOverdue = daysPassed >= OVERDUE_DAYS;
        if (isOverdue) { overdueCount++; overdueAmount += unpaidAmount; }
        html += '<tr class="' + (isOverdue ? 'table-warning' : '') + '">' +
          '<td>' + (item.purchaseDate || '-') + '</td><td>' + item.managementNumber + '</td>' +
          '<td>' + (item.supplier || '-') + '</td><td class="text-end">' + purFormatCurrency(item.purchaseAmount) + '</td>' +
          '<td>' + purGetPaymentBadge(item.purchasePaymentStatus) + '</td>' +
          '<td><button class="btn btn-sm btn-outline-warning" onclick="purOpenPaymentModal(\'' + item.id + '\',\'' + item.managementNumber + '\',\'' + (item.supplier||'').replace(/'/g,"\\'") + '\',' + item.purchaseAmount + ')">支払記録</button></td></tr>';
      });
      tbody.innerHTML = html;
      purUpdatePayableSummary(totalUnpaid, unpaidItems.length);
      var alertDiv = document.getElementById('pur-overduePayableAlert');
      if (overdueCount > 0) {
        document.getElementById('pur-overduePayableText').textContent = overdueCount + '件（' + purFormatCurrency(overdueAmount) + '）が' + OVERDUE_DAYS + '日以上経過しています。';
        if (alertDiv) alertDiv.style.display = 'block';
      } else {
        if (alertDiv) alertDiv.style.display = 'none';
      }
      purRenderPaymentScheduleTab(unpaidItems);
    }

    function purRenderPaymentScheduleTab(unpaidItems) {
      var supplierBalances = {};
      unpaidItems.forEach(function(item) {
        var supplier = item.supplier || '未設定';
        if (!supplierBalances[supplier]) supplierBalances[supplier] = { count: 0, amount: 0 };
        supplierBalances[supplier].count++;
        supplierBalances[supplier].amount += item.purchaseAmount - (item.purchasePaymentAmount || 0);
      });
      var grid = document.getElementById('pur-supplierBalanceGrid');
      if (grid) {
        if (Object.keys(supplierBalances).length === 0) {
          grid.innerHTML = '<div class="col-12 text-center text-muted">未払いの仕入はありません</div>';
        } else {
          var h = '';
          Object.keys(supplierBalances).sort(function(a,b){return a.localeCompare(b,'ja');}).forEach(function(s) {
            var b = supplierBalances[s];
            h += '<div class="pur-summary-card"><div class="pur-summary-label">' + s + '</div><div class="pur-summary-value">' + purFormatCurrency(b.amount) + '</div><div class="small text-muted">' + b.count + '件</div></div>';
          });
          grid.innerHTML = h;
        }
      }
      // 支払予定スケジュール
      var scheduleMap = {};
      unpaidItems.forEach(function(item) {
        var supplier = item.supplier || '未設定';
        var purchaseDate = item.purchaseDate ? new Date(item.purchaseDate) : new Date();
        var expectedDate = new Date(purchaseDate);
        expectedDate.setDate(expectedDate.getDate() + 30);
        var expectedDateStr = purFormatDateLocal(expectedDate);
        var key = expectedDateStr + '_' + supplier;
        if (!scheduleMap[key]) scheduleMap[key] = { date: expectedDateStr, supplier: supplier, count: 0, amount: 0 };
        scheduleMap[key].count++;
        scheduleMap[key].amount += item.purchaseAmount - (item.purchasePaymentAmount || 0);
      });
      var stbody = document.getElementById('pur-paymentScheduleBody');
      if (!stbody) return;
      if (Object.keys(scheduleMap).length === 0) {
        stbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">支払予定はありません</td></tr>';
        return;
      }
      var today = purGetJSTToday();
      var shtml = '';
      Object.values(scheduleMap).sort(function(a,b){return a.date.localeCompare(b.date);}).forEach(function(sc) {
        var isOverdue = sc.date < today;
        var badge = isOverdue ? '<span class="pur-status-badge pur-status-unpaid">期日超過</span>' : '<span class="pur-status-badge pur-status-paid">予定</span>';
        shtml += '<tr class="' + (isOverdue ? 'table-danger' : '') + '"><td>' + sc.date + '</td><td>' + sc.supplier + '</td><td>' + sc.count + '件</td><td class="text-end">' + purFormatCurrency(sc.amount) + '</td><td>' + badge + '</td></tr>';
      });
      stbody.innerHTML = shtml;
    }

    function purRenderSupplierGroups() {
      var container = document.getElementById('pur-supplierGroups');
      if (!container) return;
      var grouped = {};
      _pur_currentPurchaseData.forEach(function(item) {
        var s = item.supplier || '未設定';
        if (!grouped[s]) grouped[s] = { items: [], totalAmount: 0, paidAmount: 0 };
        grouped[s].items.push(item);
        grouped[s].totalAmount += item.purchaseAmount;
        if (item.purchasePaymentStatus === 'paid') grouped[s].paidAmount += item.purchaseAmount;
        else grouped[s].paidAmount += item.purchasePaymentAmount || 0;
      });
      if (Object.keys(grouped).length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-4">該当する仕入データがありません</div>';
        return;
      }
      var html = '';
      Object.keys(grouped).sort(function(a,b){return a.localeCompare(b,'ja');}).forEach(function(supplier) {
        var group = grouped[supplier];
        var unpaid = group.totalAmount - group.paidAmount;
        var groupId = 'pur-supplier-' + supplier.replace(/[^a-zA-Z0-9]/g, '_');
        html += '<div class="pur-supplier-group"><div class="pur-supplier-header" onclick="var b=document.getElementById(\'' + groupId + '\');if(b)b.classList.toggle(\'pur-supplier-body-collapsed\');">' +
          '<div><h6>' + supplier + '</h6><small>' + group.items.length + '件 / ' + purFormatCurrency(group.totalAmount) + '</small></div>' +
          '<div class="text-end">' + (unpaid > 0 ? '<span class="badge bg-danger">未払: ' + purFormatCurrency(unpaid) + '</span>' : '<span class="badge bg-success">支払完了</span>') + '</div></div>' +
          '<div class="pur-supplier-body pur-supplier-body-collapsed" id="' + groupId + '"><table class="pur-data-table"><thead><tr><th>仕入日</th><th>管理番号</th><th class="text-end">金額</th><th>支払</th></tr></thead><tbody>';
        group.items.forEach(function(item) {
          html += '<tr><td>' + (item.purchaseDate || '-') + '</td><td>' + item.managementNumber + '</td><td class="text-end">' + purFormatCurrency(item.purchaseAmount) + '</td><td>' + purGetPaymentBadge(item.purchasePaymentStatus) + '</td></tr>';
        });
        html += '</tbody></table></div></div>';
      });
      container.innerHTML = html;
    }

    function purGetPaymentBadge(status) {
      switch (status) {
        case 'paid': return '<span class="pur-status-badge pur-status-paid">支払済</span>';
        case 'partial': return '<span class="pur-status-badge pur-status-partial">一部支払</span>';
        default: return '<span class="pur-status-badge pur-status-unpaid">未払</span>';
      }
    }
    function purGetPaymentStatusText(status) {
      switch (status) { case 'paid': return '支払済'; case 'partial': return '一部支払'; default: return '未払'; }
    }

    function purUpdateSummary() {
      var count = _pur_currentPurchaseData.length;
      var totalAmount = _pur_currentPurchaseData.reduce(function(s, i) { return s + i.purchaseAmount; }, 0);
      var avgAmount = count > 0 ? totalAmount / count : 0;
      var paidAmount = _pur_currentPurchaseData.reduce(function(s, i) {
        if (i.purchasePaymentStatus === 'paid') return s + i.purchaseAmount;
        return s + (i.purchasePaymentAmount || 0);
      }, 0);
      var el;
      el = document.getElementById('pur-summary-purchaseCount'); if (el) el.textContent = count + '件';
      el = document.getElementById('pur-summary-purchaseAmount'); if (el) el.textContent = purFormatCurrency(totalAmount);
      el = document.getElementById('pur-summary-avgPurchase'); if (el) el.textContent = purFormatCurrency(avgAmount);
      el = document.getElementById('pur-summary-paidAmount'); if (el) el.textContent = purFormatCurrency(paidAmount);
    }

    function purUpdatePayableSummary(totalUnpaid, count) {
      var el;
      el = document.getElementById('pur-payable-balance'); if (el) el.textContent = purFormatCurrency(totalUnpaid);
      el = document.getElementById('pur-payable-count'); if (el) el.textContent = count + '件';
      el = document.getElementById('pur-payable-expected'); if (el) el.textContent = purFormatCurrency(totalUnpaid);
    }

    // ============================================
    // Payment modal
    // ============================================
    function purOpenPaymentModal(productId, managementNumber, supplier, purchaseAmount) {
      _pur_selectedProductForPayment = { id: productId, managementNumber: managementNumber, supplier: supplier, purchaseAmount: purchaseAmount };
      document.getElementById('pur-paymentManagementNumber').value = managementNumber;
      document.getElementById('pur-paymentSupplier').value = supplier || '-';
      document.getElementById('pur-paymentPurchaseAmount').value = purFormatCurrency(purchaseAmount);
      document.getElementById('pur-paymentAmount').value = Math.round(purchaseAmount);
      document.getElementById('pur-paymentNote').value = '';
      document.getElementById('pur-paymentDate').value = purGetJSTToday();
      purOpenModal('pur-paymentModal');
    }

    function purSavePayment() {
      if (!_pur_selectedProductForPayment) return;
      var paymentDate = document.getElementById('pur-paymentDate').value;
      var paymentAmount = parseFloat(document.getElementById('pur-paymentAmount').value) || 0;
      var paymentMethod = document.getElementById('pur-paymentMethod').value;
      var paymentNote = document.getElementById('pur-paymentNote').value;
      if (!paymentDate) { alert('支払日を入力してください'); return; }
      if (paymentAmount <= 0) { alert('支払額を入力してください'); return; }
      purShowLoading();
      var status = 'unpaid';
      if (paymentAmount >= _pur_selectedProductForPayment.purchaseAmount) status = 'paid';
      else if (paymentAmount > 0) status = 'partial';
      purUpdatePurchasePaymentStatus(_pur_selectedProductForPayment.id, {
        status: status, date: paymentDate, amount: paymentAmount, method: paymentMethod, note: paymentNote
      }).then(function() {
        purCloseModal('pur-paymentModal');
        alert('支払を記録しました');
        return purLoadPurchaseData();
      }).catch(function(error) {
        console.error('支払記録エラー:', error);
        alert('支払の記録に失敗しました: ' + error.message);
      }).then(function() { purHideLoading(); });
    }

    // ============================================
    // Payable sub-tabs
    // ============================================
    function purSwitchPayableSubTab(btn, tabName) {
      document.querySelectorAll('#spa-page-purchase .pur-payable-sub-tab').forEach(function(t) { t.classList.remove('active'); });
      if (btn) btn.classList.add('active');
      document.querySelectorAll('#spa-page-purchase .pur-payable-sub-content').forEach(function(c) { c.classList.remove('active'); });
      var el = document.getElementById('pur-payable-sub-' + tabName);
      if (el) el.classList.add('active');
      if (tabName === 'supplier') purRenderSupplierGroups();
    }

    // ============================================
    // Export modal
    // ============================================
    function purOpenExportModal() {
      purUpdateExportDates();
      purOpenModal('pur-exportModal');
    }
    function purUpdateExportDates() {
      var period = document.getElementById('pur-exportPeriod').value;
      var now = new Date();
      var startDate, endDate;
      switch (period) {
        case 'month': startDate = new Date(now.getFullYear(), now.getMonth(), 1); endDate = new Date(now.getFullYear(), now.getMonth()+1, 0); break;
        case 'quarter': var q = Math.floor(now.getMonth()/3); startDate = new Date(now.getFullYear(), q*3, 1); endDate = new Date(now.getFullYear(), (q+1)*3, 0); break;
        case 'year': startDate = new Date(now.getFullYear(), 0, 1); endDate = new Date(now.getFullYear(), 11, 31); break;
        case 'custom': return;
      }
      document.getElementById('pur-exportStartDate').value = purFormatDateLocal(startDate);
      document.getElementById('pur-exportEndDate').value = purFormatDateLocal(endDate);
    }
    function purExportData() {
      var startDate = document.getElementById('pur-exportStartDate').value;
      var endDate = document.getElementById('pur-exportEndDate').value;
      if (!startDate || !endDate) { alert('出力期間を設定してください'); return; }
      purShowLoading();
      purGetPurchaseData('', '').then(function(allData) {
        var filtered = allData.filter(function(i) { var d = i.purchaseDate || ''; return d >= startDate && d <= endDate; });
        var csv = '';
        if (document.getElementById('pur-exportPurchaseDetail').checked) {
          csv += '【仕入明細】\n仕入日,管理番号,商品名,仕入先,仕入金額,支払ステータス,支払日,支払額,支払方法\n';
          filtered.forEach(function(i) {
            csv += [i.purchaseDate||'',i.managementNumber||'','"'+(i.productName||'').replace(/"/g,'""')+'"',i.supplier||'',i.purchaseAmount||0,purGetPaymentStatusText(i.purchasePaymentStatus),i.purchasePaymentDate||'',i.purchasePaymentAmount||0,i.purchasePaymentMethod||''].join(',') + '\n';
          });
          csv += '\n';
        }
        if (document.getElementById('pur-exportPayable').checked) {
          var payables = filtered.filter(function(i) { return i.purchasePaymentStatus !== 'paid'; });
          csv += '【買掛金一覧】\n仕入日,管理番号,仕入先,仕入金額,支払済額,未払額,経過日数\n';
          payables.forEach(function(i) {
            var u = i.purchaseAmount - (i.purchasePaymentAmount||0);
            var d = i.purchaseDate ? Math.floor((new Date()-new Date(i.purchaseDate))/(86400000)) : 0;
            csv += [i.purchaseDate||'',i.managementNumber||'',i.supplier||'',i.purchaseAmount||0,i.purchasePaymentAmount||0,u,d+'日'].join(',') + '\n';
          });
          csv += '\n';
        }
        if (document.getElementById('pur-exportSupplierSummary').checked) {
          var ss = {};
          filtered.forEach(function(i) { var s = i.supplier||'未設定'; if(!ss[s]) ss[s]={count:0,total:0,paid:0}; ss[s].count++; ss[s].total+=i.purchaseAmount||0; if(i.purchasePaymentStatus==='paid') ss[s].paid+=i.purchaseAmount; else ss[s].paid+=i.purchasePaymentAmount||0; });
          csv += '【仕入先別集計】\n仕入先,仕入件数,仕入合計,支払済額,買掛残高\n';
          var tc=0,ta=0,tp=0;
          Object.keys(ss).sort(function(a,b){return a.localeCompare(b,'ja');}).forEach(function(s) { var v=ss[s]; csv+=[s,v.count,v.total,v.paid,v.total-v.paid].join(',')+'\n'; tc+=v.count;ta+=v.total;tp+=v.paid; });
          csv += ['【合計】',tc,ta,tp,ta-tp].join(',') + '\n\n';
        }
        if (document.getElementById('pur-exportMonthlySummary').checked) {
          var ms = {};
          filtered.forEach(function(i) { var m=(i.purchaseDate||'').slice(0,7); if(!m) return; if(!ms[m]) ms[m]={count:0,total:0,paid:0}; ms[m].count++; ms[m].total+=i.purchaseAmount||0; if(i.purchasePaymentStatus==='paid') ms[m].paid+=i.purchaseAmount; else ms[m].paid+=i.purchasePaymentAmount||0; });
          csv += '【月別集計】\n年月,仕入件数,仕入高,支払済額,買掛残高\n';
          var tc2=0,ta2=0,tp2=0;
          Object.keys(ms).sort().forEach(function(m) { var v=ms[m]; csv+=[m,v.count,v.total,v.paid,v.total-v.paid].join(',')+'\n'; tc2+=v.count;ta2+=v.total;tp2+=v.paid; });
          csv += ['【合計】',tc2,ta2,tp2,ta2-tp2].join(',') + '\n';
        }
        var fileName = '仕入帳_' + startDate + '_' + endDate + '.csv';
        var blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
        var link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.click();
        purCloseModal('pur-exportModal');
        alert('ダウンロードが完了しました');
      }).catch(function(err) { alert('出力に失敗しました: ' + err.message); }).then(function() { purHideLoading(); });
    }

    // ============================================
    // Payment notice
    // ============================================
    function purOpenPaymentNoticeModal(items) {
      if (!items) items = [];
      var todayStr = purGetJSTToday();
      document.getElementById('pur-paymentNoticeDate').value = todayStr;
      var parts = todayStr.split('-');
      var noticeNumber = 'PAY-' + parts[0] + parts[1] + parts[2] + '-' + String(Math.floor(Math.random()*1000)).padStart(3,'0');
      document.getElementById('pur-paymentNoticeNumber').value = noticeNumber;
      var tbody = document.getElementById('pur-paymentNoticeItemsBody');
      tbody.innerHTML = '';
      if (items.length > 0) {
        items.forEach(function(i) { purAddPaymentNoticeItemRow(i.purchaseDate||'', i.productName||'', i.purchaseAmount||0); });
      } else {
        purAddPaymentNoticeItemRow('', '', 0);
      }
      purUpdatePaymentNoticeTotals();
      purOpenModal('pur-paymentNoticeModal');
    }
    function purAddPaymentNoticeItem() { purAddPaymentNoticeItemRow('', '', 0); }
    function purAddPaymentNoticeItemRow(date, description, amount) {
      var tbody = document.getElementById('pur-paymentNoticeItemsBody');
      var row = document.createElement('tr');
      row.innerHTML = '<td><input type="date" class="form-control form-control-sm" value="' + date + '" onchange="purUpdatePaymentNoticeTotals()"></td><td><input type="text" class="form-control form-control-sm" value="' + purEscapeHtml(description) + '" onchange="purUpdatePaymentNoticeTotals()"></td><td><input type="number" class="form-control form-control-sm text-end" value="' + amount + '" min="0" onchange="purUpdatePaymentNoticeTotals()"></td><td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest(\'tr\').remove();purUpdatePaymentNoticeTotals();"><i class="bi bi-trash"></i></button></td>';
      tbody.appendChild(row);
    }
    function purUpdatePaymentNoticeTotals() {
      var tbody = document.getElementById('pur-paymentNoticeItemsBody');
      var rows = tbody.querySelectorAll('tr');
      var subtotal = 0;
      rows.forEach(function(r) { var inp = r.querySelector('input[type="number"]'); subtotal += parseInt(inp ? inp.value : 0) || 0; });
      document.getElementById('pur-paymentNoticeSubtotal').value = subtotal.toLocaleString();
      document.getElementById('pur-paymentNoticeTotal').value = subtotal.toLocaleString();
    }
    function purGeneratePaymentNoticeHtml() {
      var supplier = document.getElementById('pur-paymentNoticeSupplier').value || '御中';
      var paymentDate = document.getElementById('pur-paymentNoticeDate').value;
      var noticeNumber = document.getElementById('pur-paymentNoticeNumber').value;
      var paymentMethod = document.getElementById('pur-paymentNoticeMethod').value;
      var note = document.getElementById('pur-paymentNoticeNote').value;
      var total = document.getElementById('pur-paymentNoticeTotal').value;
      var tbody = document.getElementById('pur-paymentNoticeItemsBody');
      var rows = tbody.querySelectorAll('tr');
      var itemsHtml = '';
      rows.forEach(function(r, idx) {
        var inputs = r.querySelectorAll('input');
        var d = inputs[0] ? inputs[0].value : '';
        var desc = inputs[1] ? inputs[1].value : '';
        var amt = parseInt(inputs[2] ? inputs[2].value : 0) || 0;
        if (desc) itemsHtml += '<tr><td style="padding:8px;border:1px solid #ddd;">' + (idx+1) + '</td><td style="padding:8px;border:1px solid #ddd;">' + d + '</td><td style="padding:8px;border:1px solid #ddd;">' + desc + '</td><td style="padding:8px;border:1px solid #ddd;text-align:right;">\u00a5' + amt.toLocaleString() + '</td></tr>';
      });
      return '<div style="font-family:\'Helvetica Neue\',Arial,sans-serif;max-width:800px;margin:0 auto;color:#333;"><div style="text-align:center;margin-bottom:30px;"><h1 style="font-size:28px;font-weight:bold;margin:0;letter-spacing:8px;">支払通知書</h1></div><div style="display:flex;justify-content:space-between;margin-bottom:30px;"><div><p style="font-size:18px;font-weight:bold;margin:0 0 5px 0;border-bottom:2px solid #333;padding-bottom:5px;">' + supplier + '</p><p style="margin:10px 0 0 0;font-size:14px;">下記の通りお支払いいたしますのでご査収ください。</p></div><div style="text-align:right;font-size:14px;"><p style="margin:0;">発行日: ' + paymentDate + '</p><p style="margin:5px 0;">通知番号: ' + noticeNumber + '</p><p style="margin:5px 0;">支払方法: ' + paymentMethod + '</p></div></div><div style="background:#fff7ed;padding:20px;border-radius:8px;margin-bottom:30px;text-align:center;border:2px solid #f59e0b;"><p style="margin:0 0 5px 0;font-size:14px;color:#92400e;">お支払金額</p><p style="margin:0;font-size:32px;font-weight:bold;color:#b45309;">\u00a5' + total + '</p></div><table style="width:100%;border-collapse:collapse;margin-bottom:20px;"><thead><tr style="background:#fef3c7;"><th style="padding:10px;border:1px solid #ddd;text-align:center;width:40px;">No</th><th style="padding:10px;border:1px solid #ddd;text-align:center;width:100px;">仕入日</th><th style="padding:10px;border:1px solid #ddd;text-align:left;">内容</th><th style="padding:10px;border:1px solid #ddd;text-align:right;width:120px;">金額</th></tr></thead><tbody>' + itemsHtml + '</tbody></table><div style="display:flex;justify-content:flex-end;margin-bottom:30px;"><table style="border-collapse:collapse;width:250px;"><tr style="font-weight:bold;font-size:16px;border-top:2px solid #333;"><td style="padding:8px;text-align:right;">合計金額</td><td style="padding:8px;text-align:right;">\u00a5' + total + '</td></tr></table></div>' + (note ? '<div style="margin-bottom:30px;"><p style="font-weight:bold;margin:0 0 10px 0;">備考</p><div style="background:#f8f9fa;padding:15px;border-radius:4px;white-space:pre-wrap;">' + note + '</div></div>' : '') + '<div style="margin-top:40px;padding-top:20px;border-top:1px solid #ddd;text-align:right;"><p style="font-weight:bold;margin:0 0 10px 0;">発行者</p><p style="margin:0;">フリラ</p><p style="margin:5px 0 0 0;font-size:12px;color:#666;">Furira</p></div></div>';
    }
    function purPreviewPaymentNotice() {
      document.getElementById('pur-paymentNoticePreviewContent').innerHTML = purGeneratePaymentNoticeHtml();
      purCloseModal('pur-paymentNoticeModal');
      setTimeout(function() { purOpenModal('pur-paymentNoticePreviewModal'); }, 300);
    }
    function purDownloadPaymentNoticePDF() {
      if (typeof html2canvas === 'undefined' || !window.jspdf) { alert('PDFライブラリを読み込み中です。少し待ってから再度お試しください。'); return; }
      purShowLoading();
      var content = document.getElementById('pur-paymentNoticePreviewContent');
      content.innerHTML = purGeneratePaymentNoticeHtml();
      content.style.display = 'block';
      html2canvas(content, { scale: 2, useCORS: true, logging: false, backgroundColor: '#ffffff' }).then(function(canvas) {
        var jsPDF = window.jspdf.jsPDF;
        var pdf = new jsPDF('p', 'mm', 'a4');
        var imgData = canvas.toDataURL('image/png');
        var pdfWidth = pdf.internal.pageSize.getWidth();
        var pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        var noticeNumber = document.getElementById('pur-paymentNoticeNumber').value;
        var supplier = document.getElementById('pur-paymentNoticeSupplier').value.replace(/\s/g, '_');
        pdf.save('支払通知書_' + noticeNumber + '_' + supplier + '.pdf');
        alert('PDFをダウンロードしました');
        purCloseModal('pur-paymentNoticePreviewModal');
        purCloseModal('pur-paymentNoticeModal');
      }).catch(function(err) { alert('PDF出力に失敗しました: ' + err.message); }).then(function() { purHideLoading(); });
    }

    // ============================================
    // Entry tab - master data, mode switching, items
    // ============================================
    function purSaveMasterCache(data) {
      try { localStorage.setItem(_pur_MASTER_CACHE_KEY, JSON.stringify({ savedAt: Date.now(), suppliers: data.suppliers||[], assignees: data.assignees||[], categories: data.categories||[], options: data.options||{} })); } catch(e) {}
    }
    function purLoadMasterCache() {
      try {
        var raw = localStorage.getItem(_pur_MASTER_CACHE_KEY);
        if (!raw) return null;
        var cache = JSON.parse(raw);
        if (Date.now() - cache.savedAt > _pur_MASTER_CACHE_EXPIRY) return null;
        return cache;
      } catch(e) { return null; }
    }

    function purInitializeEntryTab() {
      var cache = purLoadMasterCache();
      if (cache && cache.suppliers && cache.suppliers.length > 0) {
        purApplyMasterCache(cache);
        purLoadEntryMasterData(true);
      } else {
        purLoadEntryMasterData(false);
      }
    }

    function purApplyMasterCache(cache) {
      _pur_entrySuppliersData = cache.suppliers || [];
      _pur_entryAssigneesData = cache.assignees || [];
      _pur_entryCategoryRows = cache.categories || [];
      _pur_entryMasterOptions = cache.options || {};
      purPopulateEntryDropdowns();
    }

    function purLoadEntryMasterData(isBackground) {
      if (!isBackground) purShowLoading();
      Promise.all([purGetEntrySuppliersData(), purGetEntryAssigneesData(), purGetCategoryMaster(), purGetMasterOptions(), purGetAllLabelSettings()])
        .then(function(results) {
          _pur_entrySuppliersData = results[0];
          _pur_entryAssigneesData = results[1];
          _pur_entryCategoryRows = results[2];
          _pur_entryMasterOptions = results[3];
          purSaveMasterCache({ suppliers: _pur_entrySuppliersData, assignees: _pur_entryAssigneesData, categories: _pur_entryCategoryRows, options: _pur_entryMasterOptions });
          purPopulateEntryDropdowns();
          // ラベル設定復元
          if (results[4]) {
            Object.keys(results[4]).forEach(function(k) {
              if (_pur_entryLabelPresets[k]) Object.assign(_pur_entryLabelPresets[k], results[4][k]);
            });
          }
          // 初期商品追加
          if (_pur_entryItems.length === 0) purAddEntryItem(true);
          purLoadSimpleSettings();
          purLoadEntryLabelSettings();
        }).catch(function(err) { console.error('[Pur] マスタデータ読み込みエラー:', err); })
        .then(function() { if (!isBackground) purHideLoading(); });
    }

    function purPopulateEntryDropdowns() {
      // 仕入先
      var supplierSelects = ['pur-entrySupplier', 'pur-defaultSupplier', 'pur-supplierFilter', 'pur-inspectionRequestSupplier'];
      supplierSelects.forEach(function(id) {
        var sel = document.getElementById(id);
        if (!sel) return;
        var current = sel.value;
        var firstOpt = id === 'pur-supplierFilter' ? '<option value="">すべて</option>' : '<option value="">--選択--</option>';
        sel.innerHTML = firstOpt;
        _pur_entrySuppliersData.forEach(function(s) {
          var opt = document.createElement('option');
          opt.value = s.name || s; opt.textContent = s.name || s;
          sel.appendChild(opt);
        });
        if (current) sel.value = current;
      });
      // 発送先
      var assigneeSelects = ['pur-entryAssignee', 'pur-entryAssigneeIndividual', 'pur-inspectionRequestAssignee'];
      assigneeSelects.forEach(function(id) {
        var sel = document.getElementById(id);
        if (!sel) return;
        var current = sel.value;
        sel.innerHTML = '<option value="">--選択--</option>';
        _pur_entryAssigneesData.forEach(function(a) {
          var opt = document.createElement('option');
          opt.value = a.name; opt.textContent = a.name + (a.note ? ' (' + a.note + ')' : '');
          sel.appendChild(opt);
        });
        if (current) sel.value = current;
      });
      // バッチ用カテゴリ初期化
      purInitBatchInspectionDropdowns();
      // サイズ・商品の状態
      purInitBatchSizeCondition();
      // 付属品
      purInitBatchAccessories();
      // 個別入力商品のプルダウンも更新
      purUpdateAllEntryItemSuppliers();
      purUpdateAllEntryItemAssignees();
      purUpdateAllEntryItemSizes();
    }

    function purInitBatchInspectionDropdowns() {
      var l0Values = purUniqKeepOrder(_pur_entryCategoryRows.map(function(r) { return r['\u7279\u5927\u5206\u985e']; }));
      purFillSelectSafe(document.getElementById('pur-batch-cat-l0'), l0Values);
    }

    function purInitBatchSizeCondition() {
      var sizeSelect = document.getElementById('pur-batchSize');
      var conditionSelect = document.getElementById('pur-batchCondition');
      if (sizeSelect && _pur_entryMasterOptions.sizes) {
        purFillSelectSafe(sizeSelect, _pur_entryMasterOptions.sizes);
      }
      if (conditionSelect && _pur_entryMasterOptions.conditions) {
        purFillSelectSafe(conditionSelect, _pur_entryMasterOptions.conditions);
      }
    }

    function purInitBatchAccessories() {
      var container = document.getElementById('pur-batch-accessories');
      if (!container || !_pur_entryMasterOptions.accessories) return;
      var html = '';
      _pur_entryMasterOptions.accessories.forEach(function(acc) {
        html += '<label class="pur-accessory-checkbox"><input type="checkbox" value="' + purEscapeHtml(acc) + '" onchange="purUpdateBatchAccessoryCheckbox(this)"> ' + purEscapeHtml(acc) + '</label>';
      });
      html += '<label class="pur-accessory-checkbox"><input type="checkbox" value="その他" onchange="purUpdateBatchAccessoryCheckbox(this)"> その他</label>';
      container.innerHTML = html;
    }

    function purUpdateBatchAccessoryCheckbox(checkbox) {
      var label = checkbox.closest('.pur-accessory-checkbox');
      if (checkbox.checked) label.classList.add('checked');
      else label.classList.remove('checked');
      if (checkbox.value === 'その他') {
        var otherContainer = document.getElementById('pur-batch-accessory-other-container');
        if (otherContainer) otherContainer.style.display = checkbox.checked ? 'block' : 'none';
      }
    }

    function purSetEntryMode(mode) {
      _pur_currentEntryMode = mode;
      document.getElementById('pur-entryModeIndividual').classList.toggle('active', mode === 'individual');
      document.getElementById('pur-entryModeBatch').classList.toggle('active', mode === 'batch');
      document.getElementById('pur-batchEntrySection').style.display = mode === 'batch' ? 'block' : 'none';
      document.getElementById('pur-individualEntrySection').style.display = mode === 'individual' ? 'block' : 'none';
    }

    function purCalculateEntryPerItem() {
      var total = parseFloat(document.getElementById('pur-entryTotalAmount').value) || 0;
      var count = parseInt(document.getElementById('pur-entryItemCount').value) || 1;
      var perItem = count > 0 ? Math.round(total / count) : 0;
      document.getElementById('pur-entryPricePerItem').textContent = purFormatCurrency(perItem);
    }

    function purApplyDefaultToAllItems(field) {
      _pur_entryItems.forEach(function(item) {
        var el;
        if (field === 'purchaseDate') { el = document.getElementById('pur-entry-purchaseDate-' + item.id); if (el) el.value = document.getElementById('pur-defaultPurchaseDate').value; }
        if (field === 'supplier') { el = document.getElementById('pur-entry-supplier-' + item.id); if (el) el.value = document.getElementById('pur-defaultSupplier').value; }
        if (field === 'assignee') { el = document.getElementById('pur-entry-assignee-' + item.id); if (el) el.value = document.getElementById('pur-entryAssigneeIndividual').value; }
        if (field === 'amount') { el = document.getElementById('pur-entry-amount-' + item.id); if (el) el.value = document.getElementById('pur-defaultAmount').value; }
        purUpdateEntryItem(item.id);
      });
    }

    function purCreateEntrySupplierOptionsHTML(sel) {
      var html = '<option value="">--選択--</option>';
      _pur_entrySuppliersData.forEach(function(s) { html += '<option value="' + purEscapeHtml(s.name||s) + '"' + (sel===(s.name||s)?' selected':'') + '>' + purEscapeHtml(s.name||s) + '</option>'; });
      return html;
    }
    function purCreateEntryAssigneeOptionsHTML(sel) {
      var html = '<option value="">--選択--</option>';
      _pur_entryAssigneesData.forEach(function(a) { html += '<option value="' + purEscapeHtml(a.name) + '"' + (sel===a.name?' selected':'') + '>' + purEscapeHtml(a.name) + (a.note?' ('+purEscapeHtml(a.note)+')':'') + '</option>'; });
      return html;
    }
    function purGetEntrySizeOptions() {
      if (_pur_entryMasterOptions.sizes) return _pur_entryMasterOptions.sizes;
      return ['XXS','XS','S','M','L','XL','XXL','FREE'];
    }

    function purUpdateAllEntryItemSuppliers() {
      _pur_entryItems.forEach(function(item) {
        var sel = document.getElementById('pur-entry-supplier-' + item.id);
        if (sel) { var v = sel.value; sel.innerHTML = purCreateEntrySupplierOptionsHTML(v); }
      });
    }
    function purUpdateAllEntryItemAssignees() {
      _pur_entryItems.forEach(function(item) {
        var sel = document.getElementById('pur-entry-assignee-' + item.id);
        if (sel) { var v = sel.value; sel.innerHTML = purCreateEntryAssigneeOptionsHTML(v); }
      });
    }
    function purUpdateAllEntryItemSizes() {
      _pur_entryItems.forEach(function(item) {
        var sel = document.getElementById('pur-entry-size-' + item.id);
        if (sel) { var v = sel.value; purFillSelectSafe(sel, purGetEntrySizeOptions()); if (v) sel.value = v; }
      });
    }

    // ============================================
    // Individual entry items
    // ============================================
    function purAddEntryItem(skipScroll) {
      var itemId = 'item-' + _pur_entryItemNextId++;
      var defDate = (document.getElementById('pur-defaultPurchaseDate') ? document.getElementById('pur-defaultPurchaseDate').value : '') || purGetJSTToday();
      var defSupplier = document.getElementById('pur-defaultSupplier') ? document.getElementById('pur-defaultSupplier').value : '';
      var defAssignee = document.getElementById('pur-entryAssigneeIndividual') ? document.getElementById('pur-entryAssigneeIndividual').value : '';
      var defAmount = document.getElementById('pur-defaultAmount') ? document.getElementById('pur-defaultAmount').value : '';

      _pur_entryItems.push({ id: itemId, purchaseDate: defDate, supplier: defSupplier, assignee: defAssignee, amount: defAmount ? parseInt(defAmount) : 0 });

      var container = document.getElementById('pur-entryItemsContainer');
      var placeholder = container.querySelector('.text-center.text-muted');
      if (placeholder) placeholder.remove();

      var itemEl = document.createElement('div');
      itemEl.className = 'pur-entry-item expanded';
      itemEl.id = 'pur-entry-item-' + itemId;

      var num = _pur_entryItems.length;
      var sizeOptions = '<option value="">--選択--</option>';
      purGetEntrySizeOptions().forEach(function(s) { sizeOptions += '<option value="' + s + '">' + s + '</option>'; });
      var condOptions = '<option value="">--選択--</option>';
      if (_pur_entryMasterOptions.conditions) _pur_entryMasterOptions.conditions.forEach(function(c) { condOptions += '<option value="' + purEscapeHtml(c) + '">' + purEscapeHtml(c) + '</option>'; });

      itemEl.innerHTML = '<div class="pur-entry-item-summary" onclick="purToggleEntryItem(\'' + itemId + '\')">' +
        '<span class="pur-item-number">#' + num + '</span>' +
        '<span class="pur-item-info" id="pur-entry-info-' + itemId + '">未入力</span>' +
        '<span class="pur-item-warning" id="pur-entry-warning-' + itemId + '"></span>' +
        '<button class="pur-item-reset" onclick="event.stopPropagation();purResetEntryItem(\'' + itemId + '\')" title="リセット"><i class="bi bi-arrow-counterclockwise"></i></button>' +
        '<button class="pur-item-delete" onclick="event.stopPropagation();purRemoveEntryItem(\'' + itemId + '\')" title="削除"><i class="bi bi-x-lg"></i></button>' +
        '<i class="bi bi-chevron-down pur-item-toggle"></i></div>' +
        '<div class="pur-entry-item-body">' +
        '<div class="row g-2">' +
        '<div class="col-6"><label class="form-label">仕入日 <span class="text-danger">*</span></label><input type="date" class="form-control" id="pur-entry-purchaseDate-' + itemId + '" value="' + defDate + '" onchange="purUpdateEntryItem(\'' + itemId + '\')"></div>' +
        '<div class="col-6"><label class="form-label">仕入金額 <span class="text-danger">*</span></label><div class="input-group"><span class="input-group-text">\u00a5</span><input type="number" class="form-control" id="pur-entry-amount-' + itemId + '" value="' + (defAmount||'') + '" min="0" onchange="purUpdateEntryItem(\'' + itemId + '\')"></div></div>' +
        '<div class="col-6"><label class="form-label">仕入先 <span class="text-danger">*</span></label><select class="form-select" id="pur-entry-supplier-' + itemId + '" onchange="purUpdateEntryItem(\'' + itemId + '\')">' + purCreateEntrySupplierOptionsHTML(defSupplier) + '</select></div>' +
        '<div class="col-6"><label class="form-label">発送先 <span class="text-danger">*</span></label><select class="form-select" id="pur-entry-assignee-' + itemId + '" onchange="purUpdateEntryItem(\'' + itemId + '\')">' + purCreateEntryAssigneeOptionsHTML(defAssignee) + '</select></div>' +
        '</div>' +
        '<div class="pur-inspection-section mt-2"><div class="pur-inspection-section-header" onclick="var f=this.nextElementSibling;f.style.display=f.style.display===\'none\'?\'grid\':\'none\';"><i class="bi bi-clipboard-check"></i><span>検品情報</span><i class="bi bi-chevron-down pur-toggle-icon"></i></div>' +
        '<div class="pur-inspection-fields" style="display:none;">' +
        '<div class="pur-inspection-category-selects"><label class="form-label">カテゴリー</label>' +
        '<select class="form-select" id="pur-entry-cat-l0-' + itemId + '" onchange="purOnEntryCatL0Changed(\'' + itemId + '\')"><option value="">--選択してください--</option></select>' +
        '<select class="form-select" id="pur-entry-cat-l1-' + itemId + '" onchange="purOnEntryCatL1Changed(\'' + itemId + '\')" disabled><option value="">--選択してください--</option></select>' +
        '<select class="form-select" id="pur-entry-cat-l2-' + itemId + '" onchange="purOnEntryCatL2Changed(\'' + itemId + '\')" disabled><option value="">--選択してください--</option></select>' +
        '<select class="form-select" id="pur-entry-cat-l3-' + itemId + '" onchange="purOnEntryCatL3Changed(\'' + itemId + '\')" disabled><option value="">--選択してください--</option></select>' +
        '<select class="form-select" id="pur-entry-cat-l4-' + itemId + '" onchange="purOnEntryCatL4Changed(\'' + itemId + '\')" disabled style="display:none;"><option value="">--選択してください--</option></select>' +
        '<select class="form-select" id="pur-entry-cat-l5-' + itemId + '" onchange="purOnEntryCatL5Changed(\'' + itemId + '\')" disabled style="display:none;"><option value="">--選択してください--</option></select>' +
        '</div>' +
        '<div class="pur-inspection-category-selects"><label class="form-label">アイテム名</label><select class="form-select" id="pur-entry-cat-item-' + itemId + '" disabled><option value="">--選択してください--</option></select></div>' +
        '<div><label class="form-label">サイズ</label><select class="form-select" id="pur-entry-size-' + itemId + '">' + sizeOptions + '</select></div>' +
        '<div><label class="form-label">商品の状態</label><select class="form-select" id="pur-entry-condition-' + itemId + '">' + condOptions + '</select></div>' +
        '<div class="pur-brand-field"><label class="form-label">ブランド</label><input type="text" class="form-control" id="pur-entry-brand-' + itemId + '" autocomplete="off" placeholder="入力すると候補が表示されます"><div class="pur-suggest" id="pur-suggest-brand-' + itemId + '" hidden></div><input type="hidden" id="pur-entry-brandKana-' + itemId + '"></div>' +
        '<div><label class="form-label">メモ</label><input type="text" class="form-control" id="pur-entry-memo-' + itemId + '" placeholder="備考"></div>' +
        '</div></div></div>';

      container.appendChild(itemEl);

      // カテゴリL0初期化
      var l0Values = purUniqKeepOrder(_pur_entryCategoryRows.map(function(r) { return r['\u7279\u5927\u5206\u985e']; }));
      purFillSelectSafe(document.getElementById('pur-entry-cat-l0-' + itemId), l0Values);

      // ブランドサジェスト初期化
      if (window.algoliaBrandModulesLoaded) purAttachEntryBrandSuggest(itemId);

      purCollapseAllEntryItems();
      itemEl.classList.remove('collapsed');
      itemEl.classList.add('expanded');

      if (!skipScroll) itemEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
      purUpdateEntryItemNumbers();
      purUpdateEntryTotal();
    }

    function purCollapseAllEntryItems() {
      document.querySelectorAll('#spa-page-purchase .pur-entry-item').forEach(function(el) {
        el.classList.remove('expanded'); el.classList.add('collapsed');
      });
    }
    function purToggleEntryItem(itemId) {
      var el = document.getElementById('pur-entry-item-' + itemId);
      if (!el) return;
      if (el.classList.contains('expanded')) { el.classList.remove('expanded'); el.classList.add('collapsed'); }
      else { purCollapseAllEntryItems(); el.classList.remove('collapsed'); el.classList.add('expanded'); }
    }

    function purUpdateEntryItem(itemId) {
      var item = _pur_entryItems.find(function(i) { return i.id === itemId; });
      if (!item) return;
      var dateEl = document.getElementById('pur-entry-purchaseDate-' + itemId);
      var amtEl = document.getElementById('pur-entry-amount-' + itemId);
      var supEl = document.getElementById('pur-entry-supplier-' + itemId);
      var assEl = document.getElementById('pur-entry-assignee-' + itemId);
      if (dateEl) item.purchaseDate = dateEl.value;
      if (amtEl) item.amount = parseInt(amtEl.value) || 0;
      if (supEl) item.supplier = supEl.value;
      if (assEl) item.assignee = assEl.value;
      purUpdateEntryItemSummary(itemId);
      purUpdateEntryTotal();
    }

    function purUpdateEntryItemSummary(itemId) {
      var item = _pur_entryItems.find(function(i) { return i.id === itemId; });
      if (!item) return;
      var info = document.getElementById('pur-entry-info-' + itemId);
      var warning = document.getElementById('pur-entry-warning-' + itemId);
      if (info) {
        var parts = [];
        if (item.supplier) parts.push(item.supplier);
        if (item.amount) parts.push(purFormatCurrency(item.amount));
        info.textContent = parts.length > 0 ? parts.join(' / ') : '未入力';
      }
      if (warning) {
        var missing = [];
        if (!item.purchaseDate) missing.push('日付');
        if (!item.supplier) missing.push('仕入先');
        if (!item.amount) missing.push('金額');
        warning.innerHTML = missing.length > 0 ? '<i class="bi bi-exclamation-triangle"></i>' : '';
      }
    }

    function purResetEntryItem(itemId) {
      var dateEl = document.getElementById('pur-entry-purchaseDate-' + itemId);
      var amtEl = document.getElementById('pur-entry-amount-' + itemId);
      var supEl = document.getElementById('pur-entry-supplier-' + itemId);
      var assEl = document.getElementById('pur-entry-assignee-' + itemId);
      if (dateEl) dateEl.value = purGetJSTToday();
      if (amtEl) amtEl.value = '';
      if (supEl) supEl.selectedIndex = 0;
      if (assEl) assEl.selectedIndex = 0;
      purUpdateEntryItem(itemId);
    }

    function purRemoveEntryItem(itemId) {
      if (_pur_entryItems.length <= 1) { alert('最低1点は必要です'); return; }
      _pur_entryItems = _pur_entryItems.filter(function(i) { return i.id !== itemId; });
      var el = document.getElementById('pur-entry-item-' + itemId);
      if (el) el.remove();
      purUpdateEntryItemNumbers();
      purUpdateEntryTotal();
    }

    function purUpdateEntryItemNumbers() {
      _pur_entryItems.forEach(function(item, idx) {
        var numEl = document.querySelector('#pur-entry-item-' + item.id + ' .pur-item-number');
        if (numEl) numEl.textContent = '#' + (idx + 1);
      });
    }

    function purUpdateEntryTotal() {
      var total = 0, count = 0;
      _pur_entryItems.forEach(function(i) { total += i.amount || 0; count++; });
      var valEl = document.getElementById('pur-entryTotalValue');
      var cntEl = document.getElementById('pur-entryTotalCount');
      if (valEl) valEl.textContent = purFormatCurrency(total);
      if (cntEl) cntEl.textContent = count + '点';
    }

    // ============================================
    // Category cascade (entry items)
    // ============================================
    function purOnEntryCatL0Changed(itemId) {
      var v = document.getElementById('pur-entry-cat-l0-' + itemId).value.trim();
      ['l1','l2','l3','l4','l5','cat-item'].forEach(function(s) { purResetEntrySelect('pur-entry-cat-' + s + '-' + itemId); });
      if (!v) return;
      var l1s = purUniqKeepOrder(_pur_entryCategoryRows.filter(function(r) { return r['\u7279\u5927\u5206\u985e'] === v; }).map(function(r) { return r['\u5927\u5206\u985e']; }));
      purFillSelectSafe(document.getElementById('pur-entry-cat-l1-' + itemId), l1s);
    }
    function purOnEntryCatL1Changed(itemId) {
      var l0 = document.getElementById('pur-entry-cat-l0-' + itemId).value.trim();
      var v = document.getElementById('pur-entry-cat-l1-' + itemId).value.trim();
      ['l2','l3','l4','l5','cat-item'].forEach(function(s) { purResetEntrySelect('pur-entry-cat-' + s + '-' + itemId); });
      if (!v) return;
      var l2s = purUniqKeepOrder(_pur_entryCategoryRows.filter(function(r) { return r['\u7279\u5927\u5206\u985e']===l0 && r['\u5927\u5206\u985e']===v; }).map(function(r) { return r['\u4e2d\u5206\u985e']; }));
      purFillSelectSafe(document.getElementById('pur-entry-cat-l2-' + itemId), l2s);
    }
    function purOnEntryCatL2Changed(itemId) {
      var l0 = document.getElementById('pur-entry-cat-l0-' + itemId).value.trim();
      var l1 = document.getElementById('pur-entry-cat-l1-' + itemId).value.trim();
      var v = document.getElementById('pur-entry-cat-l2-' + itemId).value.trim();
      ['l3','l4','l5','cat-item'].forEach(function(s) { purResetEntrySelect('pur-entry-cat-' + s + '-' + itemId); });
      if (!v) return;
      var l3s = purUniqKeepOrder(_pur_entryCategoryRows.filter(function(r) { return r['\u7279\u5927\u5206\u985e']===l0 && r['\u5927\u5206\u985e']===l1 && r['\u4e2d\u5206\u985e']===v; }).map(function(r) { return r['\u5c0f\u5206\u985e']; }));
      purFillSelectSafe(document.getElementById('pur-entry-cat-l3-' + itemId), l3s);
    }
    function purOnEntryCatL3Changed(itemId) {
      var l0 = document.getElementById('pur-entry-cat-l0-' + itemId).value.trim();
      var l1 = document.getElementById('pur-entry-cat-l1-' + itemId).value.trim();
      var l2 = document.getElementById('pur-entry-cat-l2-' + itemId).value.trim();
      var v = document.getElementById('pur-entry-cat-l3-' + itemId).value.trim();
      ['l4','l5','cat-item'].forEach(function(s) { purResetEntrySelect('pur-entry-cat-' + s + '-' + itemId); });
      // Damage marker: load by subcategory for individual item
      purLoadDamageMarkerBySubcategory(itemId, v);
      if (!v) { purRefreshEntryItems(itemId); return; }
      var fines = purUniqKeepOrder(_pur_entryCategoryRows.filter(function(r) { return r['\u7279\u5927\u5206\u985e']===l0 && r['\u5927\u5206\u985e']===l1 && r['\u4e2d\u5206\u985e']===l2 && r['\u5c0f\u5206\u985e']===v; }).map(function(r) { return r['\u7d30\u5206\u985e']; }));
      var l4El = document.getElementById('pur-entry-cat-l4-' + itemId);
      purFillSelectSafe(l4El, fines);
      if (fines.length > 0 && l4El) l4El.style.display = '';
      else { if (l4El) l4El.style.display = 'none'; purRefreshEntryItems(itemId); }
    }
    function purOnEntryCatL4Changed(itemId) {
      purResetEntrySelect('pur-entry-cat-l5-' + itemId);
      purResetEntrySelect('pur-entry-cat-item-' + itemId, false);
      var l0 = document.getElementById('pur-entry-cat-l0-' + itemId).value.trim();
      var l1 = document.getElementById('pur-entry-cat-l1-' + itemId).value.trim();
      var l2 = document.getElementById('pur-entry-cat-l2-' + itemId).value.trim();
      var l3 = document.getElementById('pur-entry-cat-l3-' + itemId).value.trim();
      var v = document.getElementById('pur-entry-cat-l4-' + itemId).value.trim();
      // Damage marker: load by fine category for individual item
      purLoadDamageMarkerBySubcategory(itemId, l3, v);
      if (!v) { purRefreshEntryItems(itemId); return; }
      var fine2s = purUniqKeepOrder(_pur_entryCategoryRows.filter(function(r) { return r['\u7279\u5927\u5206\u985e']===l0 && r['\u5927\u5206\u985e']===l1 && r['\u4e2d\u5206\u985e']===l2 && r['\u5c0f\u5206\u985e']===l3 && r['\u7d30\u5206\u985e']===v; }).map(function(r) { return r['\u7d30\u5206\u985e2']; }));
      var l5El = document.getElementById('pur-entry-cat-l5-' + itemId);
      purFillSelectSafe(l5El, fine2s);
      if (fine2s.length > 0 && l5El) l5El.style.display = '';
      else { if (l5El) l5El.style.display = 'none'; purRefreshEntryItems(itemId); }
    }
    function purOnEntryCatL5Changed(itemId) {
      purResetEntrySelect('pur-entry-cat-item-' + itemId, false);
      purRefreshEntryItems(itemId);
    }
    function purRefreshEntryItems(itemId) {
      var l1 = (document.getElementById('pur-entry-cat-l1-' + itemId) || {}).value || '';
      var l2 = (document.getElementById('pur-entry-cat-l2-' + itemId) || {}).value || '';
      var l3 = (document.getElementById('pur-entry-cat-l3-' + itemId) || {}).value || '';
      var l4 = (document.getElementById('pur-entry-cat-l4-' + itemId) || {}).value || '';
      var l5 = (document.getElementById('pur-entry-cat-l5-' + itemId) || {}).value || '';
      var filtered = _pur_entryCategoryRows;
      if (l1) filtered = filtered.filter(function(r) { return r['\u5927\u5206\u985e'] === l1.trim(); });
      if (l2) filtered = filtered.filter(function(r) { return r['\u4e2d\u5206\u985e'] === l2.trim(); });
      if (l3) filtered = filtered.filter(function(r) { return r['\u5c0f\u5206\u985e'] === l3.trim(); });
      if (l4) filtered = filtered.filter(function(r) { return r['\u7d30\u5206\u985e'] === l4.trim(); });
      if (l5) filtered = filtered.filter(function(r) { return r['\u7d30\u5206\u985e2'] === l5.trim(); });
      var items = purUniqKeepOrder(filtered.map(function(r) { return r['\u30a2\u30a4\u30c6\u30e0\u540d']; }));
      purFillSelectSafe(document.getElementById('pur-entry-cat-item-' + itemId), items);
    }

    // Batch category cascade
    function purOnBatchCatL0Changed() {
      var v = document.getElementById('pur-batch-cat-l0').value.trim();
      ['l1','l2','l3','l4','l5','cat-item'].forEach(function(s) { purResetEntrySelect('pur-batch-cat-' + (s === 'cat-item' ? 'item' : s)); });
      if (!v) return;
      var l1s = purUniqKeepOrder(_pur_entryCategoryRows.filter(function(r) { return r['\u7279\u5927\u5206\u985e']===v; }).map(function(r) { return r['\u5927\u5206\u985e']; }));
      purFillSelectSafe(document.getElementById('pur-batch-cat-l1'), l1s);
    }
    function purOnBatchCatL1Changed() {
      var l0 = document.getElementById('pur-batch-cat-l0').value.trim();
      var v = document.getElementById('pur-batch-cat-l1').value.trim();
      ['l2','l3','l4','l5'].forEach(function(s) { purResetEntrySelect('pur-batch-cat-' + s); });
      purResetEntrySelect('pur-batch-cat-item', false);
      if (!v) return;
      var l2s = purUniqKeepOrder(_pur_entryCategoryRows.filter(function(r) { return r['\u7279\u5927\u5206\u985e']===l0 && r['\u5927\u5206\u985e']===v; }).map(function(r) { return r['\u4e2d\u5206\u985e']; }));
      purFillSelectSafe(document.getElementById('pur-batch-cat-l2'), l2s);
    }
    function purOnBatchCatL2Changed() {
      var l0 = document.getElementById('pur-batch-cat-l0').value.trim();
      var l1 = document.getElementById('pur-batch-cat-l1').value.trim();
      var v = document.getElementById('pur-batch-cat-l2').value.trim();
      ['l3','l4','l5'].forEach(function(s) { purResetEntrySelect('pur-batch-cat-' + s); });
      purResetEntrySelect('pur-batch-cat-item', false);
      if (!v) return;
      var l3s = purUniqKeepOrder(_pur_entryCategoryRows.filter(function(r) { return r['\u7279\u5927\u5206\u985e']===l0 && r['\u5927\u5206\u985e']===l1 && r['\u4e2d\u5206\u985e']===v; }).map(function(r) { return r['\u5c0f\u5206\u985e']; }));
      purFillSelectSafe(document.getElementById('pur-batch-cat-l3'), l3s);
    }
    function purOnBatchCatL3Changed() {
      var l0 = document.getElementById('pur-batch-cat-l0').value.trim();
      var l1 = document.getElementById('pur-batch-cat-l1').value.trim();
      var l2 = document.getElementById('pur-batch-cat-l2').value.trim();
      var v = document.getElementById('pur-batch-cat-l3').value.trim();
      purResetEntrySelect('pur-batch-cat-l4');
      purResetEntrySelect('pur-batch-cat-l5');
      purResetEntrySelect('pur-batch-cat-item', false);
      // Damage marker: load by subcategory
      purLoadBatchDamageMarkerBySubcategory(v);
      if (!v) { purRefreshBatchItems(); return; }
      var fines = purUniqKeepOrder(_pur_entryCategoryRows.filter(function(r) { return r['\u7279\u5927\u5206\u985e']===l0 && r['\u5927\u5206\u985e']===l1 && r['\u4e2d\u5206\u985e']===l2 && r['\u5c0f\u5206\u985e']===v; }).map(function(r) { return r['\u7d30\u5206\u985e']; }));
      var l4El = document.getElementById('pur-batch-cat-l4');
      purFillSelectSafe(l4El, fines);
      if (fines.length > 0 && l4El) l4El.style.display = '';
      else { if (l4El) l4El.style.display = 'none'; purRefreshBatchItems(); }
    }
    function purOnBatchCatL4Changed() {
      var l3 = (document.getElementById('pur-batch-cat-l3') || {}).value || '';
      var l4 = (document.getElementById('pur-batch-cat-l4') || {}).value || '';
      purResetEntrySelect('pur-batch-cat-l5');
      purResetEntrySelect('pur-batch-cat-item', false);
      // Damage marker: load by fine category
      purLoadBatchDamageMarkerBySubcategory(l3.trim(), l4.trim());
      purRefreshBatchItems();
    }
    function purOnBatchCatL5Changed() { purResetEntrySelect('pur-batch-cat-item', false); purRefreshBatchItems(); }
    function purRefreshBatchItems() {
      var l1 = (document.getElementById('pur-batch-cat-l1') || {}).value || '';
      var l2 = (document.getElementById('pur-batch-cat-l2') || {}).value || '';
      var l3 = (document.getElementById('pur-batch-cat-l3') || {}).value || '';
      var l4 = (document.getElementById('pur-batch-cat-l4') || {}).value || '';
      var l5 = (document.getElementById('pur-batch-cat-l5') || {}).value || '';
      var filtered = _pur_entryCategoryRows;
      if (l1) filtered = filtered.filter(function(r) { return r['\u5927\u5206\u985e']===l1.trim(); });
      if (l2) filtered = filtered.filter(function(r) { return r['\u4e2d\u5206\u985e']===l2.trim(); });
      if (l3) filtered = filtered.filter(function(r) { return r['\u5c0f\u5206\u985e']===l3.trim(); });
      if (l4) filtered = filtered.filter(function(r) { return r['\u7d30\u5206\u985e']===l4.trim(); });
      if (l5) filtered = filtered.filter(function(r) { return r['\u7d30\u5206\u985e2']===l5.trim(); });
      var items = purUniqKeepOrder(filtered.map(function(r) { return r['\u30a2\u30a4\u30c6\u30e0\u540d']; }));
      purFillSelectSafe(document.getElementById('pur-batch-cat-item'), items);
    }
    function purOnBatchBrandInput() { /* handled by purAttachBatchBrandSuggest */ }

    // ============================================
    // QR code generation
    // ============================================
    function purGenerateEntryQRCodes() {
      if (_pur_currentEntryMode === 'batch') purGenerateEntryQRCodesBatch();
      else purGenerateEntryQRCodesIndividual();
    }

    function purGenerateEntryQRCodesBatch() {
      var purchaseDate = document.getElementById('pur-entryPurchaseDate').value;
      var supplier = document.getElementById('pur-entrySupplier').value;
      var assignee = document.getElementById('pur-entryAssignee').value;
      var totalAmount = parseInt(document.getElementById('pur-entryTotalAmount').value) || 0;
      var itemCount = parseInt(document.getElementById('pur-entryItemCount').value) || 0;
      if (!purchaseDate || !supplier || !assignee || totalAmount <= 0 || itemCount <= 0) {
        alert('必須項目を入力してください');
        return;
      }
      purShowLoading();
      var assigneeData = _pur_entryAssigneesData.find(function(a) { return a.name === assignee; });
      var currentUser = firebase.auth().currentUser;
      var currentUserEmail = currentUser ? currentUser.email : '';
      var currentUserName = _pur_entryAssigneesData.find(function(a) { return a.email === currentUserEmail; });

      var batchItems = [];
      for (var i = 0; i < itemCount; i++) {
        batchItems.push({
          amount: Math.round(totalAmount / itemCount),
          memo: document.getElementById('pur-entryMemo').value || ''
        });
      }

      purSavePurchaseBatch({
        purchaseDate: purchaseDate, supplier: supplier, totalAmount: totalAmount,
        itemCount: itemCount, assignee: assignee,
        assigneeUserId: assigneeData ? assigneeData.userId : null,
        inspectionAssignee: currentUserName ? currentUserName.name : '',
        inspectionAssigneeUserId: currentUserEmail,
        inspectionAssigneeEmail: currentUserEmail,
        memo: document.getElementById('pur-entryMemo').value || '',
        items: batchItems
      }).then(function(result) {
        _pur_entryGeneratedQRData = result.slots.map(function(s) { return { slotId: s.slotId, amount: s.amount }; });
        purShowQRPreview();
        purShowEntryAfterActions(result.batchId, assignee, assigneeData);
      }).catch(function(err) { alert('登録に失敗しました: ' + err.message); }).then(function() { purHideLoading(); });
    }

    function purGenerateEntryQRCodesIndividual() {
      var validItems = [];
      _pur_entryItems.forEach(function(item, idx) {
        var dateEl = document.getElementById('pur-entry-purchaseDate-' + item.id);
        var amtEl = document.getElementById('pur-entry-amount-' + item.id);
        var supEl = document.getElementById('pur-entry-supplier-' + item.id);
        var assEl = document.getElementById('pur-entry-assignee-' + item.id);
        var d = dateEl ? dateEl.value : '';
        var a = parseInt(amtEl ? amtEl.value : 0) || 0;
        var s = supEl ? supEl.value : '';
        var ass = assEl ? assEl.value : '';
        var errors = [];
        if (!d) errors.push('仕入日');
        if (!s) errors.push('仕入先');
        if (!ass) errors.push('発送先');
        if (a <= 0) errors.push('仕入金額');
        if (errors.length > 0) { item._errors = errors; item._itemIndex = idx + 1; }
        validItems.push({
          purchaseDate: d, supplier: s, assignee: ass, amount: a,
          memo: (document.getElementById('pur-entry-memo-' + item.id) || {}).value || '',
          _errors: item._errors, _itemIndex: item._itemIndex
        });
      });
      if (validItems.length === 0) { alert('商品を追加してください'); return; }
      var withErrors = validItems.filter(function(i) { return i._errors && i._errors.length > 0; });
      if (withErrors.length > 0) {
        alert('必須項目が未入力です\n\n' + withErrors.map(function(i) { return '商品 #' + i._itemIndex + '：' + i._errors.join('、'); }).join('\n'));
        return;
      }
      purShowLoading();
      // Group by supplier+date+assignee
      var suppliers = purUniqKeepOrder(validItems.map(function(i) { return i.supplier; }));
      var allSlots = [];
      var batchPromise = Promise.resolve();

      suppliers.forEach(function(sup) {
        var supItems = validItems.filter(function(i) { return i.supplier === sup; });
        var totalAmount = supItems.reduce(function(s, i) { return s + i.amount; }, 0);
        var assignee = supItems[0].assignee;
        var assigneeData = _pur_entryAssigneesData.find(function(a) { return a.name === assignee; });
        var currentUser = firebase.auth().currentUser;
        var currentUserEmail = currentUser ? currentUser.email : '';
        var currentUserName = _pur_entryAssigneesData.find(function(a) { return a.email === currentUserEmail; });

        batchPromise = batchPromise.then(function() {
          return purSavePurchaseBatch({
            purchaseDate: supItems[0].purchaseDate, supplier: sup, totalAmount: totalAmount,
            itemCount: supItems.length, assignee: assignee,
            assigneeUserId: assigneeData ? assigneeData.userId : null,
            inspectionAssignee: currentUserName ? currentUserName.name : '',
            inspectionAssigneeUserId: currentUserEmail,
            inspectionAssigneeEmail: currentUserEmail,
            memo: '', items: supItems
          }).then(function(result) {
            result.slots.forEach(function(s) { allSlots.push({ slotId: s.slotId, amount: s.amount }); });
            return result;
          });
        });
      });

      batchPromise.then(function(lastResult) {
        _pur_entryGeneratedQRData = allSlots;
        purShowQRPreview();
        if (lastResult) purShowEntryAfterActions(lastResult.batchId, validItems[0].assignee, _pur_entryAssigneesData.find(function(a) { return a.name === validItems[0].assignee; }));
      }).catch(function(err) { alert('登録に失敗しました: ' + err.message); }).then(function() { purHideLoading(); });
    }

    function purShowQRPreview() {
      document.getElementById('pur-qrEntryPreview').style.display = 'block';
      document.getElementById('pur-qrEntryCount').textContent = _pur_entryGeneratedQRData.length + '枚';
      // Generate dataUrls for label preview/printing
      if (window.QRCode) {
        var promises = _pur_entryGeneratedQRData.map(function(qr) {
          if (qr.dataUrl) return Promise.resolve();
          return purGenerateQRCodeDataUrl(qr.slotId).then(function(dataUrl) { qr.dataUrl = dataUrl; });
        });
        Promise.all(promises).then(function() { purUpdateEntryLabelPreview(); });
      } else {
        purUpdateEntryLabelPreview();
      }
    }

    function purShowEntryAfterActions(batchId, assigneeName, assigneeData) {
      document.getElementById('pur-entryAfterActions').style.display = 'block';
      document.getElementById('pur-entryPurchaseId').textContent = batchId;
      document.getElementById('pur-entryAssigneeName').textContent = assigneeName;
      if (assigneeData && assigneeData.userId) {
        document.getElementById('pur-dispatchNotificationArea').style.display = 'block';
      }
    }

    // ============================================
    // Label settings and printing
    // ============================================
    function purSetEntryPrintMode(mode) {
      _pur_currentEntryPrintMode = mode;
      document.getElementById('pur-entryPrintModeLabel').classList.toggle('active', mode === 'label');
      document.getElementById('pur-entryPrintModeSimple').classList.toggle('active', mode === 'simple');
      document.getElementById('pur-entrySimplePrintSection').style.display = mode === 'simple' ? 'block' : 'none';
      document.getElementById('pur-entryLabelPrintSection').style.display = mode === 'label' ? 'block' : 'none';
      if (mode === 'simple') purRenderSimpleQRGrid();
    }

    function purRenderSimpleQRGrid() {
      if (!window.QRCode) return;
      var grid = document.getElementById('pur-qrEntryGrid');
      if (!grid) return;
      grid.innerHTML = '';
      _pur_entryGeneratedQRData.forEach(function(qr) {
        var item = document.createElement('div');
        item.className = 'pur-qr-entry-item';
        var qrDiv = document.createElement('div');
        item.appendChild(qrDiv);
        var label = document.createElement('div');
        label.className = 'pur-qr-entry-item-label';
        label.textContent = qr.slotId;
        item.appendChild(label);
        grid.appendChild(item);
        new QRCode(qrDiv, { text: qr.slotId, width: 80, height: 80, correctLevel: QRCode.CorrectLevel.M });
      });
    }

    function purSelectEntryLabelPreset(presetKey) {
      _pur_currentEntryPresetKey = presetKey;
      var preset = _pur_entryLabelPresets[presetKey];
      if (!preset) return;
      _pur_currentEntryLabelSettings = Object.assign({}, preset);
      document.querySelectorAll('#spa-page-purchase .pur-entry-label-preset-btn').forEach(function(el) {
        el.classList.toggle('active', el.getAttribute('data-preset') === presetKey);
      });
      purUpdateEntryCustomInputs();
      purUpdateEntryLabelInfo();
      purUpdateEntryLabelPreview();
    }

    function purUpdateEntryCustomInputs() {
      var s = _pur_currentEntryLabelSettings;
      var ids = {Width:'labelWidth',Height:'labelHeight',Cols:'cols',Rows:'rows',MarginTop:'marginTop',MarginLeft:'marginLeft',GapX:'gapX',GapY:'gapY',QrSize:'qrSize'};
      Object.keys(ids).forEach(function(k) {
        var el = document.getElementById('pur-entryLabel' + k) || document.getElementById('pur-entry' + k);
        if (el) el.value = s[ids[k]] || '';
      });
    }

    function purUpdateEntryLabelInfo() {
      var s = _pur_currentEntryLabelSettings;
      var perSheet = s.cols * s.rows;
      var total = _pur_entryGeneratedQRData.length;
      var sheets = Math.ceil(total / perSheet) || 1;
      var infoEl = document.getElementById('pur-entryLabelInfo');
      var sheetEl = document.getElementById('pur-entrySheetInfo');
      if (infoEl) infoEl.textContent = s.name + 'ラベル: 1シートあたり' + perSheet + '枚印刷可能';
      if (sheetEl) sheetEl.textContent = '必要シート数: ' + sheets + '枚';
    }

    function purUpdateEntryLabelPreview() {
      var customBtn = document.querySelector('#spa-page-purchase .pur-entry-label-preset-btn[data-preset="custom"]');
      if (customBtn && customBtn.classList.contains('active')) purReadEntryCustomInputs();
      purUpdateEntryLabelInfo();
      var container = document.getElementById('pur-entryLabelSheetContainer');
      if (!container) return;
      var s = _pur_currentEntryLabelSettings;
      var total = _pur_entryGeneratedQRData.length;
      if (total === 0) { container.innerHTML = '<div class="text-center text-muted py-4">QRコードを生成するとプレビューが表示されます</div>'; return; }
      container.innerHTML = '';
      var labelWidth = s.labelWidth, labelHeight = s.labelHeight, cols = s.cols, rows = s.rows;
      var marginTop = s.marginTop, marginLeft = s.marginLeft, gapX = s.gapX, gapY = s.gapY;
      var perSheet = cols * rows;
      var startPos = parseInt((document.getElementById('pur-entryStartPosition') || {}).value) || 1;
      var a4Width = 210, a4Height = 297, maxPreviewWidth = 320;
      var scale = maxPreviewWidth / a4Width;
      var sheetsNeeded = Math.ceil((total + startPos - 1) / perSheet);
      var qrIndex = 0;
      for (var sheet = 0; sheet < sheetsNeeded; sheet++) {
        var sheetDiv = document.createElement('div');
        sheetDiv.className = 'pur-entry-label-sheet-preview';
        sheetDiv.style.width = (a4Width * scale) + 'px';
        sheetDiv.style.height = (a4Height * scale) + 'px';
        sheetDiv.style.marginBottom = '16px';
        sheetDiv.style.position = 'relative';
        sheetDiv.style.background = '#fff';
        sheetDiv.style.border = '1px solid #e5e7eb';
        sheetDiv.style.overflow = 'hidden';
        for (var row = 0; row < rows; row++) {
          for (var col = 0; col < cols; col++) {
            var cellIndex = row * cols + col;
            var globalIndex = sheet * perSheet + cellIndex;
            var isBeforeStart = globalIndex < startPos - 1;
            var hasQR = !isBeforeStart && qrIndex < total;
            var x = marginLeft + col * (labelWidth + gapX);
            var y = marginTop + row * (labelHeight + gapY);
            var cell = document.createElement('div');
            cell.style.position = 'absolute';
            cell.style.left = (x * scale) + 'px';
            cell.style.top = (y * scale) + 'px';
            cell.style.width = (labelWidth * scale) + 'px';
            cell.style.height = (labelHeight * scale) + 'px';
            cell.style.border = '1px dashed ' + (hasQR ? '#4ECDC4' : '#e5e7eb');
            cell.style.display = 'flex';
            cell.style.flexDirection = 'column';
            cell.style.alignItems = 'center';
            cell.style.justifyContent = 'center';
            cell.style.padding = '1px';
            cell.style.overflow = 'hidden';
            if (hasQR) {
              var qrData = _pur_entryGeneratedQRData[qrIndex];
              if (qrData.dataUrl) {
                var img = document.createElement('img');
                img.src = qrData.dataUrl;
                img.style.width = '80%'; img.style.height = '75%'; img.style.objectFit = 'contain';
                cell.appendChild(img);
              }
              var idText = document.createElement('div');
              var shortId = qrData.slotId.replace(/^BATCH-\d{8}-/, '');
              idText.textContent = shortId;
              idText.style.fontSize = (labelWidth * scale * 0.15) + 'px';
              idText.style.lineHeight = '1'; idText.style.color = '#333'; idText.style.textAlign = 'center';
              idText.style.overflow = 'hidden'; idText.style.whiteSpace = 'nowrap';
              cell.appendChild(idText);
              qrIndex++;
            }
            sheetDiv.appendChild(cell);
          }
        }
        var sheetLabel = document.createElement('div');
        sheetLabel.className = 'text-center text-muted mt-1';
        sheetLabel.style.fontSize = '0.75rem';
        sheetLabel.textContent = 'シート ' + (sheet + 1) + ' / ' + sheetsNeeded;
        var wrapper = document.createElement('div');
        wrapper.appendChild(sheetDiv); wrapper.appendChild(sheetLabel);
        container.appendChild(wrapper);
      }
    }

    function purReadEntryCustomInputs() {
      var s = _pur_currentEntryLabelSettings;
      s.labelWidth = parseFloat((document.getElementById('pur-entryLabelWidth') || {}).value) || 20;
      s.labelHeight = parseFloat((document.getElementById('pur-entryLabelHeight') || {}).value) || 20;
      s.cols = parseInt((document.getElementById('pur-entryLabelCols') || {}).value) || 7;
      s.rows = parseInt((document.getElementById('pur-entryLabelRows') || {}).value) || 10;
      s.marginTop = parseFloat((document.getElementById('pur-entryMarginTop') || {}).value) || 0;
      s.marginLeft = parseFloat((document.getElementById('pur-entryMarginLeft') || {}).value) || 0;
      s.gapX = parseFloat((document.getElementById('pur-entryGapX') || {}).value) || 0;
      s.gapY = parseFloat((document.getElementById('pur-entryGapY') || {}).value) || 0;
      s.qrSize = parseFloat((document.getElementById('pur-entryQrSize') || {}).value) || 15;
      s.perSheet = s.cols * s.rows;
    }

    function purGenerateQRCodeDataUrl(content) {
      return new Promise(function(resolve) {
        var tempContainer = document.createElement('div');
        tempContainer.style.cssText = 'position:absolute;left:-9999px;top:-9999px;';
        document.body.appendChild(tempContainer);
        new QRCode(tempContainer, { text: content, width: 200, height: 200, colorDark: '#000000', colorLight: '#ffffff', correctLevel: QRCode.CorrectLevel.M });
        setTimeout(function() {
          var canvas = tempContainer.querySelector('canvas');
          var dataUrl = canvas ? canvas.toDataURL('image/png') : null;
          document.body.removeChild(tempContainer);
          resolve(dataUrl);
        }, 100);
      });
    }

    function purPrintEntryLabelSheet(skipHistorySave) {
      if (_pur_entryGeneratedQRData.length === 0) { alert('先にQRコードを生成してください'); return; }
      var customBtn = document.querySelector('#spa-page-purchase .pur-entry-label-preset-btn[data-preset="custom"]');
      if (customBtn && customBtn.classList.contains('active')) purReadEntryCustomInputs();
      var s = _pur_currentEntryLabelSettings;
      var perSheet = s.cols * s.rows;
      var startPos = parseInt((document.getElementById('pur-entryStartPosition') || {}).value) || 1;
      var qrSize = s.qrSize || Math.min(s.labelWidth, s.labelHeight) * 0.75;
      var fontSize = Math.max(1.5, s.labelWidth * 0.12);
      var totalQR = _pur_entryGeneratedQRData.length;
      var sheetsNeeded = Math.ceil((totalQR + startPos - 1) / perSheet);
      if (!window.jspdf) { alert('PDFライブラリを読み込み中です。しばらくお待ちください。'); return; }
      try {
        var jsPDF = window.jspdf.jsPDF;
        var pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
        var qrIndex = 0;
        for (var sheet = 0; sheet < sheetsNeeded; sheet++) {
          if (sheet > 0) pdf.addPage();
          for (var row = 0; row < s.rows; row++) {
            for (var col = 0; col < s.cols; col++) {
              var cellIndex = row * s.cols + col;
              var globalIndex = sheet * perSheet + cellIndex;
              if (globalIndex < startPos - 1 || qrIndex >= totalQR) continue;
              var x = s.marginLeft + col * (s.labelWidth + s.gapX);
              var y = s.marginTop + row * (s.labelHeight + s.gapY);
              var qrData = _pur_entryGeneratedQRData[qrIndex];
              var shortId = qrData.slotId.replace(/^BATCH-\d{8}-/, '');
              var qrX = x + (s.labelWidth - qrSize) / 2;
              var qrY = y + 0.5;
              if (qrData.dataUrl) pdf.addImage(qrData.dataUrl, 'PNG', qrX, qrY, qrSize, qrSize);
              pdf.setFontSize(fontSize * 2.83465); pdf.setFont('helvetica', 'bold');
              pdf.text(shortId, x + s.labelWidth / 2, qrY + qrSize + fontSize, { align: 'center' });
              qrIndex++;
            }
          }
        }
        var pdfBlob = pdf.output('blob');
        var pdfUrl = URL.createObjectURL(pdfBlob);
        var newWindow = window.open(pdfUrl, '_blank');
        if (!newWindow) { var link = document.createElement('a'); link.href = pdfUrl; link.download = 'labels_' + purGetJSTToday() + '.pdf'; link.click(); }
        if (!skipHistorySave) purSaveLabelPrintHistory(sheetsNeeded);
        setTimeout(function() { URL.revokeObjectURL(pdfUrl); }, 60000);
      } catch(error) { console.error('[Pur] PDF生成エラー:', error); alert('PDF生成中にエラーが発生しました: ' + error.message); }
    }

    function purPrintEntryLabelSheetWithWindow(pdfWindow, skipHistorySave) {
      if (_pur_entryGeneratedQRData.length === 0) { if (pdfWindow) pdfWindow.close(); alert('先にQRコードを生成してください'); return; }
      var s = _pur_currentEntryLabelSettings;
      var perSheet = s.cols * s.rows;
      var startPos = parseInt((document.getElementById('pur-entryStartPosition') || {}).value) || 1;
      var qrSize = s.qrSize || Math.min(s.labelWidth, s.labelHeight) * 0.75;
      var fontSize = Math.max(1.5, s.labelWidth * 0.12);
      var totalQR = _pur_entryGeneratedQRData.length;
      var sheetsNeeded = Math.ceil((totalQR + startPos - 1) / perSheet);
      try {
        var jsPDF = window.jspdf.jsPDF;
        var pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
        var qrIndex = 0;
        for (var sheet = 0; sheet < sheetsNeeded; sheet++) {
          if (sheet > 0) pdf.addPage();
          for (var row = 0; row < s.rows; row++) {
            for (var col = 0; col < s.cols; col++) {
              var cellIndex = row * s.cols + col;
              var globalIndex = sheet * perSheet + cellIndex;
              if (globalIndex < startPos - 1 || qrIndex >= totalQR) continue;
              var x = s.marginLeft + col * (s.labelWidth + s.gapX);
              var y = s.marginTop + row * (s.labelHeight + s.gapY);
              var qrData = _pur_entryGeneratedQRData[qrIndex];
              var shortId = qrData.slotId.replace(/^BATCH-\d{8}-/, '');
              var qrX = x + (s.labelWidth - qrSize) / 2;
              var qrY = y + 0.5;
              if (qrData.dataUrl) pdf.addImage(qrData.dataUrl, 'PNG', qrX, qrY, qrSize, qrSize);
              pdf.setFontSize(fontSize * 2.83465); pdf.setFont('helvetica', 'bold');
              pdf.text(shortId, x + s.labelWidth / 2, qrY + qrSize + fontSize, { align: 'center' });
              qrIndex++;
            }
          }
        }
        var pdfBlob = pdf.output('blob');
        var pdfUrl = URL.createObjectURL(pdfBlob);
        if (pdfWindow) pdfWindow.location.href = pdfUrl;
        else { var link = document.createElement('a'); link.href = pdfUrl; link.download = 'labels_' + purGetJSTToday() + '.pdf'; link.click(); }
        setTimeout(function() { URL.revokeObjectURL(pdfUrl); }, 60000);
      } catch(error) {
        console.error('[Pur] PDF生成エラー:', error);
        if (pdfWindow) pdfWindow.close();
        alert('PDF生成中にエラーが発生しました: ' + error.message);
      }
    }

    function purPrintEntrySimple() { window.print(); }
    function purDownloadEntryQRCodes() {
      alert('印刷ダイアログで「PDFとして保存」を選択してください');
      purPrintEntrySimple();
    }

    function purToggleLabelSettings() {
      var panel = document.getElementById('pur-entryCustomSettings');
      var toggleText = document.getElementById('pur-labelSettingsToggleText');
      var icon = document.getElementById('pur-labelSettingsIcon');
      var btn = document.getElementById('pur-labelSettingsToggleBtn');
      if (!panel) return;
      if (panel.style.display === 'none') {
        panel.style.display = 'block';
        if (toggleText) toggleText.textContent = '詳細設定を閉じる';
        if (icon) icon.className = 'bi bi-chevron-up';
        if (btn) { btn.classList.remove('btn-outline-secondary'); btn.classList.add('btn-secondary'); }
      } else {
        panel.style.display = 'none';
        if (toggleText) toggleText.textContent = '詳細設定';
        if (icon) icon.className = 'bi bi-sliders';
        if (btn) { btn.classList.remove('btn-secondary'); btn.classList.add('btn-outline-secondary'); }
      }
      setTimeout(function() { if (document.activeElement) document.activeElement.blur(); }, 100);
    }
    function purToggleSimpleSettings() {
      var panel = document.getElementById('pur-simpleCustomSettings');
      var toggleText = document.getElementById('pur-simpleSettingsToggleText');
      var icon = document.getElementById('pur-simpleSettingsIcon');
      var btn = document.getElementById('pur-simpleSettingsToggleBtn');
      if (!panel) return;
      if (panel.style.display === 'none') {
        panel.style.display = 'block';
        if (toggleText) toggleText.textContent = '詳細設定を閉じる';
        if (icon) icon.className = 'bi bi-chevron-up';
        if (btn) { btn.classList.remove('btn-outline-secondary'); btn.classList.add('btn-secondary'); }
      } else {
        panel.style.display = 'none';
        if (toggleText) toggleText.textContent = '詳細設定';
        if (icon) icon.className = 'bi bi-sliders';
        if (btn) { btn.classList.remove('btn-secondary'); btn.classList.add('btn-outline-secondary'); }
      }
      setTimeout(function() { if (document.activeElement) document.activeElement.blur(); }, 100);
    }
    function purSaveEntryLabelSettings() {
      purReadEntryCustomInputs();
      _pur_entryLabelPresets[_pur_currentEntryPresetKey] = Object.assign({}, _pur_currentEntryLabelSettings);
      purSaveEntryLabelSettingsToFirestore(_pur_currentEntryPresetKey, _pur_currentEntryLabelSettings).then(function(success) {
        try { var all = JSON.parse(localStorage.getItem('pur_entryLabelPresets') || '{}'); all[_pur_currentEntryPresetKey] = _pur_currentEntryLabelSettings; localStorage.setItem('pur_entryLabelPresets', JSON.stringify(all)); } catch(e) {}
        alert('設定を保存しました');
      }).catch(function() {
        try { var all = JSON.parse(localStorage.getItem('pur_entryLabelPresets') || '{}'); all[_pur_currentEntryPresetKey] = _pur_currentEntryLabelSettings; localStorage.setItem('pur_entryLabelPresets', JSON.stringify(all)); } catch(e) {}
        alert('設定を保存しました（ローカル）');
      });
    }
    function purResetEntryLabelToDefault() {
      var preset = _pur_entryLabelPresetsDefault[_pur_currentEntryPresetKey];
      if (!preset) return;
      if (!confirm((_pur_entryLabelPresetsDefault[_pur_currentEntryPresetKey].name || _pur_currentEntryPresetKey) + 'をデフォルト設定に戻しますか？')) return;
      _pur_entryLabelPresets[_pur_currentEntryPresetKey] = Object.assign({}, preset);
      _pur_currentEntryLabelSettings = Object.assign({}, preset);
      purUpdateEntryCustomInputs(); purUpdateEntryLabelPreview();
      try { var all = JSON.parse(localStorage.getItem('pur_entryLabelPresets') || '{}'); delete all[_pur_currentEntryPresetKey]; localStorage.setItem('pur_entryLabelPresets', JSON.stringify(all)); } catch(e) {}
      alert('デフォルト設定に戻しました');
    }
    function purSaveSimpleSettings() {
      _pur_currentSimpleSettings = {
        marginTop: parseFloat((document.getElementById('pur-simpleMarginTop') || {}).value) || 15,
        marginLeft: parseFloat((document.getElementById('pur-simpleMarginLeft') || {}).value) || 15,
        qrSize: parseFloat((document.getElementById('pur-simpleQrSize') || {}).value) || 25,
        gap: parseFloat((document.getElementById('pur-simpleGap') || {}).value) || 10
      };
      try { localStorage.setItem('pur_simpleSettings', JSON.stringify(_pur_currentSimpleSettings)); } catch(e) {}
      alert('設定を保存しました');
    }
    function purResetSimpleSettings() {
      if (!confirm('シンプル印刷設定をデフォルトに戻しますか？')) return;
      _pur_currentSimpleSettings = Object.assign({}, _pur_simpleSettingsDefault);
      var el;
      el = document.getElementById('pur-simpleMarginTop'); if (el) el.value = _pur_simpleSettingsDefault.marginTop;
      el = document.getElementById('pur-simpleMarginLeft'); if (el) el.value = _pur_simpleSettingsDefault.marginLeft;
      el = document.getElementById('pur-simpleQrSize'); if (el) el.value = _pur_simpleSettingsDefault.qrSize;
      el = document.getElementById('pur-simpleGap'); if (el) el.value = _pur_simpleSettingsDefault.gap;
      try { localStorage.removeItem('pur_simpleSettings'); } catch(e) {}
      alert('デフォルト設定に戻しました');
    }
    function purLoadSimpleSettings() {
      try {
        var saved = localStorage.getItem('pur_simpleSettings');
        if (saved) _pur_currentSimpleSettings = Object.assign({}, _pur_simpleSettingsDefault, JSON.parse(saved));
      } catch(e) {}
      var el;
      el = document.getElementById('pur-simpleMarginTop'); if (el) el.value = _pur_currentSimpleSettings.marginTop;
      el = document.getElementById('pur-simpleMarginLeft'); if (el) el.value = _pur_currentSimpleSettings.marginLeft;
      el = document.getElementById('pur-simpleQrSize'); if (el) el.value = _pur_currentSimpleSettings.qrSize;
      el = document.getElementById('pur-simpleGap'); if (el) el.value = _pur_currentSimpleSettings.gap;
    }
    function purLoadEntryLabelSettings() {
      purGetAllLabelSettings().then(function(savedPresets) {
        if (!savedPresets) {
          try { var local = localStorage.getItem('pur_entryLabelPresets'); if (local) savedPresets = JSON.parse(local); } catch(e) {}
        }
        if (savedPresets) {
          Object.keys(_pur_entryLabelPresets).forEach(function(key) {
            if (savedPresets[key]) _pur_entryLabelPresets[key] = Object.assign({}, _pur_entryLabelPresetsDefault[key], savedPresets[key]);
          });
        }
        _pur_currentEntryLabelSettings = Object.assign({}, _pur_entryLabelPresets[_pur_currentEntryPresetKey]);
        purUpdateEntryCustomInputs();
      }).catch(function() {
        try { var local = localStorage.getItem('pur_entryLabelPresets'); if (local) { var sp = JSON.parse(local); Object.keys(_pur_entryLabelPresets).forEach(function(k) { if (sp[k]) _pur_entryLabelPresets[k] = Object.assign({}, _pur_entryLabelPresetsDefault[k], sp[k]); }); } } catch(e) {}
        _pur_currentEntryLabelSettings = Object.assign({}, _pur_entryLabelPresets[_pur_currentEntryPresetKey]);
        purUpdateEntryCustomInputs();
      });
    }

    // ============================================
    // Label print history
    // ============================================
    function purGenerateLabelHistoryId() {
      var dateStr = purGetJSTToday().replace(/-/g, '');
      var randomStr = Math.random().toString(36).substring(2, 7).toUpperCase();
      return 'LABEL-' + dateStr + '-' + randomStr;
    }
    function purSaveLabelPrintHistory(sheetsNeeded) {
      try {
        var historyId = purGenerateLabelHistoryId();
        var slotIds = _pur_entryGeneratedQRData.map(function(qr) { return qr.slotId; });
        var startPos = parseInt((document.getElementById('pur-entryStartPosition') || {}).value) || 1;
        var currentUser = firebase.auth().currentUser;
        var historyData = {
          historyId: historyId,
          batchId: (document.getElementById('pur-entryPurchaseId') || {}).textContent || '',
          slotIds: slotIds, itemCount: slotIds.length,
          presetKey: _pur_currentEntryPresetKey,
          presetName: (_pur_entryLabelPresetsDefault[_pur_currentEntryPresetKey] || {}).name || _pur_currentEntryPresetKey,
          labelSettings: Object.assign({}, _pur_currentEntryLabelSettings),
          startPosition: startPos, sheetsUsed: sheetsNeeded,
          printedBy: currentUser ? currentUser.email : 'unknown',
          printedByName: currentUser ? (currentUser.displayName || '') : '',
          printedAt: firebase.firestore.FieldValue.serverTimestamp(),
          reprintCount: 0, lastReprintAt: null
        };
        window.db.collection('labelPrintHistory').doc(historyId).set(historyData).then(function() {
          console.log('[Pur] 印刷履歴保存完了:', historyId);
        }).catch(function(err) { console.error('[Pur] 印刷履歴保存エラー:', err); });
      } catch(error) { console.error('[Pur] 印刷履歴保存エラー:', error); }
    }
    function purOpenLabelPrintHistoryModal() {
      purOpenModal('pur-labelPrintHistoryModal');
      purRenderLabelPrintHistory();
    }
    function purRenderLabelPrintHistory() {
      var list = document.getElementById('pur-labelPrintHistoryList');
      if (!list) return;
      list.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div> 読み込み中...</div>';
      window.db.collection('labelPrintHistory').orderBy('printedAt', 'desc').limit(10).get().then(function(snap) {
        if (snap.empty) { list.innerHTML = '<div class="text-center text-muted py-3">印刷履歴がありません</div>'; return; }
        var html = '';
        snap.forEach(function(doc) {
          var h = doc.data();
          var date = h.printedAt && h.printedAt.toDate ? h.printedAt.toDate() : new Date();
          var dateStr = date.toLocaleDateString('ja-JP', { month: '2-digit', day: '2-digit' });
          var timeStr = date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
          var reprintBadge = h.reprintCount > 0 ? '<span class="badge bg-secondary ms-1">再' + h.reprintCount + '</span>' : '';
          html += '<div class="list-group-item d-flex justify-content-between align-items-center py-2">' +
            '<div><div class="fw-bold">' + dateStr + ' ' + timeStr + reprintBadge + '</div>' +
            '<small class="text-muted">' + (h.presetName || h.presetKey) + ' ' + h.itemCount + '枚</small></div>' +
            '<div class="btn-group btn-group-sm">' +
            '<button class="btn btn-outline-primary" onclick="purReprintFromHistory(\'' + doc.id + '\')" title="再印刷"><i class="bi bi-printer"></i></button>' +
            '<button class="btn btn-outline-danger" onclick="purDeleteLabelPrintHistory(\'' + doc.id + '\')" title="削除"><i class="bi bi-trash"></i></button>' +
            '</div></div>';
        });
        list.innerHTML = html;
      }).catch(function() { list.innerHTML = '<div class="text-center text-muted py-3">読み込みに失敗しました</div>'; });
    }
    function purDeleteLabelPrintHistory(historyId) {
      if (!confirm('この印刷履歴を削除しますか？')) return;
      window.db.collection('labelPrintHistory').doc(historyId).delete().then(function() { purRenderLabelPrintHistory(); }).catch(function(err) { alert('削除に失敗しました: ' + err.message); });
    }
    function purReprintFromHistory(historyId) {
      var pdfWindow = window.open('about:blank', '_blank');
      window.db.collection('labelPrintHistory').doc(historyId).get().then(function(doc) {
        if (!doc.exists) { if (pdfWindow) pdfWindow.close(); alert('履歴が見つかりません'); return; }
        var history = doc.data();
        var qrPromises = history.slotIds.map(function(slotId) {
          return purGenerateQRCodeDataUrl(slotId).then(function(dataUrl) { return { slotId: slotId, content: slotId, dataUrl: dataUrl }; });
        });
        Promise.all(qrPromises).then(function(qrDataList) {
          _pur_entryGeneratedQRData = qrDataList;
          _pur_currentEntryPresetKey = history.presetKey;
          _pur_currentEntryLabelSettings = Object.assign({}, history.labelSettings);
          var startPosEl = document.getElementById('pur-entryStartPosition');
          if (startPosEl) startPosEl.value = history.startPosition;
          purUpdateEntryLabelPreview();
          window.db.collection('labelPrintHistory').doc(historyId).update({
            reprintCount: firebase.firestore.FieldValue.increment(1),
            lastReprintAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          purCloseModal('pur-labelPrintHistoryModal');
          purPrintEntryLabelSheetWithWindow(pdfWindow, true);
        });
      }).catch(function(error) {
        console.error('[Pur] 再印刷エラー:', error);
        if (pdfWindow) pdfWindow.close();
        alert('再印刷に失敗しました: ' + error.message);
      });
    }

    function purResetEntryForm() {
      _pur_entryItems = [];
      _pur_entryGeneratedQRData = [];
      _pur_entryItemNextId = 1;
      document.getElementById('pur-entryAfterActions').style.display = 'none';
      document.getElementById('pur-qrEntryPreview').style.display = 'none';
      document.getElementById('pur-dispatchNotificationArea').style.display = 'none';
      document.getElementById('pur-entryItemsContainer').innerHTML = '';
      // Reset batch fields
      document.getElementById('pur-entryTotalAmount').value = '';
      document.getElementById('pur-entryItemCount').value = '1';
      document.getElementById('pur-entryMemo').value = '';
      purAddEntryItem(true);
      purUpdateEntryTotal();
    }

    // ============================================
    // Dispatch progress
    // ============================================
    function purLoadDispatchProgress() {
      var tbody = document.getElementById('pur-dispatchProgressBody');
      if (!tbody) return;
      tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">読み込み中...</td></tr>';
      window.db.collection('purchaseBatches').orderBy('createdAt', 'desc').limit(50).get().then(function(snap) {
        _pur_dispatchProgressData = [];
        snap.forEach(function(doc) { _pur_dispatchProgressData.push(Object.assign({ id: doc.id }, doc.data())); });
        purRenderDispatchProgress();
      }).catch(function(err) { tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">読み込みに失敗しました</td></tr>'; });
    }

    function purRenderDispatchProgress() {
      var tbody = document.getElementById('pur-dispatchProgressBody');
      if (!tbody) return;
      var filter = document.getElementById('pur-dispatchStatusFilter').value;
      var filtered = filter === 'all' ? _pur_dispatchProgressData : _pur_dispatchProgressData.filter(function(d) { return d.status === filter; });
      if (filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">該当するデータがありません</td></tr>'; return; }
      var html = '';
      filtered.forEach(function(d) {
        var progress = d.itemCount > 0 ? Math.round((d.registeredCount || 0) / d.itemCount * 100) : 0;
        html += '<tr><td>' + (d.purchaseDate||'-') + '</td><td>' + (d.supplier||'-') + '</td><td>' + (d.itemCount||0) + '</td><td>' + (d.assignee||'-') + '</td><td>' + (d.inspectionAssignee||'-') + '</td><td>' + (d.inspectionStatus||'-') + '</td><td>' + (d.status||'-') + '</td><td>' + progress + '%</td></tr>';
      });
      tbody.innerHTML = html;
    }
    function purFilterDispatchProgress() { purRenderDispatchProgress(); }

    // ============================================
    // Inspection requests
    // ============================================
    function purLoadInspectionRequests() {
      var tbody = document.getElementById('pur-inspectionRequestBody');
      if (!tbody) return;
      tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">読み込み中...</td></tr>';
      window.db.collection('inspectionRequests').orderBy('createdAt', 'desc').limit(50).get().then(function(snap) {
        _pur_inspectionRequestsData = [];
        snap.forEach(function(doc) { _pur_inspectionRequestsData.push(Object.assign({ id: doc.id }, doc.data())); });
        purRenderInspectionRequests();
      }).catch(function() { tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">読み込みに失敗しました</td></tr>'; });
    }

    function purRenderInspectionRequests() {
      var tbody = document.getElementById('pur-inspectionRequestBody');
      if (!tbody) return;
      var filter = document.getElementById('pur-inspectionRequestStatusFilter').value;
      var filtered = filter === 'all' ? _pur_inspectionRequestsData : _pur_inspectionRequestsData.filter(function(d) { return d.status === filter; });
      if (filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">該当するデータがありません</td></tr>'; return; }
      var html = '';
      filtered.forEach(function(d) {
        var progress = d.expectedCount > 0 ? Math.round((d.registeredCount||0) / d.expectedCount * 100) : 0;
        var createdAt = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate().toISOString().slice(0,10) : '-';
        html += '<tr><td>' + createdAt + '</td><td>' + (d.supplier||'-') + '</td><td>' + (d.expectedCount||0) + '</td><td>' + (d.assigneeName||'-') + '</td><td>' + (d.dueDate||'-') + '</td><td>' + progress + '%</td><td>' + (d.status||'-') + '</td><td>' + (d.status !== 'completed' ? '<button class="btn btn-sm btn-outline-danger" onclick="purCancelInspectionRequest(\'' + d.id + '\')">キャンセル</button>' : '-') + '</td></tr>';
      });
      tbody.innerHTML = html;
    }
    function purFilterInspectionRequests() { purRenderInspectionRequests(); }

    function purShowCreateInspectionRequestModal() { purOpenModal('pur-createInspectionRequestModal'); }

    function purCreateInspectionRequest() {
      var supplier = document.getElementById('pur-inspectionRequestSupplier').value;
      var expectedCount = parseInt(document.getElementById('pur-inspectionRequestCount').value) || 0;
      var assigneeEl = document.getElementById('pur-inspectionRequestAssignee');
      var assigneeName = assigneeEl.value;
      var assigneeData = _pur_entryAssigneesData.find(function(a) { return a.name === assigneeName; });
      var assigneeEmail = assigneeData ? assigneeData.email : '';
      var dueDate = document.getElementById('pur-inspectionRequestDueDate').value;
      var note = document.getElementById('pur-inspectionRequestNote').value;

      if (!supplier) { alert('仕入先を選択してください'); return; }
      if (expectedCount <= 0) { alert('予定点数を入力してください'); return; }
      if (!assigneeEmail) { alert('担当者を選択してください'); return; }

      window.db.collection('inspectionRequests').add({
        supplier: supplier, expectedCount: expectedCount, registeredCount: 0,
        assigneeEmail: assigneeEmail, assigneeName: assigneeName,
        dueDate: dueDate || null, note: note, status: 'pending',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdBy: firebase.auth().currentUser ? firebase.auth().currentUser.email : 'unknown'
      }).then(function() {
        purCloseModal('pur-createInspectionRequestModal');
        alert('検品依頼を作成しました');
        purLoadInspectionRequests();
      }).catch(function(err) { alert('作成に失敗しました: ' + err.message); });
    }

    function purCancelInspectionRequest(requestId) {
      if (!confirm('この検品依頼をキャンセルしますか？')) return;
      window.db.collection('inspectionRequests').doc(requestId).update({
        status: 'cancelled', updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(function() { alert('キャンセルしました'); purLoadInspectionRequests(); });
    }

    function purSendDispatchNotification() {
      alert('発送通知を送信しました');
      document.getElementById('pur-btnSendDispatch').style.display = 'none';
      document.getElementById('pur-dispatchNotificationSent').style.display = 'block';
    }

    // ============================================
    // QR Scanner
    // ============================================
    function purOpenQRCheckScanner() {
      document.getElementById('pur-qrCheckScannerModal').style.display = 'flex';
      purStartQRCheckScanner();
    }
    function purCloseQRCheckScanner() {
      purStopQRCheckScanner();
      document.getElementById('pur-qrCheckScannerModal').style.display = 'none';
    }
    function purStartQRCheckScanner() {
      if (typeof Html5Qrcode === 'undefined') { alert('QRスキャナーを読み込み中です'); return; }
      if (_pur_html5QrCode) return;
      _pur_html5QrCode = new Html5Qrcode('pur-qrCheckReader');
      _pur_html5QrCode.start(
        { facingMode: 'environment' },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        function(decodedText) { purOnQRCheckScanSuccess(decodedText); },
        function() {}
      ).catch(function(err) { console.error('[Pur] QRスキャナー起動エラー:', err); });
    }
    function purStopQRCheckScanner() {
      if (_pur_html5QrCode) {
        try { _pur_html5QrCode.stop().catch(function() {}); } catch(e) {}
        _pur_html5QrCode = null;
      }
    }
    function purOnQRCheckScanSuccess(decodedText) {
      purStopQRCheckScanner();
      purCloseQRCheckScanner();
      purShowLoading();
      purGetSlotBySlotId(decodedText).then(function(slotData) {
        purHideLoading();
        if (slotData) {
          alert('スロット情報\nID: ' + slotData.slotId + '\n仕入先: ' + (slotData.supplier||'-') + '\n金額: ' + purFormatCurrency(slotData.amount) + '\nステータス: ' + (slotData.status||'-'));
        } else {
          alert('QRコード情報が見つかりませんでした: ' + decodedText);
        }
      }).catch(function() { purHideLoading(); alert('情報の取得に失敗しました'); });
    }

    // ============================================
    // Damage marker constants & images
    // ============================================
    var _pur_SUBCATEGORY_IMAGES = {
      'Tシャツ': { front: '/images/clothing/tshirt_front-Photoroom.png', back: '/images/clothing/tshirt_back-Photoroom.png' },
      '半袖シャツ': { front: '/images/clothing/shirt_short_front-Photoroom.png', back: '/images/clothing/shirt_short_back-Photoroom.png' },
      '長袖シャツ': { front: '/images/clothing/shirt_long_front-Photoroom.png', back: '/images/clothing/shirt_long_back-Photoroom.png' },
      'ポロシャツ': { front: '/images/clothing/polo_front-Photoroom.png?v=2', back: '/images/clothing/polo_back-Photoroom.png?v=2' },
      '七分・長袖カットソー': { front: '/images/clothing/longsleeve_front-Photoroom.png?v=2', back: '/images/clothing/longsleeve_back-Photoroom.png?v=2' },
      'パーカー': { front: '/images/clothing/hoodie_front-Photoroom.png', back: '/images/clothing/hoodie_back-Photoroom.png' },
      'トレーナー・スウェット': { front: '/images/clothing/sweatshirt_front-Photoroom.png', back: '/images/clothing/sweatshirt_back-Photoroom.png' },
      'ニット・セーター': { front: '/images/clothing/sweater_front-Photoroom.png', back: '/images/clothing/sweater_back-Photoroom.png' },
      'カーディガン': { front: '/images/clothing/cardigan_front-Photoroom.png', back: '/images/clothing/cardigan_back-Photoroom.png' },
      'ジャージ': { front: '/images/clothing/jersey_front-Photoroom.png', back: '/images/clothing/jersey_back-Photoroom.png' },
      'ベスト': { front: '/images/clothing/vest_front-Photoroom.png', back: '/images/clothing/vest_back-Photoroom.png' },
      'タンクトップ・ノースリーブトップス': { front: '/images/clothing/tanktop_front-Photoroom.png', back: '/images/clothing/tanktop_back-Photoroom.png' }
    };
    var _pur_SUBCATEGORY_NEEDS_FINE = ['シャツ'];

    function purNeedsFineCategoryForImage(subcategory) {
      return _pur_SUBCATEGORY_NEEDS_FINE.indexOf(subcategory) !== -1;
    }
    function purFindDamageMarkerImages(subcategory, fineCategory) {
      if (fineCategory && _pur_SUBCATEGORY_IMAGES[fineCategory]) return _pur_SUBCATEGORY_IMAGES[fineCategory];
      if (subcategory && _pur_SUBCATEGORY_IMAGES[subcategory]) return _pur_SUBCATEGORY_IMAGES[subcategory];
      return null;
    }
    function purGetCircledNumber(num) {
      var cn = ['', '\u2460', '\u2461', '\u2462', '\u2463', '\u2464', '\u2465', '\u2466', '\u2467', '\u2468', '\u2469',
                '\u246A', '\u246B', '\u246C', '\u246D', '\u246E', '\u246F', '\u2470', '\u2471', '\u2472', '\u2473'];
      if (num >= 1 && num <= 20) return cn[num];
      return '(' + num + ')';
    }

    // ============================================
    // Batch damage marker (full implementation)
    // ============================================
    var _pur_batchDamageMarkerState = {
      front: null, back: null, currentSide: 'front', currentSubcategory: null, currentFineCategory: null
    };
    var _pur_batchDamageMarkerSaved = { front: null, back: null };

    function purToggleBatchDamageMarker() {
      var container = document.getElementById('pur-batch-damage-marker-container');
      if (!container) return;
      container.classList.toggle('active');
      var text = document.getElementById('pur-batch-damage-marker-toggle-text');
      if (text) text.textContent = container.classList.contains('active') ? '閉じる' : '開く';
    }

    function purLoadBatchDamageMarkerBySubcategory(subcategory, fineCategory) {
      var noCategoryMsg = document.getElementById('pur-batch-damage-marker-no-category');
      var sideToggle = document.getElementById('pur-batch-damage-marker-side-toggle');
      if (!subcategory) {
        if (noCategoryMsg) { noCategoryMsg.innerHTML = '<i class="bi bi-info-circle"></i><span>小分類を選択すると画像が表示されます</span>'; noCategoryMsg.style.display = 'flex'; }
        if (sideToggle) sideToggle.style.display = 'none';
        purHideBatchDamageMarkerCanvas();
        _pur_batchDamageMarkerState.currentSubcategory = null;
        _pur_batchDamageMarkerState.currentFineCategory = null;
        return;
      }
      if (purNeedsFineCategoryForImage(subcategory) && !fineCategory) {
        if (noCategoryMsg) { noCategoryMsg.innerHTML = '<i class="bi bi-info-circle"></i><span>細分類を選択すると画像が表示されます</span>'; noCategoryMsg.style.display = 'flex'; }
        if (sideToggle) sideToggle.style.display = 'none';
        purHideBatchDamageMarkerCanvas();
        _pur_batchDamageMarkerState.currentSubcategory = subcategory;
        _pur_batchDamageMarkerState.currentFineCategory = null;
        return;
      }
      var searchKey = fineCategory || subcategory;
      var prevKey = _pur_batchDamageMarkerState.currentFineCategory || _pur_batchDamageMarkerState.currentSubcategory;
      if (prevKey !== searchKey) {
        _pur_batchDamageMarkerState.front = null;
        _pur_batchDamageMarkerState.back = null;
        _pur_batchDamageMarkerState.currentSide = 'front';
        _pur_batchDamageMarkerSaved.front = null;
        _pur_batchDamageMarkerSaved.back = null;
        var fb = document.getElementById('pur-batch-front-saved-badge');
        var bb = document.getElementById('pur-batch-back-saved-badge');
        if (fb) fb.style.display = 'none';
        if (bb) bb.style.display = 'none';
      }
      _pur_batchDamageMarkerState.currentSubcategory = subcategory;
      _pur_batchDamageMarkerState.currentFineCategory = fineCategory;
      var images = purFindDamageMarkerImages(subcategory, fineCategory);
      if (!images) {
        if (noCategoryMsg) { noCategoryMsg.innerHTML = '<i class="bi bi-exclamation-circle"></i><span>この分類の画像は準備中です</span>'; noCategoryMsg.style.display = 'flex'; }
        if (sideToggle) sideToggle.style.display = 'none';
        purHideBatchDamageMarkerCanvas();
        return;
      }
      if (noCategoryMsg) noCategoryMsg.style.display = 'none';
      if (sideToggle) sideToggle.style.display = 'flex';
      purUpdateBatchSideToggleUI('front');
      purInitBatchDamageMarkerCanvas(images.front, 'front');
    }

    function purSwitchBatchDamageMarkerSide(side) {
      var sub = _pur_batchDamageMarkerState.currentSubcategory;
      var fine = _pur_batchDamageMarkerState.currentFineCategory;
      var images = purFindDamageMarkerImages(sub, fine);
      if (!images) return;
      purSaveBatchCurrentSideState();
      _pur_batchDamageMarkerState.currentSide = side;
      purUpdateBatchSideToggleUI(side);
      if (_pur_batchDamageMarkerState[side]) {
        purRenderBatchDamageMarker();
        document.getElementById('pur-batch-damage-marker-wrapper').style.display = 'block';
        document.getElementById('pur-batch-damage-marker-tools').style.display = 'flex';
        document.getElementById('pur-batch-damage-marker-actions').style.display = 'flex';
        document.getElementById('pur-batch-damage-marker-note').style.display = 'block';
      } else {
        var imagePath = side === 'front' ? images.front : images.back;
        purInitBatchDamageMarkerCanvas(imagePath, side);
      }
    }

    function purUpdateBatchSideToggleUI(activeSide) {
      var f = document.getElementById('pur-batch-side-front-btn');
      var b = document.getElementById('pur-batch-side-back-btn');
      if (f) f.classList.toggle('active', activeSide === 'front');
      if (b) b.classList.toggle('active', activeSide === 'back');
    }

    function purSaveBatchCurrentSideState() {
      // state is held by reference, nothing extra needed
    }

    function purGetCurrentBatchState() {
      return _pur_batchDamageMarkerState[_pur_batchDamageMarkerState.currentSide];
    }

    function purGetNextBatchMarkerNumber() {
      var maxNumber = 0;
      ['front', 'back'].forEach(function(side) {
        var state = _pur_batchDamageMarkerState[side];
        if (state && state.objects) {
          state.objects.forEach(function(obj) {
            if (obj.type === 'circle' && obj.number) maxNumber = Math.max(maxNumber, obj.number);
          });
        }
      });
      return maxNumber + 1;
    }

    function purAppendBatchMarkerNumberToNotes(number) {
      var noteEl = document.getElementById('pur-batch-damage-marker-note-text');
      if (!noteEl) return;
      var circledNum = purGetCircledNumber(number);
      var currentText = noteEl.value;
      if (currentText.trim()) { noteEl.value = currentText + '\n' + circledNum + ' '; }
      else { noteEl.value = circledNum + ' '; }
      noteEl.focus();
      noteEl.setSelectionRange(noteEl.value.length, noteEl.value.length);
    }

    function purHideBatchDamageMarkerCanvas() {
      var ids = ['pur-batch-damage-marker-wrapper', 'pur-batch-damage-marker-tools', 'pur-batch-damage-marker-note', 'pur-batch-damage-marker-actions', 'pur-batch-damage-marker-object-controls'];
      ids.forEach(function(id) { var el = document.getElementById(id); if (el) el.style.display = 'none'; });
    }

    function purInitBatchDamageMarkerCanvas(imagePath, side) {
      var canvas = document.getElementById('pur-batch-damage-marker-canvas');
      if (!canvas) return;
      var ctx = canvas.getContext('2d');
      var currentSide = side || _pur_batchDamageMarkerState.currentSide;
      var img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = function() {
        var maxWidth = 280;
        var scale = maxWidth / img.width;
        var newWidth = img.width * scale;
        var newHeight = img.height * scale;
        canvas.width = newWidth;
        canvas.height = newHeight;
        _pur_batchDamageMarkerState[currentSide] = {
          ctx: ctx, canvas: canvas, baseImage: img, baseWidth: newWidth, baseHeight: newHeight,
          objects: [], selectedObject: null, tool: 'circle', color: '#ef4444',
          history: [], historyIndex: -1, isDrawing: false, currentPath: []
        };
        purSaveBatchMarkerHistory();
        purRenderBatchDamageMarker();
        document.getElementById('pur-batch-damage-marker-wrapper').style.display = 'block';
        document.getElementById('pur-batch-damage-marker-tools').style.display = 'flex';
        document.getElementById('pur-batch-damage-marker-actions').style.display = 'flex';
        document.getElementById('pur-batch-damage-marker-note').style.display = 'block';
        purSetupBatchDamageMarkerEvents();
      };
      img.onerror = function() { console.error('[Pur] 画像読み込み失敗:', imagePath); };
      img.src = imagePath;
    }

    function purRenderBatchDamageMarker() {
      var state = purGetCurrentBatchState();
      if (!state) return;
      var ctx = state.ctx, canvas = state.canvas;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(state.baseImage, 0, 0, state.baseWidth, state.baseHeight);
      state.objects.forEach(function(obj, index) {
        ctx.save();
        if (obj.type === 'circle') {
          ctx.strokeStyle = obj.color; ctx.lineWidth = 3;
          ctx.beginPath(); ctx.arc(obj.x, obj.y, obj.radius, 0, Math.PI * 2); ctx.stroke();
          if (obj.number) {
            ctx.fillStyle = obj.color;
            ctx.font = 'bold ' + Math.max(14, obj.radius) + 'px sans-serif';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(purGetCircledNumber(obj.number), obj.x, obj.y);
          }
          if (index === state.selectedObject) {
            ctx.setLineDash([5, 5]); ctx.strokeStyle = '#0ea5e9'; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.arc(obj.x, obj.y, obj.radius + 5, 0, Math.PI * 2); ctx.stroke();
          }
        } else if (obj.type === 'text') {
          ctx.fillStyle = obj.color; ctx.font = obj.fontSize + 'px sans-serif';
          ctx.fillText(obj.text, obj.x, obj.y);
          if (index === state.selectedObject) {
            var metrics = ctx.measureText(obj.text);
            ctx.setLineDash([5, 5]); ctx.strokeStyle = '#0ea5e9'; ctx.lineWidth = 2;
            ctx.strokeRect(obj.x - 2, obj.y - obj.fontSize, metrics.width + 4, obj.fontSize + 4);
          }
        } else if (obj.type === 'pen') {
          ctx.strokeStyle = obj.color; ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
          ctx.beginPath();
          obj.points.forEach(function(point, i) { if (i === 0) ctx.moveTo(point.x, point.y); else ctx.lineTo(point.x, point.y); });
          ctx.stroke();
          if (index === state.selectedObject) { ctx.setLineDash([5, 5]); ctx.strokeStyle = '#0ea5e9'; ctx.lineWidth = 2; ctx.stroke(); }
        }
        ctx.restore();
      });
    }

    function purSetupBatchDamageMarkerEvents() {
      var canvas = document.getElementById('pur-batch-damage-marker-canvas');
      if (!canvas) return;
      var getPos = function(e) {
        var rect = canvas.getBoundingClientRect();
        var scaleX = canvas.width / rect.width, scaleY = canvas.height / rect.height;
        if (e.touches && e.touches.length > 0) return { x: (e.touches[0].clientX - rect.left) * scaleX, y: (e.touches[0].clientY - rect.top) * scaleY };
        return { x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top) * scaleY };
      };
      var touchStartPos = null, touchStartTime = null;
      var handleStart = function(e) {
        if (e.type === 'touchstart') { touchStartPos = getPos(e); touchStartTime = Date.now(); }
        var state = purGetCurrentBatchState(); if (!state) return;
        var pos = getPos(e);
        var clickedIndex = purFindBatchObjectAtPosition(pos);
        if (clickedIndex !== -1) {
          state.selectedObject = clickedIndex;
          state.dragOffset = { x: pos.x - purGetObjectCenter(state.objects[clickedIndex]).x, y: pos.y - purGetObjectCenter(state.objects[clickedIndex]).y };
          state.isDragging = true;
          purShowBatchObjectControls();
          purRenderBatchDamageMarker();
          if (e.type === 'touchstart') e.preventDefault();
          return;
        }
        if (state.tool === 'pen') { state.isDrawing = true; state.currentPath = [pos]; if (e.type === 'touchstart') e.preventDefault(); }
      };
      var handleMove = function(e) {
        var state = purGetCurrentBatchState(); if (!state) return;
        var pos = getPos(e);
        if (state.isDrawing && state.tool === 'pen') {
          state.currentPath.push(pos);
          purRenderBatchDamageMarker();
          var ctx = state.ctx; ctx.strokeStyle = state.color; ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
          ctx.beginPath();
          state.currentPath.forEach(function(point, i) { if (i === 0) ctx.moveTo(point.x, point.y); else ctx.lineTo(point.x, point.y); });
          ctx.stroke();
          if (e.type === 'touchmove') e.preventDefault();
          return;
        }
        if (state.isDragging && state.selectedObject !== null) {
          var obj = state.objects[state.selectedObject];
          var center = purGetObjectCenter(obj);
          var dx = pos.x - state.dragOffset.x - center.x, dy = pos.y - state.dragOffset.y - center.y;
          purMoveObject(obj, dx, dy);
          purRenderBatchDamageMarker();
          if (e.type === 'touchmove') e.preventDefault();
        }
      };
      var handleEnd = function(e) {
        var state = purGetCurrentBatchState(); if (!state) return;
        var pos = e.changedTouches ? { x: (e.changedTouches[0].clientX - canvas.getBoundingClientRect().left) * (canvas.width / canvas.getBoundingClientRect().width), y: (e.changedTouches[0].clientY - canvas.getBoundingClientRect().top) * (canvas.height / canvas.getBoundingClientRect().height) } : getPos(e);
        if (state.isDrawing && state.tool === 'pen') {
          if (state.currentPath.length > 1) { state.objects.push({ type: 'pen', points: state.currentPath.slice(), color: state.color }); purSaveBatchMarkerHistory(); }
          state.isDrawing = false; state.currentPath = [];
          purRenderBatchDamageMarker(); return;
        }
        if (state.isDragging) { state.isDragging = false; purSaveBatchMarkerHistory(); return; }
        if (e.type === 'touchend' && touchStartPos) {
          var duration = Date.now() - touchStartTime;
          var distance = Math.sqrt(Math.pow(pos.x - touchStartPos.x, 2) + Math.pow(pos.y - touchStartPos.y, 2));
          if (duration > 300 || distance > 20) { touchStartPos = null; touchStartTime = null; return; }
        }
        if (state.tool === 'circle') {
          var markerNumber = purGetNextBatchMarkerNumber();
          state.objects.push({ type: 'circle', x: pos.x, y: pos.y, radius: 15, color: state.color, number: markerNumber });
          purSaveBatchMarkerHistory(); purRenderBatchDamageMarker();
          purAppendBatchMarkerNumberToNotes(markerNumber);
        } else if (state.tool === 'text') {
          var text = prompt('テキストを入力:');
          if (text) { state.objects.push({ type: 'text', x: pos.x, y: pos.y, text: text, fontSize: 16, color: state.color }); purSaveBatchMarkerHistory(); purRenderBatchDamageMarker(); }
        }
        state.selectedObject = null; purHideBatchObjectControls();
        touchStartPos = null; touchStartTime = null;
      };
      canvas.addEventListener('mousedown', handleStart);
      canvas.addEventListener('mousemove', handleMove);
      canvas.addEventListener('mouseup', handleEnd);
      canvas.addEventListener('touchstart', handleStart, { passive: false });
      canvas.addEventListener('touchmove', handleMove, { passive: false });
      canvas.addEventListener('touchend', handleEnd);
    }

    function purFindBatchObjectAtPosition(pos) {
      var state = purGetCurrentBatchState(); if (!state) return -1;
      for (var i = state.objects.length - 1; i >= 0; i--) {
        var obj = state.objects[i];
        if (obj.type === 'circle') { var dist = Math.sqrt(Math.pow(pos.x - obj.x, 2) + Math.pow(pos.y - obj.y, 2)); if (dist <= obj.radius + 10) return i; }
        else if (obj.type === 'text') { var ctx = state.ctx; ctx.font = obj.fontSize + 'px sans-serif'; var m = ctx.measureText(obj.text); if (pos.x >= obj.x - 5 && pos.x <= obj.x + m.width + 5 && pos.y >= obj.y - obj.fontSize - 5 && pos.y <= obj.y + 5) return i; }
        else if (obj.type === 'pen') { for (var j = 0; j < obj.points.length; j++) { var d = Math.sqrt(Math.pow(pos.x - obj.points[j].x, 2) + Math.pow(pos.y - obj.points[j].y, 2)); if (d <= 10) return i; } }
      }
      return -1;
    }
    function purGetObjectCenter(obj) {
      if (obj.type === 'circle' || obj.type === 'text') return { x: obj.x, y: obj.y };
      if (obj.type === 'pen' && obj.points.length > 0) {
        var sx = 0, sy = 0; obj.points.forEach(function(p) { sx += p.x; sy += p.y; });
        return { x: sx / obj.points.length, y: sy / obj.points.length };
      }
      return { x: 0, y: 0 };
    }
    function purMoveObject(obj, dx, dy) {
      if (obj.type === 'circle' || obj.type === 'text') { obj.x += dx; obj.y += dy; }
      else if (obj.type === 'pen') { obj.points.forEach(function(p) { p.x += dx; p.y += dy; }); }
    }
    function purShowBatchObjectControls() { var c = document.getElementById('pur-batch-damage-marker-object-controls'); if (c) c.style.display = 'flex'; }
    function purHideBatchObjectControls() { var c = document.getElementById('pur-batch-damage-marker-object-controls'); if (c) c.style.display = 'none'; }
    function purSaveBatchMarkerHistory() {
      var state = purGetCurrentBatchState(); if (!state) return;
      state.history = state.history.slice(0, state.historyIndex + 1);
      state.history.push(JSON.parse(JSON.stringify(state.objects)));
      state.historyIndex = state.history.length - 1;
    }
    function purSetBatchDamageMarkerTool(tool) {
      var state = purGetCurrentBatchState(); if (!state) return;
      state.tool = tool; state.selectedObject = null; purHideBatchObjectControls(); purRenderBatchDamageMarker();
      document.querySelectorAll('#spa-page-purchase #pur-batch-damage-marker-tools .damage-marker-tool').forEach(function(btn) {
        btn.classList.toggle('active', btn.getAttribute('data-tool') === tool);
      });
    }
    function purSetBatchDamageMarkerColor(color) {
      var state = purGetCurrentBatchState(); if (!state) return;
      state.color = color;
      if (state.selectedObject !== null) { state.objects[state.selectedObject].color = color; purSaveBatchMarkerHistory(); purRenderBatchDamageMarker(); }
      document.querySelectorAll('#spa-page-purchase #pur-batch-damage-marker-tools .damage-marker-color').forEach(function(btn) {
        var btnColor = btn.classList.contains('red') ? '#ef4444' : btn.classList.contains('blue') ? '#3b82f6' : '#1f2937';
        btn.classList.toggle('active', btnColor === color);
      });
    }
    function purClearBatchDamageMarker() {
      var state = purGetCurrentBatchState(); if (!state) return;
      if (!confirm('描いた内容をすべて消去しますか？')) return;
      state.objects = []; state.selectedObject = null; purHideBatchObjectControls(); purSaveBatchMarkerHistory(); purRenderBatchDamageMarker();
    }
    function purUndoBatchDamageMarker() {
      var state = purGetCurrentBatchState(); if (!state || state.historyIndex <= 0) return;
      state.historyIndex--; state.objects = JSON.parse(JSON.stringify(state.history[state.historyIndex]));
      state.selectedObject = null; purHideBatchObjectControls(); purRenderBatchDamageMarker();
    }
    function purRedoBatchDamageMarker() {
      var state = purGetCurrentBatchState(); if (!state || state.historyIndex >= state.history.length - 1) return;
      state.historyIndex++; state.objects = JSON.parse(JSON.stringify(state.history[state.historyIndex]));
      state.selectedObject = null; purHideBatchObjectControls(); purRenderBatchDamageMarker();
    }
    function purSaveBatchDamageMarker() {
      var currentSide = _pur_batchDamageMarkerState.currentSide;
      var state = _pur_batchDamageMarkerState[currentSide]; if (!state) return;
      state.selectedObject = null; purHideBatchObjectControls(); purRenderBatchDamageMarker();
      var canvas = document.getElementById('pur-batch-damage-marker-canvas');
      var dataUrl = canvas.toDataURL('image/png');
      _pur_batchDamageMarkerSaved[currentSide] = {
        image: dataUrl, subcategory: _pur_batchDamageMarkerState.currentSubcategory, side: currentSide,
        objects: JSON.parse(JSON.stringify(state.objects)),
        note: (document.getElementById('pur-batch-damage-marker-note-text') || {}).value || ''
      };
      var badgeId = currentSide === 'front' ? 'pur-batch-front-saved-badge' : 'pur-batch-back-saved-badge';
      var badge = document.getElementById(badgeId); if (badge) badge.style.display = 'inline';
      var previewContainer = document.getElementById('pur-batch-damage-marker-preview');
      var previewImg = document.getElementById('pur-batch-damage-marker-preview-img');
      if (previewImg) previewImg.src = dataUrl;
      if (previewContainer) previewContainer.style.display = 'block';
      var sideLabel = currentSide === 'front' ? '表' : '裏';
      alert(sideLabel + '面のマーキングを保存しました');
    }
    function purGetBatchDamageMarker() {
      if (!_pur_batchDamageMarkerSaved.front && !_pur_batchDamageMarkerSaved.back) return null;
      return { front: _pur_batchDamageMarkerSaved.front, back: _pur_batchDamageMarkerSaved.back };
    }
    function purEnlargeBatchSelectedObject() {
      var state = purGetCurrentBatchState(); if (!state || state.selectedObject === null) return;
      var obj = state.objects[state.selectedObject];
      if (obj.type === 'circle') obj.radius = Math.min(100, obj.radius + 5);
      else if (obj.type === 'text') obj.fontSize = Math.min(48, obj.fontSize + 2);
      purSaveBatchMarkerHistory(); purRenderBatchDamageMarker();
    }
    function purShrinkBatchSelectedObject() {
      var state = purGetCurrentBatchState(); if (!state || state.selectedObject === null) return;
      var obj = state.objects[state.selectedObject];
      if (obj.type === 'circle') obj.radius = Math.max(5, obj.radius - 5);
      else if (obj.type === 'text') obj.fontSize = Math.max(10, obj.fontSize - 2);
      purSaveBatchMarkerHistory(); purRenderBatchDamageMarker();
    }
    function purDeleteBatchSelectedObject() {
      var state = purGetCurrentBatchState(); if (!state || state.selectedObject === null) return;
      state.objects.splice(state.selectedObject, 1); state.selectedObject = null;
      purHideBatchObjectControls(); purSaveBatchMarkerHistory(); purRenderBatchDamageMarker();
    }

    // ============================================
    // Individual item damage marker (full)
    // ============================================
    function purToggleDamageMarker(itemId) {
      var container = document.getElementById('pur-damage-marker-container-' + itemId);
      var toggleText = document.getElementById('pur-damage-marker-toggle-text-' + itemId);
      if (!container) return;
      if (container.classList.contains('active')) { container.classList.remove('active'); if (toggleText) toggleText.textContent = '開く'; }
      else { container.classList.add('active'); if (toggleText) toggleText.textContent = '閉じる'; }
    }
    function purGetCurrentItemState(itemId) {
      var itemState = _pur_damageMarkerState.get(itemId); if (!itemState) return null;
      return itemState[itemState.currentSide];
    }
    function purGetNextItemMarkerNumber(itemId) {
      var itemState = _pur_damageMarkerState.get(itemId); if (!itemState) return 1;
      var maxNumber = 0;
      ['front', 'back'].forEach(function(side) {
        var state = itemState[side];
        if (state && state.objects) state.objects.forEach(function(obj) { if (obj.type === 'circle' && obj.number) maxNumber = Math.max(maxNumber, obj.number); });
      });
      return maxNumber + 1;
    }
    function purAppendItemMarkerNumberToNotes(itemId, number) {
      var noteEl = document.getElementById('pur-damage-marker-note-text-' + itemId); if (!noteEl) return;
      var circledNum = purGetCircledNumber(number);
      if (noteEl.value.trim()) noteEl.value = noteEl.value + '\n' + circledNum + ' ';
      else noteEl.value = circledNum + ' ';
      noteEl.focus(); noteEl.setSelectionRange(noteEl.value.length, noteEl.value.length);
    }
    function purLoadDamageMarkerBySubcategory(itemId, subcategory, fineCategory) {
      var noCategoryMsg = document.getElementById('pur-damage-marker-no-category-' + itemId);
      var sideToggle = document.getElementById('pur-damage-marker-side-toggle-' + itemId);
      if (!subcategory) {
        if (noCategoryMsg) { noCategoryMsg.innerHTML = '<i class="bi bi-info-circle"></i><span>小分類を選択すると画像が表示されます</span>'; noCategoryMsg.style.display = 'flex'; }
        if (sideToggle) sideToggle.style.display = 'none';
        purHideDamageMarkerCanvas(itemId); return;
      }
      if (purNeedsFineCategoryForImage(subcategory) && !fineCategory) {
        if (noCategoryMsg) { noCategoryMsg.innerHTML = '<i class="bi bi-info-circle"></i><span>細分類を選択すると画像が表示されます</span>'; noCategoryMsg.style.display = 'flex'; }
        if (sideToggle) sideToggle.style.display = 'none';
        purHideDamageMarkerCanvas(itemId); return;
      }
      var searchKey = fineCategory || subcategory;
      var itemState = _pur_damageMarkerState.get(itemId);
      var prevKey = itemState ? (itemState.currentFineCategory || itemState.currentSubcategory) : null;
      if (!itemState || prevKey !== searchKey) {
        itemState = { front: null, back: null, currentSide: 'front', currentSubcategory: subcategory, currentFineCategory: fineCategory, savedFront: null, savedBack: null };
        _pur_damageMarkerState.set(itemId, itemState);
        var fb = document.getElementById('pur-front-saved-badge-' + itemId);
        var bb = document.getElementById('pur-back-saved-badge-' + itemId);
        if (fb) fb.style.display = 'none'; if (bb) bb.style.display = 'none';
      }
      var images = purFindDamageMarkerImages(subcategory, fineCategory);
      if (!images) {
        if (noCategoryMsg) { noCategoryMsg.innerHTML = '<i class="bi bi-exclamation-circle"></i><span>この分類の画像は準備中です</span>'; noCategoryMsg.style.display = 'flex'; }
        if (sideToggle) sideToggle.style.display = 'none';
        purHideDamageMarkerCanvas(itemId); return;
      }
      if (noCategoryMsg) noCategoryMsg.style.display = 'none';
      if (sideToggle) sideToggle.style.display = 'flex';
      purUpdateItemSideToggleUI(itemId, 'front');
      purInitDamageMarkerCanvas(itemId, images.front, 'front');
    }
    function purSwitchDamageMarkerSide(itemId, side) {
      var itemState = _pur_damageMarkerState.get(itemId); if (!itemState) return;
      var images = purFindDamageMarkerImages(itemState.currentSubcategory, itemState.currentFineCategory); if (!images) return;
      itemState.currentSide = side; purUpdateItemSideToggleUI(itemId, side);
      if (itemState[side]) {
        purRenderDamageMarker(itemId);
        document.getElementById('pur-damage-marker-wrapper-' + itemId).style.display = 'block';
        document.getElementById('pur-damage-marker-tools-' + itemId).style.display = 'flex';
        document.getElementById('pur-damage-marker-actions-' + itemId).style.display = 'flex';
        var noteEl = document.getElementById('pur-damage-marker-note-' + itemId); if (noteEl) noteEl.style.display = 'block';
      } else {
        var imagePath = side === 'front' ? images.front : images.back;
        purInitDamageMarkerCanvas(itemId, imagePath, side);
      }
    }
    function purUpdateItemSideToggleUI(itemId, activeSide) {
      var f = document.getElementById('pur-side-front-btn-' + itemId);
      var b = document.getElementById('pur-side-back-btn-' + itemId);
      if (f) f.classList.toggle('active', activeSide === 'front'); if (b) b.classList.toggle('active', activeSide === 'back');
    }
    function purHideDamageMarkerCanvas(itemId) {
      ['wrapper', 'tools', 'note', 'actions', 'object-controls'].forEach(function(part) {
        var el = document.getElementById('pur-damage-marker-' + part + '-' + itemId); if (el) el.style.display = 'none';
      });
    }
    function purInitDamageMarkerCanvas(itemId, imagePath, side) {
      var canvas = document.getElementById('pur-damage-marker-canvas-' + itemId); if (!canvas) return;
      var ctx = canvas.getContext('2d');
      var img = new Image(); img.crossOrigin = 'anonymous';
      img.onload = function() {
        var maxSize = 300, w = img.width, h = img.height;
        if (w > maxSize || h > maxSize) { var ratio = Math.min(maxSize / w, maxSize / h); w *= ratio; h *= ratio; }
        canvas.width = w; canvas.height = h;
        var sideState = { canvas: canvas, ctx: ctx, baseImage: img, baseWidth: w, baseHeight: h, objects: [], selectedObject: null, tool: 'circle', color: '#ef4444', isDragging: false, dragStart: { x: 0, y: 0 }, history: [], historyIndex: -1 };
        var itemState = _pur_damageMarkerState.get(itemId);
        if (!itemState) { itemState = { front: null, back: null, currentSide: side, currentSubcategory: null }; _pur_damageMarkerState.set(itemId, itemState); }
        itemState[side] = sideState; itemState.currentSide = side;
        purSaveItemMarkerHistory(itemId); purRenderDamageMarker(itemId);
        document.getElementById('pur-damage-marker-wrapper-' + itemId).style.display = 'block';
        document.getElementById('pur-damage-marker-tools-' + itemId).style.display = 'flex';
        document.getElementById('pur-damage-marker-actions-' + itemId).style.display = 'flex';
        var noteEl = document.getElementById('pur-damage-marker-note-' + itemId); if (noteEl) noteEl.style.display = 'block';
        purSetupDamageMarkerEvents(itemId);
      };
      img.onerror = function() { alert('画像の読み込みに失敗しました'); };
      img.src = imagePath;
    }
    function purRenderDamageMarker(itemId) {
      var state = purGetCurrentItemState(itemId); if (!state) return;
      var ctx = state.ctx, canvas = state.canvas;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(state.baseImage, 0, 0, state.baseWidth, state.baseHeight);
      state.objects.forEach(function(obj, index) {
        ctx.save();
        if (obj.type === 'circle') {
          ctx.strokeStyle = obj.color; ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(obj.x, obj.y, obj.radius, 0, Math.PI * 2); ctx.stroke();
          if (obj.number) { ctx.fillStyle = obj.color; ctx.font = 'bold ' + Math.max(14, obj.radius) + 'px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(purGetCircledNumber(obj.number), obj.x, obj.y); }
          if (state.selectedObject === index) { ctx.setLineDash([4, 4]); ctx.strokeStyle = '#0d9488'; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(obj.x, obj.y, obj.radius + 5, 0, Math.PI * 2); ctx.stroke(); }
        } else if (obj.type === 'text') {
          ctx.font = obj.fontSize + 'px sans-serif'; ctx.fillStyle = obj.color; ctx.fillText(obj.text, obj.x, obj.y);
          if (state.selectedObject === index) { var m = ctx.measureText(obj.text); ctx.setLineDash([4, 4]); ctx.strokeStyle = '#0d9488'; ctx.lineWidth = 2; ctx.strokeRect(obj.x - 2, obj.y - obj.fontSize, m.width + 4, obj.fontSize + 4); }
        } else if (obj.type === 'pen' && obj.points && obj.points.length > 1) {
          ctx.beginPath(); ctx.moveTo(obj.points[0].x, obj.points[0].y);
          for (var i = 1; i < obj.points.length; i++) ctx.lineTo(obj.points[i].x, obj.points[i].y);
          ctx.strokeStyle = obj.color; ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.stroke();
        }
        ctx.restore();
      });
    }
    function purSetupDamageMarkerEvents(itemId) {
      var canvas = document.getElementById('pur-damage-marker-canvas-' + itemId); if (!canvas) return;
      var getPos = function(e) {
        var rect = canvas.getBoundingClientRect(), scaleX = canvas.width / rect.width, scaleY = canvas.height / rect.height;
        var cx, cy;
        if (e.touches && e.touches.length > 0) { cx = e.touches[0].clientX; cy = e.touches[0].clientY; }
        else if (e.changedTouches && e.changedTouches.length > 0) { cx = e.changedTouches[0].clientX; cy = e.changedTouches[0].clientY; }
        else { cx = e.clientX; cy = e.clientY; }
        return { x: (cx - rect.left) * scaleX, y: (cy - rect.top) * scaleY };
      };
      var handleStart = function(e) {
        e.preventDefault();
        if (e.touches && e.touches.length >= 2) return;
        var state = purGetCurrentItemState(itemId); if (!state) return;
        var pos = getPos(e);
        state.touchStartPos = pos; state.touchStartTime = Date.now(); state.pendingNewObject = false;
        var hitIndex = purHitTestObjects(state, pos);
        if (hitIndex !== -1) { state.selectedObject = hitIndex; state.isDragging = true; state.dragStart = pos; purRenderDamageMarker(itemId); purShowItemObjectControls(itemId); return; }
        if (state.selectedObject !== null) { state.selectedObject = null; purHideItemObjectControls(itemId); purRenderDamageMarker(itemId); return; }
        if (state.tool === 'pen') { state.currentPen = { type: 'pen', points: [pos], color: state.color }; state.isDrawingPen = true; return; }
        if (state.tool === 'circle' || state.tool === 'text') state.pendingNewObject = true;
      };
      var handleMove = function(e) {
        e.preventDefault(); if (e.touches && e.touches.length >= 2) return;
        var state = purGetCurrentItemState(itemId); if (!state) return;
        var pos = getPos(e);
        if (state.isDrawingPen && state.currentPen) {
          state.currentPen.points.push(pos); purRenderDamageMarker(itemId);
          var ctx = state.ctx, pts = state.currentPen.points;
          if (pts.length > 1) { ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y); for (var i = 1; i < pts.length; i++) ctx.lineTo(pts[i].x, pts[i].y); ctx.strokeStyle = state.currentPen.color; ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.stroke(); }
          return;
        }
        if (state.isDragging && state.selectedObject !== null) {
          var obj = state.objects[state.selectedObject];
          var dx = pos.x - state.dragStart.x, dy = pos.y - state.dragStart.y;
          obj.x += dx; obj.y += dy;
          if (obj.type === 'pen') obj.points.forEach(function(p) { p.x += dx; p.y += dy; });
          state.dragStart = pos; purRenderDamageMarker(itemId);
        }
      };
      var handleEnd = function(e) {
        var state = purGetCurrentItemState(itemId); if (!state) return;
        var pos = getPos(e);
        if (state.isDrawingPen && state.currentPen && state.currentPen.points.length > 1) { state.objects.push(state.currentPen); purSaveItemMarkerHistory(itemId); }
        state.isDrawingPen = false; state.currentPen = null;
        if (state.isDragging) { state.isDragging = false; purSaveItemMarkerHistory(itemId); }
        if (state.pendingNewObject && state.touchStartPos) {
          var dx = pos.x - state.touchStartPos.x, dy = pos.y - state.touchStartPos.y;
          var distance = Math.sqrt(dx * dx + dy * dy), duration = Date.now() - (state.touchStartTime || 0);
          if (distance <= 10 && duration <= 500) {
            if (state.tool === 'circle') {
              var mn = purGetNextItemMarkerNumber(itemId);
              state.objects.push({ type: 'circle', x: state.touchStartPos.x, y: state.touchStartPos.y, radius: 15, color: state.color, number: mn });
              state.selectedObject = state.objects.length - 1; purSaveItemMarkerHistory(itemId); purShowItemObjectControls(itemId);
              purAppendItemMarkerNumberToNotes(itemId, mn);
            } else if (state.tool === 'text') {
              var text = prompt('テキストを入力してください:');
              if (text) { state.objects.push({ type: 'text', x: state.touchStartPos.x, y: state.touchStartPos.y, text: text, fontSize: 14, color: state.color }); state.selectedObject = state.objects.length - 1; purSaveItemMarkerHistory(itemId); purShowItemObjectControls(itemId); }
            }
          }
        }
        state.pendingNewObject = false; state.touchStartPos = null; state.touchStartTime = null;
        purRenderDamageMarker(itemId);
      };
      canvas.onmousedown = handleStart; canvas.onmousemove = handleMove; canvas.onmouseup = handleEnd; canvas.onmouseleave = handleEnd;
      canvas.ontouchstart = handleStart; canvas.ontouchmove = handleMove; canvas.ontouchend = handleEnd;
    }
    function purHitTestObjects(state, pos) {
      for (var i = state.objects.length - 1; i >= 0; i--) {
        var obj = state.objects[i];
        if (obj.type === 'circle') { var d = Math.sqrt(Math.pow(pos.x - obj.x, 2) + Math.pow(pos.y - obj.y, 2)); if (d <= obj.radius + 10) return i; }
        else if (obj.type === 'text') { state.ctx.font = obj.fontSize + 'px sans-serif'; var m = state.ctx.measureText(obj.text); if (pos.x >= obj.x - 5 && pos.x <= obj.x + m.width + 5 && pos.y >= obj.y - obj.fontSize - 5 && pos.y <= obj.y + 5) return i; }
        else if (obj.type === 'pen' && obj.points) { for (var j = 0; j < obj.points.length; j++) { var d2 = Math.sqrt(Math.pow(pos.x - obj.points[j].x, 2) + Math.pow(pos.y - obj.points[j].y, 2)); if (d2 <= 10) return i; } }
      }
      return -1;
    }
    function purShowItemObjectControls(itemId) { var c = document.getElementById('pur-damage-marker-object-controls-' + itemId); if (c) c.style.display = 'flex'; }
    function purHideItemObjectControls(itemId) { var c = document.getElementById('pur-damage-marker-object-controls-' + itemId); if (c) c.style.display = 'none'; }
    function purSaveItemMarkerHistory(itemId) {
      var state = purGetCurrentItemState(itemId); if (!state) return;
      state.history = state.history.slice(0, state.historyIndex + 1);
      state.history.push(JSON.parse(JSON.stringify(state.objects)));
      state.historyIndex = state.history.length - 1;
      if (state.history.length > 20) { state.history.shift(); state.historyIndex--; }
    }
    function purSetDamageMarkerTool(itemId, tool) {
      var state = purGetCurrentItemState(itemId); if (!state) return;
      state.tool = tool;
      if (state.selectedObject !== null) { state.selectedObject = null; purHideItemObjectControls(itemId); purRenderDamageMarker(itemId); }
      document.querySelectorAll('#pur-damage-marker-tools-' + itemId + ' .damage-marker-tool').forEach(function(btn) { btn.classList.toggle('active', btn.getAttribute('data-tool') === tool); });
    }
    function purSetDamageMarkerColor(itemId, color) {
      var state = purGetCurrentItemState(itemId); if (!state) return;
      state.color = color;
      if (state.selectedObject !== null) { state.objects[state.selectedObject].color = color; purSaveItemMarkerHistory(itemId); purRenderDamageMarker(itemId); }
      document.querySelectorAll('#pur-damage-marker-tools-' + itemId + ' .damage-marker-color').forEach(function(btn) {
        var bc = btn.classList.contains('red') ? '#ef4444' : btn.classList.contains('blue') ? '#3b82f6' : '#1f2937';
        btn.classList.toggle('active', bc === color);
      });
    }
    function purClearDamageMarker(itemId) {
      var state = purGetCurrentItemState(itemId); if (!state) return;
      if (!confirm('描いた内容をすべて消去しますか？')) return;
      state.objects = []; state.selectedObject = null; purHideItemObjectControls(itemId); purSaveItemMarkerHistory(itemId); purRenderDamageMarker(itemId);
    }
    function purUndoDamageMarker(itemId) {
      var state = purGetCurrentItemState(itemId); if (!state || state.historyIndex <= 0) return;
      state.historyIndex--; state.objects = JSON.parse(JSON.stringify(state.history[state.historyIndex]));
      state.selectedObject = null; purHideItemObjectControls(itemId); purRenderDamageMarker(itemId);
    }
    function purRedoDamageMarker(itemId) {
      var state = purGetCurrentItemState(itemId); if (!state || state.historyIndex >= state.history.length - 1) return;
      state.historyIndex++; state.objects = JSON.parse(JSON.stringify(state.history[state.historyIndex]));
      state.selectedObject = null; purHideItemObjectControls(itemId); purRenderDamageMarker(itemId);
    }
    function purEnlargeSelectedObject(itemId) {
      var state = purGetCurrentItemState(itemId); if (!state || state.selectedObject === null) return;
      var obj = state.objects[state.selectedObject];
      if (obj.type === 'circle') obj.radius = Math.min(100, obj.radius + 5);
      else if (obj.type === 'text') obj.fontSize = Math.min(48, obj.fontSize + 2);
      purSaveItemMarkerHistory(itemId); purRenderDamageMarker(itemId);
    }
    function purShrinkSelectedObject(itemId) {
      var state = purGetCurrentItemState(itemId); if (!state || state.selectedObject === null) return;
      var obj = state.objects[state.selectedObject];
      if (obj.type === 'circle') obj.radius = Math.max(5, obj.radius - 5);
      else if (obj.type === 'text') obj.fontSize = Math.max(8, obj.fontSize - 2);
      purSaveItemMarkerHistory(itemId); purRenderDamageMarker(itemId);
    }
    function purDeleteSelectedObject(itemId) {
      var state = purGetCurrentItemState(itemId); if (!state || state.selectedObject === null) return;
      state.objects.splice(state.selectedObject, 1); state.selectedObject = null;
      purHideItemObjectControls(itemId); purSaveItemMarkerHistory(itemId); purRenderDamageMarker(itemId);
    }
    function purSaveDamageMarker(itemId) {
      var state = purGetCurrentItemState(itemId); if (!state) return;
      state.selectedObject = null; purHideItemObjectControls(itemId); purRenderDamageMarker(itemId);
      var dataUrl = state.canvas.toDataURL('image/png');
      var item = _pur_entryItems.find(function(i) { return i.id === itemId; });
      var itemState = _pur_damageMarkerState.get(itemId);
      if (item && itemState) {
        var side = itemState.currentSide;
        var note = (document.getElementById('pur-damage-marker-note-text-' + itemId) || {}).value || '';
        if (!item.damageMarkerFront) item.damageMarkerFront = null;
        if (!item.damageMarkerBack) item.damageMarkerBack = null;
        var markerData = { image: dataUrl, subcategory: itemState.currentSubcategory || '', fineCategory: itemState.currentFineCategory || '', objects: JSON.parse(JSON.stringify(state.objects)), note: note };
        if (side === 'front') item.damageMarkerFront = markerData; else item.damageMarkerBack = markerData;
        var badgeId = side === 'front' ? 'pur-front-saved-badge-' + itemId : 'pur-back-saved-badge-' + itemId;
        var badge = document.getElementById(badgeId); if (badge) badge.style.display = 'inline';
        itemState.savedFront = item.damageMarkerFront; itemState.savedBack = item.damageMarkerBack;
      }
      var previewContainer = document.getElementById('pur-damage-marker-preview-' + itemId);
      var previewImg = document.getElementById('pur-damage-marker-preview-img-' + itemId);
      if (previewImg) previewImg.src = dataUrl;
      if (previewContainer) previewContainer.style.display = 'block';
      alert('マーキングを保存しました');
    }

    // ============================================
    // Algolia brand suggest (batch + individual)
    // ============================================
    var _pur_ALGOLIA_APP_ID = 'P68RUXXTYN';
    var _pur_ALGOLIA_SEARCH_KEY = '12758e11bbd889f72177b459d296ed50';
    var _pur_ALGOLIA_INDEX_NAME = 'brands';

    function purLoadAlgoliaBrandModules() {
      import('https://reborn-inventory-system.pages.dev/js/firestore-api.js').then(function(module) {
        window.searchBrands = module.searchBrands || (module.default && module.default.searchBrands);
        window.incrementBrandUsageCount = module.incrementBrandUsageCount || (module.default && module.default.incrementBrandUsageCount);
        window.preloadBrandsInBackground = module.preloadBrandsInBackground || (module.default && module.default.preloadBrandsInBackground);
        window.searchBrandsFromCache = module.searchBrandsFromCache || (module.default && module.default.searchBrandsFromCache);
        return import('https://reborn-inventory-system.pages.dev/js/brand-suggest-algolia.js?v=98-minchars2');
      }).then(function() {
        window.algoliaBrandModulesLoaded = true;
        console.log('[Pur] Algoliaブランド検索モジュール読み込み完了');
        purAttachBatchBrandSuggest();
      }).catch(function(error) {
        console.error('[Pur] Algoliaモジュール読み込みエラー:', error);
      });
    }

    function purAttachBatchBrandSuggest() {
      var input = document.getElementById('pur-batchBrand');
      var panel = document.getElementById('pur-suggest-batch-brand');
      if (!input || !panel) return;
      if (typeof window.algoliasearch === 'undefined') { console.warn('[Pur] Algolia SDKがまだロードされていません'); return; }
      var searchClient;
      try { searchClient = window.algoliasearch(_pur_ALGOLIA_APP_ID, _pur_ALGOLIA_SEARCH_KEY); }
      catch(error) { console.error('[Pur] Algoliaクライアント初期化エラー:', error); return; }
      var index = searchClient.initIndex(_pur_ALGOLIA_INDEX_NAME);
      var debounceTimer = null;
      input.addEventListener('input', function(e) {
        var query = e.target.value.trim();
        if (query.length < 1) { panel.hidden = true; panel.style.display = 'none'; return; }
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(function() {
          var convertedQuery = purHiraganaToKatakana(query);
          index.search(convertedQuery, { hitsPerPage: 15, attributesToRetrieve: ['id', 'name', 'nameKana', 'usageCount'] }).then(function(result) {
            var hits = result.hits;
            if (hits.length === 0) { panel.hidden = true; panel.style.display = 'none'; return; }
            var inputRect = input.getBoundingClientRect();
            if (inputRect.top > window.innerHeight * 0.5) panel.classList.add('suggest-above');
            else panel.classList.remove('suggest-above');
            panel.innerHTML = '';
            hits.forEach(function(hit) {
              var div = document.createElement('div'); div.className = 'sug-item brand-item';
              div.innerHTML = '<div class="brand-english">' + purEscapeHtml(hit.name || '') + '</div><div class="brand-kana">' + purEscapeHtml(hit.nameKana || '') + '</div>';
              div.addEventListener('mousedown', function(ev) { ev.preventDefault(); });
              div.addEventListener('click', function() {
                input.value = hit.name || hit.nameKana || '';
                var kanaEl = document.getElementById('pur-batchBrandKana'); if (kanaEl) kanaEl.value = hit.nameKana || '';
                panel.hidden = true; panel.style.display = 'none'; input.blur();
              });
              panel.appendChild(div);
            });
            panel.hidden = false; panel.style.display = 'block';
          }).catch(function(error) { console.error('[Pur] Algolia検索エラー:', error); });
        }, 150);
      });
      input.addEventListener('blur', function() { setTimeout(function() { panel.hidden = true; panel.style.display = 'none'; }, 200); });
      console.log('[Pur] 一括入力ブランドサジェスト初期化完了');
    }

    function purAttachEntryBrandSuggest(itemId) {
      var input = document.getElementById('pur-entry-brand-' + itemId);
      var panel = document.getElementById('pur-suggest-brand-' + itemId);
      if (!input || !panel) return;
      if (typeof window.algoliasearch === 'undefined') { console.warn('[Pur] Algolia SDKがまだロードされていません'); return; }
      var searchClient;
      try { searchClient = window.algoliasearch(_pur_ALGOLIA_APP_ID, _pur_ALGOLIA_SEARCH_KEY); }
      catch(error) { console.error('[Pur] Algoliaクライアント初期化エラー:', error); return; }
      var index = searchClient.initIndex(_pur_ALGOLIA_INDEX_NAME);
      var debounceTimer = null;
      input.addEventListener('input', function(e) {
        var query = e.target.value.trim();
        if (query.length < 1) { panel.hidden = true; panel.style.display = 'none'; return; }
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(function() {
          var convertedQuery = purHiraganaToKatakana(query);
          index.search(convertedQuery, { hitsPerPage: 15, attributesToRetrieve: ['id', 'name', 'nameKana', 'usageCount'] }).then(function(result) {
            var hits = result.hits;
            if (hits.length === 0) { panel.hidden = true; panel.style.display = 'none'; return; }
            var inputRect = input.getBoundingClientRect();
            if (inputRect.top > window.innerHeight * 0.5) panel.classList.add('suggest-above');
            else panel.classList.remove('suggest-above');
            panel.innerHTML = '';
            hits.forEach(function(brand) {
              var div = document.createElement('div'); div.className = 'sug-item brand-item';
              div.innerHTML = '<div class="brand-english">' + purEscapeHtml(brand.name || '') + '</div><div class="brand-kana">' + purEscapeHtml(brand.nameKana || '') + '</div>';
              div.addEventListener('mousedown', function(ev) { ev.preventDefault(); });
              div.addEventListener('click', function() {
                input.value = brand.name || brand.nameKana || '';
                var kanaInput = document.getElementById('pur-entry-brandKana-' + itemId);
                if (kanaInput) kanaInput.value = brand.nameKana || '';
                panel.hidden = true; panel.style.display = 'none'; input.blur();
              });
              panel.appendChild(div);
            });
            panel.hidden = false; panel.style.display = 'block';
          }).catch(function(error) { console.error('[Pur] ブランド検索エラー:', error); });
        }, 300);
      });
      input.addEventListener('blur', function() { setTimeout(function() { panel.hidden = true; panel.style.display = 'none'; }, 200); });
      console.log('[Pur] ブランドサジェストアタッチ完了: ' + itemId);
    }

    // ============================================
    // SPA Lifecycle
    // ============================================
    function initPurchasePage() {
      console.log('[Pur SPA] initPurchasePage called');

      var loadPromises = [];

      // Load QRCode.js if not already loaded
      if (!window.QRCode) {
        loadPromises.push(_purLoadScript('https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js'));
      }
      // Load html5-qrcode if not already loaded
      if (typeof Html5Qrcode === 'undefined') {
        loadPromises.push(_purLoadScript('https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js'));
      }
      // Load Algolia SDK
      if (!window.algoliasearch) {
        loadPromises.push(_purLoadScript('https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js'));
      }
      // Load html2canvas
      if (typeof html2canvas === 'undefined') {
        loadPromises.push(_purLoadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js'));
      }
      // Load jsPDF
      if (!window.jspdf) {
        loadPromises.push(_purLoadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'));
      }

      // Set up dropdown close handler
      _pur_dropdownClickHandler = function(event) {
        var dropdown = document.getElementById('pur-settingsDropdown');
        if (dropdown && !event.target.closest('.pur-settings-dropdown') && !event.target.closest('.pur-sub-header-icon')) {
          dropdown.classList.remove('active');
        }
      };
      document.addEventListener('click', _pur_dropdownClickHandler);

      // Wait for scripts to load, then initialize
      Promise.all(loadPromises).then(function() {
        console.log('[Pur SPA] External scripts loaded');

        // Set default dates
        var purchaseMonthEl = document.getElementById('pur-purchaseMonth');
        if (purchaseMonthEl) purchaseMonthEl.value = purGetJSTMonth();
        var paymentDateEl = document.getElementById('pur-paymentDate');
        if (paymentDateEl) paymentDateEl.value = purGetJSTToday();
        var purchaseDateEl = document.getElementById('pur-entryPurchaseDate');
        if (purchaseDateEl) purchaseDateEl.value = purGetJSTToday();
        var defPurchaseDateEl = document.getElementById('pur-defaultPurchaseDate');
        if (defPurchaseDateEl) defPurchaseDateEl.value = purGetJSTToday();

        // Initialize entry tab
        purInitializeEntryTab();

        // Load supplier filter
        purGetSuppliers().then(function(suppliers) {
          var select = document.getElementById('pur-supplierFilter');
          if (select) {
            suppliers.forEach(function(s) {
              var opt = document.createElement('option');
              opt.value = s; opt.textContent = s;
              select.appendChild(opt);
            });
          }
        });

        // Load Algolia brand modules
        purLoadAlgoliaBrandModules();

        // Load label settings
        purLoadEntryLabelSettings();
        purLoadSimpleSettings();

      }).catch(function(err) {
        console.error('[Pur SPA] Script loading error:', err);
        purInitializeEntryTab();
      });
    }

    function destroyPurchasePage() {
      console.log('[Pur SPA] destroyPurchasePage called');

      // CRITICAL: Stop QR scanner if running
      if (_pur_html5QrCode) {
        try { _pur_html5QrCode.stop().catch(function() {}); } catch(e) {}
        _pur_html5QrCode = null;
      }

      // Close scanner modal
      var scanModal = document.getElementById('pur-qrCheckScannerModal');
      if (scanModal) scanModal.style.display = 'none';

      // Remove dropdown click handler
      if (_pur_dropdownClickHandler) {
        document.removeEventListener('click', _pur_dropdownClickHandler);
        _pur_dropdownClickHandler = null;
      }

      // Close any open modals
      document.querySelectorAll('#spa-page-purchase .pur-modal-overlay').forEach(function(m) {
        m.classList.remove('active');
      });

      // Clear draft timer
      if (_pur_saveDraftTimer) {
        clearTimeout(_pur_saveDraftTimer);
        _pur_saveDraftTimer = null;
      }

      // Reset state
      _pur_currentPurchaseData = [];
      _pur_selectedProductForPayment = null;
      _pur_entrySuppliersData = [];
      _pur_entryAssigneesData = [];
      _pur_entryItems = [];
      _pur_entryCategoryRows = [];
      _pur_entryMasterOptions = {};
      _pur_entryGeneratedQRData = [];
      _pur_dispatchProgressData = [];
      _pur_inspectionRequestsData = [];
      _pur_damageMarkerState = new Map();
      _pur_batchDamageMarkerState = { front: null, back: null, currentSide: 'front', currentSubcategory: null, currentFineCategory: null };
      _pur_batchDamageMarkerSaved = { front: null, back: null };
      _pur_qrCheckHistory = [];
      _pur_entryItemNextId = 1;
    }
  </script>
</div>
