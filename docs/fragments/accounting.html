<!-- SPA Fragment: accounting.html -->
<!-- Prefix: acct- -->
<div id="spa-page-accounting">
  <style>
    #spa-page-accounting {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    #spa-page-accounting .acct-content-container {
      padding: 16px;
      max-width: 1000px;
      margin: 0 auto;
    }

    /* タブ（material-tabs） */
    #spa-page-accounting .acct-material-tabs {
      display: flex;
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      position: sticky;
      top: 56px;
      z-index: 999;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    #spa-page-accounting .acct-material-tabs::-webkit-scrollbar { display: none; }
    #spa-page-accounting .acct-material-tab {
      flex: 1;
      min-width: 0;
      padding: 12px 4px;
      text-align: center;
      font-size: 13px;
      font-weight: 500;
      color: #6b7280;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    #spa-page-accounting .acct-material-tab:hover {
      color: #374151;
      background: #f9fafb;
    }
    #spa-page-accounting .acct-material-tab.active {
      color: #2563eb;
      border-bottom-color: #2563eb;
    }
    #spa-page-accounting .acct-material-tab i {
      display: block;
      font-size: 18px;
      margin-bottom: 4px;
    }

    /* カード */
    #spa-page-accounting .acct-card-section {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    #spa-page-accounting .acct-card-section h6 {
      color: #374151;
      font-weight: 600;
      margin-bottom: 12px;
      font-size: 1rem;
    }

    /* サマリーグリッド */
    #spa-page-accounting .acct-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    #spa-page-accounting .acct-summary-card {
      background: white;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    #spa-page-accounting .acct-summary-card.highlight {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      color: white;
    }
    #spa-page-accounting .acct-summary-card.highlight .acct-summary-label { color: rgba(255,255,255,0.8); }
    #spa-page-accounting .acct-summary-card.highlight .acct-summary-value { color: white; }
    #spa-page-accounting .acct-summary-label {
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 4px;
    }
    #spa-page-accounting .acct-summary-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1f2937;
    }
    #spa-page-accounting .acct-summary-value.positive { color: #10b981; }
    #spa-page-accounting .acct-summary-value.negative { color: #ef4444; }
    #spa-page-accounting .acct-summary-sub {
      font-size: 0.7rem;
      margin-top: 4px;
      opacity: 0.85;
    }
    #spa-page-accounting .acct-summary-card.highlight .acct-summary-sub { color: rgba(255,255,255,0.75); }

    /* テーブル */
    #spa-page-accounting .acct-data-table {
      width: 100%;
      font-size: 0.875rem;
      border-collapse: collapse;
    }
    #spa-page-accounting .acct-data-table th {
      background: #f9fafb;
      padding: 12px 8px;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
      white-space: nowrap;
      text-align: left;
    }
    #spa-page-accounting .acct-data-table td {
      padding: 12px 8px;
      border-bottom: 1px solid #f3f4f6;
      vertical-align: middle;
      white-space: nowrap;
    }
    #spa-page-accounting .acct-data-table tr:hover { background: #f9fafb; }

    /* P/L表示 */
    #spa-page-accounting .acct-pl-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #e5e7eb;
    }
    #spa-page-accounting .acct-pl-row.total {
      font-weight: 700;
      background: #f9fafb;
      padding: 12px;
      margin: 8px -16px;
      border: none;
    }
    #spa-page-accounting .acct-pl-label { color: #374151; }
    #spa-page-accounting .acct-pl-amount { font-weight: 600; }
    #spa-page-accounting .acct-pl-amount.positive { color: #10b981; }
    #spa-page-accounting .acct-pl-amount.negative { color: #ef4444; }

    /* 経費カテゴリ */
    #spa-page-accounting .acct-expense-category {
      background: #f9fafb;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
    }

    /* ローディング */
    #spa-page-accounting .acct-loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    /* サブヘッダー */
    #spa-page-accounting .acct-sub-header {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 56px;
      padding: 0 16px;
      background: #ffffff;
      border-bottom: 1px solid #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    #spa-page-accounting .acct-sub-header-back {
      position: absolute;
      left: 16px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 20px;
      transition: background 0.2s;
    }
    #spa-page-accounting .acct-sub-header-back:hover { background: #f2f2f2; }
    #spa-page-accounting .acct-sub-header-back:active { background: #e5e5e5; }
    #spa-page-accounting .acct-sub-header-title {
      font-weight: 600;
      font-size: 16px;
      color: #1f2937;
    }
    #spa-page-accounting .acct-sub-header-icons {
      position: absolute;
      right: 16px;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    #spa-page-accounting .acct-sub-header-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 20px;
      transition: background 0.2s;
      position: relative;
    }
    #spa-page-accounting .acct-sub-header-icon:hover { background: #f2f2f2; }
    #spa-page-accounting .acct-announce-dot {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      display: none;
    }

    /* タブコンテンツ */
    #spa-page-accounting .acct-tab-pane { display: none; }
    #spa-page-accounting .acct-tab-pane.active { display: block; }

    /* フォームスタイル（UI_DESIGN_STANDARDS準拠） */
    #spa-page-accounting select,
    #spa-page-accounting input[type="date"],
    #spa-page-accounting input[type="number"],
    #spa-page-accounting input[type="text"] {
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 16px;
      font-family: inherit;
      box-sizing: border-box;
      background: white;
      color: #374151;
      transition: all 0.2s;
    }
    #spa-page-accounting select:focus,
    #spa-page-accounting input[type="date"]:focus,
    #spa-page-accounting input[type="number"]:focus,
    #spa-page-accounting input[type="text"]:focus {
      outline: none;
      border-color: #3b82f6;
      background: #f9fafb;
    }

    /* 経費入力フォーム */
    #spa-page-accounting .acct-expense-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #spa-page-accounting .acct-expense-row {
      display: flex;
      gap: 8px;
    }
    #spa-page-accounting .acct-expense-row input:first-child { flex: 1; min-width: 0; }
    #spa-page-accounting .acct-expense-row input:last-child { flex: 2; min-width: 0; }

    #spa-page-accounting .acct-btn-success {
      background: #10b981;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
    }
    #spa-page-accounting .acct-btn-success:hover { background: #059669; }

    #spa-page-accounting .acct-btn-outline-success {
      background: white;
      color: #10b981;
      border: 1px solid #10b981;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
    }
    #spa-page-accounting .acct-btn-outline-success:hover { background: #ecfdf5; }

    #spa-page-accounting .acct-btn-outline-danger {
      background: white;
      color: #ef4444;
      border: 1px solid #ef4444;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    #spa-page-accounting .acct-btn-outline-primary {
      background: white;
      color: #3b82f6;
      border: 1px solid #3b82f6;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
    }
    #spa-page-accounting .acct-btn-outline-primary:hover { background: #eff6ff; }

    #spa-page-accounting .acct-alert-info {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 8px;
      padding: 12px;
      font-size: 13px;
      color: #1e40af;
      margin-bottom: 12px;
    }

    #spa-page-accounting .acct-alert-warning {
      background: #fffbeb;
      border: 1px solid #fde68a;
      border-radius: 8px;
      padding: 12px;
      font-size: 13px;
      color: #92400e;
      margin-bottom: 12px;
    }

    /* チェックリスト */
    #spa-page-accounting .acct-check-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 14px;
    }
    #spa-page-accounting .acct-check-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    /* 税額シミュレーション */
    #spa-page-accounting .acct-tax-toggle-group {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
    }
    #spa-page-accounting .acct-tax-toggle {
      flex: 1;
      padding: 8px 4px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: white;
      font-size: 13px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
      color: #374151;
    }
    #spa-page-accounting .acct-tax-toggle.active {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }
    #spa-page-accounting .acct-tax-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f3f4f6;
      font-size: 14px;
    }
    #spa-page-accounting .acct-tax-row.acct-tax-total {
      font-weight: 700;
      font-size: 16px;
      border-top: 2px solid #e5e7eb;
      border-bottom: none;
      padding-top: 12px;
      margin-top: 4px;
    }
    #spa-page-accounting .acct-tax-row .acct-tax-label { color: #374151; }
    #spa-page-accounting .acct-tax-row .acct-tax-amount { font-weight: 600; color: #1f2937; }

    /* ユーティリティ */
    #spa-page-accounting .text-end { text-align: right; }
    #spa-page-accounting .text-center { text-align: center; }
    #spa-page-accounting .text-muted { color: #6b7280; }
    #spa-page-accounting .text-success { color: #10b981; }
    #spa-page-accounting .text-danger { color: #ef4444; }
    #spa-page-accounting .fw-bold { font-weight: 700; }
    #spa-page-accounting .py-4 { padding-top: 1.5rem; padding-bottom: 1.5rem; }
    #spa-page-accounting .small { font-size: 0.875rem; }
    #spa-page-accounting .mb-0 { margin-bottom: 0; }
    #spa-page-accounting .w-100 { width: 100%; }
    #spa-page-accounting .table-responsive { overflow-x: auto; }

    #spa-page-accounting .acct-row { display: flex; flex-wrap: wrap; gap: 8px; }
    #spa-page-accounting .acct-col { flex: 1; min-width: 120px; }
    #spa-page-accounting .acct-d-flex { display: flex; }
    #spa-page-accounting .acct-justify-between { justify-content: space-between; }

    /* レスポンシブ */
    @media (max-width: 576px) {
      #spa-page-accounting .acct-summary-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>

  <!-- ローディング -->
  <div class="acct-loading-overlay" id="acct-loadingOverlay">
    <div style="text-align: center;">
      <div style="width:32px;height:32px;border:4px solid #e5e7eb;border-top-color:#10b981;border-radius:50%;animation:acctSpin 1s linear infinite;margin:0 auto;"></div>
      <p style="margin-top:8px;color:#6b7280;">データを読み込んでいます...</p>
    </div>
  </div>
  <style>
    @keyframes acctSpin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>

  <!-- サブヘッダー -->
  <div class="acct-sub-header">
    <button class="acct-sub-header-back" onclick="acctGoBack()" title="戻る">
      <i class="bi bi-chevron-left"></i>
    </button>
    <span class="acct-sub-header-title">確定申告</span>
    <div class="acct-sub-header-icons">
      <button class="acct-sub-header-icon" title="通知" onclick="acctOpenAnnouncePage()">
        <i class="bi bi-bell"></i>
        <span class="acct-announce-dot" id="acct-announceDot"></span>
      </button>
      <button class="acct-sub-header-icon" title="メニュー" onclick="if(typeof toggleDrawer==='function')toggleDrawer()">
        <i class="bi bi-list"></i>
      </button>
    </div>
  </div>

  <!-- タブ（sticky・サブヘッダー直下） -->
  <div class="acct-material-tabs">
    <button class="acct-material-tab active" data-tab="overview" onclick="acctSwitchTab('overview')">
      <i class="bi bi-bar-chart-line"></i> 概要
    </button>
    <button class="acct-material-tab" data-tab="expense" onclick="acctSwitchTab('expense')">
      <i class="bi bi-credit-card"></i> 経費
    </button>
    <button class="acct-material-tab" data-tab="export" onclick="acctSwitchTab('export')">
      <i class="bi bi-download"></i> 帳簿出力
    </button>
    <button class="acct-material-tab" data-tab="taxreturn" onclick="acctSwitchTab('taxreturn')">
      <i class="bi bi-file-earmark-ruled"></i> 確定申告
    </button>
  </div>

  <div class="acct-content-container">
    <!-- 年度選択 -->
    <div class="acct-card-section" style="padding:12px 16px;">
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
        <label style="font-size:13px;font-weight:600;color:#374151;white-space:nowrap;">対象年度:</label>
        <select id="acct-fiscalYear" onchange="acctLoadAccountingData()" style="padding:4px 8px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;"></select>
        <span class="text-muted" style="font-size:12px;margin-left:auto;" id="acct-periodDisplay"></span>
      </div>
    </div>

    <!-- localStorage移行バナー -->
    <div class="acct-alert-warning" id="acct-migrationBanner" style="display:none;">
      <i class="bi bi-exclamation-triangle"></i>
      <strong>データ移行のお知らせ:</strong> ローカルに保存された経費データがあります。Firestoreに移行すると他デバイスでも利用できます。
      <div style="margin-top:8px;">
        <button class="acct-btn-success" onclick="acctMigrateFromLocalStorage()" style="font-size:12px;padding:6px 12px;">移行する</button>
        <button style="background:none;border:none;color:#6b7280;font-size:12px;cursor:pointer;margin-left:8px;" onclick="document.getElementById('acct-migrationBanner').style.display='none'">後で</button>
      </div>
    </div>

    <!-- タブコンテンツ -->
    <!-- 概要タブ -->
    <div class="acct-tab-pane active" id="acct-tab-overview">
      <div class="acct-summary-grid">
        <div class="acct-summary-card highlight">
          <div class="acct-summary-label">売上高</div>
          <div class="acct-summary-value" id="acct-kpi-sales">-</div>
          <div class="acct-summary-sub" id="acct-kpi-sales-sub"></div>
        </div>
        <div class="acct-summary-card">
          <div class="acct-summary-label">仕入高</div>
          <div class="acct-summary-value" id="acct-kpi-cost">-</div>
        </div>
        <div class="acct-summary-card">
          <div class="acct-summary-label">経費</div>
          <div class="acct-summary-value" id="acct-kpi-expense">-</div>
        </div>
        <div class="acct-summary-card highlight">
          <div class="acct-summary-label">所得</div>
          <div class="acct-summary-value" id="acct-kpi-income">-</div>
          <div class="acct-summary-sub" id="acct-kpi-income-sub"></div>
        </div>
      </div>

      <!-- 簡易損益計算 -->
      <div class="acct-card-section">
        <h6><i class="bi bi-calculator"></i> 損益計算</h6>
        <div id="acct-plContent">
          <div class="acct-pl-row">
            <span class="acct-pl-label">売上高</span>
            <span class="acct-pl-amount" id="acct-pl-sales">-</span>
          </div>
          <div class="acct-pl-row">
            <span class="acct-pl-label">&#x25B3; 売上原価（仕入高）</span>
            <span class="acct-pl-amount" id="acct-pl-cost">-</span>
          </div>
          <div class="acct-pl-row total">
            <span class="acct-pl-label">＝ 売上総利益（粗利）</span>
            <span class="acct-pl-amount positive" id="acct-pl-gross">-</span>
          </div>
          <div class="acct-pl-row">
            <span class="acct-pl-label">&#x25B3; 経費合計</span>
            <span class="acct-pl-amount" id="acct-pl-expense">-</span>
          </div>
          <div class="acct-pl-row total">
            <span class="acct-pl-label">＝ 事業所得</span>
            <span class="acct-pl-amount" id="acct-pl-income">-</span>
          </div>
        </div>
      </div>

      <!-- 税額シミュレーション -->
      <div class="acct-card-section">
        <h6><i class="bi bi-cash-stack"></i> 簡易税額シミュレーション</h6>
        <div style="font-size:13px;color:#6b7280;margin-bottom:12px;">青色申告特別控除額を選択してください</div>
        <div class="acct-tax-toggle-group">
          <button class="acct-tax-toggle active" data-deduction="650000" onclick="acctSelectDeduction(this)">65万円</button>
          <button class="acct-tax-toggle" data-deduction="100000" onclick="acctSelectDeduction(this)">10万円</button>
          <button class="acct-tax-toggle" data-deduction="0" onclick="acctSelectDeduction(this)">なし</button>
        </div>
        <div id="acct-taxSimContent">
          <div class="acct-tax-row">
            <span class="acct-tax-label">事業所得</span>
            <span class="acct-tax-amount" id="acct-tax-income">-</span>
          </div>
          <div class="acct-tax-row">
            <span class="acct-tax-label">青色申告特別控除</span>
            <span class="acct-tax-amount" id="acct-tax-blue">-</span>
          </div>
          <div class="acct-tax-row">
            <span class="acct-tax-label">基礎控除</span>
            <span class="acct-tax-amount" id="acct-tax-basic">-</span>
          </div>
          <div class="acct-tax-row" style="font-weight:600;">
            <span class="acct-tax-label">課税所得</span>
            <span class="acct-tax-amount" id="acct-tax-taxable">-</span>
          </div>
          <div style="border-top:1px solid #e5e7eb;margin:8px 0;"></div>
          <div class="acct-tax-row">
            <span class="acct-tax-label">所得税</span>
            <span class="acct-tax-amount" id="acct-tax-income-tax">-</span>
          </div>
          <div class="acct-tax-row">
            <span class="acct-tax-label">住民税（10%）</span>
            <span class="acct-tax-amount" id="acct-tax-resident">-</span>
          </div>
          <div class="acct-tax-row">
            <span class="acct-tax-label">個人事業税（5%）</span>
            <span class="acct-tax-amount" id="acct-tax-business">-</span>
          </div>
          <div class="acct-tax-row acct-tax-total">
            <span class="acct-tax-label">合計納税見込額</span>
            <span class="acct-tax-amount text-danger" id="acct-tax-total">-</span>
          </div>
        </div>
        <div class="acct-alert-info" style="margin-top:12px;margin-bottom:0;">
          <i class="bi bi-info-circle"></i> この金額は概算です。実際の納税額は各種控除・扶養状況等により異なります。
        </div>
      </div>

      <!-- 月別売上 -->
      <div class="acct-card-section">
        <h6><i class="bi bi-graph-up"></i> 月別売上</h6>
        <div class="table-responsive">
          <table class="acct-data-table">
            <thead>
              <tr>
                <th>月</th>
                <th class="text-end">売上</th>
                <th class="text-end">仕入</th>
                <th class="text-end">粗利</th>
              </tr>
            </thead>
            <tbody id="acct-monthlyBody">
              <tr><td colspan="4" class="text-center text-muted py-4">データを読み込んでいます...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 経費タブ -->
    <div class="acct-tab-pane" id="acct-tab-expense">
      <div class="acct-card-section">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <h6 style="margin-bottom:0;"><i class="bi bi-plus-circle"></i> 経費を追加</h6>
          <button class="acct-btn-outline-primary" onclick="acctCopyLastMonth()" style="font-size:12px;padding:6px 12px;">
            <i class="bi bi-files"></i> 先月分をコピー
          </button>
        </div>
        <div class="acct-expense-form">
          <input type="date" id="acct-expenseDate">
          <select id="acct-expenseCategory">
            <option value="">勘定科目</option>
            <option value="通信費">通信費</option>
            <option value="荷造運賃">荷造運賃（送料）</option>
            <option value="消耗品費">消耗品費</option>
            <option value="広告宣伝費">広告宣伝費</option>
            <option value="支払手数料">支払手数料</option>
            <option value="旅費交通費">旅費交通費</option>
            <option value="水道光熱費">水道光熱費</option>
            <option value="地代家賃">地代家賃</option>
            <option value="雑費">雑費</option>
          </select>
          <div class="acct-expense-row">
            <input type="number" id="acct-expenseAmount" placeholder="金額">
            <input type="text" id="acct-expenseNote" placeholder="摘要（任意）">
          </div>
          <button class="acct-btn-success w-100" onclick="acctAddExpense()">
            <i class="bi bi-plus"></i> 追加
          </button>
        </div>
      </div>

      <div class="acct-card-section">
        <h6><i class="bi bi-pie-chart"></i> 勘定科目別経費</h6>
        <div id="acct-expenseByCategoryList">
          <div class="text-center text-muted" style="padding:12px;">経費データがありません</div>
        </div>
      </div>

      <div class="acct-card-section">
        <h6><i class="bi bi-list-ul"></i> 経費明細</h6>
        <div class="table-responsive">
          <table class="acct-data-table">
            <thead>
              <tr>
                <th>日付</th>
                <th>勘定科目</th>
                <th>摘要</th>
                <th class="text-end">金額</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="acct-expenseListBody">
              <tr><td colspan="5" class="text-center text-muted py-4">経費データがありません</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 帳簿出力タブ -->
    <div class="acct-tab-pane" id="acct-tab-export">
      <!-- 1. 帳簿データ出力（既存） -->
      <div class="acct-card-section">
        <h6><i class="bi bi-file-earmark-arrow-down"></i> 帳簿データ出力</h6>
        <p class="text-muted small" style="margin-bottom:16px;">確定申告に必要な帳簿をCSV形式でダウンロードできます。</p>

        <div class="acct-row" style="margin-bottom:12px;">
          <div class="acct-col">
            <button class="acct-btn-outline-success w-100" onclick="acctDownloadLedger('sales')">
              <i class="bi bi-download"></i><br>売上帳
            </button>
          </div>
          <div class="acct-col">
            <button class="acct-btn-outline-success w-100" onclick="acctDownloadLedger('purchase')">
              <i class="bi bi-download"></i><br>仕入帳
            </button>
          </div>
          <div class="acct-col">
            <button class="acct-btn-outline-success w-100" onclick="acctDownloadLedger('expense')">
              <i class="bi bi-download"></i><br>経費帳
            </button>
          </div>
        </div>
        <button class="acct-btn-success w-100" onclick="acctDownloadLedger('all')">
          <i class="bi bi-file-earmark-zip"></i> 全帳簿一括ダウンロード
        </button>
      </div>

      <!-- 2. 仕訳帳（機能A） -->
      <div class="acct-card-section">
        <h6><i class="bi bi-journal-text"></i> 仕訳帳</h6>
        <div class="acct-alert-info">
          <i class="bi bi-info-circle"></i> 三分法に基づく複式簿記の仕訳帳を自動生成します。
        </div>
        <div id="acct-journal-summary" style="margin-bottom:12px;">
          <div class="acct-row" style="margin-bottom:4px;">
            <div class="acct-col"><div class="acct-expense-category"><div class="acct-d-flex acct-justify-between"><span>販売仕訳</span><span class="fw-bold" id="acct-journal-sales-count">0件</span></div></div></div>
            <div class="acct-col"><div class="acct-expense-category"><div class="acct-d-flex acct-justify-between"><span>仕入仕訳</span><span class="fw-bold" id="acct-journal-purchase-count">0件</span></div></div></div>
          </div>
          <div class="acct-row">
            <div class="acct-col"><div class="acct-expense-category"><div class="acct-d-flex acct-justify-between"><span>経費仕訳</span><span class="fw-bold" id="acct-journal-expense-count">0件</span></div></div></div>
            <div class="acct-col"><div class="acct-expense-category"><div class="acct-d-flex acct-justify-between"><span>棚卸仕訳</span><span class="fw-bold" id="acct-journal-inventory-count">0件</span></div></div></div>
          </div>
          <div style="margin-top:8px;font-size:13px;color:#6b7280;">
            合計: <span id="acct-journal-total-count" class="fw-bold">0</span>件
            ｜ 借方合計: <span id="acct-journal-debit-total" class="fw-bold">-</span>
            ｜ 貸方合計: <span id="acct-journal-credit-total" class="fw-bold">-</span>
          </div>
        </div>
        <button class="acct-btn-outline-primary w-100" onclick="acctDownloadJournal()">
          <i class="bi bi-download"></i> 仕訳帳CSVダウンロード
        </button>
      </div>

    </div>

    <!-- 確定申告タブ -->
    <div class="acct-tab-pane" id="acct-tab-taxreturn">
      <!-- 青色申告決算書 -->
      <div class="acct-card-section">
        <h6><i class="bi bi-file-earmark-ruled"></i> 青色申告決算書</h6>

        <!-- 損益計算書 -->
        <div style="font-size:13px;font-weight:600;color:#2563eb;margin-bottom:8px;"><i class="bi bi-1-circle"></i> 損益計算書</div>

        <div class="acct-pl-row">
          <span class="acct-pl-label">売上（収入）金額</span>
          <span class="acct-pl-amount" id="acct-br-sales">-</span>
        </div>

        <div style="padding:8px 0;font-size:13px;font-weight:600;color:#374151;border-bottom:1px solid #e5e7eb;">【売上原価】</div>
        <div class="acct-pl-row" style="padding-left:16px;">
          <span class="acct-pl-label">期首商品棚卸高</span>
          <span class="acct-pl-amount">
            <input type="number" id="acct-br-opening-inventory" placeholder="0" style="width:100px;padding:4px 8px;font-size:14px;text-align:right;border:1px solid #d1d5db;border-radius:4px;" onchange="acctSaveOpeningInventory();acctUpdateBlueReturnSection()">
          </span>
        </div>
        <div class="acct-pl-row" style="padding-left:16px;">
          <span class="acct-pl-label">仕入金額</span>
          <span class="acct-pl-amount" id="acct-br-purchase">-</span>
        </div>
        <div class="acct-pl-row" style="padding-left:16px;">
          <span class="acct-pl-label">期末商品棚卸高</span>
          <span class="acct-pl-amount" id="acct-br-closing-inventory">-</span>
        </div>
        <div class="acct-pl-row total">
          <span class="acct-pl-label">差引原価</span>
          <span class="acct-pl-amount" id="acct-br-cogs">-</span>
        </div>
        <div class="acct-pl-row total" style="background:#ecfdf5;">
          <span class="acct-pl-label">差引金額（粗利）</span>
          <span class="acct-pl-amount" id="acct-br-gross-profit">-</span>
        </div>

        <div style="padding:8px 0;font-size:13px;font-weight:600;color:#374151;border-bottom:1px solid #e5e7eb;margin-top:8px;">【経費内訳】</div>
        <div id="acct-br-expense-breakdown"></div>
        <div class="acct-pl-row total">
          <span class="acct-pl-label">経費合計</span>
          <span class="acct-pl-amount" id="acct-br-total-expense">-</span>
        </div>

        <div class="acct-pl-row total" style="background:#eff6ff;margin-top:8px;">
          <span class="acct-pl-label" style="font-size:16px;">所得金額</span>
          <span class="acct-pl-amount" id="acct-br-income" style="font-size:16px;color:#2563eb;">-</span>
        </div>

        <!-- 月別売上・仕入 -->
        <div style="font-size:13px;font-weight:600;color:#2563eb;margin:16px 0 8px;"><i class="bi bi-2-circle"></i> 月別売上・仕入</div>
        <div class="table-responsive">
          <table class="acct-data-table" id="acct-br-monthly-table">
            <thead>
              <tr><th>月</th><th class="text-end">売上</th><th class="text-end">仕入</th></tr>
            </thead>
            <tbody id="acct-br-monthly-tbody"></tbody>
            <tfoot>
              <tr style="font-weight:700;border-top:2px solid #e5e7eb;">
                <td>合計</td>
                <td class="text-end" id="acct-br-monthly-sales-total">-</td>
                <td class="text-end" id="acct-br-monthly-purchase-total">-</td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- CSV出力ボタン群 -->
        <div class="acct-row" style="margin-top:12px;">
          <div class="acct-col">
            <button class="acct-btn-outline-primary w-100" onclick="acctDownloadBlueReturn('pl')" style="font-size:13px;">
              <i class="bi bi-download"></i><br>損益計算書
            </button>
          </div>
          <div class="acct-col">
            <button class="acct-btn-outline-primary w-100" onclick="acctDownloadBlueReturn('monthly')" style="font-size:13px;">
              <i class="bi bi-download"></i><br>月別データ
            </button>
          </div>
          <div class="acct-col">
            <button class="acct-btn-outline-primary w-100" onclick="acctDownloadBlueReturn('all')" style="font-size:13px;">
              <i class="bi bi-download"></i><br>一括
            </button>
          </div>
        </div>
      </div>

      <!-- e-Tax連携用データ -->
      <div class="acct-card-section">
        <h6><i class="bi bi-bank"></i> e-Tax転記用データ</h6>
        <div class="acct-alert-info">
          <i class="bi bi-info-circle"></i> e-Taxの入力フォームに転記するための参照データです。各項目にe-Tax上の欄番号（ア〜ノ等）を併記しています。
        </div>
        <div id="acct-etax-preview" style="margin-bottom:12px;"></div>
        <div class="acct-row">
          <div class="acct-col">
            <button class="acct-btn-outline-primary w-100" onclick="acctDownloadEtax('pl')" style="font-size:13px;">
              <i class="bi bi-download"></i><br>損益計算書
            </button>
          </div>
          <div class="acct-col">
            <button class="acct-btn-outline-primary w-100" onclick="acctDownloadEtax('monthly')" style="font-size:13px;">
              <i class="bi bi-download"></i><br>月別
            </button>
          </div>
          <div class="acct-col">
            <button class="acct-btn-outline-primary w-100" onclick="acctDownloadEtax('all')" style="font-size:13px;">
              <i class="bi bi-download"></i><br>一括
            </button>
          </div>
        </div>
      </div>

      <!-- チェックリスト -->
      <div class="acct-card-section">
        <h6><i class="bi bi-check2-square"></i> 確定申告チェックリスト</h6>
        <div class="acct-check-item">
          <input type="checkbox" id="acct-check1">
          <label for="acct-check1">売上帳の記帳完了</label>
        </div>
        <div class="acct-check-item">
          <input type="checkbox" id="acct-check2">
          <label for="acct-check2">仕入帳の記帳完了</label>
        </div>
        <div class="acct-check-item">
          <input type="checkbox" id="acct-check3">
          <label for="acct-check3">経費の入力完了</label>
        </div>
        <div class="acct-check-item">
          <input type="checkbox" id="acct-check4">
          <label for="acct-check4">領収書・請求書の整理完了</label>
        </div>
        <div class="acct-check-item">
          <input type="checkbox" id="acct-check5">
          <label for="acct-check5">仕訳帳の確認・ダウンロード</label>
        </div>
        <div class="acct-check-item">
          <input type="checkbox" id="acct-check6">
          <label for="acct-check6">青色申告決算書の確認</label>
        </div>
        <div class="acct-check-item">
          <input type="checkbox" id="acct-check7">
          <label for="acct-check7">e-Taxデータの転記完了</label>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // Accounting Page SPA Fragment
    // ============================================

    var _acctCurrentProducts = [];
    var _acctCurrentExpenses = [];
    var _acctCurrentYear = new Date().getFullYear();
    var _acctCurrentIncome = 0;
    var _acctSelectedDeduction = 650000;

    function acctGetJSTToday() {
      var now = new Date();
      var jst = new Date(now.getTime() + (9 * 60 + now.getTimezoneOffset()) * 60000);
      var year = jst.getFullYear();
      var month = String(jst.getMonth() + 1).padStart(2, '0');
      var day = String(jst.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }

    function acctShowLoading() { var el = document.getElementById('acct-loadingOverlay'); if (el) el.style.display = 'flex'; }
    function acctHideLoading() { var el = document.getElementById('acct-loadingOverlay'); if (el) el.style.display = 'none'; }

    function acctFormatCurrency(amount) {
      if (amount === null || amount === undefined || isNaN(amount)) return '-';
      return '\u00A5' + Math.round(amount).toLocaleString();
    }

    // タブ切り替え（material-tabs パターン）
    function acctSwitchTab(tabName) {
      var root = document.getElementById('spa-page-accounting');
      if (!root) return;
      root.querySelectorAll('.acct-material-tab').forEach(function(tab) {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });
      root.querySelectorAll('.acct-tab-pane').forEach(function(content) {
        content.classList.toggle('active', content.id === 'acct-tab-' + tabName);
      });
    }

    // 戻るボタン
    function acctGoBack() {
      if (typeof navigateToPage === 'function') {
        navigateToPage('home');
      } else if (typeof spaGoBack === 'function') {
        spaGoBack();
      }
    }

    // 通知ページを開く
    function acctOpenAnnouncePage() {
      if (typeof navigateToPage === 'function') {
        navigateToPage('announce');
      }
    }

    // ============================================
    // 機能1: Firestore経費データ管理
    // ============================================

    // Firebase: 商品データ取得
    async function acctGetProducts() {
      var db = window.firebaseDB;
      var productsRef = window.firestoreCollection(db, 'products');
      var snapshot = await window.firestoreGetDocs(productsRef);
      var products = [];
      snapshot.forEach(function(docSnap) {
        products.push({ id: docSnap.id, ...docSnap.data() });
      });
      return products;
    }

    // 経費データ取得（Firestoreから）
    async function acctGetExpenses(fiscalYear) {
      var db = window.firebaseDB;
      var expensesRef = window.firestoreCollection(db, 'expenses');
      var q = window.firestoreQuery(
        expensesRef,
        window.firestoreWhere('fiscalYear', '==', fiscalYear)
      );
      var snapshot = await window.firestoreGetDocs(q);
      var expenses = [];
      snapshot.forEach(function(docSnap) {
        expenses.push({ id: docSnap.id, ...docSnap.data() });
      });
      return expenses;
    }

    // 経費追加（Firestoreへ）
    async function acctAddExpenseToFirestore(expenseData) {
      var db = window.firebaseDB;
      var expensesRef = window.firestoreCollection(db, 'expenses');
      var year = parseInt((expenseData.date || '').slice(0, 4)) || _acctCurrentYear;
      var docData = {
        date: expenseData.date,
        category: expenseData.category,
        amount: expenseData.amount,
        note: expenseData.note || '',
        fiscalYear: year,
        createdBy: localStorage.getItem('reborn_user_name') || '',
        createdAt: window.firestoreServerTimestamp()
      };
      var docRef = await window.firestoreAddDoc(expensesRef, docData);
      return { id: docRef.id, ...docData };
    }

    // 経費削除（Firestoreから）
    async function acctDeleteExpenseFromFirestore(expenseId) {
      var db = window.firebaseDB;
      var docRef = window.firestoreDoc(db, 'expenses', expenseId);
      await window.firestoreDeleteDoc(docRef);
    }

    // localStorageからの移行チェック
    function acctCheckLocalStorageMigration() {
      try {
        var localData = JSON.parse(localStorage.getItem('reborn_expenses') || '[]');
        if (localData.length > 0) {
          var banner = document.getElementById('acct-migrationBanner');
          if (banner) banner.style.display = 'block';
        }
      } catch (e) { /* ignore */ }
    }

    // localStorageからFirestoreへの移行
    async function acctMigrateFromLocalStorage() {
      try {
        var localData = JSON.parse(localStorage.getItem('reborn_expenses') || '[]');
        if (localData.length === 0) {
          alert('移行するデータがありません');
          return;
        }
        if (!confirm(localData.length + '件の経費データをFirestoreに移行します。よろしいですか？')) return;

        acctShowLoading();
        var migrated = 0;
        for (var i = 0; i < localData.length; i++) {
          var e = localData[i];
          await acctAddExpenseToFirestore({
            date: e.date,
            category: e.category,
            amount: parseFloat(e.amount) || 0,
            note: e.note || ''
          });
          migrated++;
        }
        localStorage.removeItem('reborn_expenses');
        var banner = document.getElementById('acct-migrationBanner');
        if (banner) banner.style.display = 'none';

        await acctLoadAccountingData();
        alert(migrated + '件のデータを移行しました');
      } catch (error) {
        console.error('移行エラー:', error);
        alert('移行中にエラーが発生しました');
      } finally {
        acctHideLoading();
      }
    }

    // ============================================
    // 機能4: 先月経費コピー
    // ============================================

    async function acctCopyLastMonth() {
      var today = acctGetJSTToday();
      var todayDate = new Date(today);
      var lastMonth = new Date(todayDate.getFullYear(), todayDate.getMonth() - 1, 1);
      var lastMonthYear = lastMonth.getFullYear();
      var lastMonthNum = lastMonth.getMonth() + 1;
      var lastMonthStr = String(lastMonthNum).padStart(2, '0');
      var lastMonthPrefix = lastMonthYear + '-' + lastMonthStr;

      var thisMonthNum = todayDate.getMonth() + 1;
      var thisMonthStr = String(thisMonthNum).padStart(2, '0');
      var thisYear = todayDate.getFullYear();

      // 前月の経費を取得
      var lastMonthExpenses = _acctCurrentExpenses.filter(function(e) {
        return (e.date || '').startsWith(lastMonthPrefix);
      });

      if (lastMonthExpenses.length === 0) {
        // 現在の年度に前月データがない場合、前年度からも探す
        if (lastMonthYear !== _acctCurrentYear) {
          try {
            var prevYearExpenses = await acctGetExpenses(lastMonthYear);
            lastMonthExpenses = prevYearExpenses.filter(function(e) {
              return (e.date || '').startsWith(lastMonthPrefix);
            });
          } catch (err) {
            console.error('前月データ取得エラー:', err);
          }
        }
        if (lastMonthExpenses.length === 0) {
          alert(lastMonthYear + '年' + lastMonthNum + '月の経費データがありません');
          return;
        }
      }

      var totalAmount = lastMonthExpenses.reduce(function(sum, e) { return sum + (parseFloat(e.amount) || 0); }, 0);
      if (!confirm(lastMonthYear + '年' + lastMonthNum + '月の経費 ' + lastMonthExpenses.length + '件（合計' + acctFormatCurrency(totalAmount) + '）を今月分としてコピーしますか？')) return;

      acctShowLoading();
      try {
        var copied = 0;
        for (var i = 0; i < lastMonthExpenses.length; i++) {
          var e = lastMonthExpenses[i];
          var origDay = (e.date || '').slice(8, 10);
          var lastDayOfMonth = new Date(thisYear, thisMonthNum, 0).getDate();
          var day = Math.min(parseInt(origDay) || 1, lastDayOfMonth);
          var newDate = thisYear + '-' + thisMonthStr + '-' + String(day).padStart(2, '0');

          await acctAddExpenseToFirestore({
            date: newDate,
            category: e.category,
            amount: parseFloat(e.amount) || 0,
            note: e.note || ''
          });
          copied++;
        }
        await acctLoadAccountingData();
        alert(copied + '件の経費をコピーしました');
      } catch (error) {
        console.error('コピーエラー:', error);
        alert('コピー中にエラーが発生しました');
      } finally {
        acctHideLoading();
      }
    }

    // ============================================
    // ページ初期化・データ読み込み
    // ============================================

    function acctInitializePage() {
      var yearSelect = document.getElementById('acct-fiscalYear');
      if (!yearSelect) return;
      var thisYear = new Date().getFullYear();
      yearSelect.innerHTML = '';
      for (var y = thisYear; y >= thisYear - 5; y--) {
        var option = document.createElement('option');
        option.value = y;
        option.textContent = y + '\u5E74';
        yearSelect.appendChild(option);
      }

      var expenseDate = document.getElementById('acct-expenseDate');
      if (expenseDate) expenseDate.value = acctGetJSTToday();

      acctCheckLocalStorageMigration();
      acctLoadAccountingData();
    }

    async function acctLoadAccountingData() {
      acctShowLoading();
      try {
        _acctCurrentYear = parseInt(document.getElementById('acct-fiscalYear').value);
        var startDate = _acctCurrentYear + '-01-01';
        var endDate = _acctCurrentYear + '-12-31';

        var display = document.getElementById('acct-periodDisplay');
        if (display) display.textContent = startDate + ' \u301C ' + endDate;

        _acctCurrentProducts = await acctGetProducts();
        _acctCurrentExpenses = await acctGetExpenses(_acctCurrentYear);

        acctUpdateOverview(startDate, endDate);
        acctUpdateTaxSimulation();
        acctUpdateExpenseTab();
        acctUpdateExportTab(startDate, endDate);

      } catch (error) {
        console.error('データ読み込みエラー:', error);
        alert('データの読み込みに失敗しました');
      } finally {
        acctHideLoading();
      }
    }

    // ============================================
    // 機能2: 概要タブ（KPI + 前年比 + 粗利率）
    // ============================================

    function acctCalcSalesForYear(products, year) {
      var start = year + '-01-01';
      var end = year + '-12-31';
      var sold = products.filter(function(p) {
        var sd = p.saleDate || '';
        return p.status === '\u8CA9\u58F2\u6E08' && sd >= start && sd <= end;
      });
      var sales = sold.reduce(function(sum, p) { return sum + (parseFloat(p.saleAmount) || 0); }, 0);
      var cost = sold.reduce(function(sum, p) { return sum + (parseFloat((p.purchase && p.purchase.amount) || p.purchaseAmount) || 0); }, 0);
      return { sales: sales, cost: cost };
    }

    function acctUpdateOverview(startDate, endDate) {
      var soldProducts = _acctCurrentProducts.filter(function(p) {
        var saleDate = p.saleDate || '';
        return p.status === '\u8CA9\u58F2\u6E08' && saleDate >= startDate && saleDate <= endDate;
      });

      var totalSales = soldProducts.reduce(function(sum, p) { return sum + (parseFloat(p.saleAmount) || 0); }, 0);
      var totalCost = soldProducts.reduce(function(sum, p) { return sum + (parseFloat((p.purchase && p.purchase.amount) || p.purchaseAmount) || 0); }, 0);
      var grossProfit = totalSales - totalCost;
      var totalExpense = _acctCurrentExpenses.reduce(function(sum, e) { return sum + (parseFloat(e.amount) || 0); }, 0);
      var income = grossProfit - totalExpense;

      _acctCurrentIncome = income;

      var el;
      el = document.getElementById('acct-kpi-sales'); if (el) el.textContent = acctFormatCurrency(totalSales);
      el = document.getElementById('acct-kpi-cost'); if (el) el.textContent = acctFormatCurrency(totalCost);
      el = document.getElementById('acct-kpi-expense'); if (el) el.textContent = acctFormatCurrency(totalExpense);
      el = document.getElementById('acct-kpi-income'); if (el) el.textContent = acctFormatCurrency(income);

      // 前年比（売上高カード）
      var prevYear = acctCalcSalesForYear(_acctCurrentProducts, _acctCurrentYear - 1);
      var salesSub = document.getElementById('acct-kpi-sales-sub');
      if (salesSub) {
        if (prevYear.sales > 0) {
          var changePercent = ((totalSales - prevYear.sales) / prevYear.sales * 100).toFixed(1);
          var sign = changePercent >= 0 ? '+' : '';
          salesSub.textContent = '\u524D\u5E74: ' + acctFormatCurrency(prevYear.sales) + '(' + sign + changePercent + '%)';
        } else {
          salesSub.textContent = '';
        }
      }

      // 粗利率（所得カード）
      var incomeSub = document.getElementById('acct-kpi-income-sub');
      if (incomeSub) {
        if (totalSales > 0) {
          var grossMargin = (grossProfit / totalSales * 100).toFixed(1);
          incomeSub.textContent = '\u7C97\u5229\u7387: ' + grossMargin + '%';
        } else {
          incomeSub.textContent = '';
        }
      }

      el = document.getElementById('acct-pl-sales'); if (el) el.textContent = acctFormatCurrency(totalSales);
      el = document.getElementById('acct-pl-cost'); if (el) el.textContent = acctFormatCurrency(totalCost);
      el = document.getElementById('acct-pl-gross'); if (el) el.textContent = acctFormatCurrency(grossProfit);
      el = document.getElementById('acct-pl-expense'); if (el) el.textContent = acctFormatCurrency(totalExpense);
      el = document.getElementById('acct-pl-income');
      if (el) {
        el.textContent = acctFormatCurrency(income);
        el.className = 'acct-pl-amount ' + (income >= 0 ? 'positive' : 'negative');
      }

      // 月別
      var monthlyData = {};
      soldProducts.forEach(function(p) {
        var month = (p.saleDate || '').slice(0, 7);
        if (!month) return;
        if (!monthlyData[month]) monthlyData[month] = { sales: 0, cost: 0 };
        monthlyData[month].sales += parseFloat(p.saleAmount) || 0;
        monthlyData[month].cost += parseFloat((p.purchase && p.purchase.amount) || p.purchaseAmount) || 0;
      });

      var tbody = document.getElementById('acct-monthlyBody');
      if (!tbody) return;
      if (Object.keys(monthlyData).length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">該当期間のデータがありません</td></tr>';
      } else {
        var html = '';
        var totals = { sales: 0, cost: 0 };
        Object.keys(monthlyData).sort().forEach(function(month) {
          var m = monthlyData[month];
          var gross = m.sales - m.cost;
          totals.sales += m.sales;
          totals.cost += m.cost;
          html += '<tr><td>' + month.replace('-', '\u5E74') + '\u6708</td><td class="text-end">' + acctFormatCurrency(m.sales) + '</td><td class="text-end">' + acctFormatCurrency(m.cost) + '</td><td class="text-end ' + (gross >= 0 ? 'text-success' : 'text-danger') + '">' + acctFormatCurrency(gross) + '</td></tr>';
        });
        html += '<tr style="background:#e5e7eb;font-weight:700;"><td>\u5408\u8A08</td><td class="text-end">' + acctFormatCurrency(totals.sales) + '</td><td class="text-end">' + acctFormatCurrency(totals.cost) + '</td><td class="text-end ' + ((totals.sales - totals.cost) >= 0 ? 'text-success' : 'text-danger') + '">' + acctFormatCurrency(totals.sales - totals.cost) + '</td></tr>';
        tbody.innerHTML = html;
      }
    }

    // ============================================
    // 機能3: 簡易税額シミュレーション
    // ============================================

    function acctSelectDeduction(btn) {
      var root = document.getElementById('spa-page-accounting');
      if (!root) return;
      root.querySelectorAll('.acct-tax-toggle').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      _acctSelectedDeduction = parseInt(btn.dataset.deduction) || 0;
      acctUpdateTaxSimulation();
    }

    // 所得税の累進課税計算
    function acctCalcIncomeTax(taxableIncome) {
      if (taxableIncome <= 0) return 0;
      // 令和6年以降の所得税率
      var brackets = [
        { limit: 1950000, rate: 0.05, deduction: 0 },
        { limit: 3300000, rate: 0.10, deduction: 97500 },
        { limit: 6950000, rate: 0.20, deduction: 427500 },
        { limit: 9000000, rate: 0.23, deduction: 636000 },
        { limit: 18000000, rate: 0.33, deduction: 1536000 },
        { limit: 40000000, rate: 0.40, deduction: 2796000 },
        { limit: Infinity, rate: 0.45, deduction: 4796000 }
      ];
      for (var i = 0; i < brackets.length; i++) {
        if (taxableIncome <= brackets[i].limit) {
          return Math.floor(taxableIncome * brackets[i].rate - brackets[i].deduction);
        }
      }
      return 0;
    }

    function acctUpdateTaxSimulation() {
      var income = _acctCurrentIncome;
      var blueDeduction = _acctSelectedDeduction;
      var basicDeduction = 480000;

      // 青色申告控除は所得を超えない
      var effectiveBlue = Math.min(blueDeduction, Math.max(income, 0));
      var afterBlue = Math.max(income - effectiveBlue, 0);
      var taxableIncome = Math.max(afterBlue - basicDeduction, 0);

      var incomeTax = acctCalcIncomeTax(taxableIncome);
      var residentTax = Math.floor(taxableIncome * 0.10);
      // 個人事業税: (所得 - 290万) × 5%、青色申告控除は事業税では適用されない
      var businessTaxBase = Math.max(income - 2900000, 0);
      var businessTax = Math.floor(businessTaxBase * 0.05);
      var totalTax = incomeTax + residentTax + businessTax;

      var el;
      el = document.getElementById('acct-tax-income'); if (el) el.textContent = acctFormatCurrency(income);
      el = document.getElementById('acct-tax-blue'); if (el) el.textContent = '-' + acctFormatCurrency(effectiveBlue);
      el = document.getElementById('acct-tax-basic'); if (el) el.textContent = '-' + acctFormatCurrency(basicDeduction);
      el = document.getElementById('acct-tax-taxable'); if (el) el.textContent = acctFormatCurrency(taxableIncome);
      el = document.getElementById('acct-tax-income-tax'); if (el) el.textContent = acctFormatCurrency(incomeTax);
      el = document.getElementById('acct-tax-resident'); if (el) el.textContent = acctFormatCurrency(residentTax);
      el = document.getElementById('acct-tax-business'); if (el) el.textContent = businessTaxBase > 0 ? acctFormatCurrency(businessTax) : '\u00A50（290万以下）';
      el = document.getElementById('acct-tax-total'); if (el) el.textContent = acctFormatCurrency(totalTax);
    }

    // ============================================
    // 経費タブ
    // ============================================

    function acctUpdateExpenseTab() {
      var totalExpense = _acctCurrentExpenses.reduce(function(sum, e) { return sum + (parseFloat(e.amount) || 0); }, 0);

      var byCategory = {};
      _acctCurrentExpenses.forEach(function(e) {
        var cat = e.category || '\u96D1\u8CBB';
        if (!byCategory[cat]) byCategory[cat] = 0;
        byCategory[cat] += parseFloat(e.amount) || 0;
      });

      var categoryList = document.getElementById('acct-expenseByCategoryList');
      if (categoryList) {
        if (Object.keys(byCategory).length === 0) {
          categoryList.innerHTML = '<div class="text-center text-muted" style="padding:12px;">経費データがありません</div>';
        } else {
          var html = '';
          Object.keys(byCategory).sort(function(a, b) { return byCategory[b] - byCategory[a]; }).forEach(function(cat) {
            var percent = totalExpense > 0 ? (byCategory[cat] / totalExpense * 100).toFixed(1) : 0;
            html += '<div class="acct-expense-category"><div class="acct-d-flex acct-justify-between"><span>' + cat + '</span><span class="fw-bold">' + acctFormatCurrency(byCategory[cat]) + ' <small class="text-muted">(' + percent + '%)</small></span></div></div>';
          });
          categoryList.innerHTML = html;
        }
      }

      var tbody = document.getElementById('acct-expenseListBody');
      if (tbody) {
        if (_acctCurrentExpenses.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">経費データがありません</td></tr>';
        } else {
          var html = '';
          _acctCurrentExpenses.sort(function(a, b) { return (b.date || '').localeCompare(a.date || ''); }).forEach(function(e) {
            html += '<tr><td>' + (e.date || '-') + '</td><td>' + (e.category || '-') + '</td><td>' + (e.note || '-') + '</td><td class="text-end">' + acctFormatCurrency(e.amount) + '</td><td><button class="acct-btn-outline-danger" onclick="acctDeleteExpense(\'' + e.id + '\')"><i class="bi bi-trash"></i></button></td></tr>';
          });
          tbody.innerHTML = html;
        }
      }
    }

    function acctUpdateExportTab(startDate, endDate) {
      acctUpdateJournalPreview(startDate, endDate);
      acctLoadOpeningInventory();
      acctUpdateBlueReturnSection();
      acctUpdateEtaxPreview();
    }

    // ============================================
    // 機能A: 仕訳帳
    // ============================================

    function acctGetPurchaseDate(p) {
      return (p.purchase && p.purchase.date) || p.purchaseDate || '';
    }
    function acctGetPurchaseAmount(p) {
      return parseFloat((p.purchase && p.purchase.amount) || p.purchaseAmount) || 0;
    }

    function acctGenerateJournalEntries(startDate, endDate) {
      var entries = [];

      // 販売仕訳: 借方=売掛金, 貸方=売上
      var sold = _acctCurrentProducts.filter(function(p) {
        var sd = p.saleDate || '';
        return p.status === '\u8CA9\u58F2\u6E08' && sd >= startDate && sd <= endDate;
      });
      sold.forEach(function(p) {
        var amt = parseFloat(p.saleAmount) || 0;
        entries.push({
          date: p.saleDate || '',
          debitAccount: '\u58F2\u639B\u91D1',
          debitAmount: amt,
          creditAccount: '\u58F2\u4E0A',
          creditAmount: amt,
          summary: (p.managementNumber || '') + ' ' + (p.salePlatform || ''),
          type: 'sales'
        });
      });

      // 仕入仕訳: 借方=仕入高, 貸方=現金
      var purchased = _acctCurrentProducts.filter(function(p) {
        var d = acctGetPurchaseDate(p);
        return d >= startDate && d <= endDate;
      });
      purchased.forEach(function(p) {
        var amt = acctGetPurchaseAmount(p);
        entries.push({
          date: acctGetPurchaseDate(p),
          debitAccount: '\u4ED5\u5165\u9AD8',
          debitAmount: amt,
          creditAccount: '\u73FE\u91D1',
          creditAmount: amt,
          summary: (p.managementNumber || '') + ' ' + (p.supplier || ''),
          type: 'purchase'
        });
      });

      // 経費仕訳: 借方=勘定科目, 貸方=現金
      _acctCurrentExpenses.forEach(function(e) {
        var amt = parseFloat(e.amount) || 0;
        entries.push({
          date: e.date || '',
          debitAccount: e.category || '\u96D1\u8CBB',
          debitAmount: amt,
          creditAccount: '\u73FE\u91D1',
          creditAmount: amt,
          summary: e.note || '',
          type: 'expense'
        });
      });

      // 棚卸仕訳
      var openingInv = acctGetOpeningInventoryValue();
      var closingInv = acctCalcClosingInventory();

      if (openingInv > 0) {
        entries.push({
          date: startDate,
          debitAccount: '\u4ED5\u5165\u9AD8',
          debitAmount: openingInv,
          creditAccount: '\u7E70\u8D8A\u5546\u54C1',
          creditAmount: openingInv,
          summary: '\u671F\u9996\u68DA\u5378\u9AD8',
          type: 'inventory'
        });
      }
      if (closingInv > 0) {
        entries.push({
          date: endDate,
          debitAccount: '\u7E70\u8D8A\u5546\u54C1',
          debitAmount: closingInv,
          creditAccount: '\u4ED5\u5165\u9AD8',
          creditAmount: closingInv,
          summary: '\u671F\u672B\u68DA\u5378\u9AD8',
          type: 'inventory'
        });
      }

      // 日付順ソート
      entries.sort(function(a, b) { return a.date.localeCompare(b.date); });
      return entries;
    }

    function acctUpdateJournalPreview(startDate, endDate) {
      var entries = acctGenerateJournalEntries(startDate, endDate);
      var salesCount = entries.filter(function(e) { return e.type === 'sales'; }).length;
      var purchaseCount = entries.filter(function(e) { return e.type === 'purchase'; }).length;
      var expenseCount = entries.filter(function(e) { return e.type === 'expense'; }).length;
      var inventoryCount = entries.filter(function(e) { return e.type === 'inventory'; }).length;

      var debitTotal = entries.reduce(function(sum, e) { return sum + e.debitAmount; }, 0);
      var creditTotal = entries.reduce(function(sum, e) { return sum + e.creditAmount; }, 0);

      var el;
      el = document.getElementById('acct-journal-sales-count'); if (el) el.textContent = salesCount + '\u4EF6';
      el = document.getElementById('acct-journal-purchase-count'); if (el) el.textContent = purchaseCount + '\u4EF6';
      el = document.getElementById('acct-journal-expense-count'); if (el) el.textContent = expenseCount + '\u4EF6';
      el = document.getElementById('acct-journal-inventory-count'); if (el) el.textContent = inventoryCount + '\u4EF6';
      el = document.getElementById('acct-journal-total-count'); if (el) el.textContent = entries.length;
      el = document.getElementById('acct-journal-debit-total'); if (el) el.textContent = acctFormatCurrency(debitTotal);
      el = document.getElementById('acct-journal-credit-total'); if (el) el.textContent = acctFormatCurrency(creditTotal);
    }

    function acctDownloadJournal() {
      var startDate = _acctCurrentYear + '-01-01';
      var endDate = _acctCurrentYear + '-12-31';
      var entries = acctGenerateJournalEntries(startDate, endDate);
      if (entries.length === 0) { alert('\u4ED5\u8A33\u30C7\u30FC\u30BF\u304C\u3042\u308A\u307E\u305B\u3093'); return; }

      var csv = '\u4ED5\u8A33\u5E33\uFF08' + _acctCurrentYear + '\u5E74\uFF09\n\n';
      csv += '\u65E5\u4ED8,\u501F\u65B9\u79D1\u76EE,\u501F\u65B9\u91D1\u984D,\u8CB8\u65B9\u79D1\u76EE,\u8CB8\u65B9\u91D1\u984D,\u6458\u8981\n';
      entries.forEach(function(e) {
        csv += [e.date, e.debitAccount, e.debitAmount, e.creditAccount, e.creditAmount, '"' + (e.summary || '').replace(/"/g, '""') + '"'].join(',') + '\n';
      });

      var debitTotal = entries.reduce(function(s, e) { return s + e.debitAmount; }, 0);
      var creditTotal = entries.reduce(function(s, e) { return s + e.creditAmount; }, 0);
      csv += '\n\u5408\u8A08,,' + debitTotal + ',,' + creditTotal + ',\n';

      acctDownloadCSV(csv, '\u4ED5\u8A33\u5E33_' + _acctCurrentYear + '\u5E74.csv');
    }

    // ============================================
    // 機能B: 青色申告決算書
    // ============================================

    function acctGetOpeningInventoryValue() {
      var key = 'reborn_opening_inventory_' + _acctCurrentYear;
      return parseFloat(localStorage.getItem(key)) || 0;
    }

    function acctSaveOpeningInventory() {
      var input = document.getElementById('acct-br-opening-inventory');
      if (!input) return;
      var key = 'reborn_opening_inventory_' + _acctCurrentYear;
      var val = parseFloat(input.value) || 0;
      localStorage.setItem(key, val);
    }

    function acctLoadOpeningInventory() {
      var input = document.getElementById('acct-br-opening-inventory');
      if (!input) return;
      var val = acctGetOpeningInventoryValue();
      input.value = val > 0 ? val : '';
    }

    function acctCalcClosingInventory() {
      // 期末棚卸高 = 未販売品の仕入額合計
      return _acctCurrentProducts.filter(function(p) {
        return p.status !== '\u8CA9\u58F2\u6E08';
      }).reduce(function(sum, p) {
        return sum + acctGetPurchaseAmount(p);
      }, 0);
    }

    function acctUpdateBlueReturnSection() {
      var startDate = _acctCurrentYear + '-01-01';
      var endDate = _acctCurrentYear + '-12-31';

      // 売上
      var sold = _acctCurrentProducts.filter(function(p) {
        var sd = p.saleDate || '';
        return p.status === '\u8CA9\u58F2\u6E08' && sd >= startDate && sd <= endDate;
      });
      var totalSales = sold.reduce(function(sum, p) { return sum + (parseFloat(p.saleAmount) || 0); }, 0);

      // 仕入
      var purchased = _acctCurrentProducts.filter(function(p) {
        var d = acctGetPurchaseDate(p);
        return d >= startDate && d <= endDate;
      });
      var totalPurchase = purchased.reduce(function(sum, p) { return sum + acctGetPurchaseAmount(p); }, 0);

      // 棚卸
      var openingInv = acctGetOpeningInventoryValue();
      var closingInv = acctCalcClosingInventory();

      // 売上原価 = 期首 + 仕入 - 期末
      var cogs = openingInv + totalPurchase - closingInv;
      var grossProfit = totalSales - cogs;

      // 経費内訳（勘定科目ごと集計）
      var expenseByCategory = {};
      var totalExpense = 0;
      _acctCurrentExpenses.forEach(function(e) {
        var cat = e.category || '\u96D1\u8CBB';
        var amt = parseFloat(e.amount) || 0;
        expenseByCategory[cat] = (expenseByCategory[cat] || 0) + amt;
        totalExpense += amt;
      });

      var income = grossProfit - totalExpense;

      // DOM更新
      var el;
      el = document.getElementById('acct-br-sales'); if (el) el.textContent = acctFormatCurrency(totalSales);
      el = document.getElementById('acct-br-purchase'); if (el) el.textContent = acctFormatCurrency(totalPurchase);
      el = document.getElementById('acct-br-closing-inventory'); if (el) el.textContent = acctFormatCurrency(closingInv);
      el = document.getElementById('acct-br-cogs'); if (el) el.textContent = acctFormatCurrency(cogs);
      el = document.getElementById('acct-br-gross-profit'); if (el) {
        el.textContent = acctFormatCurrency(grossProfit);
        el.className = 'acct-pl-amount ' + (grossProfit >= 0 ? 'positive' : 'negative');
      }

      // 経費内訳
      var breakdownEl = document.getElementById('acct-br-expense-breakdown');
      if (breakdownEl) {
        var cats = Object.keys(expenseByCategory).sort();
        var html = '';
        cats.forEach(function(cat) {
          html += '<div class="acct-pl-row" style="padding-left:16px;"><span class="acct-pl-label">' + cat + '</span><span class="acct-pl-amount">' + acctFormatCurrency(expenseByCategory[cat]) + '</span></div>';
        });
        if (cats.length === 0) {
          html = '<div style="padding:8px 16px;font-size:13px;color:#9ca3af;">経費データなし</div>';
        }
        breakdownEl.innerHTML = html;
      }

      el = document.getElementById('acct-br-total-expense'); if (el) el.textContent = acctFormatCurrency(totalExpense);
      el = document.getElementById('acct-br-income'); if (el) {
        el.textContent = acctFormatCurrency(income);
        el.className = 'acct-pl-amount ' + (income >= 0 ? '' : 'negative');
        el.style.fontSize = '16px';
        el.style.color = income >= 0 ? '#2563eb' : '#ef4444';
      }

      // 月別売上・仕入
      acctUpdateMonthlyTable(startDate, endDate, totalSales, totalPurchase);
    }

    function acctUpdateMonthlyTable(startDate, endDate, annualSales, annualPurchase) {
      var tbody = document.getElementById('acct-br-monthly-tbody');
      if (!tbody) return;

      var monthlySales = {};
      var monthlyPurchase = {};
      for (var m = 1; m <= 12; m++) {
        monthlySales[m] = 0;
        monthlyPurchase[m] = 0;
      }

      _acctCurrentProducts.forEach(function(p) {
        // 売上
        if (p.status === '\u8CA9\u58F2\u6E08') {
          var sd = p.saleDate || '';
          if (sd >= startDate && sd <= endDate) {
            var sMonth = parseInt(sd.substring(5, 7));
            monthlySales[sMonth] += parseFloat(p.saleAmount) || 0;
          }
        }
        // 仕入
        var pd = acctGetPurchaseDate(p);
        if (pd >= startDate && pd <= endDate) {
          var pMonth = parseInt(pd.substring(5, 7));
          monthlyPurchase[pMonth] += acctGetPurchaseAmount(p);
        }
      });

      var html = '';
      var salesTotal = 0;
      var purchaseTotal = 0;
      for (var i = 1; i <= 12; i++) {
        salesTotal += monthlySales[i];
        purchaseTotal += monthlyPurchase[i];
        html += '<tr><td>' + i + '\u6708</td><td class="text-end">' + acctFormatCurrency(monthlySales[i]) + '</td><td class="text-end">' + acctFormatCurrency(monthlyPurchase[i]) + '</td></tr>';
      }
      tbody.innerHTML = html;

      var el;
      el = document.getElementById('acct-br-monthly-sales-total'); if (el) el.textContent = acctFormatCurrency(salesTotal);
      el = document.getElementById('acct-br-monthly-purchase-total'); if (el) el.textContent = acctFormatCurrency(purchaseTotal);
    }

    function acctDownloadBlueReturn(type) {
      var startDate = _acctCurrentYear + '-01-01';
      var endDate = _acctCurrentYear + '-12-31';
      var bom = '\uFEFF';
      var csv = '';
      var filename = '';

      if (type === 'pl' || type === 'all') {
        csv += acctGeneratePLCSV(startDate, endDate);
      }
      if (type === 'monthly' || type === 'all') {
        if (csv) csv += '\n\n';
        csv += acctGenerateMonthlyCSV(startDate, endDate);
      }

      if (type === 'pl') filename = '\u640D\u76CA\u8A08\u7B97\u66F8_' + _acctCurrentYear + '\u5E74.csv';
      else if (type === 'monthly') filename = '\u6708\u5225\u58F2\u4E0A\u4ED5\u5165_' + _acctCurrentYear + '\u5E74.csv';
      else filename = '\u9752\u8272\u7533\u544A\u6C7A\u7B97\u66F8_' + _acctCurrentYear + '\u5E74.csv';

      acctDownloadCSV(csv, filename);
    }

    function acctGeneratePLCSV(startDate, endDate) {
      var sold = _acctCurrentProducts.filter(function(p) {
        var sd = p.saleDate || '';
        return p.status === '\u8CA9\u58F2\u6E08' && sd >= startDate && sd <= endDate;
      });
      var totalSales = sold.reduce(function(s, p) { return s + (parseFloat(p.saleAmount) || 0); }, 0);
      var purchased = _acctCurrentProducts.filter(function(p) {
        var d = acctGetPurchaseDate(p);
        return d >= startDate && d <= endDate;
      });
      var totalPurchase = purchased.reduce(function(s, p) { return s + acctGetPurchaseAmount(p); }, 0);
      var openingInv = acctGetOpeningInventoryValue();
      var closingInv = acctCalcClosingInventory();
      var cogs = openingInv + totalPurchase - closingInv;
      var grossProfit = totalSales - cogs;

      var expenseByCategory = {};
      var totalExpense = 0;
      _acctCurrentExpenses.forEach(function(e) {
        var cat = e.category || '\u96D1\u8CBB';
        var amt = parseFloat(e.amount) || 0;
        expenseByCategory[cat] = (expenseByCategory[cat] || 0) + amt;
        totalExpense += amt;
      });

      var csv = '\u640D\u76CA\u8A08\u7B97\u66F8\uFF08' + _acctCurrentYear + '\u5E74\uFF09\n\n';
      csv += '\u9805\u76EE,\u91D1\u984D\n';
      csv += '\u58F2\u4E0A\uFF08\u53CE\u5165\uFF09\u91D1\u984D,' + totalSales + '\n';
      csv += '\u671F\u9996\u5546\u54C1\u68DA\u5378\u9AD8,' + openingInv + '\n';
      csv += '\u4ED5\u5165\u91D1\u984D,' + totalPurchase + '\n';
      csv += '\u671F\u672B\u5546\u54C1\u68DA\u5378\u9AD8,' + closingInv + '\n';
      csv += '\u5DEE\u5F15\u539F\u4FA1,' + cogs + '\n';
      csv += '\u5DEE\u5F15\u91D1\u984D\uFF08\u7C97\u5229\uFF09,' + grossProfit + '\n\n';
      csv += '\u7D4C\u8CBB\u5185\u8A33\n';
      csv += '\u52D8\u5B9A\u79D1\u76EE,\u91D1\u984D\n';
      Object.keys(expenseByCategory).sort().forEach(function(cat) {
        csv += '"' + cat + '",' + expenseByCategory[cat] + '\n';
      });
      csv += '\u7D4C\u8CBB\u5408\u8A08,' + totalExpense + '\n\n';
      csv += '\u6240\u5F97\u91D1\u984D,' + (grossProfit - totalExpense) + '\n';
      return csv;
    }

    function acctGenerateMonthlyCSV(startDate, endDate) {
      var monthlySales = {};
      var monthlyPurchase = {};
      for (var m = 1; m <= 12; m++) { monthlySales[m] = 0; monthlyPurchase[m] = 0; }

      _acctCurrentProducts.forEach(function(p) {
        if (p.status === '\u8CA9\u58F2\u6E08') {
          var sd = p.saleDate || '';
          if (sd >= startDate && sd <= endDate) {
            monthlySales[parseInt(sd.substring(5, 7))] += parseFloat(p.saleAmount) || 0;
          }
        }
        var pd = acctGetPurchaseDate(p);
        if (pd >= startDate && pd <= endDate) {
          monthlyPurchase[parseInt(pd.substring(5, 7))] += acctGetPurchaseAmount(p);
        }
      });

      var csv = '\u6708\u5225\u58F2\u4E0A\u30FB\u4ED5\u5165\uFF08' + _acctCurrentYear + '\u5E74\uFF09\n\n';
      csv += '\u6708,\u58F2\u4E0A,\u4ED5\u5165\n';
      var sTotal = 0, pTotal = 0;
      for (var i = 1; i <= 12; i++) {
        sTotal += monthlySales[i];
        pTotal += monthlyPurchase[i];
        csv += i + '\u6708,' + monthlySales[i] + ',' + monthlyPurchase[i] + '\n';
      }
      csv += '\u5408\u8A08,' + sTotal + ',' + pTotal + '\n';
      return csv;
    }

    // ============================================
    // 機能C: e-Tax転記用データ
    // ============================================

    // e-Tax欄番号マッピング（青色申告決算書）
    var ACCT_ETAX_EXPENSE_MAP = {
      '\u8377\u9020\u904B\u8CC3': { code: '\u30B7', label: '\u30B7\u6B04\uFF08\u8377\u9020\u904B\u8CC3\uFF09' },
      '\u901A\u4FE1\u8CBB': { code: '\u30C4', label: '\u30C4\u6B04\uFF08\u901A\u4FE1\u8CBB\uFF09' },
      '\u5E83\u544A\u5BA3\u4F1D\u8CBB': { code: '\u30C6', label: '\u30C6\u6B04\uFF08\u5E83\u544A\u5BA3\u4F1D\u8CBB\uFF09' },
      '\u6D88\u8017\u54C1\u8CBB': { code: '\u30CA', label: '\u30CA\u6B04\uFF08\u6D88\u8017\u54C1\u8CBB\uFF09' },
      '\u65C5\u8CBB\u4EA4\u901A\u8CBB': { code: '\u30BF', label: '\u30BF\u6B04\uFF08\u65C5\u8CBB\u4EA4\u901A\u8CBB\uFF09' },
      '\u63A5\u5F85\u4EA4\u969B\u8CBB': { code: '\u30C1', label: '\u30C1\u6B04\uFF08\u63A5\u5F85\u4EA4\u969B\u8CBB\uFF09' },
      '\u640D\u5BB3\u4FDD\u967A\u6599': { code: '\u30C8', label: '\u30C8\u6B04\uFF08\u640D\u5BB3\u4FDD\u967A\u6599\uFF09' },
      '\u4FEE\u7E55\u8CBB': { code: '\u30CB', label: '\u30CB\u6B04\uFF08\u4FEE\u7E55\u8CBB\uFF09' },
      '\u6C34\u9053\u5149\u71B1\u8CBB': { code: '\u30CC', label: '\u30CC\u6B04\uFF08\u6C34\u9053\u5149\u71B1\u8CBB\uFF09' },
      '\u5730\u4EE3\u5BB6\u8CC3': { code: '\u30CD', label: '\u30CD\u6B04\uFF08\u5730\u4EE3\u5BB6\u8CC3\uFF09' },
      '\u96D1\u8CBB': { code: '\u30E2', label: '\u30E2\u6B04\uFF08\u96D1\u8CBB\uFF09' },
      '\u5916\u6CE8\u5DE5\u8CC3': { code: '\u30B9', label: '\u30B9\u6B04\uFF08\u5916\u6CE8\u5DE5\u8CC3\uFF09' },
      '\u6E1B\u4FA1\u511F\u5374\u8CBB': { code: '\u30CC', label: '\u30CC\u6B04\uFF08\u6E1B\u4FA1\u511F\u5374\u8CBB\uFF09' },
      '\u798F\u5229\u539A\u751F\u8CBB': { code: '\u30BD', label: '\u30BD\u6B04\uFF08\u798F\u5229\u539A\u751F\u8CBB\uFF09' },
      '\u7D66\u6599\u8CC3\u91D1': { code: '\u30B5', label: '\u30B5\u6B04\uFF08\u7D66\u6599\u8CC3\u91D1\uFF09' },
      '\u5229\u5B50\u5272\u5F15\u6599': { code: '\u30CE', label: '\u30CE\u6B04\uFF08\u5229\u5B50\u5272\u5F15\u6599\uFF09' },
      '\u65B0\u805E\u56F3\u66F8\u8CBB': { code: '\u30C0', label: '\u30C0\u6B04\uFF08\u65B0\u805E\u56F3\u66F8\u8CBB\uFF09' }
    };

    function acctUpdateEtaxPreview() {
      var previewEl = document.getElementById('acct-etax-preview');
      if (!previewEl) return;

      var startDate = _acctCurrentYear + '-01-01';
      var endDate = _acctCurrentYear + '-12-31';

      var sold = _acctCurrentProducts.filter(function(p) {
        var sd = p.saleDate || '';
        return p.status === '\u8CA9\u58F2\u6E08' && sd >= startDate && sd <= endDate;
      });
      var totalSales = sold.reduce(function(s, p) { return s + (parseFloat(p.saleAmount) || 0); }, 0);
      var openingInv = acctGetOpeningInventoryValue();
      var purchased = _acctCurrentProducts.filter(function(p) {
        var d = acctGetPurchaseDate(p);
        return d >= startDate && d <= endDate;
      });
      var totalPurchase = purchased.reduce(function(s, p) { return s + acctGetPurchaseAmount(p); }, 0);
      var closingInv = acctCalcClosingInventory();
      var cogs = openingInv + totalPurchase - closingInv;
      var grossProfit = totalSales - cogs;

      var expenseByCategory = {};
      var totalExpense = 0;
      _acctCurrentExpenses.forEach(function(e) {
        var cat = e.category || '\u96D1\u8CBB';
        var amt = parseFloat(e.amount) || 0;
        expenseByCategory[cat] = (expenseByCategory[cat] || 0) + amt;
        totalExpense += amt;
      });
      var income = grossProfit - totalExpense;

      var html = '<div style="font-size:12px;color:#6b7280;">';
      html += '<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #f3f4f6;"><span>\u30A2\u6B04\uFF08\u58F2\u4E0A\uFF09</span><span class="fw-bold">' + acctFormatCurrency(totalSales) + '</span></div>';
      html += '<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #f3f4f6;"><span>\u30A6\u6B04\uFF08\u671F\u9996\u68DA\u5378\u9AD8\uFF09</span><span class="fw-bold">' + acctFormatCurrency(openingInv) + '</span></div>';
      html += '<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #f3f4f6;"><span>\u30A8\u6B04\uFF08\u4ED5\u5165\u91D1\u984D\uFF09</span><span class="fw-bold">' + acctFormatCurrency(totalPurchase) + '</span></div>';
      html += '<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #f3f4f6;"><span>\u30B1\u6B04\uFF08\u671F\u672B\u68DA\u5378\u9AD8\uFF09</span><span class="fw-bold">' + acctFormatCurrency(closingInv) + '</span></div>';
      html += '<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #f3f4f6;"><span>\u30B3\u6B04\uFF08\u5DEE\u5F15\u539F\u4FA1\uFF09</span><span class="fw-bold">' + acctFormatCurrency(cogs) + '</span></div>';
      html += '<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #f3f4f6;"><span>\u30B5\u6B04\uFF08\u5DEE\u5F15\u91D1\u984D\uFF09</span><span class="fw-bold">' + acctFormatCurrency(grossProfit) + '</span></div>';

      // 経費のe-Tax欄番号
      Object.keys(expenseByCategory).sort().forEach(function(cat) {
        var mapping = ACCT_ETAX_EXPENSE_MAP[cat];
        var label = mapping ? mapping.label : '\u305D\u306E\u4ED6\uFF08' + cat + '\uFF09';
        html += '<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #f3f4f6;"><span>' + label + '</span><span class="fw-bold">' + acctFormatCurrency(expenseByCategory[cat]) + '</span></div>';
      });

      html += '<div style="display:flex;justify-content:space-between;padding:4px 0;font-weight:700;border-top:2px solid #e5e7eb;margin-top:4px;"><span>\u30CE\u6B04\uFF08\u6240\u5F97\u91D1\u984D\uFF09</span><span>' + acctFormatCurrency(income) + '</span></div>';
      html += '</div>';
      previewEl.innerHTML = html;
    }

    function acctDownloadEtax(type) {
      var startDate = _acctCurrentYear + '-01-01';
      var endDate = _acctCurrentYear + '-12-31';
      var csv = '';
      var filename = '';

      if (type === 'pl' || type === 'all') {
        csv += acctGenerateEtaxPLCSV(startDate, endDate);
      }
      if (type === 'monthly' || type === 'all') {
        if (csv) csv += '\n\n';
        csv += acctGenerateEtaxMonthlyCSV(startDate, endDate);
      }

      if (type === 'pl') filename = 'e-Tax\u640D\u76CA\u8A08\u7B97\u66F8_' + _acctCurrentYear + '\u5E74.csv';
      else if (type === 'monthly') filename = 'e-Tax\u6708\u5225_' + _acctCurrentYear + '\u5E74.csv';
      else filename = 'e-Tax\u8EE2\u8A18\u7528_' + _acctCurrentYear + '\u5E74.csv';

      acctDownloadCSV(csv, filename);
    }

    function acctGenerateEtaxPLCSV(startDate, endDate) {
      var sold = _acctCurrentProducts.filter(function(p) {
        var sd = p.saleDate || '';
        return p.status === '\u8CA9\u58F2\u6E08' && sd >= startDate && sd <= endDate;
      });
      var totalSales = sold.reduce(function(s, p) { return s + (parseFloat(p.saleAmount) || 0); }, 0);
      var openingInv = acctGetOpeningInventoryValue();
      var purchased = _acctCurrentProducts.filter(function(p) {
        var d = acctGetPurchaseDate(p);
        return d >= startDate && d <= endDate;
      });
      var totalPurchase = purchased.reduce(function(s, p) { return s + acctGetPurchaseAmount(p); }, 0);
      var closingInv = acctCalcClosingInventory();
      var cogs = openingInv + totalPurchase - closingInv;
      var grossProfit = totalSales - cogs;

      var expenseByCategory = {};
      var totalExpense = 0;
      _acctCurrentExpenses.forEach(function(e) {
        var cat = e.category || '\u96D1\u8CBB';
        var amt = parseFloat(e.amount) || 0;
        expenseByCategory[cat] = (expenseByCategory[cat] || 0) + amt;
        totalExpense += amt;
      });
      var income = grossProfit - totalExpense;

      var csv = 'e-Tax\u8EE2\u8A18\u7528 \u640D\u76CA\u8A08\u7B97\u66F8\uFF08' + _acctCurrentYear + '\u5E74\uFF09\n\n';
      csv += 'e-Tax\u6B04,\u9805\u76EE,\u91D1\u984D\n';
      csv += '\u30A2,\u58F2\u4E0A\uFF08\u53CE\u5165\uFF09\u91D1\u984D,' + totalSales + '\n';
      csv += '\u30A6,\u671F\u9996\u5546\u54C1\u68DA\u5378\u9AD8,' + openingInv + '\n';
      csv += '\u30A8,\u4ED5\u5165\u91D1\u984D,' + totalPurchase + '\n';
      csv += '\u30B1,\u671F\u672B\u5546\u54C1\u68DA\u5378\u9AD8,' + closingInv + '\n';
      csv += '\u30B3,\u5DEE\u5F15\u539F\u4FA1,' + cogs + '\n';
      csv += '\u30B5,\u5DEE\u5F15\u91D1\u984D\uFF08\u7C97\u5229\uFF09,' + grossProfit + '\n\n';

      csv += 'e-Tax\u6B04,\u7D4C\u8CBB\u79D1\u76EE,\u91D1\u984D\n';
      Object.keys(expenseByCategory).sort().forEach(function(cat) {
        var mapping = ACCT_ETAX_EXPENSE_MAP[cat];
        var code = mapping ? mapping.code : '\u305D\u306E\u4ED6';
        csv += code + ',"' + cat + '",' + expenseByCategory[cat] + '\n';
      });
      csv += ',\u7D4C\u8CBB\u5408\u8A08,' + totalExpense + '\n\n';
      csv += '\u30CE,\u6240\u5F97\u91D1\u984D,' + income + '\n';
      return csv;
    }

    function acctGenerateEtaxMonthlyCSV(startDate, endDate) {
      var monthlySales = {};
      var monthlyPurchase = {};
      for (var m = 1; m <= 12; m++) { monthlySales[m] = 0; monthlyPurchase[m] = 0; }

      _acctCurrentProducts.forEach(function(p) {
        if (p.status === '\u8CA9\u58F2\u6E08') {
          var sd = p.saleDate || '';
          if (sd >= startDate && sd <= endDate) {
            monthlySales[parseInt(sd.substring(5, 7))] += parseFloat(p.saleAmount) || 0;
          }
        }
        var pd = acctGetPurchaseDate(p);
        if (pd >= startDate && pd <= endDate) {
          monthlyPurchase[parseInt(pd.substring(5, 7))] += acctGetPurchaseAmount(p);
        }
      });

      var csv = 'e-Tax\u8EE2\u8A18\u7528 \u6708\u5225\u58F2\u4E0A\u30FB\u4ED5\u5165\uFF08' + _acctCurrentYear + '\u5E74\uFF09\n\n';
      csv += '\u6708,\u58F2\u4E0A,\u4ED5\u5165\n';
      var sTotal = 0, pTotal = 0;
      for (var i = 1; i <= 12; i++) {
        sTotal += monthlySales[i];
        pTotal += monthlyPurchase[i];
        csv += i + '\u6708,' + monthlySales[i] + ',' + monthlyPurchase[i] + '\n';
      }
      csv += '\u5408\u8A08,' + sTotal + ',' + pTotal + '\n';
      return csv;
    }

    // 共通CSVダウンロードヘルパー
    function acctDownloadCSV(csvContent, filename) {
      var bom = '\uFEFF';
      var blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
      var link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      alert('\u2705 \u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u3057\u307E\u3057\u305F');
    }

    async function acctAddExpense() {
      var date = document.getElementById('acct-expenseDate').value;
      var category = document.getElementById('acct-expenseCategory').value;
      var amount = parseFloat(document.getElementById('acct-expenseAmount').value);
      var note = document.getElementById('acct-expenseNote').value;

      if (!date || !category || !amount) {
        alert('\u65E5\u4ED8\u3001\u52D8\u5B9A\u79D1\u76EE\u3001\u91D1\u984D\u306F\u5FC5\u9808\u3067\u3059');
        return;
      }

      try {
        await acctAddExpenseToFirestore({ date: date, category: category, amount: amount, note: note });
        var amountEl = document.getElementById('acct-expenseAmount');
        var noteEl = document.getElementById('acct-expenseNote');
        if (amountEl) amountEl.value = '';
        if (noteEl) noteEl.value = '';

        await acctLoadAccountingData();
        alert('\u2705 \u7D4C\u8CBB\u3092\u8FFD\u52A0\u3057\u307E\u3057\u305F');
      } catch (error) {
        console.error('経費追加エラー:', error);
        alert('経費の追加に失敗しました');
      }
    }

    async function acctDeleteExpense(expenseId) {
      if (!confirm('\u3053\u306E\u7D4C\u8CBB\u3092\u524A\u9664\u3057\u307E\u3059\u304B\uFF1F')) return;
      try {
        await acctDeleteExpenseFromFirestore(expenseId);
        await acctLoadAccountingData();
      } catch (error) {
        console.error('経費削除エラー:', error);
        alert('経費の削除に失敗しました');
      }
    }

    // ============================================
    // 帳簿出力
    // ============================================

    function acctDownloadLedger(type) {
      var startDate = _acctCurrentYear + '-01-01';
      var endDate = _acctCurrentYear + '-12-31';
      var bom = '\uFEFF';
      var csv = '';
      var filename = '';

      switch (type) {
        case 'sales':
          csv = acctGenerateSalesLedger(startDate, endDate);
          filename = '\u58F2\u4E0A\u5E33_' + _acctCurrentYear + '\u5E74.csv';
          break;
        case 'purchase':
          csv = acctGeneratePurchaseLedger(startDate, endDate);
          filename = '\u4ED5\u5165\u5E33_' + _acctCurrentYear + '\u5E74.csv';
          break;
        case 'expense':
          csv = acctGenerateExpenseLedger();
          filename = '\u7D4C\u8CBB\u5E33_' + _acctCurrentYear + '\u5E74.csv';
          break;
        case 'all':
          csv = acctGenerateSalesLedger(startDate, endDate) + '\n\n' + acctGeneratePurchaseLedger(startDate, endDate) + '\n\n' + acctGenerateExpenseLedger();
          filename = '\u5E33\u7C3F\u4E00\u62EC_' + _acctCurrentYear + '\u5E74.csv';
          break;
      }

      var blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
      var link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      alert('\u2705 \u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u3057\u307E\u3057\u305F');
    }

    function acctGenerateSalesLedger(startDate, endDate) {
      var csv = '\u58F2\u4E0A\u5E33\uFF08' + _acctCurrentYear + '\u5E74\uFF09\n\n\u65E5\u4ED8,\u7BA1\u7406\u756A\u53F7,\u5546\u54C1\u540D,\u8CA9\u58F2\u5148,\u58F2\u4E0A\u91D1\u984D\n';
      var sold = _acctCurrentProducts.filter(function(p) {
        return p.status === '\u8CA9\u58F2\u6E08' && (p.saleDate || '') >= startDate && (p.saleDate || '') <= endDate;
      }).sort(function(a, b) { return (a.saleDate || '').localeCompare(b.saleDate || ''); });
      var total = 0;
      sold.forEach(function(p) {
        var amount = parseFloat(p.saleAmount) || 0;
        total += amount;
        csv += [p.saleDate || '', p.managementNumber || '', '"' + (p.productName || '').replace(/"/g, '""') + '"', p.salePlatform || '', amount].join(',') + '\n';
      });
      csv += '\n\u5408\u8A08,,,,' + total + '\n';
      return csv;
    }

    function acctGeneratePurchaseLedger(startDate, endDate) {
      var csv = '\u4ED5\u5165\u5E33\uFF08' + _acctCurrentYear + '\u5E74\uFF09\n\n\u65E5\u4ED8,\u7BA1\u7406\u756A\u53F7,\u5546\u54C1\u540D,\u4ED5\u5165\u5148,\u4ED5\u5165\u91D1\u984D\n';
      var purchased = _acctCurrentProducts.filter(function(p) {
        var d = (p.purchase && p.purchase.date) || p.purchaseDate || '';
        return d >= startDate && d <= endDate;
      }).sort(function(a, b) { return (((a.purchase && a.purchase.date) || a.purchaseDate || '')).localeCompare(((b.purchase && b.purchase.date) || b.purchaseDate || '')); });
      var total = 0;
      purchased.forEach(function(p) {
        var amount = parseFloat((p.purchase && p.purchase.amount) || p.purchaseAmount) || 0;
        total += amount;
        csv += [(p.purchase && p.purchase.date) || p.purchaseDate || '', p.managementNumber || '', '"' + (p.productName || '').replace(/"/g, '""') + '"', p.supplier || '', amount].join(',') + '\n';
      });
      csv += '\n\u5408\u8A08,,,,' + total + '\n';
      return csv;
    }

    function acctGenerateExpenseLedger() {
      var csv = '\u7D4C\u8CBB\u5E33\uFF08' + _acctCurrentYear + '\u5E74\uFF09\n\n\u65E5\u4ED8,\u52D8\u5B9A\u79D1\u76EE,\u6458\u8981,\u91D1\u984D\n';
      var total = 0;
      _acctCurrentExpenses.sort(function(a, b) { return (a.date || '').localeCompare(b.date || ''); }).forEach(function(e) {
        var amount = parseFloat(e.amount) || 0;
        total += amount;
        csv += [e.date || '', e.category || '', '"' + (e.note || '').replace(/"/g, '""') + '"', amount].join(',') + '\n';
      });
      csv += '\n\u5408\u8A08,,,' + total + '\n';
      return csv;
    }

    // ============================================
    // SPA Lifecycle
    // ============================================

    function initAccountingPage() {
      console.log('[Acct SPA] initAccountingPage called');
      acctInitializePage();
    }

    function destroyAccountingPage() {
      console.log('[Acct SPA] destroyAccountingPage called');
      _acctCurrentProducts = [];
      _acctCurrentExpenses = [];
      _acctCurrentYear = new Date().getFullYear();
      _acctCurrentIncome = 0;
      _acctSelectedDeduction = 650000;
    }
  </script>
</div>
