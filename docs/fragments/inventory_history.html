<!-- SPA Fragment: inventory_history.html -->
<!-- Prefix: ih- -->
<div id="spa-page-inventory-history">
  <style>
    #spa-page-inventory-history {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      padding: 0;
      background-color: #f8f9fa;
      margin: 0;
    }
    @media (min-width: 768px) {
      #spa-page-inventory-history {
        background-color: transparent;
      }
    }
    #spa-page-inventory-history .container-fluid {
      padding: 12px;
    }
    @media (min-width: 768px) {
      #spa-page-inventory-history .container-fluid {
        padding: 8px;
      }
    }
    #spa-page-inventory-history .filter-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      border: 1px solid #e9ecef;
    }
    #spa-page-inventory-history .filter-section .form-label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 6px;
    }
    #spa-page-inventory-history .filter-section .form-select,
    #spa-page-inventory-history .filter-section .form-control {
      border: 1px solid #ced4da;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      transition: all 0.2s ease;
    }
    #spa-page-inventory-history .filter-section .form-select:focus,
    #spa-page-inventory-history .filter-section .form-control:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    #spa-page-inventory-history .filter-section .btn-primary {
      padding: 10px 24px;
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(37, 99, 235, 0.3);
      transition: all 0.2s ease;
    }
    #spa-page-inventory-history .filter-section .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }
    #spa-page-inventory-history .history-card {
      background: white;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      border-left: 4px solid #e9ecef;
      transition: box-shadow 0.2s ease;
    }
    #spa-page-inventory-history .history-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    #spa-page-inventory-history .history-card.card-inbound {
      border-left-color: #10b981;
    }
    #spa-page-inventory-history .history-card.card-outbound {
      border-left-color: #ef4444;
    }
    #spa-page-inventory-history .history-card.card-adjustment {
      border-left-color: #f59e0b;
    }
    #spa-page-inventory-history .ih-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e9ecef;
    }
    #spa-page-inventory-history .card-date {
      font-size: 0.85rem;
      color: #6c757d;
    }
    #spa-page-inventory-history .card-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    #spa-page-inventory-history .card-material {
      font-weight: 600;
      font-size: 1rem;
      color: #212529;
    }
    #spa-page-inventory-history .card-quantity {
      font-size: 1.25rem;
      font-weight: 700;
      color: #212529;
    }
    #spa-page-inventory-history .card-details {
      font-size: 0.85rem;
      color: #6c757d;
    }
    #spa-page-inventory-history .card-detail-row {
      margin-top: 4px;
    }
    #spa-page-inventory-history .card-detail-row.price-info {
      color: #059669;
      font-weight: 600;
    }
    #spa-page-inventory-history .table thead th {
      background-color: #f59e0b;
      color: white;
      font-weight: 600;
      border: none;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    #spa-page-inventory-history .table tbody tr:hover {
      background-color: #f8f9fa;
    }
    #spa-page-inventory-history .badge-type {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
    #spa-page-inventory-history .ih-loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #spa-page-inventory-history .spinner-border {
      width: 3rem;
      height: 3rem;
    }
    #spa-page-inventory-history .table-container {
      max-height: 500px;
      overflow-y: auto;
      overflow-x: auto;
    }
    #spa-page-inventory-history .table {
      font-size: 0.85rem;
      white-space: nowrap;
    }
    #spa-page-inventory-history .table th {
      font-size: 0.75rem;
      padding: 8px 4px;
    }
    #spa-page-inventory-history .table td {
      padding: 6px 4px;
    }
    #spa-page-inventory-history .export-section {
      background: white;
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
    }
    #spa-page-inventory-history .sub-header {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 56px;
      padding: 0 16px;
      background: #ffffff;
      border-bottom: 1px solid #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    #spa-page-inventory-history .sub-header-back {
      position: absolute;
      left: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: transparent;
      border: none;
      color: #374151;
      font-size: 20px;
      cursor: pointer;
    }
    #spa-page-inventory-history .sub-header-back:hover { background: #f3f4f6; }
    #spa-page-inventory-history .sub-header-back:active { background: #e5e7eb; }
    #spa-page-inventory-history .sub-header-title {
      font-size: 17px;
      font-weight: 600;
      color: #111827;
    }
    #spa-page-inventory-history .sub-header-icons {
      position: absolute;
      right: 8px;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    #spa-page-inventory-history .sub-header-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: transparent;
      border: none;
      color: #374151;
      font-size: 20px;
      cursor: pointer;
    }
    #spa-page-inventory-history .sub-header-icon:hover { background: #f3f4f6; }
    #spa-page-inventory-history .sub-header-icon:active { background: #e5e7eb; }
    #spa-page-inventory-history .ih-settings-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 180px;
      padding: 8px 0;
      display: none;
      z-index: 1001;
    }
    #spa-page-inventory-history .ih-settings-dropdown.show {
      display: block;
    }
    #spa-page-inventory-history .settings-dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border: none;
      background: none;
      width: 100%;
      font-size: 14px;
      color: #374151;
      cursor: pointer;
      text-align: left;
    }
    #spa-page-inventory-history .settings-dropdown-item:hover {
      background: #f3f4f6;
    }
    #spa-page-inventory-history .settings-dropdown-item i {
      font-size: 18px;
      color: #6b7280;
      width: 20px;
      text-align: center;
    }
    #spa-page-inventory-history .material-tabs {
      display: flex;
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      position: sticky;
      top: 56px;
      z-index: 999;
    }
    #spa-page-inventory-history .material-tab {
      flex: 1;
      padding: 12px 8px;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      color: #6b7280;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }
    #spa-page-inventory-history .material-tab:hover {
      color: #374151;
      background: #f9fafb;
    }
    #spa-page-inventory-history .material-tab.active {
      color: #2563eb;
      border-bottom-color: #2563eb;
    }
    #spa-page-inventory-history .material-tab i {
      display: block;
      font-size: 18px;
      margin-bottom: 4px;
    }
    #spa-page-inventory-history .ih-tab-content {
      display: none;
    }
    #spa-page-inventory-history .ih-tab-content.active {
      display: block;
    }
    #spa-page-inventory-history .stock-card {
      background: white;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border-left: 4px solid #e5e7eb;
    }
    #spa-page-inventory-history .stock-card.stock-ok { border-left-color: #10b981; }
    #spa-page-inventory-history .stock-card.stock-warning { border-left-color: #f59e0b; }
    #spa-page-inventory-history .stock-card.stock-danger { border-left-color: #ef4444; }
    #spa-page-inventory-history .stock-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    #spa-page-inventory-history .stock-card-name {
      font-weight: 600;
      font-size: 14px;
    }
    #spa-page-inventory-history .stock-card-category {
      font-size: 12px;
      color: #6b7280;
    }
    #spa-page-inventory-history .stock-card-body {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #spa-page-inventory-history .stock-count {
      font-size: 20px;
      font-weight: 700;
    }
    #spa-page-inventory-history .stock-count.text-success { color: #10b981; }
    #spa-page-inventory-history .stock-count.text-warning { color: #f59e0b; }
    #spa-page-inventory-history .stock-count.text-danger { color: #ef4444; }
    #spa-page-inventory-history .stock-actions {
      display: flex;
      gap: 8px;
    }
    #spa-page-inventory-history .order-card {
      background: white;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border-left: 4px solid #3b82f6;
    }
    #spa-page-inventory-history .order-card.order-pending { border-left-color: #f59e0b; }
    #spa-page-inventory-history .order-card.order-received { border-left-color: #10b981; }
    #spa-page-inventory-history .order-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    #spa-page-inventory-history .order-card-date {
      font-size: 12px;
      color: #6b7280;
    }
    #spa-page-inventory-history .order-card-body {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #spa-page-inventory-history .order-material {
      font-weight: 600;
    }
    #spa-page-inventory-history .order-quantity {
      font-size: 16px;
      font-weight: 600;
    }
    #spa-page-inventory-history .tab-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      border-radius: 9px;
      background: #ef4444;
      color: white;
      font-size: 11px;
      font-weight: 600;
      margin-left: 4px;
      vertical-align: middle;
    }
    #spa-page-inventory-history .tab-badge:empty {
      display: none;
    }
    #spa-page-inventory-history .stock-card.stock-danger {
      animation: ihAlertPulse 2s ease-in-out infinite;
    }
    @keyframes ihAlertPulse {
      0%, 100% { box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
      50% { box-shadow: 0 0 10px rgba(239, 68, 68, 0.4); }
    }
    #spa-page-inventory-history .stock-alert-icon {
      color: #ef4444;
      font-size: 14px;
      margin-left: 4px;
      animation: ihAlertBlink 1.5s ease-in-out infinite;
    }
    @keyframes ihAlertBlink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    #spa-page-inventory-history .alert-summary {
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      border: 1px solid #fecaca;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }
    #spa-page-inventory-history .alert-summary-title {
      font-size: 14px;
      font-weight: 600;
      color: #dc2626;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    #spa-page-inventory-history .alert-summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid #fecaca;
      font-size: 13px;
    }
    #spa-page-inventory-history .alert-summary-item:last-child {
      border-bottom: none;
    }
    #spa-page-inventory-history .alert-summary-location {
      color: #374151;
      font-weight: 500;
    }
    #spa-page-inventory-history .alert-summary-count {
      color: #dc2626;
      font-weight: 600;
    }
  </style>

  <!-- Loading Overlay -->
  <div class="ih-loading-overlay" id="ih-loadingOverlay">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- サブページヘッダー -->
  <div class="sub-header">
    <button class="sub-header-back" onclick="spaGoBack()" title="戻る">
      <i class="bi bi-chevron-left"></i>
    </button>
    <span class="sub-header-title">資材管理</span>
    <div class="sub-header-icons">
      <button class="sub-header-icon" onclick="navigateToPage('chat')" title="お知らせ">
        <i class="bi bi-bell"></i>
      </button>
      <div style="position: relative;">
        <button class="sub-header-icon" onclick="ihToggleSettingsDropdown(event)" title="メニュー">
          <i class="bi bi-list"></i>
        </button>
        <div class="ih-settings-dropdown" id="ih-settingsDropdown">
          <button class="settings-dropdown-item" onclick="ihExportToCSV()">
            <i class="bi bi-download"></i>
            <span>CSV出力</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- タブナビゲーション -->
  <div class="material-tabs">
    <button class="material-tab active" data-tab="stock" onclick="ihSwitchTab('stock')">
      <i class="bi bi-box-seam"></i>
      在庫<span class="tab-badge" id="ih-stockAlertBadge"></span>
    </button>
    <button class="material-tab" data-tab="history" onclick="ihSwitchTab('history')">
      <i class="bi bi-arrow-left-right"></i>
      入出庫履歴
    </button>
    <button class="material-tab" data-tab="orders" onclick="ihSwitchTab('orders')">
      <i class="bi bi-cart-plus"></i>
      発注
    </button>
  </div>

  <!-- 在庫タブ -->
  <div class="ih-tab-content active" id="ih-tab-stock">
    <div class="container-fluid">
      <div class="filter-section" style="margin-top: 12px;">
        <div class="row g-2 mb-2" id="ih-adminLocationRow" style="display: none;">
          <div class="col-12">
            <label class="form-label small mb-1"><i class="bi bi-geo-alt"></i> 場所選択（管理者）</label>
            <select class="form-select form-select-sm" id="ih-adminLocationFilter">
              <option value="">読み込み中...</option>
            </select>
          </div>
        </div>
        <div class="row g-2 mb-2">
          <div class="col-12">
            <select class="form-select form-select-sm" id="ih-stockCategoryFilter">
              <option value="">全カテゴリ</option>
            </select>
          </div>
        </div>
        <div class="row g-2 mb-2">
          <div class="col-6">
            <button class="btn w-100" style="background: linear-gradient(135deg, #4A90D9 0%, #357ABD 100%); color: white; border: none;" onclick="ihShowStockInModalMaterial()">
              <i class="bi bi-plus-circle me-1"></i> 入庫
            </button>
          </div>
          <div class="col-6">
            <button class="btn w-100" style="background: linear-gradient(135deg, #F5A623 0%, #E09612 100%); color: white; border: none;" onclick="ihShowStockAdjustmentModal()">
              <i class="bi bi-pencil-square me-1"></i> 調整
            </button>
          </div>
        </div>
        <div class="row g-2 mb-2" id="ih-adminTransferRow" style="display: none;">
          <div class="col-6">
            <button class="btn w-100" style="background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; border: none;" onclick="ihShowTransferModal()">
              <i class="bi bi-box-arrow-right me-1"></i> 配布
            </button>
          </div>
          <div class="col-6">
            <button class="btn w-100" style="background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%); color: white; border: none;" onclick="ihShowThresholdSettingsModal()">
              <i class="bi bi-sliders me-1"></i> 閾値設定
            </button>
          </div>
        </div>
        <div class="row g-2">
          <div class="col-12">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="ih-showLowStockOnly">
              <label class="form-check-label small" for="ih-showLowStockOnly">要発注のみ表示</label>
            </div>
          </div>
        </div>
      </div>
      <div id="ih-currentLocationBadge" class="mb-2 px-2">
        <small class="text-muted"><i class="bi bi-geo-alt"></i> <span id="ih-currentLocationName">読み込み中...</span></small>
      </div>
      <div id="ih-adminAlertSummary" class="px-2" style="display: none;"></div>
      <div id="ih-stockList"></div>
    </div>
  </div>

  <!-- 入出庫履歴タブ -->
  <div class="ih-tab-content" id="ih-tab-history">
    <div class="container-fluid">
    <div class="filter-section">
      <div class="row g-2 mb-2">
        <div class="col-6 col-md-2">
          <label for="ih-filterCategory" class="form-label small mb-1">カテゴリ</label>
          <select class="form-select form-select-sm" id="ih-filterCategory">
            <option value="">全て</option>
          </select>
        </div>
        <div class="col-6 col-md-3">
          <label for="ih-filterMaterial" class="form-label small mb-1">資材名</label>
          <select class="form-select form-select-sm" id="ih-filterMaterial">
            <option value="">全て</option>
          </select>
        </div>
      </div>
      <div class="row g-2 mb-2">
        <div class="col-6 col-md-2">
          <label for="ih-filterType" class="form-label small mb-1">種別</label>
          <select class="form-select form-select-sm" id="ih-filterType">
            <option value="">全て</option>
            <option value="入庫">入庫</option>
            <option value="出庫">出庫</option>
            <option value="調整">調整</option>
          </select>
        </div>
      </div>
      <div class="row g-2 mb-1">
        <div class="col-12">
          <label class="form-label small mb-1 text-muted"><i class="bi bi-calendar3"></i> 期間クイック選択</label>
        </div>
        <div class="col-12">
          <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm flex-fill" id="ih-btnAllPeriod">全期間</button>
            <button class="btn btn-outline-primary btn-sm flex-fill" id="ih-btnThisMonth">今月</button>
            <button class="btn btn-outline-primary btn-sm flex-fill" id="ih-btnLastMonth">先月</button>
          </div>
        </div>
      </div>
      <div class="row g-2 mb-2">
        <div class="col-12">
          <div class="d-flex gap-2">
            <select class="form-select form-select-sm flex-fill" id="ih-filterYear">
              <option value="">年選択</option>
            </select>
            <select class="form-select form-select-sm flex-fill" id="ih-filterMonth">
              <option value="">月選択</option>
            </select>
          </div>
        </div>
      </div>
      <div class="row g-2 mb-2">
        <div class="col-6 col-md-2">
          <label for="ih-filterStartDate" class="form-label small mb-1">開始日</label>
          <input type="date" class="form-control form-control-sm" id="ih-filterStartDate">
        </div>
        <div class="col-6 col-md-2">
          <label for="ih-filterEndDate" class="form-label small mb-1">終了日</label>
          <input type="date" class="form-control form-control-sm" id="ih-filterEndDate">
        </div>
      </div>
      <div class="row g-2 mb-2">
        <div class="col-12 col-md-3">
          <button class="btn btn-primary btn-sm w-100" id="ih-btnSearch"><i class="bi bi-search"></i> 検索</button>
        </div>
      </div>
      <div class="row mt-2">
        <div class="col-12">
          <button class="btn btn-outline-secondary btn-sm" id="ih-btnReset"><i class="bi bi-arrow-clockwise"></i> リセット</button>
          <span class="ms-3 text-muted small" id="ih-resultCount"></span>
        </div>
      </div>
    </div>
    <div id="ih-historyCards"></div>
    <div id="ih-pagination" class="d-flex justify-content-center align-items-center gap-2 my-3" style="display: none !important;"></div>
    </div>
  </div>

  <!-- 発注タブ -->
  <div class="ih-tab-content" id="ih-tab-orders">
    <div class="container-fluid">
      <div class="filter-section" style="margin-top: 12px;">
        <div class="row g-2 mb-2">
          <div class="col-6">
            <select class="form-select form-select-sm" id="ih-orderStatusFilter">
              <option value="">全ステータス</option>
              <option value="ordered" selected>発注中</option>
              <option value="received">入荷済み</option>
              <option value="cancelled">キャンセル</option>
            </select>
          </div>
          <div class="col-6">
            <button class="btn btn-primary btn-sm w-100" onclick="ihShowOrderModalMaterial()">
              <i class="bi bi-cart-plus"></i> 新規発注
            </button>
          </div>
        </div>
      </div>
      <div id="ih-ordersList"></div>
    </div>
  </div>

  <!-- 入庫モーダル -->
  <div class="modal fade" id="ih-stockInModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-box-arrow-in-down"></i> 入庫登録</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">資材選択</label>
            <select class="form-select" id="ih-stockInMaterial" style="font-size:16px;">
              <option value="">選択してください</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">入庫数量</label>
            <input type="number" class="form-control" id="ih-stockInQuantity" min="1" style="font-size:16px;">
          </div>
          <div class="mb-3">
            <label class="form-label">購入価格（合計・税込）</label>
            <input type="number" class="form-control" id="ih-stockInPrice" min="0" style="font-size:16px;">
            <small class="text-muted">※入庫数で割って単価を計算します</small>
          </div>
          <div class="mb-3">
            <label class="form-label">発注先（任意）</label>
            <input type="text" class="form-control" id="ih-stockInSupplier" placeholder="例: Amazon, 楽天" style="font-size:16px;">
          </div>
          <div class="mb-3">
            <label class="form-label">備考</label>
            <input type="text" class="form-control" id="ih-stockInNote" style="font-size:16px;">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-success" onclick="ihProcessStockInMaterial()">入庫登録</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 在庫調整モーダル -->
  <div class="modal fade" id="ih-stockAdjustmentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-pencil-square"></i> 在庫調整（減少）</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">資材選択</label>
            <select class="form-select" id="ih-adjustMaterial" style="font-size:16px;">
              <option value="">選択してください</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">減少数量</label>
            <input type="number" class="form-control" id="ih-adjustQuantity" min="1" style="font-size:16px;">
            <small class="text-muted">※新しいロットから自動的に減少します（LIFO）</small>
          </div>
          <div class="mb-3">
            <label class="form-label">理由</label>
            <select class="form-select" id="ih-adjustReason" style="font-size:16px;">
              <option value="damaged">破損</option>
              <option value="lost">紛失</option>
              <option value="discarded">廃棄</option>
              <option value="other">その他</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">備考</label>
            <input type="text" class="form-control" id="ih-adjustNote" placeholder="詳細メモ" style="font-size:16px;">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-warning" onclick="ihProcessStockAdjustmentMaterial()">在庫調整</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 発注モーダル -->
  <div class="modal fade" id="ih-orderModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-cart-plus"></i> 発注登録</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">資材選択</label>
            <select class="form-select" id="ih-orderMaterial" style="font-size:16px;">
              <option value="">選択してください</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">発注数量</label>
            <input type="number" class="form-control" id="ih-orderQuantity" min="1" style="font-size:16px;">
          </div>
          <div class="mb-3">
            <label class="form-label">発注先</label>
            <input type="text" class="form-control" id="ih-orderSupplier" style="font-size:16px;">
          </div>
          <div class="mb-3">
            <label class="form-label">備考</label>
            <input type="text" class="form-control" id="ih-orderNote" style="font-size:16px;">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" onclick="ihProcessOrderMaterial()">発注登録</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 入荷処理モーダル -->
  <div class="modal fade" id="ih-receiveModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-check-circle"></i> 入荷処理</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">資材名</label>
            <input type="text" class="form-control" id="ih-receiveMaterialName" readonly style="font-size:16px;">
            <input type="hidden" id="ih-receiveOrderId">
            <input type="hidden" id="ih-receiveMaterialId">
          </div>
          <div class="mb-3">
            <label class="form-label">発注数量</label>
            <input type="number" class="form-control" id="ih-receiveOrderedQuantity" readonly style="font-size:16px;">
          </div>
          <div class="mb-3">
            <label class="form-label">実際の入荷数量</label>
            <input type="number" class="form-control" id="ih-receiveActualQuantity" min="1" style="font-size:16px;">
          </div>
          <div class="mb-3">
            <label class="form-label">購入価格（税込）</label>
            <input type="number" class="form-control" id="ih-receivePrice" min="0" style="font-size:16px;">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-success" onclick="ihProcessReceiveOrderMaterial()">入荷完了</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 配布モーダル（管理者用） -->
  <div class="modal fade" id="ih-transferModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-box-arrow-right"></i> 資材配布</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">配布元（自分の場所）</label>
            <input type="text" class="form-control" id="ih-transferFromLocation" readonly style="font-size:16px; background-color: #f8f9fa;">
            <input type="hidden" id="ih-transferFromLocationId">
          </div>
          <div class="mb-3">
            <label class="form-label">配布先</label>
            <select class="form-select" id="ih-transferToLocation" style="font-size:16px;">
              <option value="">選択してください</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">資材選択</label>
            <select class="form-select" id="ih-transferMaterial" style="font-size:16px;">
              <option value="">選択してください</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">配布数量</label>
            <input type="number" class="form-control" id="ih-transferQuantity" min="1" style="font-size:16px;">
            <small class="text-muted" id="ih-transferAvailableStock">現在庫: -</small>
          </div>
          <div class="mb-3">
            <label class="form-label">備考</label>
            <input type="text" class="form-control" id="ih-transferNote" placeholder="配布理由など" style="font-size:16px;">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-success" onclick="ihProcessTransfer()">配布実行</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 閾値設定モーダル（管理者用） -->
  <div class="modal fade" id="ih-thresholdSettingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header" style="background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%); color: white;">
          <h5 class="modal-title"><i class="bi bi-sliders"></i> ユーザー別閾値設定</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">ユーザー（場所）を選択</label>
            <select class="form-select" id="ih-thresholdLocationSelect" style="font-size:16px;" onchange="ihLoadLocationThresholds()">
              <option value="">選択してください</option>
            </select>
            <small class="text-muted">ユーザーごとに資材の発注点（閾値）を設定できます</small>
          </div>
          <hr>
          <div id="ih-thresholdSettingsContainer" style="display: none;">
            <h6 class="mb-3"><i class="bi bi-box-seam"></i> 資材別閾値設定</h6>
            <p class="small text-muted mb-3">
              閾値を設定すると、そのユーザーの在庫が閾値以下になった時にアラートが発生します。<br>
              <strong>0 または空欄</strong>: グローバル閾値を使用（資材マスタの設定値）
            </p>
            <div id="ih-thresholdMaterialList"></div>
          </div>
          <div id="ih-thresholdNoLocationSelected" class="text-center text-muted py-4">
            <i class="bi bi-arrow-up-circle" style="font-size: 2rem;"></i>
            <p class="mt-2">ユーザー（場所）を選択してください</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
          <button type="button" class="btn" style="background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%); color: white;" onclick="ihSaveLocationThresholds()">
            <i class="bi bi-check-lg"></i> 保存
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========================================
    // State Variables (ih_ prefix)
    // ========================================
    var ih_currentHistoryData = [];
    var ih_allMaterials = [];
    var ih_allLocations = [];
    var ih_selectedLocationId = null;
    var ih_currentPage = 1;
    var IH_ITEMS_PER_PAGE = 10;
    var ih_currentTab = 'stock';
    var ih_allOrders = [];
    var _ih_currentLocation = null;
    var _ih_eventListeners = [];
    var _ih_dropdownClickHandler = null;

    // ========================================
    // Event Listener Tracking
    // ========================================
    function ihAddListener(el, event, handler, options) {
      if (!el) return;
      el.addEventListener(event, handler, options);
      _ih_eventListeners.push({ el: el, event: event, handler: handler, options: options });
    }

    // ========================================
    // Utility Functions
    // ========================================
    function ihGetDb() {
      return window.db;
    }

    function ihGetFirebaseTimestamp() {
      if (window.firebase && window.firebase.firestore && window.firebase.firestore.FieldValue) {
        return window.firebase.firestore.FieldValue.serverTimestamp();
      }
      return new Date();
    }

    function ihIsAdmin() {
      var permission = localStorage.getItem('reborn_user_permission');
      return permission === 'owner' || permission === 'admin';
    }

    function ihGetJSTToday() {
      var now = new Date();
      var jst = new Date(now.getTime() + (9 * 60 + now.getTimezoneOffset()) * 60000);
      var year = jst.getFullYear();
      var month = String(jst.getMonth() + 1).padStart(2, '0');
      var day = String(jst.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }

    function ihShowLoading() {
      var el = document.getElementById('ih-loadingOverlay');
      if (el) el.style.display = 'flex';
    }

    function ihHideLoading() {
      var el = document.getElementById('ih-loadingOverlay');
      if (el) el.style.display = 'none';
    }

    function ihEscapeHtml(text) {
      if (!text) return '';
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function ihFormatDateTime(date) {
      var d = new Date(date);
      var year = d.getFullYear();
      var month = String(d.getMonth() + 1).padStart(2, '0');
      var day = String(d.getDate()).padStart(2, '0');
      var hours = String(d.getHours()).padStart(2, '0');
      var minutes = String(d.getMinutes()).padStart(2, '0');
      return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes;
    }

    function ihGetBadgeType(type) {
      var badges = {
        '入庫': '<span class="badge bg-success badge-type">入庫</span>',
        '出庫': '<span class="badge bg-danger badge-type">出庫</span>',
        '調整': '<span class="badge bg-warning text-dark badge-type">調整</span>',
        '配布出': '<span class="badge bg-danger badge-type">配布出庫</span>',
        '配布入': '<span class="badge bg-success badge-type">配布入庫</span>'
      };
      return badges[type] || type;
    }

    function ihShowError(message) {
      var container = document.getElementById('ih-historyCards');
      if (container) container.innerHTML = '<div class="text-center text-danger py-4">' + ihEscapeHtml(message) + '</div>';
    }

    function ihShowInitialMessage() {
      var container = document.getElementById('ih-historyCards');
      if (container) {
        container.innerHTML = '<div class="text-center text-muted py-5" style="font-size: 1rem;"><div>検索条件を選択して検索ボタンをクリックしてください</div></div>';
      }
      var rc = document.getElementById('ih-resultCount');
      if (rc) rc.textContent = '';
    }

    function ihToggleSettingsDropdown(event) {
      event.stopPropagation();
      var dropdown = document.getElementById('ih-settingsDropdown');
      if (dropdown) dropdown.classList.toggle('show');
    }

    // ========================================
    // Tab Switching
    // ========================================
    function ihSwitchTab(tabName) {
      ih_currentTab = tabName;
      var root = document.getElementById('spa-page-inventory-history');
      if (!root) return;
      root.querySelectorAll('.material-tab').forEach(function(tab) {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });
      root.querySelectorAll('.ih-tab-content').forEach(function(content) {
        content.classList.toggle('active', content.id === 'ih-tab-' + tabName);
      });
      if (tabName === 'stock') {
        ihLoadStockList();
      } else if (tabName === 'orders') {
        ihLoadOrdersList();
      }
    }

    // ========================================
    // Period Filters
    // ========================================
    function ihInitializePeriodFilters() {
      var currentYear = new Date().getFullYear();
      var yearSelect = document.getElementById('ih-filterYear');
      if (!yearSelect) return;
      for (var year = currentYear; year >= 2020; year--) {
        var option = document.createElement('option');
        option.value = year;
        option.textContent = year + '年';
        yearSelect.appendChild(option);
      }
      var monthSelect = document.getElementById('ih-filterMonth');
      if (!monthSelect) return;
      for (var month = 1; month <= 12; month++) {
        var option = document.createElement('option');
        option.value = month;
        option.textContent = month + '月';
        monthSelect.appendChild(option);
      }
    }

    function ihSetAllPeriod() {
      document.getElementById('ih-filterStartDate').value = '';
      document.getElementById('ih-filterEndDate').value = '';
      document.getElementById('ih-filterYear').value = '';
      document.getElementById('ih-filterMonth').value = '';
    }

    function ihSetThisMonth() {
      var now = new Date();
      var year = now.getFullYear();
      var month = String(now.getMonth() + 1).padStart(2, '0');
      var firstDay = year + '-' + month + '-01';
      var lastDay = new Date(year, now.getMonth() + 1, 0);
      var lastDayStr = year + '-' + month + '-' + String(lastDay.getDate()).padStart(2, '0');
      document.getElementById('ih-filterStartDate').value = firstDay;
      document.getElementById('ih-filterEndDate').value = lastDayStr;
      document.getElementById('ih-filterYear').value = '';
      document.getElementById('ih-filterMonth').value = '';
    }

    function ihSetLastMonth() {
      var now = new Date();
      var lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      var year = lastMonth.getFullYear();
      var month = String(lastMonth.getMonth() + 1).padStart(2, '0');
      var firstDay = year + '-' + month + '-01';
      var lastDay = new Date(year, lastMonth.getMonth() + 1, 0);
      var lastDayStr = year + '-' + month + '-' + String(lastDay.getDate()).padStart(2, '0');
      document.getElementById('ih-filterStartDate').value = firstDay;
      document.getElementById('ih-filterEndDate').value = lastDayStr;
      document.getElementById('ih-filterYear').value = '';
      document.getElementById('ih-filterMonth').value = '';
    }

    function ihUpdatePeriodFromYearMonth() {
      var year = document.getElementById('ih-filterYear').value;
      var month = document.getElementById('ih-filterMonth').value;
      if (year && month) {
        var lastDay = new Date(year, month, 0).getDate();
        document.getElementById('ih-filterStartDate').value = year + '-' + String(month).padStart(2, '0') + '-01';
        document.getElementById('ih-filterEndDate').value = year + '-' + String(month).padStart(2, '0') + '-' + String(lastDay).padStart(2, '0');
      } else if (year && !month) {
        document.getElementById('ih-filterStartDate').value = year + '-01-01';
        document.getElementById('ih-filterEndDate').value = year + '-12-31';
      } else {
        document.getElementById('ih-filterStartDate').value = '';
        document.getElementById('ih-filterEndDate').value = '';
      }
    }

    function ihFilterMaterialsByCategory(category) {
      var materialSelect = document.getElementById('ih-filterMaterial');
      if (!materialSelect) return;
      materialSelect.innerHTML = '<option value="">全て</option>';
      var filtered = category ? ih_allMaterials.filter(function(m) { return m.category === category; }) : ih_allMaterials;
      filtered.forEach(function(material) {
        var option = document.createElement('option');
        option.value = material.productName;
        option.textContent = material.productName;
        materialSelect.appendChild(option);
      });
    }

    function ihResetFilters() {
      document.getElementById('ih-filterCategory').value = '';
      document.getElementById('ih-filterMaterial').value = '';
      document.getElementById('ih-filterType').value = '';
      document.getElementById('ih-filterStartDate').value = '';
      document.getElementById('ih-filterEndDate').value = '';
      document.getElementById('ih-filterYear').value = '';
      document.getElementById('ih-filterMonth').value = '';
      ihFilterMaterialsByCategory('');
      ihShowInitialMessage();
    }

    // ========================================
    // GAS→Firestore: Materials List
    // ========================================
    async function ihLoadMaterialsList() {
      try {
        var db = ihGetDb();
        if (!db) {
          console.error('[ih] Firestore未接続');
          return;
        }
        var snapshot = await db.collection('packagingMaterials').get();
        var materials = snapshot.docs.map(function(doc) {
          var d = doc.data();
          return {
            id: doc.id,
            productName: d.productName || '',
            category: d.category || '',
            currentStock: d.currentStock || 0,
            stockAlertThreshold: d.stockAlertThreshold || 0,
            supplier: d.supplier || '',
            name: d.name || ''
          };
        });
        ih_allMaterials = materials;

        var categories = [];
        var seen = {};
        materials.forEach(function(m) {
          if (m.category && !seen[m.category]) {
            seen[m.category] = true;
            categories.push(m.category);
          }
        });
        var categorySelect = document.getElementById('ih-filterCategory');
        if (categorySelect) {
          categorySelect.innerHTML = '<option value="">全て</option>';
          categories.forEach(function(cat) {
            var option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            categorySelect.appendChild(option);
          });
        }
        ihFilterMaterialsByCategory('');
      } catch (error) {
        console.error('[ih] 資材リスト読み込みエラー:', error);
      }
    }

    // ========================================
    // GAS→Firestore: History Data
    // ========================================
    async function ihLoadHistoryData() {
      ihShowLoading();
      var materialName = document.getElementById('ih-filterMaterial').value || '';
      var filterType = document.getElementById('ih-filterType').value || '';
      var startDate = document.getElementById('ih-filterStartDate').value || '';
      var endDate = document.getElementById('ih-filterEndDate').value || '';

      try {
        var db = ihGetDb();
        if (!db) {
          ihHideLoading();
          ihShowError('Firestoreに接続できません');
          return;
        }

        var query = db.collection('packagingTransactions')
          .orderBy('createdAt', 'desc')
          .limit(1000);
        var snapshot = await query.get();
        var data = snapshot.docs.map(function(doc) {
          var d = doc.data();
          var ts = d.createdAt ? (d.createdAt.toDate ? d.createdAt.toDate() : new Date(d.createdAt)) : new Date();
          return {
            timestamp: ts,
            operator: d.createdBy || '',
            materialName: d.materialName || '',
            type: d.type || '',
            quantity: d.quantity || 0,
            reason: d.reason || '',
            relatedSalesRecord: d.relatedSaleId || '',
            unitCost: d.unitPrice || 0,
            purchasePrice: d.purchasePrice || 0,
            packageQuantity: d.packageQuantity || 0,
            note: d.note || ''
          };
        });

        // Client-side filtering
        if (materialName) {
          data = data.filter(function(item) { return item.materialName === materialName; });
        }
        if (filterType) {
          if (filterType === '出庫') {
            data = data.filter(function(item) { return item.type === '出庫' || item.type === '配布出'; });
          } else if (filterType === '入庫') {
            data = data.filter(function(item) { return item.type === '入庫' || item.type === '配布入'; });
          } else {
            data = data.filter(function(item) { return item.type === filterType; });
          }
        }
        if (startDate) {
          var start = new Date(startDate);
          start.setHours(0, 0, 0, 0);
          data = data.filter(function(item) { return new Date(item.timestamp) >= start; });
        }
        if (endDate) {
          var end = new Date(endDate);
          end.setHours(23, 59, 59, 999);
          data = data.filter(function(item) { return new Date(item.timestamp) <= end; });
        }

        ihHideLoading();
        ih_currentHistoryData = data;
        ih_currentPage = 1;
        ihRenderHistoryTable(data);
        document.getElementById('ih-resultCount').textContent = data.length + '件';
      } catch (error) {
        ihHideLoading();
        console.error('[ih] 履歴データ取得エラー:', error);
        ihShowError('データの読み込みに失敗しました: ' + error.message);
      }
    }

    // ========================================
    // History Rendering + Pagination
    // ========================================
    function ihRenderHistoryTable(data) {
      var container = document.getElementById('ih-historyCards');
      var paginationContainer = document.getElementById('ih-pagination');
      if (!container) return;

      if (data.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-4">該当するデータがありません</div>';
        if (paginationContainer) paginationContainer.style.display = 'none';
        return;
      }

      var totalPages = Math.ceil(data.length / IH_ITEMS_PER_PAGE);
      var startIndex = (ih_currentPage - 1) * IH_ITEMS_PER_PAGE;
      var endIndex = startIndex + IH_ITEMS_PER_PAGE;
      var pageData = data.slice(startIndex, endIndex);

      container.innerHTML = pageData.map(function(item) {
        var cardTypeClass = '';
        if (item.type === '入庫' || item.type === '配布入') cardTypeClass = 'card-inbound';
        else if (item.type === '出庫' || item.type === '配布出') cardTypeClass = 'card-outbound';
        else if (item.type === '調整') cardTypeClass = 'card-adjustment';

        var detailHtml = '';
        if (item.type === '入庫' || item.type === '配布入') {
          detailHtml = '<div style="display:flex;gap:12px;margin-top:8px;padding-top:8px;border-top:1px solid #f0f0f0;"><div style="flex:1;">' +
            (item.purchasePrice ? '<div class="card-detail-row price-info">購入価格: ¥' + item.purchasePrice.toLocaleString() + '</div>' : '') +
            (item.packageQuantity ? '<div class="card-detail-row price-info">購入個数: ' + item.packageQuantity.toLocaleString() + '個</div>' : '') +
            (item.unitCost ? '<div class="card-detail-row price-info">単価: ¥' + item.unitCost.toFixed(2) + '</div>' : '') +
            '</div><div style="flex:1;">' +
            (item.reason ? '<div class="card-detail-row">理由: ' + ihEscapeHtml(item.reason) + '</div>' : '') +
            (item.operator ? '<div class="card-detail-row">ユーザー名: ' + ihEscapeHtml(item.operator) + '</div>' : '') +
            (item.relatedSalesRecord ? '<div class="card-detail-row">販売記録: ' + ihEscapeHtml(item.relatedSalesRecord) + '</div>' : '') +
            (item.note ? '<div class="card-detail-row">備考: ' + ihEscapeHtml(item.note) + '</div>' : '') +
            '</div></div>';
        } else {
          detailHtml =
            (item.reason ? '<div class="card-detail-row" style="margin-top:8px;padding-top:8px;border-top:1px solid #f0f0f0;">理由: ' + ihEscapeHtml(item.reason) + '</div>' : '') +
            (item.operator ? '<div class="card-detail-row">ユーザー名: ' + ihEscapeHtml(item.operator) + '</div>' : '') +
            (item.relatedSalesRecord ? '<div class="card-detail-row">販売記録: ' + ihEscapeHtml(item.relatedSalesRecord) + '</div>' : '') +
            (item.note ? '<div class="card-detail-row">備考: ' + ihEscapeHtml(item.note) + '</div>' : '');
        }

        return '<div class="history-card ' + cardTypeClass + '">' +
          '<div class="ih-card-header">' +
            '<span class="card-date">' + ihFormatDateTime(item.timestamp) + '</span>' +
            ihGetBadgeType(item.type) +
          '</div>' +
          '<div class="card-main">' +
            '<div class="card-material">' + ihEscapeHtml(item.materialName) + '</div>' +
            '<div class="card-quantity">' + item.quantity.toLocaleString() + '個</div>' +
          '</div>' +
          '<div class="card-details">' + detailHtml + '</div>' +
        '</div>';
      }).join('');

      ihRenderPagination(totalPages, data.length);
    }

    function ihRenderPagination(totalPages, totalItems) {
      var paginationContainer = document.getElementById('ih-pagination');
      if (!paginationContainer) return;
      if (totalPages <= 1) {
        paginationContainer.style.display = 'none';
        return;
      }
      paginationContainer.style.display = 'flex';
      var html = '';
      html += '<button class="btn btn-outline-primary btn-sm" ' + (ih_currentPage === 1 ? 'disabled' : '') + ' onclick="ihChangePage(' + (ih_currentPage - 1) + ')">‹ 前へ</button>';
      var maxButtons = 5;
      var startPage = Math.max(1, ih_currentPage - Math.floor(maxButtons / 2));
      var endPage = Math.min(totalPages, startPage + maxButtons - 1);
      if (endPage - startPage < maxButtons - 1) {
        startPage = Math.max(1, endPage - maxButtons + 1);
      }
      for (var i = startPage; i <= endPage; i++) {
        html += '<button class="btn ' + (i === ih_currentPage ? 'btn-primary' : 'btn-outline-primary') + ' btn-sm" onclick="ihChangePage(' + i + ')">' + i + '</button>';
      }
      html += '<button class="btn btn-outline-primary btn-sm" ' + (ih_currentPage === totalPages ? 'disabled' : '') + ' onclick="ihChangePage(' + (ih_currentPage + 1) + ')">次へ ›</button>';
      html += '<span class="text-muted small ms-2">' + totalItems + '件中 ' + ((ih_currentPage - 1) * IH_ITEMS_PER_PAGE + 1) + '-' + Math.min(ih_currentPage * IH_ITEMS_PER_PAGE, totalItems) + '件</span>';
      paginationContainer.innerHTML = html;
    }

    function ihChangePage(page) {
      ih_currentPage = page;
      ihRenderHistoryTable(ih_currentHistoryData);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ========================================
    // CSV Export
    // ========================================
    function ihExportToCSV() {
      var dropdown = document.getElementById('ih-settingsDropdown');
      if (dropdown) dropdown.classList.remove('show');
      if (ih_currentHistoryData.length === 0) {
        alert('出力するデータがありません');
        return;
      }
      var headers = ['日時', 'ユーザー名', '資材名', '種別', '数量', '理由', '関連販売記録', '備考'];
      var rows = ih_currentHistoryData.map(function(item) {
        return [
          ihFormatDateTime(item.timestamp), item.operator, item.materialName,
          item.type, item.quantity, item.reason, item.relatedSalesRecord, item.note
        ];
      });
      var csvContent = [
        headers.join(','),
        ...rows.map(function(row) { return row.map(function(cell) { return '"' + String(cell).replace(/"/g, '""') + '"'; }).join(','); })
      ].join('\n');
      var bom = '\uFEFF';
      var blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
      var link = document.createElement('a');
      var url = URL.createObjectURL(blob);
      var timestamp = ihGetJSTToday().replace(/-/g, '');
      link.setAttribute('href', url);
      link.setAttribute('download', '入出庫履歴_' + timestamp + '.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      setTimeout(function() {
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }, 100);
    }

    // ========================================
    // Location Management
    // ========================================
    async function ihGetCurrentUserLocation() {
      if (_ih_currentLocation) return _ih_currentLocation;
      var userEmail = localStorage.getItem('reborn_user_email');
      var userName = localStorage.getItem('reborn_user_name') || 'unknown';
      if (!userEmail) {
        console.warn('[ih] ユーザーメール未取得');
        return null;
      }
      var db = ihGetDb();
      if (!db) {
        console.error('[ih] Firestore未接続');
        return null;
      }
      try {
        var snapshot = await db.collection('packagingLocations')
          .where('assignedUserEmail', '==', userEmail)
          .where('type', '==', 'user_home')
          .limit(1)
          .get();
        if (!snapshot.empty) {
          var doc = snapshot.docs[0];
          _ih_currentLocation = { id: doc.id, ...doc.data() };
          return _ih_currentLocation;
        }
        var newLocation = {
          name: userName + 'さん',
          type: 'user_home',
          assignedUserEmail: userEmail,
          assignedUserName: userName,
          isActive: true,
          createdAt: ihGetFirebaseTimestamp(),
          updatedAt: ihGetFirebaseTimestamp()
        };
        var docRef = await db.collection('packagingLocations').add(newLocation);
        _ih_currentLocation = { id: docRef.id, ...newLocation };
        return _ih_currentLocation;
      } catch (error) {
        console.error('[ih] 場所取得/作成エラー:', error);
        return null;
      }
    }

    // ========================================
    // Admin UI
    // ========================================
    async function ihInitializeAdminUI() {
      if (!ihIsAdmin()) return;
      var el1 = document.getElementById('ih-adminLocationRow');
      if (el1) el1.style.display = 'flex';
      var el2 = document.getElementById('ih-adminTransferRow');
      if (el2) el2.style.display = 'flex';
      var el3 = document.getElementById('ih-adminAlertSummary');
      if (el3) el3.style.display = 'block';
      await ihLoadAllLocations();
      await ihLoadAllLocationsAlertSummary();
    }

    async function ihLoadAllLocations() {
      try {
        var db = ihGetDb();
        if (!db) return;
        var snapshot = await db.collection('packagingLocations')
          .where('isActive', '==', true)
          .orderBy('type')
          .orderBy('name')
          .get();
        ih_allLocations = snapshot.docs.map(function(doc) { return { id: doc.id, ...doc.data() }; });
        var select = document.getElementById('ih-adminLocationFilter');
        if (select) {
          select.innerHTML = '<option value="">自分の場所</option>' +
            ih_allLocations.map(function(loc) {
              var typeLabel = loc.type === 'user_home' ? '👤' : loc.type === 'warehouse' ? '🏭' : '🏢';
              return '<option value="' + loc.id + '">' + typeLabel + ' ' + ihEscapeHtml(loc.name) + '</option>';
            }).join('');
        }
      } catch (error) {
        console.error('[ih] 場所一覧取得エラー:', error);
      }
    }

    async function ihLoadAllLocationsAlertSummary() {
      var container = document.getElementById('ih-adminAlertSummary');
      if (!container) return;
      try {
        var db = ihGetDb();
        if (!db) return;
        var materialsSnapshot = await db.collection('packagingMaterials').get();
        var materials = materialsSnapshot.docs.map(function(doc) { return { id: doc.id, ...doc.data() }; });
        var lotsSnapshot = await db.collection('packagingLots').where('status', '==', 'active').get();
        var stockByLocation = {};
        lotsSnapshot.docs.forEach(function(doc) {
          var lot = doc.data();
          var locId = lot.locationId || 'unknown';
          if (!stockByLocation[locId]) stockByLocation[locId] = {};
          if (!stockByLocation[locId][lot.materialId]) stockByLocation[locId][lot.materialId] = 0;
          stockByLocation[locId][lot.materialId] += lot.remainingQty || 0;
        });
        var locationAlerts = [];
        ih_allLocations.forEach(function(loc) {
          var locStock = stockByLocation[loc.id] || {};
          var alertCount = 0;
          materials.forEach(function(m) {
            var stock = locStock[m.id] || 0;
            var threshold = m.stockAlertThreshold || 0;
            if (stock <= 0 || (threshold > 0 && stock <= threshold)) alertCount++;
          });
          if (alertCount > 0) locationAlerts.push({ id: loc.id, name: loc.name, type: loc.type, alertCount: alertCount });
        });
        if (locationAlerts.length === 0) {
          container.innerHTML = '';
          container.style.display = 'none';
          return;
        }
        container.style.display = 'block';
        var typeIcon = function(type) { return type === 'user_home' ? '👤' : type === 'warehouse' ? '🏭' : '🏢'; };
        container.innerHTML = '<div class="alert-summary"><div class="alert-summary-title"><i class="bi bi-exclamation-triangle-fill"></i> 全場所の在庫アラート</div>' +
          locationAlerts.map(function(loc) {
            return '<div class="alert-summary-item" onclick="ihSelectLocation(\'' + loc.id + '\')" style="cursor: pointer;"><span class="alert-summary-location">' + typeIcon(loc.type) + ' ' + ihEscapeHtml(loc.name) + '</span><span class="alert-summary-count">' + loc.alertCount + '件</span></div>';
          }).join('') + '</div>';
      } catch (error) {
        console.error('[ih] 全場所アラートサマリー取得エラー:', error);
        container.innerHTML = '';
      }
    }

    function ihSelectLocation(locationId) {
      var select = document.getElementById('ih-adminLocationFilter');
      if (select) {
        select.value = locationId;
        ih_selectedLocationId = locationId;
        ihLoadStockList();
      }
    }

    // ========================================
    // Stock Tab
    // ========================================
    async function ihLoadStockList() {
      var container = document.getElementById('ih-stockList');
      if (!container) return;
      container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div></div>';
      try {
        var db = ihGetDb();
        if (!db) {
          container.innerHTML = '<div class="text-center text-danger py-4">Firestoreに接続できません</div>';
          return;
        }
        var locationId, locationName;
        if (ih_selectedLocationId && ihIsAdmin()) {
          var selectedLoc = ih_allLocations.find(function(l) { return l.id === ih_selectedLocationId; });
          locationId = ih_selectedLocationId;
          locationName = selectedLoc ? selectedLoc.name : '不明な場所';
        } else {
          var location = await ihGetCurrentUserLocation();
          if (!location) {
            container.innerHTML = '<div class="text-center text-danger py-4">場所の取得に失敗しました</div>';
            return;
          }
          locationId = location.id;
          locationName = location.name;
        }
        var locationNameEl = document.getElementById('ih-currentLocationName');
        if (locationNameEl) locationNameEl.textContent = locationName;

        var materialsSnapshot = await db.collection('packagingMaterials').get();
        var materials = materialsSnapshot.docs.map(function(doc) { return { id: doc.id, ...doc.data() }; });
        var lotsSnapshot = await db.collection('packagingLots')
          .where('locationId', '==', locationId)
          .where('status', '==', 'active')
          .get();
        var stockByMaterial = {};
        lotsSnapshot.docs.forEach(function(doc) {
          var lot = doc.data();
          if (!stockByMaterial[lot.materialId]) stockByMaterial[lot.materialId] = 0;
          stockByMaterial[lot.materialId] += lot.remainingQty || 0;
        });
        ih_allMaterials = materials.map(function(m) {
          return { ...m, currentStock: stockByMaterial[m.id] || 0 };
        });
        ihPopulateStockCategoryFilter(ih_allMaterials);
        ihRenderStockList(ih_allMaterials);
      } catch (error) {
        console.error('[ih] 資材リスト取得エラー:', error);
        container.innerHTML = '<div class="text-center text-danger py-4">エラー: ' + error.message + '</div>';
      }
    }

    function ihPopulateStockCategoryFilter(materials) {
      var categories = [];
      var seen = {};
      materials.forEach(function(m) {
        if (m.category && !seen[m.category]) { seen[m.category] = true; categories.push(m.category); }
      });
      var select = document.getElementById('ih-stockCategoryFilter');
      if (select) {
        select.innerHTML = '<option value="">全カテゴリ</option>' +
          categories.map(function(cat) { return '<option value="' + ihEscapeHtml(cat) + '">' + ihEscapeHtml(cat) + '</option>'; }).join('');
      }
    }

    function ihRenderStockList(materials) {
      var container = document.getElementById('ih-stockList');
      if (!container) return;
      var categoryFilter = document.getElementById('ih-stockCategoryFilter').value;
      var showLowOnly = document.getElementById('ih-showLowStockOnly').checked;
      var filtered = materials;
      if (categoryFilter) filtered = filtered.filter(function(m) { return m.category === categoryFilter; });
      if (showLowOnly) filtered = filtered.filter(function(m) { return (m.currentStock || 0) <= (m.stockAlertThreshold || 0); });
      ihUpdateAlertBadge(materials);
      if (filtered.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-4">該当する資材がありません</div>';
        return;
      }
      container.innerHTML = filtered.map(function(item) {
        var stock = item.currentStock || 0;
        var threshold = item.stockAlertThreshold || 0;
        var stockClass = 'stock-ok';
        var countClass = 'text-success';
        var alertIcon = '';
        if (stock <= 0) {
          stockClass = 'stock-danger'; countClass = 'text-danger';
          alertIcon = '<i class="bi bi-exclamation-triangle-fill stock-alert-icon"></i>';
        } else if (threshold > 0 && stock <= threshold) {
          stockClass = 'stock-warning'; countClass = 'text-warning';
          alertIcon = '<i class="bi bi-exclamation-circle stock-alert-icon" style="color: #f59e0b;"></i>';
        }
        return '<div class="stock-card ' + stockClass + '">' +
          '<div class="stock-card-header"><span class="stock-card-name">' + ihEscapeHtml(item.productName || item.name) + alertIcon + '</span><span class="stock-card-category">' + ihEscapeHtml(item.category || '') + '</span></div>' +
          '<div class="stock-card-body"><div><span class="stock-count ' + countClass + '">' + stock + '</span><span class="text-muted small">個</span>' +
          (threshold > 0 ? '<span class="text-muted small ms-2">(発注点: ' + threshold + ')</span>' : '') +
          '</div><div class="stock-actions">' +
          '<button class="btn btn-sm btn-outline-success" onclick="ihShowStockInModalMaterial(\'' + item.id + '\')"><i class="bi bi-plus"></i></button>' +
          '<button class="btn btn-sm btn-outline-primary" onclick="ihShowOrderModalMaterial(\'' + item.id + '\')"><i class="bi bi-cart-plus"></i></button>' +
          '</div></div></div>';
      }).join('');
    }

    function ihUpdateAlertBadge(materials) {
      var badge = document.getElementById('ih-stockAlertBadge');
      if (!badge) return;
      var alertCount = materials.filter(function(m) {
        var stock = m.currentStock || 0;
        var threshold = m.stockAlertThreshold || 0;
        return stock <= 0 || (threshold > 0 && stock <= threshold);
      }).length;
      badge.textContent = alertCount > 0 ? alertCount : '';
    }

    // ========================================
    // Stock In Modal
    // ========================================
    function ihShowStockInModalMaterial(materialId) {
      var select = document.getElementById('ih-stockInMaterial');
      select.innerHTML = '<option value="">選択してください</option>' +
        ih_allMaterials.map(function(m) { return '<option value="' + m.id + '" ' + (m.id === materialId ? 'selected' : '') + '>' + ihEscapeHtml(m.productName || m.name) + '</option>'; }).join('');
      document.getElementById('ih-stockInQuantity').value = '';
      document.getElementById('ih-stockInPrice').value = '';
      document.getElementById('ih-stockInSupplier').value = '';
      document.getElementById('ih-stockInNote').value = '';
      var modal = new bootstrap.Modal(document.getElementById('ih-stockInModal'));
      modal.show();
    }

    async function ihProcessStockInMaterial() {
      var materialId = document.getElementById('ih-stockInMaterial').value;
      var quantity = parseInt(document.getElementById('ih-stockInQuantity').value) || 0;
      var price = parseFloat(document.getElementById('ih-stockInPrice').value) || 0;
      var supplier = document.getElementById('ih-stockInSupplier').value.trim();
      var note = document.getElementById('ih-stockInNote').value;
      if (!materialId) { alert('資材を選択してください'); return; }
      if (quantity <= 0) { alert('数量を入力してください'); return; }
      var material = ih_allMaterials.find(function(m) { return m.id === materialId; });
      var materialName = material ? (material.productName || material.name) : '';
      var unitPrice = price > 0 && quantity > 0 ? Math.round(price / quantity) : 0;
      ihShowLoading();
      bootstrap.Modal.getInstance(document.getElementById('ih-stockInModal'))?.hide();
      try {
        var db = ihGetDb();
        var location = await ihGetCurrentUserLocation();
        if (!location) throw new Error('場所の取得に失敗しました');
        var locationId = location.id;
        var lotRef = await db.collection('packagingLots').add({
          materialId: materialId, locationId: locationId, quantity: quantity, remainingQty: quantity,
          unitPrice: unitPrice, purchaseDate: ihGetFirebaseTimestamp(), supplier: supplier, notes: note,
          status: 'active', createdBy: localStorage.getItem('reborn_user_name') || 'unknown',
          createdAt: ihGetFirebaseTimestamp(), updatedAt: ihGetFirebaseTimestamp()
        });
        await db.collection('packagingTransactions').add({
          materialId: materialId, materialName: materialName, locationId: locationId, type: '入庫',
          quantity: quantity, purchasePrice: price, unitPrice: unitPrice, lotId: lotRef.id,
          supplier: supplier, reason: '手動入庫', note: note,
          createdBy: localStorage.getItem('reborn_user_name') || 'unknown', createdAt: ihGetFirebaseTimestamp()
        });
        var lotsSnapshot = await db.collection('packagingLots')
          .where('materialId', '==', materialId).where('locationId', '==', locationId).where('status', '==', 'active').get();
        var totalStock = lotsSnapshot.docs.reduce(function(sum, doc) { return sum + (doc.data().remainingQty || 0); }, 0);
        await db.collection('packagingMaterials').doc(materialId).update({ currentStock: totalStock, updatedAt: ihGetFirebaseTimestamp() });
        ihHideLoading();
        alert('入庫を登録しました（単価: ¥' + unitPrice + '、場所: ' + location.name + '）');
        ihLoadStockList();
      } catch (error) {
        ihHideLoading();
        console.error('[ih] 入庫登録エラー:', error);
        alert('入庫登録に失敗しました: ' + error.message);
      }
    }

    // ========================================
    // Stock Adjustment Modal
    // ========================================
    function ihShowStockAdjustmentModal(materialId) {
      var select = document.getElementById('ih-adjustMaterial');
      select.innerHTML = '<option value="">選択してください</option>' +
        ih_allMaterials.map(function(m) { return '<option value="' + m.id + '" ' + (m.id === materialId ? 'selected' : '') + '>' + ihEscapeHtml(m.productName || m.name) + ' (現在庫: ' + (m.currentStock || 0) + ')</option>'; }).join('');
      document.getElementById('ih-adjustQuantity').value = '';
      document.getElementById('ih-adjustReason').value = 'damaged';
      document.getElementById('ih-adjustNote').value = '';
      var modal = new bootstrap.Modal(document.getElementById('ih-stockAdjustmentModal'));
      modal.show();
    }

    async function ihProcessStockAdjustmentMaterial() {
      var materialId = document.getElementById('ih-adjustMaterial').value;
      var quantity = parseInt(document.getElementById('ih-adjustQuantity').value) || 0;
      var reason = document.getElementById('ih-adjustReason').value;
      var note = document.getElementById('ih-adjustNote').value;
      if (!materialId) { alert('資材を選択してください'); return; }
      if (quantity <= 0) { alert('減少数量を入力してください'); return; }
      var material = ih_allMaterials.find(function(m) { return m.id === materialId; });
      var materialName = material ? (material.productName || material.name) : '';
      if (!confirm('「' + materialName + '」の在庫を' + quantity + '個減少させます。\nよろしいですか？')) return;
      ihShowLoading();
      bootstrap.Modal.getInstance(document.getElementById('ih-stockAdjustmentModal'))?.hide();
      try {
        var db = ihGetDb();
        var location = await ihGetCurrentUserLocation();
        if (!location) throw new Error('場所の取得に失敗しました');
        var locationId = location.id;
        var lotsSnapshot = await db.collection('packagingLots')
          .where('materialId', '==', materialId).where('locationId', '==', locationId)
          .where('status', '==', 'active').orderBy('purchaseDate', 'desc').get();
        var remaining = quantity;
        var adjusted = [];
        for (var i = 0; i < lotsSnapshot.docs.length; i++) {
          if (remaining <= 0) break;
          var doc = lotsSnapshot.docs[i];
          var lot = doc.data();
          var toAdjust = Math.min(remaining, lot.remainingQty);
          var newRemainingQty = lot.remainingQty - toAdjust;
          var newStatus = newRemainingQty <= 0 ? 'depleted' : 'active';
          await db.collection('packagingLots').doc(doc.id).update({ remainingQty: newRemainingQty, status: newStatus, updatedAt: ihGetFirebaseTimestamp() });
          adjusted.push({ lotId: doc.id, quantity: toAdjust, unitPrice: lot.unitPrice });
          remaining -= toAdjust;
        }
        var reasonLabels = { damaged: '破損', lost: '紛失', discarded: '廃棄', other: 'その他' };
        await db.collection('packagingTransactions').add({
          materialId: materialId, materialName: materialName, locationId: locationId, type: '調整',
          quantity: -quantity, reason: reasonLabels[reason] || reason, adjustedLots: adjusted, note: note,
          createdBy: localStorage.getItem('reborn_user_name') || 'unknown', createdAt: ihGetFirebaseTimestamp()
        });
        var updatedLotsSnapshot = await db.collection('packagingLots')
          .where('materialId', '==', materialId).where('locationId', '==', locationId).where('status', '==', 'active').get();
        var totalStock = updatedLotsSnapshot.docs.reduce(function(sum, doc) { return sum + (doc.data().remainingQty || 0); }, 0);
        await db.collection('packagingMaterials').doc(materialId).update({ currentStock: totalStock, updatedAt: ihGetFirebaseTimestamp() });
        if (window.checkMaterialStockAlert) {
          await window.checkMaterialStockAlert(materialId, totalStock, locationId, location.name);
        }
        ihHideLoading();
        alert('在庫を調整しました（-' + quantity + '、場所: ' + location.name + '）');
        ihLoadStockList();
      } catch (error) {
        ihHideLoading();
        console.error('[ih] 在庫調整エラー:', error);
        alert('在庫調整に失敗しました: ' + error.message);
      }
    }

    // ========================================
    // Transfer (Admin)
    // ========================================
    async function ihShowTransferModal() {
      if (!ihIsAdmin()) { alert('管理者権限が必要です'); return; }
      var myLocation = await ihGetCurrentUserLocation();
      if (!myLocation) { alert('場所の取得に失敗しました'); return; }
      document.getElementById('ih-transferFromLocation').value = myLocation.name;
      document.getElementById('ih-transferFromLocationId').value = myLocation.id;
      var toSelect = document.getElementById('ih-transferToLocation');
      toSelect.innerHTML = '<option value="">選択してください</option>' +
        ih_allLocations.filter(function(loc) { return loc.id !== myLocation.id; }).map(function(loc) {
          var typeLabel = loc.type === 'user_home' ? '👤' : loc.type === 'warehouse' ? '🏭' : '🏢';
          return '<option value="' + loc.id + '">' + typeLabel + ' ' + ihEscapeHtml(loc.name) + '</option>';
        }).join('');
      var materialSelect = document.getElementById('ih-transferMaterial');
      var materialsWithStock = ih_allMaterials.filter(function(m) { return m.currentStock > 0; });
      materialSelect.innerHTML = '<option value="">選択してください</option>' +
        materialsWithStock.map(function(m) {
          return '<option value="' + m.id + '" data-stock="' + m.currentStock + '">' + ihEscapeHtml(m.productName || m.name) + ' (在庫: ' + m.currentStock + ')</option>';
        }).join('');
      document.getElementById('ih-transferQuantity').value = '';
      document.getElementById('ih-transferNote').value = '';
      document.getElementById('ih-transferAvailableStock').textContent = '現在庫: -';
      materialSelect.onchange = function() {
        var option = this.options[this.selectedIndex];
        var stock = option.dataset.stock || '-';
        document.getElementById('ih-transferAvailableStock').textContent = '現在庫: ' + stock;
      };
      var modal = new bootstrap.Modal(document.getElementById('ih-transferModal'));
      modal.show();
    }

    async function ihProcessTransfer() {
      var fromLocationId = document.getElementById('ih-transferFromLocationId').value;
      var toLocationId = document.getElementById('ih-transferToLocation').value;
      var materialId = document.getElementById('ih-transferMaterial').value;
      var quantity = parseInt(document.getElementById('ih-transferQuantity').value) || 0;
      var note = document.getElementById('ih-transferNote').value;
      if (!toLocationId) { alert('配布先を選択してください'); return; }
      if (!materialId) { alert('資材を選択してください'); return; }
      if (quantity <= 0) { alert('配布数量を入力してください'); return; }
      var material = ih_allMaterials.find(function(m) { return m.id === materialId; });
      var materialName = material ? (material.productName || material.name) : '';
      if (material && quantity > material.currentStock) { alert('在庫が不足しています（現在庫: ' + material.currentStock + '）'); return; }
      var toLocation = ih_allLocations.find(function(l) { return l.id === toLocationId; });
      var toLocationName = toLocation ? toLocation.name : '不明';
      if (!confirm('「' + materialName + '」を ' + toLocationName + ' に ' + quantity + '個 配布します。\nよろしいですか？')) return;
      ihShowLoading();
      bootstrap.Modal.getInstance(document.getElementById('ih-transferModal'))?.hide();
      try {
        var db = ihGetDb();
        var lotsSnapshot = await db.collection('packagingLots')
          .where('materialId', '==', materialId).where('locationId', '==', fromLocationId)
          .where('status', '==', 'active').orderBy('purchaseDate', 'asc').get();
        var remaining = quantity;
        var consumedLots = [];
        var totalCost = 0;
        for (var i = 0; i < lotsSnapshot.docs.length; i++) {
          if (remaining <= 0) break;
          var doc = lotsSnapshot.docs[i];
          var lot = doc.data();
          var toConsume = Math.min(remaining, lot.remainingQty);
          var newRemainingQty = lot.remainingQty - toConsume;
          var newStatus = newRemainingQty <= 0 ? 'depleted' : 'active';
          await db.collection('packagingLots').doc(doc.id).update({ remainingQty: newRemainingQty, status: newStatus, updatedAt: ihGetFirebaseTimestamp() });
          consumedLots.push({ lotId: doc.id, quantity: toConsume, unitPrice: lot.unitPrice });
          totalCost += toConsume * (lot.unitPrice || 0);
          remaining -= toConsume;
        }
        if (remaining > 0) throw new Error('在庫不足: ' + remaining + '個配布できませんでした');
        var avgUnitPrice = quantity > 0 ? Math.round(totalCost / quantity) : 0;
        var fromLocName = document.getElementById('ih-transferFromLocation').value;
        var newLotRef = await db.collection('packagingLots').add({
          materialId: materialId, locationId: toLocationId, quantity: quantity, remainingQty: quantity,
          unitPrice: avgUnitPrice, purchaseDate: ihGetFirebaseTimestamp(), supplier: '配布元: ' + fromLocName,
          notes: note || '配布による入庫', status: 'active',
          createdBy: localStorage.getItem('reborn_user_name') || 'unknown',
          createdAt: ihGetFirebaseTimestamp(), updatedAt: ihGetFirebaseTimestamp()
        });
        await db.collection('packagingTransactions').add({
          materialId: materialId, materialName: materialName, locationId: fromLocationId, type: '配布出',
          quantity: -quantity, toLocationId: toLocationId, toLocationName: toLocationName, consumedLots: consumedLots,
          note: note, createdBy: localStorage.getItem('reborn_user_name') || 'unknown', createdAt: ihGetFirebaseTimestamp()
        });
        await db.collection('packagingTransactions').add({
          materialId: materialId, materialName: materialName, locationId: toLocationId, type: '配布入',
          quantity: quantity, fromLocationId: fromLocationId, fromLocationName: fromLocName, lotId: newLotRef.id,
          note: note, createdBy: localStorage.getItem('reborn_user_name') || 'unknown', createdAt: ihGetFirebaseTimestamp()
        });
        var fromLotsSnapshot = await db.collection('packagingLots')
          .where('materialId', '==', materialId).where('locationId', '==', fromLocationId).where('status', '==', 'active').get();
        var fromTotalStock = fromLotsSnapshot.docs.reduce(function(sum, doc) { return sum + (doc.data().remainingQty || 0); }, 0);
        if (window.checkMaterialStockAlert) {
          await window.checkMaterialStockAlert(materialId, fromTotalStock, fromLocationId, fromLocName);
        }
        ihHideLoading();
        alert('配布完了: ' + materialName + ' ' + quantity + '個 → ' + toLocationName);
        ihLoadStockList();
      } catch (error) {
        ihHideLoading();
        console.error('[ih] 配布エラー:', error);
        alert('配布に失敗しました: ' + error.message);
      }
    }

    // ========================================
    // Threshold Settings (Admin)
    // ========================================
    async function ihShowThresholdSettingsModal() {
      if (!ihIsAdmin()) { alert('管理者権限が必要です'); return; }
      var locationSelect = document.getElementById('ih-thresholdLocationSelect');
      locationSelect.innerHTML = '<option value="">選択してください</option>' +
        ih_allLocations.filter(function(loc) { return loc.type === 'user_home'; })
          .map(function(loc) { return '<option value="' + loc.id + '">👤 ' + ihEscapeHtml(loc.name) + '</option>'; }).join('');
      document.getElementById('ih-thresholdSettingsContainer').style.display = 'none';
      document.getElementById('ih-thresholdNoLocationSelected').style.display = 'block';
      document.getElementById('ih-thresholdMaterialList').innerHTML = '';
      var modal = new bootstrap.Modal(document.getElementById('ih-thresholdSettingsModal'));
      modal.show();
    }

    async function ihLoadLocationThresholds() {
      var locationId = document.getElementById('ih-thresholdLocationSelect').value;
      var container = document.getElementById('ih-thresholdSettingsContainer');
      var noSelection = document.getElementById('ih-thresholdNoLocationSelected');
      var materialList = document.getElementById('ih-thresholdMaterialList');
      if (!locationId) { container.style.display = 'none'; noSelection.style.display = 'block'; return; }
      container.style.display = 'block';
      noSelection.style.display = 'none';
      materialList.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div> 読み込み中...</div>';
      try {
        var db = ihGetDb();
        var locationDoc = await db.collection('packagingLocations').doc(locationId).get();
        var materialThresholds = locationDoc.exists ? (locationDoc.data().materialThresholds || {}) : {};
        var html = '<div class="list-group">';
        ih_allMaterials.forEach(function(material) {
          var materialId = material.id;
          var materialName = material.productName || material.name || '不明な資材';
          var globalThreshold = material.stockAlertThreshold || 0;
          var localThreshold = materialThresholds[materialId] !== undefined ? materialThresholds[materialId] : '';
          html += '<div class="list-group-item d-flex justify-content-between align-items-center"><div class="me-3 flex-grow-1"><div class="fw-bold">' + ihEscapeHtml(materialName) + '</div><small class="text-muted">グローバル閾値: ' + (globalThreshold > 0 ? globalThreshold + '個' : '未設定') + '</small></div><div class="d-flex align-items-center" style="min-width: 120px;"><input type="number" class="form-control form-control-sm text-end" id="ih-threshold_' + materialId + '" value="' + localThreshold + '" min="0" placeholder="' + (globalThreshold || '0') + '" style="width: 80px; font-size: 16px;"><span class="ms-1 text-muted small">個</span></div></div>';
        });
        html += '</div>';
        materialList.innerHTML = html;
      } catch (error) {
        console.error('[ih] 閾値読み込みエラー:', error);
        materialList.innerHTML = '<div class="text-danger text-center py-3">エラー: ' + error.message + '</div>';
      }
    }

    async function ihSaveLocationThresholds() {
      var locationId = document.getElementById('ih-thresholdLocationSelect').value;
      if (!locationId) { alert('ユーザー（場所）を選択してください'); return; }
      var db = ihGetDb();
      var materialThresholds = {};
      ih_allMaterials.forEach(function(material) {
        var input = document.getElementById('ih-threshold_' + material.id);
        if (input) {
          var value = parseInt(input.value) || 0;
          if (value > 0) materialThresholds[material.id] = value;
        }
      });
      ihShowLoading();
      try {
        await db.collection('packagingLocations').doc(locationId).update({ materialThresholds: materialThresholds, updatedAt: ihGetFirebaseTimestamp() });
        ihHideLoading();
        var locationName = document.getElementById('ih-thresholdLocationSelect').selectedOptions[0].text;
        var count = Object.keys(materialThresholds).length;
        alert('閾値設定を保存しました\n場所: ' + locationName + '\n設定数: ' + count + '件');
      } catch (error) {
        ihHideLoading();
        console.error('[ih] 閾値保存エラー:', error);
        alert('保存に失敗しました: ' + error.message);
      }
    }

    // ========================================
    // Orders Tab
    // ========================================
    async function ihLoadOrdersList() {
      var container = document.getElementById('ih-ordersList');
      if (!container) return;
      container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div></div>';
      try {
        var db = ihGetDb();
        if (!db) { container.innerHTML = '<div class="text-center text-danger py-4">Firestoreに接続できません</div>'; return; }
        var snapshot = await db.collection('packagingOrders').orderBy('orderedAt', 'desc').limit(50).get();
        ih_allOrders = snapshot.docs.map(function(doc) {
          var d = doc.data();
          return { id: doc.id, ...d, orderedAt: d.orderedAt?.toDate?.() || d.orderedAt };
        });
        ihRenderOrdersList();
      } catch (error) {
        console.error('[ih] 発注一覧取得エラー:', error);
        container.innerHTML = '<div class="text-center text-danger py-4">エラー: ' + error.message + '</div>';
      }
    }

    function ihRenderOrdersList() {
      var container = document.getElementById('ih-ordersList');
      if (!container) return;
      var statusFilter = document.getElementById('ih-orderStatusFilter').value;
      var filtered = ih_allOrders;
      if (statusFilter) filtered = filtered.filter(function(o) { return o.status === statusFilter; });
      if (filtered.length === 0) { container.innerHTML = '<div class="text-center text-muted py-4">該当する発注がありません</div>'; return; }
      container.innerHTML = filtered.map(function(order) {
        var statusBadge = order.status === 'ordered' ? '<span class="badge bg-warning">発注中</span>'
          : order.status === 'received' ? '<span class="badge bg-success">入荷済み</span>'
          : order.status === 'cancelled' ? '<span class="badge bg-secondary">キャンセル</span>'
          : '<span class="badge bg-light text-dark">' + ihEscapeHtml(order.status) + '</span>';
        var cardClass = order.status === 'ordered' ? 'order-pending' : order.status === 'received' ? 'order-received' : '';
        return '<div class="order-card ' + cardClass + '"><div class="order-card-header"><span class="order-card-date">' + ihFormatDateTime(order.orderedAt || order.createdAt) + '</span>' + statusBadge + '</div><div class="order-card-body"><div><div class="order-material">' + ihEscapeHtml(order.materialName) + '</div>' + (order.supplier ? '<div class="text-muted small">' + ihEscapeHtml(order.supplier) + '</div>' : '') + '</div><div class="order-quantity">' + order.quantity + '個</div></div>' +
          (order.status === 'ordered' ? '<div class="mt-2 d-flex gap-2 justify-content-end"><button class="btn btn-sm btn-success" onclick="ihShowReceiveModal(\'' + order.id + '\')"><i class="bi bi-check"></i> 入荷</button><button class="btn btn-sm btn-outline-secondary" onclick="ihCancelOrderMaterial(\'' + order.id + '\')">キャンセル</button></div>' : '') +
          '</div>';
      }).join('');
    }

    // ========================================
    // Order Modal
    // ========================================
    async function ihShowOrderModalMaterial(materialId) {
      if (ih_allMaterials.length === 0) {
        try {
          var db = ihGetDb();
          var snapshot = await db.collection('packagingMaterials').get();
          ih_allMaterials = snapshot.docs.map(function(doc) { return { id: doc.id, ...doc.data() }; });
        } catch (error) { console.error('[ih] 資材データ取得エラー:', error); }
      }
      ihPopulateOrderMaterialSelect(materialId);
    }

    function ihPopulateOrderMaterialSelect(materialId) {
      var select = document.getElementById('ih-orderMaterial');
      select.innerHTML = '<option value="">選択してください</option>' +
        ih_allMaterials.map(function(m) { return '<option value="' + m.id + '" ' + (m.id === materialId ? 'selected' : '') + '>' + ihEscapeHtml(m.productName || m.name) + '</option>'; }).join('');
      if (materialId) {
        var material = ih_allMaterials.find(function(m) { return m.id === materialId; });
        if (material && material.supplier) document.getElementById('ih-orderSupplier').value = material.supplier;
      }
      document.getElementById('ih-orderQuantity').value = '';
      document.getElementById('ih-orderNote').value = '';
      var modal = new bootstrap.Modal(document.getElementById('ih-orderModal'));
      modal.show();
    }

    async function ihProcessOrderMaterial() {
      var materialId = document.getElementById('ih-orderMaterial').value;
      var quantity = parseInt(document.getElementById('ih-orderQuantity').value) || 0;
      var supplier = document.getElementById('ih-orderSupplier').value;
      var note = document.getElementById('ih-orderNote').value;
      if (!materialId) { alert('資材を選択してください'); return; }
      if (quantity <= 0) { alert('数量を入力してください'); return; }
      var material = ih_allMaterials.find(function(m) { return m.id === materialId; });
      var materialName = material ? (material.productName || material.name) : '';
      ihShowLoading();
      bootstrap.Modal.getInstance(document.getElementById('ih-orderModal'))?.hide();
      try {
        var db = ihGetDb();
        await db.collection('packagingOrders').add({
          materialId: materialId, materialName: materialName, quantity: quantity, supplier: supplier,
          note: note, status: 'ordered', orderedAt: ihGetFirebaseTimestamp(),
          createdBy: localStorage.getItem('reborn_user_name') || 'unknown'
        });
        ihHideLoading();
        alert('発注を登録しました');
        ihLoadOrdersList();
      } catch (error) {
        ihHideLoading();
        console.error('[ih] 発注登録エラー:', error);
        alert('発注登録に失敗しました: ' + error.message);
      }
    }

    // ========================================
    // Receive Modal
    // ========================================
    function ihShowReceiveModal(orderId) {
      var order = ih_allOrders.find(function(o) { return o.id === orderId; });
      if (!order) { alert('発注が見つかりません'); return; }
      document.getElementById('ih-receiveOrderId').value = orderId;
      document.getElementById('ih-receiveMaterialId').value = order.materialId;
      document.getElementById('ih-receiveMaterialName').value = order.materialName;
      document.getElementById('ih-receiveOrderedQuantity').value = order.quantity;
      document.getElementById('ih-receiveActualQuantity').value = order.quantity;
      document.getElementById('ih-receivePrice').value = '';
      var modal = new bootstrap.Modal(document.getElementById('ih-receiveModal'));
      modal.show();
    }

    async function ihProcessReceiveOrderMaterial() {
      var orderId = document.getElementById('ih-receiveOrderId').value;
      var materialId = document.getElementById('ih-receiveMaterialId').value;
      var materialName = document.getElementById('ih-receiveMaterialName').value;
      var actualQuantity = parseInt(document.getElementById('ih-receiveActualQuantity').value) || 0;
      var price = parseFloat(document.getElementById('ih-receivePrice').value) || 0;
      if (actualQuantity <= 0) { alert('入荷数量を入力してください'); return; }
      ihShowLoading();
      bootstrap.Modal.getInstance(document.getElementById('ih-receiveModal'))?.hide();
      try {
        var db = ihGetDb();
        await db.collection('packagingOrders').doc(orderId).update({ status: 'received', receivedAt: ihGetFirebaseTimestamp() });
        await db.collection('packagingTransactions').add({
          materialId: materialId, materialName: materialName, type: '入庫', quantity: actualQuantity,
          purchasePrice: price, unitCost: price > 0 && actualQuantity > 0 ? price / actualQuantity : 0,
          reason: '発注入荷', orderId: orderId,
          createdBy: localStorage.getItem('reborn_user_name') || 'unknown', createdAt: ihGetFirebaseTimestamp()
        });
        var materialRef = db.collection('packagingMaterials').doc(materialId);
        var materialDoc = await materialRef.get();
        var currentStock = materialDoc.exists ? (materialDoc.data().currentStock || 0) : 0;
        await materialRef.update({ currentStock: currentStock + actualQuantity, updatedAt: ihGetFirebaseTimestamp() });
        await ihCompleteStockReplenishmentTasks(materialId, materialName, actualQuantity);
        await ihSendMaterialArrivalNotification(materialName, actualQuantity);
        ihHideLoading();
        alert('入荷処理が完了しました');
        ihLoadOrdersList();
        if (ih_currentTab === 'stock') ihLoadStockList();
      } catch (error) {
        ihHideLoading();
        console.error('[ih] 入荷処理エラー:', error);
        alert('入荷処理に失敗しました: ' + error.message);
      }
    }

    async function ihCompleteStockReplenishmentTasks(materialId, materialName, quantity) {
      try {
        var db = ihGetDb();
        var usersSnapshot = await db.collection('users').where('status', '==', 'active').get();
        for (var i = 0; i < usersSnapshot.docs.length; i++) {
          var userDoc = usersSnapshot.docs[i];
          var user = userDoc.data();
          if (user.permission !== 'owner' && user.permission !== 'admin') continue;
          var tasksSnapshot = await db.collection('userTasks').doc(user.email).collection('tasks')
            .where('type', '==', 'stock_replenishment').where('completed', '==', false).get();
          for (var j = 0; j < tasksSnapshot.docs.length; j++) {
            var taskDoc = tasksSnapshot.docs[j];
            var task = taskDoc.data();
            if (task.relatedData?.materialId === materialId) {
              await db.collection('userTasks').doc(user.email).collection('tasks').doc(taskDoc.id).update({
                completed: true, completedAt: new Date().toISOString(), completedReason: '入荷完了: ' + quantity + '個'
              });
            }
          }
        }
      } catch (error) { console.error('[ih] タスク完了処理エラー:', error); }
    }

    async function ihSendMaterialArrivalNotification(materialName, quantity) {
      try {
        var db = ihGetDb();
        var roomId = 'room_inventory_alert';
        var messageText = '✅ 入荷完了\n📦 ' + materialName + '\n入荷数量: ' + quantity + '個\n補充完了しました！';
        await db.collection('messages').add({
          roomId: roomId, text: messageText, userName: 'システム', userEmail: 'system@reborn-inventory.com',
          createdAt: ihGetFirebaseTimestamp(), isSystemMessage: true
        });
        await db.collection('rooms').doc(roomId).update({
          lastMessage: messageText.split('\n')[0], lastMessageAt: ihGetFirebaseTimestamp(), lastMessageBy: 'システム'
        });
        var usersSnapshot = await db.collection('users').where('status', '==', 'active').get();
        var allTokens = [];
        usersSnapshot.docs.forEach(function(doc) {
          var user = doc.data();
          if (user.activeDevices && Array.isArray(user.activeDevices)) {
            user.activeDevices.forEach(function(device) { if (device.fcmToken) allTokens.push(device.fcmToken); });
          }
          if (user.fcmToken) allTokens.push(user.fcmToken);
        });
        if (allTokens.length > 0) {
          var FCM_WORKER_URL = 'https://reborn-fcm-worker.antigravity-llc.workers.dev';
          await fetch(FCM_WORKER_URL + '/send', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              tokens: allTokens, title: '✅ 資材入荷: ' + materialName,
              body: quantity + '個入荷しました', data: { type: 'material_arrival', roomId: 'room_inventory_alert' }
            })
          });
        }
      } catch (error) { console.error('[ih] 入荷通知エラー:', error); }
    }

    async function ihCancelOrderMaterial(orderId) {
      if (!confirm('この発注をキャンセルしますか？')) return;
      ihShowLoading();
      try {
        var db = ihGetDb();
        await db.collection('packagingOrders').doc(orderId).update({ status: 'cancelled' });
        ihHideLoading();
        alert('発注をキャンセルしました');
        ihLoadOrdersList();
      } catch (error) {
        ihHideLoading();
        console.error('[ih] 発注キャンセルエラー:', error);
        alert('キャンセルに失敗しました: ' + error.message);
      }
    }

    // ========================================
    // Lifecycle: Init & Destroy
    // ========================================
    function initInventoryHistoryPage() {
      console.log('[ih] initInventoryHistoryPage called');

      _ih_dropdownClickHandler = function(e) {
        var dropdown = document.getElementById('ih-settingsDropdown');
        if (dropdown && !e.target.closest('.ih-settings-dropdown') && !e.target.closest('.sub-header-icon')) {
          dropdown.classList.remove('show');
        }
      };
      document.addEventListener('click', _ih_dropdownClickHandler);

      ihInitializePeriodFilters();
      ihLoadMaterialsList();
      ihShowInitialMessage();
      ihInitializeAdminUI();

      ihAddListener(document.getElementById('ih-filterCategory'), 'change', function() { ihFilterMaterialsByCategory(this.value); });
      ihAddListener(document.getElementById('ih-btnAllPeriod'), 'click', ihSetAllPeriod);
      ihAddListener(document.getElementById('ih-btnThisMonth'), 'click', ihSetThisMonth);
      ihAddListener(document.getElementById('ih-btnLastMonth'), 'click', ihSetLastMonth);
      ihAddListener(document.getElementById('ih-filterYear'), 'change', ihUpdatePeriodFromYearMonth);
      ihAddListener(document.getElementById('ih-filterMonth'), 'change', ihUpdatePeriodFromYearMonth);
      ihAddListener(document.getElementById('ih-btnSearch'), 'click', ihLoadHistoryData);
      ihAddListener(document.getElementById('ih-btnReset'), 'click', ihResetFilters);
      ihAddListener(document.getElementById('ih-adminLocationFilter'), 'change', function() {
        ih_selectedLocationId = this.value || null;
        ihLoadStockList();
      });
      ihAddListener(document.getElementById('ih-stockCategoryFilter'), 'change', function() { ihRenderStockList(ih_allMaterials); });
      ihAddListener(document.getElementById('ih-showLowStockOnly'), 'change', function() { ihRenderStockList(ih_allMaterials); });
      ihAddListener(document.getElementById('ih-orderStatusFilter'), 'change', function() { ihRenderOrdersList(); });

      ihLoadStockList();
    }

    function destroyInventoryHistoryPage() {
      console.log('[ih] destroyInventoryHistoryPage called');
      _ih_eventListeners.forEach(function(item) {
        item.el.removeEventListener(item.event, item.handler, item.options);
      });
      _ih_eventListeners = [];
      if (_ih_dropdownClickHandler) {
        document.removeEventListener('click', _ih_dropdownClickHandler);
        _ih_dropdownClickHandler = null;
      }
      ['ih-stockInModal', 'ih-stockAdjustmentModal', 'ih-orderModal', 'ih-receiveModal', 'ih-transferModal', 'ih-thresholdSettingsModal'].forEach(function(id) {
        var el = document.getElementById(id);
        if (el) {
          var instance = bootstrap.Modal.getInstance(el);
          if (instance) instance.hide();
        }
      });
      document.querySelectorAll('.modal-backdrop').forEach(function(el) { el.remove(); });
      document.body.classList.remove('modal-open');
      document.body.style.removeProperty('overflow');
      document.body.style.removeProperty('padding-right');
      ih_currentHistoryData = [];
      ih_allMaterials = [];
      ih_allLocations = [];
      ih_selectedLocationId = null;
      ih_currentPage = 1;
      ih_currentTab = 'stock';
      ih_allOrders = [];
      _ih_currentLocation = null;
    }
  </script>
</div>
