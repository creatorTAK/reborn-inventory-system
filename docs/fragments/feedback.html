<!-- SPA Fragment: feedback (フィードバック送信) -->
<div id="spa-page-feedback">
  <style>
    #spa-page-feedback {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: #f8f9fa;
      min-height: 100vh;
    }
    #spa-page-feedback .page-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #ffffff;
      padding: 12px 16px;
      padding-top: calc(12px + env(safe-area-inset-top, 0px));
      display: flex;
      align-items: center;
      z-index: 1000;
      border-bottom: 1px solid #e5e7eb;
    }
    #spa-page-feedback .page-header h1 {
      font-size: 17px;
      font-weight: 600;
      margin: 0;
      color: #111827;
      flex: 1;
      text-align: center;
      padding-right: 28px;
    }
    #spa-page-feedback .page-header .back-button {
      background: none;
      border: none;
      padding: 8px;
      margin: -8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #374151;
      font-size: 20px;
    }
    #spa-page-feedback .page-header .back-button:active { opacity: 0.6; }
    #spa-page-feedback .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      padding-top: calc(70px + env(safe-area-inset-top, 0px));
    }
    #spa-page-feedback .page-description { color: #6b7280; font-size: 14px; margin-bottom: 24px; line-height: 1.6; }
    #spa-page-feedback .form-group { margin-bottom: 20px; }
    #spa-page-feedback .form-label { display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px; }
    #spa-page-feedback .form-label .required { color: #ef4444; margin-left: 4px; }
    #spa-page-feedback .form-select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 16px;
      font-family: inherit;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      color: #374151;
    }
    #spa-page-feedback .form-select:focus { outline: none; border-color: #3b82f6; background: #f9fafb; }
    #spa-page-feedback .form-textarea {
      width: 100%;
      min-height: 150px;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
      font-family: inherit;
      resize: vertical;
      transition: border-color 0.2s;
      box-sizing: border-box;
    }
    #spa-page-feedback .form-textarea:focus { outline: none; border-color: #40B4E5; }
    #spa-page-feedback .form-textarea::placeholder { color: #9ca3af; }
    #spa-page-feedback .char-count { text-align: right; font-size: 12px; color: #9ca3af; margin-top: 4px; }
    #spa-page-feedback .submit-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: opacity 0.2s;
    }
    #spa-page-feedback .submit-btn:hover { opacity: 0.9; }
    #spa-page-feedback .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    #spa-page-feedback .submit-btn .spinner {
      width: 20px; height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: fbSpin 0.8s linear infinite;
    }
    @keyframes fbSpin { to { transform: rotate(360deg); } }
    #spa-page-feedback .success-message { display: none; text-align: center; padding: 40px 20px; }
    #spa-page-feedback .success-message.show { display: block; }
    #spa-page-feedback .success-message i { font-size: 64px; color: #10b981; margin-bottom: 16px; }
    #spa-page-feedback .success-message h2 { font-size: 20px; color: #374151; margin-bottom: 8px; }
    #spa-page-feedback .success-message p { color: #6b7280; margin-bottom: 24px; }
    #spa-page-feedback .success-message .back-to-mypage {
      display: inline-block; padding: 12px 24px; background: #40B4E5; color: white;
      border-radius: 8px; text-decoration: none; font-weight: 600; cursor: pointer;
    }
    #spa-page-feedback .form-container { display: block; }
    #spa-page-feedback .form-container.hide { display: none; }
    #spa-page-feedback .note {
      background: #fef3c7; border-radius: 8px; padding: 12px; font-size: 13px; color: #92400e; margin-bottom: 20px;
    }
    #spa-page-feedback .note i { margin-right: 6px; }
    #spa-page-feedback .image-upload-area {
      border: 2px dashed #e5e7eb; border-radius: 12px; padding: 20px; text-align: center;
      cursor: pointer; transition: all 0.2s; background: white;
    }
    #spa-page-feedback .image-upload-area:hover { border-color: #40B4E5; background: #f0f9ff; }
    #spa-page-feedback .image-upload-area.has-image { border-style: solid; border-color: #40B4E5; }
    #spa-page-feedback .image-upload-area i { font-size: 32px; color: #9ca3af; margin-bottom: 8px; }
    #spa-page-feedback .image-upload-area p { color: #6b7280; font-size: 14px; margin: 0; }
    #spa-page-feedback .image-upload-area .hint { font-size: 12px; color: #9ca3af; margin-top: 4px; }
    #spa-page-feedback .image-preview-container { display: none; position: relative; margin-top: 12px; }
    #spa-page-feedback .image-preview-container.show { display: block; }
    #spa-page-feedback .image-preview { max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid #e5e7eb; }
    #spa-page-feedback .remove-image-btn {
      position: absolute; top: -8px; right: -8px; width: 28px; height: 28px; border-radius: 50%;
      background: #ef4444; color: white; border: none; cursor: pointer; display: flex;
      align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    #spa-page-feedback .remove-image-btn:hover { background: #dc2626; }
    #spa-page-feedback .upload-progress { display: none; margin-top: 8px; }
    #spa-page-feedback .upload-progress.show { display: block; }
    #spa-page-feedback .progress-bar { height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden; }
    #spa-page-feedback .progress-bar-fill { height: 100%; background: #40B4E5; width: 0%; transition: width 0.3s; }
    #spa-page-feedback .progress-text { font-size: 12px; color: #6b7280; margin-top: 4px; }
  </style>

  <div class="page-header">
    <button class="back-button" onclick="spaGoBack()">
      <i class="bi bi-chevron-left"></i>
    </button>
    <h1>フィードバック送信</h1>
  </div>

  <div class="container">
    <div class="form-container" id="fb-formContainer">
      <p class="page-description">
        機能のご要望やバグのご報告など、お気軽にお寄せください。<br>
        いただいたご意見はサービス改善に活用させていただきます。
      </p>
      <div class="note">
        <i class="bi bi-info-circle"></i>
        返信が必要な場合は、内容に連絡先をご記入ください。
      </div>
      <form id="fb-feedbackForm" onsubmit="fbSubmitFeedback(event)">
        <div class="form-group">
          <label class="form-label" for="fb-feedbackType">種類<span class="required">*</span></label>
          <select class="form-select" id="fb-feedbackType" name="type" required>
            <option value="">-- 選択してください --</option>
            <option value="feature">機能要望</option>
            <option value="bug">バグ報告</option>
            <option value="other">その他</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" for="fb-feedbackContent">内容<span class="required">*</span></label>
          <textarea
            class="form-textarea"
            id="fb-feedbackContent"
            name="content"
            placeholder="できるだけ具体的にお書きください。&#10;&#10;バグ報告の場合：&#10;・どの画面で発生したか&#10;・どのような操作をしたか&#10;・どのようなエラーが出たか"
            required
            maxlength="2000"
            oninput="fbUpdateCharCount()"
          ></textarea>
          <div class="char-count"><span id="fb-charCount">0</span> / 2000</div>
        </div>
        <div class="form-group">
          <label class="form-label">スクリーンショット（任意）</label>
          <div class="image-upload-area" id="fb-imageUploadArea" onclick="document.getElementById('fb-imageInput').click()">
            <i class="bi bi-image"></i>
            <p>タップして画像を選択</p>
            <p class="hint">PNG, JPG, JPEG（最大5MB）</p>
          </div>
          <input type="file" id="fb-imageInput" accept="image/png,image/jpeg,image/jpg" style="display: none" onchange="fbHandleImageSelect(event)">
          <div class="image-preview-container" id="fb-imagePreviewContainer">
            <img id="fb-imagePreview" class="image-preview" src="" alt="プレビュー">
            <button type="button" class="remove-image-btn" onclick="fbRemoveImage()">
              <i class="bi bi-x"></i>
            </button>
          </div>
          <div class="upload-progress" id="fb-uploadProgress">
            <div class="progress-bar">
              <div class="progress-bar-fill" id="fb-progressBarFill"></div>
            </div>
            <p class="progress-text" id="fb-progressText">アップロード中...</p>
          </div>
        </div>
        <button type="submit" class="submit-btn" id="fb-submitBtn">
          <i class="bi bi-send"></i>
          送信する
        </button>
      </form>
    </div>
    <div class="success-message" id="fb-successMessage">
      <i class="bi bi-check-circle"></i>
      <h2>送信完了</h2>
      <p>フィードバックをお寄せいただき、<br>ありがとうございます。</p>
      <span class="back-to-mypage" onclick="spaGoBack()">マイページに戻る</span>
    </div>
  </div>
</div>

<script>
  var _fbSelectedImageFile = null;

  function initFeedbackPage() {
    // 初期化（フォームリセット）
    var form = document.getElementById('fb-feedbackForm');
    if (form) form.reset();
    var charCount = document.getElementById('fb-charCount');
    if (charCount) charCount.textContent = '0';
    document.getElementById('fb-formContainer').classList.remove('hide');
    document.getElementById('fb-successMessage').classList.remove('show');
    _fbSelectedImageFile = null;
  }

  function destroyFeedbackPage() {
    _fbSelectedImageFile = null;
  }

  function fbHandleImageSelect(event) {
    var file = event.target.files[0];
    if (!file) return;
    if (file.size > 5 * 1024 * 1024) {
      alert('画像サイズは5MB以下にしてください');
      event.target.value = '';
      return;
    }
    if (!file.type.match(/^image\/(png|jpeg|jpg)$/)) {
      alert('PNG、JPG、JPEG形式の画像を選択してください');
      event.target.value = '';
      return;
    }
    _fbSelectedImageFile = file;
    var reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('fb-imagePreview').src = e.target.result;
      document.getElementById('fb-imagePreviewContainer').classList.add('show');
      document.getElementById('fb-imageUploadArea').classList.add('has-image');
    };
    reader.readAsDataURL(file);
  }

  function fbRemoveImage() {
    _fbSelectedImageFile = null;
    document.getElementById('fb-imageInput').value = '';
    document.getElementById('fb-imagePreview').src = '';
    document.getElementById('fb-imagePreviewContainer').classList.remove('show');
    document.getElementById('fb-imageUploadArea').classList.remove('has-image');
  }

  function fbUpdateCharCount() {
    var content = document.getElementById('fb-feedbackContent').value;
    document.getElementById('fb-charCount').textContent = content.length;
  }

  async function fbUploadImage(file) {
    // 親のFirebase Storageインスタンスを使用
    var storage = window.firebaseStorage;
    var storageRefFn = window.storageRef;
    var uploadBytesFn = window.storageUploadBytes;
    var getDownloadURLFn = window.storageGetDownloadURL;

    var timestamp = Date.now();
    var randomStr = Math.random().toString(36).substring(2, 8);
    var extension = file.name.split('.').pop();
    var fileName = 'feedback/' + timestamp + '_' + randomStr + '.' + extension;

    var fileRef = storageRefFn(storage, fileName);

    var progressContainer = document.getElementById('fb-uploadProgress');
    var progressBar = document.getElementById('fb-progressBarFill');
    var progressText = document.getElementById('fb-progressText');
    progressContainer.classList.add('show');
    progressText.textContent = 'アップロード中...';
    progressBar.style.width = '50%';

    await uploadBytesFn(fileRef, file);
    progressBar.style.width = '100%';
    var downloadURL = await getDownloadURLFn(fileRef);
    progressContainer.classList.remove('show');
    return downloadURL;
  }

  async function fbSubmitFeedback(event) {
    event.preventDefault();

    var feedbackType = document.getElementById('fb-feedbackType').value;
    if (!feedbackType) { alert('種類を選択してください'); return; }

    var content = document.getElementById('fb-feedbackContent').value.trim();
    if (!content) { alert('内容を入力してください'); return; }

    var submitBtn = document.getElementById('fb-submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<div class="spinner"></div> 送信中...';

    try {
      // 親のFirestoreインスタンスを使用
      var db = window.firebaseDB;
      var collectionFn = window.firestoreCollection;
      var addDocFn = window.firestoreAddDoc;
      var serverTimestampFn = window.firestoreServerTimestamp;

      // 画像アップロード
      var imageUrl = null;
      if (_fbSelectedImageFile) {
        try {
          imageUrl = await fbUploadImage(_fbSelectedImageFile);
        } catch (uploadError) {
          console.error('画像アップロードエラー:', uploadError);
          var continueWithoutImage = confirm('画像のアップロードに失敗しました。画像なしで送信しますか？');
          if (!continueWithoutImage) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-send"></i> 送信する';
            document.getElementById('fb-uploadProgress').classList.remove('show');
            return;
          }
        }
      }

      var userId = localStorage.getItem('reborn_user_id') || '';
      var userEmail = localStorage.getItem('reborn_user_email') || '';
      var userName = localStorage.getItem('reborn_user_name') || '';

      var feedbackData = {
        type: feedbackType,
        content: content,
        userId: userId,
        userEmail: userEmail,
        userName: userName,
        deviceInfo: {
          userAgent: navigator.userAgent,
          platform: navigator.platform,
          language: navigator.language,
          screenWidth: screen.width,
          screenHeight: screen.height
        },
        status: 'new',
        createdAt: serverTimestampFn()
      };

      if (imageUrl) feedbackData.imageUrl = imageUrl;

      var docRef = await addDocFn(collectionFn(db, 'feedback'), feedbackData);

      // メール通知
      fbSendEmailNotification(feedbackData, docRef.id, imageUrl);

      document.getElementById('fb-formContainer').classList.add('hide');
      document.getElementById('fb-successMessage').classList.add('show');

    } catch (error) {
      console.error('送信エラー:', error);
      alert('送信に失敗しました。もう一度お試しください。');
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="bi bi-send"></i> 送信する';
    }
  }

  async function fbSendEmailNotification(feedbackData, docId, imageUrl) {
    try {
      var typeLabels = { 'feature': '機能要望', 'bug': 'バグ報告', 'other': 'その他' };
      var typeLabel = typeLabels[feedbackData.type] || feedbackData.type;
      var subject = '[フリラ] ' + typeLabel + 'が届きました';

      var body = 'フィードバックが届きました。\n\n';
      body += '【種類】' + typeLabel + '\n';
      body += '【送信者】' + (feedbackData.userName || '未登録') + ' (' + (feedbackData.userEmail || '不明') + ')\n';
      body += '【送信日時】' + new Date().toLocaleString('ja-JP') + '\n';
      body += '【ID】' + docId + '\n\n';
      body += '【内容】\n' + feedbackData.content + '\n';
      if (imageUrl) body += '\n【添付画像】\n' + imageUrl + '\n';
      body += '\n【デバイス情報】\n';
      body += 'プラットフォーム: ' + feedbackData.deviceInfo.platform + '\n';
      body += '画面サイズ: ' + feedbackData.deviceInfo.screenWidth + 'x' + feedbackData.deviceInfo.screenHeight + '\n';
      body += '言語: ' + feedbackData.deviceInfo.language + '\n';

      await fetch('https://reborn-fcm-worker.mercari-yasuhirotakuji.workers.dev/send-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ to: 'support@furira.jp', subject: subject, body: body })
      });
    } catch (error) {
      console.error('メール通知エラー:', error);
    }
  }
</script>
