<!-- SPA Fragment: master-management.html -->
<!-- Prefix: mst- (CSS scoped, element IDs kept compatible with master-manager.js) -->
<div id="spa-page-master-management">
  <style>
    #spa-page-master-management {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      background: #f5f6fa;
      padding-bottom: 80px;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
      margin: 0;
      padding: 0;
    }

    #spa-page-master-management * {
      box-sizing: border-box;
    }

    /* ヘッダー - reborn-theme.cssの統一ヘッダーを使用 */

    /* マスタ種別選択 */
    #spa-page-master-management .master-selector-container {
      max-width: 800px;
      margin: 16px auto;
      padding: 0 16px;
    }

    #spa-page-master-management .master-selector {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    #spa-page-master-management .master-selector-label {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      display: block;
    }

    #spa-page-master-management .master-selector-dropdown {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.2s;
      background: white;
      cursor: pointer;
    }

    #spa-page-master-management .master-selector-dropdown:focus {
      border-color: #40B4E5;
    }

    /* 検索バー */
    #spa-page-master-management .search-container {
      max-width: 800px;
      margin: 16px auto;
      padding: 0 16px;
    }

    #spa-page-master-management .search-box {
      position: relative;
    }

    #spa-page-master-management .search-input {
      width: 100%;
      padding: 12px 40px 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.2s;
      background: white;
    }

    #spa-page-master-management .search-input:focus {
      border-color: #40B4E5;
    }

    #spa-page-master-management .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
      font-size: 18px;
    }

    #spa-page-master-management .search-result-count {
      position: absolute;
      right: 40px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      color: #666;
      background: #f0f0f0;
      padding: 2px 8px;
      border-radius: 10px;
    }

    #spa-page-master-management .search-result-count:empty {
      display: none;
    }

    /* 拡張機能バー */
    #spa-page-master-management .action-bar {
      max-width: 800px;
      margin: 0 auto 16px;
      padding: 16px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      width: calc(100% - 32px);
      max-width: 800px;
    }

    #spa-page-master-management .stats-info {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #666;
      font-weight: 600;
    }

    #spa-page-master-management .stats-info i {
      color: #40B4E5;
      font-size: 18px;
    }

    #spa-page-master-management .action-buttons {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #spa-page-master-management .btn-action {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    #spa-page-master-management .btn-add {
      background: #40B4E5;
      color: white;
    }

    #spa-page-master-management .btn-add:active {
      transform: scale(0.95);
      background: #3a9ae6;
    }

    #spa-page-master-management .btn-select {
      background: #f5f5f5;
      color: #666;
    }

    #spa-page-master-management .btn-select:active {
      background: #e0e0e0;
    }

    #spa-page-master-management .btn-select.active {
      background: #40B4E5;
      color: white;
    }

    /* 登録件数テキスト */
    #spa-page-master-management .total-count-text {
      font-size: 14px;
      font-weight: 600;
      color: #666;
      white-space: nowrap;
    }

    #spa-page-master-management .total-count-text.hidden {
      display: none;
    }

    /* masterOptions専用UI */
    #spa-page-master-management .master-options-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 16px;
    }

    #spa-page-master-management .master-options-section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 16px;
      overflow: hidden;
    }

    #spa-page-master-management .master-options-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #40B4E5;
      color: white;
      border-radius: 10px 10px 0 0;
    }

    #spa-page-master-management .master-options-header h6 {
      margin: 0;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #spa-page-master-management .master-options-header .badge {
      background: rgba(255,255,255,0.2) !important;
    }

    #spa-page-master-management .master-options-list {
      max-height: 300px;
      overflow-y: auto;
    }

    #spa-page-master-management .master-options-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
    }

    #spa-page-master-management .master-options-item:last-child {
      border-bottom: none;
    }

    #spa-page-master-management .master-options-item:hover {
      background: #f8f9fa;
    }

    #spa-page-master-management .master-options-item .item-text {
      flex: 1;
      font-size: 14px;
    }

    #spa-page-master-management .master-options-item .item-actions {
      display: flex;
      gap: 4px;
    }

    #spa-page-master-management .master-options-item .btn-icon {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    /* 編集ボタン: 常時青背景 */
    #spa-page-master-management .master-options-item .btn-icon.btn-edit {
      background: #e3f2fd;
      color: #1976d2;
    }

    #spa-page-master-management .master-options-item .btn-icon.btn-edit:hover {
      background: #bbdefb;
    }

    /* 削除ボタン: 常時赤背景 */
    #spa-page-master-management .master-options-item .btn-icon.btn-delete {
      background: #ffebee;
      color: #c62828;
    }

    #spa-page-master-management .master-options-item .btn-icon.btn-delete:hover {
      background: #ffcdd2;
    }

    #spa-page-master-management .master-options-add {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      background: #f8f9fa;
      border-top: 1px solid #eee;
    }

    #spa-page-master-management .master-options-add input[type="text"] {
      flex: 1;
      min-width: 0;
    }

    #spa-page-master-management .master-options-add input[type="number"] {
      flex: none;
    }

    #spa-page-master-management .master-options-add .btn {
      white-space: nowrap;
    }

    /* 商品属性ドロップダウンセレクター */
    #spa-page-master-management .master-options-dropdown-selector {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    #spa-page-master-management .master-options-dropdown-selector label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    #spa-page-master-management .master-options-dropdown-selector .form-select {
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.2s;
    }

    #spa-page-master-management .master-options-dropdown-selector .form-select:focus {
      border-color: #40B4E5;
      box-shadow: none;
    }

    /* 空状態 */
    #spa-page-master-management .master-options-empty {
      padding: 24px 16px;
      text-align: center;
      color: #999;
    }

    #spa-page-master-management .master-options-empty p {
      margin: 0;
      font-size: 14px;
    }

    /* マスタ検索フィルター */
    #spa-page-master-management .master-filter-container {
      background: white;
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    #spa-page-master-management .master-filter-input {
      width: 100%;
      padding: 10px 40px 10px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      outline: none;
      transition: border-color 0.2s;
      background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23999' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E") no-repeat right 12px center;
    }

    #spa-page-master-management .master-filter-input:focus {
      border-color: #40B4E5;
    }

    #spa-page-master-management .master-filter-input::placeholder {
      color: #aaa;
    }

    /* フィルター結果カウント */
    #spa-page-master-management .master-filter-count {
      font-size: 13px;
      color: #666;
      margin-top: 8px;
      text-align: right;
    }

    /* フィルターでハイライト */
    #spa-page-master-management .master-options-item.hidden {
      display: none !important;
    }

    #spa-page-master-management .filter-highlight {
      background: #fff3cd;
      padding: 0 2px;
      border-radius: 2px;
    }

    /* カテゴリツリービュー */
    #spa-page-master-management .category-tree-wrapper {
      padding: 8px 0;
    }

    #spa-page-master-management .category-tree-node {
      margin-bottom: 4px;
      position: relative;
    }

    /* 階層表示：最小限のインデント + 左ボーダーで階層を表現 */
    #spa-page-master-management .category-tree-node.level-1 > .category-tree-header,
    #spa-page-master-management .category-tree-node.level-1 > .category-tree-children { margin-left: 0; }
    #spa-page-master-management .category-tree-node.level-2 > .category-tree-header,
    #spa-page-master-management .category-tree-node.level-2 > .category-tree-children { margin-left: 4px; }
    #spa-page-master-management .category-tree-node.level-3 > .category-tree-header,
    #spa-page-master-management .category-tree-node.level-3 > .category-tree-children { margin-left: 4px; }
    #spa-page-master-management .category-tree-node.level-4 > .category-tree-header,
    #spa-page-master-management .category-tree-node.level-4 > .category-tree-children { margin-left: 4px; }
    #spa-page-master-management .category-tree-node.level-5 > .category-tree-header,
    #spa-page-master-management .category-tree-node.level-5 > .category-tree-children { margin-left: 4px; }
    #spa-page-master-management .category-tree-node.level-6 > .category-tree-header,
    #spa-page-master-management .category-tree-node.level-6 > .category-tree-children { margin-left: 4px; }
    #spa-page-master-management .category-tree-node.level-7 > .category-tree-header,
    #spa-page-master-management .category-tree-node.level-7 > .category-tree-children { margin-left: 4px; }

    /* 階層ボーダー色 */
    #spa-page-master-management .category-tree-node.level-1 > .category-tree-header { border-left: 4px solid #40B4E5; }
    #spa-page-master-management .category-tree-node.level-2 > .category-tree-header { border-left: 4px solid #5BC0DE; }
    #spa-page-master-management .category-tree-node.level-3 > .category-tree-header { border-left: 4px solid #7FCCE8; }
    #spa-page-master-management .category-tree-node.level-4 > .category-tree-header { border-left: 4px solid #A3D9F0; }
    #spa-page-master-management .category-tree-node.level-5 > .category-tree-header { border-left: 4px solid #C7E7F7; }
    #spa-page-master-management .category-tree-node.level-6 > .category-tree-header { border-left: 4px solid #E0F2FC; }
    #spa-page-master-management .category-tree-node.level-7 > .category-tree-header { border-left: 4px solid #F0F9FF; }

    #spa-page-master-management .category-tree-header {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      background: #f8f9fa;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }

    #spa-page-master-management .category-tree-header:hover {
      background: #e9ecef;
    }

    #spa-page-master-management .category-tree-header.expanded {
      background: #40B4E5;
      color: white;
      border-radius: 10px 10px 0 0;
    }

    #spa-page-master-management .tree-node-content {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }

    #spa-page-master-management .tree-node-actions {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }

    #spa-page-master-management .toggle-icon {
      font-size: 14px;
      transition: transform 0.2s;
      width: 16px;
      text-align: center;
    }

    #spa-page-master-management .tree-spacer {
      width: 16px;
    }

    #spa-page-master-management .tree-node-name {
      font-weight: 600;
      font-size: 15px;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    #spa-page-master-management .tree-node-count {
      font-size: 13px;
      opacity: 0.7;
      flex-shrink: 0;
    }

    #spa-page-master-management .category-tree-children {
      display: grid;
      grid-template-rows: 0fr;
      overflow: hidden;
      transition: grid-template-rows 0.3s ease;
      background: transparent;
      margin-bottom: 4px;
    }

    #spa-page-master-management .category-tree-children.expanded {
      grid-template-rows: 1fr;
    }

    #spa-page-master-management .tree-children-inner {
      overflow: hidden;
      padding: 0;
    }

    #spa-page-master-management .category-tree-children.expanded .tree-children-inner {
      padding: 4px 0;
    }

    /* ツリーアイテムカード */
    #spa-page-master-management .tree-item-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: white;
      border-radius: 8px;
      margin-bottom: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    #spa-page-master-management .tree-item-card:last-child {
      margin-bottom: 0;
    }

    #spa-page-master-management .tree-item-content {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    #spa-page-master-management .tree-item-name {
      font-size: 14px;
      font-weight: 500;
      color: #333;
      word-break: break-word;
    }

    #spa-page-master-management .tree-item-actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    #spa-page-master-management .tree-item-actions .btn-icon {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    #spa-page-master-management .tree-item-actions .btn-edit {
      background: #e3f2fd;
      color: #1976d2;
    }

    #spa-page-master-management .tree-item-actions .btn-edit:hover {
      background: #bbdefb;
    }

    #spa-page-master-management .tree-item-actions .btn-delete {
      background: #ffebee;
      color: #d32f2f;
    }

    #spa-page-master-management .tree-item-actions .btn-delete:hover {
      background: #ffcdd2;
    }

    /* ツリー追加ボタン */
    #spa-page-master-management .tree-add-btn {
      width: 24px;
      height: 24px;
      border: none;
      border-radius: 50%;
      background: #40B4E5;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s, transform 0.2s;
      margin-left: 8px;
      flex-shrink: 0;
    }

    #spa-page-master-management .tree-add-btn:hover {
      background: #2196f3;
      transform: scale(1.1);
    }

    #spa-page-master-management .category-tree-header:hover .tree-add-btn,
    #spa-page-master-management .category-tree-header:hover .tree-kebab-btn {
      opacity: 1;
    }

    /* ケバブメニューボタン */
    #spa-page-master-management .tree-kebab-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      color: #6c757d;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s, color 0.2s;
      margin-left: 2px;
      flex-shrink: 0;
      position: relative;
    }

    #spa-page-master-management .tree-kebab-btn:hover {
      color: #333;
    }

    /* 展開時（青背景ヘッダー）のケバブ色 */
    #spa-page-master-management .category-tree-header.expanded .tree-kebab-btn {
      color: white;
    }

    #spa-page-master-management .category-tree-header.expanded .tree-kebab-btn:hover {
      color: white;
    }

    /* 展開時の件数テキストを白に */
    #spa-page-master-management .category-tree-header.expanded .tree-node-count {
      color: white;
      opacity: 1;
    }

    /* 展開時の追加ボタンを反転（白背景＋青アイコン） */
    #spa-page-master-management .category-tree-header.expanded .tree-add-btn {
      background: white;
      color: #40B4E5;
    }

    /* ケバブドロップダウンメニュー */
    #spa-page-master-management .tree-kebab-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      min-width: 140px;
      z-index: 1000;
      overflow: hidden;
      display: none;
    }

    #spa-page-master-management .tree-kebab-dropdown.show {
      display: block;
    }

    #spa-page-master-management .tree-kebab-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      font-size: 14px;
      color: #333;
      cursor: pointer;
      transition: background 0.15s;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }

    #spa-page-master-management .tree-kebab-item:hover {
      background: #f0f0f0;
    }

    #spa-page-master-management .tree-kebab-item i {
      font-size: 15px;
      width: 18px;
      text-align: center;
    }

    #spa-page-master-management .tree-kebab-item.danger {
      color: #dc3545;
    }

    #spa-page-master-management .tree-kebab-item.danger:hover {
      background: #fff5f5;
    }

    /* モバイルでは常に表示 */
    @media (max-width: 768px) {
      #spa-page-master-management .tree-add-btn,
      #spa-page-master-management .tree-kebab-btn {
        opacity: 0.7;
      }
    }

    /* インライン追加フォーム */
    #spa-page-master-management .tree-inline-add-form {
      background: #f0f9ff;
      border: 2px solid #40B4E5;
      border-radius: 10px;
      margin: 8px 0 8px 24px;
      overflow: hidden;
    }

    #spa-page-master-management .inline-form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: #40B4E5;
      color: white;
    }

    #spa-page-master-management .inline-form-path {
      font-size: 13px;
      font-weight: 500;
    }

    #spa-page-master-management .inline-form-close {
      width: 24px;
      height: 24px;
      border: none;
      background: rgba(255,255,255,0.2);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    #spa-page-master-management .inline-form-close:hover {
      background: rgba(255,255,255,0.3);
    }

    #spa-page-master-management .inline-form-body {
      padding: 12px;
    }

    #spa-page-master-management .inline-form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      resize: vertical;
      min-height: 60px;
    }

    #spa-page-master-management .inline-form-input:focus {
      outline: none;
      border-color: #40B4E5;
      box-shadow: 0 0 0 3px rgba(64, 180, 229, 0.2);
    }

    #spa-page-master-management .inline-form-hint {
      font-size: 11px;
      color: #888;
      margin-top: 6px;
    }

    #spa-page-master-management .inline-form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    #spa-page-master-management .inline-form-cancel {
      padding: 8px 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
      color: #666;
      font-size: 14px;
      cursor: pointer;
    }

    #spa-page-master-management .inline-form-cancel:hover {
      background: #f5f5f5;
    }

    #spa-page-master-management .inline-form-submit {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      background: #40B4E5;
      color: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    #spa-page-master-management .inline-form-submit:hover {
      background: #2196f3;
    }

    /* 選択ツールバー */
    #spa-page-master-management .selection-toolbar {
      max-width: 800px;
      margin: 0 auto 16px;
      padding: 12px 16px;
      background: #40B4E5;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(79, 172, 254, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-left: 16px;
      margin-right: 16px;
    }

    #spa-page-master-management .btn-tool {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s;
    }

    #spa-page-master-management .btn-tool:active {
      background: rgba(255, 255, 255, 0.3);
    }

    #spa-page-master-management .btn-delete-selected {
      background: rgba(255, 59, 48, 0.9);
    }

    #spa-page-master-management .btn-delete-selected:active {
      background: rgba(255, 59, 48, 1);
    }

    #spa-page-master-management .selected-count {
      color: white;
      font-weight: 600;
      font-size: 14px;
      flex: 1;
      text-align: center;
    }

    /* データリスト */
    #spa-page-master-management .brands-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 0 16px;
    }

    #spa-page-master-management .master-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    #spa-page-master-management .master-card:active {
      transform: scale(0.98);
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }

    #spa-page-master-management .master-info {
      flex: 1;
    }

    #spa-page-master-management .master-field {
      margin-bottom: 4px;
    }

    #spa-page-master-management .master-field-label {
      font-size: 12px;
      color: #999;
      margin-right: 4px;
    }

    #spa-page-master-management .master-field-value {
      font-size: 14px;
      color: #333;
      font-weight: 600;
    }

    #spa-page-master-management .master-field-primary {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }

    #spa-page-master-management .master-field-secondary {
      font-size: 14px;
      color: #666;
    }

    #spa-page-master-management .master-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 8px;
    }

    #spa-page-master-management .usage-count {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: #999;
    }

    #spa-page-master-management .master-actions {
      display: flex;
      gap: 8px;
    }

    /* 汎用削除ボタン: 淡い赤背景 */
    #spa-page-master-management .btn-delete {
      background: #ffebee;
      color: #c62828;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
    }

    #spa-page-master-management .btn-delete:hover {
      background: #ffcdd2;
    }

    #spa-page-master-management .btn-delete:active {
      background: #ef9a9a;
    }

    /* 汎用編集ボタン: 淡い青背景 */
    #spa-page-master-management .btn-edit {
      background: #e3f2fd;
      color: #1976d2;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
      margin-right: 8px;
    }

    #spa-page-master-management .btn-edit:hover {
      background: #bbdefb;
    }

    #spa-page-master-management .btn-edit:active {
      background: #90caf9;
    }

    #spa-page-master-management .master-actions {
      display: flex;
      align-items: center;
    }

    /* アコーディオン表示 */
    #spa-page-master-management .accordion-header {
      background: #40B4E5;
      color: white;
      padding: 14px 16px;
      border-radius: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s;
    }

    #spa-page-master-management .accordion-header:active {
      transform: scale(0.98);
    }

    #spa-page-master-management .accordion-header.expanded {
      border-radius: 10px 10px 0 0;
      margin-bottom: 0;
    }

    #spa-page-master-management .accordion-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #spa-page-master-management .accordion-toggle i {
      font-size: 18px;
      transition: transform 0.2s;
    }

    #spa-page-master-management .accordion-title {
      font-size: 16px;
      font-weight: 600;
      flex: 1;
    }

    #spa-page-master-management .accordion-count {
      font-size: 14px;
      opacity: 0.9;
    }

    #spa-page-master-management .accordion-content {
      display: grid;
      grid-template-rows: 0fr;
      overflow: hidden;
      transition: grid-template-rows 0.3s ease;
      background: #f8f9fa;
      border-radius: 0 0 10px 10px;
      margin-bottom: 12px;
    }

    #spa-page-master-management .accordion-content.expanded {
      grid-template-rows: 1fr;
    }

    #spa-page-master-management .accordion-content > .accordion-inner {
      overflow: hidden;
      padding: 0 12px;
      transition: padding 0.3s ease;
    }

    #spa-page-master-management .accordion-content.expanded > .accordion-inner {
      padding: 12px;
    }

    #spa-page-master-management .accordion-content .master-card {
      margin-bottom: 10px;
      border-radius: 8px;
    }

    #spa-page-master-management .accordion-content .master-card:last-child {
      margin-bottom: 0;
    }

    /* ラベル付きカード表示（縦配列） */
    #spa-page-master-management .master-field-labeled {
      display: flex;
      flex-direction: column;
      margin-bottom: 10px;
      gap: 2px;
    }

    #spa-page-master-management .master-field-labeled:last-child {
      margin-bottom: 0;
    }

    #spa-page-master-management .master-field-labeled .field-label {
      font-size: 11px;
      color: #888;
    }

    #spa-page-master-management .master-field-labeled .field-value {
      font-size: 15px;
      color: #333;
      font-weight: 600;
    }

    /* 価格表示のハイライト */
    #spa-page-master-management .master-field-labeled .field-value.price-value {
      color: #e74c3c;
    }

    /* 選択モード用チェックボックス */
    #spa-page-master-management .master-checkbox {
      width: 24px;
      height: 24px;
      margin-right: 12px;
      cursor: pointer;
      accent-color: #40B4E5;
    }

    #spa-page-master-management .master-card.selection-mode {
      padding-left: 12px;
    }

    #spa-page-master-management .master-card.selected {
      background: linear-gradient(135deg, rgba(79, 172, 254, 0.1) 0%, rgba(0, 242, 254, 0.1) 100%);
      border: 2px solid #40B4E5;
    }

    /* 空状態 */
    #spa-page-master-management .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    #spa-page-master-management .empty-state i {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    #spa-page-master-management .empty-state-text {
      font-size: 16px;
      margin-bottom: 8px;
    }

    #spa-page-master-management .empty-state-hint {
      font-size: 14px;
      color: #bbb;
    }

    /* ローディング */
    #spa-page-master-management .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    #spa-page-master-management .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: mstSpin 1s linear infinite;
    }

    @keyframes mstSpin {
      to { transform: rotate(360deg); }
    }

    /* モーダル */
    #spa-page-master-management .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    #spa-page-master-management .modal-content {
      background: white;
      border-radius: 16px;
      max-width: 400px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    #spa-page-master-management .modal-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
    }

    #spa-page-master-management .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    /* コピーモーダル用スタイル */
    #spa-page-master-management .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      font-size: 20px;
      line-height: 1;
      color: #666;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    #spa-page-master-management .modal-close:hover {
      background: rgba(0, 0, 0, 0.2);
      color: #333;
    }
    #spa-page-master-management .copy-platform-btn:hover {
      background: #f8f9fa !important;
      border-color: #007AFF !important;
      transform: translateX(4px);
    }
    #spa-page-master-management .copy-platform-btn:active {
      background: #e9ecef !important;
      transform: translateX(2px);
    }

    #spa-page-master-management .modal-body {
      padding: 20px;
    }

    #spa-page-master-management .form-group {
      margin-bottom: 16px;
    }

    #spa-page-master-management .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    #spa-page-master-management .form-input,
    #spa-page-master-management .form-select,
    #spa-page-master-management .form-textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.2s;
    }

    #spa-page-master-management .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    #spa-page-master-management .form-input:focus,
    #spa-page-master-management .form-select:focus,
    #spa-page-master-management .form-textarea:focus {
      border-color: #40B4E5;
    }

    #spa-page-master-management .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    #spa-page-master-management .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    #spa-page-master-management .btn-primary {
      background: #40B4E5;
      color: white;
    }

    #spa-page-master-management .btn-primary:active {
      background: #3a9ae6;
    }

    #spa-page-master-management .btn-secondary {
      background: #e0e0e0;
      color: #666;
    }

    #spa-page-master-management .btn-secondary:active {
      background: #d0d0d0;
    }

    /* エラー表示 */
    #spa-page-master-management .error-message {
      background: #fff3f3;
      border: 1px solid #ffcaca;
      color: #d00;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    /* 検索結果超過通知 */
    #spa-page-master-management .more-results-notice {
      background: #40B4E5;
      color: white;
      padding: 16px;
      border-radius: 12px;
      margin-top: 16px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
    }

    #spa-page-master-management .more-results-notice i {
      font-size: 20px;
      margin-bottom: 8px;
      display: block;
    }

    #spa-page-master-management .more-results-notice span {
      display: block;
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 4px;
    }

    #spa-page-master-management .more-results-notice small {
      display: block;
      font-size: 13px;
      opacity: 0.9;
    }

    /* サブグループ切替ボタン（2x2グリッド） */
    #spa-page-master-management .sub-group-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      padding: 12px 8px;
      background: #f8f9fa;
      border-radius: 8px 8px 0 0;
      border-bottom: 1px solid #e9ecef;
    }

    #spa-page-master-management .sub-group-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 500;
      color: #6c757d;
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    #spa-page-master-management .sub-group-btn:hover {
      background: #e9ecef;
      color: #495057;
    }

    #spa-page-master-management .sub-group-btn.active {
      background: var(--reborn-primary, #40B4E5);
      color: white;
      border-color: var(--reborn-primary, #40B4E5);
      font-weight: 600;
    }

    #spa-page-master-management .sub-group-btn i {
      font-size: 14px;
    }

    #spa-page-master-management .nav-tabs {
      margin-bottom: 0;
      flex-wrap: nowrap;
      overflow-x: auto;
      overflow-y: hidden;
      border-bottom: none;
      background: #f8f9fa;
      padding: 8px 8px 0 8px;
      border-radius: 0;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
    }

    #spa-page-master-management .nav-tabs::-webkit-scrollbar {
      height: 4px;
    }

    #spa-page-master-management .nav-tabs::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 2px;
    }

    #spa-page-master-management .nav-tabs .nav-link {
      font-size: 13px;
      padding: 10px 16px;
      white-space: nowrap;
      border: 1px solid transparent;
      border-radius: 6px 6px 0 0;
      color: #6c757d;
      background: transparent;
      margin-right: 4px;
      transition: all 0.2s;
    }

    #spa-page-master-management .nav-tabs .nav-link:hover {
      background: #e9ecef;
      color: #495057;
    }

    #spa-page-master-management .nav-tabs .nav-link.active {
      color: #212529;
      background: white;
      border-color: #dee2e6 #dee2e6 white;
      font-weight: 600;
    }

    #spa-page-master-management .tab-content {
      background: white;
      padding: 20px;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* アコーディオンボディとの統合 */
    #spa-page-master-management .accordion-body {
      background: #f8f9fa;
      border-radius: 0 0 8px 8px;
    }

    /* 非表示クラス */
    #spa-page-master-management .hidden {
      display: none !important;
    }

    /* ルートカテゴリ追加ボタン（ツリー最上部） */
    #spa-page-master-management .tree-root-add-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: #f0f9ff;
      border: 2px dashed #40B4E5;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 8px;
      color: #40B4E5;
      font-weight: 600;
      font-size: 14px;
    }

    #spa-page-master-management .tree-root-add-btn:hover {
      background: #e0f2fe;
      border-color: #2196f3;
      color: #2196f3;
    }

    #spa-page-master-management .tree-root-add-btn:active {
      transform: scale(0.98);
    }

    #spa-page-master-management .tree-root-add-btn i {
      font-size: 18px;
    }

    /* サブページヘッダー */
    #spa-page-master-management .sub-header {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 56px;
      padding: 0 16px;
      background: #ffffff;
      border-bottom: 1px solid #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    #spa-page-master-management .sub-header-back {
      position: absolute;
      left: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: transparent;
      border: none;
      color: #374151;
      font-size: 20px;
      cursor: pointer;
    }
    #spa-page-master-management .sub-header-back:hover {
      background: #f3f4f6;
    }
    #spa-page-master-management .sub-header-back:active {
      background: #e5e7eb;
    }
    #spa-page-master-management .sub-header-title {
      font-size: 17px;
      font-weight: 600;
      color: #111827;
    }
    #spa-page-master-management .sub-header-icons {
      position: absolute;
      right: 8px;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    #spa-page-master-management .sub-header-icon {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: transparent;
      border: none;
      color: #606060;
      font-size: 20px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #spa-page-master-management .sub-header-icon:hover {
      background: #f3f4f6;
    }
    #spa-page-master-management .sub-header-icon:active {
      background: #e5e7eb;
    }
  </style>

  <!-- サブページヘッダー（白背景・シンプル） -->
  <div class="sub-header">
    <button class="sub-header-back" id="mst-back-button" title="戻る">
      <i class="bi bi-chevron-left"></i>
    </button>
    <span class="sub-header-title" id="headerTitle"></span>
    <div class="sub-header-icons">
      <button class="sub-header-icon" id="mst-bell-button" title="お知らせ">
        <i class="bi bi-bell"></i>
      </button>
      <button class="sub-header-icon" id="mst-menu-button" title="メニュー">
        <i class="bi bi-list"></i>
      </button>
    </div>
  </div>

  <!-- マスタタブナビゲーション -->
  <div class="master-tabs-container" style="max-width: 800px; margin: 16px auto; padding: 0 16px;">
    <!-- 商品関連マスタタブ -->
    <div id="product-master-tabs" style="display: none;">
      <!-- サブグループ切替ボタン -->
      <div id="productSubGroupButtons" class="sub-group-buttons">
        <button class="sub-group-btn active" data-subgroup="listing" onclick="switchProductSubGroup('listing')">
          <i class="bi bi-tag"></i> 出品設定
        </button>
        <button class="sub-group-btn" data-subgroup="description" onclick="switchProductSubGroup('description')">
          <i class="bi bi-file-text"></i> 説明文生成
        </button>
      </div>

      <!-- 出品設定タブ -->
      <ul class="nav nav-tabs" id="productMasterTabs-listing" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="master-brand-tab" type="button" role="tab" onclick="loadMaster('product', 'brand')"><i class="bi bi-tag"></i> ブランド</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-category-tab" type="button" role="tab" onclick="loadMaster('product', 'category')"><i class="bi bi-folder"></i> カテゴリ</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-size-tab" type="button" role="tab" onclick="loadMaster('product', 'size')"><i class="bi bi-rulers"></i> サイズ</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-condition-tab" type="button" role="tab" onclick="loadMaster('product', 'condition')"><i class="bi bi-star"></i> 商品の状態</button>
        </li>
      </ul>

      <!-- 説明文生成タブ -->
      <ul class="nav nav-tabs" id="productMasterTabs-description" role="tablist" style="display: none;">
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-material-tab" type="button" role="tab" onclick="loadMaster('product', 'material')"><i class="bi bi-palette"></i> 素材</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-colorDetail-tab" type="button" role="tab" onclick="loadMaster('product', 'colorDetail')"><i class="bi bi-droplet-fill"></i> カラー(詳細)</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-accessory-tab" type="button" role="tab" onclick="loadMaster('product', 'accessory')"><i class="bi bi-box"></i> 付属品</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-sizeLabel-tab" type="button" role="tab" onclick="loadMaster('product', 'sizeLabel')"><i class="bi bi-tag"></i> サイズ(表記)</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-salesword-tab" type="button" role="tab" onclick="loadMaster('product', 'salesword')"><i class="bi bi-chat-quote"></i> セールスワード</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-attribute-tab" type="button" role="tab" onclick="loadMaster('product', 'attribute')"><i class="bi bi-tags"></i> 商品属性</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-conditionRank-tab" type="button" role="tab" onclick="loadMaster('product', 'conditionRank')"><i class="bi bi-star-half"></i> ランク</button>
        </li>
      </ul>
    </div>

    <!-- 業務関連マスタタブ -->
    <div id="business-master-tabs" style="display: none;">
      <!-- サブグループ切替ボタン -->
      <div id="businessSubGroupButtons" class="sub-group-buttons">
        <button class="sub-group-btn active" data-subgroup="delivery" onclick="switchBusinessSubGroup('delivery')">
          <i class="bi bi-truck"></i> 配送設定
        </button>
        <button class="sub-group-btn" data-subgroup="material" onclick="switchBusinessSubGroup('material')">
          <i class="bi bi-box-seam"></i> 資材・在庫
        </button>
        <button class="sub-group-btn" data-subgroup="partner" onclick="switchBusinessSubGroup('partner')">
          <i class="bi bi-building"></i> 取引先
        </button>
        <button class="sub-group-btn" data-subgroup="system" onclick="switchBusinessSubGroup('system')">
          <i class="bi bi-gear"></i> システム設定
        </button>
      </div>

      <!-- 配送設定タブ -->
      <ul class="nav nav-tabs" id="businessMasterTabs-delivery" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="master-shipping-tab" type="button" role="tab" onclick="loadMaster('business', 'shipping')"><i class="bi bi-truck"></i> 発送方法</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-shippingBurden-tab" type="button" role="tab" onclick="loadMaster('business', 'shippingBurden')"><i class="bi bi-cash-coin"></i> 配送料の負担</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-shippingRegion-tab" type="button" role="tab" onclick="loadMaster('business', 'shippingRegion')"><i class="bi bi-geo-alt"></i> 発送元の地域</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-shippingDays-tab" type="button" role="tab" onclick="loadMaster('business', 'shippingDays')"><i class="bi bi-calendar-check"></i> 発送までの日数</button>
        </li>
      </ul>

      <!-- 資材・在庫タブ -->
      <ul class="nav nav-tabs" id="businessMasterTabs-material" role="tablist" style="display: none;">
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-packaging-tab" type="button" role="tab" onclick="loadMaster('business', 'packaging')"><i class="bi bi-box-seam"></i> 梱包資材</button>
        </li>
      </ul>

      <!-- 取引先タブ -->
      <ul class="nav nav-tabs" id="businessMasterTabs-partner" role="tablist" style="display: none;">
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-supplier-tab" type="button" role="tab" onclick="loadMaster('business', 'supplier')"><i class="bi bi-building"></i> 仕入先</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-marketplace-tab" type="button" role="tab" onclick="loadMaster('business', 'marketplace')"><i class="bi bi-shop"></i> 出品先</button>
        </li>
      </ul>

      <!-- システム設定タブ -->
      <ul class="nav nav-tabs" id="businessMasterTabs-system" role="tablist" style="display: none;">
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-managementNumber-tab" type="button" role="tab" onclick="loadManagementNumberMaster()"><i class="bi bi-123"></i> 管理番号</button>
        </li>
      </ul>
    </div>
  </div>

  <!-- 検索バー（全タブ共通） -->
  <div id="searchContainer" class="search-container">
    <div class="search-box">
      <input type="text" id="searchInput" class="search-input" placeholder="絞り込み検索..." oninput="handleGlobalFilter(this.value)">
      <i class="bi bi-search search-icon"></i>
      <span id="searchResultCount" class="search-result-count"></span>
    </div>
  </div>

  <!-- 拡張機能バー -->
  <div class="action-bar">
    <div class="action-buttons">
      <button class="btn-action btn-add" onclick="showAddModal()">
        <i class="bi bi-plus-circle"></i>
        <span>新規追加</span>
      </button>
      <button class="btn-action btn-add" id="categoryAddBtn" onclick="showRootCategoryAddForm()" style="display: none;">
        <i class="bi bi-plus-circle"></i>
        <span>カテゴリ追加</span>
      </button>
      <button class="btn-action btn-select" onclick="toggleSelectionMode()" id="selectModeBtn">
        <i class="bi bi-check-square"></i>
        <span>選択削除</span>
      </button>
    </div>
    <div class="stats-info">
      <span id="statsText"></span>
      <span id="totalCountBadge" class="hidden"></span>
    </div>
  </div>

  <!-- 選択モード時のツールバー -->
  <div class="selection-toolbar hidden" id="selectionToolbar">
    <button class="btn-tool" onclick="selectAll()">
      <i class="bi bi-check-all"></i>
      全選択
    </button>
    <span class="selected-count" id="selectedCount">0件選択中</span>
    <button class="btn-tool btn-delete-selected" onclick="deleteSelected()">
      <i class="bi bi-trash"></i>
      削除
    </button>
  </div>

  <!-- マスタリスト -->
  <div class="brands-container" id="masterListContainer">
    <!-- マスタカードがここに動的生成される -->
  </div>

  <!-- 空状態 -->
  <div class="empty-state hidden" id="emptyState">
    <i class="bi bi-inbox empty-state-icon"></i>
    <div class="empty-state-text" id="emptyStateText">マスタを選択してください</div>
    <div class="empty-state-hint" id="emptyStateHint"></div>
  </div>

  <!-- ローディングオーバーレイ -->
  <div class="loading-overlay hidden" id="loadingOverlay">
    <div class="loading-spinner"></div>
  </div>

  <!-- 追加モーダル -->
  <div class="modal-backdrop hidden" id="addModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="addModalTitle">新規追加</div>
      </div>
      <div class="modal-body">
        <div class="error-message hidden" id="addErrorMessage"></div>
        <div id="addModalBody">
          <!-- 動的にフィールドが生成される -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="addCancelBtn" onclick="hideAddModal()">キャンセル</button>
        <button class="btn btn-primary" id="addSubmitBtn" onclick="addMaster()">追加</button>
      </div>
    </div>
  </div>

  <!-- 削除確認モーダル -->
  <div class="modal-backdrop hidden" id="deleteModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="deleteModalTitle">削除確認</div>
      </div>
      <div class="modal-body">
        <p>以下のデータを削除してもよろしいですか？</p>
        <div style="margin-top: 16px; padding: 12px; background: #f5f5f5; border-radius: 8px;" id="deleteNameDisplay">
          <!-- 削除対象のデータプレビューが表示される -->
        </div>
        <p style="margin-top: 16px; color: #ff4757; font-size: 14px;">
          <i class="bi bi-exclamation-triangle"></i>
          この操作は取り消せません
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideDeleteModal()">キャンセル</button>
        <button class="btn btn-primary" style="background: #ff4757;" onclick="confirmDelete()">削除</button>
      </div>
    </div>
  </div>

  <!-- 編集モーダル（梱包資材・発送方法用） -->
  <div class="modal-backdrop hidden" id="editItemModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="editItemModalTitle">編集</div>
      </div>
      <div class="modal-body">
        <div id="editItemModalBody">
          <!-- 動的にフィールドが生成される -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideEditItemModal()">キャンセル</button>
        <button class="btn btn-primary" id="editItemSubmitBtn" onclick="submitEditItem()">保存</button>
      </div>
    </div>
  </div>

  <!-- コピー先選択モーダル -->
  <div class="modal-backdrop hidden" id="copyModal">
    <div class="modal-content" style="max-width: 360px;">
      <div class="modal-header">
        <div class="modal-title" id="copyModalTitle">コピー先を選択</div>
        <button type="button" class="modal-close" onclick="hideCopyModal()">&times;</button>
      </div>
      <div class="modal-body" style="padding: 16px;">
        <div id="copyModalInfo" style="margin-bottom: 16px; padding: 12px; background: #f8f9fa; border-radius: 8px; text-align: center;">
          <div style="font-weight: 600; color: #333;"></div>
          <div style="font-size: 13px; color: #666; margin-top: 4px;"></div>
        </div>
        <div id="copyPlatformList" style="display: flex; flex-direction: column; gap: 8px;">
          <!-- プラットフォームボタンがここに生成される -->
        </div>
      </div>
      <div class="modal-footer" style="justify-content: center; border-top: 1px solid #eee; padding-top: 12px;">
        <button class="btn btn-secondary" onclick="hideCopyModal()">キャンセル</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // SPA Fragment: master-management
    // ============================================

    // Fragment-scoped state
    var _mst_initialized = false;
    var _mst_scriptsLoaded = false;
    var _mst_category = 'product'; // 'product' or 'business'
    var _mst_swipeCleanupFns = []; // swipe event listener cleanup functions

    /**
     * Load an external script dynamically (non-module)
     * Returns a promise that resolves when the script is loaded
     */
    function mstLoadScript(src) {
      return new Promise(function(resolve, reject) {
        // Check if script already loaded
        if (document.querySelector('script[src="' + src + '"]')) {
          resolve();
          return;
        }
        var script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = function() { reject(new Error('Failed to load: ' + src)); };
        document.head.appendChild(script);
      });
    }

    /**
     * Determine the category (product/business) from SPA page name
     */
    function mstGetCategory() {
      if (typeof getCurrentSpaPage === 'function') {
        var pageName = getCurrentSpaPage();
        if (pageName === 'master-business') return 'business';
        if (pageName === 'master-product') return 'product';
      }
      // Fallback: check localStorage
      var stored = localStorage.getItem('mst_category');
      if (stored === 'business') return 'business';
      return 'product';
    }

    /**
     * Setup custom tab switching (without Bootstrap JS dependency)
     * master-manager.js handles tab .active class switching internally,
     * but we need a basic click handler for nav-link visual toggling
     */
    function mstSetupTabs() {
      var wrapper = document.getElementById('spa-page-master-management');
      if (!wrapper) return;

      var tabButtons = wrapper.querySelectorAll('.nav-tabs .nav-link');
      tabButtons.forEach(function(btn) {
        btn.addEventListener('click', function() {
          // Remove active from siblings in same nav-tabs
          var parent = this.closest('.nav-tabs');
          if (parent) {
            parent.querySelectorAll('.nav-link').forEach(function(link) {
              link.classList.remove('active');
            });
          }
          this.classList.add('active');
        });
      });
    }

    /**
     * Setup swipe gesture handlers for tab navigation
     */
    function mstSetupSwipeGestures() {
      // Product tabs swipe
      mstSetupSwipeForTabs('product');
      // Business tabs swipe
      mstSetupSwipeForTabs('business');
    }

    function mstSetupSwipeForTabs(groupType) {
      var wrapper = document.getElementById('spa-page-master-management');
      if (!wrapper) return;

      // The swipe target is the master list container area
      var swipeTarget = wrapper.querySelector('#masterListContainer');
      if (!swipeTarget) return;

      var touchStartX = 0;
      var touchStartY = 0;
      var touchEndX = 0;
      var touchEndY = 0;
      var isSwiping = false;
      var minSwipeDistance = 80;
      var maxVerticalDeviation = 40;

      // Product subgroup tabs definition
      var productSubGroupTabs = {
        listing: {
          tabIds: ['master-brand', 'master-category', 'master-size', 'master-condition'],
          masterTypes: ['brand', 'category', 'size', 'condition']
        },
        description: {
          tabIds: ['master-material', 'master-colorDetail', 'master-accessory', 'master-sizeLabel', 'master-salesword', 'master-attribute', 'master-conditionRank'],
          masterTypes: ['material', 'colorDetail', 'accessory', 'sizeLabel', 'salesword', 'attribute', 'conditionRank']
        }
      };

      // Business subgroup tabs definition
      var businessSubGroupTabs = {
        delivery: {
          tabIds: ['master-shipping', 'master-shippingBurden', 'master-shippingRegion', 'master-shippingDays'],
          masterTypes: ['shipping', 'shippingBurden', 'shippingRegion', 'shippingDays']
        },
        material: {
          tabIds: ['master-packaging'],
          masterTypes: ['packaging']
        },
        partner: {
          tabIds: ['master-supplier', 'master-marketplace'],
          masterTypes: ['supplier', 'marketplace']
        },
        system: {
          tabIds: ['master-managementNumber'],
          masterTypes: ['managementNumber']
        }
      };

      function onTouchStart(e) {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
        isSwiping = true;
      }

      function onTouchMove(e) {
        if (!isSwiping) return;
        var currentX = e.changedTouches[0].screenX;
        var currentY = e.changedTouches[0].screenY;
        var diffX = Math.abs(currentX - touchStartX);
        var diffY = Math.abs(currentY - touchStartY);
        if (diffY > maxVerticalDeviation || (diffY > 15 && diffY > diffX)) {
          isSwiping = false;
        }
      }

      function onTouchEnd(e) {
        if (!isSwiping) {
          isSwiping = false;
          return;
        }
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleSwipe();
        isSwiping = false;
      }

      function handleSwipe() {
        var diffX = touchStartX - touchEndX;
        var diffY = Math.abs(touchStartY - touchEndY);
        if (Math.abs(diffX) < minSwipeDistance || diffY > maxVerticalDeviation) return;
        if (Math.abs(diffX) < diffY * 2.5) return;

        // Determine current category mode
        var cat = _mst_category;
        var subGroupTabs, currentSubGroup;

        if (cat === 'product') {
          currentSubGroup = (typeof window.currentProductSubGroup !== 'undefined') ? window.currentProductSubGroup : 'listing';
          subGroupTabs = productSubGroupTabs;
        } else {
          currentSubGroup = (typeof window.currentBusinessSubGroup !== 'undefined') ? window.currentBusinessSubGroup : 'delivery';
          subGroupTabs = businessSubGroupTabs;
        }

        var groupDef = subGroupTabs[currentSubGroup];
        if (!groupDef) return;

        var tabIds = groupDef.tabIds;
        var masterTypes = groupDef.masterTypes;

        // Find current active tab
        var tabContainerId = cat === 'product' ? 'productMasterTabs-' + currentSubGroup : 'businessMasterTabs-' + currentSubGroup;
        var tabContainer = document.getElementById(tabContainerId);
        var activeTab = tabContainer ? tabContainer.querySelector('.nav-link.active') : null;
        if (!activeTab) return;

        var currentId = activeTab.id.replace('-tab', '');
        var currentIndex = tabIds.indexOf(currentId);
        if (currentIndex === -1) return;

        var nextIndex;
        if (diffX > 0) {
          nextIndex = currentIndex + 1;
          if (nextIndex >= tabIds.length) return;
        } else {
          nextIndex = currentIndex - 1;
          if (nextIndex < 0) return;
        }

        var nextTabId = tabIds[nextIndex];
        var nextMasterType = masterTypes[nextIndex];
        var nextTabButton = document.getElementById(nextTabId + '-tab');
        if (nextTabButton) {
          // Manually switch active tab (no Bootstrap JS)
          if (tabContainer) {
            tabContainer.querySelectorAll('.nav-link').forEach(function(link) {
              link.classList.remove('active');
            });
          }
          nextTabButton.classList.add('active');

          // Scroll tab into view
          setTimeout(function() {
            nextTabButton.scrollIntoView({
              behavior: 'smooth',
              block: 'nearest',
              inline: 'center'
            });
          }, 50);

          // Load master data
          if (typeof window.loadMaster === 'function') {
            window.loadMaster(cat, nextMasterType);
          }
        }
      }

      swipeTarget.addEventListener('touchstart', onTouchStart, { passive: true });
      swipeTarget.addEventListener('touchmove', onTouchMove, { passive: true });
      swipeTarget.addEventListener('touchend', onTouchEnd, { passive: true });

      // Store cleanup function
      _mst_swipeCleanupFns.push(function() {
        swipeTarget.removeEventListener('touchstart', onTouchStart);
        swipeTarget.removeEventListener('touchmove', onTouchMove);
        swipeTarget.removeEventListener('touchend', onTouchEnd);
      });
    }

    /**
     * Setup header button event listeners
     */
    function mstSetupHeaderButtons() {
      var backBtn = document.getElementById('mst-back-button');
      if (backBtn) {
        backBtn.addEventListener('click', function() {
          if (typeof spaGoBack === 'function') {
            spaGoBack();
          } else if (typeof goBackInHistory === 'function') {
            goBackInHistory();
          } else {
            navigateToPage('home');
          }
        });
      }

      var bellBtn = document.getElementById('mst-bell-button');
      if (bellBtn) {
        bellBtn.addEventListener('click', function() {
          if (typeof openChatRooms === 'function') {
            openChatRooms();
          }
        });
      }

      var menuBtn = document.getElementById('mst-menu-button');
      if (menuBtn) {
        menuBtn.addEventListener('click', function() {
          if (typeof toggleDrawer === 'function') {
            toggleDrawer();
          }
        });
      }
    }

    /**
     * Load all required external scripts and initialize
     */
    async function mstLoadDependencies() {
      if (_mst_scriptsLoaded) {
        console.log('[MstSPA] Dependencies already loaded, skipping');
        return;
      }

      try {
        // 1. Load master-config.js (defines masterCategories, masterDefinitions)
        if (typeof window.masterCategories === 'undefined') {
          await mstLoadScript('/js/master-config.js?v=534');
          console.log('[MstSPA] master-config.js loaded');
        }

        // 2. Load firestore-api.js (provides getMasterData, createMaster, etc.)
        //    This is an ES module, so we use dynamic import()
        if (typeof window.getMasterData === 'undefined') {
          try {
            var firestoreModule = await import('/js/firestore-api.js?v=534');
            window.getMasterData = firestoreModule.getMasterData;
            window.createMaster = firestoreModule.createMaster;
            window.updateMaster = firestoreModule.updateMaster;
            window.deleteMaster = firestoreModule.deleteMaster;
            window.searchMaster = firestoreModule.searchMaster;
            window.incrementMasterUsageCount = firestoreModule.incrementMasterUsageCount;
            window.initializeFirestore = firestoreModule.initializeFirestore;
            window.getMasterCount = firestoreModule.getMasterCount;
            console.log('[MstSPA] firestore-api.js loaded (dynamic import)');
          } catch (importErr) {
            console.error('[MstSPA] firestore-api.js import error:', importErr);
            throw importErr;
          }
        }

        // 3. Setup firestoreModular for count() queries
        //    Parent may already provide this, or we set it up
        if (!window.firestoreModular) {
          try {
            var fbAppModule = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
            var fbFsModule = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

            var app;
            if (fbAppModule.getApps().length === 0) {
              app = fbAppModule.initializeApp({
                apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
                authDomain: "furira.jp",
                projectId: "reborn-chat",
                storageBucket: "reborn-chat.firebasestorage.app",
                messagingSenderId: "345706548795",
                appId: "1:345706548795:web:058a553da6b4b74db5161e"
              });
            } else {
              app = fbAppModule.getApps()[0];
            }

            var modularDb = fbFsModule.getFirestore(app);
            window.firestoreModular = {
              db: modularDb,
              collection: fbFsModule.collection,
              getCountFromServer: fbFsModule.getCountFromServer
            };
            console.log('[MstSPA] firestoreModular setup complete');
          } catch (modErr) {
            console.warn('[MstSPA] firestoreModular setup failed (non-critical):', modErr);
          }
        }

        // 4. Load master-manager.js (provides initMasterManager, loadMaster, etc.)
        if (typeof window.initMasterManager === 'undefined') {
          await mstLoadScript('/js/master-manager.js?v=535');
          console.log('[MstSPA] master-manager.js loaded');
        }

        // master-cache.js is already loaded by parent (per instructions)

        _mst_scriptsLoaded = true;
        console.log('[MstSPA] All dependencies loaded successfully');

      } catch (err) {
        console.error('[MstSPA] Failed to load dependencies:', err);
        throw err;
      }
    }

    /**
     * Override goBack in master-manager.js to use SPA navigation
     * v577: window.goBackは他Fragmentと衝突するためmst専用名に変更
     */
    function mstOverrideNavigation() {
      window._mstGoBack = function() {
        console.log('[MstSPA] _mstGoBack -> spaGoBack');
        if (typeof spaGoBack === 'function') {
          spaGoBack();
        } else if (typeof navigateToPage === 'function') {
          navigateToPage('home');
        }
      };
    }

    /**
     * Initialize the master management page (SPA lifecycle)
     */
    async function initMasterManagementPage() {
      console.log('[MstSPA] initMasterManagementPage called');

      // Determine category from SPA page name
      _mst_category = mstGetCategory();
      console.log('[MstSPA] Category:', _mst_category);

      // Setup header buttons
      mstSetupHeaderButtons();

      // Setup custom tab switching
      mstSetupTabs();

      try {
        // Load all required dependencies
        await mstLoadDependencies();

        // Override navigation functions for SPA context
        mstOverrideNavigation();

        // Initialize master manager (SPA mode: skip auto-loadMaster)
        window._mstSpaMode = true;
        if (typeof window.initMasterManager === 'function') {
          console.log('[MstSPA] Calling initMasterManager (SPA mode)...');
          window.initMasterManager();
        } else {
          console.error('[MstSPA] initMasterManager not found');
          return;
        }

        // Store sessionId from localStorage (SPA context)
        var sessionId = localStorage.getItem('device_session_id') || sessionStorage.getItem('device_session_id');
        if (sessionId) {
          sessionStorage.setItem('device_session_id', sessionId);
        }

        // Show appropriate tabs and load first master
        setTimeout(function() {
          var productTabs = document.getElementById('product-master-tabs');
          var businessTabs = document.getElementById('business-master-tabs');
          var headerTitle = document.getElementById('headerTitle');

          if (_mst_category === 'product') {
            if (productTabs) productTabs.style.display = 'block';
            if (businessTabs) businessTabs.style.display = 'none';
            if (headerTitle) headerTitle.textContent = '商品マスタ管理';
            if (typeof window.loadMaster === 'function') {
              window.loadMaster('product', 'brand');
            }
          } else if (_mst_category === 'business') {
            if (productTabs) productTabs.style.display = 'none';
            if (businessTabs) businessTabs.style.display = 'block';
            if (headerTitle) headerTitle.textContent = '業務マスタ管理';
            if (typeof window.loadMaster === 'function') {
              window.loadMaster('business', 'shipping');
            }
          }

          // Setup swipe gestures after tabs are visible
          mstSetupSwipeGestures();
        }, 100);

        _mst_initialized = true;
        console.log('[MstSPA] Initialization complete');

      } catch (err) {
        console.error('[MstSPA] Initialization error:', err);
        var emptyState = document.getElementById('emptyState');
        var emptyText = document.getElementById('emptyStateText');
        if (emptyState) emptyState.classList.remove('hidden');
        if (emptyText) emptyText.textContent = '初期化エラーが発生しました。ページを再読み込みしてください。';
      }
    }

    /**
     * Destroy the master management page (SPA lifecycle)
     * Clean up event listeners, reset state
     */
    function destroyMasterManagementPage() {
      console.log('[MstSPA] destroyMasterManagementPage called');
      window._mstSpaMode = false;

      // Clean up swipe gesture listeners
      _mst_swipeCleanupFns.forEach(function(fn) {
        try { fn(); } catch(e) { /* ignore */ }
      });
      _mst_swipeCleanupFns = [];

      // Reset master-manager.js global state if it exists
      if (typeof window.currentCategory !== 'undefined') {
        // These are globals in master-manager.js
        // We can't delete them but we note the page is being torn down
      }

      // Clean up any open modals/overlays in the fragment
      var wrapper = document.getElementById('spa-page-master-management');
      if (wrapper) {
        var modals = wrapper.querySelectorAll('.modal-backdrop');
        modals.forEach(function(m) { m.classList.add('hidden'); });
        var loading = wrapper.querySelector('.loading-overlay');
        if (loading) loading.classList.add('hidden');
      }

      // Remove any toasts created by master-manager.js
      var toasts = document.querySelectorAll('.master-toast');
      toasts.forEach(function(t) { t.remove(); });

      _mst_initialized = false;
      _mst_scriptsLoaded = false;
      console.log('[MstSPA] Cleanup complete');
    }

    // Expose lifecycle functions globally for SPA router
    window.initMasterManagementPage = initMasterManagementPage;
    window.destroyMasterManagementPage = destroyMasterManagementPage;
  </script>
</div>
