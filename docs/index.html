<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- Cache Bust: 2025-12-02 v3.1 - é€šçŸ¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³å‹•çš„ç”Ÿæˆç‰ˆ -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- ğŸ”§ consoleæœ‰åŠ¹ï¼ˆãƒ‡ãƒãƒƒã‚°ä¸­ï¼‰ -->
  <!--
  <script>
    window.console = {
      log: function() {},
      warn: function() {},
      error: function() {},
      info: function() {},
      debug: function() {}
    };
  </script>
  -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ãƒ•ãƒªãƒ©">
  <title>ãƒ•ãƒªãƒ© ç‰©è²©ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">

  <!-- PWA Icons -->
  <link rel="apple-touch-icon" href="icon-180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

  <!-- iOS Splash Screens (ç™½èƒŒæ™¯ã§PWAã‚’é–‹ãã¾ã™ãƒ†ã‚­ã‚¹ãƒˆã‚’ç›®ç«‹ãŸãªãã™ã‚‹) -->
  <!-- iPhone 15 Pro Max, 14 Pro Max -->
  <link rel="apple-touch-startup-image" href="/splash/splash-1290x2796.png" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)">
  <!-- iPhone 15 Pro, 14 Pro -->
  <link rel="apple-touch-startup-image" href="/splash/splash-1179x2556.png" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3)">
  <!-- iPhone 15, 14, 13, 13 Pro, 12, 12 Pro -->
  <link rel="apple-touch-startup-image" href="/splash/splash-1170x2532.png" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)">
  <!-- iPhone 15 Plus, 14 Plus, 13 Pro Max, 12 Pro Max -->
  <link rel="apple-touch-startup-image" href="/splash/splash-1284x2778.png" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)">
  <!-- iPhone 13 mini, 12 mini -->
  <link rel="apple-touch-startup-image" href="/splash/splash-1080x2340.png" media="(device-width: 360px) and (device-height: 780px) and (-webkit-device-pixel-ratio: 3)">
  <!-- iPhone 11 Pro Max, XS Max -->
  <link rel="apple-touch-startup-image" href="/splash/splash-1242x2688.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)">
  <!-- iPhone 11 Pro, XS, X -->
  <link rel="apple-touch-startup-image" href="/splash/splash-1125x2436.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)">
  <!-- iPhone 11, XR -->
  <link rel="apple-touch-startup-image" href="/splash/splash-828x1792.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)">
  <!-- iPhone 8 Plus -->
  <link rel="apple-touch-startup-image" href="/splash/splash-1242x2208.png" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3)">
  <!-- iPhone 8, SE (2nd/3rd gen) -->
  <link rel="apple-touch-startup-image" href="/splash/splash-750x1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)">
  <!-- iPad Pro 12.9" -->
  <link rel="apple-touch-startup-image" href="/splash/splash-2048x2732.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)">
  <!-- iPad Pro 11" -->
  <link rel="apple-touch-startup-image" href="/splash/splash-1668x2388.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)">
  <!-- iPad Air -->
  <link rel="apple-touch-startup-image" href="/splash/splash-1640x2360.png" media="(device-width: 820px) and (device-height: 1180px) and (-webkit-device-pixel-ratio: 2)">
  <!-- iPad 10th gen -->
  <link rel="apple-touch-startup-image" href="/splash/splash-1620x2160.png" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2)">
  <!-- iPad Mini -->
  <link rel="apple-touch-startup-image" href="/splash/splash-1488x2266.png" media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2)">

  <!-- Performance: ãƒ—ãƒªã‚³ãƒã‚¯ãƒˆï¼ˆDNSè§£æ±ºãƒ»TCPãƒ»TLSæ¥ç¶šã‚’å…ˆè¡Œå®Ÿè¡Œï¼‰ -->
  <link rel="dns-prefetch" href="https://script.google.com">
  <link rel="dns-prefetch" href="https://www.gstatic.com">
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>

  <!-- GAS Web App URLï¼ˆå…¨iframeå­ãƒšãƒ¼ã‚¸ã‹ã‚‰å‚ç…§å¯èƒ½ï¼‰ -->
  <script>
    window.REBORN_CONFIG = {
      GAS_BASE_URL: "/gas-proxy"
    };
  </script>

  <!-- REBORN Brand Colors -->
  <link rel="stylesheet" href="/css/reborn-brand-colors.css?v=9635">
  <link rel="stylesheet" href="/css/reborn-theme.css?v=9635">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body, html {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    /* ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç”»é¢å…±é€š */
    #setup-screen,
    #install-prompt-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      display: none;
      /* flexbox ã§å‚ç›´ãƒ»æ°´å¹³ä¸­å¤®é…ç½® */
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      background: linear-gradient(135deg, var(--reborn-primary, #40B4E5) 0%, var(--reborn-primary-dark, #1E8FBF) 100%);
      padding: 20px;
      box-sizing: border-box;
      z-index: 9999;
    }

    .setup-container {
      background: white;
      border-radius: 16px;
      padding: 24px;
      padding-bottom: 40px;
      max-width: 500px;
      width: 100%;
      margin: 20px 0;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      box-sizing: border-box;
      min-height: fit-content;
    }

    .setup-title {
      color: #5B9DD9;
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      text-align: center;
    }

    .setup-subtitle {
      color: #6b7280;
      font-size: 14px;
      text-align: center;
      margin-bottom: 24px;
    }

    .step-section {
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .step-number {
      display: inline-block;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      text-align: center;
      line-height: 24px;
      font-size: 14px;
      font-weight: 600;
      margin-right: 8px;
    }

    .step-title {
      display: inline;
      font-weight: 600;
      color: #1f2937;
      font-size: 16px;
    }

    .step-button {
      width: 100%;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
      transition: transform 0.2s;
    }

    .step-button:hover {
      transform: translateY(-2px);
    }

    .step-button:active {
      transform: translateY(0);
    }

    .step-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .step-button.success {
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
    }

    .step-button.optional {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .step-result {
      margin-top: 10px;
      padding: 10px 12px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      font-size: 13px;
      color: #374151;
      display: none;
    }

    .step-result.success {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      color: #374151;
      display: block;
    }

    .step-result.error {
      background: #fef2f2;
      border-color: #ef4444;
      color: #dc2626;
      display: block;
    }

    .open-app-button {
      width: 100%;
      background: linear-gradient(135deg, var(--reborn-primary, #40B4E5) 0%, var(--reborn-primary-dark, #1E8FBF) 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 16px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 24px;
      transition: transform 0.2s;
      display: none;
    }

    .open-app-button:hover {
      transform: translateY(-2px);
    }

    .open-app-button:active {
      transform: translateY(0);
    }

    /* ã‚¢ãƒ—ãƒªç”»é¢ */
    #app-screen {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆé€šçŸ¥ï¼‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ä»˜ãï¼‰ */
    #app-header {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      background: linear-gradient(135deg, var(--reborn-primary, #40B4E5) 0%, var(--reborn-primary-dark, #1E8FBF) 100%);
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      /* UI-013: ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’é«˜é€Ÿåˆ‡ã‚Šæ›¿ãˆï¼ˆé·ç§»é€Ÿåº¦æ”¹å–„ï¼‰ */
      transition: opacity 0.15s ease, transform 0.15s ease;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼éè¡¨ç¤ºæ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #app-header[style*="display: none"] {
      opacity: 0;
      transform: translateY(-100%);
    }

    .app-logo {
      height: 50px;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.2s;
      display: block;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }

    .app-logo:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .app-logo:active {
      opacity: 0.8;
      transform: translateY(0);
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼å³å´ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— */
    .header-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* é€šçŸ¥ãƒãƒƒã‚¸ãƒœã‚¿ãƒ³ */
    .notification-button {
      position: relative;
      background: transparent;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s, opacity 0.2s;
    }

    .notification-button:hover {
      opacity: 0.8;
    }

    .notification-button:active {
      transform: scale(0.9);
    }

    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆâ˜°ï¼‰ */
    .menu-button {
      background: transparent;
      border: none;
      border-radius: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s, opacity 0.2s;
      color: white;
      font-size: 30px;
      font-weight: 300;
    }

    .menu-button:hover {
      opacity: 0.8;
    }

    .menu-button:active {
      transform: scale(0.9);
    }

    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³ */
    .user-icon-button {
      position: relative;
      background: transparent;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s, opacity 0.2s;
      overflow: hidden;
      padding: 0;
    }

    .user-icon-button:hover {
      opacity: 0.8;
    }

    .user-icon-button:active {
      transform: scale(0.9);
    }

    .user-icon-image {
      width: 28px;
      height: 28px;
      object-fit: cover;
      border-radius: 50%;
    }

    .user-icon-placeholder {
      font-size: 22px;
      color: white;
    }

    /* ãƒ‰ãƒ­ãƒ¯ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆèƒŒæ™¯æš—è»¢ï¼‰ */
    #drawer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    #drawer-overlay.active {
      display: block;
      opacity: 1;
    }

    /* ãƒ‰ãƒ­ãƒ¯ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    #drawer-menu {
      position: fixed;
      top: 0;
      right: -280px;
      width: 280px;
      height: 100%;
      background: white;
      z-index: 2000;
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.2);
      transition: right 0.3s ease;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    #drawer-menu.active {
      right: 0;
    }

    .drawer-header {
      padding: 20px 16px;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      color: white;
      font-size: 20px;
      font-weight: 600;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .drawer-item {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 16px;
      color: #1f2937;
      text-decoration: none;
      border-bottom: 1px solid #e5e7eb;
      transition: background 0.2s;
    }

    .drawer-item:hover {
      background: #f3f4f6;
    }

    .drawer-item.active {
      background: #ede9fe;
      color: #5B9DD9;
      font-weight: 600;
    }

    .drawer-item.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    .drawer-accordion {
      margin: 0;
    }

    .drawer-accordion-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      color: #374151;
      font-size: 15px;
      text-decoration: none;
      cursor: pointer;
      transition: background 0.2s;
    }

    .drawer-accordion-header:hover {
      background: #f3f4f6;
    }

    .drawer-accordion-arrow {
      transition: transform 0.3s;
      font-size: 12px;
    }

    .drawer-accordion.open .drawer-accordion-arrow {
      transform: rotate(180deg);
    }

    .drawer-accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .drawer-accordion.open .drawer-accordion-content {
      max-height: 500px;
    }

    .drawer-accordion-item {
      display: block;
      padding: 12px 20px 12px 40px;
      color: #6b7280;
      font-size: 14px;
      text-decoration: none;
      transition: background 0.2s, color 0.2s;
    }

    .drawer-accordion-item:hover {
      background: #f9fafb;
      color: #374151;
    }

    .notification-icon {
      font-size: 22px;
      color: white;
    }

    /* ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆã®ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ */
    #todo-list-button .notification-icon {
      color: white;
      font-weight: bold;
    }

    /* ãƒ¡ãƒ«ã‚«ãƒªé¢¨ãƒãƒƒã‚¸ */
    .badge-count {
      position: absolute;
      top: 2px;
      right: 2px;
      background: #ef4444;
      color: white;
      border-radius: 50%;
      min-width: 14px;
      height: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: 700;
      padding: 0 3px;
      display: none;
      line-height: 1;
    }

    .badge-count.active {
      display: flex;
    }

    #gas-iframe {
      width: 100%;
      height: 100%;
      border: none;
      flex: 1;
    }

    /* ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIï¼ˆåˆæœŸãƒ­ãƒ¼ãƒ‰ä¸­ã«è¡¨ç¤ºï¼‰ */
    #skeleton-loader {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #f9fafb;
      z-index: 1100; /* UI-013: ãƒ‰ãƒ­ãƒ¯ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚ˆã‚Šä¸Šã«è¡¨ç¤º */
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
      transition: opacity 0.15s ease-out; /* æ¡ˆC: é«˜é€ŸåŒ– 0.3s â†’ 0.15s */
    }

    #skeleton-loader.hidden {
      opacity: 0;
      pointer-events: none;
    }

    /* UI-013: ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼è¿½åŠ ï¼ˆå‹•ãã®ã‚ã‚‹è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰ */
    .loading-spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      margin-top: -25px; /* height / 2 */
      margin-left: -25px; /* width / 2 */
      width: 50px;
      height: 50px;
      border: 4px solid #e0e0e0;
      border-top: 4px solid #5B9DD9;
      border-radius: 50%;
      animation: spinner-rotate 1s linear infinite;
      z-index: 10; /* skeleton-formã®ä¸Šã«è¡¨ç¤º */
    }

    @keyframes spinner-rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .skeleton-header {
      width: 100%;
      height: 60px;
      background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
      background-size: 200% 100%;
      animation: skeleton-pulse 1.5s ease-in-out infinite;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .skeleton-form {
      width: 100%;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .skeleton-input {
      width: 100%;
      height: 40px;
      background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
      background-size: 200% 100%;
      animation: skeleton-pulse 1.5s ease-in-out infinite;
      border-radius: 6px;
      margin-bottom: 16px;
    }

    .skeleton-button {
      width: 120px;
      height: 44px;
      background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
      background-size: 200% 100%;
      animation: skeleton-pulse 1.5s ease-in-out infinite;
      border-radius: 6px;
      margin-top: 10px;
    }

    @keyframes skeleton-pulse {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }

    /* ãƒãƒ£ãƒƒãƒˆFABï¼ˆå³ä¸‹å›ºå®šï¼‰ */
    #chat-fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      box-shadow: 0 8px 24px rgba(91, 157, 217, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 9998;
      transition: all 0.3s ease;
      border: none;
    }

    #chat-fab:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 32px rgba(91, 157, 217, 0.5);
    }

    #chat-fab:active {
      transform: scale(0.95);
    }

    #chat-fab.hidden {
      display: none;
    }

    #chat-fab-icon {
      font-size: 32px;
      line-height: 1;
    }

    /* æœªèª­ãƒãƒƒã‚¸ */
    #chat-fab-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      min-width: 24px;
      height: 24px;
      border-radius: 12px;
      background: #ef4444;
      color: white;
      font-size: 12px;
      font-weight: 600;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0 6px;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
      border: 2px solid white;
    }

    #chat-fab-badge.active {
      display: flex;
      animation: badge-bounce 0.5s ease;
    }

    @keyframes badge-bounce {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.2);
      }
    }

    /* æ‰¿èªå¾…ã¡ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ‰ãƒƒãƒˆ */
    .loading-dot {
      animation: loading-pulse 1.5s ease-in-out infinite;
      color: #3b82f6;
    }

    @keyframes loading-pulse {
      0%, 100% {
        opacity: 0.3;
      }
      50% {
        opacity: 1;
      }
    }

    /* æ‰¿èªå®Œäº†ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .approval-success {
      animation: approval-bounce 0.5s ease;
    }

    @keyframes approval-bounce {
      0% { transform: scale(0.8); opacity: 0; }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body>
  <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã‚’ä¿ƒã™ç”»é¢ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ãŸå ´åˆï¼‰ -->
  <div id="install-prompt-screen" style="display: none;">
    <div class="setup-container">
      <div style="text-align: center; margin-bottom: 20px;">
        <img src="/images/furira-square-logo.png" alt="ãƒ•ãƒªãƒ©" style="width: 80px; height: 80px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
      </div>
      <div class="setup-title">ğŸ“± ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</div>
      <div class="setup-subtitle">ãƒ•ãƒªãƒ©ã‚’ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã‚¢ãƒ—ãƒªã¨ã—ã¦ä½¿ç”¨ã§ãã¾ã™</div>

      <!-- iOSç”¨ã®æ¡ˆå†… -->
      <div id="ios-install-guide" class="step-section" style="display: none;">
        <div style="text-align: center; padding: 20px;">
          <div style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 20px;">
            ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †
          </div>
          <div style="text-align: left; background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 20px;">
              <div style="width: 32px; height: 32px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; flex-shrink: 0;">1</div>
              <div style="font-size: 14px; color: #374151; line-height: 1.8;">
                ç”»é¢å³ä¸‹ã® <span style="display: inline-flex; align-items: center; background: #e5e7eb; padding: 2px 8px; border-radius: 4px; font-size: 13px; vertical-align: middle;">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#374151" stroke-width="2">
                    <circle cx="12" cy="12" r="1.5"/>
                    <circle cx="6" cy="12" r="1.5"/>
                    <circle cx="18" cy="12" r="1.5"/>
                  </svg>
                </span> ã‚’ã‚¿ãƒƒãƒ—<br>
                â†’ <span style="display: inline-flex; align-items: center; background: #e5e7eb; padding: 2px 8px; border-radius: 4px; font-size: 13px; vertical-align: middle;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#374151" stroke-width="2" style="margin-right: 4px;">
                    <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8M16 6l-4-4-4 4M12 2v13"/>
                  </svg>
                  å…±æœ‰
                </span> ã‚’ã‚¿ãƒƒãƒ—
              </div>
            </div>
            <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 20px;">
              <div style="width: 32px; height: 32px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; flex-shrink: 0;">2</div>
              <div style="font-size: 14px; color: #374151; line-height: 1.8;">
                <span style="display: inline-flex; align-items: center; background: #e5e7eb; padding: 2px 8px; border-radius: 4px; font-size: 13px; vertical-align: middle;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#374151" stroke-width="2" style="margin-right: 4px;">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <line x1="12" y1="8" x2="12" y2="16"/>
                    <line x1="8" y1="12" x2="16" y2="12"/>
                  </svg>
                  ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ 
                </span> ã‚’ã‚¿ãƒƒãƒ—
              </div>
            </div>
            <div style="display: flex; align-items: flex-start; gap: 12px;">
              <div style="width: 32px; height: 32px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; flex-shrink: 0;">3</div>
              <div style="font-size: 14px; color: #374151; line-height: 1.8;">
                å³ä¸Šã® <span style="background: #e5e7eb; padding: 2px 8px; border-radius: 4px; font-size: 13px; vertical-align: middle;">è¿½åŠ </span> ã‚’ã‚¿ãƒƒãƒ—
              </div>
            </div>
          </div>
          <div style="font-size: 13px; color: #6b7280;">
            ãƒ›ãƒ¼ãƒ ç”»é¢ã®ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦ãã ã•ã„
          </div>
        </div>
      </div>

      <!-- Androidç”¨ã®æ¡ˆå†… -->
      <div id="android-install-guide" class="step-section" style="display: none;">
        <div style="text-align: center; padding: 20px;">
          <div style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 20px;">
            ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †
          </div>
          <div style="text-align: center; margin-bottom: 20px;">
            <button id="android-install-btn" onclick="installPWA()"
                    style="display: inline-flex; align-items: center; gap: 10px; padding: 14px 28px;
                           background: #059669; border: none; border-radius: 10px;
                           font-size: 16px; font-weight: 600; color: white; cursor: pointer;
                           box-shadow: 0 2px 8px rgba(5, 150, 105, 0.3);">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
              </svg>
              ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            </button>
          </div>
          <div id="android-manual-guide" style="display: none; text-align: left; background: #f9fafb; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
            <div style="font-size: 13px; color: #6b7280; margin-bottom: 12px;">ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆï¼š</div>
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div style="width: 28px; height: 28px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 13px; flex-shrink: 0;">1</div>
              <div style="font-size: 13px; color: #374151;">
                ãƒ–ãƒ©ã‚¦ã‚¶ã® <span style="background: #e5e7eb; padding: 2px 6px; border-radius: 4px;">â‹®</span> ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚¿ãƒƒãƒ—
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="width: 28px; height: 28px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 13px; flex-shrink: 0;">2</div>
              <div style="font-size: 13px; color: #374151;">
                ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã¾ãŸã¯ã€Œã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ã‚’ã‚¿ãƒƒãƒ—
              </div>
            </div>
          </div>
          <div style="font-size: 13px; color: #6b7280;">
            ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã€ãƒ›ãƒ¼ãƒ ç”»é¢ã®ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦ãã ã•ã„
          </div>
        </div>
      </div>

      <!-- PCç”¨ã®æ¡ˆå†… -->
      <div id="pc-install-guide" class="step-section" style="display: none;">
        <div style="text-align: center; padding: 20px;">
          <div style="font-size: 48px; margin-bottom: 16px;">ğŸ’»</div>
          <div style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 16px;">
            PCã§ã®ã”åˆ©ç”¨
          </div>
          <div style="font-size: 14px; color: #6b7280; margin-bottom: 24px;">
            ã“ã®ã‚¢ãƒ—ãƒªã¯ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å‘ã‘ã«æœ€é©åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚<br>
            åˆå›ç™»éŒ²ã¯ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§è¡Œã£ã¦ãã ã•ã„ã€‚
          </div>
          <div style="border-top: 1px solid #e5e7eb; padding-top: 20px;">
            <div style="font-size: 13px; color: #9ca3af; margin-bottom: 12px;">
              æ—¢ã«ç™»éŒ²æ¸ˆã¿ã®æ–¹ã¯ã“ã¡ã‚‰
            </div>
            <button onclick="signInWithGoogleFromPC()"
                    style="display: inline-flex; align-items: center; gap: 10px; padding: 12px 24px;
                           background: white; border: 1px solid #d1d5db; border-radius: 8px;
                           font-size: 14px; font-weight: 500; color: #374151; cursor: pointer;
                           box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <svg width="20" height="20" viewBox="0 0 24 24">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
              </svg>
              Googleã§ãƒ­ã‚°ã‚¤ãƒ³
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ï¼ˆåˆå›ã®ã¿ï¼‰ -->
  <div id="setup-screen" style="display: none;">
    <div class="setup-container">
      <div class="setup-title">åˆæœŸè¨­å®š</div>
      <div class="setup-subtitle">åˆå›è¨­å®š - ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™</div>

      <!-- â‘ -1 ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ï¼ˆè¤‡æ•°æ–¹æ³•å¯¾å¿œï¼‰ -->
      <div class="step-section" id="google-auth-section">
        <div style="display: flex; align-items: flex-start; gap: 10px;">
          <span style="font-size: 18px; font-weight: 600; color: #3b82f6;">â‘ </span>
          <div style="flex: 1;">
            <span class="step-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼</span>
            <p style="font-size: 13px; color: #6b7280; margin-top: 6px; margin-bottom: 0;">
              ãŠå¥½ã¿ã®æ–¹æ³•ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„
            </p>
          </div>
        </div>
        <div style="margin-top: 16px; display: flex; flex-direction: column; gap: 10px;">
          <!-- Google ãƒ­ã‚°ã‚¤ãƒ³ -->
          <button onclick="signInWithGoogle()"
                  style="display: flex; align-items: center; justify-content: center; gap: 12px; padding: 12px 24px;
                         background: white; border: 2px solid #e5e7eb; border-radius: 8px;
                         font-size: 15px; font-weight: 500; color: #374151; cursor: pointer;
                         transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1); width: 100%;"
                  onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#d1d5db';"
                  onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb';">
            <svg width="20" height="20" viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Google ã§ãƒ­ã‚°ã‚¤ãƒ³
          </button>

          <!-- åŒºåˆ‡ã‚Šç·š -->
          <div style="display: flex; align-items: center; margin: 8px 0;">
            <div style="flex: 1; height: 1px; background: #e5e7eb;"></div>
            <span style="padding: 0 12px; font-size: 12px; color: #9ca3af;">ã¾ãŸã¯</span>
            <div style="flex: 1; height: 1px; background: #e5e7eb;"></div>
          </div>

          <!-- ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³ -->
          <button onclick="showEmailLogin()"
                  style="display: flex; align-items: center; justify-content: center; gap: 12px; padding: 12px 24px;
                         background: white; border: 2px solid #e5e7eb; border-radius: 8px;
                         font-size: 15px; font-weight: 500; color: #374151; cursor: pointer;
                         transition: all 0.2s; width: 100%;"
                  onmouseover="this.style.background='#f9fafb';"
                  onmouseout="this.style.background='white';">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#374151" stroke-width="2">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
              <polyline points="22,6 12,13 2,6"/>
            </svg>
            ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ­ã‚°ã‚¤ãƒ³
          </button>
        </div>
      </div>

      <!-- æ‰¿èªå¾…ã¡çŠ¶æ…‹è¡¨ç¤º -->
      <div class="step-section" id="pending-approval-section" style="display: none;">
        <div style="text-align: center; padding: 20px;">
          <div id="pending-icon" style="font-size: 48px; margin-bottom: 16px;">â³</div>
          <div id="pending-title" style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 8px;">
            æ‰¿èªå¾…ã¡
          </div>
          <p id="pending-message" style="font-size: 13px; color: #6b7280; margin-bottom: 16px;">
            ç®¡ç†è€…ã®æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚<br>
            æ‰¿èªã•ã‚Œã‚‹ã¨ã€è‡ªå‹•çš„ã«ã‚¢ãƒ—ãƒªãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
          </p>
          <div id="pending-user-info" style="background: #f3f4f6; padding: 12px; border-radius: 8px; font-size: 13px; color: #4b5563;">
          </div>
          <div id="pending-status" style="margin-top: 12px; font-size: 12px; color: #9ca3af;">
            <span class="loading-dot">â—</span> ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ‰¿èªçŠ¶æ³ã‚’ç¢ºèªä¸­...
          </div>
          <button id="pending-retry-btn" onclick="signOutAndRetry()"
                  style="margin-top: 16px; padding: 10px 20px; background: #f3f4f6; border: none;
                         border-radius: 6px; font-size: 13px; color: #6b7280; cursor: pointer;">
            åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³
          </button>
        </div>
      </div>

      <!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç„¡åŠ¹çŠ¶æ…‹è¡¨ç¤º -->
      <div class="step-section" id="disabled-account-section" style="display: none;">
        <div style="text-align: center; padding: 20px;">
          <div style="font-size: 48px; margin-bottom: 16px;">ğŸš«</div>
          <div style="font-size: 16px; font-weight: 600; color: #dc2626; margin-bottom: 8px;">
            ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç„¡åŠ¹
          </div>
          <p style="font-size: 13px; color: #6b7280; margin-bottom: 16px;">
            ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚<br>
            ã‚ªãƒ¼ãƒŠãƒ¼ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
          </p>
          <button onclick="signOutAndRetry()"
                  style="margin-top: 16px; padding: 10px 20px; background: #f3f4f6; border: none;
                         border-radius: 6px; font-size: 13px; color: #6b7280; cursor: pointer;">
            åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³
          </button>
        </div>
      </div>

      <!-- èªè¨¼çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆç‹¬ç«‹ï¼‰ -->
      <div id="auth-result" class="step-result" style="display: none; margin-bottom: 16px;"></div>

      <!-- â‘¡-1 æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² -->
      <div class="step-section" id="new-user-section" style="display: none;">
        <div>
          <span class="step-number">â‘¡</span>
          <span class="step-title">æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</span>
        </div>
        <div style="margin-top: 8px;">
          <label style="display: block; font-size: 13px; color: #6b7280; margin-bottom: 4px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆæ‹…å½“è€…åï¼‰</label>
          <input type="text" id="user-name-input" placeholder="ä¾‹: å±±ç”°å¤ªéƒ"
                 style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;">
        </div>
        <div style="margin-top: 12px;">
          <label style="display: block; font-size: 13px; color: #6b7280; margin-bottom: 4px;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
          <input type="email" id="user-email-input" placeholder="your-email@example.com" disabled
                 style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; background: #f9fafb; color: #6b7280;">
        </div>
        <div style="margin-top: 12px;" id="permission-selection-area">
          <label style="display: block; font-size: 13px; color: #6b7280; margin-bottom: 8px;">æ¨©é™</label>
          <div id="permission-options" style="display: flex; flex-direction: column; gap: 8px;">
            <!-- åˆå›ç™»éŒ²è€…å‘ã‘ï¼ˆJavaScript ã§å‹•çš„ã«è¡¨ç¤ºåˆ¶å¾¡ï¼‰ -->
            <!-- æ³¨: ã“ã‚Œã‚‰ã¯ loadAndRenderPermissions() ã§å‹•çš„ã«ä¸Šæ›¸ãã•ã‚Œã¾ã™ -->
            <label id="owner-option" style="display: none; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="user-permission" value="owner" data-display="ç®¡ç†è€…" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
              <div>
                <div style="font-size: 15px; font-weight: 600; color: #dc2626;">ğŸ‘‘ ç®¡ç†è€…</div>
                <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ç®¡ç†è€…</div>
              </div>
            </label>
            <label id="employee-option" style="display: flex; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="user-permission" value="employee" data-display="ç¤¾å“¡" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
              <div>
                <div style="font-size: 15px; font-weight: 600; color: #059669;">ğŸ‘” ç¤¾å“¡</div>
                <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">æ­£ç¤¾å“¡</div>
              </div>
            </label>
            <label id="staff-option" style="display: flex; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="user-permission" value="staff" data-display="ã‚¹ã‚¿ãƒƒãƒ•" checked style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
              <div>
                <div style="font-size: 15px; font-weight: 600; color: #1e40af;">ğŸ“‹ ã‚¹ã‚¿ãƒƒãƒ•</div>
                <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">ãƒ‘ãƒ¼ãƒˆãƒ»ã‚¢ãƒ«ãƒã‚¤ãƒˆ</div>
              </div>
            </label>
            <label id="leader-option" style="display: flex; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="user-permission" value="leader" data-display="ãƒªãƒ¼ãƒ€ãƒ¼" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
              <div>
                <div style="font-size: 15px; font-weight: 600; color: #d97706;">ğŸ–ï¸ ãƒªãƒ¼ãƒ€ãƒ¼</div>
                <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼</div>
              </div>
            </label>
            <label id="contractor-option" style="display: flex; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="user-permission" value="contractor" data-display="å¤–æ³¨" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
              <div>
                <div style="font-size: 15px; font-weight: 600; color: #4338ca;">ğŸ”§ å¤–æ³¨</div>
                <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">å¤–éƒ¨ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼</div>
              </div>
            </label>
          </div>
          <div id="permission-info" style="font-size: 12px; color: #9ca3af; margin-top: 8px; padding: 8px; background: #f9fafb; border-radius: 6px; display: none;">
          </div>
        </div>
        <div style="display: flex; gap: 8px; margin-top: 12px;">
          <button class="step-button" onclick="cancelEmailAuth()" style="background: #9ca3af; flex: 1;">â† æˆ»ã‚‹</button>
          <button class="step-button" onclick="saveNewUserInfo()" style="flex: 2;">ç™»éŒ²</button>
        </div>
        <div id="step0-result" class="step-result"></div>
      </div>

      <!-- é€šçŸ¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³æŒ¿å…¥ä½ç½®ï¼ˆJavaScriptã§å‹•çš„ã«è¿½åŠ ï¼‰ -->
      <div id="notification-section-container" style="display: none;"></div>

      <!-- ã‚¢ãƒ—ãƒªã‚’é–‹ã -->
      <button class="open-app-button" onclick="openApp()" id="open-app-button">ã‚¢ãƒ—ãƒªã‚’é–‹ã</button>
    </div>

    <!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ¡ˆå†… -->
    <div id="google-account-help" style="text-align: center; margin-top: 24px; padding: 0 20px;">
      <p style="color: rgba(255,255,255,0.85); font-size: 13px; margin-bottom: 12px;">
        Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„æ–¹
      </p>
      <a href="https://accounts.google.com/signup" target="_blank" rel="noopener noreferrer"
         style="color: white; font-size: 13px; text-decoration: underline; opacity: 0.9;">
        ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆï¼ˆç„¡æ–™ï¼‰â†’
      </a>
    </div>
  </div>

  <!-- ã‚¢ãƒ—ãƒªç”»é¢ï¼ˆ2å›ç›®ä»¥é™ or ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†å¾Œï¼‰ -->
  <div id="app-screen">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆé€šçŸ¥ãƒœã‚¿ãƒ³ + ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ + ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ï¼‰ -->
    <div id="app-header">
      <img src="/images/furira-text-logo-v2.png?v=20251209" alt="Furira" class="app-logo" onclick="navigateToPage('home')" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹" onerror="this.style.display='none'; document.getElementById('logo-fallback').style.display='flex';">
      <div id="logo-fallback" style="display:none; align-items:center; height:50px; font-size:24px; font-weight:bold; color:white; text-shadow:0 2px 4px rgba(0,0,0,0.2); cursor:pointer;" onclick="navigateToPage('home')">ãƒ•ãƒªãƒ©</div>
      <div class="header-buttons">
        <button class="notification-button" onclick="openChatRooms()" title="ãƒãƒ£ãƒƒãƒˆ">
          <span class="notification-icon">ğŸ’¬</span>
          <span class="badge-count" id="chat-badge-count">0</span>
        </button>
        <button class="notification-button" onclick="openTodoList()" title="ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆ" id="todo-list-button">
          <img src="/images/check-green2.png" alt="ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆ" class="notification-icon" style="width: 30px; height: 30px;">
          <span class="badge-count" id="todo-badge-count">0</span>
        </button>
        <button class="user-icon-button" id="header-user-icon" onclick="openUserSettings()" title="ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š">
          <span class="user-icon-placeholder" id="user-icon-placeholder">ğŸ‘¤</span>
          <img class="user-icon-image" id="user-icon-image" style="display: none;">
        </button>
        <button class="menu-button" onclick="toggleDrawer()" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">â˜°</button>
      </div>
    </div>

    <!-- ãƒ‰ãƒ­ãƒ¯ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="drawer-overlay" onclick="closeDrawer()"></div>

    <!-- ãƒ‰ãƒ­ãƒ¯ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div id="drawer-menu">
      <div class="drawer-header">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
      <a href="#" onclick="navigateToPage('product'); return false;" class="drawer-item active" id="drawer-product">
        ğŸ“ å•†å“ç™»éŒ²
      </a>
      <a href="#" onclick="navigateToPage('inventory'); return false;" class="drawer-item" id="drawer-inventory">
        ğŸ“¦ åœ¨åº«ç®¡ç†
      </a>
      <a href="#" onclick="navigateToPage('inventory_history'); return false;" class="drawer-item" id="drawer-inventory-history">
        ğŸ“Š å…¥å‡ºåº«å±¥æ­´
      </a>
      <a href="#" class="drawer-item disabled" id="drawer-stocktaking">
        ğŸ“‹ æ£šå¸
      </a>
      <a href="#" onclick="navigateToPage('chat'); return false;" class="drawer-item" id="drawer-chat">
        ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ
      </a>
      <a href="#" class="drawer-item disabled" id="drawer-purchase">
        ğŸ’° ä»•å…¥ï¼è²·æ›
      </a>
      <a href="#" class="drawer-item disabled" id="drawer-sales">
        ğŸ’µ å£²ä¸Šï¼å£²æ›
      </a>
      <a href="#" class="drawer-item disabled" id="drawer-sales-analysis">
        ğŸ“ˆ å£²ä¸Šåˆ†æ
      </a>
      
      <!-- ãƒã‚¹ã‚¿ç®¡ç†ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ -->
      <div class="drawer-accordion" id="drawer-master">
        <a href="#" class="drawer-accordion-header" onclick="toggleMasterAccordion(); return false;">
          ğŸ—‚ï¸ ãƒã‚¹ã‚¿ç®¡ç†
          <span class="drawer-accordion-arrow">â–¼</span>
        </a>
        <div class="drawer-accordion-content">
          <a href="#" onclick="navigateToPage('master-product'); return false;" class="drawer-accordion-item" id="drawer-master-product">
            ğŸ“¦ å•†å“é–¢é€£ãƒã‚¹ã‚¿ç®¡ç†
          </a>
          <a href="#" onclick="navigateToPage('master-business'); return false;" class="drawer-accordion-item" id="drawer-master-business">
            ğŸ¢ æ¥­å‹™é–¢é€£ãƒã‚¹ã‚¿ç®¡ç†
          </a>
        </div>
      </div>

      <!-- è¨­å®šç®¡ç†ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ -->
      <div class="drawer-accordion" id="drawer-config">
        <a href="#" class="drawer-accordion-header" onclick="toggleConfigAccordion(); return false;">
          âš™ï¸ è¨­å®šç®¡ç†
          <span class="drawer-accordion-arrow">â–¼</span>
        </a>
        <div class="drawer-accordion-content">
          <a href="#" onclick="navigateToPage('config-system'); return false;" class="drawer-accordion-item" id="drawer-config-system">
            âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
          </a>
          <a href="#" onclick="navigateToPage('config-product'); return false;" class="drawer-accordion-item" id="drawer-config-product">
            ğŸ“ å•†å“ç™»éŒ²è¨­å®š
          </a>
        </div>
      </div>
    </div>

    <!-- ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIï¼ˆåˆæœŸãƒ­ãƒ¼ãƒ‰ä¸­ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰ -->
    <div id="skeleton-loader">
      <div class="skeleton-header"></div>
      <div class="skeleton-form">
        <div class="skeleton-input"></div>
        <div class="skeleton-input"></div>
        <div class="skeleton-input"></div>
        <div class="skeleton-input"></div>
        <div class="skeleton-button"></div>
      </div>
      <!-- UI-013: ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ï¼ˆå‹•ãã®ã‚ã‚‹è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰ -->
      <div class="loading-spinner"></div>
    </div>

    <!-- GAS Web App ã‚’ iframe ã§è¡¨ç¤ºï¼ˆé…å»¶ãƒ­ãƒ¼ãƒ‰: DOMContentLoadedå¾Œã« srcè¨­å®šï¼‰ -->
    <iframe
      id="gas-iframe"
      data-src="https://script.google.com/macros/s/AKfycbx6ybbRLDqKQJ8IR-NPoVP8981Gtozzz0N3880XanEGRS4--iZtset8PFrVcD_u9YAHMA/exec?v=817&ts=20251112">
    </iframe>
  </div>

  <!-- ========================================
       æœ€å„ªå…ˆ: iframeâ†’è¦ª postMessageå—ä¿¡ãƒãƒ³ãƒ‰ãƒ©
       ========================================
       DOMContentLoadedã‚ˆã‚Šå‰ã«ç™»éŒ²ï¼ˆChatGPTæ¨å¥¨ï¼‰
  -->
  <script>
  (function() {
    console.log('[parent EARLY] postMessage listener ç™»éŒ²é–‹å§‹');

    window.addEventListener('message', function(e) {
      // ========== ãƒ‡ãƒãƒƒã‚°ç”¨è©³ç´°ãƒ­ã‚°ï¼ˆå¿…ãšå‡ºåŠ›ï¼‰ ==========
      console.log('[parent] ========== message RECEIVED ==========');
      console.log('[parent] origin:', e.origin);
      console.log('[parent] data:', e.data);
      console.log('[parent] source:', e.source);
      console.log('[parent] source === window:', e.source === window);

      // iframeå‚ç…§ï¼ˆé…å»¶è©•ä¾¡ï¼‰
      const iframe = document.getElementById('gas-iframe');
      const iframeWindow = iframe ? iframe.contentWindow : null;
      console.log('[parent] iframe.contentWindow:', iframeWindow);
      console.log('[parent] source === iframe.contentWindow:', e.source === iframeWindow);

      // ========== originæ¤œè¨¼ï¼ˆãƒ‡ãƒãƒƒã‚°ä¸­ã¯ç·©å’Œï¼‰ ==========
      const allowedOrigins = [
        'https://script.google.com',
        'https://script.googleusercontent.com',
        'https://furira.jp',
        'https://reborn-inventory-system.pages.dev'
      ];

      const isAllowedOrigin = allowedOrigins.some(origin => e.origin.startsWith(origin));
      console.log('[parent] isAllowedOrigin:', isAllowedOrigin);

      // ãƒ‡ãƒãƒƒã‚°ä¸­: originãƒã‚§ãƒƒã‚¯ã‚’è­¦å‘Šã®ã¿ã«ï¼ˆæœ¬ç•ªã§ã¯ return ã§é®æ–­ï¼‰
      if (!isAllowedOrigin) {
        console.warn('[parent] âš ï¸ message from unexpected origin (allowed for debug):', e.origin);
        // return; // ãƒ‡ãƒãƒƒã‚°ä¸­ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
      }

      // ========== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç† ==========
      const payload = e.data || {};
      console.log('[parent] payload.type:', payload.type);

      if (payload.type === 'showChatRoomsList') {
        console.log('[parent] âœ… showChatRoomsList è¦æ±‚ã‚’å—ä¿¡');
        console.log('[parent] openChatRooms() å‘¼ã³å‡ºã—é–‹å§‹');

        // openChatRoomsé–¢æ•°ãŒå®šç¾©ã•ã‚Œã‚‹ã¾ã§å¾…ã¤ï¼ˆDOMContentLoadedå¾Œã«å®šç¾©ã•ã‚Œã‚‹ï¼‰
        if (typeof openChatRooms === 'function') {
          openChatRooms();
          console.log('[parent] âœ… openChatRooms() å‘¼ã³å‡ºã—å®Œäº†');
        } else {
          console.warn('[parent] âš ï¸ openChatRooms() ãŒã¾ã å®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚é…å»¶å®Ÿè¡Œã—ã¾ã™ã€‚');
          // 100mså¾Œã«å†è©¦è¡Œ
          setTimeout(function() {
            if (typeof openChatRooms === 'function') {
              openChatRooms();
              console.log('[parent] âœ… openChatRooms() é…å»¶å‘¼ã³å‡ºã—å®Œäº†');
            } else {
              console.error('[parent] âŒ openChatRooms() ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
          }, 100);
        }
      } else if (payload.type === 'navigateTo') {
        console.log('[parent] ========== navigateToå‡¦ç†é–‹å§‹ ==========');
        console.log('[parent] âœ… navigateTo è¦æ±‚ã‚’å—ä¿¡');
        console.log('[parent] payload:', payload);
        console.log('[parent] url:', payload.url);
        console.log('[parent] ç¾åœ¨ã®URL:', window.location.href);

        if (payload.url) {
          console.log('[parent] ãƒšãƒ¼ã‚¸é·ç§»ã‚’å®Ÿè¡Œã—ã¾ã™:', payload.url);
          window.location.href = payload.url;
          console.log('[parent] âœ… window.location.hrefè¨­å®šå®Œäº†');
        } else {
          console.error('[parent] âŒ URLãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
          alert('ã‚¨ãƒ©ãƒ¼: é·ç§»å…ˆURLãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        }
        console.log('[parent] ========== navigateToå‡¦ç†å®Œäº† ==========');
      } else if (payload.type === 'navigateToHome') {
        console.log('[parent EARLY] ========== navigateToHomeå‡¦ç†é–‹å§‹ ==========');
        console.log('[parent EARLY] âœ… ãƒˆãƒƒãƒ—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹è¦æ±‚ã‚’å—ä¿¡');

        // navigateToPageé–¢æ•°ãŒå®šç¾©ã•ã‚Œã‚‹ã¾ã§å¾…ã¤
        if (typeof navigateToPage === 'function') {
          navigateToPage('home');
          console.log('[parent EARLY] âœ… navigateToPage(\'home\')å‘¼ã³å‡ºã—å®Œäº†');
        } else {
          console.warn('[parent EARLY] âš ï¸ navigateToPage() ãŒã¾ã å®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚é…å»¶å®Ÿè¡Œã—ã¾ã™ã€‚');
          setTimeout(function() {
            if (typeof navigateToPage === 'function') {
              navigateToPage('home');
              console.log('[parent EARLY] âœ… navigateToPage(\'home\') é…å»¶å‘¼ã³å‡ºã—å®Œäº†');
            } else {
              console.error('[parent EARLY] âŒ navigateToPage() ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
          }, 100);
        }
        console.log('[parent EARLY] ========== navigateToHomeå‡¦ç†å®Œäº† ==========');
      } else {
        console.log('[parent] âš ï¸ æœªçŸ¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—:', payload.type);
      }

      console.log('[parent] ========== messageå‡¦ç†å®Œäº† ==========');
    }, false);

    console.log('[parent EARLY] postMessage listener ç™»éŒ²å®Œäº†');
  })();
  </script>

  <!-- Firebase compat SDK (firestore-api.jsç”¨) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <!-- Firebase SDKs (Modular format) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getMessaging, onMessage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js';
    import { getFirestore, doc, getDoc, setDoc, collection, collectionGroup, addDoc, query, where, orderBy, getDocs, updateDoc, deleteDoc, Timestamp, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getAuth, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider, OAuthProvider, onAuthStateChanged, signOut, getAdditionalUserInfo } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

    // Firebase è¨­å®šï¼ˆreborn-chat ã«çµ±ä¸€ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "furira.jp",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    // Firebase åˆæœŸåŒ–ï¼ˆéã‚µãƒãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œï¼‰
    try {
      // Modular SDKåˆæœŸåŒ–
      const app = initializeApp(firebaseConfig);
      const messaging = getMessaging(app);
      const db = getFirestore(app);
      const storage = getStorage(app);
      const auth = getAuth(app);
      const googleProvider = new GoogleAuthProvider();

      // Apple Provider
      const appleProvider = new OAuthProvider('apple.com');
      appleProvider.addScope('email');
      appleProvider.addScope('name');

      // Compat SDKåˆæœŸåŒ–ï¼ˆfirestore-api.jsç”¨ï¼‰
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      window.db = firebase.firestore(); // Compatç‰ˆ

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å…¬é–‹
      window.firebaseMessaging = messaging;
      window.firebaseDB = db;
      window.firestoreDoc = doc;
      window.firestoreGetDoc = getDoc;
      window.firestoreSetDoc = setDoc;
      window.firestoreCollection = collection;
      window.firestoreCollectionGroup = collectionGroup;
      window.firestoreAddDoc = addDoc;
      window.firestoreQuery = query;
      window.firestoreWhere = where;
      window.firestoreOrderBy = orderBy;
      window.firestoreGetDocs = getDocs;
      window.firestoreUpdateDoc = updateDoc;
      window.firestoreDeleteDoc = deleteDoc;
      window.firestoreTimestamp = Timestamp;
      window.firestoreServerTimestamp = serverTimestamp;

      // Firebase Storage ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹
      window.firebaseStorage = storage;
      window.storageRef = ref;
      window.storageUploadBytes = uploadBytes;
      window.storageGetDownloadURL = getDownloadURL;
      window.storageDeleteObject = deleteObject;

      // Firebase Auth ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹
      window.firebaseAuth = auth;
      window.firebaseGoogleProvider = googleProvider;
      window.firebaseAppleProvider = appleProvider;
      window.firebaseSignInWithPopup = signInWithPopup;
      window.firebaseSignInWithRedirect = signInWithRedirect;
      window.firebaseGetRedirectResult = getRedirectResult;
      window.firebaseSignOut = signOut;
      window.firebaseOnAuthStateChanged = onAuthStateChanged;
      window.firebaseGetAdditionalUserInfo = getAdditionalUserInfo;

      // â˜… èªè¨¼çŠ¶æ…‹ã®ç›£è¦–ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼å¯¾å¿œ - æœ€ã‚‚ç¢ºå®Ÿãªæ–¹æ³•ï¼‰
      // onAuthStateChangedã¯ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ—¢å­˜ã®èªè¨¼çŠ¶æ…‹ã‚’æ¤œå‡º
      console.log('[Auth] ğŸ”„ onAuthStateChanged ãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²é–‹å§‹');
      window.authHandled = false; // äºŒé‡å‡¦ç†é˜²æ­¢ãƒ•ãƒ©ã‚°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–ï¼‰
      window.localStorageRecoveryAttempted = false; // localStorageå¾©å…ƒè©¦è¡Œãƒ•ãƒ©ã‚°
      onAuthStateChanged(auth, async (user) => {
        console.log('[Auth] ğŸ”” onAuthStateChangedç™ºç«:', user ? user.email : 'null');
        if (user && !window.authHandled) {
          window.authHandled = true;
          console.log('[Auth] âœ… ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œå‡º:', user.email);

          // ğŸ”§ ã‚¿ã‚¹ã‚¯ã‚­ãƒ«å¾Œã®localStorageå–ªå¤±å¯¾ç­–
          const setupCompleted = localStorage.getItem('fcm-setup-completed');
          if (setupCompleted !== '1' && !window.localStorageRecoveryAttempted) {
            window.localStorageRecoveryAttempted = true;
            console.log('[Auth] âš ï¸ localStorageå–ªå¤±ã‚’æ¤œå‡º - Firestoreã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹ã‚’ç¢ºèª');

            // ğŸ”§ é€šçŸ¥è¨±å¯ã®çŠ¶æ…‹ã‚’ç¢ºèª
            const notificationPermission = typeof Notification !== 'undefined' ? Notification.permission : 'default';
            console.log('[Auth] ğŸ”” Notification.permission:', notificationPermission);

            try {
              const db = window.firebaseDB;
              if (db && window.firestoreGetDoc && window.firestoreDoc) {
                const userDoc = await window.firestoreGetDoc(window.firestoreDoc(db, 'users', user.email));
                if (userDoc.exists()) {
                  const userData = userDoc.data();
                  console.log('[Auth] Firestore user status:', userData.status);
                  if (userData.status === 'active') {
                    // ğŸ”§ é€šçŸ¥è¨±å¯ãŒãªã„å ´åˆã¯ã€é€šçŸ¥è¨­å®šã ã‘å†åº¦è¡Œã†å¿…è¦ãŒã‚ã‚‹
                    if (notificationPermission !== 'granted') {
                      console.log('[Auth] âš ï¸ é€šçŸ¥è¨±å¯ãªã— - é€šçŸ¥å†è¨­å®šãŒå¿…è¦');
                      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã ã‘å¾©å…ƒã—ã€fcm-setup-completedã¯è¨­å®šã—ãªã„
                      localStorage.setItem('reborn_user_name', userData.userName || user.displayName || '');
                      localStorage.setItem('reborn_user_email', user.email);
                      localStorage.setItem('reborn_user_permission_id', userData.permissionId || 'staff');
                      localStorage.setItem('reborn_user_permission_display', userData.permissionDisplay || 'ã‚¹ã‚¿ãƒƒãƒ•');
                      if (userData.photoURL) localStorage.setItem('reborn_user_photo_url', userData.photoURL);
                      if (userData.userIconUrl) localStorage.setItem('reborn_user_icon_url', userData.userIconUrl);
                      localStorage.setItem('reborn_firebase_uid', user.uid);
                      // ğŸ”§ èªè¨¼æ¸ˆã¿ã ãŒé€šçŸ¥æœªè¨±å¯ã®ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
                      localStorage.setItem('reborn_auth_completed', '1');
                      console.log('[Auth] ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å¾©å…ƒå®Œäº†ï¼ˆé€šçŸ¥å†è¨­å®šå¿…è¦ï¼‰');
                      // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã§é€šçŸ¥è¨­å®šã‹ã‚‰é–‹å§‹ã™ã‚‹ãŸã‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ãªã„
                      // â†’ DOMContentLoadedã®setupCompleted !== '1' ã§é€šçŸ¥è¨­å®šç”»é¢ã¸
                    } else {
                      console.log('[Auth] âœ… ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ + é€šçŸ¥è¨±å¯ã‚ã‚Š - å®Œå…¨å¾©å…ƒ');
                      // localStorageã‚’å®Œå…¨å¾©å…ƒ
                      localStorage.setItem('fcm-setup-completed', '1');
                      localStorage.setItem('reborn_user_name', userData.userName || user.displayName || '');
                      localStorage.setItem('reborn_user_email', user.email);
                      localStorage.setItem('reborn_user_permission_id', userData.permissionId || 'staff');
                      localStorage.setItem('reborn_user_permission_display', userData.permissionDisplay || 'ã‚¹ã‚¿ãƒƒãƒ•');
                      if (userData.photoURL) localStorage.setItem('reborn_user_photo_url', userData.photoURL);
                      if (userData.userIconUrl) localStorage.setItem('reborn_user_icon_url', userData.userIconUrl);
                      localStorage.setItem('reborn_firebase_uid', user.uid);
                      // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢è¡¨ç¤ºã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                      if (window._setupScreenTimeout) {
                        clearTimeout(window._setupScreenTimeout);
                        console.log('[Auth] ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
                      }
                      // ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æ­£å¸¸ãƒ•ãƒ­ãƒ¼ã«æˆ»ã™
                      console.log('[Auth] ğŸ”„ ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ');
                      location.reload();
                      return;
                    }
                  }
                }
              }
            } catch (e) {
              console.warn('[Auth] localStorageå¾©å…ƒãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', e);
            }
          }

          // é€šå¸¸ã®ãƒ•ãƒ­ãƒ¼: DOMè¦ç´ ãŒæº–å‚™ã•ã‚Œã‚‹ã¾ã§å¾…ã¤
          let waitRetryCount = 0;
          const MAX_WAIT_RETRIES = 15; // æœ€å¤§3ç§’å¾…æ©Ÿï¼ˆ200ms Ã— 15ï¼‰
          const waitForDOM = () => {
            const authSection = document.getElementById('google-auth-section');
            const authResult = document.getElementById('auth-result');
            const setupScreen = document.getElementById('setup-screen');
            waitRetryCount++;
            console.log('[Auth] DOMç¢ºèª (' + waitRetryCount + '/' + MAX_WAIT_RETRIES + '): authSection=', !!authSection, 'authResult=', !!authResult, 'setupScreen=', !!setupScreen);

            // DOMè¦ç´ ãŒå­˜åœ¨ã™ã‚Œã°å‡¦ç†ã‚’é€²ã‚ã‚‹ï¼ˆsetupScreenã®è¡¨ç¤ºçŠ¶æ…‹ã¯å•ã‚ãªã„ï¼‰
            if (authSection && authResult && setupScreen) {
              console.log('[Auth] âœ… DOMæº–å‚™å®Œäº† - handleGoogleAuthResultå‘¼ã³å‡ºã—');
              window.handleGoogleAuthResult(user);
            } else if (waitRetryCount >= MAX_WAIT_RETRIES) {
              // æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ã«é”ã—ãŸå ´åˆã€DOMè¦ç´ ãŒãªãã¦ã‚‚é€²ã‚ã‚‹
              console.warn('[Auth] âš ï¸ DOMå¾…æ©Ÿã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ - å¼·åˆ¶çš„ã«å‡¦ç†ã‚’ç¶šè¡Œ');
              window.handleGoogleAuthResult(user);
            } else {
              console.log('[Auth] â³ DOMæœªæº–å‚™ - 200mså¾Œã«å†è©¦è¡Œ');
              setTimeout(waitForDOM, 200);
            }
          };
          // å°‘ã—å¾…ã£ã¦ã‹ã‚‰DOMç¢ºèªã‚’é–‹å§‹
          setTimeout(waitForDOM, 300);
        } else if (!user) {
          console.log('[Auth] ğŸ‘¤ æœªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹');
          window.authHandled = false; // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã«ãƒ•ãƒ©ã‚°ãƒªã‚»ãƒƒãƒˆ
        }
      });
      console.log('[Auth] âœ… onAuthStateChanged ãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²å®Œäº†');

      // â˜… ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰é€šçŸ¥å¯¾å¿œ â˜…
      // ã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦ã„ã‚‹çŠ¶æ…‹ã§é€šçŸ¥ã‚’å—ä¿¡ã—ãŸæ™‚ã®å‡¦ç†
      onMessage(messaging, (payload) => {
        console.log('ğŸ“¨ ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡:', payload);

        // é€šçŸ¥ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const notificationTitle = payload.data?.title || payload.notification?.title || 'Furira';
        const notificationBody = payload.data?.body || payload.notification?.body || 'æ–°ã—ã„é€šçŸ¥ãŒã‚ã‚Šã¾ã™';

        // çµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼šãƒãƒƒã‚¸ã¯Firestoreã‹ã‚‰è‡ªå‹•æ›´æ–°
        // if (typeof window.incrementBadge === 'function') {
        //   window.incrementBadge();
        //   console.log('ğŸ”” ãƒãƒƒã‚¸ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã—ã¾ã—ãŸ');
        // }

        // ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’è¡¨ç¤ºï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ°—ã¥ã„ã¦ã‚‚ã‚‰ã†ãŸã‚ï¼‰
        if (Notification.permission === 'granted') {
          new Notification(notificationTitle, {
            body: notificationBody,
            icon: '/icon-180.png',
            badge: '/icon-192.png',
            tag: 'reborn-notification',
            requireInteraction: false  // è‡ªå‹•ã§æ¶ˆãˆã‚‹
          });
          console.log('ğŸ”” ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
        }
      });
    } catch (error) {
      // Safariç­‰ã®éã‚µãƒãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯é™ã‹ã«ã‚¹ã‚­ãƒƒãƒ—
          window.firebaseMessaging = null;
    }
  </script>

  <!-- Firestore API Wrapper (ARCH-001 Phase 1.5) -->
  <script type="module" src="/js/firestore-api.js"></script>

  <!-- Master Cache System (MASTER-002: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰) -->
  <!-- master-config.js ã¨ master-cache.js ã¯å‹•çš„ãƒ­ãƒ¼ãƒ‰ã«ç§»è¡Œï¼ˆService Workerå¯¾ç­–ï¼‰ -->

  <script>
    // GAS API URL (Cloudflare Worker ãƒ—ãƒ­ã‚­ã‚·çµŒç”± - CORSå•é¡Œè§£æ±º)
    const GAS_API_URL = '/gas-proxy';

    // VAPIDå…¬é–‹éµ
    const VAPID_PUBLIC_KEY = 'BAhqpnZ0bAewADDuEn2-TGyKLZqL3vPRbI3W8j-_HZT6r82P-E66kcXjFD2Hzmhwd4nFNBVzHMwaqv0kPGaFeEE';

    // Service Worker registrationï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼‰
    let swRegistration = null;

    // ========================================
    // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ©Ÿèƒ½
    // ========================================
    let deferredPrompt = null; // beforeinstallpromptã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¿å­˜

    // beforeinstallpromptã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼ˆAndroid Chromeç”¨ï¼‰
    window.addEventListener('beforeinstallprompt', (e) => {
      console.log('[PWA Install] beforeinstallprompt ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«');
      e.preventDefault();
      deferredPrompt = e;
      // Androidç”¨ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
      const androidBtn = document.getElementById('android-install-btn');
      if (androidBtn) {
        androidBtn.style.display = 'inline-flex';
      }
    });

    // PWAã¨ã—ã¦èµ·å‹•ã—ã¦ã„ã‚‹ã‹åˆ¤å®š
    function isPWAMode() {
      // display-mode: standaloneï¼ˆAndroid/PCï¼‰
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
      // iOS Safari ã®ãƒ›ãƒ¼ãƒ ç”»é¢ã‹ã‚‰èµ·å‹•
      const isIOSStandalone = window.navigator.standalone === true;
      // TWAï¼ˆTrusted Web Activityï¼‰
      const isTWA = document.referrer.includes('android-app://');

      console.log('[PWA Install] åˆ¤å®š:', { isStandalone, isIOSStandalone, isTWA });
      return isStandalone || isIOSStandalone || isTWA;
    }

    // ãƒ‡ãƒã‚¤ã‚¹ã‚¿ã‚¤ãƒ—åˆ¤å®š
    function getDeviceType() {
      const ua = navigator.userAgent;
      if (/iPhone|iPad|iPod/.test(ua)) return 'ios';
      if (/Android/.test(ua)) return 'android';
      return 'pc';
    }

    // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”»é¢ã‚’è¡¨ç¤º
    function showInstallPrompt() {
      const installScreen = document.getElementById('install-prompt-screen');
      const setupScreen = document.getElementById('setup-screen');
      const appScreen = document.getElementById('app-screen');

      // å…¨ç”»é¢éè¡¨ç¤º
      if (setupScreen) setupScreen.style.display = 'none';
      if (appScreen) appScreen.style.display = 'none';

      // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤º
      if (installScreen) {
        installScreen.style.display = 'flex';
        installScreen.style.minHeight = '100vh';
        installScreen.style.background = 'linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%)';
        installScreen.style.justifyContent = 'center';
        installScreen.style.alignItems = 'center';
      }

      // ãƒ‡ãƒã‚¤ã‚¹ã«å¿œã˜ãŸã‚¬ã‚¤ãƒ‰ã‚’è¡¨ç¤º
      const deviceType = getDeviceType();
      const iosGuide = document.getElementById('ios-install-guide');
      const androidGuide = document.getElementById('android-install-guide');
      const pcGuide = document.getElementById('pc-install-guide');

      if (iosGuide) iosGuide.style.display = deviceType === 'ios' ? 'block' : 'none';
      if (androidGuide) androidGuide.style.display = deviceType === 'android' ? 'block' : 'none';
      if (pcGuide) pcGuide.style.display = deviceType === 'pc' ? 'block' : 'none';

      // Androidã§beforeinstallpromptãŒãªã„å ´åˆã¯æ‰‹å‹•ã‚¬ã‚¤ãƒ‰ã‚’è¡¨ç¤º
      if (deviceType === 'android' && !deferredPrompt) {
        const manualGuide = document.getElementById('android-manual-guide');
        const installBtn = document.getElementById('android-install-btn');
        if (manualGuide) manualGuide.style.display = 'block';
        if (installBtn) installBtn.style.display = 'none';
      }

      console.log('[PWA Install] ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤º:', deviceType);
    }

    // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Ÿè¡Œï¼ˆAndroidç”¨ï¼‰
    window.installPWA = async function installPWA() {
      if (!deferredPrompt) {
        console.log('[PWA Install] deferredPromptãŒã‚ã‚Šã¾ã›ã‚“');
        // æ‰‹å‹•ã‚¬ã‚¤ãƒ‰ã‚’è¡¨ç¤º
        const manualGuide = document.getElementById('android-manual-guide');
        if (manualGuide) manualGuide.style.display = 'block';
        return;
      }

      console.log('[PWA Install] ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º');
      deferredPrompt.prompt();

      const { outcome } = await deferredPrompt.userChoice;
      console.log('[PWA Install] ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠ:', outcome);

      if (outcome === 'accepted') {
        console.log('[PWA Install] ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰¿èª');
        // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã¯ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã¸
        skipInstallPrompt();
      }

      deferredPrompt = null;
    }

    // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
    window.skipInstallPrompt = function skipInstallPrompt() {
      const installScreen = document.getElementById('install-prompt-screen');
      const setupScreen = document.getElementById('setup-screen');

      if (installScreen) installScreen.style.display = 'none';
      if (setupScreen) setupScreen.style.display = 'flex';

      // ã‚¹ã‚­ãƒƒãƒ—ã—ãŸã“ã¨ã‚’è¨˜éŒ²ï¼ˆæ¬¡å›ä»¥é™ã¯è¡¨ç¤ºã—ãªã„ï¼‰
      localStorage.setItem('pwa-install-prompt-skipped', '1');

      console.log('[PWA Install] ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—');
    }

    // ========================================
    // ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆPhase 1: GASçµŒç”±ï¼‰
    // ========================================
    window.brandsCache = null;
    window.brandsPreloading = false;
    window.brandsCacheTimestamp = null;

    /**
     * GASçµŒç”±ã§Firestoreã‹ã‚‰ç®¡ç†ç•ªå·è¨­å®šã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆAlgoliaç§»è¡Œç‰ˆï¼‰
     * - ãƒ–ãƒ©ãƒ³ãƒ‰ã¯Algoliaã§æ¤œç´¢ï¼ˆãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ä¸è¦ï¼‰
     * - ç®¡ç†ç•ªå·è¨­å®šã®ã¿GASçµŒç”±ã§å–å¾—ï¼ˆ1-2ç§’ã§å®Œäº†ï¼‰
     */
    async function preloadManagementConfigForPWA() {
      if (window.managementConfigCache || window.managementConfigPreloading) {
        console.log('â© [PWA] ç®¡ç†ç•ªå·è¨­å®šãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ—¢ã«ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã¾ãŸã¯ãƒ­ãƒ¼ãƒ‰ä¸­ï¼‰');
        return;
      }

      window.managementConfigPreloading = true;
          const startTime = performance.now();

      try {
        // GAS getManagementConfig() ã‚’å‘¼ã³å‡ºã—
        const response = await fetch(GAS_API_URL + '?action=getManagementConfig');

        if (!response.ok) {
          throw new Error('GAS API ã‚¨ãƒ©ãƒ¼: ' + response.status);
        }

        const config = await response.json();

        window.managementConfigCache = config;
        window.managementConfigCacheTimestamp = Date.now();
        window.managementConfigPreloading = false;

        const endTime = performance.now();
        const duration = (endTime - startTime).toFixed(2);

        console.log(`âœ… [PWA-GASçµŒç”±] ç®¡ç†ç•ªå·è¨­å®šãƒ—ãƒªãƒ­ãƒ¼ãƒ‰å®Œäº†: prefix="${config?.prefix}", segments=${config?.segments?.length}ä»¶ (${duration}ms)`);

        return config;

      } catch (error) {
        console.error('âŒ [PWA-GASçµŒç”±] ç®¡ç†ç•ªå·è¨­å®šãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
        window.managementConfigPreloading = false;
        return null;
      }
    }

    // Unhandled Promise Rejection ã‚’ã‚­ãƒ£ãƒƒãƒï¼ˆSafariç­‰ã®FCMã‚¨ãƒ©ãƒ¼å¯¾å¿œï¼‰
    window.addEventListener('unhandledrejection', (event) => {
      // Firebase Messagingã®éã‚µãƒãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¶ã‚¨ãƒ©ãƒ¼ã¯é™ã‹ã«ç„¡è¦–
      if (event.reason && event.reason.message && event.reason.message.includes('messaging/unsupported-browser')) {
              event.preventDefault(); // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’æŠ‘åˆ¶
      }
    });

    // ================= æ¨©é™ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ï¼ˆPERM-001 v4ï¼‰ =================
    // ãƒ‰ãƒ­ãƒ¯ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼IDãƒãƒƒãƒ”ãƒ³ã‚°
    const DRAWER_MENU_ID_MAP = {
      'product': 'drawer-product',
      'inventory': 'drawer-inventory',
      'inventory_history': 'drawer-inventory-history',
      'stocktaking': 'drawer-stocktaking',
      'purchase': 'drawer-purchase',
      'sales': 'drawer-sales',
      'sales-analysis': 'drawer-sales-analysis',
      'chat': 'drawer-chat',
      'master-product': 'drawer-master-product',
      'master-business': 'drawer-master-business',
      'config-product': 'drawer-config-product',
      'config-system': 'drawer-config-system'
    };

    async function checkUserPermissionForSidebar() {
      try {
        const userEmail = localStorage.getItem('reborn_user_email');
        const userName = localStorage.getItem('reborn_user_name');

        if (!userEmail) {
          console.warn('[index.html] âš ï¸ æ¨©é™ãƒã‚§ãƒƒã‚¯: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        console.log('[index.html] ğŸ” æ¨©é™ãƒã‚§ãƒƒã‚¯é–‹å§‹:', userName, '(', userEmail, ')');

        if (!window.db) {
          console.warn('[index.html] âš ï¸ æ¨©é™ãƒã‚§ãƒƒã‚¯: FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
          return;
        }

        // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™IDã‚’å–å¾—
        const userDoc = await window.db.collection('users').doc(userEmail).get();

        if (!userDoc.exists) {
          console.warn('[index.html] âš ï¸ æ¨©é™ãƒã‚§ãƒƒã‚¯: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        const userData = userDoc.data();
        const permissionId = userData.permissionId || 'staff';
        const permissionDisplay = userData.permissionDisplay || 'ã‚¹ã‚¿ãƒƒãƒ•';

        console.log('[index.html] ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™:', permissionDisplay, '(ID:', permissionId + ')');

        // æ¨©é™ã‚’localStorageã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        localStorage.setItem('reborn_user_permission', permissionId);

        // ã‚ªãƒ¼ãƒŠãƒ¼ã¯å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º
        if (permissionId === 'owner') {
          console.log('[index.html] âœ… ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ - å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º');
          return;
        }

        // 2. ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ¨©é™è¨­å®šã‚’å–å¾—
        const menuPermDoc = await window.db.collection('settings').doc('menuPermissions').get();

        if (!menuPermDoc.exists) {
          console.log('[index.html] â„¹ï¸ ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ¨©é™è¨­å®šãªã— - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤º');
          return;
        }

        const menuPermissions = menuPermDoc.data();
        console.log('[index.html] ğŸ“‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ¨©é™è¨­å®š:', menuPermissions);

        // 3. å„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ¶å¾¡
        let hiddenCount = 0;
        for (const [menuId, elementId] of Object.entries(DRAWER_MENU_ID_MAP)) {
          const menuPerm = menuPermissions[menuId];
          const element = document.getElementById(elementId);

          if (!element) continue;

          // visibleToã«æ¨©é™IDãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          const isVisible = !menuPerm || !menuPerm.visibleTo || menuPerm.visibleTo.includes(permissionId);

          if (!isVisible) {
            element.style.display = 'none';
            hiddenCount++;
            console.log('[index.html] ğŸ”’ ãƒ‰ãƒ­ãƒ¯ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼éè¡¨ç¤º:', menuId);
          }
        }

        console.log('[index.html] âœ… æ¨©é™ãƒã‚§ãƒƒã‚¯å®Œäº† - éè¡¨ç¤ºãƒ¡ãƒ‹ãƒ¥ãƒ¼æ•°:', hiddenCount);

      } catch (error) {
        console.error('[index.html] âŒ æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–ï¼ˆDOMContentLoaded: ã‚ˆã‚Šé«˜é€Ÿï¼‰
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('âš¡ DOMContentLoaded - åˆæœŸåŒ–é–‹å§‹');

      // Service Workerç™»éŒ²
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
          swRegistration = registration;
          console.log('âœ… Service Worker ç™»éŒ²æˆåŠŸ:', registration.scope);
        } catch (error) {
          console.error('âŒ Service Worker ç™»éŒ²å¤±æ•—:', error);
        }
      }

      // çµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼šãƒãƒƒã‚¸ã¯Firestoreã‹ã‚‰è‡ªå‹•æ›´æ–°
      // initBadge(); // æ—§ã‚·ã‚¹ãƒ†ãƒ å‰Šé™¤

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’èª­ã¿è¾¼ã¿
      loadUserIcon();

      // ã‚¢ãƒ—ãƒªå†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã®Firestoreã‚¢ã‚¤ã‚³ãƒ³ã‚¯ãƒªã‚¢
      await clearFirestoreUserIconIfNeeded();

      // ===== PWAåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ =====
      // ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦ã„ã‚‹å ´åˆã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º
      const isPWA = isPWAMode();
      const installPromptSkipped = localStorage.getItem('pwa-install-prompt-skipped') === '1';
      const setupCompleted = localStorage.getItem('fcm-setup-completed');

      console.log('[PWA Check] isPWA:', isPWA, 'skipped:', installPromptSkipped, 'setupCompleted:', setupCompleted);

      if (!isPWA && !installPromptSkipped && setupCompleted !== '1') {
        // ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦ãŠã‚Šã€ã¾ã ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ãŠã‚‰ãšã€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº†
        // â†’ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º
        console.log('[PWA Check] ãƒ–ãƒ©ã‚¦ã‚¶è¡¨ç¤ºï¼†æœªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— â†’ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤º');
        showInstallPrompt();
        return; // ä»¥é™ã®å‡¦ç†ã¯å®Ÿè¡Œã—ãªã„ï¼ˆã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ã§ç¶šè¡Œï¼‰
      }

      // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
      if (setupCompleted !== '1') {
        // ğŸ”§ ã‚¿ã‚¹ã‚¯ã‚­ãƒ«å¾Œã®localStorageå–ªå¤±å¯¾ç­–:
        // å³åº§ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã‚’è¡¨ç¤ºã›ãšã€onAuthStateChangedã®çµæœã‚’å¾…ã¤
        // ï¼ˆèªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã‚‰localStorageã‚’å¾©å…ƒã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ï¼‰
        console.log('[Setup] localStorageæœªå®Œäº† - èªè¨¼çŠ¶æ…‹ç¢ºèªã‚’å¾…æ©Ÿ');

        // 2ç§’å¾Œã«ã¾ã ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã‘ã‚Œã°ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã‚’è¡¨ç¤ºï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰
        window._setupScreenTimeout = setTimeout(async () => {
          // localStorageãŒå¾©å…ƒã•ã‚Œã¦ã„ãŸã‚‰ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã®ã¯ãšï¼‰
          if (localStorage.getItem('fcm-setup-completed') === '1') {
            console.log('[Setup] localStorageå¾©å…ƒæ¸ˆã¿ - ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã‚¹ã‚­ãƒƒãƒ—');
            return;
          }
          console.log('[Setup] ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ - ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã‚’è¡¨ç¤º');
          document.getElementById('setup-screen').style.display = 'flex';
          document.getElementById('app-screen').style.display = 'none';
          await loadAndRenderPermissions();

          // ğŸ”§ èªè¨¼æ¸ˆã¿ã ãŒé€šçŸ¥æœªè¨±å¯ã®å ´åˆã€Googleãƒ­ã‚°ã‚¤ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦é€šçŸ¥è¨­å®šã¸
          if (localStorage.getItem('reborn_auth_completed') === '1') {
            console.log('[Setup] èªè¨¼æ¸ˆã¿ - Googleãƒ­ã‚°ã‚¤ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦é€šçŸ¥è¨­å®šã¸');
            document.getElementById('google-auth-section').style.display = 'none';
            // é€šçŸ¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            const notifContainer = document.getElementById('notification-section-container');
            if (notifContainer) {
              notifContainer.innerHTML = `
                <div class="step-section" id="notification-section">
                  <div style="display: flex; align-items: flex-start; gap: 10px;">
                    <span style="font-size: 18px; font-weight: 600; color: #3b82f6;">ğŸ””</span>
                    <span class="step-title" style="flex: 1;">é€šçŸ¥ã‚’å†åº¦æœ‰åŠ¹ã«ã™ã‚‹</span>
                  </div>
                  <p style="font-size: 14px; color: #666; margin: 10px 0;">é€šçŸ¥è¨±å¯ãŒå¤±ã‚ã‚Œã¦ã„ã¾ã™ã€‚å†åº¦æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚</p>
                  <button class="step-button" onclick="enableNotifications()" id="enable-notifications-btn">é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>
                  <div id="notification-result" class="step-result"></div>
                </div>
              `;
              notifContainer.style.display = 'block';
              console.log('[Setup] é€šçŸ¥å†è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º');
            }
          }
        }, 2000);

        // æ¨©é™é¸æŠè‚¢ã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆè¡¨ç¤ºå‰ã«æº–å‚™ï¼‰
        loadAndRenderPermissions();
      } else {
        // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†æ¸ˆã¿ â†’ FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆPhase 2: NOTIF-003ï¼‰
        await checkAndUpdateFCMToken();

        // æ¨©é™ãƒã‚§ãƒƒã‚¯ã—ã¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’åˆ¶å¾¡ï¼ˆPERM-001ï¼‰
        await checkUserPermissionForSidebar();

        // ğŸ  åˆæœŸè¨­å®šå®Œäº†æ¸ˆã¿ã®å ´åˆã€ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’éè¡¨ç¤ºã«ã—ã¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã‚’è¡¨ç¤ºï¼ˆUI-013ï¼‰
        // ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIè¡¨ç¤ºä¸­ã‚‚ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’éè¡¨ç¤ºã«ä¿ã¤
        const header = document.getElementById('app-header');
        if (header) {
          header.style.display = 'none';
        }

        // ğŸš€ åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«PWAç‰ˆmenu_homeã‚’ç›´æ¥ãƒ­ãƒ¼ãƒ‰ï¼ˆGASç‰ˆã‚’çµŒç”±ã—ãªã„ï¼‰
        const iframe = document.getElementById('gas-iframe');
        if (iframe) {
          // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDç”Ÿæˆï¼ˆç«¯æœ«ãƒ»ã‚¿ãƒ–ã”ã¨ã«ä¸€æ„ï¼‰
          if (!sessionStorage.getItem('device_session_id')) {
            const newSessionId = Date.now() + '_' + Math.random().toString(36).substring(2);
            sessionStorage.setItem('device_session_id', newSessionId);
            console.log('ğŸ†” æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ç”Ÿæˆ:', newSessionId);
          }
          const sessionId = sessionStorage.getItem('device_session_id');

          // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
          const userName = localStorage.getItem('reborn_user_name') || '';
          // userIconUrl ã¯localStorageã‹ã‚‰ç›´æ¥èª­ã¿è¾¼ã‚€ãŸã‚ã€URLã«ã¯å«ã‚ãªã„ï¼ˆURI Too Longå¯¾ç­–ï¼‰

          const pwaBaseUrl = location.origin;
          const params = new URLSearchParams({
            userName: userName,
            sessionId: sessionId
          });
          const menuHomeUrl = pwaBaseUrl + '/menu_home.html?' + params.toString();

          console.log('ğŸ  [åˆæœŸè¨­å®šå®Œäº†æ¸ˆã¿] PWAç‰ˆmenu_homeã‚’ç›´æ¥ãƒ­ãƒ¼ãƒ‰:', menuHomeUrl);
          console.log('ğŸ†” sessionId:', sessionId);
          console.log('ğŸ‘¤ userName:', userName);
          iframe.setAttribute('data-src', menuHomeUrl);

          // ç®¡ç†ç•ªå·è¨­å®šã®GASçµŒç”±ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã‚’å»ƒæ­¢ï¼ˆ2025-11-19ï¼‰
          // ç†ç”±: product.html ãŒ Firestore ã‹ã‚‰ç›´æ¥èª­ã¿è¾¼ã‚€ãŸã‚ä¸è¦
          /*
          setTimeout(() => {
                      preloadManagementConfigForPWA();
          }, 5000);
          */
        }
      }

      // iframeèª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIã‚’éè¡¨ç¤º
      const iframe = document.getElementById('gas-iframe');
      const skeleton = document.getElementById('skeleton-loader');

      if (iframe && skeleton) {
        // ã‚¹ã‚±ãƒ«ãƒˆãƒ³éè¡¨ç¤ºã®å…±é€šé–¢æ•°
        const hideSkeleton = () => {
          if (!skeleton.classList.contains('hidden')) {
            skeleton.classList.add('hidden');
            setTimeout(() => {
              skeleton.style.display = 'none';
            }, 300);
          }
        };

        iframe.addEventListener('load', hideSkeleton);

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: 5ç§’å¾Œã«å¼·åˆ¶çš„ã«ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚’éè¡¨ç¤ºï¼ˆiframeãƒ­ãƒ¼ãƒ‰ãŒãƒãƒ³ã‚°ã—ãŸå ´åˆï¼‰
        setTimeout(() => {
          if (!skeleton.classList.contains('hidden')) {
            console.warn('âš ï¸ iframeèª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ5ç§’ï¼‰- ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚’å¼·åˆ¶éè¡¨ç¤º');
            hideSkeleton();
          }
        }, 5000);

        // ğŸš€ iframeé…å»¶ãƒ­ãƒ¼ãƒ‰: åˆæœŸè¡¨ç¤ºã‚’é«˜é€ŸåŒ–
        // DOMæ§‹ç¯‰å®Œäº†å¾Œã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰iframeã‚’èª­ã¿è¾¼ã¿é–‹å§‹
        console.log('â±ï¸ iframeé…å»¶ãƒ­ãƒ¼ãƒ‰: 100mså¾Œã«é–‹å§‹');
        setTimeout(() => {
          const iframeSrc = iframe.getAttribute('data-src');
          if (iframeSrc) {
            // ğŸ” postMessageç”¨ã®parentOriginã¨pmTokenã‚’ç”Ÿæˆï¼ˆäºŒé‡iframeå¯¾ç­–ï¼‰
            const parentOrigin = location.origin;
            const pmToken = crypto.getRandomValues(new Uint32Array(1))[0].toString(36);
            localStorage.setItem('pm_token', pmToken);
            console.log('ğŸ” [postMessage Security] åˆæœŸèª­ã¿è¾¼ã¿ - parentOrigin:', parentOrigin, 'pmToken:', pmToken);

            // FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’localStorageã‹ã‚‰å–å¾—ã—ã¦URLã«è¿½åŠ 
            const fcmToken = localStorage.getItem('reborn_fcm_token') || '';
            const fcmParam = fcmToken ? '&fcmToken=' + encodeURIComponent(fcmToken) : '';
            const securityParams = '&parentOrigin=' + encodeURIComponent(parentOrigin) + '&pmToken=' + encodeURIComponent(pmToken);
            const finalSrc = iframeSrc + fcmParam + securityParams;

            console.log('ğŸš€ iframeèª­ã¿è¾¼ã¿é–‹å§‹:', finalSrc.substring(0, 120) + '...');
            console.log('ğŸ”‘ FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’iframeã«æ¸¡ã—ã¾ã™:', fcmToken ? fcmToken.substring(0, 20) + '...' : 'ãªã—');
            iframe.src = finalSrc;
          }
        }, 100); // 100msé…å»¶ï¼ˆä½“æ„Ÿé€Ÿåº¦å‘ä¸Šã®ãŸã‚ï¼‰
      }

      // ãƒã‚¹ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã¯å‰Šé™¤
      // ãƒã‚¹ã‚¿ç®¡ç†ç”»é¢ã‚’é–‹ã„ãŸæ™‚ã«åˆã‚ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªè¨­è¨ˆã«å¤‰æ›´
    });

    // FirestoreãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ç›£è¦–ï¼ˆãƒãƒ£ãƒƒãƒˆæˆ»ã‚‹ãƒœã‚¿ãƒ³ç”¨ï¼‰
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('[Navigation] Firestoreãƒªã‚¹ãƒŠãƒ¼åˆæœŸåŒ–é–‹å§‹');

      try {
        // Firebaseè¨­å®š
        const firebaseConfig = {
          apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
          authDomain: "furira.jp",
          projectId: "reborn-chat",
          storageBucket: "reborn-chat.firebasestorage.app",
          messagingSenderId: "345706548795",
          appId: "1:345706548795:web:058a553da6b4b74db5161e"
        };

        // Firebaseå‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        const { initializeApp, getApps } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
        const { getFirestore, doc, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        // FirebaseåˆæœŸåŒ–ï¼ˆæ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ãªã‚‰ãã‚Œã‚’ä½¿ç”¨ï¼‰
        const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig, 'navigation-listener');
        const db = getFirestore(app);

        console.log('[Navigation] Firestoreãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');

        // navigationã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
        let isFirstSnapshot = true;
        onSnapshot(doc(db, 'navigation', 'chatControl'), (snapshot) => {
          if (snapshot.exists()) {
            const data = snapshot.data();
            console.log('[Navigation] Chat Firestoreæ›´æ–°æ¤œçŸ¥:', data);

            // åˆå›èª­ã¿è¾¼ã¿ã¯ç„¡è¦–ï¼ˆå¤ã„ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‹èª¤ä½œå‹•ã‚’é˜²ãï¼‰
            if (isFirstSnapshot) {
              console.log('[Navigation] Chatåˆå›èª­ã¿è¾¼ã¿ã®ãŸã‚ç„¡è¦–');
              isFirstSnapshot = false;
              return;
            }

            // è‡ªåˆ†ã®sessionIdã¨ä¸€è‡´ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const mySessionId = sessionStorage.getItem('device_session_id');
            console.log('[Navigation] Chat mySessionId:', mySessionId);
            console.log('[Navigation] Chat data.sessionId:', data.sessionId);

            if (data.sessionId !== mySessionId) {
              console.log('[Navigation] â­ï¸ ä»–ã®ç«¯æœ«ã®ãƒãƒ£ãƒƒãƒˆæ“ä½œã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
              return;
            }

            if (data.action === 'goBackToList') {
              console.log('[Navigation] âœ… goBackToListè¦æ±‚ã‚’å—ä¿¡ â†’ openChatRooms()å‘¼ã³å‡ºã—');
              if (typeof openChatRooms === 'function') {
                openChatRooms();
              } else {
                console.error('[Navigation] openChatRooms()ãŒæœªå®šç¾©');
              }
            }
          }
        }, (error) => {
          console.error('[Navigation] Firestoreãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
        });

        // menuControlãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã‹ã‚‰ã®é·ç§»ç”¨ï¼‰
        let isFirstMenuSnapshot = true;
        console.log('[Navigation] âœ… menuControlãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²é–‹å§‹');
        onSnapshot(doc(db, 'navigation', 'menuControl'), (snapshot) => {
          console.log('[Navigation] ğŸ”” Menu onSnapshot ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ');
          console.log('[Navigation] snapshot.exists():', snapshot.exists());

          if (snapshot.exists()) {
            const data = snapshot.data();
            console.log('[Navigation] Menuæ›´æ–°æ¤œçŸ¥ - å…¨ãƒ‡ãƒ¼ã‚¿:', JSON.stringify(data));
            console.log('[Navigation] isFirstMenuSnapshot:', isFirstMenuSnapshot);

            // åˆå›èª­ã¿è¾¼ã¿ã¯ç„¡è¦–ï¼ˆå¤ã„ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‹èª¤ä½œå‹•ã‚’é˜²ãï¼‰
            if (isFirstMenuSnapshot) {
              console.log('[Navigation] â­ï¸ Menuåˆå›èª­ã¿è¾¼ã¿ã®ãŸã‚ç„¡è¦–');
              isFirstMenuSnapshot = false;
              return;
            }

            console.log('[Navigation] data.action:', data.action);
            console.log('[Navigation] data.page:', data.page);
            console.log('[Navigation] data.sessionId:', data.sessionId);

            // è‡ªåˆ†ã®sessionIdã¨ä¸€è‡´ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const mySessionId = sessionStorage.getItem('device_session_id');
            console.log('[Navigation] mySessionId:', mySessionId);

            if (data.sessionId !== mySessionId) {
              console.log('[Navigation] â­ï¸ ä»–ã®ç«¯æœ«ã®æ“ä½œã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
              return;
            }

            if (data.action === 'navigate' && data.page) {
              console.log('[Navigation] âœ… navigateè¦æ±‚ã‚’å—ä¿¡ â†’ navigateToPage()å‘¼ã³å‡ºã—:', data.page);
              if (typeof navigateToPage === 'function') {
                navigateToPage(data.page);
                console.log('[Navigation] âœ… navigateToPage()å‘¼ã³å‡ºã—å®Œäº†ï¼ˆ200msé…å»¶ãƒ¢ãƒ¼ãƒ‰ï¼‰');
              } else {
                console.error('[Navigation] âŒ navigateToPage()ãŒæœªå®šç¾©');
              }
            } else {
              console.log('[Navigation] âš ï¸ action or page ãŒä¸æ­£:', { action: data.action, page: data.page });
            }
          } else {
            console.log('[Navigation] âš ï¸ menuControlãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“');
          }
        }, (error) => {
          console.error('[Navigation] âŒ Menuãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
        });

      } catch (error) {
        console.error('[Navigation] FirestoreåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      }
    });

    /**
     * Firestore settings/permissions ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
     * å­˜åœ¨ã—ãªã„å ´åˆã¯è‡ªå‹•çš„ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
     */
    async function initializePermissionsSettings() {
      const db = window.firebaseDB;
      const docFunc = window.firestoreDoc;
      const getDocFunc = window.firestoreGetDoc;
      const setDocFunc = window.firestoreSetDoc;
      const serverTimestampFunc = window.firestoreServerTimestamp;

      if (!db || !docFunc || !getDocFunc || !setDocFunc || !serverTimestampFunc) {
        console.error('[initPermissions] Firestoreé–¢æ•°ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return null;
      }

      // æœ€æ–°ã®æ¨©é™è¨­å®šï¼ˆversion: 2 = 5ã¤ã®æ¨©é™ï¼‰
      const latestPermissions = {
        roles: [
          {
            id: 'owner',
            display: 'ç®¡ç†è€…',
            description: 'ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ç®¡ç†è€…',
            order: 1,
            isSystem: true,
            canModify: false
          },
          {
            id: 'employee',
            display: 'ç¤¾å“¡',
            description: 'æ­£ç¤¾å“¡',
            order: 2,
            isSystem: true,
            canModify: false
          },
          {
            id: 'staff',
            display: 'ã‚¹ã‚¿ãƒƒãƒ•',
            description: 'ãƒ‘ãƒ¼ãƒˆãƒ»ã‚¢ãƒ«ãƒã‚¤ãƒˆ',
            order: 3,
            isSystem: true,
            canModify: false
          },
          {
            id: 'leader',
            display: 'ãƒªãƒ¼ãƒ€ãƒ¼',
            description: 'ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼',
            order: 4,
            isSystem: true,
            canModify: false
          },
          {
            id: 'contractor',
            display: 'å¤–æ³¨',
            description: 'å¤–éƒ¨ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼',
            order: 5,
            isSystem: true,
            canModify: false
          }
        ],
        lastUpdated: serverTimestampFunc(),
        version: 2
      };

      try {
        const permissionsDocRef = docFunc(db, 'settings', 'permissions');
        const permissionsDoc = await getDocFunc(permissionsDocRef);

        if (permissionsDoc.exists()) {
          const existingData = permissionsDoc.data();
          const existingVersion = existingData.version || 1;

          // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ï¼šå¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å ´åˆã¯ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
          if (existingVersion < 2) {
            console.log('[initPermissions] ğŸ”„ æ¨©é™è¨­å®šã‚’v1ã‹ã‚‰v2ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­...');
            await setDocFunc(permissionsDocRef, latestPermissions);
            console.log('[initPermissions] âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†ï¼ˆ5ã¤ã®æ¨©é™ã«æ›´æ–°ï¼‰');
            return latestPermissions;
          }

          console.log('[initPermissions] âœ… æ¨©é™è¨­å®šãŒæ—¢ã«æœ€æ–°ã§ã™ (version:', existingVersion, ')');
          return existingData;
        }

        // å­˜åœ¨ã—ãªã„å ´åˆã€æ–°è¦ä½œæˆ
        console.log('[initPermissions] ğŸ”„ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ¨©é™è¨­å®šã‚’ä½œæˆä¸­...');
        await setDocFunc(permissionsDocRef, latestPermissions);
        console.log('[initPermissions] âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ¨©é™è¨­å®šã‚’ä½œæˆã—ã¾ã—ãŸ');

        return latestPermissions;
      } catch (error) {
        console.error('[initPermissions] âŒ ã‚¨ãƒ©ãƒ¼:', error);
        return null;
      }
    }

    /**
     * Firestoreã‹ã‚‰æ¨©é™è¨­å®šã‚’å–å¾—ã—ã¦ã€å‹•çš„ã«UIã‚’ç”Ÿæˆ
     */
    async function loadAndRenderPermissions() {
      console.log('[loadPermissions] ğŸ”„ æ¨©é™è¨­å®šã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...');

      try {
        // 1. æ¨©é™è¨­å®šã‚’åˆæœŸåŒ–ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆï¼‰
        const permissionsData = await initializePermissionsSettings();

        if (!permissionsData || !permissionsData.roles) {
          throw new Error('æ¨©é™è¨­å®šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        // 2. Collection Group Queryã§ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ã‚ªãƒ¼ãƒŠãƒ¼å­˜åœ¨ãƒã‚§ãƒƒã‚¯
        const db = window.firebaseDB;
        const collectionGroupFunc = window.firestoreCollectionGroup;
        const queryFunc = window.firestoreQuery;
        const whereFunc = window.firestoreWhere;
        const getDocsFunc = window.firestoreGetDocs;

        const allDevicesQuery = queryFunc(
          collectionGroupFunc(db, 'devices'),
          whereFunc('permissionId', '==', 'owner'),
          whereFunc('active', '==', true)
        );
        const ownerDevices = await getDocsFunc(allDevicesQuery);
        const hasOwner = ownerDevices.size > 0;

        console.log(`[loadPermissions] ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ã‚ªãƒ¼ãƒŠãƒ¼ãƒ‡ãƒã‚¤ã‚¹æ•°: ${ownerDevices.size}`);

        // 3. æ¨©é™ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’UIã«å‹•çš„ç”Ÿæˆ
        const permissionContainer = document.getElementById('permission-options');
        const permissionInfo = document.getElementById('permission-info');

        if (!permissionContainer) {
          console.error('[loadPermissions] permission-optionsè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        permissionContainer.innerHTML = ''; // æ—¢å­˜ã®HTMLã‚’ã‚¯ãƒªã‚¢

        // roles ã‚’ order ã§ã‚½ãƒ¼ãƒˆ
        const sortedRoles = permissionsData.roles.sort((a, b) => a.order - b.order);

        // ã‚¢ã‚¤ã‚³ãƒ³ãƒãƒƒãƒ”ãƒ³ã‚°
        const iconMap = {
          owner: 'ğŸ‘‘',
          employee: 'ğŸ‘”',
          staff: 'ğŸ“‹',
          leader: 'ğŸ–ï¸',
          contractor: 'ğŸ”§'
        };

        // ã‚«ãƒ©ãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°
        const colorMap = {
          owner: '#dc2626',
          employee: '#059669',
          staff: '#1e40af',
          leader: '#d97706',
          contractor: '#4338ca'
        };

        let defaultChecked = false;

        sortedRoles.forEach((role, index) => {
          const isOwner = role.id === 'owner';
          const shouldShow = isOwner ? !hasOwner : true; // ã‚ªãƒ¼ãƒŠãƒ¼ã¯æœªç™»éŒ²æ™‚ã®ã¿è¡¨ç¤º

          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯: ã‚ªãƒ¼ãƒŠãƒ¼ãŒã„ãªã‘ã‚Œã°ownerã€ã„ã‚Œã°staff
          const shouldCheck = (!defaultChecked && shouldShow &&
            ((isOwner && !hasOwner) || (!isOwner && role.id === 'staff' && hasOwner)));

          if (shouldCheck) defaultChecked = true;

          const label = document.createElement('label');
          label.id = `${role.id}-option`;
          label.style.display = shouldShow ? 'flex' : 'none';
          label.style.alignItems = 'center';
          label.style.padding = '12px';
          label.style.border = '2px solid #e5e7eb';
          label.style.borderRadius = '8px';
          label.style.cursor = 'pointer';
          label.style.transition = 'all 0.2s';

          const radio = document.createElement('input');
          radio.type = 'radio';
          radio.name = 'user-permission';
          radio.value = role.id; // Internal ID
          radio.dataset.display = role.display; // Display name
          radio.style.marginRight = '8px';
          radio.style.width = '18px';
          radio.style.height = '18px';
          radio.style.cursor = 'pointer';
          if (shouldCheck) radio.checked = true;

          const textDiv = document.createElement('div');

          const titleDiv = document.createElement('div');
          titleDiv.style.fontSize = '15px';
          titleDiv.style.fontWeight = '600';
          titleDiv.style.color = colorMap[role.id] || '#000';
          titleDiv.textContent = `${iconMap[role.id] || 'ğŸ“„'} ${role.display}`;

          const descDiv = document.createElement('div');
          descDiv.style.fontSize = '12px';
          descDiv.style.color = '#6b7280';
          descDiv.style.marginTop = '2px';
          descDiv.textContent = role.description;

          textDiv.appendChild(titleDiv);
          textDiv.appendChild(descDiv);
          label.appendChild(radio);
          label.appendChild(textDiv);
          permissionContainer.appendChild(label);
        });

        // æƒ…å ±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        if (!hasOwner) {
          permissionInfo.textContent = 'âœ¨ åˆå›ç™»éŒ²è€…ã®ãŸã‚ã€ç®¡ç†è€…æ¨©é™ã§ç™»éŒ²ã•ã‚Œã¾ã™';
          permissionInfo.style.background = '#fef3c7';
          permissionInfo.style.color = '#92400e';
        } else {
          permissionInfo.textContent = 'ğŸ’¡ æ¨©é™ã®å¤‰æ›´ã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ç®¡ç†ã€ã‹ã‚‰ç®¡ç†è€…ãŒè¨­å®šã—ã¾ã™';
          permissionInfo.style.background = '#e0e7ff';
          permissionInfo.style.color = '#1e40af';
        }

        console.log('[loadPermissions] âœ… æ¨©é™é¸æŠUIã‚’å‹•çš„ç”Ÿæˆã—ã¾ã—ãŸ');

      } catch (error) {
        console.error('[loadPermissions] âŒ ã‚¨ãƒ©ãƒ¼:', error);

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚¨ãƒ©ãƒ¼æ™‚ã¯å®‰å…¨å´ã«å€’ã™ï¼ˆã‚¹ã‚¿ãƒƒãƒ•ã®ã¿è¡¨ç¤ºï¼‰
        const permissionContainer = document.getElementById('permission-options');
        const permissionInfo = document.getElementById('permission-info');

        if (permissionContainer) {
          permissionContainer.innerHTML = `
            <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
              <input type="radio" name="user-permission" value="staff" data-display="ã‚¹ã‚¿ãƒƒãƒ•" checked style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
              <div>
                <div style="font-size: 15px; font-weight: 600; color: #1e40af;">ğŸ“˜ ã‚¹ã‚¿ãƒƒãƒ•</div>
                <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">é€šå¸¸ã®å¾“æ¥­å“¡</div>
              </div>
            </label>
          `;
        }

        if (permissionInfo) {
          permissionInfo.textContent = 'âš ï¸ æ¨©é™è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆã‚¹ã‚¿ãƒƒãƒ•ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¾ã™ï¼‰';
          permissionInfo.style.background = '#fef2f2';
          permissionInfo.style.color = '#991b1b';
        }
      }
    }


    // ========================================
    // Firebase Googleèªè¨¼ãƒ•ãƒ­ãƒ¼
    // ========================================

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿æŒ
    let authenticatedEmail = '';
    let existingUserData = null;
    let googleUser = null;

    // ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹åˆ¤å®š
    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // Google ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³
    window.signInWithGoogle = async function signInWithGoogle() {
      const resultDiv = document.getElementById('auth-result');

      // onAuthStateChangedã®äºŒé‡å‡¦ç†ã‚’é˜²æ­¢ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å®Œäº†å‰ã«ç™ºç«ã™ã‚‹ãŸã‚ã€æœ€åˆã«ã‚»ãƒƒãƒˆï¼‰
      window.authHandled = true;

      try {
        resultDiv.textContent = 'â³ Googleèªè¨¼ä¸­...';
        resultDiv.className = 'step-result';
        resultDiv.style.display = 'block';

        // Firebase Auth ã§Google ã‚µã‚¤ãƒ³ã‚¤ãƒ³
        const auth = window.firebaseAuth;
        const provider = window.firebaseGoogleProvider;

        if (!auth || !provider) {
          throw new Error('Firebase Auth ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        }

        // å…¨ãƒ‡ãƒã‚¤ã‚¹ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—èªè¨¼ã‚’ä½¿ç”¨
        // â€» Safari/iOSã§ã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼å¾Œã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒä¿æŒã•ã‚Œãªã„ãŸã‚
        // â€» authDomainãŒç•°ãªã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã®å ´åˆã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—èªè¨¼ãŒæœ€ã‚‚å®‰å®š
        console.log('[Auth] ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—èªè¨¼ã‚’ä½¿ç”¨ï¼ˆå…¨ãƒ‡ãƒã‚¤ã‚¹å…±é€šï¼‰');
        const result = await window.firebaseSignInWithPopup(auth, provider);

        // Googleã‹ã‚‰ç›´æ¥æœ€æ–°ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å–å¾—ï¼ˆFirebase Authã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å›é¿ï¼‰
        const additionalInfo = window.firebaseGetAdditionalUserInfo(result);
        const googleProfile = additionalInfo?.profile || {};
        console.log('[Auth] Googleãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆæœ€æ–°ï¼‰:', googleProfile);

        await handleGoogleAuthResult(result.user, googleProfile);

      } catch (error) {
        console.error('âŒ [signInWithGoogle] ã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå†è©¦è¡Œå¯èƒ½ã«ã™ã‚‹ï¼‰
        window.authHandled = false;

        if (error.code === 'auth/popup-closed-by-user') {
          resultDiv.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚';
          resultDiv.className = 'step-result';
        } else if (error.code === 'auth/popup-blocked') {
          resultDiv.textContent = 'ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
          resultDiv.className = 'step-result error';
        } else {
          resultDiv.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message;
          resultDiv.className = 'step-result error';
        }
        resultDiv.style.display = 'block';
      }
    }

    // Apple ãƒ­ã‚°ã‚¤ãƒ³
    window.signInWithApple = async function signInWithApple() {
      const resultDiv = document.getElementById('auth-result');
      window.authHandled = true;

      try {
        resultDiv.textContent = 'â³ Appleèªè¨¼ä¸­...';
        resultDiv.className = 'step-result';
        resultDiv.style.display = 'block';

        const auth = window.firebaseAuth;
        const provider = window.firebaseAppleProvider;

        if (!auth || !provider) {
          throw new Error('Firebase Auth ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        }

        console.log('[Auth] Apple ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—èªè¨¼ã‚’ä½¿ç”¨');
        const result = await window.firebaseSignInWithPopup(auth, provider);

        // Appleã‹ã‚‰ç›´æ¥ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å–å¾—
        const additionalInfo = window.firebaseGetAdditionalUserInfo(result);
        const appleProfile = additionalInfo?.profile || {};
        console.log('[Auth] Appleãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«:', appleProfile);

        // Appleã¯åˆå›ã®ã¿nameæƒ…å ±ã‚’è¿”ã™ï¼ˆ2å›ç›®ä»¥é™ã¯nullï¼‰
        // ãã®ãŸã‚ã€Firebase Authã®useræƒ…å ±ã‚‚æ´»ç”¨
        await handleOAuthResult(result.user, appleProfile, 'apple');

      } catch (error) {
        console.error('âŒ [signInWithApple] ã‚¨ãƒ©ãƒ¼:', error);
        window.authHandled = false;

        if (error.code === 'auth/popup-closed-by-user') {
          resultDiv.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚';
          resultDiv.className = 'step-result';
        } else if (error.code === 'auth/popup-blocked') {
          resultDiv.textContent = 'ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
          resultDiv.className = 'step-result error';
        } else {
          resultDiv.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message;
          resultDiv.className = 'step-result error';
        }
        resultDiv.style.display = 'block';
      }
    }

    // LINE ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆOAuth 2.0ï¼‰
    window.signInWithLINE = async function signInWithLINE() {
      const resultDiv = document.getElementById('auth-result');

      try {
        resultDiv.textContent = 'â³ LINEèªè¨¼ã®æº–å‚™ä¸­...';
        resultDiv.className = 'step-result';
        resultDiv.style.display = 'block';

        // LINE Login ã¯ Firebase Auth ãƒã‚¤ãƒ†ã‚£ãƒ–ã§ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãŸã‚ã€
        // ã‚«ã‚¹ã‚¿ãƒ èªè¨¼ãƒ•ãƒ­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚

        // ç¾æ™‚ç‚¹ã§ã¯æº–å‚™ä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        resultDiv.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 14px; color: #374151; margin-bottom: 8px;">
              LINE ãƒ­ã‚°ã‚¤ãƒ³ã¯æº–å‚™ä¸­ã§ã™
            </div>
            <div style="font-size: 12px; color: #6b7280;">
              ä»–ã®ãƒ­ã‚°ã‚¤ãƒ³æ–¹æ³•ã‚’ã”åˆ©ç”¨ãã ã•ã„
            </div>
          </div>
        `;
        resultDiv.className = 'step-result';
        resultDiv.style.display = 'block';

      } catch (error) {
        console.error('âŒ [signInWithLINE] ã‚¨ãƒ©ãƒ¼:', error);
        resultDiv.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message;
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
      }
    }

    // Xï¼ˆTwitterï¼‰ãƒ­ã‚°ã‚¤ãƒ³
    window.signInWithX = async function signInWithX() {
      const resultDiv = document.getElementById('auth-result');
      window.authHandled = true;

      try {
        resultDiv.textContent = 'â³ Xèªè¨¼ä¸­...';
        resultDiv.className = 'step-result';
        resultDiv.style.display = 'block';

        // Twitter Provider ã‚’ä½¿ç”¨
        const { TwitterAuthProvider } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
        const auth = window.firebaseAuth;
        const provider = new TwitterAuthProvider();

        console.log('[Auth] Xï¼ˆTwitterï¼‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—èªè¨¼ã‚’ä½¿ç”¨');
        const result = await window.firebaseSignInWithPopup(auth, provider);

        // Twitterãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å–å¾—
        const additionalInfo = window.firebaseGetAdditionalUserInfo(result);
        const twitterProfile = additionalInfo?.profile || {};
        console.log('[Auth] Twitterãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«:', twitterProfile);

        await handleOAuthResult(result.user, twitterProfile, 'twitter');

      } catch (error) {
        console.error('âŒ [signInWithX] ã‚¨ãƒ©ãƒ¼:', error);
        window.authHandled = false;

        if (error.code === 'auth/popup-closed-by-user') {
          resultDiv.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚';
          resultDiv.className = 'step-result';
        } else if (error.code === 'auth/popup-blocked') {
          resultDiv.textContent = 'ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
          resultDiv.className = 'step-result error';
        } else if (error.code === 'auth/account-exists-with-different-credential') {
          resultDiv.textContent = 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«åˆ¥ã®æ–¹æ³•ã§ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚';
          resultDiv.className = 'step-result error';
        } else {
          resultDiv.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message;
          resultDiv.className = 'step-result error';
        }
        resultDiv.style.display = 'block';
      }
    }

    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
    window.showEmailLogin = function showEmailLogin() {
      const authSection = document.getElementById('google-auth-section');

      // Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¡ˆå†…ã‚’éè¡¨ç¤º
      const helpDiv = document.getElementById('google-account-help');
      if (helpDiv) helpDiv.style.display = 'none';

      // æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä¿å­˜
      if (!window.originalAuthContent) {
        window.originalAuthContent = authSection.innerHTML;
      }

      authSection.innerHTML = `
        <div style="display: flex; align-items: flex-start; gap: 10px;">
          <span style="font-size: 18px; font-weight: 600; color: #3b82f6;">â‘ </span>
          <div style="flex: 1;">
            <span class="step-title">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§æ–°è¦ç™»éŒ²</span>
            <p style="font-size: 13px; color: #6b7280; margin-top: 6px; margin-bottom: 0;">
              ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
            </p>
          </div>
        </div>
        <div style="margin-top: 16px;">
          <div id="email-login-form">
            <input type="email" id="login-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"
                   style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;
                          font-size: 15px; margin-bottom: 10px; box-sizing: border-box;">
            <input type="password" id="login-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰"
                   style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;
                          font-size: 15px; margin-bottom: 10px; box-sizing: border-box;">
            <div id="email-auth-result" class="step-result" style="display: none;"></div>
            <button onclick="signUpWithEmail()"
                    style="width: 100%; padding: 12px; background: #10b981; color: white; border: none;
                           border-radius: 8px; font-size: 15px; font-weight: 500; cursor: pointer; margin-bottom: 12px;">
              æ–°è¦ç™»éŒ²
            </button>
            <div style="text-align: center; margin-bottom: 16px;">
              <span style="font-size: 13px; color: #6b7280;">æ—¢ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã®æ–¹ã¯ </span>
              <button onclick="signInWithEmail()"
                      style="background: none; border: none; color: #3b82f6; font-size: 13px;
                             cursor: pointer; text-decoration: underline; padding: 0;">
                ãƒ­ã‚°ã‚¤ãƒ³
              </button>
            </div>
            <div style="text-align: center;">
              <button onclick="backToAuthOptions()"
                      style="background: none; border: none; color: #6b7280; font-size: 14px;
                             cursor: pointer; text-decoration: underline;">
                â† ä»–ã®ãƒ­ã‚°ã‚¤ãƒ³æ–¹æ³•ã«æˆ»ã‚‹
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // ä»–ã®ãƒ­ã‚°ã‚¤ãƒ³æ–¹æ³•ã«æˆ»ã‚‹
    window.backToAuthOptions = function backToAuthOptions() {
      const authSection = document.getElementById('google-auth-section');
      if (window.originalAuthContent) {
        authSection.innerHTML = window.originalAuthContent;
      }
      // Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¡ˆå†…ã‚’å†è¡¨ç¤º
      const helpDiv = document.getElementById('google-account-help');
      if (helpDiv) helpDiv.style.display = 'block';
    }

    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³
    window.signInWithEmail = async function signInWithEmail() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      const resultDiv = document.getElementById('email-auth-result');

      if (!email || !password) {
        resultDiv.textContent = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
        return;
      }

      try {
        resultDiv.textContent = 'â³ ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';
        resultDiv.className = 'step-result';
        resultDiv.style.display = 'block';

        // Firebase Auth ã®signInWithEmailAndPassword ã‚’å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        const { signInWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
        const auth = window.firebaseAuth;

        const result = await signInWithEmailAndPassword(auth, email, password);
        console.log('[Auth] Email ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', result.user.email);

        await handleOAuthResult(result.user, {}, 'email');

      } catch (error) {
        console.error('âŒ [signInWithEmail] ã‚¨ãƒ©ãƒ¼:', error);

        let errorMessage = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        if (error.code === 'auth/user-not-found') {
          errorMessage = 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
        } else if (error.code === 'auth/wrong-password') {
          errorMessage = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚';
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚';
        } else if (error.code === 'auth/invalid-credential') {
          errorMessage = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚';
        }

        resultDiv.textContent = 'âŒ ' + errorMessage;
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
      }
    }

    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§æ–°è¦ç™»éŒ²
    window.signUpWithEmail = async function signUpWithEmail() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      const resultDiv = document.getElementById('email-auth-result');

      if (!email || !password) {
        resultDiv.textContent = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
        return;
      }

      if (password.length < 6) {
        resultDiv.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
        return;
      }

      try {
        resultDiv.textContent = 'â³ ç™»éŒ²ä¸­...';
        resultDiv.className = 'step-result';
        resultDiv.style.display = 'block';

        // Firebase Auth ã®createUserWithEmailAndPassword ã‚’å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        const { createUserWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
        const auth = window.firebaseAuth;

        const result = await createUserWithEmailAndPassword(auth, email, password);
        console.log('[Auth] Email æ–°è¦ç™»éŒ²æˆåŠŸ:', result.user.email);

        await handleOAuthResult(result.user, {}, 'email');

      } catch (error) {
        console.error('âŒ [signUpWithEmail] ã‚¨ãƒ©ãƒ¼:', error);

        let errorMessage = 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        if (error.code === 'auth/email-already-in-use') {
          errorMessage = 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚';
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚';
        } else if (error.code === 'auth/weak-password') {
          errorMessage = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¼±ã™ãã¾ã™ã€‚ã‚‚ã†å°‘ã—è¤‡é›‘ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚';
        }

        resultDiv.textContent = 'âŒ ' + errorMessage;
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
      }
    }

    // OAuthçµæœã‚’å‡¦ç†ã™ã‚‹å…±é€šé–¢æ•°ï¼ˆApple, LINE, Emailç”¨ï¼‰
    window.handleOAuthResult = async function handleOAuthResult(user, profile, provider) {
      const resultDiv = document.getElementById('auth-result') || document.getElementById('email-auth-result');

      // Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¡ˆå†…ã‚’éè¡¨ç¤º
      const helpDiv = document.getElementById('google-account-help');
      if (helpDiv) helpDiv.style.display = 'none';

      try {
        const email = user.email;
        const displayName = profile?.name || user.displayName || email?.split('@')[0] || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
        const photoURL = profile?.picture || user.photoURL || '';

        resultDiv.textContent = 'ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç¢ºèªä¸­...';

        // Firestoreã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
        const db = window.firebaseDB;
        const usersRef = window.firestoreCollection(db, 'users');
        const q = window.firestoreQuery(usersRef, window.firestoreWhere('email', '==', email));
        const querySnapshot = await window.firestoreGetDocs(q);

        if (!querySnapshot.empty) {
          // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼
          const userDoc = querySnapshot.docs[0];
          const userData = userDoc.data();
          const userName = userData.name || displayName;
          const permissionId = userData.permissionId || 'guest';

          // Firestoreã®æƒ…å ±ã‚’æ›´æ–°ï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒãªã©ï¼‰
          if (photoURL && photoURL !== userData.photoURL) {
            await window.firestoreSetDoc(window.firestoreDoc(db, 'users', userDoc.id), {
              photoURL: photoURL,
              authProvider: provider,
              lastLogin: window.firestoreServerTimestamp()
            }, { merge: true });
          }

          // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
          localStorage.setItem('user_name', userName);
          localStorage.setItem('user_email', email);
          localStorage.setItem('user_permission', permissionId);
          if (photoURL) localStorage.setItem('user_photo', photoURL);
          localStorage.setItem('auth_provider', provider);

          // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸç”»é¢ã‚’è¡¨ç¤º
          document.getElementById('google-auth-section').style.display = 'none';

          // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ãƒã‚§ãƒƒã‚¯
          const isSetupCompleted = localStorage.getItem('fcm-setup-completed') === '1';

          if (isSetupCompleted) {
            // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†æ¸ˆã¿ â†’ æˆåŠŸè¡¨ç¤ºå¾Œã«ãƒ›ãƒ¼ãƒ ç”»é¢ã¸
            resultDiv.innerHTML = `
              <div style="text-align: center; line-height: 1.5;">
                ${photoURL ? `<img src="${photoURL}" style="width: 48px; height: 48px; border-radius: 50%;">` : ''}
                <div style="font-weight: 600; font-size: 16px; color: #059669; margin-top: 10px;">âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼</div>
                <div style="margin-top: 6px; font-size: 14px;">${userName}ã•ã‚“</div>
              </div>
            `;
            resultDiv.className = 'step-result success';
            resultDiv.style.display = 'block';

            setTimeout(() => {
              document.getElementById('setup-screen').style.display = 'none';
              document.getElementById('app-screen').style.display = 'block';
              loadUserIcon();
              // ğŸŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ«ãƒ¼ãƒ ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ 
              if (typeof addCurrentUserToGlobalRooms === 'function') {
                console.log('[Auth] ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ«ãƒ¼ãƒ ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ');
                addCurrentUserToGlobalRooms();
              }
            }, 1500);
          } else {
            // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æœªå®Œäº† â†’ é€šçŸ¥è¨­å®šã¸ã®ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼ˆ2å°ç›®ç«¯æœ«å¯¾å¿œï¼‰
            resultDiv.innerHTML = `
              <div style="text-align: center; line-height: 1.5;">
                ${photoURL ? `<img src="${photoURL}" style="width: 48px; height: 48px; border-radius: 50%;">` : ''}
                <div style="font-weight: 600; font-size: 16px; color: #059669; margin-top: 10px;">âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼</div>
                <div style="margin-top: 6px; font-size: 14px;">${userName}ã•ã‚“</div>
                <div style="margin-top: 16px;">
                  <button onclick="showNotificationScreen()"
                          style="width: 100%; padding: 14px; background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
                    æ¬¡ã¸ï¼ˆé€šçŸ¥è¨­å®šï¼‰
                  </button>
                </div>
              </div>
            `;
            resultDiv.className = 'step-result success';
            resultDiv.style.display = 'block';
          }

        } else {
          // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ åå‰å…¥åŠ›ç”»é¢ã¸
          console.log('[Auth] æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼:', email);

          // Googleãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’ä¿å­˜ï¼ˆåå‰å…¥åŠ›ç”»é¢ã§ä½¿ç”¨ï¼‰
          window.currentGoogleProfile = profile;
          window.currentAuthProvider = provider;

          showNameInputScreen(email, displayName, photoURL, provider);
        }

      } catch (error) {
        console.error('âŒ [handleOAuthResult] ã‚¨ãƒ©ãƒ¼:', error);
        resultDiv.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message;
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
      }
    }

    // PCç”¨Googleãƒ­ã‚°ã‚¤ãƒ³ï¼ˆæ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ï¼‰
    window.signInWithGoogleFromPC = async function signInWithGoogleFromPC() {
      const pcGuide = document.getElementById('pc-install-guide');

      // çµæœè¡¨ç¤ºç”¨ã®divã‚’å‹•çš„ã«è¿½åŠ 
      let pcResultDiv = document.getElementById('pc-auth-result');
      if (!pcResultDiv) {
        pcResultDiv = document.createElement('div');
        pcResultDiv.id = 'pc-auth-result';
        pcResultDiv.style.cssText = 'margin-top: 16px; padding: 12px; border-radius: 8px; font-size: 14px; text-align: center;';
        pcGuide.querySelector('div > div').appendChild(pcResultDiv);
      }

      try {
        pcResultDiv.textContent = 'â³ Googleèªè¨¼ä¸­...';
        pcResultDiv.style.background = '#f3f4f6';
        pcResultDiv.style.color = '#374151';

        const auth = window.firebaseAuth;
        const provider = window.firebaseGoogleProvider;

        if (!auth || !provider) {
          throw new Error('Firebase Auth ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        }

        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—èªè¨¼
        const result = await window.firebaseSignInWithPopup(auth, provider);
        const user = result.user;
        const email = user.email;

        // Googleã‹ã‚‰ç›´æ¥æœ€æ–°ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å–å¾—ï¼ˆFirebase Authã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å›é¿ï¼‰
        const additionalInfo = window.firebaseGetAdditionalUserInfo(result);
        const googleProfile = additionalInfo?.profile || {};
        console.log('[PC Auth] Googleãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆæœ€æ–°ï¼‰:', googleProfile);

        const displayName = googleProfile.name || user.displayName || email.split('@')[0];
        const photoURL = googleProfile.picture || user.photoURL;
        console.log('[PC Auth] displayName:', displayName, '(googleProfile:', googleProfile.name, ', user.displayName:', user.displayName, ')');

        pcResultDiv.textContent = 'ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç¢ºèªä¸­...';

        // Firestoreã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
        let db = window.firebaseDB;
        if (!db) {
          const { initializeApp, getApps } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
          const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
          const firebaseConfig = {
            apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
            authDomain: "furira.jp",
            projectId: "reborn-chat",
            storageBucket: "reborn-chat.firebasestorage.app",
            messagingSenderId: "345706548795",
            appId: "1:345706548795:web:058a553da6b4b74db5161e"
          };
          const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
          db = getFirestore(app);
          window.firebaseDB = db;
        }

        const { getDocs, collection, query, where } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const usersCollection = collection(db, 'users');
        const q = query(usersCollection, where('userEmail', '==', email));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„ â†’ ã‚¹ãƒãƒ›ã§ç™»éŒ²ãŒå¿…è¦
          pcResultDiv.innerHTML = 'âŒ ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯æœªç™»éŒ²ã§ã™ã€‚<br><span style="font-size: 12px; color: #6b7280;">ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§åˆå›ç™»éŒ²ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚</span>';
          pcResultDiv.style.background = '#fef2f2';
          pcResultDiv.style.color = '#dc2626';
          return;
        }

        // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã£ãŸ
        const userDoc = querySnapshot.docs[0];
        const userData = { id: userDoc.id, ...userDoc.data() };
        const userName = userData.userName || userData.name || displayName;
        const permissionId = userData.permissionId || userData.permission || 'staff';
        const status = userData.status || 'active';

        if (status === 'inactive') {
          pcResultDiv.innerHTML = 'âŒ ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚<br><span style="font-size: 12px; color: #6b7280;">ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</span>';
          pcResultDiv.style.background = '#fef2f2';
          pcResultDiv.style.color = '#dc2626';
          return;
        }

        if (status === 'pending') {
          pcResultDiv.innerHTML = 'â³ ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯æ‰¿èªå¾…ã¡ã§ã™ã€‚<br><span style="font-size: 12px; color: #6b7280;">ç®¡ç†è€…ã®æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚</span>';
          pcResultDiv.style.background = '#fffbeb';
          pcResultDiv.style.color = '#d97706';
          return;
        }

        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
        // Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆå†™çœŸã®ã¿è‡ªå‹•åŒæœŸï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯ç™»éŒ²æ™‚ã«è¨­å®šã—ãŸã‚‚ã®ã‚’ä¿æŒï¼‰
        if (photoURL && photoURL !== userData.photoURL) {
          try {
            const userRef = doc(db, 'users', email);
            await updateDoc(userRef, { photoURL: photoURL });
            console.log('[PC Login] Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆå†™çœŸã‚’åŒæœŸ');
          } catch (syncError) {
            console.error('[PC Login] FirestoreåŒæœŸã‚¨ãƒ©ãƒ¼:', syncError);
          }
        }

        // Firestoreã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å„ªå…ˆï¼ˆç™»éŒ²æ™‚ã«è¨­å®šã—ãŸåå‰ã‚’ä¿æŒï¼‰
        const finalUserName = userName;
        localStorage.setItem('reborn_user_name', finalUserName);
        localStorage.setItem('reborn_user_email', email);
        localStorage.setItem('reborn_user_permission_id', permissionId);
        localStorage.setItem('reborn_user_permission_display', getPermissionDisplayName(permissionId));
        localStorage.setItem('reborn_user_photo_url', photoURL || '');
        localStorage.setItem('reborn_firebase_uid', user.uid);
        if (userData.userIconUrl) {
          localStorage.setItem('reborn_user_icon_url', userData.userIconUrl);
        } else if (photoURL) {
          localStorage.setItem('reborn_user_icon_url', photoURL);
        }

        // PCã§ã¯FCMãƒˆãƒ¼ã‚¯ãƒ³ã¯å–å¾—ã—ãªã„ï¼ˆãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã¯ã‚¹ãƒãƒ›ã®ã¿ï¼‰
        // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ
        localStorage.setItem('fcm-setup-completed', '1');

        pcResultDiv.textContent = 'âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¾ã™...';
        pcResultDiv.style.background = '#f0fdf4';
        pcResultDiv.style.color = '#16a34a';

        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚¢ãƒ—ãƒªç”»é¢ã¸
        setTimeout(() => {
          document.getElementById('install-prompt-screen').style.display = 'none';
          document.getElementById('setup-screen').style.display = 'none';
          document.getElementById('app-screen').style.display = 'block';

          // ã‚¢ãƒ—ãƒªç”»é¢ã®åˆæœŸåŒ–
          loadUserIcon();

          // ğŸŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ«ãƒ¼ãƒ ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ 
          if (typeof addCurrentUserToGlobalRooms === 'function') {
            console.log('[PC Login] ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ«ãƒ¼ãƒ ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ');
            addCurrentUserToGlobalRooms();
          }

          // iframeã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã‚’ãƒ­ãƒ¼ãƒ‰
          const iframe = document.getElementById('gas-iframe');
          if (iframe) {
            const sessionId = sessionStorage.getItem('device_session_id') || Date.now() + '_' + Math.random().toString(36).substring(2);
            sessionStorage.setItem('device_session_id', sessionId);

            const pwaBaseUrl = location.origin;
            const params = new URLSearchParams({
              userName: userName,
              sessionId: sessionId
            });
            const menuHomeUrl = pwaBaseUrl + '/menu_home.html?' + params.toString();
            iframe.src = menuHomeUrl;
          }
        }, 1000);

      } catch (error) {
        console.error('âŒ [signInWithGoogleFromPC] ã‚¨ãƒ©ãƒ¼:', error);

        if (error.code === 'auth/popup-closed-by-user') {
          pcResultDiv.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚';
          pcResultDiv.style.background = '#f3f4f6';
          pcResultDiv.style.color = '#6b7280';
        } else if (error.code === 'auth/popup-blocked') {
          pcResultDiv.textContent = 'ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
          pcResultDiv.style.background = '#fef2f2';
          pcResultDiv.style.color = '#dc2626';
        } else {
          pcResultDiv.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message;
          pcResultDiv.style.background = '#fef2f2';
          pcResultDiv.style.color = '#dc2626';
        }
      }
    }

    // Googleèªè¨¼çµæœã‚’å‡¦ç†ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—/ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…±é€šï¼‰
    // googleProfile: getAdditionalUserInfo()ã‹ã‚‰å–å¾—ã—ãŸGoogleã®æœ€æ–°ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    window.handleGoogleAuthResult = async function handleGoogleAuthResult(user, googleProfile = null) {
      const resultDiv = document.getElementById('auth-result');

      // Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¡ˆå†…ã‚’éè¡¨ç¤º
      const helpDiv = document.getElementById('google-account-help');
      if (helpDiv) helpDiv.style.display = 'none';

      try {
        googleUser = user;
        const email = user.email;
        // Googleã®æœ€æ–°ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å„ªå…ˆï¼ˆFirebase Authã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å›é¿ï¼‰
        const displayName = googleProfile?.name || user.displayName || email.split('@')[0];
        const photoURL = googleProfile?.picture || user.photoURL;
        console.log('[handleGoogleAuthResult] displayName:', displayName, '(googleProfile:', googleProfile?.name, ', user.displayName:', user.displayName, ')');
        console.log('[handleGoogleAuthResult] Googleãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è©³ç´°:', googleProfile);

        // Googleãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜ï¼ˆå§“ãƒ»åã®åˆ†å‰²å–å¾—ç”¨ï¼‰
        window.currentGoogleProfile = googleProfile;

        resultDiv.textContent = 'ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç¢ºèªä¸­...';
        resultDiv.className = 'step-result';
        resultDiv.style.display = 'block';

        // èªè¨¼ãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
        localStorage.removeItem('reborn_auth_pending');

        // Firestoreã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
        let db = window.firebaseDB;
        if (!db) {
          const { initializeApp, getApps } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
          const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
          const firebaseConfig = {
            apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
            authDomain: "furira.jp",
            projectId: "reborn-chat",
            storageBucket: "reborn-chat.firebasestorage.app",
            messagingSenderId: "345706548795",
            appId: "1:345706548795:web:058a553da6b4b74db5161e"
          };
          const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
          db = getFirestore(app);
          window.firebaseDB = db;
        }

        const { getDocs, collection, query, where, doc, setDoc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const usersCollection = collection(db, 'users');

        // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ï¼ˆåˆå›ç™»éŒ²åˆ¤å®šç”¨ï¼‰
        const allUsersSnapshot = await getDocs(usersCollection);
        const isFirstUser = allUsersSnapshot.size === 0;

        // userEmailãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
        const q = query(usersCollection, where('userEmail', '==', email));
        const querySnapshot = await getDocs(q);

        authenticatedEmail = email;

        if (!querySnapshot.empty) {
          // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã£ãŸ
          const userDoc = querySnapshot.docs[0];
          existingUserData = { id: userDoc.id, ...userDoc.data() };

          const userName = existingUserData.userName || existingUserData.name || displayName;
          const permissionId = existingUserData.permissionId || existingUserData.permission || 'staff';
          const status = existingUserData.status || 'active'; // æ—§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯activeæ‰±ã„

          // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸå‡¦ç†
          if (status === 'inactive') {
            // ç„¡åŠ¹åŒ–ã•ã‚ŒãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
            document.getElementById('google-auth-section').style.display = 'none';
            document.getElementById('disabled-account-section').style.display = 'block';
            resultDiv.style.display = 'none';
            return;
          }

          if (status === 'pending') {
            // æ‰¿èªå¾…ã¡
            document.getElementById('google-auth-section').style.display = 'none';
            document.getElementById('pending-approval-section').style.display = 'block';
            document.getElementById('pending-user-info').innerHTML = `
              <div style="display: flex; align-items: center; gap: 10px; justify-content: center;">
                ${photoURL ? `<img src="${photoURL}" style="width: 32px; height: 32px; border-radius: 50%;">` : ''}
                <div>
                  <div style="font-weight: 600;">${userName}</div>
                  <div style="font-size: 12px; color: #6b7280;">${email}</div>
                </div>
              </div>
            `;
            resultDiv.style.display = 'none';

            // æ‰¿èªçŠ¶æ…‹ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–é–‹å§‹
            startPendingApprovalListener(email, displayName, photoURL, googleUser.uid);
            return;
          }

          // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
          // Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆå†™çœŸã®ã¿è‡ªå‹•åŒæœŸï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯ç™»éŒ²æ™‚ã«è¨­å®šã—ãŸã‚‚ã®ã‚’ä¿æŒï¼‰
          const syncUpdates = {};
          if (photoURL && photoURL !== existingUserData.photoURL) {
            syncUpdates.photoURL = photoURL;
            console.log('[Mobile Login] Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆå†™çœŸã‚’åŒæœŸ');
          }
          // userIconUrlãŒæœªè¨­å®šã®å ´åˆã‚‚photoURLã‚’ã‚»ãƒƒãƒˆ
          if (photoURL && !existingUserData.userIconUrl) {
            syncUpdates.userIconUrl = photoURL;
          }
          if (Object.keys(syncUpdates).length > 0) {
            try {
              const userRef = doc(db, 'users', email);
              await updateDoc(userRef, syncUpdates);
              console.log('[Mobile Login] FirestoreåŒæœŸå®Œäº†:', syncUpdates);
            } catch (syncError) {
              console.error('[Mobile Login] FirestoreåŒæœŸã‚¨ãƒ©ãƒ¼:', syncError);
            }
          }

          // Firestoreã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å„ªå…ˆï¼ˆç™»éŒ²æ™‚ã«è¨­å®šã—ãŸåå‰ã‚’ä¿æŒï¼‰
          const finalUserName = userName;
          localStorage.setItem('reborn_user_name', finalUserName);
          localStorage.setItem('reborn_user_email', email);
          localStorage.setItem('reborn_user_permission_id', permissionId);
          localStorage.setItem('reborn_user_permission_display', getPermissionDisplayName(permissionId));
          localStorage.setItem('reborn_user_photo_url', photoURL || '');
          localStorage.setItem('reborn_firebase_uid', googleUser.uid);
          // userIconUrlã®è¨­å®š
          if (existingUserData.userIconUrl) {
            localStorage.setItem('reborn_user_icon_url', existingUserData.userIconUrl);
          } else if (photoURL) {
            localStorage.setItem('reborn_user_icon_url', photoURL);
          }

          // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
          loadUserIcon();

          // IndexedDBã«ã‚‚ä¿å­˜
          const request = indexedDB.open('RebornUserDB', 1);
          request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains('user')) {
              db.createObjectStore('user');
            }
          };
          request.onsuccess = () => {
            const db = request.result;
            const transaction = db.transaction(['user'], 'readwrite');
            const store = transaction.objectStore('user');
            store.put(userName, 'userName');
          };

          // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’éè¡¨ç¤º
          document.getElementById('google-auth-section').style.display = 'none';

          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰+ æ¬¡ã¸ãƒœã‚¿ãƒ³è¿½åŠ ï¼ˆ2å°ç›®ç«¯æœ«å¯¾å¿œï¼‰
          resultDiv.innerHTML = `
            <div style="text-align: center; line-height: 1.5;">
              ${photoURL ? `<img src="${photoURL}" style="width: 48px; height: 48px; border-radius: 50%;">` : ''}
              <div style="font-weight: 600; font-size: 16px; color: #059669; margin-top: 10px;">âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼</div>
              <div style="margin-top: 6px; font-size: 14px;">${userName}ã•ã‚“ï¼ˆ${getPermissionBadge(permissionId)}ï¼‰</div>
              <div style="margin-top: 16px;">
                <button onclick="showNotificationScreen()"
                        style="width: 100%; padding: 14px; background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
                  æ¬¡ã¸ï¼ˆé€šçŸ¥è¨­å®šï¼‰
                </button>
              </div>
            </div>
          `;
          resultDiv.className = 'step-result success';
          resultDiv.style.cssText = 'display: block; padding: 14px;';


        } else {
          // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼
          if (isFirstUser) {
            // åˆå›ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ ã‚ªãƒ¼ãƒŠãƒ¼ã¨ã—ã¦è‡ªå‹•ç™»éŒ²ï¼ˆactiveï¼‰
            const newUserData = {
              userName: displayName,
              userEmail: email,
              permissionId: 'owner',
              permissionDisplay: 'ğŸ‘‘ ç®¡ç†è€…',
              status: 'active',
              photoURL: photoURL || '',
              userIconUrl: photoURL || '', // ã‚¢ãƒ—ãƒªå†…ã‚¢ã‚¤ã‚³ãƒ³ç”¨ï¼ˆGoogleå†™çœŸã‚’åˆæœŸå€¤ã¨ã—ã¦è¨­å®šï¼‰
              firebaseUid: googleUser.uid,
              createdAt: new Date().toISOString(),
              deviceId: null
            };

            // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã¨ã—ã¦ä½¿ç”¨ï¼ˆè¨­å®šç”»é¢ã¨ã®æ•´åˆæ€§ã®ãŸã‚ï¼‰
            const userDocRef = doc(db, 'users', email);
            await setDoc(userDocRef, newUserData);

            // LocalStorageã«ä¿å­˜
            localStorage.setItem('reborn_user_name', displayName);
            localStorage.setItem('reborn_user_email', email);
            localStorage.setItem('reborn_user_permission_id', 'owner');
            localStorage.setItem('reborn_user_permission_display', 'ğŸ‘‘ ç®¡ç†è€…');
            localStorage.setItem('reborn_user_photo_url', photoURL || '');
            localStorage.setItem('reborn_user_icon_url', photoURL || ''); // ã‚¢ãƒ—ãƒªå†…ã‚¢ã‚¤ã‚³ãƒ³ç”¨
            localStorage.setItem('reborn_firebase_uid', googleUser.uid);

            // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
            loadUserIcon();

            document.getElementById('google-auth-section').style.display = 'none';

            // ã€ç”»é¢1ã€‘ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸç”»é¢
            resultDiv.innerHTML = `
              <div style="text-align: center; line-height: 1.5;">
                ${photoURL ? `<img src="${photoURL}" style="width: 64px; height: 64px; border-radius: 50%;">` : ''}
                <div style="font-size: 14px; color: #6b7280; margin-top: 10px;">${displayName}</div>
                <div style="font-weight: 600; font-size: 20px; color: #059669; margin-top: 6px;">âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼</div>
                <div style="margin-top: 14px; padding: 10px 20px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 8px; display: inline-block;">
                  <span style="font-size: 14px; color: #374151;">ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ</span>
                </div>
                <div style="margin-top: 24px;">
                  <button onclick="showNameInputScreen('${email}', '${photoURL || ''}', 'owner', '', '${displayName.replace(/'/g, "\\'")}')"
                          style="width: 100%; padding: 14px; background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
                    æ¬¡ã¸
                  </button>
                </div>
              </div>
            `;
            resultDiv.className = 'step-result success';
            resultDiv.style.cssText = 'display: block; padding: 14px;';


          } else {
            // 2äººç›®ä»¥é™ â†’ pendingçŠ¶æ…‹ã§ç™»éŒ²
            const newUserData = {
              userName: displayName,
              userEmail: email,
              permissionId: 'staff', // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã‚¹ã‚¿ãƒƒãƒ•ï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ãŒå¾Œã§å¤‰æ›´å¯èƒ½ï¼‰
              permissionDisplay: 'ğŸ“‹ ã‚¹ã‚¿ãƒƒãƒ•',
              status: 'pending', // æ‰¿èªå¾…ã¡
              photoURL: photoURL || '',
              userIconUrl: photoURL || '', // ã‚¢ãƒ—ãƒªå†…ã‚¢ã‚¤ã‚³ãƒ³ç”¨ï¼ˆGoogleå†™çœŸã‚’åˆæœŸå€¤ã¨ã—ã¦è¨­å®šï¼‰
              firebaseUid: googleUser.uid,
              createdAt: new Date().toISOString(),
              deviceId: null
            };

            // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã¨ã—ã¦ä½¿ç”¨ï¼ˆè¨­å®šç”»é¢ã¨ã®æ•´åˆæ€§ã®ãŸã‚ï¼‰
            const userDocRef = doc(db, 'users', email);
            await setDoc(userDocRef, newUserData);

            // æ³¨: ç®¡ç†è€…ã¸ã®é€šçŸ¥ï¼ˆã‚¿ã‚¹ã‚¯/ãƒ—ãƒƒã‚·ãƒ¥/ãƒãƒ£ãƒƒãƒˆ/ãƒ¡ãƒ¼ãƒ«ï¼‰ã¯
            // saveNewUserName()ã§æ‰¿èªå¾…ã¡ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹æ™‚ã«é€ä¿¡ã•ã‚Œã‚‹

            // ã€ç”»é¢1ã€‘ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸç”»é¢ï¼ˆpendingç”¨ï¼‰
            document.getElementById('google-auth-section').style.display = 'none';
            resultDiv.innerHTML = `
              <div style="text-align: center; line-height: 1.5;">
                ${photoURL ? `<img src="${photoURL}" style="width: 64px; height: 64px; border-radius: 50%;">` : ''}
                <div style="font-size: 14px; color: #6b7280; margin-top: 10px;">${displayName}</div>
                <div style="font-weight: 600; font-size: 20px; color: #059669; margin-top: 6px;">âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼</div>
                <div style="margin-top: 14px; padding: 10px 20px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 8px; display: inline-block;">
                  <span style="font-size: 14px; color: #374151;">æ‰¿èªå¾…ã¡ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¾ã™</span>
                </div>
                <div style="margin-top: 24px;">
                  <button onclick="showNameInputScreen('${email}', '${photoURL || ''}', 'pending', '${googleUser.uid}', '${displayName.replace(/'/g, "\\'")}')"
                          style="width: 100%; padding: 14px; background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
                    æ¬¡ã¸
                  </button>
                </div>
              </div>
            `;
            resultDiv.className = 'step-result success';
            resultDiv.style.cssText = 'display: block; padding: 14px;';

            // è‡ªå‹•FCMç™»éŒ²ï¼ˆæ‰¿èªæ™‚ã«ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’é€ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
            autoRegisterFCMForPendingUser(email);
          }
        }

      } catch (error) {
        console.error('âŒ [handleGoogleAuthResult] ã‚¨ãƒ©ãƒ¼:', error);
        resultDiv.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message;
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
      }
    }

    // ã€ç”»é¢2ã€‘ãƒ¦ãƒ¼ã‚¶ãƒ¼åå…¥åŠ›ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    window.showNameInputScreen = function showNameInputScreen(email, photoURL, userType, firebaseUid, displayName) {
      const resultDiv = document.getElementById('auth-result');

      // Googleãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‹ã‚‰å§“ãƒ»åã‚’å–å¾—ï¼ˆfamily_name/given_nameã‚’å„ªå…ˆï¼‰
      const googleProfile = window.currentGoogleProfile;
      let defaultLastName = '';
      let defaultFirstName = '';

      if (googleProfile?.family_name || googleProfile?.given_name) {
        // Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§å§“ãƒ»åãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
        defaultLastName = googleProfile.family_name || '';
        defaultFirstName = googleProfile.given_name || '';
        console.log('[showNameInputScreen] Googleãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‹ã‚‰å§“åå–å¾—:', defaultLastName, defaultFirstName);
      } else if (displayName) {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§åˆ†å‰²ã‚’è©¦ã¿ã‚‹
        const nameParts = displayName.trim().split(/\s+/);
        if (nameParts.length >= 2) {
          // ã‚¹ãƒšãƒ¼ã‚¹ã§åŒºåˆ‡ã‚‰ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆæ—¥æœ¬èªï¼šå§“ åã€è‹±èªï¼šFirst Lastï¼‰
          defaultLastName = nameParts[0];
          defaultFirstName = nameParts.slice(1).join(' ');
        } else {
          // ã‚¹ãƒšãƒ¼ã‚¹ãŒãªã„å ´åˆã¯å§“ã«å…¨ä½“ã‚’å…¥ã‚Œã‚‹
          defaultLastName = displayName;
        }
        console.log('[showNameInputScreen] displayNameã‹ã‚‰åˆ†å‰²:', defaultLastName, defaultFirstName);
      }

      // ç¾åœ¨ã®ã‚¢ã‚¤ã‚³ãƒ³URLã‚’ä¿å­˜ï¼ˆå¤‰æ›´ç”¨ï¼‰
      window.currentUserIconURL = photoURL || '';
      window.currentUserIconBase64 = '';

      resultDiv.innerHTML = `
        <div style="display: flex; align-items: flex-start; gap: 10px; margin-bottom: 24px;">
          <span style="font-size: 18px; font-weight: 600; color: #3b82f6;">â‘¡</span>
          <div style="flex: 1;">
            <div style="font-size: 18px; font-weight: 600; color: #374151;">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¨­å®š</div>
            <div style="font-size: 13px; color: #6b7280; margin-top: 6px;">ã‚¢ãƒ—ãƒªå†…ã§è¡¨ç¤ºã•ã‚Œã‚‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¦ãã ã•ã„</div>
          </div>
        </div>
        <div style="width: 100%; box-sizing: border-box;">
          <!-- ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š -->
          <div style="text-align: center; margin-bottom: 24px;">
            <div style="position: relative; display: inline-block;">
              <div id="user-icon-preview" onclick="document.getElementById('icon-file-input').click()"
                   style="width: 80px; height: 80px; border-radius: 50%; background: #e5e7eb; cursor: pointer;
                          display: flex; align-items: center; justify-content: center; overflow: hidden;
                          border: 3px solid #d1d5db; transition: all 0.2s;">
                ${photoURL
                  ? `<img src="${photoURL}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                     <div style="display: none; width: 100%; height: 100%; align-items: center; justify-content: center;">
                       <svg width="36" height="36" viewBox="0 0 24 24" fill="#9ca3af"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                     </div>`
                  : `<svg width="36" height="36" viewBox="0 0 24 24" fill="#9ca3af"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`
                }
              </div>
              <div style="position: absolute; bottom: -2px; right: -2px; width: 28px; height: 28px; background: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; cursor: pointer;"
                   onclick="document.getElementById('icon-file-input').click()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="white"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
              </div>
            </div>
            <input type="file" id="icon-file-input" accept="image/*" style="display: none;" onchange="previewUserIcon(this)">
            <div style="font-size: 12px; color: #9ca3af; margin-top: 8px;">ã‚¿ãƒƒãƒ—ã—ã¦å¤‰æ›´ï¼ˆä»»æ„ï¼‰</div>
          </div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 14px; color: #374151; margin-bottom: 6px; font-weight: 500;">å§“</label>
            <div style="position: relative;">
              <input type="text" id="input-last-name" placeholder="ä¾‹ï¼šå±±ç”°" value="${defaultLastName.replace(/"/g, '&quot;')}"
                     style="width: 100%; padding: 14px 40px 14px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; box-sizing: border-box; -webkit-appearance: none;"
                     oninput="toggleClearButton(this); clearNameValidationError()">
              <button type="button" class="input-clear-btn" onclick="clearInput('input-last-name')"
                      style="${defaultLastName ? 'display: block;' : 'display: none;'} position: absolute; right: 10px; top: 50%; transform: translateY(-50%); width: 26px; height: 26px; border: none; background: #9ca3af; border-radius: 50%; color: white; font-size: 16px; cursor: pointer; line-height: 1;">Ã—</button>
            </div>
          </div>
          <div style="margin-bottom: 24px;">
            <label style="display: block; font-size: 14px; color: #374151; margin-bottom: 6px; font-weight: 500;">å</label>
            <div style="position: relative;">
              <input type="text" id="input-first-name" placeholder="ä¾‹ï¼šå¤ªéƒ" value="${defaultFirstName.replace(/"/g, '&quot;')}"
                     style="width: 100%; padding: 14px 40px 14px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; box-sizing: border-box; -webkit-appearance: none;"
                     oninput="toggleClearButton(this); clearNameValidationError()">
              <button type="button" class="input-clear-btn" onclick="clearInput('input-first-name')"
                      style="${defaultFirstName ? 'display: block;' : 'display: none;'} position: absolute; right: 10px; top: 50%; transform: translateY(-50%); width: 26px; height: 26px; border: none; background: #9ca3af; border-radius: 50%; color: white; font-size: 16px; cursor: pointer; line-height: 1;">Ã—</button>
            </div>
          </div>
          <div id="name-validation-error" style="display: none; margin-bottom: 12px; padding: 10px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; color: #dc2626; font-size: 14px; text-align: center;">
            å§“ã¨åã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
          </div>
          <button onclick="saveNewUserName('${email}', '${photoURL}', '${userType}', '${firebaseUid}')"
                  id="save-name-btn"
                  style="width: 100%; padding: 16px; background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
            ä¿å­˜
          </button>
          <div id="name-save-result" style="display: none; margin-top: 16px; text-align: center;">
            <div style="color: #40B4E5; font-size: 15px; font-weight: 600;">âœ… ä¿å­˜ã—ã¾ã—ãŸ</div>
            <button onclick="showNotificationScreen()"
                    style="width: 100%; margin-top: 16px; padding: 16px; background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
              æ¬¡ã¸
            </button>
          </div>
        </div>
      `;
      resultDiv.className = 'step-result';
      resultDiv.style.cssText = 'display: block; padding: 20px;';
    }

    // å…¥åŠ›æ¬„ã®ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ‡æ›¿
    window.toggleClearButton = function toggleClearButton(input) {
      const clearBtn = input.parentElement.querySelector('.input-clear-btn');
      if (clearBtn) {
        clearBtn.style.display = input.value.length > 0 ? 'block' : 'none';
      }
    }

    // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
    window.clearInput = function clearInput(inputId) {
      const input = document.getElementById(inputId);
      if (input) {
        input.value = '';
        input.focus();
        toggleClearButton(input);
      }
    }

    // å§“åãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢
    window.clearNameValidationError = function clearNameValidationError() {
      const errorDiv = document.getElementById('name-validation-error');
      if (errorDiv) {
        errorDiv.style.display = 'none';
      }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
    window.previewUserIcon = function previewUserIcon(input) {
      const file = input.files[0];
      if (!file) return;

      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ5MBä»¥ä¸‹ï¼‰
      if (file.size > 5 * 1024 * 1024) {
        alert('ç”»åƒã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
        input.value = '';
        return;
      }

      // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‹ãƒã‚§ãƒƒã‚¯
      if (!file.type.startsWith('image/')) {
        alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
        input.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const base64Data = e.target.result;
        window.currentUserIconBase64 = base64Data;
        window.currentUserIconURL = ''; // Base64ã‚’ä½¿ã†å ´åˆã¯URLã‚’ã‚¯ãƒªã‚¢

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        const previewDiv = document.getElementById('user-icon-preview');
        if (previewDiv) {
          previewDiv.innerHTML = `<img src="${base64Data}" style="width: 100%; height: 100%; object-fit: cover;">`;
        }
        console.log('[previewUserIcon] ã‚¢ã‚¤ã‚³ãƒ³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°');
      };
      reader.onerror = function() {
        alert('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        input.value = '';
      };
      reader.readAsDataURL(file);
    }

    // ã€ç”»é¢3ã€‘ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ç”»é¢ã‚’è¡¨ç¤º
    window.showNotificationScreen = function showNotificationScreen() {
      // ç”»é¢2ï¼ˆauth-resultï¼‰ã‚’éè¡¨ç¤º
      const resultDiv = document.getElementById('auth-result');
      resultDiv.style.display = 'none';

      // é€šçŸ¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‹•çš„ã«è¿½åŠ ã—ã¦è¡¨ç¤º
      const notificationContainer = document.getElementById('notification-section-container');
      notificationContainer.innerHTML = `
        <div class="step-section" id="notification-section">
          <div style="display: flex; align-items: flex-start; gap: 10px;">
            <span style="font-size: 18px; font-weight: 600; color: #3b82f6;">â‘¢</span>
            <span class="step-title" style="flex: 1;">ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’å—ã‘å–ã‚‹</span>
          </div>
          <button class="step-button" onclick="enableNotifications()" id="enable-notifications-btn">é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>
          <div id="notification-result" class="step-result"></div>
        </div>
      `;
      notificationContainer.style.display = 'block';
    }

    // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å§“ãƒ»åã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
    window.saveNewUserName = async function saveNewUserName(email, photoURL, userType, firebaseUid) {
      const lastName = document.getElementById('input-last-name').value.trim();
      const firstName = document.getElementById('input-first-name').value.trim();
      const resultDiv = document.getElementById('auth-result');
      const errorDiv = document.getElementById('name-validation-error');
      const saveBtn = document.getElementById('save-name-btn');

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!lastName || !firstName) {
        errorDiv.style.display = 'block';
        return;
      }
      errorDiv.style.display = 'none';

      const userName = lastName + firstName; // å§“åã‚’çµåˆ

      try {
        // ã‚¢ã‚¤ã‚³ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆBase64å„ªå…ˆã€ãªã‘ã‚Œã°URLï¼‰
        let iconToSave = '';
        if (window.currentUserIconBase64) {
          iconToSave = window.currentUserIconBase64;
        } else if (window.currentUserIconURL) {
          iconToSave = window.currentUserIconURL;
        }

        console.log('[saveNewUserName] ğŸ”§ ä¿å­˜é–‹å§‹:', { email, userName, hasIcon: !!iconToSave });

        // Firestoreæ›´æ–°ï¼ˆsetDoc + mergeã§ç¢ºå®Ÿã«ä¿å­˜ï¼‰
        const { getFirestore, doc, setDoc, getApps, initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        // Firestoreã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç¢ºå®Ÿã«å–å¾—
        let db = window.firebaseDB;
        if (!db) {
          console.log('[saveNewUserName] âš ï¸ window.firebaseDBæœªè¨­å®šã€åˆæœŸåŒ–ã—ã¾ã™');
          const firebaseConfig = {
            apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
            authDomain: "furira.jp",
            projectId: "reborn-chat",
            storageBucket: "reborn-chat.firebasestorage.app",
            messagingSenderId: "345706548795",
            appId: "1:345706548795:web:058a553da6b4b74db5161e"
          };
          const { getApps: getApps2, initializeApp: initializeApp2 } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
          const app = getApps2().length ? getApps2()[0] : initializeApp2(firebaseConfig);
          db = getFirestore(app);
          window.firebaseDB = db;
        }

        const userRef = doc(db, 'users', email);

        // æ›´æ–°ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
        const updateData = { userName: userName };
        if (iconToSave) {
          updateData.userIconUrl = iconToSave; // ä»–ãƒšãƒ¼ã‚¸ã¨çµ±ä¸€ã—ãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å
        }

        // setDoc + mergeã§ç¢ºå®Ÿã«ä¿å­˜ï¼ˆupdateDocã‚ˆã‚Šä¿¡é ¼æ€§ãŒé«˜ã„ï¼‰
        await setDoc(userRef, updateData, { merge: true });
        console.log('[saveNewUserName] âœ… Firestoreä¿å­˜æˆåŠŸ:', updateData);

        // localStorageæ›´æ–°
        localStorage.setItem('reborn_user_name', userName);
        if (iconToSave) {
          localStorage.setItem('reborn_user_icon', iconToSave);
          localStorage.setItem('reborn_user_icon_url', iconToSave); // ä»–ãƒšãƒ¼ã‚¸å…±é€šã®ã‚­ãƒ¼
        }

        console.log('[saveNewUserName] âœ… å®Œäº†:', userName, iconToSave ? 'ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ã‚ã‚Šï¼‰' : 'ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ãªã—ï¼‰');

        if (userType === 'owner') {
          // ä¿å­˜å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼ˆå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ãã®ã¾ã¾ï¼‰
          const saveResultDiv = document.getElementById('name-save-result');
          if (saveResultDiv) {
            saveResultDiv.style.display = 'block';
          }
        } else {
          // pendingã®å ´åˆï¼šæ‰¿èªå¾…ã¡ç”»é¢ã‚’è¡¨ç¤º
          resultDiv.style.display = 'none';
          document.getElementById('pending-approval-section').style.display = 'block';
          // è¡¨ç¤ºç”¨ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆæ›´æ–°æ¸ˆã¿ãªã‚‰æ›´æ–°ç‰ˆã€ãªã‘ã‚Œã°å…ƒã®photoURLï¼‰
          const displayIcon = iconToSave || photoURL;
          document.getElementById('pending-user-info').innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px; justify-content: center;">
              ${displayIcon ? `<img src="${displayIcon}" style="width: 32px; height: 32px; border-radius: 50%;">` : ''}
              <div>
                <div style="font-weight: 600;">${userName}</div>
                <div style="font-size: 12px; color: #6b7280;">${email}</div>
              </div>
            </div>
            <div style="margin-top: 8px; font-size: 12px; color: #9ca3af;">
              æ–°è¦ç™»éŒ²ã•ã‚Œã¾ã—ãŸã€‚ç®¡ç†è€…ã®æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚
            </div>
          `;

          // æ‰¿èªçŠ¶æ…‹ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–é–‹å§‹
          startPendingApprovalListener(email, userName, displayIcon, firebaseUid);

          // === ç®¡ç†è€…ã¸ã®é€šçŸ¥ï¼ˆæ‰¿èªå¾…ã¡ç”»é¢åˆ°é”æ™‚ã«é€ä¿¡ï¼‰ ===
          // ç®¡ç†è€…ã«ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
          try {
            await addTaskToOwners({
              type: 'pending_user_approval',
              title: 'æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰¿èªå¾…ã¡',
              description: `${userName}ï¼ˆ${email}ï¼‰ãŒæ–°è¦ç™»éŒ²ã—ã¾ã—ãŸã€‚æ‰¿èªã¾ãŸã¯å´ä¸‹ã—ã¦ãã ã•ã„ã€‚`,
              link: 'config-permission-users',
              relatedData: {
                pendingUserEmail: email,
                pendingUserName: userName,
                pendingUserPhoto: displayIcon || ''
              }
            });
            console.log('[PendingUser] ç®¡ç†è€…ã¸ã®ã‚¿ã‚¹ã‚¯è¿½åŠ å®Œäº†');
          } catch (taskError) {
            console.error('[PendingUser] ã‚¿ã‚¹ã‚¯è¿½åŠ ã‚¨ãƒ©ãƒ¼:', taskError);
          }

          // ç®¡ç†è€…ã«ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’é€ä¿¡
          try {
            await sendPushToOwners({
              title: 'ğŸ†• æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªå¾…ã¡',
              body: `${userName}ã•ã‚“ãŒæ–°è¦ç™»éŒ²ã—ã¾ã—ãŸ`,
              data: { type: 'pending_user', userEmail: email, badgeCount: '1' }
            });
          } catch (pushError) {
            console.error('[PendingUser] ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚¨ãƒ©ãƒ¼:', pushError);
          }

          // ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒãƒ£ãƒƒãƒˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
          console.log('[PendingUser] === ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ£ãƒƒãƒˆå‡¦ç†é–‹å§‹ ===');
          try {
            await sendSystemChatMessage(
              `ğŸ†• æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªå¾…ã¡\n${userName}ï¼ˆ${email}ï¼‰ãŒæ–°è¦ç™»éŒ²ã—ã¾ã—ãŸã€‚\nã‚·ã‚¹ãƒ†ãƒ è¨­å®š > ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† ã‹ã‚‰æ‰¿èªã—ã¦ãã ã•ã„ã€‚`
            );
            console.log('[PendingUser] âœ… ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ£ãƒƒãƒˆé€ä¿¡å®Œäº†');
          } catch (chatError) {
            console.error('[PendingUser] âŒ ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ£ãƒƒãƒˆé€ä¿¡ã‚¨ãƒ©ãƒ¼:', chatError);
          }
          console.log('[PendingUser] === ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ£ãƒƒãƒˆå‡¦ç†çµ‚äº† ===');

          // ç®¡ç†è€…ã«Resendã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡
          try {
            await sendEmailToOwners({
              subject: 'ğŸ†• æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªå¾…ã¡ - ãƒ•ãƒªãƒ©',
              body: `æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç™»éŒ²ã—ã¾ã—ãŸã€‚\n\nåå‰: ${userName}\nãƒ¡ãƒ¼ãƒ«: ${email}\n\nã‚·ã‚¹ãƒ†ãƒ è¨­å®š > ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† ã‹ã‚‰æ‰¿èªã¾ãŸã¯å´ä¸‹ã—ã¦ãã ã•ã„ã€‚\n\nhttps://furira.jp`
            });
            console.log('[PendingUser] ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†');
          } catch (emailError) {
            console.error('[PendingUser] ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼:', emailError);
          }
          // === ç®¡ç†è€…ã¸ã®é€šçŸ¥çµ‚äº† ===
        }
      } catch (error) {
        console.error('[saveNewUserName] ã‚¨ãƒ©ãƒ¼:', error);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    window.updateUserName = async function updateUserName() {
      const input = document.getElementById('edit-user-name');
      const saveBtn = document.getElementById('save-user-name-btn');
      const statusDiv = document.getElementById('user-name-status');

      if (!input || !saveBtn) return;

      const newUserName = input.value.trim();
      if (!newUserName) {
        statusDiv.textContent = 'åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        statusDiv.style.color = '#dc2626';
        return;
      }

      const email = localStorage.getItem('reborn_user_email');
      if (!email) {
        statusDiv.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
        statusDiv.style.color = '#dc2626';
        return;
      }

      try {
        saveBtn.disabled = true;
        saveBtn.textContent = 'ä¿å­˜ä¸­...';
        statusDiv.textContent = '';

        // Firestoreæ›´æ–°
        const { getFirestore, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const db = window.firebaseDB || getFirestore();
        const userRef = doc(db, 'users', email);
        await updateDoc(userRef, { userName: newUserName });

        // LocalStorageæ›´æ–°
        localStorage.setItem('reborn_user_name', newUserName);

        // IndexedDBæ›´æ–°
        const request = indexedDB.open('RebornUserDB', 1);
        request.onsuccess = () => {
          const db = request.result;
          const transaction = db.transaction(['user'], 'readwrite');
          const store = transaction.objectStore('user');
          store.put(newUserName, 'userName');
        };

        // UIæ›´æ–°
        saveBtn.textContent = 'âœ“ ä¿å­˜å®Œäº†';
        saveBtn.style.background = 'linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%)';
        statusDiv.textContent = 'åå‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ';
        statusDiv.style.color = '#40B4E5';

        // è¡¨ç¤ºåã‚‚æ›´æ–°
        const displayDiv = document.getElementById('display-user-name');
        if (displayDiv) {
          displayDiv.textContent = newUserName + 'ã•ã‚“';
        }

        setTimeout(() => {
          saveBtn.textContent = 'ä¿å­˜';
          saveBtn.style.background = '#3b82f6';
          saveBtn.disabled = false;
        }, 2000);

      } catch (error) {
        console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼åæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        statusDiv.textContent = 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ';
        statusDiv.style.color = '#dc2626';
        saveBtn.textContent = 'ä¿å­˜';
        saveBtn.disabled = false;
      }
    };

    // ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆã—ã¦åˆ¥ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³
    window.signOutAndRetry = async function signOutAndRetry() {
      try {
        const auth = window.firebaseAuth;
        if (auth) {
          await window.firebaseSignOut(auth);
        }
        googleUser = null;
        authenticatedEmail = '';
        existingUserData = null;

        // LocalStorageã‚¯ãƒªã‚¢
        localStorage.removeItem('reborn_user_name');
        localStorage.removeItem('reborn_user_email');
        localStorage.removeItem('reborn_user_permission_id');
        localStorage.removeItem('reborn_user_permission_display');
        localStorage.removeItem('reborn_user_photo_url');
        localStorage.removeItem('reborn_firebase_uid');

        // ç”»é¢ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('google-auth-section').style.display = 'block';
        document.getElementById('pending-approval-section').style.display = 'none';
        document.getElementById('disabled-account-section').style.display = 'none';
        document.getElementById('auth-result').style.display = 'none';
        // é€šçŸ¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
        const notifContainer = document.getElementById('notification-section-container');
        if (notifContainer) {
          notifContainer.innerHTML = '';
          notifContainer.style.display = 'none';
        }
      } catch (error) {
        console.error('âŒ [signOutAndRetry] ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ========================================
    // æ—§ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹èªè¨¼ãƒ•ãƒ­ãƒ¼ï¼ˆå¾Œæ–¹äº’æ›ç”¨ï¼‰
    // ========================================

    // â“ª-1 ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯ã¨ç”»é¢é·ç§»
    window.checkEmailAndProceed = async function checkEmailAndProceed() {
      console.log('[checkEmailAndProceed] ========== é–‹å§‹ ==========');
      const emailInput = document.getElementById('auth-email-input');
      const resultDiv = document.getElementById('auth-result');
      const email = emailInput.value.trim();
      console.log('[checkEmailAndProceed] å…¥åŠ›ãƒ¡ãƒ¼ãƒ«:', email);

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!email) {
        console.log('[checkEmailAndProceed] ã‚¨ãƒ©ãƒ¼: ãƒ¡ãƒ¼ãƒ«æœªå…¥åŠ›');
        resultDiv.textContent = 'âŒ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
        return;
      }

      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        console.log('[checkEmailAndProceed] ã‚¨ãƒ©ãƒ¼: ãƒ¡ãƒ¼ãƒ«å½¢å¼ä¸æ­£');
        resultDiv.textContent = 'âŒ æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
        return;
      }

      // ç¢ºèªä¸­è¡¨ç¤º
      console.log('[checkEmailAndProceed] ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªé–‹å§‹...');
      resultDiv.textContent = 'â³ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªä¸­...';
      resultDiv.className = 'step-result';
      resultDiv.style.display = 'block';

      try {
        // ğŸš¨ ãƒ‡ãƒãƒƒã‚°: ç”»é¢è¡¨ç¤ºç”¨ï¼ˆconsole.logã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ï¼‰
        resultDiv.textContent = 'ğŸ” Firestoreã‚¢ã‚¯ã‚»ã‚¹é–‹å§‹...';

        // Firestoreã§æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
        let db = window.firebaseDB;

        // window.firebaseDBãŒæœªåˆæœŸåŒ–ã®å ´åˆã€ã“ã“ã§åˆæœŸåŒ–
        if (!db) {
          resultDiv.textContent = 'ğŸ” FirebaseåˆæœŸåŒ–ä¸­...';
          const { initializeApp, getApps } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
          const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

          const firebaseConfig = {
            apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
            authDomain: "furira.jp",
            projectId: "reborn-chat",
            storageBucket: "reborn-chat.firebasestorage.app",
            messagingSenderId: "345706548795",
            appId: "1:345706548795:web:058a553da6b4b74db5161e"
          };

          const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
          db = getFirestore(app);
          window.firebaseDB = db;
        }

        const { getDocs, collection, query, where } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const usersCollection = collection(db, 'users');

        // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ï¼ˆåˆå›ç™»éŒ²åˆ¤å®šç”¨ï¼‰
        const allUsersSnapshot = await getDocs(usersCollection);

        // userEmailãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
        const q = query(usersCollection, where('userEmail', '==', email));
        const querySnapshot = await getDocs(q);

        authenticatedEmail = email;

        if (!querySnapshot.empty) {
          // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã£ãŸ â†’ ç›´æ¥LocalStorageã«ä¿å­˜ã—ã¦ã‚¹ãƒ†ãƒƒãƒ—â‘ ã¸
          const userDoc = querySnapshot.docs[0];
          existingUserData = { id: userDoc.id, ...userDoc.data() };

          const userName = existingUserData.userName || existingUserData.name;
          const permissionId = existingUserData.permissionId || existingUserData.permission || 'staff';

          // LocalStorageã«ä¿å­˜
          localStorage.setItem('reborn_user_name', userName);
          localStorage.setItem('reborn_user_email', email);
          localStorage.setItem('reborn_user_permission_id', permissionId);
          localStorage.setItem('reborn_user_permission_display', getPermissionDisplayName(permissionId));

          // IndexedDBã«ã‚‚ä¿å­˜
          const request = indexedDB.open('RebornUserDB', 1);
          request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains('user')) {
              db.createObjectStore('user');
            }
          };
          request.onsuccess = () => {
            const db = request.result;
            const transaction = db.transaction(['user'], 'readwrite');
            const store = transaction.objectStore('user');
            store.put(userName, 'userName');
          };

          // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›æ¬„ã‚’éè¡¨ç¤º
          document.getElementById('email-auth-section').style.display = 'none';

          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆç‹¬ç«‹ã—ãŸè¡¨ç¤ºã‚¨ãƒªã‚¢ï¼‰
          resultDiv.innerHTML = `
            <div style="text-align: center; line-height: 1.5;">
              <div style="font-weight: 600; font-size: 16px; color: #059669;">âœ… èªè¨¼æˆåŠŸï¼</div>
              <div style="margin-top: 8px; font-size: 14px;">${userName}ã•ã‚“ï¼ˆ${getPermissionBadge(permissionId)}ï¼‰</div>
              <div style="margin-top: 12px; font-size: 13px; color: #6b7280;">â†“ æ¬¡ã¯ã€Œé€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
              <div id="auto-notification-status-email" style="font-size: 12px; color: #6b7280; margin-top: 8px;"></div>
            </div>
          `;
          resultDiv.className = 'step-result success';
          resultDiv.style.display = 'block';

        } else {
          // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼
          // æ–°è¦ç™»éŒ²ç”»é¢ã‚’è¡¨ç¤º
          document.getElementById('user-email-input').value = email;

          // ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ã®è¡¨ç¤ºåˆ¤å®šï¼ˆå…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
          const isFirstUser = allUsersSnapshot.size === 0;

          const ownerOption = document.getElementById('owner-option');
          const permissionInfo = document.getElementById('permission-info');

          if (isFirstUser) {
            ownerOption.style.display = 'flex';
            ownerOption.querySelector('input').checked = true;
            permissionInfo.textContent = 'âœ¨ ã‚ãªãŸãŒåˆå›ç™»éŒ²è€…ã§ã™ã€‚ç®¡ç†è€…æ¨©é™ã§ç™»éŒ²ã•ã‚Œã¾ã™ã€‚';
            permissionInfo.style.background = '#fef3c7';
            permissionInfo.style.color = '#92400e';
            permissionInfo.style.display = 'block';
          } else {
            ownerOption.style.display = 'none';
            document.getElementById('staff-option').querySelector('input').checked = true;
            permissionInfo.textContent = 'â„¹ï¸ ç®¡ç†è€…ã¯æ—¢ã«ç™»éŒ²æ¸ˆã¿ã§ã™ã€‚';
            permissionInfo.style.background = '#e0f2fe';
            permissionInfo.style.color = '#075985';
            permissionInfo.style.display = 'block';
          }

          // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
          resultDiv.style.display = 'none';
          document.getElementById('email-auth-section').style.display = 'none';
          document.getElementById('new-user-section').style.display = 'block';
        }
      } catch (error) {
        console.error('âŒ [checkEmailAndProceed] ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
        console.error('âŒ [checkEmailAndProceed] ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.stack);
        resultDiv.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message;
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
      }
      console.log('[checkEmailAndProceed] ========== çµ‚äº† ==========');
    }

    // æ¨©é™ã®è¡¨ç¤ºåã‚’å–å¾—
    function getPermissionDisplayName(permissionId) {
      const permissionMap = {
        'owner': 'ğŸ‘‘ ç®¡ç†è€…',
        'employee': 'ğŸ‘” ç¤¾å“¡',
        'staff': 'ğŸ“‹ ã‚¹ã‚¿ãƒƒãƒ•',
        'leader': 'ğŸ–ï¸ ãƒªãƒ¼ãƒ€ãƒ¼',
        'contractor': 'ğŸ”§ å¤–æ³¨'
      };
      return permissionMap[permissionId] || 'ğŸ“‹ ã‚¹ã‚¿ãƒƒãƒ•';
    }

    // æ¨©é™ãƒãƒƒã‚¸HTMLã‚’å–å¾—
    function getPermissionBadge(permissionId) {
      const permissions = {
        'owner': 'ç®¡ç†è€…',
        'employee': 'ç¤¾å“¡',
        'staff': 'ã‚¹ã‚¿ãƒƒãƒ•',
        'leader': 'ãƒªãƒ¼ãƒ€ãƒ¼',
        'contractor': 'å¤–æ³¨'
      };
      const label = permissions[permissionId] || permissions['staff'];
      return `<span style="font-size: 13px; color: #374151; font-weight: 500;">${label}</span>`;
    }

    // èªè¨¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆæœ€åˆã®ç”»é¢ã«æˆ»ã‚‹ï¼‰
    window.cancelEmailAuth = function cancelEmailAuth() {
      document.getElementById('email-auth-section').style.display = 'block';
      document.getElementById('new-user-section').style.display = 'none';
      document.getElementById('auth-result').style.display = 'none';
      document.getElementById('step0-result').style.display = 'none';
      // é€šçŸ¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
      const notifContainer = document.getElementById('notification-section-container');
      if (notifContainer) {
        notifContainer.innerHTML = '';
        notifContainer.style.display = 'none';
      }
      authenticatedEmail = '';
      existingUserData = null;
    }

    // â“ª-2 æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
    window.saveNewUserInfo = async function saveNewUserInfo() {
      const nameInput = document.getElementById('user-name-input');
      const emailInput = document.getElementById('user-email-input');
      const resultDiv = document.getElementById('step0-result');

      const userName = nameInput.value.trim();
      const email = emailInput.value.trim();

      // æ¨©é™ã‚’å–å¾—
      const permissionRadio = document.querySelector('input[name="user-permission"]:checked');
      const permissionId = permissionRadio ? permissionRadio.value : 'staff';
      const permissionDisplay = permissionRadio ? permissionRadio.dataset.display : 'ã‚¹ã‚¿ãƒƒãƒ•';

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!userName) {
        resultDiv.textContent = 'âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
        // å…¥åŠ›æ¬„ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã—ã¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        nameInput.style.border = '2px solid #dc2626';
        nameInput.style.background = '#fef2f2';
        nameInput.focus();
        // å…¥åŠ›æ™‚ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
        nameInput.addEventListener('input', function resetStyle() {
          nameInput.style.border = '2px solid #e5e7eb';
          nameInput.style.background = '#f9fafb';
          nameInput.removeEventListener('input', resetStyle);
        });
        return;
      }

      // ä¿å­˜ä¸­ã®è¡¨ç¤º
      resultDiv.textContent = 'â³ ä¿å­˜ä¸­...';
      resultDiv.className = 'step-result';
      resultDiv.style.display = 'block';

      // LocalStorageã«ä¿å­˜
      try {
        localStorage.setItem('reborn_user_name', userName);
        localStorage.setItem('reborn_user_email', email);
        localStorage.setItem('reborn_user_permission_id', permissionId);
        localStorage.setItem('reborn_user_permission_display', permissionDisplay);
        console.log('âœ… æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ä¿å­˜:', { name: userName, email: email, permissionId: permissionId });

        // IndexedDBã«ã‚‚ä¿å­˜
        const request = indexedDB.open('RebornUserDB', 1);
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('user')) {
            db.createObjectStore('user');
          }
        };
        request.onsuccess = () => {
          const db = request.result;
          const transaction = db.transaction(['user'], 'readwrite');
          const store = transaction.objectStore('user');
          store.put(userName, 'userName');
          console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’IndexedDBã«ä¿å­˜:', userName);
        };

        // ğŸ†• Firestoreã«ã‚‚ä¿å­˜ï¼ˆuserEmailãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½¿ç”¨ï¼‰
        resultDiv.textContent = 'â³ Firestoreã«ä¿å­˜ä¸­...';

        let db = window.firebaseDB;
        if (!db) {
          const { initializeApp, getApps } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
          const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

          const firebaseConfig = {
            apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
            authDomain: "furira.jp",
            projectId: "reborn-chat",
            storageBucket: "reborn-chat.firebasestorage.app",
            messagingSenderId: "345706548795",
            appId: "1:345706548795:web:058a553da6b4b74db5161e"
          };

          const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
          db = getFirestore(app);
          window.firebaseDB = db;
        }

        const { doc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã¨ã—ã¦ä½¿ç”¨ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
        const userRef = doc(db, 'users', email);

        await setDoc(userRef, {
          userName: userName,
          userEmail: email,
          permissionId: permissionId,
          permissionDisplay: getPermissionDisplayName(permissionId),
          createdAt: new Date().toISOString(),
          deviceId: null  // é€šçŸ¥è¨±å¯å¾Œã«è¨­å®šã•ã‚Œã‚‹
        });

        console.log('âœ… Firestoreã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²å®Œäº†:', email);

        resultDiv.innerHTML = `
          <div style="text-align: center; line-height: 1.5;">
            <div style="font-weight: 600; font-size: 16px; color: #059669;">âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼</div>
            <div style="margin-top: 12px; font-size: 13px; color: #6b7280;">â†“ æ¬¡ã¯ã€Œé€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
          </div>
        `;
        resultDiv.className = 'step-result success';
        resultDiv.style.display = 'block';


        // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç„¡åŠ¹åŒ–
        nameInput.disabled = true;
        emailInput.disabled = true;
        document.querySelectorAll('input[name="user-permission"]').forEach(radio => radio.disabled = true);
      } catch (error) {
        console.error('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        resultDiv.textContent = 'âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
      }
    }

    // ========================================
    // æ—§ç‰ˆã® saveUserInfoï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
    // ========================================
    // â“ª ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜
    async function saveUserInfo() {
      const nameInput = document.getElementById('user-name-input');
      const emailInput = document.getElementById('user-email-input');
      const resultDiv = document.getElementById('step0-result');

      const userName = nameInput.value.trim();
      const email = emailInput.value.trim();

      // æ¨©é™ã‚’å–å¾—ï¼ˆpermissionId ã¨ permissionDisplay ã®ä¸¡æ–¹ï¼‰
      const permissionRadio = document.querySelector('input[name="user-permission"]:checked');
      const permissionId = permissionRadio ? permissionRadio.value : 'staff'; // Internal ID
      const permissionDisplay = permissionRadio ? permissionRadio.dataset.display : 'ã‚¹ã‚¿ãƒƒãƒ•'; // Display name

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!userName) {
        resultDiv.textContent = 'âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
        // å…¥åŠ›æ¬„ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã—ã¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        nameInput.style.border = '2px solid #dc2626';
        nameInput.style.background = '#fef2f2';
        nameInput.focus();
        // å…¥åŠ›æ™‚ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
        nameInput.addEventListener('input', function resetStyle() {
          nameInput.style.border = '2px solid #e5e7eb';
          nameInput.style.background = '#f9fafb';
          nameInput.removeEventListener('input', resetStyle);
        });
        return;
      }

      if (!email) {
        resultDiv.textContent = 'âŒ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
        return;
      }

      // ç°¡æ˜“çš„ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œè¨¼
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        resultDiv.textContent = 'âŒ æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
        return;
      }

      // ä¿å­˜ä¸­ã®è¡¨ç¤º
      resultDiv.textContent = 'â³ ä¿å­˜ä¸­...';
      resultDiv.className = 'step-result';
      resultDiv.style.display = 'block';

      // âœ… ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ã®å ´åˆã€ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
      if (permissionId === 'owner') {
        const confirmMessage = `âš ï¸ ç®¡ç†è€…æ¨©é™ã§ç™»éŒ²ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚\n\nç®¡ç†è€…ã¯ä»¥ä¸‹ã®æ¨©é™ã‚’æŒã¡ã¾ã™ï¼š\nâ€¢ ã™ã¹ã¦ã®æ©Ÿèƒ½ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹\nâ€¢ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ¨©é™\nâ€¢ ã‚·ã‚¹ãƒ†ãƒ è¨­å®šå¤‰æ›´æ¨©é™\n\næœ¬å½“ã«ç®¡ç†è€…æ¨©é™ã§ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`;

        if (!confirm(confirmMessage)) {
          resultDiv.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚';
          resultDiv.className = 'step-result';
          resultDiv.style.display = 'block';
          console.log('[saveUserInfo] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚ªãƒ¼ãƒŠãƒ¼ç™»éŒ²ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
          return;
        }
      }

      // âœ… ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ã®å ´åˆã€Firestoreã§æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚’ãƒã‚§ãƒƒã‚¯
      if (permissionId === 'owner') {
        try {
          // Firebase modular SDK (v10) ã‚’ä½¿ç”¨
          const db = window.firebaseDB;
          if (!db) {
            throw new Error('Firestore ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
          }

          // getDocs ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ¸ˆã¿ã®ã‚‚ã®ã‚’ä½¿ç”¨
          const { getDocs, collection } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
          const usersCollection = collection(db, 'users');
          const usersSnapshot = await getDocs(usersCollection);
          const userCount = usersSnapshot.size;

          console.log('[saveUserInfo] æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:', userCount);

          if (userCount > 0) {
            // æ—¢ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ã‚ªãƒ¼ãƒŠãƒ¼ç™»éŒ²ã‚’æ‹’å¦
            resultDiv.textContent = 'âŒ æ—¢ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚¹ã‚¿ãƒƒãƒ•ã¾ãŸã¯å¤–æ³¨ã§ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚';
            resultDiv.className = 'step-result error';
            resultDiv.style.display = 'block';
            console.log('[saveUserInfo] âŒ ã‚ªãƒ¼ãƒŠãƒ¼é‡è¤‡ç™»éŒ²ã‚’æ‹’å¦ï¼ˆæ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ' + userCount + 'ï¼‰');
            return;
          }

          console.log('[saveUserInfo] âœ… åˆå›ç™»éŒ²è€…ã®ãŸã‚ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ã‚’è¨±å¯');
        } catch (error) {
          console.error('âŒ ã‚ªãƒ¼ãƒŠãƒ¼é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
          resultDiv.textContent = 'âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
          resultDiv.className = 'step-result error';
          resultDiv.style.display = 'block';
          return;
        }
      }

      // LocalStorageã«ä¿å­˜
      try {
        localStorage.setItem('reborn_user_name', userName);
        localStorage.setItem('reborn_user_email', email);
        localStorage.setItem('reborn_user_permission_id', permissionId);
        localStorage.setItem('reborn_user_permission_display', permissionDisplay);
        console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ä¿å­˜:', { name: userName, email: email, permissionId: permissionId, permissionDisplay: permissionDisplay });

        // IndexedDBã«ã‚‚ä¿å­˜ï¼ˆService Workerã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã™ã‚‹ãŸã‚ï¼‰
        const request = indexedDB.open('RebornUserDB', 1);
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('user')) {
            db.createObjectStore('user');
          }
        };
        request.onsuccess = () => {
          const db = request.result;
          const transaction = db.transaction(['user'], 'readwrite');
          const store = transaction.objectStore('user');
          store.put(userName, 'userName');
          console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’IndexedDBã«ä¿å­˜:', userName);
        };
        request.onerror = () => {
          console.error('âŒ IndexedDBä¿å­˜ã‚¨ãƒ©ãƒ¼');
        };

        // PWAç‰ˆã§ã¯Firestoreã®ã¿ã«ä¿å­˜ï¼ˆGAS Proxyã¯ä¸è¦ï¼‰
        console.log('âœ… PWAç‰ˆï¼šFirestoreã«ä¿å­˜äºˆå®šï¼ˆç«¯æœ«ç™»éŒ²æ™‚ã«è‡ªå‹•ä¿å­˜ï¼‰');

        resultDiv.innerHTML = `
          <div style="text-align: center; line-height: 1.5;">
            <div style="font-weight: 600; font-size: 16px; color: #059669;">âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼</div>
            <div style="margin-top: 12px; font-size: 13px; color: #6b7280;">â†“ æ¬¡ã¯ã€Œé€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
          </div>
        `;
        resultDiv.className = 'step-result success';
        resultDiv.style.display = 'block';


        // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç„¡åŠ¹åŒ–
        nameInput.disabled = true;
        emailInput.disabled = true;
        document.querySelectorAll('input[name="user-permission"]').forEach(radio => radio.disabled = true);
      } catch (error) {
        console.error('âŒ LocalStorageä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        resultDiv.textContent = 'âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
      }
    }

    // é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹ï¼ˆè¨±å¯â†’FCMç™»éŒ²ã‚’è‡ªå‹•å®Ÿè¡Œï¼‰
    async function enableNotifications() {
      const resultDiv = document.getElementById('notification-result');
      const enableBtn = document.getElementById('enable-notifications-btn');
      const openAppButton = document.getElementById('open-app-button');

      // ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œãƒã‚§ãƒƒã‚¯
      if (!('Notification' in window)) {
        resultDiv.textContent = 'â„¹ï¸ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“\n\nä¸‹ã®ã€Œã‚¢ãƒ—ãƒªã¸ç§»å‹•ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
        resultDiv.className = 'step-result';
        resultDiv.style.display = 'block';
        openAppButton.style.display = 'block';
        return;
      }

      // ğŸ”§ iOS PWAå¯¾å¿œ: Firebase MessagingãŒãªãã¦ã‚‚é€šçŸ¥è¨±å¯ã¯å–å¾—å¯èƒ½
      const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
      const isStandalone = window.navigator.standalone === true;
      const isIOSPWA = isIOS && isStandalone;

      // iOSãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¤œå‡ºï¼ˆ16.4ä»¥ä¸Šã§Web Pushå¯¾å¿œï¼‰
      let iOSVersion = 'N/A';
      if (isIOS) {
        const match = navigator.userAgent.match(/OS (\d+)_(\d+)/);
        if (match) {
          iOSVersion = `${match[1]}.${match[2]}`;
        }
      }

      const debugInfo = [];
      debugInfo.push(`iOS: ${isIOS}`);
      debugInfo.push(`ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³: ${isStandalone}`);
      debugInfo.push(`iOS PWA: ${isIOSPWA}`);
      debugInfo.push(`iOSãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${iOSVersion}`);
      debugInfo.push(`firebaseMessaging: ${!!window.firebaseMessaging}`);
      debugInfo.push(`Notification API: ${'Notification' in window}`);
      debugInfo.push(`PushManager: ${'PushManager' in window}`);
      debugInfo.push(`ç¾åœ¨ã®è¨±å¯çŠ¶æ…‹: ${typeof Notification !== 'undefined' ? Notification.permission : 'N/A'}`);
      console.log('[é€šçŸ¥è¨­å®š] ãƒ‡ãƒãƒƒã‚°æƒ…å ±:', debugInfo.join(', '));

      // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›æ¸ˆã¿

      try {
        // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦å‡¦ç†ä¸­è¡¨ç¤º
        enableBtn.disabled = true;
        enableBtn.textContent = 'è¨­å®šä¸­...';
        // é€šçŸ¥è¨±å¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºä¸­ã¯èƒŒæ™¯ãƒ†ã‚­ã‚¹ãƒˆã‚’éè¡¨ç¤º
        resultDiv.style.display = 'none';

        // Step 1: é€šçŸ¥è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        console.log('[é€šçŸ¥è¨­å®š] Step 1: é€šçŸ¥è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹');

        const permission = await Notification.requestPermission();
        console.log('[é€šçŸ¥è¨­å®š] é€šçŸ¥è¨±å¯çµæœ:', permission);
        
        // è¨±å¯çµæœå¾Œã«è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’æœ‰åŠ¹åŒ–
        resultDiv.style.display = 'block';
        resultDiv.className = 'step-result';

        // ğŸ”§ iOS PWAã§ã¯åˆå›deniedå¾Œã€ã‚¢ãƒ—ãƒªç”»é¢ã§å†åº¦è¨±å¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒå‡ºã‚‹ã“ã¨ãŒã‚ã‚‹
        // deniedã§ã‚‚ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã›ãšã€ã‚¢ãƒ—ãƒªã«è‡ªå‹•é·ç§»ã™ã‚‹
        if (permission !== 'granted') {
          console.log('[é€šçŸ¥è¨­å®š] åˆå›denied - ã‚¢ãƒ—ãƒªç”»é¢ã§å†è©¦è¡Œã—ã¾ã™');
          resultDiv.textContent = 'é€šçŸ¥è¨­å®šã‚’ç¶šè¡Œä¸­...';
          resultDiv.className = 'step-result';

          // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚¢ãƒ—ãƒªã«é·ç§»ï¼ˆã‚¢ãƒ—ãƒªå†…ã§å†åº¦é€šçŸ¥è¨±å¯ã‚’å–å¾—ã§ãã‚‹ï¼‰
          setTimeout(() => {
            openApp();
          }, 1000);
          return;
        }

        // Step 2: FCMç™»éŒ² ã¾ãŸã¯ Web Pushç™»éŒ²
        resultDiv.textContent = 'é€šçŸ¥è¨±å¯OKï¼ç™»éŒ²ä¸­...';

        // Service Workerç™»éŒ²ç¢ºèª
        if (!swRegistration) {
          resultDiv.textContent = 'âŒ Service WorkerãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“\nãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚';
          resultDiv.className = 'step-result error';
          enableBtn.disabled = false;
          enableBtn.textContent = 'é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹';
          console.error('âŒ swRegistration is null');
          return;
        }

        console.log('âœ… Service Workeræº–å‚™å®Œäº†:', swRegistration);

        let currentToken = null;

        // ğŸ”§ Firebase MessagingãŒã‚ã‚‹å ´åˆã¯FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
        // ãªã„å ´åˆï¼ˆiOS PWAç­‰ï¼‰ã¯Web Push APIã§ç™»éŒ²
        if (window.firebaseMessaging) {
          // Firebase Messagingã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
          const { getToken } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js');

          console.log('ğŸ”„ FCMãƒˆãƒ¼ã‚¯ãƒ³å–å¾—é–‹å§‹...');
          currentToken = await getToken(window.firebaseMessaging, {
            vapidKey: VAPID_PUBLIC_KEY,
            serviceWorkerRegistration: swRegistration
          });
          console.log('âœ… FCMãƒˆãƒ¼ã‚¯ãƒ³å–å¾—æˆåŠŸ:', currentToken);
        } else {
          // iOS PWA: Web Push APIã§ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å–å¾—
          console.log('ğŸ”„ [iOS PWA] Web Push ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³é–‹å§‹...');
          try {
            const subscription = await swRegistration.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: VAPID_PUBLIC_KEY
            });

            // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®å®Œå…¨æƒ…å ±ã‚’JSONå½¢å¼ã§ä¿å­˜ï¼ˆWeb Pushé€ä¿¡ã«å¿…è¦ï¼‰
            const subscriptionJson = subscription.toJSON();
            const webPushData = {
              endpoint: subscriptionJson.endpoint,
              keys: {
                p256dh: subscriptionJson.keys?.p256dh || '',
                auth: subscriptionJson.keys?.auth || ''
              }
            };

            // Web Pushã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’è­˜åˆ¥ã§ãã‚‹å½¢å¼ã§ãƒˆãƒ¼ã‚¯ãƒ³åŒ–
            // "webpush:" ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã§è­˜åˆ¥å¯èƒ½ã«ã™ã‚‹
            currentToken = 'webpush:' + btoa(JSON.stringify(webPushData));

            // å®Œå…¨ãªã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’localStorageã«ä¿å­˜
            localStorage.setItem('reborn_webpush_subscription', JSON.stringify(webPushData));

            console.log('âœ… [iOS PWA] Web Push ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æˆåŠŸ');
            console.log('  ğŸ“ Endpoint:', subscriptionJson.endpoint.substring(0, 50) + '...');
            console.log('  ğŸ”‘ Keys: p256dh=' + (webPushData.keys.p256dh ? 'æœ‰ã‚Š' : 'ãªã—') + ', auth=' + (webPushData.keys.auth ? 'æœ‰ã‚Š' : 'ãªã—'));
          } catch (pushError) {
            console.error('âŒ [iOS PWA] Web Push ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å¤±æ•—:', pushError);
            // ã‚¨ãƒ©ãƒ¼ã§ã‚‚é€šçŸ¥è¨±å¯ã¯å–å¾—ã§ãã¦ã„ã‚‹ã®ã§ç¶šè¡Œ
            currentToken = 'ios-pwa-' + Date.now();
            console.log('âš ï¸ [iOS PWA] ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨:', currentToken);
          }
        }

        if (!currentToken) {
          resultDiv.textContent = 'âŒ ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
          resultDiv.className = 'step-result error';
          enableBtn.disabled = false;
          enableBtn.textContent = 'é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹';
          return;
        }

        // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’localStorageã«ä¿å­˜
        localStorage.setItem('reborn_fcm_token', currentToken);
        console.log('ğŸ’¾ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’localStorageã«ä¿å­˜');

        // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’å–å¾—
        const deviceInfo = {
          userAgent: navigator.userAgent,
          platform: navigator.platform,
          language: navigator.language,
          screenSize: `${screen.width}x${screen.height}`,
          timestamp: new Date().toISOString()
        };

        // LocalStorageã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
        const userEmail = localStorage.getItem('reborn_user_email') || 'unknown';
        const userName = localStorage.getItem('reborn_user_name') || '';
        const userPermissionId = localStorage.getItem('reborn_user_permission_id') || 'staff';
        const userPermissionDisplay = localStorage.getItem('reborn_user_permission_display') || 'ã‚¹ã‚¿ãƒƒãƒ•';

        if (!userName || !currentToken) {
          throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ã§ãã¾ã›ã‚“');
        }

        console.log('ğŸ”„ Firestore devices ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜é–‹å§‹...');

        const db = window.firebaseDB;
        const collectionFunc = window.firestoreCollection;
        const collectionGroupFunc = window.firestoreCollectionGroup;
        const addDocFunc = window.firestoreAddDoc;
        const queryFunc = window.firestoreQuery;
        const whereFunc = window.firestoreWhere;
        const getDocsFunc = window.firestoreGetDocs;
        const updateDocFunc = window.firestoreUpdateDoc;

        if (!db || !collectionFunc || !collectionGroupFunc || !addDocFunc || !queryFunc || !whereFunc || !getDocsFunc || !updateDocFunc) {
          throw new Error('Firestoreé–¢æ•°ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        }

        // 1. ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ã‚ªãƒ¼ãƒŠãƒ¼ãƒ‡ãƒã‚¤ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
        const allDevicesQuery = queryFunc(
          collectionGroupFunc(db, 'devices'),
          whereFunc('permissionId', '==', 'owner'),
          whereFunc('active', '==', true)
        );
        const ownerDevices = await getDocsFunc(allDevicesQuery);

        // ã‚ªãƒ¼ãƒŠãƒ¼åˆ¶é™ãƒã‚§ãƒƒã‚¯
        let finalPermissionId = userPermissionId;
        let finalPermissionDisplay = userPermissionDisplay;
        if (ownerDevices.size > 0 && userPermissionId === 'owner') {
          finalPermissionId = 'staff';
          finalPermissionDisplay = 'ã‚¹ã‚¿ãƒƒãƒ•';
          console.log('âš ï¸ ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã§æ—¢ã«ã‚ªãƒ¼ãƒŠãƒ¼ãƒ‡ãƒã‚¤ã‚¹ãŒå­˜åœ¨ã™ã‚‹ãŸã‚ã€ã‚¹ã‚¿ãƒƒãƒ•ã«é™æ ¼');
        }

        // 2. ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ—¢å­˜ãƒ‡ãƒã‚¤ã‚¹ã‚’å–å¾—
        const userDevicesRef = collectionFunc(db, 'users', userEmail, 'devices');
        const userAllDevices = await getDocsFunc(userDevicesRef);

        // 3. åŒã˜FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŒã¤ãƒ‡ãƒã‚¤ã‚¹ã‚’æ¤œç´¢ï¼ˆè¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œï¼‰
        let existingDeviceDoc = null;
        const staleDevices = [];
        const now = new Date();
        const STALE_THRESHOLD_DAYS = 30; // 30æ—¥ä»¥ä¸Šæœªä½¿ç”¨ã¯å¤ã„ãƒ‡ãƒã‚¤ã‚¹

        for (const deviceDoc of userAllDevices.docs) {
          const deviceData = deviceDoc.data();

          // åŒã˜FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŒã¤ãƒ‡ãƒã‚¤ã‚¹ã‚’æ¤œç´¢
          if (deviceData.fcmToken === currentToken) {
            existingDeviceDoc = deviceDoc;
            console.log(`ğŸ”„ æ—¢å­˜ãƒ‡ãƒã‚¤ã‚¹ç™ºè¦‹ï¼ˆåŒä¸€ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰: ${deviceDoc.id}`);
          }

          // 30æ—¥ä»¥ä¸Šæœªä½¿ç”¨ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’è¨˜éŒ²
          if (deviceData.lastUsedAt) {
            const lastUsed = deviceData.lastUsedAt.toDate ? deviceData.lastUsedAt.toDate() : new Date(deviceData.lastUsedAt);
            const daysSinceLastUsed = (now - lastUsed) / (1000 * 60 * 60 * 24);
            if (daysSinceLastUsed > STALE_THRESHOLD_DAYS) {
              staleDevices.push(deviceDoc);
            }
          }
        }

        // 4. å¤ã„ãƒ‡ãƒã‚¤ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆ30æ—¥ä»¥ä¸Šæœªä½¿ç”¨ï¼‰
        if (staleDevices.length > 0) {
          console.log(`ğŸ§¹ å¤ã„ãƒ‡ãƒã‚¤ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—: ${staleDevices.length}ä»¶`);
          const deleteDocFunc = window.firestoreDeleteDoc;
          for (const staleDoc of staleDevices) {
            try {
              await deleteDocFunc(staleDoc.ref);
              console.log(`ğŸ—‘ï¸ å¤ã„ãƒ‡ãƒã‚¤ã‚¹å‰Šé™¤: ${staleDoc.id}`);
            } catch (e) {
              console.warn(`âš ï¸ ãƒ‡ãƒã‚¤ã‚¹å‰Šé™¤å¤±æ•—: ${staleDoc.id}`, e);
            }
          }
        }

        // 5. ãƒ‡ãƒã‚¤ã‚¹ç™»éŒ²ï¼ˆæ—¢å­˜æ›´æ–° or æ–°è¦ä½œæˆï¼‰
        const deviceData = {
          fcmToken: currentToken,
          deviceInfo: deviceInfo,
          active: true,
          permissionId: finalPermissionId,
          permissionDisplay: finalPermissionDisplay,
          userName: userName,
          userEmail: userEmail,
          lastUsedAt: new Date()
        };

        let deviceDocRef;
        if (existingDeviceDoc) {
          // æ—¢å­˜ãƒ‡ãƒã‚¤ã‚¹ã‚’æ›´æ–°ï¼ˆregisteredAtã¯ä¿æŒï¼‰
          await updateDocFunc(existingDeviceDoc.ref, deviceData);
          deviceDocRef = existingDeviceDoc.ref;
          console.log('âœ… æ—¢å­˜ãƒ‡ãƒã‚¤ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ:', existingDeviceDoc.id);
        } else {
          // æ–°è¦ãƒ‡ãƒã‚¤ã‚¹ã‚’è¿½åŠ 
          deviceData.registeredAt = new Date();
          deviceDocRef = await addDocFunc(userDevicesRef, deviceData);
          console.log('âœ… æ–°è¦ãƒ‡ãƒã‚¤ã‚¹ã‚’ç™»éŒ²ã—ã¾ã—ãŸ:', deviceDocRef.id);
        }

        // 6. ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ‡ãƒã‚¤ã‚¹æ•°ã‚’ãƒ­ã‚°
        const activeCount = userAllDevices.docs.filter(d => d.data().active && d.id !== (existingDeviceDoc?.id)).length + 1;
        console.log(`ğŸ“± ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ‡ãƒã‚¤ã‚¹æ•°: ${activeCount}`);

        // å®Œäº†è¡¨ç¤º
        resultDiv.textContent = 'âœ… é€šçŸ¥è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼';
        resultDiv.className = 'step-result success';
        enableBtn.textContent = 'âœ“ è¨­å®šå®Œäº†';
        enableBtn.style.background = 'linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%)';

        // ã€Œã‚¢ãƒ—ãƒªã¸ç§»å‹•ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        openAppButton.style.display = 'block';

        // ãƒãƒ£ãƒƒãƒˆæœªèª­ãƒªã‚¹ãƒŠãƒ¼ã‚’é–‹å§‹
        if (typeof startChatUnreadListener === 'function') {
          console.log('[FCMç™»éŒ²] ãƒãƒ£ãƒƒãƒˆæœªèª­ãƒªã‚¹ãƒŠãƒ¼ã‚’é–‹å§‹');
          setTimeout(() => {
            startChatUnreadListener();
          }, 1000);
        }

      } catch (error) {
        resultDiv.textContent = 'âŒ è¨­å®šå¤±æ•—\n\nã‚¨ãƒ©ãƒ¼: ' + error.message;
        resultDiv.className = 'step-result error';
        enableBtn.disabled = false;
        enableBtn.textContent = 'é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹';
        console.error('âŒ é€šçŸ¥è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã‚¢ãƒ—ãƒªã‚’é–‹ã
    function openApp() {
      // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ãƒ•ãƒ©ã‚°ã‚’ä¿å­˜
      localStorage.setItem('fcm-setup-completed', '1');

      // ã‚¢ãƒ—ãƒªç”»é¢ã‚’è¡¨ç¤º
      showAppScreen();

      // ğŸŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ«ãƒ¼ãƒ ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å®Œäº†å¾Œã«å®Ÿè¡Œï¼‰
      if (typeof addCurrentUserToGlobalRooms === 'function') {
        console.log('[openApp] ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ«ãƒ¼ãƒ ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ');
        addCurrentUserToGlobalRooms();
      }

      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã‚’èª­ã¿è¾¼ã‚€ï¼ˆUI-013: ãƒˆãƒƒãƒ—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ï¼‰
      navigateToPage('home');
    }

    // ã‚¢ãƒ—ãƒªç”»é¢ã‚’è¡¨ç¤º
    async function showAppScreen() {
      document.getElementById('setup-screen').style.display = 'none';
      document.getElementById('app-screen').style.display = 'flex';

      // FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€æ›´æ–°ãŒã‚ã‚Œã°è‡ªå‹•é€ä¿¡
      await checkAndUpdateFCMToken();

      // ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼ã‚’é–‹å§‹ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒƒã‚¸æ›´æ–°ç”¨ï¼‰
      if (typeof startTodoListener === 'function') {
        startTodoListener();
      }
    }

    /**
     * FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€æ›´æ–°ãŒã‚ã‚Œã°è‡ªå‹•çš„ã«GASã«é€ä¿¡
     * Phase 2: ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å‡¦ç†ï¼ˆNOTIF-003ï¼‰
     */
    async function checkAndUpdateFCMToken() {
      try {
        // Service WorkerãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if (!swRegistration) {
          console.log('â­ï¸ Service Workeræœªç™»éŒ²ã®ãŸã‚ã€FCMãƒˆãƒ¼ã‚¯ãƒ³ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—');
          return;
        }

        // FCMéã‚µãƒãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆSafariç­‰ï¼‰ã‚’ãƒã‚§ãƒƒã‚¯
        if (!window.firebaseMessaging) {
          console.log('â„¹ï¸ Firebase Messagingéå¯¾å¿œç’°å¢ƒ');
          return;
        }

        // ğŸ”§ iOS PWAã§é€šçŸ¥è¨±å¯ãŒã¾ã ã®å ´åˆã¯å†ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        if (Notification.permission !== 'granted') {
          console.log('ğŸ”” é€šçŸ¥è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­...');
          const permission = await Notification.requestPermission();
          console.log('ğŸ”” é€šçŸ¥è¨±å¯çµæœ:', permission);
          if (permission !== 'granted') {
            console.log('â­ï¸ é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€FCMãƒˆãƒ¼ã‚¯ãƒ³ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—');
            return;
          }
        }

        // Firebase Messagingã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
        const { getToken } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js');

        console.log('ğŸ”„ FCMãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°ãƒã‚§ãƒƒã‚¯é–‹å§‹...');

        const currentToken = await getToken(window.firebaseMessaging, {
          vapidKey: VAPID_PUBLIC_KEY,
          serviceWorkerRegistration: swRegistration
        });

        if (!currentToken) {
          console.log('âš ï¸ FCMãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
          return;
        }

        // localStorageã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã¨æ¯”è¼ƒ
        const savedToken = localStorage.getItem('reborn_fcm_token');

        if (savedToken === currentToken) {
          console.log('âœ… FCMãƒˆãƒ¼ã‚¯ãƒ³ã¯æœ€æ–°ã§ã™ï¼ˆæ›´æ–°ãªã—ï¼‰');
          return;
        }

        console.log('ğŸ”„ FCMãƒˆãƒ¼ã‚¯ãƒ³ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ');
        console.log('  - æ—§ãƒˆãƒ¼ã‚¯ãƒ³:', savedToken ? savedToken.substring(0, 20) + '...' : 'ãªã—');
        console.log('  - æ–°ãƒˆãƒ¼ã‚¯ãƒ³:', currentToken.substring(0, 20) + '...');

        // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’å–å¾—
        const deviceInfo = {
          userAgent: navigator.userAgent,
          platform: navigator.platform,
          language: navigator.language,
          screenSize: `${screen.width}x${screen.height}`,
          timestamp: new Date().toISOString()
        };

        // LocalStorageã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
        const userEmail = localStorage.getItem('reborn_user_email') || 'unknown';
        const userName = localStorage.getItem('reborn_user_name') || '';
        const permissionDisplay = localStorage.getItem('reborn_user_permission_display') || 'ã‚¹ã‚¿ãƒƒãƒ•';

        // ğŸ”§ ä¿®æ­£: localStorageã‹ã‚‰é€šçŸ¥è¨­å®šã‚’èª­ã¿è¾¼ã‚€
        const config = JSON.parse(localStorage.getItem('config') || '{}');
        const notificationEnabled = config.notificationEnabled !== undefined ? config.notificationEnabled : true;
        const notificationSound = config.notificationSound !== undefined ? config.notificationSound : true;

        // GASã«æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ä¿¡
        const response = await fetch(GAS_API_URL + '?action=subscribeFCM&token=' + encodeURIComponent(currentToken) +
                                    '&deviceInfo=' + encodeURIComponent(JSON.stringify(deviceInfo)) +
                                    '&userId=' + encodeURIComponent(userEmail) +
                                    '&userName=' + encodeURIComponent(userName) +
                                    '&email=' + encodeURIComponent(userEmail) +
                                    '&permission=' + encodeURIComponent(permissionDisplay) +
                                    '&notificationEnabled=' + encodeURIComponent(notificationEnabled) +
                                    '&notificationSound=' + encodeURIComponent(notificationSound));

        if (response.ok) {
          // localStorageã«æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
          localStorage.setItem('reborn_fcm_token', currentToken);
          console.log('âœ… FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’è‡ªå‹•æ›´æ–°ã—ã¾ã—ãŸ');
        } else {
          console.error('âŒ FCMãƒˆãƒ¼ã‚¯ãƒ³ã®é€ä¿¡ã«å¤±æ•—:', response.status);
        }
      } catch (error) {
        console.error('âŒ FCMãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ãƒ‰ãƒ­ãƒ¯ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã/é–‰ã˜ã‚‹
    function toggleDrawer() {
      const drawer = document.getElementById('drawer-menu');
      const overlay = document.getElementById('drawer-overlay');

      drawer.classList.toggle('active');
      overlay.classList.toggle('active');
    }

    // ãƒ‰ãƒ­ãƒ¯ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
    function closeDrawer() {
      const drawer = document.getElementById('drawer-menu');
      const overlay = document.getElementById('drawer-overlay');

      drawer.classList.remove('active');
      overlay.classList.remove('active');
    }

    // ãƒã‚¹ã‚¿ç®¡ç†ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰
    function toggleMasterAccordion() {
      const accordion = document.getElementById('drawer-master');
      accordion.classList.toggle('open');
    }

    // è¨­å®šç®¡ç†ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰
    function toggleConfigAccordion() {
      const accordion = document.getElementById('drawer-config');
      accordion.classList.toggle('open');
    }

    // pmTokenç”Ÿæˆç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function generatePmToken() {
      return crypto.getRandomValues(new Uint32Array(1))[0].toString(36);
    }

    // ãƒšãƒ¼ã‚¸é·ç§»ï¼ˆãƒ‰ãƒ­ãƒ¯ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ï¼‰
    function navigateToPage(page, options = {}) {
      const iframe = document.getElementById('gas-iframe');
      const header = document.getElementById('app-header');
      const skeleton = document.getElementById('skeleton-loader');
      const baseUrl = 'https://script.google.com/macros/s/AKfycbx6ybbRLDqKQJ8IR-NPoVP8981Gtozzz0N3880XanEGRS4--iZtset8PFrVcD_u9YAHMA/exec';
      const skipSkeleton = options.skipSkeleton || false;

      // ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬é–‹å§‹
      const startTime = performance.now();
      console.log('â±ï¸ [è¨ˆæ¸¬é–‹å§‹] ãƒšãƒ¼ã‚¸é·ç§»:', page);

      // UI-013: ãƒ‰ãƒ­ãƒ¯ãƒ¼ã‚’å…ˆã«é–‰ã˜ã‚‹ï¼ˆã‚¹ã‚±ãƒ«ãƒˆãƒ³UIè¡¨ç¤ºã‚’å¦¨ã’ãªã„ã‚ˆã†ã«ï¼‰
      closeDrawer();

      // UI-013: ãƒšãƒ¼ã‚¸é·ç§»æ™‚ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°UXæ”¹å–„
      // æ¡ˆD: 300msé…å»¶ã§ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIè¡¨ç¤ºï¼ˆé«˜é€Ÿã‚­ãƒ£ãƒƒã‚·ãƒ¥æ™‚ã¯éè¡¨ç¤ºï¼‰
      // æ¡ˆC: ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚’é«˜é€ŸåŒ–ï¼ˆ0.15sï¼‰
      let skeletonTimeout = null;
      if (!skipSkeleton && skeleton) {
        skeletonTimeout = setTimeout(() => {
          console.log('ğŸ”„ [UI-013] ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°300msè¶…é - ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIè¡¨ç¤º:', page);
          skeleton.classList.remove('hidden');
          skeleton.style.display = ''; // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢ï¼ˆé‡è¦ï¼ï¼‰
        }, 300);
      } else if (skipSkeleton) {
        console.log('âš¡ [UI-013] é«˜é€Ÿé·ç§»ãƒ¢ãƒ¼ãƒ‰ - ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIã‚¹ã‚­ãƒƒãƒ—:', page);
      }
      // ãƒ˜ãƒƒãƒ€ãƒ¼ã¯èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆ¶å¾¡ï¼ˆã‚«ã‚¯ã¤ãé˜²æ­¢ï¼‰

      // ğŸ” postMessageç”¨ã®parentOriginã¨pmTokenã‚’ç”Ÿæˆï¼ˆäºŒé‡iframeå¯¾ç­–ï¼‰
      const parentOrigin = location.origin; // https://reborn-inventory-system.pages.dev
      const pmToken = crypto.getRandomValues(new Uint32Array(1))[0].toString(36);
      localStorage.setItem('pm_token', pmToken);
      console.log('ğŸ” [postMessage Security] parentOrigin:', parentOrigin, 'pmToken:', pmToken);

      // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDç”Ÿæˆï¼ˆç«¯æœ«ãƒ»ã‚¿ãƒ–ã”ã¨ã«ä¸€æ„ï¼‰
      if (!sessionStorage.getItem('device_session_id')) {
        const newSessionId = Date.now() + '_' + Math.random().toString(36).substring(2);
        sessionStorage.setItem('device_session_id', newSessionId);
        console.log('ğŸ†” æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ç”Ÿæˆ:', newSessionId);
      } else {
        console.log('ğŸ†” æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ä½¿ç”¨:', sessionStorage.getItem('device_session_id'));
      }
      const sessionId = sessionStorage.getItem('device_session_id');
      const sessionIdParam = '&sessionId=' + encodeURIComponent(sessionId);

      // FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’localStorageã‹ã‚‰å–å¾—
      const fcmToken = localStorage.getItem('reborn_fcm_token') || '';
      const fcmParam = fcmToken ? '&fcmToken=' + encodeURIComponent(fcmToken) : '';
      console.log('ğŸ”‘ FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’iframeã«æ¸¡ã—ã¾ã™:', fcmToken ? fcmToken.substring(0, 20) + '...' : 'ãªã—');

      // postMessageç”¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
      const securityParams = '&parentOrigin=' + encodeURIComponent(parentOrigin) + '&pmToken=' + encodeURIComponent(pmToken);

      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
      document.querySelectorAll('.drawer-item').forEach(item => {
        item.classList.remove('active');
      });

      if (page === 'home') {
        // PWAç‰ˆãƒˆãƒƒãƒ—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç›´æ¥èª­ã¿è¾¼ã¿ï¼ˆè¶…é«˜é€ŸåŒ–ï¼š2ç§’ â†’ 50msï¼‰
        const pwaBaseUrl = location.origin;
        const userName = localStorage.getItem('reborn_user_name') || '';
        // userIconUrl ã¯localStorageã‹ã‚‰ç›´æ¥èª­ã¿è¾¼ã‚€ãŸã‚ã€URLã«ã¯å«ã‚ãªã„ï¼ˆURI Too Longå¯¾ç­–ï¼‰

        const params = new URLSearchParams({
          userName: userName,
          sessionId: sessionId
        });

        iframe.src = pwaBaseUrl + '/menu_home.html?' + params.toString();

        // menu_home.htmlèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ãƒãƒ£ãƒƒãƒˆãƒãƒƒã‚¸ã‚’æ›´æ–°
        iframe.addEventListener('load', function updateMenuBadgeOnLoad() {
          console.log('[Home] menu_home.htmlèª­ã¿è¾¼ã¿å®Œäº† - ãƒãƒ£ãƒƒãƒˆãƒãƒƒã‚¸ã‚’æ›´æ–°');
          // å°‘ã—é…å»¶ã•ã›ã¦DOMãŒç¢ºå®Ÿã«æº–å‚™ã•ã‚Œã¦ã‹ã‚‰æ›´æ–°
          setTimeout(() => {
            if (typeof chatUnreadCount !== 'undefined') {
              updateChatBadge(chatUnreadCount);
            }
          }, 100);
          iframe.removeEventListener('load', updateMenuBadgeOnLoad);
        });
      } else if (page === 'product') {
        // PWAç‰ˆå•†å“ç™»éŒ²ã‚’ç›´æ¥èª­ã¿è¾¼ã¿ï¼ˆè¶…é«˜é€ŸåŒ–ï¼š2ç§’ â†’ 50msï¼‰
        const pwaBaseUrl = location.origin;
        const userName = localStorage.getItem('reborn_user_name') || '';
        const userEmail = localStorage.getItem('reborn_user_email') || '';
        // userIconUrl ã¯localStorageã‹ã‚‰ç›´æ¥èª­ã¿è¾¼ã‚€ãŸã‚ã€URLã«ã¯å«ã‚ãªã„ï¼ˆURI Too Longå¯¾ç­–ï¼‰

        const params = new URLSearchParams({
          userName: userName,
          userEmail: userEmail,
          sessionId: sessionId
        });

        iframe.src = pwaBaseUrl + '/product.html?' + params.toString();
        document.getElementById('drawer-product').classList.add('active');

        // ç®¡ç†ç•ªå·è¨­å®šã®postMessageé€ä¿¡ã‚’å»ƒæ­¢ï¼ˆFirestoreç›´æ¥èª­ã¿è¾¼ã¿ã«çµ±ä¸€ï¼‰
        iframe.addEventListener('load', function sendManagementConfigToProduct() {
          console.log('ğŸ“¦ [PWA] product.htmlèª­ã¿è¾¼ã¿å®Œäº†');
        
          // ä»¥ä¸‹ã€GASçµŒç”±ã®postMessageé€ä¿¡ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼ˆ2025-11-19ï¼‰
          // ç†ç”±: product.html ãŒ Firestore ã‹ã‚‰ç›´æ¥èª­ã¿è¾¼ã‚€ãŸã‚ä¸è¦ï¼ˆé«˜é€ŸåŒ–ï¼‰
          /*
          if (window.managementConfigCache) {
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ â†’ å³åº§ã«é€ä¿¡
            console.log('ğŸ“¤ [PWA] ç®¡ç†ç•ªå·è¨­å®šã‚’postMessageé€ä¿¡: prefix="' + window.managementConfigCache.prefix + '"');
            iframe.contentWindow.postMessage({
              type: 'managementConfig',
              config: window.managementConfigCache
            }, pwaBaseUrl);
          } else if (window.managementConfigPreloading) {
            // ãƒ­ãƒ¼ãƒ‰ä¸­ â†’ å¾…æ©Ÿã—ã¦å†è©¦è¡Œ
            console.log('â³ [PWA] ç®¡ç†ç•ªå·è¨­å®šãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ä¸­... 3ç§’å¾Œã«å†è©¦è¡Œ');
            setTimeout(() => {
              if (window.managementConfigCache) {
                console.log('ğŸ“¤ [PWA] ç®¡ç†ç•ªå·è¨­å®šã‚’postMessageé€ä¿¡ï¼ˆé…å»¶ï¼‰: prefix="' + window.managementConfigCache.prefix + '"');
                iframe.contentWindow.postMessage({
                  type: 'managementConfig',
                  config: window.managementConfigCache
                }, pwaBaseUrl);
              } else {
                console.warn('âš ï¸ [PWA] ç®¡ç†ç•ªå·è¨­å®šãƒ—ãƒªãƒ­ãƒ¼ãƒ‰æœªå®Œäº†ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰');
              }
            }, 3000);
          } else {
            // æœªãƒ­ãƒ¼ãƒ‰ â†’ ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰é–‹å§‹ã—ã¦å¾…æ©Ÿ
            console.log('ğŸš€ [PWA] ç®¡ç†ç•ªå·è¨­å®šãƒ—ãƒªãƒ­ãƒ¼ãƒ‰é–‹å§‹ï¼ˆã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ï¼‰');
            preloadManagementConfigForPWA().then(() => {
              if (window.managementConfigCache) {
                console.log('ğŸ“¤ [PWA] ç®¡ç†ç•ªå·è¨­å®šã‚’postMessageé€ä¿¡ï¼ˆã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰å®Œäº†ï¼‰: prefix="' + window.managementConfigCache.prefix + '"');
                iframe.contentWindow.postMessage({
                  type: 'managementConfig',
                  config: window.managementConfigCache
                }, pwaBaseUrl);
              }
            });
          }
          */

          // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’1å›ã ã‘å®Ÿè¡Œ
          iframe.removeEventListener('load', sendManagementConfigToProduct);
        }, { once: true });
      } else if (page === 'config-basic') {
        // PWAç‰ˆè¨­å®šç®¡ç†ï¼ˆåŸºæœ¬è¨­å®šã‚¿ãƒ–ï¼‰ã‚’iframeã§é–‹ã
        iframe.src = '/config.html?tab=system&_cb=' + Date.now();
        document.getElementById('drawer-config-system').classList.add('active');
      } else if (page === 'config-product') {
        // PWAç‰ˆè¨­å®šç®¡ç†ã‚’iframeã§é–‹ãï¼ˆproduct.htmlã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
        iframe.src = '/config.html?tab=product&_cb=' + Date.now();
        document.getElementById('drawer-config-product').classList.add('active');
      } else if (page === 'config-system') {
        // PWAç‰ˆè¨­å®šç®¡ç†ã‚’iframeã§é–‹ãï¼ˆproduct.htmlã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
        iframe.src = '/config.html?tab=system&_cb=' + Date.now();
        document.getElementById('drawer-config-system').classList.add('active');
      } else if (page === 'config-permission-users') {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚¿ãƒ–ã‚’ç›´æ¥é–‹ã
        iframe.src = '/config.html?tab=system&subtab=users&_cb=' + Date.now();
        document.getElementById('drawer-config-system').classList.add('active');
      } else if (page === 'config') {
        // Legacy support - default to basic
        iframe.src = baseUrl + '?menu=config&activeTab=basic' + fcmParam + securityParams + '&_cb=' + Date.now();
      } else if (page === 'inventory') {
        // PWAç‰ˆåœ¨åº«ç®¡ç†ã‚’ç›´æ¥èª­ã¿è¾¼ã¿ï¼ˆè¶…é«˜é€ŸåŒ–ï¼š2ç§’ â†’ 50msï¼‰
        const pwaBaseUrl = location.origin;
        const userName = localStorage.getItem('reborn_user_name') || '';
        // userIconUrl ã¯localStorageã‹ã‚‰ç›´æ¥èª­ã¿è¾¼ã‚€ãŸã‚ã€URLã«ã¯å«ã‚ãªã„ï¼ˆURI Too Longå¯¾ç­–ï¼‰

        const params = new URLSearchParams({
          userName: userName,
          sessionId: sessionId
        });

        iframe.src = pwaBaseUrl + '/inventory.html?' + params.toString();
        document.getElementById('drawer-inventory').classList.add('active');
      } else if (page === 'inventory_history') {
        // PWAç‰ˆå…¥å‡ºåº«å±¥æ­´ã‚’ç›´æ¥èª­ã¿è¾¼ã¿ï¼ˆè¶…é«˜é€ŸåŒ–ï¼š2ç§’ â†’ 50msï¼‰
        const pwaBaseUrl = location.origin;
        const userName = localStorage.getItem('reborn_user_name') || '';
        // userIconUrl ã¯localStorageã‹ã‚‰ç›´æ¥èª­ã¿è¾¼ã‚€ãŸã‚ã€URLã«ã¯å«ã‚ãªã„ï¼ˆURI Too Longå¯¾ç­–ï¼‰

        const params = new URLSearchParams({
          userName: userName,
          sessionId: sessionId
        });

        iframe.src = pwaBaseUrl + '/inventory_history.html?' + params.toString();
        document.getElementById('drawer-inventory-history').classList.add('active');
      } else if (page === 'chat') {
        // PWAç‰ˆãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚’ç›´æ¥èª­ã¿è¾¼ã¿ï¼ˆè¶…é«˜é€ŸåŒ–ï¼š2ç§’ â†’ 50msï¼‰
        const userName = localStorage.getItem('reborn_user_name') || '';
        const userEmail = localStorage.getItem('reborn_user_email') || '';
        // userIconUrl ã¯localStorageã‹ã‚‰ç›´æ¥èª­ã¿è¾¼ã‚€ãŸã‚ã€URLã«ã¯å«ã‚ãªã„ï¼ˆURI Too Longå¯¾ç­–ï¼‰
        const fcmToken = localStorage.getItem('fcm_token') || '';

        const params = new URLSearchParams({
          app: 'pwa',
          userName: userName,
          userEmail: userEmail,
          fcmToken: fcmToken,
          parentOrigin: window.location.origin,
          pmToken: pmToken,
          sessionId: sessionId
        });

        iframe.src = '/chat_rooms_list.html?v=20251127f&' + params.toString();
        document.getElementById('drawer-chat').classList.add('active');
      } else if (page === 'master-product') {
        // PWAç‰ˆãƒã‚¹ã‚¿ç®¡ç†ï¼ˆå•†å“é–¢é€£ï¼‰ã‚’iframeã«èª­ã¿è¾¼ã‚€
        const pwaBaseUrl = location.origin;
        iframe.src = pwaBaseUrl + '/master-management.html?category=product' + sessionIdParam;
      } else if (page === 'master-business') {
        // PWAç‰ˆãƒã‚¹ã‚¿ç®¡ç†ï¼ˆæ¥­å‹™é–¢é€£ï¼‰ã‚’iframeã«èª­ã¿è¾¼ã‚€
        const pwaBaseUrl = location.origin;
        iframe.src = pwaBaseUrl + '/master-management.html?category=business' + sessionIdParam;
      } else if (page === 'shipping-master') {
        // GASç‰ˆç™ºé€æ–¹æ³•ãƒã‚¹ã‚¿ç®¡ç†
        iframe.src = baseUrl + '?menu=shipping-master' + fcmParam + securityParams;
      } else if (page === 'packaging-master') {
        // GASç‰ˆæ¢±åŒ…è³‡æãƒã‚¹ã‚¿ç®¡ç†
        iframe.src = baseUrl + '?menu=packaging-master' + fcmParam + securityParams;
      } else if (page === 'todo-list') {
        // ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆ
        const userName = localStorage.getItem('reborn_user_name') || '';
        const userEmail = localStorage.getItem('reborn_user_email') || '';

        const params = new URLSearchParams({
          userEmail: userEmail,
          parentOrigin: parentOrigin,
          pmToken: pmToken,
          sessionId: sessionId
        });

        iframe.src = `/todo_list.html?v=20251201a&${params.toString()}`;
      } else if (page === 'todo-history') {
        // å®Œäº†ã‚¿ã‚¹ã‚¯å±¥æ­´
        const userName = localStorage.getItem('reborn_user_name') || '';
        const userEmail = localStorage.getItem('reborn_user_email') || '';

        const params = new URLSearchParams({
          userEmail: userEmail,
          parentOrigin: parentOrigin,
          pmToken: pmToken,
          sessionId: sessionId
        });

        iframe.src = `/todo_history.html?v=20251201a&${params.toString()}`;
      }

      // FABè¡¨ç¤ºåˆ¶å¾¡ï¼ˆãƒãƒ£ãƒƒãƒˆä»¥å¤–ã¯è¡¨ç¤ºï¼‰
      if (page === 'chat') {
        hideChatFab();
      } else {
        showChatFab();
      }

      // UI-013: iframeèª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®å‡¦ç†ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°UXæ”¹å–„ï¼‰
      // ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIã‚’éè¡¨ç¤ºã«ã—ã€ãƒ˜ãƒƒãƒ€ãƒ¼è¡¨ç¤ºã‚’åˆ¶å¾¡
      if (iframe) {
        // æ—¢å­˜ã®loadã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
        iframe.removeEventListener('load', handlePageLoadComplete);

        // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
        function handlePageLoadComplete() {
          // ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬å®Œäº†
          const loadTime = performance.now() - startTime;
          console.log('âœ… ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†:', page);
          console.log(`ğŸ“Š å®Ÿéš›ã®èª­ã¿è¾¼ã¿æ™‚é–“: ${loadTime.toFixed(0)}ms`);

          // æ¡ˆD: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢ï¼ˆã‚¹ã‚±ãƒ«ãƒˆãƒ³UIè¡¨ç¤ºå‰ã«ãƒ­ãƒ¼ãƒ‰å®Œäº†ã—ãŸå ´åˆï¼‰
          if (skeletonTimeout) {
            clearTimeout(skeletonTimeout);
            console.log('âš¡ é«˜é€Ÿãƒ­ãƒ¼ãƒ‰ï¼ˆ300msä»¥å†…ï¼‰ - ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIè¡¨ç¤ºã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
          }

          if (skeleton) skeleton.classList.add('hidden');

          // ãƒ˜ãƒƒãƒ€ãƒ¼è¡¨ç¤ºåˆ¶å¾¡
          if (header) {
            if (page === 'home') {
              header.style.display = 'none'; // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã¯ãƒ˜ãƒƒãƒ€ãƒ¼éè¡¨ç¤º
            } else {
              header.style.display = 'flex'; // é€šå¸¸ãƒšãƒ¼ã‚¸ã¯ãƒ˜ãƒƒãƒ€ãƒ¼è¡¨ç¤º
            }
          }
        }

        iframe.addEventListener('load', handlePageLoadComplete, { once: true });
      }
    }

    // postMessageå—ä¿¡å‡¦ç†ï¼ˆGASã‹ã‚‰ã®é€šçŸ¥å—ä¿¡ï¼‰
    // ğŸ” originæ¤œè¨¼ã®ã¿ï¼ˆevent.sourceæ¯”è¼ƒãªã—ã€pmTokenæ¤œè¨¼ãªã—ï¼‰
    const ALLOWED_ORIGINS = new Set([
      'https://script.google.com'
    ]);

    function isAllowedOrigin(origin) {
      if (ALLOWED_ORIGINS.has(origin)) return true;
      try {
        const url = new URL(origin);
        return url.hostname.endsWith('.googleusercontent.com');
      } catch {
        return false;
      }
    }

    window.addEventListener('message', async function(event) {
      const iframe = document.getElementById('gas-iframe');
      const iframeWindow = iframe ? iframe.contentWindow : null;

      // iframeå†…ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã€è¨±å¯ã•ã‚ŒãŸoriginã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚’ç¢ºèª
      const isFromIframe = event.source === iframeWindow;
      const isFromAllowedOrigin = isAllowedOrigin(event.origin);

      console.log('[postMessage Debug] event.source === iframeWindow:', isFromIframe);
      console.log('[postMessage Debug] isAllowedOrigin:', isFromAllowedOrigin);
      console.log('[postMessage Debug] event.origin:', event.origin);

      if (!isFromIframe && !isFromAllowedOrigin) {
        console.warn('âš ï¸ [postMessage] ä¸æ­£ãªoriginã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ‹’å¦:', event.origin);
        return;
      }

      const data = event.data || {};
      console.log('ğŸ“¨ [postMessage] å—ä¿¡ (from', event.origin + '):', data);

      console.log('ğŸ“¨ å—ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (from', event.origin + '):', data);

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°è¦æ±‚ã®å‡¦ç†
      if (data.type === 'updateUserIcon') {
        console.log('ğŸ–¼ï¸ [postMessage] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°è¦æ±‚ã‚’å—ä¿¡');
        loadUserIcon();
        return;
      }

      // ãƒãƒ£ãƒƒãƒˆä¸€è¦§ã«æˆ»ã‚‹è¦æ±‚ã®å‡¦ç†
      if (data.type === 'showChatRoomsList') {
        console.log('========================================');
        console.log('ğŸ”™ [postMessage] ãƒãƒ£ãƒƒãƒˆä¸€è¦§ã«æˆ»ã‚‹è¦æ±‚ã‚’å—ä¿¡');
        console.log('[postMessage] data:', data);
        console.log('[postMessage] openChatRooms é–¢æ•°å‘¼ã³å‡ºã—é–‹å§‹');
        console.log('========================================');
        openChatRooms();
        console.log('[postMessage] âœ… openChatRooms å‘¼ã³å‡ºã—å®Œäº†');
        return;
      }

      // ãƒšãƒ¼ã‚¸é·ç§»è¦æ±‚ã®å‡¦ç†ï¼ˆãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³é·ç§»ï¼‰
      if (data.type === 'navigateTo') {
        console.log('========================================');
        console.log('ğŸ”€ [postMessage] navigateTo è¦æ±‚ã‚’å—ä¿¡');
        console.log('[postMessage] url:', data.url);
        console.log('[postMessage] ç¾åœ¨ã®URL:', window.location.href);
        console.log('========================================');

        if (data.url) {
          console.log('[postMessage] ãƒšãƒ¼ã‚¸é·ç§»ã‚’å®Ÿè¡Œã—ã¾ã™:', data.url);
          window.location.href = data.url;
          console.log('[postMessage] âœ… window.location.hrefè¨­å®šå®Œäº†');
        } else {
          console.error('[postMessage] âŒ URLãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        }
        return;
      }

      // ãƒˆãƒƒãƒ—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹è¦æ±‚ã®å‡¦ç†ï¼ˆå‰Šé™¤: æ—©æœŸç™»éŒ²ãƒªã‚¹ãƒŠãƒ¼ã¨é‡è¤‡ï¼‰
      // æ—©æœŸç™»éŒ²ãƒªã‚¹ãƒŠãƒ¼ï¼ˆè¡Œ935-954ï¼‰ã§å‡¦ç†ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä¸è¦

      if (data.type === 'navigateToChat') {
        console.log('========================================');
        console.log('ğŸ’¬ [postMessage] ãƒˆãƒ¼ã‚¯ä¸€è¦§ã«æˆ»ã‚‹è¦æ±‚ã‚’å—ä¿¡');
        console.log('========================================');
        if (typeof navigateToPage === 'function') {
          navigateToPage('chat');
          console.log('[postMessage] âœ… navigateToPage(\'chat\')å‘¼ã³å‡ºã—å®Œäº†ï¼ˆ200msé…å»¶ãƒ¢ãƒ¼ãƒ‰ï¼‰');
        } else {
          console.error('[postMessage] âŒ navigateToPage()ãŒæœªå®šç¾©');
        }
        return;
      }

      // ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆã‹ã‚‰ã®ãƒšãƒ¼ã‚¸é·ç§»è¦æ±‚
      if (data.type === 'navigateToPage' && data.page) {
        console.log('========================================');
        console.log('âœ“ [postMessage] ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆã‹ã‚‰ãƒšãƒ¼ã‚¸é·ç§»è¦æ±‚ã‚’å—ä¿¡');
        console.log('âœ“ é·ç§»å…ˆ:', data.page);
        console.log('========================================');
        if (typeof navigateToPage === 'function') {
          navigateToPage(data.page);
          console.log('[postMessage] âœ… ãƒšãƒ¼ã‚¸é·ç§»å®Œäº†');
        } else {
          console.error('[postMessage] âŒ navigateToPage()ãŒæœªå®šç¾©');
        }
        return;
      }

      // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¦æ±‚ã®å‡¦ç†ï¼ˆiframeå†…é·ç§»ï¼‰
      if (data.type === 'navigate') {
        const iframe = document.getElementById('gas-iframe');

        // URLãŒç›´æ¥æŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆå¾“æ¥ã®æ–¹æ³•ï¼‰
        if (data.url) {
          console.log('ğŸš€ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³:', data.url);
          iframe.src = data.url;
        }
        // pageæŒ‡å®šã®å ´åˆï¼ˆãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ç­‰ï¼‰
        else if (data.page) {
          const page = data.page;
          const roomId = data.roomId || '';
          const userName = data.userName || localStorage.getItem('reborn_user_name') || '';
          const userEmail = localStorage.getItem('reborn_user_email') || '';
          const fcmToken = localStorage.getItem('fcm_token') || '';

          console.log('ğŸš€ ãƒšãƒ¼ã‚¸é·ç§»:', page, 'roomId:', roomId);

          // ãƒãƒ£ãƒƒãƒˆç”»é¢ã¸ã®é·ç§»
          if (page === 'chat') {
            // PWAç‰ˆãƒãƒ£ãƒƒãƒˆUIã‚’ç›´æ¥èª­ã¿è¾¼ã¿ï¼ˆè¶…é«˜é€ŸåŒ–ï¼š2ç§’ â†’ 50msï¼‰
            const sessionId = sessionStorage.getItem('device_session_id');
            // userIconUrl ã¯localStorageã‹ã‚‰ç›´æ¥èª­ã¿è¾¼ã‚€ãŸã‚ã€URLã«ã¯å«ã‚ãªã„ï¼ˆURI Too Longå¯¾ç­–ï¼‰
            const searchQuery = data.searchQuery || '';  // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å¼•ãç¶™ã

            const params = new URLSearchParams({
              userName: userName,
              userEmail: userEmail,
              roomId: roomId,
              sessionId: sessionId
            });
            // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¿½åŠ 
            if (searchQuery) {
              params.set('searchQuery', searchQuery);
              console.log('ğŸ” æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¼•ãç¶™ã:', searchQuery);
            }
            const url = '/chat_ui_firestore.html?' + params.toString();
            console.log('ğŸš€ PWAç‰ˆãƒãƒ£ãƒƒãƒˆUI URL:', url);
            iframe.src = url;

            // ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’é–‹ã„ãŸã®ã§FABã‚’éè¡¨ç¤º
            hideChatFab();
          }
        }
      }

      // ğŸ”” Service Workerã‹ã‚‰ã®ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒãƒƒã‚¸æ›´æ–°è¦æ±‚
      if (event.data.type === 'INCREMENT_SYSTEM_UNREAD') {
        console.log('[Badge] Service Workerã‹ã‚‰ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒãƒƒã‚¸æ›´æ–°è¦æ±‚');
        // ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ã®Firestore unreadCountã‚’+1
        incrementSystemNotificationUnreadCount();
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°è¦æ±‚ã®å‡¦ç†
      if (event.data.type === 'UPDATE_USER_ICON') {
        console.log('ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°:', event.data.iconUrl ? 'ç”»åƒã‚ã‚Š' : 'ç”»åƒãªã—');
        updateUserIcon(event.data.iconUrl);
      }

      // ğŸ“¢ ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ æŠ•ç¨¿ï¼ˆçµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼‰
      // Webhookæ–¹å¼ã«ç§»è¡Œã—ãŸãŸã‚ã€postMessageã«ã‚ˆã‚‹é€šçŸ¥å—ä¿¡ã¯ä¸è¦
      // GAS â†’ Cloudflare Worker â†’ Firestore + FCM ã§å®Œçµ
    });

    // ğŸ”• æ—§ãƒ™ãƒ«ãƒãƒ¼ã‚¯é€šçŸ¥ãƒãƒƒã‚¸æ©Ÿèƒ½ï¼ˆç„¡åŠ¹åŒ– - çµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼‰
    // çµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã¯ã€ãƒãƒ£ãƒƒãƒˆãƒãƒƒã‚¸ã«çµ±åˆ
    // ãƒãƒƒã‚¸ã¯Firestoreã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰è‡ªå‹•æ›´æ–°
    /*
    let badgeCount = 0;

    // ãƒãƒƒã‚¸ã‚«ã‚¦ãƒ³ãƒˆã‚’åˆæœŸåŒ–ï¼ˆlocalStorage ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
    function initBadge() {
      const saved = localStorage.getItem('reborn-badge-count');
      badgeCount = saved ? parseInt(saved, 10) : 0;
      updateBadgeDisplay();
      updateAppBadge();
    }

    // ãƒãƒƒã‚¸ã‚’å¢—ã‚„ã™
    function incrementBadge() {
      badgeCount++;
      localStorage.setItem('reborn-badge-count', badgeCount);
      updateBadgeDisplay();
      updateAppBadge();
      console.log('ğŸ”” ãƒãƒƒã‚¸ã‚«ã‚¦ãƒ³ãƒˆ +1:', badgeCount);
    }

    // ãƒãƒƒã‚¸ã‚’ã‚¯ãƒªã‚¢
    function clearBadge() {
      badgeCount = 0;
      localStorage.setItem('reborn-badge-count', 0);
      updateBadgeDisplay();
      updateAppBadge();
      console.log('ğŸ”” ãƒãƒƒã‚¸ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢');
    }

    // ãƒãƒƒã‚¸è¡¨ç¤ºã‚’æ›´æ–°
    function updateBadgeDisplay() {
      const badgeElement = document.getElementById('badge-count');
      if (badgeElement) {
        badgeElement.textContent = badgeCount;
        if (badgeCount > 0) {
          badgeElement.classList.add('active');
        } else {
          badgeElement.classList.remove('active');
        }
      }
    }
    */

    // App Badge API ã‚’æ›´æ–°ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ã®ãƒãƒƒã‚¸ï¼‰
    // çµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼šãƒãƒ£ãƒƒãƒˆæœªèª­ + ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆã®åˆè¨ˆã‚’è¡¨ç¤º
    function updateAppBadge() {
      if ('setAppBadge' in navigator) {
        const totalBadgeCount = chatUnreadCount + todoUnreadCount;
        if (totalBadgeCount > 0) {
          navigator.setAppBadge(totalBadgeCount).catch(err => {
            console.error('âŒ Badge API ã‚¨ãƒ©ãƒ¼:', err);
          });
          console.log('ğŸ“± ã‚¢ãƒ—ãƒªãƒãƒƒã‚¸æ›´æ–°:', totalBadgeCount, '(ãƒãƒ£ãƒƒãƒˆ:', chatUnreadCount, '+ Todo:', todoUnreadCount, ')');
        } else {
          navigator.clearAppBadge().catch(err => {
            console.error('âŒ Badge API ã‚¨ãƒ©ãƒ¼:', err);
          });
          console.log('ğŸ“± ã‚¢ãƒ—ãƒªãƒãƒƒã‚¸ã‚¯ãƒªã‚¢');
        }
      }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚’é–‹ã
    function openUserSettings() {
      navigateToPage('config-basic');
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
    function loadUserIcon() {
      const iconUrl = localStorage.getItem('reborn_user_icon_url');
      const iconImage = document.getElementById('user-icon-image');
      const iconPlaceholder = document.getElementById('user-icon-placeholder');

      if (iconUrl) {
        // ã‚¢ã‚¤ã‚³ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç”»åƒã‚’è¡¨ç¤º
        iconImage.src = iconUrl;
        iconImage.style.display = 'block';
        iconPlaceholder.style.display = 'none';

        // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¡¨ç¤º
        iconImage.onerror = function() {
          console.warn('âš ï¸ ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã®èª­ã¿è¾¼ã¿å¤±æ•—:', iconUrl);
          iconImage.style.display = 'none';
          iconPlaceholder.style.display = 'block';
        };
      } else {
        // ã‚¢ã‚¤ã‚³ãƒ³ãŒæœªè¨­å®šã®å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¡¨ç¤º
        iconImage.style.display = 'none';
        iconPlaceholder.style.display = 'block';
      }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
    function updateUserIcon(iconUrl) {
      if (iconUrl) {
        localStorage.setItem('reborn_user_icon', iconUrl);
      } else {
        localStorage.removeItem('reborn_user_icon');
      }
      loadUserIcon();
    }

    // ã‚¢ãƒ—ãƒªå†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã®Firestoreã‚¢ã‚¤ã‚³ãƒ³ã‚¯ãƒªã‚¢
    async function clearFirestoreUserIconIfNeeded() {
      try {
        // localStorageã«ã‚¢ã‚¤ã‚³ãƒ³ãŒãªã„ ã‹ã¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒã‚ã‚‹å ´åˆ
        const userIcon = localStorage.getItem('reborn_user_icon');
        const userName = localStorage.getItem('reborn_user_name');

        if (!userIcon && userName) {
          console.log('[Icon Init] ğŸ”„ ã‚¢ã‚¤ã‚³ãƒ³åˆæœŸåŒ–: localStorageã«ã‚¢ã‚¤ã‚³ãƒ³ãªã—ã€Firestoreã‚’ã‚¯ãƒªã‚¢');

          // FirebaseåˆæœŸåŒ–
          const { initializeApp, getApps } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
          const { getFirestore, doc, getDoc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

          const firebaseConfig = {
            apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
            authDomain: "furira.jp",
            projectId: "reborn-chat",
            storageBucket: "reborn-chat.firebasestorage.app",
            messagingSenderId: "345706548795",
            appId: "1:345706548795:web:058a553da6b4b74db5161e"
          };

          const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig, 'icon-clear-app');
          const db = getFirestore(app);

          // Firestoreã®usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºèª
          const userRef = doc(db, 'users', userName);
          const userDoc = await getDoc(userRef);

          if (userDoc.exists()) {
            const userData = userDoc.data();
            if (userData.userIconUrl) {
              // ã‚¢ã‚¤ã‚³ãƒ³URLãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ã‚¯ãƒªã‚¢
              await updateDoc(userRef, {
                userIconUrl: ''
              });
              console.log('[Icon Init] âœ… Firestoreã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ:', userName);
            } else {
              console.log('[Icon Init] â„¹ï¸ Firestoreã«ã‚¢ã‚¤ã‚³ãƒ³ãªã—ï¼ˆã‚¯ãƒªã‚¢ä¸è¦ï¼‰:', userName);
            }
          } else {
            console.log('[Icon Init] â„¹ï¸ Firestoreã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæœªå­˜åœ¨:', userName);
          }
        } else {
          console.log('[Icon Init] â„¹ï¸ ã‚¢ã‚¤ã‚³ãƒ³åˆæœŸåŒ–ã‚¹ã‚­ãƒƒãƒ—:', {
            hasIcon: !!userIcon,
            hasUserName: !!userName
          });
        }
      } catch (error) {
        console.error('[Icon Init] âŒ ã‚¢ã‚¤ã‚³ãƒ³åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã‚¢ãƒ—ãƒªã®èµ·å‹•ã‚’å¦¨ã’ãªã„
      }
    }

    // é€šçŸ¥ãƒšãƒ¼ã‚¸ã‚’é–‹ãï¼ˆPWAå†…ã§é·ç§»ï¼‰
    function openNotifications() {
      window.location.href = '/notifications.html';
    }

    // çµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼šService Workerã‹ã‚‰ã®ãƒãƒƒã‚¸æ›´æ–°ã¯ä¸è¦
    /*
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('message', (event) => {
        console.log('ğŸ“¨ Service Workerã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', event.data);

        if (event.data.type === 'INCREMENT_BADGE') {
          incrementBadge();
        }
      });
    }
    */

    // ========================================
    // ãƒãƒ£ãƒƒãƒˆFABæ©Ÿèƒ½
    // ========================================

    // ãƒãƒ£ãƒƒãƒˆä¸€è¦§ã‚’é–‹ã
    function openChatRooms() {
      console.log('[Chat FAB] ãƒãƒ£ãƒƒãƒˆä¸€è¦§ã‚’é–‹ã');

      const userName = localStorage.getItem('reborn_user_name') || '';
      const userEmail = localStorage.getItem('reborn_user_email') || '';
      const fcmToken = localStorage.getItem('fcm_token') || '';
      const sessionId = sessionStorage.getItem('device_session_id');

      // pmTokenç”Ÿæˆ
      const pmToken = generatePmToken();
      localStorage.setItem('pm_token', pmToken);

      // PWAç‰ˆã§ã¯ chat_rooms_list.html ã‚’ç›´æ¥é–‹ã
      const params = new URLSearchParams({
        app: 'pwa',
        userName: userName,
        userEmail: userEmail,
        fcmToken: fcmToken,
        parentOrigin: window.location.origin,
        pmToken: pmToken,
        sessionId: sessionId
      });

      const iframe = document.getElementById('gas-iframe');
      iframe.src = `/chat_rooms_list.html?v=20251127f&${params.toString()}`;

      // ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’é–‹ã„ãŸã®ã§FABã‚’éè¡¨ç¤º
      hideChatFab();
    }

    // FABè¡¨ç¤ºåˆ¶å¾¡
    function showChatFab() {
      const fab = document.getElementById('chat-fab');
      if (fab) {
        fab.classList.remove('hidden');
      }
    }

    function hideChatFab() {
      const fab = document.getElementById('chat-fab');
      if (fab) {
        fab.classList.add('hidden');
      }
    }

    // çµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼šFABã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆä¸è¦ï¼ˆä¸Šéƒ¨ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ã«çµ±åˆï¼‰

    // æœªèª­ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°ï¼ˆFirebaseçµŒç”±ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼‰
    let chatUnreadCount = 0;

    function updateChatBadge(count) {
      console.log('[Chat Badge] ãƒãƒƒã‚¸æ›´æ–°:', count);
      chatUnreadCount = count;

      const badge = document.getElementById('chat-badge-count');
      if (badge) {
        if (count > 0) {
          badge.textContent = count > 99 ? '99+' : count.toString();
          badge.classList.add('active');
        } else {
          badge.textContent = '0';
          badge.classList.remove('active');
        }
      }

      // iframeå†…ã®menu_home.htmlã®ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒƒã‚¸ã‚‚æ›´æ–°
      try {
        const iframe = document.getElementById('gas-iframe');
        if (iframe && iframe.contentDocument) {
          const menuBadge = iframe.contentDocument.getElementById('chat-menu-badge');
          if (menuBadge) {
            if (count > 0) {
              menuBadge.textContent = count > 99 ? '99+' : count.toString();
              menuBadge.classList.add('active');
              console.log('[Chat Badge] ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒƒã‚¸æ›´æ–°:', count);
            } else {
              menuBadge.textContent = '0';
              menuBadge.classList.remove('active');
            }
          }
        }
      } catch (e) {
        // ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ãŒç„¡è¦–
        console.log('[Chat Badge] iframeå†…ãƒãƒƒã‚¸æ›´æ–°ã‚¹ã‚­ãƒƒãƒ—:', e.message);
      }

      // ã‚¢ãƒ—ãƒªã‚¢ã‚¤ã‚³ãƒ³ãƒãƒƒã‚¸ã‚‚æ›´æ–°ï¼ˆãƒãƒ£ãƒƒãƒˆ + Todo ã®åˆè¨ˆï¼‰
      updateAppBadge();
    }

    // ==========================================
    // ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆæ©Ÿèƒ½
    // ==========================================
    let todoUnreadCount = 0;

    // ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆã‚’é–‹ã
    function openTodoList() {
      console.log('[Todo] ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆã‚’é–‹ã');

      const userName = localStorage.getItem('reborn_user_name') || '';
      const userEmail = localStorage.getItem('reborn_user_email') || '';
      const sessionId = sessionStorage.getItem('device_session_id');

      // pmTokenç”Ÿæˆ
      const pmToken = generatePmToken();
      localStorage.setItem('pm_token', pmToken);

      const params = new URLSearchParams({
        app: 'pwa',
        userName: userName,
        userEmail: userEmail,
        parentOrigin: window.location.origin,
        pmToken: pmToken,
        sessionId: sessionId
      });

      const iframe = document.getElementById('gas-iframe');
      iframe.src = `/todo_list.html?v=20251130a&${params.toString()}`;
    }

    // ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆãƒãƒƒã‚¸æ›´æ–°
    function updateTodoBadge(count) {
      console.log('[Todo Badge] ãƒãƒƒã‚¸æ›´æ–°:', count);
      todoUnreadCount = count;

      const badge = document.getElementById('todo-badge-count');
      if (badge) {
        if (count > 0) {
          badge.textContent = count > 99 ? '99+' : count.toString();
          badge.classList.add('active');
        } else {
          badge.textContent = '0';
          badge.classList.remove('active');
        }
      }

      // ã‚¢ãƒ—ãƒªã‚¢ã‚¤ã‚³ãƒ³ãƒãƒƒã‚¸ã‚‚æ›´æ–°ï¼ˆãƒãƒ£ãƒƒãƒˆ + Todo ã®åˆè¨ˆï¼‰
      updateAppBadge();
    }

    // ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã‚’é–‹å§‹
    async function startTodoListener() {
      const userEmail = localStorage.getItem('reborn_user_email');
      if (!userEmail) {
        console.warn('[Todo] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      try {
        const db = await getFirebaseDb();
        const { collection, query, where, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        // æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
        const tasksRef = collection(db, 'userTasks', userEmail, 'tasks');
        const q = query(tasksRef, where('completed', '==', false));

        onSnapshot(q, (snapshot) => {
          const count = snapshot.size;
          console.log('[Todo] æœªå®Œäº†ã‚¿ã‚¹ã‚¯æ•°:', count);
          updateTodoBadge(count);
        }, (error) => {
          console.error('[Todo] ãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
        });

        console.log('[Todo] ãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²å®Œäº†');
      } catch (error) {
        console.error('[Todo] ãƒªã‚¹ãƒŠãƒ¼é–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // æ‰¿èªå¾…ã¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çŠ¶æ…‹ç›£è¦–ãƒªã‚¹ãƒŠãƒ¼
    let pendingApprovalUnsubscribe = null;

    async function startPendingApprovalListener(email, displayName, photoURL, firebaseUid) {
      console.log('[PendingApproval] ãƒªã‚¹ãƒŠãƒ¼é–‹å§‹:', email);

      try {
        const db = await getFirebaseDb();
        const { doc, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        const userDocRef = doc(db, 'users', email);

        // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ãŒã‚ã‚Œã°è§£é™¤
        if (pendingApprovalUnsubscribe) {
          pendingApprovalUnsubscribe();
        }

        pendingApprovalUnsubscribe = onSnapshot(userDocRef, (docSnapshot) => {
          if (!docSnapshot.exists()) {
            // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚ŒãŸ = å´ä¸‹ã•ã‚ŒãŸ
            console.log('[PendingApproval] âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼ˆå´ä¸‹ï¼‰');

            document.getElementById('pending-icon').textContent = 'âŒ';
            document.getElementById('pending-icon').classList.remove('pending-animation');
            document.getElementById('pending-title').textContent = 'æ‰¿èªã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ';
            document.getElementById('pending-title').style.color = '#dc2626';
            document.getElementById('pending-message').innerHTML = 'ç®¡ç†è€…ã«ã‚ˆã‚Šå´ä¸‹ã•ã‚Œã¾ã—ãŸã€‚<br>åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãŠè©¦ã—ãã ã•ã„ã€‚';
            document.getElementById('pending-status').style.display = 'none';
            document.getElementById('pending-retry-btn').style.display = 'none';

            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            const logoutBtn = document.createElement('button');
            logoutBtn.textContent = 'åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³';
            logoutBtn.style.cssText = 'margin-top: 20px; padding: 12px 24px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;';
            logoutBtn.onclick = () => location.reload();
            document.getElementById('pending-message').appendChild(logoutBtn);

            // ãƒªã‚¹ãƒŠãƒ¼è§£é™¤
            if (pendingApprovalUnsubscribe) {
              pendingApprovalUnsubscribe();
              pendingApprovalUnsubscribe = null;
            }
            return;
          }

          const userData = docSnapshot.data();
          const status = userData.status;
          console.log('[PendingApproval] ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´æ¤œçŸ¥:', status);

          if (status === 'active') {
            // æ‰¿èªã•ã‚ŒãŸï¼
            console.log('[PendingApproval] âœ… æ‰¿èªã•ã‚Œã¾ã—ãŸï¼');

            // UIã‚’æ›´æ–°ï¼ˆæ‰¿èªå®Œäº†è¡¨ç¤º + æ¬¡ã¸ãƒœã‚¿ãƒ³ï¼‰
            document.getElementById('pending-icon').textContent = 'âœ…';
            document.getElementById('pending-icon').classList.add('approval-success');
            document.getElementById('pending-title').textContent = 'æ‰¿èªã•ã‚Œã¾ã—ãŸï¼';
            document.getElementById('pending-title').style.color = '#059669';
            document.getElementById('pending-status').style.display = 'none';
            document.getElementById('pending-retry-btn').style.display = 'none';

            // ğŸ”§ ä¿®æ­£: è‡ªå‹•é·ç§»ã§ã¯ãªãã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ç¢ºä¿ï¼‰
            document.getElementById('pending-message').innerHTML = `
              <div style="margin-top: 16px;">
                <p style="margin-bottom: 16px;">æ¬¡ã«é€šçŸ¥è¨­å®šã‚’è¡Œã„ã¾ã™</p>
                <button onclick="proceedToNotificationAfterApproval('${email}', '${photoURL || ''}', '${firebaseUid}')"
                        style="width: 100%; padding: 14px; background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
                  æ¬¡ã¸ï¼ˆé€šçŸ¥è¨­å®šï¼‰
                </button>
              </div>
            `;

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«userDataã‚’ä¿å­˜ï¼ˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ä½¿ç”¨ï¼‰
            window._pendingApprovalUserData = userData;

            // ãƒªã‚¹ãƒŠãƒ¼è§£é™¤
            if (pendingApprovalUnsubscribe) {
              pendingApprovalUnsubscribe();
              pendingApprovalUnsubscribe = null;
            }

          } else if (status === 'inactive') {
            // å´ä¸‹ã•ã‚ŒãŸ
            console.log('[PendingApproval] âŒ å´ä¸‹ã•ã‚Œã¾ã—ãŸ');

            document.getElementById('pending-icon').textContent = 'âŒ';
            document.getElementById('pending-title').textContent = 'æ‰¿èªã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ';
            document.getElementById('pending-title').style.color = '#dc2626';
            document.getElementById('pending-message').innerHTML = 'ç®¡ç†è€…ã«ã‚ˆã‚Šå´ä¸‹ã•ã‚Œã¾ã—ãŸã€‚<br>åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãŠè©¦ã—ãã ã•ã„ã€‚';
            document.getElementById('pending-status').style.display = 'none';

            // ãƒªã‚¹ãƒŠãƒ¼è§£é™¤
            if (pendingApprovalUnsubscribe) {
              pendingApprovalUnsubscribe();
              pendingApprovalUnsubscribe = null;
            }
          }
        }, (error) => {
          console.error('[PendingApproval] ãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
          document.getElementById('pending-status').innerHTML = 'âš ï¸ æ¥ç¶šã‚¨ãƒ©ãƒ¼ - ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„';
        });

        console.log('[PendingApproval] ãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²å®Œäº†');
      } catch (error) {
        console.error('[PendingApproval] ãƒªã‚¹ãƒŠãƒ¼é–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // æ‰¿èªå¾Œã®ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†å‡¦ç†
    async function completeLoginAfterApproval(userData, email, photoURL, firebaseUid) {
      console.log('[PendingApproval] ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†å‡¦ç†é–‹å§‹');

      const userName = userData.userName || userData.name || email.split('@')[0];
      const permissionId = userData.permissionId || 'staff';

      // localStorageã«ä¿å­˜
      localStorage.setItem('reborn_user_name', userName);
      localStorage.setItem('reborn_user_email', email);
      localStorage.setItem('reborn_user_permission_id', permissionId);
      localStorage.setItem('reborn_user_permission_display', getPermissionDisplayName(permissionId));
      localStorage.setItem('reborn_user_photo_url', photoURL || '');
      localStorage.setItem('reborn_firebase_uid', firebaseUid);

      if (userData.userIconUrl) {
        localStorage.setItem('reborn_user_icon_url', userData.userIconUrl);
      } else if (photoURL) {
        localStorage.setItem('reborn_user_icon_url', photoURL);
      }

      // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
      loadUserIcon();

      // IndexedDBã«ã‚‚ä¿å­˜
      try {
        const request = indexedDB.open('RebornUserDB', 1);
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('user')) {
            db.createObjectStore('user');
          }
        };
        request.onsuccess = () => {
          const db = request.result;
          const transaction = db.transaction(['user'], 'readwrite');
          const store = transaction.objectStore('user');
          store.put(userName, 'userName');
        };
      } catch (e) {
        console.warn('[PendingApproval] IndexedDBä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
      }

      // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDç”Ÿæˆ
      const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      sessionStorage.setItem('device_session_id', sessionId);

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°æ›´æ–°
      window.userName = userName;
      window.userEmail = email;

      // ğŸ”§ ä¿®æ­£: ã‚¢ãƒ—ãƒªç”»é¢ã«ç›´æ¥é·ç§»ã›ãšã€é€šçŸ¥è¨­å®šç”»é¢ã‚’è¡¨ç¤º
      // ï¼ˆé€šçŸ¥è¨±å¯ã‚’å–å¾—ã—ãªã„ã¨iOSè¨­å®šã«ã‚¢ãƒ—ãƒªãŒè¡¨ç¤ºã•ã‚Œãªã„ï¼‰
      console.log('[PendingApproval] âœ… æ‰¿èªå®Œäº† â†’ é€šçŸ¥è¨­å®šç”»é¢ã¸');

      // æ‰¿èªå¾…ã¡ç”»é¢ã‚’éè¡¨ç¤º
      document.getElementById('pending-approval-section').style.display = 'none';

      // é€šçŸ¥è¨­å®šç”»é¢ã‚’è¡¨ç¤º
      showNotificationScreen();
    }

    // ğŸ”§ æ‰¿èªå¾Œã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ç¢ºä¿ï¼‰
    window.proceedToNotificationAfterApproval = function(email, photoURL, firebaseUid) {
      console.log('[PendingApproval] æ¬¡ã¸ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ â†’ é€šçŸ¥è¨­å®šç”»é¢ã¸');

      // ä¿å­˜ã•ã‚ŒãŸuserDataã‚’å–å¾—
      const userData = window._pendingApprovalUserData || {};

      // completeLoginAfterApprovalã¨åŒã˜å‡¦ç†ã‚’å®Ÿè¡Œ
      const userName = userData.userName || userData.name || email.split('@')[0];
      const permissionId = userData.permissionId || 'staff';

      // localStorageã«ä¿å­˜
      localStorage.setItem('reborn_user_name', userName);
      localStorage.setItem('reborn_user_email', email);
      localStorage.setItem('reborn_user_permission_id', permissionId);
      localStorage.setItem('reborn_user_permission_display', getPermissionDisplayName(permissionId));
      localStorage.setItem('reborn_user_photo_url', photoURL || '');
      localStorage.setItem('reborn_firebase_uid', firebaseUid);

      if (userData.userIconUrl) {
        localStorage.setItem('reborn_user_icon_url', userData.userIconUrl);
      } else if (photoURL) {
        localStorage.setItem('reborn_user_icon_url', photoURL);
      }

      // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
      loadUserIcon();

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°æ›´æ–°
      window.userName = userName;
      window.userEmail = email;

      // æ‰¿èªå¾…ã¡ç”»é¢ã‚’éè¡¨ç¤º
      document.getElementById('pending-approval-section').style.display = 'none';

      // é€šçŸ¥è¨­å®šç”»é¢ã‚’è¡¨ç¤º
      showNotificationScreen();
    };

    // æ‰¿èªå¾…ã¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ã®è‡ªå‹•FCMç™»éŒ²
    async function autoRegisterFCMForPendingUser(email) {
      console.log('[AutoFCM] è‡ªå‹•FCMç™»éŒ²é–‹å§‹:', email);

      // FCMéã‚µãƒãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆSafariç­‰ï¼‰ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
      if (!window.firebaseMessaging) {
        console.log('[AutoFCM] FCMéã‚µãƒãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¶ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
        return;
      }

      // Service Workerç¢ºèª
      if (!swRegistration) {
        console.log('[AutoFCM] Service Workeræœªç™»éŒ²ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
        return;
      }

      try {
        // é€šçŸ¥è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        const permission = await Notification.requestPermission();
        console.log('[AutoFCM] é€šçŸ¥è¨±å¯çµæœ:', permission);

        if (permission !== 'granted') {
          console.log('[AutoFCM] é€šçŸ¥ãŒè¨±å¯ã•ã‚Œãªã‹ã£ãŸãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
          return;
        }

        // FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
        const { getToken } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js');
        const currentToken = await getToken(window.firebaseMessaging, {
          vapidKey: VAPID_PUBLIC_KEY,
          serviceWorkerRegistration: swRegistration
        });

        if (!currentToken) {
          console.log('[AutoFCM] FCMãƒˆãƒ¼ã‚¯ãƒ³å–å¾—å¤±æ•—');
          return;
        }

        console.log('[AutoFCM] FCMãƒˆãƒ¼ã‚¯ãƒ³å–å¾—æˆåŠŸ:', currentToken.substring(0, 20) + '...');

        // localStorageã«ä¿å­˜
        localStorage.setItem('reborn_fcm_token', currentToken);

        // Firestoreã®usersãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
        const db = await getFirebaseDb();
        const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const userDocRef = doc(db, 'users', email);
        await updateDoc(userDocRef, {
          fcmToken: currentToken,
          fcmUpdatedAt: new Date().toISOString()
        });

        console.log('[AutoFCM] âœ… FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’Firestoreã«ä¿å­˜å®Œäº†');
      } catch (error) {
        console.error('[AutoFCM] ã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼ã§ã‚‚å‡¦ç†ã¯ç¶šè¡Œï¼ˆæ‰¿èªå¾…ã¡ç”»é¢ã¯è¡¨ç¤ºã•ã‚ŒãŸã¾ã¾ï¼‰
      }
    }

    // ç®¡ç†è€…ã«ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ï¼ˆæ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªå¾…ã¡ç­‰ï¼‰
    async function addTaskToOwners(taskData) {
      try {
        const db = await getFirebaseDb();
        const { collection, query, where, getDocs, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        // ç®¡ç†è€…ã‚’å–å¾—
        const usersRef = collection(db, 'users');
        const ownersQuery = query(usersRef, where('permissionId', '==', 'owner'));
        const ownersSnapshot = await getDocs(ownersQuery);

        if (ownersSnapshot.empty) {
          console.warn('[Todo] ç®¡ç†è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        // å„ç®¡ç†è€…ã«ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
        for (const ownerDoc of ownersSnapshot.docs) {
          const ownerEmail = ownerDoc.data().userEmail;
          const tasksRef = collection(db, 'userTasks', ownerEmail, 'tasks');

          await addDoc(tasksRef, {
            ...taskData,
            createdAt: serverTimestamp(),
            completed: false,
            read: false
          });

          console.log('[Todo] ã‚¿ã‚¹ã‚¯è¿½åŠ å®Œäº†:', ownerEmail, taskData.type);
        }
      } catch (error) {
        console.error('[Todo] ã‚¿ã‚¹ã‚¯è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ç®¡ç†è€…ã«ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’é€ä¿¡ï¼ˆè‡ªå·±ä¿®å¾©å‹ï¼‰
    async function sendPushToOwners(notification) {
      const debugInfo = { step: '', details: [] };
      try {
        console.log('[Push] === sendPushToOwnersé–‹å§‹ ===');
        debugInfo.step = 'åˆæœŸåŒ–';
        
        const db = await getFirebaseDb();
        const { collection, query, where, getDocs, deleteDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        // Step 1: usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ç®¡ç†è€…ã‚’å–å¾—
        debugInfo.step = 'Step1: ç®¡ç†è€…æ¤œç´¢';
        const usersRef = collection(db, 'users');
        const ownersQuery = query(usersRef, where('permissionId', '==', 'owner'));
        const ownersSnapshot = await getDocs(ownersQuery);

        if (ownersSnapshot.empty) {
          debugInfo.details.push('âŒ ç®¡ç†è€…0äºº');
          return { success: false, reason: 'ç®¡ç†è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', debug: debugInfo };
        }

        debugInfo.details.push(`âœ… ç®¡ç†è€…${ownersSnapshot.size}äººç™ºè¦‹`);

        // Step 2: ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’åé›†ï¼ˆå‰Šé™¤ç”¨ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§ã‚‚ä¿æŒï¼‰
        debugInfo.step = 'Step2: ãƒ‡ãƒã‚¤ã‚¹æ¤œç´¢';
        const tokenInfoList = []; // { token, ownerEmail, deviceDocRef }
        
        for (const ownerDoc of ownersSnapshot.docs) {
          const ownerEmail = ownerDoc.data().userEmail;
          const devicesRef = collection(db, 'users', ownerEmail, 'devices');
          const activeDevicesQuery = query(devicesRef, where('active', '==', true));
          const devicesSnapshot = await getDocs(activeDevicesQuery);

          debugInfo.details.push(`${ownerEmail}: active=${devicesSnapshot.size}ä»¶`);

          devicesSnapshot.forEach((deviceDoc) => {
            const deviceData = deviceDoc.data();
            if (deviceData.fcmToken) {
              tokenInfoList.push({
                token: deviceData.fcmToken,
                ownerEmail: ownerEmail,
                deviceDocRef: deviceDoc.ref
              });
            }
          });
        }

        if (tokenInfoList.length === 0) {
          debugInfo.details.push('âŒ FCMãƒˆãƒ¼ã‚¯ãƒ³0ä»¶');
          return { success: false, reason: 'FCMãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“', debug: debugInfo };
        }

        debugInfo.step = 'Step3: Workeré€ä¿¡';
        debugInfo.details.push(`âœ… ãƒˆãƒ¼ã‚¯ãƒ³${tokenInfoList.length}ä»¶ã§é€ä¿¡`);

        // Cloudflare WorkerçµŒç”±ã§ãƒ—ãƒƒã‚·ãƒ¥é€ä¿¡
        const tokens = tokenInfoList.map(t => t.token);
        const response = await fetch('https://reborn-fcm-worker.mercari-yasuhirotakuji.workers.dev/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tokens: tokens,
            title: notification.title,
            body: notification.body,
            data: notification.data || {}
          })
        });

        const responseText = await response.text();
        let workerResult;
        try {
          workerResult = JSON.parse(responseText);
        } catch (e) {
          workerResult = { raw: responseText };
        }

        debugInfo.details.push(`Workerå¿œç­”: ${response.status}`);
        debugInfo.details.push(`é€ä¿¡æˆåŠŸ: ${workerResult.sent || 0}ä»¶`);
        debugInfo.details.push(`é€ä¿¡å¤±æ•—: ${workerResult.failed || 0}ä»¶`);

        // ğŸ”§ è‡ªå·±ä¿®å¾©: FCMã‚¨ãƒ©ãƒ¼ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è‡ªå‹•å‰Šé™¤
        if (workerResult.errors && workerResult.errors.length > 0) {
          debugInfo.step = 'Step4: ç„¡åŠ¹ãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤';
          for (const err of workerResult.errors) {
            debugInfo.details.push(`âŒ FCMã‚¨ãƒ©ãƒ¼: ${err.error}`);
            
            // ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹ã‚¨ãƒ©ãƒ¼ã®å ´åˆã®ã¿ã€è©²å½“ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤
            // "invalid value" ãªã©ã®ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼ã¯é™¤å¤–
            const errorLower = (err.error || '').toLowerCase();
            const isTokenError = (errorLower.includes('not found') || errorLower.includes('unregistered')) 
                                 && !errorLower.includes('invalid value');
            if (isTokenError) {
              // ãƒˆãƒ¼ã‚¯ãƒ³ã®å…ˆé ­éƒ¨åˆ†ã§ãƒãƒƒãƒãƒ³ã‚°ï¼ˆWorkerã¯å…ˆé ­20æ–‡å­—ã‚’è¿”ã™ï¼‰
              const tokenPrefix = err.token?.replace('...', '') || '';
              const matchedTokenInfo = tokenInfoList.find(t => t.token.startsWith(tokenPrefix));
              
              if (matchedTokenInfo) {
                try {
                  await deleteDoc(matchedTokenInfo.deviceDocRef);
                  debugInfo.details.push(`ğŸ—‘ï¸ ç„¡åŠ¹ãƒ‡ãƒã‚¤ã‚¹å‰Šé™¤: ${matchedTokenInfo.ownerEmail}`);
                  console.log('[Push] ğŸ—‘ï¸ ç„¡åŠ¹ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’å‰Šé™¤:', matchedTokenInfo.ownerEmail);
                } catch (delErr) {
                  console.warn('[Push] ãƒ‡ãƒã‚¤ã‚¹å‰Šé™¤å¤±æ•—:', delErr);
                }
              }
            }
          }
        }

        if (workerResult.results && workerResult.results.length > 0) {
          workerResult.results.forEach((res, i) => {
            debugInfo.details.push(`âœ… FCMæˆåŠŸ: ${res.messageId || 'OK'}`);
          });
        }

        if (!response.ok) {
          return { success: false, reason: `Workerå¤±æ•—: ${response.status}`, debug: debugInfo };
        }

        if (workerResult.failed > 0 && workerResult.sent === 0) {
          return { success: false, reason: `FCMé€ä¿¡å¤±æ•—: ${workerResult.failed}ä»¶ï¼ˆç„¡åŠ¹ãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤æ¸ˆã¿ï¼‰`, debug: debugInfo };
        }

        console.log('[Push] âœ… ãƒ—ãƒƒã‚·ãƒ¥é€ä¿¡å®Œäº†');
        return { success: true, tokenCount: tokenInfoList.length, debug: debugInfo };
      } catch (error) {
        debugInfo.details.push(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        console.error('[Push] âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        return { success: false, reason: error.message, debug: debugInfo };
      }
    }

    // ç®¡ç†è€…ã«ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆResendçµŒç”±ï¼‰
    async function sendEmailToOwners(emailData) {
      try {
        const db = await getFirebaseDb();
        const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        // ç®¡ç†è€…ã‚’å–å¾—
        const usersRef = collection(db, 'users');
        const ownersQuery = query(usersRef, where('permissionId', '==', 'owner'));
        const ownersSnapshot = await getDocs(ownersQuery);

        if (ownersSnapshot.empty) {
          console.warn('[Email] ç®¡ç†è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        // å„ç®¡ç†è€…ã«ãƒ¡ãƒ¼ãƒ«é€ä¿¡
        for (const ownerDoc of ownersSnapshot.docs) {
          const ownerEmail = ownerDoc.data().userEmail;
          console.log('[Email] ç®¡ç†è€…ã«ãƒ¡ãƒ¼ãƒ«é€ä¿¡:', ownerEmail);

          const response = await fetch('https://reborn-fcm-worker.mercari-yasuhirotakuji.workers.dev/send-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              to: ownerEmail,
              subject: emailData.subject,
              body: emailData.body
            })
          });

          if (!response.ok) {
            const errorText = await response.text();
            console.error('[Email] é€ä¿¡å¤±æ•—:', ownerEmail, errorText);
          } else {
            console.log('[Email] é€ä¿¡æˆåŠŸ:', ownerEmail);
          }
        }
      } catch (error) {
        console.error('[Email] é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒãƒ£ãƒƒãƒˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ï¼ˆç®¡ç†è€…ã®ã¿ã«è¡¨ç¤ºï¼‰
    async function sendSystemChatMessage(message) {
      try {
        console.log('[SystemChat] === sendSystemChatMessageé–‹å§‹ ===');
        console.log('[SystemChat] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', message.substring(0, 50) + '...');
        const db = await getFirebaseDb();
        const { collection, doc, addDoc, setDoc, getDocs, query, where, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        const systemRoomId = 'system-notifications';
        console.log('[SystemChat] roomId:', systemRoomId);

        // ç®¡ç†è€…ï¼ˆownerï¼‰ã®ãƒªã‚¹ãƒˆã‚’å–å¾—
        const usersRef = collection(db, 'users');
        const ownersQuery = query(usersRef, where('permissionId', '==', 'owner'));
        const ownersSnapshot = await getDocs(ownersQuery);

        const ownerEmails = [];
        const ownerNames = [];
        ownersSnapshot.forEach(doc => {
          const data = doc.data();
          ownerEmails.push(doc.id); // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID = ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
          if (data.userName) {
            ownerNames.push(data.userName);
          }
        });
        console.log('[SystemChat] ç®¡ç†è€…:', ownerEmails.length, 'å');

        // ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
        const messagesRef = collection(db, 'rooms', systemRoomId, 'messages');
        const messageDoc = await addDoc(messagesRef, {
          text: message,
          userName: 'ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥',  // chat_ui_firestoreã¨çµ±ä¸€ï¼ˆsenderNameã§ã¯ãªãuserNameï¼‰
          userEmail: 'system@furira.jp',
          timestamp: serverTimestamp(),
          type: 'system'
        });
        console.log('[SystemChat] âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ å®Œäº†:', messageDoc.id);

        // ãƒ«ãƒ¼ãƒ ã®lastMessageã¨lastMessageAtã‚’æ›´æ–°ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆï¼‰
        // ç®¡ç†è€…ã‚’ãƒ¡ãƒ³ãƒãƒ¼ã«è¿½åŠ ã—ã¦ãƒãƒ£ãƒƒãƒˆä¸€è¦§ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
        const roomRef = doc(db, 'rooms', systemRoomId);
        await setDoc(roomRef, {
          name: 'ğŸ‘‘ ç®¡ç†è€…é€šçŸ¥',
          type: 'system',
          lastMessage: message.substring(0, 50) + (message.length > 50 ? '...' : ''),
          lastMessageAt: serverTimestamp(),  // chat_rooms_listã®orderByã§ä½¿ç”¨
          updatedAt: serverTimestamp(),
          memberEmails: ownerEmails,  // ç®¡ç†è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆã‚¯ã‚¨ãƒªç”¨ï¼‰
          members: ownerNames         // ç®¡ç†è€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆã‚¯ã‚¨ãƒªç”¨ï¼‰
        }, { merge: true });
        console.log('[SystemChat] âœ… ãƒ«ãƒ¼ãƒ æ›´æ–°å®Œäº†ï¼ˆç®¡ç†è€…ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ ï¼‰');

        console.log('[SystemChat] === sendSystemChatMessageå®Œäº† ===');
      } catch (error) {
        console.error('[SystemChat] âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        console.error('[SystemChat] ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.message, error.stack);
      }
    }

    // ğŸ”§ Firebaseå…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆã‚¢ãƒ—ãƒªé‡è¤‡åˆæœŸåŒ–é˜²æ­¢ï¼‰
    let _firebaseApp, _firestoreDb;
    async function getFirebaseDb() {
      if (_firestoreDb) return _firestoreDb;

      const { initializeApp, getApps } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
      const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

      const firebaseConfig = {
        apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
        authDomain: "furira.jp",
        projectId: "reborn-chat",
        storageBucket: "reborn-chat.firebasestorage.app",
        messagingSenderId: "345706548795",
        appId: "1:345706548795:web:058a553da6b4b74db5161e"
      };

      _firebaseApp = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
      _firestoreDb = getFirestore(_firebaseApp);
      console.log('[Firebase] å…±é€šã‚¢ãƒ—ãƒªåˆæœŸåŒ–å®Œäº†');
      return _firestoreDb;
    }

    // ========================================
    // ğŸ”„ ãƒ‡ãƒã‚¤ã‚¹è‡ªå‹•åŒæœŸæ©Ÿèƒ½ï¼ˆã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ï¼‰
    // FCMãƒˆãƒ¼ã‚¯ãƒ³ã®è‡ªå‹•æ›´æ–°ã¨ lastUsedAt ã®æ›´æ–°
    // ========================================
    async function refreshDeviceRegistration() {
      console.log('[Device] ğŸ”„ ãƒ‡ãƒã‚¤ã‚¹åŒæœŸãƒã‚§ãƒƒã‚¯é–‹å§‹');

      try {
        const userEmail = localStorage.getItem('reborn_user_email');
        const userName = localStorage.getItem('reborn_user_name');
        const storedToken = localStorage.getItem('reborn_fcm_token');

        if (!userEmail || !userName) {
          console.log('[Device] ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãªã— - ã‚¹ã‚­ãƒƒãƒ—');
          return;
        }

        // Firebase SDKã‚’å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        const { initializeApp, getApps } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
        const { getFirestore, collection, query, where, getDocs, updateDoc, deleteDoc, addDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const { getMessaging, getToken } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js');

        const firebaseConfig = {
          apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
          authDomain: "reborn-chat.firebaseapp.com",
          projectId: "reborn-chat",
          storageBucket: "reborn-chat.firebasestorage.app",
          messagingSenderId: "345706548795",
          appId: "1:345706548795:web:058a553da6b4b74db5161e"
        };

        const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Firebase Auth ã®èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèª
        const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
        const auth = getAuth(app);
        const currentUser = auth.currentUser;

        // ç¾åœ¨ã®FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ï¼ˆèªè¨¼æ¸ˆã¿ã®å ´åˆã®ã¿ï¼‰
        // å¸¸ã«æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å¼·åˆ¶å–å¾—ï¼ˆå¤ã„ãƒˆãƒ¼ã‚¯ãƒ³å•é¡Œã‚’é˜²æ­¢ï¼‰
        let currentToken = null;
        if (currentUser) {
          try {
            const messaging = getMessaging(app);
            const vapidKey = 'BIiPYM_7rWJYqJl3sCQI9RGQsblY8eQTsZGz9rKRgAx2gKLk8jz1cT4tR8U5WvMqkHHHGrVnLv1QdqJ7rNvHtfY';
            
            // å¤ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤ã—ã¦æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å¼·åˆ¶å–å¾—
            const { deleteToken } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js');
            try {
              await deleteToken(messaging);
              console.log('[Device] å¤ã„FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤');
            } catch (delErr) {
              // å‰Šé™¤å¤±æ•—ã¯ç„¡è¦–ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„å ´åˆãªã©ï¼‰
              console.log('[Device] ãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤ã‚¹ã‚­ãƒƒãƒ—:', delErr.message);
            }
            
            // æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
            currentToken = await getToken(messaging, { vapidKey });
            console.log('[Device] âœ… æ–°ã—ã„FCMãƒˆãƒ¼ã‚¯ãƒ³å–å¾—:', currentToken ? currentToken.substring(0, 20) + '...' : 'ãªã—');

            if (currentToken) {
              localStorage.setItem('reborn_fcm_token', currentToken);
            }
          } catch (tokenError) {
            console.log('[Device] FCMãƒˆãƒ¼ã‚¯ãƒ³å–å¾—å¤±æ•—:', tokenError.message);
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ä¿å­˜æ¸ˆã¿ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨
            currentToken = storedToken;
          }
        } else {
          console.log('[Device] èªè¨¼å¾…ã¡ - æ—¢å­˜ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨');
          currentToken = storedToken;
        }

        if (!currentToken) {
          console.log('[Device] FCMãƒˆãƒ¼ã‚¯ãƒ³ãªã— - ã‚¹ã‚­ãƒƒãƒ—');
          return;
        }

        // ãƒ‡ãƒã‚¤ã‚¹ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¤œç´¢
        const devicesRef = collection(db, 'users', userEmail, 'devices');
        const devicesSnapshot = await getDocs(devicesRef);

        let deviceFound = false;
        const now = new Date();
        const STALE_THRESHOLD_DAYS = 30;

        for (const deviceDoc of devicesSnapshot.docs) {
          const deviceData = deviceDoc.data();

          // åŒã˜ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’æ›´æ–°
          if (deviceData.fcmToken === currentToken) {
            await updateDoc(deviceDoc.ref, {
              lastUsedAt: now,
              active: true,
              userName: userName // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚‚æ›´æ–°
            });
            console.log('[Device] âœ… ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±æ›´æ–°:', deviceDoc.id);
            deviceFound = true;
          }

          // å¤ã„ãƒ‡ãƒã‚¤ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          if (deviceData.lastUsedAt) {
            const lastUsed = deviceData.lastUsedAt.toDate ? deviceData.lastUsedAt.toDate() : new Date(deviceData.lastUsedAt);
            const daysSinceLastUsed = (now - lastUsed) / (1000 * 60 * 60 * 24);
            if (daysSinceLastUsed > STALE_THRESHOLD_DAYS && deviceData.fcmToken !== currentToken) {
              try {
                await deleteDoc(deviceDoc.ref);
                console.log('[Device] ğŸ—‘ï¸ å¤ã„ãƒ‡ãƒã‚¤ã‚¹å‰Šé™¤:', deviceDoc.id);
              } catch (e) {
                console.warn('[Device] ãƒ‡ãƒã‚¤ã‚¹å‰Šé™¤å¤±æ•—:', e);
              }
            }
          }
        }

        if (!deviceFound) {
          console.log('[Device] âš ï¸ ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã¯æœªç™»éŒ² - è‡ªå‹•ç™»éŒ²ã‚’å®Ÿè¡Œ');
          
          // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’åé›†
          const deviceInfo = {
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            language: navigator.language,
            screenWidth: screen.width,
            screenHeight: screen.height
          };
          
          // æ–°è¦ãƒ‡ãƒã‚¤ã‚¹ã‚’ç™»éŒ²
          const devicesRef = collection(db, 'users', userEmail, 'devices');
          const newDeviceData = {
            fcmToken: currentToken,
            deviceInfo: deviceInfo,
            active: true,
            userName: userName,
            userEmail: userEmail,
            registeredAt: new Date(),
            lastUsedAt: new Date()
          };
          
          try {
            const newDocRef = await addDoc(devicesRef, newDeviceData);
            console.log('[Device] âœ… æ–°è¦ãƒ‡ãƒã‚¤ã‚¹è‡ªå‹•ç™»éŒ²å®Œäº†:', newDocRef.id);
          } catch (addError) {
            console.error('[Device] âŒ ãƒ‡ãƒã‚¤ã‚¹ç™»éŒ²å¤±æ•—:', addError);
          }
        }

        console.log('[Device] âœ… ãƒ‡ãƒã‚¤ã‚¹åŒæœŸå®Œäº†');

      } catch (error) {
        console.error('[Device] ãƒ‡ãƒã‚¤ã‚¹åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«ãƒ‡ãƒã‚¤ã‚¹åŒæœŸã‚’å®Ÿè¡Œ
    window.refreshDeviceRegistration = refreshDeviceRegistration;

    // Firestoreæœªèª­ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚¹ãƒ‹ãƒ³ã‚°
    async function startChatUnreadListener() {
      console.log('[Chat FAB] æœªèª­ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚¹ãƒ‹ãƒ³ã‚°é–‹å§‹');

      try {
        const userName = localStorage.getItem('reborn_user_name');
        const userEmail = localStorage.getItem('reborn_user_email');
        if (!userName || !userEmail) {
          console.log('[Chat FAB] ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±æœªè¨­å®šã®ãŸã‚ãƒªã‚¹ãƒ‹ãƒ³ã‚°ä¸­æ–­');
          return;
        }

        // Firebase SDKã‚’å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
        const { getFirestore, collection, doc, query, where, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        // Firebaseè¨­å®šï¼ˆreborn-chat ã«çµ±ä¸€ï¼‰
        const firebaseConfig = {
          apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
          authDomain: "furira.jp",
          projectId: "reborn-chat",
          storageBucket: "reborn-chat.firebasestorage.app",
          messagingSenderId: "345706548795",
          appId: "1:345706548795:web:058a553da6b4b74db5161e"
        };

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig, 'chat-fab-app');
        const db = getFirestore(app);
        console.log('[Chat FAB] FirebaseåˆæœŸåŒ–å®Œäº†');

        // æœªèª­ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’åˆæœŸåŒ–
        if (!window.chatUnreadByRoom) window.chatUnreadByRoom = {};

        // æœªèª­ã‚«ã‚¦ãƒ³ãƒˆåˆè¨ˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateTotalUnread() {
          const totalUnread = Object.values(window.chatUnreadByRoom).reduce((sum, count) => sum + count, 0);
          console.log('[Chat FAB] æœªèª­ã‚«ã‚¦ãƒ³ãƒˆåˆè¨ˆ:', totalUnread, window.chatUnreadByRoom);
          updateChatBadge(totalUnread);
        }

        // ã€ãƒªã‚¹ãƒŠãƒ¼1ã€‘è‡ªåˆ†ãŒå‚åŠ ã—ã¦ã„ã‚‹é€šå¸¸ãƒ«ãƒ¼ãƒ ã‚’å–å¾—
        const roomsQuery = query(
          collection(db, 'rooms'),
          where('members', 'array-contains', userName)
        );

        onSnapshot(roomsQuery, (roomsSnapshot) => {
          console.log('[Chat FAB] é€šå¸¸ãƒ«ãƒ¼ãƒ æ•°:', roomsSnapshot.size);

          // å„ãƒ«ãƒ¼ãƒ ã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚’å–å¾—
          roomsSnapshot.forEach((roomDoc) => {
            const roomId = roomDoc.id;
            const unreadDocRef = doc(db, `rooms/${roomId}/unreadCounts/${userEmail}`);

            // å„ãƒ«ãƒ¼ãƒ ã®æœªèª­ã‚’ãƒªã‚¹ãƒ‹ãƒ³ã‚°
            onSnapshot(unreadDocRef, (unreadDoc) => {
              const unreadData = unreadDoc.data();
              const unreadCount = unreadData?.unreadCount || 0;

              // ã“ã®ãƒ«ãƒ¼ãƒ ã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚’è¨˜éŒ²
              window.chatUnreadByRoom[roomId] = unreadCount;
              console.log(`[Chat FAB] ${roomId} æœªèª­:`, unreadCount);

              // å…¨ãƒ«ãƒ¼ãƒ ã®æœªèª­ã‚’åˆè¨ˆã—ã¦æ›´æ–°
              updateTotalUnread();
            }, (error) => {
              console.error('[Chat FAB] ãƒ«ãƒ¼ãƒ ', roomId, 'ã®æœªèª­å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            });
          });
        }, (error) => {
          console.error('[Chat FAB] ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        });

        // ã€ãƒªã‚¹ãƒŠãƒ¼2ã€‘ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒ ï¼ˆå…¨ä½“ãƒ»ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆï¼‰ã‚’ç›´æ¥ãƒªã‚¹ãƒ‹ãƒ³ã‚°
        const defaultRoomIds = ['room_default_all', 'system', 'system-notifications', 'room_inventory_alert'];

        defaultRoomIds.forEach((roomId) => {
          const unreadDocRef = doc(db, `rooms/${roomId}/unreadCounts/${userEmail}`);

          onSnapshot(unreadDocRef, (unreadDoc) => {
            const unreadData = unreadDoc.data();
            const unreadCount = unreadData?.unreadCount || 0;

            // ã“ã®ãƒ«ãƒ¼ãƒ ã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚’è¨˜éŒ²
            window.chatUnreadByRoom[roomId] = unreadCount;
            console.log(`[Chat FAB] ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒ  ${roomId} æœªèª­:`, unreadCount);

            // å…¨ãƒ«ãƒ¼ãƒ ã®æœªèª­ã‚’åˆè¨ˆã—ã¦æ›´æ–°
            updateTotalUnread();
          }, (error) => {
            console.log(`[Chat FAB] ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒ  ${roomId} æœªèª­å–å¾—:`, error.message, '(ãƒ«ãƒ¼ãƒ æœªä½œæˆã®å¯èƒ½æ€§)');
          });
        });

      } catch (error) {
        console.error('[Chat FAB] åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ã®è‡ªå‹•ä½œæˆ
    async function initializeSystemNotificationRoom() {
      console.log('[System Room] ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ åˆæœŸåŒ–é–‹å§‹');

      try {
        // Firebase SDKã‚’å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
        const { getFirestore, doc, getDoc, setDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        // Firebaseè¨­å®šï¼ˆreborn-chat ã«çµ±ä¸€ï¼‰
        const firebaseConfig = {
          apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
          authDomain: "furira.jp",
          projectId: "reborn-chat",
          storageBucket: "reborn-chat.firebasestorage.app",
          messagingSenderId: "345706548795",
          appId: "1:345706548795:web:058a553da6b4b74db5161e"
        };

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig, 'system-room-init');
        const db = getFirestore(app);

        const systemRoomId = 'system';
        const systemRoomRef = doc(db, 'rooms', systemRoomId);

        // æ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
        const roomSnap = await getDoc(systemRoomRef);

        if (!roomSnap.exists()) {
          // ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ
          await setDoc(systemRoomRef, {
            roomId: systemRoomId,
            name: 'ğŸ“¢ ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥',
            type: 'system',
            icon: 'ğŸ“¢',
            members: [], // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
            createdBy: 'ã‚·ã‚¹ãƒ†ãƒ ',
            createdAt: serverTimestamp(),
            lastMessage: 'ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã—ãŸ',
            lastMessageAt: serverTimestamp(),
            lastMessageBy: 'ã‚·ã‚¹ãƒ†ãƒ '
          });

          console.log('[System Room] ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã—ãŸ');
        } else {
          // æ—¢å­˜ãƒ«ãƒ¼ãƒ ã«nameãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒç„¡ã„å ´åˆã¯è¿½åŠ ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
          const roomData = roomSnap.data();
          if (!roomData.name) {
            await setDoc(systemRoomRef, {
              name: 'ğŸ“¢ ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥',
              type: 'system',
              icon: 'ğŸ“¢'
            }, { merge: true });
            console.log('[System Room] ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ åã‚’æ›´æ–°ã—ã¾ã—ãŸ');
          } else {
            console.log('[System Room] ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');
          }
        }

      } catch (error) {
        console.error('[System Room] åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚’+1ã™ã‚‹é–¢æ•°
    async function incrementSystemNotificationUnreadCount() {
      console.log('[Badge] ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆ+1é–‹å§‹');

      const userName = localStorage.getItem('reborn_user_name');
      const userEmail = localStorage.getItem('reborn_user_email');
      if (!userName || !userEmail) {
        console.error('[Badge] ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“');
        return;
      }

      try {
        // å…±é€šFirebaseã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—ï¼ˆé‡è¤‡åˆæœŸåŒ–é˜²æ­¢ï¼‰
        const db = await getFirebaseDb();
        const { doc, setDoc, increment } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        const systemRoomId = 'system';
        const unreadDocRef = doc(db, `rooms/${systemRoomId}/unreadCounts/${userEmail}`);

        // Firestore unreadCountã‚’+1ï¼ˆã‚¢ãƒˆãƒŸãƒƒã‚¯æ“ä½œï¼‰
        await setDoc(unreadDocRef, {
          unreadCount: increment(1)
        }, { merge: true });

        console.log('[Badge] Firestore unreadCount +1 å®Œäº†');

      } catch (error) {
        console.error('[Badge] Firestoreæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã€Œå…¨ä½“ã€ãƒ«ãƒ¼ãƒ ã®è‡ªå‹•ä½œæˆï¼ˆå‰Šé™¤ã•ã‚Œã¦ã‚‚å†ä½œæˆï¼‰
    async function initializeDefaultRoom() {
      console.log('[Default Room] å…¨ä½“ãƒ«ãƒ¼ãƒ åˆæœŸåŒ–é–‹å§‹');

      try {
        // Firebase SDKã‚’å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
        const { getFirestore, doc, getDoc, setDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        // Firebaseè¨­å®šï¼ˆreborn-chat ã«çµ±ä¸€ï¼‰
        const firebaseConfig = {
          apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
          authDomain: "furira.jp",
          projectId: "reborn-chat",
          storageBucket: "reborn-chat.firebasestorage.app",
          messagingSenderId: "345706548795",
          appId: "1:345706548795:web:058a553da6b4b74db5161e"
        };

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig, 'default-room-init');
        const db = getFirestore(app);

        const defaultRoomId = 'room_default_all';
        const defaultRoomRef = doc(db, 'rooms', defaultRoomId);

        // æ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
        const roomSnap = await getDoc(defaultRoomRef);

        if (!roomSnap.exists()) {
          // å…¨ä½“ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ
          await setDoc(defaultRoomRef, {
            roomId: defaultRoomId,
            name: 'ğŸ’¬ å…¨ä½“',
            type: 'default',
            icon: 'ğŸ’¬',
            members: [], // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
            createdBy: 'ã‚·ã‚¹ãƒ†ãƒ ',
            createdAt: serverTimestamp(),
            lastMessage: 'å…¨ä½“ãƒ«ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã—ãŸ',
            lastMessageAt: serverTimestamp(),
            lastMessageBy: 'ã‚·ã‚¹ãƒ†ãƒ '
          });

          console.log('[Default Room] å…¨ä½“ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã—ãŸ');
        } else {
          console.log('[Default Room] å…¨ä½“ãƒ«ãƒ¼ãƒ ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');
        }

      } catch (error) {
        console.error('[Default Room] åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ğŸ—‘ï¸ postSystemNotificationé–¢æ•°ã¯å‰Šé™¤ï¼ˆFirebase Functions v2ã§å‡¦ç†ã€GASç‰ˆä¸ä½¿ç”¨ã®ãŸã‚ï¼‰
    // ä»¥å‰ã¯GASç‰ˆã§ä½¿ç”¨ã—ã¦ã„ãŸãŒã€ç¾åœ¨ã¯Firebase FunctionsãŒå…¨ã¦å‡¦ç†

    // ğŸŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ«ãƒ¼ãƒ ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è‡ªå‹•è¿½åŠ ã™ã‚‹é–¢æ•°
    // room_default_all, room_inventory_alert, system ã®3ã¤ã®ãƒ«ãƒ¼ãƒ ã«å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ 
    async function addCurrentUserToGlobalRooms() {
      console.log('[Global Rooms] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ«ãƒ¼ãƒ ã«è¿½åŠ é–‹å§‹');

      const userName = localStorage.getItem('reborn_user_name');
      const userEmail = localStorage.getItem('reborn_user_email');

      if (!userName || !userEmail) {
        console.log('[Global Rooms] ãƒ¦ãƒ¼ã‚¶ãƒ¼æœªãƒ­ã‚°ã‚¤ãƒ³ - ã‚¹ã‚­ãƒƒãƒ—');
        return;
      }

      try {
        // Firebase SDKã‚’å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        const { initializeApp, getApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
        const { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        // Firebaseè¨­å®šï¼ˆreborn-chat ã«çµ±ä¸€ï¼‰
        const firebaseConfig = {
          apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
          authDomain: "furira.jp",
          projectId: "reborn-chat",
          storageBucket: "reborn-chat.firebasestorage.app",
          messagingSenderId: "345706548795",
          appId: "1:345706548795:web:058a553da6b4b74db5161e"
        };

        // FirebaseåˆæœŸåŒ–ï¼ˆæ—¢å­˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ç”¨ï¼‰
        let app;
        try {
          app = getApp('global-rooms-init');
        } catch {
          app = initializeApp(firebaseConfig, 'global-rooms-init');
        }
        const db = getFirestore(app);

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ«ãƒ¼ãƒ ã®å®šç¾©
        const globalRooms = [
          {
            id: 'room_default_all',
            name: 'ğŸ’¬ å…¨ä½“',
            type: 'default',
            icon: 'ğŸ’¬',
            defaultMessage: 'å…¨ä½“ãƒ«ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã—ãŸ'
          },
          {
            id: 'room_inventory_alert',
            name: 'ğŸ“¦ åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆ',
            type: 'system',
            icon: 'ğŸ“¦',
            defaultMessage: 'åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆãƒ«ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã—ãŸ'
          },
          {
            id: 'system',
            name: 'ğŸ“¢ ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥',
            type: 'system',
            icon: 'ğŸ“¢',
            defaultMessage: 'ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã—ãŸ'
          }
        ];

        // å„ãƒ«ãƒ¼ãƒ ã‚’å‡¦ç†
        for (const room of globalRooms) {
          const roomRef = doc(db, 'rooms', room.id);
          const roomSnap = await getDoc(roomRef);

          if (!roomSnap.exists()) {
            // ãƒ«ãƒ¼ãƒ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
            await setDoc(roomRef, {
              roomId: room.id,
              name: room.name,
              type: room.type,
              icon: room.icon,
              members: [userName],
              memberEmails: [userEmail],
              createdBy: 'ã‚·ã‚¹ãƒ†ãƒ ',
              createdAt: serverTimestamp(),
              lastMessage: room.defaultMessage,
              lastMessageAt: serverTimestamp(),
              lastMessageBy: 'ã‚·ã‚¹ãƒ†ãƒ '
            });
            console.log(`[Global Rooms] ${room.name}ã‚’ä½œæˆã—ã€${userName}ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
          } else {
            // æ—¢å­˜ãƒ«ãƒ¼ãƒ ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ï¼ˆarrayUnionã§é‡è¤‡é˜²æ­¢ï¼‰
            await updateDoc(roomRef, {
              members: arrayUnion(userName),
              memberEmails: arrayUnion(userEmail)
            });
            console.log(`[Global Rooms] ${room.name}ã«${userName}ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
          }
        }

        console.log('[Global Rooms] å…¨ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ«ãƒ¼ãƒ ã¸ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ å®Œäº†');

      } catch (error) {
        console.error('[Global Rooms] ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[Chat FAB] DOMContentLoaded - ãƒªã‚¹ãƒŠãƒ¼é–‹å§‹');

      // postMessageãƒªã‚¹ãƒŠãƒ¼ã¯æ—¢ã«è¡Œ1502ã§ç™»éŒ²æ¸ˆã¿ï¼ˆPRODUCT_REGISTEREDå‡¦ç†ã‚’è¿½åŠ æ¸ˆã¿ï¼‰

      initializeSystemNotificationRoom(); // ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ä½œæˆ
      initializeDefaultRoom(); // å…¨ä½“ãƒ«ãƒ¼ãƒ ä½œæˆ
      addCurrentUserToGlobalRooms(); // ğŸŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ«ãƒ¼ãƒ ã«è¿½åŠ 
      startChatUnreadListener();

      // ğŸ”„ ãƒ‡ãƒã‚¤ã‚¹è‡ªå‹•åŒæœŸï¼ˆFCMãƒˆãƒ¼ã‚¯ãƒ³ãƒ»lastUsedAtæ›´æ–°ï¼‰
      if (typeof refreshDeviceRegistration === 'function') {
        setTimeout(() => {
          refreshDeviceRegistration();
        }, 2000); // ä»–ã®åˆæœŸåŒ–å®Œäº†å¾Œã«å®Ÿè¡Œ
      }
    });

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã‚‚å®Ÿè¡Œï¼ˆå¿µã®ãŸã‚ï¼‰
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        console.log('[Chat FAB] DOMContentLoaded - ãƒªã‚¹ãƒŠãƒ¼é–‹å§‹');
        startChatUnreadListener();
      });
    } else {
      console.log('[Chat FAB] ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ¸ˆã¿ - ãƒªã‚¹ãƒŠãƒ¼å³æ™‚èµ·å‹•');
      startChatUnreadListener();
    }
  </script>

  <!-- ãƒãƒ£ãƒƒãƒˆFABå‰Šé™¤ï¼ˆçµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼šä¸Šéƒ¨ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ã«çµ±åˆï¼‰ -->

  <!-- ãƒãƒ£ãƒƒãƒˆFABãƒªã‚¹ãƒŠãƒ¼ï¼ˆç‹¬ç«‹scriptãƒ–ãƒ­ãƒƒã‚¯ï¼‰ -->
  <script>
    (function() {
      console.log('[Chat FAB] ç‹¬ç«‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯å®Ÿè¡Œé–‹å§‹');

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«å®Ÿè¡Œ
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initChatFAB);
      } else {
        initChatFAB();
      }

      function initChatFAB() {
        console.log('[Chat FAB] åˆæœŸåŒ–é–‹å§‹ - readyState:', document.readyState);

        if (typeof startChatUnreadListener === 'function') {
          console.log('[Chat FAB] startChatUnreadListeneré–¢æ•°ã‚’æ¤œå‡º - å®Ÿè¡Œ');
          startChatUnreadListener();
        } else {
          console.error('[Chat FAB] startChatUnreadListeneré–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }

        // ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼ã‚‚é–‹å§‹
        if (typeof startTodoListener === 'function') {
          console.log('[Todo] startTodoListeneré–¢æ•°ã‚’æ¤œå‡º - å®Ÿè¡Œ');
          startTodoListener();
        } else {
          console.error('[Todo] startTodoListeneré–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
      }
    })();
  </script>

  <!-- Master Background Preload (ãƒ–ãƒ©ãƒ³ãƒ‰ï¼‹ã‚«ãƒ†ã‚´ãƒª) ã¯ master-cache.js å†…ã§è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™ -->
</body>
</html>
