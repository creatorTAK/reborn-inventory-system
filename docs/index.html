<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- Cache Bust: 2025-11-13 13:45 - REBORN Theme v3.0 -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- ğŸš¨ ç·Šæ€¥ãƒ‡ãƒãƒƒã‚°: å…¨consoleç„¡åŠ¹åŒ–ï¼ˆSafariå¯¾å¿œï¼‰ -->
  <script>
    window.console = {
      log: function() {},
      warn: function() {},
      error: function() {},
      info: function() {},
      debug: function() {}
    };
  </script>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Furira">
  <title>Furira åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">

  <!-- PWA Icons -->
  <link rel="apple-touch-icon" href="icon-180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

  <!-- Performance: ãƒ—ãƒªã‚³ãƒã‚¯ãƒˆï¼ˆDNSè§£æ±ºãƒ»TCPãƒ»TLSæ¥ç¶šã‚’å…ˆè¡Œå®Ÿè¡Œï¼‰ -->
  <link rel="dns-prefetch" href="https://script.google.com">
  <link rel="dns-prefetch" href="https://www.gstatic.com">
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>

  <!-- GAS Web App URLï¼ˆå…¨iframeå­ãƒšãƒ¼ã‚¸ã‹ã‚‰å‚ç…§å¯èƒ½ï¼‰ -->
  <script>
    window.REBORN_CONFIG = {
      GAS_BASE_URL: "/gas-proxy"
    };
  </script>

  <!-- REBORN Brand Colors -->
  <link rel="stylesheet" href="/css/reborn-brand-colors.css?v=9635">
  <link rel="stylesheet" href="/css/reborn-theme.css?v=9635">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body, html {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    /* ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ */
    #setup-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow-y: scroll;
      -webkit-overflow-scrolling: touch;
      display: none;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      padding: 20px;
      box-sizing: border-box;
      z-index: 9999;
    }

    .setup-container {
      background: white;
      border-radius: 16px;
      padding: 24px;
      padding-bottom: 40px;
      max-width: 500px;
      width: 100%;
      margin: 20px auto;
      margin-bottom: 60px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      box-sizing: border-box;
      min-height: fit-content;
    }

    .setup-title {
      color: #5B9DD9;
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      text-align: center;
    }

    .setup-subtitle {
      color: #6b7280;
      font-size: 14px;
      text-align: center;
      margin-bottom: 24px;
    }

    .step-section {
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .step-number {
      display: inline-block;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      text-align: center;
      line-height: 24px;
      font-size: 14px;
      font-weight: 600;
      margin-right: 8px;
    }

    .step-title {
      display: inline;
      font-weight: 600;
      color: #1f2937;
      font-size: 16px;
    }

    .step-button {
      width: 100%;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
      transition: transform 0.2s;
    }

    .step-button:hover {
      transform: translateY(-2px);
    }

    .step-button:active {
      transform: translateY(0);
    }

    .step-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .step-button.success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .step-button.optional {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .step-result {
      margin-top: 12px;
      padding: 12px;
      background: white;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      font-size: 13px;
      color: #374151;
      white-space: pre-wrap;
      display: none;
    }

    .step-result.success {
      background: #f0fdf4;
      border-color: #22c55e;
      color: #15803d;
      display: block;
    }

    .step-result.error {
      background: #fef2f2;
      border-color: #ef4444;
      color: #dc2626;
      display: block;
    }

    .open-app-button {
      width: 100%;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 16px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 24px;
      transition: transform 0.2s;
      display: none;
    }

    .open-app-button:hover {
      transform: translateY(-2px);
    }

    .open-app-button:active {
      transform: translateY(0);
    }

    /* ã‚¢ãƒ—ãƒªç”»é¢ */
    #app-screen {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆé€šçŸ¥ï¼‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ä»˜ãï¼‰ */
    #app-header {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      background: linear-gradient(135deg, var(--reborn-primary, #40B4E5) 0%, var(--reborn-primary-dark, #1E8FBF) 100%);
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      /* UI-013: ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’é«˜é€Ÿåˆ‡ã‚Šæ›¿ãˆï¼ˆé·ç§»é€Ÿåº¦æ”¹å–„ï¼‰ */
      transition: opacity 0.15s ease, transform 0.15s ease;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼éè¡¨ç¤ºæ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #app-header[style*="display: none"] {
      opacity: 0;
      transform: translateY(-100%);
    }

    .app-logo {
      height: 50px;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.2s;
      display: block;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }

    .app-logo:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .app-logo:active {
      opacity: 0.8;
      transform: translateY(0);
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼å³å´ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— */
    .header-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* é€šçŸ¥ãƒãƒƒã‚¸ãƒœã‚¿ãƒ³ */
    .notification-button {
      position: relative;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .notification-button:active {
      transform: scale(0.95);
    }

    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆâ˜°ï¼‰ */
    .menu-button {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
      border-radius: 8px;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s;
      color: white;
      font-size: 24px;
      font-weight: 300;
    }

    .menu-button:active {
      transform: scale(0.95);
    }

    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³ */
    .user-icon-button {
      position: relative;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s;
      overflow: hidden;
      padding: 0;
    }

    .user-icon-button:active {
      transform: scale(0.95);
    }

    .user-icon-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .user-icon-placeholder {
      font-size: 24px;
      color: white;
    }

    /* ãƒ‰ãƒ­ãƒ¯ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆèƒŒæ™¯æš—è»¢ï¼‰ */
    #drawer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    #drawer-overlay.active {
      display: block;
      opacity: 1;
    }

    /* ãƒ‰ãƒ­ãƒ¯ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    #drawer-menu {
      position: fixed;
      top: 0;
      right: -280px;
      width: 280px;
      height: 100%;
      background: white;
      z-index: 2000;
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.2);
      transition: right 0.3s ease;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    #drawer-menu.active {
      right: 0;
    }

    .drawer-header {
      padding: 20px 16px;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      color: white;
      font-size: 20px;
      font-weight: 600;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .drawer-item {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 16px;
      color: #1f2937;
      text-decoration: none;
      border-bottom: 1px solid #e5e7eb;
      transition: background 0.2s;
    }

    .drawer-item:hover {
      background: #f3f4f6;
    }

    .drawer-item.active {
      background: #ede9fe;
      color: #5B9DD9;
      font-weight: 600;
    }

    .drawer-item.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    .drawer-accordion {
      margin: 0;
    }

    .drawer-accordion-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      color: #374151;
      font-size: 15px;
      text-decoration: none;
      cursor: pointer;
      transition: background 0.2s;
    }

    .drawer-accordion-header:hover {
      background: #f3f4f6;
    }

    .drawer-accordion-arrow {
      transition: transform 0.3s;
      font-size: 12px;
    }

    .drawer-accordion.open .drawer-accordion-arrow {
      transform: rotate(180deg);
    }

    .drawer-accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .drawer-accordion.open .drawer-accordion-content {
      max-height: 500px;
    }

    .drawer-accordion-item {
      display: block;
      padding: 12px 20px 12px 40px;
      color: #6b7280;
      font-size: 14px;
      text-decoration: none;
      transition: background 0.2s, color 0.2s;
    }

    .drawer-accordion-item:hover {
      background: #f9fafb;
      color: #374151;
    }

    .notification-icon {
      font-size: 24px;
    }

    .badge-count {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #ef4444;
      color: white;
      border-radius: 12px;
      min-width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      padding: 0 6px;
      display: none;
    }

    .badge-count.active {
      display: flex;
    }

    #gas-iframe {
      width: 100%;
      height: 100%;
      border: none;
      flex: 1;
    }

    /* ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIï¼ˆåˆæœŸãƒ­ãƒ¼ãƒ‰ä¸­ã«è¡¨ç¤ºï¼‰ */
    #skeleton-loader {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #f9fafb;
      z-index: 1100; /* UI-013: ãƒ‰ãƒ­ãƒ¯ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚ˆã‚Šä¸Šã«è¡¨ç¤º */
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
      transition: opacity 0.15s ease-out; /* æ¡ˆC: é«˜é€ŸåŒ– 0.3s â†’ 0.15s */
    }

    #skeleton-loader.hidden {
      opacity: 0;
      pointer-events: none;
    }

    /* UI-013: ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼è¿½åŠ ï¼ˆå‹•ãã®ã‚ã‚‹è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰ */
    .loading-spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      margin-top: -25px; /* height / 2 */
      margin-left: -25px; /* width / 2 */
      width: 50px;
      height: 50px;
      border: 4px solid #e0e0e0;
      border-top: 4px solid #5B9DD9;
      border-radius: 50%;
      animation: spinner-rotate 1s linear infinite;
      z-index: 10; /* skeleton-formã®ä¸Šã«è¡¨ç¤º */
    }

    @keyframes spinner-rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .skeleton-header {
      width: 100%;
      height: 60px;
      background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
      background-size: 200% 100%;
      animation: skeleton-pulse 1.5s ease-in-out infinite;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .skeleton-form {
      width: 100%;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .skeleton-input {
      width: 100%;
      height: 40px;
      background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
      background-size: 200% 100%;
      animation: skeleton-pulse 1.5s ease-in-out infinite;
      border-radius: 6px;
      margin-bottom: 16px;
    }

    .skeleton-button {
      width: 120px;
      height: 44px;
      background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
      background-size: 200% 100%;
      animation: skeleton-pulse 1.5s ease-in-out infinite;
      border-radius: 6px;
      margin-top: 10px;
    }

    @keyframes skeleton-pulse {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }

    /* ãƒãƒ£ãƒƒãƒˆFABï¼ˆå³ä¸‹å›ºå®šï¼‰ */
    #chat-fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      box-shadow: 0 8px 24px rgba(91, 157, 217, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 9998;
      transition: all 0.3s ease;
      border: none;
    }

    #chat-fab:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 32px rgba(91, 157, 217, 0.5);
    }

    #chat-fab:active {
      transform: scale(0.95);
    }

    #chat-fab.hidden {
      display: none;
    }

    #chat-fab-icon {
      font-size: 32px;
      line-height: 1;
    }

    /* æœªèª­ãƒãƒƒã‚¸ */
    #chat-fab-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      min-width: 24px;
      height: 24px;
      border-radius: 12px;
      background: #ef4444;
      color: white;
      font-size: 12px;
      font-weight: 600;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0 6px;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
      border: 2px solid white;
    }

    #chat-fab-badge.active {
      display: flex;
      animation: badge-bounce 0.5s ease;
    }

    @keyframes badge-bounce {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.2);
      }
    }
  </style>
</head>
<body>
  <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ï¼ˆåˆå›ã®ã¿ï¼‰ -->
  <div id="setup-screen">
    <div class="setup-container">
      <div class="setup-title">ğŸ”” é€šçŸ¥è¨­å®š</div>
      <div class="setup-subtitle">åˆå›ã®ã¿ - å•†å“ç™»éŒ²ã®é€šçŸ¥ã‚’å—ã‘å–ã‚‹ãŸã‚ã®è¨­å®šã§ã™</div>

      <!-- â“ª-1 ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹èªè¨¼ -->
      <div class="step-section" id="email-auth-section">
        <div>
          <span class="step-number">â“ª</span>
          <span class="step-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼</span>
        </div>
        <div style="margin-top: 8px;">
          <label style="display: block; font-size: 13px; color: #6b7280; margin-bottom: 4px;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
          <input type="email" id="auth-email-input" placeholder="your-email@example.com"
                 style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;">
        </div>
        <button class="step-button" onclick="checkEmailAndProceed()" style="margin-top: 12px;">æ¬¡ã¸ â†’</button>
        <div id="auth-result" class="step-result"></div>
      </div>

      <!-- â“ª-2 æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª -->
      <div class="step-section" id="existing-user-section" style="display: none;">
        <div>
          <span class="step-number">â“ª</span>
          <span class="step-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª</span>
        </div>
        <div style="margin-top: 16px; padding: 16px; background: #f0fdf4; border: 2px solid #86efac; border-radius: 8px;">
          <div style="font-size: 14px; color: #166534; margin-bottom: 12px;">âœ… ä»¥ä¸‹ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ï¼š</div>
          <div style="display: flex; align-items: center; gap: 12px; margin-top: 8px;">
            <div style="font-size: 32px;">ğŸ‘¤</div>
            <div>
              <div style="font-size: 16px; font-weight: 600; color: #1f2937;" id="existing-user-name">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</div>
              <div style="font-size: 14px; color: #6b7280;" id="existing-user-permission">æ¨©é™</div>
              <div style="font-size: 12px; color: #9ca3af; margin-top: 2px;" id="existing-user-email">ãƒ¡ãƒ¼ãƒ«</div>
            </div>
          </div>
          <div style="font-size: 13px; color: #166534; margin-top: 12px;">ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ</div>
        </div>
        <div style="display: flex; gap: 8px; margin-top: 12px;">
          <button class="step-button" onclick="cancelEmailAuth()" style="background: #9ca3af; flex: 1;">â† æˆ»ã‚‹</button>
          <button class="step-button" onclick="registerExistingUserDevice()" style="flex: 2;">ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’ç™»éŒ²</button>
        </div>
        <div id="existing-user-result" class="step-result"></div>
      </div>

      <!-- â“ª-3 æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² -->
      <div class="step-section" id="new-user-section" style="display: none;">
        <div>
          <span class="step-number">â“ª</span>
          <span class="step-title">æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</span>
        </div>
        <div style="margin-top: 8px;">
          <label style="display: block; font-size: 13px; color: #6b7280; margin-bottom: 4px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆæ‹…å½“è€…åï¼‰</label>
          <input type="text" id="user-name-input" placeholder="ä¾‹: å±±ç”°å¤ªéƒ"
                 style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;">
        </div>
        <div style="margin-top: 12px;">
          <label style="display: block; font-size: 13px; color: #6b7280; margin-bottom: 4px;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
          <input type="email" id="user-email-input" placeholder="your-email@example.com" disabled
                 style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; background: #f9fafb; color: #6b7280;">
        </div>
        <div style="margin-top: 12px;" id="permission-selection-area">
          <label style="display: block; font-size: 13px; color: #6b7280; margin-bottom: 8px;">æ¨©é™</label>
          <div id="permission-options" style="display: flex; flex-direction: column; gap: 8px;">
            <!-- åˆå›ç™»éŒ²è€…å‘ã‘ï¼ˆJavaScript ã§å‹•çš„ã«è¡¨ç¤ºåˆ¶å¾¡ï¼‰ -->
            <label id="owner-option" style="display: none; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="user-permission" value="owner" data-display="ã‚ªãƒ¼ãƒŠãƒ¼" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
              <div>
                <div style="font-size: 15px; font-weight: 600; color: #dc2626;">ğŸ”‘ ã‚ªãƒ¼ãƒŠãƒ¼</div>
                <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">å…¨æ©Ÿèƒ½åˆ©ç”¨å¯èƒ½</div>
              </div>
            </label>
            <label id="staff-option" style="display: flex; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="user-permission" value="staff" data-display="ã‚¹ã‚¿ãƒƒãƒ•" checked style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
              <div>
                <div style="font-size: 15px; font-weight: 600; color: #1e40af;">ğŸ“‹ ã‚¹ã‚¿ãƒƒãƒ•</div>
                <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">é€šå¸¸ã®å¾“æ¥­å“¡</div>
              </div>
            </label>
            <label id="outsource-option" style="display: flex; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="user-permission" value="outsource" data-display="å¤–æ³¨" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
              <div>
                <div style="font-size: 15px; font-weight: 600; color: #4338ca;">ğŸ”§ å¤–æ³¨ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼</div>
                <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">å¤–éƒ¨ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼</div>
              </div>
            </label>
          </div>
          <div id="permission-info" style="font-size: 12px; color: #9ca3af; margin-top: 8px; padding: 8px; background: #f9fafb; border-radius: 6px; display: none;">
          </div>
        </div>
        <div style="display: flex; gap: 8px; margin-top: 12px;">
          <button class="step-button" onclick="cancelEmailAuth()" style="background: #9ca3af; flex: 1;">â† æˆ»ã‚‹</button>
          <button class="step-button" onclick="saveNewUserInfo()" style="flex: 2;">ç™»éŒ²</button>
        </div>
        <div id="step0-result" class="step-result"></div>
      </div>

      <!-- â‘  é€šçŸ¥ã‚’è¨±å¯ -->
      <div class="step-section">
        <div>
          <span class="step-number">â‘ </span>
          <span class="step-title">é€šçŸ¥ã‚’è¨±å¯</span>
        </div>
        <button class="step-button" onclick="requestNotificationPermission()">é€šçŸ¥ã‚’è¨±å¯</button>
        <div id="step1-result" class="step-result"></div>
      </div>

      <!-- â‘¡ FCMç™»éŒ² -->
      <div class="step-section">
        <div>
          <span class="step-number">â‘¡</span>
          <span class="step-title">FCMç™»éŒ²</span>
        </div>
        <button class="step-button" onclick="subscribeToFCM()" id="step2-button" disabled>FCMç™»éŒ²</button>
        <div id="step2-result" class="step-result"></div>
      </div>

      <!-- â‘¢ é€šçŸ¥ãƒ†ã‚¹ãƒˆï¼ˆä»»æ„ï¼‰ -->
      <div class="step-section">
        <div>
          <span class="step-number">â‘¢</span>
          <span class="step-title">é€šçŸ¥ãƒ†ã‚¹ãƒˆï¼ˆä»»æ„ï¼‰</span>
        </div>
        <button class="step-button optional" onclick="triggerServerNotification()" id="step3-button" disabled>ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡</button>
        <div id="step3-result" class="step-result"></div>
      </div>

      <!-- ã‚¢ãƒ—ãƒªã‚’é–‹ã -->
      <button class="open-app-button" onclick="openApp()" id="open-app-button">âœ… ã‚¢ãƒ—ãƒªã‚’é–‹ã</button>
    </div>
  </div>

  <!-- ã‚¢ãƒ—ãƒªç”»é¢ï¼ˆ2å›ç›®ä»¥é™ or ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†å¾Œï¼‰ -->
  <div id="app-screen">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆé€šçŸ¥ãƒœã‚¿ãƒ³ + ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ + ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ï¼‰ -->
    <div id="app-header">
      <img src="/images/furira-text-logo-v2.png" alt="Furira" class="app-logo" onclick="navigateToPage('home')" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹">
      <div class="header-buttons">
        <button class="notification-button" onclick="openChatRooms()" title="ãƒãƒ£ãƒƒãƒˆ">
          <span class="notification-icon">ğŸ’¬</span>
          <span class="badge-count" id="chat-badge-count">0</span>
        </button>
        <button class="user-icon-button" id="header-user-icon" onclick="openUserSettings()" title="ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š">
          <span class="user-icon-placeholder" id="user-icon-placeholder">ğŸ‘¤</span>
          <img class="user-icon-image" id="user-icon-image" style="display: none;">
        </button>
        <button class="menu-button" onclick="toggleDrawer()" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">â˜°</button>
      </div>
    </div>

    <!-- ãƒ‰ãƒ­ãƒ¯ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="drawer-overlay" onclick="closeDrawer()"></div>

    <!-- ãƒ‰ãƒ­ãƒ¯ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div id="drawer-menu">
      <div class="drawer-header">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
      <a href="#" onclick="navigateToPage('product'); return false;" class="drawer-item active" id="drawer-product">
        ğŸ“ å•†å“ç™»éŒ²
      </a>
      <a href="#" onclick="navigateToPage('inventory'); return false;" class="drawer-item" id="drawer-inventory">
        ğŸ“¦ åœ¨åº«ç®¡ç†
      </a>
      <a href="#" onclick="navigateToPage('inventory_history'); return false;" class="drawer-item" id="drawer-inventory-history">
        ğŸ“Š å…¥å‡ºåº«å±¥æ­´
      </a>
      <a href="#" class="drawer-item disabled">
        ğŸ“‹ æ£šå¸
      </a>
      <a href="#" onclick="navigateToPage('chat'); return false;" class="drawer-item" id="drawer-chat">
        ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ
      </a>
      <a href="#" class="drawer-item disabled">
        ğŸ’° ä»•å…¥ï¼è²·æ›
      </a>
      <a href="#" class="drawer-item disabled">
        ğŸ’µ å£²ä¸Šï¼å£²æ›
      </a>
      <a href="#" class="drawer-item disabled">
        ğŸ“ˆ å£²ä¸Šåˆ†æ
      </a>
      
      <!-- ãƒã‚¹ã‚¿ç®¡ç†ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ -->
      <div class="drawer-accordion" id="drawer-master">
        <a href="#" class="drawer-accordion-header" onclick="toggleMasterAccordion(); return false;">
          ğŸ—‚ï¸ ãƒã‚¹ã‚¿ç®¡ç†
          <span class="drawer-accordion-arrow">â–¼</span>
        </a>
        <div class="drawer-accordion-content">
          <a href="/master-management.html?category=product" class="drawer-accordion-item" id="drawer-master-product">
            ğŸ“¦ å•†å“é–¢é€£ãƒã‚¹ã‚¿ç®¡ç†
          </a>
          <a href="/master-management.html?category=business" class="drawer-accordion-item" id="drawer-master-business">
            ğŸ¢ æ¥­å‹™é–¢é€£ãƒã‚¹ã‚¿ç®¡ç†
          </a>
        </div>
      </div>

      <!-- è¨­å®šç®¡ç†ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ -->
      <div class="drawer-accordion" id="drawer-config">
        <a href="#" class="drawer-accordion-header" onclick="toggleConfigAccordion(); return false;">
          âš™ï¸ è¨­å®šç®¡ç†
          <span class="drawer-accordion-arrow">â–¼</span>
        </a>
        <div class="drawer-accordion-content">
          <a href="#" onclick="navigateToPage('config-system'); return false;" class="drawer-accordion-item" id="drawer-config-system">
            âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
          </a>
          <a href="#" onclick="navigateToPage('config-product'); return false;" class="drawer-accordion-item" id="drawer-config-product">
            ğŸ“ å•†å“ç™»éŒ²è¨­å®š
          </a>
        </div>
      </div>
    </div>

    <!-- ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIï¼ˆåˆæœŸãƒ­ãƒ¼ãƒ‰ä¸­ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰ -->
    <div id="skeleton-loader">
      <div class="skeleton-header"></div>
      <div class="skeleton-form">
        <div class="skeleton-input"></div>
        <div class="skeleton-input"></div>
        <div class="skeleton-input"></div>
        <div class="skeleton-input"></div>
        <div class="skeleton-button"></div>
      </div>
      <!-- UI-013: ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ï¼ˆå‹•ãã®ã‚ã‚‹è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰ -->
      <div class="loading-spinner"></div>
    </div>

    <!-- GAS Web App ã‚’ iframe ã§è¡¨ç¤ºï¼ˆé…å»¶ãƒ­ãƒ¼ãƒ‰: DOMContentLoadedå¾Œã« srcè¨­å®šï¼‰ -->
    <iframe
      id="gas-iframe"
      data-src="https://script.google.com/macros/s/AKfycbx6ybbRLDqKQJ8IR-NPoVP8981Gtozzz0N3880XanEGRS4--iZtset8PFrVcD_u9YAHMA/exec?v=817&ts=20251112">
    </iframe>
  </div>

  <!-- ========================================
       æœ€å„ªå…ˆ: iframeâ†’è¦ª postMessageå—ä¿¡ãƒãƒ³ãƒ‰ãƒ©
       ========================================
       DOMContentLoadedã‚ˆã‚Šå‰ã«ç™»éŒ²ï¼ˆChatGPTæ¨å¥¨ï¼‰
  -->
  <script>
  (function() {
    console.log('[parent EARLY] postMessage listener ç™»éŒ²é–‹å§‹');

    window.addEventListener('message', function(e) {
      // ========== ãƒ‡ãƒãƒƒã‚°ç”¨è©³ç´°ãƒ­ã‚°ï¼ˆå¿…ãšå‡ºåŠ›ï¼‰ ==========
      console.log('[parent] ========== message RECEIVED ==========');
      console.log('[parent] origin:', e.origin);
      console.log('[parent] data:', e.data);
      console.log('[parent] source:', e.source);
      console.log('[parent] source === window:', e.source === window);

      // iframeå‚ç…§ï¼ˆé…å»¶è©•ä¾¡ï¼‰
      const iframe = document.getElementById('gas-iframe');
      const iframeWindow = iframe ? iframe.contentWindow : null;
      console.log('[parent] iframe.contentWindow:', iframeWindow);
      console.log('[parent] source === iframe.contentWindow:', e.source === iframeWindow);

      // ========== originæ¤œè¨¼ï¼ˆãƒ‡ãƒãƒƒã‚°ä¸­ã¯ç·©å’Œï¼‰ ==========
      const allowedOrigins = [
        'https://script.google.com',
        'https://script.googleusercontent.com',
        'https://furira.jp',
        'https://reborn-inventory-system.pages.dev'
      ];

      const isAllowedOrigin = allowedOrigins.some(origin => e.origin.startsWith(origin));
      console.log('[parent] isAllowedOrigin:', isAllowedOrigin);

      // ãƒ‡ãƒãƒƒã‚°ä¸­: originãƒã‚§ãƒƒã‚¯ã‚’è­¦å‘Šã®ã¿ã«ï¼ˆæœ¬ç•ªã§ã¯ return ã§é®æ–­ï¼‰
      if (!isAllowedOrigin) {
        console.warn('[parent] âš ï¸ message from unexpected origin (allowed for debug):', e.origin);
        // return; // ãƒ‡ãƒãƒƒã‚°ä¸­ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
      }

      // ========== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç† ==========
      const payload = e.data || {};
      console.log('[parent] payload.type:', payload.type);

      if (payload.type === 'showChatRoomsList') {
        console.log('[parent] âœ… showChatRoomsList è¦æ±‚ã‚’å—ä¿¡');
        console.log('[parent] openChatRooms() å‘¼ã³å‡ºã—é–‹å§‹');

        // openChatRoomsé–¢æ•°ãŒå®šç¾©ã•ã‚Œã‚‹ã¾ã§å¾…ã¤ï¼ˆDOMContentLoadedå¾Œã«å®šç¾©ã•ã‚Œã‚‹ï¼‰
        if (typeof openChatRooms === 'function') {
          openChatRooms();
          console.log('[parent] âœ… openChatRooms() å‘¼ã³å‡ºã—å®Œäº†');
        } else {
          console.warn('[parent] âš ï¸ openChatRooms() ãŒã¾ã å®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚é…å»¶å®Ÿè¡Œã—ã¾ã™ã€‚');
          // 100mså¾Œã«å†è©¦è¡Œ
          setTimeout(function() {
            if (typeof openChatRooms === 'function') {
              openChatRooms();
              console.log('[parent] âœ… openChatRooms() é…å»¶å‘¼ã³å‡ºã—å®Œäº†');
            } else {
              console.error('[parent] âŒ openChatRooms() ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
          }, 100);
        }
      } else if (payload.type === 'navigateTo') {
        console.log('[parent] ========== navigateToå‡¦ç†é–‹å§‹ ==========');
        console.log('[parent] âœ… navigateTo è¦æ±‚ã‚’å—ä¿¡');
        console.log('[parent] payload:', payload);
        console.log('[parent] url:', payload.url);
        console.log('[parent] ç¾åœ¨ã®URL:', window.location.href);

        if (payload.url) {
          console.log('[parent] ãƒšãƒ¼ã‚¸é·ç§»ã‚’å®Ÿè¡Œã—ã¾ã™:', payload.url);
          window.location.href = payload.url;
          console.log('[parent] âœ… window.location.hrefè¨­å®šå®Œäº†');
        } else {
          console.error('[parent] âŒ URLãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
          alert('ã‚¨ãƒ©ãƒ¼: é·ç§»å…ˆURLãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        }
        console.log('[parent] ========== navigateToå‡¦ç†å®Œäº† ==========');
      } else if (payload.type === 'navigateToHome') {
        console.log('[parent EARLY] ========== navigateToHomeå‡¦ç†é–‹å§‹ ==========');
        console.log('[parent EARLY] âœ… ãƒˆãƒƒãƒ—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹è¦æ±‚ã‚’å—ä¿¡');

        // navigateToPageé–¢æ•°ãŒå®šç¾©ã•ã‚Œã‚‹ã¾ã§å¾…ã¤
        if (typeof navigateToPage === 'function') {
          navigateToPage('home');
          console.log('[parent EARLY] âœ… navigateToPage(\'home\')å‘¼ã³å‡ºã—å®Œäº†');
        } else {
          console.warn('[parent EARLY] âš ï¸ navigateToPage() ãŒã¾ã å®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚é…å»¶å®Ÿè¡Œã—ã¾ã™ã€‚');
          setTimeout(function() {
            if (typeof navigateToPage === 'function') {
              navigateToPage('home');
              console.log('[parent EARLY] âœ… navigateToPage(\'home\') é…å»¶å‘¼ã³å‡ºã—å®Œäº†');
            } else {
              console.error('[parent EARLY] âŒ navigateToPage() ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
          }, 100);
        }
        console.log('[parent EARLY] ========== navigateToHomeå‡¦ç†å®Œäº† ==========');
      } else {
        console.log('[parent] âš ï¸ æœªçŸ¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—:', payload.type);
      }

      console.log('[parent] ========== messageå‡¦ç†å®Œäº† ==========');
    }, false);

    console.log('[parent EARLY] postMessage listener ç™»éŒ²å®Œäº†');
  })();
  </script>

  <!-- Firebase compat SDK (firestore-api.jsç”¨) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <!-- Firebase SDKs (Modular format) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getMessaging, onMessage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js';
    import { getFirestore, doc, getDoc, setDoc, collection, collectionGroup, addDoc, query, where, orderBy, getDocs, updateDoc, Timestamp, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase è¨­å®šï¼ˆreborn-chat ã«çµ±ä¸€ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "reborn-chat.firebaseapp.com",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    // Firebase åˆæœŸåŒ–ï¼ˆéã‚µãƒãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œï¼‰
    try {
      // Modular SDKåˆæœŸåŒ–
      const app = initializeApp(firebaseConfig);
      const messaging = getMessaging(app);
      const db = getFirestore(app);

      // Compat SDKåˆæœŸåŒ–ï¼ˆfirestore-api.jsç”¨ï¼‰
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      window.db = firebase.firestore(); // Compatç‰ˆ

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å…¬é–‹
      window.firebaseMessaging = messaging;
      window.firebaseDB = db;
      window.firestoreDoc = doc;
      window.firestoreGetDoc = getDoc;
      window.firestoreSetDoc = setDoc;
      window.firestoreCollection = collection;
      window.firestoreCollectionGroup = collectionGroup;
      window.firestoreAddDoc = addDoc;
      window.firestoreQuery = query;
      window.firestoreWhere = where;
      window.firestoreOrderBy = orderBy;
      window.firestoreGetDocs = getDocs;
      window.firestoreUpdateDoc = updateDoc;
      window.firestoreTimestamp = Timestamp;
      window.firestoreServerTimestamp = serverTimestamp;

      // â˜… ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰é€šçŸ¥å¯¾å¿œ â˜…
      // ã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦ã„ã‚‹çŠ¶æ…‹ã§é€šçŸ¥ã‚’å—ä¿¡ã—ãŸæ™‚ã®å‡¦ç†
      onMessage(messaging, (payload) => {
        console.log('ğŸ“¨ ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡:', payload);

        // é€šçŸ¥ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const notificationTitle = payload.data?.title || payload.notification?.title || 'Furira';
        const notificationBody = payload.data?.body || payload.notification?.body || 'æ–°ã—ã„é€šçŸ¥ãŒã‚ã‚Šã¾ã™';

        // çµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼šãƒãƒƒã‚¸ã¯Firestoreã‹ã‚‰è‡ªå‹•æ›´æ–°
        // if (typeof window.incrementBadge === 'function') {
        //   window.incrementBadge();
        //   console.log('ğŸ”” ãƒãƒƒã‚¸ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã—ã¾ã—ãŸ');
        // }

        // ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’è¡¨ç¤ºï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ°—ã¥ã„ã¦ã‚‚ã‚‰ã†ãŸã‚ï¼‰
        if (Notification.permission === 'granted') {
          new Notification(notificationTitle, {
            body: notificationBody,
            icon: '/icon-180.png',
            badge: '/icon-192.png',
            tag: 'reborn-notification',
            requireInteraction: false  // è‡ªå‹•ã§æ¶ˆãˆã‚‹
          });
          console.log('ğŸ”” ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
        }
      });
    } catch (error) {
      // Safariç­‰ã®éã‚µãƒãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯é™ã‹ã«ã‚¹ã‚­ãƒƒãƒ—
          window.firebaseMessaging = null;
    }
  </script>

  <!-- Firestore API Wrapper (ARCH-001 Phase 1.5) -->
  <script type="module" src="/js/firestore-api.js"></script>

  <!-- Master Cache System (MASTER-002: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰) -->
  <!-- master-config.js ã¨ master-cache.js ã¯å‹•çš„ãƒ­ãƒ¼ãƒ‰ã«ç§»è¡Œï¼ˆService Workerå¯¾ç­–ï¼‰ -->

  <script>
    // GAS API URL (Cloudflare Worker ãƒ—ãƒ­ã‚­ã‚·çµŒç”± - CORSå•é¡Œè§£æ±º)
    const GAS_API_URL = '/gas-proxy';

    // VAPIDå…¬é–‹éµ
    const VAPID_PUBLIC_KEY = 'BAhqpnZ0bAewADDuEn2-TGyKLZqL3vPRbI3W8j-_HZT6r82P-E66kcXjFD2Hzmhwd4nFNBVzHMwaqv0kPGaFeEE';

    // Service Worker registrationï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼‰
    let swRegistration = null;

    // ========================================
    // ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆPhase 1: GASçµŒç”±ï¼‰
    // ========================================
    window.brandsCache = null;
    window.brandsPreloading = false;
    window.brandsCacheTimestamp = null;

    /**
     * GASçµŒç”±ã§Firestoreã‹ã‚‰ç®¡ç†ç•ªå·è¨­å®šã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆAlgoliaç§»è¡Œç‰ˆï¼‰
     * - ãƒ–ãƒ©ãƒ³ãƒ‰ã¯Algoliaã§æ¤œç´¢ï¼ˆãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ä¸è¦ï¼‰
     * - ç®¡ç†ç•ªå·è¨­å®šã®ã¿GASçµŒç”±ã§å–å¾—ï¼ˆ1-2ç§’ã§å®Œäº†ï¼‰
     */
    async function preloadManagementConfigForPWA() {
      if (window.managementConfigCache || window.managementConfigPreloading) {
        console.log('â© [PWA] ç®¡ç†ç•ªå·è¨­å®šãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ—¢ã«ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã¾ãŸã¯ãƒ­ãƒ¼ãƒ‰ä¸­ï¼‰');
        return;
      }

      window.managementConfigPreloading = true;
          const startTime = performance.now();

      try {
        // GAS getManagementConfig() ã‚’å‘¼ã³å‡ºã—
        const response = await fetch(GAS_API_URL + '?action=getManagementConfig');

        if (!response.ok) {
          throw new Error('GAS API ã‚¨ãƒ©ãƒ¼: ' + response.status);
        }

        const config = await response.json();

        window.managementConfigCache = config;
        window.managementConfigCacheTimestamp = Date.now();
        window.managementConfigPreloading = false;

        const endTime = performance.now();
        const duration = (endTime - startTime).toFixed(2);

        console.log(`âœ… [PWA-GASçµŒç”±] ç®¡ç†ç•ªå·è¨­å®šãƒ—ãƒªãƒ­ãƒ¼ãƒ‰å®Œäº†: prefix="${config?.prefix}", segments=${config?.segments?.length}ä»¶ (${duration}ms)`);

        return config;

      } catch (error) {
        console.error('âŒ [PWA-GASçµŒç”±] ç®¡ç†ç•ªå·è¨­å®šãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
        window.managementConfigPreloading = false;
        return null;
      }
    }

    // Unhandled Promise Rejection ã‚’ã‚­ãƒ£ãƒƒãƒï¼ˆSafariç­‰ã®FCMã‚¨ãƒ©ãƒ¼å¯¾å¿œï¼‰
    window.addEventListener('unhandledrejection', (event) => {
      // Firebase Messagingã®éã‚µãƒãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¶ã‚¨ãƒ©ãƒ¼ã¯é™ã‹ã«ç„¡è¦–
      if (event.reason && event.reason.message && event.reason.message.includes('messaging/unsupported-browser')) {
              event.preventDefault(); // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’æŠ‘åˆ¶
      }
    });

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–ï¼ˆDOMContentLoaded: ã‚ˆã‚Šé«˜é€Ÿï¼‰
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('âš¡ DOMContentLoaded - åˆæœŸåŒ–é–‹å§‹');

      // Service Workerç™»éŒ²
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
          swRegistration = registration;
          console.log('âœ… Service Worker ç™»éŒ²æˆåŠŸ:', registration.scope);
        } catch (error) {
          console.error('âŒ Service Worker ç™»éŒ²å¤±æ•—:', error);
        }
      }

      // çµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼šãƒãƒƒã‚¸ã¯Firestoreã‹ã‚‰è‡ªå‹•æ›´æ–°
      // initBadge(); // æ—§ã‚·ã‚¹ãƒ†ãƒ å‰Šé™¤

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’èª­ã¿è¾¼ã¿
      loadUserIcon();

      // ã‚¢ãƒ—ãƒªå†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã®Firestoreã‚¢ã‚¤ã‚³ãƒ³ã‚¯ãƒªã‚¢
      await clearFirestoreUserIconIfNeeded();

      // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
      const setupCompleted = localStorage.getItem('fcm-setup-completed');
      if (setupCompleted !== '1') {
        // åˆå› â†’ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã‚’è¡¨ç¤º
        document.getElementById('setup-screen').style.display = 'flex';
        document.getElementById('app-screen').style.display = 'none';
        // æ¨©é™é¸æŠè‚¢ã‚’å‹•çš„ãƒ­ãƒ¼ãƒ‰ï¼ˆFirestoreã‹ã‚‰å–å¾—ã—ã¦ç”Ÿæˆï¼‰
        await loadAndRenderPermissions();
      } else {
        // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†æ¸ˆã¿ â†’ FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆPhase 2: NOTIF-003ï¼‰
        await checkAndUpdateFCMToken();

        // ğŸ  åˆæœŸè¨­å®šå®Œäº†æ¸ˆã¿ã®å ´åˆã€ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’éè¡¨ç¤ºã«ã—ã¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã‚’è¡¨ç¤ºï¼ˆUI-013ï¼‰
        // ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIè¡¨ç¤ºä¸­ã‚‚ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’éè¡¨ç¤ºã«ä¿ã¤
        const header = document.getElementById('app-header');
        if (header) {
          header.style.display = 'none';
        }

        // ğŸš€ åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«PWAç‰ˆmenu_homeã‚’ç›´æ¥ãƒ­ãƒ¼ãƒ‰ï¼ˆGASç‰ˆã‚’çµŒç”±ã—ãªã„ï¼‰
        const iframe = document.getElementById('gas-iframe');
        if (iframe) {
          // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDç”Ÿæˆï¼ˆç«¯æœ«ãƒ»ã‚¿ãƒ–ã”ã¨ã«ä¸€æ„ï¼‰
          if (!sessionStorage.getItem('device_session_id')) {
            const newSessionId = Date.now() + '_' + Math.random().toString(36).substring(2);
            sessionStorage.setItem('device_session_id', newSessionId);
            console.log('ğŸ†” æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ç”Ÿæˆ:', newSessionId);
          }
          const sessionId = sessionStorage.getItem('device_session_id');

          // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
          const userName = localStorage.getItem('reborn_user_name') || '';
          const userIconUrl = localStorage.getItem('reborn_user_icon_url') || '';

          const pwaBaseUrl = 'https://reborn-inventory-system.pages.dev';
          const params = new URLSearchParams({
            userName: userName,
            userIconUrl: userIconUrl,
            sessionId: sessionId
          });
          const menuHomeUrl = pwaBaseUrl + '/menu_home.html?' + params.toString();

          console.log('ğŸ  [åˆæœŸè¨­å®šå®Œäº†æ¸ˆã¿] PWAç‰ˆmenu_homeã‚’ç›´æ¥ãƒ­ãƒ¼ãƒ‰:', menuHomeUrl);
          console.log('ğŸ†” sessionId:', sessionId);
          console.log('ğŸ‘¤ userName:', userName);
          iframe.setAttribute('data-src', menuHomeUrl);

          // ç®¡ç†ç•ªå·è¨­å®šã®GASçµŒç”±ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã‚’å»ƒæ­¢ï¼ˆ2025-11-19ï¼‰
          // ç†ç”±: product.html ãŒ Firestore ã‹ã‚‰ç›´æ¥èª­ã¿è¾¼ã‚€ãŸã‚ä¸è¦
          /*
          setTimeout(() => {
                      preloadManagementConfigForPWA();
          }, 5000);
          */
        }
      }

      // iframeèª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIã‚’éè¡¨ç¤º
      const iframe = document.getElementById('gas-iframe');
      const skeleton = document.getElementById('skeleton-loader');

      if (iframe && skeleton) {
        iframe.addEventListener('load', () => {
                  skeleton.classList.add('hidden');
          // 0.3ç§’å¾Œã«å®Œå…¨ã«å‰Šé™¤ï¼ˆtransitionã¨åŒæœŸï¼‰
          setTimeout(() => {
            skeleton.style.display = 'none';
          }, 300);
        });

        // ğŸš€ iframeé…å»¶ãƒ­ãƒ¼ãƒ‰: åˆæœŸè¡¨ç¤ºã‚’é«˜é€ŸåŒ–
        // DOMæ§‹ç¯‰å®Œäº†å¾Œã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰iframeã‚’èª­ã¿è¾¼ã¿é–‹å§‹
        console.log('â±ï¸ iframeé…å»¶ãƒ­ãƒ¼ãƒ‰: 100mså¾Œã«é–‹å§‹');
        setTimeout(() => {
          const iframeSrc = iframe.getAttribute('data-src');
          if (iframeSrc) {
            // ğŸ” postMessageç”¨ã®parentOriginã¨pmTokenã‚’ç”Ÿæˆï¼ˆäºŒé‡iframeå¯¾ç­–ï¼‰
            const parentOrigin = location.origin;
            const pmToken = crypto.getRandomValues(new Uint32Array(1))[0].toString(36);
            localStorage.setItem('pm_token', pmToken);
            console.log('ğŸ” [postMessage Security] åˆæœŸèª­ã¿è¾¼ã¿ - parentOrigin:', parentOrigin, 'pmToken:', pmToken);

            // FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’localStorageã‹ã‚‰å–å¾—ã—ã¦URLã«è¿½åŠ 
            const fcmToken = localStorage.getItem('reborn_fcm_token') || '';
            const fcmParam = fcmToken ? '&fcmToken=' + encodeURIComponent(fcmToken) : '';
            const securityParams = '&parentOrigin=' + encodeURIComponent(parentOrigin) + '&pmToken=' + encodeURIComponent(pmToken);
            const finalSrc = iframeSrc + fcmParam + securityParams;

            console.log('ğŸš€ iframeèª­ã¿è¾¼ã¿é–‹å§‹:', finalSrc.substring(0, 120) + '...');
            console.log('ğŸ”‘ FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’iframeã«æ¸¡ã—ã¾ã™:', fcmToken ? fcmToken.substring(0, 20) + '...' : 'ãªã—');
            iframe.src = finalSrc;
          }
        }, 100); // 100msé…å»¶ï¼ˆä½“æ„Ÿé€Ÿåº¦å‘ä¸Šã®ãŸã‚ï¼‰
      }

      // ãƒã‚¹ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã¯å‰Šé™¤
      // ãƒã‚¹ã‚¿ç®¡ç†ç”»é¢ã‚’é–‹ã„ãŸæ™‚ã«åˆã‚ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªè¨­è¨ˆã«å¤‰æ›´
    });

    // FirestoreãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ç›£è¦–ï¼ˆãƒãƒ£ãƒƒãƒˆæˆ»ã‚‹ãƒœã‚¿ãƒ³ç”¨ï¼‰
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('[Navigation] Firestoreãƒªã‚¹ãƒŠãƒ¼åˆæœŸåŒ–é–‹å§‹');

      try {
        // Firebaseè¨­å®š
        const firebaseConfig = {
          apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
          authDomain: "reborn-chat.firebaseapp.com",
          projectId: "reborn-chat",
          storageBucket: "reborn-chat.firebasestorage.app",
          messagingSenderId: "345706548795",
          appId: "1:345706548795:web:058a553da6b4b74db5161e"
        };

        // Firebaseå‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        const { initializeApp, getApps } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
        const { getFirestore, doc, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        // FirebaseåˆæœŸåŒ–ï¼ˆæ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ãªã‚‰ãã‚Œã‚’ä½¿ç”¨ï¼‰
        const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig, 'navigation-listener');
        const db = getFirestore(app);

        console.log('[Navigation] Firestoreãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');

        // navigationã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
        let isFirstSnapshot = true;
        onSnapshot(doc(db, 'navigation', 'chatControl'), (snapshot) => {
          if (snapshot.exists()) {
            const data = snapshot.data();
            console.log('[Navigation] Chat Firestoreæ›´æ–°æ¤œçŸ¥:', data);

            // åˆå›èª­ã¿è¾¼ã¿ã¯ç„¡è¦–ï¼ˆå¤ã„ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‹èª¤ä½œå‹•ã‚’é˜²ãï¼‰
            if (isFirstSnapshot) {
              console.log('[Navigation] Chatåˆå›èª­ã¿è¾¼ã¿ã®ãŸã‚ç„¡è¦–');
              isFirstSnapshot = false;
              return;
            }

            // è‡ªåˆ†ã®sessionIdã¨ä¸€è‡´ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const mySessionId = sessionStorage.getItem('device_session_id');
            console.log('[Navigation] Chat mySessionId:', mySessionId);
            console.log('[Navigation] Chat data.sessionId:', data.sessionId);

            if (data.sessionId !== mySessionId) {
              console.log('[Navigation] â­ï¸ ä»–ã®ç«¯æœ«ã®ãƒãƒ£ãƒƒãƒˆæ“ä½œã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
              return;
            }

            if (data.action === 'goBackToList') {
              console.log('[Navigation] âœ… goBackToListè¦æ±‚ã‚’å—ä¿¡ â†’ openChatRooms()å‘¼ã³å‡ºã—');
              if (typeof openChatRooms === 'function') {
                openChatRooms();
              } else {
                console.error('[Navigation] openChatRooms()ãŒæœªå®šç¾©');
              }
            }
          }
        }, (error) => {
          console.error('[Navigation] Firestoreãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
        });

        // menuControlãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã‹ã‚‰ã®é·ç§»ç”¨ï¼‰
        let isFirstMenuSnapshot = true;
        console.log('[Navigation] âœ… menuControlãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²é–‹å§‹');
        onSnapshot(doc(db, 'navigation', 'menuControl'), (snapshot) => {
          console.log('[Navigation] ğŸ”” Menu onSnapshot ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ');
          console.log('[Navigation] snapshot.exists():', snapshot.exists());

          if (snapshot.exists()) {
            const data = snapshot.data();
            console.log('[Navigation] Menuæ›´æ–°æ¤œçŸ¥ - å…¨ãƒ‡ãƒ¼ã‚¿:', JSON.stringify(data));
            console.log('[Navigation] isFirstMenuSnapshot:', isFirstMenuSnapshot);

            // åˆå›èª­ã¿è¾¼ã¿ã¯ç„¡è¦–ï¼ˆå¤ã„ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‹èª¤ä½œå‹•ã‚’é˜²ãï¼‰
            if (isFirstMenuSnapshot) {
              console.log('[Navigation] â­ï¸ Menuåˆå›èª­ã¿è¾¼ã¿ã®ãŸã‚ç„¡è¦–');
              isFirstMenuSnapshot = false;
              return;
            }

            console.log('[Navigation] data.action:', data.action);
            console.log('[Navigation] data.page:', data.page);
            console.log('[Navigation] data.sessionId:', data.sessionId);

            // è‡ªåˆ†ã®sessionIdã¨ä¸€è‡´ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const mySessionId = sessionStorage.getItem('device_session_id');
            console.log('[Navigation] mySessionId:', mySessionId);

            if (data.sessionId !== mySessionId) {
              console.log('[Navigation] â­ï¸ ä»–ã®ç«¯æœ«ã®æ“ä½œã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
              return;
            }

            if (data.action === 'navigate' && data.page) {
              console.log('[Navigation] âœ… navigateè¦æ±‚ã‚’å—ä¿¡ â†’ navigateToPage()å‘¼ã³å‡ºã—:', data.page);
              if (typeof navigateToPage === 'function') {
                navigateToPage(data.page);
                console.log('[Navigation] âœ… navigateToPage()å‘¼ã³å‡ºã—å®Œäº†ï¼ˆ200msé…å»¶ãƒ¢ãƒ¼ãƒ‰ï¼‰');
              } else {
                console.error('[Navigation] âŒ navigateToPage()ãŒæœªå®šç¾©');
              }
            } else {
              console.log('[Navigation] âš ï¸ action or page ãŒä¸æ­£:', { action: data.action, page: data.page });
            }
          } else {
            console.log('[Navigation] âš ï¸ menuControlãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“');
          }
        }, (error) => {
          console.error('[Navigation] âŒ Menuãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
        });

      } catch (error) {
        console.error('[Navigation] FirestoreåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      }
    });

    /**
     * Firestore settings/permissions ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
     * å­˜åœ¨ã—ãªã„å ´åˆã¯è‡ªå‹•çš„ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
     */
    async function initializePermissionsSettings() {
      const db = window.firebaseDB;
      const docFunc = window.firestoreDoc;
      const getDocFunc = window.firestoreGetDoc;
      const setDocFunc = window.firestoreSetDoc;
      const serverTimestampFunc = window.firestoreServerTimestamp;

      if (!db || !docFunc || !getDocFunc || !setDocFunc || !serverTimestampFunc) {
        console.error('[initPermissions] Firestoreé–¢æ•°ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return null;
      }

      try {
        const permissionsDocRef = docFunc(db, 'settings', 'permissions');
        const permissionsDoc = await getDocFunc(permissionsDocRef);

        if (permissionsDoc.exists()) {
          console.log('[initPermissions] âœ… æ¨©é™è¨­å®šãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™');
          return permissionsDoc.data();
        }

        // å­˜åœ¨ã—ãªã„å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
        console.log('[initPermissions] ğŸ”„ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ¨©é™è¨­å®šã‚’ä½œæˆä¸­...');

        const defaultPermissions = {
          roles: [
            {
              id: 'owner',
              display: 'ã‚ªãƒ¼ãƒŠãƒ¼',
              description: 'ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ç®¡ç†è€…',
              order: 1,
              isSystem: true,
              canModify: false
            },
            {
              id: 'staff',
              display: 'ã‚¹ã‚¿ãƒƒãƒ•',
              description: 'é€šå¸¸ã®å¾“æ¥­å“¡',
              order: 2,
              isSystem: true,
              canModify: false
            },
            {
              id: 'partner',
              display: 'å¤–æ³¨',
              description: 'å¤–éƒ¨ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼',
              order: 3,
              isSystem: true,
              canModify: false
            }
          ],
          lastUpdated: serverTimestampFunc(),
          version: 1
        };

        await setDocFunc(permissionsDocRef, defaultPermissions);
        console.log('[initPermissions] âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ¨©é™è¨­å®šã‚’ä½œæˆã—ã¾ã—ãŸ');

        return defaultPermissions;
      } catch (error) {
        console.error('[initPermissions] âŒ ã‚¨ãƒ©ãƒ¼:', error);
        return null;
      }
    }

    /**
     * Firestoreã‹ã‚‰æ¨©é™è¨­å®šã‚’å–å¾—ã—ã¦ã€å‹•çš„ã«UIã‚’ç”Ÿæˆ
     */
    async function loadAndRenderPermissions() {
      console.log('[loadPermissions] ğŸ”„ æ¨©é™è¨­å®šã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...');

      try {
        // 1. æ¨©é™è¨­å®šã‚’åˆæœŸåŒ–ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆï¼‰
        const permissionsData = await initializePermissionsSettings();

        if (!permissionsData || !permissionsData.roles) {
          throw new Error('æ¨©é™è¨­å®šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        // 2. Collection Group Queryã§ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ã‚ªãƒ¼ãƒŠãƒ¼å­˜åœ¨ãƒã‚§ãƒƒã‚¯
        const db = window.firebaseDB;
        const collectionGroupFunc = window.firestoreCollectionGroup;
        const queryFunc = window.firestoreQuery;
        const whereFunc = window.firestoreWhere;
        const getDocsFunc = window.firestoreGetDocs;

        const allDevicesQuery = queryFunc(
          collectionGroupFunc(db, 'devices'),
          whereFunc('permissionId', '==', 'owner'),
          whereFunc('active', '==', true)
        );
        const ownerDevices = await getDocsFunc(allDevicesQuery);
        const hasOwner = ownerDevices.size > 0;

        console.log(`[loadPermissions] ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ã‚ªãƒ¼ãƒŠãƒ¼ãƒ‡ãƒã‚¤ã‚¹æ•°: ${ownerDevices.size}`);

        // 3. æ¨©é™ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’UIã«å‹•çš„ç”Ÿæˆ
        const permissionContainer = document.getElementById('permission-options');
        const permissionInfo = document.getElementById('permission-info');

        if (!permissionContainer) {
          console.error('[loadPermissions] permission-optionsè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        permissionContainer.innerHTML = ''; // æ—¢å­˜ã®HTMLã‚’ã‚¯ãƒªã‚¢

        // roles ã‚’ order ã§ã‚½ãƒ¼ãƒˆ
        const sortedRoles = permissionsData.roles.sort((a, b) => a.order - b.order);

        // ã‚¢ã‚¤ã‚³ãƒ³ãƒãƒƒãƒ”ãƒ³ã‚°
        const iconMap = {
          owner: 'ğŸ“•',
          staff: 'ğŸ“˜',
          partner: 'ğŸ“™'
        };

        // ã‚«ãƒ©ãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°
        const colorMap = {
          owner: '#dc2626',
          staff: '#1e40af',
          partner: '#4338ca'
        };

        let defaultChecked = false;

        sortedRoles.forEach((role, index) => {
          const isOwner = role.id === 'owner';
          const shouldShow = isOwner ? !hasOwner : true; // ã‚ªãƒ¼ãƒŠãƒ¼ã¯æœªç™»éŒ²æ™‚ã®ã¿è¡¨ç¤º

          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯: ã‚ªãƒ¼ãƒŠãƒ¼ãŒã„ãªã‘ã‚Œã°ownerã€ã„ã‚Œã°staff
          const shouldCheck = (!defaultChecked && shouldShow &&
            ((isOwner && !hasOwner) || (!isOwner && role.id === 'staff' && hasOwner)));

          if (shouldCheck) defaultChecked = true;

          const label = document.createElement('label');
          label.id = `${role.id}-option`;
          label.style.display = shouldShow ? 'flex' : 'none';
          label.style.alignItems = 'center';
          label.style.padding = '12px';
          label.style.border = '2px solid #e5e7eb';
          label.style.borderRadius = '8px';
          label.style.cursor = 'pointer';
          label.style.transition = 'all 0.2s';

          const radio = document.createElement('input');
          radio.type = 'radio';
          radio.name = 'user-permission';
          radio.value = role.id; // Internal ID
          radio.dataset.display = role.display; // Display name
          radio.style.marginRight = '8px';
          radio.style.width = '18px';
          radio.style.height = '18px';
          radio.style.cursor = 'pointer';
          if (shouldCheck) radio.checked = true;

          const textDiv = document.createElement('div');

          const titleDiv = document.createElement('div');
          titleDiv.style.fontSize = '15px';
          titleDiv.style.fontWeight = '600';
          titleDiv.style.color = colorMap[role.id] || '#000';
          titleDiv.textContent = `${iconMap[role.id] || 'ğŸ“„'} ${role.display}`;

          const descDiv = document.createElement('div');
          descDiv.style.fontSize = '12px';
          descDiv.style.color = '#6b7280';
          descDiv.style.marginTop = '2px';
          descDiv.textContent = role.description;

          textDiv.appendChild(titleDiv);
          textDiv.appendChild(descDiv);
          label.appendChild(radio);
          label.appendChild(textDiv);
          permissionContainer.appendChild(label);
        });

        // æƒ…å ±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        if (!hasOwner) {
          permissionInfo.textContent = 'âœ¨ åˆå›ç™»éŒ²è€…ã®ãŸã‚ã€ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ã§ç™»éŒ²ã•ã‚Œã¾ã™';
          permissionInfo.style.background = '#fef3c7';
          permissionInfo.style.color = '#92400e';
        } else {
          permissionInfo.textContent = 'ğŸ’¡ ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ã¯ç®¡ç†è€…ãŒã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ç®¡ç†ã€ã‹ã‚‰è¨­å®šã—ã¾ã™';
          permissionInfo.style.background = '#e0e7ff';
          permissionInfo.style.color = '#1e40af';
        }

        console.log('[loadPermissions] âœ… æ¨©é™é¸æŠUIã‚’å‹•çš„ç”Ÿæˆã—ã¾ã—ãŸ');

      } catch (error) {
        console.error('[loadPermissions] âŒ ã‚¨ãƒ©ãƒ¼:', error);

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚¨ãƒ©ãƒ¼æ™‚ã¯å®‰å…¨å´ã«å€’ã™ï¼ˆã‚¹ã‚¿ãƒƒãƒ•ã®ã¿è¡¨ç¤ºï¼‰
        const permissionContainer = document.getElementById('permission-options');
        const permissionInfo = document.getElementById('permission-info');

        if (permissionContainer) {
          permissionContainer.innerHTML = `
            <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
              <input type="radio" name="user-permission" value="staff" data-display="ã‚¹ã‚¿ãƒƒãƒ•" checked style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
              <div>
                <div style="font-size: 15px; font-weight: 600; color: #1e40af;">ğŸ“˜ ã‚¹ã‚¿ãƒƒãƒ•</div>
                <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">é€šå¸¸ã®å¾“æ¥­å“¡</div>
              </div>
            </label>
          `;
        }

        if (permissionInfo) {
          permissionInfo.textContent = 'âš ï¸ æ¨©é™è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆã‚¹ã‚¿ãƒƒãƒ•ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¾ã™ï¼‰';
          permissionInfo.style.background = '#fef2f2';
          permissionInfo.style.color = '#991b1b';
        }
      }
    }


    // ========================================
    // æ–°ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹èªè¨¼ãƒ•ãƒ­ãƒ¼
    // ========================================

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§èªè¨¼æ¸ˆã¿ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿æŒ
    let authenticatedEmail = '';
    let existingUserData = null;

    // â“ª-1 ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯ã¨ç”»é¢é·ç§»
    window.checkEmailAndProceed = async function checkEmailAndProceed() {
      console.log('[checkEmailAndProceed] ========== é–‹å§‹ ==========');
      const emailInput = document.getElementById('auth-email-input');
      const resultDiv = document.getElementById('auth-result');
      const email = emailInput.value.trim();
      console.log('[checkEmailAndProceed] å…¥åŠ›ãƒ¡ãƒ¼ãƒ«:', email);

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!email) {
        console.log('[checkEmailAndProceed] ã‚¨ãƒ©ãƒ¼: ãƒ¡ãƒ¼ãƒ«æœªå…¥åŠ›');
        resultDiv.textContent = 'âŒ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
        return;
      }

      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        console.log('[checkEmailAndProceed] ã‚¨ãƒ©ãƒ¼: ãƒ¡ãƒ¼ãƒ«å½¢å¼ä¸æ­£');
        resultDiv.textContent = 'âŒ æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
        return;
      }

      // ç¢ºèªä¸­è¡¨ç¤º
      console.log('[checkEmailAndProceed] ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªé–‹å§‹...');
      resultDiv.textContent = 'â³ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªä¸­...';
      resultDiv.className = 'step-result';
      resultDiv.style.display = 'block';

      try {
        // ğŸš¨ ãƒ‡ãƒãƒƒã‚°: ç”»é¢è¡¨ç¤ºç”¨ï¼ˆconsole.logã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ï¼‰
        resultDiv.textContent = 'ğŸ” Firestoreã‚¢ã‚¯ã‚»ã‚¹é–‹å§‹...';

        // Firestoreã§æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
        let db = window.firebaseDB;

        // window.firebaseDBãŒæœªåˆæœŸåŒ–ã®å ´åˆã€ã“ã“ã§åˆæœŸåŒ–
        if (!db) {
          resultDiv.textContent = 'ğŸ” FirebaseåˆæœŸåŒ–ä¸­...';
          const { initializeApp, getApps } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
          const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

          const firebaseConfig = {
            apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
            authDomain: "reborn-chat.firebaseapp.com",
            projectId: "reborn-chat",
            storageBucket: "reborn-chat.firebasestorage.app",
            messagingSenderId: "345706548795",
            appId: "1:345706548795:web:058a553da6b4b74db5161e"
          };

          const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
          db = getFirestore(app);
          window.firebaseDB = db;
        }

        const { getDocs, collection, query, where } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const usersCollection = collection(db, 'users');

        // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ï¼ˆåˆå›ç™»éŒ²åˆ¤å®šç”¨ï¼‰
        const allUsersSnapshot = await getDocs(usersCollection);

        // userEmailãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
        const q = query(usersCollection, where('userEmail', '==', email));
        const querySnapshot = await getDocs(q);

        authenticatedEmail = email;

        if (!querySnapshot.empty) {
          // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã£ãŸ
          const userDoc = querySnapshot.docs[0];
          existingUserData = { id: userDoc.id, ...userDoc.data() };

          // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªç”»é¢ã‚’è¡¨ç¤º
          document.getElementById('existing-user-name').textContent = existingUserData.userName || existingUserData.name || 'åå‰æœªè¨­å®š';
          document.getElementById('existing-user-permission').textContent = getPermissionDisplayName(existingUserData.permission || 'staff');
          document.getElementById('existing-user-email').textContent = email;

          // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
          resultDiv.style.display = 'none';
          document.getElementById('email-auth-section').style.display = 'none';
          document.getElementById('existing-user-section').style.display = 'block';
        } else {
          // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼
          // æ–°è¦ç™»éŒ²ç”»é¢ã‚’è¡¨ç¤º
          document.getElementById('user-email-input').value = email;

          // ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ã®è¡¨ç¤ºåˆ¤å®šï¼ˆå…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
          const isFirstUser = allUsersSnapshot.size === 0;

          const ownerOption = document.getElementById('owner-option');
          const permissionInfo = document.getElementById('permission-info');

          if (isFirstUser) {
            ownerOption.style.display = 'flex';
            ownerOption.querySelector('input').checked = true;
            permissionInfo.textContent = 'âœ¨ ã‚ãªãŸãŒåˆå›ç™»éŒ²è€…ã§ã™ã€‚ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ã§ç™»éŒ²ã•ã‚Œã¾ã™ã€‚';
            permissionInfo.style.background = '#fef3c7';
            permissionInfo.style.color = '#92400e';
            permissionInfo.style.display = 'block';
          } else {
            ownerOption.style.display = 'none';
            document.getElementById('staff-option').querySelector('input').checked = true;
            permissionInfo.textContent = 'â„¹ï¸ ã‚ªãƒ¼ãƒŠãƒ¼ã¯æ—¢ã«ç™»éŒ²æ¸ˆã¿ã§ã™ã€‚';
            permissionInfo.style.background = '#e0f2fe';
            permissionInfo.style.color = '#075985';
            permissionInfo.style.display = 'block';
          }

          // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
          resultDiv.style.display = 'none';
          document.getElementById('email-auth-section').style.display = 'none';
          document.getElementById('new-user-section').style.display = 'block';
        }
      } catch (error) {
        console.error('âŒ [checkEmailAndProceed] ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
        console.error('âŒ [checkEmailAndProceed] ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.stack);
        resultDiv.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message;
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
      }
      console.log('[checkEmailAndProceed] ========== çµ‚äº† ==========');
    }

    // æ¨©é™ã®è¡¨ç¤ºåã‚’å–å¾—
    function getPermissionDisplayName(permissionId) {
      const permissionMap = {
        'owner': 'ğŸ”‘ ã‚ªãƒ¼ãƒŠãƒ¼',
        'staff': 'ğŸ“‹ ã‚¹ã‚¿ãƒƒãƒ•',
        'outsource': 'ğŸ”§ å¤–æ³¨ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼'
      };
      return permissionMap[permissionId] || 'ğŸ“‹ ã‚¹ã‚¿ãƒƒãƒ•';
    }

    // èªè¨¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆæœ€åˆã®ç”»é¢ã«æˆ»ã‚‹ï¼‰
    window.cancelEmailAuth = function cancelEmailAuth() {
      document.getElementById('email-auth-section').style.display = 'block';
      document.getElementById('existing-user-section').style.display = 'none';
      document.getElementById('new-user-section').style.display = 'none';
      document.getElementById('auth-result').style.display = 'none';
      authenticatedEmail = '';
      existingUserData = null;
    }

    // â“ª-2 æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒã‚¤ã‚¹ç™»éŒ²
    window.registerExistingUserDevice = async function registerExistingUserDevice() {
      const resultDiv = document.getElementById('existing-user-result');

      if (!existingUserData || !authenticatedEmail) {
        resultDiv.textContent = 'âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ';
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
        return;
      }

      // LocalStorageã«ä¿å­˜
      try {
        const userName = existingUserData.userName || existingUserData.name;
        localStorage.setItem('reborn_user_name', userName);
        localStorage.setItem('reborn_user_email', authenticatedEmail);
        localStorage.setItem('reborn_user_permission_id', existingUserData.permission || 'staff');
        localStorage.setItem('reborn_user_permission_display', getPermissionDisplayName(existingUserData.permission || 'staff'));

        console.log('âœ… æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ä¿å­˜:', existingUserData);

        // IndexedDBã«ã‚‚ä¿å­˜
        const request = indexedDB.open('RebornUserDB', 1);
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('user')) {
            db.createObjectStore('user');
          }
        };
        request.onsuccess = () => {
          const db = request.result;
          const transaction = db.transaction(['user'], 'readwrite');
          const store = transaction.objectStore('user');
          store.put(userName, 'userName');
          console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’IndexedDBã«ä¿å­˜:', userName);
        };

        resultDiv.textContent = 'âœ… ãƒ‡ãƒã‚¤ã‚¹ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼\næ¬¡ã«ã€Œâ‘  é€šçŸ¥ã‚’è¨±å¯ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
        resultDiv.className = 'step-result success';
        resultDiv.style.display = 'block';

        // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        document.querySelector('#existing-user-section button[onclick="registerExistingUserDevice()"]').disabled = true;
      } catch (error) {
        console.error('âŒ ãƒ‡ãƒã‚¤ã‚¹ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
        resultDiv.textContent = 'âŒ ãƒ‡ãƒã‚¤ã‚¹ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
      }
    }

    // â“ª-3 æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
    window.saveNewUserInfo = async function saveNewUserInfo() {
      const nameInput = document.getElementById('user-name-input');
      const emailInput = document.getElementById('user-email-input');
      const resultDiv = document.getElementById('step0-result');

      const userName = nameInput.value.trim();
      const email = emailInput.value.trim();

      // æ¨©é™ã‚’å–å¾—
      const permissionRadio = document.querySelector('input[name="user-permission"]:checked');
      const permissionId = permissionRadio ? permissionRadio.value : 'staff';
      const permissionDisplay = permissionRadio ? permissionRadio.dataset.display : 'ã‚¹ã‚¿ãƒƒãƒ•';

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!userName) {
        resultDiv.textContent = 'âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
        return;
      }

      // ä¿å­˜ä¸­ã®è¡¨ç¤º
      resultDiv.textContent = 'â³ ä¿å­˜ä¸­...';
      resultDiv.className = 'step-result';
      resultDiv.style.display = 'block';

      // LocalStorageã«ä¿å­˜
      try {
        localStorage.setItem('reborn_user_name', userName);
        localStorage.setItem('reborn_user_email', email);
        localStorage.setItem('reborn_user_permission_id', permissionId);
        localStorage.setItem('reborn_user_permission_display', permissionDisplay);
        console.log('âœ… æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ä¿å­˜:', { name: userName, email: email, permissionId: permissionId });

        // IndexedDBã«ã‚‚ä¿å­˜
        const request = indexedDB.open('RebornUserDB', 1);
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('user')) {
            db.createObjectStore('user');
          }
        };
        request.onsuccess = () => {
          const db = request.result;
          const transaction = db.transaction(['user'], 'readwrite');
          const store = transaction.objectStore('user');
          store.put(userName, 'userName');
          console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’IndexedDBã«ä¿å­˜:', userName);
        };

        // ğŸ†• Firestoreã«ã‚‚ä¿å­˜ï¼ˆuserEmailãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½¿ç”¨ï¼‰
        resultDiv.textContent = 'â³ Firestoreã«ä¿å­˜ä¸­...';

        let db = window.firebaseDB;
        if (!db) {
          const { initializeApp, getApps } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
          const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

          const firebaseConfig = {
            apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
            authDomain: "reborn-chat.firebaseapp.com",
            projectId: "reborn-chat",
            storageBucket: "reborn-chat.firebasestorage.app",
            messagingSenderId: "345706548795",
            appId: "1:345706548795:web:058a553da6b4b74db5161e"
          };

          const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
          db = getFirestore(app);
          window.firebaseDB = db;
        }

        const { addDoc, collection } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const usersCollection = collection(db, 'users');

        const newUserDoc = await addDoc(usersCollection, {
          userName: userName,
          userEmail: email,
          permission: permissionId,
          createdAt: new Date().toISOString(),
          deviceId: null  // é€šçŸ¥è¨±å¯å¾Œã«è¨­å®šã•ã‚Œã‚‹
        });

        console.log('âœ… Firestoreã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²å®Œäº†:', newUserDoc.id);

        resultDiv.textContent = 'âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼\næ¬¡ã«ã€Œâ‘  é€šçŸ¥ã‚’è¨±å¯ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
        resultDiv.className = 'step-result success';
        resultDiv.style.display = 'block';

        // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç„¡åŠ¹åŒ–
        nameInput.disabled = true;
        emailInput.disabled = true;
        document.querySelectorAll('input[name="user-permission"]').forEach(radio => radio.disabled = true);
      } catch (error) {
        console.error('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        resultDiv.textContent = 'âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
      }
    }

    // ========================================
    // æ—§ç‰ˆã® saveUserInfoï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
    // ========================================
    // â“ª ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜
    async function saveUserInfo() {
      const nameInput = document.getElementById('user-name-input');
      const emailInput = document.getElementById('user-email-input');
      const resultDiv = document.getElementById('step0-result');

      const userName = nameInput.value.trim();
      const email = emailInput.value.trim();

      // æ¨©é™ã‚’å–å¾—ï¼ˆpermissionId ã¨ permissionDisplay ã®ä¸¡æ–¹ï¼‰
      const permissionRadio = document.querySelector('input[name="user-permission"]:checked');
      const permissionId = permissionRadio ? permissionRadio.value : 'staff'; // Internal ID
      const permissionDisplay = permissionRadio ? permissionRadio.dataset.display : 'ã‚¹ã‚¿ãƒƒãƒ•'; // Display name

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!userName) {
        resultDiv.textContent = 'âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
        return;
      }

      if (!email) {
        resultDiv.textContent = 'âŒ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
        return;
      }

      // ç°¡æ˜“çš„ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œè¨¼
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        resultDiv.textContent = 'âŒ æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
        return;
      }

      // ä¿å­˜ä¸­ã®è¡¨ç¤º
      resultDiv.textContent = 'â³ ä¿å­˜ä¸­...';
      resultDiv.className = 'step-result';
      resultDiv.style.display = 'block';

      // âœ… ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ã®å ´åˆã€ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
      if (permissionId === 'owner') {
        const confirmMessage = `âš ï¸ ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ã§ç™»éŒ²ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚\n\nã‚ªãƒ¼ãƒŠãƒ¼ã¯ä»¥ä¸‹ã®æ¨©é™ã‚’æŒã¡ã¾ã™ï¼š\nâ€¢ ã™ã¹ã¦ã®æ©Ÿèƒ½ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹\nâ€¢ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ¨©é™\nâ€¢ ã‚·ã‚¹ãƒ†ãƒ è¨­å®šå¤‰æ›´æ¨©é™\n\næœ¬å½“ã«ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ã§ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`;

        if (!confirm(confirmMessage)) {
          resultDiv.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚';
          resultDiv.className = 'step-result';
          resultDiv.style.display = 'block';
          console.log('[saveUserInfo] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚ªãƒ¼ãƒŠãƒ¼ç™»éŒ²ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
          return;
        }
      }

      // âœ… ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ã®å ´åˆã€Firestoreã§æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚’ãƒã‚§ãƒƒã‚¯
      if (permissionId === 'owner') {
        try {
          // Firebase modular SDK (v10) ã‚’ä½¿ç”¨
          const db = window.firebaseDB;
          if (!db) {
            throw new Error('Firestore ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
          }

          // getDocs ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ¸ˆã¿ã®ã‚‚ã®ã‚’ä½¿ç”¨
          const { getDocs, collection } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
          const usersCollection = collection(db, 'users');
          const usersSnapshot = await getDocs(usersCollection);
          const userCount = usersSnapshot.size;

          console.log('[saveUserInfo] æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:', userCount);

          if (userCount > 0) {
            // æ—¢ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ã‚ªãƒ¼ãƒŠãƒ¼ç™»éŒ²ã‚’æ‹’å¦
            resultDiv.textContent = 'âŒ æ—¢ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚¹ã‚¿ãƒƒãƒ•ã¾ãŸã¯å¤–æ³¨ã§ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚';
            resultDiv.className = 'step-result error';
            resultDiv.style.display = 'block';
            console.log('[saveUserInfo] âŒ ã‚ªãƒ¼ãƒŠãƒ¼é‡è¤‡ç™»éŒ²ã‚’æ‹’å¦ï¼ˆæ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ' + userCount + 'ï¼‰');
            return;
          }

          console.log('[saveUserInfo] âœ… åˆå›ç™»éŒ²è€…ã®ãŸã‚ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ã‚’è¨±å¯');
        } catch (error) {
          console.error('âŒ ã‚ªãƒ¼ãƒŠãƒ¼é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
          resultDiv.textContent = 'âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
          resultDiv.className = 'step-result error';
          resultDiv.style.display = 'block';
          return;
        }
      }

      // LocalStorageã«ä¿å­˜
      try {
        localStorage.setItem('reborn_user_name', userName);
        localStorage.setItem('reborn_user_email', email);
        localStorage.setItem('reborn_user_permission_id', permissionId);
        localStorage.setItem('reborn_user_permission_display', permissionDisplay);
        console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ä¿å­˜:', { name: userName, email: email, permissionId: permissionId, permissionDisplay: permissionDisplay });

        // IndexedDBã«ã‚‚ä¿å­˜ï¼ˆService Workerã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã™ã‚‹ãŸã‚ï¼‰
        const request = indexedDB.open('RebornUserDB', 1);
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('user')) {
            db.createObjectStore('user');
          }
        };
        request.onsuccess = () => {
          const db = request.result;
          const transaction = db.transaction(['user'], 'readwrite');
          const store = transaction.objectStore('user');
          store.put(userName, 'userName');
          console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’IndexedDBã«ä¿å­˜:', userName);
        };
        request.onerror = () => {
          console.error('âŒ IndexedDBä¿å­˜ã‚¨ãƒ©ãƒ¼');
        };

        // PWAç‰ˆã§ã¯Firestoreã®ã¿ã«ä¿å­˜ï¼ˆGAS Proxyã¯ä¸è¦ï¼‰
        console.log('âœ… PWAç‰ˆï¼šFirestoreã«ä¿å­˜äºˆå®šï¼ˆç«¯æœ«ç™»éŒ²æ™‚ã«è‡ªå‹•ä¿å­˜ï¼‰');

        resultDiv.textContent = 'âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼\næ¬¡ã«ã€Œâ‘  é€šçŸ¥ã‚’è¨±å¯ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
        resultDiv.className = 'step-result success';
        resultDiv.style.display = 'block';

        // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç„¡åŠ¹åŒ–
        nameInput.disabled = true;
        emailInput.disabled = true;
        document.querySelectorAll('input[name="user-permission"]').forEach(radio => radio.disabled = true);
      } catch (error) {
        console.error('âŒ LocalStorageä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        resultDiv.textContent = 'âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
      }
    }

    // â‘  é€šçŸ¥ã‚’è¨±å¯
    async function requestNotificationPermission() {
      const resultDiv = document.getElementById('step1-result');
      const step2Button = document.getElementById('step2-button');

      if (!('Notification' in window)) {
        resultDiv.textContent = 'âŒ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“';
        resultDiv.className = 'step-result error';
        return;
      }

      try {
        const permission = await Notification.requestPermission();

        if (permission === 'granted') {
          resultDiv.textContent = 'âœ… é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸï¼\næ¬¡ã«ã€Œâ‘¡ FCMç™»éŒ²ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
          resultDiv.className = 'step-result success';

          // â‘¡ ã‚’æœ‰åŠ¹åŒ–
          step2Button.disabled = false;
        } else {
          resultDiv.textContent = 'âŒ é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ\nè¨­å®šã‹ã‚‰è¨±å¯ã—ã¦ãã ã•ã„ã€‚';
          resultDiv.className = 'step-result error';
        }
      } catch (error) {
        resultDiv.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message;
        resultDiv.className = 'step-result error';
      }
    }

    // â‘¡ FCMç™»éŒ²
    async function subscribeToFCM() {
      const resultDiv = document.getElementById('step2-result');
      const step3Button = document.getElementById('step3-button');
      const openAppButton = document.getElementById('open-app-button');

      // FCMéã‚µãƒãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆSafariç­‰ï¼‰ã®å ´åˆ
      if (!window.firebaseMessaging) {
        resultDiv.textContent = 'â„¹ï¸ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ï¼ˆSafariç­‰ï¼‰\n\nã‚¹ãƒãƒ›ã§ã¯é€šçŸ¥ã‚’å—ã‘å–ã‚Œã¾ã™ã€‚\n\nä¸‹ã®ã€Œã‚¢ãƒ—ãƒªã‚’é–‹ãã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
        resultDiv.className = 'step-result';
        resultDiv.style.display = 'block';

        // ã€Œã‚¢ãƒ—ãƒªã‚’é–‹ãã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        openAppButton.style.display = 'block';
        return;
      }

      if (Notification.permission !== 'granted') {
        resultDiv.textContent = 'âŒ é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“\nã€Œâ‘  é€šçŸ¥ã‚’è¨±å¯ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
        resultDiv.className = 'step-result error';
        return;
      }

      // Service Workerç™»éŒ²ç¢ºèª
      if (!swRegistration) {
        resultDiv.textContent = 'âŒ Service WorkerãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“\nãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚';
        resultDiv.className = 'step-result error';
        console.error('âŒ swRegistration is null');
        return;
      }

      console.log('âœ… Service Workeræº–å‚™å®Œäº†:', swRegistration);

      try {
        resultDiv.textContent = 'ç™»éŒ²ä¸­...';
        resultDiv.className = 'step-result';
        resultDiv.style.display = 'block';

        // Firebase Messagingã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
        const { getToken } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js');

        console.log('ğŸ”„ FCMãƒˆãƒ¼ã‚¯ãƒ³å–å¾—é–‹å§‹...');
        console.log('  - firebaseMessaging:', window.firebaseMessaging);
        console.log('  - vapidKey:', VAPID_PUBLIC_KEY);
        console.log('  - swRegistration:', swRegistration);

        const currentToken = await getToken(window.firebaseMessaging, {
          vapidKey: VAPID_PUBLIC_KEY,
          serviceWorkerRegistration: swRegistration
        });

        console.log('âœ… FCMãƒˆãƒ¼ã‚¯ãƒ³å–å¾—æˆåŠŸ:', currentToken);

        if (currentToken) {
          // FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’localStorageã«ä¿å­˜ï¼ˆãƒ‡ãƒã‚¤ã‚¹è­˜åˆ¥ç”¨ï¼‰
          localStorage.setItem('reborn_fcm_token', currentToken);
          console.log('ğŸ’¾ FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’localStorageã«ä¿å­˜');

          console.log('ğŸ“± FCMãƒˆãƒ¼ã‚¯ãƒ³:', currentToken);

          // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’å–å¾—
          const deviceInfo = {
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            language: navigator.language,
            screenSize: `${screen.width}x${screen.height}`,
            timestamp: new Date().toISOString()
          };
          console.log('ğŸ“± ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±:', deviceInfo);

          // LocalStorageã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨æ¨©é™ã‚’å–å¾—
          const userEmail = localStorage.getItem('reborn_user_email') || 'unknown';
          const userName = localStorage.getItem('reborn_user_name') || '';
          const userPermissionId = localStorage.getItem('reborn_user_permission_id') || 'staff';
          const userPermissionDisplay = localStorage.getItem('reborn_user_permission_display') || 'ã‚¹ã‚¿ãƒƒãƒ•';
          console.log('ğŸ“§ ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:', userEmail);
          console.log('ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼å:', userName);
          console.log('ğŸ” æ¨©é™ID:', userPermissionId);
          console.log('ğŸ” æ¨©é™è¡¨ç¤ºå:', userPermissionDisplay);

          // Firestoreã«ä¿å­˜ï¼ˆFirebase Functionsç”¨ï¼‰
          try {
            if (!userName || !currentToken) {
              throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ã§ãã¾ã›ã‚“');
            }

            console.log('ğŸ”„ Firestore devices ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜é–‹å§‹...');

            const db = window.firebaseDB;
            const collectionFunc = window.firestoreCollection;
            const collectionGroupFunc = window.firestoreCollectionGroup;
            const addDocFunc = window.firestoreAddDoc;
            const queryFunc = window.firestoreQuery;
            const whereFunc = window.firestoreWhere;
            const getDocsFunc = window.firestoreGetDocs;
            const updateDocFunc = window.firestoreUpdateDoc;

            if (!db || !collectionFunc || !collectionGroupFunc || !addDocFunc || !queryFunc || !whereFunc || !getDocsFunc || !updateDocFunc) {
              throw new Error('Firestoreé–¢æ•°ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }

            // 1. ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ã‚ªãƒ¼ãƒŠãƒ¼ãƒ‡ãƒã‚¤ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆCollection Group Queryï¼‰
            const allDevicesQuery = queryFunc(
              collectionGroupFunc(db, 'devices'),
              whereFunc('permissionId', '==', 'owner'),
              whereFunc('active', '==', true)
            );
            const ownerDevices = await getDocsFunc(allDevicesQuery);

            console.log(`ğŸ” ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ã‚ªãƒ¼ãƒŠãƒ¼ãƒ‡ãƒã‚¤ã‚¹æ•°: ${ownerDevices.size}`);

            // ã‚ªãƒ¼ãƒŠãƒ¼åˆ¶é™: ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã§æ—¢ã«ã‚ªãƒ¼ãƒŠãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€æ–°ã—ã„ãƒ‡ãƒã‚¤ã‚¹ã¯å¼·åˆ¶çš„ã«ã‚¹ã‚¿ãƒƒãƒ•ã«é™æ ¼
            let finalPermissionId = userPermissionId;
            let finalPermissionDisplay = userPermissionDisplay;
            if (ownerDevices.size > 0 && userPermissionId === 'owner') {
              finalPermissionId = 'staff';
              finalPermissionDisplay = 'ã‚¹ã‚¿ãƒƒãƒ•';
              console.log('âš ï¸ ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã§æ—¢ã«ã‚ªãƒ¼ãƒŠãƒ¼ãƒ‡ãƒã‚¤ã‚¹ãŒå­˜åœ¨ã™ã‚‹ãŸã‚ã€ã‚¹ã‚¿ãƒƒãƒ•ã«é™æ ¼');
            }

            // 2. ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ—¢å­˜ãƒ‡ãƒã‚¤ã‚¹ã‚’å–å¾—ï¼ˆ1ãƒ¦ãƒ¼ã‚¶ãƒ¼1å°åˆ¶é™ç”¨ï¼‰
            const userDevicesRef = collectionFunc(db, 'users', userEmail, 'devices');
            const userActiveQuery = queryFunc(userDevicesRef, whereFunc('active', '==', true));
            const userActiveDevices = await getDocsFunc(userActiveQuery);

            console.log(`ğŸ“± ${userEmail}ã®ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ‡ãƒã‚¤ã‚¹æ•°: ${userActiveDevices.size}`);

            // 3. æ—¢ã«ãƒ‡ãƒã‚¤ã‚¹ãŒã‚ã‚‹å ´åˆã€æ—¢å­˜ãƒ‡ãƒã‚¤ã‚¹ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            if (userActiveDevices.size > 0) {
              for (const deviceDoc of userActiveDevices.docs) {
                await updateDocFunc(deviceDoc.ref, { active: false });
                console.log(`â¸ï¸ æ—¢å­˜ãƒ‡ãƒã‚¤ã‚¹ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–: ${deviceDoc.id}`);
              }
            }

            // 4. æ–°ã—ã„ãƒ‡ãƒã‚¤ã‚¹ã‚’è¿½åŠ 
            const newDevice = {
              fcmToken: currentToken,
              deviceInfo: deviceInfo,
              active: true,
              permissionId: finalPermissionId,
              permissionDisplay: finalPermissionDisplay,
              userName: userName,
              userEmail: userEmail,
              registeredAt: new Date(),
              lastUsedAt: new Date()
            };

            const deviceDocRef = await addDocFunc(userDevicesRef, newDevice);
            console.log('âœ… FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’Firestoreã«ä¿å­˜ã—ã¾ã—ãŸ:', deviceDocRef.id);
            console.log('   - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:', userEmail);
            console.log('   - ãƒ¦ãƒ¼ã‚¶ãƒ¼å:', userName);
            console.log('   - æ¨©é™ID:', finalPermissionId);
            console.log('   - æ¨©é™è¡¨ç¤ºå:', finalPermissionDisplay, userPermissionId !== finalPermissionId ? `(${userPermissionDisplay} â†’ é™æ ¼)` : '');
            console.log('   - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ‡ãƒã‚¤ã‚¹æ•°: 1ï¼ˆæ—¢å­˜ãƒ‡ãƒã‚¤ã‚¹ã‚’ç½®ãæ›ãˆï¼‰');

            resultDiv.textContent = 'âœ… FCMç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\nä¸‹ã®ã€Œã‚¢ãƒ—ãƒªã‚’é–‹ãã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚\n\nâ€» é€šçŸ¥ãƒ†ã‚¹ãƒˆã¯ä»»æ„ã§ã™ï¼ˆã‚¹ã‚­ãƒƒãƒ—å¯ï¼‰';
            resultDiv.className = 'step-result success';

            // â‘¢ ã‚’æœ‰åŠ¹åŒ–
            step3Button.disabled = false;

            // ã€Œã‚¢ãƒ—ãƒªã‚’é–‹ãã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            openAppButton.style.display = 'block';

            // ğŸ”” ãƒãƒ£ãƒƒãƒˆæœªèª­ãƒªã‚¹ãƒŠãƒ¼ã‚’é–‹å§‹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
            if (typeof startChatUnreadListener === 'function') {
              console.log('[FCMç™»éŒ²] ãƒãƒ£ãƒƒãƒˆæœªèª­ãƒªã‚¹ãƒŠãƒ¼ã‚’é–‹å§‹');
              setTimeout(() => {
                startChatUnreadListener();
              }, 1000); // 1ç§’å¾Œã«å®Ÿè¡Œï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åè¨­å®šãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿï¼‰
            }
          } catch (firestoreError) {
            console.error('âŒ Firestoreä¿å­˜ã‚¨ãƒ©ãƒ¼:', firestoreError);
            resultDiv.textContent = 'âŒ ç™»éŒ²å¤±æ•—\n\nã‚¨ãƒ©ãƒ¼: ' + firestoreError.message;
            resultDiv.className = 'step-result error';
          }
        } else {
          resultDiv.textContent = 'âŒ ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
          resultDiv.className = 'step-result error';
        }
      } catch (error) {
        resultDiv.textContent = 'âŒ ç™»éŒ²å¤±æ•—\n\nã‚¨ãƒ©ãƒ¼: ' + error.message;
        resultDiv.className = 'step-result error';
        console.error('âŒ FCMç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // â‘¢ ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰é€šçŸ¥ã‚’é€ä¿¡ï¼ˆä»»æ„ï¼‰
    async function triggerServerNotification() {
      const resultDiv = document.getElementById('step3-result');

      try {
        resultDiv.textContent = 'é€ä¿¡ä¸­...';
        resultDiv.className = 'step-result';
        resultDiv.style.display = 'block';

        const title = 'ğŸ‰ Furira ãƒ†ã‚¹ãƒˆé€šçŸ¥';
        const body = 'é€šçŸ¥è¨­å®šãŒæ­£ã—ãå®Œäº†ã—ã¾ã—ãŸï¼';

        // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
        const titleEncoded = btoa(encodeURIComponent(title));
        const bodyEncoded = btoa(encodeURIComponent(body));

        // GETãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        const url = GAS_API_URL + '?action=sendFCM&title=' + titleEncoded + '&body=' + bodyEncoded;
        const response = await fetch(url);

        if (response.ok) {
          const data = await response.json();
          resultDiv.textContent = 'âœ… ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼\n\nâš ï¸ ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã£ã¦é€šçŸ¥ãŒå±Šãã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
          resultDiv.className = 'step-result success';
        } else {
          throw new Error('HTTP ' + response.status);
        }
      } catch (error) {
        resultDiv.textContent = 'âŒ é€ä¿¡å¤±æ•—\n\nã‚¨ãƒ©ãƒ¼: ' + error.message;
        resultDiv.className = 'step-result error';
        console.error('âŒ é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã‚¢ãƒ—ãƒªã‚’é–‹ã
    function openApp() {
      // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ãƒ•ãƒ©ã‚°ã‚’ä¿å­˜
      localStorage.setItem('fcm-setup-completed', '1');

      // ã‚¢ãƒ—ãƒªç”»é¢ã‚’è¡¨ç¤º
      showAppScreen();

      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã‚’èª­ã¿è¾¼ã‚€ï¼ˆUI-013: ãƒˆãƒƒãƒ—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ï¼‰
      navigateToPage('home');
    }

    // ã‚¢ãƒ—ãƒªç”»é¢ã‚’è¡¨ç¤º
    async function showAppScreen() {
      document.getElementById('setup-screen').style.display = 'none';
      document.getElementById('app-screen').style.display = 'flex';

      // FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€æ›´æ–°ãŒã‚ã‚Œã°è‡ªå‹•é€ä¿¡
      await checkAndUpdateFCMToken();
    }

    /**
     * FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€æ›´æ–°ãŒã‚ã‚Œã°è‡ªå‹•çš„ã«GASã«é€ä¿¡
     * Phase 2: ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å‡¦ç†ï¼ˆNOTIF-003ï¼‰
     */
    async function checkAndUpdateFCMToken() {
      try {
        // Service WorkerãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if (!swRegistration) {
          console.log('â­ï¸ Service Workeræœªç™»éŒ²ã®ãŸã‚ã€FCMãƒˆãƒ¼ã‚¯ãƒ³ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—');
          return;
        }

        // FCMéã‚µãƒãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆSafariç­‰ï¼‰ã‚’ãƒã‚§ãƒƒã‚¯
        if (!window.firebaseMessaging) {
                  console.log('   ã‚¹ãƒãƒ›ã‚¢ãƒ—ãƒªã§ã¯é€šçŸ¥ã‚’å—ã‘å–ã‚Œã¾ã™');
          return;
        }

        // Firebase Messagingã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
        const { getToken } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js');

        console.log('ğŸ”„ FCMãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°ãƒã‚§ãƒƒã‚¯é–‹å§‹...');

        const currentToken = await getToken(window.firebaseMessaging, {
          vapidKey: VAPID_PUBLIC_KEY,
          serviceWorkerRegistration: swRegistration
        });

        if (!currentToken) {
          console.log('âš ï¸ FCMãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
          return;
        }

        // localStorageã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã¨æ¯”è¼ƒ
        const savedToken = localStorage.getItem('reborn_fcm_token');

        if (savedToken === currentToken) {
          console.log('âœ… FCMãƒˆãƒ¼ã‚¯ãƒ³ã¯æœ€æ–°ã§ã™ï¼ˆæ›´æ–°ãªã—ï¼‰');
          return;
        }

        console.log('ğŸ”„ FCMãƒˆãƒ¼ã‚¯ãƒ³ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ');
        console.log('  - æ—§ãƒˆãƒ¼ã‚¯ãƒ³:', savedToken ? savedToken.substring(0, 20) + '...' : 'ãªã—');
        console.log('  - æ–°ãƒˆãƒ¼ã‚¯ãƒ³:', currentToken.substring(0, 20) + '...');

        // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’å–å¾—
        const deviceInfo = {
          userAgent: navigator.userAgent,
          platform: navigator.platform,
          language: navigator.language,
          screenSize: `${screen.width}x${screen.height}`,
          timestamp: new Date().toISOString()
        };

        // LocalStorageã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
        const userEmail = localStorage.getItem('reborn_user_email') || 'unknown';
        const userName = localStorage.getItem('reborn_user_name') || '';
        const permissionDisplay = localStorage.getItem('reborn_user_permission_display') || 'ã‚¹ã‚¿ãƒƒãƒ•';

        // ğŸ”§ ä¿®æ­£: localStorageã‹ã‚‰é€šçŸ¥è¨­å®šã‚’èª­ã¿è¾¼ã‚€
        const config = JSON.parse(localStorage.getItem('config') || '{}');
        const notificationEnabled = config.notificationEnabled !== undefined ? config.notificationEnabled : true;
        const notificationSound = config.notificationSound !== undefined ? config.notificationSound : true;

        // GASã«æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ä¿¡
        const response = await fetch(GAS_API_URL + '?action=subscribeFCM&token=' + encodeURIComponent(currentToken) +
                                    '&deviceInfo=' + encodeURIComponent(JSON.stringify(deviceInfo)) +
                                    '&userId=' + encodeURIComponent(userEmail) +
                                    '&userName=' + encodeURIComponent(userName) +
                                    '&email=' + encodeURIComponent(userEmail) +
                                    '&permission=' + encodeURIComponent(permissionDisplay) +
                                    '&notificationEnabled=' + encodeURIComponent(notificationEnabled) +
                                    '&notificationSound=' + encodeURIComponent(notificationSound));

        if (response.ok) {
          // localStorageã«æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
          localStorage.setItem('reborn_fcm_token', currentToken);
          console.log('âœ… FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’è‡ªå‹•æ›´æ–°ã—ã¾ã—ãŸ');
        } else {
          console.error('âŒ FCMãƒˆãƒ¼ã‚¯ãƒ³ã®é€ä¿¡ã«å¤±æ•—:', response.status);
        }
      } catch (error) {
        console.error('âŒ FCMãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ãƒ‰ãƒ­ãƒ¯ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã/é–‰ã˜ã‚‹
    function toggleDrawer() {
      const drawer = document.getElementById('drawer-menu');
      const overlay = document.getElementById('drawer-overlay');

      drawer.classList.toggle('active');
      overlay.classList.toggle('active');
    }

    // ãƒ‰ãƒ­ãƒ¯ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
    function closeDrawer() {
      const drawer = document.getElementById('drawer-menu');
      const overlay = document.getElementById('drawer-overlay');

      drawer.classList.remove('active');
      overlay.classList.remove('active');
    }

    // ãƒã‚¹ã‚¿ç®¡ç†ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰
    function toggleMasterAccordion() {
      const accordion = document.getElementById('drawer-master');
      accordion.classList.toggle('open');
    }

    // è¨­å®šç®¡ç†ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰
    function toggleConfigAccordion() {
      const accordion = document.getElementById('drawer-config');
      accordion.classList.toggle('open');
    }

    // pmTokenç”Ÿæˆç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function generatePmToken() {
      return crypto.getRandomValues(new Uint32Array(1))[0].toString(36);
    }

    // ãƒšãƒ¼ã‚¸é·ç§»ï¼ˆãƒ‰ãƒ­ãƒ¯ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ï¼‰
    function navigateToPage(page, options = {}) {
      const iframe = document.getElementById('gas-iframe');
      const header = document.getElementById('app-header');
      const skeleton = document.getElementById('skeleton-loader');
      const baseUrl = 'https://script.google.com/macros/s/AKfycbx6ybbRLDqKQJ8IR-NPoVP8981Gtozzz0N3880XanEGRS4--iZtset8PFrVcD_u9YAHMA/exec';
      const skipSkeleton = options.skipSkeleton || false;

      // ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬é–‹å§‹
      const startTime = performance.now();
      console.log('â±ï¸ [è¨ˆæ¸¬é–‹å§‹] ãƒšãƒ¼ã‚¸é·ç§»:', page);

      // UI-013: ãƒ‰ãƒ­ãƒ¯ãƒ¼ã‚’å…ˆã«é–‰ã˜ã‚‹ï¼ˆã‚¹ã‚±ãƒ«ãƒˆãƒ³UIè¡¨ç¤ºã‚’å¦¨ã’ãªã„ã‚ˆã†ã«ï¼‰
      closeDrawer();

      // UI-013: ãƒšãƒ¼ã‚¸é·ç§»æ™‚ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°UXæ”¹å–„
      // æ¡ˆD: 300msé…å»¶ã§ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIè¡¨ç¤ºï¼ˆé«˜é€Ÿã‚­ãƒ£ãƒƒã‚·ãƒ¥æ™‚ã¯éè¡¨ç¤ºï¼‰
      // æ¡ˆC: ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚’é«˜é€ŸåŒ–ï¼ˆ0.15sï¼‰
      let skeletonTimeout = null;
      if (!skipSkeleton && skeleton) {
        skeletonTimeout = setTimeout(() => {
          console.log('ğŸ”„ [UI-013] ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°300msè¶…é - ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIè¡¨ç¤º:', page);
          skeleton.classList.remove('hidden');
          skeleton.style.display = ''; // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢ï¼ˆé‡è¦ï¼ï¼‰
        }, 300);
      } else if (skipSkeleton) {
        console.log('âš¡ [UI-013] é«˜é€Ÿé·ç§»ãƒ¢ãƒ¼ãƒ‰ - ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIã‚¹ã‚­ãƒƒãƒ—:', page);
      }
      // ãƒ˜ãƒƒãƒ€ãƒ¼ã¯èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆ¶å¾¡ï¼ˆã‚«ã‚¯ã¤ãé˜²æ­¢ï¼‰

      // ğŸ” postMessageç”¨ã®parentOriginã¨pmTokenã‚’ç”Ÿæˆï¼ˆäºŒé‡iframeå¯¾ç­–ï¼‰
      const parentOrigin = location.origin; // https://reborn-inventory-system.pages.dev
      const pmToken = crypto.getRandomValues(new Uint32Array(1))[0].toString(36);
      localStorage.setItem('pm_token', pmToken);
      console.log('ğŸ” [postMessage Security] parentOrigin:', parentOrigin, 'pmToken:', pmToken);

      // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDç”Ÿæˆï¼ˆç«¯æœ«ãƒ»ã‚¿ãƒ–ã”ã¨ã«ä¸€æ„ï¼‰
      if (!sessionStorage.getItem('device_session_id')) {
        const newSessionId = Date.now() + '_' + Math.random().toString(36).substring(2);
        sessionStorage.setItem('device_session_id', newSessionId);
        console.log('ğŸ†” æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ç”Ÿæˆ:', newSessionId);
      } else {
        console.log('ğŸ†” æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ä½¿ç”¨:', sessionStorage.getItem('device_session_id'));
      }
      const sessionId = sessionStorage.getItem('device_session_id');
      const sessionIdParam = '&sessionId=' + encodeURIComponent(sessionId);

      // FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’localStorageã‹ã‚‰å–å¾—
      const fcmToken = localStorage.getItem('reborn_fcm_token') || '';
      const fcmParam = fcmToken ? '&fcmToken=' + encodeURIComponent(fcmToken) : '';
      console.log('ğŸ”‘ FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’iframeã«æ¸¡ã—ã¾ã™:', fcmToken ? fcmToken.substring(0, 20) + '...' : 'ãªã—');

      // postMessageç”¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
      const securityParams = '&parentOrigin=' + encodeURIComponent(parentOrigin) + '&pmToken=' + encodeURIComponent(pmToken);

      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
      document.querySelectorAll('.drawer-item').forEach(item => {
        item.classList.remove('active');
      });

      if (page === 'home') {
        // PWAç‰ˆãƒˆãƒƒãƒ—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç›´æ¥èª­ã¿è¾¼ã¿ï¼ˆè¶…é«˜é€ŸåŒ–ï¼š2ç§’ â†’ 50msï¼‰
        const pwaBaseUrl = 'https://reborn-inventory-system.pages.dev';
        const userName = localStorage.getItem('reborn_user_name') || '';
        const userIconUrl = localStorage.getItem('reborn_user_icon_url') || '';

        const params = new URLSearchParams({
          userName: userName,
          userIconUrl: userIconUrl,
          sessionId: sessionId
        });

        iframe.src = pwaBaseUrl + '/menu_home.html?' + params.toString();
      } else if (page === 'product') {
        // PWAç‰ˆå•†å“ç™»éŒ²ã‚’ç›´æ¥èª­ã¿è¾¼ã¿ï¼ˆè¶…é«˜é€ŸåŒ–ï¼š2ç§’ â†’ 50msï¼‰
        const pwaBaseUrl = 'https://reborn-inventory-system.pages.dev';
        const userName = localStorage.getItem('reborn_user_name') || '';
        const userEmail = localStorage.getItem('reborn_user_email') || '';
        const userIconUrl = localStorage.getItem('reborn_user_icon_url') || '';

        const params = new URLSearchParams({
          userName: userName,
          userEmail: userEmail,
          userIconUrl: userIconUrl,
          sessionId: sessionId
        });

        iframe.src = pwaBaseUrl + '/product.html?' + params.toString();
        document.getElementById('drawer-product').classList.add('active');

        // ç®¡ç†ç•ªå·è¨­å®šã®postMessageé€ä¿¡ã‚’å»ƒæ­¢ï¼ˆFirestoreç›´æ¥èª­ã¿è¾¼ã¿ã«çµ±ä¸€ï¼‰
        iframe.addEventListener('load', function sendManagementConfigToProduct() {
          console.log('ğŸ“¦ [PWA] product.htmlèª­ã¿è¾¼ã¿å®Œäº†');
        
          // ä»¥ä¸‹ã€GASçµŒç”±ã®postMessageé€ä¿¡ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼ˆ2025-11-19ï¼‰
          // ç†ç”±: product.html ãŒ Firestore ã‹ã‚‰ç›´æ¥èª­ã¿è¾¼ã‚€ãŸã‚ä¸è¦ï¼ˆé«˜é€ŸåŒ–ï¼‰
          /*
          if (window.managementConfigCache) {
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ â†’ å³åº§ã«é€ä¿¡
            console.log('ğŸ“¤ [PWA] ç®¡ç†ç•ªå·è¨­å®šã‚’postMessageé€ä¿¡: prefix="' + window.managementConfigCache.prefix + '"');
            iframe.contentWindow.postMessage({
              type: 'managementConfig',
              config: window.managementConfigCache
            }, pwaBaseUrl);
          } else if (window.managementConfigPreloading) {
            // ãƒ­ãƒ¼ãƒ‰ä¸­ â†’ å¾…æ©Ÿã—ã¦å†è©¦è¡Œ
            console.log('â³ [PWA] ç®¡ç†ç•ªå·è¨­å®šãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ä¸­... 3ç§’å¾Œã«å†è©¦è¡Œ');
            setTimeout(() => {
              if (window.managementConfigCache) {
                console.log('ğŸ“¤ [PWA] ç®¡ç†ç•ªå·è¨­å®šã‚’postMessageé€ä¿¡ï¼ˆé…å»¶ï¼‰: prefix="' + window.managementConfigCache.prefix + '"');
                iframe.contentWindow.postMessage({
                  type: 'managementConfig',
                  config: window.managementConfigCache
                }, pwaBaseUrl);
              } else {
                console.warn('âš ï¸ [PWA] ç®¡ç†ç•ªå·è¨­å®šãƒ—ãƒªãƒ­ãƒ¼ãƒ‰æœªå®Œäº†ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰');
              }
            }, 3000);
          } else {
            // æœªãƒ­ãƒ¼ãƒ‰ â†’ ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰é–‹å§‹ã—ã¦å¾…æ©Ÿ
            console.log('ğŸš€ [PWA] ç®¡ç†ç•ªå·è¨­å®šãƒ—ãƒªãƒ­ãƒ¼ãƒ‰é–‹å§‹ï¼ˆã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ï¼‰');
            preloadManagementConfigForPWA().then(() => {
              if (window.managementConfigCache) {
                console.log('ğŸ“¤ [PWA] ç®¡ç†ç•ªå·è¨­å®šã‚’postMessageé€ä¿¡ï¼ˆã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰å®Œäº†ï¼‰: prefix="' + window.managementConfigCache.prefix + '"');
                iframe.contentWindow.postMessage({
                  type: 'managementConfig',
                  config: window.managementConfigCache
                }, pwaBaseUrl);
              }
            });
          }
          */

          // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’1å›ã ã‘å®Ÿè¡Œ
          iframe.removeEventListener('load', sendManagementConfigToProduct);
        }, { once: true });
      } else if (page === 'config-basic') {
        // PWAç‰ˆè¨­å®šç®¡ç†ï¼ˆåŸºæœ¬è¨­å®šã‚¿ãƒ–ï¼‰ã‚’iframeã§é–‹ã
        iframe.src = '/config.html?tab=system&_cb=' + Date.now();
        document.getElementById('drawer-config-system').classList.add('active');
      } else if (page === 'config-product') {
        // PWAç‰ˆè¨­å®šç®¡ç†ã‚’iframeã§é–‹ãï¼ˆproduct.htmlã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
        iframe.src = '/config.html?tab=product&_cb=' + Date.now();
        document.getElementById('drawer-config-product').classList.add('active');
      } else if (page === 'config-system') {
        // PWAç‰ˆè¨­å®šç®¡ç†ã‚’iframeã§é–‹ãï¼ˆproduct.htmlã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
        iframe.src = '/config.html?tab=system&_cb=' + Date.now();
        document.getElementById('drawer-config-system').classList.add('active');
      } else if (page === 'config') {
        // Legacy support - default to basic
        iframe.src = baseUrl + '?menu=config&activeTab=basic' + fcmParam + securityParams + '&_cb=' + Date.now();
      } else if (page === 'inventory') {
        // PWAç‰ˆåœ¨åº«ç®¡ç†ã‚’ç›´æ¥èª­ã¿è¾¼ã¿ï¼ˆè¶…é«˜é€ŸåŒ–ï¼š2ç§’ â†’ 50msï¼‰
        const pwaBaseUrl = 'https://reborn-inventory-system.pages.dev';
        const userName = localStorage.getItem('reborn_user_name') || '';
        const userIconUrl = localStorage.getItem('reborn_user_icon_url') || '';

        const params = new URLSearchParams({
          userName: userName,
          userIconUrl: userIconUrl,
          sessionId: sessionId
        });

        iframe.src = pwaBaseUrl + '/inventory.html?' + params.toString();
        document.getElementById('drawer-inventory').classList.add('active');
      } else if (page === 'inventory_history') {
        // PWAç‰ˆå…¥å‡ºåº«å±¥æ­´ã‚’ç›´æ¥èª­ã¿è¾¼ã¿ï¼ˆè¶…é«˜é€ŸåŒ–ï¼š2ç§’ â†’ 50msï¼‰
        const pwaBaseUrl = 'https://reborn-inventory-system.pages.dev';
        const userName = localStorage.getItem('reborn_user_name') || '';
        const userIconUrl = localStorage.getItem('reborn_user_icon_url') || '';

        const params = new URLSearchParams({
          userName: userName,
          userIconUrl: userIconUrl,
          sessionId: sessionId
        });

        iframe.src = pwaBaseUrl + '/inventory_history.html?' + params.toString();
        document.getElementById('drawer-inventory-history').classList.add('active');
      } else if (page === 'chat') {
        // PWAç‰ˆãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚’ç›´æ¥èª­ã¿è¾¼ã¿ï¼ˆè¶…é«˜é€ŸåŒ–ï¼š2ç§’ â†’ 50msï¼‰
        const userName = localStorage.getItem('reborn_user_name') || '';
        const userEmail = localStorage.getItem('reborn_user_email') || '';
        const userIconUrl = localStorage.getItem('reborn_user_icon_url') || '';
        const fcmToken = localStorage.getItem('fcm_token') || '';

        const params = new URLSearchParams({
          app: 'pwa',
          userName: userName,
          userEmail: userEmail,
          userIconUrl: userIconUrl,
          fcmToken: fcmToken,
          parentOrigin: window.location.origin,
          pmToken: pmToken,
          sessionId: sessionId
        });

        iframe.src = '/chat_rooms_list.html?' + params.toString();
        document.getElementById('drawer-chat').classList.add('active');
      } else if (page === 'master-product') {
        // PWAç‰ˆãƒã‚¹ã‚¿ç®¡ç†ï¼ˆå•†å“é–¢é€£ï¼‰ã‚’iframeã«èª­ã¿è¾¼ã‚€
        const pwaBaseUrl = 'https://reborn-inventory-system.pages.dev';
        iframe.src = pwaBaseUrl + '/master-management.html?category=product' + sessionIdParam;
      } else if (page === 'master-business') {
        // PWAç‰ˆãƒã‚¹ã‚¿ç®¡ç†ï¼ˆæ¥­å‹™é–¢é€£ï¼‰ã‚’iframeã«èª­ã¿è¾¼ã‚€
        const pwaBaseUrl = 'https://reborn-inventory-system.pages.dev';
        iframe.src = pwaBaseUrl + '/master-management.html?category=business' + sessionIdParam;
      } else if (page === 'shipping-master') {
        // GASç‰ˆç™ºé€æ–¹æ³•ãƒã‚¹ã‚¿ç®¡ç†
        iframe.src = baseUrl + '?menu=shipping-master' + fcmParam + securityParams;
      } else if (page === 'packaging-master') {
        // GASç‰ˆæ¢±åŒ…è³‡æãƒã‚¹ã‚¿ç®¡ç†
        iframe.src = baseUrl + '?menu=packaging-master' + fcmParam + securityParams;
      }

      // FABè¡¨ç¤ºåˆ¶å¾¡ï¼ˆãƒãƒ£ãƒƒãƒˆä»¥å¤–ã¯è¡¨ç¤ºï¼‰
      if (page === 'chat') {
        hideChatFab();
      } else {
        showChatFab();
      }

      // UI-013: iframeèª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®å‡¦ç†ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°UXæ”¹å–„ï¼‰
      // ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIã‚’éè¡¨ç¤ºã«ã—ã€ãƒ˜ãƒƒãƒ€ãƒ¼è¡¨ç¤ºã‚’åˆ¶å¾¡
      if (iframe) {
        // æ—¢å­˜ã®loadã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
        iframe.removeEventListener('load', handlePageLoadComplete);

        // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
        function handlePageLoadComplete() {
          // ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬å®Œäº†
          const loadTime = performance.now() - startTime;
          console.log('âœ… ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†:', page);
          console.log(`ğŸ“Š å®Ÿéš›ã®èª­ã¿è¾¼ã¿æ™‚é–“: ${loadTime.toFixed(0)}ms`);

          // æ¡ˆD: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢ï¼ˆã‚¹ã‚±ãƒ«ãƒˆãƒ³UIè¡¨ç¤ºå‰ã«ãƒ­ãƒ¼ãƒ‰å®Œäº†ã—ãŸå ´åˆï¼‰
          if (skeletonTimeout) {
            clearTimeout(skeletonTimeout);
            console.log('âš¡ é«˜é€Ÿãƒ­ãƒ¼ãƒ‰ï¼ˆ300msä»¥å†…ï¼‰ - ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIè¡¨ç¤ºã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
          }

          if (skeleton) skeleton.classList.add('hidden');

          // ãƒ˜ãƒƒãƒ€ãƒ¼è¡¨ç¤ºåˆ¶å¾¡
          if (header) {
            if (page === 'home') {
              header.style.display = 'none'; // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã¯ãƒ˜ãƒƒãƒ€ãƒ¼éè¡¨ç¤º
            } else {
              header.style.display = 'flex'; // é€šå¸¸ãƒšãƒ¼ã‚¸ã¯ãƒ˜ãƒƒãƒ€ãƒ¼è¡¨ç¤º
            }
          }
        }

        iframe.addEventListener('load', handlePageLoadComplete, { once: true });
      }
    }

    // postMessageå—ä¿¡å‡¦ç†ï¼ˆGASã‹ã‚‰ã®é€šçŸ¥å—ä¿¡ï¼‰
    // ğŸ” originæ¤œè¨¼ã®ã¿ï¼ˆevent.sourceæ¯”è¼ƒãªã—ã€pmTokenæ¤œè¨¼ãªã—ï¼‰
    const ALLOWED_ORIGINS = new Set([
      'https://script.google.com'
    ]);

    function isAllowedOrigin(origin) {
      if (ALLOWED_ORIGINS.has(origin)) return true;
      try {
        const url = new URL(origin);
        return url.hostname.endsWith('.googleusercontent.com');
      } catch {
        return false;
      }
    }

    window.addEventListener('message', async function(event) {
      const iframe = document.getElementById('gas-iframe');
      const iframeWindow = iframe ? iframe.contentWindow : null;

      // iframeå†…ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã€è¨±å¯ã•ã‚ŒãŸoriginã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚’ç¢ºèª
      const isFromIframe = event.source === iframeWindow;
      const isFromAllowedOrigin = isAllowedOrigin(event.origin);

      console.log('[postMessage Debug] event.source === iframeWindow:', isFromIframe);
      console.log('[postMessage Debug] isAllowedOrigin:', isFromAllowedOrigin);
      console.log('[postMessage Debug] event.origin:', event.origin);

      if (!isFromIframe && !isFromAllowedOrigin) {
        console.warn('âš ï¸ [postMessage] ä¸æ­£ãªoriginã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ‹’å¦:', event.origin);
        return;
      }

      const data = event.data || {};
      console.log('ğŸ“¨ [postMessage] å—ä¿¡ (from', event.origin + '):', data);

      console.log('ğŸ“¨ å—ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (from', event.origin + '):', data);

      // ãƒãƒ£ãƒƒãƒˆä¸€è¦§ã«æˆ»ã‚‹è¦æ±‚ã®å‡¦ç†
      if (data.type === 'showChatRoomsList') {
        console.log('========================================');
        console.log('ğŸ”™ [postMessage] ãƒãƒ£ãƒƒãƒˆä¸€è¦§ã«æˆ»ã‚‹è¦æ±‚ã‚’å—ä¿¡');
        console.log('[postMessage] data:', data);
        console.log('[postMessage] openChatRooms é–¢æ•°å‘¼ã³å‡ºã—é–‹å§‹');
        console.log('========================================');
        openChatRooms();
        console.log('[postMessage] âœ… openChatRooms å‘¼ã³å‡ºã—å®Œäº†');
        return;
      }

      // ãƒšãƒ¼ã‚¸é·ç§»è¦æ±‚ã®å‡¦ç†ï¼ˆãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³é·ç§»ï¼‰
      if (data.type === 'navigateTo') {
        console.log('========================================');
        console.log('ğŸ”€ [postMessage] navigateTo è¦æ±‚ã‚’å—ä¿¡');
        console.log('[postMessage] url:', data.url);
        console.log('[postMessage] ç¾åœ¨ã®URL:', window.location.href);
        console.log('========================================');

        if (data.url) {
          console.log('[postMessage] ãƒšãƒ¼ã‚¸é·ç§»ã‚’å®Ÿè¡Œã—ã¾ã™:', data.url);
          window.location.href = data.url;
          console.log('[postMessage] âœ… window.location.hrefè¨­å®šå®Œäº†');
        } else {
          console.error('[postMessage] âŒ URLãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        }
        return;
      }

      // ãƒˆãƒƒãƒ—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹è¦æ±‚ã®å‡¦ç†ï¼ˆå‰Šé™¤: æ—©æœŸç™»éŒ²ãƒªã‚¹ãƒŠãƒ¼ã¨é‡è¤‡ï¼‰
      // æ—©æœŸç™»éŒ²ãƒªã‚¹ãƒŠãƒ¼ï¼ˆè¡Œ935-954ï¼‰ã§å‡¦ç†ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä¸è¦

      if (data.type === 'navigateToChat') {
        console.log('========================================');
        console.log('ğŸ’¬ [postMessage] ãƒˆãƒ¼ã‚¯ä¸€è¦§ã«æˆ»ã‚‹è¦æ±‚ã‚’å—ä¿¡');
        console.log('========================================');
        if (typeof navigateToPage === 'function') {
          navigateToPage('chat');
          console.log('[postMessage] âœ… navigateToPage(\'chat\')å‘¼ã³å‡ºã—å®Œäº†ï¼ˆ200msé…å»¶ãƒ¢ãƒ¼ãƒ‰ï¼‰');
        } else {
          console.error('[postMessage] âŒ navigateToPage()ãŒæœªå®šç¾©');
        }
        return;
      }

      // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¦æ±‚ã®å‡¦ç†ï¼ˆiframeå†…é·ç§»ï¼‰
      if (data.type === 'navigate') {
        const iframe = document.getElementById('gas-iframe');

        // URLãŒç›´æ¥æŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆå¾“æ¥ã®æ–¹æ³•ï¼‰
        if (data.url) {
          console.log('ğŸš€ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³:', data.url);
          iframe.src = data.url;
        }
        // pageæŒ‡å®šã®å ´åˆï¼ˆãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ç­‰ï¼‰
        else if (data.page) {
          const page = data.page;
          const roomId = data.roomId || '';
          const userName = data.userName || localStorage.getItem('reborn_user_name') || '';
          const userEmail = localStorage.getItem('reborn_user_email') || '';
          const fcmToken = localStorage.getItem('fcm_token') || '';

          console.log('ğŸš€ ãƒšãƒ¼ã‚¸é·ç§»:', page, 'roomId:', roomId);

          // ãƒãƒ£ãƒƒãƒˆç”»é¢ã¸ã®é·ç§»
          if (page === 'chat') {
            // PWAç‰ˆãƒãƒ£ãƒƒãƒˆUIã‚’ç›´æ¥èª­ã¿è¾¼ã¿ï¼ˆè¶…é«˜é€ŸåŒ–ï¼š2ç§’ â†’ 50msï¼‰
            const sessionId = sessionStorage.getItem('device_session_id');
            const userIconUrl = localStorage.getItem('reborn_user_icon_url') || '';

            const params = new URLSearchParams({
              userName: userName,
              userEmail: userEmail,
              userIconUrl: userIconUrl,
              roomId: roomId,
              sessionId: sessionId
            });
            const url = '/chat_ui_firestore.html?' + params.toString();
            console.log('ğŸš€ PWAç‰ˆãƒãƒ£ãƒƒãƒˆUI URL:', url);
            iframe.src = url;

            // ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’é–‹ã„ãŸã®ã§FABã‚’éè¡¨ç¤º
            hideChatFab();
          }
        }
      }

      // ğŸ”” Service Workerã‹ã‚‰ã®ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒãƒƒã‚¸æ›´æ–°è¦æ±‚
      if (event.data.type === 'INCREMENT_SYSTEM_UNREAD') {
        console.log('[Badge] Service Workerã‹ã‚‰ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒãƒƒã‚¸æ›´æ–°è¦æ±‚');
        // ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ã®Firestore unreadCountã‚’+1
        incrementSystemNotificationUnreadCount();
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°è¦æ±‚ã®å‡¦ç†
      if (event.data.type === 'UPDATE_USER_ICON') {
        console.log('ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°:', event.data.iconUrl ? 'ç”»åƒã‚ã‚Š' : 'ç”»åƒãªã—');
        updateUserIcon(event.data.iconUrl);
      }

      // ğŸ“¢ ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ æŠ•ç¨¿ï¼ˆçµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼‰
      // Webhookæ–¹å¼ã«ç§»è¡Œã—ãŸãŸã‚ã€postMessageã«ã‚ˆã‚‹é€šçŸ¥å—ä¿¡ã¯ä¸è¦
      // GAS â†’ Cloudflare Worker â†’ Firestore + FCM ã§å®Œçµ
    });

    // ğŸ”• æ—§ãƒ™ãƒ«ãƒãƒ¼ã‚¯é€šçŸ¥ãƒãƒƒã‚¸æ©Ÿèƒ½ï¼ˆç„¡åŠ¹åŒ– - çµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼‰
    // çµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã¯ã€ãƒãƒ£ãƒƒãƒˆãƒãƒƒã‚¸ã«çµ±åˆ
    // ãƒãƒƒã‚¸ã¯Firestoreã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰è‡ªå‹•æ›´æ–°
    /*
    let badgeCount = 0;

    // ãƒãƒƒã‚¸ã‚«ã‚¦ãƒ³ãƒˆã‚’åˆæœŸåŒ–ï¼ˆlocalStorage ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
    function initBadge() {
      const saved = localStorage.getItem('reborn-badge-count');
      badgeCount = saved ? parseInt(saved, 10) : 0;
      updateBadgeDisplay();
      updateAppBadge();
    }

    // ãƒãƒƒã‚¸ã‚’å¢—ã‚„ã™
    function incrementBadge() {
      badgeCount++;
      localStorage.setItem('reborn-badge-count', badgeCount);
      updateBadgeDisplay();
      updateAppBadge();
      console.log('ğŸ”” ãƒãƒƒã‚¸ã‚«ã‚¦ãƒ³ãƒˆ +1:', badgeCount);
    }

    // ãƒãƒƒã‚¸ã‚’ã‚¯ãƒªã‚¢
    function clearBadge() {
      badgeCount = 0;
      localStorage.setItem('reborn-badge-count', 0);
      updateBadgeDisplay();
      updateAppBadge();
      console.log('ğŸ”” ãƒãƒƒã‚¸ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢');
    }

    // ãƒãƒƒã‚¸è¡¨ç¤ºã‚’æ›´æ–°
    function updateBadgeDisplay() {
      const badgeElement = document.getElementById('badge-count');
      if (badgeElement) {
        badgeElement.textContent = badgeCount;
        if (badgeCount > 0) {
          badgeElement.classList.add('active');
        } else {
          badgeElement.classList.remove('active');
        }
      }
    }
    */

    // App Badge API ã‚’æ›´æ–°ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ã®ãƒãƒƒã‚¸ï¼‰
    // çµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼šãƒãƒ£ãƒƒãƒˆæœªèª­ã®ã¿è¡¨ç¤º
    function updateAppBadge() {
      if ('setAppBadge' in navigator) {
        if (chatUnreadCount > 0) {
          navigator.setAppBadge(chatUnreadCount).catch(err => {
            console.error('âŒ Badge API ã‚¨ãƒ©ãƒ¼:', err);
          });
          console.log('ğŸ“± ã‚¢ãƒ—ãƒªãƒãƒƒã‚¸æ›´æ–°:', chatUnreadCount);
        } else {
          navigator.clearAppBadge().catch(err => {
            console.error('âŒ Badge API ã‚¨ãƒ©ãƒ¼:', err);
          });
          console.log('ğŸ“± ã‚¢ãƒ—ãƒªãƒãƒƒã‚¸ã‚¯ãƒªã‚¢');
        }
      }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚’é–‹ã
    function openUserSettings() {
      navigateToPage('config-basic');
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
    function loadUserIcon() {
      const iconUrl = localStorage.getItem('user_icon_url');
      const iconImage = document.getElementById('user-icon-image');
      const iconPlaceholder = document.getElementById('user-icon-placeholder');

      if (iconUrl) {
        // ã‚¢ã‚¤ã‚³ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç”»åƒã‚’è¡¨ç¤º
        iconImage.src = iconUrl;
        iconImage.style.display = 'block';
        iconPlaceholder.style.display = 'none';

        // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¡¨ç¤º
        iconImage.onerror = function() {
          console.warn('âš ï¸ ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã®èª­ã¿è¾¼ã¿å¤±æ•—:', iconUrl);
          iconImage.style.display = 'none';
          iconPlaceholder.style.display = 'block';
        };
      } else {
        // ã‚¢ã‚¤ã‚³ãƒ³ãŒæœªè¨­å®šã®å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¡¨ç¤º
        iconImage.style.display = 'none';
        iconPlaceholder.style.display = 'block';
      }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
    function updateUserIcon(iconUrl) {
      if (iconUrl) {
        localStorage.setItem('reborn_user_icon', iconUrl);
      } else {
        localStorage.removeItem('reborn_user_icon');
      }
      loadUserIcon();
    }

    // ã‚¢ãƒ—ãƒªå†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã®Firestoreã‚¢ã‚¤ã‚³ãƒ³ã‚¯ãƒªã‚¢
    async function clearFirestoreUserIconIfNeeded() {
      try {
        // localStorageã«ã‚¢ã‚¤ã‚³ãƒ³ãŒãªã„ ã‹ã¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒã‚ã‚‹å ´åˆ
        const userIcon = localStorage.getItem('reborn_user_icon');
        const userName = localStorage.getItem('reborn_user_name');

        if (!userIcon && userName) {
          console.log('[Icon Init] ğŸ”„ ã‚¢ã‚¤ã‚³ãƒ³åˆæœŸåŒ–: localStorageã«ã‚¢ã‚¤ã‚³ãƒ³ãªã—ã€Firestoreã‚’ã‚¯ãƒªã‚¢');

          // FirebaseåˆæœŸåŒ–
          const { initializeApp, getApps } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
          const { getFirestore, doc, getDoc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

          const firebaseConfig = {
            apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
            authDomain: "reborn-chat.firebaseapp.com",
            projectId: "reborn-chat",
            storageBucket: "reborn-chat.firebasestorage.app",
            messagingSenderId: "345706548795",
            appId: "1:345706548795:web:058a553da6b4b74db5161e"
          };

          const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig, 'icon-clear-app');
          const db = getFirestore(app);

          // Firestoreã®usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºèª
          const userRef = doc(db, 'users', userName);
          const userDoc = await getDoc(userRef);

          if (userDoc.exists()) {
            const userData = userDoc.data();
            if (userData.userIconUrl) {
              // ã‚¢ã‚¤ã‚³ãƒ³URLãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ã‚¯ãƒªã‚¢
              await updateDoc(userRef, {
                userIconUrl: ''
              });
              console.log('[Icon Init] âœ… Firestoreã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ:', userName);
            } else {
              console.log('[Icon Init] â„¹ï¸ Firestoreã«ã‚¢ã‚¤ã‚³ãƒ³ãªã—ï¼ˆã‚¯ãƒªã‚¢ä¸è¦ï¼‰:', userName);
            }
          } else {
            console.log('[Icon Init] â„¹ï¸ Firestoreã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæœªå­˜åœ¨:', userName);
          }
        } else {
          console.log('[Icon Init] â„¹ï¸ ã‚¢ã‚¤ã‚³ãƒ³åˆæœŸåŒ–ã‚¹ã‚­ãƒƒãƒ—:', {
            hasIcon: !!userIcon,
            hasUserName: !!userName
          });
        }
      } catch (error) {
        console.error('[Icon Init] âŒ ã‚¢ã‚¤ã‚³ãƒ³åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã‚¢ãƒ—ãƒªã®èµ·å‹•ã‚’å¦¨ã’ãªã„
      }
    }

    // é€šçŸ¥ãƒšãƒ¼ã‚¸ã‚’é–‹ãï¼ˆPWAå†…ã§é·ç§»ï¼‰
    function openNotifications() {
      window.location.href = '/notifications.html';
    }

    // çµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼šService Workerã‹ã‚‰ã®ãƒãƒƒã‚¸æ›´æ–°ã¯ä¸è¦
    /*
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('message', (event) => {
        console.log('ğŸ“¨ Service Workerã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', event.data);

        if (event.data.type === 'INCREMENT_BADGE') {
          incrementBadge();
        }
      });
    }
    */

    // ========================================
    // ãƒãƒ£ãƒƒãƒˆFABæ©Ÿèƒ½
    // ========================================

    // ãƒãƒ£ãƒƒãƒˆä¸€è¦§ã‚’é–‹ã
    function openChatRooms() {
      console.log('[Chat FAB] ãƒãƒ£ãƒƒãƒˆä¸€è¦§ã‚’é–‹ã');

      const userName = localStorage.getItem('reborn_user_name') || '';
      const userEmail = localStorage.getItem('reborn_user_email') || '';
      const fcmToken = localStorage.getItem('fcm_token') || '';
      const sessionId = sessionStorage.getItem('device_session_id');

      // pmTokenç”Ÿæˆ
      const pmToken = generatePmToken();
      localStorage.setItem('pm_token', pmToken);

      // PWAç‰ˆã§ã¯ chat_rooms_list.html ã‚’ç›´æ¥é–‹ã
      const params = new URLSearchParams({
        app: 'pwa',
        userName: userName,
        userEmail: userEmail,
        fcmToken: fcmToken,
        parentOrigin: window.location.origin,
        pmToken: pmToken,
        sessionId: sessionId
      });

      const iframe = document.getElementById('gas-iframe');
      iframe.src = `/chat_rooms_list.html?${params.toString()}`;

      // ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’é–‹ã„ãŸã®ã§FABã‚’éè¡¨ç¤º
      hideChatFab();
    }

    // FABè¡¨ç¤ºåˆ¶å¾¡
    function showChatFab() {
      const fab = document.getElementById('chat-fab');
      if (fab) {
        fab.classList.remove('hidden');
      }
    }

    function hideChatFab() {
      const fab = document.getElementById('chat-fab');
      if (fab) {
        fab.classList.add('hidden');
      }
    }

    // çµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼šFABã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆä¸è¦ï¼ˆä¸Šéƒ¨ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ã«çµ±åˆï¼‰

    // æœªèª­ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°ï¼ˆFirebaseçµŒç”±ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼‰
    let chatUnreadCount = 0;

    function updateChatBadge(count) {
      console.log('[Chat Badge] ãƒãƒƒã‚¸æ›´æ–°:', count);
      chatUnreadCount = count;

      const badge = document.getElementById('chat-badge-count');
      if (badge) {
        if (count > 0) {
          badge.textContent = count > 99 ? '99+' : count.toString();
          badge.classList.add('active');
        } else {
          badge.textContent = '0';
          badge.classList.remove('active');
        }
      }

      // ã‚¢ãƒ—ãƒªã‚¢ã‚¤ã‚³ãƒ³ãƒãƒƒã‚¸ã‚‚æ›´æ–°ï¼ˆãƒãƒ£ãƒƒãƒˆæœªèª­ã®ã¿ï¼‰
      updateAppBadge();
    }

    // ğŸ”§ Firebaseå…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆã‚¢ãƒ—ãƒªé‡è¤‡åˆæœŸåŒ–é˜²æ­¢ï¼‰
    let _firebaseApp, _firestoreDb;
    async function getFirebaseDb() {
      if (_firestoreDb) return _firestoreDb;

      const { initializeApp, getApps } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
      const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

      const firebaseConfig = {
        apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
        authDomain: "reborn-chat.firebaseapp.com",
        projectId: "reborn-chat",
        storageBucket: "reborn-chat.firebasestorage.app",
        messagingSenderId: "345706548795",
        appId: "1:345706548795:web:058a553da6b4b74db5161e"
      };

      _firebaseApp = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
      _firestoreDb = getFirestore(_firebaseApp);
      console.log('[Firebase] å…±é€šã‚¢ãƒ—ãƒªåˆæœŸåŒ–å®Œäº†');
      return _firestoreDb;
    }

    // Firestoreæœªèª­ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚¹ãƒ‹ãƒ³ã‚°
    async function startChatUnreadListener() {
      console.log('[Chat FAB] æœªèª­ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚¹ãƒ‹ãƒ³ã‚°é–‹å§‹');

      try {
        const userName = localStorage.getItem('reborn_user_name');
        const userEmail = localStorage.getItem('reborn_user_email');
        if (!userName || !userEmail) {
          console.log('[Chat FAB] ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±æœªè¨­å®šã®ãŸã‚ãƒªã‚¹ãƒ‹ãƒ³ã‚°ä¸­æ–­');
          return;
        }

        // Firebase SDKã‚’å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
        const { getFirestore, collection, doc, query, where, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        // Firebaseè¨­å®šï¼ˆreborn-chat ã«çµ±ä¸€ï¼‰
        const firebaseConfig = {
          apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
          authDomain: "reborn-chat.firebaseapp.com",
          projectId: "reborn-chat",
          storageBucket: "reborn-chat.firebasestorage.app",
          messagingSenderId: "345706548795",
          appId: "1:345706548795:web:058a553da6b4b74db5161e"
        };

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig, 'chat-fab-app');
        const db = getFirestore(app);
        console.log('[Chat FAB] FirebaseåˆæœŸåŒ–å®Œäº†');

        // æœªèª­ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’åˆæœŸåŒ–
        if (!window.chatUnreadByRoom) window.chatUnreadByRoom = {};

        // æœªèª­ã‚«ã‚¦ãƒ³ãƒˆåˆè¨ˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateTotalUnread() {
          const totalUnread = Object.values(window.chatUnreadByRoom).reduce((sum, count) => sum + count, 0);
          console.log('[Chat FAB] æœªèª­ã‚«ã‚¦ãƒ³ãƒˆåˆè¨ˆ:', totalUnread, window.chatUnreadByRoom);
          updateChatBadge(totalUnread);
        }

        // ã€ãƒªã‚¹ãƒŠãƒ¼1ã€‘è‡ªåˆ†ãŒå‚åŠ ã—ã¦ã„ã‚‹é€šå¸¸ãƒ«ãƒ¼ãƒ ã‚’å–å¾—
        const roomsQuery = query(
          collection(db, 'rooms'),
          where('members', 'array-contains', userName)
        );

        onSnapshot(roomsQuery, (roomsSnapshot) => {
          console.log('[Chat FAB] é€šå¸¸ãƒ«ãƒ¼ãƒ æ•°:', roomsSnapshot.size);

          // å„ãƒ«ãƒ¼ãƒ ã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚’å–å¾—
          roomsSnapshot.forEach((roomDoc) => {
            const roomId = roomDoc.id;
            const unreadDocRef = doc(db, `rooms/${roomId}/unreadCounts/${userEmail}`);

            // å„ãƒ«ãƒ¼ãƒ ã®æœªèª­ã‚’ãƒªã‚¹ãƒ‹ãƒ³ã‚°
            onSnapshot(unreadDocRef, (unreadDoc) => {
              const unreadData = unreadDoc.data();
              const unreadCount = unreadData?.unreadCount || 0;

              // ã“ã®ãƒ«ãƒ¼ãƒ ã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚’è¨˜éŒ²
              window.chatUnreadByRoom[roomId] = unreadCount;
              console.log(`[Chat FAB] ${roomId} æœªèª­:`, unreadCount);

              // å…¨ãƒ«ãƒ¼ãƒ ã®æœªèª­ã‚’åˆè¨ˆã—ã¦æ›´æ–°
              updateTotalUnread();
            }, (error) => {
              console.error('[Chat FAB] ãƒ«ãƒ¼ãƒ ', roomId, 'ã®æœªèª­å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            });
          });
        }, (error) => {
          console.error('[Chat FAB] ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        });

        // ã€ãƒªã‚¹ãƒŠãƒ¼2ã€‘ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒ ï¼ˆå…¨ä½“ãƒ»ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ï¼‰ã‚’ç›´æ¥ãƒªã‚¹ãƒ‹ãƒ³ã‚°
        const defaultRoomIds = ['room_default_all', 'system'];

        defaultRoomIds.forEach((roomId) => {
          const unreadDocRef = doc(db, `rooms/${roomId}/unreadCounts/${userEmail}`);

          onSnapshot(unreadDocRef, (unreadDoc) => {
            const unreadData = unreadDoc.data();
            const unreadCount = unreadData?.unreadCount || 0;

            // ã“ã®ãƒ«ãƒ¼ãƒ ã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚’è¨˜éŒ²
            window.chatUnreadByRoom[roomId] = unreadCount;
            console.log(`[Chat FAB] ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒ  ${roomId} æœªèª­:`, unreadCount);

            // å…¨ãƒ«ãƒ¼ãƒ ã®æœªèª­ã‚’åˆè¨ˆã—ã¦æ›´æ–°
            updateTotalUnread();
          }, (error) => {
            console.log(`[Chat FAB] ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒ  ${roomId} æœªèª­å–å¾—:`, error.message, '(ãƒ«ãƒ¼ãƒ æœªä½œæˆã®å¯èƒ½æ€§)');
          });
        });

      } catch (error) {
        console.error('[Chat FAB] åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ã®è‡ªå‹•ä½œæˆ
    async function initializeSystemNotificationRoom() {
      console.log('[System Room] ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ åˆæœŸåŒ–é–‹å§‹');

      try {
        // Firebase SDKã‚’å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
        const { getFirestore, doc, getDoc, setDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        // Firebaseè¨­å®šï¼ˆreborn-chat ã«çµ±ä¸€ï¼‰
        const firebaseConfig = {
          apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
          authDomain: "reborn-chat.firebaseapp.com",
          projectId: "reborn-chat",
          storageBucket: "reborn-chat.firebasestorage.app",
          messagingSenderId: "345706548795",
          appId: "1:345706548795:web:058a553da6b4b74db5161e"
        };

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig, 'system-room-init');
        const db = getFirestore(app);

        const systemRoomId = 'system';
        const systemRoomRef = doc(db, 'rooms', systemRoomId);

        // æ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
        const roomSnap = await getDoc(systemRoomRef);

        if (!roomSnap.exists()) {
          // ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ
          await setDoc(systemRoomRef, {
            roomId: systemRoomId,
            name: 'ğŸ“¢ ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥',
            type: 'system',
            icon: 'ğŸ“¢',
            members: [], // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
            createdBy: 'ã‚·ã‚¹ãƒ†ãƒ ',
            createdAt: serverTimestamp(),
            lastMessage: 'ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã—ãŸ',
            lastMessageAt: serverTimestamp(),
            lastMessageBy: 'ã‚·ã‚¹ãƒ†ãƒ '
          });

          console.log('[System Room] ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã—ãŸ');
        } else {
          // æ—¢å­˜ãƒ«ãƒ¼ãƒ ã«nameãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒç„¡ã„å ´åˆã¯è¿½åŠ ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
          const roomData = roomSnap.data();
          if (!roomData.name) {
            await setDoc(systemRoomRef, {
              name: 'ğŸ“¢ ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥',
              type: 'system',
              icon: 'ğŸ“¢'
            }, { merge: true });
            console.log('[System Room] ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ åã‚’æ›´æ–°ã—ã¾ã—ãŸ');
          } else {
            console.log('[System Room] ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');
          }
        }

      } catch (error) {
        console.error('[System Room] åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚’+1ã™ã‚‹é–¢æ•°
    async function incrementSystemNotificationUnreadCount() {
      console.log('[Badge] ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆ+1é–‹å§‹');

      const userName = localStorage.getItem('reborn_user_name');
      const userEmail = localStorage.getItem('reborn_user_email');
      if (!userName || !userEmail) {
        console.error('[Badge] ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“');
        return;
      }

      try {
        // å…±é€šFirebaseã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—ï¼ˆé‡è¤‡åˆæœŸåŒ–é˜²æ­¢ï¼‰
        const db = await getFirebaseDb();
        const { doc, setDoc, increment } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        const systemRoomId = 'system';
        const unreadDocRef = doc(db, `rooms/${systemRoomId}/unreadCounts/${userEmail}`);

        // Firestore unreadCountã‚’+1ï¼ˆã‚¢ãƒˆãƒŸãƒƒã‚¯æ“ä½œï¼‰
        await setDoc(unreadDocRef, {
          unreadCount: increment(1)
        }, { merge: true });

        console.log('[Badge] Firestore unreadCount +1 å®Œäº†');

      } catch (error) {
        console.error('[Badge] Firestoreæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã€Œå…¨ä½“ã€ãƒ«ãƒ¼ãƒ ã®è‡ªå‹•ä½œæˆï¼ˆå‰Šé™¤ã•ã‚Œã¦ã‚‚å†ä½œæˆï¼‰
    async function initializeDefaultRoom() {
      console.log('[Default Room] å…¨ä½“ãƒ«ãƒ¼ãƒ åˆæœŸåŒ–é–‹å§‹');

      try {
        // Firebase SDKã‚’å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
        const { getFirestore, doc, getDoc, setDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        // Firebaseè¨­å®šï¼ˆreborn-chat ã«çµ±ä¸€ï¼‰
        const firebaseConfig = {
          apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
          authDomain: "reborn-chat.firebaseapp.com",
          projectId: "reborn-chat",
          storageBucket: "reborn-chat.firebasestorage.app",
          messagingSenderId: "345706548795",
          appId: "1:345706548795:web:058a553da6b4b74db5161e"
        };

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig, 'default-room-init');
        const db = getFirestore(app);

        const defaultRoomId = 'room_default_all';
        const defaultRoomRef = doc(db, 'rooms', defaultRoomId);

        // æ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
        const roomSnap = await getDoc(defaultRoomRef);

        if (!roomSnap.exists()) {
          // å…¨ä½“ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ
          await setDoc(defaultRoomRef, {
            roomId: defaultRoomId,
            name: 'ğŸ’¬ å…¨ä½“',
            type: 'default',
            icon: 'ğŸ’¬',
            members: [], // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
            createdBy: 'ã‚·ã‚¹ãƒ†ãƒ ',
            createdAt: serverTimestamp(),
            lastMessage: 'å…¨ä½“ãƒ«ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã—ãŸ',
            lastMessageAt: serverTimestamp(),
            lastMessageBy: 'ã‚·ã‚¹ãƒ†ãƒ '
          });

          console.log('[Default Room] å…¨ä½“ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã—ãŸ');
        } else {
          console.log('[Default Room] å…¨ä½“ãƒ«ãƒ¼ãƒ ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');
        }

      } catch (error) {
        console.error('[Default Room] åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ğŸ—‘ï¸ postSystemNotificationé–¢æ•°ã¯å‰Šé™¤ï¼ˆFirebase Functions v2ã§å‡¦ç†ã€GASç‰ˆä¸ä½¿ç”¨ã®ãŸã‚ï¼‰
    // ä»¥å‰ã¯GASç‰ˆã§ä½¿ç”¨ã—ã¦ã„ãŸãŒã€ç¾åœ¨ã¯Firebase FunctionsãŒå…¨ã¦å‡¦ç†

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[Chat FAB] DOMContentLoaded - ãƒªã‚¹ãƒŠãƒ¼é–‹å§‹');

      // postMessageãƒªã‚¹ãƒŠãƒ¼ã¯æ—¢ã«è¡Œ1502ã§ç™»éŒ²æ¸ˆã¿ï¼ˆPRODUCT_REGISTEREDå‡¦ç†ã‚’è¿½åŠ æ¸ˆã¿ï¼‰

      initializeSystemNotificationRoom(); // ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ä½œæˆ
      initializeDefaultRoom(); // å…¨ä½“ãƒ«ãƒ¼ãƒ ä½œæˆ
      startChatUnreadListener();
    });

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã‚‚å®Ÿè¡Œï¼ˆå¿µã®ãŸã‚ï¼‰
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        console.log('[Chat FAB] DOMContentLoaded - ãƒªã‚¹ãƒŠãƒ¼é–‹å§‹');
        startChatUnreadListener();
      });
    } else {
      console.log('[Chat FAB] ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ¸ˆã¿ - ãƒªã‚¹ãƒŠãƒ¼å³æ™‚èµ·å‹•');
      startChatUnreadListener();
    }
  </script>

  <!-- ãƒãƒ£ãƒƒãƒˆFABå‰Šé™¤ï¼ˆçµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼šä¸Šéƒ¨ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ã«çµ±åˆï¼‰ -->

  <!-- ãƒãƒ£ãƒƒãƒˆFABãƒªã‚¹ãƒŠãƒ¼ï¼ˆç‹¬ç«‹scriptãƒ–ãƒ­ãƒƒã‚¯ï¼‰ -->
  <script>
    (function() {
      console.log('[Chat FAB] ç‹¬ç«‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯å®Ÿè¡Œé–‹å§‹');

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«å®Ÿè¡Œ
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initChatFAB);
      } else {
        initChatFAB();
      }

      function initChatFAB() {
        console.log('[Chat FAB] åˆæœŸåŒ–é–‹å§‹ - readyState:', document.readyState);

        if (typeof startChatUnreadListener === 'function') {
          console.log('[Chat FAB] startChatUnreadListeneré–¢æ•°ã‚’æ¤œå‡º - å®Ÿè¡Œ');
          startChatUnreadListener();
        } else {
          console.error('[Chat FAB] startChatUnreadListeneré–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
      }
    })();
  </script>

  <!-- Master Background Preload (ãƒ–ãƒ©ãƒ³ãƒ‰ï¼‹ã‚«ãƒ†ã‚´ãƒª) ã¯ master-cache.js å†…ã§è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™ -->
</body>
</html>
