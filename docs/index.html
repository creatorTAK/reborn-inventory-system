<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="REBORN">
  <title>REBORN åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">

  <!-- PWA Icons -->
  <link rel="apple-touch-icon" href="icon-180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

  <!-- Performance: ãƒ—ãƒªã‚³ãƒã‚¯ãƒˆï¼ˆDNSè§£æ±ºãƒ»TCPãƒ»TLSæ¥ç¶šã‚’å…ˆè¡Œå®Ÿè¡Œï¼‰ -->
  <link rel="dns-prefetch" href="https://script.google.com">
  <link rel="dns-prefetch" href="https://www.gstatic.com">
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>

  <!-- GAS Web App URLï¼ˆå…¨iframeå­ãƒšãƒ¼ã‚¸ã‹ã‚‰å‚ç…§å¯èƒ½ï¼‰ -->
  <script>
    window.REBORN_CONFIG = {
      GAS_BASE_URL: "https://script.google.com/macros/s/AKfycbx6ybbRLDqKQJ8IR-NPoVP8981Gtozzz0N3880XanEGRS4--iZtset8PFrVcD_u9YAHMA/exec"
    };
  </script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body, html {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    /* ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ */
    #setup-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow-y: scroll;
      -webkit-overflow-scrolling: touch;
      display: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      box-sizing: border-box;
      z-index: 9999;
    }

    .setup-container {
      background: white;
      border-radius: 16px;
      padding: 24px;
      padding-bottom: 40px;
      max-width: 500px;
      width: 100%;
      margin: 20px auto;
      margin-bottom: 60px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      box-sizing: border-box;
      min-height: fit-content;
    }

    .setup-title {
      color: #667eea;
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      text-align: center;
    }

    .setup-subtitle {
      color: #6b7280;
      font-size: 14px;
      text-align: center;
      margin-bottom: 24px;
    }

    .step-section {
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .step-number {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      text-align: center;
      line-height: 24px;
      font-size: 14px;
      font-weight: 600;
      margin-right: 8px;
    }

    .step-title {
      display: inline;
      font-weight: 600;
      color: #1f2937;
      font-size: 16px;
    }

    .step-button {
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
      transition: transform 0.2s;
    }

    .step-button:hover {
      transform: translateY(-2px);
    }

    .step-button:active {
      transform: translateY(0);
    }

    .step-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .step-button.success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .step-button.optional {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .step-result {
      margin-top: 12px;
      padding: 12px;
      background: white;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      font-size: 13px;
      color: #374151;
      white-space: pre-wrap;
      display: none;
    }

    .step-result.success {
      background: #f0fdf4;
      border-color: #22c55e;
      color: #15803d;
      display: block;
    }

    .step-result.error {
      background: #fef2f2;
      border-color: #ef4444;
      color: #dc2626;
      display: block;
    }

    .open-app-button {
      width: 100%;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 16px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 24px;
      transition: transform 0.2s;
      display: none;
    }

    .open-app-button:hover {
      transform: translateY(-2px);
    }

    .open-app-button:active {
      transform: translateY(0);
    }

    /* ã‚¢ãƒ—ãƒªç”»é¢ */
    #app-screen {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆé€šçŸ¥ï¼‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ä»˜ãï¼‰ */
    #app-header {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .app-title {
      color: white;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .app-title:hover {
      opacity: 0.8;
    }

    .app-title:active {
      opacity: 0.6;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼å³å´ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— */
    .header-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* é€šçŸ¥ãƒãƒƒã‚¸ãƒœã‚¿ãƒ³ */
    .notification-button {
      position: relative;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .notification-button:active {
      transform: scale(0.95);
    }

    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆâ˜°ï¼‰ */
    .menu-button {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
      border-radius: 8px;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s;
      color: white;
      font-size: 24px;
      font-weight: 300;
    }

    .menu-button:active {
      transform: scale(0.95);
    }

    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³ */
    .user-icon-button {
      position: relative;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s;
      overflow: hidden;
      padding: 0;
    }

    .user-icon-button:active {
      transform: scale(0.95);
    }

    .user-icon-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .user-icon-placeholder {
      font-size: 24px;
      color: white;
    }

    /* ãƒ‰ãƒ­ãƒ¯ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆèƒŒæ™¯æš—è»¢ï¼‰ */
    #drawer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    #drawer-overlay.active {
      display: block;
      opacity: 1;
    }

    /* ãƒ‰ãƒ­ãƒ¯ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    #drawer-menu {
      position: fixed;
      top: 0;
      right: -280px;
      width: 280px;
      height: 100%;
      background: white;
      z-index: 2000;
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.2);
      transition: right 0.3s ease;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    #drawer-menu.active {
      right: 0;
    }

    .drawer-header {
      padding: 20px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 20px;
      font-weight: 600;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .drawer-item {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 16px;
      color: #1f2937;
      text-decoration: none;
      border-bottom: 1px solid #e5e7eb;
      transition: background 0.2s;
    }

    .drawer-item:hover {
      background: #f3f4f6;
    }

    .drawer-item.active {
      background: #ede9fe;
      color: #667eea;
      font-weight: 600;
    }

    .drawer-item.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    .drawer-accordion {
      margin: 0;
    }

    .drawer-accordion-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      color: #374151;
      font-size: 15px;
      text-decoration: none;
      cursor: pointer;
      transition: background 0.2s;
    }

    .drawer-accordion-header:hover {
      background: #f3f4f6;
    }

    .drawer-accordion-arrow {
      transition: transform 0.3s;
      font-size: 12px;
    }

    .drawer-accordion.open .drawer-accordion-arrow {
      transform: rotate(180deg);
    }

    .drawer-accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .drawer-accordion.open .drawer-accordion-content {
      max-height: 500px;
    }

    .drawer-accordion-item {
      display: block;
      padding: 12px 20px 12px 40px;
      color: #6b7280;
      font-size: 14px;
      text-decoration: none;
      transition: background 0.2s, color 0.2s;
    }

    .drawer-accordion-item:hover {
      background: #f9fafb;
      color: #374151;
    }

    .notification-icon {
      font-size: 24px;
    }

    .badge-count {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #ef4444;
      color: white;
      border-radius: 12px;
      min-width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      padding: 0 6px;
      display: none;
    }

    .badge-count.active {
      display: flex;
    }

    #gas-iframe {
      width: 100%;
      height: 100%;
      border: none;
      flex: 1;
    }

    /* ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIï¼ˆåˆæœŸãƒ­ãƒ¼ãƒ‰ä¸­ã«è¡¨ç¤ºï¼‰ */
    #skeleton-loader {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #f9fafb;
      z-index: 100;
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
      transition: opacity 0.3s ease-out;
    }

    #skeleton-loader.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .skeleton-header {
      width: 100%;
      height: 60px;
      background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
      background-size: 200% 100%;
      animation: skeleton-pulse 1.5s ease-in-out infinite;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .skeleton-form {
      width: 100%;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .skeleton-input {
      width: 100%;
      height: 40px;
      background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
      background-size: 200% 100%;
      animation: skeleton-pulse 1.5s ease-in-out infinite;
      border-radius: 6px;
      margin-bottom: 16px;
    }

    .skeleton-button {
      width: 120px;
      height: 44px;
      background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
      background-size: 200% 100%;
      animation: skeleton-pulse 1.5s ease-in-out infinite;
      border-radius: 6px;
      margin-top: 10px;
    }

    @keyframes skeleton-pulse {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }

    /* ãƒãƒ£ãƒƒãƒˆFABï¼ˆå³ä¸‹å›ºå®šï¼‰ */
    #chat-fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 9998;
      transition: all 0.3s ease;
      border: none;
    }

    #chat-fab:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 32px rgba(102, 126, 234, 0.5);
    }

    #chat-fab:active {
      transform: scale(0.95);
    }

    #chat-fab.hidden {
      display: none;
    }

    #chat-fab-icon {
      font-size: 32px;
      line-height: 1;
    }

    /* æœªèª­ãƒãƒƒã‚¸ */
    #chat-fab-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      min-width: 24px;
      height: 24px;
      border-radius: 12px;
      background: #ef4444;
      color: white;
      font-size: 12px;
      font-weight: 600;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0 6px;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
      border: 2px solid white;
    }

    #chat-fab-badge.active {
      display: flex;
      animation: badge-bounce 0.5s ease;
    }

    @keyframes badge-bounce {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.2);
      }
    }
  </style>
</head>
<body>
  <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ï¼ˆåˆå›ã®ã¿ï¼‰ -->
  <div id="setup-screen">
    <div class="setup-container">
      <div class="setup-title">ğŸ”” é€šçŸ¥è¨­å®š</div>
      <div class="setup-subtitle">åˆå›ã®ã¿ - å•†å“ç™»éŒ²ã®é€šçŸ¥ã‚’å—ã‘å–ã‚‹ãŸã‚ã®è¨­å®šã§ã™</div>

      <!-- â“ª ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å…¥åŠ› -->
      <div class="step-section">
        <div>
          <span class="step-number">â“ª</span>
          <span class="step-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ç™»éŒ²</span>
        </div>
        <div style="margin-top: 8px;">
          <label style="display: block; font-size: 13px; color: #6b7280; margin-bottom: 4px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆæ‹…å½“è€…åï¼‰</label>
          <input type="text" id="user-name-input" placeholder="ä¾‹: å±±ç”°å¤ªéƒ"
                 style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;">
        </div>
        <div style="margin-top: 12px;">
          <label style="display: block; font-size: 13px; color: #6b7280; margin-bottom: 4px;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
          <input type="email" id="user-email-input" placeholder="your-email@example.com"
                 style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;">
        </div>
        <div style="margin-top: 12px;">
          <label style="display: block; font-size: 13px; color: #6b7280; margin-bottom: 8px;">æ¨©é™</label>
          <div id="permission-options" style="display: flex; flex-direction: column; gap: 8px;">
            <!-- åˆå›ç™»éŒ²è€…å‘ã‘ï¼ˆJavaScript ã§å‹•çš„ã«è¡¨ç¤ºåˆ¶å¾¡ï¼‰ -->
            <label id="owner-option" style="display: none; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="user-permission" value="ã‚ªãƒ¼ãƒŠãƒ¼" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
              <div>
                <div style="font-size: 15px; font-weight: 600; color: #dc2626;">ğŸ“• ã‚ªãƒ¼ãƒŠãƒ¼</div>
                <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">å…¨æ©Ÿèƒ½åˆ©ç”¨å¯èƒ½ï¼ˆåˆå›ç™»éŒ²è€…ã®ã¿ï¼‰</div>
              </div>
            </label>
            <label id="staff-option" style="display: flex; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="user-permission" value="ã‚¹ã‚¿ãƒƒãƒ•" checked style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
              <div>
                <div style="font-size: 15px; font-weight: 600; color: #1e40af;">ğŸ“˜ ã‚¹ã‚¿ãƒƒãƒ•</div>
                <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">å•†å“ç™»éŒ²ãƒ»åœ¨åº«ç®¡ç†ãªã©é€šå¸¸æ¥­å‹™</div>
              </div>
            </label>
            <label id="outsource-option" style="display: flex; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="user-permission" value="å¤–æ³¨" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
              <div>
                <div style="font-size: 15px; font-weight: 600; color: #4338ca;">ğŸ“™ å¤–æ³¨</div>
                <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">å•†å“ç™»éŒ²ã®ã¿ï¼ˆé™å®šçš„ãªæ¨©é™ï¼‰</div>
              </div>
            </label>
          </div>
          <div id="permission-info" style="font-size: 12px; color: #9ca3af; margin-top: 8px; padding: 8px; background: #f9fafb; border-radius: 6px;">
            â³ æ¨©é™è¨­å®šã‚’ç¢ºèªä¸­...
          </div>
        </div>
        <button class="step-button" onclick="saveUserInfo()" style="margin-top: 12px;">ä¿å­˜</button>
        <div id="step0-result" class="step-result"></div>
      </div>

      <!-- â‘  é€šçŸ¥ã‚’è¨±å¯ -->
      <div class="step-section">
        <div>
          <span class="step-number">â‘ </span>
          <span class="step-title">é€šçŸ¥ã‚’è¨±å¯</span>
        </div>
        <button class="step-button" onclick="requestNotificationPermission()">é€šçŸ¥ã‚’è¨±å¯</button>
        <div id="step1-result" class="step-result"></div>
      </div>

      <!-- â‘¡ FCMç™»éŒ² -->
      <div class="step-section">
        <div>
          <span class="step-number">â‘¡</span>
          <span class="step-title">FCMç™»éŒ²</span>
        </div>
        <button class="step-button" onclick="subscribeToFCM()" id="step2-button" disabled>FCMç™»éŒ²</button>
        <div id="step2-result" class="step-result"></div>
      </div>

      <!-- â‘¢ é€šçŸ¥ãƒ†ã‚¹ãƒˆï¼ˆä»»æ„ï¼‰ -->
      <div class="step-section">
        <div>
          <span class="step-number">â‘¢</span>
          <span class="step-title">é€šçŸ¥ãƒ†ã‚¹ãƒˆï¼ˆä»»æ„ï¼‰</span>
        </div>
        <button class="step-button optional" onclick="triggerServerNotification()" id="step3-button" disabled>ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡</button>
        <div id="step3-result" class="step-result"></div>
      </div>

      <!-- ã‚¢ãƒ—ãƒªã‚’é–‹ã -->
      <button class="open-app-button" onclick="openApp()" id="open-app-button">âœ… ã‚¢ãƒ—ãƒªã‚’é–‹ã</button>
    </div>
  </div>

  <!-- ã‚¢ãƒ—ãƒªç”»é¢ï¼ˆ2å›ç›®ä»¥é™ or ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†å¾Œï¼‰ -->
  <div id="app-screen">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆé€šçŸ¥ãƒœã‚¿ãƒ³ + ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ + ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ï¼‰ -->
    <div id="app-header">
      <div class="app-title" onclick="navigateToPage('product')" title="å•†å“ç™»éŒ²ã«æˆ»ã‚‹">ğŸ”„ REBORN</div>
      <div class="header-buttons">
        <button class="notification-button" onclick="openChatRooms()" title="ãƒãƒ£ãƒƒãƒˆ">
          <span class="notification-icon">ğŸ’¬</span>
          <span class="badge-count" id="chat-badge-count">0</span>
        </button>
        <button class="user-icon-button" id="header-user-icon" onclick="openUserSettings()" title="ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š">
          <span class="user-icon-placeholder" id="user-icon-placeholder">ğŸ‘¤</span>
          <img class="user-icon-image" id="user-icon-image" style="display: none;">
        </button>
        <button class="menu-button" onclick="toggleDrawer()" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">â˜°</button>
      </div>
    </div>

    <!-- ãƒ‰ãƒ­ãƒ¯ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="drawer-overlay" onclick="closeDrawer()"></div>

    <!-- ãƒ‰ãƒ­ãƒ¯ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div id="drawer-menu">
      <div class="drawer-header">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
      <a href="#" onclick="navigateToPage('product'); return false;" class="drawer-item active" id="drawer-product">
        ğŸ“ å•†å“ç™»éŒ²
      </a>
      <a href="#" onclick="navigateToPage('inventory'); return false;" class="drawer-item" id="drawer-inventory">
        ğŸ“¦ åœ¨åº«ç®¡ç†
      </a>
      <a href="#" onclick="navigateToPage('inventory_history'); return false;" class="drawer-item" id="drawer-inventory-history">
        ğŸ“Š å…¥å‡ºåº«å±¥æ­´
      </a>
      <a href="#" class="drawer-item disabled">
        ğŸ“ˆ å£²ä¸Š
      </a>
      
      <!-- ãƒã‚¹ã‚¿ç®¡ç†ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ -->
      <div class="drawer-accordion" id="drawer-master">
        <a href="#" class="drawer-accordion-header" onclick="toggleMasterAccordion(); return false;">
          ğŸ—‚ï¸ ãƒã‚¹ã‚¿ç®¡ç†
          <span class="drawer-accordion-arrow">â–¼</span>
        </a>
        <div class="drawer-accordion-content">
          <a href="#" onclick="navigateToPage('shipping-master'); return false;" class="drawer-accordion-item" id="drawer-shipping-master">
            ğŸšš ç™ºé€æ–¹æ³•ãƒã‚¹ã‚¿ç®¡ç†
          </a>
          <a href="#" onclick="navigateToPage('packaging-master'); return false;" class="drawer-accordion-item" id="drawer-packaging-master">
            ğŸ“¦ æ¢±åŒ…è³‡æãƒã‚¹ã‚¿ç®¡ç†
          </a>
        </div>
      </div>

      <!-- è¨­å®šç®¡ç†ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ -->
      <div class="drawer-accordion" id="drawer-config">
        <a href="#" class="drawer-accordion-header" onclick="toggleConfigAccordion(); return false;">
          âš™ï¸ è¨­å®šç®¡ç†
          <span class="drawer-accordion-arrow">â–¼</span>
        </a>
        <div class="drawer-accordion-content">
          <a href="#" onclick="navigateToPage('config-basic'); return false;" class="drawer-accordion-item" id="drawer-config-basic">
            ğŸ‘¤ åŸºæœ¬è¨­å®š
          </a>
          <a href="#" onclick="navigateToPage('config-management'); return false;" class="drawer-accordion-item" id="drawer-config-management">
            ğŸ”¢ ç®¡ç†ç•ªå·è¨­å®š
          </a>
          <a href="#" onclick="navigateToPage('config-product'); return false;" class="drawer-accordion-item" id="drawer-config-product">
            ğŸ“ å•†å“ç™»éŒ²è¨­å®š
          </a>
          <a href="#" onclick="navigateToPage('config-shipping'); return false;" class="drawer-accordion-item" id="drawer-config-shipping">
            ğŸ“¦ é…é€è¨­å®š
          </a>
          <a href="#" onclick="navigateToPage('config-procure'); return false;" class="drawer-accordion-item" id="drawer-config-procure">
            ğŸ’¼ ä»•å…¥ãƒ»å‡ºå“è¨­å®š
          </a>
          <a href="#" onclick="navigateToPage('config-ai'); return false;" class="drawer-accordion-item" id="drawer-config-ai">
            âœ¨ AIç”Ÿæˆè¨­å®š
          </a>
        </div>
      </div>
    </div>

    <!-- ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIï¼ˆåˆæœŸãƒ­ãƒ¼ãƒ‰ä¸­ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰ -->
    <div id="skeleton-loader">
      <div class="skeleton-header"></div>
      <div class="skeleton-form">
        <div class="skeleton-input"></div>
        <div class="skeleton-input"></div>
        <div class="skeleton-input"></div>
        <div class="skeleton-input"></div>
        <div class="skeleton-button"></div>
      </div>
    </div>

    <!-- GAS Web App ã‚’ iframe ã§è¡¨ç¤ºï¼ˆé…å»¶ãƒ­ãƒ¼ãƒ‰: DOMContentLoadedå¾Œã« srcè¨­å®šï¼‰ -->
    <iframe
      id="gas-iframe"
      data-src="https://script.google.com/macros/s/AKfycbx6ybbRLDqKQJ8IR-NPoVP8981Gtozzz0N3880XanEGRS4--iZtset8PFrVcD_u9YAHMA/exec?v=637&ts=20251105_5">
    </iframe>
  </div>

  <!-- Firebase SDKs (Modular format) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getMessaging, onMessage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js';

    // Firebase è¨­å®šï¼ˆreborn-chat ã«çµ±ä¸€ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "reborn-chat.firebaseapp.com",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    // Firebase åˆæœŸåŒ–ï¼ˆéã‚µãƒãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œï¼‰
    try {
      const app = initializeApp(firebaseConfig);
      const messaging = getMessaging(app);

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å…¬é–‹
      window.firebaseMessaging = messaging;

      // â˜… ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰é€šçŸ¥å¯¾å¿œ â˜…
      // ã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦ã„ã‚‹çŠ¶æ…‹ã§é€šçŸ¥ã‚’å—ä¿¡ã—ãŸæ™‚ã®å‡¦ç†
      onMessage(messaging, (payload) => {
        console.log('ğŸ“¨ ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡:', payload);

        // é€šçŸ¥ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const notificationTitle = payload.data?.title || payload.notification?.title || 'REBORN';
        const notificationBody = payload.data?.body || payload.notification?.body || 'æ–°ã—ã„é€šçŸ¥ãŒã‚ã‚Šã¾ã™';

        // çµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼šãƒãƒƒã‚¸ã¯Firestoreã‹ã‚‰è‡ªå‹•æ›´æ–°
        // if (typeof window.incrementBadge === 'function') {
        //   window.incrementBadge();
        //   console.log('ğŸ”” ãƒãƒƒã‚¸ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã—ã¾ã—ãŸ');
        // }

        // ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’è¡¨ç¤ºï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ°—ã¥ã„ã¦ã‚‚ã‚‰ã†ãŸã‚ï¼‰
        if (Notification.permission === 'granted') {
          new Notification(notificationTitle, {
            body: notificationBody,
            icon: '/icon-180.png',
            badge: '/icon-192.png',
            tag: 'reborn-notification',
            requireInteraction: false  // è‡ªå‹•ã§æ¶ˆãˆã‚‹
          });
          console.log('ğŸ”” ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
        }
      });
    } catch (error) {
      // Safariç­‰ã®éã‚µãƒãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯é™ã‹ã«ã‚¹ã‚­ãƒƒãƒ—
      console.log('â„¹ï¸ Firebase MessagingåˆæœŸåŒ–ã‚¹ã‚­ãƒƒãƒ—ï¼ˆéã‚µãƒãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰');
      window.firebaseMessaging = null;
    }
  </script>

  <script>
    // GAS API URL
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbx6ybbRLDqKQJ8IR-NPoVP8981Gtozzz0N3880XanEGRS4--iZtset8PFrVcD_u9YAHMA/exec';

    // VAPIDå…¬é–‹éµ
    const VAPID_PUBLIC_KEY = 'BAhqpnZ0bAewADDuEn2-TGyKLZqL3vPRbI3W8j-_HZT6r82P-E66kcXjFD2Hzmhwd4nFNBVzHMwaqv0kPGaFeEE';

    // Service Worker registrationï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼‰
    let swRegistration = null;

    // Unhandled Promise Rejection ã‚’ã‚­ãƒ£ãƒƒãƒï¼ˆSafariç­‰ã®FCMã‚¨ãƒ©ãƒ¼å¯¾å¿œï¼‰
    window.addEventListener('unhandledrejection', (event) => {
      // Firebase Messagingã®éã‚µãƒãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¶ã‚¨ãƒ©ãƒ¼ã¯é™ã‹ã«ç„¡è¦–
      if (event.reason && event.reason.message && event.reason.message.includes('messaging/unsupported-browser')) {
        console.log('â„¹ï¸ Firebase Messagingéã‚µãƒãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆSafariç­‰ï¼‰- ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–');
        event.preventDefault(); // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’æŠ‘åˆ¶
      }
    });

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–ï¼ˆDOMContentLoaded: ã‚ˆã‚Šé«˜é€Ÿï¼‰
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('âš¡ DOMContentLoaded - åˆæœŸåŒ–é–‹å§‹');

      // Service Workerç™»éŒ²
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
          swRegistration = registration;
          console.log('âœ… Service Worker ç™»éŒ²æˆåŠŸ:', registration.scope);
        } catch (error) {
          console.error('âŒ Service Worker ç™»éŒ²å¤±æ•—:', error);
        }
      }

      // çµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼šãƒãƒƒã‚¸ã¯Firestoreã‹ã‚‰è‡ªå‹•æ›´æ–°
      // initBadge(); // æ—§ã‚·ã‚¹ãƒ†ãƒ å‰Šé™¤

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’èª­ã¿è¾¼ã¿
      loadUserIcon();

      // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
      const setupCompleted = localStorage.getItem('fcm-setup-completed');
      if (setupCompleted !== '1') {
        // åˆå› â†’ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã‚’è¡¨ç¤º
        document.getElementById('setup-screen').style.display = 'flex';
        document.getElementById('app-screen').style.display = 'none';
        // æ¨©é™é¸æŠè‚¢ã‚’åˆæœŸåŒ–ï¼ˆã‚µãƒ¼ãƒãƒ¼å´åˆ¤å®šæ–¹å¼ï¼‰
        setupPermissionOptionsWithServerValidation();
      } else {
        // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†æ¸ˆã¿ â†’ FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆPhase 2: NOTIF-003ï¼‰
        await checkAndUpdateFCMToken();
      }

      // iframeèª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIã‚’éè¡¨ç¤º
      const iframe = document.getElementById('gas-iframe');
      const skeleton = document.getElementById('skeleton-loader');

      if (iframe && skeleton) {
        iframe.addEventListener('load', () => {
          console.log('âœ… iframeèª­ã¿è¾¼ã¿å®Œäº† - ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIéè¡¨ç¤º');
          skeleton.classList.add('hidden');
          // 0.3ç§’å¾Œã«å®Œå…¨ã«å‰Šé™¤ï¼ˆtransitionã¨åŒæœŸï¼‰
          setTimeout(() => {
            skeleton.style.display = 'none';
          }, 300);
        });

        // ğŸš€ iframeé…å»¶ãƒ­ãƒ¼ãƒ‰: åˆæœŸè¡¨ç¤ºã‚’é«˜é€ŸåŒ–
        // DOMæ§‹ç¯‰å®Œäº†å¾Œã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰iframeã‚’èª­ã¿è¾¼ã¿é–‹å§‹
        console.log('â±ï¸ iframeé…å»¶ãƒ­ãƒ¼ãƒ‰: 100mså¾Œã«é–‹å§‹');
        setTimeout(() => {
          const iframeSrc = iframe.getAttribute('data-src');
          if (iframeSrc) {
            // ğŸ” postMessageç”¨ã®parentOriginã¨pmTokenã‚’ç”Ÿæˆï¼ˆäºŒé‡iframeå¯¾ç­–ï¼‰
            const parentOrigin = location.origin;
            const pmToken = crypto.getRandomValues(new Uint32Array(1))[0].toString(36);
            localStorage.setItem('pm_token', pmToken);
            console.log('ğŸ” [postMessage Security] åˆæœŸèª­ã¿è¾¼ã¿ - parentOrigin:', parentOrigin, 'pmToken:', pmToken);

            // FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’localStorageã‹ã‚‰å–å¾—ã—ã¦URLã«è¿½åŠ 
            const fcmToken = localStorage.getItem('reborn_fcm_token') || '';
            const fcmParam = fcmToken ? '&fcmToken=' + encodeURIComponent(fcmToken) : '';
            const securityParams = '&parentOrigin=' + encodeURIComponent(parentOrigin) + '&pmToken=' + encodeURIComponent(pmToken);
            const finalSrc = iframeSrc + fcmParam + securityParams;

            console.log('ğŸš€ iframeèª­ã¿è¾¼ã¿é–‹å§‹:', finalSrc.substring(0, 120) + '...');
            console.log('ğŸ”‘ FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’iframeã«æ¸¡ã—ã¾ã™:', fcmToken ? fcmToken.substring(0, 20) + '...' : 'ãªã—');
            iframe.src = finalSrc;
          }
        }, 100); // 100msé…å»¶ï¼ˆä½“æ„Ÿé€Ÿåº¦å‘ä¸Šã®ãŸã‚ï¼‰
      }
    });

    // æ¨©é™é¸æŠè‚¢ã®è¡¨ç¤ºåˆ¶å¾¡ï¼ˆåˆå›ç™»éŒ²åˆ¤å®šï¼‰
    function checkPermissionOptions() {
      const ownerOption = document.getElementById('owner-option');
      const staffOption = document.getElementById('staff-option');
      const outsourceOption = document.getElementById('outsource-option');
      const permissionInfo = document.getElementById('permission-info');

      console.log('[checkPermissionOptions] æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚’ç¢ºèªä¸­...');

      // GASã‹ã‚‰æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚’å–å¾—ï¼ˆinventory.js doGetã«getExistingUserCountã‚±ãƒ¼ã‚¹è¿½åŠ æ¸ˆã¿@732ï¼‰
      const baseUrl = 'https://script.google.com/macros/s/AKfycbx6ybbRLDqKQJ8IR-NPoVP8981Gtozzz0N3880XanEGRS4--iZtset8PFrVcD_u9YAHMA/exec';
      fetch(baseUrl + '?action=getExistingUserCount')
        .then(response => response.json())
        .then(data => {
          console.log('[checkPermissionOptions] æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:', data.count);

          if (data.count === 0) {
            // åˆå›ç™»éŒ²è€… â†’ ã‚ªãƒ¼ãƒŠãƒ¼ã®ã¿è¡¨ç¤º
            ownerOption.style.display = 'flex';
            ownerOption.querySelector('input').checked = true;
            staffOption.style.display = 'none';
            outsourceOption.style.display = 'none';
            permissionInfo.textContent = 'âœ¨ åˆå›ç™»éŒ²è€…ã®ãŸã‚ã€ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ã§ç™»éŒ²ã•ã‚Œã¾ã™';
            permissionInfo.style.background = '#fef3c7';
            permissionInfo.style.color = '#92400e';
            console.log('[checkPermissionOptions] åˆå›ç™»éŒ²è€…ãƒ¢ãƒ¼ãƒ‰: ã‚ªãƒ¼ãƒŠãƒ¼ã®ã¿è¡¨ç¤º');
          } else {
            // 2äººç›®ä»¥é™ â†’ ã‚¹ã‚¿ãƒƒãƒ•ãƒ»å¤–æ³¨ã®ã¿è¡¨ç¤º
            ownerOption.style.display = 'none';
            staffOption.style.display = 'flex';
            outsourceOption.style.display = 'flex';
            staffOption.querySelector('input').checked = true;
            permissionInfo.textContent = 'ğŸ’¡ ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ã¯ç®¡ç†è€…ãŒã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ç®¡ç†ã€ã‹ã‚‰è¨­å®šã—ã¾ã™';
            console.log('[checkPermissionOptions] é€šå¸¸ãƒ¢ãƒ¼ãƒ‰: ã‚¹ã‚¿ãƒƒãƒ•ãƒ»å¤–æ³¨ã®ã¿è¡¨ç¤º');
          }
        })
        .catch(error => {
          console.error('[checkPermissionOptions] ã‚¨ãƒ©ãƒ¼:', error);
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å®‰å…¨å´ã«å€’ã™ï¼ˆã‚¹ã‚¿ãƒƒãƒ•ãƒ»å¤–æ³¨ã®ã¿ï¼‰
          ownerOption.style.display = 'none';
          staffOption.style.display = 'flex';
          outsourceOption.style.display = 'flex';
          staffOption.querySelector('input').checked = true;
          permissionInfo.textContent = 'âš ï¸ æ¨©é™ç¢ºèªã‚¨ãƒ©ãƒ¼ï¼ˆã‚¹ã‚¿ãƒƒãƒ•ãƒ»å¤–æ³¨ã®ã¿é¸æŠå¯èƒ½ï¼‰';
          permissionInfo.style.background = '#fef2f2';
          permissionInfo.style.color = '#991b1b';
        });
    }

    /**
     * æ¨©é™é¸æŠè‚¢ã‚’è¨­å®šï¼ˆã‚µãƒ¼ãƒãƒ¼å´åˆ¤å®šæ–¹å¼ï¼‰
     * ã™ã¹ã¦ã®é¸æŠè‚¢ã‚’è¡¨ç¤ºã—ã€ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚ªãƒ¼ãƒŠãƒ¼é‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯
     */
    function setupPermissionOptionsWithServerValidation() {
      const ownerOption = document.getElementById('owner-option');
      const staffOption = document.getElementById('staff-option');
      const outsourceOption = document.getElementById('outsource-option');
      const permissionInfo = document.getElementById('permission-info');

      console.log('[setupPermissionOptions] ã‚µãƒ¼ãƒãƒ¼å´åˆ¤å®šæ–¹å¼ã§åˆæœŸåŒ–');

      // ã™ã¹ã¦ã®é¸æŠè‚¢ã‚’è¡¨ç¤º
      ownerOption.style.display = 'flex';
      staffOption.style.display = 'flex';
      outsourceOption.style.display = 'flex';

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ
      staffOption.querySelector('input').checked = true;

      // æƒ…å ±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      permissionInfo.textContent = 'ğŸ’¡ åˆå›ç™»éŒ²è€…ã®ã¿ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ã§ç™»éŒ²ã§ãã¾ã™ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã§è‡ªå‹•åˆ¤å®šï¼‰';
      permissionInfo.style.background = '#fef3c7';
      permissionInfo.style.color = '#92400e';

      console.log('[setupPermissionOptions] ã™ã¹ã¦ã®é¸æŠè‚¢ã‚’è¡¨ç¤ºï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã§ã‚ªãƒ¼ãƒŠãƒ¼é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼‰');
    }

    // â“ª ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜
    async function saveUserInfo() {
      const nameInput = document.getElementById('user-name-input');
      const emailInput = document.getElementById('user-email-input');
      const resultDiv = document.getElementById('step0-result');

      const userName = nameInput.value.trim();
      const email = emailInput.value.trim();

      // æ¨©é™ã‚’å–å¾—
      const permissionRadio = document.querySelector('input[name="user-permission"]:checked');
      const permission = permissionRadio ? permissionRadio.value : 'ã‚¹ã‚¿ãƒƒãƒ•';

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!userName) {
        resultDiv.textContent = 'âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
        return;
      }

      if (!email) {
        resultDiv.textContent = 'âŒ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
        return;
      }

      // ç°¡æ˜“çš„ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œè¨¼
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        resultDiv.textContent = 'âŒ æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
        return;
      }

      // ä¿å­˜ä¸­ã®è¡¨ç¤º
      resultDiv.textContent = 'â³ ä¿å­˜ä¸­...';
      resultDiv.className = 'step-result';
      resultDiv.style.display = 'block';

      // âœ… ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ã®å ´åˆã€ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚ªãƒ¼ãƒŠãƒ¼é‡è¤‡ãƒã‚§ãƒƒã‚¯
      if (permission === 'ã‚ªãƒ¼ãƒŠãƒ¼') {
        try {
          const baseUrl = 'https://script.google.com/macros/s/AKfycbx6ybbRLDqKQJ8IR-NPoVP8981Gtozzz0N3880XanEGRS4--iZtset8PFrVcD_u9YAHMA/exec';
          const response = await fetch(baseUrl + '?action=getExistingUserCount');
          const data = await response.json();

          if (data.success && data.count > 0) {
            // æ—¢ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ã‚ªãƒ¼ãƒŠãƒ¼ç™»éŒ²ã‚’æ‹’å¦
            resultDiv.textContent = 'âŒ æ—¢ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚¹ã‚¿ãƒƒãƒ•ã¾ãŸã¯å¤–æ³¨ã§ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚';
            resultDiv.className = 'step-result error';
            resultDiv.style.display = 'block';
            console.log('[saveUserInfo] âŒ ã‚ªãƒ¼ãƒŠãƒ¼é‡è¤‡ç™»éŒ²ã‚’æ‹’å¦ï¼ˆæ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ' + data.count + 'ï¼‰');
            return;
          }

          console.log('[saveUserInfo] âœ… åˆå›ç™»éŒ²è€…ã®ãŸã‚ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ã‚’è¨±å¯');
        } catch (error) {
          console.error('âŒ ã‚ªãƒ¼ãƒŠãƒ¼é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
          resultDiv.textContent = 'âŒ ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
          resultDiv.className = 'step-result error';
          resultDiv.style.display = 'block';
          return;
        }
      }

      // LocalStorageã«ä¿å­˜
      try {
        localStorage.setItem('reborn_user_name', userName);
        localStorage.setItem('reborn_user_email', email);
        localStorage.setItem('reborn_user_permission', permission);
        console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ä¿å­˜:', { name: userName, email: email, permission: permission });

        // IndexedDBã«ã‚‚ä¿å­˜ï¼ˆService Workerã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã™ã‚‹ãŸã‚ï¼‰
        const request = indexedDB.open('RebornUserDB', 1);
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('user')) {
            db.createObjectStore('user');
          }
        };
        request.onsuccess = () => {
          const db = request.result;
          const transaction = db.transaction(['user'], 'readwrite');
          const store = transaction.objectStore('user');
          store.put(userName, 'userName');
          console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’IndexedDBã«ä¿å­˜:', userName);
        };
        request.onerror = () => {
          console.error('âŒ IndexedDBä¿å­˜ã‚¨ãƒ©ãƒ¼');
        };

        // GASå´ã®PropertiesServiceã«ã‚‚ä¿å­˜
        const baseUrl = 'https://script.google.com/macros/s/AKfycbx6ybbRLDqKQJ8IR-NPoVP8981Gtozzz0N3880XanEGRS4--iZtset8PFrVcD_u9YAHMA/exec';
        fetch(baseUrl + '?action=setOperatorName&name=' + encodeURIComponent(userName))
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              console.log('âœ… æ‹…å½“è€…åã‚’GASã«ä¿å­˜æˆåŠŸ');
            } else {
              console.warn('âš ï¸ æ‹…å½“è€…åã®GASä¿å­˜å¤±æ•—:', data.message);
            }
          })
          .catch(error => {
            console.warn('âš ï¸ æ‹…å½“è€…åã®GASä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
          });

        resultDiv.textContent = 'âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼\næ¬¡ã«ã€Œâ‘  é€šçŸ¥ã‚’è¨±å¯ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
        resultDiv.className = 'step-result success';
        resultDiv.style.display = 'block';

        // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç„¡åŠ¹åŒ–
        nameInput.disabled = true;
        emailInput.disabled = true;
        document.querySelectorAll('input[name="user-permission"]').forEach(radio => radio.disabled = true);
      } catch (error) {
        console.error('âŒ LocalStorageä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        resultDiv.textContent = 'âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
      }
    }

    // â‘  é€šçŸ¥ã‚’è¨±å¯
    async function requestNotificationPermission() {
      const resultDiv = document.getElementById('step1-result');
      const step2Button = document.getElementById('step2-button');

      if (!('Notification' in window)) {
        resultDiv.textContent = 'âŒ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“';
        resultDiv.className = 'step-result error';
        return;
      }

      try {
        const permission = await Notification.requestPermission();

        if (permission === 'granted') {
          resultDiv.textContent = 'âœ… é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸï¼\næ¬¡ã«ã€Œâ‘¡ FCMç™»éŒ²ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
          resultDiv.className = 'step-result success';

          // â‘¡ ã‚’æœ‰åŠ¹åŒ–
          step2Button.disabled = false;
        } else {
          resultDiv.textContent = 'âŒ é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ\nè¨­å®šã‹ã‚‰è¨±å¯ã—ã¦ãã ã•ã„ã€‚';
          resultDiv.className = 'step-result error';
        }
      } catch (error) {
        resultDiv.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message;
        resultDiv.className = 'step-result error';
      }
    }

    // â‘¡ FCMç™»éŒ²
    async function subscribeToFCM() {
      const resultDiv = document.getElementById('step2-result');
      const step3Button = document.getElementById('step3-button');
      const openAppButton = document.getElementById('open-app-button');

      // FCMéã‚µãƒãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆSafariç­‰ï¼‰ã®å ´åˆ
      if (!window.firebaseMessaging) {
        resultDiv.textContent = 'â„¹ï¸ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ï¼ˆSafariç­‰ï¼‰\n\nã‚¹ãƒãƒ›ã§ã¯é€šçŸ¥ã‚’å—ã‘å–ã‚Œã¾ã™ã€‚\n\nä¸‹ã®ã€Œã‚¢ãƒ—ãƒªã‚’é–‹ãã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
        resultDiv.className = 'step-result';
        resultDiv.style.display = 'block';

        // ã€Œã‚¢ãƒ—ãƒªã‚’é–‹ãã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        openAppButton.style.display = 'block';
        return;
      }

      if (Notification.permission !== 'granted') {
        resultDiv.textContent = 'âŒ é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“\nã€Œâ‘  é€šçŸ¥ã‚’è¨±å¯ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
        resultDiv.className = 'step-result error';
        return;
      }

      // Service Workerç™»éŒ²ç¢ºèª
      if (!swRegistration) {
        resultDiv.textContent = 'âŒ Service WorkerãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“\nãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚';
        resultDiv.className = 'step-result error';
        console.error('âŒ swRegistration is null');
        return;
      }

      console.log('âœ… Service Workeræº–å‚™å®Œäº†:', swRegistration);

      try {
        resultDiv.textContent = 'ç™»éŒ²ä¸­...';
        resultDiv.className = 'step-result';
        resultDiv.style.display = 'block';

        // Firebase Messagingã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
        const { getToken } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js');

        console.log('ğŸ”„ FCMãƒˆãƒ¼ã‚¯ãƒ³å–å¾—é–‹å§‹...');
        console.log('  - firebaseMessaging:', window.firebaseMessaging);
        console.log('  - vapidKey:', VAPID_PUBLIC_KEY);
        console.log('  - swRegistration:', swRegistration);

        const currentToken = await getToken(window.firebaseMessaging, {
          vapidKey: VAPID_PUBLIC_KEY,
          serviceWorkerRegistration: swRegistration
        });

        console.log('âœ… FCMãƒˆãƒ¼ã‚¯ãƒ³å–å¾—æˆåŠŸ:', currentToken);

        if (currentToken) {
          // FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’localStorageã«ä¿å­˜ï¼ˆãƒ‡ãƒã‚¤ã‚¹è­˜åˆ¥ç”¨ï¼‰
          localStorage.setItem('reborn_fcm_token', currentToken);
          console.log('ğŸ’¾ FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’localStorageã«ä¿å­˜');

          console.log('ğŸ“± FCMãƒˆãƒ¼ã‚¯ãƒ³:', currentToken);

          // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’å–å¾—
          const deviceInfo = {
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            language: navigator.language,
            screenSize: `${screen.width}x${screen.height}`,
            timestamp: new Date().toISOString()
          };
          console.log('ğŸ“± ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±:', deviceInfo);

          // LocalStorageã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨æ¨©é™ã‚’å–å¾—
          const userEmail = localStorage.getItem('reborn_user_email') || 'unknown';
          const userName = localStorage.getItem('reborn_user_name') || '';
          const userPermission = localStorage.getItem('reborn_user_permission') || 'ã‚¹ã‚¿ãƒƒãƒ•';
          console.log('ğŸ“§ ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:', userEmail);
          console.log('ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼å:', userName);
          console.log('ğŸ” æ¨©é™:', userPermission);
          console.log('ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:', userEmail);

          // é€šçŸ¥è¨­å®šï¼ˆé€šçŸ¥ã‚’è¨±å¯ã—ã¦ã„ã‚‹å ´åˆã¯trueï¼‰
          const notificationEnabled = true;
          const notificationSound = true;
          console.log('ğŸ”” é€šçŸ¥æœ‰åŠ¹:', notificationEnabled);
          console.log('ğŸ”Š é€šçŸ¥éŸ³:', notificationSound);

          // GASã«ãƒˆãƒ¼ã‚¯ãƒ³ã€ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€æ¨©é™ã€é€šçŸ¥è¨­å®šã‚’é€ä¿¡
          const response = await fetch(GAS_API_URL + '?action=subscribeFCM&token=' + encodeURIComponent(currentToken) +
                                      '&deviceInfo=' + encodeURIComponent(JSON.stringify(deviceInfo)) +
                                      '&userId=' + encodeURIComponent(userEmail) +
                                      '&userName=' + encodeURIComponent(userName) +
                                      '&email=' + encodeURIComponent(userEmail) +
                                      '&permission=' + encodeURIComponent(userPermission) +
                                      '&notificationEnabled=' + encodeURIComponent(notificationEnabled) +
                                      '&notificationSound=' + encodeURIComponent(notificationSound));

          if (response.ok) {
            const data = await response.json();

            // âœ… ã‚µãƒ¼ãƒãƒ¼å´ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœã‚’ãƒã‚§ãƒƒã‚¯
            if (data.success === false) {
              throw new Error(data.message || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }

            resultDiv.textContent = 'âœ… FCMç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\nä¸‹ã®ã€Œã‚¢ãƒ—ãƒªã‚’é–‹ãã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚\n\nâ€» é€šçŸ¥ãƒ†ã‚¹ãƒˆã¯ä»»æ„ã§ã™ï¼ˆã‚¹ã‚­ãƒƒãƒ—å¯ï¼‰';
            resultDiv.className = 'step-result success';

            // â‘¢ ã‚’æœ‰åŠ¹åŒ–
            step3Button.disabled = false;

            // ã€Œã‚¢ãƒ—ãƒªã‚’é–‹ãã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            openAppButton.style.display = 'block';

            // ğŸ”” ãƒãƒ£ãƒƒãƒˆæœªèª­ãƒªã‚¹ãƒŠãƒ¼ã‚’é–‹å§‹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
            if (typeof startChatUnreadListener === 'function') {
              console.log('[FCMç™»éŒ²] ãƒãƒ£ãƒƒãƒˆæœªèª­ãƒªã‚¹ãƒŠãƒ¼ã‚’é–‹å§‹');
              setTimeout(() => {
                startChatUnreadListener();
              }, 1000); // 1ç§’å¾Œã«å®Ÿè¡Œï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åè¨­å®šãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿï¼‰
            }
          } else {
            throw new Error('HTTP ' + response.status);
          }
        } else {
          throw new Error('ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        resultDiv.textContent = 'âŒ ç™»éŒ²å¤±æ•—\n\nã‚¨ãƒ©ãƒ¼: ' + error.message;
        resultDiv.className = 'step-result error';
        console.error('âŒ FCMç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // â‘¢ ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰é€šçŸ¥ã‚’é€ä¿¡ï¼ˆä»»æ„ï¼‰
    async function triggerServerNotification() {
      const resultDiv = document.getElementById('step3-result');

      try {
        resultDiv.textContent = 'é€ä¿¡ä¸­...';
        resultDiv.className = 'step-result';
        resultDiv.style.display = 'block';

        const title = 'ğŸ‰ REBORN ãƒ†ã‚¹ãƒˆé€šçŸ¥';
        const body = 'é€šçŸ¥è¨­å®šãŒæ­£ã—ãå®Œäº†ã—ã¾ã—ãŸï¼';

        // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
        const titleEncoded = btoa(encodeURIComponent(title));
        const bodyEncoded = btoa(encodeURIComponent(body));

        // GETãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        const url = GAS_API_URL + '?action=sendFCM&title=' + titleEncoded + '&body=' + bodyEncoded;
        const response = await fetch(url);

        if (response.ok) {
          const data = await response.json();
          resultDiv.textContent = 'âœ… ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼\n\nâš ï¸ ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã£ã¦é€šçŸ¥ãŒå±Šãã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
          resultDiv.className = 'step-result success';
        } else {
          throw new Error('HTTP ' + response.status);
        }
      } catch (error) {
        resultDiv.textContent = 'âŒ é€ä¿¡å¤±æ•—\n\nã‚¨ãƒ©ãƒ¼: ' + error.message;
        resultDiv.className = 'step-result error';
        console.error('âŒ é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã‚¢ãƒ—ãƒªã‚’é–‹ã
    function openApp() {
      // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ãƒ•ãƒ©ã‚°ã‚’ä¿å­˜
      localStorage.setItem('fcm-setup-completed', '1');

      // ã‚¢ãƒ—ãƒªç”»é¢ã‚’è¡¨ç¤º
      showAppScreen();

      // å•†å“ç™»éŒ²ç”»é¢ã‚’èª­ã¿è¾¼ã‚€ï¼ˆæ‹…å½“è€…åã‚’æ­£ã—ãè¡¨ç¤ºã™ã‚‹ãŸã‚ï¼‰
      navigateToPage('product');
    }

    // ã‚¢ãƒ—ãƒªç”»é¢ã‚’è¡¨ç¤º
    async function showAppScreen() {
      document.getElementById('setup-screen').style.display = 'none';
      document.getElementById('app-screen').style.display = 'flex';

      // FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€æ›´æ–°ãŒã‚ã‚Œã°è‡ªå‹•é€ä¿¡
      await checkAndUpdateFCMToken();
    }

    /**
     * FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€æ›´æ–°ãŒã‚ã‚Œã°è‡ªå‹•çš„ã«GASã«é€ä¿¡
     * Phase 2: ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å‡¦ç†ï¼ˆNOTIF-003ï¼‰
     */
    async function checkAndUpdateFCMToken() {
      try {
        // Service WorkerãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if (!swRegistration) {
          console.log('â­ï¸ Service Workeræœªç™»éŒ²ã®ãŸã‚ã€FCMãƒˆãƒ¼ã‚¯ãƒ³ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—');
          return;
        }

        // FCMéã‚µãƒãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆSafariç­‰ï¼‰ã‚’ãƒã‚§ãƒƒã‚¯
        if (!window.firebaseMessaging) {
          console.log('â„¹ï¸ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ï¼ˆSafariç­‰ï¼‰');
          console.log('   ã‚¹ãƒãƒ›ã‚¢ãƒ—ãƒªã§ã¯é€šçŸ¥ã‚’å—ã‘å–ã‚Œã¾ã™');
          return;
        }

        // Firebase Messagingã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
        const { getToken } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js');

        console.log('ğŸ”„ FCMãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°ãƒã‚§ãƒƒã‚¯é–‹å§‹...');

        const currentToken = await getToken(window.firebaseMessaging, {
          vapidKey: VAPID_PUBLIC_KEY,
          serviceWorkerRegistration: swRegistration
        });

        if (!currentToken) {
          console.log('âš ï¸ FCMãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
          return;
        }

        // localStorageã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã¨æ¯”è¼ƒ
        const savedToken = localStorage.getItem('reborn_fcm_token');

        if (savedToken === currentToken) {
          console.log('âœ… FCMãƒˆãƒ¼ã‚¯ãƒ³ã¯æœ€æ–°ã§ã™ï¼ˆæ›´æ–°ãªã—ï¼‰');
          return;
        }

        console.log('ğŸ”„ FCMãƒˆãƒ¼ã‚¯ãƒ³ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ');
        console.log('  - æ—§ãƒˆãƒ¼ã‚¯ãƒ³:', savedToken ? savedToken.substring(0, 20) + '...' : 'ãªã—');
        console.log('  - æ–°ãƒˆãƒ¼ã‚¯ãƒ³:', currentToken.substring(0, 20) + '...');

        // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’å–å¾—
        const deviceInfo = {
          userAgent: navigator.userAgent,
          platform: navigator.platform,
          language: navigator.language,
          screenSize: `${screen.width}x${screen.height}`,
          timestamp: new Date().toISOString()
        };

        // LocalStorageã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
        const userEmail = localStorage.getItem('reborn_user_email') || 'unknown';
        const userName = localStorage.getItem('reborn_user_name') || '';
        const permission = localStorage.getItem('reborn_user_permission') || 'ã‚¹ã‚¿ãƒƒãƒ•';
        const notificationEnabled = true;
        const notificationSound = true;

        // GASã«æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ä¿¡
        const response = await fetch(GAS_API_URL + '?action=subscribeFCM&token=' + encodeURIComponent(currentToken) +
                                    '&deviceInfo=' + encodeURIComponent(JSON.stringify(deviceInfo)) +
                                    '&userId=' + encodeURIComponent(userEmail) +
                                    '&userName=' + encodeURIComponent(userName) +
                                    '&email=' + encodeURIComponent(userEmail) +
                                    '&permission=' + encodeURIComponent(permission) +
                                    '&notificationEnabled=' + encodeURIComponent(notificationEnabled) +
                                    '&notificationSound=' + encodeURIComponent(notificationSound));

        if (response.ok) {
          // localStorageã«æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
          localStorage.setItem('reborn_fcm_token', currentToken);
          console.log('âœ… FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’è‡ªå‹•æ›´æ–°ã—ã¾ã—ãŸ');
        } else {
          console.error('âŒ FCMãƒˆãƒ¼ã‚¯ãƒ³ã®é€ä¿¡ã«å¤±æ•—:', response.status);
        }
      } catch (error) {
        console.error('âŒ FCMãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ãƒ‰ãƒ­ãƒ¯ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã/é–‰ã˜ã‚‹
    function toggleDrawer() {
      const drawer = document.getElementById('drawer-menu');
      const overlay = document.getElementById('drawer-overlay');

      drawer.classList.toggle('active');
      overlay.classList.toggle('active');
    }

    // ãƒ‰ãƒ­ãƒ¯ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
    function closeDrawer() {
      const drawer = document.getElementById('drawer-menu');
      const overlay = document.getElementById('drawer-overlay');

      drawer.classList.remove('active');
      overlay.classList.remove('active');
    }

    // ãƒã‚¹ã‚¿ç®¡ç†ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰
    function toggleMasterAccordion() {
      const accordion = document.getElementById('drawer-master');
      accordion.classList.toggle('open');
    }

    // è¨­å®šç®¡ç†ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰
    function toggleConfigAccordion() {
      const accordion = document.getElementById('drawer-config');
      accordion.classList.toggle('open');
    }

    // pmTokenç”Ÿæˆç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function generatePmToken() {
      return crypto.getRandomValues(new Uint32Array(1))[0].toString(36);
    }

    // ãƒšãƒ¼ã‚¸é·ç§»ï¼ˆãƒ‰ãƒ­ãƒ¯ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ï¼‰
    function navigateToPage(page) {
      const iframe = document.getElementById('gas-iframe');
      const baseUrl = 'https://script.google.com/macros/s/AKfycbx6ybbRLDqKQJ8IR-NPoVP8981Gtozzz0N3880XanEGRS4--iZtset8PFrVcD_u9YAHMA/exec';

      // ğŸ” postMessageç”¨ã®parentOriginã¨pmTokenã‚’ç”Ÿæˆï¼ˆäºŒé‡iframeå¯¾ç­–ï¼‰
      const parentOrigin = location.origin; // https://reborn-inventory-system.pages.dev
      const pmToken = crypto.getRandomValues(new Uint32Array(1))[0].toString(36);
      localStorage.setItem('pm_token', pmToken);
      console.log('ğŸ” [postMessage Security] parentOrigin:', parentOrigin, 'pmToken:', pmToken);

      // FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’localStorageã‹ã‚‰å–å¾—
      const fcmToken = localStorage.getItem('reborn_fcm_token') || '';
      const fcmParam = fcmToken ? '&fcmToken=' + encodeURIComponent(fcmToken) : '';
      console.log('ğŸ”‘ FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’iframeã«æ¸¡ã—ã¾ã™:', fcmToken ? fcmToken.substring(0, 20) + '...' : 'ãªã—');

      // postMessageç”¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
      const securityParams = '&parentOrigin=' + encodeURIComponent(parentOrigin) + '&pmToken=' + encodeURIComponent(pmToken);

      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
      document.querySelectorAll('.drawer-item').forEach(item => {
        item.classList.remove('active');
      });

      if (page === 'product') {
        iframe.src = baseUrl + '?menu=product' + fcmParam + securityParams;
        document.getElementById('drawer-product').classList.add('active');
      } else if (page === 'config-basic') {
        iframe.src = baseUrl + '?menu=config&activeTab=basic' + fcmParam + securityParams;
        document.getElementById('drawer-config-basic').classList.add('active');
      } else if (page === 'config-management') {
        iframe.src = baseUrl + '?menu=config&activeTab=management' + fcmParam + securityParams;
        document.getElementById('drawer-config-management').classList.add('active');
      } else if (page === 'config-product') {
        iframe.src = baseUrl + '?menu=config&activeTab=product' + fcmParam + securityParams;
        document.getElementById('drawer-config-product').classList.add('active');
      } else if (page === 'config-shipping') {
        iframe.src = baseUrl + '?menu=config&activeTab=shipping' + fcmParam + securityParams;
        document.getElementById('drawer-config-shipping').classList.add('active');
      } else if (page === 'config-procure') {
        iframe.src = baseUrl + '?menu=config&activeTab=procure-listing' + fcmParam + securityParams;
        document.getElementById('drawer-config-procure').classList.add('active');
      } else if (page === 'config-ai') {
        iframe.src = baseUrl + '?menu=config&activeTab=ai' + fcmParam + securityParams;
        document.getElementById('drawer-config-ai').classList.add('active');
      } else if (page === 'config') {
        // Legacy support - default to basic
        iframe.src = baseUrl + '?menu=config&activeTab=basic' + fcmParam + securityParams;
      } else if (page === 'inventory') {
        iframe.src = baseUrl + '?menu=inventory' + fcmParam + securityParams;
        document.getElementById('drawer-inventory').classList.add('active');
      } else if (page === 'inventory_history') {
        iframe.src = baseUrl + '?menu=inventory_history' + fcmParam + securityParams;
        document.getElementById('drawer-inventory-history').classList.add('active');
      } else if (page === 'chat') {
        // PWAç‰ˆï¼šapp=pwaãƒ•ãƒ©ã‚°ã‚’å¸¸ã«ä»˜ã‘ã‚‹ï¼ˆåˆ¤å®šã‚’ç¢ºå®Ÿã«ã™ã‚‹ï¼‰
        const userName = localStorage.getItem('reborn_user_name') || '';

        // pmTokenã‚’ç”Ÿæˆã—ã¦localStorageã«ä¿å­˜
        const pmToken = generatePmToken();
        localStorage.setItem('pm_token', pmToken);

        const params = new URLSearchParams({
          menu: 'chat',
          app: 'pwa',                 // â˜…æ˜ç¤ºãƒ•ãƒ©ã‚°ï¼ˆå¿…é ˆï¼‰
          userName: userName || '',   // ç©ºã§ã‚‚å¯ï¼ˆPWAãƒ•ã‚©ãƒ¼ãƒ ã§å…¥åŠ›ã•ã›ã‚‹ï¼‰
          parentOrigin: window.location.origin,
          pmToken: pmToken
        });
        // fcmTokenãŒã‚ã‚Œã°ä»˜ä¸
        if (fcmToken) params.set('fcmToken', fcmToken);

        iframe.src = `${baseUrl}?${params.toString()}`;
        document.getElementById('drawer-chat').classList.add('active');
      } else if (page === 'shipping-master') {
        iframe.src = baseUrl + '?menu=shipping-master' + fcmParam + securityParams;
        document.getElementById('drawer-shipping-master').classList.add('active');
      } else if (page === 'packaging-master') {
        iframe.src = baseUrl + '?menu=packaging-master' + fcmParam + securityParams;
        document.getElementById('drawer-packaging-master').classList.add('active');
      }

      // FABè¡¨ç¤ºåˆ¶å¾¡ï¼ˆãƒãƒ£ãƒƒãƒˆä»¥å¤–ã¯è¡¨ç¤ºï¼‰
      if (page === 'chat') {
        hideChatFab();
      } else {
        showChatFab();
      }

      // ãƒ‰ãƒ­ãƒ¯ãƒ¼ã‚’é–‰ã˜ã‚‹
      closeDrawer();
    }

    // postMessageå—ä¿¡å‡¦ç†ï¼ˆGASã‹ã‚‰ã®é€šçŸ¥å—ä¿¡ï¼‰
    // ğŸ” originæ¤œè¨¼ã®ã¿ï¼ˆevent.sourceæ¯”è¼ƒãªã—ã€pmTokenæ¤œè¨¼ãªã—ï¼‰
    const ALLOWED_ORIGINS = new Set([
      'https://script.google.com'
    ]);

    function isAllowedOrigin(origin) {
      if (ALLOWED_ORIGINS.has(origin)) return true;
      try {
        const url = new URL(origin);
        return url.hostname.endsWith('.googleusercontent.com');
      } catch {
        return false;
      }
    }

    window.addEventListener('message', async function(event) {
      const iframe = document.getElementById('gas-iframe');
      const iframeWindow = iframe ? iframe.contentWindow : null;

      // iframeå†…ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã€è¨±å¯ã•ã‚ŒãŸoriginã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚’ç¢ºèª
      const isFromIframe = event.source === iframeWindow;
      const isFromAllowedOrigin = isAllowedOrigin(event.origin);

      console.log('[postMessage Debug] event.source === iframeWindow:', isFromIframe);
      console.log('[postMessage Debug] isAllowedOrigin:', isFromAllowedOrigin);
      console.log('[postMessage Debug] event.origin:', event.origin);

      if (!isFromIframe && !isFromAllowedOrigin) {
        console.warn('âš ï¸ [postMessage] ä¸æ­£ãªoriginã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ‹’å¦:', event.origin);
        return;
      }

      const data = event.data || {};
      console.log('ğŸ“¨ [postMessage] å—ä¿¡ (from', event.origin + '):', data);

      console.log('ğŸ“¨ å—ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (from', event.origin + '):', data);

      // ãƒãƒ£ãƒƒãƒˆä¸€è¦§ã«æˆ»ã‚‹è¦æ±‚ã®å‡¦ç†
      if (data.type === 'showChatRoomsList') {
        console.log('========================================');
        console.log('ğŸ”™ [postMessage] ãƒãƒ£ãƒƒãƒˆä¸€è¦§ã«æˆ»ã‚‹è¦æ±‚ã‚’å—ä¿¡');
        console.log('[postMessage] data:', data);
        console.log('[postMessage] openChatRooms é–¢æ•°å‘¼ã³å‡ºã—é–‹å§‹');
        console.log('========================================');
        openChatRooms();
        console.log('[postMessage] âœ… openChatRooms å‘¼ã³å‡ºã—å®Œäº†');
        return;
      }

      // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¦æ±‚ã®å‡¦ç†
      if (data.type === 'navigate') {
        const iframe = document.getElementById('gas-iframe');

        // URLãŒç›´æ¥æŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆå¾“æ¥ã®æ–¹æ³•ï¼‰
        if (data.url) {
          console.log('ğŸš€ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³:', data.url);
          iframe.src = data.url;
        }
        // pageæŒ‡å®šã®å ´åˆï¼ˆãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ç­‰ï¼‰
        else if (data.page) {
          const page = data.page;
          const roomId = data.roomId || '';
          const userName = data.userName || localStorage.getItem('reborn_user_name') || '';
          const fcmToken = localStorage.getItem('fcm_token') || '';

          console.log('ğŸš€ ãƒšãƒ¼ã‚¸é·ç§»:', page, 'roomId:', roomId);

          // ãƒãƒ£ãƒƒãƒˆç”»é¢ã¸ã®é·ç§»
          if (page === 'chat') {
            // æ–°ã—ã„pmTokenã‚’ç”Ÿæˆ
            const pmToken = generatePmToken();
            localStorage.setItem('pm_token', pmToken);

            const params = new URLSearchParams({
              menu: 'chat',  // âœ… 'page'ã§ã¯ãªã'menu'ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
              app: 'pwa',
              userName: userName,
              fcmToken: fcmToken,
              roomId: roomId,
              parentOrigin: window.location.origin,
              pmToken: pmToken,
              gasBaseUrl: window.REBORN_CONFIG.GAS_BASE_URL  // âœ… APIå‘¼ã³å‡ºã—ç”¨
            });
            const url = `${window.REBORN_CONFIG.GAS_BASE_URL}?${params.toString()}`;
            console.log('ğŸš€ ãƒãƒ£ãƒƒãƒˆç”»é¢URL:', url);
            iframe.src = url;

            // ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’é–‹ã„ãŸã®ã§FABã‚’éè¡¨ç¤º
            hideChatFab();
          }
        }
      }

      // ğŸ”” Service Workerã‹ã‚‰ã®ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒãƒƒã‚¸æ›´æ–°è¦æ±‚
      if (event.data.type === 'INCREMENT_SYSTEM_UNREAD') {
        console.log('[Badge] Service Workerã‹ã‚‰ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒãƒƒã‚¸æ›´æ–°è¦æ±‚');
        // ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ã®Firestore unreadCountã‚’+1
        incrementSystemNotificationUnreadCount();
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°è¦æ±‚ã®å‡¦ç†
      if (event.data.type === 'UPDATE_USER_ICON') {
        console.log('ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°:', event.data.iconUrl ? 'ç”»åƒã‚ã‚Š' : 'ç”»åƒãªã—');
        updateUserIcon(event.data.iconUrl);
      }

      // ğŸ“¢ ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ æŠ•ç¨¿ï¼ˆçµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼‰
      // Webhookæ–¹å¼ã«ç§»è¡Œã—ãŸãŸã‚ã€postMessageã«ã‚ˆã‚‹é€šçŸ¥å—ä¿¡ã¯ä¸è¦
      // GAS â†’ Cloudflare Worker â†’ Firestore + FCM ã§å®Œçµ
    });

    // ğŸ”• æ—§ãƒ™ãƒ«ãƒãƒ¼ã‚¯é€šçŸ¥ãƒãƒƒã‚¸æ©Ÿèƒ½ï¼ˆç„¡åŠ¹åŒ– - çµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼‰
    // çµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã¯ã€ãƒãƒ£ãƒƒãƒˆãƒãƒƒã‚¸ã«çµ±åˆ
    // ãƒãƒƒã‚¸ã¯Firestoreã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰è‡ªå‹•æ›´æ–°
    /*
    let badgeCount = 0;

    // ãƒãƒƒã‚¸ã‚«ã‚¦ãƒ³ãƒˆã‚’åˆæœŸåŒ–ï¼ˆlocalStorage ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
    function initBadge() {
      const saved = localStorage.getItem('reborn-badge-count');
      badgeCount = saved ? parseInt(saved, 10) : 0;
      updateBadgeDisplay();
      updateAppBadge();
    }

    // ãƒãƒƒã‚¸ã‚’å¢—ã‚„ã™
    function incrementBadge() {
      badgeCount++;
      localStorage.setItem('reborn-badge-count', badgeCount);
      updateBadgeDisplay();
      updateAppBadge();
      console.log('ğŸ”” ãƒãƒƒã‚¸ã‚«ã‚¦ãƒ³ãƒˆ +1:', badgeCount);
    }

    // ãƒãƒƒã‚¸ã‚’ã‚¯ãƒªã‚¢
    function clearBadge() {
      badgeCount = 0;
      localStorage.setItem('reborn-badge-count', 0);
      updateBadgeDisplay();
      updateAppBadge();
      console.log('ğŸ”” ãƒãƒƒã‚¸ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢');
    }

    // ãƒãƒƒã‚¸è¡¨ç¤ºã‚’æ›´æ–°
    function updateBadgeDisplay() {
      const badgeElement = document.getElementById('badge-count');
      if (badgeElement) {
        badgeElement.textContent = badgeCount;
        if (badgeCount > 0) {
          badgeElement.classList.add('active');
        } else {
          badgeElement.classList.remove('active');
        }
      }
    }
    */

    // App Badge API ã‚’æ›´æ–°ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ã®ãƒãƒƒã‚¸ï¼‰
    // çµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼šãƒãƒ£ãƒƒãƒˆæœªèª­ã®ã¿è¡¨ç¤º
    function updateAppBadge() {
      if ('setAppBadge' in navigator) {
        if (chatUnreadCount > 0) {
          navigator.setAppBadge(chatUnreadCount).catch(err => {
            console.error('âŒ Badge API ã‚¨ãƒ©ãƒ¼:', err);
          });
          console.log('ğŸ“± ã‚¢ãƒ—ãƒªãƒãƒƒã‚¸æ›´æ–°:', chatUnreadCount);
        } else {
          navigator.clearAppBadge().catch(err => {
            console.error('âŒ Badge API ã‚¨ãƒ©ãƒ¼:', err);
          });
          console.log('ğŸ“± ã‚¢ãƒ—ãƒªãƒãƒƒã‚¸ã‚¯ãƒªã‚¢');
        }
      }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚’é–‹ã
    function openUserSettings() {
      navigateToPage('config-basic');
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
    function loadUserIcon() {
      const iconUrl = localStorage.getItem('reborn_user_icon');
      const iconImage = document.getElementById('user-icon-image');
      const iconPlaceholder = document.getElementById('user-icon-placeholder');

      if (iconUrl) {
        // ã‚¢ã‚¤ã‚³ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç”»åƒã‚’è¡¨ç¤º
        iconImage.src = iconUrl;
        iconImage.style.display = 'block';
        iconPlaceholder.style.display = 'none';

        // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¡¨ç¤º
        iconImage.onerror = function() {
          console.warn('âš ï¸ ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã®èª­ã¿è¾¼ã¿å¤±æ•—:', iconUrl);
          iconImage.style.display = 'none';
          iconPlaceholder.style.display = 'block';
        };
      } else {
        // ã‚¢ã‚¤ã‚³ãƒ³ãŒæœªè¨­å®šã®å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¡¨ç¤º
        iconImage.style.display = 'none';
        iconPlaceholder.style.display = 'block';
      }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
    function updateUserIcon(iconUrl) {
      if (iconUrl) {
        localStorage.setItem('reborn_user_icon', iconUrl);
      } else {
        localStorage.removeItem('reborn_user_icon');
      }
      loadUserIcon();
    }

    // é€šçŸ¥ãƒšãƒ¼ã‚¸ã‚’é–‹ãï¼ˆPWAå†…ã§é·ç§»ï¼‰
    function openNotifications() {
      window.location.href = '/notifications.html';
    }

    // çµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼šService Workerã‹ã‚‰ã®ãƒãƒƒã‚¸æ›´æ–°ã¯ä¸è¦
    /*
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('message', (event) => {
        console.log('ğŸ“¨ Service Workerã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', event.data);

        if (event.data.type === 'INCREMENT_BADGE') {
          incrementBadge();
        }
      });
    }
    */

    // ========================================
    // ãƒãƒ£ãƒƒãƒˆFABæ©Ÿèƒ½
    // ========================================

    // ãƒãƒ£ãƒƒãƒˆä¸€è¦§ã‚’é–‹ã
    function openChatRooms() {
      console.log('[Chat FAB] ãƒãƒ£ãƒƒãƒˆä¸€è¦§ã‚’é–‹ã');

      const userName = localStorage.getItem('reborn_user_name') || '';
      const fcmToken = localStorage.getItem('fcm_token') || '';

      // pmTokenç”Ÿæˆ
      const pmToken = generatePmToken();
      localStorage.setItem('pm_token', pmToken);

      const params = new URLSearchParams({
        menu: 'chat_rooms',
        app: 'pwa',
        userName: userName,
        fcmToken: fcmToken,
        parentOrigin: window.location.origin,
        pmToken: pmToken,
        gasBaseUrl: window.REBORN_CONFIG.GAS_BASE_URL  // âœ… APIå‘¼ã³å‡ºã—ç”¨
      });

      const iframe = document.getElementById('gas-iframe');
      iframe.src = `${window.REBORN_CONFIG.GAS_BASE_URL}?${params.toString()}`;

      // ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’é–‹ã„ãŸã®ã§FABã‚’éè¡¨ç¤º
      hideChatFab();
    }

    // FABè¡¨ç¤ºåˆ¶å¾¡
    function showChatFab() {
      const fab = document.getElementById('chat-fab');
      if (fab) {
        fab.classList.remove('hidden');
      }
    }

    function hideChatFab() {
      const fab = document.getElementById('chat-fab');
      if (fab) {
        fab.classList.add('hidden');
      }
    }

    // çµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼šFABã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆä¸è¦ï¼ˆä¸Šéƒ¨ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ã«çµ±åˆï¼‰

    // æœªèª­ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°ï¼ˆFirebaseçµŒç”±ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼‰
    let chatUnreadCount = 0;

    function updateChatBadge(count) {
      console.log('[Chat Badge] ãƒãƒƒã‚¸æ›´æ–°:', count);
      chatUnreadCount = count;

      const badge = document.getElementById('chat-badge-count');
      if (badge) {
        if (count > 0) {
          badge.textContent = count > 99 ? '99+' : count.toString();
          badge.classList.add('active');
        } else {
          badge.textContent = '0';
          badge.classList.remove('active');
        }
      }

      // ã‚¢ãƒ—ãƒªã‚¢ã‚¤ã‚³ãƒ³ãƒãƒƒã‚¸ã‚‚æ›´æ–°ï¼ˆãƒãƒ£ãƒƒãƒˆæœªèª­ã®ã¿ï¼‰
      updateAppBadge();
    }

    // ğŸ”§ Firebaseå…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆã‚¢ãƒ—ãƒªé‡è¤‡åˆæœŸåŒ–é˜²æ­¢ï¼‰
    let _firebaseApp, _firestoreDb;
    async function getFirebaseDb() {
      if (_firestoreDb) return _firestoreDb;

      const { initializeApp, getApps } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
      const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

      const firebaseConfig = {
        apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjwwtCorUZQ",
        authDomain: "reborn-chat.firebaseapp.com",
        projectId: "reborn-chat",
        storageBucket: "reborn-chat.firebasestorage.app",
        messagingSenderId: "345706548795",
        appId: "1:345706548795:web:058a553da6b4b74db5161e"
      };

      _firebaseApp = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
      _firestoreDb = getFirestore(_firebaseApp);
      console.log('[Firebase] å…±é€šã‚¢ãƒ—ãƒªåˆæœŸåŒ–å®Œäº†');
      return _firestoreDb;
    }

    // Firestoreæœªèª­ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚¹ãƒ‹ãƒ³ã‚°
    async function startChatUnreadListener() {
      console.log('[Chat FAB] æœªèª­ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚¹ãƒ‹ãƒ³ã‚°é–‹å§‹');

      try {
        const userName = localStorage.getItem('reborn_user_name');
        if (!userName) {
          console.log('[Chat FAB] ãƒ¦ãƒ¼ã‚¶ãƒ¼åæœªè¨­å®šã®ãŸã‚ãƒªã‚¹ãƒ‹ãƒ³ã‚°ä¸­æ–­');
          return;
        }

        // Firebase SDKã‚’å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
        const { getFirestore, collection, doc, query, where, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        // Firebaseè¨­å®šï¼ˆreborn-chat ã«çµ±ä¸€ï¼‰
        const firebaseConfig = {
          apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjwwtCorUZQ",
          authDomain: "reborn-chat.firebaseapp.com",
          projectId: "reborn-chat",
          storageBucket: "reborn-chat.firebasestorage.app",
          messagingSenderId: "345706548795",
          appId: "1:345706548795:web:058a553da6b4b74db5161e"
        };

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig, 'chat-fab-app');
        const db = getFirestore(app);
        console.log('[Chat FAB] FirebaseåˆæœŸåŒ–å®Œäº†');

        // æœªèª­ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’åˆæœŸåŒ–
        if (!window.chatUnreadByRoom) window.chatUnreadByRoom = {};

        // æœªèª­ã‚«ã‚¦ãƒ³ãƒˆåˆè¨ˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateTotalUnread() {
          const totalUnread = Object.values(window.chatUnreadByRoom).reduce((sum, count) => sum + count, 0);
          console.log('[Chat FAB] æœªèª­ã‚«ã‚¦ãƒ³ãƒˆåˆè¨ˆ:', totalUnread, window.chatUnreadByRoom);
          updateChatBadge(totalUnread);
        }

        // ã€ãƒªã‚¹ãƒŠãƒ¼1ã€‘è‡ªåˆ†ãŒå‚åŠ ã—ã¦ã„ã‚‹é€šå¸¸ãƒ«ãƒ¼ãƒ ã‚’å–å¾—
        const roomsQuery = query(
          collection(db, 'rooms'),
          where('members', 'array-contains', userName)
        );

        onSnapshot(roomsQuery, (roomsSnapshot) => {
          console.log('[Chat FAB] é€šå¸¸ãƒ«ãƒ¼ãƒ æ•°:', roomsSnapshot.size);

          // å„ãƒ«ãƒ¼ãƒ ã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚’å–å¾—
          roomsSnapshot.forEach((roomDoc) => {
            const roomId = roomDoc.id;
            const unreadDocRef = doc(db, `rooms/${roomId}/unreadCounts/${userName}`);

            // å„ãƒ«ãƒ¼ãƒ ã®æœªèª­ã‚’ãƒªã‚¹ãƒ‹ãƒ³ã‚°
            onSnapshot(unreadDocRef, (unreadDoc) => {
              const unreadData = unreadDoc.data();
              const unreadCount = unreadData?.unreadCount || 0;

              // ã“ã®ãƒ«ãƒ¼ãƒ ã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚’è¨˜éŒ²
              window.chatUnreadByRoom[roomId] = unreadCount;
              console.log(`[Chat FAB] ${roomId} æœªèª­:`, unreadCount);

              // å…¨ãƒ«ãƒ¼ãƒ ã®æœªèª­ã‚’åˆè¨ˆã—ã¦æ›´æ–°
              updateTotalUnread();
            }, (error) => {
              console.error('[Chat FAB] ãƒ«ãƒ¼ãƒ ', roomId, 'ã®æœªèª­å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            });
          });
        }, (error) => {
          console.error('[Chat FAB] ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        });

        // ã€ãƒªã‚¹ãƒŠãƒ¼2ã€‘ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒ ï¼ˆå…¨ä½“ãƒ»ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ï¼‰ã‚’ç›´æ¥ãƒªã‚¹ãƒ‹ãƒ³ã‚°
        const defaultRoomIds = ['room_default_all', 'room_system_notifications'];

        defaultRoomIds.forEach((roomId) => {
          const unreadDocRef = doc(db, `rooms/${roomId}/unreadCounts/${userName}`);

          onSnapshot(unreadDocRef, (unreadDoc) => {
            const unreadData = unreadDoc.data();
            const unreadCount = unreadData?.unreadCount || 0;

            // ã“ã®ãƒ«ãƒ¼ãƒ ã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚’è¨˜éŒ²
            window.chatUnreadByRoom[roomId] = unreadCount;
            console.log(`[Chat FAB] ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒ  ${roomId} æœªèª­:`, unreadCount);

            // å…¨ãƒ«ãƒ¼ãƒ ã®æœªèª­ã‚’åˆè¨ˆã—ã¦æ›´æ–°
            updateTotalUnread();
          }, (error) => {
            console.log(`[Chat FAB] ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒ  ${roomId} æœªèª­å–å¾—:`, error.message, '(ãƒ«ãƒ¼ãƒ æœªä½œæˆã®å¯èƒ½æ€§)');
          });
        });

      } catch (error) {
        console.error('[Chat FAB] åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ã®è‡ªå‹•ä½œæˆ
    async function initializeSystemNotificationRoom() {
      console.log('[System Room] ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ åˆæœŸåŒ–é–‹å§‹');

      try {
        // Firebase SDKã‚’å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
        const { getFirestore, doc, getDoc, setDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        // Firebaseè¨­å®šï¼ˆreborn-chat ã«çµ±ä¸€ï¼‰
        const firebaseConfig = {
          apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjwwtCorUZQ",
          authDomain: "reborn-chat.firebaseapp.com",
          projectId: "reborn-chat",
          storageBucket: "reborn-chat.firebasestorage.app",
          messagingSenderId: "345706548795",
          appId: "1:345706548795:web:058a553da6b4b74db5161e"
        };

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig, 'system-room-init');
        const db = getFirestore(app);

        const systemRoomId = 'room_system_notifications';
        const systemRoomRef = doc(db, 'rooms', systemRoomId);

        // æ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
        const roomSnap = await getDoc(systemRoomRef);

        if (!roomSnap.exists()) {
          // ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ
          await setDoc(systemRoomRef, {
            roomId: systemRoomId,
            name: 'ğŸ“¢ ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥',
            type: 'system',
            icon: 'ğŸ“¢',
            members: [], // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
            createdBy: 'ã‚·ã‚¹ãƒ†ãƒ ',
            createdAt: serverTimestamp(),
            lastMessage: 'ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã—ãŸ',
            lastMessageAt: serverTimestamp(),
            lastMessageBy: 'ã‚·ã‚¹ãƒ†ãƒ '
          });

          console.log('[System Room] ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã—ãŸ');
        } else {
          // æ—¢å­˜ãƒ«ãƒ¼ãƒ ã«nameãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒç„¡ã„å ´åˆã¯è¿½åŠ ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
          const roomData = roomSnap.data();
          if (!roomData.name) {
            await setDoc(systemRoomRef, {
              name: 'ğŸ“¢ ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥',
              type: 'system',
              icon: 'ğŸ“¢'
            }, { merge: true });
            console.log('[System Room] ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ åã‚’æ›´æ–°ã—ã¾ã—ãŸ');
          } else {
            console.log('[System Room] ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');
          }
        }

      } catch (error) {
        console.error('[System Room] åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚’+1ã™ã‚‹é–¢æ•°
    async function incrementSystemNotificationUnreadCount() {
      console.log('[Badge] ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆ+1é–‹å§‹');

      const userName = localStorage.getItem('reborn_user_name');
      if (!userName) {
        console.error('[Badge] ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒå–å¾—ã§ãã¾ã›ã‚“');
        return;
      }

      try {
        // å…±é€šFirebaseã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—ï¼ˆé‡è¤‡åˆæœŸåŒ–é˜²æ­¢ï¼‰
        const db = await getFirebaseDb();
        const { doc, setDoc, increment } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        const systemRoomId = 'room_system_notifications';
        const unreadDocRef = doc(db, `rooms/${systemRoomId}/unreadCounts/${userName}`);

        // Firestore unreadCountã‚’+1ï¼ˆã‚¢ãƒˆãƒŸãƒƒã‚¯æ“ä½œï¼‰
        await setDoc(unreadDocRef, {
          unreadCount: increment(1)
        }, { merge: true });

        console.log('[Badge] Firestore unreadCount +1 å®Œäº†');

      } catch (error) {
        console.error('[Badge] Firestoreæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã€Œå…¨ä½“ã€ãƒ«ãƒ¼ãƒ ã®è‡ªå‹•ä½œæˆï¼ˆå‰Šé™¤ã•ã‚Œã¦ã‚‚å†ä½œæˆï¼‰
    async function initializeDefaultRoom() {
      console.log('[Default Room] å…¨ä½“ãƒ«ãƒ¼ãƒ åˆæœŸåŒ–é–‹å§‹');

      try {
        // Firebase SDKã‚’å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
        const { getFirestore, doc, getDoc, setDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        // Firebaseè¨­å®šï¼ˆreborn-chat ã«çµ±ä¸€ï¼‰
        const firebaseConfig = {
          apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjwwtCorUZQ",
          authDomain: "reborn-chat.firebaseapp.com",
          projectId: "reborn-chat",
          storageBucket: "reborn-chat.firebasestorage.app",
          messagingSenderId: "345706548795",
          appId: "1:345706548795:web:058a553da6b4b74db5161e"
        };

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig, 'default-room-init');
        const db = getFirestore(app);

        const defaultRoomId = 'room_default_all';
        const defaultRoomRef = doc(db, 'rooms', defaultRoomId);

        // æ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
        const roomSnap = await getDoc(defaultRoomRef);

        if (!roomSnap.exists()) {
          // å…¨ä½“ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ
          await setDoc(defaultRoomRef, {
            roomId: defaultRoomId,
            name: 'ğŸ’¬ å…¨ä½“',
            type: 'default',
            icon: 'ğŸ’¬',
            members: [], // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
            createdBy: 'ã‚·ã‚¹ãƒ†ãƒ ',
            createdAt: serverTimestamp(),
            lastMessage: 'å…¨ä½“ãƒ«ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã—ãŸ',
            lastMessageAt: serverTimestamp(),
            lastMessageBy: 'ã‚·ã‚¹ãƒ†ãƒ '
          });

          console.log('[Default Room] å…¨ä½“ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã—ãŸ');
        } else {
          console.log('[Default Room] å…¨ä½“ãƒ«ãƒ¼ãƒ ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');
        }

      } catch (error) {
        console.error('[Default Room] åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // GASã‹ã‚‰ã®postMessageã‚’å—ã‘å–ã£ã¦ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ã«æŠ•ç¨¿
    async function postSystemNotification(data) {
      console.log('[System Notification] é€šçŸ¥æŠ•ç¨¿é–‹å§‹:', data);

      try {
        // Firebase SDKã‚’å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
        const { getFirestore, collection, addDoc, doc, updateDoc, setDoc, serverTimestamp, increment } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        // Firebaseè¨­å®š
        const firebaseConfig = {
          apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjwwtCorUZQ",
          authDomain: "reborn-chat.firebaseapp.com",
          projectId: "reborn-chat",
          storageBucket: "reborn-chat.firebasestorage.app",
          messagingSenderId: "345706548795",
          appId: "1:345706548795:web:058a553da6b4b74db5161e"
        };

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig, 'system-notification-post');
        const db = getFirestore(app);

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ã‚’ä½œæˆ
        let messageText = '';

        if (data.type === 'PRODUCT_REGISTERED') {
          messageText = `[ğŸ‰ å•†å“ç™»éŒ²å®Œäº†] ${data.userName}\n`;
          messageText += `å•†å“å: ${data.productName}\n`;
          messageText += `ç®¡ç†ç•ªå·: ${data.managementNumber}\n`;
          if (data.listingDestination) {
            messageText += `å‡ºå“å…ˆ: ${data.listingDestination}\n`;
          }
          if (data.listingAmount) {
            const amount = Number(data.listingAmount);
            if (!isNaN(amount)) {
              messageText += `å‡ºå“é‡‘é¡: ${amount.toLocaleString()}å††\n`;
            }
          }
          messageText += `ç™»éŒ²æ—¥æ™‚: ${new Date(data.timestamp).toLocaleString('ja-JP')}`;
        }

        // ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ç¨¿
        const systemRoomId = 'room_system_notifications';
        await addDoc(collection(db, 'messages'), {
          roomId: systemRoomId,
          text: messageText,
          userName: 'ã‚·ã‚¹ãƒ†ãƒ ',
          timestamp: serverTimestamp(),
          deletedBy: []
        });

        // roomsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®lastMessageã‚’æ›´æ–°
        const roomRef = doc(db, 'rooms', systemRoomId);
        await updateDoc(roomRef, {
          lastMessage: messageText.split('\n')[0], // 1è¡Œç›®ã®ã¿
          lastMessageAt: serverTimestamp(),
          lastMessageBy: 'ã‚·ã‚¹ãƒ†ãƒ '
        });

        console.log('[System Notification] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æŠ•ç¨¿å®Œäº†');

        // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          console.log('[System Notification] å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°é–‹å§‹');

          google.script.run
            .withSuccessHandler(async function(userNames) {
              console.log('[System Notification] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—:', userNames);

              // å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚’+1ï¼ˆPromise.allã§ä¸¦åˆ—å®Ÿè¡Œï¼‰
              const updatePromises = userNames
                .filter(userName => userName && userName !== data.userName && userName !== 'ã‚·ã‚¹ãƒ†ãƒ ')
                .map(async (userName) => {
                  try {
                    const unreadRef = doc(db, `rooms/${systemRoomId}/unreadCounts/${userName}`);
                    await setDoc(unreadRef, {
                      userId: userName,
                      unreadCount: increment(1),
                      lastUpdated: serverTimestamp()
                    }, { merge: true });

                    console.log(`[System Notification] ${userName} ã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°å®Œäº†`);
                  } catch (err) {
                    console.error(`[System Notification] ${userName} ã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:`, err);
                  }
                });

              await Promise.all(updatePromises);
              console.log('[System Notification] å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°å®Œäº†');

              // ğŸ“¢ FCMãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’é€ä¿¡ï¼ˆçµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼‰
              console.log('[System Notification] FCMãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥é€ä¿¡é–‹å§‹');

              // FCMé€šçŸ¥ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’ä½œæˆ
              const fcmTitle = 'ğŸ‰ å•†å“ç™»éŒ²å®Œäº†';
              const fcmBody = messageText.replace(/\n/g, '\n'); // å®Ÿéš›ã®æ”¹è¡Œã«å¤‰æ›

              // ç™»éŒ²è€…ä»¥å¤–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«FCMé€ä¿¡
              const targetUsers = userNames.filter(userName => 
                userName && userName !== data.userName && userName !== 'ã‚·ã‚¹ãƒ†ãƒ '
              );

              if (targetUsers.length > 0) {
                google.script.run
                  .withSuccessHandler(function(result) {
                    console.log('[System Notification] âœ… FCMãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥é€ä¿¡å®Œäº†:', result);
                  })
                  .withFailureHandler(function(error) {
                    console.error('[System Notification] âŒ FCMãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                  })
                  .sendFCMNotificationToUsers(fcmTitle, fcmBody, targetUsers);
              } else {
                console.log('[System Notification] FCMé€ä¿¡å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã—ï¼ˆå…¨å“¡ãŒç™»éŒ²è€…ï¼‰');
              }
            })
            .withFailureHandler(function(error) {
              console.error('[System Notification] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            })
            .getAllUserNames();
        }

        console.log('[System Notification] é€šçŸ¥æŠ•ç¨¿å®Œäº†');

      } catch (error) {
        console.error('[System Notification] æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[Chat FAB] DOMContentLoaded - ãƒªã‚¹ãƒŠãƒ¼é–‹å§‹');

      // postMessageãƒªã‚¹ãƒŠãƒ¼ã¯æ—¢ã«è¡Œ1502ã§ç™»éŒ²æ¸ˆã¿ï¼ˆPRODUCT_REGISTEREDå‡¦ç†ã‚’è¿½åŠ æ¸ˆã¿ï¼‰

      initializeSystemNotificationRoom(); // ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ãƒ«ãƒ¼ãƒ ä½œæˆ
      initializeDefaultRoom(); // å…¨ä½“ãƒ«ãƒ¼ãƒ ä½œæˆ
      startChatUnreadListener();
    });

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã‚‚å®Ÿè¡Œï¼ˆå¿µã®ãŸã‚ï¼‰
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        console.log('[Chat FAB] DOMContentLoaded - ãƒªã‚¹ãƒŠãƒ¼é–‹å§‹');
        startChatUnreadListener();
      });
    } else {
      console.log('[Chat FAB] ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ¸ˆã¿ - ãƒªã‚¹ãƒŠãƒ¼å³æ™‚èµ·å‹•');
      startChatUnreadListener();
    }
  </script>

  <!-- ãƒãƒ£ãƒƒãƒˆFABå‰Šé™¤ï¼ˆçµ±åˆå‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼šä¸Šéƒ¨ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ã«çµ±åˆï¼‰ -->

  <!-- ãƒãƒ£ãƒƒãƒˆFABãƒªã‚¹ãƒŠãƒ¼ï¼ˆç‹¬ç«‹scriptãƒ–ãƒ­ãƒƒã‚¯ï¼‰ -->
  <script>
    (function() {
      console.log('[Chat FAB] ç‹¬ç«‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯å®Ÿè¡Œé–‹å§‹');

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«å®Ÿè¡Œ
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initChatFAB);
      } else {
        initChatFAB();
      }

      function initChatFAB() {
        console.log('[Chat FAB] åˆæœŸåŒ–é–‹å§‹ - readyState:', document.readyState);

        if (typeof startChatUnreadListener === 'function') {
          console.log('[Chat FAB] startChatUnreadListeneré–¢æ•°ã‚’æ¤œå‡º - å®Ÿè¡Œ');
          startChatUnreadListener();
        } else {
          console.error('[Chat FAB] startChatUnreadListeneré–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
      }
    })();
  </script>
</body>
</html>
