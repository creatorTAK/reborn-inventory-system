<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="REBORN">
  <title>REBORN 在庫管理システム</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">

  <!-- PWA Icons -->
  <link rel="apple-touch-icon" href="icon-180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

  <!-- Performance: プリコネクト（DNS解決・TCP・TLS接続を先行実行） -->
  <link rel="dns-prefetch" href="https://script.google.com">
  <link rel="dns-prefetch" href="https://www.gstatic.com">
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>

  <!-- GAS Web App URL（全iframe子ページから参照可能） -->
  <script>
    window.REBORN_CONFIG = {
      GAS_BASE_URL: "https://script.google.com/macros/s/AKfycbx6ybbRLDqKQJ8IR-NPoVP8981Gtozzz0N3880XanEGRS4--iZtset8PFrVcD_u9YAHMA/exec"
    };
  </script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body, html {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    /* セットアップ画面 */
    #setup-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow-y: scroll;
      -webkit-overflow-scrolling: touch;
      display: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      box-sizing: border-box;
      z-index: 9999;
    }

    .setup-container {
      background: white;
      border-radius: 16px;
      padding: 24px;
      padding-bottom: 40px;
      max-width: 500px;
      width: 100%;
      margin: 20px auto;
      margin-bottom: 60px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      box-sizing: border-box;
      min-height: fit-content;
    }

    .setup-title {
      color: #667eea;
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      text-align: center;
    }

    .setup-subtitle {
      color: #6b7280;
      font-size: 14px;
      text-align: center;
      margin-bottom: 24px;
    }

    .step-section {
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .step-number {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      text-align: center;
      line-height: 24px;
      font-size: 14px;
      font-weight: 600;
      margin-right: 8px;
    }

    .step-title {
      display: inline;
      font-weight: 600;
      color: #1f2937;
      font-size: 16px;
    }

    .step-button {
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
      transition: transform 0.2s;
    }

    .step-button:hover {
      transform: translateY(-2px);
    }

    .step-button:active {
      transform: translateY(0);
    }

    .step-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .step-button.success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .step-button.optional {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .step-result {
      margin-top: 12px;
      padding: 12px;
      background: white;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      font-size: 13px;
      color: #374151;
      white-space: pre-wrap;
      display: none;
    }

    .step-result.success {
      background: #f0fdf4;
      border-color: #22c55e;
      color: #15803d;
      display: block;
    }

    .step-result.error {
      background: #fef2f2;
      border-color: #ef4444;
      color: #dc2626;
      display: block;
    }

    .open-app-button {
      width: 100%;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 16px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 24px;
      transition: transform 0.2s;
      display: none;
    }

    .open-app-button:hover {
      transform: translateY(-2px);
    }

    .open-app-button:active {
      transform: translateY(0);
    }

    /* アプリ画面 */
    #app-screen {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ヘッダー（通知＋メニューボタン付き） */
    #app-header {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .app-title {
      color: white;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .app-title:hover {
      opacity: 0.8;
    }

    .app-title:active {
      opacity: 0.6;
    }

    /* ヘッダー右側ボタングループ */
    .header-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* 通知バッジボタン */
    .notification-button {
      position: relative;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .notification-button:active {
      transform: scale(0.95);
    }

    /* メニューボタン（☰） */
    .menu-button {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
      border-radius: 8px;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s;
      color: white;
      font-size: 24px;
      font-weight: 300;
    }

    .menu-button:active {
      transform: scale(0.95);
    }

    /* ドロワーオーバーレイ（背景暗転） */
    #drawer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    #drawer-overlay.active {
      display: block;
      opacity: 1;
    }

    /* ドロワーメニュー */
    #drawer-menu {
      position: fixed;
      top: 0;
      right: -280px;
      width: 280px;
      height: 100%;
      background: white;
      z-index: 2000;
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.2);
      transition: right 0.3s ease;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    #drawer-menu.active {
      right: 0;
    }

    .drawer-header {
      padding: 20px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 20px;
      font-weight: 600;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .drawer-item {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 16px;
      color: #1f2937;
      text-decoration: none;
      border-bottom: 1px solid #e5e7eb;
      transition: background 0.2s;
    }

    .drawer-item:hover {
      background: #f3f4f6;
    }

    .drawer-item.active {
      background: #ede9fe;
      color: #667eea;
      font-weight: 600;
    }

    .drawer-item.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    /* アコーディオンメニュー */
    .drawer-accordion {
      margin: 0;
    }

    .drawer-accordion-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      color: #374151;
      font-size: 15px;
      text-decoration: none;
      cursor: pointer;
      transition: background 0.2s;
    }

    .drawer-accordion-header:hover {
      background: #f3f4f6;
    }

    .drawer-accordion-arrow {
      transition: transform 0.3s;
      font-size: 12px;
    }

    .drawer-accordion.open .drawer-accordion-arrow {
      transform: rotate(180deg);
    }

    .drawer-accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .drawer-accordion.open .drawer-accordion-content {
      max-height: 500px;
    }

    .drawer-accordion-item {
      display: block;
      padding: 12px 20px 12px 40px;
      color: #6b7280;
      font-size: 14px;
      text-decoration: none;
      transition: background 0.2s, color 0.2s;
    }

    .drawer-accordion-item:hover {
      background: #f9fafb;
      color: #374151;
    }

    .notification-icon {
      font-size: 24px;
    }

    .badge-count {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #ef4444;
      color: white;
      border-radius: 12px;
      min-width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      padding: 0 6px;
      display: none;
    }

    .badge-count.active {
      display: flex;
    }

    #gas-iframe {
      width: 100%;
      height: 100%;
      border: none;
      flex: 1;
    }

    /* スケルトンUI（初期ロード中に表示） */
    #skeleton-loader {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #f9fafb;
      z-index: 100;
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
      transition: opacity 0.3s ease-out;
    }

    #skeleton-loader.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .skeleton-header {
      width: 100%;
      height: 60px;
      background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
      background-size: 200% 100%;
      animation: skeleton-pulse 1.5s ease-in-out infinite;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .skeleton-form {
      width: 100%;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .skeleton-input {
      width: 100%;
      height: 40px;
      background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
      background-size: 200% 100%;
      animation: skeleton-pulse 1.5s ease-in-out infinite;
      border-radius: 6px;
      margin-bottom: 16px;
    }

    .skeleton-button {
      width: 120px;
      height: 44px;
      background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
      background-size: 200% 100%;
      animation: skeleton-pulse 1.5s ease-in-out infinite;
      border-radius: 6px;
      margin-top: 10px;
    }

    @keyframes skeleton-pulse {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }
  </style>
</head>
<body>
  <!-- セットアップ画面（初回のみ） -->
  <div id="setup-screen">
    <div class="setup-container">
      <div class="setup-title">🔔 通知設定</div>
      <div class="setup-subtitle">初回のみ - 商品登録の通知を受け取るための設定です</div>

      <!-- ⓪ ユーザーID入力 -->
      <div class="step-section">
        <div>
          <span class="step-number">⓪</span>
          <span class="step-title">ユーザーID（メールアドレス）</span>
        </div>
        <input type="email" id="user-email-input" placeholder="your-email@example.com"
               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; margin-top: 8px;">
        <button class="step-button" onclick="saveUserEmail()" style="margin-top: 8px;">保存</button>
        <div id="step0-result" class="step-result"></div>
      </div>

      <!-- ① 通知を許可 -->
      <div class="step-section">
        <div>
          <span class="step-number">①</span>
          <span class="step-title">通知を許可</span>
        </div>
        <button class="step-button" onclick="requestNotificationPermission()">通知を許可</button>
        <div id="step1-result" class="step-result"></div>
      </div>

      <!-- ② FCM登録 -->
      <div class="step-section">
        <div>
          <span class="step-number">②</span>
          <span class="step-title">FCM登録</span>
        </div>
        <button class="step-button" onclick="subscribeToFCM()" id="step2-button" disabled>FCM登録</button>
        <div id="step2-result" class="step-result"></div>
      </div>

      <!-- ③ 通知テスト（任意） -->
      <div class="step-section">
        <div>
          <span class="step-number">③</span>
          <span class="step-title">通知テスト（任意）</span>
        </div>
        <button class="step-button optional" onclick="triggerServerNotification()" id="step3-button" disabled>テスト通知を送信</button>
        <div id="step3-result" class="step-result"></div>
      </div>

      <!-- アプリを開く -->
      <button class="open-app-button" onclick="openApp()" id="open-app-button">✅ アプリを開く</button>
    </div>
  </div>

  <!-- アプリ画面（2回目以降 or セットアップ完了後） -->
  <div id="app-screen">
    <!-- ヘッダー（通知ボタン + メニューボタン） -->
    <div id="app-header">
      <div class="app-title" onclick="navigateToPage('product')" title="商品登録に戻る">🔄 REBORN</div>
      <div class="header-buttons">
        <button class="notification-button" onclick="openNotifications()" title="通知">
          <span class="notification-icon">🔔</span>
          <span class="badge-count" id="badge-count">0</span>
        </button>
        <button class="menu-button" onclick="toggleDrawer()" title="メニュー">☰</button>
      </div>
    </div>

    <!-- ドロワーオーバーレイ -->
    <div id="drawer-overlay" onclick="closeDrawer()"></div>

    <!-- ドロワーメニュー -->
    <div id="drawer-menu">
      <div class="drawer-header">メニュー</div>
      <a href="#" onclick="navigateToPage('product'); return false;" class="drawer-item active" id="drawer-product">
        📝 商品登録
      </a>
      <a href="#" onclick="navigateToPage('inventory'); return false;" class="drawer-item" id="drawer-inventory">
        📦 在庫管理
      </a>
      <a href="#" onclick="navigateToPage('inventory_history'); return false;" class="drawer-item" id="drawer-inventory-history">
        📊 入出庫履歴
      </a>
      <a href="#" class="drawer-item disabled">
        📈 売上
      </a>
      
      <!-- マスタ・設定アコーディオン -->
      <div class="drawer-accordion" id="drawer-master-config">
        <a href="#" class="drawer-accordion-header" onclick="toggleMasterConfigAccordion(); return false;">
          🗂️ マスタ・設定
          <span class="drawer-accordion-arrow">▼</span>
        </a>
        <div class="drawer-accordion-content">
          <a href="#" onclick="navigateToPage('shipping-master'); return false;" class="drawer-accordion-item" id="drawer-shipping-master">
            🚚 発送方法マスタ管理
          </a>
          <a href="#" onclick="navigateToPage('packaging-master'); return false;" class="drawer-accordion-item" id="drawer-packaging-master">
            📦 梱包資材マスタ管理
          </a>
          <a href="#" onclick="navigateToPage('config'); return false;" class="drawer-accordion-item" id="drawer-config">
            ⚙️ 設定管理
          </a>
        </div>
      </div>
    </div>

    <!-- スケルトンUI（初期ロード中のプレースホルダー） -->
    <div id="skeleton-loader">
      <div class="skeleton-header"></div>
      <div class="skeleton-form">
        <div class="skeleton-input"></div>
        <div class="skeleton-input"></div>
        <div class="skeleton-input"></div>
        <div class="skeleton-input"></div>
        <div class="skeleton-button"></div>
      </div>
    </div>

    <!-- GAS Web App を iframe で表示（遅延ロード: DOMContentLoaded後に src設定） -->
    <iframe
      id="gas-iframe"
      data-src="https://script.google.com/macros/s/AKfycbx6ybbRLDqKQJ8IR-NPoVP8981Gtozzz0N3880XanEGRS4--iZtset8PFrVcD_u9YAHMA/exec?v=408&ts=20251030">
    </iframe>
  </div>

  <!-- Firebase SDKs (Modular format) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getMessaging, onMessage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js';

    // Firebase 設定
    const firebaseConfig = {
      apiKey: "AIzaSyAwJKTz1gm3CIz_R4YTlbQopgaBq1ULt1A",
      authDomain: "reborn-pwa.firebaseapp.com",
      projectId: "reborn-pwa",
      storageBucket: "reborn-pwa.firebasestorage.app",
      messagingSenderId: "345653439471",
      appId: "1:345653439471:web:7620819ce3f022d9cd241a",
      measurementId: "G-SX48K45X75"
    };

    // Firebase 初期化
    const app = initializeApp(firebaseConfig);
    const messaging = getMessaging(app);

    // グローバル変数として公開
    window.firebaseMessaging = messaging;

    // ★ フォアグラウンド通知対応 ★
    // アプリを開いている状態で通知を受信した時の処理
    onMessage(messaging, (payload) => {
      console.log('📨 フォアグラウンドメッセージ受信:', payload);

      // 通知データを取得
      const notificationTitle = payload.data?.title || payload.notification?.title || 'REBORN';
      const notificationBody = payload.data?.body || payload.notification?.body || '新しい通知があります';

      // バッジを更新（グローバル関数を呼び出し）
      if (typeof window.incrementBadge === 'function') {
        window.incrementBadge();
        console.log('🔔 バッジをインクリメントしました');
      }

      // ブラウザ通知を表示（ユーザーに気づいてもらうため）
      if (Notification.permission === 'granted') {
        new Notification(notificationTitle, {
          body: notificationBody,
          icon: '/reborn-inventory-system/icon-180.png',
          badge: '/reborn-inventory-system/icon-192.png',
          tag: 'reborn-notification',
          requireInteraction: false  // 自動で消える
        });
        console.log('🔔 ブラウザ通知を表示しました');
      }
    });
  </script>

  <script>
    // GAS API URL
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbx6ybbRLDqKQJ8IR-NPoVP8981Gtozzz0N3880XanEGRS4--iZtset8PFrVcD_u9YAHMA/exec';

    // VAPID公開鍵
    const VAPID_PUBLIC_KEY = 'BLt5H1TPMi9OetYHgqoDXVoSkPQziC0Ulimr1-xv8rPObF693SCMWkzP8UhZLMaZzYGd_jP5V3JugDTROjKInbY';

    // Service Worker registration（グローバル変数）
    let swRegistration = null;

    // ページ読み込み時の初期化（DOMContentLoaded: より高速）
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('⚡ DOMContentLoaded - 初期化開始');

      // Service Worker登録
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
          swRegistration = registration;
          console.log('✅ Service Worker 登録成功:', registration.scope);
        } catch (error) {
          console.error('❌ Service Worker 登録失敗:', error);
        }
      }

      // バッジを初期化
      initBadge();

      // セットアップ完了済みかチェック
      const setupCompleted = localStorage.getItem('fcm-setup-completed');
      if (setupCompleted !== '1') {
        // 初回 → セットアップ画面を表示
        document.getElementById('setup-screen').style.display = 'flex';
        document.getElementById('app-screen').style.display = 'none';
      }
      // セットアップ完了済みの場合は何もしない（デフォルトでアプリ画面が表示されている）

      // iframe読み込み完了時にスケルトンUIを非表示
      const iframe = document.getElementById('gas-iframe');
      const skeleton = document.getElementById('skeleton-loader');

      if (iframe && skeleton) {
        iframe.addEventListener('load', () => {
          console.log('✅ iframe読み込み完了 - スケルトンUI非表示');
          skeleton.classList.add('hidden');
          // 0.3秒後に完全に削除（transitionと同期）
          setTimeout(() => {
            skeleton.style.display = 'none';
          }, 300);
        });

        // 🚀 iframe遅延ロード: 初期表示を高速化
        // DOM構築完了後、少し待ってからiframeを読み込み開始
        console.log('⏱️ iframe遅延ロード: 100ms後に開始');
        setTimeout(() => {
          const iframeSrc = iframe.getAttribute('data-src');
          if (iframeSrc) {
            console.log('🚀 iframe読み込み開始:', iframeSrc);
            iframe.src = iframeSrc;
          }
        }, 100); // 100ms遅延（体感速度向上のため）
      }
    });

    // ⓪ ユーザーIDを保存
    function saveUserEmail() {
      const emailInput = document.getElementById('user-email-input');
      const resultDiv = document.getElementById('step0-result');
      const step1Button = document.querySelector('button[onclick="requestNotificationPermission()"]');

      const email = emailInput.value.trim();

      if (!email) {
        resultDiv.textContent = '❌ メールアドレスを入力してください';
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
        return;
      }

      // 簡易的なメールアドレス検証
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        resultDiv.textContent = '❌ 有効なメールアドレスを入力してください';
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
        return;
      }

      // LocalStorageに保存
      try {
        localStorage.setItem('reborn_user_email', email);
        console.log('✅ ユーザーID保存:', email);

        resultDiv.textContent = '✅ ユーザーIDを保存しました！\n次に「① 通知を許可」ボタンを押してください。';
        resultDiv.className = 'step-result success';
        resultDiv.style.display = 'block';

        // 入力フィールドを無効化
        emailInput.disabled = true;
      } catch (error) {
        console.error('❌ LocalStorage保存エラー:', error);
        resultDiv.textContent = '❌ 保存に失敗しました: ' + error.message;
        resultDiv.className = 'step-result error';
        resultDiv.style.display = 'block';
      }
    }

    // ① 通知を許可
    async function requestNotificationPermission() {
      const resultDiv = document.getElementById('step1-result');
      const step2Button = document.getElementById('step2-button');

      if (!('Notification' in window)) {
        resultDiv.textContent = '❌ このブラウザはプッシュ通知に対応していません';
        resultDiv.className = 'step-result error';
        return;
      }

      try {
        const permission = await Notification.requestPermission();

        if (permission === 'granted') {
          resultDiv.textContent = '✅ 通知が許可されました！\n次に「② FCM登録」ボタンを押してください。';
          resultDiv.className = 'step-result success';

          // ② を有効化
          step2Button.disabled = false;
        } else {
          resultDiv.textContent = '❌ 通知が拒否されました\n設定から許可してください。';
          resultDiv.className = 'step-result error';
        }
      } catch (error) {
        resultDiv.textContent = '❌ エラー: ' + error.message;
        resultDiv.className = 'step-result error';
      }
    }

    // ② FCM登録
    async function subscribeToFCM() {
      const resultDiv = document.getElementById('step2-result');
      const step3Button = document.getElementById('step3-button');
      const openAppButton = document.getElementById('open-app-button');

      if (Notification.permission !== 'granted') {
        resultDiv.textContent = '❌ 通知が許可されていません\n「① 通知を許可」ボタンを押してください。';
        resultDiv.className = 'step-result error';
        return;
      }

      // Service Worker登録確認
      if (!swRegistration) {
        resultDiv.textContent = '❌ Service Workerが登録されていません\nページをリロードしてください。';
        resultDiv.className = 'step-result error';
        console.error('❌ swRegistration is null');
        return;
      }

      console.log('✅ Service Worker準備完了:', swRegistration);

      try {
        resultDiv.textContent = '登録中...';
        resultDiv.className = 'step-result';
        resultDiv.style.display = 'block';

        // Firebase Messagingからトークンを取得
        const { getToken } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js');

        console.log('🔄 FCMトークン取得開始...');
        console.log('  - firebaseMessaging:', window.firebaseMessaging);
        console.log('  - vapidKey:', VAPID_PUBLIC_KEY);
        console.log('  - swRegistration:', swRegistration);

        const currentToken = await getToken(window.firebaseMessaging, {
          vapidKey: VAPID_PUBLIC_KEY,
          serviceWorkerRegistration: swRegistration
        });

        console.log('✅ FCMトークン取得成功:', currentToken);

        if (currentToken) {
          console.log('📱 FCMトークン:', currentToken);

          // デバイス情報を取得
          const deviceInfo = {
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            language: navigator.language,
            screenSize: `${screen.width}x${screen.height}`,
            timestamp: new Date().toISOString()
          };
          console.log('📱 デバイス情報:', deviceInfo);

          // LocalStorageからユーザーIDを取得
          const userEmail = localStorage.getItem('reborn_user_email') || 'unknown';
          console.log('📧 ユーザーID:', userEmail);

          // GASにトークン、デバイス情報、ユーザーIDを送信
          const response = await fetch(GAS_API_URL + '?action=subscribeFCM&token=' + encodeURIComponent(currentToken) +
                                      '&deviceInfo=' + encodeURIComponent(JSON.stringify(deviceInfo)) +
                                      '&userId=' + encodeURIComponent(userEmail));

          if (response.ok) {
            const data = await response.json();
            resultDiv.textContent = '✅ FCM登録が完了しました！\n\n下の「アプリを開く」ボタンを押してください。\n\n※ 通知テストは任意です（スキップ可）';
            resultDiv.className = 'step-result success';

            // ③ を有効化
            step3Button.disabled = false;

            // 「アプリを開く」ボタンを表示
            openAppButton.style.display = 'block';
          } else {
            throw new Error('HTTP ' + response.status);
          }
        } else {
          throw new Error('トークンの取得に失敗しました');
        }
      } catch (error) {
        resultDiv.textContent = '❌ 登録失敗\n\nエラー: ' + error.message;
        resultDiv.className = 'step-result error';
        console.error('❌ FCM登録エラー:', error);
      }
    }

    // ③ サーバーから通知を送信（任意）
    async function triggerServerNotification() {
      const resultDiv = document.getElementById('step3-result');

      try {
        resultDiv.textContent = '送信中...';
        resultDiv.className = 'step-result';
        resultDiv.style.display = 'block';

        const title = '🎉 REBORN テスト通知';
        const body = '通知設定が正しく完了しました！';

        // Base64エンコード
        const titleEncoded = btoa(encodeURIComponent(title));
        const bodyEncoded = btoa(encodeURIComponent(body));

        // GETリクエスト
        const url = GAS_API_URL + '?action=sendFCM&title=' + titleEncoded + '&body=' + bodyEncoded;
        const response = await fetch(url);

        if (response.ok) {
          const data = await response.json();
          resultDiv.textContent = '✅ サーバーから通知を送信しました！\n\n⚠️ ホーム画面に戻って通知が届くか確認してください。';
          resultDiv.className = 'step-result success';
        } else {
          throw new Error('HTTP ' + response.status);
        }
      } catch (error) {
        resultDiv.textContent = '❌ 送信失敗\n\nエラー: ' + error.message;
        resultDiv.className = 'step-result error';
        console.error('❌ 通知送信エラー:', error);
      }
    }

    // アプリを開く
    function openApp() {
      // セットアップ完了フラグを保存
      localStorage.setItem('fcm-setup-completed', '1');

      // アプリ画面を表示
      showAppScreen();
    }

    // アプリ画面を表示
    function showAppScreen() {
      document.getElementById('setup-screen').style.display = 'none';
      document.getElementById('app-screen').style.display = 'flex';
    }

    // ドロワーメニューを開く/閉じる
    function toggleDrawer() {
      const drawer = document.getElementById('drawer-menu');
      const overlay = document.getElementById('drawer-overlay');

      drawer.classList.toggle('active');
      overlay.classList.toggle('active');
    }

    // ドロワーメニューを閉じる
    function closeDrawer() {
      const drawer = document.getElementById('drawer-menu');
      const overlay = document.getElementById('drawer-overlay');

      drawer.classList.remove('active');
      overlay.classList.remove('active');
    }

    // アコーディオン開閉
    function toggleMasterConfigAccordion() {
      const accordion = document.getElementById('drawer-master-config');
      accordion.classList.toggle('open');
    }

    // ページ遷移（ドロワーメニューから）
    function navigateToPage(page) {
      const iframe = document.getElementById('gas-iframe');
      const baseUrl = 'https://script.google.com/macros/s/AKfycbx6ybbRLDqKQJ8IR-NPoVP8981Gtozzz0N3880XanEGRS4--iZtset8PFrVcD_u9YAHMA/exec';

      // アクティブ状態を更新
      document.querySelectorAll('.drawer-item').forEach(item => {
        item.classList.remove('active');
      });

      if (page === 'product') {
        iframe.src = baseUrl + '?menu=product';
        document.getElementById('drawer-product').classList.add('active');
      } else if (page === 'config') {
        iframe.src = baseUrl + '?menu=config';
        document.getElementById('drawer-config').classList.add('active');
      } else if (page === 'inventory') {
        iframe.src = baseUrl + '?menu=inventory';
        document.getElementById('drawer-inventory').classList.add('active');
      } else if (page === 'inventory_history') {
        iframe.src = baseUrl + '?menu=inventory_history';
        document.getElementById('drawer-inventory-history').classList.add('active');
      } else if (page === 'shipping-master') {
        iframe.src = baseUrl + '?menu=shipping-master';
        document.getElementById('drawer-shipping-master').classList.add('active');
      } else if (page === 'packaging-master') {
        iframe.src = baseUrl + '?menu=packaging-master';
        document.getElementById('drawer-packaging-master').classList.add('active');
      }

      // ドロワーを閉じる
      closeDrawer();
    }

    // postMessage受信処理（iframe内からのナビゲーション要求 + バッジ更新）
    window.addEventListener('message', function(event) {
      // セキュリティ: GASのサンドボックスiframe（googleusercontent.com）からのメッセージを許可
      const isValidOrigin = event.origin === 'https://script.google.com' ||
                           event.origin.includes('googleusercontent.com');

      if (!isValidOrigin) {
        console.warn('⚠️ 不正なオリジンからのメッセージを拒否:', event.origin);
        return;
      }

      console.log('📨 受信メッセージ (from ' + event.origin + '):', event.data);

      // ナビゲーション要求の処理
      if (event.data.type === 'navigate' && event.data.url) {
        const iframe = document.getElementById('gas-iframe');
        console.log('🚀 ナビゲーション:', event.data.url);
        iframe.src = event.data.url;
      }

      // バッジ更新要求の処理
      if (event.data.type === 'INCREMENT_BADGE') {
        incrementBadge();
      }
    });

    // 🔔 バッジ管理システム
    let badgeCount = 0;

    // バッジカウントを初期化（localStorage から読み込み）
    function initBadge() {
      const saved = localStorage.getItem('reborn-badge-count');
      badgeCount = saved ? parseInt(saved, 10) : 0;
      updateBadgeDisplay();
      updateAppBadge();
    }

    // バッジを増やす
    function incrementBadge() {
      badgeCount++;
      localStorage.setItem('reborn-badge-count', badgeCount);
      updateBadgeDisplay();
      updateAppBadge();
      console.log('🔔 バッジカウント +1:', badgeCount);
    }

    // バッジをクリア
    function clearBadge() {
      badgeCount = 0;
      localStorage.setItem('reborn-badge-count', 0);
      updateBadgeDisplay();
      updateAppBadge();
      console.log('🔔 バッジカウントをクリア');
    }

    // バッジ表示を更新
    function updateBadgeDisplay() {
      const badgeElement = document.getElementById('badge-count');
      if (badgeElement) {
        badgeElement.textContent = badgeCount;
        if (badgeCount > 0) {
          badgeElement.classList.add('active');
        } else {
          badgeElement.classList.remove('active');
        }
      }
    }

    // App Badge API を更新（アイコンのバッジ）
    function updateAppBadge() {
      if ('setAppBadge' in navigator) {
        if (badgeCount > 0) {
          navigator.setAppBadge(badgeCount).catch(err => {
            console.error('❌ Badge API エラー:', err);
          });
        } else {
          navigator.clearAppBadge().catch(err => {
            console.error('❌ Badge API エラー:', err);
          });
        }
      }
    }

    // 通知ページを開く
    function openNotifications() {
      window.location.href = '/notifications.html';
    }

    // Service Workerからのメッセージ受信（バッジ更新）
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('message', (event) => {
        console.log('📨 Service Workerからメッセージ:', event.data);

        if (event.data.type === 'INCREMENT_BADGE') {
          incrementBadge();
        }
      });
    }
  </script>
</body>
</html>
