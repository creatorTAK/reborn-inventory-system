<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>お知らせ管理 - FURIRA Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    .admin-header {
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      color: white;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .admin-header h1 {
      font-size: 18px;
      font-weight: 700;
      margin: 0;
    }
    .admin-header .badge {
      background: rgba(255,255,255,0.2);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
    }
    .content-container {
      padding: 16px;
      max-width: 800px;
      margin: 0 auto;
    }

    /* アクセス拒否画面 */
    .access-denied {
      text-align: center;
      padding: 60px 20px;
    }
    .access-denied i {
      font-size: 64px;
      color: #ef4444;
      margin-bottom: 16px;
    }
    .access-denied h2 {
      font-size: 24px;
      color: #1f2937;
      margin-bottom: 8px;
    }
    .access-denied p {
      color: #6b7280;
    }

    /* カード */
    .admin-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .admin-card h3 {
      font-size: 16px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .admin-card h3 i {
      color: #6366f1;
    }

    /* フォーム */
    .form-label {
      font-weight: 600;
      color: #374151;
      margin-bottom: 6px;
    }
    .form-control {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 15px;
    }
    .form-control:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    textarea.form-control {
      min-height: 120px;
      resize: vertical;
    }

    /* 重要度バッジ */
    .priority-selector {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .priority-btn {
      padding: 8px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .priority-btn:hover {
      border-color: #6366f1;
    }
    .priority-btn.active {
      border-color: #6366f1;
      background: #eef2ff;
      color: #4f46e5;
    }
    .priority-btn.info { color: #0ea5e9; }
    .priority-btn.info.active { background: #e0f2fe; border-color: #0ea5e9; }
    .priority-btn.warning { color: #f59e0b; }
    .priority-btn.warning.active { background: #fef3c7; border-color: #f59e0b; }
    .priority-btn.danger { color: #ef4444; }
    .priority-btn.danger.active { background: #fee2e2; border-color: #ef4444; }

    /* 投稿ボタン */
    .btn-submit {
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn-submit:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }
    .btn-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* お知らせ一覧 */
    .announce-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      margin-bottom: 10px;
      transition: all 0.2s;
    }
    .announce-item:hover {
      border-color: #6366f1;
      background: #fafaff;
    }
    .announce-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .announce-icon.info { background: #e0f2fe; color: #0ea5e9; }
    .announce-icon.warning { background: #fef3c7; color: #f59e0b; }
    .announce-icon.danger { background: #fee2e2; color: #ef4444; }
    .announce-content {
      flex: 1;
      min-width: 0;
    }
    .announce-title {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
      font-size: 14px;
    }
    .announce-body {
      font-size: 13px;
      color: #6b7280;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .announce-meta {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }
    .announce-actions {
      display: flex;
      gap: 6px;
    }
    .announce-actions button {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 6px;
      background: #f3f4f6;
      color: #6b7280;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .announce-actions button:hover {
      background: #e5e7eb;
      color: #1f2937;
    }
    .announce-actions button.delete:hover {
      background: #fee2e2;
      color: #ef4444;
    }

    /* 統計 */
    .stats-row {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    .stat-box {
      flex: 1;
      background: #f8fafc;
      border-radius: 10px;
      padding: 14px;
      text-align: center;
    }
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
    }
    .stat-label {
      font-size: 12px;
      color: #6b7280;
      margin-top: 2px;
    }

    /* 空状態 */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #9ca3af;
    }
    .empty-state i {
      font-size: 48px;
      margin-bottom: 12px;
    }

    /* ローディング */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .loading-overlay.hidden {
      display: none;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e5e7eb;
      border-top-color: #6366f1;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- ローディング -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <!-- アクセス拒否画面 -->
  <div id="accessDenied" style="display: none;">
    <div class="admin-header">
      <i class="bi bi-shield-lock"></i>
      <h1>アクセス制限</h1>
    </div>
    <div class="access-denied">
      <i class="bi bi-x-circle"></i>
      <h2>アクセスが拒否されました</h2>
      <p>このページは管理者専用です。<br>権限のあるアカウントでログインしてください。</p>
    </div>
  </div>

  <!-- 管理画面 -->
  <div id="adminContent" style="display: none;">
    <div class="admin-header">
      <i class="bi bi-megaphone"></i>
      <h1>お知らせ管理</h1>
      <span class="badge">Admin</span>
    </div>

    <div class="content-container">
      <!-- 統計 -->
      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-value" id="statTotal">0</div>
          <div class="stat-label">全投稿数</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="statActive">0</div>
          <div class="stat-label">公開中</div>
        </div>
      </div>

      <!-- 新規投稿 -->
      <div class="admin-card">
        <h3><i class="bi bi-plus-circle"></i> 新規お知らせ投稿</h3>
        <form id="announceForm">
          <div class="mb-3">
            <label class="form-label">タイトル</label>
            <input type="text" class="form-control" id="announceTitle" placeholder="お知らせのタイトル" required>
          </div>
          <div class="mb-3">
            <label class="form-label">本文</label>
            <textarea class="form-control" id="announceBody" placeholder="お知らせの内容を入力..." required></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">重要度</label>
            <div class="priority-selector">
              <button type="button" class="priority-btn info active" data-priority="info">
                <i class="bi bi-info-circle"></i> 通常
              </button>
              <button type="button" class="priority-btn warning" data-priority="warning">
                <i class="bi bi-exclamation-triangle"></i> 注意
              </button>
              <button type="button" class="priority-btn danger" data-priority="danger">
                <i class="bi bi-exclamation-circle"></i> 重要
              </button>
            </div>
          </div>
          <button type="submit" class="btn-submit" id="submitBtn">
            <i class="bi bi-send"></i> 投稿する
          </button>
        </form>
      </div>

      <!-- 投稿一覧 -->
      <div class="admin-card">
        <h3><i class="bi bi-list-ul"></i> 投稿一覧</h3>
        <div id="announceList">
          <div class="empty-state">
            <i class="bi bi-megaphone"></i>
            <div>お知らせはまだありません</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, doc, getDocs, addDoc, deleteDoc, query, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase設定
    const firebaseConfig = {
      apiKey: "AIzaSyDI9rrfU1ANwMVfwLWYHMg9iB9vlyur-jM",
      authDomain: "furira.jp",
      projectId: "reborn-ba679",
      storageBucket: "reborn-ba679.appspot.com",
      messagingSenderId: "1046498019402",
      appId: "1:1046498019402:web:78e1e4eb6c07ad23d18ba7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 管理者メールアドレス（ここに管理者のメールを設定）
    const ADMIN_EMAILS = [
      'mercari.yasuhirotakuji@gmail.com'
      // 必要に応じて他の管理者メールを追加
    ];

    let announcements = [];
    let selectedPriority = 'info';
    let editingId = null;

    // 初期化
    async function init() {
      const userEmail = localStorage.getItem('reborn_user_email');

      // 管理者チェック
      if (!userEmail || !ADMIN_EMAILS.includes(userEmail)) {
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('accessDenied').style.display = 'block';
        console.log('アクセス拒否: ', userEmail);
        return;
      }

      // 管理者として認証成功
      document.getElementById('loadingOverlay').classList.add('hidden');
      document.getElementById('adminContent').style.display = 'block';

      // イベントリスナー設定
      setupEventListeners();

      // お知らせ一覧読み込み
      await loadAnnouncements();
    }

    function setupEventListeners() {
      // 重要度選択
      document.querySelectorAll('.priority-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.priority-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedPriority = btn.dataset.priority;
        });
      });

      // フォーム送信
      document.getElementById('announceForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await submitAnnouncement();
      });
    }

    async function loadAnnouncements() {
      try {
        const announcementsRef = collection(db, 'announcements');
        const snapshot = await getDocs(announcementsRef);

        announcements = [];
        snapshot.forEach(docSnap => {
          announcements.push({ id: docSnap.id, ...docSnap.data() });
        });

        // 日付で降順ソート
        announcements.sort((a, b) => {
          const dateA = a.createdAt?.toDate?.() || new Date(a.createdAt) || new Date(0);
          const dateB = b.createdAt?.toDate?.() || new Date(b.createdAt) || new Date(0);
          return dateB - dateA;
        });

        updateStats();
        renderAnnouncements();
      } catch (error) {
        console.error('お知らせ読み込みエラー:', error);
        alert('お知らせの読み込みに失敗しました');
      }
    }

    function updateStats() {
      document.getElementById('statTotal').textContent = announcements.length;
      document.getElementById('statActive').textContent = announcements.length; // 将来的に公開/非公開管理する場合に備える
    }

    function renderAnnouncements() {
      const container = document.getElementById('announceList');

      if (announcements.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="bi bi-megaphone"></i>
            <div>お知らせはまだありません</div>
          </div>
        `;
        return;
      }

      const iconMap = {
        info: 'bi-info-circle',
        warning: 'bi-exclamation-triangle',
        danger: 'bi-exclamation-circle'
      };

      container.innerHTML = announcements.map(item => {
        const date = item.createdAt?.toDate?.() || new Date(item.createdAt) || new Date();
        const dateStr = date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        const priority = item.priority || 'info';

        return `
          <div class="announce-item">
            <div class="announce-icon ${priority}">
              <i class="bi ${iconMap[priority]}"></i>
            </div>
            <div class="announce-content">
              <div class="announce-title">${escapeHtml(item.title)}</div>
              <div class="announce-body">${escapeHtml(item.body)}</div>
              <div class="announce-meta">${dateStr}</div>
            </div>
            <div class="announce-actions">
              <button class="delete" onclick="deleteAnnouncement('${item.id}')" title="削除">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function submitAnnouncement() {
      const title = document.getElementById('announceTitle').value.trim();
      const body = document.getElementById('announceBody').value.trim();

      if (!title || !body) {
        alert('タイトルと本文を入力してください');
        return;
      }

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 投稿中...';

      try {
        await addDoc(collection(db, 'announcements'), {
          title,
          body,
          priority: selectedPriority,
          createdAt: serverTimestamp()
        });

        // フォームリセット
        document.getElementById('announceForm').reset();
        document.querySelectorAll('.priority-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('.priority-btn.info').classList.add('active');
        selectedPriority = 'info';

        // 一覧更新
        await loadAnnouncements();

        alert('お知らせを投稿しました');
      } catch (error) {
        console.error('投稿エラー:', error);
        alert('投稿に失敗しました: ' + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-send"></i> 投稿する';
      }
    }

    window.deleteAnnouncement = async function(id) {
      if (!confirm('このお知らせを削除しますか？')) return;

      try {
        await deleteDoc(doc(db, 'announcements', id));
        await loadAnnouncements();
        alert('削除しました');
      } catch (error) {
        console.error('削除エラー:', error);
        alert('削除に失敗しました: ' + error.message);
      }
    };

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, char => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      })[char]);
    }

    // 初期化実行
    init();
  </script>
</body>
</html>
