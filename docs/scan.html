<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<title>QRã‚¹ã‚­ãƒ£ãƒ³ - FURIRA</title>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- html5-qrcode -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<style>
  * {
    box-sizing: border-box;
  }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #f5f5f5;
    margin: 0;
    padding: 0;
    min-height: 100vh;
  }
  
  /* ãƒ˜ãƒƒãƒ€ãƒ¼ - v296: ãƒœãƒˆãƒ ãƒŠãƒ“ã‚¹ã‚¿ã‚¤ãƒ«ã«çµ±ä¸€ */
  .header {
    background: linear-gradient(135deg, var(--reborn-primary, #40B4E5) 0%, var(--reborn-primary-dark, #1E8FBF) 100%);
    color: white;
    padding: 28px 20px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }
  .header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .header-title {
    font-size: 22px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
    justify-content: center;
  }
  .header-title i {
    font-size: 22px;
  }
  .back-button {
    width: 42px;
    height: 42px;
    border: none;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.2s;
    color: white;
    font-size: 20px;
  }
  .back-button:active {
    background: rgba(255, 255, 255, 0.3);
  }
  .menu-button {
    width: 42px;
    height: 42px;
    border: none;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.2s;
    color: white;
    font-size: 20px;
  }
  .menu-button:active {
    background: rgba(255, 255, 255, 0.3);
  }

  /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
  .content {
    max-width: 600px;
    margin: 0 auto;
    padding: 16px;
  }
  
  /* ã‚«ãƒ¼ãƒ‰ */
  .card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border: none;
  }
  .card-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 16px;
    color: #333;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  /* ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ */
  #reader {
    width: 100%;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
  }
  #reader video {
    border-radius: 12px;
  }

  /* ã‚¹ã‚­ãƒ£ãƒ³ã‚¬ã‚¤ãƒ‰ãƒ•ãƒ¬ãƒ¼ãƒ  */
  .scan-guide-container {
    position: relative;
  }
  .scan-guide-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 200px;
    height: 200px;
    pointer-events: none;
    z-index: 10;
  }
  .scan-guide-corner {
    position: absolute;
    width: 30px;
    height: 30px;
    border-color: #40B4E5;
    border-style: solid;
    border-width: 0;
  }
  .scan-guide-corner.top-left {
    top: 0;
    left: 0;
    border-top-width: 4px;
    border-left-width: 4px;
    border-top-left-radius: 8px;
  }
  .scan-guide-corner.top-right {
    top: 0;
    right: 0;
    border-top-width: 4px;
    border-right-width: 4px;
    border-top-right-radius: 8px;
  }
  .scan-guide-corner.bottom-left {
    bottom: 0;
    left: 0;
    border-bottom-width: 4px;
    border-left-width: 4px;
    border-bottom-left-radius: 8px;
  }
  .scan-guide-corner.bottom-right {
    bottom: 0;
    right: 0;
    border-bottom-width: 4px;
    border-right-width: 4px;
    border-bottom-right-radius: 8px;
  }
  .scan-guide-text {
    position: absolute;
    bottom: -35px;
    left: 50%;
    transform: translateX(-50%);
    color: white;
    font-size: 12px;
    font-weight: 600;
    text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    white-space: nowrap;
    background: rgba(0,0,0,0.5);
    padding: 4px 12px;
    border-radius: 12px;
  }

  /* html5-qrcodeã®ã‚·ã‚§ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°èª¿æ•´ */
  #reader__scan_region {
    border-radius: 8px !important;
  }
  #reader__dashboard_section {
    display: none !important;
  }
  
  /* ã‚¹ã‚­ãƒ£ãƒ³çµæœ */
  .scan-result {
    display: none;
  }
  .scan-result.show {
    display: block;
  }
  .scan-success {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
  }
  .scan-success-icon {
    font-size: 3rem;
    color: #28a745;
    text-align: center;
    display: block;
    margin-bottom: 8px;
  }
  
  /* ãƒ•ã‚©ãƒ¼ãƒ  */
  .form-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #555;
    margin-bottom: 6px;
  }
  .form-control, .form-select {
    border-radius: 8px;
    border: 1px solid #ddd;
    padding: 12px;
    font-size: 1rem;
  }
  .form-control:focus, .form-select:focus {
    border-color: #40B4E5;
    box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
  }
  
  /* ãƒœã‚¿ãƒ³ */
  .btn-primary {
    background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
    border: none;
    border-radius: 8px;
    padding: 14px 24px;
    font-size: 1rem;
    font-weight: 600;
  }
  .btn-primary:hover {
    background: linear-gradient(135deg, #3dbdb5 0%, #3a9080 100%);
  }
  .btn-secondary {
    background: #6c757d;
    border: none;
    border-radius: 8px;
    padding: 14px 24px;
    font-size: 1rem;
  }
  .btn-outline-secondary {
    border: 2px solid #6c757d;
    color: #6c757d;
    border-radius: 8px;
    padding: 12px 20px;
  }
  
  /* ä»•å…¥æƒ…å ±ï¼ˆç®¡ç†è€…ã®ã¿è¡¨ç¤ºï¼‰ */
  .purchase-info {
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 16px;
    font-size: 0.875rem;
  }
  .purchase-info.hidden {
    display: none;
  }
  .purchase-info-label {
    color: #856404;
    font-weight: 500;
  }
  
  /* ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ */
  .mode-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }
  .mode-tab {
    flex: 1;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    background: white;
    text-align: center;
    cursor: pointer;
    font-weight: 500;
    color: #666;
    transition: all 0.2s;
  }
  .mode-tab.active {
    border-color: #40B4E5;
    background: #e8f8f6;
    color: #40B4E5;
  }
  .mode-tab i {
    display: block;
    font-size: 1.5rem;
    margin-bottom: 4px;
  }
  
  /* æ‰‹å‹•å…¥åŠ› */
  .manual-input {
    display: none;
  }
  .manual-input.show {
    display: block;
  }

  /* v315: æ¤œå“æƒ…å ±è¡¨ç¤º */
  .inspection-info-grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .inspection-row {
    display: flex;
    flex-direction: column;
    padding-bottom: 12px;
    border-bottom: 1px solid #f3f4f6;
  }
  .inspection-row:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }
  .inspection-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }
  .inspection-value {
    font-size: 1rem;
    color: #1f2937;
    font-weight: 500;
  }
</style>
</head>
<body>

<!-- çµ±ä¸€ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒãƒ£ãƒƒãƒˆ/ã‚¿ã‚¹ã‚¯/ãƒ˜ãƒ«ãƒ—ã¨åŒä¸€æ§‹é€ ï¼‰ -->
<style>
  .page-header {
    background: linear-gradient(135deg, var(--reborn-primary, #40B4E5) 0%, var(--reborn-primary-dark, #1E8FBF) 100%);
    padding: 28px 20px;
    color: white;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 1000;
  }
  .page-header h1 {
    font-size: 22px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin: 0;
  }
  .page-header h1 i {
    font-size: 22px;
  }
  .page-header .back-button {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    left: 16px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 50%;
    width: 42px;
    height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: white;
    font-size: 20px;
  }
  .page-header .back-button:active {
    background: rgba(255, 255, 255, 0.3);
  }
  .page-header .menu-button {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    right: 16px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 50%;
    width: 42px;
    height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: white;
    font-size: 20px;
  }
  .page-header .menu-button:active {
    background: rgba(255, 255, 255, 0.3);
  }
</style>
<div class="page-header">
  <button class="back-button" title="æˆ»ã‚‹" onclick="if(window.parent && window.parent !== window) { window.parent.postMessage({type:'requestBack'}, '*'); } else { history.back(); }">
    <i class="bi bi-chevron-left"></i>
  </button>
  <h1><i class="bi bi-qr-code-scan"></i> QRã‚¹ã‚­ãƒ£ãƒ³</h1>
  <button class="menu-button" onclick="window.parent.postMessage({type:'toggleDrawer'}, '*')" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
    <i class="bi bi-list"></i>
  </button>
</div>

<!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
<div class="content">
  
  <!-- ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ -->
  <div class="mode-tabs">
    <div class="mode-tab active" onclick="switchMode('scan')">
      <i class="bi bi-camera"></i>
      ã‚«ãƒ¡ãƒ©
    </div>
    <div class="mode-tab" onclick="switchMode('manual')">
      <i class="bi bi-keyboard"></i>
      æ‰‹å‹•å…¥åŠ›
    </div>
  </div>
  
  <!-- ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ -->
  <div class="card" id="scannerCard">
    <div class="card-title">
      <i class="bi bi-camera-video"></i> QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³
    </div>
    <div class="scan-guide-container">
      <div id="reader"></div>
      <!-- ã‚¹ã‚­ãƒ£ãƒ³ã‚¬ã‚¤ãƒ‰ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆå››éš…ã®è§’ãƒãƒ¼ã‚¯ï¼‰ -->
      <div class="scan-guide-overlay" id="scanGuideOverlay" style="display: none;">
        <div class="scan-guide-corner top-left"></div>
        <div class="scan-guide-corner top-right"></div>
        <div class="scan-guide-corner bottom-left"></div>
        <div class="scan-guide-corner bottom-right"></div>
        <div class="scan-guide-text">æ å†…ã«QRã‚³ãƒ¼ãƒ‰ã‚’åˆã‚ã›ã¦ãã ã•ã„</div>
      </div>
    </div>
    <p class="text-muted mt-3 mb-0 small">
      <i class="bi bi-info-circle"></i>
      1ã¤ã®QRã‚³ãƒ¼ãƒ‰ã‚’æ å†…ã«åã‚ã¦ã‚¹ã‚­ãƒ£ãƒ³
    </p>
    <!-- v322: ã‚¹ã‚­ãƒƒãƒ—ãƒªãƒ³ã‚¯ -->
    <div class="text-center mt-3 pt-2 border-top">
      <a href="#" onclick="skipToProductRegistration(); return false;" class="text-muted small" style="text-decoration: none;">
        <i class="bi bi-skip-forward"></i> ã‚¹ã‚­ãƒ£ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦å•†å“ç™»éŒ²
      </a>
    </div>
  </div>
  
  <!-- æ‰‹å‹•å…¥åŠ› -->
  <div class="card manual-input" id="manualInput">
    <div class="card-title">
      <i class="bi bi-keyboard"></i> ä»•å…¥å•†å“IDã‚’å…¥åŠ›
    </div>
    <div class="mb-3">
      <input type="text" class="form-control" id="manualInvId" placeholder="ä¾‹: 441a1e-001ï¼ˆãƒ©ãƒ™ãƒ«ä¸‹ã®ç•ªå·ï¼‰">
      <small class="text-muted mt-1 d-block">ãƒ©ãƒ™ãƒ«ã«å°å­—ã•ã‚Œã¦ã„ã‚‹IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</small>
    </div>
    <button class="btn btn-primary w-100" onclick="processManualInput()">
      <i class="bi bi-search"></i> æ¤œç´¢
    </button>
  </div>
  
  <!-- ã‚¹ã‚­ãƒ£ãƒ³çµæœ v315: æ¤œå“æƒ…å ±è¡¨ç¤º + å•†å“ç™»éŒ²ã¸å°ç·š -->
  <div class="scan-result" id="scanResult">
    <div class="scan-success">
      <i class="bi bi-check-circle-fill scan-success-icon"></i>
      <div class="text-center">
        <strong>ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸï¼</strong><br>
        <span id="scannedInvId"></span>
      </div>
    </div>

    <!-- ä»•å…¥æƒ…å ±ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰ -->
    <div class="purchase-info" id="purchaseInfo">
      <div class="purchase-info-label">
        <i class="bi bi-lock-fill"></i> ä»•å…¥æƒ…å ±ï¼ˆç®¡ç†è€…ã®ã¿è¡¨ç¤ºï¼‰
      </div>
      <div class="mt-2">
        <div><strong>ä»•å…¥æ—¥:</strong> <span id="info-purchaseDate">-</span></div>
        <div><strong>ä»•å…¥å…ˆ:</strong> <span id="info-supplier">-</span></div>
        <div><strong>ä»•å…¥å˜ä¾¡:</strong> <span id="info-price">-</span></div>
      </div>
    </div>

    <!-- v315: æ¤œå“æƒ…å ±è¡¨ç¤º -->
    <div class="card" id="inspectionInfoCard">
      <div class="card-title">
        <i class="bi bi-clipboard-check"></i> æ¤œå“æƒ…å ±
      </div>

      <div class="inspection-info-grid">
        <div class="inspection-row">
          <span class="inspection-label">ã‚«ãƒ†ã‚´ãƒª</span>
          <span class="inspection-value" id="info-category">-</span>
        </div>
        <div class="inspection-row">
          <span class="inspection-label">ãƒ–ãƒ©ãƒ³ãƒ‰</span>
          <span class="inspection-value" id="info-brand">-</span>
        </div>
        <div class="inspection-row">
          <span class="inspection-label">ã‚µã‚¤ã‚º</span>
          <span class="inspection-value" id="info-size">-</span>
        </div>
        <div class="inspection-row">
          <span class="inspection-label">çŠ¶æ…‹</span>
          <span class="inspection-value" id="info-condition">-</span>
        </div>
        <div class="inspection-row">
          <span class="inspection-label">ä»˜å±å“</span>
          <span class="inspection-value" id="info-accessories">-</span>
        </div>
        <div class="inspection-row" id="damageMarkerRow" style="display: none;">
          <span class="inspection-label">ãƒãƒ¼ã‚­ãƒ³ã‚°</span>
          <div class="inspection-value">
            <img id="info-damageMarker" src="" alt="ãƒãƒ¼ã‚­ãƒ³ã‚°ç”»åƒ" style="max-width: 100%; border-radius: 8px; margin-top: 8px;">
          </div>
        </div>
      </div>

      <!-- æ¤œå“æƒ…å ±ãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
      <div id="noInspectionInfo" class="text-center text-muted py-3" style="display: none;">
        <i class="bi bi-info-circle"></i> æ¤œå“æƒ…å ±ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“
      </div>
    </div>

    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
    <div class="d-grid gap-2 mt-3">
      <button class="btn btn-primary btn-lg" onclick="goToProductRegistration()">
        <i class="bi bi-box-arrow-in-right"></i> å•†å“ç™»éŒ²ã¸é€²ã‚€
      </button>
      <button class="btn btn-outline-secondary" onclick="resetScan()">
        <i class="bi bi-arrow-counterclockwise"></i> æ¬¡ã®å•†å“ã‚’ã‚¹ã‚­ãƒ£ãƒ³
      </button>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase v313: Firestoreé€£æºè¿½åŠ  -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  // v313: FirebaseåˆæœŸåŒ–
  const firebaseConfig = {
    apiKey: "AIzaSyD8U8l0noFza2Wrt5mni2VgKV3iKPLadWQ",
    authDomain: "furira.jp",
    projectId: "reborn-chat",
    storageBucket: "reborn-chat.firebasestorage.app",
    messagingSenderId: "684049628498",
    appId: "1:684049628498:web:efb1a6c5dfe93f9b5eb09c",
    measurementId: "G-KGFXDX5XQ2"
  };

  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const db = firebase.firestore();

  let html5QrCode = null;
  let currentInvId = null;
  let currentSlotData = null; // v313: ã‚¹ãƒ­ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ä¿æŒ
  let isAdmin = true; // TODO: å®Ÿéš›ã®æ¨©é™ãƒã‚§ãƒƒã‚¯
  
  // åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', function() {
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯ï¼ˆQRã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ï¼‰
    const urlParams = new URLSearchParams(window.location.search);
    const invId = urlParams.get('inv');
    
    if (invId) {
      // QRã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹
      processScannedCode(invId);
    } else {
      // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼èµ·å‹•
      startScanner();
    }
    
    // ç®¡ç†è€…ã§ãªã‘ã‚Œã°ä»•å…¥æƒ…å ±ã‚’éè¡¨ç¤º
    if (!isAdmin) {
      document.getElementById('purchaseInfo').classList.add('hidden');
    }
  });
  
  // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼èµ·å‹•
  function startScanner() {
    html5QrCode = new Html5Qrcode("reader");

    html5QrCode.start(
      { facingMode: "environment" },
      {
        fps: 10,
        qrbox: { width: 200, height: 200 },  // å°ã•ã‚ã®æ ã§ç²¾ç¢ºã«ã‚¹ã‚­ãƒ£ãƒ³
        aspectRatio: 1.0,  // æ­£æ–¹å½¢ã®ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒªã‚¢
        disableFlip: false  // åè»¢ã‚’è¨±å¯ï¼ˆä¸€éƒ¨ã®ã‚«ãƒ¡ãƒ©å¯¾å¿œï¼‰
      },
      onScanSuccess,
      onScanFailure
    ).then(() => {
      // ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹å¾Œã«ã‚¬ã‚¤ãƒ‰ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¡¨ç¤º
      const guide = document.getElementById('scanGuideOverlay');
      if (guide) guide.style.display = 'block';
    }).catch(err => {
      console.error("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—:", err);
      document.getElementById('reader').innerHTML = `
        <div class="text-center text-danger p-4">
          <i class="bi bi-camera-video-off" style="font-size: 3rem;"></i>
          <p class="mt-2">ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“</p>
          <p class="small">æ‰‹å‹•å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã‚’ãŠä½¿ã„ãã ã•ã„</p>
        </div>
      `;
    });
  }
  
  // ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸ
  function onScanSuccess(decodedText, decodedResult) {
    // URLã‹ã‚‰invãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŠ½å‡º
    let invId = decodedText;
    try {
      const url = new URL(decodedText);
      invId = url.searchParams.get('inv') || decodedText;
    } catch (e) {
      // URLã§ãªã„å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
    }

    // ã‚¬ã‚¤ãƒ‰ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’éè¡¨ç¤º
    const guide = document.getElementById('scanGuideOverlay');
    if (guide) guide.style.display = 'none';

    // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼åœæ­¢
    if (html5QrCode) {
      html5QrCode.stop();
    }

    processScannedCode(invId);
  }
  
  // ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—ï¼ˆç¶™ç¶šã—ã¦ã‚¹ã‚­ãƒ£ãƒ³ï¼‰
  function onScanFailure(error) {
    // ç„¡è¦–ï¼ˆç¶™ç¶šï¼‰
  }
  
  // v316: çŸ­ç¸®IDã‹ã‚‰ãƒ•ãƒ«ã‚¹ãƒ­ãƒƒãƒˆIDã‚’æ¤œç´¢
  // éå»7æ—¥åˆ†ã®æ—¥ä»˜ã§BATCH-{date}-{shortId}ã‚’è©¦è¡Œ
  async function findFullSlotId(shortId) {
    // æ—¥æœ¬æ™‚é–“ã§ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
    function getJSTDate(daysAgo = 0) {
      const now = new Date();
      const jst = new Date(now.getTime() + (9 * 60 + now.getTimezoneOffset()) * 60000);
      jst.setDate(jst.getDate() - daysAgo);
      const year = jst.getFullYear();
      const month = String(jst.getMonth() + 1).padStart(2, '0');
      const day = String(jst.getDate()).padStart(2, '0');
      return `${year}${month}${day}`;
    }
    
    for (let i = 0; i < 7; i++) {
      const dateStr = getJSTDate(i);
      const fullId = `BATCH-${dateStr}-${shortId}`;
      
      try {
        const doc = await db.collection('purchaseSlots').doc(fullId).get();
        if (doc.exists) {
          return fullId;
        }
      } catch (e) {
        console.error('ğŸ“· [scan.html v316] æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', fullId, e);
      }
    }
    
    return null; // è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸ
  }

  // ã‚¹ã‚­ãƒ£ãƒ³çµæœå‡¦ç†
  // v316: Firestoreã‹ã‚‰ã‚¹ãƒ­ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆçŸ­ç¸®IDå¯¾å¿œï¼‰
  async function processScannedCode(invId) {
    currentInvId = invId;
    console.log('ğŸ“· [scan.html v313] ã‚¹ã‚­ãƒ£ãƒ³:', invId);

    // è¡¨ç¤ºæ›´æ–°
    document.getElementById('scannedInvId').textContent = invId;
    document.getElementById('scannerCard').style.display = 'none';
    document.getElementById('manualInput').classList.remove('show');
    document.getElementById('scanResult').classList.add('show');

    // v316: çŸ­ç¸®IDå¯¾å¿œ - BATCH-ã§å§‹ã¾ã‚‰ãªã„å ´åˆã¯æ—¥ä»˜ã‚’è£œå®Œã—ã¦æ¤œç´¢
    let fullSlotId = invId;
    if (!invId.startsWith('BATCH-')) {
      console.log('ğŸ“· [scan.html v316] çŸ­ç¸®IDæ¤œå‡ºã€ãƒ•ãƒ«IDæ¤œç´¢é–‹å§‹:', invId);
      fullSlotId = await findFullSlotId(invId);
      if (fullSlotId) {
        console.log('ğŸ“· [scan.html v316] ãƒ•ãƒ«IDç™ºè¦‹:', fullSlotId);
        document.getElementById('scannedInvId').textContent = fullSlotId;
      } else {
        console.warn('ğŸ“· [scan.html v316] ãƒ•ãƒ«IDæœªç™ºè¦‹:', invId);
        document.getElementById('info-purchaseDate').textContent = '-';
        document.getElementById('info-supplier').textContent = 'ï¼ˆè©²å½“ãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰';
        document.getElementById('info-price').textContent = '-';
        showNoInspectionInfo();
        return;
      }
    }

    // v313: Firestoreã‹ã‚‰ã‚¹ãƒ­ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    if (fullSlotId.startsWith('BATCH-')) {
      try {
        console.log('ğŸ“· [scan.html v316] Firestoreå–å¾—é–‹å§‹:', fullSlotId);

        // ã‚¹ãƒ­ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const slotSnap = await db.collection('purchaseSlots').doc(fullSlotId).get();
        if (slotSnap.exists) {
          currentSlotData = slotSnap.data();
          console.log('ğŸ“· [scan.html v313] ã‚¹ãƒ­ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿:', currentSlotData);

          // ä»•å…¥æƒ…å ±ã‚’è¡¨ç¤º
          document.getElementById('info-purchaseDate').textContent = currentSlotData.purchaseDate || '-';
          document.getElementById('info-supplier').textContent = currentSlotData.supplier || '-';
          document.getElementById('info-price').textContent = currentSlotData.amount ? `Â¥${Number(currentSlotData.amount).toLocaleString()}` : '-';

          // v315: æ¤œå“æƒ…å ±ã‚’è¡¨ç¤º
          displayInspectionInfo(currentSlotData);
        } else {
          console.warn('ğŸ“· [scan.html v316] ã‚¹ãƒ­ãƒƒãƒˆæœªç™ºè¦‹:', fullSlotId);
          document.getElementById('info-purchaseDate').textContent = '-';
          document.getElementById('info-supplier').textContent = 'ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰';
          document.getElementById('info-price').textContent = '-';
          showNoInspectionInfo();
        }
      } catch (error) {
        console.error('ğŸ“· [scan.html v315] Firestoreå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('info-purchaseDate').textContent = '-';
        document.getElementById('info-supplier').textContent = 'ï¼ˆå–å¾—ã‚¨ãƒ©ãƒ¼ï¼‰';
        document.getElementById('info-price').textContent = '-';
        showNoInspectionInfo();
      }
    } else {
      // æ—§å½¢å¼ã¾ãŸã¯ä¸æ˜ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
      document.getElementById('info-purchaseDate').textContent = '-';
      document.getElementById('info-supplier').textContent = 'ï¼ˆä¸æ˜ãªå½¢å¼ï¼‰';
      document.getElementById('info-price').textContent = '-';
      showNoInspectionInfo();
    }

    // åŠ¹æœéŸ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    try {
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleUI...');
      audio.volume = 0.3;
      audio.play().catch(() => {});
    } catch (e) {}
  }
  
  // æ‰‹å‹•å…¥åŠ›å‡¦ç†
  function processManualInput() {
    const invId = document.getElementById('manualInvId').value.trim();
    if (invId) {
      processScannedCode(invId);
    } else {
      alert('ä»•å…¥å•†å“IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    }
  }
  
  // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
  function switchMode(mode) {
    document.querySelectorAll('.mode-tab').forEach(tab => tab.classList.remove('active'));
    const guide = document.getElementById('scanGuideOverlay');

    if (mode === 'scan') {
      document.querySelector('.mode-tab:first-child').classList.add('active');
      document.getElementById('scannerCard').style.display = 'block';
      document.getElementById('manualInput').classList.remove('show');
      if (!html5QrCode) {
        startScanner();
      }
    } else {
      document.querySelector('.mode-tab:last-child').classList.add('active');
      document.getElementById('scannerCard').style.display = 'none';
      document.getElementById('manualInput').classList.add('show');
      // æ‰‹å‹•å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚¬ã‚¤ãƒ‰ã‚’éè¡¨ç¤º
      if (guide) guide.style.display = 'none';
      if (html5QrCode) {
        html5QrCode.stop().catch(() => {});
        html5QrCode = null;
      }
    }
  }
  
  // ãƒªã‚»ãƒƒãƒˆ
  function resetScan() {
    currentInvId = null;
    currentSlotData = null;
    document.getElementById('scanResult').classList.remove('show');
    document.getElementById('scannerCard').style.display = 'block';

    // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼å†èµ·å‹•
    startScanner();
  }

  // v315: æ¤œå“æƒ…å ±ã‚’è¡¨ç¤º
  function displayInspectionInfo(slotData) {
    const hasInspection = slotData.category || slotData.brand || slotData.size ||
                          slotData.condition || (slotData.accessories && slotData.accessories.length > 0) ||
                          slotData.damageMarkerImage;

    if (!hasInspection) {
      showNoInspectionInfo();
      return;
    }

    document.querySelector('.inspection-info-grid').style.display = 'flex';
    document.getElementById('noInspectionInfo').style.display = 'none';

    // ã‚«ãƒ†ã‚´ãƒªï¼ˆ7éšå±¤ã‹ã‚‰è¡¨ç¤ºç”¨ã«æ•´å½¢ï¼‰
    let categoryDisplay = '-';
    if (slotData.category) {
      const cat = slotData.category;
      categoryDisplay = [cat.superCategory, cat.major, cat.middle, cat.small, cat.fine, cat.fine2, cat.itemName]
        .filter(x => x)
        .join(' > ') || '-';
    }
    document.getElementById('info-category').textContent = categoryDisplay;

    // ãƒ–ãƒ©ãƒ³ãƒ‰
    document.getElementById('info-brand').textContent = slotData.brand || '-';

    // ã‚µã‚¤ã‚º
    document.getElementById('info-size').textContent = slotData.size || '-';

    // çŠ¶æ…‹
    document.getElementById('info-condition').textContent = slotData.condition || '-';

    // ä»˜å±å“
    const accessories = slotData.accessories || [];
    document.getElementById('info-accessories').textContent = accessories.length > 0 ? accessories.join(', ') : '-';

    // ãƒãƒ¼ã‚­ãƒ³ã‚°ç”»åƒ
    if (slotData.damageMarkerImage) {
      document.getElementById('damageMarkerRow').style.display = 'flex';
      document.getElementById('info-damageMarker').src = slotData.damageMarkerImage;
    } else {
      document.getElementById('damageMarkerRow').style.display = 'none';
    }
  }

  // v315: æ¤œå“æƒ…å ±ãŒãªã„å ´åˆ
  function showNoInspectionInfo() {
    document.querySelector('.inspection-info-grid').style.display = 'none';
    document.getElementById('noInspectionInfo').style.display = 'block';
  }

  // v315: å•†å“ç™»éŒ²ã¸é€²ã‚€
  function goToProductRegistration() {
    if (!currentSlotData) {
      alert('ã‚¹ãƒ­ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }

    // sessionStorageã«ã‚¹ãƒ­ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    sessionStorage.setItem('pendingSlotData', JSON.stringify(currentSlotData));
    console.log('ğŸ“· [scan.html v315] å•†å“ç™»éŒ²ã¸é·ç§»:', currentSlotData.slotId);

    // è¦ªãƒ•ãƒ¬ãƒ¼ãƒ ã«å•†å“ç™»éŒ²ç”»é¢ã¸ã®é·ç§»ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    if (window.parent && window.parent !== window) {
      window.parent.postMessage({
        type: 'navigate',
        page: 'product',
        slotId: currentSlotData.slotId
      }, '*');
    } else {
      // å˜ç‹¬ãƒšãƒ¼ã‚¸ã®å ´åˆã¯ç›´æ¥é·ç§»
      window.location.href = '/product.html?slotId=' + encodeURIComponent(currentSlotData.slotId);
    }
  }

  // v322: ã‚¹ã‚­ãƒ£ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦å•†å“ç™»éŒ²ã¸ç›´æ¥é·ç§»
  function skipToProductRegistration() {
    console.log('ğŸ“· [scan.html v322] ã‚¹ã‚­ãƒ£ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦å•†å“ç™»éŒ²ã¸');

    // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼åœæ­¢
    if (html5QrCode) {
      html5QrCode.stop().catch(() => {});
      html5QrCode = null;
    }

    // å•†å“ç™»éŒ²ç”»é¢ã¸é·ç§»ï¼ˆã‚¹ãƒ­ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰
    if (window.parent && window.parent !== window) {
      window.parent.postMessage({
        type: 'navigate',
        page: 'product'
      }, '*');
    } else {
      window.location.href = '/product.html';
    }
  }

  // æ—§é–¢æ•°ï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
  function registerProduct() {
    // v315: goToProductRegistrationã«ç½®ãæ›ãˆ
    goToProductRegistration();
  }

  function openCamera() {
    // v315: æœªä½¿ç”¨ï¼ˆå•†å“ç™»éŒ²ç”»é¢ã§æ’®å½±ï¼‰
  }

</script>

</body>
</html>
