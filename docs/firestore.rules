rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // ユーザーコレクション (Phase 1.5)
    // ========================================
    match /users/{userId} {
      // 全員が読み取り可能（チャット用）
      allow read: if true;

      // 書き込みは認証済みユーザーのみ
      allow write: if request.auth != null;
    }

    // ========================================
    // 商品コレクション (ARCH-001 Phase 3)
    // ========================================
    match /products/{productId} {
      // 全員が読み取り可能（PWAからの高速表示用）
      allow read: if true;

      // 書き込みは認証済みユーザーのみ（将来的にGASから書き込み予定）
      allow write: if request.auth != null;
    }

    // ========================================
    // カテゴリマスタコレクション (ARCH-001 Phase 3.1, MASTER-002)
    // ========================================
    match /categories/{docId} {
      // 全員が読み取り可能（商品登録画面用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（マスタ管理UI・初期化スクリプト実行のため）
      // TODO: 本番環境では認証必須に変更すること
      allow write: if true;
    }

    // ========================================
    // マスタオプションコレクション (ARCH-001 Phase 3.1)
    // ========================================
    match /masterOptions/{docId} {
      // 全員が読み取り可能（商品登録画面用）
      allow read: if true;

      // 書き込みは認証済みユーザーのみ（Migration実行時のみ）
      allow write: if request.auth != null;
    }

    // ========================================
    // ブランドマスタコレクション (ARCH-001 Phase 3.2, MASTER-001)
    // ========================================
    match /brands/{brandId} {
      // 全員が読み取り可能（商品登録画面のオートコンプリート用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（マスタ管理UI実装のため）
      // TODO: 本番環境では認証必須に変更すること
      // allow write: if request.auth != null && request.auth.token.isAdmin == true;
      allow write: if true;
    }

    // ========================================
    // 業務関連マスタコレクション (MASTER-002)
    // ========================================
    // 発送方法マスタ
    match /shippingMethods/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // 仕入先マスタ
    match /suppliers/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // 担当者マスタ
    match /staffMembers/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // 梱包資材マスタ
    match /packagingMaterials/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // 出品先マスタ
    match /salesChannels/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // 商品関連マスタコレクション (MASTER-002)
    // 素材マスタ
    match /materials/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // 生地マスタ
    match /fabrics/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // キーワードマスタ
    match /keywords/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // セールスワードマスタ（小文字版 - PWA移行用）
    match /saleswords/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // セールスワードマスタ（旧ルール - 互換性維持）
    match /salesWords/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // 属性カテゴリマスタ
    match /attributeCategories/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // 属性値マスタ
    match /attributeValues/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // ========================================
    // メッセージコレクション（トップレベル）(CHAT-001)
    // ========================================
    match /messages/{messageId} {
      // 誰でも読み取り可能
      allow read: if true;

      // 誰でも書き込み可能（ユーザー名検証あり）
      allow create: if request.resource.data.userName != null
                  && request.resource.data.text != null
                  && request.resource.data.timestamp != null;

      // 更新（論理削除）は許可
      allow update: if true;

      // 物理削除は禁止
      allow delete: if false;
    }

    // ========================================
    // チャットルームコレクション (Phase 1.5)
    // ========================================
    match /chat_rooms/{roomId} {
      // 全員が読み取り可能
      allow read: if true;

      // 書き込みは認証済みユーザーのみ
      allow write: if request.auth != null;

      // サブコレクション: メッセージ
      match /messages/{messageId} {
        allow read: if true;
        allow write: if request.auth != null;
      }
    }

    // ========================================
    // チャットルームコレクション v2 (CHAT-001, CHAT-007, CHAT-012)
    // ========================================
    match /rooms/{roomId} {
      // 読み取り: 全員許可
      allow read: if true;

      // 書き込み・削除: 全員許可（CHAT-012: スワイプ削除機能、認証不要）
      allow write: if true;
      allow delete: if true;

      // サブコレクション: メッセージ
      match /messages/{messageId} {
        allow read: if true;
        allow write: if true;
        allow delete: if true;
      }

      // サブコレクション: 未読カウント
      match /unreadCounts/{userId} {
        allow read: if true;
        allow write: if true;
        allow delete: if true;
      }
    }

    // ========================================
    // ナビゲーションコレクション (CHAT-010, UI-013)
    // ========================================
    match /navigation/{docId} {
      // 読み取り: 全員許可
      allow read: if true;

      // 書き込み: 全員許可（内部通信用、重要データなし）
      // 注: 頻度制限（5秒）を削除（UI-013: メニュー画面の連続クリックを許可）
      allow write: if true;
    }

    // ========================================
    // 管理番号カウンターコレクション (PWA Phase 2)
    // ========================================
    match /counters/{counterId} {
      // 読み取り: 全員許可（管理番号生成用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（管理番号自動採番のため）
      // TODO: 本番環境では認証必須に変更すること
      // allow write: if request.auth != null;
      allow write: if true;
    }

    // ========================================
    // 設定コレクション (PWA Phase 2 - localStorage→Firestore移行)
    // ========================================
    match /settings/{docId} {
      // 読み取り: 全員許可（PWA・GAS両方からアクセス）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（管理番号・AI生成設定等の統合管理）
      // TODO: 本番環境では認証必須に変更すること
      // allow write: if request.auth != null;
      allow write: if true;
    }

    // ========================================
    // 管理番号カウンターコレクション v2 (カウンター方式移行)
    // ========================================
    match /managementNumberCounters/{counterId} {
      // 読み取り: 全員許可（管理番号生成・移行用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（管理番号自動採番・移行のため）
      // TODO: 本番環境では認証必須に変更すること
      // allow write: if request.auth != null;
      allow write: if true;
    }

    // ========================================
    // デフォルトルール: 全て拒否
    // ========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
