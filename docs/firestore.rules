rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // ユーザーコレクション (Phase 1.5, PROD-002)
    // ========================================
    match /users/{userId} {
      // 全員が読み取り可能（チャット用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（基本設定・アイコンアップロード機能のため）
      // TODO: 本番環境では認証必須に変更すること
      allow write: if true;

      // サブコレクション: デバイス（FCMトークン管理）(PROD-002)
      match /devices/{deviceId} {
        // 読み取り: 全員許可（Firebase Functions用）
        allow read: if true;

        // 【MVP暫定】書き込みを全員許可（FCMトークン登録のため）
        // TODO: 本番環境では認証必須に変更すること
        allow write: if true;
      }

      // サブコレクション: 個人向けお知らせ（ウェルカム通知等）
      match /personalAnnouncements/{announcementId} {
        // 読み取り: 全員許可（お知らせ表示用）
        allow read: if true;

        // 【MVP暫定】書き込みを全員許可（管理者からのお知らせ作成用）
        // TODO: 本番環境では管理者のみ書き込み可能に変更
        allow write: if true;
      }

      // サブコレクション: 個人お知らせの既読管理
      match /readPersonalAnnouncements/{readId} {
        allow read: if true;
        allow write: if true;
      }

      // サブコレクション: ノート (NOTE-001)
      match /notes/{noteId} {
        // 読み取り: 公開ノートは全員、非公開は所有者のみ
        allow read: if true;

        // 書き込み: 所有者のみ
        // TODO: 本番環境では認証チェックを追加
        allow write: if true;
      }
    }

    // ========================================
    // ノート共有コレクション (NOTE-001)
    // ========================================
    match /noteShares/{shareId} {
      // 読み取り: 全員許可（共有リンクからのアクセス用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（共有リンク生成のため）
      // TODO: 本番環境では認証必須に変更すること
      allow write: if true;
    }

    // ========================================
    // 商品コレクション (ARCH-001 Phase 3, PROD-002 完全移行)
    // ========================================
    match /products/{productId} {
      // 読み取り: 全員許可（PWA・在庫管理画面からアクセス）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（商品登録機能実装のため）
      // TODO: 本番環境では認証必須に変更すること
      allow write: if true;
    }

    // ========================================
    // カテゴリマスタコレクション (ARCH-001 Phase 3.1, MASTER-002)
    // ========================================
    match /categories/{docId} {
      // 全員が読み取り可能（商品登録画面用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（マスタ管理UI・初期化スクリプト実行のため）
      // TODO: 本番環境では認証必須に変更すること
      allow write: if true;
    }

    // ========================================
    // マスタオプションコレクション (ARCH-001 Phase 3.1)
    // ========================================
    match /masterOptions/{docId} {
      // 全員が読み取り可能（商品登録画面用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（マスタ修正機能のため）
      // TODO: 本番環境では認証必須に変更すること
      allow write: if true;
    }

    // ========================================
    // ブランドマスタコレクション (ARCH-001 Phase 3.2, MASTER-001)
    // ========================================
    match /brands/{brandId} {
      // 全員が読み取り可能（商品登録画面のオートコンプリート用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（マスタ管理UI実装のため）
      // TODO: 本番環境では認証必須に変更すること
      // allow write: if request.auth != null && request.auth.token.isAdmin == true;
      allow write: if true;
    }

    // ========================================
    // 業務関連マスタコレクション (MASTER-002)
    // ========================================
    // 発送方法マスタ
    match /shippingMethods/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // 配送料の負担マスタ
    match /shippingBurden/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // 発送元の地域マスタ
    match /shippingRegion/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // 発送までの日数マスタ
    match /shippingDays/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // 仕入先マスタ
    match /suppliers/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // 発送先（外注）マスタ
    match /assignees/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // 担当者マスタ
    match /staffMembers/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // 梱包資材マスタ
    match /packagingMaterials/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // 出品先マスタ
    match /salesChannels/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // カテゴリコードマスタ（管理番号用）
    match /categoryCodes/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // 商品状態ランクマスタ
    match /conditionRanks/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // 商品関連マスタコレクション (MASTER-002)
    // 素材マスタ
    match /materials/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // 生地マスタ
    match /fabrics/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // 付属品マスタ
    match /accessories/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // キーワードマスタ
    match /keywords/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // セールスワードマスタ（小文字版 - PWA移行用）
    match /saleswords/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // セールスワードマスタ（旧ルール - 互換性維持）
    match /salesWords/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // 属性カテゴリマスタ
    match /attributeCategories/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // 属性値マスタ
    match /attributeValues/{docId} {
      allow read: if true;
      allow write: if true; // MVP暫定: 全員許可
    }

    // ========================================
    // メッセージコレクション（トップレベル）(CHAT-001)
    // ========================================
    match /messages/{messageId} {
      // 誰でも読み取り可能
      allow read: if true;

      // 誰でも書き込み可能（ユーザー名検証あり）
      allow create: if request.resource.data.userName != null
                  && request.resource.data.text != null
                  && request.resource.data.timestamp != null;

      // 更新（論理削除）は許可
      allow update: if true;

      // 物理削除は禁止
      allow delete: if false;
    }

    // ========================================
    // チャットルームコレクション (Phase 1.5)
    // ========================================
    match /chat_rooms/{roomId} {
      // 全員が読み取り可能
      allow read: if true;

      // 書き込みは認証済みユーザーのみ
      allow write: if request.auth != null;

      // サブコレクション: メッセージ
      match /messages/{messageId} {
        allow read: if true;
        allow write: if request.auth != null;
      }
    }

    // ========================================
    // チャットルームコレクション v2 (CHAT-001, CHAT-007, CHAT-012)
    // ========================================
    match /rooms/{roomId} {
      // 読み取り: 全員許可
      allow read: if true;

      // 書き込み・削除: 全員許可（CHAT-012: スワイプ削除機能、認証不要）
      allow write: if true;
      allow delete: if true;

      // サブコレクション: メッセージ
      match /messages/{messageId} {
        allow read: if true;
        allow write: if true;
        allow delete: if true;
      }

      // サブコレクション: 未読カウント
      match /unreadCounts/{userId} {
        allow read: if true;
        allow write: if true;
        allow delete: if true;
      }

      // サブコレクション: 通話 (CALL-001)
      match /calls/{callId} {
        allow read: if true;
        allow write: if true;
        allow delete: if true;
      }
    }

    // ========================================
    // ナビゲーションコレクション (CHAT-010, UI-013)
    // ========================================
    match /navigation/{docId} {
      // 読み取り: 全員許可
      allow read: if true;

      // 書き込み: 全員許可（内部通信用、重要データなし）
      // 注: 頻度制限（5秒）を削除（UI-013: メニュー画面の連続クリックを許可）
      allow write: if true;
    }

    // ========================================
    // 管理番号カウンターコレクション (PWA Phase 2)
    // ========================================
    match /counters/{counterId} {
      // 読み取り: 全員許可（管理番号生成用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（管理番号自動採番のため）
      // TODO: 本番環境では認証必須に変更すること
      // allow write: if request.auth != null;
      allow write: if true;
    }

    // ========================================
    // 設定コレクション (PWA Phase 2 - localStorage→Firestore移行)
    // ========================================
    match /settings/{docId} {
      // 読み取り: 全員許可（PWA・GAS両方からアクセス）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（管理番号・AI生成設定等の統合管理）
      // TODO: 本番環境では認証必須に変更すること
      // allow write: if request.auth != null;
      allow write: if true;
    }

    // ========================================
    // 管理番号カウンターコレクション v2 (カウンター方式移行)
    // ========================================
    match /managementNumberCounters/{counterId} {
      // 読み取り: 全員許可（管理番号生成・移行用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（管理番号自動採番・移行のため）
      // TODO: 本番環境では認証必須に変更すること
      // allow write: if request.auth != null;
      allow write: if true;
    }

    // ========================================
    // settings/permissions コレクション（SaaS対応動的権限設定）
    // ========================================
    match /settings/permissions {
      // 読み取り: 全員許可（初期設定画面で権限選択肢を表示するため）
      allow read: if true;

      // 書き込み: 全員許可（自動初期化のため）
      // TODO: 本番環境では管理者のみに制限すること
      allow write: if true;
    }

    // ========================================
    // やることリストコレクション (TASK-001)
    // ========================================
    match /userTasks/{userEmail} {
      // 読み取り: 全員許可（自分のタスク一覧表示用）
      allow read: if true;

      // 書き込み: 全員許可（タスク追加・完了処理用）
      // TODO: 本番環境では自分のドキュメントのみ書き込み可能に変更
      allow write: if true;

      // サブコレクション: タスク
      match /tasks/{taskId} {
        allow read: if true;
        allow write: if true;
      }
    }

    // ========================================
    // 閲覧中状態コレクション（バッジ問題対策）
    // ========================================
    match /viewingStatus/{userEmail} {
      // 読み取り: 全員許可（Firebase Functionsで閲覧中チェック用）
      allow read: if true;

      // 書き込み: 全員許可（PWAクライアントから閲覧状態を書き込む）
      // TODO: 本番環境では自分のドキュメントのみ書き込み可能に変更
      allow write: if true;
    }

    // ========================================
    // activeDevicesコレクション（通知高速化 - 方法2）
    // ========================================
    match /activeDevices/{userEmail} {
      // 読み取り: 全員許可（基本設定画面での通知設定保存のため）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（基本設定画面での通知設定保存のため）
      // Cloud Functions はサービスアカウントで実行されるため、このルールは適用されない
      // TODO: 本番環境では認証必須に変更すること
      allow write: if true;
    }

    // ========================================
    // Collection Group Query: devicesサブコレクション (PROD-002)
    // ========================================
    match /{path=**}/devices/{deviceId} {
      // 読み取り: 全員許可（Collection Group Queryでオーナー制限チェック用）
      allow read: if true;

      // 書き込み: 全員許可（FCMトークン登録のため）
      // TODO: 本番環境では認証必須に変更すること
      allow write: if true;
    }

    // ========================================
    // SKUコレクション (INV-010: 新品/バリエーション対応)
    // ========================================
    match /skus/{skuId} {
      // 読み取り: 全員許可（商品登録・在庫管理画面用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（SKU登録・在庫更新のため）
      // TODO: 本番環境では認証必須に変更すること
      allow write: if true;
    }

    // ========================================
    // 仕入バッチコレクション (BATCH-001)
    // ========================================
    match /purchaseBatches/{batchId} {
      // 読み取り: 全員許可（仕入一覧・バッチ管理画面用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（仕入登録機能のため）
      // TODO: 本番環境では認証必須に変更すること
      allow write: if true;
    }

    // ========================================
    // 仕入スロットコレクション (BATCH-001)
    // ========================================
    match /purchaseSlots/{slotId} {
      // 読み取り: 全員許可（QRスキャン時のスロット情報取得用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（スロット登録・商品紐付けのため）
      // TODO: 本番環境では認証必須に変更すること
      allow write: if true;
    }

    // ========================================
    // ラベル印刷履歴コレクション (LABEL-001)
    // ========================================
    match /labelPrintHistory/{historyId} {
      // 読み取り: 全員許可（印刷履歴表示・再印刷用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（印刷履歴保存・再印刷カウント更新のため）
      // TODO: 本番環境では認証必須に変更すること
      allow write: if true;
    }

    // ========================================
    // 棚卸コレクション (STOCK-001)
    // ========================================
    match /inventoryChecks/{checkId} {
      // 読み取り: 全員許可（棚卸一覧・詳細表示用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（棚卸作成・更新のため）
      // TODO: 本番環境では認証必須に変更すること
      allow write: if true;

      // サブコレクション: 棚卸アイテム（カウント結果）
      match /items/{itemId} {
        allow read: if true;
        allow write: if true;
      }
    }

    // ========================================
    // 期間ベース棚卸コレクション (STOCKTAKING-001)
    // ========================================
    match /stocktakingPeriods/{periodId} {
      // 読み取り: 全員許可（棚卸期間一覧・詳細表示用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（期間作成・更新のため）
      // TODO: 本番環境では管理者のみ書き込み可能に変更
      allow write: if true;

      // サブコレクション: スタッフ進捗
      match /staffProgress/{staffEmail} {
        allow read: if true;
        // 自分の進捗か管理者のみ書き込み可能
        // TODO: 本番環境では request.auth.token.email == staffEmail に変更
        allow write: if true;
      }

      // サブコレクション: チェック結果
      match /checkResults/{resultId} {
        allow read: if true;
        // 認証済みユーザーのみ書き込み可能
        // TODO: 本番環境では request.auth != null に変更
        allow write: if true;
      }
    }

    // ========================================
    // 在庫調整履歴コレクション (STOCK-001)
    // ========================================
    match /inventoryAdjustments/{adjustmentId} {
      // 読み取り: 全員許可（調整履歴表示用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（在庫調整記録のため）
      // TODO: 本番環境では認証必須に変更すること
      allow write: if true;
    }

    // ========================================
    // 報酬記録コレクション (COMPENSATION-001)
    // ========================================
    match /compensationRecords/{recordId} {
      // 読み取り: 全員許可（報酬管理画面用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（報酬記録のため）
      // TODO: 本番環境では認証必須に変更すること
      allow write: if true;
    }

    // ========================================
    // 報酬支払記録コレクション (COMPENSATION-001)
    // ========================================
    match /compensationPayments/{paymentId} {
      // 読み取り: 全員許可（報酬管理画面用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（支払記録のため）
      // TODO: 本番環境では認証必須に変更すること
      allow write: if true;
    }

    // ========================================
    // AIサポート会話履歴コレクション (HELP-001)
    // ========================================
    match /help_conversations/{conversationId} {
      // 読み取り: 全員許可（会話履歴表示用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（会話保存・削除のため）
      // TODO: 本番環境ではuserIdフィールドで所有者チェックに変更
      // allow write: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow write: if true;
    }

    // ========================================
    // ユーザー目標コレクション (マイページ目標設定)
    // ========================================
    match /userGoals/{goalId} {
      // 読み取り: 全員許可（マイページ表示用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（目標設定保存のため）
      // TODO: 本番環境では自分の目標のみ書き込み可能に変更
      allow write: if true;
    }

    // ========================================
    // お知らせコレクション (システム通知)
    // ========================================
    match /announcements/{announcementId} {
      // 読み取り: 全員許可（お知らせ一覧表示用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（管理者からのお知らせ投稿用）
      // TODO: 本番環境では管理者のみ書き込み可能に変更
      allow write: if true;
    }

    // ========================================
    // お知らせ既読コレクション (ユーザーごとの既読管理)
    // ========================================
    match /readAnnouncements/{odocId} {
      // 読み取り: 全員許可（既読状態確認用）
      allow read: if true;

      // 書き込み: 全員許可（既読マーク用）
      allow write: if true;
    }

    // ========================================
    // フィードバックコレクション (v311)
    // ========================================
    match /feedback/{feedbackId} {
      // 読み取り: 全員許可（管理者のフィードバック確認用）
      allow read: if true;

      // 書き込み: 全員許可（ユーザーからのフィードバック送信用）
      allow write: if true;
    }

    // ========================================
    // 延長申請コレクション (TASK-001拡張: 期限延長承認フロー)
    // ========================================
    match /extensionRequests/{requestId} {
      // 読み取り: 全員許可（管理者の申請一覧表示・申請者の状態確認用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（延長申請作成・承認/却下処理のため）
      // TODO: 本番環境では以下のルールに変更:
      // - create: 申請者自身のみ
      // - update: 管理者のみ（status変更）
      allow write: if true;
    }

    // ========================================
    // プラットフォームマスタコレクション (PLAT-001)
    // ========================================
    match /platforms/{platformId} {
      // 読み取り: 全員許可（設定画面・商品登録画面用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（プラットフォーム初期化・編集のため）
      // TODO: 本番環境では管理者のみ書き込み可能に変更
      allow write: if true;
    }

    // ========================================
    // ユーザー設定コレクション (PLAT-001)
    // ========================================
    match /configs/{userId} {
      // 読み取り: 全員許可（設定画面用）
      allow read: if true;

      // 【MVP暫定】書き込みを全員許可（ユーザー設定保存のため）
      // TODO: 本番環境では自分の設定のみ書き込み可能に変更
      allow write: if true;
    }

    // ========================================
    // デフォルトルール: 全て拒否
    // ========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
