<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="REBORN">
  <title>REBORN 在庫管理システム</title>

  <!-- PWA Icons -->
  <link rel="apple-touch-icon" href="icon-180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body, html {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    #app-container {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #gas-iframe {
      width: 100%;
      height: 100%;
      border: none;
      flex: 1;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      font-size: 18px;
    }

    /* 通知許可バナー（iOS対応） */
    #push-cta {
      position: fixed;
      bottom: 16px;
      left: 16px;
      right: 16px;
      display: none;
      padding: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      font-size: 15px;
      line-height: 1.4;
    }

    #enable-push {
      margin-top: 12px;
      width: 100%;
      background: white;
      color: #667eea;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    #enable-push:active {
      transform: scale(0.98);
    }

  </style>
</head>
<body>
  <!-- 通知許可バナー（iOS対応：ユーザージェスチャー必須） -->
  <div id="push-cta">
    🔔 商品登録の通知を受け取りますか？
    <button id="enable-push">通知を許可</button>
  </div>

  <div id="app-container">
    <div class="loading" id="loading">
      <div>
        <div style="font-size: 48px; margin-bottom: 16px; text-align: center;">🔄</div>
        <div>REBORN システム起動中...</div>
      </div>
    </div>

    <!-- GAS Web App を iframe で表示 -->
    <iframe
      id="gas-iframe"
      src="https://script.google.com/macros/s/AKfycbxgrHJ5FkYiNDulGavakaHWSMxeBxz6nQ0db_RTalqWdPOx7HZpmGX70sbP9Z3hUvfd4g/exec"
      style="display: none;"
      onload="document.getElementById('loading').style.display='none'; this.style.display='flex';">
    </iframe>
  </div>

  <!-- Firebase SDKs (Modular format) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getMessaging, getToken } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js';

    // Firebase 設定（firebase-messaging-sw.jsと同じ設定）
    const firebaseConfig = {
      apiKey: "AIzaSyAwJKTz1gm3CIz_R4YTlbQopgaBq1ULt1A",
      authDomain: "reborn-pwa.firebaseapp.com",
      projectId: "reborn-pwa",
      storageBucket: "reborn-pwa.firebasestorage.app",
      messagingSenderId: "345653439471",
      appId: "1:345653439471:web:7620819ce3f022d9cd241a",
      measurementId: "G-SX48K45X75"
    };

    // Firebase 初期化
    const app = initializeApp(firebaseConfig);
    const messaging = getMessaging(app);

    // グローバル変数として公開（他の関数から参照できるように）
    window.firebaseMessaging = messaging;

    // VAPID公開鍵（Firebase Console > Cloud Messaging > Web Push certificates）
    const vapidKey = 'BLt5H1TPMi9OetYHgqoDXVoSkPQziC0Ulimr1-xv8rPObF693SCMWkzP8UhZLMaZzYGd_jP5V3JugDTROjKInbY';

    // GAS Web App URL
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxgrHJ5FkYiNDulGavakaHWSMxeBxz6nQ0db_RTalqWdPOx7HZpmGX70sbP9Z3hUvfd4g/exec';

    // Service Worker 登録（プッシュ通知用）
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/firebase-messaging-sw.js')
        .then(registration => {
          console.log('✅ Service Worker 登録成功:', registration.scope);

          // iOS対応：通知許可バナーを表示（条件付き）
          maybeShowNotificationBanner();
        })
        .catch(error => {
          console.error('❌ Service Worker 登録失敗:', error);
        });
    }

    // 通知許可バナーを表示するか判定（iOS対応）
    function maybeShowNotificationBanner() {
      if (!('Notification' in window)) {
        console.log('ℹ️ このブラウザは通知をサポートしていません');
        return;
      }

      // 1. iOSホーム画面アプリ判定（standalone mode）
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
      console.log('📱 ホーム画面アプリモード:', isStandalone);

      // 2. localStorageで「一度出したか」フラグチェック
      const KEY = 'push-permission-asked-v1';
      const asked = localStorage.getItem(KEY) === '1';
      console.log('🔔 過去に通知許可を尋ねたか:', asked);

      // 3. 現在の通知許可状態
      const permission = Notification.permission;
      console.log('🔔 現在の通知許可状態:', permission);

      // 4. 表示条件：ホーム画面アプリ かつ 未許可(default) かつ 未表示
      if (!isStandalone) {
        console.log('ℹ️ ホーム画面アプリではないため、通知許可バナーを表示しません');
        return;
      }

      if (permission !== 'default') {
        console.log('ℹ️ 通知許可は既に決定済み（granted/denied）のため、バナーを表示しません');

        // 許可済みの場合、FCMトークンを取得
        if (permission === 'granted') {
          console.log('✅ 通知はすでに許可されています');
          getAndSaveFCMToken();
        }
        return;
      }

      if (asked) {
        console.log('ℹ️ 過去に通知許可を尋ねたため、バナーを表示しません');
        return;
      }

      // 5. 条件を満たした場合、バナーを表示
      console.log('✅ 通知許可バナーを表示します');
      document.getElementById('push-cta').style.display = 'block';
    }

    // ボタンクリック時の処理（ユーザージェスチャー内で requestPermission を呼ぶ）
    document.getElementById('enable-push')?.addEventListener('click', async () => {
      try {
        console.log('🔔 通知許可をリクエスト中...');

        // ユーザージェスチャー内で requestPermission を呼ぶ（iOS要件）
        const perm = await Notification.requestPermission();

        // 一度出したら記録（次回以降は表示しない）
        const KEY = 'push-permission-asked-v1';
        localStorage.setItem(KEY, '1');

        if (perm === 'granted') {
          console.log('✅ 通知許可が付与されました');

          // FCMトークンを取得して保存
          await getAndSaveFCMToken();

          // バナーを閉じる
          document.getElementById('push-cta').style.display = 'none';
        } else {
          console.log('❌ 通知許可が拒否されました');

          // 拒否時のメッセージ表示
          const banner = document.getElementById('push-cta');
          banner.innerHTML = '❌ 通知は拒否されました。<br>iOSの「設定 > 通知」で再度許可できます。';
          setTimeout(() => {
            banner.style.display = 'none';
          }, 4000);
        }
      } catch (error) {
        console.error('❌ 通知許可リクエストエラー:', error);
        alert('通知許可のリクエストに失敗しました: ' + error.message);
      }
    });

    // FCMトークンを取得して保存
    async function getAndSaveFCMToken() {
      try {
        console.log('🔄 FCMトークンを取得中...');

        // Service Worker登録を取得
        const registration = await navigator.serviceWorker.ready;
        console.log('✅ Service Worker準備完了:', registration);

        // モジュラー形式のgetToken()を動的にimport
        const { getToken } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js');

        // Service Worker登録を明示的に渡す（重要！）
        const token = await getToken(window.firebaseMessaging, {
          vapidKey: vapidKey,
          serviceWorkerRegistration: registration
        });
        console.log('📱 FCMトークン:', token);

        if (!token) {
          const errorMsg = '❌ FCMトークンが取得できませんでした';
          console.error(errorMsg);
          alert(errorMsg + '\n\nService Workerが正しく登録されていない可能性があります。');
          return;
        }

        // GASにトークンを保存
        await saveFCMTokenToGAS(token);
      } catch (error) {
        console.error('❌ FCMトークン取得エラー:', error);
        alert('❌ FCMトークン取得エラー:\n\n' + error.message + '\n\n詳細はコンソールを確認してください。');
      }
    }

    // FCMトークンをGASに保存
    async function saveFCMTokenToGAS(token) {
      try {
        console.log('🔄 FCMトークンをGASに保存中...');
        const url = GAS_API_URL + '?action=subscribeFCM&token=' + encodeURIComponent(token);
        console.log('📤 リクエストURL:', url);

        const response = await fetch(url);
        console.log('📥 レスポンス受信:', response.status);

        const result = await response.json();
        console.log('📋 結果:', result);

        if (result.status === 'success') {
          console.log('✅ FCMトークンをGASに保存しました');
          alert('✅ 通知設定が完了しました！\n\n商品登録時に通知が届くようになります。');
        } else {
          const errorMsg = '❌ FCMトークン保存失敗: ' + result.message;
          console.error(errorMsg);
          alert(errorMsg);
        }
      } catch (error) {
        console.error('❌ FCMトークン保存エラー:', error);
        alert('❌ FCMトークン保存エラー:\n\n' + error.message + '\n\n詳細はコンソールを確認してください。');
      }
    }

    // Badge API サポートチェック
    if ('setAppBadge' in navigator) {
      console.log('✅ Badge API サポートあり');
    }

    // PWA インストール済みチェック
    window.addEventListener('DOMContentLoaded', () => {
      if (window.matchMedia('(display-mode: standalone)').matches) {
        console.log('✅ PWA として起動');
      } else {
        console.log('ℹ️ ブラウザで起動');
      }
    });

    // postMessage受信処理（iframe内からのナビゲーション要求）
    window.addEventListener('message', function(event) {
      // セキュリティ: GASのサンドボックスiframe（googleusercontent.com）からのメッセージを許可
      const isValidOrigin = event.origin === 'https://script.google.com' ||
                           event.origin.includes('googleusercontent.com');

      if (!isValidOrigin) {
        console.warn('⚠️ 不正なオリジンからのメッセージを拒否:', event.origin);
        return;
      }

      console.log('📨 受信メッセージ (from ' + event.origin + '):', event.data);

      // ナビゲーション要求の処理
      if (event.data.type === 'navigate' && event.data.url) {
        const iframe = document.getElementById('gas-iframe');
        console.log('🚀 ナビゲーション:', event.data.url);
        iframe.src = event.data.url;
      }
    });
  </script>
</body>
</html>
