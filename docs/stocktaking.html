<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ£šå¸ - FURIRA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/reborn-theme.css?v=303">
  <!-- html5-qrcode for QR scanning -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <!-- QRCode.js for QR generation (æ£šå¸ã§ã¯ã‚¹ã‚­ãƒ£ãƒ³ã®ã¿ä½¿ç”¨ã€ç”Ÿæˆã¯ä¸è¦) -->
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    .content-container {
      padding: 16px;
      max-width: 800px;
      margin: 0 auto;
    }

    /* ã‚¿ãƒ– */
    .nav-tabs-custom {
      background: white;
      border-radius: 12px;
      padding: 8px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .nav-tabs-custom .nav-link {
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      color: #6b7280;
      font-weight: 500;
      font-size: 0.9rem;
    }
    .nav-tabs-custom .nav-link.active {
      background: #10b981;
      color: white;
    }

    /* ã‚«ãƒ¼ãƒ‰ */
    .card-section {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .card-section h6 {
      color: #374151;
      font-weight: 600;
      margin-bottom: 12px;
    }

    /* ã‚µãƒãƒªãƒ¼ã‚°ãƒªãƒƒãƒ‰ */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    .summary-card {
      background: white;
      padding: 12px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .summary-card.highlight {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    .summary-card.highlight .summary-label { color: rgba(255,255,255,0.8); }
    .summary-card.highlight .summary-value { color: white; }
    .summary-card.warning { border: 2px solid #f59e0b; }
    .summary-card.danger { border: 2px solid #ef4444; }
    .summary-label {
      font-size: 0.7rem;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .summary-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: #1f2937;
    }

    /* æ£šå¸ãƒªã‚¹ãƒˆ */
    .check-item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: all 0.2s;
    }
    .check-item:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    .check-item.active {
      border: 2px solid #10b981;
    }
    .check-status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .check-status.draft { background: #e5e7eb; color: #374151; }
    .check-status.in-progress { background: #fef3c7; color: #92400e; }
    .check-status.completed { background: #d1fae5; color: #065f46; }
    .check-status.adjusted { background: #dbeafe; color: #1e40af; }

    /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
    .progress-bar-custom {
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin: 8px 0;
    }
    .progress-bar-custom .fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #059669);
      transition: width 0.3s;
    }

    /* QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ */
    #qr-reader {
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
      border-radius: 12px;
      overflow: hidden;
    }
    #qr-reader video {
      border-radius: 12px;
    }
    .scan-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      z-index: 9999;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .scan-overlay.active { display: flex; }
    .scan-header {
      color: white;
      text-align: center;
      margin-bottom: 20px;
    }
    .scan-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
    }

    /* ã‚«ã‚¦ãƒ³ãƒˆå…¥åŠ› */
    .count-input-card {
      background: #f0fdf4;
      border: 2px solid #10b981;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .count-input-card .product-info {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    .count-input-card .product-image {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      background: #e5e7eb;
    }
    .count-input-card .product-details {
      flex: 1;
    }
    .count-input-card .product-name {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }
    .count-input-card .product-meta {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .count-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 12px;
    }
    .count-label {
      font-size: 0.875rem;
      color: #374151;
      min-width: 80px;
    }
    .count-value {
      font-size: 1.25rem;
      font-weight: 700;
    }
    .count-input {
      width: 80px;
      text-align: center;
      font-size: 1.25rem;
      font-weight: 700;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      padding: 8px;
    }
    .count-input:focus {
      border-color: #10b981;
      outline: none;
    }
    .diff-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: 600;
    }
    .diff-badge.match { background: #d1fae5; color: #065f46; }
    .diff-badge.over { background: #dbeafe; color: #1e40af; }
    .diff-badge.under { background: #fee2e2; color: #991b1b; }

    /* å·®ç•°ãƒªã‚¹ãƒˆ */
    .diff-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
    }
    .diff-item:last-child { border-bottom: none; }
    .diff-item .item-info { flex: 1; }
    .diff-item .item-name { font-weight: 600; font-size: 0.9rem; }
    .diff-item .item-meta { font-size: 0.75rem; color: #6b7280; }
    .diff-item .diff-values {
      text-align: right;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ« */
    .data-table {
      width: 100%;
      font-size: 0.8rem;
    }
    .data-table th {
      background: #f9fafb;
      padding: 10px 8px;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
      white-space: nowrap;
    }
    .data-table td {
      padding: 10px 8px;
      border-bottom: 1px solid #f3f4f6;
      vertical-align: middle;
    }
    .data-table tr:hover { background: #f9fafb; }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9998;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-content { border-radius: 16px; }
    .modal-header { border-bottom: none; padding-bottom: 0; }
    .modal-footer { border-top: none; padding-top: 0; }

    /* FAB */
    .fab-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }
    .fab-button {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .fab-button:active { transform: scale(0.95); }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 576px) {
      .summary-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="text-center">
      <div class="spinner-border text-success" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>
  </div>

  <!-- QRã‚¹ã‚­ãƒ£ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div class="scan-overlay" id="scanOverlay">
    <button class="scan-close" onclick="stopScanner()">Ã—</button>
    <div class="scan-header">
      <h5>QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</h5>
      <p class="small text-muted mb-0">å•†å“ã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„</p>
    </div>
    <div id="qr-reader"></div>
    <button class="btn btn-outline-light mt-3" onclick="stopScanner()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>

  <!-- çµ±ä¸€ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <div class="header-content">
      <button class="back-button" onclick="goBack()">
        <i class="bi bi-chevron-left"></i>
      </button>
      <div class="header-title">
        <i class="bi bi-clipboard-check"></i>
        æ£šå¸
      </div>
      <div class="header-actions">
        <button class="btn btn-sm btn-outline-primary me-1" onclick="openNewCheckModal()" title="æ–°è¦æ£šå¸">
          <i class="bi bi-plus-lg"></i>
        </button>
        <button class="menu-button" onclick="window.parent.postMessage({type:'toggleDrawer'}, '*')" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
          <i class="bi bi-list"></i>
        </button>
      </div>
    </div>
  </div>

  <div class="content-container">
    <!-- ã‚¿ãƒ– -->
    <ul class="nav nav-tabs-custom" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#list-tab" type="button">
          ğŸ“‹ ä¸€è¦§
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#count-tab" type="button" id="count-tab-btn">
          ğŸ“ ã‚«ã‚¦ãƒ³ãƒˆ
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#diff-tab" type="button">
          ğŸ“Š å·®ç•°åˆ†æ
        </button>
      </li>
    </ul>

    <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="tab-content">
      <!-- ä¸€è¦§ã‚¿ãƒ– -->
      <div class="tab-pane fade show active" id="list-tab" role="tabpanel">
        <!-- é€²è¡Œä¸­ã®æ£šå¸ -->
        <div class="card-section">
          <h6><i class="bi bi-clock-history"></i> é€²è¡Œä¸­</h6>
          <div id="inProgressList">
            <div class="text-center text-muted py-3">é€²è¡Œä¸­ã®æ£šå¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>
          </div>
        </div>

        <!-- å®Œäº†æ¸ˆã¿ -->
        <div class="card-section">
          <h6><i class="bi bi-check-circle"></i> å®Œäº†æ¸ˆã¿</h6>
          <div id="completedList">
            <div class="text-center text-muted py-3">å®Œäº†ã—ãŸæ£šå¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>
          </div>
        </div>
      </div>

      <!-- ã‚«ã‚¦ãƒ³ãƒˆã‚¿ãƒ– -->
      <div class="tab-pane fade" id="count-tab" role="tabpanel">
        <!-- ç¾åœ¨ã®æ£šå¸æƒ…å ± -->
        <div id="noActiveCheck" class="card-section text-center py-4">
          <i class="bi bi-clipboard-x text-muted" style="font-size: 48px;"></i>
          <p class="text-muted mt-2 mb-3">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ£šå¸ãŒã‚ã‚Šã¾ã›ã‚“</p>
          <button class="btn btn-success" onclick="openNewCheckModal()">
            <i class="bi bi-plus-lg"></i> æ–°è¦æ£šå¸ã‚’é–‹å§‹
          </button>
        </div>

        <div id="activeCheckPanel" style="display: none;">
          <!-- é€²æ—ã‚µãƒãƒªãƒ¼ -->
          <div class="summary-grid">
            <div class="summary-card highlight">
              <div class="summary-label">é€²æ—</div>
              <div class="summary-value" id="count-progress">0%</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">å®Œäº†</div>
              <div class="summary-value" id="count-done">0</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">æ®‹ã‚Š</div>
              <div class="summary-value" id="count-remaining">0</div>
            </div>
            <div class="summary-card warning">
              <div class="summary-label">å·®ç•°</div>
              <div class="summary-value" id="count-diff">0</div>
            </div>
          </div>

          <!-- ã‚¹ã‚­ãƒ£ãƒ³/æ¤œç´¢ -->
          <div class="card-section">
            <div class="row g-2">
              <div class="col">
                <button class="btn btn-success w-100" onclick="startScanner()">
                  <i class="bi bi-qr-code-scan"></i> QRã‚¹ã‚­ãƒ£ãƒ³
                </button>
              </div>
              <div class="col">
                <div class="input-group">
                  <input type="text" class="form-control" id="searchInput" placeholder="ç®¡ç†ç•ªå·ã§æ¤œç´¢">
                  <button class="btn btn-outline-secondary" onclick="searchProduct()">
                    <i class="bi bi-search"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- ã‚«ã‚¦ãƒ³ãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ -->
          <div id="countInputArea">
            <!-- å•†å“é¸æŠå¾Œã«è¡¨ç¤º -->
          </div>

          <!-- æœªã‚«ã‚¦ãƒ³ãƒˆãƒªã‚¹ãƒˆ -->
          <div class="card-section">
            <h6><i class="bi bi-list-ul"></i> æœªã‚«ã‚¦ãƒ³ãƒˆå•†å“</h6>
            <div id="uncountedList" style="max-height: 300px; overflow-y: auto;">
              <div class="text-center text-muted py-3">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- å·®ç•°åˆ†æã‚¿ãƒ– -->
      <div class="tab-pane fade" id="diff-tab" role="tabpanel">
        <div id="noDiffData" class="card-section text-center py-4">
          <i class="bi bi-bar-chart text-muted" style="font-size: 48px;"></i>
          <p class="text-muted mt-2">æ£šå¸ã‚’å®Œäº†ã™ã‚‹ã¨å·®ç•°åˆ†æãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
        </div>

        <div id="diffPanel" style="display: none;">
          <!-- å·®ç•°ã‚µãƒãƒªãƒ¼ -->
          <div class="summary-grid">
            <div class="summary-card">
              <div class="summary-label">ç·ã‚¢ã‚¤ãƒ†ãƒ </div>
              <div class="summary-value" id="diff-total">0</div>
            </div>
            <div class="summary-card highlight">
              <div class="summary-label">ä¸€è‡´</div>
              <div class="summary-value" id="diff-match">0</div>
            </div>
            <div class="summary-card warning">
              <div class="summary-label">éå‰°</div>
              <div class="summary-value" id="diff-over">0</div>
            </div>
            <div class="summary-card danger">
              <div class="summary-label">ä¸è¶³</div>
              <div class="summary-value" id="diff-under">0</div>
            </div>
          </div>

          <!-- å·®ç•°é‡‘é¡ -->
          <div class="card-section">
            <h6><i class="bi bi-currency-yen"></i> å·®ç•°é‡‘é¡</h6>
            <div class="row text-center">
              <div class="col-6">
                <div class="text-muted small">éå‰°ï¼ˆæ£šå¸å¢—ï¼‰</div>
                <div class="text-primary fw-bold fs-5" id="diff-over-amount">Â¥0</div>
              </div>
              <div class="col-6">
                <div class="text-muted small">ä¸è¶³ï¼ˆæ£šå¸æ¸›ï¼‰</div>
                <div class="text-danger fw-bold fs-5" id="diff-under-amount">Â¥0</div>
              </div>
            </div>
          </div>

          <!-- å·®ç•°è©³ç´° -->
          <div class="card-section">
            <h6><i class="bi bi-exclamation-triangle"></i> å·®ç•°è©³ç´°</h6>
            <div id="diffDetailList" style="max-height: 400px; overflow-y: auto;">
              <div class="text-center text-muted py-3">å·®ç•°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
            </div>
          </div>

          <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="card-section">
            <div class="row g-2">
              <div class="col-6">
                <button class="btn btn-outline-success w-100" onclick="exportDiffReport()">
                  <i class="bi bi-download"></i> ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
                </button>
              </div>
              <div class="col-6">
                <button class="btn btn-success w-100" onclick="applyAdjustment()">
                  <i class="bi bi-check-lg"></i> åœ¨åº«èª¿æ•´ã‚’é©ç”¨
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FABï¼ˆã‚«ã‚¦ãƒ³ãƒˆä¸­ã®ã¿ï¼‰ -->
  <div class="fab-container" id="fabContainer" style="display: none;">
    <button class="fab-button" onclick="startScanner()">
      <i class="bi bi-qr-code-scan"></i>
    </button>
  </div>

  <!-- æ–°è¦æ£šå¸ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal fade" id="newCheckModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-plus-circle"></i> æ–°è¦æ£šå¸</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">æ£šå¸åç§°</label>
            <input type="text" class="form-control" id="checkName" placeholder="ä¾‹: 2025å¹´12æœˆæ£šå¸">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">å®Ÿæ–½æ—¥</label>
            <input type="date" class="form-control" id="checkDate">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">å¯¾è±¡</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="targetProducts" checked>
              <label class="form-check-label" for="targetProducts">å•†å“åœ¨åº«</label>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">ã‚«ã‚¦ãƒ³ãƒˆæ–¹å¼</label>
            <select class="form-select" id="countMethod">
              <option value="all">å…¨æ•°æ£šå¸ï¼ˆå…¨å•†å“ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼‰</option>
              <option value="category">ã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼ˆç‰¹å®šã‚«ãƒ†ã‚´ãƒªã®ã¿ï¼‰</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="btn btn-success" onclick="createNewCheck()">
            <i class="bi bi-play-fill"></i> é–‹å§‹
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, doc, getDocs, getDoc, setDoc, updateDoc, addDoc, deleteDoc, query, where, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "furira.jp",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // APIå…¬é–‹
    window.StocktakingApi = {
      db,
      // å•†å“ä¸€è¦§å–å¾—
      async getProducts() {
        const snapshot = await getDocs(collection(db, 'products'));
        const products = [];
        snapshot.forEach(doc => products.push({ id: doc.id, ...doc.data() }));
        return products;
      },
      // æ£šå¸ä¸€è¦§å–å¾—
      async getChecks() {
        const snapshot = await getDocs(collection(db, 'inventoryChecks'));
        const checks = [];
        snapshot.forEach(doc => checks.push({ id: doc.id, ...doc.data() }));
        return checks.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
      },
      // æ£šå¸ä½œæˆ
      async createCheck(data) {
        const docRef = await addDoc(collection(db, 'inventoryChecks'), {
          ...data,
          status: 'in_progress',
          progress: 0,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        return docRef.id;
      },
      // æ£šå¸æ›´æ–°
      async updateCheck(checkId, data) {
        await updateDoc(doc(db, 'inventoryChecks', checkId), {
          ...data,
          updatedAt: serverTimestamp()
        });
      },
      // ã‚«ã‚¦ãƒ³ãƒˆçµæœå–å¾—
      async getCheckItems(checkId) {
        const snapshot = await getDocs(collection(db, 'inventoryChecks', checkId, 'items'));
        const items = [];
        snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
        return items;
      },
      // ã‚«ã‚¦ãƒ³ãƒˆçµæœä¿å­˜
      async saveCountItem(checkId, productId, data) {
        await setDoc(doc(db, 'inventoryChecks', checkId, 'items', productId), {
          ...data,
          countedAt: serverTimestamp()
        });
      },
      // å•†å“ã®åœ¨åº«æ•°æ›´æ–°
      async updateProductQuantity(productId, quantity) {
        await updateDoc(doc(db, 'products', productId), {
          quantity: quantity,
          updatedAt: serverTimestamp()
        });
      }
    };

    console.log('âœ… [æ£šå¸] FirebaseåˆæœŸåŒ–å®Œäº†');

    // FirebaseãŒæº–å‚™å®Œäº†ã—ãŸã“ã¨ã‚’ãƒ•ãƒ©ã‚°ã§é€šçŸ¥
    window.firebaseReady = true;

    // DOMContentLoadedã§åˆæœŸåŒ–ã‚’è©¦ã¿ã‚‹
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        if (typeof initializePage === 'function') {
          initializePage();
        }
      });
    } else {
      // æ—¢ã«DOMãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
      setTimeout(() => {
        if (typeof initializePage === 'function') {
          initializePage();
        }
      }, 0);
    }
  </script>

  <script>
    let allProducts = [];
    let allChecks = [];
    let activeCheck = null;
    let checkItems = {};
    let currentProduct = null;
    let html5QrCode = null;

    function showLoading() { document.getElementById('loadingOverlay').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }

    function formatCurrency(amount) {
      if (amount === null || amount === undefined || isNaN(amount)) return 'Â¥0';
      return 'Â¥' + Math.round(amount).toLocaleString();
    }

    function formatDate(timestamp) {
      if (!timestamp) return '-';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      return date.toLocaleDateString('ja-JP');
    }

    async function initializePage() {
      console.log('ğŸ“‹ [æ£šå¸] initializePageé–‹å§‹');
      showLoading();
      try {
        // Firebase APIãŒæº–å‚™ã§ãã‚‹ã¾ã§å¾…æ©Ÿ
        let waitCount = 0;
        while (!window.StocktakingApi && waitCount < 50) {
          await new Promise(r => setTimeout(r, 100));
          waitCount++;
        }
        if (!window.StocktakingApi) {
          throw new Error('Firebase APIã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        console.log('ğŸ“‹ [æ£šå¸] Firebase APIæº–å‚™å®Œäº†');

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ—¥ä»˜
        document.getElementById('checkDate').value = new Date().toISOString().slice(0, 10);
        document.getElementById('checkName').value = `${new Date().getFullYear()}å¹´${new Date().getMonth() + 1}æœˆæ£šå¸`;

        await loadData();
        console.log('ğŸ“‹ [æ£šå¸] åˆæœŸåŒ–å®Œäº†');
      } catch (error) {
        console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      } finally {
        hideLoading();
      }
    }

    async function loadData() {
      allProducts = await StocktakingApi.getProducts();
      allChecks = await StocktakingApi.getChecks();

      // é€²è¡Œä¸­ã®æ£šå¸ãŒã‚ã‚Œã°è¨­å®š
      activeCheck = allChecks.find(c => c.status === 'in_progress');
      if (activeCheck) {
        const items = await StocktakingApi.getCheckItems(activeCheck.id);
        checkItems = {};
        items.forEach(item => checkItems[item.id] = item);
      }

      renderCheckList();
      updateCountTab();
      updateDiffTab();
    }

    function renderCheckList() {
      // é€²è¡Œä¸­
      const inProgress = allChecks.filter(c => c.status === 'in_progress');
      const inProgressHtml = inProgress.length > 0 ? inProgress.map(c => `
        <div class="check-item ${activeCheck?.id === c.id ? 'active' : ''}" onclick="selectCheck('${c.id}')">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-bold">${c.name || 'æ£šå¸'}</div>
              <div class="small text-muted">å®Ÿæ–½æ—¥: ${c.checkDate || '-'}</div>
            </div>
            <span class="check-status in-progress">é€²è¡Œä¸­</span>
          </div>
          <div class="progress-bar-custom">
            <div class="fill" style="width: ${c.progress || 0}%"></div>
          </div>
          <div class="small text-muted">${c.progress || 0}% å®Œäº†</div>
        </div>
      `).join('') : '<div class="text-center text-muted py-3">é€²è¡Œä¸­ã®æ£šå¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
      document.getElementById('inProgressList').innerHTML = inProgressHtml;

      // å®Œäº†æ¸ˆã¿
      const completed = allChecks.filter(c => c.status === 'completed' || c.status === 'adjusted');
      const completedHtml = completed.length > 0 ? completed.map(c => `
        <div class="check-item" onclick="viewCheckReport('${c.id}')">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-bold">${c.name || 'æ£šå¸'}</div>
              <div class="small text-muted">å®Œäº†æ—¥: ${formatDate(c.completedAt)}</div>
            </div>
            <span class="check-status ${c.status}">${c.status === 'adjusted' ? 'èª¿æ•´æ¸ˆ' : 'å®Œäº†'}</span>
          </div>
          <div class="small text-muted mt-1">å·®ç•°: ${c.diffCount || 0}ä»¶</div>
        </div>
      `).join('') : '<div class="text-center text-muted py-3">å®Œäº†ã—ãŸæ£šå¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
      document.getElementById('completedList').innerHTML = completedHtml;
    }

    async function selectCheck(checkId) {
      activeCheck = allChecks.find(c => c.id === checkId);
      if (activeCheck) {
        const items = await StocktakingApi.getCheckItems(checkId);
        checkItems = {};
        items.forEach(item => checkItems[item.id] = item);

        updateCountTab();
        // ã‚«ã‚¦ãƒ³ãƒˆã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
        const tab = document.querySelector('[data-bs-target="#count-tab"]');
        bootstrap.Tab.getOrCreateInstance(tab).show();
      }
    }

    function updateCountTab() {
      if (!activeCheck) {
        document.getElementById('noActiveCheck').style.display = 'block';
        document.getElementById('activeCheckPanel').style.display = 'none';
        document.getElementById('fabContainer').style.display = 'none';
        return;
      }

      document.getElementById('noActiveCheck').style.display = 'none';
      document.getElementById('activeCheckPanel').style.display = 'block';
      document.getElementById('fabContainer').style.display = 'block';

      // é€²æ—è¨ˆç®—
      const total = allProducts.filter(p => p.status !== 'è²©å£²æ¸ˆ').length;
      const counted = Object.keys(checkItems).length;
      const remaining = total - counted;
      const progress = total > 0 ? Math.round((counted / total) * 100) : 0;
      const diffCount = Object.values(checkItems).filter(item => item.diff !== 0).length;

      document.getElementById('count-progress').textContent = progress + '%';
      document.getElementById('count-done').textContent = counted;
      document.getElementById('count-remaining').textContent = remaining;
      document.getElementById('count-diff').textContent = diffCount;

      // æœªã‚«ã‚¦ãƒ³ãƒˆãƒªã‚¹ãƒˆ
      const uncounted = allProducts.filter(p => p.status !== 'è²©å£²æ¸ˆ' && !checkItems[p.id]);
      const uncountedHtml = uncounted.length > 0 ? uncounted.slice(0, 50).map(p => `
        <div class="diff-item" onclick="selectProduct('${p.id}')">
          <div class="item-info">
            <div class="item-name">${p.managementNumber || '-'}</div>
            <div class="item-meta">${p.productName || '-'}</div>
          </div>
          <div class="text-muted small">å¸³ç°¿: ${p.quantity || 1}ç‚¹</div>
        </div>
      `).join('') : '<div class="text-center text-muted py-3">ã™ã¹ã¦ã‚«ã‚¦ãƒ³ãƒˆæ¸ˆã¿ã§ã™</div>';
      document.getElementById('uncountedList').innerHTML = uncountedHtml;

      // æ£šå¸ã®é€²æ—ã‚’æ›´æ–°
      if (activeCheck.progress !== progress) {
        StocktakingApi.updateCheck(activeCheck.id, { progress });
      }
    }

    function selectProduct(productId) {
      currentProduct = allProducts.find(p => p.id === productId);
      if (!currentProduct) return;

      const existingCount = checkItems[productId];
      const bookQty = currentProduct.quantity || 1;
      const actualQty = existingCount?.actualQuantity ?? '';

      document.getElementById('countInputArea').innerHTML = `
        <div class="count-input-card">
          <div class="product-info">
            <img src="${currentProduct.images?.[0] || '/images/no-image.png'}" class="product-image" onerror="this.src='/images/no-image.png'">
            <div class="product-details">
              <div class="product-name">${currentProduct.productName || '-'}</div>
              <div class="product-meta">
                ç®¡ç†ç•ªå·: ${currentProduct.managementNumber || '-'}<br>
                ${currentProduct.brand || ''} ${currentProduct.category || ''}
              </div>
            </div>
          </div>
          <div class="count-row">
            <span class="count-label">å¸³ç°¿åœ¨åº«:</span>
            <span class="count-value">${bookQty}ç‚¹</span>
          </div>
          <div class="count-row">
            <span class="count-label">å®Ÿåœ¨åº«:</span>
            <input type="number" class="count-input" id="actualQtyInput" value="${actualQty}" min="0" placeholder="0" autofocus>
            <span class="count-label">ç‚¹</span>
            <span class="diff-badge" id="diffBadge" style="display: none;"></span>
          </div>
          <div class="mt-3">
            <input type="text" class="form-control form-control-sm" id="countNote" placeholder="å‚™è€ƒï¼ˆä»»æ„ï¼‰" value="${existingCount?.note || ''}">
          </div>
          <div class="mt-3 d-flex gap-2">
            <button class="btn btn-outline-secondary flex-fill" onclick="clearCountInput()">
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
            <button class="btn btn-success flex-fill" onclick="saveCount('${productId}')">
              <i class="bi bi-check-lg"></i> ä¿å­˜
            </button>
          </div>
        </div>
      `;

      // å·®ç•°è¡¨ç¤ºæ›´æ–°
      document.getElementById('actualQtyInput').addEventListener('input', function() {
        updateDiffBadge(bookQty, this.value);
      });
      if (actualQty !== '') {
        updateDiffBadge(bookQty, actualQty);
      }

      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      setTimeout(() => document.getElementById('actualQtyInput').focus(), 100);
    }

    function updateDiffBadge(bookQty, actualQty) {
      const badge = document.getElementById('diffBadge');
      const actual = parseInt(actualQty) || 0;
      const diff = actual - bookQty;

      if (actualQty === '' || actualQty === null) {
        badge.style.display = 'none';
        return;
      }

      badge.style.display = 'inline-block';
      if (diff === 0) {
        badge.className = 'diff-badge match';
        badge.textContent = 'ä¸€è‡´';
      } else if (diff > 0) {
        badge.className = 'diff-badge over';
        badge.textContent = `+${diff}`;
      } else {
        badge.className = 'diff-badge under';
        badge.textContent = `${diff}`;
      }
    }

    function clearCountInput() {
      document.getElementById('countInputArea').innerHTML = '';
      currentProduct = null;
    }

    async function saveCount(productId) {
      const actualQty = parseInt(document.getElementById('actualQtyInput').value);
      const note = document.getElementById('countNote').value;

      if (isNaN(actualQty) || actualQty < 0) {
        alert('å®Ÿåœ¨åº«æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const product = allProducts.find(p => p.id === productId);
      const bookQty = product?.quantity || 1;
      const diff = actualQty - bookQty;

      showLoading();
      try {
        await StocktakingApi.saveCountItem(activeCheck.id, productId, {
          productId,
          managementNumber: product?.managementNumber || '',
          productName: product?.productName || '',
          bookQuantity: bookQty,
          actualQuantity: actualQty,
          diff,
          note,
          purchaseAmount: product?.purchase?.amount || product?.purchaseAmount || 0
        });

        // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°
        checkItems[productId] = {
          id: productId,
          bookQuantity: bookQty,
          actualQuantity: actualQty,
          diff,
          note
        };

        clearCountInput();
        updateCountTab();
        updateDiffTab();

        // å…¨å®Œäº†ãƒã‚§ãƒƒã‚¯
        const total = allProducts.filter(p => p.status !== 'è²©å£²æ¸ˆ').length;
        if (Object.keys(checkItems).length >= total) {
          if (confirm('ã™ã¹ã¦ã®å•†å“ã®ã‚«ã‚¦ãƒ³ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚å·®ç•°åˆ†æã‚¿ãƒ–ã‚’é–‹ãã¾ã™ã‹ï¼Ÿ')) {
            const tab = document.querySelector('[data-bs-target="#diff-tab"]');
            bootstrap.Tab.getOrCreateInstance(tab).show();
          }
        }
      } catch (error) {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        hideLoading();
      }
    }

    function updateDiffTab() {
      const items = Object.values(checkItems);
      if (items.length === 0) {
        document.getElementById('noDiffData').style.display = 'block';
        document.getElementById('diffPanel').style.display = 'none';
        return;
      }

      document.getElementById('noDiffData').style.display = 'none';
      document.getElementById('diffPanel').style.display = 'block';

      const total = items.length;
      const match = items.filter(i => i.diff === 0).length;
      const over = items.filter(i => i.diff > 0).length;
      const under = items.filter(i => i.diff < 0).length;

      document.getElementById('diff-total').textContent = total;
      document.getElementById('diff-match').textContent = match;
      document.getElementById('diff-over').textContent = over;
      document.getElementById('diff-under').textContent = under;

      // å·®ç•°é‡‘é¡è¨ˆç®—
      let overAmount = 0, underAmount = 0;
      items.forEach(item => {
        const amount = (item.purchaseAmount || 0) * Math.abs(item.diff);
        if (item.diff > 0) overAmount += amount;
        else if (item.diff < 0) underAmount += amount;
      });

      document.getElementById('diff-over-amount').textContent = formatCurrency(overAmount);
      document.getElementById('diff-under-amount').textContent = formatCurrency(underAmount);

      // å·®ç•°è©³ç´°ï¼ˆå·®ç•°ã‚ã‚Šã®ã¿ï¼‰
      const diffItems = items.filter(i => i.diff !== 0).sort((a, b) => Math.abs(b.diff) - Math.abs(a.diff));
      const diffHtml = diffItems.length > 0 ? diffItems.map(item => `
        <div class="diff-item">
          <div class="item-info">
            <div class="item-name">${item.managementNumber || '-'}</div>
            <div class="item-meta">${item.productName || '-'}</div>
          </div>
          <div class="diff-values">
            <div>å¸³ç°¿: ${item.bookQuantity} â†’ å®Ÿ: ${item.actualQuantity}</div>
            <span class="diff-badge ${item.diff > 0 ? 'over' : 'under'}">${item.diff > 0 ? '+' : ''}${item.diff}</span>
          </div>
        </div>
      `).join('') : '<div class="text-center text-muted py-3">å·®ç•°ãªã—ï¼ˆã™ã¹ã¦ä¸€è‡´ï¼‰</div>';
      document.getElementById('diffDetailList').innerHTML = diffHtml;
    }

    // QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼
    function startScanner() {
      document.getElementById('scanOverlay').classList.add('active');

      html5QrCode = new Html5Qrcode("qr-reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        onScanSuccess,
        onScanFailure
      ).catch(err => {
        console.error('ã‚¹ã‚­ãƒ£ãƒŠãƒ¼èµ·å‹•ã‚¨ãƒ©ãƒ¼:', err);
        alert('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
        stopScanner();
      });
    }

    function stopScanner() {
      document.getElementById('scanOverlay').classList.remove('active');
      if (html5QrCode) {
        html5QrCode.stop().catch(err => console.log('ã‚¹ã‚­ãƒ£ãƒŠãƒ¼åœæ­¢:', err));
        html5QrCode = null;
      }
    }

    function onScanSuccess(decodedText) {
      console.log('QRã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸ:', decodedText);
      stopScanner();

      // QRã‚³ãƒ¼ãƒ‰ã‹ã‚‰ç®¡ç†ç•ªå·ã‚’æŠ½å‡º
      let managementNumber = decodedText;
      try {
        const qrData = JSON.parse(decodedText);
        if (qrData.managementNumber) {
          managementNumber = qrData.managementNumber;
        }
      } catch (e) {
        // JSONä»¥å¤–ã¯ãã®ã¾ã¾ä½¿ç”¨
      }

      // å•†å“æ¤œç´¢
      const product = allProducts.find(p =>
        p.managementNumber === managementNumber || p.id === managementNumber
      );

      if (product) {
        selectProduct(product.id);
      } else {
        alert('å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ' + managementNumber);
      }
    }

    function onScanFailure(error) {
      // ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—ã¯ç„¡è¦–ï¼ˆç¶™ç¶šã‚¹ã‚­ãƒ£ãƒ³ï¼‰
    }

    function searchProduct() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return;

      const product = allProducts.find(p =>
        p.managementNumber?.toLowerCase().includes(query.toLowerCase()) ||
        p.productName?.toLowerCase().includes(query.toLowerCase())
      );

      if (product) {
        selectProduct(product.id);
        document.getElementById('searchInput').value = '';
      } else {
        alert('å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }
    }

    // æ–°è¦æ£šå¸ä½œæˆ
    function openNewCheckModal() {
      new bootstrap.Modal(document.getElementById('newCheckModal')).show();
    }

    async function createNewCheck() {
      const name = document.getElementById('checkName').value.trim();
      const checkDate = document.getElementById('checkDate').value;

      if (!name) {
        alert('æ£šå¸åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      showLoading();
      try {
        const checkId = await StocktakingApi.createCheck({
          name,
          checkDate,
          method: document.getElementById('countMethod').value,
          targetProducts: document.getElementById('targetProducts').checked
        });

        bootstrap.Modal.getInstance(document.getElementById('newCheckModal')).hide();

        // ãƒªãƒ­ãƒ¼ãƒ‰
        await loadData();
        await selectCheck(checkId);

        alert('âœ… æ£šå¸ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
      } catch (error) {
        console.error('ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
        alert('æ£šå¸ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        hideLoading();
      }
    }

    // åœ¨åº«èª¿æ•´é©ç”¨
    async function applyAdjustment() {
      if (!activeCheck) return;

      const diffItems = Object.values(checkItems).filter(i => i.diff !== 0);
      if (diffItems.length === 0) {
        alert('èª¿æ•´ãŒå¿…è¦ãªå·®ç•°ã¯ã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      if (!confirm(`${diffItems.length}ä»¶ã®åœ¨åº«ã‚’èª¿æ•´ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
        return;
      }

      showLoading();
      try {
        // å„å•†å“ã®åœ¨åº«æ•°ã‚’æ›´æ–°
        for (const item of diffItems) {
          await StocktakingApi.updateProductQuantity(item.productId || item.id, item.actualQuantity);
        }

        // æ£šå¸ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å®Œäº†ã«
        await StocktakingApi.updateCheck(activeCheck.id, {
          status: 'adjusted',
          completedAt: new Date(),
          diffCount: diffItems.length
        });

        alert('âœ… åœ¨åº«èª¿æ•´ãŒå®Œäº†ã—ã¾ã—ãŸ');

        // ãƒªãƒ­ãƒ¼ãƒ‰
        await loadData();
      } catch (error) {
        console.error('èª¿æ•´ã‚¨ãƒ©ãƒ¼:', error);
        alert('åœ¨åº«èª¿æ•´ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        hideLoading();
      }
    }

    // ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
    function exportDiffReport() {
      const items = Object.values(checkItems);
      const bom = '\uFEFF';
      let csv = `æ£šå¸ãƒ¬ãƒãƒ¼ãƒˆ - ${activeCheck?.name || 'æ£šå¸'}\n`;
      csv += `å®Ÿæ–½æ—¥: ${activeCheck?.checkDate || '-'}\n\n`;
      csv += 'ç®¡ç†ç•ªå·,å•†å“å,å¸³ç°¿åœ¨åº«,å®Ÿåœ¨åº«,å·®ç•°,å‚™è€ƒ\n';

      items.forEach(item => {
        csv += [
          item.managementNumber || '',
          `"${(item.productName || '').replace(/"/g, '""')}"`,
          item.bookQuantity,
          item.actualQuantity,
          item.diff,
          `"${(item.note || '').replace(/"/g, '""')}"`
        ].join(',') + '\n';
      });

      const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `æ£šå¸ãƒ¬ãƒãƒ¼ãƒˆ_${activeCheck?.checkDate || 'report'}.csv`;
      link.click();
    }

    function viewCheckReport(checkId) {
      // TODO: å®Œäº†ã—ãŸæ£šå¸ã®ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
      alert('ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤ºæ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™');
    }

    function goBack() {
      const isInIframe = window.self !== window.top;
      if (isInIframe) {
        window.top.postMessage({ type: 'goBack' }, '*');
      } else {
        window.location.href = '/menu_home.html';
      }
    }

    // Enter ã‚­ãƒ¼ã§æ¤œç´¢
    document.getElementById('searchInput')?.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') searchProduct();
    });

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: DOMContentLoadedã§ã‚‚åˆæœŸåŒ–ã‚’è©¦ã¿ã‚‹
    let initialized = false;
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸ“‹ [æ£šå¸] DOMContentLoaded');
      if (!initialized) {
        initialized = true;
        initializePage();
      }
    });

    // æ—¢ã«DOMãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if (document.readyState !== 'loading') {
      console.log('ğŸ“‹ [æ£šå¸] DOM already loaded, initializing...');
      if (!initialized) {
        initialized = true;
        initializePage();
      }
    }
  </script>
</body>
</html>
