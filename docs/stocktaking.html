<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ£šå¸ - FURIRA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/reborn-theme.css?v=338-inv010-phase6">
  <!-- html5-qrcode for QR scanning -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <!-- QRCode.js for QR generation (æ£šå¸ã§ã¯ã‚¹ã‚­ãƒ£ãƒ³ã®ã¿ä½¿ç”¨ã€ç”Ÿæˆã¯ä¸è¦) -->
  <!-- æœŸé–“ãƒ™ãƒ¼ã‚¹æ£šå¸API -->
  <script src="/js/stocktaking-period-api.js" defer></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    .content-container {
      padding: 16px;
      max-width: 800px;
      margin: 0 auto;
    }

    /* ã‚¿ãƒ– */
    .nav-tabs-custom {
      background: white;
      border-radius: 12px;
      padding: 8px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: flex;
      gap: 8px;
    }
    .nav-tabs-custom .nav-item {
      flex: 1;
    }
    .nav-tabs-custom .nav-link {
      border: none;
      border-radius: 8px;
      padding: 12px 10px;
      color: #6b7280;
      font-weight: 500;
      font-size: 0.875rem;
      width: 100%;
      text-align: center;
      background: #f3f4f6;
    }
    .nav-tabs-custom .nav-link:hover {
      background: #e0f7fa;
      color: #1E8FBF;
    }
    .nav-tabs-custom .nav-link.active {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      color: white;
    }

    /* ã‚«ãƒ¼ãƒ‰ */
    .card-section {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .card-section h6 {
      color: #374151;
      font-weight: 600;
      margin-bottom: 12px;
    }

    /* ã‚µãƒãƒªãƒ¼ã‚°ãƒªãƒƒãƒ‰ */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    .summary-card {
      background: white;
      padding: 12px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .summary-card.highlight {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    .summary-card.highlight .summary-label { color: rgba(255,255,255,0.8); }
    .summary-card.highlight .summary-value { color: white; }
    .summary-card.warning { border: 2px solid #f59e0b; }
    .summary-card.danger { border: 2px solid #ef4444; }
    .summary-label {
      font-size: 0.7rem;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .summary-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: #1f2937;
    }

    /* æ£šå¸ãƒªã‚¹ãƒˆ */
    .check-item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: all 0.2s;
    }
    .check-item:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    .check-item.active {
      border: 2px solid #10b981;
    }
    .check-status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .check-status.draft { background: #e5e7eb; color: #374151; }
    .check-status.in-progress { background: #fef3c7; color: #92400e; }
    .check-status.completed { background: #d1fae5; color: #065f46; }
    .check-status.adjusted { background: #dbeafe; color: #1e40af; }

    /* åœ¨åº«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ */
    .inventory-status {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      margin-left: 6px;
    }
    .inventory-status.purchased { background: #fef3c7; color: #92400e; }
    .inventory-status.registered { background: #d1fae5; color: #065f46; }
    .inventory-status.sold { background: #e5e7eb; color: #6b7280; }

    /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
    .progress-bar-custom {
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin: 8px 0;
    }
    .progress-bar-custom .fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #059669);
      transition: width 0.3s;
    }

    /* QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ */
    #qr-reader {
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
      border-radius: 12px;
      overflow: hidden;
    }
    #qr-reader video {
      border-radius: 12px;
    }
    .scan-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      z-index: 9999;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .scan-overlay.active { display: flex; }
    .scan-header {
      color: white;
      text-align: center;
      margin-bottom: 20px;
    }
    .scan-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
    }

    /* ã‚«ã‚¦ãƒ³ãƒˆå…¥åŠ› */
    .count-input-card {
      background: #f0fdf4;
      border: 2px solid #10b981;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .count-input-card .product-info {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    .count-input-card .product-image {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      background: #e5e7eb;
    }
    .count-input-card .product-details {
      flex: 1;
    }
    .count-input-card .product-name {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }
    .count-input-card .product-meta {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .count-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 12px;
    }
    .count-label {
      font-size: 0.875rem;
      color: #374151;
      min-width: 80px;
    }
    .count-value {
      font-size: 1.25rem;
      font-weight: 700;
    }
    .count-input {
      width: 80px;
      text-align: center;
      font-size: 1.25rem;
      font-weight: 700;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      padding: 8px;
    }
    .count-input:focus {
      border-color: #10b981;
      outline: none;
    }
    .diff-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: 600;
    }
    .diff-badge.match { background: #d1fae5; color: #065f46; }
    .diff-badge.over { background: #dbeafe; color: #1e40af; }
    .diff-badge.under { background: #fee2e2; color: #991b1b; }

    /* å·®ç•°ãƒªã‚¹ãƒˆ */
    .diff-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
    }
    .diff-item:last-child { border-bottom: none; }
    .diff-item .item-info { flex: 1; }
    .diff-item .item-name { font-weight: 600; font-size: 0.9rem; }
    .diff-item .item-meta { font-size: 0.75rem; color: #6b7280; }
    .diff-item .diff-values {
      text-align: right;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ« */
    .data-table {
      width: 100%;
      font-size: 0.8rem;
    }
    .data-table th {
      background: #f9fafb;
      padding: 10px 8px;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
      white-space: nowrap;
    }
    .data-table td {
      padding: 10px 8px;
      border-bottom: 1px solid #f3f4f6;
      vertical-align: middle;
    }
    .data-table tr:hover { background: #f9fafb; }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9998;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-content { border-radius: 16px; }
    .modal-header { border-bottom: none; padding-bottom: 0; }
    .modal-footer { border-top: none; padding-top: 0; }

    /* FAB */
    .fab-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }
    .fab-button {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .fab-button:active { transform: scale(0.95); }

    /* INV-010: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ */
    .filter-btn {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 20px;
    }
    .filter-btn.active {
      background: #10b981;
      border-color: #10b981;
      color: white;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 576px) {
      .summary-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="text-center">
      <div class="spinner-border text-success" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>
  </div>

  <!-- QRã‚¹ã‚­ãƒ£ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div class="scan-overlay" id="scanOverlay">
    <button class="scan-close" onclick="stopScanner()">Ã—</button>
    <div class="scan-header">
      <h5>QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</h5>
      <p class="small text-muted mb-0">å•†å“ã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„</p>
    </div>
    <div id="qr-reader"></div>
    <button class="btn btn-outline-light mt-3" onclick="stopScanner()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>

  <!-- ãƒŸãƒ‹ãƒãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <style>
    .minimal-header {
      background: #ffffff;
      height: 56px;
      padding: 0 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 1px solid #f0f0f0;
    }
    .minimal-header-logo {
      width: 100px;
      height: auto;
      cursor: pointer;
    }
    .minimal-header-icons {
      display: flex;
      align-items: center;
      gap: 2px;
    }
    .minimal-header-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 20px;
      transition: background 0.2s;
      position: relative;
    }
    .minimal-header-icon:hover {
      background: #f2f2f2;
    }
    .minimal-header-icon:active {
      background: #e5e5e5;
    }
    /* è¨­å®šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ */
    .settings-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 200px;
      padding: 8px 0;
      display: none;
      z-index: 1001;
    }
    .settings-dropdown.active {
      display: block;
    }
    .settings-dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border: none;
      background: none;
      width: 100%;
      font-size: 14px;
      color: #374151;
      cursor: pointer;
      text-align: left;
    }
    .settings-dropdown-item:hover {
      background: #f3f4f6;
    }
    .settings-dropdown-item i {
      font-size: 18px;
      color: #6b7280;
      width: 20px;
      text-align: center;
    }
    .announce-dot {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      display: none;
    }
    .announce-dot.visible {
      display: block;
    }
  </style>
  <div class="minimal-header">
    <img src="/images/furira-square-logo.png?v=20251209" alt="Furira" class="minimal-header-logo" onclick="window.parent.postMessage({type:'navigate', page:'home'}, '*')">
    <span style="position: absolute; left: 50%; transform: translateX(-50%); font-weight: 600; color: #1f2937; font-size: 16px;">æ£šå¸</span>
    <div class="minimal-header-icons">
      <button class="minimal-header-icon" title="é€šçŸ¥" onclick="openAnnouncePage()">
        <i class="bi bi-bell"></i>
        <span class="announce-dot" id="announceDot"></span>
      </button>
      <div style="position: relative;">
        <button class="minimal-header-icon" title="è¨­å®š" onclick="toggleSettingsDropdown(event)">
          <i class="bi bi-gear"></i>
        </button>
        <div class="settings-dropdown" id="settingsDropdown">
          <button class="settings-dropdown-item" onclick="openNewCheckModal(); closeSettingsDropdown();">
            <i class="bi bi-plus-lg"></i>
            <span>æ–°è¦æ£šå¸ï¼ˆå˜æ—¥ï¼‰</span>
          </button>
          <a href="/stocktaking-admin.html" class="settings-dropdown-item" style="text-decoration: none; color: inherit;">
            <i class="bi bi-calendar-range"></i>
            <span>æœŸé–“æ£šå¸ç®¡ç†</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="content-container">
    <!-- æœŸé–“æ£šå¸ãƒãƒŠãƒ¼ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–æœŸé–“ãŒã‚ã‚‹å ´åˆã«è¡¨ç¤ºï¼‰ -->
    <div id="periodBanner" class="card-section" style="display: none; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; margin-bottom: 16px;">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="fw-bold" id="periodBannerName">æœŸé–“æ£šå¸å®Ÿæ–½ä¸­</div>
          <div style="font-size: 0.85rem; opacity: 0.9;" id="periodBannerInfo">æœŸé–“: - | æ®‹ã‚Š: -æ—¥</div>
        </div>
        <div id="periodBannerProgress" style="text-align: right;">
          <div style="font-size: 1.5rem; font-weight: 700;">0%</div>
          <div style="font-size: 0.75rem; opacity: 0.9;">å®Œäº†</div>
        </div>
      </div>
      <div class="progress mt-2" style="height: 6px; background: rgba(255,255,255,0.3); border-radius: 3px;">
        <div class="progress-bar" id="periodProgressBar" role="progressbar" style="width: 0%; background: white;"></div>
      </div>
    </div>

    <!-- ã‚¿ãƒ– -->
    <ul class="nav nav-tabs-custom" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#list-tab" type="button">
          <i class="bi bi-list-ul"></i> ä¸€è¦§
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#count-tab" type="button" id="count-tab-btn">
          <i class="bi bi-pencil-square"></i> ã‚«ã‚¦ãƒ³ãƒˆ
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#diff-tab" type="button">
          <i class="bi bi-graph-up-arrow"></i> å·®ç•°åˆ†æ
        </button>
      </li>
    </ul>

    <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="tab-content">
      <!-- ä¸€è¦§ã‚¿ãƒ– -->
      <div class="tab-pane fade show active" id="list-tab" role="tabpanel">
        <!-- é€²è¡Œä¸­ã®æ£šå¸ -->
        <div class="card-section">
          <h6><i class="bi bi-clock-history"></i> é€²è¡Œä¸­</h6>
          <div id="inProgressList">
            <div class="text-center text-muted py-3">é€²è¡Œä¸­ã®æ£šå¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>
          </div>
        </div>

        <!-- å®Œäº†æ¸ˆã¿ -->
        <div class="card-section">
          <h6><i class="bi bi-check-circle"></i> å®Œäº†æ¸ˆã¿</h6>
          <div id="completedList">
            <div class="text-center text-muted py-3">å®Œäº†ã—ãŸæ£šå¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>
          </div>
        </div>
      </div>

      <!-- ã‚«ã‚¦ãƒ³ãƒˆã‚¿ãƒ– -->
      <div class="tab-pane fade" id="count-tab" role="tabpanel">
        <!-- ç¾åœ¨ã®æ£šå¸æƒ…å ± -->
        <div id="noActiveCheck" class="card-section text-center py-4">
          <i class="bi bi-clipboard-x text-muted" style="font-size: 48px;"></i>
          <p class="text-muted mt-2 mb-3">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ£šå¸ãŒã‚ã‚Šã¾ã›ã‚“</p>
          <button class="btn btn-success" onclick="openNewCheckModal()">
            <i class="bi bi-plus-lg"></i> æ–°è¦æ£šå¸ã‚’é–‹å§‹
          </button>
        </div>

        <div id="activeCheckPanel" style="display: none;">
          <!-- é€²æ—ã‚µãƒãƒªãƒ¼ -->
          <div class="summary-grid">
            <div class="summary-card highlight">
              <div class="summary-label">é€²æ—</div>
              <div class="summary-value" id="count-progress">0%</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">å®Œäº†</div>
              <div class="summary-value" id="count-done">0</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">æ®‹ã‚Š</div>
              <div class="summary-value" id="count-remaining">0</div>
            </div>
            <div class="summary-card warning">
              <div class="summary-label">å·®ç•°</div>
              <div class="summary-value" id="count-diff">0</div>
            </div>
          </div>

          <!-- INV-010: å•†å“ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
          <div class="card-section">
            <div class="d-flex gap-2 mb-2">
              <button class="btn btn-sm btn-outline-secondary filter-btn active" data-filter="all" onclick="setItemFilter('all')">
                ã™ã¹ã¦
              </button>
              <button class="btn btn-sm btn-outline-secondary filter-btn" data-filter="unique" onclick="setItemFilter('unique')">
                ğŸ‘• 1ç‚¹ç‰©
              </button>
              <button class="btn btn-sm btn-outline-secondary filter-btn" data-filter="sku-based" onclick="setItemFilter('sku-based')">
                ğŸ“¦ SKUå•†å“
              </button>
            </div>
            <div id="filterSummary" class="small text-muted mb-2"></div>
          </div>

          <!-- ã‚¹ã‚­ãƒ£ãƒ³/æ¤œç´¢ -->
          <div class="card-section">
            <div class="row g-2">
              <div class="col">
                <button class="btn btn-success w-100" onclick="startScanner()">
                  <i class="bi bi-qr-code-scan"></i> QRã‚¹ã‚­ãƒ£ãƒ³
                </button>
              </div>
              <div class="col">
                <div class="input-group">
                  <input type="text" class="form-control" id="searchInput" placeholder="ç®¡ç†ç•ªå·ã§æ¤œç´¢">
                  <button class="btn btn-outline-secondary" onclick="searchProduct()">
                    <i class="bi bi-search"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- ã‚«ã‚¦ãƒ³ãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ -->
          <div id="countInputArea">
            <!-- å•†å“é¸æŠå¾Œã«è¡¨ç¤º -->
          </div>

          <!-- æœªã‚«ã‚¦ãƒ³ãƒˆãƒªã‚¹ãƒˆ -->
          <div class="card-section">
            <h6><i class="bi bi-list-ul"></i> æœªã‚«ã‚¦ãƒ³ãƒˆå•†å“</h6>
            <div id="uncountedList" style="max-height: 300px; overflow-y: auto;">
              <div class="text-center text-muted py-3">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- å·®ç•°åˆ†æã‚¿ãƒ– -->
      <div class="tab-pane fade" id="diff-tab" role="tabpanel">
        <div id="noDiffData" class="card-section text-center py-4">
          <i class="bi bi-bar-chart text-muted" style="font-size: 48px;"></i>
          <p class="text-muted mt-2">æ£šå¸ã‚’å®Œäº†ã™ã‚‹ã¨å·®ç•°åˆ†æãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
        </div>

        <div id="diffPanel" style="display: none;">
          <!-- å·®ç•°ã‚µãƒãƒªãƒ¼ -->
          <div class="summary-grid">
            <div class="summary-card">
              <div class="summary-label">ç·ã‚¢ã‚¤ãƒ†ãƒ </div>
              <div class="summary-value" id="diff-total">0</div>
            </div>
            <div class="summary-card highlight">
              <div class="summary-label">ä¸€è‡´</div>
              <div class="summary-value" id="diff-match">0</div>
            </div>
            <div class="summary-card warning">
              <div class="summary-label">éå‰°</div>
              <div class="summary-value" id="diff-over">0</div>
            </div>
            <div class="summary-card danger">
              <div class="summary-label">ä¸è¶³</div>
              <div class="summary-value" id="diff-under">0</div>
            </div>
          </div>

          <!-- å·®ç•°é‡‘é¡ -->
          <div class="card-section">
            <h6><i class="bi bi-currency-yen"></i> å·®ç•°é‡‘é¡</h6>
            <div class="row text-center">
              <div class="col-6">
                <div class="text-muted small">éå‰°ï¼ˆæ£šå¸å¢—ï¼‰</div>
                <div class="text-primary fw-bold fs-5" id="diff-over-amount">Â¥0</div>
              </div>
              <div class="col-6">
                <div class="text-muted small">ä¸è¶³ï¼ˆæ£šå¸æ¸›ï¼‰</div>
                <div class="text-danger fw-bold fs-5" id="diff-under-amount">Â¥0</div>
              </div>
            </div>
          </div>

          <!-- å·®ç•°è©³ç´° -->
          <div class="card-section">
            <h6><i class="bi bi-exclamation-triangle"></i> å·®ç•°è©³ç´°</h6>
            <div id="diffDetailList" style="max-height: 400px; overflow-y: auto;">
              <div class="text-center text-muted py-3">å·®ç•°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
            </div>
          </div>

          <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="card-section">
            <div class="row g-2">
              <div class="col-6">
                <button class="btn btn-outline-success w-100" onclick="exportDiffReport()">
                  <i class="bi bi-download"></i> ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
                </button>
              </div>
              <div class="col-6">
                <button class="btn btn-success w-100" onclick="applyAdjustment()">
                  <i class="bi bi-check-lg"></i> åœ¨åº«èª¿æ•´ã‚’é©ç”¨
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FABï¼ˆã‚«ã‚¦ãƒ³ãƒˆä¸­ã®ã¿ï¼‰ -->
  <div class="fab-container" id="fabContainer" style="display: none;">
    <button class="fab-button" onclick="startScanner()">
      <i class="bi bi-qr-code-scan"></i>
    </button>
  </div>

  <!-- æ–°è¦æ£šå¸ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal fade" id="newCheckModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-plus-circle"></i> æ–°è¦æ£šå¸</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">æ£šå¸åç§°</label>
            <input type="text" class="form-control" id="checkName" placeholder="ä¾‹: 2025å¹´12æœˆæ£šå¸">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">å®Ÿæ–½æ—¥</label>
            <input type="date" class="form-control" id="checkDate">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">å¯¾è±¡</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="targetProducts" checked>
              <label class="form-check-label" for="targetProducts">å•†å“åœ¨åº«</label>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">ã‚«ã‚¦ãƒ³ãƒˆæ–¹å¼</label>
            <select class="form-select" id="countMethod">
              <option value="all">å…¨æ•°æ£šå¸ï¼ˆå…¨å•†å“ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼‰</option>
              <option value="category">ã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼ˆç‰¹å®šã‚«ãƒ†ã‚´ãƒªã®ã¿ï¼‰</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="btn btn-success" onclick="createNewCheck()">
            <i class="bi bi-play-fill"></i> é–‹å§‹
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, doc, getDocs, getDoc, setDoc, updateDoc, addDoc, deleteDoc, query, where, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "furira.jp",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // APIå…¬é–‹
    window.StocktakingApi = {
      db,
      // ä»•å…¥å•†å“ä¸€è¦§å–å¾—ï¼ˆpurchaseSlotsãƒ™ãƒ¼ã‚¹ï¼‰
      async getPurchaseSlots() {
        const snapshot = await getDocs(collection(db, 'purchaseSlots'));
        const slots = [];
        snapshot.forEach(doc => slots.push({ id: doc.id, ...doc.data() }));
        return slots;
      },
      // å•†å“ä¸€è¦§å–å¾—ï¼ˆproducts - è£œåŠ©ç”¨ï¼‰
      async getProducts() {
        const snapshot = await getDocs(collection(db, 'products'));
        const products = [];
        snapshot.forEach(doc => products.push({ id: doc.id, ...doc.data() }));
        return products;
      },
      // æ£šå¸ä¸€è¦§å–å¾—
      async getChecks() {
        const snapshot = await getDocs(collection(db, 'inventoryChecks'));
        const checks = [];
        snapshot.forEach(doc => checks.push({ id: doc.id, ...doc.data() }));
        return checks.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
      },
      // æ£šå¸ä½œæˆ
      async createCheck(data) {
        const docRef = await addDoc(collection(db, 'inventoryChecks'), {
          ...data,
          status: 'in_progress',
          progress: 0,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        return docRef.id;
      },
      // æ£šå¸æ›´æ–°
      async updateCheck(checkId, data) {
        await updateDoc(doc(db, 'inventoryChecks', checkId), {
          ...data,
          updatedAt: serverTimestamp()
        });
      },
      // ã‚«ã‚¦ãƒ³ãƒˆçµæœå–å¾—
      async getCheckItems(checkId) {
        const snapshot = await getDocs(collection(db, 'inventoryChecks', checkId, 'items'));
        const items = [];
        snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
        return items;
      },
      // ã‚«ã‚¦ãƒ³ãƒˆçµæœä¿å­˜
      async saveCountItem(checkId, productId, data) {
        await setDoc(doc(db, 'inventoryChecks', checkId, 'items', productId), {
          ...data,
          countedAt: serverTimestamp()
        });
      },
      // å•†å“ã®åœ¨åº«æ•°æ›´æ–°
      async updateProductQuantity(productId, quantity, itemData = {}) {
        // INV-010: SKUå•†å“ã®å ´åˆã¯skusã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚‚æ›´æ–°
        if (itemData.itemType === 'sku-based' && itemData.skuId) {
          await updateDoc(doc(db, 'products', productId), {
            stockQuantity: quantity,
            updatedAt: serverTimestamp()
          });
          // skusã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚‚æ›´æ–°
          const skuQuery = query(collection(db, 'skus'), where('skuId', '==', itemData.skuId));
          const skuSnapshot = await getDocs(skuQuery);
          for (const skuDoc of skuSnapshot.docs) {
            await updateDoc(doc(db, 'skus', skuDoc.id), {
              currentStock: quantity,
              updatedAt: serverTimestamp()
            });
          }
        } else {
          // é€šå¸¸ã®1ç‚¹ç‰©
          await updateDoc(doc(db, 'products', productId), {
            quantity: quantity,
            updatedAt: serverTimestamp()
          });
        }
      }
    };

    console.log('âœ… [æ£šå¸] FirebaseåˆæœŸåŒ–å®Œäº†');

    // FirebaseãŒæº–å‚™å®Œäº†ã—ãŸã“ã¨ã‚’ãƒ•ãƒ©ã‚°ã§é€šçŸ¥
    window.firebaseReady = true;

    // DOMContentLoadedã§åˆæœŸåŒ–ã‚’è©¦ã¿ã‚‹
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        if (typeof initializePage === 'function') {
          initializePage();
        }
      });
    } else {
      // æ—¢ã«DOMãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
      setTimeout(() => {
        if (typeof initializePage === 'function') {
          initializePage();
        }
      }, 0);
    }
  </script>

  <script>
    let allPurchaseSlots = []; // ä»•å…¥å•†å“ï¼ˆæ£šå¸ã®ä¸»ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ï¼‰
    let allProducts = [];      // å•†å“ï¼ˆè£œåŠ©ãƒ‡ãƒ¼ã‚¿ï¼‰
    let allChecks = [];
    let activeCheck = null;
    let checkItems = {};
    let currentSlot = null;    // ç¾åœ¨é¸æŠä¸­ã®ä»•å…¥å•†å“
    let html5QrCode = null;
    let currentItemFilter = 'all'; // INV-010: å•†å“ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆall, unique, sku-basedï¼‰

    // æ—¥æœ¬æ™‚é–“ã§ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆYYYY-MM-DDå½¢å¼ï¼‰
    function getJSTToday() {
      const now = new Date();
      const jst = new Date(now.getTime() + (9 * 60 + now.getTimezoneOffset()) * 60000);
      const year = jst.getFullYear();
      const month = String(jst.getMonth() + 1).padStart(2, '0');
      const day = String(jst.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // æ—¥æœ¬æ™‚é–“ã®æ—¥ä»˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
    function getJSTDate() {
      const now = new Date();
      return new Date(now.getTime() + (9 * 60 + now.getTimezoneOffset()) * 60000);
    }

    function showLoading() { document.getElementById('loadingOverlay').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }

    function formatCurrency(amount) {
      if (amount === null || amount === undefined || isNaN(amount)) return 'Â¥0';
      return 'Â¥' + Math.round(amount).toLocaleString();
    }

    function formatDate(timestamp) {
      if (!timestamp) return '-';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      return date.toLocaleDateString('ja-JP');
    }

    async function initializePage() {
      console.log('ğŸ“‹ [æ£šå¸] initializePageé–‹å§‹');
      showLoading();
      try {
        // Firebase APIãŒæº–å‚™ã§ãã‚‹ã¾ã§å¾…æ©Ÿ
        let waitCount = 0;
        while (!window.StocktakingApi && waitCount < 50) {
          await new Promise(r => setTimeout(r, 100));
          waitCount++;
        }
        if (!window.StocktakingApi) {
          throw new Error('Firebase APIã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        console.log('ğŸ“‹ [æ£šå¸] Firebase APIæº–å‚™å®Œäº†');

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ—¥ä»˜ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰
        document.getElementById('checkDate').value = getJSTToday();
        const jstDate = getJSTDate();
        document.getElementById('checkName').value = `${jstDate.getFullYear()}å¹´${jstDate.getMonth() + 1}æœˆæ£šå¸`;

        await loadData();

        // æœŸé–“ãƒ™ãƒ¼ã‚¹æ£šå¸ã®åˆæœŸåŒ–
        await initializePeriodStocktaking();

        console.log('ğŸ“‹ [æ£šå¸] åˆæœŸåŒ–å®Œäº†');
      } catch (error) {
        console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      } finally {
        hideLoading();
      }
    }

    async function loadData() {
      // purchaseSlotsã‚’ä¸»ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦å–å¾—
      allPurchaseSlots = await StocktakingApi.getPurchaseSlots();
      // productsã‚‚è£œåŠ©ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦å–å¾—ï¼ˆå•†å“è©³ç´°æƒ…å ±ç”¨ï¼‰
      allProducts = await StocktakingApi.getProducts();
      allChecks = await StocktakingApi.getChecks();

      // productsã®æƒ…å ±ã‚’purchaseSlotsã«ãƒãƒ¼ã‚¸
      const productMap = {};
      allProducts.forEach(p => {
        productMap[p.id] = p;
        // purchaseSlotIdã§ã‚‚ãƒãƒƒãƒ—
        if (p.purchaseSlotId) {
          productMap[p.purchaseSlotId] = p;
        }
      });

      // purchaseSlotsã«å•†å“è©³ç´°ã‚’è¿½åŠ 
      allPurchaseSlots = allPurchaseSlots.map(slot => {
        const product = productMap[slot.productId] || productMap[slot.id];
        // INV-010: itemTypeã¨stockQuantityã‚’å–å¾—
        const itemType = slot.itemType || product?.itemType || 'unique';
        const stockQuantity = itemType === 'sku-based'
          ? (product?.stockQuantity || slot.quantity || 1)
          : (product?.quantity || 1);
        return {
          ...slot,
          // å•†å“æƒ…å ±ãŒã‚ã‚Œã°ãƒãƒ¼ã‚¸
          productName: slot.productName || product?.productName || '',
          brand: slot.brand || product?.brand || '',
          category: slot.category || product?.category || '',
          images: product?.images || [],
          quantity: stockQuantity,
          // INV-010: SKUé–¢é€£ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
          itemType: itemType,
          stockQuantity: stockQuantity,
          skuId: slot.skuId || product?.skuId || null,
          purchaseAmount: slot.purchasePrice || product?.purchase?.amount || product?.purchaseAmount || 0,
          // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
          displayStatus: getDisplayStatus(slot, product, itemType)
        };
      });

      console.log(`ğŸ“‹ [æ£šå¸] ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: purchaseSlots=${allPurchaseSlots.length}, products=${allProducts.length}`);

      // é€²è¡Œä¸­ã®æ£šå¸ãŒã‚ã‚Œã°è¨­å®š
      activeCheck = allChecks.find(c => c.status === 'in_progress');
      if (activeCheck) {
        const items = await StocktakingApi.getCheckItems(activeCheck.id);
        checkItems = {};
        items.forEach(item => checkItems[item.id] = item);
      }

      renderCheckList();
      updateCountTab();
      updateDiffTab();
    }

    // è¡¨ç¤ºç”¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’åˆ¤å®š
    function getDisplayStatus(slot, product, itemType = 'unique') {
      // å£²å´æ¸ˆãƒã‚§ãƒƒã‚¯
      if (slot.status === 'sold' || product?.status === 'è²©å£²æ¸ˆ') {
        return { label: 'å£²å´æ¸ˆ', class: 'sold', color: '#6b7280' };
      }
      // INV-010: SKUå•†å“ã®å ´åˆã¯ç‰¹åˆ¥ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
      if (itemType === 'sku-based') {
        if (slot.status === 'registered' || slot.productId) {
          return { label: 'SKUå‡ºå“ä¸­', class: 'registered sku', color: '#3b82f6' };
        }
        return { label: 'SKUæœªç™»éŒ²', class: 'purchased sku', color: '#8b5cf6' };
      }
      // å•†å“ç™»éŒ²æ¸ˆãƒã‚§ãƒƒã‚¯
      if (slot.status === 'registered' || slot.productId) {
        return { label: 'å‡ºå“ä¸­', class: 'registered', color: '#10b981' };
      }
      // æœªç™»éŒ²
      return { label: 'æœªç™»éŒ²', class: 'purchased', color: '#f59e0b' };
    }

    function renderCheckList() {
      // é€²è¡Œä¸­
      const inProgress = allChecks.filter(c => c.status === 'in_progress');
      const inProgressHtml = inProgress.length > 0 ? inProgress.map(c => `
        <div class="check-item ${activeCheck?.id === c.id ? 'active' : ''}" onclick="selectCheck('${c.id}')">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-bold">${c.name || 'æ£šå¸'}</div>
              <div class="small text-muted">å®Ÿæ–½æ—¥: ${c.checkDate || '-'}</div>
            </div>
            <span class="check-status in-progress">é€²è¡Œä¸­</span>
          </div>
          <div class="progress-bar-custom">
            <div class="fill" style="width: ${c.progress || 0}%"></div>
          </div>
          <div class="small text-muted">${c.progress || 0}% å®Œäº†</div>
        </div>
      `).join('') : '<div class="text-center text-muted py-3">é€²è¡Œä¸­ã®æ£šå¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
      document.getElementById('inProgressList').innerHTML = inProgressHtml;

      // å®Œäº†æ¸ˆã¿
      const completed = allChecks.filter(c => c.status === 'completed' || c.status === 'adjusted');
      const completedHtml = completed.length > 0 ? completed.map(c => `
        <div class="check-item" onclick="viewCheckReport('${c.id}')">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-bold">${c.name || 'æ£šå¸'}</div>
              <div class="small text-muted">å®Œäº†æ—¥: ${formatDate(c.completedAt)}</div>
            </div>
            <span class="check-status ${c.status}">${c.status === 'adjusted' ? 'èª¿æ•´æ¸ˆ' : 'å®Œäº†'}</span>
          </div>
          <div class="small text-muted mt-1">å·®ç•°: ${c.diffCount || 0}ä»¶</div>
        </div>
      `).join('') : '<div class="text-center text-muted py-3">å®Œäº†ã—ãŸæ£šå¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
      document.getElementById('completedList').innerHTML = completedHtml;
    }

    async function selectCheck(checkId) {
      activeCheck = allChecks.find(c => c.id === checkId);
      if (activeCheck) {
        const items = await StocktakingApi.getCheckItems(checkId);
        checkItems = {};
        items.forEach(item => checkItems[item.id] = item);

        updateCountTab();
        // ã‚«ã‚¦ãƒ³ãƒˆã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
        const tab = document.querySelector('[data-bs-target="#count-tab"]');
        bootstrap.Tab.getOrCreateInstance(tab).show();
      }
    }

    // INV-010: å•†å“ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š
    function setItemFilter(filter) {
      currentItemFilter = filter;
      // ãƒœã‚¿ãƒ³ã®activeçŠ¶æ…‹ã‚’æ›´æ–°
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === filter) {
          btn.classList.add('active');
        }
      });
      updateCountTab();
    }

    function updateCountTab() {
      if (!activeCheck) {
        document.getElementById('noActiveCheck').style.display = 'block';
        document.getElementById('activeCheckPanel').style.display = 'none';
        document.getElementById('fabContainer').style.display = 'none';
        return;
      }

      document.getElementById('noActiveCheck').style.display = 'none';
      document.getElementById('activeCheckPanel').style.display = 'block';
      document.getElementById('fabContainer').style.display = 'block';

      // é€²æ—è¨ˆç®—ï¼ˆå£²å´æ¸ˆä»¥å¤–ã®purchaseSlotsãŒå¯¾è±¡ï¼‰
      const allTargetSlots = allPurchaseSlots.filter(s => s.displayStatus?.class !== 'sold');

      // INV-010: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
      const targetSlots = currentItemFilter === 'all'
        ? allTargetSlots
        : allTargetSlots.filter(s => s.itemType === currentItemFilter);

      // å…¨ä½“çµ±è¨ˆï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç„¡é–¢ä¿‚ï¼‰
      const totalAll = allTargetSlots.length;
      const countedAll = Object.keys(checkItems).length;
      const remainingAll = totalAll - countedAll;
      const progressAll = totalAll > 0 ? Math.round((countedAll / totalAll) * 100) : 0;
      const diffCount = Object.values(checkItems).filter(item => item.diff !== 0).length;

      document.getElementById('count-progress').textContent = progressAll + '%';
      document.getElementById('count-done').textContent = countedAll;
      document.getElementById('count-remaining').textContent = remainingAll;
      document.getElementById('count-diff').textContent = diffCount;

      // INV-010: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆ¥ã‚µãƒãƒªãƒ¼è¡¨ç¤º
      const uniqueCount = allTargetSlots.filter(s => s.itemType !== 'sku-based').length;
      const skuCount = allTargetSlots.filter(s => s.itemType === 'sku-based').length;
      const filterSummary = document.getElementById('filterSummary');
      if (filterSummary) {
        filterSummary.innerHTML = `ğŸ‘• 1ç‚¹ç‰©: ${uniqueCount}ä»¶ / ğŸ“¦ SKUå•†å“: ${skuCount}ä»¶`;
      }

      // æœªã‚«ã‚¦ãƒ³ãƒˆãƒªã‚¹ãƒˆï¼ˆpurchaseSlotsãƒ™ãƒ¼ã‚¹ï¼‰
      const uncounted = targetSlots.filter(s => !checkItems[s.id]);
      const uncountedHtml = uncounted.length > 0 ? uncounted.slice(0, 50).map(s => {
        // INV-010: SKUå•†å“ã‹ã©ã†ã‹ã‚’åˆ¤å®š
        const isSku = s.itemType === 'sku-based';
        const typeIcon = isSku ? 'ğŸ“¦' : 'ğŸ‘•';
        const qtyLabel = isSku ? `åœ¨åº«: ${s.stockQuantity || 1}ç‚¹` : `å¸³ç°¿: ${s.quantity || 1}ç‚¹`;
        return `
          <div class="diff-item" onclick="selectSlot('${s.id}')">
            <div class="item-info">
              <div class="item-name">
                ${typeIcon} ${s.managementNumber || s.slotId || s.id}
                <span class="badge" style="background: ${s.displayStatus?.color || '#6b7280'}; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 6px;">
                  ${s.displayStatus?.label || 'ä¸æ˜'}
                </span>
              </div>
              <div class="item-meta">${s.productName || s.brand || '-'}${s.skuId ? ` (${s.skuId})` : ''}</div>
            </div>
            <div class="text-muted small">${qtyLabel}</div>
          </div>
        `;
      }).join('') : '<div class="text-center text-muted py-3">ã™ã¹ã¦ã‚«ã‚¦ãƒ³ãƒˆæ¸ˆã¿ã§ã™</div>';
      document.getElementById('uncountedList').innerHTML = uncountedHtml;

      // æ£šå¸ã®é€²æ—ã‚’æ›´æ–°
      if (activeCheck.progress !== progressAll) {
        StocktakingApi.updateCheck(activeCheck.id, { progress: progressAll });
      }
    }

    // ä»•å…¥å•†å“ã‚’é¸æŠï¼ˆpurchaseSlotsãƒ™ãƒ¼ã‚¹ï¼‰
    function selectSlot(slotId) {
      currentSlot = allPurchaseSlots.find(s => s.id === slotId);
      if (!currentSlot) return;

      const existingCount = checkItems[slotId];
      const bookQty = currentSlot.quantity || 1;
      const actualQty = existingCount?.actualQuantity ?? '';

      // INV-010: SKUå•†å“åˆ¤å®š
      const isSku = currentSlot.itemType === 'sku-based';
      const typeIcon = isSku ? 'ğŸ“¦' : 'ğŸ‘•';
      const typeLabel = isSku ? 'SKUå•†å“ï¼ˆè¤‡æ•°åœ¨åº«ï¼‰' : '1ç‚¹ç‰©';

      // ã‚«ãƒ†ã‚´ãƒªè¡¨ç¤ºç”¨ã®æ–‡å­—åˆ—ã‚’ç”Ÿæˆ
      const categoryText = currentSlot.category
        ? (typeof currentSlot.category === 'object'
            ? (currentSlot.category.itemName || currentSlot.category.small || currentSlot.category.middle || currentSlot.category.major || '')
            : currentSlot.category)
        : '';

      // ç”»åƒURLï¼ˆå•†å“ç”»åƒã‚’å„ªå…ˆã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
      const imageUrl = currentSlot.images?.[0] || '/images/no-image.png';

      // INV-010: SKUå•†å“ã®å ´åˆã¯ãƒ’ãƒ³ãƒˆè¡¨ç¤º
      const skuHint = isSku ? `
        <div class="alert alert-info py-2 px-3 mb-2" style="font-size: 12px;">
          <i class="bi bi-info-circle"></i> ã“ã®SKUå•†å“ã¯<strong>${bookQty}ç‚¹</strong>ã®åœ¨åº«ãŒå¸³ç°¿ä¸Šã«ã‚ã‚Šã¾ã™ã€‚å®Ÿéš›ã«æ•°ãˆãŸæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
        </div>
      ` : '';

      document.getElementById('countInputArea').innerHTML = `
        <div class="count-input-card">
          <div class="product-info">
            <img src="${imageUrl}" class="product-image" onerror="this.src='/images/no-image.png'">
            <div class="product-details">
              <div class="product-name">
                ${typeIcon} ${currentSlot.productName || currentSlot.brand || '-'}
                <span class="badge" style="background: ${currentSlot.displayStatus?.color || '#6b7280'}; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 6px;">
                  ${currentSlot.displayStatus?.label || 'ä¸æ˜'}
                </span>
              </div>
              <div class="product-meta">
                <span class="badge bg-${isSku ? 'primary' : 'secondary'}" style="font-size: 10px;">${typeLabel}</span><br>
                ç®¡ç†ç•ªå·: ${currentSlot.managementNumber || '-'}<br>
                ${currentSlot.skuId ? `SKU ID: ${currentSlot.skuId}<br>` : ''}
                ä»•å…¥ID: ${currentSlot.slotId || currentSlot.id}<br>
                ${currentSlot.brand || ''}${categoryText ? ' / ' + categoryText : ''}
              </div>
            </div>
          </div>
          ${skuHint}
          <div class="count-row">
            <span class="count-label">å¸³ç°¿åœ¨åº«:</span>
            <span class="count-value">${bookQty}ç‚¹</span>
          </div>
          <div class="count-row">
            <span class="count-label">å®Ÿåœ¨åº«:</span>
            <input type="number" class="count-input" id="actualQtyInput" value="${actualQty}" min="0" placeholder="${isSku ? bookQty : '0'}" autofocus>
            <span class="count-label">ç‚¹</span>
            <span class="diff-badge" id="diffBadge" style="display: none;"></span>
          </div>
          <div class="mt-3">
            <input type="text" class="form-control form-control-sm" id="countNote" placeholder="å‚™è€ƒï¼ˆä»»æ„ï¼‰" value="${existingCount?.note || ''}">
          </div>
          <div class="mt-3 d-flex gap-2">
            <button class="btn btn-outline-secondary flex-fill" onclick="clearCountInput()">
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
            <button class="btn btn-success flex-fill" onclick="saveCount('${slotId}')">
              <i class="bi bi-check-lg"></i> ä¿å­˜
            </button>
          </div>
        </div>
      `;

      // å·®ç•°è¡¨ç¤ºæ›´æ–°
      document.getElementById('actualQtyInput').addEventListener('input', function() {
        updateDiffBadge(bookQty, this.value);
      });
      if (actualQty !== '') {
        updateDiffBadge(bookQty, actualQty);
      }

      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      setTimeout(() => document.getElementById('actualQtyInput').focus(), 100);
    }

    // å¾Œæ–¹äº’æ›: selectProductã¯selectSlotã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    function selectProduct(productId) {
      // productIdã‹ã‚‰purchaseSlotã‚’æ¤œç´¢
      const slot = allPurchaseSlots.find(s => s.productId === productId || s.id === productId);
      if (slot) {
        selectSlot(slot.id);
      }
    }

    function updateDiffBadge(bookQty, actualQty) {
      const badge = document.getElementById('diffBadge');
      const actual = parseInt(actualQty) || 0;
      const diff = actual - bookQty;

      if (actualQty === '' || actualQty === null) {
        badge.style.display = 'none';
        return;
      }

      badge.style.display = 'inline-block';
      if (diff === 0) {
        badge.className = 'diff-badge match';
        badge.textContent = 'ä¸€è‡´';
      } else if (diff > 0) {
        badge.className = 'diff-badge over';
        badge.textContent = `+${diff}`;
      } else {
        badge.className = 'diff-badge under';
        badge.textContent = `${diff}`;
      }
    }

    function clearCountInput() {
      document.getElementById('countInputArea').innerHTML = '';
      currentSlot = null;
    }

    async function saveCount(slotId) {
      const actualQty = parseInt(document.getElementById('actualQtyInput').value);
      const note = document.getElementById('countNote').value;

      if (isNaN(actualQty) || actualQty < 0) {
        alert('å®Ÿåœ¨åº«æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const slot = allPurchaseSlots.find(s => s.id === slotId);
      const bookQty = slot?.quantity || 1;
      const diff = actualQty - bookQty;

      showLoading();
      try {
        await StocktakingApi.saveCountItem(activeCheck.id, slotId, {
          slotId,
          productId: slot?.productId || '',
          managementNumber: slot?.managementNumber || '',
          productName: slot?.productName || '',
          brand: slot?.brand || '',
          bookQuantity: bookQty,
          actualQuantity: actualQty,
          diff,
          note,
          purchaseAmount: slot?.purchaseAmount || 0,
          status: slot?.displayStatus?.class || 'unknown',
          // INV-010: SKUé–¢é€£ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
          itemType: slot?.itemType || 'unique',
          skuId: slot?.skuId || null
        });

        // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°
        checkItems[slotId] = {
          id: slotId,
          managementNumber: slot?.managementNumber || '',
          productName: slot?.productName || '',
          bookQuantity: bookQty,
          actualQuantity: actualQty,
          diff,
          note,
          purchaseAmount: slot?.purchaseAmount || 0,
          // INV-010: SKUé–¢é€£ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
          itemType: slot?.itemType || 'unique',
          skuId: slot?.skuId || null
        };

        clearCountInput();
        updateCountTab();
        updateDiffTab();

        // å…¨å®Œäº†ãƒã‚§ãƒƒã‚¯
        const targetSlots = allPurchaseSlots.filter(s => s.displayStatus?.class !== 'sold');
        if (Object.keys(checkItems).length >= targetSlots.length) {
          if (confirm('ã™ã¹ã¦ã®åœ¨åº«ã®ã‚«ã‚¦ãƒ³ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚å·®ç•°åˆ†æã‚¿ãƒ–ã‚’é–‹ãã¾ã™ã‹ï¼Ÿ')) {
            const tab = document.querySelector('[data-bs-target="#diff-tab"]');
            bootstrap.Tab.getOrCreateInstance(tab).show();
          }
        }
      } catch (error) {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        hideLoading();
      }
    }

    function updateDiffTab() {
      const items = Object.values(checkItems);
      if (items.length === 0) {
        document.getElementById('noDiffData').style.display = 'block';
        document.getElementById('diffPanel').style.display = 'none';
        return;
      }

      document.getElementById('noDiffData').style.display = 'none';
      document.getElementById('diffPanel').style.display = 'block';

      const total = items.length;
      const match = items.filter(i => i.diff === 0).length;
      const over = items.filter(i => i.diff > 0).length;
      const under = items.filter(i => i.diff < 0).length;

      document.getElementById('diff-total').textContent = total;
      document.getElementById('diff-match').textContent = match;
      document.getElementById('diff-over').textContent = over;
      document.getElementById('diff-under').textContent = under;

      // å·®ç•°é‡‘é¡è¨ˆç®—
      let overAmount = 0, underAmount = 0;
      items.forEach(item => {
        const amount = (item.purchaseAmount || 0) * Math.abs(item.diff);
        if (item.diff > 0) overAmount += amount;
        else if (item.diff < 0) underAmount += amount;
      });

      document.getElementById('diff-over-amount').textContent = formatCurrency(overAmount);
      document.getElementById('diff-under-amount').textContent = formatCurrency(underAmount);

      // å·®ç•°è©³ç´°ï¼ˆå·®ç•°ã‚ã‚Šã®ã¿ï¼‰
      const diffItems = items.filter(i => i.diff !== 0).sort((a, b) => Math.abs(b.diff) - Math.abs(a.diff));
      const diffHtml = diffItems.length > 0 ? diffItems.map(item => {
        // INV-010: SKUå•†å“ã‹ã©ã†ã‹ã‚’è¡¨ç¤º
        const isSku = item.itemType === 'sku-based';
        const typeIcon = isSku ? 'ğŸ“¦' : 'ğŸ‘•';
        return `
          <div class="diff-item">
            <div class="item-info">
              <div class="item-name">${typeIcon} ${item.managementNumber || '-'}</div>
              <div class="item-meta">${item.productName || '-'}${item.skuId ? ` (${item.skuId})` : ''}</div>
            </div>
            <div class="diff-values">
              <div>å¸³ç°¿: ${item.bookQuantity} â†’ å®Ÿ: ${item.actualQuantity}</div>
              <span class="diff-badge ${item.diff > 0 ? 'over' : 'under'}">${item.diff > 0 ? '+' : ''}${item.diff}</span>
            </div>
          </div>
        `;
      }).join('') : '<div class="text-center text-muted py-3">å·®ç•°ãªã—ï¼ˆã™ã¹ã¦ä¸€è‡´ï¼‰</div>';
      document.getElementById('diffDetailList').innerHTML = diffHtml;
    }

    // QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼
    function startScanner() {
      document.getElementById('scanOverlay').classList.add('active');

      html5QrCode = new Html5Qrcode("qr-reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        onScanSuccess,
        onScanFailure
      ).catch(err => {
        console.error('ã‚¹ã‚­ãƒ£ãƒŠãƒ¼èµ·å‹•ã‚¨ãƒ©ãƒ¼:', err);
        alert('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
        stopScanner();
      });
    }

    function stopScanner() {
      document.getElementById('scanOverlay').classList.remove('active');
      if (html5QrCode) {
        html5QrCode.stop().catch(err => console.log('ã‚¹ã‚­ãƒ£ãƒŠãƒ¼åœæ­¢:', err));
        html5QrCode = null;
      }
    }

    function onScanSuccess(decodedText) {
      console.log('QRã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸ:', decodedText);
      stopScanner();

      let slot = null;
      let searchKey = decodedText;

      // 1. URLå½¢å¼ï¼ˆä»•å…¥QR: https://furira.jp/scan?inv=BATCH-XXXXï¼‰
      if (decodedText.includes('furira.jp/scan') || decodedText.includes('inv=')) {
        try {
          const url = new URL(decodedText);
          const invId = url.searchParams.get('inv');
          if (invId) {
            console.log('ä»•å…¥QRæ¤œå‡ºã€purchaseSlotsã§æ¤œç´¢:', invId);
            searchKey = invId;
            // purchaseSlotsã§ç›´æ¥æ¤œç´¢ï¼ˆID or slotIdï¼‰
            slot = allPurchaseSlots.find(s => s.id === invId || s.slotId === invId);
          }
        } catch (e) {
          console.log('URLè§£æå¤±æ•—ã€ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å‡¦ç†');
        }
      }

      // 2. JSONå½¢å¼ï¼ˆå•†å“QR: {"type":"product","managementNumber":"XX-XXXX"}ï¼‰
      if (!slot) {
        try {
          const qrData = JSON.parse(decodedText);
          if (qrData.managementNumber) {
            searchKey = qrData.managementNumber;
            slot = allPurchaseSlots.find(s => s.managementNumber === qrData.managementNumber);
          }
        } catch (e) {
          // JSONä»¥å¤–
        }
      }

      // 3. ç›´æ¥ãƒ†ã‚­ã‚¹ãƒˆï¼ˆç®¡ç†ç•ªå·ã€slotIdã€IDï¼‰
      if (!slot) {
        slot = allPurchaseSlots.find(s =>
          s.managementNumber === searchKey || 
          s.slotId === searchKey || 
          s.id === searchKey ||
          s.productId === searchKey
        );
      }

      if (slot) {
        selectSlot(slot.id);
      } else {
        alert('åœ¨åº«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ' + searchKey);
      }
    }

    function onScanFailure(error) {
      // ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—ã¯ç„¡è¦–ï¼ˆç¶™ç¶šã‚¹ã‚­ãƒ£ãƒ³ï¼‰
    }

    function searchProduct() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return;

      const slot = allPurchaseSlots.find(s =>
        s.managementNumber?.toLowerCase().includes(query.toLowerCase()) ||
        s.productName?.toLowerCase().includes(query.toLowerCase()) ||
        s.slotId?.toLowerCase().includes(query.toLowerCase()) ||
        s.brand?.toLowerCase().includes(query.toLowerCase())
      );

      if (slot) {
        selectSlot(slot.id);
        document.getElementById('searchInput').value = '';
      } else {
        alert('åœ¨åº«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }
    }

    // æ–°è¦æ£šå¸ä½œæˆ
    function openNewCheckModal() {
      new bootstrap.Modal(document.getElementById('newCheckModal')).show();
    }

    async function createNewCheck() {
      const name = document.getElementById('checkName').value.trim();
      const checkDate = document.getElementById('checkDate').value;

      if (!name) {
        alert('æ£šå¸åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      showLoading();
      try {
        const checkId = await StocktakingApi.createCheck({
          name,
          checkDate,
          method: document.getElementById('countMethod').value,
          targetProducts: document.getElementById('targetProducts').checked
        });

        bootstrap.Modal.getInstance(document.getElementById('newCheckModal')).hide();

        // ãƒªãƒ­ãƒ¼ãƒ‰
        await loadData();
        await selectCheck(checkId);

        alert('âœ… æ£šå¸ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
      } catch (error) {
        console.error('ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
        alert('æ£šå¸ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        hideLoading();
      }
    }

    // åœ¨åº«èª¿æ•´é©ç”¨
    async function applyAdjustment() {
      if (!activeCheck) return;

      const diffItems = Object.values(checkItems).filter(i => i.diff !== 0);
      if (diffItems.length === 0) {
        alert('èª¿æ•´ãŒå¿…è¦ãªå·®ç•°ã¯ã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      if (!confirm(`${diffItems.length}ä»¶ã®åœ¨åº«ã‚’èª¿æ•´ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
        return;
      }

      showLoading();
      try {
        // å„å•†å“ã®åœ¨åº«æ•°ã‚’æ›´æ–°
        for (const item of diffItems) {
          // INV-010: SKUå•†å“ã®å ´åˆã¯itemDataã‚’æ¸¡ã™
          await StocktakingApi.updateProductQuantity(
            item.productId || item.id,
            item.actualQuantity,
            { itemType: item.itemType, skuId: item.skuId }
          );
        }

        // æ£šå¸ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å®Œäº†ã«
        await StocktakingApi.updateCheck(activeCheck.id, {
          status: 'adjusted',
          completedAt: new Date(),
          diffCount: diffItems.length
        });

        alert('âœ… åœ¨åº«èª¿æ•´ãŒå®Œäº†ã—ã¾ã—ãŸ');

        // ãƒªãƒ­ãƒ¼ãƒ‰
        await loadData();
      } catch (error) {
        console.error('èª¿æ•´ã‚¨ãƒ©ãƒ¼:', error);
        alert('åœ¨åº«èª¿æ•´ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        hideLoading();
      }
    }

    // ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
    function exportDiffReport() {
      const items = Object.values(checkItems);
      const bom = '\uFEFF';
      let csv = `æ£šå¸ãƒ¬ãƒãƒ¼ãƒˆ - ${activeCheck?.name || 'æ£šå¸'}\n`;
      csv += `å®Ÿæ–½æ—¥: ${activeCheck?.checkDate || '-'}\n\n`;
      csv += 'ç®¡ç†ç•ªå·,å•†å“å,å¸³ç°¿åœ¨åº«,å®Ÿåœ¨åº«,å·®ç•°,å‚™è€ƒ\n';

      items.forEach(item => {
        csv += [
          item.managementNumber || '',
          `"${(item.productName || '').replace(/"/g, '""')}"`,
          item.bookQuantity,
          item.actualQuantity,
          item.diff,
          `"${(item.note || '').replace(/"/g, '""')}"`
        ].join(',') + '\n';
      });

      const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `æ£šå¸ãƒ¬ãƒãƒ¼ãƒˆ_${activeCheck?.checkDate || 'report'}.csv`;
      link.click();
    }

    function viewCheckReport(checkId) {
      // TODO: å®Œäº†ã—ãŸæ£šå¸ã®ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
      alert('ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤ºæ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™');
    }

    function goBack() {
      const isInIframe = window.self !== window.top;
      if (isInIframe) {
        window.top.postMessage({ type: 'goBack' }, '*');
      } else {
        window.location.href = '/menu_home.html';
      }
    }

    // ============================================
    // è¨­å®šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³
    // ============================================

    /**
     * è¨­å®šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‹é–‰
     */
    function toggleSettingsDropdown(event) {
      event.stopPropagation();
      const dropdown = document.getElementById('settingsDropdown');
      dropdown.classList.toggle('active');
    }

    /**
     * è¨­å®šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
     */
    function closeSettingsDropdown() {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown) {
        dropdown.classList.remove('active');
      }
    }

    /**
     * ãŠçŸ¥ã‚‰ã›ãƒšãƒ¼ã‚¸ã‚’é–‹ã
     */
    function openAnnouncePage() {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'navigate', page: 'announce' }, '*');
      } else {
        window.location.href = '/announce.html';
      }
    }

    // å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('settingsDropdown');
      if (dropdown && !event.target.closest('.settings-dropdown') && !event.target.closest('.minimal-header-icon')) {
        dropdown.classList.remove('active');
      }
    });

    // Enter ã‚­ãƒ¼ã§æ¤œç´¢
    document.getElementById('searchInput')?.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') searchProduct();
    });

    // ============================================
    // æœŸé–“ãƒ™ãƒ¼ã‚¹æ£šå¸æ©Ÿèƒ½
    // ============================================

    let activePeriod = null;          // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ£šå¸æœŸé–“
    let currentUserEmail = null;      // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«
    let currentUserName = null;       // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å
    let periodCheckItems = {};        // æœŸé–“æ£šå¸ã®ãƒã‚§ãƒƒã‚¯çµæœ
    let myStocktakingProducts = [];   // è‡ªåˆ†ã®æ‹…å½“å•†å“

    /**
     * æœŸé–“ãƒ™ãƒ¼ã‚¹æ£šå¸ã®åˆæœŸåŒ–
     */
    async function initializePeriodStocktaking() {
      console.log('[æœŸé–“æ£šå¸] åˆæœŸåŒ–é–‹å§‹...');

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
      const currentUser = firebase.auth().currentUser;
      if (!currentUser) {
        console.log('[æœŸé–“æ£šå¸] ãƒ¦ãƒ¼ã‚¶ãƒ¼æœªãƒ­ã‚°ã‚¤ãƒ³');
        return;
      }

      currentUserEmail = currentUser.email;

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
      try {
        const userDoc = await window.db.collection('users').doc(currentUserEmail).get();
        if (userDoc.exists) {
          currentUserName = userDoc.data().userName || currentUserEmail;
        }
      } catch (e) {
        console.log('[æœŸé–“æ£šå¸] ãƒ¦ãƒ¼ã‚¶ãƒ¼åå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
      }

      // StocktakingPeriodAPIãŒæº–å‚™ã§ãã‚‹ã¾ã§å¾…æ©Ÿ
      let waitCount = 0;
      while (!window.StocktakingPeriodAPI && waitCount < 50) {
        await new Promise(r => setTimeout(r, 100));
        waitCount++;
      }

      if (!window.StocktakingPeriodAPI) {
        console.log('[æœŸé–“æ£šå¸] StocktakingPeriodAPIæœªèª­ã¿è¾¼ã¿');
        return;
      }

      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæœŸé–“ã‚’å–å¾—
      try {
        activePeriod = await StocktakingPeriodAPI.getActiveStocktakingPeriod();

        if (activePeriod) {
          console.log('[æœŸé–“æ£šå¸] ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æœŸé–“ã‚ã‚Š:', activePeriod.name);
          await loadPeriodStocktakingData();
          showPeriodBanner();
        } else {
          console.log('[æœŸé–“æ£šå¸] ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æœŸé–“ãªã—');
          hidePeriodBanner();
        }
      } catch (error) {
        console.error('[æœŸé–“æ£šå¸] åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    /**
     * æœŸé–“æ£šå¸ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
     */
    async function loadPeriodStocktakingData() {
      if (!activePeriod || !currentUserEmail) return;

      try {
        // è‡ªåˆ†ã®ãƒã‚§ãƒƒã‚¯çµæœã‚’å–å¾—
        const results = await StocktakingPeriodAPI.getCheckResults(activePeriod.id, currentUserEmail);
        periodCheckItems = {};
        results.forEach(r => {
          periodCheckItems[r.slotId] = r;
        });

        // è‡ªåˆ†ã®é€²æ—ã‚’å–å¾—
        const progress = await StocktakingPeriodAPI.getStaffProgress(activePeriod.id, currentUserEmail);

        // ãƒãƒŠãƒ¼ã‚’æ›´æ–°
        if (progress) {
          updatePeriodBannerProgress(progress);
        }

        console.log('[æœŸé–“æ£šå¸] ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', Object.keys(periodCheckItems).length, 'ä»¶ãƒã‚§ãƒƒã‚¯æ¸ˆã¿');
      } catch (error) {
        console.error('[æœŸé–“æ£šå¸] ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    /**
     * æœŸé–“ãƒãƒŠãƒ¼ã‚’è¡¨ç¤º
     */
    function showPeriodBanner() {
      const banner = document.getElementById('periodBanner');
      if (!banner || !activePeriod) return;

      banner.style.display = 'block';
      document.getElementById('periodBannerName').textContent = activePeriod.name;

      const periodRange = StocktakingPeriodAPI.formatPeriodRange(activePeriod.startDate, activePeriod.endDate);
      const remainingDays = StocktakingPeriodAPI.getRemainingDays(activePeriod);
      document.getElementById('periodBannerInfo').textContent =
        `æœŸé–“: ${periodRange} | æ®‹ã‚Š: ${remainingDays > 0 ? remainingDays + 'æ—¥' : 'çµ‚äº†'}`;
    }

    /**
     * æœŸé–“ãƒãƒŠãƒ¼ã‚’éè¡¨ç¤º
     */
    function hidePeriodBanner() {
      const banner = document.getElementById('periodBanner');
      if (banner) {
        banner.style.display = 'none';
      }
    }

    /**
     * æœŸé–“ãƒãƒŠãƒ¼ã®é€²æ—ã‚’æ›´æ–°
     */
    function updatePeriodBannerProgress(progress) {
      const percent = StocktakingPeriodAPI.calculateProgress(
        progress.checkedProducts || 0,
        progress.totalProducts || 0
      );

      document.getElementById('periodBannerProgress').innerHTML = `
        <div style="font-size: 1.5rem; font-weight: 700;">${percent}%</div>
        <div style="font-size: 0.75rem; opacity: 0.9;">${progress.checkedProducts || 0}/${progress.totalProducts || 0}ä»¶</div>
      `;
      document.getElementById('periodProgressBar').style.width = `${percent}%`;
    }

    /**
     * æœŸé–“æ£šå¸ç”¨ã«ã‚«ã‚¦ãƒ³ãƒˆçµæœã‚’ä¿å­˜
     */
    async function savePeriodCount(slotId) {
      if (!activePeriod) {
        // æœŸé–“æ£šå¸ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ãªã„å ´åˆã¯é€šå¸¸ã®ä¿å­˜
        return false;
      }

      const actualQty = parseInt(document.getElementById('actualQtyInput').value);
      const note = document.getElementById('countNote').value;

      if (isNaN(actualQty) || actualQty < 0) {
        alert('å®Ÿåœ¨åº«æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return true; // å‡¦ç†æ¸ˆã¿
      }

      const slot = allPurchaseSlots.find(s => s.id === slotId);
      const bookQty = slot?.quantity || 1;

      showLoading();
      try {
        await StocktakingPeriodAPI.saveCheckResult(activePeriod.id, {
          slotId,
          productId: slot?.productId || '',
          managementNumber: slot?.managementNumber || '',
          productName: slot?.productName || '',
          staffName: currentUserName || currentUserEmail,
          bookQuantity: bookQty,
          actualQuantity: actualQty,
          note
        });

        // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°
        periodCheckItems[slotId] = {
          slotId,
          bookQuantity: bookQty,
          actualQuantity: actualQty,
          difference: actualQty - bookQty
        };

        clearCountInput();

        // é€²æ—ã‚’å†èª­ã¿è¾¼ã¿
        await loadPeriodStocktakingData();
        updateCountTab();

        // å®Œäº†ãƒã‚§ãƒƒã‚¯
        const progress = await StocktakingPeriodAPI.getStaffProgress(activePeriod.id, currentUserEmail);
        if (progress && progress.status === 'completed') {
          alert('å…¨å•†å“ã®ãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        }

      } catch (error) {
        console.error('[æœŸé–“æ£šå¸] ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        hideLoading();
      }

      return true; // å‡¦ç†æ¸ˆã¿
    }

    /**
     * æ‹…å½“è€…ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ãŸå•†å“ã‚’å–å¾—
     */
    function getMyAssignedSlots() {
      if (!currentUserEmail && !currentUserName) {
        return allPurchaseSlots;
      }

      return allPurchaseSlots.filter(slot => {
        // personEmail ã¾ãŸã¯ person ã§ãƒãƒƒãƒãƒ³ã‚°
        const personEmail = slot.personEmail || '';
        const person = slot.person || '';

        return personEmail === currentUserEmail ||
               person === currentUserEmail ||
               person === currentUserName;
      });
    }

    /**
     * æœŸé–“æ£šå¸ç”¨ã®ãƒã‚§ãƒƒã‚¯æ¸ˆã¿åˆ¤å®š
     */
    function isPeriodChecked(slotId) {
      return !!periodCheckItems[slotId];
    }

    // ã‚ªãƒªã‚¸ãƒŠãƒ«ã®saveCounté–¢æ•°ã‚’ãƒ©ãƒƒãƒ—
    const originalSaveCount = saveCount;
    saveCount = async function(slotId) {
      // æœŸé–“æ£šå¸ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ´åˆã¯æœŸé–“ç”¨ã®ä¿å­˜ã‚’ä½¿ç”¨
      if (activePeriod) {
        const handled = await savePeriodCount(slotId);
        if (handled) return;
      }
      // é€šå¸¸ã®ä¿å­˜
      await originalSaveCount(slotId);
    };

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: DOMContentLoadedã§ã‚‚åˆæœŸåŒ–ã‚’è©¦ã¿ã‚‹
    let initialized = false;
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸ“‹ [æ£šå¸] DOMContentLoaded');
      if (!initialized) {
        initialized = true;
        initializePage();
      }
    });

    // æ—¢ã«DOMãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if (document.readyState !== 'loading') {
      console.log('ğŸ“‹ [æ£šå¸] DOM already loaded, initializing...');
      if (!initialized) {
        initialized = true;
        initializePage();
      }
    }
  </script>
</body>
</html>
