<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base target="_top">
  <title>å ±é…¬ç®¡ç† - FURIRA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/reborn-theme.css?v=304">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    .content-container {
      padding: 16px;
      max-width: 1000px;
      margin: 0 auto;
    }

    /* ã‚¿ãƒ– */
    .nav-tabs-custom {
      background: white;
      border-radius: 12px;
      padding: 8px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .nav-tabs-custom .nav-link {
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      color: #6b7280;
      font-weight: 500;
    }
    .nav-tabs-custom .nav-link.active {
      background: #40B4E5;
      color: white;
    }

    /* ã‚«ãƒ¼ãƒ‰ */
    .card-section {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .card-section h6 {
      color: #374151;
      font-weight: 600;
      margin-bottom: 12px;
    }

    /* ã‚µãƒãƒªãƒ¼ã‚°ãƒªãƒƒãƒ‰ */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    .summary-card {
      background: white;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .summary-card.highlight {
      background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%);
      color: white;
    }
    .summary-card.highlight .summary-label { color: rgba(255,255,255,0.8); }
    .summary-card.highlight .summary-value { color: white; }
    .summary-label {
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .summary-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1f2937;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ« */
    .data-table {
      width: 100%;
      font-size: 0.875rem;
    }
    .data-table th {
      background: #f9fafb;
      padding: 12px 8px;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
      white-space: nowrap;
    }
    .data-table td {
      padding: 12px 8px;
      border-bottom: 1px solid #f3f4f6;
      vertical-align: middle;
    }
    .data-table tr:hover { background: #f9fafb; }

    /* ã‚¹ã‚¿ãƒƒãƒ•ã‚«ãƒ¼ãƒ‰ */
    .staff-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .staff-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    .staff-info {
      flex: 1;
    }
    .staff-name {
      font-weight: 600;
      color: #1f2937;
      font-size: 14px;
    }
    .staff-role {
      font-size: 12px;
      color: #6b7280;
    }
    .staff-stats {
      text-align: right;
    }
    .staff-amount {
      font-size: 18px;
      font-weight: 700;
      color: #40B4E5;
    }
    .staff-tasks {
      font-size: 12px;
      color: #6b7280;
    }

    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ */
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    .status-badge.unpaid {
      background: #fef3c7;
      color: #b45309;
    }
    .status-badge.paid {
      background: #dcfce7;
      color: #166534;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    /* æœŸé–“é¸æŠ */
    .period-selector {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 576px) {
      .summary-grid { grid-template-columns: repeat(2, 1fr); }
      .staff-card { flex-wrap: wrap; }
      .staff-stats { width: 100%; text-align: left; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb; }
    }
  </style>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>
  </div>

  <!-- çµ±ä¸€ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <div class="header-content">
      <button class="back-button" onclick="goBack()">
        <i class="bi bi-chevron-left"></i>
      </button>
      <div class="header-title">
        <i class="bi bi-wallet2"></i>
        å ±é…¬ç®¡ç†
      </div>
      <div class="header-actions">
        <button class="btn btn-sm btn-outline-primary me-1" onclick="openExportModal()" title="ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ">
          <i class="bi bi-download"></i>
        </button>
        <button class="menu-button" onclick="window.parent.postMessage({type:'toggleDrawer'}, '*')" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
          <i class="bi bi-list"></i>
        </button>
      </div>
    </div>
  </div>

  <div class="content-container">
    <!-- æœŸé–“é¸æŠ -->
    <div class="card-section">
      <div class="period-selector">
        <label class="form-label mb-0 small fw-bold">å¯¾è±¡æœŸé–“:</label>
        <select class="form-select form-select-sm" id="periodYear" style="width: auto;" onchange="loadCompensationData()">
          <!-- å‹•çš„ã«ç”Ÿæˆ -->
        </select>
        <select class="form-select form-select-sm" id="periodMonth" style="width: auto;" onchange="loadCompensationData()">
          <option value="all">å…¨æœˆ</option>
          <option value="1">1æœˆ</option>
          <option value="2">2æœˆ</option>
          <option value="3">3æœˆ</option>
          <option value="4">4æœˆ</option>
          <option value="5">5æœˆ</option>
          <option value="6">6æœˆ</option>
          <option value="7">7æœˆ</option>
          <option value="8">8æœˆ</option>
          <option value="9">9æœˆ</option>
          <option value="10">10æœˆ</option>
          <option value="11">11æœˆ</option>
          <option value="12">12æœˆ</option>
        </select>
        <span class="text-muted small" id="periodDisplay"></span>
      </div>
    </div>

    <!-- ã‚¿ãƒ– -->
    <ul class="nav nav-tabs-custom" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#summary-tab" type="button">
          ğŸ“Š ã‚µãƒãƒªãƒ¼
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#staff-tab" type="button">
          ğŸ‘¤ æ‹…å½“è€…åˆ¥
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#detail-tab" type="button">
          ğŸ“ æ˜ç´°
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#payment-tab" type="button">
          ğŸ’³ æ”¯æ‰•ç®¡ç†
        </button>
      </li>
    </ul>

    <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="tab-content">
      <!-- ã‚µãƒãƒªãƒ¼ã‚¿ãƒ– -->
      <div class="tab-pane fade show active" id="summary-tab" role="tabpanel">
        <!-- KPIã‚µãƒãƒªãƒ¼ -->
        <div class="summary-grid">
          <div class="summary-card highlight">
            <div class="summary-label">å ±é…¬ç·é¡</div>
            <div class="summary-value" id="kpi-total">Â¥0</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">æœªæ‰•ã„</div>
            <div class="summary-value" id="kpi-unpaid">Â¥0</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">æ”¯æ‰•æ¸ˆ</div>
            <div class="summary-value" id="kpi-paid">Â¥0</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">å¯¾è±¡ä»¶æ•°</div>
            <div class="summary-value" id="kpi-count">0ä»¶</div>
          </div>
        </div>

        <!-- ã‚¿ã‚¹ã‚¯ç¨®åˆ¥å†…è¨³ -->
        <div class="card-section">
          <h6><i class="bi bi-pie-chart"></i> ã‚¿ã‚¹ã‚¯ç¨®åˆ¥å†…è¨³</h6>
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ã‚¿ã‚¹ã‚¯</th>
                  <th class="text-end">ä»¶æ•°</th>
                  <th class="text-end">å˜ä¾¡</th>
                  <th class="text-end">é‡‘é¡</th>
                </tr>
              </thead>
              <tbody id="taskBreakdownBody">
                <tr><td colspan="4" class="text-center text-muted py-4">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- æœˆåˆ¥æ¨ç§» -->
        <div class="card-section">
          <h6><i class="bi bi-graph-up"></i> æœˆåˆ¥æ¨ç§»</h6>
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>æœˆ</th>
                  <th class="text-end">ä»¶æ•°</th>
                  <th class="text-end">å ±é…¬é¡</th>
                </tr>
              </thead>
              <tbody id="monthlyTrendBody">
                <tr><td colspan="3" class="text-center text-muted py-4">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- æ‹…å½“è€…åˆ¥ã‚¿ãƒ– -->
      <div class="tab-pane fade" id="staff-tab" role="tabpanel">
        <div id="staffList">
          <div class="text-center text-muted py-4">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
        </div>
      </div>

      <!-- æ˜ç´°ã‚¿ãƒ– -->
      <div class="tab-pane fade" id="detail-tab" role="tabpanel">
        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="card-section">
          <div class="row g-2">
            <div class="col-6 col-md-3">
              <select class="form-select form-select-sm" id="filterStaff" onchange="filterRecords()">
                <option value="">å…¨æ‹…å½“è€…</option>
              </select>
            </div>
            <div class="col-6 col-md-3">
              <select class="form-select form-select-sm" id="filterTask" onchange="filterRecords()">
                <option value="">å…¨ã‚¿ã‚¹ã‚¯</option>
                <option value="listing">å•†å“å‡ºå“</option>
                <option value="shipping">æ¢±åŒ…ãƒ»ç™ºé€</option>
                <option value="photography">å•†å“æ’®å½±</option>
                <option value="inspection">æ¤œå“ä½œæ¥­</option>
              </select>
            </div>
            <div class="col-6 col-md-3">
              <select class="form-select form-select-sm" id="filterStatus" onchange="filterRecords()">
                <option value="">å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                <option value="unpaid">æœªæ‰•ã„</option>
                <option value="paid">æ”¯æ‰•æ¸ˆ</option>
              </select>
            </div>
            <div class="col-6 col-md-3">
              <button class="btn btn-sm btn-outline-secondary w-100" onclick="resetFilters()">
                <i class="bi bi-x-circle"></i> ãƒªã‚»ãƒƒãƒˆ
              </button>
            </div>
          </div>
        </div>

        <!-- æ˜ç´°ãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div class="card-section">
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>æ—¥ä»˜</th>
                  <th>æ‹…å½“è€…</th>
                  <th>ã‚¿ã‚¹ã‚¯</th>
                  <th>å•†å“</th>
                  <th class="text-end">é‡‘é¡</th>
                  <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                </tr>
              </thead>
              <tbody id="detailBody">
                <tr><td colspan="6" class="text-center text-muted py-4">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- æ”¯æ‰•ç®¡ç†ã‚¿ãƒ– -->
      <div class="tab-pane fade" id="payment-tab" role="tabpanel">
        <!-- æ”¯æ‰•å‡¦ç† -->
        <div class="card-section">
          <h6><i class="bi bi-cash-stack"></i> æ”¯æ‰•å‡¦ç†</h6>
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label small">æ‹…å½“è€…</label>
              <select class="form-select form-select-sm" id="paymentStaff">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label small">æ”¯æ‰•æ—¥</label>
              <input type="date" class="form-control form-control-sm" id="paymentDate">
            </div>
            <div class="col-md-3">
              <label class="form-label small">æ”¯æ‰•é‡‘é¡</label>
              <div class="input-group input-group-sm">
                <span class="input-group-text">Â¥</span>
                <input type="number" class="form-control" id="paymentAmount" readonly>
              </div>
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button class="btn btn-primary btn-sm w-100" onclick="processPayment()">
                <i class="bi bi-check-circle"></i> æ”¯æ‰•å‡¦ç†
              </button>
            </div>
          </div>
        </div>

        <!-- æ”¯æ‰•å±¥æ­´ -->
        <div class="card-section">
          <h6><i class="bi bi-clock-history"></i> æ”¯æ‰•å±¥æ­´</h6>
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>æ”¯æ‰•æ—¥</th>
                  <th>æ‹…å½“è€…</th>
                  <th class="text-end">æ”¯æ‰•é¡</th>
                  <th>ä»¶æ•°</th>
                  <th>ãƒ¡ãƒ¢</th>
                </tr>
              </thead>
              <tbody id="paymentHistoryBody">
                <tr><td colspan="5" class="text-center text-muted py-4">æ”¯æ‰•å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "furira.jp",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // å ±é…¬è¨˜éŒ²ã‚’å–å¾—ï¼ˆcompensationRecords ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
    async function getCompensationRecords(year, month) {
      const recordsRef = collection(db, 'compensationRecords');
      const snapshot = await getDocs(recordsRef);
      const records = [];
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        records.push({ id: docSnap.id, ...data });
      });

      // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      return records.filter(r => {
        if (!r.completedAt && !r.recordedAt) return false;
        const dateStr = r.completedAt || r.recordedAt;
        const date = typeof dateStr === 'string' ? new Date(dateStr) : (dateStr.toDate ? dateStr.toDate() : new Date(dateStr));
        if (date.getFullYear() !== year) return false;
        if (month !== 'all' && (date.getMonth() + 1) !== parseInt(month)) return false;
        return true;
      });
    }

    // æ—§APIäº’æ›
    async function getTaskRecords(year, month) {
      return getCompensationRecords(year, month);
    }

    // æ”¯æ‰•è¨˜éŒ²ã‚’å–å¾—
    async function getPaymentRecords(year) {
      const paymentsRef = collection(db, 'compensationPayments');
      const snapshot = await getDocs(paymentsRef);
      const payments = [];
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        payments.push({ id: docSnap.id, ...data });
      });

      return payments.filter(p => {
        if (!p.paymentDate) return false;
        const date = new Date(p.paymentDate);
        return date.getFullYear() === year;
      });
    }

    // å•†å“ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ‹…å½“è€…åˆ¥ã‚¿ã‚¹ã‚¯æ•°ã‚’è¨ˆç®—
    async function getProductTaskCounts(year, month) {
      const productsRef = collection(db, 'products');
      const snapshot = await getDocs(productsRef);
      const products = [];
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        products.push({ id: docSnap.id, ...data });
      });

      // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const filtered = products.filter(p => {
        const date = p.createdAt?.toDate ? p.createdAt.toDate() : (p.createdAt ? new Date(p.createdAt) : null);
        if (!date) return false;
        if (date.getFullYear() !== year) return false;
        if (month !== 'all' && (date.getMonth() + 1) !== parseInt(month)) return false;
        return true;
      });

      // æ‹…å½“è€…åˆ¥ã«é›†è¨ˆ
      const staffStats = {};
      filtered.forEach(p => {
        const staff = p.assignedTo || p.createdBy || 'ä¸æ˜';
        if (!staffStats[staff]) {
          staffStats[staff] = { listing: 0, shipping: 0, photography: 0, inspection: 0 };
        }
        // å‡ºå“ã‚¿ã‚¹ã‚¯
        if (p.status === 'å‡ºå“ä¸­' || p.status === 'è²©å£²æ¸ˆã¿') {
          staffStats[staff].listing++;
        }
        // ç™ºé€ã‚¿ã‚¹ã‚¯
        if (p.status === 'è²©å£²æ¸ˆã¿' && p.shippingCompleted) {
          staffStats[staff].shipping++;
        }
      });

      return staffStats;
    }

    // å ±é…¬è¨­å®šã‚’å–å¾—
    function getCompensationSettings() {
      try {
        const config = JSON.parse(localStorage.getItem('config') || '{}');
        return config.å ±é…¬è¨­å®š || {
          taskRates: { listing: 100, shipping: 100, photography: 50, inspection: 30 },
          customTasks: [],
          options: { autoRecordListing: true, autoRecordShipping: true, cutoffDay: 'æœ«æ—¥', recordAsExpense: true }
        };
      } catch {
        return {
          taskRates: { listing: 100, shipping: 100, photography: 50, inspection: 30 },
          customTasks: [],
          options: {}
        };
      }
    }

    // æ”¯æ‰•å‡¦ç†
    async function savePayment(paymentData) {
      const paymentId = 'pay_' + Date.now();
      const paymentRef = doc(db, 'compensationPayments', paymentId);
      await setDoc(paymentRef, {
        ...paymentData,
        id: paymentId,
        createdAt: new Date().toISOString()
      });
      return paymentId;
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹
    window.CompensationApi = {
      getTaskRecords,
      getCompensationRecords,
      getPaymentRecords,
      getProductTaskCounts,
      getCompensationSettings,
      savePayment
    };

    console.log('âœ… [å ±é…¬ç®¡ç†] FirebaseåˆæœŸåŒ–å®Œäº†');

    window.addEventListener('load', () => {
      initializePage();
    });
  </script>

  <script>
    let currentRecords = [];
    let currentPayments = [];
    let currentStaffStats = {};
    let compensationSettings = {};

    function showLoading() { document.getElementById('loadingOverlay').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }

    function formatCurrency(amount) {
      if (amount === null || amount === undefined || isNaN(amount)) return 'Â¥0';
      return 'Â¥' + Math.round(amount).toLocaleString();
    }

    function formatDate(date) {
      if (!date) return '-';
      const d = date.toDate ? date.toDate() : new Date(date);
      return d.toLocaleDateString('ja-JP');
    }

    function goBack() {
      if (window.parent && window.parent !== window) {
        window.top.postMessage({ type: 'goBack' }, '*');
        console.log('[compensation] âœ… postMessageé€ä¿¡å®Œäº† (type: goBack)');
      } else {
        window.history.back();
      }
    }

    function initializePage() {
      // å¹´åº¦é¸æŠã‚’ç”Ÿæˆ
      const yearSelect = document.getElementById('periodYear');
      const thisYear = new Date().getFullYear();
      for (let y = thisYear; y >= thisYear - 3; y--) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y + 'å¹´';
        if (y === thisYear) opt.selected = true;
        yearSelect.appendChild(opt);
      }

      // ç¾åœ¨æœˆã‚’é¸æŠ
      const monthSelect = document.getElementById('periodMonth');
      const thisMonth = new Date().getMonth() + 1;
      monthSelect.value = thisMonth.toString();

      // æ”¯æ‰•æ—¥ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
      document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];

      // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      loadCompensationData();
    }

    async function loadCompensationData() {
      showLoading();

      try {
        const year = parseInt(document.getElementById('periodYear').value);
        const month = document.getElementById('periodMonth').value;

        // è¨­å®šã‚’å–å¾—
        compensationSettings = window.CompensationApi.getCompensationSettings();

        // å ±é…¬è¨˜éŒ²ã‚’å–å¾—ï¼ˆcompensationRecordsï¼‰
        currentRecords = await window.CompensationApi.getCompensationRecords(year, month);
        console.log('ğŸ“Š [å ±é…¬ç®¡ç†] å ±é…¬è¨˜éŒ²å–å¾—:', currentRecords.length, 'ä»¶');

        // å ±é…¬è¨˜éŒ²ã‹ã‚‰æ‹…å½“è€…åˆ¥çµ±è¨ˆã‚’è¨ˆç®—
        currentStaffStats = calculateStaffStatsFromRecords(currentRecords);

        // æ”¯æ‰•è¨˜éŒ²ã‚’å–å¾—
        currentPayments = await window.CompensationApi.getPaymentRecords(year);

        // è¡¨ç¤ºã‚’æ›´æ–°
        updatePeriodDisplay();
        renderSummary();
        renderStaffList();
        renderDetail();
        renderPaymentHistory();
        populateStaffSelects();

      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        hideLoading();
      }
    }

    // å ±é…¬è¨˜éŒ²ã‹ã‚‰æ‹…å½“è€…åˆ¥çµ±è¨ˆã‚’è¨ˆç®—
    function calculateStaffStatsFromRecords(records) {
      const staffStats = {};
      records.forEach(r => {
        const staffEmail = r.staffEmail || 'unknown';
        const staffName = r.staffName || staffEmail.split('@')[0] || 'ä¸æ˜';

        if (!staffStats[staffName]) {
          staffStats[staffName] = {
            email: staffEmail,
            listing: 0,
            shipping: 0,
            photography: 0,
            inspection: 0,
            totalAmount: 0,
            records: []
          };
        }

        // ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ã‚«ã‚¦ãƒ³ãƒˆ
        const taskType = r.taskTypeKey || r.taskType?.replace('_approval', '').replace('_task', '') || 'listing';
        if (staffStats[staffName][taskType] !== undefined) {
          staffStats[staffName][taskType]++;
        }

        // é‡‘é¡ã‚’åŠ ç®—
        staffStats[staffName].totalAmount += r.unitPrice || 0;
        staffStats[staffName].records.push(r);
      });

      return staffStats;
    }

    function updatePeriodDisplay() {
      const year = document.getElementById('periodYear').value;
      const month = document.getElementById('periodMonth').value;
      const display = document.getElementById('periodDisplay');

      if (month === 'all') {
        display.textContent = `${year}å¹´ å…¨æœŸé–“`;
      } else {
        display.textContent = `${year}å¹´${month}æœˆ`;
      }
    }

    function renderSummary() {
      const rates = compensationSettings.taskRates || { listing: 100, shipping: 100, photography: 50, inspection: 30 };

      let totalTasks = 0;
      let totalAmount = 0;
      const taskBreakdown = {
        listing: { count: 0, rate: rates.listing, amount: 0 },
        shipping: { count: 0, rate: rates.shipping, amount: 0 },
        photography: { count: 0, rate: rates.photography, amount: 0 },
        inspection: { count: 0, rate: rates.inspection, amount: 0 }
      };

      // å ±é…¬è¨˜éŒ²ã‹ã‚‰ç›´æ¥é›†è¨ˆ
      currentRecords.forEach(r => {
        const taskType = r.taskTypeKey || 'listing';
        if (taskBreakdown[taskType]) {
          taskBreakdown[taskType].count++;
          taskBreakdown[taskType].amount += r.unitPrice || rates[taskType] || 0;
          totalTasks++;
          totalAmount += r.unitPrice || rates[taskType] || 0;
        }
      });

      // æ”¯æ‰•æ¸ˆã¿é‡‘é¡ã‚’è¨ˆç®—
      const paidAmount = currentPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
      const unpaidAmount = Math.max(0, totalAmount - paidAmount);

      // KPIæ›´æ–°
      document.getElementById('kpi-total').textContent = formatCurrency(totalAmount);
      document.getElementById('kpi-unpaid').textContent = formatCurrency(unpaidAmount);
      document.getElementById('kpi-paid').textContent = formatCurrency(paidAmount);
      document.getElementById('kpi-count').textContent = totalTasks + 'ä»¶';

      // ã‚¿ã‚¹ã‚¯ç¨®åˆ¥å†…è¨³
      const taskNames = {
        listing: 'å•†å“å‡ºå“',
        shipping: 'æ¢±åŒ…ãƒ»ç™ºé€',
        photography: 'å•†å“æ’®å½±',
        inspection: 'æ¤œå“ä½œæ¥­'
      };

      let breakdownHtml = '';
      Object.entries(taskBreakdown).forEach(([task, data]) => {
        if (data.count > 0) {
          breakdownHtml += `
            <tr>
              <td>${taskNames[task]}</td>
              <td class="text-end">${data.count}ä»¶</td>
              <td class="text-end">${formatCurrency(data.rate)}</td>
              <td class="text-end fw-bold">${formatCurrency(data.amount)}</td>
            </tr>
          `;
        }
      });

      if (!breakdownHtml) {
        breakdownHtml = '<tr><td colspan="4" class="text-center text-muted py-4">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      } else {
        breakdownHtml += `
          <tr style="background: #f9fafb; font-weight: 600;">
            <td>åˆè¨ˆ</td>
            <td class="text-end">${totalTasks}ä»¶</td>
            <td class="text-end">-</td>
            <td class="text-end">${formatCurrency(totalAmount)}</td>
          </tr>
        `;
      }

      document.getElementById('taskBreakdownBody').innerHTML = breakdownHtml;
    }

    function renderStaffList() {
      const rates = compensationSettings.taskRates || { listing: 100, shipping: 100, photography: 50, inspection: 30 };
      const staffList = document.getElementById('staffList');

      if (Object.keys(currentStaffStats).length === 0) {
        staffList.innerHTML = '<div class="text-center text-muted py-4">å¯¾è±¡æœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      let html = '';
      Object.entries(currentStaffStats).forEach(([staffName, stats]) => {
        const totalTasks = stats.listing + stats.shipping + stats.photography + stats.inspection;
        const totalAmount = (stats.listing * rates.listing) +
                           (stats.shipping * rates.shipping) +
                           (stats.photography * rates.photography) +
                           (stats.inspection * rates.inspection);

        html += `
          <div class="staff-card">
            <div class="staff-avatar">ğŸ‘¤</div>
            <div class="staff-info">
              <div class="staff-name">${staffName}</div>
              <div class="staff-role">
                å‡ºå“: ${stats.listing}ä»¶ / ç™ºé€: ${stats.shipping}ä»¶
              </div>
            </div>
            <div class="staff-stats">
              <div class="staff-amount">${formatCurrency(totalAmount)}</div>
              <div class="staff-tasks">${totalTasks}ä»¶ã®ã‚¿ã‚¹ã‚¯</div>
            </div>
          </div>
        `;
      });

      staffList.innerHTML = html;
    }

    function renderDetail() {
      const taskNames = {
        listing: 'å•†å“å‡ºå“',
        shipping: 'æ¢±åŒ…ãƒ»ç™ºé€',
        photography: 'å•†å“æ’®å½±',
        inspection: 'æ¤œå“ä½œæ¥­',
        listing_approval: 'å‡ºå“ç¢ºèª',
        shipping_task: 'æ¢±åŒ…ãƒ»ç™ºé€'
      };

      // å ±é…¬è¨˜éŒ²ã‚’æ˜ç´°ã¨ã—ã¦è¡¨ç¤º
      let html = '';

      // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
      const sortedRecords = [...currentRecords].sort((a, b) => {
        const dateA = new Date(a.completedAt || a.recordedAt || 0);
        const dateB = new Date(b.completedAt || b.recordedAt || 0);
        return dateB - dateA;
      });

      sortedRecords.forEach(r => {
        const dateStr = r.completedAt || r.recordedAt;
        const date = dateStr ? new Date(dateStr) : null;
        const displayDate = date ? date.toLocaleDateString('ja-JP') : '-';
        const staffName = r.staffName || 'ä¸æ˜';
        const taskType = r.taskTypeKey || r.taskType || 'listing';
        const taskName = taskNames[taskType] || r.description || 'ã‚¿ã‚¹ã‚¯';
        const productInfo = r.managementNumber || '-';
        const amount = r.unitPrice || 0;
        const isPaid = r.paidAt ? true : false;

        html += `
          <tr>
            <td>${displayDate}</td>
            <td>${staffName}</td>
            <td>${taskName}</td>
            <td>${productInfo}</td>
            <td class="text-end">${formatCurrency(amount)}</td>
            <td><span class="status-badge ${isPaid ? 'paid' : 'unpaid'}">${isPaid ? 'æ”¯æ‰•æ¸ˆ' : 'æœªæ‰•ã„'}</span></td>
          </tr>
        `;
      });

      if (!html) {
        html = '<tr><td colspan="6" class="text-center text-muted py-4">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      }

      document.getElementById('detailBody').innerHTML = html;
    }

    function renderPaymentHistory() {
      const tbody = document.getElementById('paymentHistoryBody');

      if (currentPayments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">æ”¯æ‰•å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
      }

      let html = '';
      currentPayments.forEach(payment => {
        html += `
          <tr>
            <td>${formatDate(payment.paymentDate)}</td>
            <td>${payment.staffName || '-'}</td>
            <td class="text-end fw-bold">${formatCurrency(payment.amount)}</td>
            <td>${payment.taskCount || '-'}ä»¶</td>
            <td>${payment.memo || '-'}</td>
          </tr>
        `;
      });

      tbody.innerHTML = html;
    }

    function populateStaffSelects() {
      const staffNames = Object.keys(currentStaffStats);

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨
      const filterStaff = document.getElementById('filterStaff');
      filterStaff.innerHTML = '<option value="">å…¨æ‹…å½“è€…</option>';
      staffNames.forEach(name => {
        filterStaff.innerHTML += `<option value="${name}">${name}</option>`;
      });

      // æ”¯æ‰•ç”¨
      const paymentStaff = document.getElementById('paymentStaff');
      paymentStaff.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      staffNames.forEach(name => {
        paymentStaff.innerHTML += `<option value="${name}">${name}</option>`;
      });

      // æ”¯æ‰•æ‹…å½“è€…é¸æŠæ™‚ã«é‡‘é¡ã‚’è¨ˆç®—
      paymentStaff.addEventListener('change', function() {
        const rates = compensationSettings.taskRates || { listing: 100, shipping: 100, photography: 50, inspection: 30 };
        const stats = currentStaffStats[this.value];
        if (stats) {
          const amount = (stats.listing * rates.listing) +
                        (stats.shipping * rates.shipping) +
                        (stats.photography * rates.photography) +
                        (stats.inspection * rates.inspection);
          document.getElementById('paymentAmount').value = amount;
        } else {
          document.getElementById('paymentAmount').value = 0;
        }
      });
    }

    function filterRecords() {
      // ç°¡æ˜“ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆå®Ÿè£…ã¯æ˜ç´°ãƒ‡ãƒ¼ã‚¿ãŒå¢—ãˆã¦ã‹ã‚‰æ‹¡å¼µï¼‰
      renderDetail();
    }

    function resetFilters() {
      document.getElementById('filterStaff').value = '';
      document.getElementById('filterTask').value = '';
      document.getElementById('filterStatus').value = '';
      filterRecords();
    }

    async function processPayment() {
      const staffName = document.getElementById('paymentStaff').value;
      const paymentDate = document.getElementById('paymentDate').value;
      const amount = parseInt(document.getElementById('paymentAmount').value) || 0;

      if (!staffName) {
        alert('æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      if (amount <= 0) {
        alert('æ”¯æ‰•é‡‘é¡ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      if (!confirm(`${staffName}ã•ã‚“ã«${formatCurrency(amount)}ã‚’æ”¯æ‰•ã„æ¸ˆã¿ã¨ã—ã¦è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }

      showLoading();

      try {
        await window.CompensationApi.savePayment({
          staffName: staffName,
          paymentDate: paymentDate,
          amount: amount,
          taskCount: currentStaffStats[staffName] ?
            Object.values(currentStaffStats[staffName]).reduce((a, b) => a + b, 0) : 0,
          memo: ''
        });

        alert('æ”¯æ‰•å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ');
        loadCompensationData();

      } catch (error) {
        console.error('æ”¯æ‰•å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        alert('æ”¯æ‰•å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        hideLoading();
      }
    }

    function openExportModal() {
      // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
      alert('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™');
    }
  </script>
</body>
</html>
