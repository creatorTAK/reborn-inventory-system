# 複数プラットフォーム対応 設計ドキュメント

**作成日**: 2025-10-27
**ステータス**: 設計中
**対象Issue**: INV-003（予定）

---

## 📋 目的

REBORN Inventoryシステムを複数の販売プラットフォームに対応させるための設計を定義する。

**背景:**
- メルカリ単独依存のリスク（規制強化、アカウント制限）
- チーム運用の困難さ（通常メルカリのアカウント制限）
- SaaS化への展開（複数顧客×複数プラットフォーム）
- 販路拡大による事業成長

---

## 🎯 対象プラットフォーム

### Phase 1（現在）
- **メルカリ（手動出品）**
  - 現状: 手動コピー&ペースト
  - API: なし（企業向けのみ）
  - 優先度: 第1優先

### Phase 2（短期）
- **メルカリShops**
  - API連携: 可能（調査中）
  - 優先度: 第2優先
  - 状態: ショップ開設待ち

### Phase 3（中期）
- **ラクマ**（楽天）
- **Yahoo!フリマ**
- **BASE**（自社EC）
- **Shopify**（自社EC）

### Phase 4（長期）
- **Yahoo!オークション**
- **eBay**（越境EC）

---

## 🏗️ データ構造設計

### 現状の問題点

**現在のスプレッドシート構造:**
- 出品先: Y0, Y1（単一の値）
- ステータス: 登録済み、出品中、販売済み（どのプラットフォームか不明）
- 出品金額: 単一の値（プラットフォームごとに手数料が異なるが対応不可）

**問題:**
- 1商品を複数プラットフォームに出品できない
- プラットフォーム別の状態管理ができない
- プラットフォーム別の商品IDを保存できない
- 在庫同期ができない（1つ売れたら全プラットフォームで更新）

---

## 🔧 設計案

### 案A: プラットフォーム出品管理シート追加（推奨）

**メリット:**
- データ構造が明確
- 既存のスプレッドシートへの影響最小
- クエリが簡単
- 拡張性が高い

**デメリット:**
- シート数が増える
- JOIN的な処理が必要

#### データ構造

**商品マスタシート（既存）**
```
列A: 管理番号（AA-1001）
列B: ブランド
列C: 商品名
...
列X: 全体ステータス（登録済み、出品可能、全販売済み、取り下げ）
列Y: 画像URL配列（R2）
```

**プラットフォーム出品管理シート（新規）**
```
列A: 管理番号（AA-1001）
列B: プラットフォーム（メルカリ、メルカリShops、BASE、etc）
列C: 出品ステータス（未出品、出品準備中、出品中、販売済み、取り下げ）
列D: プラットフォーム商品ID（mercari_xxx、shops_yyy）
列E: 出品価格（プラットフォームごとに異なる可能性）
列F: 出品日時
列G: 販売日時
列H: プラットフォーム手数料率
列I: プラットフォーム利益（出品価格 - 仕入金額 - 手数料）
列J: 備考
```

**例:**
```
| 管理番号 | プラットフォーム | 出品ステータス | 商品ID | 出品価格 | 出品日時 | 販売日時 | 手数料率 | 利益 |
|---------|----------------|--------------|--------|---------|---------|---------|---------|------|
| AA-1001 | メルカリ        | 出品中        | merc_x | 5000    | 2025-10-27 |         | 10%     | 3500 |
| AA-1001 | メルカリShops  | 出品準備中     | shops_y | 5200    |         |         | 5%      | 3740 |
| AA-1001 | BASE           | 未出品        |        | 5500    |         |         | 3%      | 4035 |
| AA-1002 | メルカリ        | 販売済み      | merc_z | 8000    | 2025-10-26 | 2025-10-27 | 10%  | 6200 |
```

---

### 案B: JSON列追加

**メリット:**
- シート数を増やさない
- 実装が軽量

**デメリット:**
- JSONのパース処理が必要
- クエリが複雑
- スプレッドシート上での可視性が低い
- 拡張時の柔軟性が低い

#### データ構造

**商品マスタシート（既存）**
```
列A: 管理番号
...
列Z: プラットフォーム情報（JSON文字列）
```

**JSON例:**
```json
{
  "mercari": {
    "status": "出品中",
    "productId": "merc_xxx",
    "price": 5000,
    "listedAt": "2025-10-27",
    "soldAt": null
  },
  "mercari_shops": {
    "status": "出品準備中",
    "productId": "shops_yyy",
    "price": 5200,
    "listedAt": null,
    "soldAt": null
  }
}
```

---

## 📊 推奨設計: 案A（プラットフォーム出品管理シート）

理由:
- スプレッドシートの利点を活かせる（可視性、フィルタ、集計）
- 拡張性が高い（プラットフォーム追加が容易）
- 在庫管理画面でのクエリが明確
- API連携時のデータ取得が簡単

---

## 🔄 ステータス管理の設計

### 商品マスタの全体ステータス
```
- 登録済み: どこにも出品していない
- 出品可能: 商品情報完成、出品準備OK
- 一部出品中: 1つ以上のプラットフォームで出品中
- 全出品中: 登録した全プラットフォームで出品中
- 一部販売済み: 1つのプラットフォームで販売済み
- 全販売済み: 全プラットフォームで販売または取り下げ（在庫なし）
- 取り下げ: 全プラットフォームで取り下げ
```

### プラットフォーム別ステータス
```
- 未出品: このプラットフォームには出品していない
- 出品準備中: 出品情報作成中（下書き状態）
- 出品中: 出品完了、販売中
- 販売済み: このプラットフォームで販売完了
- 取り下げ: 出品を取り下げ
```

---

## 🔌 API連携設計

### API連携可能性調査（要確認）

| プラットフォーム | API提供 | 認証方式 | 主要機能 | 調査状況 |
|----------------|---------|---------|---------|---------|
| メルカリ | ❌ 企業向けのみ | - | - | 手動運用 |
| メルカリShops | ✅ 調査中 | OAuth? | 商品登録、在庫管理 | 未調査 |
| ラクマ | ❓ | - | - | 未調査 |
| Yahoo!フリマ | ❓ | - | - | 未調査 |
| BASE | ✅ あり | OAuth | 商品登録、在庫管理、注文管理 | 未調査 |
| Shopify | ✅ あり | OAuth | 商品登録、在庫管理、注文管理 | 未調査 |
| Yahoo!オークション | ❓ | - | - | 未調査 |
| eBay | ✅ あり | OAuth | 商品登録、在庫管理、注文管理 | 未調査 |

### API連携の基本フロー（例: メルカリShops）

```
1. 商品登録（REBORN Inventory）
   ↓
2. 「メルカリShopsに出品」ボタンクリック
   ↓
3. API呼び出し
   - 商品情報送信
   - 画像URL送信（R2から）
   ↓
4. メルカリShops商品ID取得
   ↓
5. プラットフォーム出品管理シートに記録
   - 商品ID: shops_xxx
   - ステータス: 出品中
   ↓
6. 在庫同期（Webhook or ポーリング）
   - 販売完了 → ステータス更新
   - 全プラットフォームで在庫数更新
```

---

## 🖼️ 画像管理の設計

### 現状
- R2に画像を保存
- スプレッドシートに画像URL配列を保存
- 商品マスタから参照

### プラットフォーム別画像対応

**問題:**
- プラットフォームごとに画像要件が異なる
  - メルカリ: 正方形推奨、10枚まで
  - メルカリShops: 正方形、20枚まで
  - BASE: 任意のアスペクト比、無制限？
  - eBay: 特定サイズ推奨、12枚まで

**解決策:**
- R2に原画像を保存（現状維持）
- API連携時にプラットフォーム要件に応じてリサイズ・変換
- または、プラットフォームごとの画像セットを事前生成

---

## 📱 UI/UX設計

### 在庫管理画面の拡張

**現在:**
```
商品カード
├─ 画像
├─ ステータスバッジ（登録済み、出品中、販売済み）
├─ 管理番号
├─ ブランド、商品名
├─ 出品: ¥5,000
└─ 利益: ¥3,500
```

**複数プラットフォーム対応後:**
```
商品カード
├─ 画像
├─ 全体ステータス（一部出品中、全出品中、販売済み）
├─ 管理番号
├─ ブランド、商品名
├─ プラットフォームステータス（横並び）
│   ├─ [メ] 出品中 ¥5,000
│   ├─ [Sh] 準備中 ¥5,200
│   └─ [+] 出品可能
└─ 総利益: ¥3,500
```

### 商品詳細モーダルの拡張

**追加セクション: プラットフォーム管理**
```
プラットフォーム管理
├─ メルカリ
│   ├─ ステータス: 出品中
│   ├─ 商品ID: merc_xxx
│   ├─ 出品価格: ¥5,000
│   ├─ 出品日: 2025-10-27
│   ├─ [メルカリで見る] [取り下げ] [編集]
│   └─ 利益: ¥3,500
├─ メルカリShops
│   ├─ ステータス: 未出品
│   ├─ 出品価格: ¥5,200（設定）
│   └─ [出品する]
├─ BASE
│   ├─ ステータス: 未出品
│   └─ [出品する]
└─ [+ プラットフォーム追加]
```

---

## 🚀 実装ロードマップ

### Phase 1: メルカリ手動運用完成（現在）
- [x] 商品登録機能
- [x] 在庫管理基本機能
- [x] コピー機能
- [ ] ステータス管理改善
- [ ] その他必要機能

### Phase 2: データ構造拡張
- [ ] プラットフォーム出品管理シート作成
- [ ] 商品マスタの全体ステータス追加
- [ ] マイグレーションスクリプト作成（既存データ移行）
- [ ] 在庫管理画面の拡張（プラットフォーム別表示）

### Phase 3: メルカリShops連携
- [ ] メルカリShops API調査
- [ ] OAuth認証実装
- [ ] 商品登録API連携
- [ ] 在庫同期（Webhook or ポーリング）
- [ ] テスト運用

### Phase 4: その他プラットフォーム連携
- [ ] BASE API連携
- [ ] Shopify API連携
- [ ] ラクマ、Yahoo!フリマ調査
- [ ] Yahoo!オークション、eBay調査

### Phase 5: SaaS化準備
- [ ] マルチテナント対応
- [ ] ユーザー管理
- [ ] 権限管理
- [ ] 課金システム

---

## ⚠️ 技術的課題と検討事項

### 1. 在庫同期の設計
**課題:** 1つのプラットフォームで販売された時、他のプラットフォームの在庫をどうするか？

**選択肢:**
- A. 全プラットフォームで取り下げ（在庫1個の場合）
- B. 在庫数管理（在庫2個なら、1つ売れても他は継続）
- C. 手動管理（ユーザーが判断）

**推奨:** Phase 2ではA（シンプル）、Phase 3以降でB（在庫数管理）

### 2. プラットフォーム別価格設定
**課題:** 手数料が異なるため、プラットフォームごとに価格を変えたい

**解決策:**
- プラットフォーム出品管理シートに「出品価格」列
- デフォルト価格を自動計算（手数料率を考慮）
- ユーザーが手動調整可能

### 3. 画像のプラットフォーム別対応
**課題:** プラットフォームごとに画像要件が異なる

**解決策:**
- R2に原画像を保存
- API連携時にプラットフォーム要件に応じて動的変換
- または、プラットフォーム別画像セットを事前生成

### 4. API認証情報の管理
**課題:** 複数プラットフォームのAPI認証情報をどこに保存するか？

**解決策:**
- Google Apps Scriptのプロパティサービス（暗号化推奨）
- 別途シークレット管理サービス（GCP Secret Manager等）

### 5. スプレッドシート vs データベース
**課題:** スプレッドシートで複数プラットフォーム管理は限界があるか？

**検討:**
- Phase 2-3: スプレッドシートで継続（コスト、シンプルさ）
- Phase 4-5: Cloud SQL/Firestore等への移行を検討

---

## 📝 次のアクション

1. **ユーザー確認**
   - この設計案の承認
   - 優先順位の再確認
   - Phase 2開始タイミングの決定

2. **Issue起票**
   - INV-003: プラットフォーム出品管理シート作成
   - INV-004: メルカリShops API調査
   - INV-005: 在庫管理画面のプラットフォーム別表示

3. **API調査開始**
   - メルカリShops API ドキュメント確認
   - BASE API ドキュメント確認
   - Shopify API ドキュメント確認

4. **メルカリ手動運用完成**
   - 残タスクの洗い出し
   - Phase 1完了

---

**最終更新**: 2025-10-27
**次回レビュー**: ユーザー確認後
