<!DOCTYPE html>
<html>
<head>
  <!-- ğŸ“Œ ãƒ•ãƒ©ãƒƒã‚·ãƒ¥é˜²æ­¢: subtab=usersã®å ´åˆã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤ºã«ã—ã¦ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå¾Œã«è¡¨ç¤º -->
  <script>
    (function() {
      if (new URLSearchParams(window.location.search).get('subtab') === 'users') {
        document.documentElement.classList.add('subtab-users-mode');
      }
    })();
  </script>
  <style>
    /* subtab=usersã®å ´åˆã€ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å…¨ä½“ã‚’éè¡¨ç¤ºï¼ˆã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå®Œäº†å¾Œã«JSã§è¡¨ç¤ºï¼‰ */
    html.subtab-users-mode #systemConfigTabContent {
      visibility: hidden;
    }
    /* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå®Œäº†å¾Œã«è¡¨ç¤ºã™ã‚‹ã‚¯ãƒ©ã‚¹ */
    html.subtab-users-mode.tab-ready #systemConfigTabContent {
      visibility: visible;
    }
  </style>

  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>è¨­å®š - Furira</title>

  <!-- PWAå¯¾å¿œ -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#000000">

  <!-- iOS PWAå¯¾å¿œ -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="ãƒ•ãƒªãƒ©">
  <link rel="apple-touch-icon" sizes="180x180" href="/icon-180.png">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- REBORN Brand Colors & Theme -->
  <link rel="stylesheet" href="https://www.reborn-inventory.com/css/reborn-brand-colors.css?v=0bd1a9b">
  <link rel="stylesheet" href="https://www.reborn-inventory.com/css/reborn-theme.css?v=0bd1a9b">

  <!-- Sortable.js - ã‚¿ãƒƒãƒå¯¾å¿œã®ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f8f9fa;
    }
    .config-container {
      padding: 16px;
    }
    .nav-tabs {
      margin-bottom: 0;
      flex-wrap: nowrap;
      overflow-x: auto;
      overflow-y: hidden;
      z-index: 100; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚ˆã‚Šä¸Šã€ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆz-index: 1000ï¼‰ã‚ˆã‚Šä¸‹ã«è¡¨ç¤º */
      border-bottom: none;
      background: #f8f9fa;
      padding: 8px 8px 0 8px;
      border-radius: 8px 8px 0 0;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
    }

    /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’ç´°ã */
    .nav-tabs::-webkit-scrollbar {
      height: 4px;
    }

    .nav-tabs::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 2px;
    }

    .nav-tabs::-webkit-scrollbar-track {
      background: #f7fafc;
    }
    .nav-tabs .nav-link {
      font-size: 13px;
      padding: 10px 16px;
      white-space: nowrap;
      border: 1px solid transparent;
      border-radius: 6px 6px 0 0;
      color: #6c757d;
      background: transparent;
      margin-right: 4px;
      transition: all 0.2s;
    }
    .nav-tabs .nav-link:hover {
      background: #e9ecef;
      color: #495057;
    }
    .nav-tabs .nav-link.active {
      color: #212529;
      background: white;
      border-color: #dee2e6 #dee2e6 white;
      font-weight: 600;
    }
    .tab-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #212529;
    }
    .form-label {
      font-weight: 500;
      font-size: 13px;
      color: #495057;
      margin-bottom: 4px;
    }
    .form-control, .form-select {
      font-size: 16px;  /* iOS Safari ã‚ºãƒ¼ãƒ é˜²æ­¢: 16pxä»¥ä¸Šå¿…é ˆ */
      border-radius: 6px;
      border: 1px solid #ced4da;
    }
    .form-control:focus, .form-select:focus {
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    .btn-group-sm .btn {
      font-size: 12px;
      padding: 4px 8px;
    }
    .save-btn {
      position: sticky;
      bottom: 0;
      background: white;
      padding: 12px 16px 32px 16px;
      border-top: 1px solid #dee2e6;
      margin: 0;
      z-index: 10;
    }
    .button-config-item {
      background: #f8f9fa;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 6px;
      border: 1px solid #e9ecef;
    }
    .button-config-item .form-label {
      margin-bottom: 6px;
    }
    .add-btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .add-btn:hover {
      background: #2563eb;
    }
    .remove-btn {
      font-size: 12px;
      padding: 2px 8px;
    }
    .discount-group {
      background: white;
      padding: 12px;
      margin-bottom: 16px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .discount-range-item {
      background: #f9fafb;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 4px;
      border: 1px solid #dee2e6;
    }
    .alert {
      font-size: 13px;
      padding: 10px 14px;
      margin-bottom: 16px;
    }
    .input-group-text {
      font-size: 13px;
    }
    .condition-group {
      margin-bottom: 24px;
    }
    .condition-group-title {
      font-size: 14px;
      font-weight: 600;
      color: #495057;
      margin-bottom: 12px;
      padding: 8px 12px;
      background: #e9ecef;
      border-radius: 6px;
    }

    /* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ */
    .switch input + span {
      background-color: #d1d5db; /* ã‚ªãƒ•: ã‚°ãƒ¬ãƒ¼ */
    }
    .switch input:checked + span {
      background-color: #3b82f6; /* ã‚ªãƒ³: é’ */
    }
    .switch input:checked + span:before {
      transform: translateX(20px);
    }
    .switch span:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    /* ã‚¹ãƒ”ãƒŠãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ã‚·ã‚¹ãƒ†ãƒ è¨­å®šå†…ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å¤–æ ã‚’å‰Šé™¤ï¼ˆä¸­èº«ã‚’åºƒã’ã‚‹ï¼‰ */
    #systemConfigTabContent {
      background: transparent;
      padding: 0;
      border-radius: 0;
      box-shadow: none;
    }

    /* å•†å“ç™»éŒ²è¨­å®šå†…ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å¤–æ ã‚’å‰Šé™¤ï¼ˆä¸­èº«ã‚’åºƒã’ã‚‹ï¼‰ */
    #productConfigTabContent {
      background: transparent;
      padding: 0;
      border-radius: 0;
      box-shadow: none;
    }

  </style>
</head>
<body>
  <script>
  // FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’GASãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ã‹ã‚‰å–å¾—ï¼ˆãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œï¼‰
  const fcmToken = '<!-- FCM Token will be set by JavaScript -->';
  console.log('ğŸ”‘ FCMãƒˆãƒ¼ã‚¯ãƒ³å–å¾— (GASãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ):', fcmToken ? fcmToken.substring(0, 20) + '...' : 'ãªã—');

  // ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã®Base64ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚ä¿å­˜ï¼ˆä¿å­˜ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰
  let pendingUserIconData = null;

  function navigateInPWA(url) {
    try {
      // iframeå†…ã«ã„ã‚‹å ´åˆã€æœ€ä¸Šä½ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«postMessageã§é€šçŸ¥
      if (window.top && window.top !== window.self) {
        console.log('ğŸ“¤ postMessageé€ä¿¡ (to window.top):', url);
        window.top.postMessage({
          type: 'navigate',
          url: url
        }, '*'); // GASã®ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹iframeã‹ã‚‰é€ä¿¡ã™ã‚‹ãŸã‚ã€ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
      } else {
        // iframeå¤–ï¼ˆé€šå¸¸ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼‰ã®å ´åˆ
        window.location.href = url;
      }
    } catch (e) {
      console.error('âŒ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:', e);
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: é€šå¸¸ã®é·ç§»
      window.location.href = url;
    }
  }
  </script>

  <!-- çµ±ä¸€ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <div class="header-content">
      <button class="back-button" id="back-button">
        <i class="bi bi-chevron-left"></i>
      </button>
      <div class="header-title" id="page-header-title">
        âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
      </div>
      <div style="width: 40px;"></div>
    </div>
  </div>

  <div class="config-container">
    <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="tab-content" id="configTabContent">

      <!-- å•†å“ç™»éŒ²è¨­å®š -->
      <div class="tab-pane fade" id="product" role="tabpanel">
        <!-- å•†å“ç™»éŒ²è¨­å®šå†…ã®æ¨ªã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <ul class="nav nav-tabs" id="productConfigTabs" role="tablist" style="margin-bottom: 16px; overflow-x: auto; flex-wrap: nowrap; white-space: nowrap;">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="product-salesword-tab" data-bs-toggle="tab" data-bs-target="#product-salesword" type="button" role="tab" style="font-size: 13px; padding: 8px 12px;">ğŸ’¬ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="product-condition-tab" data-bs-toggle="tab" data-bs-target="#product-condition" type="button" role="tab" style="font-size: 13px; padding: 8px 12px;">ğŸ”˜å•†å“çŠ¶æ…‹è¨­å®š</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="product-hashtag-tab" data-bs-toggle="tab" data-bs-target="#product-hashtag" type="button" role="tab" style="font-size: 13px; padding: 8px 12px;">ğŸ·ï¸ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°è¨­å®š</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="product-discount-tab" data-bs-toggle="tab" data-bs-target="#product-discount" type="button" role="tab" style="font-size: 13px; padding: 8px 12px;">ğŸ’°å‰²å¼•è¨­å®š</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="product-ai-tab" data-bs-toggle="tab" data-bs-target="#product-ai" type="button" role="tab" style="font-size: 13px; padding: 8px 12px;">âœ¨AIç”Ÿæˆè¨­å®š</button>
          </li>
        </ul>

        <!-- å•†å“ç™»éŒ²è¨­å®šå†…ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="tab-content" id="productConfigTabContent">
          <!-- ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰ -->
          <div class="tab-pane fade show active" id="product-salesword" role="tabpanel">
        <!-- å…¨ä½“èª¬æ˜ -->
        <div style="font-size: 12px; color: #374151; padding: 16px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 8px; border-left: 4px solid #3b82f6; margin-bottom: 24px; line-height: 1.6;">
          <div style="font-weight: 600; margin-bottom: 8px; font-size: 14px; color: #1e40af;">
            ğŸ’¡ ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã«ã¤ã„ã¦
          </div>
          <div>
            å•†å“ç™»éŒ²æ™‚ã«ä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®<strong>è¡¨ç¤ºå½¢å¼</strong>ã€<strong>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤</strong>ã€<strong>ã‚ˆãä½¿ã†ãƒ¯ãƒ¼ãƒ‰</strong>ã‚’è¨­å®šã§ãã¾ã™ã€‚<br>
            ä»¥ä¸‹ã®é †åºã§è¨­å®šã™ã‚‹ã¨åˆ†ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚
          </div>
        </div>

        <!-- 1ï¸âƒ£ è¡¨ç¤ºå½¢å¼è¨­å®šï¼ˆå…¨ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰å…±é€šï¼‰ -->
        <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 2px solid #e5e7eb;">
          <div style="font-weight: 600; margin-bottom: 8px; font-size: 15px; color: #374151;">
            1ï¸âƒ£ è¡¨ç¤ºå½¢å¼ï¼ˆå…¨ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰å…±é€šï¼‰
          </div>
          <div style="font-size: 12px; color: #6b7280; margin-bottom: 12px; line-height: 1.5;">
            ã€ã€‘ã‚„ã€ˆã€‰ç­‰ã€ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å‰å¾Œã«ä»˜ã‘ã‚‹è¨˜å·ã‚’è¨­å®šã—ã¾ã™
          </div>

          <!-- ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š -->
          <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <div style="font-weight: 600; margin-bottom: 12px; font-size: 14px;">ğŸ“Œ ã™ã¹ã¦ã®ãƒ¯ãƒ¼ãƒ‰ã«é©ç”¨</div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
              <div>
                <label style="font-size: 11px; margin-bottom: 4px; display: block;">å‰ã«ä»˜ã‘ã‚‹è¨˜å·</label>
                <select id="saleswordPrefixGlobalSelect" class="form-select form-select-sm" onchange="handlePrefixChange()">
                  <option value="">ãªã—</option>
                  <option value="ã€">ã€</option>
                  <option value="ã€">ã€</option>
                  <option value="ã€Œ">ã€Œ</option>
                  <option value="(">ï¼ˆ</option>
                  <option value="ï½œ">ï½œ</option>
                  <option value="â˜…">â˜…</option>
                  <option value="â˜†">â˜†</option>
                  <option value="â—†">â—†</option>
                  <option value="â—">â—</option>
                  <option value="â– ">â– </option>
                  <option value="â™¡">â™¡</option>
                  <option value="âœ¨">âœ¨</option>
                  <option value="â€»">â€»</option>
                  <option value="custom">ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›</option>
                </select>
                <input type="text" id="saleswordPrefixGlobalCustom" class="form-control form-control-sm" placeholder="è‡ªç”±ã«å…¥åŠ›" maxlength="5" style="margin-top: 4px; display: none;" oninput="updateSaleswordFormatPreview()">
              </div>
              <div>
                <label style="font-size: 11px; margin-bottom: 4px; display: block;">å¾Œã‚ã«ä»˜ã‘ã‚‹è¨˜å·</label>
                <select id="saleswordSuffixGlobalSelect" class="form-select form-select-sm" onchange="handleSuffixChange()">
                  <option value="">ãªã—</option>
                  <option value="ã€‘">ã€‘</option>
                  <option value="ã€">ã€</option>
                  <option value="ã€">ã€</option>
                  <option value=")">ï¼‰</option>
                  <option value="ï½œ">ï½œ</option>
                  <option value="!">ï¼</option>
                  <option value="â˜…">â˜…</option>
                  <option value="â˜†">â˜†</option>
                  <option value="â—†">â—†</option>
                  <option value="â—">â—</option>
                  <option value="â– ">â– </option>
                  <option value="â™¡">â™¡</option>
                  <option value="âœ¨">âœ¨</option>
                  <option value="â€»">â€»</option>
                  <option value="custom">ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›</option>
                </select>
                <input type="text" id="saleswordSuffixGlobalCustom" class="form-control form-control-sm" placeholder="è‡ªç”±ã«å…¥åŠ›" maxlength="5" style="margin-top: 4px; display: none;" oninput="updateSaleswordFormatPreview()">
              </div>
            </div>

            <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div style="background: white; padding: 8px 12px; border-radius: 4px; border: 1px solid #dee2e6;">
              <div style="font-size: 11px; color: #6c757d; margin-bottom: 4px;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</div>
              <div id="saleswordFormatPreview" style="font-size: 14px; color: #212529; font-weight: 500;">ã€ç¾å“ã€‘</div>
            </div>
          </div>

          <!-- ãƒ¯ãƒ¼ãƒ‰ã”ã¨ã«å€‹åˆ¥è¨­å®š -->
          <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #dee2e6;">
            <div style="font-weight: 600; margin-bottom: 12px; font-size: 14px;">
              ğŸ·ï¸ ãƒ¯ãƒ¼ãƒ‰ã”ã¨ã«å€‹åˆ¥è¨­å®š
            </div>

            <div style="font-size: 12px; color: #6c757d; margin-bottom: 12px;">
              ç‰¹å®šã®ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã ã‘ç•°ãªã‚‹å½¢å¼ã‚’ä½¿ã„ãŸã„å ´åˆã«è¨­å®šã—ã¾ã™ã€‚<br>
              ä¾‹ï¼šã€ŒåŒ¿åé…é€ã€ã ã‘â˜…ã§å›²ã‚€ã€ã€Œé€æ–™ç„¡æ–™ã€ã ã‘ã€ã€ã§å›²ã‚€ãªã©
            </div>

            <div id="wordOverrideList" style="margin-bottom: 12px;">
              <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ãƒ¯ãƒ¼ãƒ‰åˆ¥è¨­å®š -->
            </div>

            <button type="button" onclick="addWordOverride()" style="width: 100%; padding: 10px; background: #3b82f6; border: none; border-radius: 8px; color: white; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 8px; transition: all 0.2s;" onmouseover="this.style.background='#2563eb';" onmouseout="this.style.background='#3b82f6';">
              + ãƒ¯ãƒ¼ãƒ‰åˆ¥è¨­å®šã‚’è¿½åŠ 
            </button>

            <button type="button" onclick="clearAllSaleswordSettings()" style="width: 100%; padding: 10px; background: white; border: 2px solid #ef4444; border-radius: 8px; color: #ef4444; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 16px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
              ğŸ—‘ï¸ ã™ã¹ã¦ã‚¯ãƒªã‚¢
            </button>
          </div>
        </div>

        <!-- 2ï¸âƒ£ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¯ãƒ¼ãƒ‰ï¼ˆè‡ªå‹•å…¥åŠ›ï¼‰ -->
        <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 2px solid #e5e7eb;">
          <div style="font-weight: 600; margin-bottom: 8px; font-size: 15px; color: #374151;">
            2ï¸âƒ£ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¯ãƒ¼ãƒ‰ï¼ˆè‡ªå‹•å…¥åŠ›ï¼‰
          </div>
          <div style="font-size: 12px; color: #6b7280; margin-bottom: 12px; line-height: 1.5;">
            å•†å“ç™»éŒ²ã‚’é–‹ã„ãŸã¨ãã«è‡ªå‹•ã§å…¥åŠ›ã•ã‚Œã‚‹ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¾ã™
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div>
              <label style="font-size: 11px; margin-bottom: 4px; display: block; color: #6b7280;">ã‚«ãƒ†ã‚´ãƒª</label>
              <select id="defaultSaleswordCategory" class="form-select form-select-sm" onchange="updateDefaultSaleswordOptions()">
                <option value="">--é¸æŠ--</option>
              </select>
            </div>
            <div>
              <label style="font-size: 11px; margin-bottom: 4px; display: block; color: #6b7280;">ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
              <select id="defaultSalesword" class="form-select form-select-sm" disabled>
                <option value="">--é¸æŠ--</option>
              </select>
            </div>
          </div>
        </div>

        <!-- 3ï¸âƒ£ ã‚ˆãä½¿ã†ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚¯ã‚¤ãƒƒã‚¯é¸æŠï¼‰ -->
        <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 2px solid #e5e7eb;">
          <div style="font-weight: 600; margin-bottom: 8px; font-size: 15px; color: #374151;">
            3ï¸âƒ£ ã‚ˆãä½¿ã†ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚¯ã‚¤ãƒƒã‚¯é¸æŠï¼‰
          </div>
          <div style="font-size: 12px; color: #6b7280; margin-bottom: 12px; line-height: 1.5;">
            ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰ç´ æ—©ãé¸ã¹ã‚‹ãƒ¯ãƒ¼ãƒ‰ã‚’ã€Œã‚ˆãä½¿ã†ã€ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
            <div>
              <label style="font-size: 11px; margin-bottom: 4px; display: block; color: #6b7280;">ã‚«ãƒ†ã‚´ãƒª</label>
              <select id="saleswordCategorySelect" class="form-select form-select-sm" onchange="updateSaleswordOptions()">
                <option value="">--é¸æŠ--</option>
              </select>
            </div>
            <div>
              <label style="font-size: 11px; margin-bottom: 4px; display: block; color: #6b7280;">ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
              <select id="saleswordSelect" class="form-select form-select-sm" disabled>
                <option value="">--é¸æŠ--</option>
              </select>
            </div>
          </div>

          <button type="button" onclick="addSaleswordFromDropdown()" style="width: 100%; padding: 8px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#2563eb';" onmouseout="this.style.background='#3b82f6';">
            + è¿½åŠ 
          </button>
        </div>

        <!-- ç™»éŒ²æ¸ˆã¿ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ -->
        <div id="saleswordList" style="margin-bottom: 16px;">
          <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ç™»éŒ²æ¸ˆã¿ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ -->
        </div>
      </div>

          <!-- å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³ -->
          <div class="tab-pane fade" id="product-condition" role="tabpanel">
            <!-- ãƒ’ãƒ³ãƒˆ -->
            <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
              <div style="color: #3b82f6; font-weight: 600; margin-bottom: 4px;">
                <span>ğŸ’¡ æ¦‚è¦</span>
              </div>
              <div id="condition-overview-content" style="display: block; padding-left: 12px; margin-bottom: 8px;">
                å•†å“ç™»éŒ²æ™‚ã«ã€Œå•†å“çŠ¶æ…‹(è©³ç´°)ã€æ¬„ã¸ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§èª¬æ˜æ–‡ã‚’æŒ¿å…¥ã§ãã‚‹ãƒœã‚¿ãƒ³ã‚’è¨­å®šã§ãã¾ã™ã€‚6ã¤ã®å•†å“çŠ¶æ…‹ã‚«ãƒ†ã‚´ãƒªï¼ˆæ–°å“ãƒ»æœªä½¿ç”¨ã«è¿‘ã„ãƒ»ç›®ç«‹ã£ãŸå‚·ã‚„æ±šã‚Œãªã—ç­‰ï¼‰ã”ã¨ã«ã€ã‚ˆãä½¿ã†èª¬æ˜æ–‡ã‚’ãƒœã‚¿ãƒ³åŒ–ã—ã¦ç™»éŒ²ã§ãã¾ã™
              </div>
            </div>

            <div id="conditionButtonsContainer">
              <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </div>

            <!-- ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
            <button type="button" onclick="clearConditionButtons()" style="width: 100%; padding: 10px; background: white; border: 2px solid #ef4444; border-radius: 8px; color: #ef4444; font-size: 13px; font-weight: 600; cursor: pointer; margin-top: 16px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
              ğŸ—‘ï¸ ã™ã¹ã¦ã‚¯ãƒªã‚¢
            </button>
          </div>

          <!-- ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰ -->
          <div class="tab-pane fade" id="product-hashtag" role="tabpanel">
<!-- ãƒ’ãƒ³ãƒˆ -->
        <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
          <div style="color: #3b82f6; font-weight: 600; margin-bottom: 4px;">
            <span>ğŸ’¡ æ¦‚è¦</span>
          </div>
          <div id="hashtag-overview-content" style="display: block; padding-left: 12px; margin-bottom: 8px;">
            ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã¯å•†å“èª¬æ˜ã®æœ€å¾Œã«è‡ªå‹•ã§è¿½åŠ ã•ã‚Œã¾ã™ï¼ˆä¾‹: #REBORN_å…¨å•†å“ï¼‰ã€‚å…±é€šãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼ˆã‚·ãƒ§ãƒƒãƒ—åï¼‰ã®è¨­å®šã‚„ã€5ç¨®é¡ã®ã‚¿ã‚¤ãƒ—ï¼ˆå…¨å•†å“ã€ãƒ–ãƒ©ãƒ³ãƒ‰ã€ã‚«ãƒ†ã‚´ãƒªã€ã‚«ãƒ©ãƒ¼ã€ã‚µã‚¤ã‚ºï¼‰ã‹ã‚‰é¸æŠã—ã¦è¿½åŠ ã€ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§é †ç•ªã‚’ä¸¦ã³æ›¿ãˆã§ãã¾ã™
          </div>
        </div>

        <!-- å…±é€šãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹è¨­å®š -->
        <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
          <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
            <span style="font-size: 16px;">âš™ï¸</span>
            <label style="font-size: 13px; font-weight: 600; color: #374151;">
              å…±é€šè¨­å®š
            </label>
          </div>
          <div style="display: flex; align-items: stretch;">
            <span style="width: 32px; padding: 8px 0; border: 2px solid #d1d5db; border-right: none; border-radius: 6px 0 0 6px; background: #f9fafb; font-size: 14px; font-weight: 500; color: #374151; display: flex; align-items: center; justify-content: center;">#</span>
            <input type="text" id="commonHashtagPrefix" placeholder="ã‚·ãƒ§ãƒƒãƒ—å_" style="width: calc(100% - 32px); padding: 8px 10px; border: 2px solid #d1d5db; border-radius: 0 6px 6px 0; font-size: 16px; transition: all 0.2s; box-sizing: border-box;" onfocus="this.style.borderColor='#3b82f6';" onblur="this.style.borderColor='#d1d5db';" oninput="updateAllHashtagPreviews()">
          </div>
          <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">
            ğŸ’¡ ã‚·ãƒ§ãƒƒãƒ—åã‚„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: Shopã€‡ã€‡_ï¼‰
          </div>
        </div>

        <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°é …ç›® -->
        <div id="hashtagItemsContainer"></div>

        <!-- è¿½åŠ ãƒœã‚¿ãƒ³ -->
        <button type="button" onclick="showHashtagTypeSelector()" style="width: 100%; padding: 10px; background: #3b82f6; border: none; border-radius: 8px; color: white; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 8px; transition: all 0.2s;" onmouseover="this.style.background='#2563eb';" onmouseout="this.style.background='#3b82f6';">
          + ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’è¿½åŠ 
        </button>

        <!-- ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ -->
        <button type="button" onclick="clearAllHashtags()" style="width: 100%; padding: 10px; background: white; border: 2px solid #ef4444; border-radius: 8px; color: #ef4444; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 16px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
          ğŸ—‘ï¸ ã™ã¹ã¦ã‚¯ãƒªã‚¢
        </button>

        <!-- ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚¿ã‚¤ãƒ—é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <div id="hashtagTypeSelectorMenu" style="display: none; margin-bottom: 16px; padding: 12px; background: white; border: 2px solid #3b82f6; border-radius: 8px;">
          <div style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">è¿½åŠ ã™ã‚‹ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã®ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ:</div>
          <div style="display: flex; flex-direction: column; gap: 6px;">
            <button type="button" onclick="addHashtagItemByType('å…¨å•†å“')" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; transition: all 0.2s; text-align: left;" onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#3b82f6';" onmouseout="this.style.background='white'; this.style.borderColor='#d1d5db';">
              <span style="font-size: 18px;">ğŸŒ</span>
              <span style="font-size: 13px; font-weight: 500; color: #374151;">å…¨å•†å“</span>
            </button>
            <button type="button" onclick="addHashtagItemByType('ãƒ–ãƒ©ãƒ³ãƒ‰')" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; transition: all 0.2s; text-align: left;" onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#3b82f6';" onmouseout="this.style.background='white'; this.style.borderColor='#d1d5db';">
              <span style="font-size: 18px;">ğŸ‘”</span>
              <span style="font-size: 13px; font-weight: 500; color: #374151;">ãƒ–ãƒ©ãƒ³ãƒ‰</span>
            </button>
            <button type="button" onclick="addHashtagItemByType('ã‚«ãƒ†ã‚´ãƒª')" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; transition: all 0.2s; text-align: left;" onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#3b82f6';" onmouseout="this.style.background='white'; this.style.borderColor='#d1d5db';">
              <span style="font-size: 18px;">ğŸ“</span>
              <span style="font-size: 13px; font-weight: 500; color: #374151;">ã‚«ãƒ†ã‚´ãƒª</span>
            </button>
            <button type="button" onclick="addHashtagItemByType('ã‚«ãƒ©ãƒ¼')" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; transition: all 0.2s; text-align: left;" onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#3b82f6';" onmouseout="this.style.background='white'; this.style.borderColor='#d1d5db';">
              <span style="font-size: 18px;">ğŸ¨</span>
              <span style="font-size: 13px; font-weight: 500; color: #374151;">ã‚«ãƒ©ãƒ¼</span>
            </button>
            <button type="button" onclick="addHashtagItemByType('ã‚µã‚¤ã‚º')" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; transition: all 0.2s; text-align: left;" onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#3b82f6';" onmouseout="this.style.background='white'; this.style.borderColor='#d1d5db';">
              <span style="font-size: 18px;">ğŸ“</span>
              <span style="font-size: 13px; font-weight: 500; color: #374151;">ã‚µã‚¤ã‚º</span>
            </button>
            <button type="button" onclick="hideHashtagTypeSelector()" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 12px; color: #6b7280; margin-top: 4px;" onmouseover="this.style.background='#e5e7eb';" onmouseout="this.style.background='#f3f4f6';">
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
          </div>
        </div>
          </div>

          <!-- å‰²å¼•æƒ…å ±ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰ -->
          <div class="tab-pane fade" id="product-discount" role="tabpanel">
<!-- ãƒ’ãƒ³ãƒˆ -->
        <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
          <div style="color: #3b82f6; font-weight: 600; margin-bottom: 4px;">
            <span>ğŸ’¡ æ¦‚è¦</span>
          </div>
          <div id="discount-overview-content" style="display: block; padding-left: 12px; margin-bottom: 8px;">
            è¨­å®šã—ãŸå‰²å¼•æƒ…å ±ãŒå•†å“èª¬æ˜ã«è‡ªå‹•ã§è¿½åŠ ã•ã‚Œã¾ã™ã€‚3ç¨®é¡ã®å‰²å¼•ï¼ˆãƒ•ã‚©ãƒ­ãƒ¼å‰²ã€ãƒªãƒ”ãƒ¼ãƒˆå‰²ã€ã¾ã¨ã‚å‰²ï¼‰ã‚’è¨­å®šã§ãã€ãƒ•ã‚©ãƒ­ãƒ¼å‰²ãƒ»ã¾ã¨ã‚å‰²ã¯è¤‡æ•°ã®ä¾¡æ ¼å¸¯ãƒ»æ•°é‡ç¯„å›²ã‚’è¨­å®šå¯èƒ½ã€‚èª¬æ˜æ–‡ã‚‚è‡ªç”±ã«ç·¨é›†ã§ãã¾ã™
          </div>
        </div>

        <!-- ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š -->
        <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
          <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px; display: block;">
            ğŸ“Œ ã‚¿ã‚¤ãƒˆãƒ«
          </label>
          <select id="å‰²å¼•æƒ…å ±ã‚¿ã‚¤ãƒˆãƒ«é¸æŠ" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer; transition: all 0.2s; margin-bottom: 8px;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';" onchange="handleDiscountTitleChange()">
            <option value="ã€ãŠå¾—ãªå‰²å¼•æƒ…å ±ã€‘">ã€ãŠå¾—ãªå‰²å¼•æƒ…å ±ã€‘</option>
            <option value="ã€å‰²å¼•ã«ã¤ã„ã¦ã€‘">ã€å‰²å¼•ã«ã¤ã„ã¦ã€‘</option>
            <option value="ã€ãŠå€¤å¼•ãæƒ…å ±ã€‘">ã€ãŠå€¤å¼•ãæƒ…å ±ã€‘</option>
            <option value="ã€ç‰¹åˆ¥å‰²å¼•ã€‘">ã€ç‰¹åˆ¥å‰²å¼•ã€‘</option>
            <option value="ã€ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æƒ…å ±ã€‘">ã€ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æƒ…å ±ã€‘</option>
            <option value="">ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãªã—ï¼‰</option>
            <option value="custom">âœï¸ ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›</option>
          </select>
          <input type="text" id="å‰²å¼•æƒ…å ±ã‚¿ã‚¤ãƒˆãƒ«ã‚«ã‚¹ã‚¿ãƒ " placeholder="ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; display: none; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6';" onblur="this.style.borderColor='#d1d5db';" oninput="updateDiscountPreview()">
        </div>

        <!-- å‰²å¼•ã‚¿ã‚¤ãƒ—ãƒªã‚¹ãƒˆï¼ˆå‹•çš„ã«ç”Ÿæˆï¼‰ -->
        <div id="discountTypesList">
          <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
        </div>

        <!-- å‰²å¼•è¿½åŠ ãƒœã‚¿ãƒ³ -->
        <button type="button" onclick="addDiscountType()" style="width: 100%; margin-bottom: 16px; background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#2563eb';" onmouseout="this.style.background='#3b82f6';">+ å‰²å¼•ã‚’è¿½åŠ </button>

        <!-- ã™ã¹ã¦ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ -->
        <div style="text-align: center; margin-bottom: 16px;">
          <button type="button" onclick="clearAllDiscounts()" style="width: 100%; padding: 8px 16px; background: white; color: #ef4444; border: 2px solid #ef4444; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
            ğŸ—‘ï¸ ã™ã¹ã¦ã‚¯ãƒªã‚¢
          </button>
        </div>

        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px;">
          <div style="font-size: 11px; color: #6b7280; margin-bottom: 8px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
          <div id="discountPreview" style="padding: 6px 10px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 11px; color: #1e40af; font-weight: 500; white-space: pre-line; line-height: 1.6;">
            ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆä¸­...
          </div>
        </div>
          </div>

          <!-- AIç”Ÿæˆè¨­å®š -->
          <div class="tab-pane fade" id="product-ai" role="tabpanel">
        <!-- ãƒ’ãƒ³ãƒˆ -->
        <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
          <div style="color: #3b82f6; font-weight: 600; margin-bottom: 4px;">
            <span>ğŸ’¡ æ¦‚è¦</span>
          </div>
          <div id="ai-overview-content" style="display: block; padding-left: 12px; margin-bottom: 8px;">
            Gemini APIã‚’ä½¿ç”¨ã—ãŸå•†å“èª¬æ˜æ–‡ã®è‡ªå‹•ç”Ÿæˆè¨­å®šã§ã™ã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€ç”Ÿæˆæ–‡å­—æ•°ã€ãƒˆãƒ¼ãƒ³ã€å«ã‚ã‚‹æƒ…å ±ãªã©ã‚’ç´°ã‹ãã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™ã€‚ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰é¸ã‚“ã§ã€ã•ã‚‰ã«è‡ªåˆ†å¥½ã¿ã«èª¿æ•´ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™
          </div>
        </div>

        <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠ -->
        <div style="margin-bottom: 24px;">
          <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">
            ğŸ¨ ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰é¸ã¶
          </div>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
            <button type="button" onclick="applyAiPreset('casual')" style="padding: 10px; background: white; border: 2px solid #40B4E5; border-radius: 6px; color: #40B4E5; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f5f3ff';" onmouseout="this.style.background='white';">
              ğŸ˜Š ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«<br><span style="font-size: 10px; font-weight: 400;">ãƒ¡ãƒ«ã‚«ãƒªå‘ã‘</span>
            </button>
            <button type="button" onclick="applyAiPreset('standard')" style="padding: 10px; background: white; border: 2px solid #3b82f6; border-radius: 6px; color: #3b82f6; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#eff6ff';" onmouseout="this.style.background='white';">
              â­ ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰<br><span style="font-size: 10px; font-weight: 400;">â˜…æ¨å¥¨</span>
            </button>
            <button type="button" onclick="applyAiPreset('polite')" style="padding: 10px; background: white; border: 2px solid #40B4E5; border-radius: 6px; color: #40B4E5; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f5f3ff';" onmouseout="this.style.background='white';">
              ğŸ© ä¸å¯§<br><span style="font-size: 10px; font-weight: 400;">ãƒ“ã‚¸ãƒã‚¹å‘ã‘</span>
            </button>
            <button type="button" onclick="applyAiPreset('enthusiastic')" style="padding: 10px; background: white; border: 2px solid #f59e0b; border-radius: 6px; color: #f59e0b; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#fffbeb';" onmouseout="this.style.background='white';">
              ğŸ”¥ ç†±é‡é«˜ã‚<br><span style="font-size: 10px; font-weight: 400;">ãŠã™ã™ã‚å¼·èª¿</span>
            </button>
            <button type="button" onclick="applyAiPreset('concise')" style="padding: 10px; background: white; border: 2px solid #40B4E5; border-radius: 6px; color: #40B4E5; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f5f3ff';" onmouseout="this.style.background='white';">
              ğŸ“ ç°¡æ½”<br><span style="font-size: 10px; font-weight: 400;">çŸ­æ–‡</span>
            </button>
            <button type="button" onclick="applyAiPreset('detailed')" style="padding: 10px; background: white; border: 2px solid #40B4E5; border-radius: 6px; color: #40B4E5; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f5f3ff';" onmouseout="this.style.background='white';">
              ğŸ“– è©³ç´°<br><span style="font-size: 10px; font-weight: 400;">é•·æ–‡</span>
            </button>
          </div>
        </div>

        <!-- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ -->
        <div style="margin-bottom: 24px;">
          <label style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">
            ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
          </label>
          <textarea id="aiPromptTemplate" rows="8" style="width: 100%; padding: 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 12px; font-family: monospace; resize: vertical;" placeholder="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
          <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
            ğŸ’¡ å¤‰æ•°ãŒä½¿ãˆã¾ã™: {brand}, {item}, {category}, {size}, {condition}, {material}, {color}
          </div>
        </div>

        <!-- ç”Ÿæˆæ–‡å­—æ•° -->
        <div style="margin-bottom: 24px;">
          <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">
            ğŸ“ ç”Ÿæˆæ–‡å­—æ•°
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb';" onmouseout="this.style.background='white';">
              <input type="radio" name="aiLength" value="short" style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px; font-weight: 500;">çŸ­æ–‡ï¼ˆ150-200å­—ï¼‰</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb';" onmouseout="this.style.background='white';">
              <input type="radio" name="aiLength" value="medium" checked style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px; font-weight: 500;">æ¨™æº–ï¼ˆ200-300å­—ï¼‰â˜…æ¨å¥¨</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb';" onmouseout="this.style.background='white';">
              <input type="radio" name="aiLength" value="long" style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px; font-weight: 500;">é•·æ–‡ï¼ˆ300-500å­—ï¼‰</span>
            </label>
          </div>
        </div>

        <!-- ãƒˆãƒ¼ãƒ³/ã‚¹ã‚¿ã‚¤ãƒ« -->
        <div style="margin-bottom: 24px;">
          <label style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">
            ğŸ­ ãƒˆãƒ¼ãƒ³/ã‚¹ã‚¿ã‚¤ãƒ«
          </label>
          <select id="aiTone" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer;">
            <option value="casual">ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ï¼ˆãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ï¼‰</option>
            <option value="standard">ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ï¼ˆä¸å¯§ã§è¦ªã—ã¿ã‚„ã™ã„ï¼‰â˜…æ¨å¥¨</option>
            <option value="polite">ä¸å¯§ï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ©ã‚¤ã‚¯ï¼‰</option>
            <option value="enthusiastic">ç†±é‡é«˜ã‚ï¼ˆãŠã™ã™ã‚æ„Ÿå¼·ã‚ï¼‰</option>
          </select>
        </div>

        <!-- è¦‹å‡ºã—ã‚¹ã‚¿ã‚¤ãƒ« -->
        <div style="margin-bottom: 24px;">
          <label style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">
            ğŸ“‘ è¦‹å‡ºã—ã‚¹ã‚¿ã‚¤ãƒ«
          </label>
          <select id="aiHeadingStyle" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer;">
            <option value="emoji">çµµæ–‡å­—ï¼ˆä¾‹: âœ¨ å•†å“ã®ç‰¹å¾´ï¼‰</option>
            <option value="brackets">ã‹ã£ã“ï¼ˆä¾‹: ã€å•†å“ã®ç‰¹å¾´ã€‘ï¼‰</option>
            <option value="square">é»’å››è§’ï¼ˆä¾‹: â–  å•†å“ã®ç‰¹å¾´ï¼‰</option>
            <option value="none">ãªã—ï¼ˆæ”¹è¡Œã®ã¿ï¼‰</option>
          </select>
          <div style="font-size: 11px; color: #6b7280; margin-top: 4px; padding: 6px 8px; background: #eff6ff; border-radius: 4px; border-left: 3px solid #3b82f6;">
            ğŸ’¡ èª¬æ˜æ–‡å…¨ä½“ã§çµ±ä¸€ã•ã‚ŒãŸè¦‹å‡ºã—ã‚¹ã‚¿ã‚¤ãƒ«ãŒä½¿ã‚ã‚Œã¾ã™
          </div>
        </div>

        <!-- å«ã‚ã‚‹è¦ç´  -->
        <div style="margin-bottom: 24px;">
          <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">
            â˜‘ï¸ èª¬æ˜æ–‡ã«å«ã‚ã‚‹è¦ç´ 
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 12px; background: #f9fafb; border-radius: 6px; border: 2px solid #e5e7eb;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="aiIncludeBrand" checked style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px;">ãƒ–ãƒ©ãƒ³ãƒ‰æƒ…å ±</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="aiIncludeCategory" checked style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px;">ã‚«ãƒ†ã‚´ãƒªæƒ…å ±</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="aiIncludeSize" checked style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px;">ã‚µã‚¤ã‚ºæƒ…å ±</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="aiIncludeMaterial" checked style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px;">ç´ ææƒ…å ±</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="aiIncludeColor" checked style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px;">ã‚«ãƒ©ãƒ¼æƒ…å ±</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="aiIncludeAttributes" checked style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px;">å•†å“å±æ€§ â˜…é‡è¦</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="aiIncludeCondition" checked style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px;">å•†å“çŠ¶æ…‹</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="aiIncludeCoordinate" checked style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px;">ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ãƒˆææ¡ˆ</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="aiIncludeScene" checked style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px;">ç€ç”¨ã‚·ãƒ¼ãƒ³</span>
            </label>
          </div>
        </div>

        <!-- è©³ç´°è¨­å®š -->
        <div style="margin-bottom: 24px; padding: 16px; background: #fef3c7; border-radius: 8px; border: 2px solid #fde68a;">
          <div style="font-size: 14px; font-weight: 600; color: #92400e; margin-bottom: 16px;">
            ğŸ”§ è©³ç´°è¨­å®šï¼ˆä¸Šç´šè€…å‘ã‘ï¼‰
          </div>

          <!-- Temperature -->
          <div style="margin-bottom: 16px;">
            <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">
              ğŸŒ¡ï¸ Temperatureï¼ˆå‰µé€ æ€§ï¼‰: <span id="aiTempValue">0.7</span>
            </label>
            <input type="range" id="aiTemperature" min="0" max="10" value="7" step="1" oninput="updateTempDisplay()" style="width: 100%; cursor: pointer;">
            <div style="display: flex; justify-content: space-between; font-size: 10px; color: #6b7280; margin-top: 4px;">
              <span>0.0ï¼ˆå®‰å®šï¼‰</span>
              <span>0.5</span>
              <span>1.0ï¼ˆå‰µé€ çš„ï¼‰</span>
            </div>
            <div style="font-size: 11px; color: #6b7280; margin-top: 8px;">
              ğŸ’¡ 0.7å‰å¾ŒãŒæ¨å¥¨ã€‚ä½ã„ã¨å®‰å®šã€é«˜ã„ã¨å‰µé€ çš„ã ãŒä¸å®‰å®š
            </div>
          </div>

          <!-- Max Tokens -->
          <div>
            <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">
              ğŸ“Š Max Tokensï¼ˆæœ€å¤§å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³æ•°ï¼‰
            </label>
            <input type="number" id="aiMaxTokens" value="500" min="100" max="2000" step="50" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px;">
            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
              ğŸ’¡ é€šå¸¸ã¯500ã§ååˆ†ã€‚é•·æ–‡ã«ã™ã‚‹å ´åˆã¯800ã€œ1000ã«è¨­å®š
            </div>
          </div>
        </div>

        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
        <div style="margin-bottom: 16px;">
          <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">
            ğŸ‘€ è¨­å®šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
          </div>
          <div id="aiConfigPreview" style="padding: 16px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 12px; color: #374151; line-height: 1.8; white-space: pre-wrap; min-height: 100px;">
            ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é¸æŠã¾ãŸã¯è¨­å®šã‚’å¤‰æ›´ã™ã‚‹ã¨ã€ã“ã“ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
          </div>
        </div>

        <!-- é…ç½®é †åºè¨­å®š -->
        <div style="margin-bottom: 24px; padding: 16px; background: #f0f9ff; border-radius: 8px; border: 2px solid #bae6fd;">
          <div style="font-size: 14px; font-weight: 600; color: #0c4a6e; margin-bottom: 16px;">
            ğŸ“ å•†å“èª¬æ˜ã®é…ç½®é †åº
          </div>

          <div style="font-size: 11px; color: #6b7280; margin-bottom: 12px; padding: 8px; background: white; border-radius: 4px;">
            ğŸ’¡ ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§é †åºã‚’å¤‰æ›´ã§ãã¾ã™ã€‚ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ã¨éè¡¨ç¤ºã«ãªã‚Šã¾ã™ã€‚
          </div>

          <div id="descriptionOrderList" style="display: flex; flex-direction: column; gap: 8px;">
            <!-- å‹•çš„ã«ç”Ÿæˆ -->
          </div>

          <!-- é…ç½®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
          <div style="margin-top: 16px;">
            <div style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">
              ğŸ‘ï¸ é…ç½®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            </div>
            <div id="descriptionOrderPreview" style="padding: 12px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 11px; color: #6b7280; min-height: 60px; line-height: 1.6;">
              é †åºãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
            </div>
          </div>

          <!-- ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
          <button type="button" onclick="resetDescriptionOrder()" style="width: 100%; padding: 8px; margin-top: 12px; background: white; border: 2px solid #3b82f6; border-radius: 6px; color: #3b82f6; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#eff6ff';" onmouseout="this.style.background='white';">
            â†» ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé †åºã«æˆ»ã™
          </button>
        </div>

        <!-- ã™ã¹ã¦ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ -->
        <button type="button" onclick="clearAiSettings()" style="width: 100%; padding: 10px; background: white; border: 2px solid #ef4444; border-radius: 8px; color: #ef4444; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 16px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
          ğŸ—‘ï¸ ã™ã¹ã¦ã‚¯ãƒªã‚¢ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™ï¼‰
        </button>
          </div>
        </div>
      </div>

      <!-- ã‚·ã‚¹ãƒ†ãƒ è¨­å®š -->
      <div class="tab-pane fade show active" id="system" role="tabpanel">
        <!-- ã‚·ã‚¹ãƒ†ãƒ è¨­å®šå†…ã®æ¨ªã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <ul class="nav nav-tabs" id="systemConfigTabs" role="tablist" style="margin-bottom: 16px; overflow-x: auto; flex-wrap: nowrap; white-space: nowrap;">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="system-basic-tab" data-bs-toggle="tab" data-bs-target="#system-basic" type="button" role="tab" style="font-size: 13px; padding: 8px 12px;">âš™ï¸ åŸºæœ¬è¨­å®š</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="system-management-tab" data-bs-toggle="tab" data-bs-target="#system-management" type="button" role="tab" style="font-size: 13px; padding: 8px 12px;">ğŸ”¢ç®¡ç†ç•ªå·è¨­å®š</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="system-shipping-tab" data-bs-toggle="tab" data-bs-target="#system-shipping" type="button" role="tab" style="font-size: 13px; padding: 8px 12px;">ğŸ“¦é…é€è¨­å®š</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="system-procure-tab" data-bs-toggle="tab" data-bs-target="#system-procure" type="button" role="tab" style="font-size: 13px; padding: 8px 12px;">ğŸ’¼ä»•å…¥ãƒ»å‡ºå“è¨­å®š</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="system-permission-tab" data-bs-toggle="tab" data-bs-target="#system-permission" type="button" role="tab" style="font-size: 13px; padding: 8px 12px;">ğŸ”æ¨©é™è¨­å®š</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="system-users-tab" data-bs-toggle="tab" data-bs-target="#system-users" type="button" role="tab" style="font-size: 13px; padding: 8px 12px;">ğŸ‘¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="system-platform-tab" data-bs-toggle="tab" data-bs-target="#system-platform" type="button" role="tab" style="font-size: 13px; padding: 8px 12px;">ğŸŒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </button>
          </li>
        </ul>

        <!-- ã‚·ã‚¹ãƒ†ãƒ è¨­å®šå†…ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="tab-content" id="systemConfigTabContent">
          <!-- åŸºæœ¬è¨­å®šã‚¿ãƒ– -->
          <div class="tab-pane fade show active" id="system-basic" role="tabpanel">
        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
        <div id="basicSettingsLoading" style="display: flex; justify-content: center; align-items: center; padding: 40px;">
          <div style="text-align: center;">
            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f4f6; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
            <div style="margin-top: 12px; color: #6b7280; font-size: 14px;">èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
        </div>

        <!-- åŸºæœ¬è¨­å®šã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆåˆæœŸéè¡¨ç¤ºï¼‰ -->
        <div id="basicSettingsContent" style="display: none;">

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h4>

          <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ -->
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³</label>
            <div style="display: flex; align-items: center; gap: 12px;">
              <div id="basicUserIconPreview" style="width: 60px; height: 60px; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #9ca3af; border: 2px solid #e5e7eb;">
                ğŸ‘¤
              </div>
              <div style="flex: 1;">
                <input type="file" id="basicUserIconInput" accept="image/*" style="display: none;">
                <button type="button" class="btn btn-sm" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px;" onclick="document.getElementById('basicUserIconInput').click();">
                  ç”»åƒã‚’é¸æŠ
                </button>
                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
                  æ¨å¥¨: æ­£æ–¹å½¢ã€æœ€å¤§2MB
                </div>
              </div>
            </div>
          </div>

          <!-- æ¨©é™ -->
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">æ¨©é™</label>
            <div id="basicUserPermissionBadge" style="padding: 8px 0;"></div>
            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
              æ¨©é™ã¯ç®¡ç†è€…ã®ã¿å¤‰æ›´ã§ãã¾ã™
            </div>
          </div>

          <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼å -->
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼å<span style="color: #ef4444; margin-left: 4px;">*</span></label>
            <div style="position: relative;">
              <input type="text" id="basicUserName" class="form-control" placeholder="ä¾‹: å±±ç”°å¤ªéƒ" maxlength="50" style="padding-right: 40px;">
              <button type="button" id="clearUserNameBtn" onclick="clearUserName()" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #9ca3af; cursor: pointer; padding: 4px 8px; font-size: 16px; display: none;">âœ•</button>
            </div>
            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
              å…¥å‡ºåº«å±¥æ­´ã‚„å•†å“ç™»éŒ²æ™‚ã«è¨˜éŒ²ã•ã‚Œã¾ã™
            </div>
          </div>

          <!-- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ -->
          <div class="form-group">
            <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
            <input type="email" id="basicUserEmail" class="form-control" placeholder="ä¾‹: example@example.com" maxlength="100" readonly style="background: #f9fafb; cursor: not-allowed;">
            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
              Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆå¤‰æ›´ä¸å¯ï¼‰
            </div>
          </div>
        </div>

        <!-- é€šçŸ¥è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">ğŸ”” é€šçŸ¥è¨­å®š</h4>

          <!-- ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ -->
          <div style="margin-bottom: 12px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
              <div>
                <div style="font-weight: 500; font-size: 13px; color: #374151;">ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥</div>
                <div style="font-size: 11px; color: #6b7280; margin-top: 2px;">ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ã‚’å—ã‘å–ã‚‹</div>
              </div>
              <label class="switch" style="position: relative; display: inline-block; width: 44px; height: 24px;">
                <input type="checkbox" id="basicNotificationEnabled" style="opacity: 0; width: 0; height: 0;">
                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; transition: .4s; border-radius: 24px;"></span>
              </label>
            </div>
          </div>

          <!-- é€šçŸ¥éŸ³ -->
          <div style="margin-bottom: 12px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
              <div>
                <div style="font-weight: 500; font-size: 13px; color: #374151;">é€šçŸ¥éŸ³</div>
                <div style="font-size: 11px; color: #6b7280; margin-top: 2px;">é€šçŸ¥æ™‚ã«éŸ³ã‚’é³´ã‚‰ã™</div>
              </div>
              <label class="switch" style="position: relative; display: inline-block; width: 44px; height: 24px;">
                <input type="checkbox" id="basicNotificationSound" style="opacity: 0; width: 0; height: 0;">
                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; transition: .4s; border-radius: 24px;"></span>
              </label>
            </div>
          </div>
        </div>

        <!-- ç”»åƒç®¡ç†è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">ğŸ“· ç”»åƒç®¡ç†è¨­å®š</h4>

          <!-- ãƒ’ãƒ³ãƒˆ -->
          <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
            <div style="color: #3b82f6; font-weight: 600; margin-bottom: 4px;">
              <span>ğŸ’¡ æ¦‚è¦</span>
            </div>
            <div id="image-overview-content" style="display: block; padding-left: 12px; margin-bottom: 8px;">
              å•†å“ç”»åƒã®ç®¡ç†æ–¹æ³•ã‚’è¨­å®šã—ã¾ã™ã€‚ãƒãƒ¼ãƒ åˆ©ç”¨ã‚„APIé€£æºã‚’è¡Œã†å ´åˆã¯ã€å•†å“ç”»åƒã‚’Google Driveã«ä¿å­˜ã™ã‚‹ã“ã¨ã§ã€æ’®å½±è€…ã¨å‡ºå“è€…ã§ç”»åƒã‚’å…±æœ‰ã—ãŸã‚Šã€è¤‡æ•°ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«åŒã˜ç”»åƒã‚’ä½¿ã„å›ã™ã“ã¨ãŒã§ãã¾ã™
            </div>
          </div>

          <!-- å•†å“ç”»åƒä¿å­˜è¨­å®š -->
          <div style="background: white; padding: 16px; border-radius: 8px; border: 2px solid #e5e7eb;">
            <label style="display: flex; align-items: center; cursor: pointer; user-select: none;">
              <input
                type="checkbox"
                id="enableProductImageSave"
                onchange="toggleProductImageSave()"
                style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;"
              />
              <div style="flex: 1;">
                <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 4px;">
                  å•†å“ç”»åƒã‚’Google Driveã«ä¿å­˜ã™ã‚‹
                </div>
                <div style="font-size: 11px; color: #6b7280; line-height: 1.5;">
                  ONã«ã™ã‚‹ã¨å•†å“ç™»éŒ²ç”»é¢ã«ã€Œå•†å“ç”»åƒã€ãƒ–ãƒ­ãƒƒã‚¯ãŒè¡¨ç¤ºã•ã‚Œã€<br>
                  æœ€å¤§20æšã®ç”»åƒã‚’Google Driveã«ä¿å­˜ã§ãã¾ã™
                </div>
              </div>
            </label>
          </div>

          <!-- ç¾åœ¨ã®çŠ¶æ…‹è¡¨ç¤º -->
          <div id="imageSettingStatus" style="margin-top: 12px; padding: 12px; border-radius: 6px; background: #f9fafb; border-left: 3px solid #9ca3af;">
            <div style="font-size: 12px; color: #6b7280;">
              <strong>ç¾åœ¨ã®è¨­å®š:</strong> <span id="imageSettingStatusText">OFFï¼ˆå•†å“ç”»åƒãƒ–ãƒ­ãƒƒã‚¯ã¯éè¡¨ç¤ºï¼‰</span>
            </div>
          </div>
        </div>
        </div><!-- /basicSettingsContent -->
          </div>

          <!-- ç®¡ç†ç•ªå·ã‚¿ãƒ– -->
          <div class="tab-pane fade" id="system-management" role="tabpanel">
        <!-- å‹•çš„ãƒ–ãƒ­ãƒƒã‚¯ãƒ“ãƒ«ãƒ€ãƒ¼ï¼ˆPWAå¯¾å¿œï¼šç›´æ¥åŸ‹ã‚è¾¼ã¿ï¼‰ -->
        <!-- ç®¡ç†ç•ªå·ãƒ“ãƒ«ãƒ€ãƒ¼ - ãƒ¬ã‚´ãƒ–ãƒ­ãƒƒã‚¯å¼ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ§‹ç¯‰ã‚·ã‚¹ãƒ†ãƒ  -->
<style>
  .mnb-container {
    padding: 0;
    background: white;
    border-radius: 8px;
  }

  .mnb-title {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 16px;
    color: #212529;
  }

  /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆ */
  .mnb-segments {
    background: white;
    border: none;
    border-radius: 8px;
    padding: 0;
    min-height: 100px;
    margin-bottom: 16px;
  }

  .mnb-segments.drag-over {
    background: #e3f2fd;
    border-color: #2196f3;
  }

  .mnb-segments-empty {
    text-align: center;
    color: #9ca3af;
    padding: 24px 16px;
    font-size: 13px;
    line-height: 1.6;
  }

  /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒ–ãƒ­ãƒƒã‚¯ */
  .mnb-segment {
    background: white;
    border: 1px solid #e5e7eb;
    color: #1f2937;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: move;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    transition: all 0.2s;
  }

  .mnb-segment:hover {
    border-color: #3b82f6;
    box-shadow: 0 2px 6px rgba(59,130,246,0.15);
  }

  .mnb-segment.dragging {
    opacity: 0.5;
  }

  .mnb-segment-header {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
  }

  .mnb-segment-drag-handle {
    font-size: 16px;
    color: #9ca3af;
    cursor: grab;
  }

  .mnb-segment-drag-handle:active {
    cursor: grabbing;
  }

  .mnb-segment-icon {
    font-size: 18px;
  }

  .mnb-segment-type {
    flex: 1;
    font-size: 12px;
    font-weight: 500;
    color: #6b7280;
  }

  .mnb-segment-value {
    font-size: 15px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 8px;
  }

  .mnb-segment-controls {
    display: flex;
    gap: 8px;
  }

  .mnb-segment-btn {
    flex: 1;
    background: white;
    border: 1px solid #d1d5db;
    color: #374151;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    transition: all 0.2s;
    font-weight: 500;
  }

  .mnb-segment-btn:hover {
    background: #f9fafb;
    border-color: #9ca3af;
  }

  .mnb-segment-btn.delete {
    color: #ef4444;
    border-color: #fecaca;
  }

  .mnb-segment-btn.delete:hover {
    background: #fef2f2;
    border-color: #ef4444;
  }

  /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¿½åŠ ãƒœã‚¿ãƒ³ */
  .mnb-add-segment {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    width: 100%;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-bottom: 16px;
  }

  .mnb-add-segment:hover {
    background: #2563eb;
  }

  /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
  .mnb-preview {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 12px;
  }

  .mnb-preview-label {
    font-size: 11px;
    color: #6b7280;
    margin-bottom: 8px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .mnb-preview-value {
    padding: 6px 10px;
    background: #eff6ff;
    border: 1px solid #bfdbfe;
    border-radius: 6px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    font-size: 11px;
    color: #1e40af;
    font-weight: 500;
  }

  .mnb-preview-parts {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .mnb-preview-part {
    background: #f3f4f6;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    color: #6b7280;
    font-weight: 500;
  }

  /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .mnb-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    align-items: center;
    justify-content: center;
  }

  .mnb-modal.active {
    display: flex;
  }

  .mnb-modal-content {
    background: white;
    border-radius: 12px;
    padding: 20px;
    max-width: 600px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
  }

  .mnb-modal-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 16px;
    color: #1f2937;
  }

  .mnb-form-group {
    margin-bottom: 12px;
  }

  .mnb-form-label {
    display: block;
    font-size: 12px;
    font-weight: 500;
    color: #374151;
    margin-bottom: 4px;
  }

  .mnb-form-input,
  .mnb-form-select {
    width: 100%;
    padding: 6px 10px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 16px; /* iOSè‡ªå‹•ã‚ºãƒ¼ãƒ é˜²æ­¢ï¼ˆ16pxä»¥ä¸Šå¿…é ˆï¼‰ */
  }

  .mnb-form-input:focus,
  .mnb-form-select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .mnb-modal-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
  }

  .mnb-modal-btn {
    flex: 1;
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
  }

  .mnb-modal-btn-primary {
    background: #3b82f6;
    color: white;
  }

  .mnb-modal-btn-primary:hover {
    background: #2563eb;
  }

  .mnb-modal-btn-secondary {
    background: #e5e7eb;
    color: #374151;
  }

  .mnb-modal-btn-secondary:hover {
    background: #d1d5db;
  }

  /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—é¸æŠ */
  .mnb-type-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-bottom: 12px;
  }

  .mnb-type-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    padding: 10px 12px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }

  .mnb-type-card:hover {
    border-color: #3b82f6;
    background: #f0f9ff;
  }

  .mnb-type-card.selected {
    border-color: #3b82f6;
    background: #dbeafe;
  }

  .mnb-type-card-icon {
    font-size: 30px;
    margin-bottom: 4px;
  }

  .mnb-type-card-name {
    font-size: 13px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 3px;
  }

  .mnb-type-card-desc {
    font-size: 11px;
    color: #6b7280;
    line-height: 1.3;
  }

  /* ãƒ—ãƒªã‚»ãƒƒãƒˆã‚«ãƒ¼ãƒ‰é¸æŠã‚¹ã‚¿ã‚¤ãƒ« */
  .mnb-preset-card {
    transition: all 0.2s ease;
    position: relative;
  }

  .mnb-preset-card:hover {
    border-color: #3b82f6 !important;
    background: #f8fafc !important;
  }

  .mnb-preset-card.selected {
    border-color: #3b82f6 !important;
    background: #eff6ff !important;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
  }

  /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼ˆæœªé¸æŠæ™‚ï¼‰- å·¦ä¸Šã«é…ç½® */
  .mnb-preset-card::before {
    content: "";
    position: absolute;
    top: 14px;
    left: 14px;
    width: 20px;
    height: 20px;
    background: white;
    border: 2px solid #d1d5db;
    border-radius: 4px;
  }

  /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼ˆé¸æŠæ™‚ï¼‰ */
  .mnb-preset-card.selected::before {
    background: #3b82f6;
    border-color: #3b82f6;
  }

  .mnb-preset-card.selected::after {
    content: "";
    position: absolute;
    top: 18px;
    left: 21px;
    width: 6px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
  }

  /* ã‚«ãƒ¼ãƒ‰å†…ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å·¦ã«ä½™ç™½ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åˆ†ï¼‰ */
  .mnb-preset-card > div:first-child {
    margin-left: 30px;
  }
</style>

<!-- ç®¡ç†ç•ªå·ãƒ“ãƒ«ãƒ€ãƒ¼UI -->
<div class="mnb-container">
  <!-- ãƒ’ãƒ³ãƒˆ -->
  <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
    <div style="color: #3b82f6; font-weight: 600; margin-bottom: 4px;">
      <span>ğŸ’¡ æ¦‚è¦</span>
    </div>
    <div id="mnb-overview-content" style="display: block; padding-left: 12px; margin-bottom: 8px;">
      å•†å“ç™»éŒ²æ™‚ã«è‡ªå‹•ã§ç®¡ç†ç•ªå·ï¼ˆä¾‹: AA-1001ï¼‰ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸æŠã—ãŸã‚Šã€ã‚»ã‚°ãƒ¡ãƒ³ãƒˆï¼ˆã‚«ãƒ†ã‚´ãƒªã€æ—¥ä»˜ã€ãƒ©ãƒ³ã‚¯ã€ã‚µã‚¤ã‚ºã€ã‚«ãƒ©ãƒ¼ã€é€£ç•ªã€ã‚«ã‚¹ã‚¿ãƒ å€¤ï¼‰ã‚’è‡ªç”±ã«çµ„ã¿åˆã‚ã›ã¦ã€ç‹¬è‡ªã®ç®¡ç†ç•ªå·ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ä½œæˆã§ãã¾ã™
    </div>
  </div>

  <input type="hidden" id="mnbPresetSelect" value="">

  <!-- ===== ãƒ—ãƒªã‚»ãƒƒãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ ===== -->
  <div class="mnb-accordion-section" style="margin-bottom: 12px;">
    <div class="mnb-accordion-header" id="mnbPresetHeader" onclick="toggleMnbAccordion('preset')" style="display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border-radius: 10px; cursor: pointer; transition: all 0.2s;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 18px;">ğŸ“‹</span>
        <span style="font-size: 14px; font-weight: 600;">ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰é¸æŠ</span>
        <span style="font-size: 11px; opacity: 0.9;">ï¼ˆãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§è¨­å®šå®Œäº†ï¼‰</span>
      </div>
      <span id="mnbPresetArrow" style="font-size: 12px; transition: transform 0.3s;">â–¼</span>
    </div>
    <div id="mnbPresetContent" style="display: block; padding: 12px 0 0 0;">
      <div id="mnbPresetCards" style="display: flex; flex-direction: column; gap: 10px;">
        <!-- ã‚·ãƒ³ãƒ—ãƒ«é€£ç•ª -->
        <div class="mnb-preset-card" data-preset="simple" onclick="selectPresetCard('simple')" style="padding: 14px; background: white; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
            <span style="font-size: 20px;">ğŸ”¢</span>
            <span style="font-size: 14px; font-weight: 600; color: #1f2937;">ã‚·ãƒ³ãƒ—ãƒ«é€£ç•ª</span>
          </div>
          <div style="background: #f1f5f9; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px;">
            <span style="font-family: monospace; font-size: 15px; color: #3b82f6; font-weight: 600;">001 â†’ 002 â†’ 003</span>
          </div>
          <div style="font-size: 11px; color: #64748b; line-height: 1.4;">
            ã‚·ãƒ³ãƒ—ãƒ«ã«ç•ªå·ã ã‘ã§ç®¡ç†ã€‚å°‘é‡ã®å•†å“ã‚’æ‰±ã†æ–¹ã‚„ã€åˆã‚ã¦ã®æ–¹å‘ã‘
          </div>
        </div>

        <!-- æ£šç•ªå· + é€£ç•ªï¼ˆãŠã™ã™ã‚ï¼‰ -->
        <div class="mnb-preset-card" data-preset="shelf" onclick="selectPresetCard('shelf')" style="padding: 14px; background: white; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s;">
          <div style="position: absolute; top: -8px; right: 14px; background: linear-gradient(90deg, #f59e0b, #f97316); color: white; font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 10px;">
            â­ ãŠã™ã™ã‚
          </div>
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
            <span style="font-size: 20px;">ğŸ“¦</span>
            <span style="font-size: 14px; font-weight: 600; color: #1f2937;">æ£šç•ªå· + é€£ç•ª</span>
          </div>
          <div style="background: #f1f5f9; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px;">
            <span style="font-family: monospace; font-size: 15px; color: #3b82f6; font-weight: 600;">AA-0001, AB-0001, BA-0001</span>
          </div>
          <div style="font-size: 11px; color: #64748b; line-height: 1.4;">
            åç´å ´æ‰€ï¼ˆæ£šãƒ»ãƒ©ãƒƒã‚¯ï¼‰ã”ã¨ã«åˆ†é¡ã€‚åœ¨åº«ã®å ´æ‰€ãŒã™ãã‚ã‹ã‚‹
          </div>
        </div>

        <!-- ã‚«ãƒ†ã‚´ãƒª + æ—¥ä»˜ + é€£ç•ª -->
        <div class="mnb-preset-card" data-preset="category_date" onclick="selectPresetCard('category_date')" style="padding: 14px; background: white; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
            <span style="font-size: 20px;">ğŸ“…</span>
            <span style="font-size: 14px; font-weight: 600; color: #1f2937;">ã‚«ãƒ†ã‚´ãƒª + æ—¥ä»˜ + é€£ç•ª</span>
          </div>
          <div style="background: #f1f5f9; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px;">
            <span style="font-family: monospace; font-size: 15px; color: #3b82f6; font-weight: 600;">T-260101-001, B-260101-002</span>
          </div>
          <div style="font-size: 11px; color: #64748b; line-height: 1.4;">
            å•†å“ã‚«ãƒ†ã‚´ãƒªã¨ç™»éŒ²æ—¥ã§åˆ†é¡ã€‚ã„ã¤ãƒ»ä½•ã‚’ç™»éŒ²ã—ãŸã‹ä¸€ç›®ç­ç„¶
          </div>
        </div>

        <!-- æ£šç•ªå· + æ—¥ä»˜ + é€£ç•ª -->
        <div class="mnb-preset-card" data-preset="shelf_date" onclick="selectPresetCard('shelf_date')" style="padding: 14px; background: white; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
            <span style="font-size: 20px;">ğŸ—“ï¸</span>
            <span style="font-size: 14px; font-weight: 600; color: #1f2937;">æ£šç•ªå· + æ—¥ä»˜ + é€£ç•ª</span>
          </div>
          <div style="background: #f1f5f9; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px;">
            <span style="font-family: monospace; font-size: 15px; color: #3b82f6; font-weight: 600;">AA-260101-001, AB-260101-002</span>
          </div>
          <div style="font-size: 11px; color: #64748b; line-height: 1.4;">
            åç´å ´æ‰€ã¨ç™»éŒ²æ—¥ã®ä¸¡æ–¹ã§ç®¡ç†ã€‚å¤§é‡ã®åœ¨åº«ã‚’æ‰±ã†æ–¹å‘ã‘
          </div>
        </div>

        <!-- ã‚«ãƒ†ã‚´ãƒª + ãƒ©ãƒ³ã‚¯ + é€£ç•ª -->
        <div class="mnb-preset-card" data-preset="category_rank" onclick="selectPresetCard('category_rank')" style="padding: 14px; background: white; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
            <span style="font-size: 20px;">â­</span>
            <span style="font-size: 14px; font-weight: 600; color: #1f2937;">ã‚«ãƒ†ã‚´ãƒª + ãƒ©ãƒ³ã‚¯ + é€£ç•ª</span>
          </div>
          <div style="background: #f1f5f9; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px;">
            <span style="font-family: monospace; font-size: 15px; color: #3b82f6; font-weight: 600;">T-S-001, B-A-002, O-B-003</span>
          </div>
          <div style="font-size: 11px; color: #64748b; line-height: 1.4;">
            ã‚«ãƒ†ã‚´ãƒªã¨å•†å“ãƒ©ãƒ³ã‚¯ï¼ˆS/A/B/Cï¼‰ã§åˆ†é¡ã€‚ä¾¡å€¤åˆ¥ã®ç®¡ç†ã«æœ€é©
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ ===== -->
  <div class="mnb-accordion-section" style="margin-bottom: 16px;">
    <div class="mnb-accordion-header" id="mnbCustomHeader" onclick="toggleMnbAccordion('custom')" style="display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: #f3f4f6; color: #374151; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 18px;">ğŸ› ï¸</span>
        <span style="font-size: 14px; font-weight: 600;">ã‚«ã‚¹ã‚¿ãƒ è¨­å®š</span>
        <span style="font-size: 11px; color: #6b7280;">ï¼ˆè‡ªç”±ã«çµ„ã¿åˆã‚ã›ï¼‰</span>
      </div>
      <span id="mnbCustomArrow" style="font-size: 12px; transition: transform 0.3s;">â–¶</span>
    </div>
    <div id="mnbCustomContent" style="display: none; padding: 12px 0 0 0;">
      <!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆ -->
      <div id="mnbSegmentsList" class="mnb-segments">
        <div class="mnb-segments-empty">
          ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„<br><small style="font-size: 12px;">ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆã§ãã¾ã™</small>
        </div>
      </div>

      <!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¿½åŠ ãƒœã‚¿ãƒ³ -->
      <button type="button" class="mnb-add-segment" onclick="openAddSegmentModal()">
        <span>â•</span>
        <span>ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ </span>
      </button>
    </div>
  </div>

  <!-- ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
  <button type="button" onclick="clearManagementNumberSettings()" style="width: 100%; padding: 10px; background: white; border: 2px solid #ef4444; border-radius: 8px; color: #ef4444; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 16px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
    ğŸ—‘ï¸ ã™ã¹ã¦ã‚¯ãƒªã‚¢
  </button>

  <!-- ç®¡ç†ç•ªå·ã®é…ç½®è¨­å®š -->
  <div style="margin-top: 24px; padding: 16px; background: white; border: 1px solid #e5e7eb; border-radius: 8px;">
    <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">
      ğŸ“Œ ç®¡ç†ç•ªå·ã®é…ç½®
    </div>
    <div style="font-size: 12px; color: #6b7280; margin-bottom: 12px; line-height: 1.5;">
      ç”Ÿæˆã•ã‚ŒãŸç®¡ç†ç•ªå·ã‚’ã©ã“ã«è¡¨ç¤ºã™ã‚‹ã‹è¨­å®šã§ãã¾ã™
    </div>

    <!-- é…ç½®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px;">
      <div style="display: flex; align-items: center; gap: 6px;">
        <input type="checkbox" id="å•†å“åã«ç®¡ç†ç•ªå·é…ç½®" style="width: 16px; height: 16px; cursor: pointer;" onchange="toggleManagementNumberFormat(); if (typeof onManagementNumberSettingChange === 'function') onManagementNumberSettingChange();">
        <label for="å•†å“åã«ç®¡ç†ç•ªå·é…ç½®" style="font-size: 13px; cursor: pointer; margin: 0;">å•†å“åã«è¡¨ç¤º</label>
      </div>
      <div style="display: flex; align-items: center; gap: 6px;">
        <input type="checkbox" id="èª¬æ˜æ–‡ã«ç®¡ç†ç•ªå·é…ç½®" style="width: 16px; height: 16px; cursor: pointer;" onchange="toggleManagementNumberDescriptionFormat(); if (typeof onManagementNumberSettingChange === 'function') onManagementNumberSettingChange();">
        <label for="èª¬æ˜æ–‡ã«ç®¡ç†ç•ªå·é…ç½®" style="font-size: 13px; cursor: pointer; margin: 0;">èª¬æ˜æ–‡ã«è¡¨ç¤º</label>
      </div>
    </div>

    <!-- å½¢å¼é¸æŠï¼ˆå•†å“åç”¨ï¼‰ -->
    <div id="ç®¡ç†ç•ªå·å½¢å¼é¸æŠ" style="display: none;">
      <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">å•†å“åã§ã®è¡¨ç¤ºå½¢å¼</label>
      <select id="ç®¡ç†ç•ªå·å½¢å¼" style="width: 100%; font-size: 16px; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; background: white; margin-bottom: 8px;" onchange="updateManagementNumberPreview(); if (typeof onManagementNumberSettingChange === 'function') onManagementNumberSettingChange();">
        <option value="ã€ã€‘">ã€AA-1001ã€‘</option>
        <option value="ï¼ˆï¼‰">ï¼ˆAA-1001ï¼‰</option>
        <option value="ã€ã€">ã€AA-1001ã€</option>
        <option value="ã€Œã€">ã€ŒAA-1001ã€</option>
        <option value="ï½œï½œ">ï½œAA-1001ï½œ</option>
        <option value="ï½œ">ï½œAA-1001</option>
        <option value="-">- AA-1001</option>
        <option value="none">AA-1001</option>
      </select>

      <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">é…ç½®ä½ç½®</label>
      <select id="ç®¡ç†ç•ªå·é…ç½®ä½ç½®" style="width: 100%; font-size: 16px; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; background: white;" onchange="updateManagementNumberPreview(); if (typeof onManagementNumberSettingChange === 'function') onManagementNumberSettingChange();">
        <option value="end">å¾Œã‚ï¼ˆNIKEã€AA-1001ã€‘ï¼‰</option>
        <option value="start">å…ˆé ­ï¼ˆã€AA-1001ã€‘NIKEï¼‰</option>
      </select>
    </div>

    <!-- å½¢å¼é¸æŠï¼ˆèª¬æ˜æ–‡ç”¨ï¼‰ -->
    <div id="èª¬æ˜æ–‡ç®¡ç†ç•ªå·å½¢å¼é¸æŠ" style="display: none; margin-top: 12px;">
      <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">èª¬æ˜æ–‡ã§ã®è¡¨ç¤ºå½¢å¼</label>
      <select id="èª¬æ˜æ–‡ç®¡ç†ç•ªå·å½¢å¼" style="width: 100%; font-size: 16px; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; background: white; margin-bottom: 8px;" onchange="updateManagementNumberPreview(); if (typeof onManagementNumberSettingChange === 'function') onManagementNumberSettingChange();">
        <option value="ã€ã€‘">ç®¡ç†ç•ªå·ï¼šã€AA-1001ã€‘</option>
        <option value="ï¼ˆï¼‰">ç®¡ç†ç•ªå·ï¼šï¼ˆAA-1001ï¼‰</option>
        <option value="ã€ã€">ç®¡ç†ç•ªå·ï¼šã€AA-1001ã€</option>
        <option value="ã€Œã€">ç®¡ç†ç•ªå·ï¼šã€ŒAA-1001ã€</option>
        <option value="ï½œï½œ">ç®¡ç†ç•ªå·ï¼šï½œAA-1001ï½œ</option>
        <option value="ï½œ">ç®¡ç†ç•ªå·ï¼šï½œAA-1001</option>
        <option value="-">ç®¡ç†ç•ªå·ï¼š- AA-1001</option>
        <option value="none">ç®¡ç†ç•ªå·ï¼šAA-1001</option>
      </select>

      <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">é…ç½®ä½ç½®</label>
      <select id="èª¬æ˜æ–‡ç®¡ç†ç•ªå·é…ç½®ä½ç½®" style="width: 100%; font-size: 16px; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; background: white;" onchange="updateManagementNumberPreview(); if (typeof onManagementNumberSettingChange === 'function') onManagementNumberSettingChange();">
        <option value="top">å…ˆé ­ï¼ˆãƒ–ãƒ©ãƒ³ãƒ‰åã®ä¸Šï¼‰</option>
        <option value="middle">ä¸­ï¼ˆå•†å“æƒ…å ±ã®ä¸‹ï¼‰</option>
        <option value="bottom">æœ«å°¾ï¼ˆãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã®ä¸‹ï¼‰</option>
      </select>
    </div>

    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠï¼ˆã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå¼ï¼‰ -->
    <div id="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ" style="margin-top: 16px; display: none;">
      <!-- ã‚¿ãƒ–ãƒœã‚¿ãƒ³ -->
      <div style="display: flex; gap: 8px; margin-bottom: 12px;">
        <button id="ã‚¿ãƒ–_å•†å“å" onclick="switchPreviewTab('å•†å“å')" style="flex: 1; padding: 10px; border: 2px solid #40B4E5; background: #40B4E5; color: white; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
          ğŸ“ å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        </button>
        <button id="ã‚¿ãƒ–_èª¬æ˜æ–‡" onclick="switchPreviewTab('èª¬æ˜æ–‡')" style="flex: 1; padding: 10px; border: 2px solid #d1d5db; background: white; color: #6b7280; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
          ğŸ“„ èª¬æ˜æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        </button>
      </div>

      <!-- å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
      <div id="å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼_ã‚»ã‚¯ã‚·ãƒ§ãƒ³" style="padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; display: block;">
        <div id="å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼_ç®¡ç†ç•ªå·" style="font-size: 14px; color: #111827; line-height: 1.6; min-height: 24px; word-break: break-all;">
          NIKE ã‚¨ã‚¢ãƒãƒƒã‚¯ã‚¹
        </div>
        <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">
          â€» å®Ÿéš›ã®å•†å“åã§ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™
        </div>
      </div>

      <!-- èª¬æ˜æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
      <div id="èª¬æ˜æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼_ã‚»ã‚¯ã‚·ãƒ§ãƒ³" style="padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; display: none;">
        <div id="èª¬æ˜æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼_ç®¡ç†ç•ªå·" style="font-size: 13px; color: #111827; line-height: 1.8; min-height: 60px; word-break: break-all; white-space: pre-line;">
ã€å•†å“æƒ…å ±ã€‘
ãƒ–ãƒ©ãƒ³ãƒ‰ï¼šNIKE
ã‚¢ã‚¤ãƒ†ãƒ ï¼šã‚¨ã‚¢ãƒãƒƒã‚¯ã‚¹
ã‚«ãƒ©ãƒ¼ï¼šãƒ–ãƒ©ãƒƒã‚¯
ã‚µã‚¤ã‚ºï¼š27.0cm

ğŸ”¢ ç®¡ç†ç•ªå·ï¼šAA-1001
        </div>
        <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">
          â€» èª¬æ˜æ–‡ã§ã®ç®¡ç†ç•ªå·è¡¨ç¤ºã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="mnbModal" class="mnb-modal">
  <div class="mnb-modal-content">
    <div class="mnb-modal-title" id="mnbModalTitle">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ </div>

    <!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—é¸æŠ -->
    <div class="mnb-form-group" id="mnbTypeGridContainer">
      <label class="mnb-form-label">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—</label>
      <div class="mnb-type-grid" id="mnbTypeGrid">
        <!-- å‹•çš„ã«ç”Ÿæˆ -->
      </div>
    </div>

    <!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¨­å®šï¼ˆã‚¿ã‚¤ãƒ—ã«ã‚ˆã£ã¦å¤‰ã‚ã‚‹ï¼‰ -->
    <div id="mnbSegmentConfig">
      <!-- å‹•çš„ã«ç”Ÿæˆ -->
    </div>

    <!-- åŒºåˆ‡ã‚Šæ–‡å­— -->
    <div class="mnb-form-group">
      <label class="mnb-form-label">åŒºåˆ‡ã‚Šæ–‡å­—ï¼ˆã“ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®å¾Œï¼‰</label>
      <select class="mnb-form-select" id="mnbSeparator">
        <option value="-">- (ãƒã‚¤ãƒ•ãƒ³)</option>
        <option value="_">_ (ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢)</option>
        <option value="">ï¼ˆãªã—ï¼‰</option>
        <option value=".">. (ãƒ‰ãƒƒãƒˆ)</option>
        <option value=" ">ã€€(ã‚¹ãƒšãƒ¼ã‚¹)</option>
      </select>
    </div>

    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="mnb-modal-actions">
      <button type="button" class="mnb-modal-btn mnb-modal-btn-secondary" onclick="closeSegmentModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button type="button" class="mnb-modal-btn mnb-modal-btn-primary" onclick="saveSegment()">ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
  // ç®¡ç†ç•ªå·ãƒ“ãƒ«ãƒ€ãƒ¼ã‚·ã‚¹ãƒ†ãƒ  (PWAå¯¾å¿œ @916)
  const ManagementNumberBuilder = {
    segments: [],
    currentEditingIndex: null,
    selectedType: null,

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—å®šç¾©
    segmentTypes: {
      shelf: {
        icon: 'ğŸ·ï¸',
        name: 'æ£šç•ªå·',
        desc: 'AA, BB ãªã©ã®æ£šç•ªå·',
        fields: [
          {
            id: 'format',
            label: 'æ£šç•ªå·å½¢å¼',
            type: 'select',
            options: [
              { value: 'AA', label: 'ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ2æ–‡å­— (AA)' },
              { value: 'A', label: 'ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ1æ–‡å­— (A)' },
              { value: '01', label: 'æ•°å­—2æ¡ (01)' },
              { value: '001', label: 'æ•°å­—3æ¡ (001)' },
              { value: 'custom', label: 'âœï¸ ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›' }
            ]
          },
          { id: 'code', label: 'æ£šç•ªå·', type: 'text', placeholder: 'AA', conditional: { field: 'format', value: 'custom' } }
        ],
        preview: (config) => {
          if (config.format === 'custom') {
            return config.code || 'AA';
          }
          return config.format || 'AA';
        }
      },
      sequence: {
        icon: 'ğŸ”¢',
        name: 'é€£ç•ª',
        desc: '001, 0001 ãªã©ã®é€£ç•ª',
        fields: [
          {
            id: 'digits',
            label: 'æ¡æ•°',
            type: 'select',
            options: [
              { value: '2', label: '2æ¡ (01)' },
              { value: '3', label: '3æ¡ (001)' },
              { value: '4', label: '4æ¡ (0001)' },
              { value: '5', label: '5æ¡ (00001)' },
              { value: '6', label: '6æ¡ (000001)' }
            ]
          },
          { id: 'start', label: 'é–‹å§‹ç•ªå·', type: 'number', placeholder: '1' }
        ],
        preview: (config) => {
          const num = config.start || 1;
          const digits = parseInt(config.digits) || 3;
          return String(num).padStart(digits, '0');
        }
      },
      category: {
        icon: 'ğŸ“',
        name: 'ã‚«ãƒ†ã‚´ãƒªã‚³ãƒ¼ãƒ‰',
        desc: 'å•†å“ã‚«ãƒ†ã‚´ãƒª (K, O ãªã©)',
        fields: [
          { id: 'code', label: 'ã‚³ãƒ¼ãƒ‰', type: 'text', placeholder: 'K' }
        ],
        preview: (config) => config.code || 'K'
      },
      date: {
        icon: 'ğŸ“…',
        name: 'ç™»éŒ²æ—¥',
        desc: 'æ—¥ä»˜å½¢å¼ã‚’é¸æŠ',
        fields: [
          {
            id: 'format',
            label: 'å½¢å¼',
            type: 'select',
            options: [
              { value: 'YYMMDD', label: 'YYMMDD (241007)' },
              { value: 'YYYYMMDD', label: 'YYYYMMDD (20241007)' },
              { value: 'YYMD', label: 'YYMD (24107)' },
              { value: 'YYMM', label: 'YYMM (2410)' }
            ]
          }
        ],
        preview: (config) => {
          const now = new Date();
          const y = now.getFullYear();
          const m = String(now.getMonth() + 1).padStart(2, '0');
          const d = String(now.getDate()).padStart(2, '0');

          switch(config.format) {
            case 'YYYYMMDD': return `${y}${m}${d}`;
            case 'YYMD': return `${String(y).slice(2)}${parseInt(m)}${parseInt(d)}`;
            case 'YYMM': return `${String(y).slice(2)}${m}`;
            default: return `${String(y).slice(2)}${m}${d}`;
          }
        }
      },
      rank: {
        icon: 'â­',
        name: 'å“è³ªãƒ©ãƒ³ã‚¯',
        desc: 'A, B, C ãªã©ã®ãƒ©ãƒ³ã‚¯',
        fields: [
          { id: 'value', label: 'ãƒ©ãƒ³ã‚¯å€¤', type: 'text', placeholder: 'A' }
        ],
        preview: (config) => config.value || 'A'
      },
      size: {
        icon: 'ğŸ“',
        name: 'ã‚µã‚¤ã‚ºã‚³ãƒ¼ãƒ‰',
        desc: 'S, M, L ãªã©ã®ã‚µã‚¤ã‚º',
        fields: [
          { id: 'code', label: 'ã‚µã‚¤ã‚ºã‚³ãƒ¼ãƒ‰', type: 'text', placeholder: 'M' }
        ],
        preview: (config) => config.code || 'M'
      },
      color: {
        icon: 'ğŸ¨',
        name: 'è‰²ã‚³ãƒ¼ãƒ‰',
        desc: 'DB, R ãªã©ã®è‰²ã‚³ãƒ¼ãƒ‰',
        fields: [
          { id: 'code', label: 'è‰²ã‚³ãƒ¼ãƒ‰', type: 'text', placeholder: 'DB' }
        ],
        preview: (config) => config.code || 'DB'
      },
      custom: {
        icon: 'âœï¸',
        name: 'ã‚«ã‚¹ã‚¿ãƒ å›ºå®šå€¤',
        desc: 'ä»»æ„ã®å›ºå®šæ–‡å­—åˆ—',
        fields: [
          { id: 'value', label: 'å›ºå®šå€¤', type: 'text', placeholder: 'XXX' }
        ],
        preview: (config) => config.value || 'XXX'
      }
    },

    // ãƒ—ãƒªã‚»ãƒƒãƒˆå®šç¾©
    presets: {
      simple: [
        { type: 'sequence', config: { digits: '4', start: '1001' }, separator: '' }
      ],
      shelf: [
        { type: 'shelf', config: { format: 'AA' }, separator: '-' },
        { type: 'sequence', config: { digits: '4', start: '1001' }, separator: '' }
      ],
      category_date: [
        { type: 'category', config: { code: 'K' }, separator: '-' },
        { type: 'date', config: { format: 'YYMMDD' }, separator: '-' },
        { type: 'sequence', config: { digits: '3', start: '1' }, separator: '' }
      ],
      shelf_date: [
        { type: 'shelf', config: { format: 'AA' }, separator: '-' },
        { type: 'date', config: { format: 'YYMMDD' }, separator: '-' },
        { type: 'sequence', config: { digits: '3', start: '1' }, separator: '' }
      ],
      category_rank: [
        { type: 'category', config: { code: 'K' }, separator: '-' },
        { type: 'rank', config: { value: 'A' }, separator: '-' },
        { type: 'sequence', config: { digits: '3', start: '1' }, separator: '' }
      ]
    },

    // åˆæœŸåŒ–
    init() {
      this.renderTypeGrid();
      this.updatePreview();
      this.setupDragAndDrop();
      // loadSettings()ã¯FirebaseåˆæœŸåŒ–å¾Œã«å¤–éƒ¨ã‹ã‚‰å‘¼ã°ã‚Œã‚‹
      this.setupPresetSelector();
    },

    // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼è¨­å®šï¼ˆã‚«ãƒ¼ãƒ‰å‹å¯¾å¿œï¼‰
    setupPresetSelector() {
      // ã‚«ãƒ¼ãƒ‰å‹UIãªã®ã§ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯ä¸è¦
      // selectPresetCard()é–¢æ•°ãŒonclickã§å‘¼ã°ã‚Œã‚‹
    },

    // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚«ãƒ¼ãƒ‰é¸æŠã‚’é©ç”¨
    applyPresetFromCard(presetKey) {
      if (!presetKey) {
        // ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã®å ´åˆã¯ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ãªã„
        console.log('ã‚«ã‚¹ã‚¿ãƒ è¨­å®šãŒé¸æŠã•ã‚Œã¾ã—ãŸ');
        return;
      }

      const preset = this.presets[presetKey];
      if (!preset) {
        console.warn('ãƒ—ãƒªã‚»ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', presetKey);
        return;
      }

      // æ—¢å­˜ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¦ã€ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é©ç”¨
      this.segments = JSON.parse(JSON.stringify(preset)); // ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼
      this.renderSegments();
      this.updatePreview();
      console.log('âœ… ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é©ç”¨:', presetKey);
    },

    // è¨­å®šã‚’Firestoreã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆé«˜é€ŸåŒ–ãƒ»compatç‰ˆï¼‰
    // è¨­å®šã‚’GASã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§Firestoreã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆCORSå›é¿ï¼‰
    loadSettings() {
      if (!window.db) {
        console.warn('âš ï¸ FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }

    
      window.db.collection('settings').doc('common').get()
        .then((docSnap) => {
          if (docSnap.exists) {
            const data = docSnap.data();
            if (data.managementNumber && data.managementNumber.segments) {
              this.segments = data.managementNumber.segments;
              this.renderSegments();
              this.updatePreview();
              console.log('âœ… Firestoreã‹ã‚‰ç®¡ç†ç•ªå·è¨­å®šã‚’èª­ã¿è¾¼ã¿:', this.segments.length, 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ');

              // é…ç½®è¨­å®šã‚‚ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«åæ˜ 
              const showInTitle = document.getElementById('å•†å“åã«ç®¡ç†ç•ªå·é…ç½®');
              const showInDescription = document.getElementById('èª¬æ˜æ–‡ã«ç®¡ç†ç•ªå·é…ç½®');
              const formatSelect = document.getElementById('ç®¡ç†ç•ªå·å½¢å¼');
              const positionSelect = document.getElementById('ç®¡ç†ç•ªå·é…ç½®ä½ç½®');
              const descFormatSelect = document.getElementById('èª¬æ˜æ–‡ç®¡ç†ç•ªå·å½¢å¼');
              const descPositionSelect = document.getElementById('èª¬æ˜æ–‡ç®¡ç†ç•ªå·é…ç½®ä½ç½®');

              if (showInTitle && data.managementNumber.showInTitle !== undefined) {
                showInTitle.checked = data.managementNumber.showInTitle;
                console.log('âœ… å•†å“åãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¨­å®š:', data.managementNumber.showInTitle);
              }
              if (showInDescription && data.managementNumber.showInDescription !== undefined) {
                showInDescription.checked = data.managementNumber.showInDescription;
                console.log('âœ… èª¬æ˜æ–‡ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¨­å®š:', data.managementNumber.showInDescription);
              }
              if (formatSelect && data.managementNumber.titleFormat) {
                formatSelect.value = data.managementNumber.titleFormat;
              }
              if (positionSelect && data.managementNumber.titlePosition) {
                positionSelect.value = data.managementNumber.titlePosition;
              }
              if (descFormatSelect && data.managementNumber.descFormat) {
                descFormatSelect.value = data.managementNumber.descFormat;
              }
              if (descPositionSelect && data.managementNumber.descPosition) {
                descPositionSelect.value = data.managementNumber.descPosition;
              }

              // å½¢å¼é¸æŠã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°
              if (typeof toggleManagementNumberFormat === 'function') {
                toggleManagementNumberFormat();
              }
              if (typeof toggleManagementNumberDescriptionFormat === 'function') {
                toggleManagementNumberDescriptionFormat();
              }
            }
          } else {
            console.log('ğŸ“ Firestoreã«è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆåˆå›èµ·å‹•ï¼‰');
          }
        })
        .catch((e) => {
          console.error('âŒ Firestoreèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        });
    },

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã‚°ãƒªãƒƒãƒ‰ã‚’æç”»
    renderTypeGrid() {
      const grid = document.getElementById('mnbTypeGrid');
      grid.innerHTML = '';

      Object.keys(this.segmentTypes).forEach(typeKey => {
        const type = this.segmentTypes[typeKey];
        const card = document.createElement('div');
        card.className = 'mnb-type-card';
        card.onclick = () => this.selectType(typeKey);
        card.innerHTML = `
          <div class="mnb-type-card-icon">${type.icon}</div>
          <div class="mnb-type-card-name">${type.name}</div>
          <div class="mnb-type-card-desc">${type.desc}</div>
        `;
        grid.appendChild(card);
      });
    },

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—é¸æŠ
    selectType(typeKey) {
      this.selectedType = typeKey;

      // ã‚«ãƒ¼ãƒ‰ã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
      document.querySelectorAll('.mnb-type-card').forEach((card, i) => {
        card.classList.remove('selected');
      });
      const typeKeys = Object.keys(this.segmentTypes);
      const index = typeKeys.indexOf(typeKey);
      document.querySelectorAll('.mnb-type-card')[index].classList.add('selected');

      // è¨­å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤º
      this.renderConfigFields(typeKey);
    },

    // è¨­å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æç”»
    renderConfigFields(typeKey) {
      const type = this.segmentTypes[typeKey];
      const container = document.getElementById('mnbSegmentConfig');
      container.innerHTML = '';

      type.fields.forEach(field => {
        const group = document.createElement('div');
        group.className = 'mnb-form-group';

        // æ¡ä»¶ä»˜ããƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§éè¡¨ç¤º
        if (field.conditional) {
          group.style.display = 'none';
          group.setAttribute('data-conditional-field', field.conditional.field);
          group.setAttribute('data-conditional-value', field.conditional.value);
        }

        const label = document.createElement('label');
        label.className = 'mnb-form-label';
        label.textContent = field.label;
        group.appendChild(label);

        if (field.type === 'select') {
          const select = document.createElement('select');
          select.className = 'mnb-form-select';
          select.id = `mnbField_${field.id}`;

          field.options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.value;
            option.textContent = opt.label;
            select.appendChild(option);
          });

          // ã‚»ãƒ¬ã‚¯ãƒˆå¤‰æ›´æ™‚ã«æ¡ä»¶ä»˜ããƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
          select.addEventListener('change', () => {
            this.updateConditionalFields(field.id, select.value);
          });

          group.appendChild(select);
        } else {
          const input = document.createElement('input');
          input.className = 'mnb-form-input';
          input.type = field.type;
          input.id = `mnbField_${field.id}`;
          input.placeholder = field.placeholder || '';

          // é€£ç•ªã®é–‹å§‹ç•ªå·ã®å ´åˆã€æ¡æ•°åˆ¶é™ã‚’å‹•çš„ã«è¨­å®š
          if (typeKey === 'sequence' && field.id === 'start') {
            // åˆæœŸæ¡æ•°åˆ¶é™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ3æ¡ï¼‰
            input.setAttribute('maxlength', '3');

            // æ¡æ•°ã‚»ãƒ¬ã‚¯ãƒˆãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ã€é–‹å§‹ç•ªå·ã®maxlengthã‚’æ›´æ–°
            const setupDigitsListener = () => {
              const digitsSelect = document.getElementById('mnbField_digits');
              if (digitsSelect) {
                digitsSelect.addEventListener('change', (e) => {
                  const selectedDigits = e.target.value;
                  input.setAttribute('maxlength', selectedDigits);

                  // ç¾åœ¨ã®å€¤ãŒæ¡æ•°ã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆã¯åˆ‡ã‚Šè©°ã‚ã‚‹
                  if (input.value.length > parseInt(selectedDigits)) {
                    input.value = input.value.slice(0, parseInt(selectedDigits));
                  }
                });

                // åˆå›èª­ã¿è¾¼ã¿æ™‚ã«ã‚‚æ¡æ•°ã‚’åæ˜ 
                const currentDigits = digitsSelect.value || '3';
                input.setAttribute('maxlength', currentDigits);
              }
            };

            // DOMãŒæ§‹ç¯‰ã•ã‚ŒãŸå¾Œã«ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            setTimeout(setupDigitsListener, 0);
          }

          group.appendChild(input);
        }

        container.appendChild(group);
      });
    },

    // æ¡ä»¶ä»˜ããƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°
    updateConditionalFields(fieldId, value) {
      const container = document.getElementById('mnbSegmentConfig');
      const conditionalFields = container.querySelectorAll(`[data-conditional-field="${fieldId}"]`);

      conditionalFields.forEach(field => {
        const conditionalValue = field.getAttribute('data-conditional-value');
        if (value === conditionalValue) {
          field.style.display = 'block';
        } else {
          field.style.display = 'none';
        }
      });
    },

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
    addSegment(segment) {
      this.segments.push(segment);
      this.renderSegments();
      this.updatePreview();
    },

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
    updateSegment(index, segment) {
      this.segments[index] = segment;
      this.renderSegments();
      this.updatePreview();
    },

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
    removeSegment(index) {
      this.segments.splice(index, 1);
      this.renderSegments();
      this.updatePreview();
    },

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ç§»å‹•
    moveSegment(fromIndex, toIndex) {
      const segment = this.segments.splice(fromIndex, 1)[0];
      this.segments.splice(toIndex, 0, segment);
      this.renderSegments();
      this.updatePreview();
    },

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆã‚’æç”»
    renderSegments() {
      const container = document.getElementById('mnbSegmentsList');

      if (this.segments.length === 0) {
        container.innerHTML = `
          <div class="mnb-segments-empty">
            ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„<br>
            <small>ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆã§ãã¾ã™</small>
          </div>
        `;
        return;
      }

      container.innerHTML = '';

      this.segments.forEach((segment, index) => {
        const type = this.segmentTypes[segment.type];
        const block = document.createElement('div');
        block.className = 'mnb-segment';
        block.draggable = true;
        block.setAttribute('data-index', index);

        const preview = type.preview(segment.config);

        block.innerHTML = `
          <div class="mnb-segment-header">
            <div class="mnb-segment-drag-handle">â‹®â‹®</div>
            <div class="mnb-segment-icon">${type.icon}</div>
            <div class="mnb-segment-type">${type.name}</div>
          </div>
          <div class="mnb-segment-value">${preview}</div>
          <div class="mnb-segment-controls">
            <button class="mnb-segment-btn" onclick="event.stopPropagation(); ManagementNumberBuilder.editSegment(${index})">ç·¨é›†</button>
            <button class="mnb-segment-btn delete" onclick="event.stopPropagation(); ManagementNumberBuilder.removeSegment(${index})">å‰Šé™¤</button>
          </div>
        `;

        container.appendChild(block);
      });
    },

    // ç®¡ç†ç•ªå·ã‚’ç”Ÿæˆï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ï¼‰
    generatePreview() {
      if (this.segments.length === 0) {
        return '';
      }

      let preview = '';
      this.segments.forEach((segment, index) => {
        const type = this.segmentTypes[segment.type];
        const value = type.preview(segment.config);

        preview += value;
        if (index < this.segments.length - 1 && segment.separator) {
          preview += segment.separator;
        }
      });

      return preview;
    },

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
    updatePreview() {
      // å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
      if (typeof updateManagementNumberPreview === 'function') {
        updateManagementNumberPreview();
      }
    },

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ç·¨é›†
    editSegment(index) {
      this.currentEditingIndex = index;
      const segment = this.segments[index];
      const type = this.segmentTypes[segment.type];

      // ã‚¿ã‚¤ãƒˆãƒ«ã«ã‚¢ã‚¤ã‚³ãƒ³+ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåã‚’è¡¨ç¤º
      document.getElementById('mnbModalTitle').textContent = `${type.icon} ${type.name}ã‚’ç·¨é›†`;

      // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã‚°ãƒªãƒƒãƒ‰ã‚’éè¡¨ç¤ºï¼ˆç·¨é›†æ™‚ã¯ä¸è¦ï¼‰
      document.getElementById('mnbTypeGridContainer').style.display = 'none';

      this.selectType(segment.type);

      // è¨­å®šå€¤ã‚’å¾©å…ƒ
      type.fields.forEach(field => {
        const elem = document.getElementById(`mnbField_${field.id}`);
        if (elem) {
          elem.value = segment.config[field.id] || '';

          // ã‚»ãƒ¬ã‚¯ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å ´åˆã€æ¡ä»¶ä»˜ããƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚è¡¨ç¤ºæ›´æ–°
          if (field.type === 'select') {
            this.updateConditionalFields(field.id, elem.value);
          }
        }
      });

      document.getElementById('mnbSeparator').value = segment.separator || '-';
      document.getElementById('mnbModal').classList.add('active');
    },

    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®šï¼ˆSortable.jsä½¿ç”¨ï¼‰
    // ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ï¼ˆã‚¹ãƒãƒ›ï¼‰ã§ã‚‚å‹•ä½œã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸ
    setupDragAndDrop() {
      const container = document.getElementById('mnbSegmentsList');

      // Sortable.jsã‚’ä½¿ç”¨ã—ã¦ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚’åˆæœŸåŒ–
      // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã«è‡ªå‹•å¯¾å¿œ
      Sortable.create(container, {
        animation: 150,                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é€Ÿåº¦ï¼ˆãƒŸãƒªç§’ï¼‰
        handle: '.mnb-drag-handle',        // â‹®â‹® ã‚¢ã‚¤ã‚³ãƒ³ã®ã¿ã§ãƒ‰ãƒ©ãƒƒã‚°
        ghostClass: 'sortable-ghost',      // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦ç´ ã«é©ç”¨ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹
        chosenClass: 'sortable-chosen',    // é¸æŠä¸­ã®è¦ç´ ã«é©ç”¨ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹
        dragClass: 'sortable-drag',        // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦ç´ ã«é©ç”¨ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹
        onEnd: (evt) => {
          // ãƒ‰ãƒ­ãƒƒãƒ—å¾Œã«ä¸¦ã³é †ã‚’æ›´æ–°
          const oldIndex = evt.oldIndex;
          const newIndex = evt.newIndex;

          if (oldIndex !== newIndex) {
            this.moveSegment(oldIndex, newIndex);
          }
        }
      });
    },

    // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    getData() {
      return {
        segments: this.segments
      };
    },

    // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
    setData(data) {
      this.segments = data.segments || [];
      this.renderSegments();
      this.updatePreview();
    }
  };

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
  function openAddSegmentModal() {
    ManagementNumberBuilder.currentEditingIndex = null;
    ManagementNumberBuilder.selectedType = null;
    document.getElementById('mnbModalTitle').textContent = 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ';
    document.getElementById('mnbSegmentConfig').innerHTML = '';
    document.getElementById('mnbSeparator').value = '-';

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã‚°ãƒªãƒƒãƒ‰ã‚’è¡¨ç¤ºï¼ˆæ–°è¦è¿½åŠ æ™‚ï¼‰
    document.getElementById('mnbTypeGridContainer').style.display = 'block';

    // ã‚«ãƒ¼ãƒ‰ã®é¸æŠçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
    document.querySelectorAll('.mnb-type-card').forEach(card => {
      card.classList.remove('selected');
    });

    document.getElementById('mnbModal').classList.add('active');
  }

  function closeSegmentModal() {
    document.getElementById('mnbModal').classList.remove('active');
  }

  function saveSegment() {
    if (!ManagementNumberBuilder.selectedType) {
      alert('ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    const type = ManagementNumberBuilder.segmentTypes[ManagementNumberBuilder.selectedType];
    const config = {};

    // è¨­å®šå€¤ã‚’åé›†
    type.fields.forEach(field => {
      const elem = document.getElementById(`mnbField_${field.id}`);
      if (elem) {
        config[field.id] = elem.value;
      }
    });

    const segment = {
      type: ManagementNumberBuilder.selectedType,
      config: config,
      separator: document.getElementById('mnbSeparator').value
    };

    if (ManagementNumberBuilder.currentEditingIndex !== null) {
      ManagementNumberBuilder.updateSegment(ManagementNumberBuilder.currentEditingIndex, segment);
    } else {
      ManagementNumberBuilder.addSegment(segment);
    }

    closeSegmentModal();
  }

  /**
   * ç®¡ç†ç•ªå·å½¢å¼é¸æŠã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
   */
  function toggleManagementNumberFormat() {
    const checkbox = document.getElementById('å•†å“åã«ç®¡ç†ç•ªå·é…ç½®');
    const formatSection = document.getElementById('ç®¡ç†ç•ªå·å½¢å¼é¸æŠ');

    if (checkbox && formatSection) {
      formatSection.style.display = checkbox.checked ? 'block' : 'none';
      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
      updateManagementNumberPreview();
    }
  }

  /**
   * èª¬æ˜æ–‡ç®¡ç†ç•ªå·å½¢å¼é¸æŠã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
   */
  function toggleManagementNumberDescriptionFormat() {
    const checkbox = document.getElementById('èª¬æ˜æ–‡ã«ç®¡ç†ç•ªå·é…ç½®');
    const formatSection = document.getElementById('èª¬æ˜æ–‡ç®¡ç†ç•ªå·å½¢å¼é¸æŠ');

    if (checkbox && formatSection) {
      formatSection.style.display = checkbox.checked ? 'block' : 'none';
      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
      updateManagementNumberPreview();
    }
  }

  /**
   * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆ
   */
  function switchPreviewTab(tabName) {
    const titleTab = document.getElementById('ã‚¿ãƒ–_å•†å“å');
    const descTab = document.getElementById('ã‚¿ãƒ–_èª¬æ˜æ–‡');
    const titleSection = document.getElementById('å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼_ã‚»ã‚¯ã‚·ãƒ§ãƒ³');
    const descSection = document.getElementById('èª¬æ˜æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼_ã‚»ã‚¯ã‚·ãƒ§ãƒ³');

    if (tabName === 'å•†å“å') {
      // å•†å“åã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      titleTab.style.background = '#40B4E5';
      titleTab.style.color = 'white';
      titleTab.style.borderColor = '#40B4E5';

      descTab.style.background = 'white';
      descTab.style.color = '#6b7280';
      descTab.style.borderColor = '#d1d5db';

      titleSection.style.display = 'block';
      descSection.style.display = 'none';
    } else if (tabName === 'èª¬æ˜æ–‡') {
      // èª¬æ˜æ–‡ã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      descTab.style.background = '#40B4E5';
      descTab.style.color = 'white';
      descTab.style.borderColor = '#40B4E5';

      titleTab.style.background = 'white';
      titleTab.style.color = '#6b7280';
      titleTab.style.borderColor = '#d1d5db';

      titleSection.style.display = 'none';
      descSection.style.display = 'block';
    }
  }

  /**
   * ç®¡ç†ç•ªå·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°ï¼ˆå•†å“åã§ã®è¡¨ç¤ºã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰
   */
  function updateManagementNumberPreview() {
    console.log('ğŸ“ updateManagementNumberPreview å‘¼ã³å‡ºã—');

    const titleCheckbox = document.getElementById('å•†å“åã«ç®¡ç†ç•ªå·é…ç½®');
    const descCheckbox = document.getElementById('èª¬æ˜æ–‡ã«ç®¡ç†ç•ªå·é…ç½®');
    const formatSelect = document.getElementById('ç®¡ç†ç•ªå·å½¢å¼');
    const positionSelect = document.getElementById('ç®¡ç†ç•ªå·é…ç½®ä½ç½®');
    const titlePreviewElement = document.getElementById('å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼_ç®¡ç†ç•ªå·');
    const descPreviewElement = document.getElementById('èª¬æ˜æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼_ç®¡ç†ç•ªå·');
    const previewContainer = document.getElementById('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ');
    const titleTab = document.getElementById('ã‚¿ãƒ–_å•†å“å');
    const descTab = document.getElementById('ã‚¿ãƒ–_èª¬æ˜æ–‡');

    console.log('è¦ç´ ç¢ºèª:', {
      titleCheckbox: titleCheckbox ? 'OK' : 'NG',
      descCheckbox: descCheckbox ? 'OK' : 'NG',
      formatSelect: formatSelect ? 'OK' : 'NG',
      positionSelect: positionSelect ? 'OK' : 'NG',
      titlePreviewElement: titlePreviewElement ? 'OK' : 'NG',
      descPreviewElement: descPreviewElement ? 'OK' : 'NG'
    });

    if (!titlePreviewElement || !descPreviewElement) {
      console.warn('âš ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    // ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚­ã‚¹ãƒˆ
    const sampleText = 'NIKE ã‚¨ã‚¢ãƒãƒƒã‚¯ã‚¹';

    console.log('ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹çŠ¶æ…‹:', {
      title: titleCheckbox ? titleCheckbox.checked : 'null',
      desc: descCheckbox ? descCheckbox.checked : 'null'
    });

    const titleChecked = titleCheckbox && titleCheckbox.checked;
    const descChecked = descCheckbox && descCheckbox.checked;

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ¶å¾¡
    if (previewContainer) {
      if (!titleChecked && !descChecked) {
        // ä¸¡æ–¹OFFã®å ´åˆã¯å…¨ä½“ã‚’éè¡¨ç¤º
        previewContainer.style.display = 'none';
        console.log('âœ… ä¸¡æ–¹OFF - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼éè¡¨ç¤º');
        if (typeof saveManagementNumberPlacementSettings === 'function') {
          saveManagementNumberPlacementSettings();
        }
        return;
      } else {
        // ã©ã¡ã‚‰ã‹ONã®å ´åˆã¯è¡¨ç¤º
        previewContainer.style.display = 'block';
      }
    }

    // ã‚¿ãƒ–ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ¶å¾¡
    if (titleTab && descTab) {
      if (titleChecked && descChecked) {
        // ä¸¡æ–¹ONã®å ´åˆã¯ã‚¿ãƒ–ã‚’è¡¨ç¤º
        titleTab.style.display = 'block';
        descTab.style.display = 'block';
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å•†å“åã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
        switchPreviewTab('å•†å“å');
      } else if (titleChecked) {
        // å•†å“åã®ã¿ONã®å ´åˆã¯ã‚¿ãƒ–ã‚’éè¡¨ç¤ºã€å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã¿è¡¨ç¤º
        titleTab.style.display = 'none';
        descTab.style.display = 'none';
        document.getElementById('å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼_ã‚»ã‚¯ã‚·ãƒ§ãƒ³').style.display = 'block';
        document.getElementById('èª¬æ˜æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼_ã‚»ã‚¯ã‚·ãƒ§ãƒ³').style.display = 'none';
      } else if (descChecked) {
        // èª¬æ˜æ–‡ã®ã¿ONã®å ´åˆã¯ã‚¿ãƒ–ã‚’éè¡¨ç¤ºã€èª¬æ˜æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã¿è¡¨ç¤º
        titleTab.style.display = 'none';
        descTab.style.display = 'none';
        document.getElementById('å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼_ã‚»ã‚¯ã‚·ãƒ§ãƒ³').style.display = 'none';
        document.getElementById('èª¬æ˜æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼_ã‚»ã‚¯ã‚·ãƒ§ãƒ³').style.display = 'block';
      }
    }

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¨­å®šã‹ã‚‰ç®¡ç†ç•ªå·ã‚’ç”Ÿæˆ
    const generatedNumber = ManagementNumberBuilder.generatePreview();
    const sampleNumber = generatedNumber || 'AA-1001';

    console.log('ç”Ÿæˆã•ã‚ŒãŸç®¡ç†ç•ªå·:', sampleNumber);

    // å½¢å¼ã¨é…ç½®ä½ç½®ã‚’å–å¾—
    const format = formatSelect ? formatSelect.value : 'ã€ã€‘';
    const position = positionSelect ? positionSelect.value : 'end';

    console.log('é¸æŠå€¤:', { format, position });

    // ç®¡ç†ç•ªå·ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    let formattedNumber = '';
    switch (format) {
      case 'ã€ã€‘':
        formattedNumber = `ã€${sampleNumber}ã€‘`;
        break;
      case 'ï¼ˆï¼‰':
        formattedNumber = `ï¼ˆ${sampleNumber}ï¼‰`;
        break;
      case 'ã€ã€':
        formattedNumber = `ã€${sampleNumber}ã€`;
        break;
      case 'ã€Œã€':
        formattedNumber = `ã€Œ${sampleNumber}ã€`;
        break;
      case 'ï½œï½œ':
        formattedNumber = `ï½œ${sampleNumber}ï½œ`;
        break;
      case 'ï½œ':
        formattedNumber = `ï½œ${sampleNumber}`;
        break;
      case '-':
        formattedNumber = `- ${sampleNumber}`;
        break;
      case 'none':
        formattedNumber = sampleNumber;
        break;
      default:
        formattedNumber = `ã€${sampleNumber}ã€‘`;
    }

    // ä¸¡ç«¯é–‰ã˜ã¦ã„ã‚‹å ´åˆã¯ã‚¹ãƒšãƒ¼ã‚¹ãªã—ã€ãã‚Œä»¥å¤–ã¯ã‚¹ãƒšãƒ¼ã‚¹ã‚ã‚Š
    const pairs = [
      { start: 'ã€', end: 'ã€‘' },
      { start: 'ã€', end: 'ã€' },
      { start: 'ã€Œ', end: 'ã€' },
      { start: 'ï¼ˆ', end: 'ï¼‰' },
      { start: 'ï½œ', end: 'ï½œ' }
    ];
    const needsSpace = !pairs.some(pair =>
      formattedNumber.startsWith(pair.start) && formattedNumber.endsWith(pair.end)
    );

    // é…ç½®ä½ç½®ã«å¿œã˜ã¦çµåˆ
    let result;
    if (position === 'start') {
      result = needsSpace ? `${formattedNumber} ${sampleText}` : `${formattedNumber}${sampleText}`;
    } else {
      result = needsSpace ? `${sampleText} ${formattedNumber}` : `${sampleText}${formattedNumber}`;
    }

    console.log('âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°:', result);

    // å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
    if (titleCheckbox && titleCheckbox.checked) {
      titlePreviewElement.textContent = result;
    }

    // èª¬æ˜æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
    if (descCheckbox && descCheckbox.checked) {
      const descFormatSelect = document.getElementById('èª¬æ˜æ–‡ç®¡ç†ç•ªå·å½¢å¼');
      const descPositionSelect = document.getElementById('èª¬æ˜æ–‡ç®¡ç†ç•ªå·é…ç½®ä½ç½®');

      const descFormat = descFormatSelect ? descFormatSelect.value : 'ã€ã€‘';
      const descPosition = descPositionSelect ? descPositionSelect.value : 'bottom';

      // èª¬æ˜æ–‡ç”¨ã®ç®¡ç†ç•ªå·ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆçµµæ–‡å­—ãªã—ï¼‰
      let descFormattedNumber = '';
      switch (descFormat) {
        case 'ã€ã€‘':
          descFormattedNumber = `ç®¡ç†ç•ªå·ï¼šã€${sampleNumber}ã€‘`;
          break;
        case 'ï¼ˆï¼‰':
          descFormattedNumber = `ç®¡ç†ç•ªå·ï¼šï¼ˆ${sampleNumber}ï¼‰`;
          break;
        case 'ã€ã€':
          descFormattedNumber = `ç®¡ç†ç•ªå·ï¼šã€${sampleNumber}ã€`;
          break;
        case 'ã€Œã€':
          descFormattedNumber = `ç®¡ç†ç•ªå·ï¼šã€Œ${sampleNumber}ã€`;
          break;
        case 'ï½œï½œ':
          descFormattedNumber = `ç®¡ç†ç•ªå·ï¼šï½œ${sampleNumber}ï½œ`;
          break;
        case 'ï½œ':
          descFormattedNumber = `ç®¡ç†ç•ªå·ï¼šï½œ${sampleNumber}`;
          break;
        case '-':
          descFormattedNumber = `ç®¡ç†ç•ªå·ï¼š- ${sampleNumber}`;
          break;
        case 'none':
          descFormattedNumber = `ç®¡ç†ç•ªå·ï¼š${sampleNumber}`;
          break;
        default:
          descFormattedNumber = `ç®¡ç†ç•ªå·ï¼šã€${sampleNumber}ã€‘`;
      }

      // é…ç½®ä½ç½®ã«å¿œã˜ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆï¼ˆå®Ÿéš›ã®å•†å“èª¬æ˜ã«è¿‘ã„å½¢å¼ï¼‰
      let descPreview = '';

      // ãƒ–ãƒ©ãƒ³ãƒ‰åãƒ»åŸºæœ¬æƒ…å ±ï¼ˆå…ˆé ­éƒ¨åˆ†ï¼‰
      const brandInfo = `ãƒ–ãƒ©ãƒ³ãƒ‰åï¼šUNIQLOï¼ˆãƒ¦ãƒ‹ã‚¯ãƒ­ï¼‰

ã‚«ãƒ©ãƒ¼ï¼ˆè©³ç´°ï¼‰ï¼šãƒ–ãƒ©ãƒƒã‚¯

ã‚µã‚¤ã‚ºï¼ˆè¡¨è¨˜ï¼‰ï¼šM`;

      // å•†å“æƒ…å ±ï¼ˆä¸­å¤®éƒ¨åˆ†ï¼‰
      const detailInfo = `ã€ã‚µã‚¤ã‚º(å®Ÿå¯¸)ã€‘
è‚©å¹…ï¼š47cm
èº«å¹…ï¼š55cm
è¢–ä¸ˆï¼š62cm
ç€ä¸ˆï¼š68cm

ã€ç´ æã€‘
è¡¨åœ°ï¼šãƒŠã‚¤ãƒ­ãƒ³ 100%
ä¸­ç¶¿ï¼šãƒ€ã‚¦ãƒ³ 90%ã€ãƒ•ã‚§ã‚¶ãƒ¼ 10%

å•†å“çŠ¶æ…‹ï¼ˆè©³ç´°ï¼‰ï¼š
ç›®ç«‹ã£ãŸå‚·ã‚„æ±šã‚Œãªã—ã€‚`;

      // å•†å“èª¬æ˜ãƒ»ãã®ä»–ï¼ˆä¸‹éƒ¨ï¼‰
      const descriptionPart = `ã€UNIQLO ã‚¦ãƒ«ãƒˆãƒ©ãƒ©ã‚¤ãƒˆãƒ€ã‚¦ãƒ³ã‚¸ãƒ£ã‚±ãƒƒãƒˆã€‘

UNIQLOï¼ˆãƒ¦ãƒ‹ã‚¯ãƒ­ï¼‰ã®å®šç•ªäººæ°—ã‚¢ã‚¤ãƒ†ãƒ ã€ã‚¦ãƒ«ãƒˆãƒ©ãƒ©ã‚¤ãƒˆãƒ€ã‚¦ãƒ³ã‚¸ãƒ£ã‚±ãƒƒãƒˆã§ã™ã€‚è»½é‡ã§æŒã¡é‹ã³ã‚‚ã—ã‚„ã™ãã€ç§‹å†¬ã®ã‚¢ã‚¦ã‚¿ãƒ¼ã¨ã—ã¦å¤§æ´»èºã—ã¾ã™ã€‚

ã€ãŠã™ã™ã‚ã‚·ãƒ¼ãƒ³ã€‘
æ™®æ®µä½¿ã„ã¯ã‚‚ã¡ã‚ã‚“ã€æ—…è¡Œã‚„é€šå‹¤ãƒ»é€šå­¦ã«ã‚‚ä¾¿åˆ©ã€‚ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«åç´ã§ãã‚‹ã®ã§ã€ãƒãƒƒã‚°ã«å…¥ã‚Œã¦ãŠãã¨å®‰å¿ƒã§ã™ã€‚`;

      // ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ï¼ˆæœ€ä¸‹éƒ¨ï¼‰- ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‹ã‚‰ç”Ÿæˆ
      let hashtags = '';
      try {
        const hashtagConfig = localStorage.getItem('rebornConfig_hashtag');
        if (hashtagConfig) {
          const config = JSON.parse(hashtagConfig);
          const commonPrefix = config.commonPrefix || '#REBORN_';

          // è¨­å®šã•ã‚ŒãŸãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ç”Ÿæˆï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã«ç°¡ç•¥åŒ–ï¼‰
          const previewTags = [];

          if (config.hashtags && Array.isArray(config.hashtags)) {
            config.hashtags.forEach(tag => {
              if (tag.title === 'å…¨å•†å“') {
                previewTags.push(`${commonPrefix}${tag.suffix || 'å…¨å•†å“'}`);
              } else if (tag.title === 'ãƒ–ãƒ©ãƒ³ãƒ‰') {
                previewTags.push(`${commonPrefix}UNIQLO${tag.suffix || 'ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§'}`);
              } else if (tag.title === 'ã‚«ãƒ†ã‚´ãƒª') {
                previewTags.push(`${commonPrefix}ãƒ¡ãƒ³ã‚ºãƒ»ãƒ¬ãƒ‡ã‚£ãƒ¼ã‚¹${tag.suffix || 'ä¸€è¦§'}`);
              }
            });
          }

          // ã‚¿ã‚°ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚Œã°ãã‚Œã‚’ä½¿ç”¨
          if (previewTags.length > 0) {
            hashtags = previewTags.join('\n');
          } else {
            // æ—§å½¢å¼ã¾ãŸã¯è¨­å®šãªã—ã®å ´åˆ
            hashtags = `${commonPrefix}å…¨å•†å“\n${commonPrefix}UNIQLOã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§\n${commonPrefix}ãƒ¡ãƒ³ã‚ºãƒ»ãƒ¬ãƒ‡ã‚£ãƒ¼ã‚¹ä¸€è¦§`;
          }
        } else {
          // è¨­å®šãŒãªã„å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
          hashtags = `#REBORN_å…¨å•†å“\n#REBORN_UNIQLOã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§\n#REBORN_ãƒ¡ãƒ³ã‚ºãƒ»ãƒ¬ãƒ‡ã‚£ãƒ¼ã‚¹ä¸€è¦§`;
        }
      } catch (e) {
        console.error('ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°è¨­å®šã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        hashtags = `#REBORN_å…¨å•†å“\n#REBORN_UNIQLOã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§\n#REBORN_ãƒ¡ãƒ³ã‚ºãƒ»ãƒ¬ãƒ‡ã‚£ãƒ¼ã‚¹ä¸€è¦§`;
      }

      if (descPosition === 'top') {
        // å…ˆé ­ï¼ˆãƒ–ãƒ©ãƒ³ãƒ‰åã®ä¸Šï¼‰
        descPreview = `${descFormattedNumber}

${brandInfo}

${detailInfo}

${descriptionPart}

${hashtags}`;
      } else if (descPosition === 'middle') {
        // ä¸­ï¼ˆå•†å“æƒ…å ±ã®ä¸‹ï¼‰
        descPreview = `${brandInfo}

${detailInfo}

${descFormattedNumber}

${descriptionPart}

${hashtags}`;
      } else {
        // æœ«å°¾ï¼ˆãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã®ä¸‹ã€ä¸€ç•ªç›®ç«‹ãŸãªã„ä½ç½®ï¼‰
        descPreview = `${brandInfo}

${detailInfo}

${descriptionPart}

${hashtags}

${descFormattedNumber}`;
      }

      descPreviewElement.textContent = descPreview;
    }

    // è¨­å®šã‚’ä¿å­˜
    if (typeof saveManagementNumberPlacementSettings === 'function') {
      saveManagementNumberPlacementSettings();
    }
  }



  /**
   * ãƒ’ãƒ³ãƒˆã®é–‹é–‰ã‚’åˆ‡ã‚Šæ›¿ãˆ
   */
  function toggleHint(id) {
    const content = document.getElementById(id + '-content');
    const icon = document.getElementById(id + '-icon');

    if (content.style.display === 'none') {
      content.style.display = 'block';
      icon.textContent = 'â–¼';
    } else {
      content.style.display = 'none';
      icon.textContent = 'â–¶';
    }
  }

  /**
   * ãƒ’ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®é–‹é–‰ã‚’åˆ‡ã‚Šæ›¿ãˆï¼ˆç›¸äº’æ’ä»–çš„ï¼‰
   * @param {string} prefix - ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼ˆä¾‹: 'mnb'ï¼‰
   * @param {string} section - ã‚»ã‚¯ã‚·ãƒ§ãƒ³åï¼ˆ'overview' ã¾ãŸã¯ 'hint'ï¼‰
   */
  function toggleHintSection(prefix, section) {
    const sections = ['overview', 'hint'];
    const currentContent = document.getElementById(prefix + '-' + section + '-content');
    const currentIcon = document.getElementById(prefix + '-' + section + '-icon');

    if (!currentContent || !currentIcon) return;

    const isCurrentlyOpen = currentContent.style.display !== 'none';

    // ã™ã¹ã¦ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‰ã˜ã‚‹
    sections.forEach(s => {
      const content = document.getElementById(prefix + '-' + s + '-content');
      const icon = document.getElementById(prefix + '-' + s + '-icon');
      if (content && icon) {
        content.style.display = 'none';
        icon.textContent = 'â–¶';
      }
    });

    // ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒé–‰ã˜ã¦ã„ãŸå ´åˆã®ã¿é–‹ã
    if (!isCurrentlyOpen) {
      currentContent.style.display = 'block';
      currentIcon.textContent = 'â–¼';
    }
  }

  /**
   * ç®¡ç†ç•ªå·è¨­å®šã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢
   */
  function clearManagementNumberSettings() {
    if (!confirm('ç®¡ç†ç•ªå·è¨­å®šã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ»ã™ã¹ã¦ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã™\nãƒ»ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠã‚‚ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™')) {
      return;
    }

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé…åˆ—ã‚’ã‚¯ãƒªã‚¢
    MANAGEMENT_NUMBER_CONFIG.segments = [];

    // ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
    const presetSelect = document.getElementById('mnbPresetSelect');
    if (presetSelect) {
      presetSelect.value = '';
    }

    // UIã‚’å†æç”»
    renderSegments();
    updatePreview();

    alert('ç®¡ç†ç•ªå·è¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚\nå¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã€Œè¨­å®šã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
  }

  // åˆæœŸåŒ–
  if (typeof window !== 'undefined') {
    window.ManagementNumberBuilder = ManagementNumberBuilder;

    // DOMContentLoadedã§åˆæœŸåŒ–
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        ManagementNumberBuilder.init();
      });
    } else {
      ManagementNumberBuilder.init();
    }
  }

  // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚«ãƒ¼ãƒ‰é¸æŠï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼‰
  function selectPresetCard(presetKey) {
    // 1. å…¨ã‚«ãƒ¼ãƒ‰ã‹ã‚‰é¸æŠçŠ¶æ…‹ã‚’è§£é™¤
    const allCards = document.querySelectorAll('.mnb-preset-card');
    allCards.forEach(card => card.classList.remove('selected'));

    // 2. é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã«é¸æŠçŠ¶æ…‹ã‚’è¿½åŠ 
    const selectedCard = document.querySelector(`.mnb-preset-card[data-preset="${presetKey}"]`);
    if (selectedCard) {
      selectedCard.classList.add('selected');
    }

    // 3. éš ã—inputã®å€¤ã‚’æ›´æ–°
    const hiddenInput = document.getElementById('mnbPresetSelect');
    if (hiddenInput) {
      hiddenInput.value = presetKey;
    }

    // 4. ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é©ç”¨ï¼ˆç©ºã§ãªã„å ´åˆã®ã¿ï¼‰
    if (presetKey && ManagementNumberBuilder) {
      ManagementNumberBuilder.applyPresetFromCard(presetKey);
    }

    console.log('ğŸ“‹ ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠ:', presetKey || 'ã‚«ã‚¹ã‚¿ãƒ ');
  }

  // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼‰
  function toggleMnbAccordion(section) {
    const presetContent = document.getElementById('mnbPresetContent');
    const customContent = document.getElementById('mnbCustomContent');
    const presetArrow = document.getElementById('mnbPresetArrow');
    const customArrow = document.getElementById('mnbCustomArrow');
    const presetHeader = document.getElementById('mnbPresetHeader');
    const customHeader = document.getElementById('mnbCustomHeader');

    if (section === 'preset') {
      // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é–‹ã/é–‰ã˜ã‚‹
      const isOpen = presetContent.style.display !== 'none';
      if (isOpen) {
        // é–‰ã˜ã‚‹
        presetContent.style.display = 'none';
        presetArrow.textContent = 'â–¶';
        presetHeader.style.background = '#f3f4f6';
        presetHeader.style.color = '#374151';
        presetHeader.style.border = '2px solid #e5e7eb';
      } else {
        // é–‹ãï¼ˆã‚«ã‚¹ã‚¿ãƒ ã‚’é–‰ã˜ã‚‹ï¼‰
        presetContent.style.display = 'block';
        presetArrow.textContent = 'â–¼';
        presetHeader.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
        presetHeader.style.color = 'white';
        presetHeader.style.border = 'none';

        customContent.style.display = 'none';
        customArrow.textContent = 'â–¶';
        customHeader.style.background = '#f3f4f6';
        customHeader.style.color = '#374151';
      }
    } else if (section === 'custom') {
      // ã‚«ã‚¹ã‚¿ãƒ ã‚’é–‹ã/é–‰ã˜ã‚‹
      const isOpen = customContent.style.display !== 'none';
      if (isOpen) {
        // é–‰ã˜ã‚‹
        customContent.style.display = 'none';
        customArrow.textContent = 'â–¶';
        customHeader.style.background = '#f3f4f6';
        customHeader.style.color = '#374151';
      } else {
        // é–‹ãï¼ˆãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é–‰ã˜ã‚‹ï¼‰
        customContent.style.display = 'block';
        customArrow.textContent = 'â–¼';
        customHeader.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        customHeader.style.color = 'white';
        customHeader.style.border = 'none';

        presetContent.style.display = 'none';
        presetArrow.textContent = 'â–¶';
        presetHeader.style.background = '#f3f4f6';
        presetHeader.style.color = '#374151';
      }
    }
  }

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
  window.toggleMnbAccordion = toggleMnbAccordion;
  window.selectPresetCard = selectPresetCard;
</script>
          </div>

          <!-- é…é€ã‚¿ãƒ– -->
          <div class="tab-pane fade" id="system-shipping" role="tabpanel">
        <!-- ãƒ’ãƒ³ãƒˆ -->
        <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
          <div style="color: #3b82f6; font-weight: 600; margin-bottom: 4px;">
            <span>ğŸ’¡ æ¦‚è¦</span>
          </div>
          <div id="shipping-overview-content" style="display: block; padding-left: 12px; margin-bottom: 8px;">
            ã“ã“ã§è¨­å®šã—ãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒå•†å“ç™»éŒ²æ™‚ã«è‡ªå‹•ã§é©ç”¨ã•ã‚Œã¾ã™ã€‚é…é€æ–™ã®è² æ‹…ï¼ˆé€æ–™è¾¼ã¿/ç€æ‰•ã„ï¼‰ã€é…é€ã®æ–¹æ³•ï¼ˆã‚†ã†ã‚†ã†ãƒ¡ãƒ«ã‚«ãƒªä¾¿ç­‰10ç¨®é¡ä»¥ä¸Šï¼‰ã€ç™ºé€å…ƒã®åœ°åŸŸï¼ˆå…¨47éƒ½é“åºœçœŒï¼‰ã€ç™ºé€ã¾ã§ã®æ—¥æ•°ã®4é …ç›®ã‚’è¨­å®šã§ãã¾ã™
          </div>
        </div>

        <!-- é…é€æ–™ã®è² æ‹… -->
        <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
          <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px; display: block;">
            ğŸ’° é…é€æ–™ã®è² æ‹…
          </label>
          <select id="é…é€æ–™ã®è² æ‹…" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
            <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
            <option value="é€æ–™è¾¼ã¿(å‡ºå“è€…è² æ‹…)">é€æ–™è¾¼ã¿(å‡ºå“è€…è² æ‹…)</option>
            <option value="ç€æ‰•ã„(è³¼å…¥è€…è² æ‹…)">ç€æ‰•ã„(è³¼å…¥è€…è² æ‹…)</option>
          </select>
        </div>

        <!-- é…é€ã®æ–¹æ³• -->
        <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
          <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px; display: block;">
            ğŸ“® é…é€ã®æ–¹æ³•
          </label>
          <select id="é…é€ã®æ–¹æ³•" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
            <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
            <option value="æœªå®š">æœªå®š</option>
            <option value="ã‚‰ãã‚‰ããƒ¡ãƒ«ã‚«ãƒªä¾¿">ã‚‰ãã‚‰ããƒ¡ãƒ«ã‚«ãƒªä¾¿</option>
            <option value="ã‚†ã†ã‚†ã†ãƒ¡ãƒ«ã‚«ãƒªä¾¿">ã‚†ã†ã‚†ã†ãƒ¡ãƒ«ã‚«ãƒªä¾¿</option>
            <option value="ã‚†ã†ãƒ¡ãƒ¼ãƒ«">ã‚†ã†ãƒ¡ãƒ¼ãƒ«</option>
            <option value="ãƒ¬ã‚¿ãƒ¼ãƒ‘ãƒƒã‚¯">ãƒ¬ã‚¿ãƒ¼ãƒ‘ãƒƒã‚¯</option>
            <option value="æ™®é€šéƒµä¾¿(å®šå½¢ã€å®šå½¢å¤–)">æ™®é€šéƒµä¾¿(å®šå½¢ã€å®šå½¢å¤–)</option>
            <option value="ã‚¯ãƒ­ãƒã‚³ãƒ¤ãƒãƒˆ">ã‚¯ãƒ­ãƒã‚³ãƒ¤ãƒãƒˆ</option>
            <option value="ã‚†ã†ãƒ‘ãƒƒã‚¯">ã‚†ã†ãƒ‘ãƒƒã‚¯</option>
            <option value="ã‚¯ãƒªãƒƒã‚¯ãƒã‚¹ãƒˆ">ã‚¯ãƒªãƒƒã‚¯ãƒã‚¹ãƒˆ</option>
            <option value="ã‚†ã†ãƒ‘ã‚±ãƒƒãƒˆ">ã‚†ã†ãƒ‘ã‚±ãƒƒãƒˆ</option>
          </select>
        </div>

        <!-- ç™ºé€å…ƒã®åœ°åŸŸ -->
        <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
          <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px; display: block;">
            ğŸ“ ç™ºé€å…ƒã®åœ°åŸŸ
          </label>
          <select id="ç™ºé€å…ƒã®åœ°åŸŸ" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
            <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
            <option value="åŒ—æµ·é“">åŒ—æµ·é“</option>
            <option value="é’æ£®çœŒ">é’æ£®çœŒ</option>
            <option value="å²©æ‰‹çœŒ">å²©æ‰‹çœŒ</option>
            <option value="å®®åŸçœŒ">å®®åŸçœŒ</option>
            <option value="ç§‹ç”°çœŒ">ç§‹ç”°çœŒ</option>
            <option value="å±±å½¢çœŒ">å±±å½¢çœŒ</option>
            <option value="ç¦å³¶çœŒ">ç¦å³¶çœŒ</option>
            <option value="èŒ¨åŸçœŒ">èŒ¨åŸçœŒ</option>
            <option value="æ ƒæœ¨çœŒ">æ ƒæœ¨çœŒ</option>
            <option value="ç¾¤é¦¬çœŒ">ç¾¤é¦¬çœŒ</option>
            <option value="åŸ¼ç‰çœŒ">åŸ¼ç‰çœŒ</option>
            <option value="åƒè‘‰çœŒ">åƒè‘‰çœŒ</option>
            <option value="æ±äº¬éƒ½">æ±äº¬éƒ½</option>
            <option value="ç¥å¥ˆå·çœŒ">ç¥å¥ˆå·çœŒ</option>
            <option value="æ–°æ½ŸçœŒ">æ–°æ½ŸçœŒ</option>
            <option value="å¯Œå±±çœŒ">å¯Œå±±çœŒ</option>
            <option value="çŸ³å·çœŒ">çŸ³å·çœŒ</option>
            <option value="ç¦äº•çœŒ">ç¦äº•çœŒ</option>
            <option value="å±±æ¢¨çœŒ">å±±æ¢¨çœŒ</option>
            <option value="é•·é‡çœŒ">é•·é‡çœŒ</option>
            <option value="å²é˜œçœŒ">å²é˜œçœŒ</option>
            <option value="é™å²¡çœŒ">é™å²¡çœŒ</option>
            <option value="æ„›çŸ¥çœŒ">æ„›çŸ¥çœŒ</option>
            <option value="ä¸‰é‡çœŒ">ä¸‰é‡çœŒ</option>
            <option value="æ»‹è³€çœŒ">æ»‹è³€çœŒ</option>
            <option value="äº¬éƒ½åºœ">äº¬éƒ½åºœ</option>
            <option value="å¤§é˜ªåºœ">å¤§é˜ªåºœ</option>
            <option value="å…µåº«çœŒ">å…µåº«çœŒ</option>
            <option value="å¥ˆè‰¯çœŒ">å¥ˆè‰¯çœŒ</option>
            <option value="å’Œæ­Œå±±çœŒ">å’Œæ­Œå±±çœŒ</option>
            <option value="é³¥å–çœŒ">é³¥å–çœŒ</option>
            <option value="å³¶æ ¹çœŒ">å³¶æ ¹çœŒ</option>
            <option value="å²¡å±±çœŒ">å²¡å±±çœŒ</option>
            <option value="åºƒå³¶çœŒ">åºƒå³¶çœŒ</option>
            <option value="å±±å£çœŒ">å±±å£çœŒ</option>
            <option value="å¾³å³¶çœŒ">å¾³å³¶çœŒ</option>
            <option value="é¦™å·çœŒ">é¦™å·çœŒ</option>
            <option value="æ„›åª›çœŒ">æ„›åª›çœŒ</option>
            <option value="é«˜çŸ¥çœŒ">é«˜çŸ¥çœŒ</option>
            <option value="ç¦å²¡çœŒ">ç¦å²¡çœŒ</option>
            <option value="ä½è³€çœŒ">ä½è³€çœŒ</option>
            <option value="é•·å´çœŒ">é•·å´çœŒ</option>
            <option value="ç†Šæœ¬çœŒ">ç†Šæœ¬çœŒ</option>
            <option value="å¤§åˆ†çœŒ">å¤§åˆ†çœŒ</option>
            <option value="å®®å´çœŒ">å®®å´çœŒ</option>
            <option value="é¹¿å…å³¶çœŒ">é¹¿å…å³¶çœŒ</option>
            <option value="æ²–ç¸„çœŒ">æ²–ç¸„çœŒ</option>
          </select>
        </div>

        <!-- ç™ºé€ã¾ã§ã®æ—¥æ•° -->
        <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
          <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px; display: block;">
            â±ï¸ ç™ºé€ã¾ã§ã®æ—¥æ•°
          </label>
          <select id="ç™ºé€ã¾ã§ã®æ—¥æ•°" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
            <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
            <option value="1~2æ—¥ã§ç™ºé€">1~2æ—¥ã§ç™ºé€</option>
            <option value="2~3æ—¥ã§ç™ºé€">2~3æ—¥ã§ç™ºé€</option>
            <option value="4~7æ—¥ã§ç™ºé€">4~7æ—¥ã§ç™ºé€</option>
          </select>
        </div>

        <!-- æ¢±åŒ…è³‡æãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ -->
        <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
          <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px; display: block;">
            ğŸ“¦ æ¢±åŒ…è³‡æï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
          </label>
          <select id="æ¢±åŒ…è³‡æãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
            <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
            <!-- Firestoreã‹ã‚‰å‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ -->
          </select>
        </div>

        <!-- ã™ã¹ã¦ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ -->
        <button type="button" onclick="clearShippingDefaults()" style="width: 100%; padding: 10px; background: white; border: 2px solid #ef4444; border-radius: 8px; color: #ef4444; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 16px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
          ğŸ—‘ï¸ ã™ã¹ã¦ã‚¯ãƒªã‚¢
        </button>
          </div>

          <!-- ä»•å…¥ãƒ»å‡ºå“ã‚¿ãƒ– -->
          <div class="tab-pane fade" id="system-procure" role="tabpanel">
        <!-- ãƒ’ãƒ³ãƒˆ -->
        <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
          <div style="color: #3b82f6; font-weight: 600; margin-bottom: 4px;">
            <span>ğŸ’¡ æ¦‚è¦</span>
          </div>
          <div id="procure-overview-content" style="display: block; padding-left: 12px; margin-bottom: 8px;">
            ã“ã“ã§è¨­å®šã—ãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒå•†å“ç™»éŒ²æ™‚ã«è‡ªå‹•ã§é©ç”¨ã•ã‚Œã¾ã™ã€‚ä»•å…¥æ—¥ãƒ»å‡ºå“æ—¥ã¯ã€Œå¸¸ã«ä»Šæ—¥ã®æ—¥ä»˜ã‚’ä½¿ç”¨ã€ã§æ¯æ—¥è‡ªå‹•æ›´æ–°ã€ã¾ãŸã¯ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã¦å›ºå®šæ—¥ä»˜ï¼ˆä¸€æ‹¬ä»•å…¥ã‚Œã«ä¾¿åˆ©ï¼‰ã‚’è¨­å®šã§ãã¾ã™ã€‚ä»•å…¥å…ˆãƒ»å‡ºå“å…ˆã‚‚ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã§é¸æŠã§ãã¾ã™
          </div>
        </div>

        <!-- ä»•å…¥æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div style="margin-bottom: 24px; padding: 16px; background: white; border-radius: 8px; border: 2px solid #e5e7eb;">
          <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 16px;">
            ğŸ’° ä»•å…¥æƒ…å ±
          </div>

          <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥æ—¥ -->
          <div style="margin-bottom: 16px;">
            <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">
              ğŸ“… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä»•å…¥æ—¥
            </label>
            <!-- å¸¸ã«ä»Šæ—¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 8px;">
              <input type="checkbox" id="ä»•å…¥æ—¥_ä»Šæ—¥" onchange="toggleProcureDateField()" style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px; font-weight: 500; color: #374151;">
                å¸¸ã«ä»Šæ—¥ã®æ—¥ä»˜ã‚’ä½¿ç”¨
              </span>
            </label>
            <!-- æ—¥ä»˜å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
            <input type="date" id="ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥æ—¥" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
              ç©ºæ¬„ã®å ´åˆã¯è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã›ã‚“ã€‚ã¾ã¨ã‚ã¦ä»•å…¥ã‚ŒãŸæ—¥ä»˜ã‚’è¨­å®šã™ã‚‹ã¨ä¾¿åˆ©ã§ã™
            </div>
          </div>

          <!-- ä»•å…¥å…ˆ -->
          <div style="margin-bottom: 12px;">
            <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">
              ğŸª ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä»•å…¥å…ˆ
            </label>
            <select id="ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥å…ˆ" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
              <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
            </select>
            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
              ã‚ˆãä½¿ã†ä»•å…¥å…ˆã‚’é¸æŠï¼ˆç©ºæ¬„ã‚‚å¯ï¼‰
            </div>
          </div>
        </div>

        <!-- å‡ºå“æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div style="margin-bottom: 16px; padding: 16px; background: white; border-radius: 8px; border: 2px solid #e5e7eb;">
          <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 16px;">
            ğŸ“¤ å‡ºå“æƒ…å ±
          </div>

          <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“æ—¥ -->
          <div style="margin-bottom: 16px;">
            <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">
              ğŸ“… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‡ºå“æ—¥ â˜…æ¨å¥¨
            </label>
            <!-- å¸¸ã«ä»Šæ—¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 8px;">
              <input type="checkbox" id="å‡ºå“æ—¥_ä»Šæ—¥" onchange="toggleListingDateField()" style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px; font-weight: 500; color: #374151;">
                å¸¸ã«ä»Šæ—¥ã®æ—¥ä»˜ã‚’ä½¿ç”¨
              </span>
            </label>
            <!-- æ—¥ä»˜å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
            <input type="date" id="ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“æ—¥" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
              ã€Œå¸¸ã«ä»Šæ—¥ã€ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨æ¯æ—¥è‡ªå‹•ã§ä»Šæ—¥ã®æ—¥ä»˜ãŒå…¥ã‚Šã¾ã™ã€‚å›ºå®šæ—¥ä»˜ã«ã™ã‚‹å ´åˆã¯ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã¦ãã ã•ã„
            </div>
          </div>

          <!-- å‡ºå“å…ˆ -->
          <div style="margin-bottom: 12px;">
            <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">
              ğŸ›’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‡ºå“å…ˆ
            </label>
            <select id="ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“å…ˆ" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
              <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
            </select>
            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
              ã‚ˆãä½¿ã†å‡ºå“å…ˆã‚’é¸æŠï¼ˆç©ºæ¬„ã‚‚å¯ï¼‰
            </div>
          </div>
        </div>

        <!-- ã™ã¹ã¦ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ -->
        <button type="button" onclick="clearProcureListingDefaults()" style="width: 100%; padding: 10px; background: white; border: 2px solid #ef4444; border-radius: 8px; color: #ef4444; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 16px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
          ğŸ—‘ï¸ ã™ã¹ã¦ã‚¯ãƒªã‚¢
        </button>
          </div>

          <!-- æ¨©é™è¨­å®šã‚¿ãƒ– (PERM-001 Phase 2) -->
          <div class="tab-pane fade" id="system-permission" role="tabpanel">
            <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
            <div id="permissionSettingsLoading" style="display: flex; justify-content: center; align-items: center; padding: 40px;">
              <div style="text-align: center;">
                <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f4f6; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
                <div style="margin-top: 12px; color: #6b7280; font-size: 14px;">èª­ã¿è¾¼ã¿ä¸­...</div>
              </div>
            </div>

            <!-- æ¨©é™è¨­å®šã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆåˆæœŸéè¡¨ç¤ºï¼‰ -->
            <div id="permissionSettingsContent" style="display: none;">

              <!-- ãƒ’ãƒ³ãƒˆ -->
              <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #fef3c7; border-radius: 6px; border-left: 3px solid #f59e0b; margin-bottom: 16px; line-height: 1.6;">
                <div style="color: #b45309; font-weight: 600; margin-bottom: 4px;">
                  <span>ğŸ” ç®¡ç†è€…å°‚ç”¨æ©Ÿèƒ½</span>
                </div>
                <div>
                  ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ãƒ¬ãƒ™ãƒ«ã‚’å¤‰æ›´ã—ãŸã‚Šã€å„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ¨©é™ã”ã¨ã«è¨­å®šã§ãã¾ã™ã€‚
                </div>
              </div>

              <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
              <div style="margin-bottom: 24px; padding: 16px; background: white; border-radius: 8px; border: 2px solid #e5e7eb;">
                <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 16px;">
                  ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ç®¡ç†
                </div>
                <div id="userPermissionList" style="display: flex; flex-direction: column; gap: 12px;">
                  <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                </div>
              </div>

              <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
              <div style="margin-bottom: 24px; padding: 16px; background: white; border-radius: 8px; border: 2px solid #e5e7eb;">
                <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 16px;">
                  ğŸ“‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºè¨­å®š
                </div>
                <div style="font-size: 12px; color: #6b7280; margin-bottom: 12px;">
                  å„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã©ã®æ¨©é™ã«è¡¨ç¤ºã™ã‚‹ã‹è¨­å®šã—ã¾ã™ã€‚ç®¡ç†è€…ã¯å¸¸ã«ã™ã¹ã¦è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                </div>
                <div id="menuPermissionList" style="display: flex; flex-direction: column; gap: 12px;">
                  <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®šãƒªã‚¹ãƒˆãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                </div>
              </div>
            </div>
          </div>

          <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚¿ãƒ– -->
          <div class="tab-pane fade" id="system-users" role="tabpanel">
            <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
            <div id="userManagementLoading" style="display: flex; justify-content: center; align-items: center; padding: 40px;">
              <div style="text-align: center;">
                <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f4f6; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
                <div style="margin-top: 12px; color: #6b7280; font-size: 14px;">èª­ã¿è¾¼ã¿ä¸­...</div>
              </div>
            </div>

            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆåˆæœŸéè¡¨ç¤ºï¼‰ -->
            <div id="userManagementContent" style="display: none;">

              <!-- ãƒ’ãƒ³ãƒˆ -->
              <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #fef3c7; border-radius: 6px; border-left: 3px solid #f59e0b; margin-bottom: 16px; line-height: 1.6;">
                <div style="color: #b45309; font-weight: 600; margin-bottom: 4px;">
                  <span>ğŸ‘¥ ç®¡ç†è€…å°‚ç”¨æ©Ÿèƒ½</span>
                </div>
                <div>
                  æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰¿èªãƒ»å´ä¸‹ã€æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç„¡åŠ¹åŒ–ãƒ»æœ‰åŠ¹åŒ–ã‚’ç®¡ç†ã§ãã¾ã™ã€‚
                </div>
              </div>

              <!-- æ‰¿èªå¾…ã¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
              <div style="margin-bottom: 24px; padding: 16px; background: white; border-radius: 8px; border: 2px solid #fbbf24;">
                <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                  <span>â³ æ‰¿èªå¾…ã¡ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
                  <span id="pendingUsersCount" style="background: #fbbf24; color: #92400e; font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">0</span>
                </div>
                <div id="pendingUsersList" style="display: flex; flex-direction: column; gap: 12px;">
                  <!-- æ‰¿èªå¾…ã¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                  <div style="text-align: center; color: #9ca3af; font-size: 13px; padding: 20px;">
                    æ‰¿èªå¾…ã¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“
                  </div>
                </div>
              </div>

              <!-- æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
              <div style="margin-bottom: 24px; padding: 16px; background: white; border-radius: 8px; border: 2px solid #10b981;">
                <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                  <span>âœ… æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
                  <span id="activeUsersCount" style="background: #10b981; color: white; font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">0</span>
                </div>
                <div id="activeUsersList" style="display: flex; flex-direction: column; gap: 12px;">
                  <!-- æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                </div>
              </div>

              <!-- ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
              <div style="margin-bottom: 24px; padding: 16px; background: white; border-radius: 8px; border: 2px solid #e5e7eb;">
                <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                  <span>ğŸš« ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
                  <span id="inactiveUsersCount" style="background: #6b7280; color: white; font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">0</span>
                </div>
                <div id="inactiveUsersList" style="display: flex; flex-direction: column; gap: 12px;">
                  <!-- ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                  <div style="text-align: center; color: #9ca3af; font-size: 13px; padding: 20px;">
                    ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“
                  </div>
                </div>
              </div>

            </div>
          </div>

          <!-- ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã‚¿ãƒ– -->
          <div class="tab-pane fade" id="system-platform" role="tabpanel">
            <!-- ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div id="platformSettingsContent">

              <!-- ãƒ’ãƒ³ãƒˆ -->
              <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #dbeafe; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
                <div style="color: #1e40af; font-weight: 600; margin-bottom: 4px;">
                  <span>ğŸŒ ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š</span>
                </div>
                <div>
                  å•†å“ç™»éŒ²æ™‚ã«åˆ©ç”¨ã™ã‚‹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¨ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¾ã™ã€‚
                </div>
              </div>

              <!-- ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰è¨­å®š -->
              <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">ğŸ“‹ ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰</h4>

                <div style="display: flex; flex-direction: column; gap: 12px;">
                  <label style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onclick="selectRegistrationMode('individual')">
                    <input type="radio" name="registrationMode" id="modeIndividual" value="individual" checked style="margin-top: 2px; accent-color: #40B4E5;">
                    <div>
                      <div style="font-weight: 600; color: #374151; font-size: 14px;">å€‹åˆ¥ç™»éŒ²</div>
                      <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">1å›ã®æ“ä½œã§1ã¤ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ç™»éŒ²ã—ã¾ã™ã€‚ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ç™»éŒ²å…ˆã‚’é¸æŠã—ã¾ã™ã€‚</div>
                    </div>
                  </label>

                  <label style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onclick="selectRegistrationMode('batch')">
                    <input type="radio" name="registrationMode" id="modeBatch" value="batch" style="margin-top: 2px; accent-color: #40B4E5;">
                    <div>
                      <div style="font-weight: 600; color: #374151; font-size: 14px;">ä¸€æ‹¬ç™»éŒ²</div>
                      <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">1å›ã®æ“ä½œã§æœ‰åŠ¹ãªã™ã¹ã¦ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ä¸€æ‹¬ç™»éŒ²ã—ã¾ã™ã€‚ã‚¿ãƒ–ã¯ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åˆ¥è¨­å®šã®ç¢ºèªç”¨ã«ãªã‚Šã¾ã™ã€‚</div>
                    </div>
                  </label>
                </div>
              </div>

              <!-- åˆ©ç”¨ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š -->
              <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">ğŸª åˆ©ç”¨ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </h4>
                <div style="font-size: 11px; color: #6b7280; margin-bottom: 16px;">
                  å•†å“ç™»éŒ²ç”»é¢ã«è¡¨ç¤ºã™ã‚‹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
                </div>

                <div style="display: flex; flex-direction: column; gap: 10px;" id="platformCheckboxes">
                  <!-- ãƒ¡ãƒ«ã‚«ãƒª -->
                  <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; background: #f9fafb;">
                    <input type="checkbox" id="platform-mercari" value="mercari" checked style="width: 18px; height: 18px; accent-color: #40B4E5;">
                    <img src="/images/platform/mercari.png" alt="ãƒ¡ãƒ«ã‚«ãƒª" style="width: 36px; height: 36px; object-fit: contain;">
                    <div style="flex: 1;">
                      <div style="font-weight: 600; color: #374151; font-size: 14px;">ãƒ¡ãƒ«ã‚«ãƒª</div>
                      <div style="font-size: 11px; color: #6b7280;">ãƒ•ãƒªãƒã‚¢ãƒ—ãƒª</div>
                    </div>
                    <span style="font-size: 10px; background: #10b981; color: white; padding: 2px 8px; border-radius: 10px;">å®Ÿè£…æ¸ˆ</span>
                  </label>

                  <!-- ãƒ¡ãƒ«ã‚«ãƒªShops -->
                  <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; background: #f9fafb;">
                    <input type="checkbox" id="platform-mercari-shops" value="mercari-shops" style="width: 18px; height: 18px; accent-color: #40B4E5;">
                    <img src="/images/platform/mercari-shops.png" alt="ãƒ¡ãƒ«ã‚«ãƒªShops" style="width: 36px; height: 36px; object-fit: contain;">
                    <div style="flex: 1;">
                      <div style="font-weight: 600; color: #374151; font-size: 14px;">ãƒ¡ãƒ«ã‚«ãƒªShops</div>
                      <div style="font-size: 11px; color: #6b7280;">ã‚·ãƒ§ãƒƒãƒ—å‘ã‘EC</div>
                    </div>
                    <span style="font-size: 10px; background: #f59e0b; color: white; padding: 2px 8px; border-radius: 10px;">æº–å‚™ä¸­</span>
                  </label>

                  <!-- Yahoo!ãƒ•ãƒªãƒ -->
                  <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; background: #f9fafb;">
                    <input type="checkbox" id="platform-yahoo-fleamarket" value="yahoo-fleamarket" style="width: 18px; height: 18px; accent-color: #40B4E5;">
                    <img src="/images/platform/yahoo-fleamarket.png" alt="Yahoo!ãƒ•ãƒªãƒ" style="width: 36px; height: 36px; object-fit: contain;">
                    <div style="flex: 1;">
                      <div style="font-weight: 600; color: #374151; font-size: 14px;">Yahoo!ãƒ•ãƒªãƒ</div>
                      <div style="font-size: 11px; color: #6b7280;">PayPayãƒ•ãƒªãƒ</div>
                    </div>
                    <span style="font-size: 10px; background: #f59e0b; color: white; padding: 2px 8px; border-radius: 10px;">æº–å‚™ä¸­</span>
                  </label>

                  <!-- Yahoo!ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ -->
                  <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; background: #f9fafb;">
                    <input type="checkbox" id="platform-yahoo-auction" value="yahoo-auction" style="width: 18px; height: 18px; accent-color: #40B4E5;">
                    <img src="/images/platform/yahoo-auction.png" alt="Yahoo!ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³" style="width: 36px; height: 36px; object-fit: contain;">
                    <div style="flex: 1;">
                      <div style="font-weight: 600; color: #374151; font-size: 14px;">Yahoo!ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³</div>
                      <div style="font-size: 11px; color: #6b7280;">ãƒ¤ãƒ•ã‚ªã‚¯</div>
                    </div>
                    <span style="font-size: 10px; background: #f59e0b; color: white; padding: 2px 8px; border-radius: 10px;">æº–å‚™ä¸­</span>
                  </label>

                  <!-- ãƒ©ã‚¯ãƒ -->
                  <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; background: #f9fafb;">
                    <input type="checkbox" id="platform-rakuma" value="rakuma" style="width: 18px; height: 18px; accent-color: #40B4E5;">
                    <img src="/images/platform/rakuma.png" alt="ãƒ©ã‚¯ãƒ" style="width: 36px; height: 36px; object-fit: contain;">
                    <div style="flex: 1;">
                      <div style="font-weight: 600; color: #374151; font-size: 14px;">ãƒ©ã‚¯ãƒ</div>
                      <div style="font-size: 11px; color: #6b7280;">æ¥½å¤©ãƒ•ãƒªãƒ</div>
                    </div>
                    <span style="font-size: 10px; background: #f59e0b; color: white; padding: 2px 8px; border-radius: 10px;">æº–å‚™ä¸­</span>
                  </label>

                  <!-- BASE -->
                  <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; background: #f9fafb;">
                    <input type="checkbox" id="platform-base" value="base" style="width: 18px; height: 18px; accent-color: #40B4E5;">
                    <img src="/images/platform/base.png" alt="BASE" style="width: 36px; height: 36px; object-fit: contain;">
                    <div style="flex: 1;">
                      <div style="font-weight: 600; color: #374151; font-size: 14px;">BASE</div>
                      <div style="font-size: 11px; color: #6b7280;">ãƒãƒƒãƒˆã‚·ãƒ§ãƒƒãƒ—</div>
                    </div>
                    <span style="font-size: 10px; background: #f59e0b; color: white; padding: 2px 8px; border-radius: 10px;">æº–å‚™ä¸­</span>
                  </label>
                </div>
              </div>

              <!-- æ³¨æ„äº‹é … -->
              <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #fef3c7; border-radius: 6px; border-left: 3px solid #f59e0b; line-height: 1.6;">
                <div style="color: #b45309; font-weight: 600; margin-bottom: 4px;">
                  <span>âš ï¸ æ³¨æ„</span>
                </div>
                <div>
                  ã€Œæº–å‚™ä¸­ã€ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¯ç¾åœ¨é–‹ç™ºä¸­ã§ã™ã€‚ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ã‚‚å•†å“ç™»éŒ²ç”»é¢ã«ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚
                </div>
              </div>

            </div>
          </div>

        </div>
      </div>

    </div>

    <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
    <div class="save-btn" style="display: flex; justify-content: center;">
      <button type="button" onclick="window.saveConfig()" style="background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%); color: white; border: none; padding: 12px 48px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='linear-gradient(135deg, #2E94C5 0%, #1A6A8F 100%)'" onmouseout="this.style.background='linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%)'" onmousedown="this.style.transform='scale(0.98)'; this.style.opacity='0.8';" onmouseup="this.style.transform='scale(1)'; this.style.opacity='1';">
        âœ“ è¨­å®šã‚’ä¿å­˜
      </button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      // ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆéåŒæœŸå®Œäº†ã‚’å¾…ã¤ï¼‰
      await loadSaleswordMasterData();

      // ä»•å…¥ãƒ»å‡ºå“ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’åˆæœŸåŒ–ï¼ˆFirestoreåˆæœŸåŒ–ãŒé…å»¶ã—ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
      if (window.db && window.firestoreReady) {
        await initProcureListingDropdowns();
      }

      // ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã‚’èª­ã¿è¾¼ã¿ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ»ã‚ˆãä½¿ã†ãƒ»è¡¨ç¤ºå½¢å¼ï¼‰
      loadSaleswordConfig();
    });

    /**
     * ãƒ’ãƒ³ãƒˆã®é–‹é–‰ã‚’åˆ‡ã‚Šæ›¿ãˆï¼ˆç›¸äº’æ’ä»–çš„ï¼‰
     */
    function toggleConfigHint(prefix, section) {
      const sections = ['overview', 'hint'];
      const currentContent = document.getElementById(prefix + '-' + section + '-content');
      const currentIcon = document.getElementById(prefix + '-' + section + '-icon');

      if (!currentContent || !currentIcon) return;

      const isCurrentlyOpen = currentContent.style.display !== 'none';

      // ã™ã¹ã¦ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‰ã˜ã‚‹
      sections.forEach(s => {
        const content = document.getElementById(prefix + '-' + s + '-content');
        const icon = document.getElementById(prefix + '-' + s + '-icon');
        if (content && icon) {
          content.style.display = 'none';
          icon.textContent = 'â–¶';
        }
      });

      // ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒé–‰ã˜ã¦ã„ãŸå ´åˆã®ã¿é–‹ã
      if (!isCurrentlyOpen) {
        currentContent.style.display = 'block';
        currentIcon.textContent = 'â–¼';
      }
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let currentConfig = null;
    const CONDITION_STATES = [
      'æ–°å“ã€æœªä½¿ç”¨',
      'æœªä½¿ç”¨ã«è¿‘ã„',
      'ç›®ç«‹ã£ãŸå‚·ã‚„æ±šã‚Œãªã—',
      'ã‚„ã‚„å‚·ã‚„æ±šã‚Œã‚ã‚Š',
      'å‚·ã‚„æ±šã‚Œã‚ã‚Š',
      'å…¨ä½“çš„ã«çŠ¶æ…‹ãŒæ‚ªã„'
    ];

    // å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³ã®ãƒ—ãƒªã‚»ãƒƒãƒˆ
    const CONDITION_BUTTON_PRESETS = {
      'æ–°å“ã€æœªä½¿ç”¨': [
        { label: 'ã‚¿ã‚°ä»˜ãæœªä½¿ç”¨', text: 'ã‚¿ã‚°ä»˜ãæœªä½¿ç”¨å“ã§ã™ã€‚' },
        { label: 'æ–°å“æœªé–‹å°', text: 'æ–°å“æœªé–‹å°ã§ã™ã€‚' },
        { label: 'è©¦ç€ã®ã¿', text: 'è©¦ç€ã®ã¿ã®æœªä½¿ç”¨å“ã§ã™ã€‚' }
      ],
      'æœªä½¿ç”¨ã«è¿‘ã„': [
        { label: 'æ•°å›ç€ç”¨', text: 'æ•°å›ã®ã¿ç€ç”¨ã®ç¾å“ã§ã™ã€‚' },
        { label: 'ã»ã¼æœªä½¿ç”¨', text: 'ã»ã¼æœªä½¿ç”¨ã«è¿‘ã„çŠ¶æ…‹ã§ã™ã€‚' },
        { label: 'å®¤å†…è©¦ç€ã®ã¿', text: 'å®¤å†…ã§è©¦ç€ã—ãŸã®ã¿ã§ã™ã€‚' }
      ],
      'ç›®ç«‹ã£ãŸå‚·ã‚„æ±šã‚Œãªã—': [
        { label: 'ç¾å“', text: 'ã»ã¨ã‚“ã©ä½¿ç”¨æ„ŸãŒãªãã€ã¨ã¦ã‚‚ç¶ºéº—ãªçŠ¶æ…‹ã§ã™ã€‚' },
        { label: 'ä¿ç®¡æ™‚ã®ã‚·ãƒ¯', text: 'ä¿ç®¡æ™‚ã®å°ã•ãªã‚·ãƒ¯ãŒã‚ã‚Šã¾ã™ãŒã€ç€ç”¨ã«ã¯å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚' },
        { label: 'ç€ç”¨æ„Ÿå°‘ãªã„', text: 'ç€ç”¨æ„ŸãŒå°‘ãªãã€ã¾ã ã¾ã ã”ä½¿ç”¨ã„ãŸã ã‘ã¾ã™ã€‚' }
      ],
      'ã‚„ã‚„å‚·ã‚„æ±šã‚Œã‚ã‚Š': [
        { label: 'ä½¿ç”¨æ„Ÿã‚ã‚Š', text: 'è‹¥å¹²ã®ä½¿ç”¨æ„ŸãŒã‚ã‚Šã¾ã™ãŒã€ç€ç”¨ã«å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚' },
        { label: 'å°ã•ãªæ±šã‚Œ', text: 'ç›®ç«‹ãŸãªã„ç¨‹åº¦ã®å°ã•ãªæ±šã‚ŒãŒã‚ã‚Šã¾ã™ã€‚' },
        { label: 'æ¯›ç‰ã‚ã‚Š', text: 'è‹¥å¹²ã®æ¯›ç‰ãŒã”ã–ã„ã¾ã™ãŒã€ã¾ã ã¾ã ã”ä½¿ç”¨ã„ãŸã ã‘ã¾ã™ã€‚' },
        { label: 'è‰²è¤ªã›ã‚ã‚Š', text: 'è‹¥å¹²ã®è‰²è¤ªã›ãŒã‚ã‚Šã¾ã™ãŒã€ç€ç”¨ã«ã¯å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚' }
      ],
      'å‚·ã‚„æ±šã‚Œã‚ã‚Š': [
        { label: 'ä½¿ç”¨æ„Ÿå¼·ã„', text: 'ä½¿ç”¨æ„ŸãŒå¼·ã‚ã§ã™ãŒã€ã¾ã ã”ä½¿ç”¨ã„ãŸã ã‘ã¾ã™ã€‚' },
        { label: 'æ±šã‚Œã‚ã‚Š', text: 'æ±šã‚ŒãŒã”ã–ã„ã¾ã™ã€‚å†™çœŸã§ã”ç¢ºèªãã ã•ã„ã€‚' },
        { label: 'å‚·ã‚ã‚Š', text: 'å‚·ãŒã”ã–ã„ã¾ã™ã€‚å†™çœŸã§ã”ç¢ºèªãã ã•ã„ã€‚' }
      ],
      'å…¨ä½“çš„ã«çŠ¶æ…‹ãŒæ‚ªã„': [
        { label: 'å…¨ä½“çš„ã«å‚·ã‚ã‚Š', text: 'å…¨ä½“çš„ã«å‚·ã‚„æ±šã‚ŒãŒã‚ã‚Šã¾ã™ã€‚ã”äº†æ‰¿ã®ä¸Šã”è³¼å…¥ãã ã•ã„ã€‚' },
        { label: 'ç›®ç«‹ã¤æ±šã‚Œ', text: 'ç›®ç«‹ã¤æ±šã‚ŒãŒã‚ã‚Šã¾ã™ã€‚å†™çœŸã‚’ã‚ˆãã”ç¢ºèªãã ã•ã„ã€‚' }
      ]
    };

    // åˆæœŸåŒ–
    window.onload = function() {
      loadAllConfig();
      initAiSettingsListeners();
    };

    /**
     * AIè¨­å®šã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’åˆæœŸåŒ–
     */
    function initAiSettingsListeners() {
      // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å¤‰æ›´
      const promptTemplate = document.getElementById('aiPromptTemplate');
      if (promptTemplate) {
        promptTemplate.addEventListener('input', updateAiConfigPreview);
      }

      // ç”Ÿæˆæ–‡å­—æ•°ã®å¤‰æ›´
      const lengthRadios = document.querySelectorAll('input[name="aiLength"]');
      lengthRadios.forEach(radio => {
        radio.addEventListener('change', updateAiConfigPreview);
      });

      // ãƒˆãƒ¼ãƒ³ã®å¤‰æ›´
      const tone = document.getElementById('aiTone');
      if (tone) {
        tone.addEventListener('change', updateAiConfigPreview);
      }

      // Max Tokensã®å¤‰æ›´
      const maxTokens = document.getElementById('aiMaxTokens');
      if (maxTokens) {
        maxTokens.addEventListener('input', updateAiConfigPreview);
      }

      // å«ã‚ã‚‹è¦ç´ ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´
      ['aiIncludeBrand', 'aiIncludeCategory', 'aiIncludeSize', 'aiIncludeMaterial',
       'aiIncludeColor', 'aiIncludeCondition', 'aiIncludeCoordinate', 'aiIncludeScene'].forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox) {
          checkbox.addEventListener('change', updateAiConfigPreview);
        }
      });
    }

    /**
     * å…¨è¨­å®šã‚’èª­ã¿è¾¼ã¿ï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ–¹å¼: localStorageå„ªå…ˆ â†’ PropertiesServiceï¼‰
     */
    function loadAllConfig() {
      console.log('ğŸš€ [è¨­å®šç”»é¢] è¨­å®šèª­ã¿è¾¼ã¿é–‹å§‹ï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ–¹å¼ï¼‰');
      
      // Step 1: ã¾ãšlocalStorageã‹ã‚‰å³åº§ã«èª­ã¿è¾¼ã‚“ã§è¡¨ç¤ºï¼ˆé«˜é€Ÿï¼‰
      try {
        const localConfig = {
          å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³: JSON.parse(localStorage.getItem('rebornConfig_conditionButtons') || '[]'),
          ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°: JSON.parse(localStorage.getItem('rebornConfig_hashtag') || '{}'),
          å‰²å¼•æƒ…å ±: JSON.parse(localStorage.getItem('rebornConfig_discount') || '{}'),
          é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: JSON.parse(localStorage.getItem('rebornConfig_shippingDefault') || '{}'),
          ä»•å…¥å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: JSON.parse(localStorage.getItem('rebornConfig_procureListingDefault') || '{}'),
          ç®¡ç†ç•ªå·è¨­å®š: JSON.parse(localStorage.getItem('rebornConfig_managementNumber') || '{"segments":[]}'),
          ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰: JSON.parse(localStorage.getItem('rebornConfig_salesword') || '{"ã‚ˆãä½¿ã†":[],"è¡¨ç¤ºå½¢å¼":{},"ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ":{}}'),
          AIç”Ÿæˆè¨­å®š: JSON.parse(localStorage.getItem('rebornConfig_aiSettings') || '{}'),
          ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ: localStorage.getItem('rebornTheme') || 'casual'
        };
        
        console.log('âœ… [è¨­å®šç”»é¢] Step 1: localStorageã‹ã‚‰èª­ã¿è¾¼ã¿å®Œäº†:', localConfig);
        currentConfig = localConfig;
        renderAllConfig(localConfig);
        console.log('âœ… [è¨­å®šç”»é¢] localStorageã®è¨­å®šã‚’è¡¨ç¤ºã—ã¾ã—ãŸï¼ˆå³åº§ã«è¡¨ç¤ºï¼‰');
      } catch (e) {
        console.error('âŒ [è¨­å®šç”»é¢] localStorageèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
      }

      // Step 2: Firestoreã‹ã‚‰æœ€æ–°è¨­å®šã‚’å–å¾—ã—ã¦ãƒãƒ¼ã‚¸ï¼ˆPWAç‰ˆï¼‰
      if (window.db) {
        console.log('ğŸ”„ [è¨­å®šç”»é¢] Step 2: Firestoreã‹ã‚‰æœ€æ–°è¨­å®šã‚’å–å¾—ä¸­...');
        window.db.collection('settings').doc('common').get()
          .then((docSnap) => {
            if (docSnap.exists) {
              const firestoreData = docSnap.data();
              console.log('âœ… [è¨­å®šç”»é¢] Firestoreã‹ã‚‰è¨­å®šå–å¾—æˆåŠŸ:', firestoreData);

              // Firestoreã®ãƒ‡ãƒ¼ã‚¿ã§currentConfigã‚’æ›´æ–°
              if (firestoreData.conditionButtons && firestoreData.conditionButtons.length > 0) {
                currentConfig['å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³'] = firestoreData.conditionButtons;
                localStorage.setItem('rebornConfig_conditionButtons', JSON.stringify(firestoreData.conditionButtons));
                renderConditionButtons(firestoreData.conditionButtons);
                console.log('âœ… [è¨­å®šç”»é¢] å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³ã‚’Firestoreã‹ã‚‰èª­ã¿è¾¼ã¿:', firestoreData.conditionButtons.length, 'ä»¶');
              }
              if (firestoreData.hashtag) {
                currentConfig['ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°'] = firestoreData.hashtag;
                localStorage.setItem('rebornConfig_hashtag', JSON.stringify(firestoreData.hashtag));
                renderHashtagConfig(firestoreData.hashtag);
              }
              if (firestoreData.discount) {
                currentConfig['å‰²å¼•æƒ…å ±'] = firestoreData.discount;
                localStorage.setItem('rebornConfig_discount', JSON.stringify(firestoreData.discount));
                renderDiscountConfig(firestoreData.discount);
              }
              if (firestoreData.shippingDefault) {
                currentConfig['é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ'] = firestoreData.shippingDefault;
                localStorage.setItem('rebornConfig_shippingDefault', JSON.stringify(firestoreData.shippingDefault));
                renderShippingDefaults(firestoreData.shippingDefault);
              }
              if (firestoreData.procureListingDefault) {
                currentConfig['ä»•å…¥å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ'] = firestoreData.procureListingDefault;
                localStorage.setItem('rebornConfig_procureListingDefault', JSON.stringify(firestoreData.procureListingDefault));
                renderProcureListingDefaults(firestoreData.procureListingDefault);
              }
              if (firestoreData.salesword) {
                currentConfig['ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰'] = firestoreData.salesword;
                localStorage.setItem('rebornConfig_salesword', JSON.stringify(firestoreData.salesword));
              }
              if (firestoreData.aiSettings) {
                currentConfig['AIç”Ÿæˆè¨­å®š'] = firestoreData.aiSettings;
                localStorage.setItem('rebornConfig_aiSettings', JSON.stringify(firestoreData.aiSettings));
                renderAiSettings(firestoreData.aiSettings);
              }

              console.log('âœ… [è¨­å®šç”»é¢] Firestoreè¨­å®šã‚’ãƒãƒ¼ã‚¸å®Œäº†');
            } else {
              console.log('âš ï¸ [è¨­å®šç”»é¢] Firestore settings/commonãŒå­˜åœ¨ã—ã¾ã›ã‚“');
            }
          })
          .catch((e) => {
            console.error('âŒ [è¨­å®šç”»é¢] Firestoreèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
          });
      } else {
        console.warn('âš ï¸ [è¨­å®šç”»é¢] FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆlocalStorageã®ã¿ä½¿ç”¨ï¼‰');
      }
    }

    /**
     * å…¨è¨­å®šã‚’ç”»é¢ã«åæ˜ 
     */
    function renderAllConfig(config) {
      renderConditionButtons(config.å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³ || []);
      renderHashtagConfig(config.ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚° || {});
      renderDiscountConfig(config.å‰²å¼•æƒ…å ± || {});
      renderShippingDefaults(config.é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ || {});
      renderProcureListingDefaults(config.ä»•å…¥å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ || {});
      renderManagementConfig(config.ç®¡ç†ç•ªå·è¨­å®š || {});
      renderAiSettings(config.AIç”Ÿæˆè¨­å®š || {});

      // ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã‚’èª­ã¿è¾¼ã¿ï¼ˆrenderDesignThemeã®å‰ã«ç§»å‹•ï¼‰
      console.log('ğŸ“‹ [ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰] èª­ã¿è¾¼ã¿é–‹å§‹:', config.ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰);
      if (config.ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰) {
        // æ–°ã—ã„æ§‹é€ ï¼ˆã‚ˆãä½¿ã† + è¡¨ç¤ºå½¢å¼ + ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã«å¯¾å¿œ
        if (typeof config.ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ === 'object' && config.ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰.ã‚ˆãä½¿ã†) {
          console.log('âœ… [ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰] æ–°å½¢å¼ã§èª­ã¿è¾¼ã¿');
          console.log('  - ã‚ˆãä½¿ã†:', config.ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰.ã‚ˆãä½¿ã†);
          console.log('  - è¡¨ç¤ºå½¢å¼:', config.ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰.è¡¨ç¤ºå½¢å¼);
          console.log('  - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ:', config.ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ);
          SALESWORD_LIST = config.ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰.ã‚ˆãä½¿ã† || [];
          renderSaleswordList();
          renderSaleswordFormat(config.ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰.è¡¨ç¤ºå½¢å¼ || {});
          renderDefaultSalesword(config.ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰);
        } else {
          // æ—§å½¢å¼ï¼ˆé…åˆ—ã®ã¿ï¼‰ã«å¯¾å¿œ
          console.log('âš ï¸ [ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰] æ—§å½¢å¼ã§èª­ã¿è¾¼ã¿');
          SALESWORD_LIST = config.ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰;
          renderSaleswordList();
          renderSaleswordFormat({ globalPrefix: 'ã€', globalSuffix: 'ã€‘', categoryOverrides: [] });
        }
      } else {
        console.log('âŒ [ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰] è¨­å®šãŒç©ºã§ã™');
      }

      // ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ¼ãƒï¼ˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
      try {
        renderDesignTheme(config.ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ || 'casual');
      } catch (e) {
        console.error('âŒ [ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ] ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    /**
     * å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³è¨­å®šã‚’è¡¨ç¤º
     */
    function renderConditionButtons(buttons) {
      const container = document.getElementById('conditionButtonsContainer');
      container.innerHTML = '';

      CONDITION_STATES.forEach((state, stateIndex) => {
        const stateButtons = buttons.filter(b => b.å•†å“ã®çŠ¶æ…‹ === state);

        const groupDiv = document.createElement('div');
        groupDiv.style.cssText = 'background: white; margin-bottom: 12px; border-radius: 8px; border: 1px solid #e5e7eb; overflow: hidden;';

        // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é–‹é–‰ï¼‰
        const headerDiv = document.createElement('div');
        headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px; cursor: pointer; background: #f9fafb; transition: background 0.2s;';
        headerDiv.onclick = () => toggleAccordion(stateIndex);
        headerDiv.onmouseover = () => headerDiv.style.background = '#f3f4f6';
        headerDiv.onmouseout = () => headerDiv.style.background = '#f9fafb';

        headerDiv.innerHTML = `
          <strong style="font-size: 14px; color: #1f2937;">${state}</strong>
          <span id="accordion-icon-${stateIndex}" style="font-size: 18px; color: #6b7280; transition: transform 0.3s;">â–¼</span>
        `;
        groupDiv.appendChild(headerDiv);

        // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§éè¡¨ç¤ºï¼‰
        const contentDiv = document.createElement('div');
        contentDiv.id = `accordion-content-${stateIndex}`;
        contentDiv.style.cssText = 'display: none; padding: 12px; border-top: 1px solid #e5e7eb;';

        const buttonsContainer = document.createElement('div');
        buttonsContainer.id = `condition-${state}`;

        stateButtons.forEach((btn, idx) => {
          buttonsContainer.appendChild(createButtonConfigItem(state, idx, btn.ãƒœã‚¿ãƒ³ãƒ©ãƒ™ãƒ«, btn.ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ));
        });

        contentDiv.appendChild(buttonsContainer);

        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'add-btn';
        addBtn.style.cssText = 'width: 100%; margin-top: 8px;';
        addBtn.textContent = '+ ãƒœã‚¿ãƒ³è¿½åŠ ';
        addBtn.onclick = () => addConditionButton(state);
        contentDiv.appendChild(addBtn);

        groupDiv.appendChild(contentDiv);
        container.appendChild(groupDiv);
      });
    }

    /**
     * ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®é–‹é–‰
     */
    function toggleAccordion(index) {
      const content = document.getElementById(`accordion-content-${index}`);
      const icon = document.getElementById(`accordion-icon-${index}`);

      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';

        // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’é–‹ã„ãŸæ™‚ã«å…¨ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ã‚µã‚¤ã‚ºã‚’èª¿æ•´
        setTimeout(() => {
          const textareas = content.querySelectorAll('textarea.auto-resize');
          textareas.forEach(textarea => {
            if (textarea.value) {
              autoResizeTextarea(textarea);
            }
          });
        }, 0);
      } else {
        content.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
      }
    }

    /**
     * ãƒœã‚¿ãƒ³è¨­å®šé …ç›®ã‚’ä½œæˆ
     */
    function createButtonConfigItem(state, index, label, text) {
      const div = document.createElement('div');
      div.className = 'condition-button-item';
      div.style.cssText = 'background: #f9fafb; padding: 10px; margin-bottom: 8px; border-radius: 4px; border: 1px solid #dee2e6;';

      // ãƒ—ãƒªã‚»ãƒƒãƒˆå–å¾—
      const presets = CONDITION_BUTTON_PRESETS[state] || [];

      // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®é¸æŠè‚¢ã‚’ç”Ÿæˆ
      let selectOptions = '<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>';
      presets.forEach(preset => {
        const selected = label === preset.label ? 'selected' : '';
        selectOptions += `<option value="${preset.label}" ${selected}>${preset.label}</option>`;
      });
      selectOptions += '<option value="custom">âœï¸ ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›</option>';

      // ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ã‹ã©ã†ã‹ã‚’åˆ¤å®š
      const isCustom = label && !presets.find(p => p.label === label);
      const selectedValue = isCustom ? 'custom' : (label || '');

      div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
          <strong style="font-size: 13px;">ãƒœã‚¿ãƒ³ ${index + 1}</strong>
          <button type="button" class="btn btn-sm btn-outline-danger remove-btn" onclick="removeConditionButton('${state}', ${index})">å‰Šé™¤</button>
        </div>
        <div class="mb-2">
          <label style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">ãƒœã‚¿ãƒ³ãƒ©ãƒ™ãƒ«</label>
          <select class="form-control label-preset-select" data-state="${state}" data-index="${index}" data-field="label-select" onchange="handleLabelPresetChange(this, '${state}', ${index})" style="font-size: 16px; margin-bottom: 4px; appearance: auto; -webkit-appearance: menulist; -moz-appearance: menulist; background-color: white; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 6px; cursor: pointer;">
            ${selectOptions}
          </select>
          <input type="text" class="form-control label-custom-input" data-state="${state}" data-index="${index}" data-field="label" value="${label || ''}" placeholder="ã‚«ã‚¹ã‚¿ãƒ ãƒ©ãƒ™ãƒ«ã‚’å…¥åŠ›" style="font-size: 16px; display: none;">
        </div>
        <div>
          <label style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ</label>
          <textarea class="form-control auto-resize" rows="2" data-state="${state}" data-index="${index}" data-field="text" placeholder="ã‚¯ãƒªãƒƒã‚¯æ™‚ã«æŒ¿å…¥ã•ã‚Œã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›" style="font-size: 13px; resize: none; overflow: hidden;" oninput="autoResizeTextarea(this)">${text}</textarea>
        </div>
      `;

      // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®å€¤ã‚’è¨­å®š
      setTimeout(() => {
        const select = div.querySelector('[data-field="label-select"]');
        const customInput = div.querySelector('[data-field="label"]');

        if (select) {
          select.value = selectedValue;

          // ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›æ¬„ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ¶å¾¡
          if (selectedValue === 'custom') {
            customInput.style.display = 'block';
          } else {
            customInput.style.display = 'none';
          }
        }

        // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®åˆæœŸã‚µã‚¤ã‚ºèª¿æ•´
        const textarea = div.querySelector('textarea');
        if (textarea && textarea.value) {
          autoResizeTextarea(textarea);
        }
      }, 0);

      return div;
    }

    /**
     * ãƒ©ãƒ™ãƒ«ãƒ—ãƒªã‚»ãƒƒãƒˆå¤‰æ›´æ™‚ã®å‡¦ç†
     */
    function handleLabelPresetChange(selectElement, state, index) {
      const selectedValue = selectElement.value;

      // dataå±æ€§ã‚’ä½¿ã£ã¦åŒã˜state/indexã®è¦ç´ ã‚’ç›´æ¥å–å¾—
      const containerId = `condition-${state}`;
      const container = document.getElementById(containerId);
      const items = container.querySelectorAll('.condition-button-item');
      const targetItem = items[index];

      if (!targetItem) {
        console.error('ãƒœã‚¿ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', { state, index });
        return;
      }

      const labelInput = targetItem.querySelector('[data-field="label"]');
      const textArea = targetItem.querySelector('[data-field="text"]');

      console.log('handleLabelPresetChange:', { selectedValue, state, index, targetItem });

      if (selectedValue === 'custom') {
        // ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ã‚’è¡¨ç¤º
        labelInput.style.display = 'block';
        labelInput.value = '';
        textArea.value = '';
        labelInput.focus();
        setTimeout(() => autoResizeTextarea(textArea), 0);
      } else if (selectedValue === '') {
        // æœªé¸æŠ
        labelInput.style.display = 'none';
        labelInput.value = '';
        textArea.value = '';
        setTimeout(() => autoResizeTextarea(textArea), 0);
      } else {
        // ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠ
        labelInput.style.display = 'none';
        const presets = CONDITION_BUTTON_PRESETS[state] || [];
        const preset = presets.find(p => p.label === selectedValue);
        console.log('ãƒ—ãƒªã‚»ãƒƒãƒˆæ¤œç´¢çµæœ:', preset);
        if (preset) {
          labelInput.value = preset.label;
          textArea.value = preset.text;
          console.log('ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è¨­å®š:', preset.text);
          setTimeout(() => autoResizeTextarea(textArea), 0);
        } else {
          console.warn('ãƒ—ãƒªã‚»ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', selectedValue, state);
        }
      }
    }

    /**
     * å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
     */
    function addConditionButton(state) {
      const container = document.getElementById(`condition-${state}`);
      const index = container.children.length;
      container.appendChild(createButtonConfigItem(state, index, '', ''));
    }

    /**
     * å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
     */
    function removeConditionButton(state, index) {
      const container = document.getElementById(`condition-${state}`);
      if (container.children.length > 1) {
        container.children[index].remove();
        // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å†è¨ˆç®—
        Array.from(container.children).forEach((child, newIndex) => {
          const inputs = child.querySelectorAll('[data-index]');
          inputs.forEach(input => input.setAttribute('data-index', newIndex));
          child.querySelector('strong').textContent = `ãƒœã‚¿ãƒ³ ${newIndex + 1}`;
          child.querySelector('.remove-btn').onclick = () => removeConditionButton(state, newIndex);
        });
      } else {
        alert('æœ€ä½1ã¤ã®ãƒœã‚¿ãƒ³ã¯å¿…è¦ã§ã™');
      }
    }

    /**
     * ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°è¨­å®šã‚’è¡¨ç¤º
     */
    function renderHashtagConfig(config) {
      const container = document.getElementById('hashtagItemsContainer');
      container.innerHTML = '';

      // å…±é€šãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¨­å®š
      const removeHash = (value) => {
        if (!value) return '';
        return value.startsWith('#') ? value.substring(1) : value;
      };

      let commonPrefix = '';
      let hashtags = [];

      if (config.hashtags && Array.isArray(config.hashtags)) {
        // æ–°å½¢å¼: å‹•çš„é…åˆ—
        commonPrefix = removeHash(config.commonPrefix || 'REBORN_');
        hashtags = config.hashtags;
      } else if (config.å…¨å•†å“ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ || config.ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ || config.ã‚«ãƒ†ã‚´ãƒªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹) {
        // æ—§å½¢å¼: å›ºå®š3é …ç›®ã‹ã‚‰å¤‰æ›ï¼ˆæœ€åˆã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å…±é€šã¨ã—ã¦ä½¿ç”¨ï¼‰
        commonPrefix = removeHash(config.å…¨å•†å“ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ || config.ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ || config.ã‚«ãƒ†ã‚´ãƒªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ || 'REBORN_');

        if (config.å…¨å•†å“ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ || config.å…¨å•†å“ãƒ†ã‚­ã‚¹ãƒˆ) {
          hashtags.push({
            title: 'å…¨å•†å“',
            icon: 'ğŸŒ',
            suffix: config.å…¨å•†å“ãƒ†ã‚­ã‚¹ãƒˆ || 'å…¨å•†å“',
            suffixOptions: ['å…¨å•†å“', 'å…¨ã‚¢ã‚¤ãƒ†ãƒ ', 'å•†å“ä¸€è¦§', 'ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§']
          });
        }
        if (config.ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ || config.ãƒ–ãƒ©ãƒ³ãƒ‰ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹) {
          hashtags.push({
            title: 'ãƒ–ãƒ©ãƒ³ãƒ‰',
            icon: 'ğŸ‘”',
            suffix: config.ãƒ–ãƒ©ãƒ³ãƒ‰ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ || 'ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§',
            suffixOptions: ['ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§', 'å•†å“ä¸€è¦§', 'ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³', 'ãƒ–ãƒ©ãƒ³ãƒ‰å•†å“']
          });
        }
        if (config.ã‚«ãƒ†ã‚´ãƒªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ || config.ã‚«ãƒ†ã‚´ãƒªã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹) {
          hashtags.push({
            title: 'ã‚«ãƒ†ã‚´ãƒª',
            icon: 'ğŸ“‚',
            suffix: config.ã‚«ãƒ†ã‚´ãƒªã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ || 'ä¸€è¦§',
            suffixOptions: ['ä¸€è¦§', 'ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§', 'å•†å“ä¸€è¦§', 'ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³']
          });
        }
      }

      // å…±é€šãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¨­å®š
      document.getElementById('commonHashtagPrefix').value = commonPrefix;

      // ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°é …ç›®ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
      hashtags.forEach((item, index) => {
        container.appendChild(createHashtagItem(index, item));
      });

      // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      setupHashtagDragAndDrop();
    }

    /**
     * ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°é …ç›®ã®ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆSortable.jsä½¿ç”¨ï¼‰
     * ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ï¼ˆã‚¹ãƒãƒ›ï¼‰ã§ã‚‚å‹•ä½œã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸ
     */
    function setupHashtagDragAndDrop() {
      const container = document.getElementById('hashtagItemsContainer');

      // Sortable.jsã‚’ä½¿ç”¨ã—ã¦ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚’åˆæœŸåŒ–
      // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã«è‡ªå‹•å¯¾å¿œ
      Sortable.create(container, {
        animation: 150,                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é€Ÿåº¦ï¼ˆãƒŸãƒªç§’ï¼‰
        handle: '.hashtag-drag-handle',    // â‹®â‹® ã‚¢ã‚¤ã‚³ãƒ³ã®ã¿ã§ãƒ‰ãƒ©ãƒƒã‚°
        ghostClass: 'sortable-ghost',      // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦ç´ ã«é©ç”¨ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹
        chosenClass: 'sortable-chosen',    // é¸æŠä¸­ã®è¦ç´ ã«é©ç”¨ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹
        dragClass: 'sortable-drag',        // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦ç´ ã«é©ç”¨ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹
        onEnd: function() {
          // ãƒ‰ãƒ­ãƒƒãƒ—å¾Œã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å†è¨­å®š
          reindexHashtagItems();
        }
      });
    }

    /**
     * ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°é …ç›®ã‚’ä½œæˆ
     */
    function createHashtagItem(index, data = {}) {
      const title = data.title || '';
      const icon = data.icon || 'ğŸ·ï¸';
      const suffix = data.suffix || '';
      const suffixOptions = data.suffixOptions || ['å…¨å•†å“', 'å…¨ã‚¢ã‚¤ãƒ†ãƒ ', 'å•†å“ä¸€è¦§', 'ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§'];

      const div = document.createElement('div');
      div.className = 'hashtag-item';
      div.setAttribute('data-index', index);
      div.setAttribute('draggable', 'true');
      div.style.cssText = 'margin-bottom: 12px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb; cursor: move; transition: all 0.2s;';

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®ä¸­é–“éƒ¨åˆ†ã‚’æ±ºå®šï¼ˆå…·ä½“ä¾‹ã‚’è¡¨ç¤ºï¼‰
      let previewMiddle = '';
      if (title === 'ãƒ–ãƒ©ãƒ³ãƒ‰') {
        previewMiddle = 'UNIQLO';
      } else if (title === 'ã‚«ãƒ†ã‚´ãƒª') {
        // é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªã®å…·ä½“ä¾‹ã‚’è¡¨ç¤º
        const categoryOptions = data.categoryOptions || ['å¤§åˆ†é¡', 'ä¸­åˆ†é¡'];
        const exampleMap = {
          'å¤§åˆ†é¡': 'ãƒ¡ãƒ³ã‚º',
          'ä¸­åˆ†é¡': 'ãƒˆãƒƒãƒ—ã‚¹',
          'å°åˆ†é¡': 'ã‚·ãƒ£ãƒ„',
          'ç´°åˆ†é¡1': 'åŠè¢–ã‚·ãƒ£ãƒ„',
          'ç´°åˆ†é¡2': 'ã‚¢ãƒ­ãƒã‚·ãƒ£ãƒ„ãƒ»ã‹ã‚Šã‚†ã—ã‚¦ã‚§ã‚¢',
          'ã‚¢ã‚¤ãƒ†ãƒ å': 'ã‚¢ãƒ­ãƒã‚·ãƒ£ãƒ„'
        };
        const examples = categoryOptions.map(opt => exampleMap[opt] || opt);
        previewMiddle = examples.join('');
      } else if (title === 'ã‚«ãƒ©ãƒ¼') {
        previewMiddle = 'é»’';
      } else if (title === 'ã‚µã‚¤ã‚º') {
        previewMiddle = 'M';
      }

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ
      const commonPrefix = document.getElementById('commonHashtagPrefix')?.value || 'REBORN_';
      const previewText = `#${commonPrefix}${previewMiddle}${suffixOptions.includes(suffix) ? suffix : (!suffixOptions.includes(suffix) && suffix ? suffix : '')}`;

      // ã‚«ãƒ†ã‚´ãƒªãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã®å ´åˆã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 
      const isCategoryHashtag = title === 'ã‚«ãƒ†ã‚´ãƒª';
      const categoryOptions = data.categoryOptions || ['å¤§åˆ†é¡', 'ä¸­åˆ†é¡'];

      const categoryCheckboxesHtml = isCategoryHashtag ? `
        <div style="margin-bottom: 8px; padding: 8px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
          <div style="font-size: 11px; font-weight: 600; color: #6b7280; margin-bottom: 6px;">é€£çµã™ã‚‹ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰:</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px;">
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
              <input type="checkbox" class="category-option" data-option="å¤§åˆ†é¡" ${categoryOptions.includes('å¤§åˆ†é¡') ? 'checked' : ''} onchange="updateHashtagItemPreview(${index})" style="cursor: pointer;">
              <span>å¤§åˆ†é¡</span>
            </label>
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
              <input type="checkbox" class="category-option" data-option="ä¸­åˆ†é¡" ${categoryOptions.includes('ä¸­åˆ†é¡') ? 'checked' : ''} onchange="updateHashtagItemPreview(${index})" style="cursor: pointer;">
              <span>ä¸­åˆ†é¡</span>
            </label>
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
              <input type="checkbox" class="category-option" data-option="å°åˆ†é¡" ${categoryOptions.includes('å°åˆ†é¡') ? 'checked' : ''} onchange="updateHashtagItemPreview(${index})" style="cursor: pointer;">
              <span>å°åˆ†é¡</span>
            </label>
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
              <input type="checkbox" class="category-option" data-option="ç´°åˆ†é¡1" ${categoryOptions.includes('ç´°åˆ†é¡1') ? 'checked' : ''} onchange="updateHashtagItemPreview(${index})" style="cursor: pointer;">
              <span>ç´°åˆ†é¡1</span>
            </label>
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
              <input type="checkbox" class="category-option" data-option="ç´°åˆ†é¡2" ${categoryOptions.includes('ç´°åˆ†é¡2') ? 'checked' : ''} onchange="updateHashtagItemPreview(${index})" style="cursor: pointer;">
              <span>ç´°åˆ†é¡2</span>
            </label>
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
              <input type="checkbox" class="category-option" data-option="ã‚¢ã‚¤ãƒ†ãƒ å" ${categoryOptions.includes('ã‚¢ã‚¤ãƒ†ãƒ å') ? 'checked' : ''} onchange="updateHashtagItemPreview(${index})" style="cursor: pointer;">
              <span>ã‚¢ã‚¤ãƒ†ãƒ å</span>
            </label>
          </div>
        </div>
      ` : '';

      div.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
          <span class="hashtag-drag-handle" style="font-size: 16px; color: #9ca3af; cursor: grab; user-select: none; flex-shrink: 0;" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ">â‹®â‹®</span>
          <span class="hashtag-icon-display" style="font-size: 18px; user-select: none; flex-shrink: 0;">${icon}</span>
          <input type="hidden" class="hashtag-icon" value="${icon}">
          <input type="hidden" class="hashtag-title" value="${title}">
          <div style="flex: 1; font-size: 14px; font-weight: 600; color: #374151;">${title}</div>
        </div>

        ${categoryCheckboxesHtml}

        <div style="margin-bottom: 8px;">
          <select class="hashtag-suffix-select" style="width: 100%; padding: 6px 8px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 12px; transition: all 0.2s; background: white; cursor: pointer;" onfocus="this.style.borderColor='#3b82f6';" onblur="this.style.borderColor='#d1d5db';" onchange="handleHashtagItemSuffixChange(${index})">
            ${suffixOptions.map(opt => `<option value="${opt}"${opt === suffix ? ' selected' : ''}>${opt}</option>`).join('')}
            <option value="custom"${!suffixOptions.includes(suffix) && suffix ? ' selected' : ''}>ã‚«ã‚¹ã‚¿ãƒ ...</option>
          </select>
          <input type="text" class="hashtag-suffix-custom" value="${!suffixOptions.includes(suffix) && suffix ? suffix : ''}" placeholder="ã‚«ã‚¹ã‚¿ãƒ å€¤ã‚’å…¥åŠ›" style="width: 100%; padding: 6px 8px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 12px; transition: all 0.2s; margin-top: 6px; display: ${!suffixOptions.includes(suffix) && suffix ? 'block' : 'none'};" onfocus="this.style.borderColor='#3b82f6';" onblur="this.style.borderColor='#d1d5db';" oninput="updateHashtagItemPreview(${index})">
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
          <div style="flex: 1;">
            <div style="font-size: 10px; color: #6b7280; margin-bottom: 2px;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</div>
            <div class="hashtag-preview" style="padding: 6px 10px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 11px; color: #1e40af; font-weight: 500;">
              ${previewText}
            </div>
          </div>
          <button type="button" onclick="removeHashtagItem(${index})" style="padding: 4px 8px; background: white; border: 1px solid #ef4444; color: #ef4444; border-radius: 4px; font-size: 10px; cursor: pointer; transition: all 0.2s; white-space: nowrap; flex-shrink: 0;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
            å‰Šé™¤
          </button>
        </div>
      `;

      return div;
    }

    /**
     * ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚¿ã‚¤ãƒ—é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
     */
    function showHashtagTypeSelector() {
      const menu = document.getElementById('hashtagTypeSelectorMenu');
      menu.style.display = 'block';
    }

    /**
     * ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚¿ã‚¤ãƒ—é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’éè¡¨ç¤º
     */
    function hideHashtagTypeSelector() {
      const menu = document.getElementById('hashtagTypeSelectorMenu');
      menu.style.display = 'none';
    }

    /**
     * ã‚¿ã‚¤ãƒ—ã‚’æŒ‡å®šã—ã¦ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°é …ç›®ã‚’è¿½åŠ 
     */
    function addHashtagItemByType(type) {
      const container = document.getElementById('hashtagItemsContainer');
      const index = container.children.length;

      let newItem = {};

      if (type === 'å…¨å•†å“') {
        newItem = {
          title: 'å…¨å•†å“',
          icon: 'ğŸŒ',
          suffix: 'å…¨å•†å“',
          suffixOptions: ['å…¨å•†å“', 'å…¨ã‚¢ã‚¤ãƒ†ãƒ ', 'å•†å“ä¸€è¦§', 'ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§']
        };
      } else if (type === 'ãƒ–ãƒ©ãƒ³ãƒ‰') {
        newItem = {
          title: 'ãƒ–ãƒ©ãƒ³ãƒ‰',
          icon: 'ğŸ‘”',
          suffix: 'ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§',
          suffixOptions: ['ä¸€è¦§', 'ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§', 'å•†å“ä¸€è¦§', 'å…¨å•†å“', 'ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³']
        };
      } else if (type === 'ã‚«ãƒ†ã‚´ãƒª') {
        newItem = {
          title: 'ã‚«ãƒ†ã‚´ãƒª',
          icon: 'ğŸ“',
          suffix: 'ä¸€è¦§',
          suffixOptions: ['ä¸€è¦§', 'ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§', 'å•†å“ä¸€è¦§', 'ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³'],
          categoryOptions: ['å¤§åˆ†é¡']
        };
      } else if (type === 'ã‚«ãƒ©ãƒ¼') {
        newItem = {
          title: 'ã‚«ãƒ©ãƒ¼',
          icon: 'ğŸ¨',
          suffix: 'ä¸€è¦§',
          suffixOptions: ['ä¸€è¦§', 'ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§', 'å•†å“ä¸€è¦§', 'ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³']
        };
      } else if (type === 'ã‚µã‚¤ã‚º') {
        newItem = {
          title: 'ã‚µã‚¤ã‚º',
          icon: 'ğŸ“',
          suffix: 'ä¸€è¦§',
          suffixOptions: ['ä¸€è¦§', 'ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§', 'å•†å“ä¸€è¦§', 'ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³']
        };
      }

      container.appendChild(createHashtagItem(index, newItem));
      hideHashtagTypeSelector();
    }

    /**
     * ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°é …ç›®ã‚’è¿½åŠ ï¼ˆæ—§é–¢æ•°ãƒ»äº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
     */
    function addHashtagItem() {
      showHashtagTypeSelector();
    }

    /**
     * ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°é …ç›®ã‚’å‰Šé™¤
     */
    function removeHashtagItem(index) {
      const container = document.getElementById('hashtagItemsContainer');

      // é …ç›®ã‚’å‰Šé™¤
      if (container.children[index]) {
        container.children[index].remove();
      }

      // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å†å‰²ã‚Šå½“ã¦
      Array.from(container.children).forEach((item, newIndex) => {
        item.setAttribute('data-index', newIndex);

        // å„ãƒœã‚¿ãƒ³ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
        const deleteBtn = item.querySelector('button[onclick*="removeHashtagItem"]');
        if (deleteBtn) {
          deleteBtn.setAttribute('onclick', `removeHashtagItem(${newIndex})`);
        }

        const suffixSelect = item.querySelector('.hashtag-suffix-select');
        if (suffixSelect) {
          suffixSelect.setAttribute('onchange', `handleHashtagItemSuffixChange(${newIndex})`);
        }

        const suffixCustom = item.querySelector('.hashtag-suffix-custom');
        if (suffixCustom) {
          suffixCustom.setAttribute('oninput', `updateHashtagItemPreview(${newIndex})`);
        }
      });
    }

    /**
     * ã™ã¹ã¦ã®ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ã‚¯ãƒªã‚¢
     */
    function clearAllHashtags() {
      if (!confirm('ã™ã¹ã¦ã®ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        return;
      }

      const container = document.getElementById('hashtagItemsContainer');
      container.innerHTML = '';

      alert('ã™ã¹ã¦ã®ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚\nå¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
    }

    /**
     * ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°é …ç›®ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å†å‰²ã‚Šå½“ã¦
     */
    function reindexHashtagItems() {
      const container = document.getElementById('hashtagItemsContainer');
      Array.from(container.children).forEach((item, newIndex) => {
        item.setAttribute('data-index', newIndex);

        const deleteBtn = item.querySelector('button[onclick*="removeHashtagItem"]');
        if (deleteBtn) {
          deleteBtn.setAttribute('onclick', `removeHashtagItem(${newIndex})`);
        }

        const suffixSelect = item.querySelector('.hashtag-suffix-select');
        if (suffixSelect) {
          suffixSelect.setAttribute('onchange', `handleHashtagItemSuffixChange(${newIndex})`);
        }

        const suffixCustom = item.querySelector('.hashtag-suffix-custom');
        if (suffixCustom) {
          suffixCustom.setAttribute('oninput', `updateHashtagItemPreview(${newIndex})`);
        }

        const categoryOptions = item.querySelectorAll('.category-option');
        categoryOptions.forEach(checkbox => {
          checkbox.setAttribute('onchange', `updateHashtagItemPreview(${newIndex})`);
        });
      });
    }

    /**
     * ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°é …ç›®ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
     */
    function updateHashtagItemPreview(index) {
      const container = document.getElementById('hashtagItemsContainer');
      const item = container.children[index];
      if (!item) return;

      const commonPrefix = document.getElementById('commonHashtagPrefix').value || '';
      const titleInput = item.querySelector('.hashtag-title');
      const title = titleInput ? titleInput.value || '' : '';
      const suffixSelect = item.querySelector('.hashtag-suffix-select');
      const suffixCustom = item.querySelector('.hashtag-suffix-custom');

      let suffix = '';
      if (suffixSelect.value === 'custom') {
        suffix = suffixCustom.value || '';
      } else {
        suffix = suffixSelect.value || '';
      }

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®ä¸­é–“éƒ¨åˆ†ã‚’æ±ºå®šï¼ˆå…·ä½“ä¾‹ã‚’è¡¨ç¤ºï¼‰
      let previewMiddle = '';
      if (title === 'ãƒ–ãƒ©ãƒ³ãƒ‰') {
        previewMiddle = 'UNIQLO';
      } else if (title === 'ã‚«ãƒ†ã‚´ãƒª') {
        // é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å…·ä½“ä¾‹ã‚’è¡¨ç¤º
        const categoryCheckboxes = item.querySelectorAll('.category-option:checked');
        const selectedCategories = Array.from(categoryCheckboxes).map(cb => cb.getAttribute('data-option'));
        const exampleMap = {
          'å¤§åˆ†é¡': 'ãƒ¡ãƒ³ã‚º',
          'ä¸­åˆ†é¡': 'ãƒˆãƒƒãƒ—ã‚¹',
          'å°åˆ†é¡': 'ã‚·ãƒ£ãƒ„',
          'ç´°åˆ†é¡1': 'åŠè¢–ã‚·ãƒ£ãƒ„',
          'ç´°åˆ†é¡2': 'ã‚¢ãƒ­ãƒã‚·ãƒ£ãƒ„ãƒ»ã‹ã‚Šã‚†ã—ã‚¦ã‚§ã‚¢',
          'ã‚¢ã‚¤ãƒ†ãƒ å': 'ã‚¢ãƒ­ãƒã‚·ãƒ£ãƒ„'
        };
        const examples = selectedCategories.map(opt => exampleMap[opt] || opt);
        previewMiddle = examples.length > 0 ? examples.join('') : 'ã‚«ãƒ†ã‚´ãƒª';
      } else if (title === 'ã‚«ãƒ©ãƒ¼') {
        previewMiddle = 'é»’';
      } else if (title === 'ã‚µã‚¤ã‚º') {
        previewMiddle = 'M';
      }

      const preview = `#${commonPrefix}${previewMiddle}${suffix}`;
      const previewDiv = item.querySelector('.hashtag-preview');
      if (previewDiv) {
        previewDiv.textContent = preview;
      }
    }

    /**
     * ã™ã¹ã¦ã®ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
     */
    function updateAllHashtagPreviews() {
      const container = document.getElementById('hashtagItemsContainer');
      for (let i = 0; i < container.children.length; i++) {
        updateHashtagItemPreview(i);
      }
    }

    /**
     * ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°é …ç›®ã®ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹å¤‰æ›´å‡¦ç†
     */
    function handleHashtagItemSuffixChange(index) {
      const container = document.getElementById('hashtagItemsContainer');
      const item = container.children[index];
      if (!item) return;

      const suffixSelect = item.querySelector('.hashtag-suffix-select');
      const suffixCustom = item.querySelector('.hashtag-suffix-custom');

      if (suffixSelect.value === 'custom') {
        suffixCustom.style.display = 'block';
        suffixCustom.focus();
      } else {
        suffixCustom.style.display = 'none';
        suffixCustom.value = '';
      }

      updateHashtagItemPreview(index);
    }


    /**
     * ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆé¸æŠè‚¢ã¨ã‚«ã‚¹ã‚¿ãƒ å€¤ã®å‡¦ç†ï¼‰
     */
    function setupHashtagSuffix(type, value, options) {
      const selectId = type === 'å…¨å•†å“' ? 'å…¨å•†å“ãƒ†ã‚­ã‚¹ãƒˆ_select' : `${type}ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹_select`;
      const inputId = type === 'å…¨å•†å“' ? 'å…¨å•†å“ãƒ†ã‚­ã‚¹ãƒˆ' : `${type}ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹`;

      const select = document.getElementById(selectId);
      const input = document.getElementById(inputId);

      if (options.includes(value)) {
        // ãƒ—ãƒªã‚»ãƒƒãƒˆå€¤ã®å ´åˆ
        select.value = value;
        input.style.display = 'none';
        input.value = '';
      } else {
        // ã‚«ã‚¹ã‚¿ãƒ å€¤ã®å ´åˆ
        select.value = 'custom';
        input.style.display = 'block';
        input.value = value;
      }
    }

    /**
     * ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
     */
    function updateHashtagPreview(type) {
      const prefixId = type === 'å…¨å•†å“' ? 'å…¨å•†å“ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹' : `${type}ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹`;
      const selectId = type === 'å…¨å•†å“' ? 'å…¨å•†å“ãƒ†ã‚­ã‚¹ãƒˆ_select' : `${type}ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹_select`;
      const inputId = type === 'å…¨å•†å“' ? 'å…¨å•†å“ãƒ†ã‚­ã‚¹ãƒˆ' : `${type}ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹`;
      const previewId = `${type}ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼`;

      const prefix = document.getElementById(prefixId).value || '';
      const select = document.getElementById(selectId);
      const input = document.getElementById(inputId);

      let suffix = '';
      if (select.value === 'custom') {
        suffix = input.value || '';
      } else {
        suffix = select.value || '';
      }

      // ãƒ–ãƒ©ãƒ³ãƒ‰ã®å ´åˆã¯ä¾‹ã¨ã—ã¦UNIQLOã‚’è¡¨ç¤º
      const middlePart = type === 'ãƒ–ãƒ©ãƒ³ãƒ‰' ? 'UNIQLO' : (type === 'ã‚«ãƒ†ã‚´ãƒª' ? 'ãƒˆãƒƒãƒ—ã‚¹' : '');

      const preview = `#${prefix}${middlePart}${suffix}`;
      document.getElementById(previewId).textContent = preview;
    }

    /**
     * ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹å¤‰æ›´å‡¦ç†
     */
    function handleHashtagSuffixChange(type) {
      const selectId = type === 'å…¨å•†å“' ? 'å…¨å•†å“ãƒ†ã‚­ã‚¹ãƒˆ_select' : `${type}ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹_select`;
      const inputId = type === 'å…¨å•†å“' ? 'å…¨å•†å“ãƒ†ã‚­ã‚¹ãƒˆ' : `${type}ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹`;

      const select = document.getElementById(selectId);
      const input = document.getElementById(inputId);

      if (select.value === 'custom') {
        input.style.display = 'block';
        input.focus();
      } else {
        input.style.display = 'none';
        input.value = '';
      }

      updateHashtagPreview(type);
    }

    // å‰²å¼•ã‚¿ã‚¤ãƒ—ã®ã‚¢ã‚¤ã‚³ãƒ³ãƒãƒƒãƒ”ãƒ³ã‚°
    const DISCOUNT_ICONS = {
      'ãƒ•ã‚©ãƒ­ãƒ¼å‰²': 'ğŸ‘¥',
      'ãƒªãƒ”ãƒ¼ãƒˆå‰²': 'ğŸ”„',
      'ã¾ã¨ã‚å‰²': 'ğŸ“¦',
      'å­¦å‰²': 'ğŸ“',
      'ã‚»ãƒƒãƒˆå‰²': 'ğŸ',
      'ã‚¯ãƒ¼ãƒãƒ³å‰²': 'ğŸ«',
      'æ–°è¦ä¼šå“¡å‰²': 'âœ¨',
      'æœŸé–“é™å®šå‰²': 'â°'
    };

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‰²å¼•ã‚¿ã‚¤ãƒ—
    const DEFAULT_DISCOUNT_TYPES = ['ãƒ•ã‚©ãƒ­ãƒ¼å‰²', 'ãƒªãƒ”ãƒ¼ãƒˆå‰²', 'ã¾ã¨ã‚å‰²'];

    /**
     * å‰²å¼•ã‚¿ã‚¤ãƒ—ã‚’è¿½åŠ 
     */
    function addDiscountType() {
      const typesList = document.getElementById('discountTypesList');

      // ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠUI
      const selectorDiv = document.createElement('div');
      selectorDiv.style.cssText = 'background: white; padding: 12px; margin-bottom: 16px; border-radius: 8px; border: 2px solid #3b82f6;';
      selectorDiv.innerHTML = `
        <div style="margin-bottom: 8px; font-size: 13px; font-weight: 600; color: #374151;">å‰²å¼•ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ</div>
        <select id="newDiscountTypeSelect" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 8px; font-size: 16px;">
          <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
          <option value="ãƒ•ã‚©ãƒ­ãƒ¼å‰²">ğŸ‘¥ ãƒ•ã‚©ãƒ­ãƒ¼å‰²</option>
          <option value="ãƒªãƒ”ãƒ¼ãƒˆå‰²">ğŸ”„ ãƒªãƒ”ãƒ¼ãƒˆå‰²</option>
          <option value="ã¾ã¨ã‚å‰²">ğŸ“¦ ã¾ã¨ã‚å‰²</option>
          <option value="å­¦å‰²">ğŸ“ å­¦å‰²</option>
          <option value="ã‚»ãƒƒãƒˆå‰²">ğŸ ã‚»ãƒƒãƒˆå‰²</option>
          <option value="ã‚¯ãƒ¼ãƒãƒ³å‰²">ğŸ« ã‚¯ãƒ¼ãƒãƒ³å‰²</option>
          <option value="æ–°è¦ä¼šå“¡å‰²">âœ¨ æ–°è¦ä¼šå“¡å‰²</option>
          <option value="æœŸé–“é™å®šå‰²">â° æœŸé–“é™å®šå‰²</option>
          <option value="custom">âœï¸ ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›</option>
        </select>
        <input type="text" id="newDiscountTypeCustom" placeholder="ã‚«ã‚¹ã‚¿ãƒ å‰²å¼•åã‚’å…¥åŠ›ï¼ˆä¾‹: èª•ç”Ÿæ—¥å‰²ï¼‰" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 8px; font-size: 16px; display: none;">
        <input type="text" id="newDiscountTypeIcon" placeholder="ã‚¢ã‚¤ã‚³ãƒ³ã‚’å…¥åŠ›ï¼ˆä¾‹: ğŸ‚ï¼‰" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 8px; font-size: 16px; display: none;">
        <div style="display: flex; gap: 8px;">
          <button type="button" onclick="confirmAddDiscountType()" style="flex: 1; padding: 8px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">è¿½åŠ </button>
          <button type="button" onclick="cancelAddDiscountType()" style="flex: 1; padding: 8px; background: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 13px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      `;

      typesList.appendChild(selectorDiv);

      // ã‚»ãƒ¬ã‚¯ãƒˆå¤‰æ›´æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
      document.getElementById('newDiscountTypeSelect').addEventListener('change', function() {
        const customInput = document.getElementById('newDiscountTypeCustom');
        const iconInput = document.getElementById('newDiscountTypeIcon');
        if (this.value === 'custom') {
          customInput.style.display = 'block';
          iconInput.style.display = 'block';
        } else {
          customInput.style.display = 'none';
          iconInput.style.display = 'none';
        }
      });
    }

    /**
     * å‰²å¼•ã‚¿ã‚¤ãƒ—è¿½åŠ ã‚’ç¢ºå®š
     */
    function confirmAddDiscountType() {
      const select = document.getElementById('newDiscountTypeSelect');
      const customInput = document.getElementById('newDiscountTypeCustom');
      const iconInput = document.getElementById('newDiscountTypeIcon');

      let typeName, icon;

      if (select.value === 'custom') {
        typeName = customInput.value.trim();
        icon = iconInput.value.trim() || 'ğŸ’°';
        if (!typeName) {
          alert('å‰²å¼•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
      } else if (select.value) {
        typeName = select.value;
        icon = DISCOUNT_ICONS[typeName] || 'ğŸ’°';
      } else {
        alert('å‰²å¼•ã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      // æ—¢å­˜ãƒã‚§ãƒƒã‚¯
      if (document.getElementById(`${typeName}Group`)) {
        alert('åŒã˜åå‰ã®å‰²å¼•ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™');
        return;
      }

      // é¸æŠUIã‚’å‰Šé™¤
      cancelAddDiscountType();

      // æ–°ã—ã„å‰²å¼•ã‚¿ã‚¤ãƒ—ã‚’ä½œæˆ
      createDiscountTypeBlock(typeName, icon);

      updateDiscountPreview();
    }

    /**
     * å‰²å¼•ã‚¿ã‚¤ãƒ—è¿½åŠ ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
     */
    function cancelAddDiscountType() {
      const typesList = document.getElementById('discountTypesList');
      const selector = typesList.querySelector('[id="newDiscountTypeSelect"]')?.closest('div');
      if (selector) {
        selector.remove();
      }
    }

    /**
     * å‰²å¼•ã‚¿ã‚¤ãƒ—ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½œæˆ
     */
    function createDiscountTypeBlock(typeName, icon, ranges = [], description = '') {
      const typesList = document.getElementById('discountTypesList');

      const groupDiv = document.createElement('div');
      groupDiv.id = `${typeName}Group`;
      groupDiv.className = 'discount-group';

      groupDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <strong style="font-size: 14px; color: #1f2937;">${icon} ${typeName}</strong>
          <button type="button" onclick="removeDiscountType('${typeName}')" style="padding: 4px 12px; background: white; color: #ef4444; border: 1px solid #ef4444; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">å‰Šé™¤</button>
        </div>
        <div id="${typeName}Container">
          <!-- å‹•çš„ã«ç”Ÿæˆ -->
        </div>
        <button type="button" class="btn btn-sm btn-primary add-btn" onclick="addDiscountRange('${typeName}')" style="width: 100%; margin-bottom: 12px;">+ ç¯„å›²è¿½åŠ </button>
        <div>
          <label class="form-label" style="font-size: 12px;">èª¬æ˜æ–‡ï¼ˆä»»æ„ï¼‰</label>
          <textarea class="form-control auto-resize" id="${typeName}_èª¬æ˜æ–‡" placeholder="èª¬æ˜æ–‡ã‚’å…¥åŠ›" style="font-size: 16px; resize: none; overflow: hidden; min-height: 100px;" oninput="autoResizeTextarea(this); updateDiscountPreview();">${description}</textarea>
        </div>
      `;

      typesList.appendChild(groupDiv);

      const container = document.getElementById(`${typeName}Container`);
      ranges.forEach((range, idx) => {
        container.appendChild(createDiscountRangeItem(typeName, idx, range.ç¯„å›², range.å‰²å¼•é¡));
      });

      // èª¬æ˜æ–‡textareaã®åˆæœŸã‚µã‚¤ã‚ºèª¿æ•´
      setTimeout(() => {
        const textarea = document.getElementById(`${typeName}_èª¬æ˜æ–‡`);
        if (textarea && textarea.value) {
          autoResizeTextarea(textarea);
        }
      }, 0);
    }

    /**
     * å‰²å¼•ã‚¿ã‚¤ãƒ—ã‚’å‰Šé™¤
     */
    function removeDiscountType(typeName) {
      if (!confirm(`ã€Œ${typeName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }

      const group = document.getElementById(`${typeName}Group`);
      if (group) {
        group.remove();
      }

      updateDiscountPreview();
    }

    /**
     * å‰²å¼•æƒ…å ±è¨­å®šã‚’è¡¨ç¤º
     */
    function renderDiscountConfig(config) {
      // ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨­å®š
      const select = document.getElementById('å‰²å¼•æƒ…å ±ã‚¿ã‚¤ãƒˆãƒ«é¸æŠ');
      const customInput = document.getElementById('å‰²å¼•æƒ…å ±ã‚¿ã‚¤ãƒˆãƒ«ã‚«ã‚¹ã‚¿ãƒ ');

      if (select) {
        const titleSelection = config['ã‚¿ã‚¤ãƒˆãƒ«é¸æŠ'] || config['ã‚¿ã‚¤ãƒˆãƒ«'] || 'ã€ãŠå¾—ãªå‰²å¼•æƒ…å ±ã€‘';

        // ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ã®å ´åˆ
        if (titleSelection === 'custom') {
          select.value = 'custom';
          customInput.value = config['ã‚¿ã‚¤ãƒˆãƒ«'] || '';
          customInput.style.display = 'block';
        } else {
          // ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠã®å ´åˆ
          select.value = titleSelection;
          customInput.style.display = 'none';
        }
      }

      // æ—¢å­˜ã®å‰²å¼•ã‚¿ã‚¤ãƒ—ã‚’ã‚¯ãƒªã‚¢
      const typesList = document.getElementById('discountTypesList');
      typesList.innerHTML = '';

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèª¬æ˜æ–‡
      const defaultDescriptions = {
        'ãƒ•ã‚©ãƒ­ãƒ¼å‰²': '',
        'ãƒªãƒ”ãƒ¼ãƒˆå‰²': 'ã€Œãƒªãƒ”ãƒ¼ãƒˆå‰²å¸Œæœ›ã€ã¨ã‚³ãƒ¡ãƒ³ãƒˆã«ã¦ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚',
        'ã¾ã¨ã‚å‰²': 'è³¼å…¥ã—ãŸã„å•†å“ãŒè¤‡æ•°ã‚ã‚‹å ´åˆã€ã‚³ãƒ¡ãƒ³ãƒˆã«ã¦ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚'
      };

      // è¨­å®šã‹ã‚‰å‰²å¼•ã‚¿ã‚¤ãƒ—ã‚’å–å¾—ï¼ˆä¿å­˜ã•ã‚Œã¦ã„ã‚‹é †åºã‚’ç¶­æŒï¼‰
      const savedTypes = config['å‰²å¼•ã‚¿ã‚¤ãƒ—é †åº'] || DEFAULT_DISCOUNT_TYPES;

      savedTypes.forEach(typeName => {
        const ranges = config[typeName] || [];
        const description = config[`${typeName}_èª¬æ˜æ–‡`] || defaultDescriptions[typeName] || '';
        const icon = config[`${typeName}_ã‚¢ã‚¤ã‚³ãƒ³`] || DISCOUNT_ICONS[typeName] || 'ğŸ’°';

        createDiscountTypeBlock(typeName, icon, ranges, description);
      });

      // å…¨ã¦ã®å‰²å¼•ã‚¿ã‚¤ãƒ—ä½œæˆå¾Œã€èª¬æ˜æ–‡ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ã‚µã‚¤ã‚ºã‚’èª¿æ•´
      setTimeout(() => {
        const textareas = typesList.querySelectorAll('textarea.auto-resize');
        textareas.forEach(textarea => {
          if (textarea.value) {
            autoResizeTextarea(textarea);
          }
        });
      }, 100);

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
      updateDiscountPreview();
    }

    /**
     * å‰²å¼•ç¯„å›²é …ç›®ã‚’ä½œæˆ
     */
    function createDiscountRangeItem(type, index, range, amount) {
      const div = document.createElement('div');
      div.className = 'discount-range-item';
      div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
          <strong style="font-size: 13px;">ç¯„å›² ${index + 1}</strong>
          <button type="button" class="btn btn-sm btn-outline-danger remove-btn" onclick="removeDiscountRange('${type}', ${index})">å‰Šé™¤</button>
        </div>
        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
          <div style="writing-mode: vertical-rl; font-size: 9px; font-weight: 600; color: #6b7280; display: flex; align-items: center; justify-content: center; padding: 4px 2px; background: #f3f4f6; border-radius: 4px;">ç¯„å›²</div>
          <input type="text" class="form-control" data-discount="${type}" data-index="${index}" data-field="range" value="${range}" placeholder="ç©ºæ¬„å¯ï¼ˆä¾‹: ã€œ2,999å††ï¼‰" style="flex: 1;" oninput="updateDiscountPreview()">
        </div>
        <div style="display: flex; gap: 8px;">
          <div style="writing-mode: vertical-rl; font-size: 9px; font-weight: 600; color: #6b7280; display: flex; align-items: center; justify-content: center; padding: 4px 2px; background: #f3f4f6; border-radius: 4px;">å‰²å¼•</div>
          <input type="text" class="form-control" data-discount="${type}" data-index="${index}" data-field="amount" value="${amount}" placeholder="100å††å¼•" style="flex: 1;" oninput="updateDiscountPreview()">
        </div>
      `;
      return div;
    }

    /**
     * å‰²å¼•ç¯„å›²ã‚’è¿½åŠ 
     */
    function addDiscountRange(type) {
      const container = document.getElementById(`${type}Container`);
      const index = container.children.length;
      container.appendChild(createDiscountRangeItem(type, index, '', ''));
      updateDiscountPreview();
    }

    /**
     * å‰²å¼•ç¯„å›²ã‚’å‰Šé™¤
     */
    function removeDiscountRange(type, index) {
      const container = document.getElementById(`${type}Container`);
      if (container.children.length > 1) {
        container.children[index].remove();
        // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å†è¨ˆç®—
        Array.from(container.children).forEach((child, newIndex) => {
          const inputs = child.querySelectorAll('[data-index]');
          inputs.forEach(input => input.setAttribute('data-index', newIndex));
          child.querySelector('strong').textContent = `ç¯„å›² ${newIndex + 1}`;
          child.querySelector('.remove-btn').onclick = () => removeDiscountRange(type, newIndex);
        });
        updateDiscountPreview();
      } else {
        alert('æœ€ä½1ã¤ã®ç¯„å›²ã¯å¿…è¦ã§ã™');
      }
    }

    /**
     * å‰²å¼•æƒ…å ±ã‚¿ã‚¤ãƒˆãƒ«ã®å¤‰æ›´ã‚’å‡¦ç†
     */
    function handleDiscountTitleChange() {
      const select = document.getElementById('å‰²å¼•æƒ…å ±ã‚¿ã‚¤ãƒˆãƒ«é¸æŠ');
      const customInput = document.getElementById('å‰²å¼•æƒ…å ±ã‚¿ã‚¤ãƒˆãƒ«ã‚«ã‚¹ã‚¿ãƒ ');

      if (select.value === 'custom') {
        customInput.style.display = 'block';
        customInput.focus();
      } else {
        customInput.style.display = 'none';
      }

      updateDiscountPreview();
    }

    /**
     * å‰²å¼•æƒ…å ±ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
     */
    function updateDiscountPreview() {
      const preview = document.getElementById('discountPreview');
      if (!preview) return;

      const select = document.getElementById('å‰²å¼•æƒ…å ±ã‚¿ã‚¤ãƒˆãƒ«é¸æŠ');
      const customInput = document.getElementById('å‰²å¼•æƒ…å ±ã‚¿ã‚¤ãƒˆãƒ«ã‚«ã‚¹ã‚¿ãƒ ');
      const title = select?.value === 'custom' ? customInput?.value : select?.value || 'ã€ãŠå¾—ãªå‰²å¼•æƒ…å ±ã€‘';
      const discountConfig = collectDiscountConfig();
      let previewText = title ? title + '\n\n' : '';

      // ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å…¨ã¦ã®å‰²å¼•ã‚¿ã‚¤ãƒ—ã‚’å‡¦ç†
      const typesList = document.getElementById('discountTypesList');
      const discountGroups = typesList?.querySelectorAll('.discount-group') || [];

      discountGroups.forEach(group => {
        const typeName = group.id.replace('Group', '');
        const ranges = discountConfig[typeName] || [];

        if (ranges.length > 0) {
          previewText += `â–  ${typeName}\n`;
          ranges.forEach(item => {
            // ç¯„å›²ãŒç©ºæ¬„ã®å ´åˆã¯å‰²å¼•é¡ã®ã¿è¡¨ç¤º
            if (item.ç¯„å›²) {
              previewText += `${item.ç¯„å›²} â‡’ ${item.å‰²å¼•é¡}\n`;
            } else {
              previewText += `${item.å‰²å¼•é¡}\n`;
            }
          });
          const desc = document.getElementById(`${typeName}_èª¬æ˜æ–‡`)?.value;
          if (desc) previewText += desc + '\n';
          previewText += '\n';
        }
      });

      preview.textContent = previewText.trim() || 'å‰²å¼•æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
    }

    /**
     * å‰²å¼•è¨­å®šã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢
     */
    function clearAllDiscounts() {
      if (!confirm('ã™ã¹ã¦ã®å‰²å¼•è¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      // ã‚¿ã‚¤ãƒˆãƒ«ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
      const select = document.getElementById('å‰²å¼•æƒ…å ±ã‚¿ã‚¤ãƒˆãƒ«é¸æŠ');
      const customInput = document.getElementById('å‰²å¼•æƒ…å ±ã‚¿ã‚¤ãƒˆãƒ«ã‚«ã‚¹ã‚¿ãƒ ');
      if (select) {
        select.value = 'ã€ãŠå¾—ãªå‰²å¼•æƒ…å ±ã€‘';
      }
      if (customInput) {
        customInput.value = '';
        customInput.style.display = 'none';
      }

      // ã™ã¹ã¦ã®å‰²å¼•ã‚¿ã‚¤ãƒ—ã‚’å‰Šé™¤
      const typesList = document.getElementById('discountTypesList');
      if (typesList) {
        typesList.innerHTML = '';
      }

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
      updateDiscountPreview();
    }

    /**
     * é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢
     */
    function clearShippingDefaults() {
      if (!confirm('é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      // ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç©ºæ¬„ã«æˆ»ã™
      document.getElementById('é…é€æ–™ã®è² æ‹…').value = '';
      document.getElementById('é…é€ã®æ–¹æ³•').value = '';
      document.getElementById('ç™ºé€å…ƒã®åœ°åŸŸ').value = '';
      document.getElementById('ç™ºé€ã¾ã§ã®æ—¥æ•°').value = '';
      document.getElementById('æ¢±åŒ…è³‡æãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ').value = '';

      alert('é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚\nå¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã€Œè¨­å®šã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
    }

    /**
     * é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’è¡¨ç¤º
     */
    function renderShippingDefaults(config) {
      document.getElementById('é…é€æ–™ã®è² æ‹…').value = config.é…é€æ–™ã®è² æ‹… || 'é€æ–™è¾¼ã¿(å‡ºå“è€…è² æ‹…)';
      document.getElementById('é…é€ã®æ–¹æ³•').value = config.é…é€ã®æ–¹æ³• || 'ã‚†ã†ã‚†ã†ãƒ¡ãƒ«ã‚«ãƒªä¾¿';
      document.getElementById('ç™ºé€å…ƒã®åœ°åŸŸ').value = config.ç™ºé€å…ƒã®åœ°åŸŸ || 'å²¡å±±çœŒ';
      document.getElementById('ç™ºé€ã¾ã§ã®æ—¥æ•°').value = config.ç™ºé€ã¾ã§ã®æ—¥æ•° || '1~2æ—¥ã§ç™ºé€';
      document.getElementById('æ¢±åŒ…è³‡æãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ').value = config.æ¢±åŒ…è³‡æãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ || '';
    }

    /**
     * ç®¡ç†ç•ªå·è¨­å®šã‚’è¡¨ç¤º
     */
    function renderManagementConfig(config) {
      // æ–°ã—ã„ç®¡ç†ç•ªå·ãƒ“ãƒ«ãƒ€ãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
      if (typeof ManagementNumberBuilder !== 'undefined' && config.segments) {
        ManagementNumberBuilder.setData(config);
      }

      // é…ç½®è¨­å®šã‚’å•†å“ç™»éŒ²ç”»é¢ç”¨ã®localStorageã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆå„ªå…ˆï¼‰
      let placementConfig = {
        showInTitle: false,
        showInDescription: false,
        titleFormat: 'ã€ã€‘',
        titlePosition: 'end'
      };

      // ã¾ãšã€å•†å“ç™»éŒ²ç”»é¢ç”¨ã®managementNumberPlacementã‹ã‚‰èª­ã¿è¾¼ã‚€
      try {
        const savedPlacement = localStorage.getItem('managementNumberPlacement');
        if (savedPlacement) {
          const parsed = JSON.parse(savedPlacement);
          placementConfig = {
            showInTitle: parsed.inTitle !== undefined ? parsed.inTitle : false,
            showInDescription: parsed.inDesc !== undefined ? parsed.inDesc : false,
            titleFormat: parsed.format || 'ã€ã€‘',
            titlePosition: parsed.position || 'end'
          };
          console.log('ğŸ“¦ managementNumberPlacementã‹ã‚‰èª­ã¿è¾¼ã¿:', placementConfig);
        } else {
          // managementNumberPlacementãŒãªã„å ´åˆã€rebornConfig_managementNumberã‹ã‚‰èª­ã¿è¾¼ã‚€
          const savedConfig = localStorage.getItem(CONFIG_STORAGE_KEYS.MANAGEMENT_NUMBER);
          if (savedConfig) {
            const parsedConfig = JSON.parse(savedConfig);
            placementConfig = {
              showInTitle: parsedConfig.showInTitle !== undefined ? parsedConfig.showInTitle : false,
              showInDescription: parsedConfig.showInDescription !== undefined ? parsedConfig.showInDescription : false,
              titleFormat: parsedConfig.titleFormat || 'ã€ã€‘',
              titlePosition: parsedConfig.titlePosition || 'end'
            };
            console.log('ğŸ“¦ rebornConfig_managementNumberã‹ã‚‰èª­ã¿è¾¼ã¿:', placementConfig);
          }
        }
      } catch (e) {
        console.error('localStorageèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
      }

      // PropertiesServiceã‹ã‚‰èª­ã¿è¾¼ã¾ã‚ŒãŸå€¤ãŒã‚ã‚Œã°ã€ãã‚Œã§ä¸Šæ›¸ã
      if (config.showInTitle !== undefined) {
        placementConfig.showInTitle = config.showInTitle;
      }
      if (config.showInDescription !== undefined) {
        placementConfig.showInDescription = config.showInDescription;
      }
      if (config.titleFormat !== undefined) {
        placementConfig.titleFormat = config.titleFormat;
      }
      if (config.titlePosition !== undefined) {
        placementConfig.titlePosition = config.titlePosition;
      }
      if (config.descFormat !== undefined) {
        placementConfig.descFormat = config.descFormat;
      }
      if (config.descPosition !== undefined) {
        placementConfig.descPosition = config.descPosition;
      }

      // ç®¡ç†ç•ªå·ã®é…ç½®è¨­å®šã‚’è¡¨ç¤º
      const showInTitleCheckbox = document.getElementById('å•†å“åã«ç®¡ç†ç•ªå·é…ç½®');
      const showInDescriptionCheckbox = document.getElementById('èª¬æ˜æ–‡ã«ç®¡ç†ç•ªå·é…ç½®');
      const formatSelect = document.getElementById('ç®¡ç†ç•ªå·å½¢å¼');
      const positionSelect = document.getElementById('ç®¡ç†ç•ªå·é…ç½®ä½ç½®');
      const descFormatSelect = document.getElementById('èª¬æ˜æ–‡ç®¡ç†ç•ªå·å½¢å¼');
      const descPositionSelect = document.getElementById('èª¬æ˜æ–‡ç®¡ç†ç•ªå·é…ç½®ä½ç½®');

      console.log('ğŸ“‹ ç®¡ç†ç•ªå·é…ç½®è¨­å®šã‚’èª­ã¿è¾¼ã¿:', placementConfig);

      if (showInTitleCheckbox) {
        showInTitleCheckbox.checked = placementConfig.showInTitle || false;
        console.log('âœ… å•†å“åãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¨­å®š:', showInTitleCheckbox.checked);
      }
      if (showInDescriptionCheckbox) {
        showInDescriptionCheckbox.checked = placementConfig.showInDescription || false;
        console.log('âœ… èª¬æ˜æ–‡ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¨­å®š:', showInDescriptionCheckbox.checked);
      }
      if (formatSelect) {
        formatSelect.value = placementConfig.titleFormat || 'ã€ã€‘';
        console.log('âœ… å½¢å¼é¸æŠè¨­å®š:', formatSelect.value);
      }
      if (positionSelect) {
        positionSelect.value = placementConfig.titlePosition || 'end';
        console.log('âœ… é…ç½®ä½ç½®é¸æŠè¨­å®š:', positionSelect.value);
      }
      if (descFormatSelect) {
        descFormatSelect.value = placementConfig.descFormat || 'ã€ã€‘';
        console.log('âœ… èª¬æ˜æ–‡å½¢å¼é¸æŠè¨­å®š:', descFormatSelect.value);
      }
      if (descPositionSelect) {
        descPositionSelect.value = placementConfig.descPosition || 'bottom';
        console.log('âœ… èª¬æ˜æ–‡é…ç½®ä½ç½®é¸æŠè¨­å®š:', descPositionSelect.value);
      }

      // å½¢å¼é¸æŠã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°
      toggleManagementNumberFormat();
      // èª¬æ˜æ–‡ã®å½¢å¼é¸æŠã®è¡¨ç¤º/éè¡¨ç¤ºã‚‚æ›´æ–°
      if (typeof toggleManagementNumberDescriptionFormat === 'function') {
        toggleManagementNumberDescriptionFormat();
      }
    }


    /**
     * ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ¼ãƒã‚’ç”»é¢ã«åæ˜ 
     * @param {string} theme - 'casual' ã¾ãŸã¯ 'modern'
     */
    function renderDesignTheme(theme) {
      console.log('ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ¼ãƒã‚’èª­ã¿è¾¼ã¿:', theme);
      selectTheme(theme || 'casual');
    }

    /**
     * ãƒ†ãƒ¼ãƒã‚’é¸æŠ
     * @param {string} theme - 'casual' ã¾ãŸã¯ 'modern'
     */
    function selectTheme(theme) {
      console.log('ãƒ†ãƒ¼ãƒé¸æŠ:', theme);

      // éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
      const hiddenField = document.getElementById('selected-design-theme');
      if (hiddenField) {
        hiddenField.value = theme;
      }

      // ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã‚«ãƒ¼ãƒ‰
      const casualCard = document.getElementById('theme-casual-card');
      const casualCheck = document.getElementById('theme-casual-check');

      // ãƒ¢ãƒ€ãƒ³ã‚«ãƒ¼ãƒ‰
      const modernCard = document.getElementById('theme-modern-card');
      const modernCheck = document.getElementById('theme-modern-check');

      if (theme === 'casual') {
        // ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã‚’é¸æŠçŠ¶æ…‹ã«
        casualCard.style.border = '3px solid #40B4E5';
        casualCard.style.background = 'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)';
        casualCheck.style.display = 'block';

        // ãƒ¢ãƒ€ãƒ³ã‚’éé¸æŠçŠ¶æ…‹ã«
        modernCard.style.border = '3px solid #d1d5db';
        modernCard.style.background = '#ffffff';
        modernCheck.style.display = 'none';
      } else if (theme === 'modern') {
        // ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã‚’éé¸æŠçŠ¶æ…‹ã«
        casualCard.style.border = '3px solid #d1d5db';
        casualCard.style.background = '#ffffff';
        casualCheck.style.display = 'none';

        // ãƒ¢ãƒ€ãƒ³ã‚’é¸æŠçŠ¶æ…‹ã«
        modernCard.style.border = '3px solid #C9A961';
        modernCard.style.background = 'linear-gradient(135deg, #fefce8 0%, #fef3c7 100%)';
        modernCheck.style.display = 'block';
      }

      console.log('ãƒ†ãƒ¼ãƒé¸æŠå®Œäº†:', theme);
    }

    // ================= è¨­å®šç®¡ç†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆlocalStorage + PropertiesService ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ï¼‰ =================

    /**
     * localStorageã‚­ãƒ¼å®šç¾©
     */
    const CONFIG_STORAGE_KEYS = {
      CONDITION_BUTTONS: 'rebornConfig_conditionButtons',
      HASHTAG: 'rebornConfig_hashtag',
      DISCOUNT: 'rebornConfig_discount',
      SHIPPING_DEFAULT: 'rebornConfig_shippingDefault',
      PROCURE_LISTING_DEFAULT: 'rebornConfig_procureListingDefault',
      MANAGEMENT_NUMBER: 'rebornConfig_managementNumber',
      SALESWORD: 'rebornConfig_salesword',
      AI_SETTINGS: 'rebornConfig_aiSettings',
      DESIGN_THEME: 'rebornTheme', // æ—¢å­˜
      IMAGE_SAVE: 'enableProductImageSave' // æ—¢å­˜
    };

    /**
     * å…¨è¨­å®šã‚’localStorageã«ä¿å­˜
     */
    function saveConfigToLocalStorage(config) {
      console.log('ğŸ“ [DEBUG] saveConfigToLocalStorage - ç¾åœ¨ã®URL:', window.location.href);
      console.log('ğŸ“ [DEBUG] saveConfigToLocalStorage - ã‚ªãƒªã‚¸ãƒ³:', window.location.origin);
      console.log('ğŸ“ [DEBUG] saveConfigToLocalStorage - ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿:', config);
      
      try {
        localStorage.setItem(CONFIG_STORAGE_KEYS.CONDITION_BUTTONS, JSON.stringify(config['å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³']));
        localStorage.setItem(CONFIG_STORAGE_KEYS.HASHTAG, JSON.stringify(config['ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°']));
        localStorage.setItem(CONFIG_STORAGE_KEYS.DISCOUNT, JSON.stringify(config['å‰²å¼•æƒ…å ±']));
        localStorage.setItem(CONFIG_STORAGE_KEYS.SHIPPING_DEFAULT, JSON.stringify(config['é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ']));
        localStorage.setItem(CONFIG_STORAGE_KEYS.PROCURE_LISTING_DEFAULT, JSON.stringify(config['ä»•å…¥å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ']));
        localStorage.setItem(CONFIG_STORAGE_KEYS.MANAGEMENT_NUMBER, JSON.stringify(config['ç®¡ç†ç•ªå·è¨­å®š']));
        localStorage.setItem(CONFIG_STORAGE_KEYS.SALESWORD, JSON.stringify(config['ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰']));
        localStorage.setItem(CONFIG_STORAGE_KEYS.AI_SETTINGS, JSON.stringify(config['AIç”Ÿæˆè¨­å®š']));
        localStorage.setItem(CONFIG_STORAGE_KEYS.DESIGN_THEME, config['ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ']);

        // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã‚’ config ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ä¿å­˜ï¼ˆproduct.html ãŒå‚ç…§ï¼‰
        const existingConfig = JSON.parse(localStorage.getItem('config') || '{}');
        existingConfig['ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š'] = config['ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š'];
        localStorage.setItem('config', JSON.stringify(existingConfig));
        console.log('âœ… ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã‚’ config ã«ä¿å­˜:', config['ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š']);

        console.log('âœ… å…¨è¨­å®šã‚’localStorageã«ä¿å­˜ã—ã¾ã—ãŸ');
        
        // ğŸ” ä¿å­˜ç›´å¾Œã«èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ
        console.log('ğŸ” [DEBUG] ä¿å­˜ç›´å¾Œã®èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆé–‹å§‹...');
        const testRead = localStorage.getItem(CONFIG_STORAGE_KEYS.SALESWORD);
        if (testRead) {
          console.log('âœ… [DEBUG] ä¿å­˜ç›´å¾Œã®èª­ã¿è¾¼ã¿æˆåŠŸ:', JSON.parse(testRead));
        } else {
          console.error('âŒ [DEBUG] ä¿å­˜ç›´å¾Œãªã®ã«èª­ã¿è¾¼ã¿å¤±æ•—ï¼ localStorageã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§');
        }
        
        return true;
      } catch (e) {
        console.error('âŒ localStorageä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
        return false;
      }
    }

    /**
     * å…¨è¨­å®šã‚’Firestoreã«ä¿å­˜ï¼ˆPWAç‰ˆã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼‰
     */
    /**
     * å…¨è¨­å®šã‚’Firestoreã«ä¿å­˜ï¼ˆGASã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§CORSå›é¿ï¼‰
     */
    function saveConfigToFirestore(config) {
      if (!window.db) {
        console.warn('âš ï¸ FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆlocalStorage ã®ã¿ä¿å­˜ï¼‰');
        return Promise.resolve(false);
      }

      console.log('ğŸ“¤ Firestoreã«è¨­å®šã‚’ä¿å­˜ä¸­...');

      return window.db.collection('settings').doc('common').set({
        conditionButtons: config['å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³'] || [],
        hashtag: config['ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°'] || {},
        discount: config['å‰²å¼•æƒ…å ±'] || {},
        shippingDefault: config['é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ'] || {},
        procureListingDefault: config['ä»•å…¥å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ'] || {},
        managementNumber: config['ç®¡ç†ç•ªå·è¨­å®š'] || {},
        salesword: config['ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰'] || {},
        aiSettings: config['AIç”Ÿæˆè¨­å®š'] || {},
        designTheme: config['ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ'] || 'modern',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
              return true;
      })
      .catch((e) => {
        console.error('âŒ Firestoreä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
        return false;
      });
    }

    /**
     * è¨­å®šå¤‰æ›´ã‚’å•†å“ç™»éŒ²ç”»é¢ã«é€šçŸ¥ï¼ˆpostMessageï¼‰
     */
    function notifyConfigChange() {
      try {
        // å…¨ã¦ã®windowã«é€šçŸ¥ï¼ˆè¦ªã€å…„å¼Ÿiframeå«ã‚€ï¼‰
        if (window.parent) {
          window.parent.postMessage({
            type: 'configChanged',
            timestamp: new Date().getTime()
          }, '*');
        }

        if (window.top && window.top !== window.parent) {
          window.top.postMessage({
            type: 'configChanged',
            timestamp: new Date().getTime()
          }, '*');
        }

        // â˜… åˆ¥ã‚¿ãƒ–é–“é€šä¿¡ç”¨ï¼šBroadcastChannel ã§å…¨ã‚¿ãƒ–ã«é€šçŸ¥
        if ('BroadcastChannel' in window) {
          const channel = new BroadcastChannel('reborn_config_updates');
          channel.postMessage({
            type: 'configChanged',
            timestamp: new Date().getTime()
          });
          channel.close();
          console.log('ğŸ“¤ BroadcastChannelã§å…¨ã‚¿ãƒ–ã«è¨­å®šå¤‰æ›´ã‚’é€šçŸ¥ã—ã¾ã—ãŸ');
        } else {
          console.warn('âš ï¸ BroadcastChanneléå¯¾å¿œï¼ˆå¤ã„ãƒ–ãƒ©ã‚¦ã‚¶ï¼‰');
        }

        console.log('ğŸ“¤ è¨­å®šå¤‰æ›´ã‚’postMessageã§é€šçŸ¥ã—ã¾ã—ãŸ');
      } catch (e) {
        console.warn('postMessageé€ä¿¡ã‚¨ãƒ©ãƒ¼ï¼ˆç„¡è¦–ã—ã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ï¼‰:', e);
      }
    }

    /**
     * PropertiesServiceã¸ã®ä¿å­˜ã‚’ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãã§å®Ÿè¡Œ
     * PWAç‰ˆã§ã¯ PropertiesService ä¿å­˜ã¯ä¸è¦ï¼ˆFirestore ã‚’ä½¿ç”¨ï¼‰
     */

    /**
     * è¨­å®šã‚’ä¿å­˜
     */
    window.saveConfig = async function() {
      try {
        console.log('=== saveConfig é–‹å§‹ ===');
        const managementConfig = collectManagementConfig();
        console.log('ç®¡ç†ç•ªå·è¨­å®š:', managementConfig);

        // åŸºæœ¬è¨­å®šã‚’ä¿å­˜
        await saveBasicSettings();

        // ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
        if (pendingUserIconData) {
          await uploadUserIcon();
        }

      // ç”»åƒç®¡ç†è¨­å®šã‚’LocalStorageã«ä¿å­˜
      const imageCheckbox = document.getElementById('enableProductImageSave');
      let imageSettingMessage = '';
      if (imageCheckbox) {
        const imageEnabled = imageCheckbox.checked;
        localStorage.setItem('enableProductImageSave', imageEnabled.toString());
        console.log('ğŸ’¾ ç”»åƒç®¡ç†è¨­å®šã‚’LocalStorageã«ä¿å­˜:', imageEnabled);

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
        const statusText = document.getElementById('imageSettingStatusText');
        if (statusText) {
          statusText.textContent = imageEnabled
            ? 'ONï¼ˆå•†å“ç”»åƒãƒ–ãƒ­ãƒƒã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰'
            : 'OFFï¼ˆå•†å“ç”»åƒãƒ–ãƒ­ãƒƒã‚¯ã¯éè¡¨ç¤ºï¼‰';
        }

        // ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è¿½åŠ 
        imageSettingMessage = imageEnabled
          ? '\n\nğŸ“· å•†å“ç”»åƒãƒ–ãƒ­ãƒƒã‚¯: ON â†’ å•†å“ç™»éŒ²ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã¾ã™'
          : '\n\nğŸ“· å•†å“ç”»åƒãƒ–ãƒ­ãƒƒã‚¯: OFF â†’ éè¡¨ç¤ºã«ãªã‚Šã¾ã™';
      }

        console.log('Step 1: å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³ã‚’åé›†ä¸­...');
        const conditionButtons = collectConditionButtons();
        console.log('Step 2: ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’åé›†ä¸­...');
        const hashtags = collectHashtagConfig();
        console.log('Step 3: å‰²å¼•æƒ…å ±ã‚’åé›†ä¸­...');
        const discountInfo = collectDiscountConfig();
        console.log('Step 4: é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’åé›†ä¸­...');
        const shippingDefaults = collectShippingDefaults();
        console.log('Step 5: ä»•å…¥å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’åé›†ä¸­...');
        const procureListingDefaults = collectProcureListingDefaults();
        console.log('Step 6: ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’åé›†ä¸­...');
        const saleswords = collectSaleswordConfig();
        console.log('ğŸ’¾ [ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰] åé›†çµæœ:', saleswords);
        console.log('ğŸ’¾ [ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰] ã‚ˆãä½¿ã†:', saleswords?.ã‚ˆãä½¿ã†);
        console.log('ğŸ’¾ [ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰] è¡¨ç¤ºå½¢å¼:', saleswords?.è¡¨ç¤ºå½¢å¼);
        console.log('ğŸ’¾ [ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰] ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ:', saleswords?.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ);
        console.log('Step 7: AIç”Ÿæˆè¨­å®šã‚’åé›†ä¸­...');
        const aiSettings = collectAiSettings();
        console.log('Step 8: ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ¼ãƒã‚’å–å¾—ä¸­...');
        const designThemeElement = document.getElementById('selected-design-theme');
        const designTheme = designThemeElement ? designThemeElement.value : '';
        console.log('Step 8.5: ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã‚’åé›†ä¸­...');
        const platformSettings = collectPlatformSettings();

        const newConfig = {
          å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³: conditionButtons,
          ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°: hashtags,
          å‰²å¼•æƒ…å ±: discountInfo,
          é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: shippingDefaults,
          ä»•å…¥å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: procureListingDefaults,
          ç®¡ç†ç•ªå·è¨­å®š: managementConfig,
          ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰: saleswords,
          AIç”Ÿæˆè¨­å®š: aiSettings,
          ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ: designTheme,
          ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š: platformSettings
        };

        console.log('Step 9: è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆå®Œäº†');
        console.log('ä¿å­˜ã™ã‚‹è¨­å®šå…¨ä½“:', newConfig);

        // 1. å³åº§ã«localStorageã«ä¿å­˜ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ä¸è¦ã§åæ˜ ï¼‰
        console.log('Step 10: localStorageã«ä¿å­˜ä¸­...');
        const localStorageSaved = saveConfigToLocalStorage(newConfig);

        // 2. Firestoreã«ä¿å­˜ï¼ˆPWAç‰ˆã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼‰
        console.log('Step 11: Firestoreã«ä¿å­˜ä¸­...');
        saveConfigToFirestore(newConfig).catch(err => {
          console.warn('âš ï¸ Firestoreä¿å­˜ã¯å¤±æ•—ã—ã¾ã—ãŸãŒã€localStorageã«ã¯ä¿å­˜ã•ã‚Œã¾ã—ãŸ:', err);
        });

        // 3. postMessageã§å•†å“ç™»éŒ²ç”»é¢ã«é€šçŸ¥ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ä¸è¦ã§åæ˜ ï¼‰
        console.log('Step 12: postMessageé€šçŸ¥ä¸­...');
        notifyConfigChange();

        // 4. æ¨©é™è¨­å®šã‚’ä¿å­˜ï¼ˆæ¨©é™è¨­å®šã‚¿ãƒ–ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ï¼‰
        console.log('Step 13: æ¨©é™è¨­å®šã‚’ä¿å­˜ä¸­...');
        const permissionSaved = await savePermissionSettings(false);
        console.log('Step 13 çµæœ:', permissionSaved ? 'æˆåŠŸ' : 'å¤±æ•—ã¾ãŸã¯ã‚¹ã‚­ãƒƒãƒ—');

        // 5. PWAç‰ˆã§ã¯ PropertiesService ä¿å­˜ä¸è¦ï¼ˆFirestore + localStorage ã§å®Œçµï¼‰
        console.log('Step 14: PWAç‰ˆã§ã¯ PropertiesService ä¿å­˜ä¸è¦');
        if (localStorageSaved) {
          alert('âœ… è¨­å®šå®Œäº†ã—ã¾ã—ãŸ');
        } else {
          alert('âŒ è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('âŒâŒâŒ saveConfig ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ âŒâŒâŒ');
        console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
        console.error('ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', error.message);
        console.error('ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯:', error.stack);
        alert('âŒ è¨­å®šä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n\n' + error.message + '\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
      }
    }

    /**
     * å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³è¨­å®šã‚’åé›†
     */
    function collectConditionButtons() {
      const buttons = [];
      CONDITION_STATES.forEach(state => {
        const container = document.getElementById(`condition-${state}`);
        Array.from(container.children).forEach((item, index) => {
          const labelSelect = item.querySelector('[data-field="label-select"]');
          const labelInput = item.querySelector('[data-field="label"]');
          const text = item.querySelector('[data-field="text"]').value;

          // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãŒã‚«ã‚¹ã‚¿ãƒ ã¾ãŸã¯æœªé¸æŠã®å ´åˆã¯inputã‹ã‚‰ã€ãã‚Œä»¥å¤–ã¯selectã‹ã‚‰å–å¾—
          let label = '';
          if (labelSelect && labelSelect.value === 'custom') {
            label = labelInput.value;
          } else if (labelSelect && labelSelect.value) {
            label = labelSelect.value;
          } else {
            label = labelInput.value;
          }

          if (label || text) {
            buttons.push({
              å•†å“ã®çŠ¶æ…‹: state,
              ãƒœã‚¿ãƒ³ãƒ©ãƒ™ãƒ«: label,
              ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ: text
            });
          }
        });
      });
      return buttons;
    }

    /**
     * å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢
     */
    function clearConditionButtons() {
      if (!confirm('å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³è¨­å®šã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\n\nå…¨ã‚«ãƒ†ã‚´ãƒªã®ã‚«ã‚¹ã‚¿ãƒ ãƒœã‚¿ãƒ³ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
        return;
      }

      // ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒªã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
      CONDITION_STATES.forEach(state => {
        const container = document.getElementById(`condition-${state}`);
        if (container) {
          container.innerHTML = '';
        }
      });

      alert('å•†å“çŠ¶æ…‹ãƒœã‚¿ãƒ³è¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚\nå¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã€Œè¨­å®šã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
    }

    /**
     * ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°è¨­å®šã‚’åé›†
     */
    function collectHashtagConfig() {
      const container = document.getElementById('hashtagItemsContainer');
      const hashtags = [];

      // ä¿å­˜æ™‚ã« # ã‚’è‡ªå‹•ã§ä»˜ã‘ã‚‹
      const addHash = (value) => {
        const trimmed = (value || '').trim();
        if (!trimmed) return '';
        return trimmed.startsWith('#') ? trimmed : '#' + trimmed;
      };

      // å…±é€šãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å–å¾—
      const commonPrefix = addHash(document.getElementById('commonHashtagPrefix').value || '');

      Array.from(container.children).forEach(item => {
        const title = item.querySelector('.hashtag-title').value || '';
        const icon = item.querySelector('.hashtag-icon').value || 'ğŸ·ï¸';
        const suffixSelect = item.querySelector('.hashtag-suffix-select');
        const suffixCustom = item.querySelector('.hashtag-suffix-custom');

        let suffix = '';
        if (suffixSelect.value === 'custom') {
          suffix = suffixCustom.value || '';
        } else {
          suffix = suffixSelect.value || '';
        }

        // ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’åé›†
        const suffixOptions = Array.from(suffixSelect.options)
          .filter(opt => opt.value !== 'custom')
          .map(opt => opt.value);

        // ã‚«ãƒ†ã‚´ãƒªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’åé›†ï¼ˆã‚«ãƒ†ã‚´ãƒªãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã®å ´åˆã®ã¿ï¼‰
        let categoryOptions = null;
        if (title === 'ã‚«ãƒ†ã‚´ãƒª') {
          categoryOptions = [];
          const checkboxes = item.querySelectorAll('.category-option');
          checkboxes.forEach(cb => {
            if (cb.checked) {
              categoryOptions.push(cb.getAttribute('data-option'));
            }
          });
        }

        // ã‚¿ã‚¤ãƒˆãƒ«ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ä¿å­˜
        if (title) {
          const hashtagData = {
            title: title,
            icon: icon,
            suffix: suffix,
            suffixOptions: suffixOptions
          };
          if (categoryOptions) {
            hashtagData.categoryOptions = categoryOptions;
          }
          hashtags.push(hashtagData);
        }
      });

      return {
        commonPrefix: commonPrefix,
        hashtags: hashtags
      };
    }

    /**
     * å‰²å¼•æƒ…å ±è¨­å®šã‚’åé›†
     */
    function collectDiscountConfig() {
      const config = {};

      // ã‚¿ã‚¤ãƒˆãƒ«ã‚’åé›†
      const select = document.getElementById('å‰²å¼•æƒ…å ±ã‚¿ã‚¤ãƒˆãƒ«é¸æŠ');
      const customInput = document.getElementById('å‰²å¼•æƒ…å ±ã‚¿ã‚¤ãƒˆãƒ«ã‚«ã‚¹ã‚¿ãƒ ');
      if (select) {
        if (select.value === 'custom') {
          config['ã‚¿ã‚¤ãƒˆãƒ«'] = customInput?.value || '';
          config['ã‚¿ã‚¤ãƒˆãƒ«é¸æŠ'] = 'custom';
        } else {
          config['ã‚¿ã‚¤ãƒˆãƒ«'] = select.value;
          config['ã‚¿ã‚¤ãƒˆãƒ«é¸æŠ'] = select.value;
        }
      }

      // ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å…¨ã¦ã®å‰²å¼•ã‚¿ã‚¤ãƒ—ã‚’åé›†
      const typesList = document.getElementById('discountTypesList');
      const discountGroups = typesList?.querySelectorAll('.discount-group') || [];
      const discountTypes = [];

      discountGroups.forEach(group => {
        const typeName = group.id.replace('Group', '');
        discountTypes.push(typeName);

        // ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—
        const iconElement = group.querySelector('strong');
        const iconText = iconElement?.textContent || '';
        const icon = iconText.split(' ')[0] || 'ğŸ’°'; // ã‚¢ã‚¤ã‚³ãƒ³éƒ¨åˆ†ã‚’æŠ½å‡º
        config[`${typeName}_ã‚¢ã‚¤ã‚³ãƒ³`] = icon;

        // ç¯„å›²ã‚’åé›†
        config[typeName] = [];
        const container = document.getElementById(`${typeName}Container`);
        if (container) {
          Array.from(container.children).forEach(item => {
            const range = item.querySelector('[data-field="range"]')?.value || '';
            const amount = item.querySelector('[data-field="amount"]')?.value || '';
            if (range || amount) {
              config[typeName].push({ ç¯„å›²: range, å‰²å¼•é¡: amount });
            }
          });
        }

        // èª¬æ˜æ–‡ã‚’åé›†
        const descField = document.getElementById(`${typeName}_èª¬æ˜æ–‡`);
        if (descField) {
          config[`${typeName}_èª¬æ˜æ–‡`] = descField.value;
        }
      });

      // å‰²å¼•ã‚¿ã‚¤ãƒ—ã®é †åºã‚’ä¿å­˜
      config['å‰²å¼•ã‚¿ã‚¤ãƒ—é †åº'] = discountTypes;

      return config;
    }

    /**
     * ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’è‡ªå‹•ãƒªã‚µã‚¤ã‚º
     */
    function autoResizeTextarea(textarea) {
      // é«˜ã•ã‚’ãƒªã‚»ãƒƒãƒˆ
      textarea.style.height = 'auto';
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é«˜ã•ã«åˆã‚ã›ã‚‹
      textarea.style.height = textarea.scrollHeight + 'px';
    }

    /**
     * é…é€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’åé›†
     */
    function collectShippingDefaults() {
      return {
        é…é€æ–™ã®è² æ‹…: document.getElementById('é…é€æ–™ã®è² æ‹…').value,
        é…é€ã®æ–¹æ³•: document.getElementById('é…é€ã®æ–¹æ³•').value,
        ç™ºé€å…ƒã®åœ°åŸŸ: document.getElementById('ç™ºé€å…ƒã®åœ°åŸŸ').value,
        ç™ºé€ã¾ã§ã®æ—¥æ•°: document.getElementById('ç™ºé€ã¾ã§ã®æ—¥æ•°').value,
        æ¢±åŒ…è³‡æãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: document.getElementById('æ¢±åŒ…è³‡æãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ').value
      };
    }

    /**
     * ç®¡ç†ç•ªå·è¨­å®šã‚’åé›†
     */
    function collectManagementConfig() {
      // æ–°ã—ã„ç®¡ç†ç•ªå·ãƒ“ãƒ«ãƒ€ãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      try {
        if (typeof ManagementNumberBuilder !== 'undefined' && ManagementNumberBuilder) {
          const data = ManagementNumberBuilder.getData();
          console.log('ManagementNumberBuilderã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—:', data);

          // ç®¡ç†ç•ªå·ã®é…ç½®è¨­å®šã‚‚è¿½åŠ 
          const showInTitle = document.getElementById('å•†å“åã«ç®¡ç†ç•ªå·é…ç½®');
          const showInDescription = document.getElementById('èª¬æ˜æ–‡ã«ç®¡ç†ç•ªå·é…ç½®');
          const format = document.getElementById('ç®¡ç†ç•ªå·å½¢å¼');
          const position = document.getElementById('ç®¡ç†ç•ªå·é…ç½®ä½ç½®');
          const descFormat = document.getElementById('èª¬æ˜æ–‡ç®¡ç†ç•ªå·å½¢å¼');
          const descPosition = document.getElementById('èª¬æ˜æ–‡ç®¡ç†ç•ªå·é…ç½®ä½ç½®');

          console.log('ğŸ“ ç®¡ç†ç•ªå·é…ç½®è¨­å®šã‚’åé›†ï¼ˆä¿å­˜å‰ï¼‰:', {
            showInTitleElement: showInTitle,
            showInTitleChecked: showInTitle ? showInTitle.checked : null,
            showInDescriptionElement: showInDescription,
            showInDescriptionChecked: showInDescription ? showInDescription.checked : null,
            formatElement: format,
            formatValue: format ? format.value : null,
            positionElement: position,
            positionValue: position ? position.value : null,
            descFormatElement: descFormat,
            descFormatValue: descFormat ? descFormat.value : null,
            descPositionElement: descPosition,
            descPositionValue: descPosition ? descPosition.value : null
          });

          data.showInTitle = showInTitle ? showInTitle.checked : false;
          data.showInDescription = showInDescription ? showInDescription.checked : false;
          data.titleFormat = format ? format.value : 'ã€ã€‘';
          data.titlePosition = position ? position.value : 'end';
          data.descFormat = descFormat ? descFormat.value : 'ã€ã€‘';
          data.descPosition = descPosition ? descPosition.value : 'bottom';

          console.log('ğŸ’¾ ç®¡ç†ç•ªå·ã®é…ç½®è¨­å®šï¼ˆä¿å­˜ãƒ‡ãƒ¼ã‚¿ï¼‰:', {
            showInTitle: data.showInTitle,
            showInDescription: data.showInDescription,
            titleFormat: data.titleFormat,
            titlePosition: data.titlePosition,
            descFormat: data.descFormat,
            descPosition: data.descPosition
          });

          // å•†å“ç™»éŒ²ç”»é¢ç”¨ã®localStorageã«ã‚‚ä¿å­˜ï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
          try {
            const placementSettings = {
              inTitle: data.showInTitle,
              inDesc: data.showInDescription,
              format: data.titleFormat,
              position: data.titlePosition,
              descFormat: data.descFormat,
              descPosition: data.descPosition
            };
            localStorage.setItem('managementNumberPlacement', JSON.stringify(placementSettings));
            console.log('âœ… managementNumberPlacementã«ã‚‚ä¿å­˜:', placementSettings);
          } catch (e) {
            console.error('managementNumberPlacementä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
          }

          return data;
        } else {
          console.warn('ManagementNumberBuilderãŒæœªå®šç¾©ã§ã™');
          return { segments: [] };
        }
      } catch (e) {
        console.error('collectManagementConfig ã‚¨ãƒ©ãƒ¼:', e);
        return { segments: [] };
      }
    }

    // ========================================
    // ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š
    // ========================================

    let SALESWORD_LIST = [];

    /**
     * ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ + å‰Šé™¤ãƒœã‚¿ãƒ³ï¼‰
     */
    function renderSaleswordList() {
      const container = document.getElementById('saleswordList');
      if (!container) return;

      container.innerHTML = '';

      // SALESWORD_LISTãŒé…åˆ—ã§ã‚ã‚‹ã“ã¨ã‚’ä¿è¨¼
      if (!Array.isArray(SALESWORD_LIST)) {
        console.warn('SALESWORD_LISTãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ç©ºé…åˆ—ã«åˆæœŸåŒ–ã—ã¾ã™ã€‚', SALESWORD_LIST);
        SALESWORD_LIST = [];
      }

      if (SALESWORD_LIST.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 16px; font-size: 13px;">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      SALESWORD_LIST.forEach((word, index) => {
        const item = document.createElement('div');
        item.style.display = 'flex';
        item.style.alignItems = 'center';
        item.style.gap = '8px';
        item.style.padding = '8px';
        item.style.background = 'white';
        item.style.border = '1px solid #e5e7eb';
        item.style.borderRadius = '6px';
        item.style.marginBottom = '8px';

        item.innerHTML = `
          <span style="color: #6c757d; font-size: 12px; min-width: 30px;">${index + 1}.</span>
          <span style="flex: 1; font-size: 13px; color: #374151;">${word}</span>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSalesword(${index})" style="font-size: 11px; padding: 4px 12px;">å‰Šé™¤</button>
        `;

        container.appendChild(item);
      });
    }

    /**
     * ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å‰Šé™¤
     */
    function removeSalesword(index) {
      SALESWORD_LIST.splice(index, 1);
      renderSaleswordList();
    }

    /**
     * ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼‰
     */
    let SALESWORD_MASTER = {};

    /**
     * ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
     */
    async function loadSaleswordMasterData() {
      try {
        console.log('[Config] ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹');

        if (!window.db) {
          console.error('[Config] FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€ç©ºãƒ‡ãƒ¼ã‚¿ã§åˆæœŸåŒ–');
          SALESWORD_MASTER = {};
          initSaleswordDropdowns();
          return;
        }

        const snapshot = await window.db.collection('saleswords').orderBy('order').get();

        if (snapshot.empty) {
          console.warn('[Config] ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€ç©ºãƒ‡ãƒ¼ã‚¿ã§åˆæœŸåŒ–');
          SALESWORD_MASTER = {};
          initSaleswordDropdowns();
          return;
        }

        // ã‚«ãƒ†ã‚´ãƒª â†’ ãƒ¯ãƒ¼ãƒ‰é…åˆ—ã®å½¢å¼ã§æ ¼ç´
        const result = {};
        snapshot.forEach(doc => {
          const data = doc.data();
          result[data.category] = data.words || [];
        });

        SALESWORD_MASTER = result;
        console.log('[Config] ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ');
        console.log('ã‚«ãƒ†ã‚´ãƒªæ•°:', Object.keys(result).length);

        initSaleswordDropdowns();

      } catch (error) {
        console.error('[Config] ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        SALESWORD_MASTER = {};
        initSaleswordDropdowns();
      }
    }

    /**
     * 2æ®µå¼ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’åˆæœŸåŒ–
     */
    function initSaleswordDropdowns() {
      const categorySelect = document.getElementById('saleswordCategorySelect');
      if (!categorySelect || !SALESWORD_MASTER) return;

      categorySelect.innerHTML = '<option value="">--é¸æŠ--</option>';

      // â­ã‚ˆãä½¿ã†ãƒ¯ãƒ¼ãƒ‰ã¯Firestoreã«ã¯ç„¡ã„ã®ã§è¡¨ç¤ºã—ãªã„ï¼ˆ3ï¸âƒ£ã¯ã€Œã‚ˆãä½¿ã†ã€ãƒªã‚¹ãƒˆã«è¿½åŠ ã™ã‚‹æ©Ÿèƒ½ï¼‰
      Object.keys(SALESWORD_MASTER).sort().forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
      });

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–ã¯ loadSaleswordConfig() ã§å®Ÿè¡Œ
      // ï¼ˆwindow.CACHED_CONFIG ãŒå¿…è¦ãªãŸã‚ã€ã“ã“ã§ã¯å‘¼ã°ãªã„ï¼‰
    }

    /**
     * ã‚«ãƒ†ã‚´ãƒªé¸æŠæ™‚ã«ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
     */
    function updateSaleswordOptions() {
      const categorySelect = document.getElementById('saleswordCategorySelect');
      const saleswordSelect = document.getElementById('saleswordSelect');

      if (!categorySelect || !saleswordSelect) return;

      const category = categorySelect.value;
      saleswordSelect.innerHTML = '<option value="">--é¸æŠ--</option>';

      if (!category || !SALESWORD_MASTER[category]) {
        saleswordSelect.disabled = true;
        return;
      }

      SALESWORD_MASTER[category].forEach(word => {
        const option = document.createElement('option');
        option.value = word;
        option.textContent = word;
        saleswordSelect.appendChild(option);
      });

      saleswordSelect.disabled = false;
    }

    /**
     * ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‹ã‚‰ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ 
     */
    function addSaleswordFromDropdown() {
      const saleswordSelect = document.getElementById('saleswordSelect');
      if (!saleswordSelect) return;

      const word = saleswordSelect.value.trim();
      if (!word) {
        alert('ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      // é‡è¤‡ãƒã‚§ãƒƒã‚¯
      if (SALESWORD_LIST.includes(word)) {
        alert('ã“ã®ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
        return;
      }

      SALESWORD_LIST.push(word);  // é…åˆ—ã®æœ«å°¾ã«è¿½åŠ ï¼ˆè¿½åŠ ã—ãŸé †ã«è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
      renderSaleswordList();

      // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('saleswordCategorySelect').value = '';
      saleswordSelect.value = '';
      saleswordSelect.disabled = true;
    }

    /**
     * ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã‚’åé›†
     */
    function collectSaleswordConfig() {
      // SALESWORD_LISTãŒé…åˆ—ã§ã‚ã‚‹ã“ã¨ã‚’ä¿è¨¼
      const saleswordList = Array.isArray(SALESWORD_LIST) ? SALESWORD_LIST : [];

      const result = {
        ã‚ˆãä½¿ã†: saleswordList.filter(word => word.trim() !== ''),
        è¡¨ç¤ºå½¢å¼: collectSaleswordFormat(),
        ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: collectDefaultSalesword()
      };
      console.log('collectSaleswordConfig çµæœ:', result);
      return result;
    }

    /**
     * ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã‚’åé›†
     */
    function collectDefaultSalesword() {
      const category = document.getElementById('defaultSaleswordCategory')?.value || '';
      const salesword = document.getElementById('defaultSalesword')?.value || '';

      console.log('[collectDefaultSalesword] ã‚«ãƒ†ã‚´ãƒª:', category);
      console.log('[collectDefaultSalesword] ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰:', salesword);

      return {
        ã‚«ãƒ†ã‚´ãƒª: category,
        ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰: salesword
      };
    }

    /**
     * ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ã‚«ãƒ†ã‚´ãƒªãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’åˆæœŸåŒ–
     */
    function initDefaultSaleswordDropdowns() {
      const categorySelect = document.getElementById('defaultSaleswordCategory');
      if (!categorySelect || !SALESWORD_MASTER) return;

      categorySelect.innerHTML = '<option value="">--é¸æŠ--</option>';

      // â­ã‚ˆãä½¿ã†ãƒ¯ãƒ¼ãƒ‰ã‚’CACHED_CONFIGã‹ã‚‰è¿½åŠ 
      if (window.CACHED_CONFIG && window.CACHED_CONFIG['ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰']) {
        const saleswordConfig = window.CACHED_CONFIG['ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰'];
        const frequentWords = saleswordConfig.ã‚ˆãä½¿ã† || [];

        if (frequentWords.length > 0) {
          const option = document.createElement('option');
          option.value = 'â­ã‚ˆãä½¿ã†ãƒ¯ãƒ¼ãƒ‰';
          option.textContent = 'â­ã‚ˆãä½¿ã†ãƒ¯ãƒ¼ãƒ‰';
          categorySelect.appendChild(option);

          // SALESWORD_MASTERã«ã‚‚è¿½åŠ 
          SALESWORD_MASTER['â­ã‚ˆãä½¿ã†ãƒ¯ãƒ¼ãƒ‰'] = frequentWords;
        }
      }

      Object.keys(SALESWORD_MASTER).sort().forEach(category => {
        // â­ã‚ˆãä½¿ã†ãƒ¯ãƒ¼ãƒ‰ã¯æ—¢ã«è¿½åŠ æ¸ˆã¿ãªã®ã§ã‚¹ã‚­ãƒƒãƒ—
        if (category === 'â­ã‚ˆãä½¿ã†ãƒ¯ãƒ¼ãƒ‰') return;

        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
      });
    }

    /**
     * ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ã‚«ãƒ†ã‚´ãƒªé¸æŠæ™‚ã«ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
     */
    function updateDefaultSaleswordOptions() {
      const categorySelect = document.getElementById('defaultSaleswordCategory');
      const saleswordSelect = document.getElementById('defaultSalesword');

      if (!categorySelect || !saleswordSelect) return;

      const category = categorySelect.value;
      saleswordSelect.innerHTML = '<option value="">--é¸æŠ--</option>';

      if (!category || !SALESWORD_MASTER[category]) {
        saleswordSelect.disabled = true;
        return;
      }

      SALESWORD_MASTER[category].forEach(word => {
        const option = document.createElement('option');
        option.value = word;
        option.textContent = word;
        saleswordSelect.appendChild(option);
      });

      saleswordSelect.disabled = false;
    }

    /**
     * ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã‚’ç”»é¢ã«åæ˜ 
     */
    function renderDefaultSalesword(config) {
      console.log('[renderDefaultSalesword] å®Ÿè¡Œé–‹å§‹');
      console.log('[renderDefaultSalesword] config:', config);

      if (!config || !config.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ) {
        console.warn('[renderDefaultSalesword] ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      const defaultConfig = config.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ;
      console.log('[renderDefaultSalesword] ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š:', defaultConfig);

      const categorySelect = document.getElementById('defaultSaleswordCategory');
      const saleswordSelect = document.getElementById('defaultSalesword');

      if (!categorySelect || !saleswordSelect) {
        console.error('[renderDefaultSalesword] ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      // ã‚«ãƒ†ã‚´ãƒªã‚’è¨­å®š
      if (defaultConfig.ã‚«ãƒ†ã‚´ãƒª) {
        categorySelect.value = defaultConfig.ã‚«ãƒ†ã‚´ãƒª;
        console.log('[renderDefaultSalesword] ã‚«ãƒ†ã‚´ãƒªè¨­å®š:', defaultConfig.ã‚«ãƒ†ã‚´ãƒª);
        // ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
        updateDefaultSaleswordOptions();

        // ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³æ›´æ–°å¾Œã«è¨­å®šï¼‰
        setTimeout(() => {
          if (defaultConfig.ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰) {
            saleswordSelect.value = defaultConfig.ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰;
            console.log('[renderDefaultSalesword] ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š:', defaultConfig.ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰);
            console.log('[renderDefaultSalesword] âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰å¾©å…ƒå®Œäº†');
          }
        }, 100);
      }
    }

    // ========================================
    // ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºå½¢å¼è¨­å®š
    // ========================================

    let WORD_OVERRIDES = [];

    /**
     * å‰ã«ä»˜ã‘ã‚‹è¨˜å·ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³å¤‰æ›´æ™‚
     */
    function handlePrefixChange() {
      const select = document.getElementById('saleswordPrefixGlobalSelect');
      const customInput = document.getElementById('saleswordPrefixGlobalCustom');

      if (select.value === 'custom') {
        customInput.style.display = 'block';
      } else {
        customInput.style.display = 'none';
        customInput.value = '';
      }

      updateSaleswordFormatPreview();
    }

    /**
     * å¾Œã‚ã«ä»˜ã‘ã‚‹è¨˜å·ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³å¤‰æ›´æ™‚
     */
    function handleSuffixChange() {
      const select = document.getElementById('saleswordSuffixGlobalSelect');
      const customInput = document.getElementById('saleswordSuffixGlobalCustom');

      if (select.value === 'custom') {
        customInput.style.display = 'block';
      } else {
        customInput.style.display = 'none';
        customInput.value = '';
      }

      updateSaleswordFormatPreview();
    }

    /**
     * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
     */
    function updateSaleswordFormatPreview() {
      const prefixSelect = document.getElementById('saleswordPrefixGlobalSelect');
      const prefixCustom = document.getElementById('saleswordPrefixGlobalCustom');
      const suffixSelect = document.getElementById('saleswordSuffixGlobalSelect');
      const suffixCustom = document.getElementById('saleswordSuffixGlobalCustom');

      let prefix = '';
      let suffix = '';

      if (prefixSelect.value === 'custom') {
        prefix = prefixCustom.value || '';
      } else {
        prefix = prefixSelect.value || '';
      }

      if (suffixSelect.value === 'custom') {
        suffix = suffixCustom.value || '';
      } else {
        suffix = suffixSelect.value || '';
      }

      const preview = document.getElementById('saleswordFormatPreview');
      if (preview) {
        preview.textContent = `${prefix}ç¾å“${suffix}`;
      }
    }

    /**
     * ãƒ¯ãƒ¼ãƒ‰åˆ¥è¨­å®šã‚’è¿½åŠ 
     */
    function addWordOverride() {
      WORD_OVERRIDES.push({
        word: '',
        prefix: '',
        suffix: ''
      });
      renderWordOverrides();
    }

    /**
     * ãƒ¯ãƒ¼ãƒ‰åˆ¥è¨­å®šã‚’å‰Šé™¤
     */
    function removeWordOverride(index) {
      WORD_OVERRIDES.splice(index, 1);
      renderWordOverrides();
    }

    /**
     * ãƒ¯ãƒ¼ãƒ‰åˆ¥è¨­å®šã‚’æ›´æ–°
     */
    function updateWordOverride(index, field, value) {
      WORD_OVERRIDES[index][field] = value;
    }

    /**
     * ãƒ¯ãƒ¼ãƒ‰åˆ¥è¨­å®šã®å‰ã«ä»˜ã‘ã‚‹è¨˜å·ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³å¤‰æ›´æ™‚
     */
    function handleWordPrefixChange(index) {
      const select = document.getElementById(`wordPrefixSelect_${index}`);
      const customInput = document.getElementById(`wordPrefixCustom_${index}`);

      if (select.value === 'custom') {
        customInput.style.display = 'block';
      } else {
        customInput.style.display = 'none';
        customInput.value = '';
      }

      updateWordOverrideFromInput(index);
    }

    /**
     * ãƒ¯ãƒ¼ãƒ‰åˆ¥è¨­å®šã®å¾Œã‚ã«ä»˜ã‘ã‚‹è¨˜å·ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³å¤‰æ›´æ™‚
     */
    function handleWordSuffixChange(index) {
      const select = document.getElementById(`wordSuffixSelect_${index}`);
      const customInput = document.getElementById(`wordSuffixCustom_${index}`);

      if (select.value === 'custom') {
        customInput.style.display = 'block';
      } else {
        customInput.style.display = 'none';
        customInput.value = '';
      }

      updateWordOverrideFromInput(index);
    }

    /**
     * ãƒ¯ãƒ¼ãƒ‰åˆ¥è¨­å®šã®ã‚«ãƒ†ã‚´ãƒªãƒ—ãƒ«ãƒ€ã‚¦ãƒ³å¤‰æ›´æ™‚
     */
    function handleWordCategoryChange(index) {
      const categorySelect = document.getElementById(`wordCategorySelect_${index}`);
      const saleswordSelect = document.getElementById(`wordSaleswordSelect_${index}`);

      if (!categorySelect || !saleswordSelect) return;

      const selectedCategory = categorySelect.value;

      // ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†æ§‹ç¯‰
      saleswordSelect.innerHTML = '<option value="">--é¸æŠ--</option>';

      if (selectedCategory && SALESWORD_MASTER[selectedCategory]) {
        // é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªã®ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«è¿½åŠ 
        SALESWORD_MASTER[selectedCategory].forEach(word => {
          const option = document.createElement('option');
          option.value = word;
          option.textContent = word;
          saleswordSelect.appendChild(option);
        });
        saleswordSelect.disabled = false;
      } else {
        saleswordSelect.disabled = true;
      }

      // WORD_OVERRIDESã®wordã‚’ã‚¯ãƒªã‚¢ï¼ˆã‚«ãƒ†ã‚´ãƒªå¤‰æ›´æ™‚ï¼‰
      WORD_OVERRIDES[index].word = '';

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
      updateWordOverridePreview(index);
    }

    /**
     * ãƒ¯ãƒ¼ãƒ‰åˆ¥è¨­å®šã®ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³å¤‰æ›´æ™‚
     */
    function handleWordSaleswordChange(index) {
      const saleswordSelect = document.getElementById(`wordSaleswordSelect_${index}`);

      if (!saleswordSelect) return;

      // WORD_OVERRIDESã‚’æ›´æ–°
      WORD_OVERRIDES[index].word = saleswordSelect.value;

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
      updateWordOverridePreview(index);
    }

    /**
     * ãƒ¯ãƒ¼ãƒ‰åˆ¥è¨­å®šã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
     */
    function updateWordOverridePreview(index) {
      const previewElement = document.getElementById(`wordOverridePreview_${index}`);
      if (!previewElement) return;

      const override = WORD_OVERRIDES[index];
      if (!override) return;

      const word = override.word || '';
      const prefix = override.prefix ?? '';
      const suffix = override.suffix ?? '';

      if (word) {
        previewElement.textContent = `${prefix}${word}${suffix}`;
      } else {
        previewElement.textContent = '-';
      }
    }

    /**
     * ãƒ¯ãƒ¼ãƒ‰åˆ¥è¨­å®šã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰å€¤ã‚’æ›´æ–°
     */
    function updateWordOverrideFromInput(index) {
      const saleswordSelect = document.getElementById(`wordSaleswordSelect_${index}`);
      const prefixSelect = document.getElementById(`wordPrefixSelect_${index}`);
      const prefixCustom = document.getElementById(`wordPrefixCustom_${index}`);
      const suffixSelect = document.getElementById(`wordSuffixSelect_${index}`);
      const suffixCustom = document.getElementById(`wordSuffixCustom_${index}`);

      // ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰ã‚’æ›´æ–°
      if (saleswordSelect) {
        WORD_OVERRIDES[index].word = saleswordSelect.value || '';
      }

      let prefix = '';
      let suffix = '';

      if (prefixSelect && prefixSelect.value === 'custom') {
        prefix = prefixCustom ? (prefixCustom.value || '').trim() : '';
      } else if (prefixSelect) {
        prefix = (prefixSelect.value || '').trim();
      }

      if (suffixSelect && suffixSelect.value === 'custom') {
        suffix = suffixCustom ? (suffixCustom.value || '').trim() : '';
      } else if (suffixSelect) {
        suffix = (suffixSelect.value || '').trim();
      }

      WORD_OVERRIDES[index].prefix = prefix;
      WORD_OVERRIDES[index].suffix = suffix;

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
      updateWordOverridePreview(index);
    }

    /**
     * ãƒ¯ãƒ¼ãƒ‰åˆ¥è¨­å®šã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
     */
    function renderWordOverrides() {
      const container = document.getElementById('wordOverrideList');
      if (!container) return;

      container.innerHTML = '';

      WORD_OVERRIDES.forEach((override, index) => {
        const item = document.createElement('div');
        item.style.background = '#f8f9fa';
        item.style.padding = '12px';
        item.style.borderRadius = '6px';
        item.style.marginBottom = '8px';
        item.style.border = '1px solid #dee2e6';

        // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®é¸æŠè‚¢ã‚’ä½œæˆï¼ˆå‰ã¨å¾Œã‚ã§åˆ†ã‘ã‚‹ï¼‰
        const prefixSelectOptions = `
          <option value="">ãªã—</option>
          <option value="ã€">ã€</option>
          <option value="ã€">ã€</option>
          <option value="ã€Œ">ã€Œ</option>
          <option value="ï¼ˆ">ï¼ˆ</option>
          <option value="ï½œ">ï½œ</option>
          <option value="â˜…">â˜…</option>
          <option value="â˜†">â˜†</option>
          <option value="â—†">â—†</option>
          <option value="â—">â—</option>
          <option value="â– ">â– </option>
          <option value="â™¡">â™¡</option>
          <option value="âœ¨">âœ¨</option>
          <option value="â€»">â€»</option>
          <option value="custom">ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›</option>
        `;

        const suffixSelectOptions = `
          <option value="">ãªã—</option>
          <option value="ã€‘">ã€‘</option>
          <option value="ã€">ã€</option>
          <option value="ã€">ã€</option>
          <option value="ï¼‰">ï¼‰</option>
          <option value="ï½œ">ï½œ</option>
          <option value="ï¼">ï¼</option>
          <option value="â˜…">â˜…</option>
          <option value="â˜†">â˜†</option>
          <option value="â—†">â—†</option>
          <option value="â—">â—</option>
          <option value="â– ">â– </option>
          <option value="â™¡">â™¡</option>
          <option value="âœ¨">âœ¨</option>
          <option value="â€»">â€»</option>
          <option value="custom">ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›</option>
        `;

        // å‰ã«ä»˜ã‘ã‚‹è¨˜å·ã®åˆæœŸå€¤ã‚’åˆ¤å®š
        const prefixValue = override.prefix || '';
        const prefixIsCustom = prefixValue && !['', 'ã€', 'ã€', 'ã€Œ', 'ï¼ˆ', 'ï½œ', 'â˜…', 'â˜†', 'â—†', 'â—', 'â– ', 'â™¡', 'âœ¨', 'â€»'].includes(prefixValue);
        const prefixSelectValue = prefixIsCustom ? 'custom' : prefixValue;

        // å¾Œã‚ã«ä»˜ã‘ã‚‹è¨˜å·ã®åˆæœŸå€¤ã‚’åˆ¤å®š
        const suffixValue = override.suffix || '';
        const suffixIsCustom = suffixValue && !['', 'ã€‘', 'ã€', 'ã€', 'ï¼‰', 'ï½œ', 'ï¼', 'â˜…', 'â˜†', 'â—†', 'â—', 'â– ', 'â™¡', 'âœ¨', 'â€»'].includes(suffixValue);
        const suffixSelectValue = suffixIsCustom ? 'custom' : suffixValue;

        // ã‚«ãƒ†ã‚´ãƒªãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
        const categoryOptions = Object.keys(SALESWORD_MASTER).map(cat =>
          `<option value="${cat}">${cat}</option>`
        ).join('');

        // ç¾åœ¨ã®è¨­å®šå€¤ã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªã‚’é€†å¼•ãï¼ˆoverride.wordãŒã©ã®ã‚«ãƒ†ã‚´ãƒªã«å±ã™ã‚‹ã‹ï¼‰
        let currentCategory = '';
        let currentWord = override.word || '';
        for (const [cat, words] of Object.entries(SALESWORD_MASTER)) {
          if (words.includes(currentWord)) {
            currentCategory = cat;
            break;
          }
        }

        item.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span style="font-size: 13px; font-weight: 500;">è¨­å®š ${index + 1}</span>
            <button type="button" style="padding: 2px 8px; font-size: 11px; color: #dc3545; background: transparent; border: 1px solid #dc3545; border-radius: 4px; cursor: pointer;" onclick="removeWordOverride(${index})" onmouseover="this.style.background='#dc3545';this.style.color='white';" onmouseout="this.style.background='transparent';this.style.color='#dc3545';">å‰Šé™¤</button>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 8px;">
            <div>
              <label style="font-size: 11px; margin-bottom: 4px; display: block; color: #6b7280;">ã‚«ãƒ†ã‚´ãƒª</label>
              <select id="wordCategorySelect_${index}" class="form-select form-select-sm" onchange="handleWordCategoryChange(${index})">
                <option value="">--é¸æŠ--</option>
                ${categoryOptions}
              </select>
            </div>
            <div>
              <label style="font-size: 11px; margin-bottom: 4px; display: block; color: #6b7280;">ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
              <select id="wordSaleswordSelect_${index}" class="form-select form-select-sm" onchange="handleWordSaleswordChange(${index})" ${currentCategory ? '' : 'disabled'}>
                <option value="">--é¸æŠ--</option>
              </select>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <div>
              <label style="font-size: 12px; margin-bottom: 4px; display: block;">å‰ã«ä»˜ã‘ã‚‹è¨˜å·</label>
              <select id="wordPrefixSelect_${index}" class="form-select form-select-sm" onchange="handleWordPrefixChange(${index})" style="margin-bottom: 4px;">
                ${prefixSelectOptions}
              </select>
              <input type="text" id="wordPrefixCustom_${index}" class="form-control form-control-sm"
                     value="${prefixIsCustom ? prefixValue : ''}"
                     onchange="updateWordOverrideFromInput(${index})"
                     placeholder="ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›" maxlength="5"
                     style="display: ${prefixIsCustom ? 'block' : 'none'};">
            </div>
            <div>
              <label style="font-size: 12px; margin-bottom: 4px; display: block;">å¾Œã‚ã«ä»˜ã‘ã‚‹è¨˜å·</label>
              <select id="wordSuffixSelect_${index}" class="form-select form-select-sm" onchange="handleWordSuffixChange(${index})" style="margin-bottom: 4px;">
                ${suffixSelectOptions}
              </select>
              <input type="text" id="wordSuffixCustom_${index}" class="form-control form-control-sm"
                     value="${suffixIsCustom ? suffixValue : ''}"
                     onchange="updateWordOverrideFromInput(${index})"
                     placeholder="ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›" maxlength="5"
                     style="display: ${suffixIsCustom ? 'block' : 'none'};">
            </div>
          </div>
          <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
          <div style="background: white; padding: 8px 12px; border-radius: 4px; border: 1px solid #dee2e6; margin-top: 8px;">
            <div style="font-size: 11px; color: #6c757d; margin-bottom: 4px;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</div>
            <div id="wordOverridePreview_${index}" style="font-size: 14px; color: #212529; font-weight: 500;">-</div>
          </div>
        `;

        container.appendChild(item);

        // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®å€¤ã‚’è¨­å®š
        const prefixSelect = document.getElementById(`wordPrefixSelect_${index}`);
        const suffixSelect = document.getElementById(`wordSuffixSelect_${index}`);
        if (prefixSelect) prefixSelect.value = prefixSelectValue;
        if (suffixSelect) suffixSelect.value = suffixSelectValue;

        // ã‚«ãƒ†ã‚´ãƒªã¨ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®å€¤ã‚’è¨­å®š
        const categorySelect = document.getElementById(`wordCategorySelect_${index}`);
        const saleswordSelect = document.getElementById(`wordSaleswordSelect_${index}`);

        if (categorySelect && currentCategory) {
          categorySelect.value = currentCategory;

          // ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
          if (saleswordSelect && SALESWORD_MASTER[currentCategory]) {
            saleswordSelect.innerHTML = '<option value="">--é¸æŠ--</option>';
            SALESWORD_MASTER[currentCategory].forEach(word => {
              const option = document.createElement('option');
              option.value = word;
              option.textContent = word;
              saleswordSelect.appendChild(option);
            });
            saleswordSelect.disabled = false;

            // ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å€¤ã‚’è¨­å®š
            if (currentWord) {
              saleswordSelect.value = currentWord;
            }
          }
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°ï¼ˆåˆæœŸè¡¨ç¤ºæ™‚ï¼‰
        updateWordOverridePreview(index);
      });
    }

    /**
     * ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºå½¢å¼è¨­å®šã‚’åé›†
     */
    function collectSaleswordFormat() {
      const prefixSelect = document.getElementById('saleswordPrefixGlobalSelect');
      const prefixCustom = document.getElementById('saleswordPrefixGlobalCustom');
      const suffixSelect = document.getElementById('saleswordSuffixGlobalSelect');
      const suffixCustom = document.getElementById('saleswordSuffixGlobalCustom');

      let prefix = '';
      let suffix = '';

      if (prefixSelect && prefixSelect.value === 'custom') {
        prefix = prefixCustom ? (prefixCustom.value || '').trim() : '';
      } else if (prefixSelect) {
        prefix = (prefixSelect.value || '').trim();
      }

      if (suffixSelect && suffixSelect.value === 'custom') {
        suffix = suffixCustom ? (suffixCustom.value || '').trim() : '';
      } else if (suffixSelect) {
        suffix = (suffixSelect.value || '').trim();
      }

      // ãƒ¯ãƒ¼ãƒ‰åˆ¥è¨­å®šã®æœ€æ–°å€¤ã‚’åé›†
      WORD_OVERRIDES.forEach((override, index) => {
        updateWordOverrideFromInput(index);
      });

      const result = {
        globalPrefix: prefix,
        globalSuffix: suffix,
        wordOverrides: WORD_OVERRIDES.filter(o => o.word.trim() !== '')
      };

      console.log('collectSaleswordFormat çµæœ:', result);
      return result;
    }

    /**
     * ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºå½¢å¼è¨­å®šã‚’èª­ã¿è¾¼ã¿
     */
    function renderSaleswordFormat(config) {
      console.log('renderSaleswordFormat å—ä¿¡ãƒ‡ãƒ¼ã‚¿:', config);

      if (!config) config = { globalPrefix: 'ã€', globalSuffix: 'ã€‘', wordOverrides: [] };

      // æ—§ãƒ‡ãƒ¼ã‚¿ï¼ˆcategoryOverridesï¼‰ã‹ã‚‰æ–°ãƒ‡ãƒ¼ã‚¿ï¼ˆwordOverridesï¼‰ã¸ã®å¤‰æ›
      if (config.categoryOverrides && !config.wordOverrides) {
        config.wordOverrides = [];
      }

      const prefixSelect = document.getElementById('saleswordPrefixGlobalSelect');
      const prefixCustom = document.getElementById('saleswordPrefixGlobalCustom');
      const suffixSelect = document.getElementById('saleswordSuffixGlobalSelect');
      const suffixCustom = document.getElementById('saleswordSuffixGlobalCustom');

      console.log('prefixè¨­å®šå€¤:', config.globalPrefix, 'suffixè¨­å®šå€¤:', config.globalSuffix);

      // å‰ã«ä»˜ã‘ã‚‹è¨˜å·ã‚’è¨­å®š
      // æ³¨æ„: ç©ºæ–‡å­—åˆ—ï¼ˆãªã—ï¼‰ã‚’è¨±å®¹ã™ã‚‹ãŸã‚ã€nullish coalescing (??) ã‚’ä½¿ç”¨
      const prefix = config.globalPrefix ?? 'ã€';
      const prefixOption = Array.from(prefixSelect.options).find(opt => opt.value === prefix);

      console.log('prefix:', prefix, 'prefixOption:', prefixOption);

      if (prefixOption && prefix !== '') {
        prefixSelect.value = prefix;
        prefixCustom.style.display = 'none';
        prefixCustom.value = '';
        console.log('prefixã‚’ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«è¨­å®š:', prefix);
      } else if (prefix === '') {
        prefixSelect.value = '';
        prefixCustom.style.display = 'none';
        prefixCustom.value = '';
        console.log('prefixã‚’ç©ºã«è¨­å®š');
      } else {
        prefixSelect.value = 'custom';
        prefixCustom.style.display = 'block';
        prefixCustom.value = prefix;
        console.log('prefixã‚’ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ã«è¨­å®š:', prefix);
      }

      // å¾Œã‚ã«ä»˜ã‘ã‚‹è¨˜å·ã‚’è¨­å®š
      // æ³¨æ„: ç©ºæ–‡å­—åˆ—ï¼ˆãªã—ï¼‰ã‚’è¨±å®¹ã™ã‚‹ãŸã‚ã€nullish coalescing (??) ã‚’ä½¿ç”¨
      const suffix = config.globalSuffix ?? 'ã€‘';
      const suffixOption = Array.from(suffixSelect.options).find(opt => opt.value === suffix);

      console.log('suffix:', suffix, 'suffixOption:', suffixOption);

      if (suffixOption && suffix !== '') {
        suffixSelect.value = suffix;
        suffixCustom.style.display = 'none';
        suffixCustom.value = '';
        console.log('suffixã‚’ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«è¨­å®š:', suffix);
      } else if (suffix === '') {
        suffixSelect.value = '';
        suffixCustom.style.display = 'none';
        suffixCustom.value = '';
        console.log('suffixã‚’ç©ºã«è¨­å®š');
      } else {
        suffixSelect.value = 'custom';
        suffixCustom.style.display = 'block';
        suffixCustom.value = suffix;
        console.log('suffixã‚’ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ã«è¨­å®š:', suffix);
      }

      // ãƒ¯ãƒ¼ãƒ‰åˆ¥è¨­å®š
      WORD_OVERRIDES = config.wordOverrides || [];
      renderWordOverrides();

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
      updateSaleswordFormatPreview();
    }

    /**
     * ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã‚’èª­ã¿è¾¼ã¿
     */
    function loadSaleswordConfig() {
      // PWAç‰ˆã§ã¯ Firestore ã‹ã‚‰èª­ã¿è¾¼ã¿
      // æš«å®š: localStorage ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆå€‹åˆ¥ã‚­ãƒ¼ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
      const saleswordConfigStr = localStorage.getItem('rebornConfig_salesword');
      const saleswordConfig = saleswordConfigStr ? JSON.parse(saleswordConfigStr) : null;

      console.log('[loadSaleswordConfig] rebornConfig_salesword:', saleswordConfig);

      // CACHED_CONFIGã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¨­å®šï¼ˆproduct-scripts.jsã¨åŒã˜ï¼‰
      if (!window.CACHED_CONFIG) {
        window.CACHED_CONFIG = {};
      }
      window.CACHED_CONFIG['ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰'] = saleswordConfig;

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’åˆæœŸåŒ–ï¼ˆâ­ã‚ˆãä½¿ã†ãƒ¯ãƒ¼ãƒ‰è¿½åŠ ã®ãŸã‚ï¼‰
      // â€» window.CACHED_CONFIG è¨­å®šå¾Œã«å¿…ãšå®Ÿè¡Œ
      initDefaultSaleswordDropdowns();

      // ã‚ˆãä½¿ã†ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆãƒªã‚¹ãƒˆï¼‰
      if (saleswordConfig) {
        if (saleswordConfig.ã‚ˆãä½¿ã†) {
          SALESWORD_LIST = saleswordConfig.ã‚ˆãä½¿ã†;
          renderSaleswordList();
          console.log('[loadSaleswordConfig] ã‚ˆãä½¿ã†ãƒ¯ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿:', SALESWORD_LIST);
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰
        if (saleswordConfig.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ) {
          renderDefaultSalesword(saleswordConfig);
          console.log('[loadSaleswordConfig] ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèª­ã¿è¾¼ã¿:', saleswordConfig.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ);
        }

        // è¡¨ç¤ºå½¢å¼
        if (saleswordConfig.è¡¨ç¤ºå½¢å¼) {
          renderSaleswordFormat(saleswordConfig.è¡¨ç¤ºå½¢å¼);
          console.log('[loadSaleswordConfig] è¡¨ç¤ºå½¢å¼èª­ã¿è¾¼ã¿:', saleswordConfig.è¡¨ç¤ºå½¢å¼);
        }
      }
    }

    /**
     * ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢
     */
    function clearAllSaleswordSettings() {
      if (!confirm('ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ»ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆã€ã€‘ï¼‰ã«æˆ»ã‚Šã¾ã™\nãƒ»ãƒ¯ãƒ¼ãƒ‰åˆ¥è¨­å®šãŒã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™')) {
        return;
      }

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«æˆ»ã™
      const prefixSelect = document.getElementById('saleswordPrefixGlobalSelect');
      const prefixCustom = document.getElementById('saleswordPrefixGlobalCustom');
      const suffixSelect = document.getElementById('saleswordSuffixGlobalSelect');
      const suffixCustom = document.getElementById('saleswordSuffixGlobalCustom');

      if (prefixSelect) {
        prefixSelect.value = 'ã€';
        prefixCustom.style.display = 'none';
        prefixCustom.value = '';
      }

      if (suffixSelect) {
        suffixSelect.value = 'ã€‘';
        suffixCustom.style.display = 'none';
        suffixCustom.value = '';
      }

      // ãƒ¯ãƒ¼ãƒ‰åˆ¥è¨­å®šã‚’ã™ã¹ã¦å‰Šé™¤
      WORD_OVERRIDES = [];
      renderWordOverrides();

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
      updateSaleswordFormatPreview();

      console.log('ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
    }

    // ========================================
    // ä»•å…¥ãƒ»å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
    // ========================================

    /**
     * ä»•å…¥ãƒ»å‡ºå“ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’åˆæœŸåŒ–ï¼ˆFirestoreã‹ã‚‰å–å¾—ï¼‰
     */
    async function initProcureListingDropdowns() {
      console.log('ğŸš€ ä»•å…¥ãƒ»å‡ºå“ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–é–‹å§‹');

      if (!window.db) {
        console.warn('âš ï¸ FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆä»•å…¥ãƒ»å‡ºå“ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰');
        return;
      }

      const savedConfig = localStorage.getItem('rebornConfig_procureListingDefault');
      const config = savedConfig ? JSON.parse(savedConfig) : {};

      // ä»•å…¥å…ˆã‚’å–å¾—
      let supplierOptions = [];
      try {
        console.log('ğŸ“¦ Firestoreã‹ã‚‰ä»•å…¥å…ˆä¸€è¦§ã‚’å–å¾—ä¸­...');
        const snapshot = await window.db.collection('suppliers')
          .orderBy('name', 'asc')
          .get();

        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.name) {
            supplierOptions.push(data.name);
          }
        });
        console.log('âœ… ä»•å…¥å…ˆ ' + supplierOptions.length + 'ä»¶ ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
      } catch (e) {
        console.error('âŒ ä»•å…¥å…ˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
      }

      // å‡ºå“å…ˆã‚’å–å¾—
      let salesChannelOptions = [];
      try {
        console.log('ğŸ“¦ Firestoreã‹ã‚‰å‡ºå“å…ˆä¸€è¦§ã‚’å–å¾—ä¸­...');
        const snapshot = await window.db.collection('salesChannels')
          .orderBy('name', 'asc')
          .get();

        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.name) {
            salesChannelOptions.push(data.name);
          }
        });
        console.log('âœ… å‡ºå“å…ˆ ' + salesChannelOptions.length + 'ä»¶ ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
      } catch (e) {
        console.error('âŒ å‡ºå“å…ˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
      }

      // ãƒ‡ãƒ¼ã‚¿ãŒä¸¡æ–¹0ä»¶ã®å ´åˆã€åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•æŠ•å…¥
      if (supplierOptions.length === 0 && salesChannelOptions.length === 0) {
        console.log('âš ï¸ ä»•å…¥å…ˆãƒ»å‡ºå“å…ˆãŒæœªç™»éŒ²ã§ã™ã€‚åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¾ã™...');
        await seedInitialMasterData();
        // å†å–å¾—
        return initProcureListingDropdowns();
      }

      // ä»•å…¥å…ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’åˆæœŸåŒ–
      const procureSelect = document.getElementById('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥å…ˆ');
      if (procureSelect) {
        populateSelect(procureSelect, supplierOptions);
        if (config.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥å…ˆ) {
          procureSelect.value = config.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥å…ˆ;
          console.log('âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥å…ˆã‚’è¨­å®šã—ã¾ã—ãŸ:', config.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥å…ˆ);
        }
        localStorage.setItem('masterData_ä»•å…¥å…ˆ', JSON.stringify(supplierOptions));
      }

      // å‡ºå“å…ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’åˆæœŸåŒ–
      const listingSelect = document.getElementById('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“å…ˆ');
      if (listingSelect) {
        populateSelect(listingSelect, salesChannelOptions);
        if (config.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“å…ˆ) {
          listingSelect.value = config.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“å…ˆ;
          console.log('âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“å…ˆã‚’è¨­å®šã—ã¾ã—ãŸ:', config.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“å…ˆ);
        }
        localStorage.setItem('masterData_å‡ºå“å…ˆ', JSON.stringify(salesChannelOptions));
      }
    }

    /**
     * ä»•å…¥å…ˆãƒ»å‡ºå“å…ˆã®åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥
     */
    async function seedInitialMasterData() {
      if (!window.db) return;

      const suppliers = [
        { name: 'å¤ç‰©å¸‚å ´' },
        { name: 'ã‚­ãƒ³ã‚°ãƒ•ã‚¡ãƒŸãƒªãƒ¼ å¹³äº•åº—' },
        { name: 'ã‚­ãƒ³ã‚°ãƒ•ã‚¡ãƒŸãƒªãƒ¼ å¤§å®‰å¯ºåº—' },
        { name: 'ã‚­ãƒ³ã‚°ãƒ•ã‚¡ãƒŸãƒªãƒ¼ å€‰æ•·å €å—åº—' },
        { name: 'ã‚¸ãƒ£ãƒ³ãƒ–ãƒ«ã‚¹ãƒˆã‚¢ åæ—¥å¸‚åº—' },
        { name: 'ã‚»ã‚«ãƒ³ãƒ‰ã‚¹ãƒˆãƒªãƒ¼ãƒˆ å€‰æ•·ç¬¹æ²–åº—' },
        { name: 'ã‚¢ãƒ³ãƒ†ã‚£ãƒƒã‚¯äº”ç•ªè¡— å²¡å±±åº—' },
        { name: 'ãƒ¡ãƒ«ã‚«ãƒª' },
        { name: 'Yahoo!ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³' },
        { name: 'Yahoo!ãƒ•ãƒªãƒ' },
        { name: 'ãƒ©ã‚¯ãƒ' },
        { name: 'ã‚¸ãƒ¢ãƒ†ã‚£ãƒ¼' },
        { name: 'ãã®ä»–' }
      ];

      const salesChannels = [
        { name: 'ãƒ¡ãƒ«ã‚«ãƒª', commission: 10 },
        { name: 'Yahoo!ãƒ•ãƒªãƒ', commission: 5 },
        { name: 'ãƒ¤ãƒ•ã‚ªã‚¯', commission: 10 },
        { name: 'ãƒ©ã‚¯ãƒ', commission: 6 },
        { name: 'ãƒ¡ãƒ«ã‚«ãƒªShops', commission: 10 },
        { name: 'BASE', commission: 3 }
      ];

      const batch = window.db.batch();

      // ä»•å…¥å…ˆã‚’è¿½åŠ 
      for (const supplier of suppliers) {
        const docRef = window.db.collection('suppliers').doc();
        batch.set(docRef, {
          ...supplier,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }

      // å‡ºå“å…ˆã‚’è¿½åŠ 
      for (const channel of salesChannels) {
        const docRef = window.db.collection('salesChannels').doc();
        batch.set(docRef, {
          ...channel,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }

      try {
        await batch.commit();
        console.log('âœ… åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥å®Œäº†: ä»•å…¥å…ˆ ' + suppliers.length + 'ä»¶, å‡ºå“å…ˆ ' + salesChannels.length + 'ä»¶');
      } catch (error) {
        console.error('âŒ åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    /**
     * selectã‚¿ã‚°ã«optionã‚’è¿½åŠ ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
     */
    function populateSelect(selectElement, options) {
      selectElement.innerHTML = '<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>';
      options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        selectElement.appendChild(option);
      });
    }

    /**
     * ä»•å…¥æ—¥ã®ã€Œå¸¸ã«ä»Šæ—¥ã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åˆ‡ã‚Šæ›¿ãˆæ™‚ã®å‡¦ç†
     */
    function toggleProcureDateField() {
      const checkbox = document.getElementById('ä»•å…¥æ—¥_ä»Šæ—¥');
      const dateField = document.getElementById('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥æ—¥');
      if (checkbox && dateField) {
        dateField.disabled = checkbox.checked;
        if (checkbox.checked) {
          dateField.style.background = '#f3f4f6';
          dateField.style.cursor = 'not-allowed';
        } else {
          dateField.style.background = 'white';
          dateField.style.cursor = 'pointer';
        }
      }
    }

    /**
     * å‡ºå“æ—¥ã®ã€Œå¸¸ã«ä»Šæ—¥ã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åˆ‡ã‚Šæ›¿ãˆæ™‚ã®å‡¦ç†
     */
    function toggleListingDateField() {
      const checkbox = document.getElementById('å‡ºå“æ—¥_ä»Šæ—¥');
      const dateField = document.getElementById('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“æ—¥');
      if (checkbox && dateField) {
        dateField.disabled = checkbox.checked;
        if (checkbox.checked) {
          dateField.style.background = '#f3f4f6';
          dateField.style.cursor = 'not-allowed';
        } else {
          dateField.style.background = 'white';
          dateField.style.cursor = 'pointer';
        }
      }
    }

    /**
     * ä»•å…¥ãƒ»å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’è¡¨ç¤º
     */
    function renderProcureListingDefaults(config) {
      console.log('ä»•å…¥ãƒ»å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’è¡¨ç¤º:', config);

      // ä»•å…¥æ—¥_ä»Šæ—¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
      const procureTodayCheckbox = document.getElementById('ä»•å…¥æ—¥_ä»Šæ—¥');
      if (procureTodayCheckbox) {
        procureTodayCheckbox.checked = config.ä»•å…¥æ—¥_ä»Šæ—¥ === true;
      }

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥æ—¥
      const procureDate = document.getElementById('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥æ—¥');
      if (procureDate) {
        procureDate.value = config.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥æ—¥ || '';
      }

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥å…ˆï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°å³åº§ã«è¨­å®šå¯èƒ½ï¼‰
      const procureSource = document.getElementById('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥å…ˆ');
      if (procureSource) {
        procureSource.value = config.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥å…ˆ || '';
        if (config.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥å…ˆ) {
          console.log('âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥å…ˆã‚’è¨­å®šã—ã¾ã—ãŸï¼ˆrenderProcureListingDefaultsï¼‰:', config.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥å…ˆ);
        }
      }

      // å‡ºå“æ—¥_ä»Šæ—¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
      const listingTodayCheckbox = document.getElementById('å‡ºå“æ—¥_ä»Šæ—¥');
      if (listingTodayCheckbox) {
        listingTodayCheckbox.checked = config.å‡ºå“æ—¥_ä»Šæ—¥ === true;
      }

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“æ—¥
      const listingDate = document.getElementById('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“æ—¥');
      if (listingDate) {
        listingDate.value = config.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“æ—¥ || '';
      }

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“å…ˆï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°å³åº§ã«è¨­å®šå¯èƒ½ï¼‰
      const listingDest = document.getElementById('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“å…ˆ');
      if (listingDest) {
        listingDest.value = config.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“å…ˆ || '';
        if (config.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“å…ˆ) {
          console.log('âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“å…ˆã‚’è¨­å®šã—ã¾ã—ãŸï¼ˆrenderProcureListingDefaultsï¼‰:', config.ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“å…ˆ);
        }
      }

      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã«å¿œã˜ã¦æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç„¡åŠ¹åŒ–
      toggleProcureDateField();
      toggleListingDateField();
    }

    /**
     * ä»•å…¥ãƒ»å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’åé›†
     */
    function collectProcureListingDefaults() {
      const result = {
        ä»•å…¥æ—¥_ä»Šæ—¥: document.getElementById('ä»•å…¥æ—¥_ä»Šæ—¥')?.checked || false,
        ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥æ—¥: document.getElementById('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥æ—¥')?.value || '',
        ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥å…ˆ: document.getElementById('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥å…ˆ')?.value || '',
        å‡ºå“æ—¥_ä»Šæ—¥: document.getElementById('å‡ºå“æ—¥_ä»Šæ—¥')?.checked || false,
        ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“æ—¥: document.getElementById('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“æ—¥')?.value || '',
        ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“å…ˆ: document.getElementById('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“å…ˆ')?.value || ''
      };
      console.log('ä»•å…¥ãƒ»å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’åé›†:', result);
      return result;
    }

    /**
     * ä»•å…¥ãƒ»å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢
     */
    function clearProcureListingDefaults() {
      if (!confirm('ä»•å…¥ãƒ»å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      document.getElementById('ä»•å…¥æ—¥_ä»Šæ—¥').checked = false;
      document.getElementById('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥æ—¥').value = '';
      document.getElementById('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•å…¥å…ˆ').value = '';
      document.getElementById('å‡ºå“æ—¥_ä»Šæ—¥').checked = false;
      document.getElementById('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“æ—¥').value = '';
      document.getElementById('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºå“å…ˆ').value = '';

      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢ã—ãŸã®ã§æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æœ‰åŠ¹åŒ–
      toggleProcureDateField();
      toggleListingDateField();

      alert('ä»•å…¥ãƒ»å‡ºå“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚\nå¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã€Œè¨­å®šã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
    }

    // ========================================
    // AIç”Ÿæˆè¨­å®šé–¢é€£ã®é–¢æ•°
    // ========================================

    /**
     * Temperatureè¡¨ç¤ºã‚’æ›´æ–°
     */
    function updateTempDisplay() {
      const slider = document.getElementById('aiTemperature');
      const display = document.getElementById('aiTempValue');
      if (slider && display) {
        const value = (parseInt(slider.value) / 10).toFixed(1);
        display.textContent = value;
      }
      updateAiConfigPreview();
    }

    /**
     * AIè¨­å®šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
     */
    function updateAiConfigPreview() {
      const prompt = document.getElementById('aiPromptTemplate')?.value || '';
      const length = document.querySelector('input[name="aiLength"]:checked')?.value || 'medium';
      const tone = document.getElementById('aiTone')?.value || 'casual';
      const temperature = (parseInt(document.getElementById('aiTemperature')?.value || 7) / 10).toFixed(1);
      const maxTokens = document.getElementById('aiMaxTokens')?.value || '500';

      const lengthText = {
        'short': '150-200å­—',
        'medium': '200-300å­—',
        'long': '300-500å­—'
      }[length];

      const toneText = {
        'casual': 'ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«',
        'polite': 'ä¸å¯§',
        'enthusiastic': 'ç†±é‡é«˜ã‚'
      }[tone];

      // å«ã‚ã‚‹è¦ç´ ã‚’ãƒã‚§ãƒƒã‚¯
      const includes = [];
      if (document.getElementById('aiIncludeBrand')?.checked) includes.push('ãƒ–ãƒ©ãƒ³ãƒ‰');
      if (document.getElementById('aiIncludeCategory')?.checked) includes.push('ã‚«ãƒ†ã‚´ãƒª');
      if (document.getElementById('aiIncludeSize')?.checked) includes.push('ã‚µã‚¤ã‚º');
      if (document.getElementById('aiIncludeMaterial')?.checked) includes.push('ç´ æ');
      if (document.getElementById('aiIncludeColor')?.checked) includes.push('ã‚«ãƒ©ãƒ¼');
      if (document.getElementById('aiIncludeCondition')?.checked) includes.push('å•†å“çŠ¶æ…‹');
      if (document.getElementById('aiIncludeCoordinate')?.checked) includes.push('ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ãƒˆ');
      if (document.getElementById('aiIncludeScene')?.checked) includes.push('ç€ç”¨ã‚·ãƒ¼ãƒ³');

      const preview = `
ã€ç¾åœ¨ã®è¨­å®šã€‘

ğŸ“ æ–‡å­—æ•°: ${lengthText}
ğŸ­ ãƒˆãƒ¼ãƒ³: ${toneText}
ğŸŒ¡ï¸ Temperature: ${temperature}
ğŸ“Š Max Tokens: ${maxTokens}

â˜‘ï¸ å«ã‚ã‚‹è¦ç´ :
${includes.join('ã€')}

ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:
${prompt || 'ï¼ˆæœªè¨­å®šï¼‰'}
      `.trim();

      const previewEl = document.getElementById('aiConfigPreview');
      if (previewEl) {
        previewEl.textContent = preview;
      }
    }

    /**
     * ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é©ç”¨
     */
    function applyAiPreset(presetName) {
      const presets = {
        casual: {
          prompt: `ä»¥ä¸‹ã®å•†å“æƒ…å ±ã‹ã‚‰ã€ãƒ¡ãƒ«ã‚«ãƒªå‘ã‘ã®é­…åŠ›çš„ãªå•†å“èª¬æ˜æ–‡ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ãƒ–ãƒ©ãƒ³ãƒ‰: {brand}
ã‚¢ã‚¤ãƒ†ãƒ : {item}
ã‚«ãƒ†ã‚´ãƒª: {category}
ã‚µã‚¤ã‚º: {size}
çŠ¶æ…‹: {condition}
ç´ æ: {material}
ã‚«ãƒ©ãƒ¼: {color}

ã€æŒ‡ç¤ºã€‘
ãƒ»ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã§ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãªæ–‡ä½“ã§æ›¸ã„ã¦ãã ã•ã„
ãƒ»å•†å“ã®ç‰¹å¾´ã‚„é­…åŠ›ã‚’å…·ä½“çš„ã«ä¼ãˆã¦ãã ã•ã„
ãƒ»ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ãƒˆææ¡ˆã‚„ç€ç”¨ã‚·ãƒ¼ãƒ³ã‚’å«ã‚ã¦ãã ã•ã„
ãƒ»{length}æ–‡å­—ç¨‹åº¦ã§ç°¡æ½”ã«ã¾ã¨ã‚ã¦ãã ã•ã„`,
          length: 'medium',
          tone: 'casual',
          headingStyle: 'emoji',
          temperature: 7,
          maxTokens: 500
        },
        standard: {
          prompt: `ä»¥ä¸‹ã®å•†å“æƒ…å ±ã‹ã‚‰ã€ãƒ¡ãƒ«ã‚«ãƒªå‘ã‘ã®å•†å“èª¬æ˜æ–‡ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ãƒ–ãƒ©ãƒ³ãƒ‰: {brand}
ã‚¢ã‚¤ãƒ†ãƒ : {item}
ã‚«ãƒ†ã‚´ãƒª: {category}
ã‚µã‚¤ã‚º: {size}
çŠ¶æ…‹: {condition}
ç´ æ: {material}
ã‚«ãƒ©ãƒ¼: {color}

ã€æŒ‡ç¤ºã€‘
ãƒ»ä¸å¯§ã§è¦ªã—ã¿ã‚„ã™ã„æ–‡ä½“ã§æ›¸ã„ã¦ãã ã•ã„
ãƒ»ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã ãŒå …è‹¦ã—ããªã„è¡¨ç¾ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„
ãƒ»å•†å“ã®é­…åŠ›ã‚„ç‰¹å¾´ã‚’ã‚ã‹ã‚Šã‚„ã™ãä¼ãˆã¦ãã ã•ã„
ãƒ»ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ãƒˆææ¡ˆã‚„ç€ç”¨ã‚·ãƒ¼ãƒ³ã‚’å«ã‚ã¦ãã ã•ã„
ãƒ»{length}æ–‡å­—ç¨‹åº¦ã§ã¾ã¨ã‚ã¦ãã ã•ã„`,
          length: 'medium',
          tone: 'standard',
          headingStyle: 'brackets',
          temperature: 6,
          maxTokens: 500
        },
        polite: {
          prompt: `ä»¥ä¸‹ã®å•†å“æƒ…å ±ã‹ã‚‰ã€ä¸å¯§ã§ãƒ“ã‚¸ãƒã‚¹ãƒ©ã‚¤ã‚¯ãªå•†å“èª¬æ˜æ–‡ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ãƒ–ãƒ©ãƒ³ãƒ‰: {brand}
ã‚¢ã‚¤ãƒ†ãƒ : {item}
ã‚«ãƒ†ã‚´ãƒª: {category}
ã‚µã‚¤ã‚º: {size}
çŠ¶æ…‹: {condition}
ç´ æ: {material}
ã‚«ãƒ©ãƒ¼: {color}

ã€æŒ‡ç¤ºã€‘
ãƒ»ä¸å¯§ã§æ ¼èª¿é«˜ã„æ–‡ä½“ã§æ›¸ã„ã¦ãã ã•ã„
ãƒ»å•†å“ã®ã‚¯ã‚ªãƒªãƒ†ã‚£ã‚„ä¾¡å€¤ã‚’å¼·èª¿ã—ã¦ãã ã•ã„
ãƒ»ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªå°è±¡ã‚’ä¸ãˆã¦ãã ã•ã„
ãƒ»{length}æ–‡å­—ç¨‹åº¦ã§ã¾ã¨ã‚ã¦ãã ã•ã„`,
          length: 'medium',
          tone: 'polite',
          headingStyle: 'none',
          temperature: 5,
          maxTokens: 500
        },
        enthusiastic: {
          prompt: `ä»¥ä¸‹ã®å•†å“æƒ…å ±ã‹ã‚‰ã€ç†±é‡é«˜ã‚ã§ãŠã™ã™ã‚æ„Ÿã®å¼·ã„å•†å“èª¬æ˜æ–‡ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ãƒ–ãƒ©ãƒ³ãƒ‰: {brand}
ã‚¢ã‚¤ãƒ†ãƒ : {item}
ã‚«ãƒ†ã‚´ãƒª: {category}
ã‚µã‚¤ã‚º: {size}
çŠ¶æ…‹: {condition}
ç´ æ: {material}
ã‚«ãƒ©ãƒ¼: {color}

ã€æŒ‡ç¤ºã€‘
ãƒ»ç†±é‡é«˜ã‚ã§ã€ãŠã™ã™ã‚æ„Ÿã‚’å¼·èª¿ã—ã¦ãã ã•ã„
ãƒ»å•†å“ã®é­…åŠ›ã‚’å…¨é¢çš„ã«ã‚¢ãƒ”ãƒ¼ãƒ«ã—ã¦ãã ã•ã„
ãƒ»ã€ŒãŠã™ã™ã‚ã€ã€Œã‚¤ãƒã‚ªã‚·ã€ãªã©ã®è¨€è‘‰ã‚’åŠ¹æœçš„ã«ä½¿ã£ã¦ãã ã•ã„
ãƒ»è³¼è²·æ„æ¬²ã‚’é«˜ã‚ã‚‹è¡¨ç¾ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„
ãƒ»{length}æ–‡å­—ç¨‹åº¦ã§ã¾ã¨ã‚ã¦ãã ã•ã„`,
          length: 'medium',
          tone: 'enthusiastic',
          headingStyle: 'emoji',
          temperature: 8,
          maxTokens: 500
        },
        concise: {
          prompt: `ä»¥ä¸‹ã®å•†å“æƒ…å ±ã‹ã‚‰ã€ç°¡æ½”ãªå•†å“èª¬æ˜æ–‡ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ãƒ–ãƒ©ãƒ³ãƒ‰: {brand}
ã‚¢ã‚¤ãƒ†ãƒ : {item}
ã‚«ãƒ†ã‚´ãƒª: {category}
ã‚µã‚¤ã‚º: {size}
çŠ¶æ…‹: {condition}
ç´ æ: {material}
ã‚«ãƒ©ãƒ¼: {color}

ã€æŒ‡ç¤ºã€‘
ãƒ»ã‚·ãƒ³ãƒ—ãƒ«ã§åˆ†ã‹ã‚Šã‚„ã™ã„æ–‡ä½“ã§æ›¸ã„ã¦ãã ã•ã„
ãƒ»è¦ç‚¹ã‚’çµã£ã¦ç°¡æ½”ã«ã¾ã¨ã‚ã¦ãã ã•ã„
ãƒ»150-200æ–‡å­—ç¨‹åº¦ã®çŸ­æ–‡ã§æ›¸ã„ã¦ãã ã•ã„`,
          length: 'short',
          tone: 'casual',
          headingStyle: 'none',
          temperature: 5,
          maxTokens: 300
        },
        detailed: {
          prompt: `ä»¥ä¸‹ã®å•†å“æƒ…å ±ã‹ã‚‰ã€è©³ç´°ãªå•†å“èª¬æ˜æ–‡ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ãƒ–ãƒ©ãƒ³ãƒ‰: {brand}
ã‚¢ã‚¤ãƒ†ãƒ : {item}
ã‚«ãƒ†ã‚´ãƒª: {category}
ã‚µã‚¤ã‚º: {size}
çŠ¶æ…‹: {condition}
ç´ æ: {material}
ã‚«ãƒ©ãƒ¼: {color}

ã€æŒ‡ç¤ºã€‘
ãƒ»å•†å“ã®ç´°éƒ¨ã¾ã§ä¸å¯§ã«èª¬æ˜ã—ã¦ãã ã•ã„
ãƒ»ãƒ–ãƒ©ãƒ³ãƒ‰ã®ç‰¹å¾´ã‚„æ­´å²ã«ã‚‚è¨€åŠã—ã¦ãã ã•ã„
ãƒ»è¤‡æ•°ã®ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ãƒˆææ¡ˆã‚„ç€ç”¨ã‚·ãƒ¼ãƒ³ã‚’å«ã‚ã¦ãã ã•ã„
ãƒ»300-500æ–‡å­—ç¨‹åº¦ã®è©³ç´°ãªèª¬æ˜æ–‡ã‚’ä½œæˆã—ã¦ãã ã•ã„`,
          length: 'long',
          tone: 'polite',
          headingStyle: 'brackets',
          temperature: 8,
          maxTokens: 1000
        }
      };

      const preset = presets[presetName];
      if (!preset) return;

      // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
      document.getElementById('aiPromptTemplate').value = preset.prompt;

      // æ–‡å­—æ•°
      const lengthRadios = document.querySelectorAll('input[name="aiLength"]');
      lengthRadios.forEach(radio => {
        radio.checked = radio.value === preset.length;
      });

      // ãƒˆãƒ¼ãƒ³
      document.getElementById('aiTone').value = preset.tone;

      // è¦‹å‡ºã—ã‚¹ã‚¿ã‚¤ãƒ«
      if (preset.headingStyle) {
        document.getElementById('aiHeadingStyle').value = preset.headingStyle;
      }

      // Temperature
      document.getElementById('aiTemperature').value = preset.temperature;
      updateTempDisplay();

      // Max Tokens
      document.getElementById('aiMaxTokens').value = preset.maxTokens;

      // ã™ã¹ã¦ã®è¦ç´ ã‚’ãƒã‚§ãƒƒã‚¯
      document.getElementById('aiIncludeBrand').checked = true;
      document.getElementById('aiIncludeCategory').checked = true;
      document.getElementById('aiIncludeSize').checked = true;
      document.getElementById('aiIncludeMaterial').checked = true;
      document.getElementById('aiIncludeColor').checked = true;
      document.getElementById('aiIncludeCondition').checked = true;
      document.getElementById('aiIncludeCoordinate').checked = true;
      document.getElementById('aiIncludeScene').checked = true;

      updateAiConfigPreview();

      const presetNames = {
        'casual': 'ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ï¼ˆãƒ¡ãƒ«ã‚«ãƒªå‘ã‘ï¼‰',
        'polite': 'ä¸å¯§ï¼ˆãƒ“ã‚¸ãƒã‚¹å‘ã‘ï¼‰',
        'concise': 'ç°¡æ½”ï¼ˆçŸ­æ–‡ï¼‰',
        'detailed': 'è©³ç´°ï¼ˆé•·æ–‡ï¼‰'
      };

      alert(`âœ… ãƒ—ãƒªã‚»ãƒƒãƒˆã€Œ${presetNames[presetName]}ã€ã‚’é©ç”¨ã—ã¾ã—ãŸï¼\n\nå†…å®¹ã‚’ç¢ºèªã—ã¦ã€å¿…è¦ã«å¿œã˜ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ãã ã•ã„ã€‚\nè¨­å®šã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã€Œè¨­å®šã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚`);
    }

    /**
     * AIè¨­å®šã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
     */
    function renderAiSettings(config) {
      console.log('AIç”Ÿæˆè¨­å®šã‚’è¡¨ç¤º:', config);

      // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
      const promptTemplate = document.getElementById('aiPromptTemplate');
      if (promptTemplate) {
        promptTemplate.value = config.promptTemplate || '';
      }

      // æ–‡å­—æ•°
      const lengthValue = config.length || 'medium';
      const lengthRadios = document.querySelectorAll('input[name="aiLength"]');
      lengthRadios.forEach(radio => {
        radio.checked = radio.value === lengthValue;
      });

      // ãƒˆãƒ¼ãƒ³
      const tone = document.getElementById('aiTone');
      if (tone) {
        tone.value = config.tone || 'casual';
      }

      // è¦‹å‡ºã—ã‚¹ã‚¿ã‚¤ãƒ«
      const headingStyle = document.getElementById('aiHeadingStyle');
      if (headingStyle) {
        headingStyle.value = config.headingStyle || 'brackets';
      }

      // Temperature
      const temperature = document.getElementById('aiTemperature');
      if (temperature) {
        temperature.value = Math.round((config.temperature || 0.7) * 10);
        updateTempDisplay();
      }

      // Max Tokens
      const maxTokens = document.getElementById('aiMaxTokens');
      if (maxTokens) {
        maxTokens.value = config.maxTokens || 500;
      }

      // å«ã‚ã‚‹è¦ç´ 
      document.getElementById('aiIncludeBrand').checked = config.includeBrand !== false;
      document.getElementById('aiIncludeCategory').checked = config.includeCategory !== false;
      document.getElementById('aiIncludeSize').checked = config.includeSize !== false;
      document.getElementById('aiIncludeMaterial').checked = config.includeMaterial !== false;
      document.getElementById('aiIncludeColor').checked = config.includeColor !== false;
      document.getElementById('aiIncludeAttributes').checked = config.includeAttributes !== false;
      document.getElementById('aiIncludeCondition').checked = config.includeCondition !== false;
      document.getElementById('aiIncludeCoordinate').checked = config.includeCoordinate !== false;
      document.getElementById('aiIncludeScene').checked = config.includeScene !== false;

      // é…ç½®é †åº
      renderDescriptionOrder(config.descriptionOrder || DESCRIPTION_ELEMENTS);

      updateAiConfigPreview();
    }

    /**
     * AIè¨­å®šã‚’åé›†
     */
    function collectAiSettings() {
      const lengthRadio = document.querySelector('input[name="aiLength"]:checked');

      const result = {
        promptTemplate: document.getElementById('aiPromptTemplate')?.value || '',
        length: lengthRadio?.value || 'medium',
        tone: document.getElementById('aiTone')?.value || 'casual',
        headingStyle: document.getElementById('aiHeadingStyle')?.value || 'brackets',
        temperature: parseInt(document.getElementById('aiTemperature')?.value || 7) / 10,
        maxTokens: parseInt(document.getElementById('aiMaxTokens')?.value || 500),
        includeBrand: document.getElementById('aiIncludeBrand')?.checked || false,
        includeCategory: document.getElementById('aiIncludeCategory')?.checked || false,
        includeSize: document.getElementById('aiIncludeSize')?.checked || false,
        includeMaterial: document.getElementById('aiIncludeMaterial')?.checked || false,
        includeColor: document.getElementById('aiIncludeColor')?.checked || false,
        includeAttributes: document.getElementById('aiIncludeAttributes')?.checked || false,
        includeCondition: document.getElementById('aiIncludeCondition')?.checked || false,
        includeCoordinate: document.getElementById('aiIncludeCoordinate')?.checked || false,
        includeScene: document.getElementById('aiIncludeScene')?.checked || false,
        descriptionOrder: collectDescriptionOrder()
      };

      console.log('AIç”Ÿæˆè¨­å®šã‚’åé›†:', result);
      return result;
    }

    /**
     * ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã‚’åé›†
     */
    function collectPlatformSettings() {
      const modeRadio = document.querySelector('input[name="registrationMode"]:checked');
      const platforms = [];

      // å„ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’åé›†
      const platformIds = ['mercari', 'mercari-shops', 'yahoo-fleamarket', 'yahoo-auction', 'rakuma', 'base'];
      platformIds.forEach(id => {
        const checkbox = document.getElementById('platform-' + id);
        if (checkbox) {
          platforms.push({
            id: id,
            enabled: checkbox.checked
          });
        }
      });

      const result = {
        registrationMode: modeRadio?.value || 'individual',
        platforms: platforms
      };

      console.log('ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã‚’åé›†:', result);
      return result;
    }

    /**
     * ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã‚’èª­ã¿è¾¼ã¿
     */
    function loadPlatformSettings(config) {
      if (!config || !config.ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š) {
        console.log('ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
        return;
      }

      const settings = config.ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š;
      console.log('ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã‚’èª­ã¿è¾¼ã¿:', settings);

      // ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š
      if (settings.registrationMode) {
        const modeRadio = document.getElementById(settings.registrationMode === 'batch' ? 'modeBatch' : 'modeIndividual');
        if (modeRadio) {
          modeRadio.checked = true;
          selectRegistrationMode(settings.registrationMode);
        }
      }

      // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’è¨­å®š
      if (settings.platforms && Array.isArray(settings.platforms)) {
        settings.platforms.forEach(platform => {
          const checkbox = document.getElementById('platform-' + platform.id);
          if (checkbox) {
            checkbox.checked = platform.enabled;
          }
        });
      }
    }

    /**
     * ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«æ›´æ–°ï¼‰
     */
    function selectRegistrationMode(mode) {
      const individualLabel = document.querySelector('label[onclick="selectRegistrationMode(\'individual\')"]');
      const batchLabel = document.querySelector('label[onclick="selectRegistrationMode(\'batch\')"]');

      if (individualLabel && batchLabel) {
        if (mode === 'individual') {
          individualLabel.style.borderColor = '#40B4E5';
          individualLabel.style.background = '#f0f9ff';
          batchLabel.style.borderColor = '#e5e7eb';
          batchLabel.style.background = 'transparent';
        } else {
          batchLabel.style.borderColor = '#40B4E5';
          batchLabel.style.background = '#f0f9ff';
          individualLabel.style.borderColor = '#e5e7eb';
          individualLabel.style.background = 'transparent';
        }
      }
    }

    /**
     * é…ç½®é †åºã®å®šç¾©
     */
    const DESCRIPTION_ELEMENTS = [
      { id: 'brand', label: 'ğŸ¢ ãƒ–ãƒ©ãƒ³ãƒ‰æƒ…å ±', enabled: true },
      { id: 'color', label: 'ğŸ¨ ã‚«ãƒ©ãƒ¼(è©³ç´°)', enabled: true },
      { id: 'size', label: 'ğŸ“ ã‚µã‚¤ã‚ºæƒ…å ±', enabled: true },
      { id: 'material', label: 'ğŸ§µ ç´ ææƒ…å ±', enabled: true },
      { id: 'condition', label: 'ğŸ“‹ å•†å“ã®çŠ¶æ…‹', enabled: true },
      { id: 'ai', label: 'âœ¨ AIç”Ÿæˆæ–‡', enabled: true },
      { id: 'management', label: 'ğŸ”¢ ç®¡ç†ç•ªå·', enabled: true },
      { id: 'discount', label: 'ğŸ’° å‰²å¼•æƒ…å ±', enabled: true },
      { id: 'hashtag', label: 'ğŸ·ï¸ ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°', enabled: true }
    ];

    /**
     * é…ç½®é †åºãƒªã‚¹ãƒˆã‚’æç”»
     */
    let draggedElement = null;

    function renderDescriptionOrder(order) {
      console.log('é…ç½®é †åºã‚’è¡¨ç¤º:', order);

      const container = document.getElementById('descriptionOrderList');
      if (!container) return;

      container.innerHTML = '';

      // é †åºé…åˆ—ãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä½¿ç”¨
      const elements = order && order.length > 0 ? order : DESCRIPTION_ELEMENTS;

      elements.forEach((element, index) => {
        const item = document.createElement('div');
        item.draggable = true;
        item.dataset.elementId = element.id;
        item.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; cursor: move; transition: all 0.2s; user-select: none;';

        // ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«
        const handle = document.createElement('span');
        handle.textContent = 'â‹®â‹®';
        handle.style.cssText = 'font-size: 16px; color: #9ca3af; cursor: move;';
        item.appendChild(handle);

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = element.enabled !== false;
        checkbox.style.cssText = 'width: 18px; height: 18px; cursor: pointer;';
        checkbox.addEventListener('change', () => {
          updateDescriptionOrderPreview();
        });
        item.appendChild(checkbox);

        // ãƒ©ãƒ™ãƒ«
        const label = document.createElement('span');
        label.textContent = element.label;
        label.style.cssText = 'flex: 1; font-size: 13px; font-weight: 500; color: #374151;';
        item.appendChild(label);

        // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆ
        item.addEventListener('dragstart', (e) => {
          draggedElement = item;
          e.dataTransfer.effectAllowed = 'move';
          item.style.opacity = '0.5';
        });

        item.addEventListener('dragend', (e) => {
          item.style.opacity = '1';
          draggedElement = null;
        });

        item.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';

          if (draggedElement && draggedElement !== item) {
            item.style.borderColor = '#3b82f6';
            item.style.background = '#eff6ff';
          }
        });

        item.addEventListener('dragleave', (e) => {
          item.style.borderColor = '#e5e7eb';
          item.style.background = 'white';
        });

        item.addEventListener('drop', (e) => {
          e.preventDefault();
          e.stopPropagation();

          item.style.borderColor = '#e5e7eb';
          item.style.background = 'white';

          if (draggedElement && draggedElement !== item) {
            // ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã„ã‚‹è¦ç´ ã®ç¾åœ¨ä½ç½®ã‚’å–å¾—
            const allItems = Array.from(container.children);
            const draggedIndex = allItems.indexOf(draggedElement);
            const targetIndex = allItems.indexOf(item);

            // ãƒ‰ãƒ­ãƒƒãƒ—å…ˆã®å‰ã«æŒ¿å…¥
            if (draggedIndex < targetIndex) {
              // ä¸‹ã«ç§»å‹•ã™ã‚‹å ´åˆã¯ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®æ¬¡ã«æŒ¿å…¥
              container.insertBefore(draggedElement, item.nextSibling);
            } else {
              // ä¸Šã«ç§»å‹•ã™ã‚‹å ´åˆã¯ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®å‰ã«æŒ¿å…¥
              container.insertBefore(draggedElement, item);
            }

            updateDescriptionOrderPreview();
          }
        });

        container.appendChild(item);
      });

      updateDescriptionOrderPreview();
    }

    /**
     * é…ç½®é †åºãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
     */
    function updateDescriptionOrderPreview() {
      const container = document.getElementById('descriptionOrderList');
      const preview = document.getElementById('descriptionOrderPreview');

      if (!container || !preview) return;

      const items = Array.from(container.children);
      const enabledItems = items
        .map((item, index) => {
          const checkbox = item.querySelector('input[type="checkbox"]');
          const label = item.querySelector('span:last-child');
          return {
            index: index + 1,
            label: label.textContent,
            enabled: checkbox.checked
          };
        })
        .filter(item => item.enabled);

      if (enabledItems.length === 0) {
        preview.textContent = 'ï¼ˆã™ã¹ã¦éè¡¨ç¤ºï¼‰';
        preview.style.color = '#ef4444';
      } else {
        preview.innerHTML = enabledItems
          .map(item => `${item.index}. ${item.label}`)
          .join('<br>');
        preview.style.color = '#374151';
      }
    }

    /**
     * é…ç½®é †åºã‚’åé›†
     */
    function collectDescriptionOrder() {
      const container = document.getElementById('descriptionOrderList');
      if (!container) return DESCRIPTION_ELEMENTS;

      const items = Array.from(container.children);
      return items.map(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        const elementId = item.dataset.elementId;
        const element = DESCRIPTION_ELEMENTS.find(e => e.id === elementId);

        return {
          id: elementId,
          label: element ? element.label : '',
          enabled: checkbox.checked
        };
      });
    }

    /**
     * é…ç½®é †åºã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
     */
    function resetDescriptionOrder() {
      if (!confirm('é…ç½®é †åºã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      renderDescriptionOrder(DESCRIPTION_ELEMENTS);
      alert('é…ç½®é †åºã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸã€‚\nå¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã€Œè¨­å®šã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
    }

    /**
     * AIè¨­å®šã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢
     */
    function clearAiSettings() {
      if (!confirm('AIç”Ÿæˆè¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ï¼‰ã‚’é©ç”¨
      applyAiPreset('casual');

      alert('AIç”Ÿæˆè¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ï¼‰ã«æˆ»ã—ã¾ã—ãŸã€‚\nå¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã€Œè¨­å®šã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
    }

    // ========================================
    // ã‚¿ãƒ–ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼å®Ÿè£… (UI-014 Phase 2)
    // ========================================

    // å•†å“ç™»éŒ²è¨­å®šã‚¿ãƒ–ã®ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼
    (function() {
      const productTabContent = document.getElementById('productConfigTabContent');
      if (!productTabContent) return;

      const tabIds = ['product-salesword', 'product-condition', 'product-hashtag', 'product-discount', 'product-ai'];
      let touchStartX = 0;
      let touchStartY = 0;
      let touchEndX = 0;
      let touchEndY = 0;
      const minSwipeDistance = 50; // æœ€å°ã‚¹ãƒ¯ã‚¤ãƒ—è·é›¢ï¼ˆpxï¼‰

      productTabContent.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
      }, { passive: true });

      productTabContent.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleSwipe('product');
      }, { passive: true });

      function handleSwipe(prefix) {
        const diffX = touchStartX - touchEndX;
        const diffY = touchStartY - touchEndY;

        // æ°´å¹³ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¤å®š: æ¨ªç§»å‹•ãŒç¸¦ç§»å‹•ã‚ˆã‚Šå¤§ãã„å ´åˆã®ã¿åå¿œ
        if (Math.abs(diffX) < minSwipeDistance) return; // ã‚¹ãƒ¯ã‚¤ãƒ—è·é›¢ãŒçŸ­ã„å ´åˆã¯ç„¡è¦–
        if (Math.abs(diffY) > Math.abs(diffX)) return; // ç¸¦ç§»å‹•ãŒå¤§ãã„å ´åˆã¯ç„¡è¦–

        // ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ã‚’å–å¾—
        const activeTab = document.querySelector(`#${prefix}ConfigTabs .nav-link.active`);
        if (!activeTab) return;

        const currentId = activeTab.id.replace('-tab', '');
        const currentIndex = tabIds.indexOf(currentId);
        if (currentIndex === -1) return;

        let nextIndex;
        if (diffX > 0) {
          // å·¦ã‚¹ãƒ¯ã‚¤ãƒ— = æ¬¡ã®ã‚¿ãƒ–ã¸
          nextIndex = currentIndex + 1;
          if (nextIndex >= tabIds.length) return; // æœ€å¾Œã®ã‚¿ãƒ–ã®å ´åˆã¯ç„¡è¦–
        } else {
          // å³ã‚¹ãƒ¯ã‚¤ãƒ— = å‰ã®ã‚¿ãƒ–ã¸
          nextIndex = currentIndex - 1;
          if (nextIndex < 0) return; // æœ€åˆã®ã‚¿ãƒ–ã®å ´åˆã¯ç„¡è¦–
        }

        // æ¬¡ã®ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
        const nextTabId = tabIds[nextIndex];
        const nextTabButton = document.getElementById(`${nextTabId}-tab`);
        if (nextTabButton) {
          const tab = new bootstrap.Tab(nextTabButton);
          tab.show();

          // ã‚¿ãƒ–è‡ªä½“ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
          const tabsContainer = document.getElementById(`${prefix}ConfigTabs`);
          if (tabsContainer) {
            nextTabButton.scrollIntoView({
              behavior: 'smooth',
              block: 'nearest',
              inline: 'center'
            });
          }
        }
      }
    })();

    // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚¿ãƒ–ã®ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼
    (function() {
      const systemTabContent = document.getElementById('systemConfigTabContent');
      if (!systemTabContent) return;

      const tabIds = ['system-basic', 'system-management', 'system-shipping', 'system-procure', 'system-permission'];
      let touchStartX = 0;
      let touchStartY = 0;
      let touchEndX = 0;
      let touchEndY = 0;
      const minSwipeDistance = 50;

      systemTabContent.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
      }, { passive: true });

      systemTabContent.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleSwipe();
      }, { passive: true });

      function handleSwipe() {
        const diffX = touchStartX - touchEndX;
        const diffY = touchStartY - touchEndY;

        // æ°´å¹³ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¤å®š: æ¨ªç§»å‹•ãŒç¸¦ç§»å‹•ã‚ˆã‚Šå¤§ãã„å ´åˆã®ã¿åå¿œ
        if (Math.abs(diffX) < minSwipeDistance) return;
        if (Math.abs(diffY) > Math.abs(diffX)) return; // ç¸¦ç§»å‹•ãŒå¤§ãã„å ´åˆã¯ç„¡è¦–

        const activeTab = document.querySelector('#systemConfigTabs .nav-link.active');
        if (!activeTab) return;

        const currentId = activeTab.id.replace('-tab', '');
        const currentIndex = tabIds.indexOf(currentId);
        if (currentIndex === -1) return;

        let nextIndex;
        if (diffX > 0) {
          nextIndex = currentIndex + 1;
          if (nextIndex >= tabIds.length) return;
        } else {
          nextIndex = currentIndex - 1;
          if (nextIndex < 0) return;
        }

        const nextTabId = tabIds[nextIndex];
        const nextTabButton = document.getElementById(`${nextTabId}-tab`);
        if (nextTabButton) {
          const tab = new bootstrap.Tab(nextTabButton);
          tab.show();

          // ã‚¿ãƒ–è‡ªä½“ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
          const tabsContainer = document.getElementById('systemConfigTabs');
          if (tabsContainer) {
            nextTabButton.scrollIntoView({
              behavior: 'smooth',
              block: 'nearest',
              inline: 'center'
            });
          }
        }
      }
    })();
  </script>

  <!-- Firebase SDK (compatç‰ˆ: UMDå½¢å¼) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <!-- FirebaseåˆæœŸåŒ–ï¼ˆproduct.htmlã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼šå³åº§ã«å®Ÿè¡Œï¼‰ -->
  <script>
    // Firebaseè¨­å®šï¼ˆreborn-chatãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«çµ±ä¸€ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "furira.jp",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    // Firebaseå³åº§ã«åˆæœŸåŒ–ï¼ˆproduct.htmlã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
    try {
      if (typeof firebase !== 'undefined') {
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        window.db = db; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
        window.firestoreReady = true;

        // æ¢±åŒ…è³‡æä¸€è¦§ã‚’èª­ã¿è¾¼ã‚“ã§ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«è¨­å®š
        loadPackagingMaterials();

        // ä»•å…¥ãƒ»å‡ºå“ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’åˆæœŸåŒ–ï¼ˆFirebaseåˆæœŸåŒ–å¾Œã«å®Ÿè¡Œï¼‰
        initProcureListingDropdowns();
      } else {
        console.error('âŒ Firebase SDKãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
      }
    } catch (error) {
      console.error('âŒ FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
    }

    /**
     * Firestoreã‹ã‚‰æ¢±åŒ…è³‡æä¸€è¦§ã‚’å–å¾—ã—ã¦ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«è¨­å®š
     */
    async function loadPackagingMaterials() {
      if (!window.db) {
        console.warn('âš ï¸ FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆæ¢±åŒ…è³‡æèª­ã¿è¾¼ã¿ã‚¹ã‚­ãƒƒãƒ—ï¼‰');
        return;
      }

      try {
        console.log('ğŸ“¦ Firestoreã‹ã‚‰æ¢±åŒ…è³‡æä¸€è¦§ã‚’å–å¾—ä¸­...');
        const snapshot = await window.db.collection('packagingMaterials')
          .orderBy('name', 'asc')
          .get();

        const select = document.getElementById('æ¢±åŒ…è³‡æãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ');
        if (!select) {
          console.warn('âš ï¸ æ¢±åŒ…è³‡æãƒ‡ãƒ•ã‚©ãƒ«ãƒˆselectãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆã€Œ-- é¸æŠã—ã¦ãã ã•ã„ --ã€ï¼‰ã¯æ®‹ã—ã¦ã€ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
        snapshot.forEach(doc => {
          const data = doc.data();
          const option = document.createElement('option');
          option.value = data.name;
          option.textContent = data.name + (data.abbreviation ? ` (${data.abbreviation})` : '');
          select.appendChild(option);
        });

        console.log(`âœ… æ¢±åŒ…è³‡æ ${snapshot.size}ä»¶ ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
      } catch (error) {
        console.error('âŒ æ¢±åŒ…è³‡æèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ================= æ¨©é™ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ï¼ˆPERM-001ï¼‰ =================

    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦UIã‚’åˆ¶å¾¡
     * Firestoreã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ¨©é™è¨­å®šã«åŸºã¥ã„ã¦ã‚µãƒ–ã‚¿ãƒ–å˜ä½ã§è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ¶å¾¡
     */
    async function checkUserPermissionAndUpdateUI() {
      try {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ï¼ˆFirestoreã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰
        const userEmail = localStorage.getItem('reborn_user_email');
        const userName = localStorage.getItem('reborn_user_name');
        if (!userEmail) {
          console.warn('âš ï¸ [æ¨©é™ãƒã‚§ãƒƒã‚¯] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        console.log('ğŸ” [æ¨©é™ãƒã‚§ãƒƒã‚¯] ãƒ¦ãƒ¼ã‚¶ãƒ¼:', userName, '(', userEmail, ')');

        // Firestoreã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
        if (!window.db) {
          console.warn('âš ï¸ [æ¨©é™ãƒã‚§ãƒƒã‚¯] FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
          return;
        }

        const userDoc = await window.db.collection('users').doc(userEmail).get();

        if (!userDoc.exists) {
          console.warn('âš ï¸ [æ¨©é™ãƒã‚§ãƒƒã‚¯] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        const userData = userDoc.data();
        const permissionId = userData.permissionId || 'staff';
        const permissionDisplay = userData.permissionDisplay || 'ã‚¹ã‚¿ãƒƒãƒ•';

        console.log('ğŸ” [æ¨©é™ãƒã‚§ãƒƒã‚¯] æ¨©é™:', permissionDisplay, '(ID:', permissionId + ')');

        // æ¨©é™ã‚’localStorageã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆä»–ã®ç”»é¢ã§ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ï¼‰
        localStorage.setItem('reborn_user_permission', permissionId);

        // ç®¡ç†è€…ã¯å…¨ã‚¿ãƒ–è¡¨ç¤º
        if (permissionId === 'owner') {
          console.log('âœ… [æ¨©é™ãƒã‚§ãƒƒã‚¯] ç®¡ç†è€…æ¨©é™ - å…¨ã‚¿ãƒ–è¡¨ç¤º');
          return;
        }

        // ç®¡ç†è€…ä»¥å¤–ã®å ´åˆï¼ˆç¤¾å“¡ãƒ»ã‚¹ã‚¿ãƒƒãƒ•ãƒ»ãƒªãƒ¼ãƒ€ãƒ¼ãƒ»å¤–æ³¨ï¼‰ã€Firestoreã®è¨­å®šã«åŸºã¥ã„ã¦ã‚µãƒ–ã‚¿ãƒ–å˜ä½ã§è¡¨ç¤ºåˆ¶å¾¡
        const menuPermDoc = await window.db.collection('settings').doc('menuPermissions').get();
        const menuPerms = menuPermDoc.exists ? menuPermDoc.data() : {};

        console.log('ğŸ“‹ [æ¨©é™ãƒã‚§ãƒƒã‚¯] ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ¨©é™è¨­å®š:', menuPerms);

        // å•†å“ç™»éŒ²è¨­å®šã®ã‚µãƒ–ã‚¿ãƒ–ã‚’åˆ¶å¾¡ï¼ˆdefaultOwnerOnly: falseã¯å…¨å“¡è¡¨ç¤ºãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
        applySubTabPermissions('product', [
          { id: 'product-salesword', tabId: 'product-salesword-tab', paneId: 'product-salesword', defaultOwnerOnly: false },
          { id: 'product-condition', tabId: 'product-condition-tab', paneId: 'product-condition', defaultOwnerOnly: false },
          { id: 'product-hashtag', tabId: 'product-hashtag-tab', paneId: 'product-hashtag', defaultOwnerOnly: false },
          { id: 'product-discount', tabId: 'product-discount-tab', paneId: 'product-discount', defaultOwnerOnly: false },
          { id: 'product-ai', tabId: 'product-ai-tab', paneId: 'product-ai', defaultOwnerOnly: false }
        ], menuPerms, permissionId, 'productConfigTabs');

        // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã®ã‚µãƒ–ã‚¿ãƒ–ã‚’åˆ¶å¾¡ï¼ˆMENU_DEFINITIONSã«åˆã‚ã›ãŸdefaultOwnerOnlyãƒ•ãƒ©ã‚°ï¼‰
        applySubTabPermissions('system', [
          { id: 'system-basic', tabId: 'system-basic-tab', paneId: 'system-basic', defaultOwnerOnly: false },
          { id: 'system-management', tabId: 'system-management-tab', paneId: 'system-management', defaultOwnerOnly: true },
          { id: 'system-shipping', tabId: 'system-shipping-tab', paneId: 'system-shipping', defaultOwnerOnly: true },
          { id: 'system-procure', tabId: 'system-procure-tab', paneId: 'system-procure', defaultOwnerOnly: true },
          { id: 'system-permission', tabId: 'system-permission-tab', paneId: 'system-permission', alwaysOwnerOnly: true }
        ], menuPerms, permissionId, 'systemConfigTabs');

      } catch (error) {
        console.error('âŒ [æ¨©é™ãƒã‚§ãƒƒã‚¯] ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    /**
     * ã‚µãƒ–ã‚¿ãƒ–å˜ä½ã§æ¨©é™ã‚’é©ç”¨
     * @param {string} parentPaneId - è¦ªãƒšã‚¤ãƒ³ã®IDï¼ˆ'product' or 'system'ï¼‰
     * @param {Array} subTabs - ã‚µãƒ–ã‚¿ãƒ–æƒ…å ±ã®é…åˆ—
     * @param {Object} menuPerms - ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ¨©é™è¨­å®š
     * @param {string} permissionId - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ID
     * @param {string} tabsContainerId - ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒŠã®ID
     */
    function applySubTabPermissions(parentPaneId, subTabs, menuPerms, permissionId, tabsContainerId) {
      let visibleCount = 0;
      let firstVisibleTabId = null;

      subTabs.forEach(subTab => {
        // æ¨©é™è¨­å®šã‚¿ãƒ–ã¯å¸¸ã«ç®¡ç†è€…ã®ã¿
        if (subTab.alwaysOwnerOnly) {
          if (permissionId === 'owner') {
            // ç®¡ç†è€…ã¯è¡¨ç¤º
            console.log(`âœ… [æ¨©é™ãƒã‚§ãƒƒã‚¯] ${subTab.id} ã‚’è¡¨ç¤ºï¼ˆç®¡ç†è€…ï¼‰`);
          } else {
            hideTab(subTab.tabId, subTab.paneId);
            console.log(`ğŸ”’ [æ¨©é™ãƒã‚§ãƒƒã‚¯] ${subTab.id} ã‚’éè¡¨ç¤ºï¼ˆç®¡ç†è€…ã®ã¿å›ºå®šï¼‰`);
            return;
          }
        }

        // Firestoreã«è¨­å®šãŒãªã„å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’æ±ºå®š
        // defaultOwnerOnly: false â†’ å…¨å“¡ã«è¡¨ç¤ºï¼ˆowner, employee, staff, leader, outsourceï¼‰
        // defaultOwnerOnly: true â†’ ç®¡ç†è€…ã®ã¿
        const defaultVisibleTo = subTab.defaultOwnerOnly === false
          ? ['owner', 'employee', 'staff', 'leader', 'outsource']
          : ['owner'];
        const perm = menuPerms[subTab.id] || { visibleTo: defaultVisibleTo };
        const isVisible = perm.visibleTo.includes(permissionId);

        if (isVisible) {
          visibleCount++;
          if (!firstVisibleTabId) firstVisibleTabId = subTab.tabId;
          console.log(`âœ… [æ¨©é™ãƒã‚§ãƒƒã‚¯] ${subTab.id} ã‚’è¡¨ç¤º`);
        } else {
          hideTab(subTab.tabId, subTab.paneId);
          console.log(`ğŸ”’ [æ¨©é™ãƒã‚§ãƒƒã‚¯] ${subTab.id} ã‚’éè¡¨ç¤º`);
        }
      });

      // ã™ã¹ã¦ã®ã‚µãƒ–ã‚¿ãƒ–ãŒéè¡¨ç¤ºã®å ´åˆã€è¦ªãƒšã‚¤ãƒ³å…¨ä½“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      if (visibleCount === 0) {
        const parentPane = document.getElementById(parentPaneId);
        if (parentPane) {
          const tabContent = parentPane.querySelector('.tab-content');
          if (tabContent) {
            tabContent.innerHTML = `
              <div style="padding: 40px; text-align: center; color: #6b7280;">
                <i class="bi bi-lock" style="font-size: 48px; display: block; margin-bottom: 16px;"></i>
                ã“ã®è¨­å®šã¯ç®¡ç†è€…ã®ã¿ç·¨é›†ã§ãã¾ã™ã€‚<br>
                è¨­å®šã®å¤‰æ›´ãŒå¿…è¦ãªå ´åˆã¯ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
              </div>
            `;
          }
          // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒŠã‚‚éè¡¨ç¤º
          const tabsContainer = document.getElementById(tabsContainerId);
          if (tabsContainer) {
            tabsContainer.style.display = 'none';
          }
        }
        console.log(`ğŸ”’ [æ¨©é™ãƒã‚§ãƒƒã‚¯] ${parentPaneId} å…¨ä½“ã‚’éè¡¨ç¤º`);
      } else if (firstVisibleTabId) {
        // æœ€åˆã®è¡¨ç¤ºå¯èƒ½ãªã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
        activateFirstVisibleTab(firstVisibleTabId, subTabs);
      }
    }

    /**
     * ã‚¿ãƒ–ã¨ãƒšã‚¤ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
     */
    function hideTab(tabId, paneId) {
      const tab = document.getElementById(tabId);
      if (tab) {
        const navItem = tab.closest('.nav-item');
        if (navItem) navItem.style.display = 'none';
      }

      const pane = document.getElementById(paneId);
      if (pane) {
        pane.style.display = 'none';
        pane.classList.remove('show', 'active');
      }
    }

    /**
     * æœ€åˆã®è¡¨ç¤ºå¯èƒ½ãªã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
     */
    function activateFirstVisibleTab(firstVisibleTabId, subTabs) {
      // ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ãŒéè¡¨ç¤ºã«ãªã£ã¦ã„ã‚‹å ´åˆã€æœ€åˆã®è¡¨ç¤ºã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      const currentActive = subTabs.find(st => {
        const pane = document.getElementById(st.paneId);
        return pane && pane.classList.contains('active');
      });

      if (currentActive) {
        const currentPane = document.getElementById(currentActive.paneId);
        if (currentPane && currentPane.style.display === 'none') {
          // ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ãŒéè¡¨ç¤ºãªã®ã§ã€æœ€åˆã®è¡¨ç¤ºã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
          const firstTab = document.getElementById(firstVisibleTabId);
          if (firstTab) {
            // Bootstrap ã®ã‚¿ãƒ–APIã‚’ä½¿ç”¨
            const bsTab = new bootstrap.Tab(firstTab);
            bsTab.show();
          }
        }
      }
    }

    // FirebaseåˆæœŸåŒ–å¾Œã«æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
    if (window.firestoreReady) {
      checkUserPermissionAndUpdateUI();
    }
  </script>

  <!-- ä»¥ä¸‹ã€ä»–ã®åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
    // ã“ã®å¾Œã®è¨­å®šå¤‰æ•°ï¼ˆfirebaseConfigã¯ä¸Šã§å®šç¾©æ¸ˆã¿ï¼‰

    // ================= ç”»åƒç®¡ç†è¨­å®š =================

    /**
     * ç”»åƒç®¡ç†è¨­å®šã®åˆæœŸåŒ–
     */
    window.initImageSettings = function() {
      const checkbox = document.getElementById('enableProductImageSave');
      const statusText = document.getElementById('imageSettingStatusText');

      // ã¾ãšlocalStorageã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆé«˜é€Ÿè¡¨ç¤ºï¼‰
      const localStorageValue = localStorage.getItem('enableProductImageSave');
      let enabled = localStorageValue === 'true';

      console.log('ğŸ” [è¨­å®šç”»é¢] ç”»åƒç®¡ç†è¨­å®šã‚’åˆæœŸåŒ–:');
      console.log('  - localStorageå€¤:', localStorageValue);
      console.log('  - æœ‰åŠ¹:', enabled);

      // UIã‚’å³åº§ã«æ›´æ–°
      if (checkbox) {
        checkbox.checked = enabled;
      }

      if (statusText) {
        statusText.textContent = enabled
          ? 'ONï¼ˆå•†å“ç”»åƒãƒ–ãƒ­ãƒƒã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰'
          : 'OFFï¼ˆå•†å“ç”»åƒãƒ–ãƒ­ãƒƒã‚¯ã¯éè¡¨ç¤ºï¼‰';
      }

      // PWAç‰ˆã§ã¯ Firestore ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆæœªå®Ÿè£…ï¼‰
      // æš«å®š: localStorage ã®ã¿ä½¿ç”¨
    }

    /**
     * å•†å“ç”»åƒä¿å­˜è¨­å®šã®åˆ‡ã‚Šæ›¿ãˆ
     */
    window.toggleProductImageSave = function() {
      const checkbox = document.getElementById('enableProductImageSave');
      const statusText = document.getElementById('imageSettingStatusText');

      console.log('ğŸ”˜ toggleProductImageSaveå‘¼ã³å‡ºã—');
      console.log('  - ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹:', checkbox);

      if (!checkbox || !statusText) {
        console.error('âŒ ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¾ãŸã¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      const enabled = checkbox.checked;
      console.log('  - ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹:', enabled);

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
      statusText.textContent = enabled
        ? 'ONï¼ˆå•†å“ç”»åƒãƒ–ãƒ­ãƒƒã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰'
        : 'OFFï¼ˆå•†å“ç”»åƒãƒ–ãƒ­ãƒƒã‚¯ã¯éè¡¨ç¤ºï¼‰';

      // 1. localStorageã«ä¿å­˜ï¼ˆPC/ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ãƒ»é«˜é€Ÿï¼‰
      try {
        localStorage.setItem('enableProductImageSave', enabled.toString());
        console.log('âœ… localStorageä¿å­˜:', enabled);

        // ä¿å­˜ç¢ºèª
        const saved = localStorage.getItem('enableProductImageSave');
        console.log('  - ä¿å­˜ç¢ºèª:', saved);
      } catch (e) {
        console.error('âš ï¸ localStorageä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼ˆiOS/ã‚¹ãƒãƒ›ã§ã¯åˆ¶é™ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰:', e);
      }

      // PWAç‰ˆã§ã¯ Firestore ã«ä¿å­˜ï¼ˆæœªå®Ÿè£…ï¼‰
      // æš«å®š: localStorage ã®ã¿ä½¿ç”¨
    }

    /**
     * ç”»åƒç®¡ç†è¨­å®šã‚’ä¿å­˜
     */
    window.saveImageSettings = function() {
      const checkbox = document.getElementById('enableProductImageSave');

      console.log('ğŸ’¾ saveImageSettingså‘¼ã³å‡ºã—');

      if (!checkbox) {
        alert('è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        return;
      }

      const enabled = checkbox.checked;
      localStorage.setItem('enableProductImageSave', enabled.toString());

      alert('âœ… è¨­å®šå®Œäº†ã—ã¾ã—ãŸ');

      console.log('âœ… ç”»åƒç®¡ç†è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ:', enabled);
    };

    // localStorageå…¨ä½“ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    window.debugLocalStorage = function() {
      console.log('ğŸ“¦ localStorageå…¨ä½“:');
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        const value = localStorage.getItem(key);
        console.log(`  - ${key}:`, value);
      }
    };

    // DOMContentLoadedæ™‚ã«åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      window.debugLocalStorage(); // ãƒ‡ãƒãƒƒã‚°ç”¨
      window.initImageSettings();

      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã‚¿ãƒ–ã‚’å–å¾—ï¼ˆmenu_homeã‹ã‚‰ã®é·ç§»å¯¾å¿œï¼‰
      const urlParams = new URLSearchParams(window.location.search);
      const tabParam = urlParams.get('tab'); // ä¾‹: ?tab=product or ?tab=system

      // ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–ã®åˆ‡ã‚Šæ›¿ãˆï¼ˆå•†å“ç™»éŒ²è¨­å®š/ã‚·ã‚¹ãƒ†ãƒ è¨­å®šï¼‰+ ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
      const headerTitle = document.getElementById('page-header-title');

      if (tabParam === 'product') {
        // å•†å“ç™»éŒ²è¨­å®šã‚¿ãƒ–ãƒšã‚¤ãƒ³ã‚’ç›´æ¥è¡¨ç¤º
        const productPane = document.getElementById('product');
        const systemPane = document.getElementById('system');

        if (productPane && systemPane) {
          // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’éè¡¨ç¤º
          systemPane.classList.remove('show', 'active');

          // å•†å“ç™»éŒ²è¨­å®šã‚’è¡¨ç¤º
          productPane.classList.add('show', 'active');

          // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
          if (headerTitle) {
            headerTitle.textContent = 'ğŸ“ å•†å“ç™»éŒ²è¨­å®š';
          }

          console.log('[config.html] å•†å“ç™»éŒ²è¨­å®šã‚¿ãƒ–ã‚’è¡¨ç¤º');
        }
      } else if (tabParam === 'system') {
        // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚¿ãƒ–ãƒšã‚¤ãƒ³ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
        const productPane = document.getElementById('product');
        const systemPane = document.getElementById('system');

        if (productPane && systemPane) {
          // å•†å“ç™»éŒ²è¨­å®šã‚’éè¡¨ç¤º
          productPane.classList.remove('show', 'active');

          // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’è¡¨ç¤º
          systemPane.classList.add('show', 'active');

          // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã ãŒæ˜ç¤ºçš„ã«è¨­å®šï¼‰
          if (headerTitle) {
            headerTitle.textContent = 'âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š';
          }

          console.log('[config.html] ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚¿ãƒ–ã‚’è¡¨ç¤º');

          // ã‚µãƒ–ã‚¿ãƒ–ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆä¾‹: ?tab=system&subtab=usersï¼‰
          const subtabParam = urlParams.get('subtab');
          console.log('[config.html] subtabParam:', subtabParam);
          if (subtabParam === 'users') {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
            const activateUsersTab = () => {
              console.log('[config.html] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ä¸­...');
              const usersTab = document.getElementById('system-users-tab');
              const usersPane = document.getElementById('system-users');
              console.log('[config.html] usersTabè¦ç´ :', usersTab);
              console.log('[config.html] usersPaneè¦ç´ :', usersPane);

              if (usersTab && usersPane) {
                // åŸºæœ¬è¨­å®šã‚¿ãƒ–ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
                const basicTab = document.getElementById('system-basic-tab');
                const basicPane = document.getElementById('system-basic');
                if (basicTab) basicTab.classList.remove('active');
                if (basicPane) basicPane.classList.remove('show', 'active');

                // Bootstrap TabãŒåˆ©ç”¨å¯èƒ½ã‹ç¢ºèª
                if (typeof bootstrap !== 'undefined' && bootstrap.Tab) {
                  const tab = new bootstrap.Tab(usersTab);
                  tab.show();
                  console.log('[config.html] âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã—ã¾ã—ãŸï¼ˆBootstrap Tabï¼‰');
                } else {
                  // BootstrapãŒæœªãƒ­ãƒ¼ãƒ‰ã®å ´åˆã¯æ‰‹å‹•ã§ã‚¯ãƒ©ã‚¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
                  console.log('[config.html] Bootstrapæœªãƒ­ãƒ¼ãƒ‰ã€æ‰‹å‹•ã§åˆ‡ã‚Šæ›¿ãˆ');
                  document.querySelectorAll('#systemConfigTabs .nav-link').forEach(el => el.classList.remove('active'));
                  document.querySelectorAll('#systemConfigTabContent .tab-pane').forEach(el => el.classList.remove('show', 'active'));
                  usersTab.classList.add('active');
                  usersPane.classList.add('show', 'active');
                }

                // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥é˜²æ­¢: ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå®Œäº†å¾Œã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
                document.documentElement.classList.add('tab-ready');
                console.log('[config.html] âœ… tab-readyã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ï¼ˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºï¼‰');

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ï¼ˆå°‘ã—é…å»¶ã•ã›ã¦ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå®Œäº†ã‚’å¾…ã¤ï¼‰
                setTimeout(function() {
                  if (typeof loadUserManagement === 'function') {
                    console.log('[config.html] loadUserManagement()ã‚’å‘¼ã³å‡ºã—');
                    loadUserManagement();
                  } else {
                    console.warn('[config.html] loadUserManagement()ãŒæœªå®šç¾©');
                  }
                }, 100);

                return true;
              }
              return false;
            };

            // å³åº§ã«å®Ÿè¡Œã‚’è©¦ã¿ã‚‹
            if (!activateUsersTab()) {
              // å¤±æ•—ã—ãŸå ´åˆã¯å°‘ã—å¾…ã£ã¦ãƒªãƒˆãƒ©ã‚¤
              setTimeout(activateUsersTab, 50);
            }
          }
        }
      }

      // activeTabãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆ
      const activeTab = '<?= typeof activeTab !== "undefined" ? activeTab : "basic" ?>';
      if (activeTab && activeTab !== 'basic') {
        // è©²å½“ã™ã‚‹ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã¨ãƒšã‚¤ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
        const tabButton = document.getElementById(activeTab + '-tab');
        const tabPane = document.getElementById(activeTab);

        if (tabButton && tabPane) {
          // ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
          const activeButton = document.querySelector('.nav-link.active');
          const activePane = document.querySelector('.tab-pane.active.show');
          if (activeButton) {
            activeButton.classList.remove('active');
          }
          if (activePane) {
            activePane.classList.remove('active', 'show');
          }

          // æ–°ã—ã„ã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
          tabButton.classList.add('active');
          tabPane.classList.add('active', 'show');
        }
      }
    });

    // Firebase ã¯ä¸Šã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿
    // window.db ã¨ window.firestoreReady ã¯æ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹

    // ãƒãƒƒã‚¸ã‚«ã‚¦ãƒ³ãƒˆã‚’å¢—ã‚„ã™ï¼ˆåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
    function incrementBadgeIfAvailable() {
      try {
        // localStorageã‹ã‚‰ç¾åœ¨ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’å–å¾—
        const currentCount = parseInt(localStorage.getItem('badgeCount') || '0', 10);
        const newCount = currentCount + 1;

        // localStorageã«ä¿å­˜
        localStorage.setItem('badgeCount', newCount.toString());
        console.log('ğŸ“› ãƒãƒƒã‚¸ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°:', newCount);

        // Badge APIã§æ›´æ–°ï¼ˆå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿ï¼‰
        if ('setAppBadge' in navigator) {
          navigator.setAppBadge(newCount)
            .then(() => console.log('âœ… Badge APIæ›´æ–°æˆåŠŸ:', newCount))
            .catch(err => console.error('âŒ Badge APIã‚¨ãƒ©ãƒ¼:', err));
        }
      } catch (error) {
        console.error('âŒ ãƒãƒƒã‚¸æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // FirebaseåˆæœŸåŒ–ã¯æ—¢ã«scriptã‚¿ã‚°ã§å®Ÿè¡Œæ¸ˆã¿
    // ManagementNumberBuilderã®loadSettings()ã‚’å‘¼ã¶
    function initFirebaseAndLoadSettings() {
      // FirestoreåˆæœŸåŒ–å®Œäº†å¾Œã€ManagementNumberBuilderã®loadSettings()ã‚’å‘¼ã¶
      if (window.ManagementNumberBuilder && window.firestoreReady) {
        console.log('ğŸ”¥ FirebaseåˆæœŸåŒ–å®Œäº† â†’ ManagementNumberBuilder.loadSettings()ã‚’å‘¼ã³å‡ºã—ã¾ã™');
        window.ManagementNumberBuilder.loadSettings();
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initFirebaseAndLoadSettings);
    } else {
      initFirebaseAndLoadSettings();
    }

    /**
     * åŸºæœ¬è¨­å®šã‚’èª­ã¿è¾¼ã‚€ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ–¹å¼ï¼‰
     */
    async function loadBasicSettings() {
      try {
        const config = JSON.parse(localStorage.getItem('config') || '{}');

        // ğŸ”§ å„ªå…ˆé †ä½: config > reborn_user_* > ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        const userName = config.userName || localStorage.getItem('reborn_user_name') || '';
        const userEmail = config.email || localStorage.getItem('reborn_user_email') || '';

        // æ¨©é™ã‚’Firestoreã‹ã‚‰å–å¾—ï¼ˆç®¡ç†è€…ãŒå¤‰æ›´ã—ãŸå ´åˆã‚’åæ˜ ï¼‰
        let permissionId = localStorage.getItem('reborn_user_permission_id') || 'staff';
        if (window.db && userEmail) {
          try {
            const userDoc = await window.db.collection('users').doc(userEmail).get();
            if (userDoc.exists) {
              const userData = userDoc.data();
              permissionId = userData.permissionId || permissionId;
              // localStorageã‚‚æ›´æ–°
              localStorage.setItem('reborn_user_permission_id', permissionId);
            }
          } catch (e) {
            console.warn('âš ï¸ Firestoreã‹ã‚‰æ¨©é™å–å¾—å¤±æ•—ã€localStorageã‚’ä½¿ç”¨:', e);
          }
        }

        // æ¨©é™ãƒãƒƒã‚¸ã‚’è¡¨ç¤º
        const permissionBadge = document.getElementById('basicUserPermissionBadge');
        if (permissionBadge) {
          permissionBadge.innerHTML = getPermissionBadgeHTML(permissionId);
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¨­å®š
        const userNameInput = document.getElementById('basicUserName');
        if (userNameInput) {
          userNameInput.value = userName;

          // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
          const clearBtn = document.getElementById('clearUserNameBtn');
          if (clearBtn) {
            clearBtn.style.display = userName ? 'block' : 'none';
          }
        }

        // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨­å®š
        const emailInput = document.getElementById('basicUserEmail');
        if (emailInput) {
          emailInput.value = userEmail;
        }

        // é€šçŸ¥è¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆtrueï¼‰
        const notificationEnabled = config.notificationEnabled !== undefined ? config.notificationEnabled : true;
        const notificationSound = config.notificationSound !== undefined ? config.notificationSound : true;

        const notifCheckbox = document.getElementById('basicNotificationEnabled');
        if (notifCheckbox) {
          notifCheckbox.checked = notificationEnabled;
        }

        const soundCheckbox = document.getElementById('basicNotificationSound');
        if (soundCheckbox) {
          soundCheckbox.checked = notificationSound;
        }

        // ğŸ”§ ã‚¢ã‚¤ã‚³ãƒ³èª­ã¿è¾¼ã¿ï¼ˆlocalStorageã‹ã‚‰ï¼‰
        const iconUrl = localStorage.getItem('reborn_user_icon_url');
        const iconPreview = document.getElementById('basicUserIconPreview');
        if (iconPreview && iconUrl) {
          iconPreview.innerHTML = '<img src="' + iconUrl + '" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">';
        }

        console.log('âœ… åŸºæœ¬è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ–¹å¼):', { userName, userEmail, permissionId, notificationEnabled, notificationSound, iconUrl: iconUrl ? 'è¨­å®šæ¸ˆã¿' : 'æœªè¨­å®š' });
      } catch (e) {
        console.error('âŒ åŸºæœ¬è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
      }

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤ºã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤º
      document.getElementById('basicSettingsLoading').style.display = 'none';
      document.getElementById('basicSettingsContent').style.display = 'block';
    }

    /**
     * åŸºæœ¬è¨­å®šã‚’ä¿å­˜ã™ã‚‹ï¼ˆFirestoreç›´æ¥ä¿å­˜ï¼‰
     */
    async function saveBasicSettings() {
      const userName = document.getElementById('basicUserName').value.trim();

      if (!userName) {
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const settings = {
        userName: userName,
        notificationEnabled: document.getElementById('basicNotificationEnabled').checked,
        notificationSound: document.getElementById('basicNotificationSound').checked
      };

      try {
        // 1. localStorageã«ä¿å­˜ï¼ˆå³æ™‚åæ˜ ç”¨ï¼‰
        const config = JSON.parse(localStorage.getItem('config') || '{}');
        config.userName = settings.userName;
        config.notificationEnabled = settings.notificationEnabled;
        config.notificationSound = settings.notificationSound;
        localStorage.setItem('config', JSON.stringify(config));

        // 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
        const userEmail = localStorage.getItem('reborn_user_email');
        if (!userEmail) {
          throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
        }

        // 3. Firestoreã«ä¿å­˜
        if (!window.db) {
          throw new Error('FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        }

        await window.db.collection('users').doc(userEmail).set({
          userName: settings.userName,
          notificationEnabled: settings.notificationEnabled,
          notificationSound: settings.notificationSound,
          lastUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        // 4. activeDevicesã«ã‚‚é€šçŸ¥è¨­å®šã‚’åŒæœŸ
        await window.db.collection('activeDevices').doc(userEmail).set({
          notificationEnabled: settings.notificationEnabled,
          notificationSound: settings.notificationSound,
          lastUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
        const clearBtn = document.getElementById('clearUserNameBtn');
        if (clearBtn) {
          clearBtn.style.display = settings.userName ? 'block' : 'none';
        }

        alert('âœ… åŸºæœ¬è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        console.log('âœ… åŸºæœ¬è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ (localStorage + Firestore):', settings);

      } catch (e) {
        console.error('âŒ åŸºæœ¬è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
        alert('âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    }

    // åŸºæœ¬è¨­å®šã‚¿ãƒ–ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã‚€
    // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚¿ãƒ–å†…ã®åŸºæœ¬è¨­å®šã‚¿ãƒ–ã‚’æ­£ã—ãå‚ç…§ï¼ˆsystem-basic-tabï¼‰
    const basicTab = document.getElementById('system-basic-tab');

    // subtab=usersã®å ´åˆã¯åŸºæœ¬è¨­å®šã‚’èª­ã¿è¾¼ã¾ãªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚¿ãƒ–ã«ç›´æ¥é·ç§»ã™ã‚‹ãŸã‚ï¼‰
    const subtabParamForBasic = new URLSearchParams(window.location.search).get('subtab');
    const skipBasicSettings = (subtabParamForBasic === 'users');

    if (basicTab) {
      basicTab.addEventListener('shown.bs.tab', function() {
        loadBasicSettings();
      });

      // åˆå›è¡¨ç¤ºæ™‚ã‚‚å³åº§ã«èª­ã¿è¾¼ã‚€ï¼ˆsubtab=usersã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
      if (basicTab.classList.contains('active') && !skipBasicSettings) {
        loadBasicSettings();
      }
    }

    // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã‚¿ãƒ–ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    const platformTab = document.getElementById('system-platform-tab');
    if (platformTab) {
      platformTab.addEventListener('shown.bs.tab', function() {
        const config = JSON.parse(localStorage.getItem('config') || '{}');
        loadPlatformSettings(config);
      });

      // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚¿ãƒ–ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ´åˆã¯åˆå›èª­ã¿è¾¼ã¿
      const platformPane = document.getElementById('system-platform');
      if (platformPane && (platformPane.classList.contains('active') || platformPane.classList.contains('show'))) {
        setTimeout(function() {
          const config = JSON.parse(localStorage.getItem('config') || '{}');
          loadPlatformSettings(config);
        }, 100);
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å¸¸ã«ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã‚’åˆæœŸåŒ–ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçŠ¶æ…‹ã‚’è¨­å®šã«åˆã‚ã›ã‚‹ï¼‰
    setTimeout(function() {
      const config = JSON.parse(localStorage.getItem('config') || '{}');
      loadPlatformSettings(config);
    }, 200);

    // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚¿ãƒ–ï¼ˆ#systemï¼‰ãŒæœ€åˆã‹ã‚‰è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã®å¯¾å¿œ
    const systemPane = document.getElementById('system');
    if (systemPane && systemPane.classList.contains('active') && !skipBasicSettings) {
      // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚¿ãƒ–ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¦ã€åŸºæœ¬è¨­å®šã‚¿ãƒ–ã‚‚è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆ
      const basicPane = document.getElementById('system-basic');
      if (basicPane && (basicPane.classList.contains('active') || basicPane.classList.contains('show'))) {
        // ç¢ºå®Ÿã«loadBasicSettings()ã‚’å‘¼ã¶
        setTimeout(function() {
          loadBasicSettings();
        }, 100);
      }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼åå…¥åŠ›ã®ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³è¡¨ç¤º/éè¡¨ç¤º
    const userNameInput = document.getElementById('basicUserName');
    const clearUserNameBtn = document.getElementById('clearUserNameBtn');
    
    if (userNameInput && clearUserNameBtn) {
      userNameInput.addEventListener('input', function() {
        clearUserNameBtn.style.display = this.value ? 'block' : 'none';
      });
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚¯ãƒªã‚¢æ©Ÿèƒ½
    function clearUserName() {
      const input = document.getElementById('basicUserName');
      const clearBtn = document.getElementById('clearUserNameBtn');
      input.value = '';
      clearBtn.style.display = 'none';
      input.focus();
    }

    // ã‚¢ã‚¤ã‚³ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆè‡ªå‹•ãƒªã‚µã‚¤ã‚ºå¯¾å¿œï¼‰
    document.getElementById('basicUserIconInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        if (file.size > 2 * 1024 * 1024) {
          alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯2MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
          return;
        }

        const reader = new FileReader();
        reader.onload = function(event) {
          const img = new Image();
          img.onload = function() {
            // ç”»åƒã‚’200x200pxã«ãƒªã‚µã‚¤ã‚ºï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ50000æ–‡å­—åˆ¶é™å¯¾ç­–ï¼‰
            const canvas = document.createElement('canvas');
            const maxSize = 200;
            let width = img.width;
            let height = img.height;

            // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿ã¡ãªãŒã‚‰æœ€å¤§ã‚µã‚¤ã‚ºã«åã‚ã‚‹
            if (width > height) {
              if (width > maxSize) {
                height = Math.round((height * maxSize) / width);
                width = maxSize;
              }
            } else {
              if (height > maxSize) {
                width = Math.round((width * maxSize) / height);
                height = maxSize;
              }
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // JPEGã§å“è³ª0.8ã§åœ§ç¸®ï¼ˆBase64ã‚µã‚¤ã‚ºã‚’å‰Šæ¸›ï¼‰
            const resizedBase64 = canvas.toDataURL('image/jpeg', 0.8);

            // Base64ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåˆ¶é™: 50000æ–‡å­—ï¼‰
            if (resizedBase64.length > 45000) {
              alert('ç”»åƒãŒå¤§ãã™ãã¾ã™ã€‚ã‚ˆã‚Šå°ã•ã„ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
              return;
            }

            console.log('ç”»åƒãƒªã‚µã‚¤ã‚ºå®Œäº†:', width + 'x' + height, 'Base64ã‚µã‚¤ã‚º:', resizedBase64.length, 'æ–‡å­—');

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            document.getElementById('basicUserIconPreview').innerHTML =
              '<img src="' + resizedBase64 + '" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">';

            // ãƒªã‚µã‚¤ã‚ºå¾Œã®Base64ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚ä¿å­˜
            pendingUserIconData = resizedBase64;
            console.log('ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã‚’é¸æŠã—ã¾ã—ãŸï¼ˆä¿å­˜ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ï¼‰');
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆFirestoreç›´æ¥ä¿å­˜ï¼‰
     */
    async function uploadUserIcon() {
      if (!pendingUserIconData) {
        console.log('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      try {
        // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
        const userEmail = localStorage.getItem('reborn_user_email');
        if (!userEmail) {
          throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
        }

        // 2. Firestoreã«ä¿å­˜
        if (!window.db) {
          throw new Error('FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        }

        await window.db.collection('users').doc(userEmail).set({
          userIconUrl: pendingUserIconData,
          lastUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        // 3. localStorageã«ã‚‚ä¿å­˜ï¼ˆå³æ™‚åæ˜ ç”¨ï¼‰
        localStorage.setItem('reborn_user_icon_url', pendingUserIconData);

        console.log('âœ… ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸ (localStorage + Firestore users)');

        // 4. è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°ã‚’é€šçŸ¥ï¼ˆå³æ™‚åæ˜ ï¼‰
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({ type: 'updateUserIcon' }, '*');
          console.log('ğŸ“¤ è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°ã‚’é€šçŸ¥ã—ã¾ã—ãŸ');
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
        pendingUserIconData = null;

      } catch (e) {
        console.error('âŒ ã‚¢ã‚¤ã‚³ãƒ³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', e);
        throw e; // saveConfig()ã§ã‚­ãƒ£ãƒƒãƒã•ã‚Œã‚‹ã‚ˆã†ã«throw
      }
    }
  </script>

  <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³å‡¦ç† -->
<script>
  console.log('[sidebar_config] âœ… Script loaded - Version @936-Placement-Fix');
  
  async function goBack() {
    console.log('[sidebar_config] >>> goBack() called at', new Date().toISOString());
    const isInIframe = window.self !== window.top;
    console.log('[sidebar_config] isInIframe:', isInIframe);
    
    if (isInIframe) {
      console.log('[sidebar_config] iframeå†…ã§é–‹ã‹ã‚Œã¦ã„ã‚‹ãŸã‚ã€postMessageé€ä¿¡');
      window.top.postMessage({ type: 'navigateToHome' }, '*');
      console.log('[sidebar_config] âœ… postMessageé€ä¿¡å®Œäº†');
    } else {
      console.log('[sidebar_config] ç›´æ¥é–‹ã‹ã‚Œã¦ã„ã‚‹ãŸã‚ã€google.script.host.close()');
      google.script.host.close();
    }
  }
  
  document.addEventListener('DOMContentLoaded', () => {
    console.log('[sidebar_config] DOMContentLoaded fired');
    const backButton = document.getElementById('back-button');
    console.log('[sidebar_config] backButton element:', backButton);

    if (backButton) {
      backButton.addEventListener('click', goBack);
      console.log('[sidebar_config] âœ… æˆ»ã‚‹ãƒœã‚¿ãƒ³ã«goBack()ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ');
    } else {
      console.error('[sidebar_config] âŒ æˆ»ã‚‹ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }

    // æ¨©é™è¨­å®šã‚¿ãƒ–ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    const permissionTab = document.getElementById('system-permission-tab');
    if (permissionTab) {
      permissionTab.addEventListener('shown.bs.tab', loadPermissionSettings);
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚¿ãƒ–ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    const usersTab = document.getElementById('system-users-tab');
    if (usersTab) {
      usersTab.addEventListener('shown.bs.tab', loadUserManagement);
    }

    // è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‹ã‚‰ã®ã‚¿ãƒ–ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³è¦æ±‚ã‚’å‡¦ç†
    window.addEventListener('message', function(event) {
      if (event.data && event.data.type === 'activateTab') {
        console.log('[config] ã‚¿ãƒ–ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³è¦æ±‚:', event.data.tabId);

        if (event.data.tabId === 'permissionUsers') {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
          const usersTab = document.getElementById('system-users-tab');
          if (usersTab) {
            const tab = new bootstrap.Tab(usersTab);
            tab.show();
            console.log('[config] âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã—ã¾ã—ãŸ');
          }
        }
      }
    });
  });

  // ================= æ¨©é™è¨­å®šæ©Ÿèƒ½ (PERM-001 Phase 2) =================

  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å®šç¾©ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼IDã¨ãƒ©ãƒ™ãƒ«ï¼‰
  const MENU_DEFINITIONS = [
    // ãƒˆãƒƒãƒ—ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ï¼ˆå˜ç‹¬ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰
    { id: 'product', label: 'ğŸ“ å•†å“ç™»éŒ²', defaultOwnerOnly: false },
    { id: 'inventory', label: 'ğŸ“¦ åœ¨åº«ç®¡ç†', defaultOwnerOnly: false },
    { id: 'inventory_history', label: 'ğŸ“Š å…¥å‡ºåº«å±¥æ­´', defaultOwnerOnly: false },
    { id: 'stocktaking', label: 'ğŸ“‹ æ£šå¸', defaultOwnerOnly: false, isComingSoon: true },
    { id: 'purchase', label: 'ğŸ’° ä»•å…¥ï¼è²·æ›', defaultOwnerOnly: false, isComingSoon: true },
    { id: 'sales', label: 'ğŸ’µ å£²ä¸Šï¼å£²æ›', defaultOwnerOnly: false, isComingSoon: true },
    { id: 'sales-analysis', label: 'ğŸ“ˆ å£²ä¸Šåˆ†æ', defaultOwnerOnly: false, isComingSoon: true },
    { id: 'chat', label: 'ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ', defaultOwnerOnly: false },
    // ãƒã‚¹ã‚¿ç®¡ç†ï¼ˆ2æ®µå¼ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰
    {
      id: 'master',
      label: 'ğŸ—‚ï¸ ãƒã‚¹ã‚¿ç®¡ç†',
      isTopGroup: true,
      children: [
        {
          id: 'master-product',
          label: 'ğŸ“¦ å•†å“é–¢é€£ãƒã‚¹ã‚¿ç®¡ç†',
          isGroup: true,
          children: [
            { id: 'master-brand', label: 'ãƒ–ãƒ©ãƒ³ãƒ‰', defaultOwnerOnly: false },
            { id: 'master-category', label: 'ã‚«ãƒ†ã‚´ãƒª', defaultOwnerOnly: false },
            { id: 'master-material', label: 'ç´ æ', defaultOwnerOnly: false },
            { id: 'master-fabric', label: 'ç”Ÿåœ°', defaultOwnerOnly: false },
            { id: 'master-color', label: 'ã‚«ãƒ©ãƒ¼', defaultOwnerOnly: false },
            { id: 'master-attributeCategory', label: 'å±æ€§ã‚«ãƒ†ã‚´ãƒª', defaultOwnerOnly: false },
            { id: 'master-attributeValue', label: 'å±æ€§å€¤', defaultOwnerOnly: false }
          ]
        },
        {
          id: 'master-business',
          label: 'ğŸ¢ æ¥­å‹™é–¢é€£ãƒã‚¹ã‚¿ç®¡ç†',
          isGroup: true,
          children: [
            { id: 'master-shipping', label: 'ç™ºé€æ–¹æ³•', defaultOwnerOnly: false },
            { id: 'master-packaging', label: 'æ¢±åŒ…è³‡æ', defaultOwnerOnly: false },
            { id: 'master-supplier', label: 'ä»•å…¥å…ˆ', defaultOwnerOnly: false },
            { id: 'master-marketplace', label: 'å‡ºå“å…ˆ', defaultOwnerOnly: false }
          ]
        }
      ]
    },
    // è¨­å®šç®¡ç†ï¼ˆ2æ®µå¼ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰
    {
      id: 'config',
      label: 'âš™ï¸ è¨­å®šç®¡ç†',
      isTopGroup: true,
      children: [
        {
          id: 'config-product',
          label: 'ğŸ“ å•†å“ç™»éŒ²è¨­å®š',
          isGroup: true,
          children: [
            { id: 'product-salesword', label: 'ã‚»ãƒ¼ãƒ«ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š', defaultOwnerOnly: true },
            { id: 'product-condition', label: 'å•†å“çŠ¶æ…‹è¨­å®š', defaultOwnerOnly: true },
            { id: 'product-hashtag', label: 'ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°è¨­å®š', defaultOwnerOnly: true },
            { id: 'product-discount', label: 'å‰²å¼•è¨­å®š', defaultOwnerOnly: true },
            { id: 'product-ai', label: 'AIç”Ÿæˆè¨­å®š', defaultOwnerOnly: true }
          ]
        },
        {
          id: 'config-system',
          label: 'âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š',
          isGroup: true,
          children: [
            { id: 'system-basic', label: 'åŸºæœ¬è¨­å®š', defaultOwnerOnly: false },
            { id: 'system-management', label: 'ç®¡ç†ç•ªå·è¨­å®š', defaultOwnerOnly: true },
            { id: 'system-shipping', label: 'é…é€è¨­å®š', defaultOwnerOnly: true },
            { id: 'system-procure', label: 'ä»•å…¥ãƒ»å‡ºå“è¨­å®š', defaultOwnerOnly: true },
            { id: 'system-permission', label: 'æ¨©é™è¨­å®š', defaultOwnerOnly: true, alwaysOwnerOnly: true }
          ]
        }
      ]
    }
  ];

  let permissionSettingsLoaded = false;
  let usersData = [];
  let menuPermissions = {};

  // æ¨©é™å®šç¾©ãƒãƒƒãƒ—ï¼ˆID â†’ è¡¨ç¤ºæƒ…å ±ï¼‰
  const PERMISSION_DEFINITIONS = {
    owner: { id: 'owner', label: 'ç®¡ç†è€…', icon: 'ğŸ‘‘', color: '#dc2626', bg: '#fef2f2', order: 1 },
    employee: { id: 'employee', label: 'ç¤¾å“¡', icon: 'ğŸ‘”', color: '#059669', bg: '#ecfdf5', order: 2 },
    staff: { id: 'staff', label: 'ã‚¹ã‚¿ãƒƒãƒ•', icon: 'ğŸ“‹', color: '#1e40af', bg: '#eff6ff', order: 3 },
    leader: { id: 'leader', label: 'ãƒªãƒ¼ãƒ€ãƒ¼', icon: 'ğŸ–ï¸', color: '#d97706', bg: '#fffbeb', order: 4 },
    contractor: { id: 'contractor', label: 'å¤–æ³¨', icon: 'ğŸ”§', color: '#4338ca', bg: '#eef2ff', order: 5 }
  };

  /**
   * æ¨©é™ãƒãƒƒã‚¸HTMLã‚’ç”Ÿæˆ
   */
  function getPermissionBadgeHTML(permissionId) {
    const perm = PERMISSION_DEFINITIONS[permissionId] || PERMISSION_DEFINITIONS['staff'];
    return `<span style="display: inline-block; padding: 4px 12px; background: ${perm.bg}; color: ${perm.color}; border: 1px solid ${perm.color}; border-radius: 20px; font-size: 13px; font-weight: 600;">${perm.icon} ${perm.label}</span>`;
  }

  /**
   * ãƒãƒ¼ãƒ å†…ã§ä½¿ç”¨ä¸­ã®æ¨©é™IDã‚’å–å¾—ï¼ˆownerã¯å¸¸ã«å«ã‚€ï¼‰
   * @returns {Array<string>} ä½¿ç”¨ä¸­ã®æ¨©é™IDé…åˆ—ï¼ˆorderé †ï¼‰
   */
  function getActivePermissions() {
    // usersDataã‹ã‚‰ä½¿ç”¨ä¸­ã®æ¨©é™IDã‚’æŠ½å‡º
    const activeIds = new Set(['owner']); // ownerã¯å¸¸ã«å«ã‚€
    usersData.forEach(user => {
      if (user.permissionId) {
        activeIds.add(user.permissionId);
      }
    });

    // orderé †ã§ã‚½ãƒ¼ãƒˆã—ã¦è¿”ã™
    return Array.from(activeIds)
      .filter(id => PERMISSION_DEFINITIONS[id])
      .sort((a, b) => PERMISSION_DEFINITIONS[a].order - PERMISSION_DEFINITIONS[b].order);
  }

  /**
   * æ¨©é™è¨­å®šã‚’èª­ã¿è¾¼ã‚€
   */
  async function loadPermissionSettings() {
    if (permissionSettingsLoaded) {
      console.log('[PERM] æ¨©é™è¨­å®šã¯æ—¢ã«èª­ã¿è¾¼ã¿æ¸ˆã¿');
      return;
    }

    console.log('[PERM] æ¨©é™è¨­å®šã‚’èª­ã¿è¾¼ã¿ä¸­...');

    try {
      if (!window.db) {
        throw new Error('FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
      }

      // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—
      const usersSnapshot = await window.db.collection('users').get();
      usersData = [];
      usersSnapshot.forEach(doc => {
        const data = doc.data();
        usersData.push({
          email: doc.id,
          userName: data.userName || doc.id,
          permissionId: data.permissionId || 'staff',
          permissionDisplay: data.permissionDisplay || 'ğŸ“‹ ã‚¹ã‚¿ãƒƒãƒ•'
        });
      });
      console.log('[PERM] ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:', usersData.length);

      // 2. ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ¨©é™è¨­å®šã‚’å–å¾—
      const menuPermDoc = await window.db.collection('settings').doc('menuPermissions').get();
      if (menuPermDoc.exists) {
        menuPermissions = menuPermDoc.data();
      } else {
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½œæˆï¼ˆãƒãƒ¼ãƒ å†…ã§ä½¿ç”¨ä¸­ã®æ¨©é™ã®ã¿ï¼‰
        const activePerms = getActivePermissions();
        menuPermissions = {};

        // å†å¸°çš„ã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã‚’å‡¦ç†
        const processMenu = (menu) => {
          if (menu.isTopGroup && menu.children) {
            // 2æ®µå¼ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®è¦ªï¼ˆmaster, configï¼‰- å­ã‚’å‡¦ç†
            menu.children.forEach(child => {
              if (child.isGroup && child.children) {
                // å­ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆmaster-product, config-systemç­‰ï¼‰
                menuPermissions[child.id] = {
                  label: child.label,
                  visibleTo: child.defaultOwnerOnly ? ['owner'] : activePerms
                };
                // å­«ï¼ˆå€‹åˆ¥ã‚¿ãƒ–ï¼‰
                child.children.forEach(grandchild => {
                  menuPermissions[grandchild.id] = {
                    label: grandchild.label,
                    visibleTo: grandchild.defaultOwnerOnly ? ['owner'] : activePerms
                  };
                });
              } else {
                menuPermissions[child.id] = {
                  label: child.label,
                  visibleTo: child.defaultOwnerOnly ? ['owner'] : activePerms
                };
              }
            });
          } else if (menu.isGroup && menu.children) {
            // 1æ®µå¼ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³
            menuPermissions[menu.id] = {
              label: menu.label,
              visibleTo: menu.defaultOwnerOnly ? ['owner'] : activePerms
            };
            menu.children.forEach(child => {
              menuPermissions[child.id] = {
                label: child.label,
                visibleTo: child.defaultOwnerOnly ? ['owner'] : activePerms
              };
            });
          } else {
            // å˜ç‹¬ãƒ¡ãƒ‹ãƒ¥ãƒ¼
            menuPermissions[menu.id] = {
              label: menu.label,
              visibleTo: menu.defaultOwnerOnly ? ['owner'] : activePerms
            };
          }
        };

        MENU_DEFINITIONS.forEach(processMenu);
      }
      console.log('[PERM] ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ¨©é™è¨­å®š:', menuPermissions);

      // 3. UIã‚’æç”»
      renderUserPermissionList();
      renderMenuPermissionList();

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤ºã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤º
      document.getElementById('permissionSettingsLoading').style.display = 'none';
      document.getElementById('permissionSettingsContent').style.display = 'block';

      permissionSettingsLoaded = true;
      console.log('[PERM] âœ… æ¨©é™è¨­å®šã®èª­ã¿è¾¼ã¿å®Œäº†');

    } catch (error) {
      console.error('[PERM] âŒ æ¨©é™è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      alert('æ¨©é™è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    }
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ãƒªã‚¹ãƒˆã‚’æç”»
   */
  function renderUserPermissionList() {
    const container = document.getElementById('userPermissionList');
    if (!container) return;

    if (usersData.length === 0) {
      container.innerHTML = '<div style="color: #6b7280; font-size: 13px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
      return;
    }

    // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
    const currentUserEmail = localStorage.getItem('reborn_user_email');

    // å…¨æ¨©é™ã‚’orderé †ã§å–å¾—ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã¯å¾Œã‹ã‚‰å¤‰æ›´å¯èƒ½ã«ã™ã‚‹ãŸã‚å…¨ã¦è¡¨ç¤ºï¼‰
    const allPermissions = Object.keys(PERMISSION_DEFINITIONS)
      .sort((a, b) => PERMISSION_DEFINITIONS[a].order - PERMISSION_DEFINITIONS[b].order);

    // æ¨©é™ã‚ªãƒ—ã‚·ãƒ§ãƒ³HTMLã‚’ç”Ÿæˆ
    const generatePermissionOptions = (selectedPermissionId) => {
      return allPermissions.map(permId => {
        const perm = PERMISSION_DEFINITIONS[permId];
        const selected = selectedPermissionId === permId ? 'selected' : '';
        return `<option value="${permId}" ${selected}>${perm.icon} ${perm.label}</option>`;
      }).join('');
    };

    container.innerHTML = usersData.map(user => {
      const isCurrentUser = user.email === currentUserEmail;
      const isOwner = user.permissionId === 'owner';

      return `
        <div style="padding: 12px; background: ${isCurrentUser ? '#f0f9ff' : '#f9fafb'}; border-radius: 8px; border: 1px solid ${isCurrentUser ? '#bfdbfe' : '#e5e7eb'};">
          <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 2px;">${user.userName}</div>
          <div style="font-size: 12px; color: #6b7280; margin-bottom: 10px;">${user.email}</div>
          <select
            data-email="${user.email}"
            onchange="updateUserPermission(this)"
            style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 14px; background: white;"
            ${isCurrentUser && isOwner ? 'disabled title="è‡ªåˆ†è‡ªèº«ã®æ¨©é™ã¯å¤‰æ›´ã§ãã¾ã›ã‚“"' : ''}
          >
            ${generatePermissionOptions(user.permissionId)}
          </select>
        </div>
      `;
    }).join('');
  }

  /**
   * ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ¨©é™ãƒªã‚¹ãƒˆã‚’æç”»
   */
  function renderMenuPermissionList() {
    const container = document.getElementById('menuPermissionList');
    if (!container) return;

    // ãƒãƒ¼ãƒ å†…ã§ä½¿ç”¨ä¸­ã®æ¨©é™ï¼ˆownerä»¥å¤–ï¼‰ã‚’å–å¾—
    const activePermissions = getActivePermissions().filter(id => id !== 'owner');

    // ãƒˆã‚°ãƒ«HTMLã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    const generateToggles = (menuId, visibleTo) => {
      if (activePermissions.length === 0) {
        return '<span style="font-size: 12px; color: #6b7280;">ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰</span>';
      }
      return activePermissions.map(permId => {
        const perm = PERMISSION_DEFINITIONS[permId];
        const isOn = visibleTo.includes(permId);
        return renderToggle(menuId, permId, perm.label, isOn);
      }).join('');
    };

    // 3æ®µç›®ï¼ˆæœ€ä¸‹å±¤ï¼‰ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    const renderLeafItem = (item) => {
      const perm = menuPermissions[item.id] || {
        visibleTo: item.defaultOwnerOnly ? ['owner'] : ['owner', ...activePermissions]
      };

      // æ¨©é™è¨­å®šã‚¿ãƒ–ã¯å¸¸ã«ç®¡ç†è€…ã®ã¿ï¼ˆãƒˆã‚°ãƒ«éè¡¨ç¤ºï¼‰
      if (item.alwaysOwnerOnly) {
        return `
          <div style="padding: 10px 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 13px; color: #374151;">${item.label}</span>
            <span style="font-size: 11px; color: #6b7280; background: #f3f4f6; padding: 4px 8px; border-radius: 4px;">ğŸ”’ ç®¡ç†è€…ã®ã¿</span>
          </div>
        `;
      }

      return `
        <div style="padding: 10px 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
          <div style="font-size: 13px; color: #374151; margin-bottom: 8px;">${item.label}</div>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            ${generateToggles(item.id, perm.visibleTo)}
          </div>
        </div>
      `;
    };

    // 2æ®µç›®ï¼ˆå­ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    const renderChildGroup = (child, parentIndex, childIndex) => {
      const childrenHtml = child.children.map(item => renderLeafItem(item)).join('');
      const accordionId = `accordion-content-menu-${parentIndex}-${childIndex}`;
      const iconId = `accordion-icon-menu-${parentIndex}-${childIndex}`;

      return `
        <div style="border: 1px solid #d1d5db; border-radius: 6px; overflow: hidden; margin-bottom: 6px;">
          <div onclick="toggleMenuAccordion('${parentIndex}-${childIndex}')" style="padding: 10px 14px; background: #f3f4f6; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
            <span style="font-size: 13px; font-weight: 600; color: #4b5563;">${child.label}</span>
            <span id="${iconId}" style="font-size: 11px; color: #6b7280; transition: transform 0.2s;">â–¼</span>
          </div>
          <div id="${accordionId}" class="accordion-content" style="display: none; padding: 10px; background: #fafafa; flex-direction: column; gap: 6px;">
            ${childrenHtml}
          </div>
        </div>
      `;
    };

    // ãƒ–ãƒ­ãƒƒã‚¯ç”¨ã®ä¸€æ‹¬æ“ä½œãƒãƒ¼ã‚’ç”Ÿæˆï¼ˆãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒç‰ˆï¼‰
    const renderBulkControlBar = (blockId, menuIds) => {
      if (activePermissions.length === 0) return '';

      const menuIdsJson = JSON.stringify(menuIds).replace(/"/g, '&quot;');

      return `
        <div style="background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 6px; padding: 10px 12px; margin-bottom: 10px;">
          <div style="font-size: 11px; color: #6b7280; margin-bottom: 8px;">ğŸ”„ ä¸€æ‹¬è¨­å®šï¼ˆä¸‹ã®å…¨é …ç›®ã‚’ã¾ã¨ã‚ã¦å¤‰æ›´ï¼‰</div>
          ${activePermissions.map(permId => {
            const perm = PERMISSION_DEFINITIONS[permId];
            // å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒONã‹ãƒã‚§ãƒƒã‚¯ï¼ˆåˆæœŸçŠ¶æ…‹ã‚’åˆ¤å®šï¼‰
            const allOn = menuIds.every(menuId => {
              const p = menuPermissions[menuId];
              return p && p.visibleTo && p.visibleTo.includes(permId);
            });
            const bgColor = allOn ? '#3b82f6' : '#d1d5db';
            const circlePos = allOn ? 'translateX(20px)' : 'translateX(2px)';
            return `
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: ${permId === activePermissions[activePermissions.length - 1] ? '0' : '8px'};">
                <span style="font-size: 12px; color: #4b5563; min-width: 60px;">${perm.label}:</span>
                <div onclick="bulkTogglePermissionSwitch('${blockId}', '${permId}', ${menuIdsJson}, this)"
                     data-block="${blockId}" data-perm="${permId}" data-on="${allOn}"
                     style="width: 44px; height: 24px; background: ${bgColor}; border-radius: 12px; position: relative; transition: background 0.2s; cursor: pointer;">
                  <div style="width: 20px; height: 20px; background: white; border-radius: 50%; position: absolute; top: 2px; transform: ${circlePos}; transition: transform 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    };

    // 3ãƒ–ãƒ­ãƒƒã‚¯æ§‹é€ ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    // 1. ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆå˜ç‹¬ãƒ¡ãƒ‹ãƒ¥ãƒ¼: å•†å“ç™»éŒ²ã€œãƒãƒ£ãƒƒãƒˆï¼‰
    // 2. ãƒã‚¹ã‚¿ç®¡ç†ï¼ˆisTopGroupï¼‰
    // 3. è¨­å®šç®¡ç†ï¼ˆisTopGroupï¼‰

    const mainMenus = MENU_DEFINITIONS.filter(m => !m.isTopGroup && !m.isGroup);
    const topGroups = MENU_DEFINITIONS.filter(m => m.isTopGroup);

    // ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®IDãƒªã‚¹ãƒˆã‚’åé›†
    const mainMenuIds = mainMenus.map(m => m.id);

    // ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ–ãƒ­ãƒƒã‚¯
    const mainMenuHtml = mainMenus.length > 0 ? `
      <div style="margin-bottom: 20px;">
        <div style="padding: 8px 4px; border-bottom: 2px solid #374151; margin-bottom: 10px;">
          <span style="font-size: 14px; font-weight: 700; color: #374151;">ğŸ“‹ ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼</span>
        </div>
        ${renderBulkControlBar('main', mainMenuIds)}
        <div style="display: flex; flex-direction: column; gap: 6px;">
          ${mainMenus.map(menu => {
            const perm = menuPermissions[menu.id] || {
              visibleTo: menu.defaultOwnerOnly ? ['owner'] : ['owner', ...activePermissions]
            };
            return `
              <div style="padding: 10px 12px; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;">
                <div style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 6px;">${menu.label}</div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                  ${generateToggles(menu.id, perm.visibleTo)}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    ` : '';

    // ãƒˆãƒƒãƒ—ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆãƒã‚¹ã‚¿ç®¡ç†ã€è¨­å®šç®¡ç†ï¼‰ãƒ–ãƒ­ãƒƒã‚¯
    const topGroupsHtml = topGroups.map((menu, topIndex) => {
      // ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼IDã‚’åé›†
      const groupMenuIds = [];
      menu.children.forEach(child => {
        if (child.isGroup && child.children) {
          child.children.forEach(grandchild => {
            if (!grandchild.alwaysOwnerOnly) {
              groupMenuIds.push(grandchild.id);
            }
          });
        } else if (!child.alwaysOwnerOnly) {
          groupMenuIds.push(child.id);
        }
      });

      const childrenHtml = menu.children.map((child, childIndex) => {
        if (child.isGroup && child.children) {
          return renderChildGroup(child, MENU_DEFINITIONS.indexOf(menu), childIndex);
        }
        return renderLeafItem(child);
      }).join('');

      return `
        <div style="margin-bottom: 20px;">
          <div style="padding: 8px 4px; border-bottom: 2px solid #374151; margin-bottom: 10px;">
            <span style="font-size: 14px; font-weight: 700; color: #374151;">${menu.label}</span>
          </div>
          ${renderBulkControlBar(menu.id, groupMenuIds)}
          <div style="display: flex; flex-direction: column; gap: 6px;">
            ${childrenHtml}
          </div>
        </div>
      `;
    }).join('');

    container.innerHTML = mainMenuHtml + topGroupsHtml;
  }

  /**
   * ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
   */
  function renderToggle(menuId, role, label, isOn) {
    const bgColor = isOn ? '#3b82f6' : '#d1d5db';
    const circlePosition = isOn ? 'translateX(20px)' : 'translateX(2px)';

    return `
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <div onclick="toggleMenuPermission('${menuId}', '${role}', this)"
             data-menu="${menuId}" data-role="${role}" data-on="${isOn}"
             style="width: 44px; height: 24px; background: ${bgColor}; border-radius: 12px; position: relative; transition: background 0.2s; cursor: pointer;">
          <div style="width: 20px; height: 20px; background: white; border-radius: 50%; position: absolute; top: 2px; transform: ${circlePosition}; transition: transform 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
        </div>
        <span style="font-size: 12px; color: #374151;">${label}</span>
      </label>
    `;
  }

  /**
   * ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ¨©é™ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®é–‹é–‰
   */
  function toggleMenuAccordion(index) {
    const content = document.getElementById(`accordion-content-menu-${index}`);
    const icon = document.getElementById(`accordion-icon-menu-${index}`);

    if (content.style.display === 'none') {
      content.style.display = 'flex';
      icon.style.transform = 'rotate(180deg)';
    } else {
      content.style.display = 'none';
      icon.style.transform = 'rotate(0deg)';
    }
  }

  /**
   * ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ¨©é™ã‚’åˆ‡ã‚Šæ›¿ãˆ
   */
  function toggleMenuPermission(menuId, role, element) {
    const isOn = element.dataset.on === 'true';
    const newState = !isOn;

    // ãƒˆã‚°ãƒ«ã®è¦‹ãŸç›®ã‚’æ›´æ–°
    element.dataset.on = newState.toString();
    element.style.background = newState ? '#3b82f6' : '#d1d5db';
    element.querySelector('div').style.transform = newState ? 'translateX(20px)' : 'translateX(2px)';

    // menuPermissionsã‚’æ›´æ–°
    if (!menuPermissions[menuId]) {
      menuPermissions[menuId] = { visibleTo: ['owner'] };
    }

    const visibleTo = menuPermissions[menuId].visibleTo;
    if (newState && !visibleTo.includes(role)) {
      visibleTo.push(role);
    } else if (!newState && visibleTo.includes(role)) {
      const index = visibleTo.indexOf(role);
      visibleTo.splice(index, 1);
    }

    console.log('[PERM] ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ¨©é™ã‚’å¤‰æ›´:', menuId, role, '->', newState ? 'ON' : 'OFF');
  }

  /**
   * ä¸€æ‹¬è¨­å®šï¼ˆãƒ–ãƒ­ãƒƒã‚¯å†…ã®å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æŒ‡å®šæ¨©é™ã§ON/OFFã«è¨­å®šï¼‰
   * @param {string} blockId - ãƒ–ãƒ­ãƒƒã‚¯IDï¼ˆmain, master, configï¼‰
   * @param {string} permissionId - æ¨©é™ID
   * @param {boolean} newState - true=ON, false=OFF
   * @param {Array} menuIds - å¯¾è±¡ãƒ¡ãƒ‹ãƒ¥ãƒ¼IDãƒªã‚¹ãƒˆ
   */
  function bulkSetPermission(blockId, permissionId, newState, menuIds) {
    console.log('[PERM] ä¸€æ‹¬è¨­å®š:', blockId, permissionId, newState ? 'ON' : 'OFF', menuIds);

    // å„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®æ¨©é™ã‚’æ›´æ–°
    menuIds.forEach(menuId => {
      if (!menuPermissions[menuId]) {
        menuPermissions[menuId] = { visibleTo: ['owner'] };
      }

      const visibleTo = menuPermissions[menuId].visibleTo;
      if (newState && !visibleTo.includes(permissionId)) {
        visibleTo.push(permissionId);
      } else if (!newState && visibleTo.includes(permissionId)) {
        const index = visibleTo.indexOf(permissionId);
        visibleTo.splice(index, 1);
      }

      // UIã®ãƒˆã‚°ãƒ«ã‚‚æ›´æ–°
      const toggleElement = document.querySelector(`[data-menu="${menuId}"][data-role="${permissionId}"]`);
      if (toggleElement) {
        toggleElement.dataset.on = newState.toString();
        toggleElement.style.background = newState ? '#3b82f6' : '#d1d5db';
        const circle = toggleElement.querySelector('div');
        if (circle) {
          circle.style.transform = newState ? 'translateX(20px)' : 'translateX(2px)';
        }
      }
    });

    console.log('[PERM] ä¸€æ‹¬è¨­å®šå®Œäº†:', blockId, permissionId, '->', newState ? 'å…¨ON' : 'å…¨OFF');
  }

  /**
   * ä¸€æ‹¬ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ON/OFFåˆ‡ã‚Šæ›¿ãˆï¼‰
   */
  function bulkTogglePermissionSwitch(blockId, permissionId, menuIds, element) {
    const isOn = element.dataset.on === 'true';
    const newState = !isOn;

    // ãƒˆã‚°ãƒ«ã®è¦‹ãŸç›®ã‚’æ›´æ–°
    element.dataset.on = newState.toString();
    element.style.background = newState ? '#3b82f6' : '#d1d5db';
    element.querySelector('div').style.transform = newState ? 'translateX(20px)' : 'translateX(2px)';

    // å®Ÿéš›ã®ä¸€æ‹¬è¨­å®šã‚’å®Ÿè¡Œ
    bulkSetPermission(blockId, permissionId, newState, menuIds);
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã‚’æ›´æ–°ï¼ˆãƒ¡ãƒ¢ãƒªä¸Šï¼‰
   */
  function updateUserPermission(selectElement) {
    const email = selectElement.dataset.email;
    const newPermissionId = selectElement.value;

    // PERMISSION_DEFINITIONSã‹ã‚‰è¡¨ç¤ºåã‚’å–å¾—
    const permDef = PERMISSION_DEFINITIONS[newPermissionId];
    const permissionDisplay = permDef ? `${permDef.icon} ${permDef.label}` : newPermissionId;

    const user = usersData.find(u => u.email === email);
    if (user) {
      user.permissionId = newPermissionId;
      user.permissionDisplay = permissionDisplay;
      console.log('[PERM] ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã‚’å¤‰æ›´:', email, '->', newPermissionId);

      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºè¨­å®šã‚’å³åº§ã«å†æç”»ï¼ˆä½¿ç”¨ä¸­æ¨©é™ãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ï¼‰
      renderMenuPermissionList();
    }
  }

  /**
   * æ¨©é™è¨­å®šã‚’ä¿å­˜ï¼ˆsaveConfig()ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ï¼‰
   * @param {boolean} showAlert - å®Œäº†ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã‹ï¼ˆçµ±åˆæ™‚ã¯falseï¼‰
   * @returns {Promise<boolean>} ä¿å­˜æˆåŠŸã—ãŸã‹ã©ã†ã‹
   */
  async function savePermissionSettings(showAlert = true) {
    // æ¨©é™è¨­å®šãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
    if (!permissionSettingsLoaded) {
      console.log('[PERM] æ¨©é™è¨­å®šãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
      return true; // ã‚¨ãƒ©ãƒ¼ã§ã¯ãªã„ã®ã§trueã‚’è¿”ã™
    }

    try {
      if (!window.db) {
        throw new Error('FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
      }

      console.log('[PERM] æ¨©é™è¨­å®šã‚’ä¿å­˜ä¸­...');

      // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã‚’æ›´æ–°
      const batch = window.db.batch();
      usersData.forEach(user => {
        const userRef = window.db.collection('users').doc(user.email);
        batch.update(userRef, {
          permissionId: user.permissionId,
          permissionDisplay: user.permissionDisplay,
          lastUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      });

      // 2. ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ¨©é™è¨­å®šã‚’ä¿å­˜
      const menuPermRef = window.db.collection('settings').doc('menuPermissions');
      batch.set(menuPermRef, menuPermissions);

      await batch.commit();

      console.log('[PERM] âœ… æ¨©é™è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      return true;

    } catch (error) {
      console.error('[PERM] âŒ æ¨©é™è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      if (showAlert) {
        alert('æ¨©é™è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
      return false;
    }
  }

  // ================= ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½ =================

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚’èª­ã¿è¾¼ã¿
   */
  async function loadUserManagement() {
    const loadingDiv = document.getElementById('userManagementLoading');
    const contentDiv = document.getElementById('userManagementContent');

    // ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ãƒã‚§ãƒƒã‚¯
    const permissionId = localStorage.getItem('reborn_user_permission_id');
    if (permissionId !== 'owner') {
      loadingDiv.innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <div style="font-size: 48px; margin-bottom: 16px;">ğŸ”’</div>
          <div style="font-size: 14px; color: #dc2626;">ã“ã®æ©Ÿèƒ½ã¯ç®¡ç†è€…ã®ã¿åˆ©ç”¨ã§ãã¾ã™</div>
        </div>
      `;
      return;
    }

    try {
      console.log('[USER] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚’èª­ã¿è¾¼ã¿ä¸­...');

      // Firestoreã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—
      const usersSnapshot = await window.db.collection('users').get();
      const users = [];

      usersSnapshot.forEach(doc => {
        users.push({ id: doc.id, ...doc.data() });
      });

      console.log('[USER] å–å¾—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:', users.length);

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘
      const pendingUsers = users.filter(u => u.status === 'pending');
      const activeUsers = users.filter(u => u.status === 'active' || !u.status); // æ—§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯activeæ‰±ã„
      const inactiveUsers = users.filter(u => u.status === 'inactive');

      // ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
      document.getElementById('pendingUsersCount').textContent = pendingUsers.length;
      document.getElementById('activeUsersCount').textContent = activeUsers.length;
      document.getElementById('inactiveUsersCount').textContent = inactiveUsers.length;

      // ãƒªã‚¹ãƒˆæç”»
      renderUserList('pendingUsersList', pendingUsers, 'pending');
      renderUserList('activeUsersList', activeUsers, 'active');
      renderUserList('inactiveUsersList', inactiveUsers, 'inactive');

      // è¡¨ç¤ºåˆ‡æ›¿
      loadingDiv.style.display = 'none';
      contentDiv.style.display = 'block';

    } catch (error) {
      console.error('[USER] âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      loadingDiv.innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <div style="font-size: 48px; margin-bottom: 16px;">âŒ</div>
          <div style="font-size: 14px; color: #dc2626;">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>
          <div style="font-size: 12px; color: #6b7280; margin-top: 8px;">${error.message}</div>
        </div>
      `;
    }
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’æç”»
   */
  function renderUserList(containerId, users, status) {
    const container = document.getElementById(containerId);
    if (!container) return;

    if (users.length === 0) {
      const emptyMsg = status === 'pending' ? 'æ‰¿èªå¾…ã¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“' :
                       status === 'inactive' ? 'ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“' :
                       'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“';
      container.innerHTML = `
        <div style="text-align: center; color: #9ca3af; font-size: 13px; padding: 20px;">
          ${emptyMsg}
        </div>
      `;
      return;
    }

    container.innerHTML = users.map(user => {
      const photoUrl = user.photoURL || '';
      const userName = user.userName || user.name || 'Unknown';
      const userEmail = user.userEmail || user.email || '';
      const permId = user.permissionId || 'staff';
      const createdAt = user.createdAt ? new Date(user.createdAt).toLocaleDateString('ja-JP') : '';

      let actionButtons = '';

      if (status === 'pending') {
        // æ¨©é™é¸æŠã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆï¼ˆownerã¯è‡ªåˆ†ã§ã¯é¸ã¹ãªã„ï¼‰
        const permissionOptions = Object.values(PERMISSION_DEFINITIONS)
          .filter(p => p.id !== 'owner') // ç®¡ç†è€…æ¨©é™ã¯é™¤å¤–
          .sort((a, b) => a.order - b.order)
          .map(p => `<option value="${p.id}">${p.icon} ${p.label}</option>`)
          .join('');

        actionButtons = `
          <div style="margin-top: 8px;">
            <div style="margin-bottom: 8px;">
              <label style="display: block; font-size: 11px; color: #6b7280; margin-bottom: 4px;">æ¨©é™ã‚’é¸æŠ:</label>
              <select id="permission-select-${user.id}" style="width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; background: white;">
                ${permissionOptions}
              </select>
            </div>
            <div style="display: flex; gap: 8px;">
              <button onclick="approveUser('${user.id}')"
                      style="flex: 1; padding: 8px 12px; background: #10b981; color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">
                âœ… æ‰¿èª
              </button>
              <button onclick="rejectUser('${user.id}')"
                      style="flex: 1; padding: 8px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">
                âŒ å´ä¸‹
              </button>
            </div>
          </div>
        `;
      } else if (status === 'active') {
        // è‡ªåˆ†è‡ªèº«ã¯ç„¡åŠ¹åŒ–ã§ããªã„
        const currentEmail = localStorage.getItem('reborn_user_email');
        const isSelf = userEmail === currentEmail;
        actionButtons = isSelf ? `
          <div style="margin-top: 8px; font-size: 11px; color: #6b7280;">ï¼ˆç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼‰</div>
        ` : `
          <button onclick="disableUser('${user.id}')"
                  style="margin-top: 8px; padding: 6px 12px; background: #f3f4f6; color: #6b7280; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 11px; cursor: pointer;">
            ğŸš« ç„¡åŠ¹åŒ–
          </button>
        `;
      } else if (status === 'inactive') {
        actionButtons = `
          <div style="display: flex; gap: 8px; margin-top: 8px;">
            <button onclick="enableUser('${user.id}')"
                    style="flex: 1; padding: 8px 12px; background: #10b981; color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">
              âœ… æœ‰åŠ¹åŒ–
            </button>
            <button onclick="deleteUser('${user.id}', '${userName.replace(/'/g, "\\'")}')"
                    style="padding: 8px 12px; background: #fee2e2; color: #dc2626; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">
              ğŸ—‘ï¸
            </button>
          </div>
        `;
      }

      // æ¨©é™è¡¨ç¤ºï¼ˆæ‰¿èªå¾…ã¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€Œæ‰¿èªå¾…ã¡ã€ã¨è¡¨ç¤ºï¼‰
      let permLabel;
      if (status === 'pending') {
        permLabel = 'â³ æ‰¿èªå¾…ã¡';
      } else {
        const permDef = PERMISSION_DEFINITIONS[permId];
        permLabel = permDef ? `${permDef.icon} ${permDef.label}` : permId;
      }

      return `
        <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: #f9fafb; border-radius: 8px;">
          <div style="flex-shrink: 0;">
            ${photoUrl ?
              `<img src="${photoUrl}" style="width: 44px; height: 44px; border-radius: 50%; object-fit: cover;">` :
              `<div style="width: 44px; height: 44px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 18px; color: #9ca3af;">ğŸ‘¤</div>`
            }
          </div>
          <div style="flex: 1; min-width: 0;">
            <div style="font-size: 14px; font-weight: 600; color: #374151;">${userName}</div>
            <div style="font-size: 12px; color: #6b7280; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${userEmail}</div>
            <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">
              ${permLabel}${createdAt ? ` â€¢ ç™»éŒ²: ${createdAt}` : ''}
            </div>
            ${actionButtons}
          </div>
        </div>
      `;
    }).join('');
  }

  /**
   * æ‰¿èªå¾…ã¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢é€£ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã«ã™ã‚‹
   */
  async function completePendingUserTask(pendingUserEmail) {
    try {
      // ç®¡ç†è€…ã‚’å–å¾—
      const ownersSnapshot = await window.db.collection('users')
        .where('permissionId', '==', 'owner')
        .get();

      if (ownersSnapshot.empty) {
        console.warn('[Todo] ç®¡ç†è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      // å„ç®¡ç†è€…ã®ã‚¿ã‚¹ã‚¯ã‚’æ¤œç´¢ã—ã¦å®Œäº†ã«ã™ã‚‹
      for (const ownerDoc of ownersSnapshot.docs) {
        const ownerEmail = ownerDoc.data().userEmail;
        const tasksRef = window.db.collection('userTasks').doc(ownerEmail).collection('tasks');

        // pending_user_approval ã‚¿ã‚¤ãƒ—ã§ã€è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢é€£ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’æ¤œç´¢
        const tasksSnapshot = await tasksRef
          .where('type', '==', 'pending_user_approval')
          .where('completed', '==', false)
          .get();

        for (const taskDoc of tasksSnapshot.docs) {
          const taskData = taskDoc.data();
          // relatedData.pendingUserEmail ãŒä¸€è‡´ã™ã‚‹ã‹ç¢ºèª
          if (taskData.relatedData && taskData.relatedData.pendingUserEmail === pendingUserEmail) {
            await taskDoc.ref.update({
              completed: true,
              completedAt: new Date().toISOString()
            });
            console.log('[Todo] âœ… ã‚¿ã‚¹ã‚¯å®Œäº†:', ownerEmail, pendingUserEmail);
          }
        }
      }
    } catch (error) {
      console.error('[Todo] ã‚¿ã‚¹ã‚¯å®Œäº†ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ‰¿èª
   */
  window.approveUser = async function(userId) {
    // é¸æŠã•ã‚ŒãŸæ¨©é™ã‚’å–å¾—
    const permissionSelect = document.getElementById(`permission-select-${userId}`);
    const selectedPermissionId = permissionSelect ? permissionSelect.value : 'staff';
    const permDef = PERMISSION_DEFINITIONS[selectedPermissionId] || PERMISSION_DEFINITIONS['staff'];

    if (!confirm(`ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã€Œ${permDef.icon} ${permDef.label}ã€ã¨ã—ã¦æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ`)) return;

    try {
      // ã¾ãšãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ï¼ˆFCMãƒˆãƒ¼ã‚¯ãƒ³ã€åå‰ãªã©ï¼‰
      const userDoc = await window.db.collection('users').doc(userId).get();
      const userData = userDoc.exists ? userDoc.data() : {};
      const userName = userData.userName || userId.split('@')[0];
      const fcmToken = userData.fcmToken;

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ‰¿èª
      await window.db.collection('users').doc(userId).update({
        status: 'active',
        permissionId: selectedPermissionId,
        permissionDisplay: permDef.label,
        approvedAt: new Date().toISOString(),
        approvedBy: localStorage.getItem('reborn_user_email')
      });
      console.log('[USER] âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ‰¿èª:', userId, 'æ¨©é™:', selectedPermissionId);

      // é–¢é€£ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã«ã™ã‚‹ï¼ˆuserIdã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰
      await completePendingUserTask(userId);

      // æ‰¿èªã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’é€ä¿¡
      if (fcmToken) {
        try {
          const response = await fetch('https://reborn-fcm-worker.mercari-yasuhirotakuji.workers.dev/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              tokens: [fcmToken],
              title: 'ğŸ‰ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæ‰¿èªã•ã‚Œã¾ã—ãŸï¼',
              body: `${userName}ã•ã‚“ã€ãƒ•ãƒªãƒ©ã¸ã‚ˆã†ã“ãï¼ã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚`,
              data: { type: 'user_approved' }
            })
          });
          if (response.ok) {
            console.log('[USER] âœ… æ‰¿èªé€šçŸ¥ãƒ—ãƒƒã‚·ãƒ¥é€ä¿¡å®Œäº†');
          }
        } catch (pushError) {
          console.error('[USER] ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼:', pushError);
        }
      }

      // æ‰¿èªã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚’é€ä¿¡
      try {
        await sendApprovalEmail(userId, userName);
        console.log('[USER] âœ… æ‰¿èªãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†');
      } catch (emailError) {
        console.error('[USER] ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼:', emailError);
      }

      alert(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã€Œ${permDef.label}ã€ã¨ã—ã¦æ‰¿èªã—ã¾ã—ãŸ`);
      loadUserManagement(); // ãƒªã‚¹ãƒˆå†èª­ã¿è¾¼ã¿
    } catch (error) {
      console.error('[USER] âŒ æ‰¿èªã‚¨ãƒ©ãƒ¼:', error);
      alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
    }
  }

  /**
   * æ‰¿èªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡
   */
  async function sendApprovalEmail(userEmail, userName) {
    // Cloudflare WorkerçµŒç”±ã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡
    const response = await fetch('https://reborn-fcm-worker.mercari-yasuhirotakuji.workers.dev/send-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        to: userEmail,
        subject: 'ğŸ‰ ãƒ•ãƒªãƒ©ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæ‰¿èªã•ã‚Œã¾ã—ãŸ',
        body: `${userName}ã•ã‚“\n\nãƒ•ãƒªãƒ©ã¸ã‚ˆã†ã“ãï¼\nã‚ãªãŸã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæ‰¿èªã•ã‚Œã¾ã—ãŸã€‚\n\nã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚\nhttps://furira.jp\n\n---\nãƒ•ãƒªãƒ©ç‰©è²©ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ `
      })
    });

    if (!response.ok) {
      throw new Error('ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—: ' + response.status);
    }
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å´ä¸‹ï¼ˆå‰Šé™¤ï¼‰
   */
  window.rejectUser = async function(userId) {
    if (!confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å´ä¸‹ã—ã¾ã™ã‹ï¼Ÿ\nå´ä¸‹ã™ã‚‹ã¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) return;

    try {
      // é–¢é€£ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã«ã™ã‚‹ï¼ˆå‰Šé™¤å‰ã«å®Ÿè¡Œï¼‰
      await completePendingUserTask(userId);

      await window.db.collection('users').doc(userId).delete();
      console.log('[USER] âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å´ä¸‹:', userId);
      alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å´ä¸‹ã—ã¾ã—ãŸ');
      loadUserManagement(); // ãƒªã‚¹ãƒˆå†èª­ã¿è¾¼ã¿
    } catch (error) {
      console.error('[USER] âŒ å´ä¸‹ã‚¨ãƒ©ãƒ¼:', error);
      alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
    }
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç„¡åŠ¹åŒ–
   */
  window.disableUser = async function(userId) {
    if (!confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™ã‹ï¼Ÿ\\nç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ­ã‚°ã‚¤ãƒ³ã§ããªããªã‚Šã¾ã™ã€‚')) return;

    try {
      await window.db.collection('users').doc(userId).update({
        status: 'inactive',
        disabledAt: new Date().toISOString(),
        disabledBy: localStorage.getItem('reborn_user_email')
      });
      console.log('[USER] âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç„¡åŠ¹åŒ–:', userId);
      alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸ');
      loadUserManagement(); // ãƒªã‚¹ãƒˆå†èª­ã¿è¾¼ã¿
    } catch (error) {
      console.error('[USER] âŒ ç„¡åŠ¹åŒ–ã‚¨ãƒ©ãƒ¼:', error);
      alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
    }
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æœ‰åŠ¹åŒ–
   */
  window.enableUser = async function(userId) {
    if (!confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã™ã‹ï¼Ÿ')) return;

    try {
      await window.db.collection('users').doc(userId).update({
        status: 'active',
        enabledAt: new Date().toISOString(),
        enabledBy: localStorage.getItem('reborn_user_email')
      });
      console.log('[USER] âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æœ‰åŠ¹åŒ–:', userId);
      alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ');
      loadUserManagement(); // ãƒªã‚¹ãƒˆå†èª­ã¿è¾¼ã¿
    } catch (error) {
      console.error('[USER] âŒ æœ‰åŠ¹åŒ–ã‚¨ãƒ©ãƒ¼:', error);
      alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
    }
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å®Œå…¨å‰Šé™¤
   */
  window.deleteUser = async function(userId, userName) {
    if (!confirm(`ã€Œ${userName}ã€ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) return;

    try {
      await window.db.collection('users').doc(userId).delete();
      console.log('[USER] âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤:', userId);
      alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      loadUserManagement(); // ãƒªã‚¹ãƒˆå†èª­ã¿è¾¼ã¿
    } catch (error) {
      console.error('[USER] âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
      alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
    }
  }
</script>

</body>
</html>
