<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>設定 - Furira</title>

  <!-- PWA対応 -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#000000">

  <!-- iOS PWA対応 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="REBORN">
  <link rel="apple-touch-icon" sizes="180x180" href="/icon-180.png">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- REBORN Brand Colors & Theme -->
  <link rel="stylesheet" href="https://www.reborn-inventory.com/css/reborn-brand-colors.css?v=0bd1a9b">
  <link rel="stylesheet" href="https://www.reborn-inventory.com/css/reborn-theme.css?v=0bd1a9b">

  <!-- Sortable.js - タッチ対応のドラッグ&ドロップライブラリ -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f8f9fa;
    }
    .config-container {
      padding: 16px;
    }
    .nav-tabs {
      margin-bottom: 0;
      flex-wrap: nowrap;
      overflow-x: auto;
      overflow-y: hidden;
      z-index: 100; /* コンテンツより上、タブナビゲーションヘッダー（z-index: 1000）より下に表示 */
      border-bottom: none;
      background: #f8f9fa;
      padding: 8px 8px 0 8px;
      border-radius: 8px 8px 0 0;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
    }

    /* タブナビゲーションのスクロールバーを細く */
    .nav-tabs::-webkit-scrollbar {
      height: 4px;
    }

    .nav-tabs::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 2px;
    }

    .nav-tabs::-webkit-scrollbar-track {
      background: #f7fafc;
    }
    .nav-tabs .nav-link {
      font-size: 13px;
      padding: 10px 16px;
      white-space: nowrap;
      border: 1px solid transparent;
      border-radius: 6px 6px 0 0;
      color: #6c757d;
      background: transparent;
      margin-right: 4px;
      transition: all 0.2s;
    }
    .nav-tabs .nav-link:hover {
      background: #e9ecef;
      color: #495057;
    }
    .nav-tabs .nav-link.active {
      color: #212529;
      background: white;
      border-color: #dee2e6 #dee2e6 white;
      font-weight: 600;
    }
    .tab-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #212529;
    }
    .form-label {
      font-weight: 500;
      font-size: 13px;
      color: #495057;
      margin-bottom: 4px;
    }
    .form-control, .form-select {
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #ced4da;
    }
    .form-control:focus, .form-select:focus {
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    .btn-group-sm .btn {
      font-size: 12px;
      padding: 4px 8px;
    }
    .save-btn {
      position: sticky;
      bottom: 0;
      background: white;
      padding: 12px 16px;
      border-top: 1px solid #dee2e6;
      margin: 0;
      z-index: 10;
    }
    .button-config-item {
      background: #f8f9fa;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 6px;
      border: 1px solid #e9ecef;
    }
    .button-config-item .form-label {
      margin-bottom: 6px;
    }
    .add-btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .add-btn:hover {
      background: #2563eb;
    }
    .remove-btn {
      font-size: 12px;
      padding: 2px 8px;
    }
    .discount-group {
      background: white;
      padding: 12px;
      margin-bottom: 16px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .discount-range-item {
      background: #f9fafb;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 4px;
      border: 1px solid #dee2e6;
    }
    .alert {
      font-size: 13px;
      padding: 10px 14px;
      margin-bottom: 16px;
    }
    .input-group-text {
      font-size: 13px;
    }
    .condition-group {
      margin-bottom: 24px;
    }
    .condition-group-title {
      font-size: 14px;
      font-weight: 600;
      color: #495057;
      margin-bottom: 12px;
      padding: 8px 12px;
      background: #e9ecef;
      border-radius: 6px;
    }

    /* トグルスイッチ */
    .switch input + span {
      background-color: #d1d5db; /* オフ: グレー */
    }
    .switch input:checked + span {
      background-color: #3b82f6; /* オン: 青 */
    }
    .switch input:checked + span:before {
      transform: translateX(20px);
    }
    .switch span:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    /* スピナーアニメーション */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* システム設定内タブコンテンツの外枠を削除（中身を広げる） */
    #systemConfigTabContent {
      background: transparent;
      padding: 0;
      border-radius: 0;
      box-shadow: none;
    }

    /* 商品登録設定内タブコンテンツの外枠を削除（中身を広げる） */
    #productConfigTabContent {
      background: transparent;
      padding: 0;
      border-radius: 0;
      box-shadow: none;
    }

  </style>
</head>
<body>
  <script>
  // FCMトークンをGASテンプレート変数から取得（マルチユーザー対応）
  const fcmToken = '<!-- FCM Token will be set by JavaScript -->';
  console.log('🔑 FCMトークン取得 (GASテンプレート):', fcmToken ? fcmToken.substring(0, 20) + '...' : 'なし');

  // アイコン画像のBase64データを一時保存（保存ボタン押下時にアップロード）
  let pendingUserIconData = null;

  function navigateInPWA(url) {
    try {
      // iframe内にいる場合、最上位ウィンドウにpostMessageで通知
      if (window.top && window.top !== window.self) {
        console.log('📤 postMessage送信 (to window.top):', url);
        window.top.postMessage({
          type: 'navigate',
          url: url
        }, '*'); // GASのサンドボックスiframeから送信するため、ワイルドカードを使用
      } else {
        // iframe外（通常のブラウザ）の場合
        window.location.href = url;
      }
    } catch (e) {
      console.error('❌ ナビゲーションエラー:', e);
      // フォールバック: 通常の遷移
      window.location.href = url;
    }
  }
  </script>

  <!-- 統一ヘッダー -->
  <div class="header">
    <div class="header-content">
      <button class="back-button" id="back-button">
        <i class="bi bi-chevron-left"></i>
      </button>
      <div class="header-title" id="page-header-title">
        ⚙️ システム設定
      </div>
      <div style="width: 40px;"></div>
    </div>
  </div>

  <div class="config-container">
    <!-- タブコンテンツ -->
    <div class="tab-content" id="configTabContent">

      <!-- 商品登録設定 -->
      <div class="tab-pane fade" id="product" role="tabpanel">
        <!-- 商品登録設定内の横タブナビゲーション -->
        <ul class="nav nav-tabs" id="productConfigTabs" role="tablist" style="margin-bottom: 16px; overflow-x: auto; flex-wrap: nowrap; white-space: nowrap;">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="product-salesword-tab" data-bs-toggle="tab" data-bs-target="#product-salesword" type="button" role="tab" style="font-size: 13px; padding: 8px 12px;">💬セールスワード設定</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="product-condition-tab" data-bs-toggle="tab" data-bs-target="#product-condition" type="button" role="tab" style="font-size: 13px; padding: 8px 12px;">🔘商品状態設定</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="product-hashtag-tab" data-bs-toggle="tab" data-bs-target="#product-hashtag" type="button" role="tab" style="font-size: 13px; padding: 8px 12px;">🏷️ハッシュタグ設定</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="product-discount-tab" data-bs-toggle="tab" data-bs-target="#product-discount" type="button" role="tab" style="font-size: 13px; padding: 8px 12px;">💰割引設定</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="product-ai-tab" data-bs-toggle="tab" data-bs-target="#product-ai" type="button" role="tab" style="font-size: 13px; padding: 8px 12px;">✨AI生成設定</button>
          </li>
        </ul>

        <!-- 商品登録設定内のタブコンテンツ -->
        <div class="tab-content" id="productConfigTabContent">
          <!-- セールスワード（プレースホルダー） -->
          <div class="tab-pane fade show active" id="product-salesword" role="tabpanel">
        <!-- 全体説明 -->
        <div style="font-size: 12px; color: #374151; padding: 16px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 8px; border-left: 4px solid #3b82f6; margin-bottom: 24px; line-height: 1.6;">
          <div style="font-weight: 600; margin-bottom: 8px; font-size: 14px; color: #1e40af;">
            💡 セールスワード設定について
          </div>
          <div>
            商品登録時に使うセールスワードの<strong>表示形式</strong>、<strong>デフォルト値</strong>、<strong>よく使うワード</strong>を設定できます。<br>
            以下の順序で設定すると分かりやすいです。
          </div>
        </div>

        <!-- 1️⃣ 表示形式設定（全セールスワード共通） -->
        <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 2px solid #e5e7eb;">
          <div style="font-weight: 600; margin-bottom: 8px; font-size: 15px; color: #374151;">
            1️⃣ 表示形式（全セールスワード共通）
          </div>
          <div style="font-size: 12px; color: #6b7280; margin-bottom: 12px; line-height: 1.5;">
            【】や〈〉等、セールスワードの前後に付ける記号を設定します
          </div>

          <!-- グローバル設定 -->
          <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <div style="font-weight: 600; margin-bottom: 12px; font-size: 14px;">📌 すべてのワードに適用</div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
              <div>
                <label style="font-size: 11px; margin-bottom: 4px; display: block;">前に付ける文字</label>
                <select id="saleswordPrefixGlobalSelect" class="form-select form-select-sm" onchange="handlePrefixChange()">
                  <option value="">なし</option>
                  <option value="【">【</option>
                  <option value="『">『</option>
                  <option value="「">「</option>
                  <option value="(">（</option>
                  <option value="｜">｜</option>
                  <option value="★">★</option>
                  <option value="☆">☆</option>
                  <option value="◆">◆</option>
                  <option value="●">●</option>
                  <option value="■">■</option>
                  <option value="♡">♡</option>
                  <option value="✨">✨</option>
                  <option value="※">※</option>
                  <option value="custom">カスタム入力</option>
                </select>
                <input type="text" id="saleswordPrefixGlobalCustom" class="form-control form-control-sm" placeholder="自由に入力" maxlength="5" style="margin-top: 4px; display: none;" oninput="updateSaleswordFormatPreview()">
              </div>
              <div>
                <label style="font-size: 11px; margin-bottom: 4px; display: block;">後ろに付ける文字</label>
                <select id="saleswordSuffixGlobalSelect" class="form-select form-select-sm" onchange="handleSuffixChange()">
                  <option value="">なし</option>
                  <option value="】">】</option>
                  <option value="』">』</option>
                  <option value="」">」</option>
                  <option value=")">）</option>
                  <option value="｜">｜</option>
                  <option value="!">！</option>
                  <option value="★">★</option>
                  <option value="☆">☆</option>
                  <option value="◆">◆</option>
                  <option value="●">●</option>
                  <option value="■">■</option>
                  <option value="♡">♡</option>
                  <option value="✨">✨</option>
                  <option value="※">※</option>
                  <option value="custom">カスタム入力</option>
                </select>
                <input type="text" id="saleswordSuffixGlobalCustom" class="form-control form-control-sm" placeholder="自由に入力" maxlength="5" style="margin-top: 4px; display: none;" oninput="updateSaleswordFormatPreview()">
              </div>
            </div>

            <!-- プレビュー -->
            <div style="background: white; padding: 8px 12px; border-radius: 4px; border: 1px solid #dee2e6;">
              <div style="font-size: 11px; color: #6c757d; margin-bottom: 4px;">プレビュー:</div>
              <div id="saleswordFormatPreview" style="font-size: 14px; color: #212529; font-weight: 500;">【美品】</div>
            </div>
          </div>

          <!-- ワードごとに個別設定 -->
          <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #dee2e6;">
            <div style="font-weight: 600; margin-bottom: 12px; font-size: 14px;">
              🏷️ ワードごとに個別設定
            </div>

            <div style="font-size: 12px; color: #6c757d; margin-bottom: 12px;">
              特定のセールスワードだけ異なる形式を使いたい場合に設定します。<br>
              例：「匿名配送」だけ★で囲む、「送料無料」だけ『』で囲むなど
            </div>

            <div id="wordOverrideList" style="margin-bottom: 12px;">
              <!-- 動的に生成されるワード別設定 -->
            </div>

            <button type="button" onclick="addWordOverride()" style="width: 100%; padding: 10px; background: #3b82f6; border: none; border-radius: 8px; color: white; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 8px; transition: all 0.2s;" onmouseover="this.style.background='#2563eb';" onmouseout="this.style.background='#3b82f6';">
              + ワード別設定を追加
            </button>

            <button type="button" onclick="clearAllSaleswordSettings()" style="width: 100%; padding: 10px; background: white; border: 2px solid #ef4444; border-radius: 8px; color: #ef4444; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 16px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
              🗑️ すべてクリア
            </button>
          </div>
        </div>

        <!-- 2️⃣ デフォルトワード（自動入力） -->
        <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 2px solid #e5e7eb;">
          <div style="font-weight: 600; margin-bottom: 8px; font-size: 15px; color: #374151;">
            2️⃣ デフォルトワード（自動入力）
          </div>
          <div style="font-size: 12px; color: #6b7280; margin-bottom: 12px; line-height: 1.5;">
            商品登録を開いたときに自動で入力されるセールスワードを設定します
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div>
              <label style="font-size: 11px; margin-bottom: 4px; display: block; color: #6b7280;">カテゴリ</label>
              <select id="defaultSaleswordCategory" class="form-select form-select-sm" onchange="updateDefaultSaleswordOptions()">
                <option value="">--選択--</option>
              </select>
            </div>
            <div>
              <label style="font-size: 11px; margin-bottom: 4px; display: block; color: #6b7280;">セールスワード</label>
              <select id="defaultSalesword" class="form-select form-select-sm" disabled>
                <option value="">--選択--</option>
              </select>
            </div>
          </div>
        </div>

        <!-- 3️⃣ よく使うワード（クイック選択） -->
        <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 2px solid #e5e7eb;">
          <div style="font-weight: 600; margin-bottom: 8px; font-size: 15px; color: #374151;">
            3️⃣ よく使うワード（クイック選択）
          </div>
          <div style="font-size: 12px; color: #6b7280; margin-bottom: 12px; line-height: 1.5;">
            カテゴリから素早く選べるワードを「よく使う」リストに追加します
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
            <div>
              <label style="font-size: 11px; margin-bottom: 4px; display: block; color: #6b7280;">カテゴリ</label>
              <select id="saleswordCategorySelect" class="form-select form-select-sm" onchange="updateSaleswordOptions()">
                <option value="">--選択--</option>
              </select>
            </div>
            <div>
              <label style="font-size: 11px; margin-bottom: 4px; display: block; color: #6b7280;">セールスワード</label>
              <select id="saleswordSelect" class="form-select form-select-sm" disabled>
                <option value="">--選択--</option>
              </select>
            </div>
          </div>

          <button type="button" onclick="addSaleswordFromDropdown()" style="width: 100%; padding: 8px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#2563eb';" onmouseout="this.style.background='#3b82f6';">
            + 追加
          </button>
        </div>

        <!-- 登録済みセールスワードリスト -->
        <div id="saleswordList" style="margin-bottom: 16px;">
          <!-- 動的に生成される登録済みセールスワード -->
        </div>
      </div>

          <!-- 商品状態ボタン -->
          <div class="tab-pane fade" id="product-condition" role="tabpanel">
            <!-- ヒント -->
            <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
              <div style="color: #3b82f6; font-weight: 600; margin-bottom: 4px;">
                <span>💡 概要</span>
              </div>
              <div id="condition-overview-content" style="display: block; padding-left: 12px; margin-bottom: 8px;">
                商品登録時に「商品状態(詳細)」欄へワンクリックで説明文を挿入できるボタンを設定できます。6つの商品状態カテゴリ（新品・未使用に近い・目立った傷や汚れなし等）ごとに、よく使う説明文をボタン化して登録できます
              </div>
            </div>

            <div id="conditionButtonsContainer">
              <!-- 動的に生成 -->
            </div>

            <!-- リセットボタン -->
            <button type="button" onclick="clearConditionButtons()" style="width: 100%; padding: 10px; background: white; border: 2px solid #ef4444; border-radius: 8px; color: #ef4444; font-size: 13px; font-weight: 600; cursor: pointer; margin-top: 16px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
              🗑️ すべてクリア
            </button>
          </div>

          <!-- ハッシュタグ（プレースホルダー） -->
          <div class="tab-pane fade" id="product-hashtag" role="tabpanel">
<!-- ヒント -->
        <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
          <div style="color: #3b82f6; font-weight: 600; margin-bottom: 4px;">
            <span>💡 概要</span>
          </div>
          <div id="hashtag-overview-content" style="display: block; padding-left: 12px; margin-bottom: 8px;">
            ハッシュタグは商品説明の最後に自動で追加されます（例: #REBORN_全商品）。共通プレフィックス（ショップ名）の設定や、5種類のタイプ（全商品、ブランド、カテゴリ、カラー、サイズ）から選択して追加、ドラッグ&ドロップで順番を並び替えできます
          </div>
        </div>

        <!-- 共通プレフィックス設定 -->
        <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
          <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
            <span style="font-size: 16px;">⚙️</span>
            <label style="font-size: 13px; font-weight: 600; color: #374151;">
              共通設定
            </label>
          </div>
          <div style="display: flex; align-items: stretch;">
            <span style="width: 32px; padding: 8px 0; border: 2px solid #d1d5db; border-right: none; border-radius: 6px 0 0 6px; background: #f9fafb; font-size: 14px; font-weight: 500; color: #374151; display: flex; align-items: center; justify-content: center;">#</span>
            <input type="text" id="commonHashtagPrefix" placeholder="ショップ名_" style="width: calc(100% - 32px); padding: 8px 10px; border: 2px solid #d1d5db; border-radius: 0 6px 6px 0; font-size: 16px; transition: all 0.2s; box-sizing: border-box;" onfocus="this.style.borderColor='#3b82f6';" onblur="this.style.borderColor='#d1d5db';" oninput="updateAllHashtagPreviews()">
          </div>
          <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">
            💡 ショップ名やアカウント名を入力してください（例: Shop〇〇_）
          </div>
        </div>

        <!-- 動的に生成されるハッシュタグ項目 -->
        <div id="hashtagItemsContainer"></div>

        <!-- 追加ボタン -->
        <button type="button" onclick="showHashtagTypeSelector()" style="width: 100%; padding: 10px; background: #3b82f6; border: none; border-radius: 8px; color: white; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 8px; transition: all 0.2s;" onmouseover="this.style.background='#2563eb';" onmouseout="this.style.background='#3b82f6';">
          + ハッシュタグを追加
        </button>

        <!-- クリアボタン -->
        <button type="button" onclick="clearAllHashtags()" style="width: 100%; padding: 10px; background: white; border: 2px solid #ef4444; border-radius: 8px; color: #ef4444; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 16px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
          🗑️ すべてクリア
        </button>

        <!-- ハッシュタグタイプ選択メニュー -->
        <div id="hashtagTypeSelectorMenu" style="display: none; margin-bottom: 16px; padding: 12px; background: white; border: 2px solid #3b82f6; border-radius: 8px;">
          <div style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">追加するハッシュタグのタイプを選択:</div>
          <div style="display: flex; flex-direction: column; gap: 6px;">
            <button type="button" onclick="addHashtagItemByType('全商品')" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; transition: all 0.2s; text-align: left;" onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#3b82f6';" onmouseout="this.style.background='white'; this.style.borderColor='#d1d5db';">
              <span style="font-size: 18px;">🌐</span>
              <span style="font-size: 13px; font-weight: 500; color: #374151;">全商品</span>
            </button>
            <button type="button" onclick="addHashtagItemByType('ブランド')" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; transition: all 0.2s; text-align: left;" onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#3b82f6';" onmouseout="this.style.background='white'; this.style.borderColor='#d1d5db';">
              <span style="font-size: 18px;">👔</span>
              <span style="font-size: 13px; font-weight: 500; color: #374151;">ブランド</span>
            </button>
            <button type="button" onclick="addHashtagItemByType('カテゴリ')" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; transition: all 0.2s; text-align: left;" onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#3b82f6';" onmouseout="this.style.background='white'; this.style.borderColor='#d1d5db';">
              <span style="font-size: 18px;">📁</span>
              <span style="font-size: 13px; font-weight: 500; color: #374151;">カテゴリ</span>
            </button>
            <button type="button" onclick="addHashtagItemByType('カラー')" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; transition: all 0.2s; text-align: left;" onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#3b82f6';" onmouseout="this.style.background='white'; this.style.borderColor='#d1d5db';">
              <span style="font-size: 18px;">🎨</span>
              <span style="font-size: 13px; font-weight: 500; color: #374151;">カラー</span>
            </button>
            <button type="button" onclick="addHashtagItemByType('サイズ')" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; transition: all 0.2s; text-align: left;" onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#3b82f6';" onmouseout="this.style.background='white'; this.style.borderColor='#d1d5db';">
              <span style="font-size: 18px;">📏</span>
              <span style="font-size: 13px; font-weight: 500; color: #374151;">サイズ</span>
            </button>
            <button type="button" onclick="hideHashtagTypeSelector()" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 12px; color: #6b7280; margin-top: 4px;" onmouseover="this.style.background='#e5e7eb';" onmouseout="this.style.background='#f3f4f6';">
              キャンセル
            </button>
          </div>
        </div>
          </div>

          <!-- 割引情報（プレースホルダー） -->
          <div class="tab-pane fade" id="product-discount" role="tabpanel">
<!-- ヒント -->
        <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
          <div style="color: #3b82f6; font-weight: 600; margin-bottom: 4px;">
            <span>💡 概要</span>
          </div>
          <div id="discount-overview-content" style="display: block; padding-left: 12px; margin-bottom: 8px;">
            設定した割引情報が商品説明に自動で追加されます。3種類の割引（フォロー割、リピート割、まとめ割）を設定でき、フォロー割・まとめ割は複数の価格帯・数量範囲を設定可能。説明文も自由に編集できます
          </div>
        </div>

        <!-- タイトル設定 -->
        <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
          <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px; display: block;">
            📌 タイトル
          </label>
          <select id="割引情報タイトル選択" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer; transition: all 0.2s; margin-bottom: 8px;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';" onchange="handleDiscountTitleChange()">
            <option value="【お得な割引情報】">【お得な割引情報】</option>
            <option value="【割引について】">【割引について】</option>
            <option value="【お値引き情報】">【お値引き情報】</option>
            <option value="【特別割引】">【特別割引】</option>
            <option value="【キャンペーン情報】">【キャンペーン情報】</option>
            <option value="">（タイトルなし）</option>
            <option value="custom">✏️ カスタム入力</option>
          </select>
          <input type="text" id="割引情報タイトルカスタム" placeholder="カスタムタイトルを入力" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; display: none; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6';" onblur="this.style.borderColor='#d1d5db';" oninput="updateDiscountPreview()">
        </div>

        <!-- 割引タイプリスト（動的に生成） -->
        <div id="discountTypesList">
          <!-- 動的に生成される -->
        </div>

        <!-- 割引追加ボタン -->
        <button type="button" onclick="addDiscountType()" style="width: 100%; margin-bottom: 16px; background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#2563eb';" onmouseout="this.style.background='#3b82f6';">+ 割引を追加</button>

        <!-- すべてクリアボタン -->
        <div style="text-align: center; margin-bottom: 16px;">
          <button type="button" onclick="clearAllDiscounts()" style="width: 100%; padding: 8px 16px; background: white; color: #ef4444; border: 2px solid #ef4444; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
            🗑️ すべてクリア
          </button>
        </div>

        <!-- プレビュー -->
        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px;">
          <div style="font-size: 11px; color: #6b7280; margin-bottom: 8px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">プレビュー</div>
          <div id="discountPreview" style="padding: 6px 10px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 11px; color: #1e40af; font-weight: 500; white-space: pre-line; line-height: 1.6;">
            プレビューを生成中...
          </div>
        </div>
          </div>

          <!-- AI生成設定 -->
          <div class="tab-pane fade" id="product-ai" role="tabpanel">
        <!-- ヒント -->
        <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
          <div style="color: #3b82f6; font-weight: 600; margin-bottom: 4px;">
            <span>💡 概要</span>
          </div>
          <div id="ai-overview-content" style="display: block; padding-left: 12px; margin-bottom: 8px;">
            Gemini APIを使用した商品説明文の自動生成設定です。プロンプトテンプレート、生成文字数、トーン、含める情報などを細かくカスタマイズできます。プリセットから選んで、さらに自分好みに調整することも可能です
          </div>
        </div>

        <!-- プリセット選択 -->
        <div style="margin-bottom: 24px;">
          <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">
            🎨 プリセットから選ぶ
          </div>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
            <button type="button" onclick="applyAiPreset('casual')" style="padding: 10px; background: white; border: 2px solid #40B4E5; border-radius: 6px; color: #40B4E5; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f5f3ff';" onmouseout="this.style.background='white';">
              😊 カジュアル<br><span style="font-size: 10px; font-weight: 400;">メルカリ向け</span>
            </button>
            <button type="button" onclick="applyAiPreset('standard')" style="padding: 10px; background: white; border: 2px solid #3b82f6; border-radius: 6px; color: #3b82f6; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#eff6ff';" onmouseout="this.style.background='white';">
              ⭐ スタンダード<br><span style="font-size: 10px; font-weight: 400;">★推奨</span>
            </button>
            <button type="button" onclick="applyAiPreset('polite')" style="padding: 10px; background: white; border: 2px solid #40B4E5; border-radius: 6px; color: #40B4E5; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f5f3ff';" onmouseout="this.style.background='white';">
              🎩 丁寧<br><span style="font-size: 10px; font-weight: 400;">ビジネス向け</span>
            </button>
            <button type="button" onclick="applyAiPreset('enthusiastic')" style="padding: 10px; background: white; border: 2px solid #f59e0b; border-radius: 6px; color: #f59e0b; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#fffbeb';" onmouseout="this.style.background='white';">
              🔥 熱量高め<br><span style="font-size: 10px; font-weight: 400;">おすすめ強調</span>
            </button>
            <button type="button" onclick="applyAiPreset('concise')" style="padding: 10px; background: white; border: 2px solid #40B4E5; border-radius: 6px; color: #40B4E5; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f5f3ff';" onmouseout="this.style.background='white';">
              📝 簡潔<br><span style="font-size: 10px; font-weight: 400;">短文</span>
            </button>
            <button type="button" onclick="applyAiPreset('detailed')" style="padding: 10px; background: white; border: 2px solid #40B4E5; border-radius: 6px; color: #40B4E5; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f5f3ff';" onmouseout="this.style.background='white';">
              📖 詳細<br><span style="font-size: 10px; font-weight: 400;">長文</span>
            </button>
          </div>
        </div>

        <!-- プロンプトテンプレート -->
        <div style="margin-bottom: 24px;">
          <label style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">
            📝 プロンプトテンプレート
          </label>
          <textarea id="aiPromptTemplate" rows="8" style="width: 100%; padding: 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 12px; font-family: monospace; resize: vertical;" placeholder="プロンプトを入力してください..."></textarea>
          <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
            💡 変数が使えます: {brand}, {item}, {category}, {size}, {condition}, {material}, {color}
          </div>
        </div>

        <!-- 生成文字数 -->
        <div style="margin-bottom: 24px;">
          <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">
            📏 生成文字数
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb';" onmouseout="this.style.background='white';">
              <input type="radio" name="aiLength" value="short" style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px; font-weight: 500;">短文（150-200字）</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb';" onmouseout="this.style.background='white';">
              <input type="radio" name="aiLength" value="medium" checked style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px; font-weight: 500;">標準（200-300字）★推奨</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb';" onmouseout="this.style.background='white';">
              <input type="radio" name="aiLength" value="long" style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px; font-weight: 500;">長文（300-500字）</span>
            </label>
          </div>
        </div>

        <!-- トーン/スタイル -->
        <div style="margin-bottom: 24px;">
          <label style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">
            🎭 トーン/スタイル
          </label>
          <select id="aiTone" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer;">
            <option value="casual">カジュアル（フレンドリー）</option>
            <option value="standard">スタンダード（丁寧で親しみやすい）★推奨</option>
            <option value="polite">丁寧（ビジネスライク）</option>
            <option value="enthusiastic">熱量高め（おすすめ感強め）</option>
          </select>
        </div>

        <!-- 見出しスタイル -->
        <div style="margin-bottom: 24px;">
          <label style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">
            📑 見出しスタイル
          </label>
          <select id="aiHeadingStyle" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer;">
            <option value="emoji">絵文字（例: ✨ 商品の特徴）</option>
            <option value="brackets">かっこ（例: 【商品の特徴】）</option>
            <option value="square">黒四角（例: ■ 商品の特徴）</option>
            <option value="none">なし（改行のみ）</option>
          </select>
          <div style="font-size: 11px; color: #6b7280; margin-top: 4px; padding: 6px 8px; background: #eff6ff; border-radius: 4px; border-left: 3px solid #3b82f6;">
            💡 説明文全体で統一された見出しスタイルが使われます
          </div>
        </div>

        <!-- 含める要素 -->
        <div style="margin-bottom: 24px;">
          <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">
            ☑️ 説明文に含める要素
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 12px; background: #f9fafb; border-radius: 6px; border: 2px solid #e5e7eb;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="aiIncludeBrand" checked style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px;">ブランド情報</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="aiIncludeCategory" checked style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px;">カテゴリ情報</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="aiIncludeSize" checked style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px;">サイズ情報</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="aiIncludeMaterial" checked style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px;">素材情報</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="aiIncludeColor" checked style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px;">カラー情報</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="aiIncludeAttributes" checked style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px;">商品属性 ★重要</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="aiIncludeCondition" checked style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px;">商品状態</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="aiIncludeCoordinate" checked style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px;">コーディネート提案</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="aiIncludeScene" checked style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px;">着用シーン</span>
            </label>
          </div>
        </div>

        <!-- 詳細設定 -->
        <div style="margin-bottom: 24px; padding: 16px; background: #fef3c7; border-radius: 8px; border: 2px solid #fde68a;">
          <div style="font-size: 14px; font-weight: 600; color: #92400e; margin-bottom: 16px;">
            🔧 詳細設定（上級者向け）
          </div>

          <!-- Temperature -->
          <div style="margin-bottom: 16px;">
            <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">
              🌡️ Temperature（創造性）: <span id="aiTempValue">0.7</span>
            </label>
            <input type="range" id="aiTemperature" min="0" max="10" value="7" step="1" oninput="updateTempDisplay()" style="width: 100%; cursor: pointer;">
            <div style="display: flex; justify-content: space-between; font-size: 10px; color: #6b7280; margin-top: 4px;">
              <span>0.0（安定）</span>
              <span>0.5</span>
              <span>1.0（創造的）</span>
            </div>
            <div style="font-size: 11px; color: #6b7280; margin-top: 8px;">
              💡 0.7前後が推奨。低いと安定、高いと創造的だが不安定
            </div>
          </div>

          <!-- Max Tokens -->
          <div>
            <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">
              📊 Max Tokens（最大出力トークン数）
            </label>
            <input type="number" id="aiMaxTokens" value="500" min="100" max="2000" step="50" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px;">
            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
              💡 通常は500で十分。長文にする場合は800〜1000に設定
            </div>
          </div>
        </div>

        <!-- プレビュー -->
        <div style="margin-bottom: 16px;">
          <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">
            👀 設定プレビュー
          </div>
          <div id="aiConfigPreview" style="padding: 16px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 12px; color: #374151; line-height: 1.8; white-space: pre-wrap; min-height: 100px;">
            プリセットを選択または設定を変更すると、ここにプレビューが表示されます
          </div>
        </div>

        <!-- 配置順序設定 -->
        <div style="margin-bottom: 24px; padding: 16px; background: #f0f9ff; border-radius: 8px; border: 2px solid #bae6fd;">
          <div style="font-size: 14px; font-weight: 600; color: #0c4a6e; margin-bottom: 16px;">
            📐 商品説明の配置順序
          </div>

          <div style="font-size: 11px; color: #6b7280; margin-bottom: 12px; padding: 8px; background: white; border-radius: 4px;">
            💡 ドラッグ&ドロップで順序を変更できます。チェックを外すと非表示になります。
          </div>

          <div id="descriptionOrderList" style="display: flex; flex-direction: column; gap: 8px;">
            <!-- 動的に生成 -->
          </div>

          <!-- 配置プレビュー -->
          <div style="margin-top: 16px;">
            <div style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">
              👁️ 配置プレビュー
            </div>
            <div id="descriptionOrderPreview" style="padding: 12px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 11px; color: #6b7280; min-height: 60px; line-height: 1.6;">
              順序がここに表示されます
            </div>
          </div>

          <!-- リセットボタン -->
          <button type="button" onclick="resetDescriptionOrder()" style="width: 100%; padding: 8px; margin-top: 12px; background: white; border: 2px solid #3b82f6; border-radius: 6px; color: #3b82f6; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#eff6ff';" onmouseout="this.style.background='white';">
            ↻ デフォルト順序に戻す
          </button>
        </div>

        <!-- すべてクリアボタン -->
        <button type="button" onclick="clearAiSettings()" style="width: 100%; padding: 10px; background: white; border: 2px solid #ef4444; border-radius: 8px; color: #ef4444; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 16px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
          🗑️ すべてクリア（デフォルトに戻す）
        </button>
          </div>
        </div>
      </div>

      <!-- システム設定 -->
      <div class="tab-pane fade show active" id="system" role="tabpanel">
        <!-- システム設定内の横タブナビゲーション -->
        <ul class="nav nav-tabs" id="systemConfigTabs" role="tablist" style="margin-bottom: 16px; overflow-x: auto; flex-wrap: nowrap; white-space: nowrap;">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="system-basic-tab" data-bs-toggle="tab" data-bs-target="#system-basic" type="button" role="tab" style="font-size: 13px; padding: 8px 12px;">⚙️ 基本設定</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="system-management-tab" data-bs-toggle="tab" data-bs-target="#system-management" type="button" role="tab" style="font-size: 13px; padding: 8px 12px;">🔢管理番号設定</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="system-shipping-tab" data-bs-toggle="tab" data-bs-target="#system-shipping" type="button" role="tab" style="font-size: 13px; padding: 8px 12px;">📦配送設定</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="system-procure-tab" data-bs-toggle="tab" data-bs-target="#system-procure" type="button" role="tab" style="font-size: 13px; padding: 8px 12px;">💼仕入・出品設定</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="system-permission-tab" data-bs-toggle="tab" data-bs-target="#system-permission" type="button" role="tab" style="font-size: 13px; padding: 8px 12px;">🔐権限設定</button>
          </li>
        </ul>

        <!-- システム設定内のタブコンテンツ -->
        <div class="tab-content" id="systemConfigTabContent">
          <!-- 基本設定タブ -->
          <div class="tab-pane fade show active" id="system-basic" role="tabpanel">
        <!-- ローディング表示 -->
        <div id="basicSettingsLoading" style="display: flex; justify-content: center; align-items: center; padding: 40px;">
          <div style="text-align: center;">
            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f4f6; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
            <div style="margin-top: 12px; color: #6b7280; font-size: 14px;">読み込み中...</div>
          </div>
        </div>

        <!-- 基本設定コンテンツ（初期非表示） -->
        <div id="basicSettingsContent" style="display: none;">

        <!-- ユーザー情報セクション -->
        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">👤 ユーザー情報</h4>

          <!-- プロフィールアイコン -->
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">プロフィールアイコン</label>
            <div style="display: flex; align-items: center; gap: 12px;">
              <div id="basicUserIconPreview" style="width: 60px; height: 60px; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #9ca3af; border: 2px solid #e5e7eb;">
                👤
              </div>
              <div style="flex: 1;">
                <input type="file" id="basicUserIconInput" accept="image/*" style="display: none;">
                <button type="button" class="btn btn-sm" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px;" onclick="document.getElementById('basicUserIconInput').click();">
                  画像を選択
                </button>
                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
                  推奨: 正方形、最大2MB
                </div>
              </div>
            </div>
          </div>

          <!-- ユーザー名 -->
          <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label">ユーザー名<span style="color: #ef4444; margin-left: 4px;">*</span></label>
            <div style="position: relative;">
              <input type="text" id="basicUserName" class="form-control" placeholder="例: 山田太郎" maxlength="50" style="padding-right: 40px;">
              <button type="button" id="clearUserNameBtn" onclick="clearUserName()" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #9ca3af; cursor: pointer; padding: 4px 8px; font-size: 16px; display: none;">✕</button>
            </div>
            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
              入出庫履歴や商品登録時に記録されます
            </div>
          </div>

          <!-- メールアドレス -->
          <div class="form-group">
            <label class="form-label">メールアドレス</label>
            <input type="email" id="basicUserEmail" class="form-control" placeholder="例: example@example.com" maxlength="100">
            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
              通知や連絡先として使用されます
            </div>
          </div>
        </div>

        <!-- 通知設定セクション -->
        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">🔔 通知設定</h4>

          <!-- プッシュ通知 -->
          <div style="margin-bottom: 12px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
              <div>
                <div style="font-weight: 500; font-size: 13px; color: #374151;">プッシュ通知</div>
                <div style="font-size: 11px; color: #6b7280; margin-top: 2px;">システム通知を受け取る</div>
              </div>
              <label class="switch" style="position: relative; display: inline-block; width: 44px; height: 24px;">
                <input type="checkbox" id="basicNotificationEnabled" style="opacity: 0; width: 0; height: 0;">
                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; transition: .4s; border-radius: 24px;"></span>
              </label>
            </div>
          </div>

          <!-- 通知音 -->
          <div style="margin-bottom: 12px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
              <div>
                <div style="font-weight: 500; font-size: 13px; color: #374151;">通知音</div>
                <div style="font-size: 11px; color: #6b7280; margin-top: 2px;">通知時に音を鳴らす</div>
              </div>
              <label class="switch" style="position: relative; display: inline-block; width: 44px; height: 24px;">
                <input type="checkbox" id="basicNotificationSound" style="opacity: 0; width: 0; height: 0;">
                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; transition: .4s; border-radius: 24px;"></span>
              </label>
            </div>
          </div>
        </div>

        <!-- 画像管理設定セクション -->
        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">📷 画像管理設定</h4>

          <!-- ヒント -->
          <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
            <div style="color: #3b82f6; font-weight: 600; margin-bottom: 4px;">
              <span>💡 概要</span>
            </div>
            <div id="image-overview-content" style="display: block; padding-left: 12px; margin-bottom: 8px;">
              商品画像の管理方法を設定します。チーム利用やAPI連携を行う場合は、商品画像をGoogle Driveに保存することで、撮影者と出品者で画像を共有したり、複数のプラットフォームに同じ画像を使い回すことができます
            </div>
          </div>

          <!-- 商品画像保存設定 -->
          <div style="background: white; padding: 16px; border-radius: 8px; border: 2px solid #e5e7eb;">
            <label style="display: flex; align-items: center; cursor: pointer; user-select: none;">
              <input
                type="checkbox"
                id="enableProductImageSave"
                onchange="toggleProductImageSave()"
                style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;"
              />
              <div style="flex: 1;">
                <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 4px;">
                  商品画像をGoogle Driveに保存する
                </div>
                <div style="font-size: 11px; color: #6b7280; line-height: 1.5;">
                  ONにすると商品登録画面に「商品画像」ブロックが表示され、<br>
                  最大20枚の画像をGoogle Driveに保存できます
                </div>
              </div>
            </label>
          </div>

          <!-- 現在の状態表示 -->
          <div id="imageSettingStatus" style="margin-top: 12px; padding: 12px; border-radius: 6px; background: #f9fafb; border-left: 3px solid #9ca3af;">
            <div style="font-size: 12px; color: #6b7280;">
              <strong>現在の設定:</strong> <span id="imageSettingStatusText">OFF（商品画像ブロックは非表示）</span>
            </div>
          </div>
        </div>
        </div><!-- /basicSettingsContent -->
          </div>

          <!-- 管理番号タブ -->
          <div class="tab-pane fade" id="system-management" role="tabpanel">
        <!-- 動的ブロックビルダー（PWA対応：直接埋め込み） -->
        <!-- 管理番号ビルダー - レゴブロック式セグメント構築システム -->
<style>
  .mnb-container {
    padding: 0;
    background: white;
    border-radius: 8px;
  }

  .mnb-title {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 16px;
    color: #212529;
  }

  /* セグメントリスト */
  .mnb-segments {
    background: white;
    border: none;
    border-radius: 8px;
    padding: 0;
    min-height: 100px;
    margin-bottom: 16px;
  }

  .mnb-segments.drag-over {
    background: #e3f2fd;
    border-color: #2196f3;
  }

  .mnb-segments-empty {
    text-align: center;
    color: #9ca3af;
    padding: 24px 16px;
    font-size: 13px;
    line-height: 1.6;
  }

  /* セグメントブロック */
  .mnb-segment {
    background: white;
    border: 1px solid #e5e7eb;
    color: #1f2937;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: move;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    transition: all 0.2s;
  }

  .mnb-segment:hover {
    border-color: #3b82f6;
    box-shadow: 0 2px 6px rgba(59,130,246,0.15);
  }

  .mnb-segment.dragging {
    opacity: 0.5;
  }

  .mnb-segment-header {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
  }

  .mnb-segment-drag-handle {
    font-size: 16px;
    color: #9ca3af;
    cursor: grab;
  }

  .mnb-segment-drag-handle:active {
    cursor: grabbing;
  }

  .mnb-segment-icon {
    font-size: 18px;
  }

  .mnb-segment-type {
    flex: 1;
    font-size: 12px;
    font-weight: 500;
    color: #6b7280;
  }

  .mnb-segment-value {
    font-size: 15px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 8px;
  }

  .mnb-segment-controls {
    display: flex;
    gap: 8px;
  }

  .mnb-segment-btn {
    flex: 1;
    background: white;
    border: 1px solid #d1d5db;
    color: #374151;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    transition: all 0.2s;
    font-weight: 500;
  }

  .mnb-segment-btn:hover {
    background: #f9fafb;
    border-color: #9ca3af;
  }

  .mnb-segment-btn.delete {
    color: #ef4444;
    border-color: #fecaca;
  }

  .mnb-segment-btn.delete:hover {
    background: #fef2f2;
    border-color: #ef4444;
  }

  /* セグメント追加ボタン */
  .mnb-add-segment {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    width: 100%;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-bottom: 16px;
  }

  .mnb-add-segment:hover {
    background: #2563eb;
  }

  /* プレビュー */
  .mnb-preview {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 12px;
  }

  .mnb-preview-label {
    font-size: 11px;
    color: #6b7280;
    margin-bottom: 8px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .mnb-preview-value {
    padding: 6px 10px;
    background: #eff6ff;
    border: 1px solid #bfdbfe;
    border-radius: 6px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    font-size: 11px;
    color: #1e40af;
    font-weight: 500;
  }

  .mnb-preview-parts {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .mnb-preview-part {
    background: #f3f4f6;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    color: #6b7280;
    font-weight: 500;
  }

  /* セグメント編集モーダル */
  .mnb-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    align-items: center;
    justify-content: center;
  }

  .mnb-modal.active {
    display: flex;
  }

  .mnb-modal-content {
    background: white;
    border-radius: 12px;
    padding: 20px;
    max-width: 600px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
  }

  .mnb-modal-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 16px;
    color: #1f2937;
  }

  .mnb-form-group {
    margin-bottom: 12px;
  }

  .mnb-form-label {
    display: block;
    font-size: 12px;
    font-weight: 500;
    color: #374151;
    margin-bottom: 4px;
  }

  .mnb-form-input,
  .mnb-form-select {
    width: 100%;
    padding: 6px 10px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 16px; /* iOS自動ズーム防止（16px以上必須） */
  }

  .mnb-form-input:focus,
  .mnb-form-select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .mnb-modal-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
  }

  .mnb-modal-btn {
    flex: 1;
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
  }

  .mnb-modal-btn-primary {
    background: #3b82f6;
    color: white;
  }

  .mnb-modal-btn-primary:hover {
    background: #2563eb;
  }

  .mnb-modal-btn-secondary {
    background: #e5e7eb;
    color: #374151;
  }

  .mnb-modal-btn-secondary:hover {
    background: #d1d5db;
  }

  /* セグメントタイプ選択 */
  .mnb-type-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-bottom: 12px;
  }

  .mnb-type-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    padding: 10px 12px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }

  .mnb-type-card:hover {
    border-color: #3b82f6;
    background: #f0f9ff;
  }

  .mnb-type-card.selected {
    border-color: #3b82f6;
    background: #dbeafe;
  }

  .mnb-type-card-icon {
    font-size: 30px;
    margin-bottom: 4px;
  }

  .mnb-type-card-name {
    font-size: 13px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 3px;
  }

  .mnb-type-card-desc {
    font-size: 11px;
    color: #6b7280;
    line-height: 1.3;
  }
</style>

<!-- 管理番号ビルダーUI -->
<div class="mnb-container">
  <!-- ヒント -->
  <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
    <div style="color: #3b82f6; font-weight: 600; margin-bottom: 4px;">
      <span>💡 概要</span>
    </div>
    <div id="mnb-overview-content" style="display: block; padding-left: 12px; margin-bottom: 8px;">
      商品登録時に自動で管理番号（例: AA-1001）が生成されます。プリセットから基本パターンを選択したり、セグメント（カテゴリ、日付、ランク、サイズ、カラー、連番、カスタム値）を自由に組み合わせて、独自の管理番号フォーマットを作成できます
    </div>
  </div>

  <!-- プリセット選択 -->
  <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
    <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px; display: block;">
      📋 プリセットから選択
    </label>
    <select id="mnbPresetSelect" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: #f9fafb; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='white';" onblur="this.style.borderColor='#d1d5db'; this.style.background='#f9fafb';">
      <option value="" style="padding: 8px;">-- カスタム設定 --</option>
      <option value="simple" style="padding: 8px;">🔢 シンプル連番　(例: 1001, 1002, 1003...)</option>
      <option value="shelf" style="padding: 8px;">📦 棚番号 + 連番　(例: AA-1001, BB-1001...)</option>
      <option value="category_date" style="padding: 8px;">📅 カテゴリ + 日付 + 連番　(例: K-251007-001...)</option>
      <option value="shelf_date" style="padding: 8px;">🗓️ 棚番号 + 日付 + 連番　(例: AA-251007-001...)</option>
      <option value="category_rank" style="padding: 8px;">⭐ カテゴリ + ランク + 連番　(例: K-A-001...)</option>
    </select>
  </div>

  <!-- セグメントリスト -->
  <div id="mnbSegmentsList" class="mnb-segments">
    <div class="mnb-segments-empty">
      セグメントを追加してください<br><small style="font-size: 12px;">ドラッグして並び替えできます</small>
    </div>
  </div>

  <!-- セグメント追加ボタン -->
  <button type="button" class="mnb-add-segment" onclick="openAddSegmentModal()">
    <span>➕</span>
    <span>セグメントを追加</span>
  </button>

  <!-- リセットボタン -->
  <button type="button" onclick="clearManagementNumberSettings()" style="width: 100%; padding: 10px; background: white; border: 2px solid #ef4444; border-radius: 8px; color: #ef4444; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 16px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
    🗑️ すべてクリア
  </button>

  <!-- 管理番号の配置設定 -->
  <div style="margin-top: 24px; padding: 16px; background: white; border: 1px solid #e5e7eb; border-radius: 8px;">
    <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">
      📌 管理番号の配置
    </div>
    <div style="font-size: 12px; color: #6b7280; margin-bottom: 12px; line-height: 1.5;">
      生成された管理番号をどこに表示するか設定できます
    </div>

    <!-- 配置チェックボックス -->
    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px;">
      <div style="display: flex; align-items: center; gap: 6px;">
        <input type="checkbox" id="商品名に管理番号配置" style="width: 16px; height: 16px; cursor: pointer;" onchange="toggleManagementNumberFormat(); if (typeof onManagementNumberSettingChange === 'function') onManagementNumberSettingChange();">
        <label for="商品名に管理番号配置" style="font-size: 13px; cursor: pointer; margin: 0;">商品名に表示</label>
      </div>
      <div style="display: flex; align-items: center; gap: 6px;">
        <input type="checkbox" id="説明文に管理番号配置" style="width: 16px; height: 16px; cursor: pointer;" onchange="toggleManagementNumberDescriptionFormat(); if (typeof onManagementNumberSettingChange === 'function') onManagementNumberSettingChange();">
        <label for="説明文に管理番号配置" style="font-size: 13px; cursor: pointer; margin: 0;">説明文に表示</label>
      </div>
    </div>

    <!-- 形式選択（商品名用） -->
    <div id="管理番号形式選択" style="display: none;">
      <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">商品名での表示形式</label>
      <select id="管理番号形式" style="width: 100%; font-size: 16px; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; background: white; margin-bottom: 8px;" onchange="updateManagementNumberPreview(); if (typeof onManagementNumberSettingChange === 'function') onManagementNumberSettingChange();">
        <option value="【】">【AA-1001】</option>
        <option value="（）">（AA-1001）</option>
        <option value="『』">『AA-1001』</option>
        <option value="「」">「AA-1001」</option>
        <option value="｜｜">｜AA-1001｜</option>
        <option value="｜">｜AA-1001</option>
        <option value="-">- AA-1001</option>
        <option value="none">AA-1001</option>
      </select>

      <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">配置位置</label>
      <select id="管理番号配置位置" style="width: 100%; font-size: 16px; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; background: white;" onchange="updateManagementNumberPreview(); if (typeof onManagementNumberSettingChange === 'function') onManagementNumberSettingChange();">
        <option value="end">後ろ（NIKE【AA-1001】）</option>
        <option value="start">先頭（【AA-1001】NIKE）</option>
      </select>
    </div>

    <!-- 形式選択（説明文用） -->
    <div id="説明文管理番号形式選択" style="display: none; margin-top: 12px;">
      <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">説明文での表示形式</label>
      <select id="説明文管理番号形式" style="width: 100%; font-size: 16px; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; background: white; margin-bottom: 8px;" onchange="updateManagementNumberPreview(); if (typeof onManagementNumberSettingChange === 'function') onManagementNumberSettingChange();">
        <option value="【】">管理番号：【AA-1001】</option>
        <option value="（）">管理番号：（AA-1001）</option>
        <option value="『』">管理番号：『AA-1001』</option>
        <option value="「」">管理番号：「AA-1001」</option>
        <option value="｜｜">管理番号：｜AA-1001｜</option>
        <option value="｜">管理番号：｜AA-1001</option>
        <option value="-">管理番号：- AA-1001</option>
        <option value="none">管理番号：AA-1001</option>
      </select>

      <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">配置位置</label>
      <select id="説明文管理番号配置位置" style="width: 100%; font-size: 16px; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; background: white;" onchange="updateManagementNumberPreview(); if (typeof onManagementNumberSettingChange === 'function') onManagementNumberSettingChange();">
        <option value="top">先頭（ブランド名の上）</option>
        <option value="middle">中（商品情報の下）</option>
        <option value="bottom">末尾（ハッシュタグの下）</option>
      </select>
    </div>

    <!-- プレビューコンテナ（タブ切り替え式） -->
    <div id="プレビューコンテナ" style="margin-top: 16px; display: none;">
      <!-- タブボタン -->
      <div style="display: flex; gap: 8px; margin-bottom: 12px;">
        <button id="タブ_商品名" onclick="switchPreviewTab('商品名')" style="flex: 1; padding: 10px; border: 2px solid #40B4E5; background: #40B4E5; color: white; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
          📝 商品名プレビュー
        </button>
        <button id="タブ_説明文" onclick="switchPreviewTab('説明文')" style="flex: 1; padding: 10px; border: 2px solid #d1d5db; background: white; color: #6b7280; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
          📄 説明文プレビュー
        </button>
      </div>

      <!-- 商品名プレビュー -->
      <div id="商品名プレビュー_セクション" style="padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; display: block;">
        <div id="商品名プレビュー_管理番号" style="font-size: 14px; color: #111827; line-height: 1.6; min-height: 24px; word-break: break-all;">
          NIKE エアマックス
        </div>
        <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">
          ※ 実際の商品名でのイメージです
        </div>
      </div>

      <!-- 説明文プレビュー -->
      <div id="説明文プレビュー_セクション" style="padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; display: none;">
        <div id="説明文プレビュー_管理番号" style="font-size: 13px; color: #111827; line-height: 1.8; min-height: 60px; word-break: break-all; white-space: pre-line;">
【商品情報】
ブランド：NIKE
アイテム：エアマックス
カラー：ブラック
サイズ：27.0cm

🔢 管理番号：AA-1001
        </div>
        <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">
          ※ 説明文での管理番号表示イメージです
        </div>
      </div>
    </div>
  </div>
</div>

<!-- セグメント追加/編集モーダル -->
<div id="mnbModal" class="mnb-modal">
  <div class="mnb-modal-content">
    <div class="mnb-modal-title" id="mnbModalTitle">セグメントを追加</div>

    <!-- セグメントタイプ選択 -->
    <div class="mnb-form-group" id="mnbTypeGridContainer">
      <label class="mnb-form-label">セグメントタイプ</label>
      <div class="mnb-type-grid" id="mnbTypeGrid">
        <!-- 動的に生成 -->
      </div>
    </div>

    <!-- セグメント設定（タイプによって変わる） -->
    <div id="mnbSegmentConfig">
      <!-- 動的に生成 -->
    </div>

    <!-- 区切り文字 -->
    <div class="mnb-form-group">
      <label class="mnb-form-label">区切り文字（このセグメントの後）</label>
      <select class="mnb-form-select" id="mnbSeparator">
        <option value="-">- (ハイフン)</option>
        <option value="_">_ (アンダースコア)</option>
        <option value="">（なし）</option>
        <option value=".">. (ドット)</option>
        <option value=" ">　(スペース)</option>
      </select>
    </div>

    <!-- アクション -->
    <div class="mnb-modal-actions">
      <button type="button" class="mnb-modal-btn mnb-modal-btn-secondary" onclick="closeSegmentModal()">キャンセル</button>
      <button type="button" class="mnb-modal-btn mnb-modal-btn-primary" onclick="saveSegment()">保存</button>
    </div>
  </div>
</div>

<script>
  // 管理番号ビルダーシステム (PWA対応 @916)
  const ManagementNumberBuilder = {
    segments: [],
    currentEditingIndex: null,
    selectedType: null,

    // セグメントタイプ定義
    segmentTypes: {
      shelf: {
        icon: '🏷️',
        name: '棚番号',
        desc: 'AA, BB などの棚番号',
        fields: [
          {
            id: 'format',
            label: '棚番号形式',
            type: 'select',
            options: [
              { value: 'AA', label: 'アルファベット2文字 (AA)' },
              { value: 'A', label: 'アルファベット1文字 (A)' },
              { value: '01', label: '数字2桁 (01)' },
              { value: '001', label: '数字3桁 (001)' },
              { value: 'custom', label: '✏️ カスタム入力' }
            ]
          },
          { id: 'code', label: '棚番号', type: 'text', placeholder: 'AA', conditional: { field: 'format', value: 'custom' } }
        ],
        preview: (config) => {
          if (config.format === 'custom') {
            return config.code || 'AA';
          }
          return config.format || 'AA';
        }
      },
      sequence: {
        icon: '🔢',
        name: '連番',
        desc: '001, 0001 などの連番',
        fields: [
          {
            id: 'digits',
            label: '桁数',
            type: 'select',
            options: [
              { value: '2', label: '2桁 (01)' },
              { value: '3', label: '3桁 (001)' },
              { value: '4', label: '4桁 (0001)' },
              { value: '5', label: '5桁 (00001)' },
              { value: '6', label: '6桁 (000001)' }
            ]
          },
          { id: 'start', label: '開始番号', type: 'number', placeholder: '1' }
        ],
        preview: (config) => {
          const num = config.start || 1;
          const digits = parseInt(config.digits) || 3;
          return String(num).padStart(digits, '0');
        }
      },
      category: {
        icon: '📁',
        name: 'カテゴリコード',
        desc: '商品カテゴリ (K, O など)',
        fields: [
          { id: 'code', label: 'コード', type: 'text', placeholder: 'K' }
        ],
        preview: (config) => config.code || 'K'
      },
      date: {
        icon: '📅',
        name: '登録日',
        desc: '日付形式を選択',
        fields: [
          {
            id: 'format',
            label: '形式',
            type: 'select',
            options: [
              { value: 'YYMMDD', label: 'YYMMDD (241007)' },
              { value: 'YYYYMMDD', label: 'YYYYMMDD (20241007)' },
              { value: 'YYMD', label: 'YYMD (24107)' },
              { value: 'YYMM', label: 'YYMM (2410)' }
            ]
          }
        ],
        preview: (config) => {
          const now = new Date();
          const y = now.getFullYear();
          const m = String(now.getMonth() + 1).padStart(2, '0');
          const d = String(now.getDate()).padStart(2, '0');

          switch(config.format) {
            case 'YYYYMMDD': return `${y}${m}${d}`;
            case 'YYMD': return `${String(y).slice(2)}${parseInt(m)}${parseInt(d)}`;
            case 'YYMM': return `${String(y).slice(2)}${m}`;
            default: return `${String(y).slice(2)}${m}${d}`;
          }
        }
      },
      rank: {
        icon: '⭐',
        name: '品質ランク',
        desc: 'A, B, C などのランク',
        fields: [
          { id: 'value', label: 'ランク値', type: 'text', placeholder: 'A' }
        ],
        preview: (config) => config.value || 'A'
      },
      size: {
        icon: '📏',
        name: 'サイズコード',
        desc: 'S, M, L などのサイズ',
        fields: [
          { id: 'code', label: 'サイズコード', type: 'text', placeholder: 'M' }
        ],
        preview: (config) => config.code || 'M'
      },
      color: {
        icon: '🎨',
        name: '色コード',
        desc: 'DB, R などの色コード',
        fields: [
          { id: 'code', label: '色コード', type: 'text', placeholder: 'DB' }
        ],
        preview: (config) => config.code || 'DB'
      },
      custom: {
        icon: '✏️',
        name: 'カスタム固定値',
        desc: '任意の固定文字列',
        fields: [
          { id: 'value', label: '固定値', type: 'text', placeholder: 'XXX' }
        ],
        preview: (config) => config.value || 'XXX'
      }
    },

    // プリセット定義
    presets: {
      simple: [
        { type: 'sequence', config: { digits: '4', start: '1001' }, separator: '' }
      ],
      shelf: [
        { type: 'shelf', config: { format: 'AA' }, separator: '-' },
        { type: 'sequence', config: { digits: '4', start: '1001' }, separator: '' }
      ],
      category_date: [
        { type: 'category', config: { code: 'K' }, separator: '-' },
        { type: 'date', config: { format: 'YYMMDD' }, separator: '-' },
        { type: 'sequence', config: { digits: '3', start: '1' }, separator: '' }
      ],
      shelf_date: [
        { type: 'shelf', config: { format: 'AA' }, separator: '-' },
        { type: 'date', config: { format: 'YYMMDD' }, separator: '-' },
        { type: 'sequence', config: { digits: '3', start: '1' }, separator: '' }
      ],
      category_rank: [
        { type: 'category', config: { code: 'K' }, separator: '-' },
        { type: 'rank', config: { value: 'A' }, separator: '-' },
        { type: 'sequence', config: { digits: '3', start: '1' }, separator: '' }
      ]
    },

    // 初期化
    init() {
      this.renderTypeGrid();
      this.updatePreview();
      this.setupDragAndDrop();
      // loadSettings()はFirebase初期化後に外部から呼ばれる
      this.setupPresetSelector();
    },

    // プリセットセレクター設定
    setupPresetSelector() {
      const selector = document.getElementById('mnbPresetSelect');
      if (!selector) return;

      selector.addEventListener('change', (e) => {
        const presetKey = e.target.value;
        if (!presetKey) return;

        const preset = this.presets[presetKey];
        if (!preset) return;

        // 既存のセグメントをクリアして、プリセットを適用
        if (confirm('現在の設定を削除してプリセットを適用しますか？')) {
          this.segments = JSON.parse(JSON.stringify(preset)); // ディープコピー
          this.renderSegments();
          this.updatePreview();
        } else {
          // キャンセルされた場合は選択を戻す
          selector.value = '';
        }
      });
    },

    // 設定をFirestoreから読み込み（高速化・compat版）
    // 設定をGASサーバー経由でFirestoreから読み込み（CORS回避）
    loadSettings() {
      if (!window.db) {
        console.warn('⚠️ Firestoreが初期化されていません');
        return;
      }

    
      window.db.collection('settings').doc('common').get()
        .then((docSnap) => {
          if (docSnap.exists) {
            const data = docSnap.data();
            if (data.managementNumber && data.managementNumber.segments) {
              this.segments = data.managementNumber.segments;
              this.renderSegments();
              this.updatePreview();
              console.log('✅ Firestoreから管理番号設定を読み込み:', this.segments.length, 'セグメント');

              // 配置設定もチェックボックスに反映
              const showInTitle = document.getElementById('商品名に管理番号配置');
              const showInDescription = document.getElementById('説明文に管理番号配置');
              const formatSelect = document.getElementById('管理番号形式');
              const positionSelect = document.getElementById('管理番号配置位置');
              const descFormatSelect = document.getElementById('説明文管理番号形式');
              const descPositionSelect = document.getElementById('説明文管理番号配置位置');

              if (showInTitle && data.managementNumber.showInTitle !== undefined) {
                showInTitle.checked = data.managementNumber.showInTitle;
                console.log('✅ 商品名チェックボックスを設定:', data.managementNumber.showInTitle);
              }
              if (showInDescription && data.managementNumber.showInDescription !== undefined) {
                showInDescription.checked = data.managementNumber.showInDescription;
                console.log('✅ 説明文チェックボックスを設定:', data.managementNumber.showInDescription);
              }
              if (formatSelect && data.managementNumber.titleFormat) {
                formatSelect.value = data.managementNumber.titleFormat;
              }
              if (positionSelect && data.managementNumber.titlePosition) {
                positionSelect.value = data.managementNumber.titlePosition;
              }
              if (descFormatSelect && data.managementNumber.descFormat) {
                descFormatSelect.value = data.managementNumber.descFormat;
              }
              if (descPositionSelect && data.managementNumber.descPosition) {
                descPositionSelect.value = data.managementNumber.descPosition;
              }

              // 形式選択の表示/非表示を更新
              if (typeof toggleManagementNumberFormat === 'function') {
                toggleManagementNumberFormat();
              }
              if (typeof toggleManagementNumberDescriptionFormat === 'function') {
                toggleManagementNumberDescriptionFormat();
              }
            }
          } else {
            console.log('📝 Firestoreに設定が見つかりません（初回起動）');
          }
        })
        .catch((e) => {
          console.error('❌ Firestore読み込みエラー:', e);
        });
    },

    // セグメントタイプグリッドを描画
    renderTypeGrid() {
      const grid = document.getElementById('mnbTypeGrid');
      grid.innerHTML = '';

      Object.keys(this.segmentTypes).forEach(typeKey => {
        const type = this.segmentTypes[typeKey];
        const card = document.createElement('div');
        card.className = 'mnb-type-card';
        card.onclick = () => this.selectType(typeKey);
        card.innerHTML = `
          <div class="mnb-type-card-icon">${type.icon}</div>
          <div class="mnb-type-card-name">${type.name}</div>
          <div class="mnb-type-card-desc">${type.desc}</div>
        `;
        grid.appendChild(card);
      });
    },

    // セグメントタイプ選択
    selectType(typeKey) {
      this.selectedType = typeKey;

      // カードの選択状態を更新
      document.querySelectorAll('.mnb-type-card').forEach((card, i) => {
        card.classList.remove('selected');
      });
      const typeKeys = Object.keys(this.segmentTypes);
      const index = typeKeys.indexOf(typeKey);
      document.querySelectorAll('.mnb-type-card')[index].classList.add('selected');

      // 設定フィールドを表示
      this.renderConfigFields(typeKey);
    },

    // 設定フィールドを描画
    renderConfigFields(typeKey) {
      const type = this.segmentTypes[typeKey];
      const container = document.getElementById('mnbSegmentConfig');
      container.innerHTML = '';

      type.fields.forEach(field => {
        const group = document.createElement('div');
        group.className = 'mnb-form-group';

        // 条件付きフィールドの場合はデフォルトで非表示
        if (field.conditional) {
          group.style.display = 'none';
          group.setAttribute('data-conditional-field', field.conditional.field);
          group.setAttribute('data-conditional-value', field.conditional.value);
        }

        const label = document.createElement('label');
        label.className = 'mnb-form-label';
        label.textContent = field.label;
        group.appendChild(label);

        if (field.type === 'select') {
          const select = document.createElement('select');
          select.className = 'mnb-form-select';
          select.id = `mnbField_${field.id}`;

          field.options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.value;
            option.textContent = opt.label;
            select.appendChild(option);
          });

          // セレクト変更時に条件付きフィールドの表示/非表示を切り替え
          select.addEventListener('change', () => {
            this.updateConditionalFields(field.id, select.value);
          });

          group.appendChild(select);
        } else {
          const input = document.createElement('input');
          input.className = 'mnb-form-input';
          input.type = field.type;
          input.id = `mnbField_${field.id}`;
          input.placeholder = field.placeholder || '';

          // 連番の開始番号の場合、桁数制限を動的に設定
          if (typeKey === 'sequence' && field.id === 'start') {
            // 初期桁数制限（デフォルト3桁）
            input.setAttribute('maxlength', '3');

            // 桁数セレクトが変更されたら、開始番号のmaxlengthを更新
            const setupDigitsListener = () => {
              const digitsSelect = document.getElementById('mnbField_digits');
              if (digitsSelect) {
                digitsSelect.addEventListener('change', (e) => {
                  const selectedDigits = e.target.value;
                  input.setAttribute('maxlength', selectedDigits);

                  // 現在の値が桁数を超えている場合は切り詰める
                  if (input.value.length > parseInt(selectedDigits)) {
                    input.value = input.value.slice(0, parseInt(selectedDigits));
                  }
                });

                // 初回読み込み時にも桁数を反映
                const currentDigits = digitsSelect.value || '3';
                input.setAttribute('maxlength', currentDigits);
              }
            };

            // DOMが構築された後にリスナーを設定
            setTimeout(setupDigitsListener, 0);
          }

          group.appendChild(input);
        }

        container.appendChild(group);
      });
    },

    // 条件付きフィールドの表示/非表示を更新
    updateConditionalFields(fieldId, value) {
      const container = document.getElementById('mnbSegmentConfig');
      const conditionalFields = container.querySelectorAll(`[data-conditional-field="${fieldId}"]`);

      conditionalFields.forEach(field => {
        const conditionalValue = field.getAttribute('data-conditional-value');
        if (value === conditionalValue) {
          field.style.display = 'block';
        } else {
          field.style.display = 'none';
        }
      });
    },

    // セグメントを追加
    addSegment(segment) {
      this.segments.push(segment);
      this.renderSegments();
      this.updatePreview();
    },

    // セグメントを更新
    updateSegment(index, segment) {
      this.segments[index] = segment;
      this.renderSegments();
      this.updatePreview();
    },

    // セグメントを削除
    removeSegment(index) {
      this.segments.splice(index, 1);
      this.renderSegments();
      this.updatePreview();
    },

    // セグメントを移動
    moveSegment(fromIndex, toIndex) {
      const segment = this.segments.splice(fromIndex, 1)[0];
      this.segments.splice(toIndex, 0, segment);
      this.renderSegments();
      this.updatePreview();
    },

    // セグメントリストを描画
    renderSegments() {
      const container = document.getElementById('mnbSegmentsList');

      if (this.segments.length === 0) {
        container.innerHTML = `
          <div class="mnb-segments-empty">
            セグメントを追加してください<br>
            <small>ドラッグして並び替えできます</small>
          </div>
        `;
        return;
      }

      container.innerHTML = '';

      this.segments.forEach((segment, index) => {
        const type = this.segmentTypes[segment.type];
        const block = document.createElement('div');
        block.className = 'mnb-segment';
        block.draggable = true;
        block.setAttribute('data-index', index);

        const preview = type.preview(segment.config);

        block.innerHTML = `
          <div class="mnb-segment-header">
            <div class="mnb-segment-drag-handle">⋮⋮</div>
            <div class="mnb-segment-icon">${type.icon}</div>
            <div class="mnb-segment-type">${type.name}</div>
          </div>
          <div class="mnb-segment-value">${preview}</div>
          <div class="mnb-segment-controls">
            <button class="mnb-segment-btn" onclick="event.stopPropagation(); ManagementNumberBuilder.editSegment(${index})">編集</button>
            <button class="mnb-segment-btn delete" onclick="event.stopPropagation(); ManagementNumberBuilder.removeSegment(${index})">削除</button>
          </div>
        `;

        container.appendChild(block);
      });
    },

    // 管理番号を生成（プレビュー用）
    generatePreview() {
      if (this.segments.length === 0) {
        return '';
      }

      let preview = '';
      this.segments.forEach((segment, index) => {
        const type = this.segmentTypes[segment.type];
        const value = type.preview(segment.config);

        preview += value;
        if (index < this.segments.length - 1 && segment.separator) {
          preview += segment.separator;
        }
      });

      return preview;
    },

    // プレビューを更新
    updatePreview() {
      // 商品名プレビューを更新
      if (typeof updateManagementNumberPreview === 'function') {
        updateManagementNumberPreview();
      }
    },

    // セグメントを編集
    editSegment(index) {
      this.currentEditingIndex = index;
      const segment = this.segments[index];
      const type = this.segmentTypes[segment.type];

      // タイトルにアイコン+セグメント名を表示
      document.getElementById('mnbModalTitle').textContent = `${type.icon} ${type.name}を編集`;

      // セグメントタイプグリッドを非表示（編集時は不要）
      document.getElementById('mnbTypeGridContainer').style.display = 'none';

      this.selectType(segment.type);

      // 設定値を復元
      type.fields.forEach(field => {
        const elem = document.getElementById(`mnbField_${field.id}`);
        if (elem) {
          elem.value = segment.config[field.id] || '';

          // セレクトフィールドの場合、条件付きフィールドも表示更新
          if (field.type === 'select') {
            this.updateConditionalFields(field.id, elem.value);
          }
        }
      });

      document.getElementById('mnbSeparator').value = segment.separator || '-';
      document.getElementById('mnbModal').classList.add('active');
    },

    // ドラッグ&ドロップ設定（Sortable.js使用）
    // タッチデバイス（スマホ）でも動作するようになりました
    setupDragAndDrop() {
      const container = document.getElementById('mnbSegmentsList');

      // Sortable.jsを使用してドラッグ&ドロップを初期化
      // タッチイベントに自動対応
      Sortable.create(container, {
        animation: 150,                    // アニメーション速度（ミリ秒）
        handle: '.mnb-drag-handle',        // ⋮⋮ アイコンのみでドラッグ
        ghostClass: 'sortable-ghost',      // ドラッグ中の要素に適用されるクラス
        chosenClass: 'sortable-chosen',    // 選択中の要素に適用されるクラス
        dragClass: 'sortable-drag',        // ドラッグ中の要素に適用されるクラス
        onEnd: (evt) => {
          // ドロップ後に並び順を更新
          const oldIndex = evt.oldIndex;
          const newIndex = evt.newIndex;

          if (oldIndex !== newIndex) {
            this.moveSegment(oldIndex, newIndex);
          }
        }
      });
    },

    // データを取得
    getData() {
      return {
        segments: this.segments
      };
    },

    // データをセット
    setData(data) {
      this.segments = data.segments || [];
      this.renderSegments();
      this.updatePreview();
    }
  };

  // グローバル関数
  function openAddSegmentModal() {
    ManagementNumberBuilder.currentEditingIndex = null;
    ManagementNumberBuilder.selectedType = null;
    document.getElementById('mnbModalTitle').textContent = 'セグメントを追加';
    document.getElementById('mnbSegmentConfig').innerHTML = '';
    document.getElementById('mnbSeparator').value = '-';

    // セグメントタイプグリッドを表示（新規追加時）
    document.getElementById('mnbTypeGridContainer').style.display = 'block';

    // カードの選択状態をクリア
    document.querySelectorAll('.mnb-type-card').forEach(card => {
      card.classList.remove('selected');
    });

    document.getElementById('mnbModal').classList.add('active');
  }

  function closeSegmentModal() {
    document.getElementById('mnbModal').classList.remove('active');
  }

  function saveSegment() {
    if (!ManagementNumberBuilder.selectedType) {
      alert('セグメントタイプを選択してください');
      return;
    }

    const type = ManagementNumberBuilder.segmentTypes[ManagementNumberBuilder.selectedType];
    const config = {};

    // 設定値を収集
    type.fields.forEach(field => {
      const elem = document.getElementById(`mnbField_${field.id}`);
      if (elem) {
        config[field.id] = elem.value;
      }
    });

    const segment = {
      type: ManagementNumberBuilder.selectedType,
      config: config,
      separator: document.getElementById('mnbSeparator').value
    };

    if (ManagementNumberBuilder.currentEditingIndex !== null) {
      ManagementNumberBuilder.updateSegment(ManagementNumberBuilder.currentEditingIndex, segment);
    } else {
      ManagementNumberBuilder.addSegment(segment);
    }

    closeSegmentModal();
  }

  /**
   * 管理番号形式選択の表示/非表示を切り替え
   */
  function toggleManagementNumberFormat() {
    const checkbox = document.getElementById('商品名に管理番号配置');
    const formatSection = document.getElementById('管理番号形式選択');

    if (checkbox && formatSection) {
      formatSection.style.display = checkbox.checked ? 'block' : 'none';
      // プレビューを更新
      updateManagementNumberPreview();
    }
  }

  /**
   * 説明文管理番号形式選択の表示/非表示を切り替え
   */
  function toggleManagementNumberDescriptionFormat() {
    const checkbox = document.getElementById('説明文に管理番号配置');
    const formatSection = document.getElementById('説明文管理番号形式選択');

    if (checkbox && formatSection) {
      formatSection.style.display = checkbox.checked ? 'block' : 'none';
      // プレビューを更新
      updateManagementNumberPreview();
    }
  }

  /**
   * プレビュータブを切り替え
   */
  function switchPreviewTab(tabName) {
    const titleTab = document.getElementById('タブ_商品名');
    const descTab = document.getElementById('タブ_説明文');
    const titleSection = document.getElementById('商品名プレビュー_セクション');
    const descSection = document.getElementById('説明文プレビュー_セクション');

    if (tabName === '商品名') {
      // 商品名タブをアクティブに
      titleTab.style.background = '#40B4E5';
      titleTab.style.color = 'white';
      titleTab.style.borderColor = '#40B4E5';

      descTab.style.background = 'white';
      descTab.style.color = '#6b7280';
      descTab.style.borderColor = '#d1d5db';

      titleSection.style.display = 'block';
      descSection.style.display = 'none';
    } else if (tabName === '説明文') {
      // 説明文タブをアクティブに
      descTab.style.background = '#40B4E5';
      descTab.style.color = 'white';
      descTab.style.borderColor = '#40B4E5';

      titleTab.style.background = 'white';
      titleTab.style.color = '#6b7280';
      titleTab.style.borderColor = '#d1d5db';

      titleSection.style.display = 'none';
      descSection.style.display = 'block';
    }
  }

  /**
   * 管理番号プレビューを更新（商品名での表示イメージ）
   */
  function updateManagementNumberPreview() {
    console.log('📝 updateManagementNumberPreview 呼び出し');

    const titleCheckbox = document.getElementById('商品名に管理番号配置');
    const descCheckbox = document.getElementById('説明文に管理番号配置');
    const formatSelect = document.getElementById('管理番号形式');
    const positionSelect = document.getElementById('管理番号配置位置');
    const titlePreviewElement = document.getElementById('商品名プレビュー_管理番号');
    const descPreviewElement = document.getElementById('説明文プレビュー_管理番号');
    const previewContainer = document.getElementById('プレビューコンテナ');
    const titleTab = document.getElementById('タブ_商品名');
    const descTab = document.getElementById('タブ_説明文');

    console.log('要素確認:', {
      titleCheckbox: titleCheckbox ? 'OK' : 'NG',
      descCheckbox: descCheckbox ? 'OK' : 'NG',
      formatSelect: formatSelect ? 'OK' : 'NG',
      positionSelect: positionSelect ? 'OK' : 'NG',
      titlePreviewElement: titlePreviewElement ? 'OK' : 'NG',
      descPreviewElement: descPreviewElement ? 'OK' : 'NG'
    });

    if (!titlePreviewElement || !descPreviewElement) {
      console.warn('⚠️ プレビュー要素が見つかりません');
      return;
    }

    // サンプルテキスト
    const sampleText = 'NIKE エアマックス';

    console.log('チェックボックス状態:', {
      title: titleCheckbox ? titleCheckbox.checked : 'null',
      desc: descCheckbox ? descCheckbox.checked : 'null'
    });

    const titleChecked = titleCheckbox && titleCheckbox.checked;
    const descChecked = descCheckbox && descCheckbox.checked;

    // プレビューコンテナの表示/非表示を制御
    if (previewContainer) {
      if (!titleChecked && !descChecked) {
        // 両方OFFの場合は全体を非表示
        previewContainer.style.display = 'none';
        console.log('✅ 両方OFF - プレビュー非表示');
        if (typeof saveManagementNumberPlacementSettings === 'function') {
          saveManagementNumberPlacementSettings();
        }
        return;
      } else {
        // どちらかONの場合は表示
        previewContainer.style.display = 'block';
      }
    }

    // タブの表示/非表示を制御
    if (titleTab && descTab) {
      if (titleChecked && descChecked) {
        // 両方ONの場合はタブを表示
        titleTab.style.display = 'block';
        descTab.style.display = 'block';
        // デフォルトで商品名タブをアクティブに
        switchPreviewTab('商品名');
      } else if (titleChecked) {
        // 商品名のみONの場合はタブを非表示、商品名プレビューのみ表示
        titleTab.style.display = 'none';
        descTab.style.display = 'none';
        document.getElementById('商品名プレビュー_セクション').style.display = 'block';
        document.getElementById('説明文プレビュー_セクション').style.display = 'none';
      } else if (descChecked) {
        // 説明文のみONの場合はタブを非表示、説明文プレビューのみ表示
        titleTab.style.display = 'none';
        descTab.style.display = 'none';
        document.getElementById('商品名プレビュー_セクション').style.display = 'none';
        document.getElementById('説明文プレビュー_セクション').style.display = 'block';
      }
    }

    // セグメント設定から管理番号を生成
    const generatedNumber = ManagementNumberBuilder.generatePreview();
    const sampleNumber = generatedNumber || 'AA-1001';

    console.log('生成された管理番号:', sampleNumber);

    // 形式と配置位置を取得
    const format = formatSelect ? formatSelect.value : '【】';
    const position = positionSelect ? positionSelect.value : 'end';

    console.log('選択値:', { format, position });

    // 管理番号をフォーマット
    let formattedNumber = '';
    switch (format) {
      case '【】':
        formattedNumber = `【${sampleNumber}】`;
        break;
      case '（）':
        formattedNumber = `（${sampleNumber}）`;
        break;
      case '『』':
        formattedNumber = `『${sampleNumber}』`;
        break;
      case '「」':
        formattedNumber = `「${sampleNumber}」`;
        break;
      case '｜｜':
        formattedNumber = `｜${sampleNumber}｜`;
        break;
      case '｜':
        formattedNumber = `｜${sampleNumber}`;
        break;
      case '-':
        formattedNumber = `- ${sampleNumber}`;
        break;
      case 'none':
        formattedNumber = sampleNumber;
        break;
      default:
        formattedNumber = `【${sampleNumber}】`;
    }

    // 両端閉じている場合はスペースなし、それ以外はスペースあり
    const pairs = [
      { start: '【', end: '】' },
      { start: '『', end: '』' },
      { start: '「', end: '」' },
      { start: '（', end: '）' },
      { start: '｜', end: '｜' }
    ];
    const needsSpace = !pairs.some(pair =>
      formattedNumber.startsWith(pair.start) && formattedNumber.endsWith(pair.end)
    );

    // 配置位置に応じて結合
    let result;
    if (position === 'start') {
      result = needsSpace ? `${formattedNumber} ${sampleText}` : `${formattedNumber}${sampleText}`;
    } else {
      result = needsSpace ? `${sampleText} ${formattedNumber}` : `${sampleText}${formattedNumber}`;
    }

    console.log('✅ プレビュー更新:', result);

    // 商品名プレビューを更新
    if (titleCheckbox && titleCheckbox.checked) {
      titlePreviewElement.textContent = result;
    }

    // 説明文プレビューを更新
    if (descCheckbox && descCheckbox.checked) {
      const descFormatSelect = document.getElementById('説明文管理番号形式');
      const descPositionSelect = document.getElementById('説明文管理番号配置位置');

      const descFormat = descFormatSelect ? descFormatSelect.value : '【】';
      const descPosition = descPositionSelect ? descPositionSelect.value : 'bottom';

      // 説明文用の管理番号をフォーマット（絵文字なし）
      let descFormattedNumber = '';
      switch (descFormat) {
        case '【】':
          descFormattedNumber = `管理番号：【${sampleNumber}】`;
          break;
        case '（）':
          descFormattedNumber = `管理番号：（${sampleNumber}）`;
          break;
        case '『』':
          descFormattedNumber = `管理番号：『${sampleNumber}』`;
          break;
        case '「」':
          descFormattedNumber = `管理番号：「${sampleNumber}」`;
          break;
        case '｜｜':
          descFormattedNumber = `管理番号：｜${sampleNumber}｜`;
          break;
        case '｜':
          descFormattedNumber = `管理番号：｜${sampleNumber}`;
          break;
        case '-':
          descFormattedNumber = `管理番号：- ${sampleNumber}`;
          break;
        case 'none':
          descFormattedNumber = `管理番号：${sampleNumber}`;
          break;
        default:
          descFormattedNumber = `管理番号：【${sampleNumber}】`;
      }

      // 配置位置に応じてプレビューを生成（実際の商品説明に近い形式）
      let descPreview = '';

      // ブランド名・基本情報（先頭部分）
      const brandInfo = `ブランド名：UNIQLO（ユニクロ）

カラー（詳細）：ブラック

サイズ（表記）：M`;

      // 商品情報（中央部分）
      const detailInfo = `【サイズ(実寸)】
肩幅：47cm
身幅：55cm
袖丈：62cm
着丈：68cm

【素材】
表地：ナイロン 100%
中綿：ダウン 90%、フェザー 10%

商品状態（詳細）：
目立った傷や汚れなし。`;

      // 商品説明・その他（下部）
      const descriptionPart = `【UNIQLO ウルトラライトダウンジャケット】

UNIQLO（ユニクロ）の定番人気アイテム、ウルトラライトダウンジャケットです。軽量で持ち運びもしやすく、秋冬のアウターとして大活躍します。

【おすすめシーン】
普段使いはもちろん、旅行や通勤・通学にも便利。コンパクトに収納できるので、バッグに入れておくと安心です。`;

      // ハッシュタグ（最下部）- ユーザー設定から生成
      let hashtags = '';
      try {
        const hashtagConfig = localStorage.getItem('rebornConfig_hashtag');
        if (hashtagConfig) {
          const config = JSON.parse(hashtagConfig);
          const commonPrefix = config.commonPrefix || '#REBORN_';

          // 設定されたハッシュタグを生成（プレビュー用に簡略化）
          const previewTags = [];

          if (config.hashtags && Array.isArray(config.hashtags)) {
            config.hashtags.forEach(tag => {
              if (tag.title === '全商品') {
                previewTags.push(`${commonPrefix}${tag.suffix || '全商品'}`);
              } else if (tag.title === 'ブランド') {
                previewTags.push(`${commonPrefix}UNIQLO${tag.suffix || 'アイテム一覧'}`);
              } else if (tag.title === 'カテゴリ') {
                previewTags.push(`${commonPrefix}メンズ・レディース${tag.suffix || '一覧'}`);
              }
            });
          }

          // タグが生成されていればそれを使用
          if (previewTags.length > 0) {
            hashtags = previewTags.join('\n');
          } else {
            // 旧形式または設定なしの場合
            hashtags = `${commonPrefix}全商品\n${commonPrefix}UNIQLOアイテム一覧\n${commonPrefix}メンズ・レディース一覧`;
          }
        } else {
          // 設定がない場合のデフォルト
          hashtags = `#REBORN_全商品\n#REBORN_UNIQLOアイテム一覧\n#REBORN_メンズ・レディース一覧`;
        }
      } catch (e) {
        console.error('ハッシュタグ設定の読み込みエラー:', e);
        // エラー時のデフォルト
        hashtags = `#REBORN_全商品\n#REBORN_UNIQLOアイテム一覧\n#REBORN_メンズ・レディース一覧`;
      }

      if (descPosition === 'top') {
        // 先頭（ブランド名の上）
        descPreview = `${descFormattedNumber}

${brandInfo}

${detailInfo}

${descriptionPart}

${hashtags}`;
      } else if (descPosition === 'middle') {
        // 中（商品情報の下）
        descPreview = `${brandInfo}

${detailInfo}

${descFormattedNumber}

${descriptionPart}

${hashtags}`;
      } else {
        // 末尾（ハッシュタグの下、一番目立たない位置）
        descPreview = `${brandInfo}

${detailInfo}

${descriptionPart}

${hashtags}

${descFormattedNumber}`;
      }

      descPreviewElement.textContent = descPreview;
    }

    // 設定を保存
    if (typeof saveManagementNumberPlacementSettings === 'function') {
      saveManagementNumberPlacementSettings();
    }
  }



  /**
   * ヒントの開閉を切り替え
   */
  function toggleHint(id) {
    const content = document.getElementById(id + '-content');
    const icon = document.getElementById(id + '-icon');

    if (content.style.display === 'none') {
      content.style.display = 'block';
      icon.textContent = '▼';
    } else {
      content.style.display = 'none';
      icon.textContent = '▶';
    }
  }

  /**
   * ヒントセクションの開閉を切り替え（相互排他的）
   * @param {string} prefix - プレフィックス（例: 'mnb'）
   * @param {string} section - セクション名（'overview' または 'hint'）
   */
  function toggleHintSection(prefix, section) {
    const sections = ['overview', 'hint'];
    const currentContent = document.getElementById(prefix + '-' + section + '-content');
    const currentIcon = document.getElementById(prefix + '-' + section + '-icon');

    if (!currentContent || !currentIcon) return;

    const isCurrentlyOpen = currentContent.style.display !== 'none';

    // すべてのセクションを閉じる
    sections.forEach(s => {
      const content = document.getElementById(prefix + '-' + s + '-content');
      const icon = document.getElementById(prefix + '-' + s + '-icon');
      if (content && icon) {
        content.style.display = 'none';
        icon.textContent = '▶';
      }
    });

    // クリックしたセクションが閉じていた場合のみ開く
    if (!isCurrentlyOpen) {
      currentContent.style.display = 'block';
      currentIcon.textContent = '▼';
    }
  }

  /**
   * 管理番号設定をすべてクリア
   */
  function clearManagementNumberSettings() {
    if (!confirm('管理番号設定をすべてクリアしますか？\n\n・すべてのセグメントが削除されます\n・プリセット選択もリセットされます')) {
      return;
    }

    // セグメント配列をクリア
    MANAGEMENT_NUMBER_CONFIG.segments = [];

    // プリセット選択をリセット
    const presetSelect = document.getElementById('mnbPresetSelect');
    if (presetSelect) {
      presetSelect.value = '';
    }

    // UIを再描画
    renderSegments();
    updatePreview();

    alert('管理番号設定をクリアしました。\n変更を保存するには「設定を保存」ボタンをクリックしてください。');
  }

  // 初期化
  if (typeof window !== 'undefined') {
    window.ManagementNumberBuilder = ManagementNumberBuilder;

    // DOMContentLoadedで初期化
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        ManagementNumberBuilder.init();
      });
    } else {
      ManagementNumberBuilder.init();
    }
  }
</script>
          </div>

          <!-- 配送タブ -->
          <div class="tab-pane fade" id="system-shipping" role="tabpanel">
        <!-- ヒント -->
        <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
          <div style="color: #3b82f6; font-weight: 600; margin-bottom: 4px;">
            <span>💡 概要</span>
          </div>
          <div id="shipping-overview-content" style="display: block; padding-left: 12px; margin-bottom: 8px;">
            ここで設定したデフォルト値が商品登録時に自動で適用されます。配送料の負担（送料込み/着払い）、配送の方法（ゆうゆうメルカリ便等10種類以上）、発送元の地域（全47都道府県）、発送までの日数の4項目を設定できます
          </div>
        </div>

        <!-- 配送料の負担 -->
        <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
          <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px; display: block;">
            💰 配送料の負担
          </label>
          <select id="配送料の負担" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
            <option value="">-- 選択してください --</option>
            <option value="送料込み(出品者負担)">送料込み(出品者負担)</option>
            <option value="着払い(購入者負担)">着払い(購入者負担)</option>
          </select>
        </div>

        <!-- 配送の方法 -->
        <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
          <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px; display: block;">
            📮 配送の方法
          </label>
          <select id="配送の方法" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
            <option value="">-- 選択してください --</option>
            <option value="未定">未定</option>
            <option value="らくらくメルカリ便">らくらくメルカリ便</option>
            <option value="ゆうゆうメルカリ便">ゆうゆうメルカリ便</option>
            <option value="ゆうメール">ゆうメール</option>
            <option value="レターパック">レターパック</option>
            <option value="普通郵便(定形、定形外)">普通郵便(定形、定形外)</option>
            <option value="クロネコヤマト">クロネコヤマト</option>
            <option value="ゆうパック">ゆうパック</option>
            <option value="クリックポスト">クリックポスト</option>
            <option value="ゆうパケット">ゆうパケット</option>
          </select>
        </div>

        <!-- 発送元の地域 -->
        <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
          <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px; display: block;">
            📍 発送元の地域
          </label>
          <select id="発送元の地域" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
            <option value="">-- 選択してください --</option>
            <option value="北海道">北海道</option>
            <option value="青森県">青森県</option>
            <option value="岩手県">岩手県</option>
            <option value="宮城県">宮城県</option>
            <option value="秋田県">秋田県</option>
            <option value="山形県">山形県</option>
            <option value="福島県">福島県</option>
            <option value="茨城県">茨城県</option>
            <option value="栃木県">栃木県</option>
            <option value="群馬県">群馬県</option>
            <option value="埼玉県">埼玉県</option>
            <option value="千葉県">千葉県</option>
            <option value="東京都">東京都</option>
            <option value="神奈川県">神奈川県</option>
            <option value="新潟県">新潟県</option>
            <option value="富山県">富山県</option>
            <option value="石川県">石川県</option>
            <option value="福井県">福井県</option>
            <option value="山梨県">山梨県</option>
            <option value="長野県">長野県</option>
            <option value="岐阜県">岐阜県</option>
            <option value="静岡県">静岡県</option>
            <option value="愛知県">愛知県</option>
            <option value="三重県">三重県</option>
            <option value="滋賀県">滋賀県</option>
            <option value="京都府">京都府</option>
            <option value="大阪府">大阪府</option>
            <option value="兵庫県">兵庫県</option>
            <option value="奈良県">奈良県</option>
            <option value="和歌山県">和歌山県</option>
            <option value="鳥取県">鳥取県</option>
            <option value="島根県">島根県</option>
            <option value="岡山県">岡山県</option>
            <option value="広島県">広島県</option>
            <option value="山口県">山口県</option>
            <option value="徳島県">徳島県</option>
            <option value="香川県">香川県</option>
            <option value="愛媛県">愛媛県</option>
            <option value="高知県">高知県</option>
            <option value="福岡県">福岡県</option>
            <option value="佐賀県">佐賀県</option>
            <option value="長崎県">長崎県</option>
            <option value="熊本県">熊本県</option>
            <option value="大分県">大分県</option>
            <option value="宮崎県">宮崎県</option>
            <option value="鹿児島県">鹿児島県</option>
            <option value="沖縄県">沖縄県</option>
          </select>
        </div>

        <!-- 発送までの日数 -->
        <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
          <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px; display: block;">
            ⏱️ 発送までの日数
          </label>
          <select id="発送までの日数" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
            <option value="">-- 選択してください --</option>
            <option value="1~2日で発送">1~2日で発送</option>
            <option value="2~3日で発送">2~3日で発送</option>
            <option value="4~7日で発送">4~7日で発送</option>
          </select>
        </div>

        <!-- 梱包資材デフォルト -->
        <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
          <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px; display: block;">
            📦 梱包資材（デフォルト）
          </label>
          <select id="梱包資材デフォルト" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
            <option value="">-- 選択してください --</option>
            <!-- Firestoreから動的に読み込まれます -->
          </select>
        </div>

        <!-- すべてクリアボタン -->
        <button type="button" onclick="clearShippingDefaults()" style="width: 100%; padding: 10px; background: white; border: 2px solid #ef4444; border-radius: 8px; color: #ef4444; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 16px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
          🗑️ すべてクリア
        </button>
          </div>

          <!-- 仕入・出品タブ -->
          <div class="tab-pane fade" id="system-procure" role="tabpanel">
        <!-- ヒント -->
        <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
          <div style="color: #3b82f6; font-weight: 600; margin-bottom: 4px;">
            <span>💡 概要</span>
          </div>
          <div id="procure-overview-content" style="display: block; padding-left: 12px; margin-bottom: 8px;">
            ここで設定したデフォルト値が商品登録時に自動で適用されます。仕入日・出品日は「常に今日の日付を使用」で毎日自動更新、またはチェックを外して固定日付（一括仕入れに便利）を設定できます。仕入先・出品先もプルダウンで選択できます
          </div>
        </div>

        <!-- 仕入情報セクション -->
        <div style="margin-bottom: 24px; padding: 16px; background: white; border-radius: 8px; border: 2px solid #e5e7eb;">
          <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 16px;">
            💰 仕入情報
          </div>

          <!-- デフォルト仕入日 -->
          <div style="margin-bottom: 16px;">
            <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">
              📅 デフォルトの仕入日
            </label>
            <!-- 常に今日チェックボックス -->
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 8px;">
              <input type="checkbox" id="仕入日_今日" onchange="toggleProcureDateField()" style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px; font-weight: 500; color: #374151;">
                常に今日の日付を使用
              </span>
            </label>
            <!-- 日付入力フィールド -->
            <input type="date" id="デフォルト仕入日" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
              空欄の場合は自動入力されません。まとめて仕入れた日付を設定すると便利です
            </div>
          </div>

          <!-- 仕入先 -->
          <div style="margin-bottom: 12px;">
            <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">
              🏪 デフォルトの仕入先
            </label>
            <select id="デフォルト仕入先" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
              <option value="">-- 選択してください --</option>
            </select>
            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
              よく使う仕入先を選択（空欄も可）
            </div>
          </div>
        </div>

        <!-- 出品情報セクション -->
        <div style="margin-bottom: 16px; padding: 16px; background: white; border-radius: 8px; border: 2px solid #e5e7eb;">
          <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 16px;">
            📤 出品情報
          </div>

          <!-- デフォルト出品日 -->
          <div style="margin-bottom: 16px;">
            <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">
              📅 デフォルトの出品日 ★推奨
            </label>
            <!-- 常に今日チェックボックス -->
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 8px;">
              <input type="checkbox" id="出品日_今日" onchange="toggleListingDateField()" style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-size: 13px; font-weight: 500; color: #374151;">
                常に今日の日付を使用
              </span>
            </label>
            <!-- 日付入力フィールド -->
            <input type="date" id="デフォルト出品日" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
              「常に今日」をチェックすると毎日自動で今日の日付が入ります。固定日付にする場合はチェックを外してください
            </div>
          </div>

          <!-- 出品先 -->
          <div style="margin-bottom: 12px;">
            <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">
              🛒 デフォルトの出品先
            </label>
            <select id="デフォルト出品先" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='#f9fafb';" onblur="this.style.borderColor='#d1d5db'; this.style.background='white';">
              <option value="">-- 選択してください --</option>
            </select>
            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
              よく使う出品先を選択（空欄も可）
            </div>
          </div>
        </div>

        <!-- すべてクリアボタン -->
        <button type="button" onclick="clearProcureListingDefaults()" style="width: 100%; padding: 10px; background: white; border: 2px solid #ef4444; border-radius: 8px; color: #ef4444; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 16px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
          🗑️ すべてクリア
        </button>
          </div>

          <!-- 権限設定タブ (PERM-001 Phase 2) -->
          <div class="tab-pane fade" id="system-permission" role="tabpanel">
            <!-- ローディング表示 -->
            <div id="permissionSettingsLoading" style="display: flex; justify-content: center; align-items: center; padding: 40px;">
              <div style="text-align: center;">
                <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f4f6; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
                <div style="margin-top: 12px; color: #6b7280; font-size: 14px;">読み込み中...</div>
              </div>
            </div>

            <!-- 権限設定コンテンツ（初期非表示） -->
            <div id="permissionSettingsContent" style="display: none;">

              <!-- ヒント -->
              <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #fef3c7; border-radius: 6px; border-left: 3px solid #f59e0b; margin-bottom: 16px; line-height: 1.6;">
                <div style="color: #b45309; font-weight: 600; margin-bottom: 4px;">
                  <span>🔐 オーナー専用機能</span>
                </div>
                <div>
                  ユーザーの権限レベルを変更したり、各メニューの表示/非表示を権限ごとに設定できます。
                </div>
              </div>

              <!-- ユーザー権限管理セクション -->
              <div style="margin-bottom: 24px; padding: 16px; background: white; border-radius: 8px; border: 2px solid #e5e7eb;">
                <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 16px;">
                  👥 ユーザー権限管理
                </div>
                <div id="userPermissionList" style="display: flex; flex-direction: column; gap: 12px;">
                  <!-- ユーザーリストがここに動的に追加される -->
                </div>
              </div>

              <!-- メニュー表示設定セクション -->
              <div style="margin-bottom: 24px; padding: 16px; background: white; border-radius: 8px; border: 2px solid #e5e7eb;">
                <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 16px;">
                  📋 メニュー表示設定
                </div>
                <div style="font-size: 12px; color: #6b7280; margin-bottom: 12px;">
                  各メニューをどの権限に表示するか設定します。オーナーは常にすべて表示されます。
                </div>
                <div id="menuPermissionList" style="display: flex; flex-direction: column; gap: 12px;">
                  <!-- メニュー設定リストがここに動的に追加される -->
                </div>
              </div>

              <!-- 保存ボタン -->
              <button type="button" id="savePermissionSettingsBtn" onclick="savePermissionSettings()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; border-radius: 8px; color: white; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(59, 130, 246, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(59, 130, 246, 0.3)';">
                💾 設定を保存
              </button>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 保存ボタン -->
    <div class="save-btn" style="display: flex; justify-content: center;">
      <button type="button" onclick="window.saveConfig()" style="background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%); color: white; border: none; padding: 12px 48px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='linear-gradient(135deg, #2E94C5 0%, #1A6A8F 100%)'" onmouseout="this.style.background='linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%)'" onmousedown="this.style.transform='scale(0.98)'; this.style.opacity='0.8';" onmouseup="this.style.transform='scale(1)'; this.style.opacity='1';">
        ✓ 設定を保存
      </button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      // セールスワードマスタデータを読み込み（非同期完了を待つ）
      await loadSaleswordMasterData();

      // 仕入・出品のプルダウンを初期化
      initProcureListingDropdowns();

      // セールスワード設定を読み込み（デフォルト・よく使う・表示形式）
      loadSaleswordConfig();
    });

    /**
     * ヒントの開閉を切り替え（相互排他的）
     */
    function toggleConfigHint(prefix, section) {
      const sections = ['overview', 'hint'];
      const currentContent = document.getElementById(prefix + '-' + section + '-content');
      const currentIcon = document.getElementById(prefix + '-' + section + '-icon');

      if (!currentContent || !currentIcon) return;

      const isCurrentlyOpen = currentContent.style.display !== 'none';

      // すべてのセクションを閉じる
      sections.forEach(s => {
        const content = document.getElementById(prefix + '-' + s + '-content');
        const icon = document.getElementById(prefix + '-' + s + '-icon');
        if (content && icon) {
          content.style.display = 'none';
          icon.textContent = '▶';
        }
      });

      // クリックしたセクションが閉じていた場合のみ開く
      if (!isCurrentlyOpen) {
        currentContent.style.display = 'block';
        currentIcon.textContent = '▼';
      }
    }

    // グローバル変数
    let currentConfig = null;
    const CONDITION_STATES = [
      '新品、未使用',
      '未使用に近い',
      '目立った傷や汚れなし',
      'やや傷や汚れあり',
      '傷や汚れあり',
      '全体的に状態が悪い'
    ];

    // 商品状態ボタンのプリセット
    const CONDITION_BUTTON_PRESETS = {
      '新品、未使用': [
        { label: 'タグ付き未使用', text: 'タグ付き未使用品です。' },
        { label: '新品未開封', text: '新品未開封です。' },
        { label: '試着のみ', text: '試着のみの未使用品です。' }
      ],
      '未使用に近い': [
        { label: '数回着用', text: '数回のみ着用の美品です。' },
        { label: 'ほぼ未使用', text: 'ほぼ未使用に近い状態です。' },
        { label: '室内試着のみ', text: '室内で試着したのみです。' }
      ],
      '目立った傷や汚れなし': [
        { label: '美品', text: 'ほとんど使用感がなく、とても綺麗な状態です。' },
        { label: '保管時のシワ', text: '保管時の小さなシワがありますが、着用には問題ありません。' },
        { label: '着用感少ない', text: '着用感が少なく、まだまだご使用いただけます。' }
      ],
      'やや傷や汚れあり': [
        { label: '使用感あり', text: '若干の使用感がありますが、着用に問題ありません。' },
        { label: '小さな汚れ', text: '目立たない程度の小さな汚れがあります。' },
        { label: '毛玉あり', text: '若干の毛玉がございますが、まだまだご使用いただけます。' },
        { label: '色褪せあり', text: '若干の色褪せがありますが、着用には問題ありません。' }
      ],
      '傷や汚れあり': [
        { label: '使用感強い', text: '使用感が強めですが、まだご使用いただけます。' },
        { label: '汚れあり', text: '汚れがございます。写真でご確認ください。' },
        { label: '傷あり', text: '傷がございます。写真でご確認ください。' }
      ],
      '全体的に状態が悪い': [
        { label: '全体的に傷あり', text: '全体的に傷や汚れがあります。ご了承の上ご購入ください。' },
        { label: '目立つ汚れ', text: '目立つ汚れがあります。写真をよくご確認ください。' }
      ]
    };

    // 初期化
    window.onload = function() {
      loadAllConfig();
      initAiSettingsListeners();
    };

    /**
     * AI設定のイベントリスナーを初期化
     */
    function initAiSettingsListeners() {
      // プロンプトテンプレートの変更
      const promptTemplate = document.getElementById('aiPromptTemplate');
      if (promptTemplate) {
        promptTemplate.addEventListener('input', updateAiConfigPreview);
      }

      // 生成文字数の変更
      const lengthRadios = document.querySelectorAll('input[name="aiLength"]');
      lengthRadios.forEach(radio => {
        radio.addEventListener('change', updateAiConfigPreview);
      });

      // トーンの変更
      const tone = document.getElementById('aiTone');
      if (tone) {
        tone.addEventListener('change', updateAiConfigPreview);
      }

      // Max Tokensの変更
      const maxTokens = document.getElementById('aiMaxTokens');
      if (maxTokens) {
        maxTokens.addEventListener('input', updateAiConfigPreview);
      }

      // 含める要素のチェックボックスの変更
      ['aiIncludeBrand', 'aiIncludeCategory', 'aiIncludeSize', 'aiIncludeMaterial',
       'aiIncludeColor', 'aiIncludeCondition', 'aiIncludeCoordinate', 'aiIncludeScene'].forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox) {
          checkbox.addEventListener('change', updateAiConfigPreview);
        }
      });
    }

    /**
     * 全設定を読み込み（ハイブリッド方式: localStorage優先 → PropertiesService）
     */
    function loadAllConfig() {
      console.log('🚀 [設定画面] 設定読み込み開始（ハイブリッド方式）');
      
      // Step 1: まずlocalStorageから即座に読み込んで表示（高速）
      try {
        const localConfig = {
          商品状態ボタン: JSON.parse(localStorage.getItem('rebornConfig_conditionButtons') || '[]'),
          ハッシュタグ: JSON.parse(localStorage.getItem('rebornConfig_hashtag') || '{}'),
          割引情報: JSON.parse(localStorage.getItem('rebornConfig_discount') || '{}'),
          配送デフォルト: JSON.parse(localStorage.getItem('rebornConfig_shippingDefault') || '{}'),
          仕入出品デフォルト: JSON.parse(localStorage.getItem('rebornConfig_procureListingDefault') || '{}'),
          管理番号設定: JSON.parse(localStorage.getItem('rebornConfig_managementNumber') || '{"segments":[]}'),
          よく使うセールスワード: JSON.parse(localStorage.getItem('rebornConfig_salesword') || '{"よく使う":[],"表示形式":{},"デフォルト":{}}'),
          AI生成設定: JSON.parse(localStorage.getItem('rebornConfig_aiSettings') || '{}'),
          デザインテーマ: localStorage.getItem('rebornTheme') || 'casual'
        };
        
        console.log('✅ [設定画面] Step 1: localStorageから読み込み完了:', localConfig);
        currentConfig = localConfig;
        renderAllConfig(localConfig);
        console.log('✅ [設定画面] localStorageの設定を表示しました（即座に表示）');
      } catch (e) {
        console.error('❌ [設定画面] localStorage読み込みエラー:', e);
      }
      
      // Step 2: PWA版ではFirestoreから読み込む（GASコードは不要）
      // Firestoreからの読み込みは既に完了している（上のlocalStorageで十分）
    }

    /**
     * 全設定を画面に反映
     */
    function renderAllConfig(config) {
      renderConditionButtons(config.商品状態ボタン || []);
      renderHashtagConfig(config.ハッシュタグ || {});
      renderDiscountConfig(config.割引情報 || {});
      renderShippingDefaults(config.配送デフォルト || {});
      renderProcureListingDefaults(config.仕入出品デフォルト || {});
      renderManagementConfig(config.管理番号設定 || {});
      renderAiSettings(config.AI生成設定 || {});

      // セールスワード設定を読み込み（renderDesignThemeの前に移動）
      console.log('📋 [セールスワード] 読み込み開始:', config.よく使うセールスワード);
      if (config.よく使うセールスワード) {
        // 新しい構造（よく使う + 表示形式 + デフォルト）に対応
        if (typeof config.よく使うセールスワード === 'object' && config.よく使うセールスワード.よく使う) {
          console.log('✅ [セールスワード] 新形式で読み込み');
          console.log('  - よく使う:', config.よく使うセールスワード.よく使う);
          console.log('  - 表示形式:', config.よく使うセールスワード.表示形式);
          console.log('  - デフォルト:', config.よく使うセールスワード.デフォルト);
          SALESWORD_LIST = config.よく使うセールスワード.よく使う || [];
          renderSaleswordList();
          renderSaleswordFormat(config.よく使うセールスワード.表示形式 || {});
          renderDefaultSalesword(config.よく使うセールスワード);
        } else {
          // 旧形式（配列のみ）に対応
          console.log('⚠️ [セールスワード] 旧形式で読み込み');
          SALESWORD_LIST = config.よく使うセールスワード;
          renderSaleswordList();
          renderSaleswordFormat({ globalPrefix: '【', globalSuffix: '】', categoryOverrides: [] });
        }
      } else {
        console.log('❌ [セールスワード] 設定が空です');
      }

      // デザインテーマ（エラーが発生してもセールスワードは表示される）
      try {
        renderDesignTheme(config.デザインテーマ || 'casual');
      } catch (e) {
        console.error('❌ [デザインテーマ] レンダリングエラー:', e);
      }
    }

    /**
     * 商品状態ボタン設定を表示
     */
    function renderConditionButtons(buttons) {
      const container = document.getElementById('conditionButtonsContainer');
      container.innerHTML = '';

      CONDITION_STATES.forEach((state, stateIndex) => {
        const stateButtons = buttons.filter(b => b.商品の状態 === state);

        const groupDiv = document.createElement('div');
        groupDiv.style.cssText = 'background: white; margin-bottom: 12px; border-radius: 8px; border: 1px solid #e5e7eb; overflow: hidden;';

        // アコーディオンヘッダー（クリックで開閉）
        const headerDiv = document.createElement('div');
        headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px; cursor: pointer; background: #f9fafb; transition: background 0.2s;';
        headerDiv.onclick = () => toggleAccordion(stateIndex);
        headerDiv.onmouseover = () => headerDiv.style.background = '#f3f4f6';
        headerDiv.onmouseout = () => headerDiv.style.background = '#f9fafb';

        headerDiv.innerHTML = `
          <strong style="font-size: 14px; color: #1f2937;">${state}</strong>
          <span id="accordion-icon-${stateIndex}" style="font-size: 18px; color: #6b7280; transition: transform 0.3s;">▼</span>
        `;
        groupDiv.appendChild(headerDiv);

        // アコーディオンコンテンツ（デフォルトで非表示）
        const contentDiv = document.createElement('div');
        contentDiv.id = `accordion-content-${stateIndex}`;
        contentDiv.style.cssText = 'display: none; padding: 12px; border-top: 1px solid #e5e7eb;';

        const buttonsContainer = document.createElement('div');
        buttonsContainer.id = `condition-${state}`;

        stateButtons.forEach((btn, idx) => {
          buttonsContainer.appendChild(createButtonConfigItem(state, idx, btn.ボタンラベル, btn.ボタンテキスト));
        });

        contentDiv.appendChild(buttonsContainer);

        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'add-btn';
        addBtn.style.cssText = 'width: 100%; margin-top: 8px;';
        addBtn.textContent = '+ ボタン追加';
        addBtn.onclick = () => addConditionButton(state);
        contentDiv.appendChild(addBtn);

        groupDiv.appendChild(contentDiv);
        container.appendChild(groupDiv);
      });
    }

    /**
     * アコーディオンの開閉
     */
    function toggleAccordion(index) {
      const content = document.getElementById(`accordion-content-${index}`);
      const icon = document.getElementById(`accordion-icon-${index}`);

      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';

        // アコーディオンを開いた時に全テキストエリアのサイズを調整
        setTimeout(() => {
          const textareas = content.querySelectorAll('textarea.auto-resize');
          textareas.forEach(textarea => {
            if (textarea.value) {
              autoResizeTextarea(textarea);
            }
          });
        }, 0);
      } else {
        content.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
      }
    }

    /**
     * ボタン設定項目を作成
     */
    function createButtonConfigItem(state, index, label, text) {
      const div = document.createElement('div');
      div.className = 'condition-button-item';
      div.style.cssText = 'background: #f9fafb; padding: 10px; margin-bottom: 8px; border-radius: 4px; border: 1px solid #dee2e6;';

      // プリセット取得
      const presets = CONDITION_BUTTON_PRESETS[state] || [];

      // プルダウンの選択肢を生成
      let selectOptions = '<option value="">-- 選択してください --</option>';
      presets.forEach(preset => {
        const selected = label === preset.label ? 'selected' : '';
        selectOptions += `<option value="${preset.label}" ${selected}>${preset.label}</option>`;
      });
      selectOptions += '<option value="custom">✏️ カスタム入力</option>';

      // カスタム入力かどうかを判定
      const isCustom = label && !presets.find(p => p.label === label);
      const selectedValue = isCustom ? 'custom' : (label || '');

      div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
          <strong style="font-size: 13px;">ボタン ${index + 1}</strong>
          <button type="button" class="btn btn-sm btn-outline-danger remove-btn" onclick="removeConditionButton('${state}', ${index})">削除</button>
        </div>
        <div class="mb-2">
          <label style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">ボタンラベル</label>
          <select class="form-control label-preset-select" data-state="${state}" data-index="${index}" data-field="label-select" onchange="handleLabelPresetChange(this, '${state}', ${index})" style="font-size: 16px; margin-bottom: 4px; appearance: auto; -webkit-appearance: menulist; -moz-appearance: menulist; background-color: white; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 6px; cursor: pointer;">
            ${selectOptions}
          </select>
          <input type="text" class="form-control label-custom-input" data-state="${state}" data-index="${index}" data-field="label" value="${label || ''}" placeholder="カスタムラベルを入力" style="font-size: 16px; display: none;">
        </div>
        <div>
          <label style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">ボタンテキスト</label>
          <textarea class="form-control auto-resize" rows="2" data-state="${state}" data-index="${index}" data-field="text" placeholder="クリック時に挿入されるテキストを入力" style="font-size: 13px; resize: none; overflow: hidden;" oninput="autoResizeTextarea(this)">${text}</textarea>
        </div>
      `;

      // プルダウンの値を設定
      setTimeout(() => {
        const select = div.querySelector('[data-field="label-select"]');
        const customInput = div.querySelector('[data-field="label"]');

        if (select) {
          select.value = selectedValue;

          // カスタム入力欄の表示/非表示を制御
          if (selectedValue === 'custom') {
            customInput.style.display = 'block';
          } else {
            customInput.style.display = 'none';
          }
        }

        // テキストエリアの初期サイズ調整
        const textarea = div.querySelector('textarea');
        if (textarea && textarea.value) {
          autoResizeTextarea(textarea);
        }
      }, 0);

      return div;
    }

    /**
     * ラベルプリセット変更時の処理
     */
    function handleLabelPresetChange(selectElement, state, index) {
      const selectedValue = selectElement.value;

      // data属性を使って同じstate/indexの要素を直接取得
      const containerId = `condition-${state}`;
      const container = document.getElementById(containerId);
      const items = container.querySelectorAll('.condition-button-item');
      const targetItem = items[index];

      if (!targetItem) {
        console.error('ボタンアイテムが見つかりません:', { state, index });
        return;
      }

      const labelInput = targetItem.querySelector('[data-field="label"]');
      const textArea = targetItem.querySelector('[data-field="text"]');

      console.log('handleLabelPresetChange:', { selectedValue, state, index, targetItem });

      if (selectedValue === 'custom') {
        // カスタム入力を表示
        labelInput.style.display = 'block';
        labelInput.value = '';
        textArea.value = '';
        labelInput.focus();
        setTimeout(() => autoResizeTextarea(textArea), 0);
      } else if (selectedValue === '') {
        // 未選択
        labelInput.style.display = 'none';
        labelInput.value = '';
        textArea.value = '';
        setTimeout(() => autoResizeTextarea(textArea), 0);
      } else {
        // プリセット選択
        labelInput.style.display = 'none';
        const presets = CONDITION_BUTTON_PRESETS[state] || [];
        const preset = presets.find(p => p.label === selectedValue);
        console.log('プリセット検索結果:', preset);
        if (preset) {
          labelInput.value = preset.label;
          textArea.value = preset.text;
          console.log('テキストエリアに設定:', preset.text);
          setTimeout(() => autoResizeTextarea(textArea), 0);
        } else {
          console.warn('プリセットが見つかりません:', selectedValue, state);
        }
      }
    }

    /**
     * 商品状態ボタンを追加
     */
    function addConditionButton(state) {
      const container = document.getElementById(`condition-${state}`);
      const index = container.children.length;
      container.appendChild(createButtonConfigItem(state, index, '', ''));
    }

    /**
     * 商品状態ボタンを削除
     */
    function removeConditionButton(state, index) {
      const container = document.getElementById(`condition-${state}`);
      if (container.children.length > 1) {
        container.children[index].remove();
        // インデックスを再計算
        Array.from(container.children).forEach((child, newIndex) => {
          const inputs = child.querySelectorAll('[data-index]');
          inputs.forEach(input => input.setAttribute('data-index', newIndex));
          child.querySelector('strong').textContent = `ボタン ${newIndex + 1}`;
          child.querySelector('.remove-btn').onclick = () => removeConditionButton(state, newIndex);
        });
      } else {
        alert('最低1つのボタンは必要です');
      }
    }

    /**
     * ハッシュタグ設定を表示
     */
    function renderHashtagConfig(config) {
      const container = document.getElementById('hashtagItemsContainer');
      container.innerHTML = '';

      // 共通プレフィックスを設定
      const removeHash = (value) => {
        if (!value) return '';
        return value.startsWith('#') ? value.substring(1) : value;
      };

      let commonPrefix = '';
      let hashtags = [];

      if (config.hashtags && Array.isArray(config.hashtags)) {
        // 新形式: 動的配列
        commonPrefix = removeHash(config.commonPrefix || 'REBORN_');
        hashtags = config.hashtags;
      } else if (config.全商品プレフィックス || config.ブランドプレフィックス || config.カテゴリプレフィックス) {
        // 旧形式: 固定3項目から変換（最初のプレフィックスを共通として使用）
        commonPrefix = removeHash(config.全商品プレフィックス || config.ブランドプレフィックス || config.カテゴリプレフィックス || 'REBORN_');

        if (config.全商品プレフィックス || config.全商品テキスト) {
          hashtags.push({
            title: '全商品',
            icon: '🌐',
            suffix: config.全商品テキスト || '全商品',
            suffixOptions: ['全商品', '全アイテム', '商品一覧', 'アイテム一覧']
          });
        }
        if (config.ブランドプレフィックス || config.ブランドサフィックス) {
          hashtags.push({
            title: 'ブランド',
            icon: '👔',
            suffix: config.ブランドサフィックス || 'アイテム一覧',
            suffixOptions: ['アイテム一覧', '商品一覧', 'コレクション', 'ブランド商品']
          });
        }
        if (config.カテゴリプレフィックス || config.カテゴリサフィックス) {
          hashtags.push({
            title: 'カテゴリ',
            icon: '📂',
            suffix: config.カテゴリサフィックス || '一覧',
            suffixOptions: ['一覧', 'アイテム一覧', '商品一覧', 'コレクション']
          });
        }
      }

      // 共通プレフィックスを設定
      document.getElementById('commonHashtagPrefix').value = commonPrefix;

      // ハッシュタグ項目をレンダリング
      hashtags.forEach((item, index) => {
        container.appendChild(createHashtagItem(index, item));
      });

      // ドラッグ&ドロップをセットアップ
      setupHashtagDragAndDrop();
    }

    /**
     * ハッシュタグ項目のドラッグ&ドロップをセットアップ（Sortable.js使用）
     * タッチデバイス（スマホ）でも動作するようになりました
     */
    function setupHashtagDragAndDrop() {
      const container = document.getElementById('hashtagItemsContainer');

      // Sortable.jsを使用してドラッグ&ドロップを初期化
      // タッチイベントに自動対応
      Sortable.create(container, {
        animation: 150,                    // アニメーション速度（ミリ秒）
        handle: '.hashtag-drag-handle',    // ⋮⋮ アイコンのみでドラッグ
        ghostClass: 'sortable-ghost',      // ドラッグ中の要素に適用されるクラス
        chosenClass: 'sortable-chosen',    // 選択中の要素に適用されるクラス
        dragClass: 'sortable-drag',        // ドラッグ中の要素に適用されるクラス
        onEnd: function() {
          // ドロップ後にインデックスを再設定
          reindexHashtagItems();
        }
      });
    }

    /**
     * ハッシュタグ項目を作成
     */
    function createHashtagItem(index, data = {}) {
      const title = data.title || '';
      const icon = data.icon || '🏷️';
      const suffix = data.suffix || '';
      const suffixOptions = data.suffixOptions || ['全商品', '全アイテム', '商品一覧', 'アイテム一覧'];

      const div = document.createElement('div');
      div.className = 'hashtag-item';
      div.setAttribute('data-index', index);
      div.setAttribute('draggable', 'true');
      div.style.cssText = 'margin-bottom: 12px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb; cursor: move; transition: all 0.2s;';

      // プレビュー用の中間部分を決定（具体例を表示）
      let previewMiddle = '';
      if (title === 'ブランド') {
        previewMiddle = 'UNIQLO';
      } else if (title === 'カテゴリ') {
        // 選択されたカテゴリの具体例を表示
        const categoryOptions = data.categoryOptions || ['大分類', '中分類'];
        const exampleMap = {
          '大分類': 'メンズ',
          '中分類': 'トップス',
          '小分類': 'シャツ',
          '細分類1': '半袖シャツ',
          '細分類2': 'アロハシャツ・かりゆしウェア',
          'アイテム名': 'アロハシャツ'
        };
        const examples = categoryOptions.map(opt => exampleMap[opt] || opt);
        previewMiddle = examples.join('');
      } else if (title === 'カラー') {
        previewMiddle = '黒';
      } else if (title === 'サイズ') {
        previewMiddle = 'M';
      }

      // プレビューテキストを生成
      const commonPrefix = document.getElementById('commonHashtagPrefix')?.value || 'REBORN_';
      const previewText = `#${commonPrefix}${previewMiddle}${suffixOptions.includes(suffix) ? suffix : (!suffixOptions.includes(suffix) && suffix ? suffix : '')}`;

      // カテゴリハッシュタグの場合、チェックボックスを追加
      const isCategoryHashtag = title === 'カテゴリ';
      const categoryOptions = data.categoryOptions || ['大分類', '中分類'];

      const categoryCheckboxesHtml = isCategoryHashtag ? `
        <div style="margin-bottom: 8px; padding: 8px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
          <div style="font-size: 11px; font-weight: 600; color: #6b7280; margin-bottom: 6px;">連結するカテゴリを選択（複数可）:</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px;">
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
              <input type="checkbox" class="category-option" data-option="大分類" ${categoryOptions.includes('大分類') ? 'checked' : ''} onchange="updateHashtagItemPreview(${index})" style="cursor: pointer;">
              <span>大分類</span>
            </label>
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
              <input type="checkbox" class="category-option" data-option="中分類" ${categoryOptions.includes('中分類') ? 'checked' : ''} onchange="updateHashtagItemPreview(${index})" style="cursor: pointer;">
              <span>中分類</span>
            </label>
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
              <input type="checkbox" class="category-option" data-option="小分類" ${categoryOptions.includes('小分類') ? 'checked' : ''} onchange="updateHashtagItemPreview(${index})" style="cursor: pointer;">
              <span>小分類</span>
            </label>
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
              <input type="checkbox" class="category-option" data-option="細分類1" ${categoryOptions.includes('細分類1') ? 'checked' : ''} onchange="updateHashtagItemPreview(${index})" style="cursor: pointer;">
              <span>細分類1</span>
            </label>
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
              <input type="checkbox" class="category-option" data-option="細分類2" ${categoryOptions.includes('細分類2') ? 'checked' : ''} onchange="updateHashtagItemPreview(${index})" style="cursor: pointer;">
              <span>細分類2</span>
            </label>
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
              <input type="checkbox" class="category-option" data-option="アイテム名" ${categoryOptions.includes('アイテム名') ? 'checked' : ''} onchange="updateHashtagItemPreview(${index})" style="cursor: pointer;">
              <span>アイテム名</span>
            </label>
          </div>
        </div>
      ` : '';

      div.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
          <span class="hashtag-drag-handle" style="font-size: 16px; color: #9ca3af; cursor: grab; user-select: none; flex-shrink: 0;" title="ドラッグして並び替え">⋮⋮</span>
          <span class="hashtag-icon-display" style="font-size: 18px; user-select: none; flex-shrink: 0;">${icon}</span>
          <input type="hidden" class="hashtag-icon" value="${icon}">
          <input type="hidden" class="hashtag-title" value="${title}">
          <div style="flex: 1; font-size: 14px; font-weight: 600; color: #374151;">${title}</div>
        </div>

        ${categoryCheckboxesHtml}

        <div style="margin-bottom: 8px;">
          <select class="hashtag-suffix-select" style="width: 100%; padding: 6px 8px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 12px; transition: all 0.2s; background: white; cursor: pointer;" onfocus="this.style.borderColor='#3b82f6';" onblur="this.style.borderColor='#d1d5db';" onchange="handleHashtagItemSuffixChange(${index})">
            ${suffixOptions.map(opt => `<option value="${opt}"${opt === suffix ? ' selected' : ''}>${opt}</option>`).join('')}
            <option value="custom"${!suffixOptions.includes(suffix) && suffix ? ' selected' : ''}>カスタム...</option>
          </select>
          <input type="text" class="hashtag-suffix-custom" value="${!suffixOptions.includes(suffix) && suffix ? suffix : ''}" placeholder="カスタム値を入力" style="width: 100%; padding: 6px 8px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 12px; transition: all 0.2s; margin-top: 6px; display: ${!suffixOptions.includes(suffix) && suffix ? 'block' : 'none'};" onfocus="this.style.borderColor='#3b82f6';" onblur="this.style.borderColor='#d1d5db';" oninput="updateHashtagItemPreview(${index})">
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
          <div style="flex: 1;">
            <div style="font-size: 10px; color: #6b7280; margin-bottom: 2px;">プレビュー:</div>
            <div class="hashtag-preview" style="padding: 6px 10px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 11px; color: #1e40af; font-weight: 500;">
              ${previewText}
            </div>
          </div>
          <button type="button" onclick="removeHashtagItem(${index})" style="padding: 4px 8px; background: white; border: 1px solid #ef4444; color: #ef4444; border-radius: 4px; font-size: 10px; cursor: pointer; transition: all 0.2s; white-space: nowrap; flex-shrink: 0;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
            削除
          </button>
        </div>
      `;

      return div;
    }

    /**
     * ハッシュタグタイプ選択メニューを表示
     */
    function showHashtagTypeSelector() {
      const menu = document.getElementById('hashtagTypeSelectorMenu');
      menu.style.display = 'block';
    }

    /**
     * ハッシュタグタイプ選択メニューを非表示
     */
    function hideHashtagTypeSelector() {
      const menu = document.getElementById('hashtagTypeSelectorMenu');
      menu.style.display = 'none';
    }

    /**
     * タイプを指定してハッシュタグ項目を追加
     */
    function addHashtagItemByType(type) {
      const container = document.getElementById('hashtagItemsContainer');
      const index = container.children.length;

      let newItem = {};

      if (type === '全商品') {
        newItem = {
          title: '全商品',
          icon: '🌐',
          suffix: '全商品',
          suffixOptions: ['全商品', '全アイテム', '商品一覧', 'アイテム一覧']
        };
      } else if (type === 'ブランド') {
        newItem = {
          title: 'ブランド',
          icon: '👔',
          suffix: 'アイテム一覧',
          suffixOptions: ['一覧', 'アイテム一覧', '商品一覧', '全商品', 'コレクション']
        };
      } else if (type === 'カテゴリ') {
        newItem = {
          title: 'カテゴリ',
          icon: '📁',
          suffix: '一覧',
          suffixOptions: ['一覧', 'アイテム一覧', '商品一覧', 'コレクション'],
          categoryOptions: ['大分類']
        };
      } else if (type === 'カラー') {
        newItem = {
          title: 'カラー',
          icon: '🎨',
          suffix: '一覧',
          suffixOptions: ['一覧', 'アイテム一覧', '商品一覧', 'コレクション']
        };
      } else if (type === 'サイズ') {
        newItem = {
          title: 'サイズ',
          icon: '📏',
          suffix: '一覧',
          suffixOptions: ['一覧', 'アイテム一覧', '商品一覧', 'コレクション']
        };
      }

      container.appendChild(createHashtagItem(index, newItem));
      hideHashtagTypeSelector();
    }

    /**
     * ハッシュタグ項目を追加（旧関数・互換性のため残す）
     */
    function addHashtagItem() {
      showHashtagTypeSelector();
    }

    /**
     * ハッシュタグ項目を削除
     */
    function removeHashtagItem(index) {
      const container = document.getElementById('hashtagItemsContainer');

      // 項目を削除
      if (container.children[index]) {
        container.children[index].remove();
      }

      // インデックスを再割り当て
      Array.from(container.children).forEach((item, newIndex) => {
        item.setAttribute('data-index', newIndex);

        // 各ボタンとイベントハンドラーのインデックスを更新
        const deleteBtn = item.querySelector('button[onclick*="removeHashtagItem"]');
        if (deleteBtn) {
          deleteBtn.setAttribute('onclick', `removeHashtagItem(${newIndex})`);
        }

        const suffixSelect = item.querySelector('.hashtag-suffix-select');
        if (suffixSelect) {
          suffixSelect.setAttribute('onchange', `handleHashtagItemSuffixChange(${newIndex})`);
        }

        const suffixCustom = item.querySelector('.hashtag-suffix-custom');
        if (suffixCustom) {
          suffixCustom.setAttribute('oninput', `updateHashtagItemPreview(${newIndex})`);
        }
      });
    }

    /**
     * すべてのハッシュタグをクリア
     */
    function clearAllHashtags() {
      if (!confirm('すべてのハッシュタグをクリアしてよろしいですか？\nこの操作は取り消せません。')) {
        return;
      }

      const container = document.getElementById('hashtagItemsContainer');
      container.innerHTML = '';

      alert('すべてのハッシュタグをクリアしました。\n変更を保存するには「保存」ボタンをクリックしてください。');
    }

    /**
     * ハッシュタグ項目のインデックスを再割り当て
     */
    function reindexHashtagItems() {
      const container = document.getElementById('hashtagItemsContainer');
      Array.from(container.children).forEach((item, newIndex) => {
        item.setAttribute('data-index', newIndex);

        const deleteBtn = item.querySelector('button[onclick*="removeHashtagItem"]');
        if (deleteBtn) {
          deleteBtn.setAttribute('onclick', `removeHashtagItem(${newIndex})`);
        }

        const suffixSelect = item.querySelector('.hashtag-suffix-select');
        if (suffixSelect) {
          suffixSelect.setAttribute('onchange', `handleHashtagItemSuffixChange(${newIndex})`);
        }

        const suffixCustom = item.querySelector('.hashtag-suffix-custom');
        if (suffixCustom) {
          suffixCustom.setAttribute('oninput', `updateHashtagItemPreview(${newIndex})`);
        }

        const categoryOptions = item.querySelectorAll('.category-option');
        categoryOptions.forEach(checkbox => {
          checkbox.setAttribute('onchange', `updateHashtagItemPreview(${newIndex})`);
        });
      });
    }

    /**
     * ハッシュタグ項目のプレビューを更新
     */
    function updateHashtagItemPreview(index) {
      const container = document.getElementById('hashtagItemsContainer');
      const item = container.children[index];
      if (!item) return;

      const commonPrefix = document.getElementById('commonHashtagPrefix').value || '';
      const titleInput = item.querySelector('.hashtag-title');
      const title = titleInput ? titleInput.value || '' : '';
      const suffixSelect = item.querySelector('.hashtag-suffix-select');
      const suffixCustom = item.querySelector('.hashtag-suffix-custom');

      let suffix = '';
      if (suffixSelect.value === 'custom') {
        suffix = suffixCustom.value || '';
      } else {
        suffix = suffixSelect.value || '';
      }

      // プレビュー用の中間部分を決定（具体例を表示）
      let previewMiddle = '';
      if (title === 'ブランド') {
        previewMiddle = 'UNIQLO';
      } else if (title === 'カテゴリ') {
        // 選択されたカテゴリオプションの具体例を表示
        const categoryCheckboxes = item.querySelectorAll('.category-option:checked');
        const selectedCategories = Array.from(categoryCheckboxes).map(cb => cb.getAttribute('data-option'));
        const exampleMap = {
          '大分類': 'メンズ',
          '中分類': 'トップス',
          '小分類': 'シャツ',
          '細分類1': '半袖シャツ',
          '細分類2': 'アロハシャツ・かりゆしウェア',
          'アイテム名': 'アロハシャツ'
        };
        const examples = selectedCategories.map(opt => exampleMap[opt] || opt);
        previewMiddle = examples.length > 0 ? examples.join('') : 'カテゴリ';
      } else if (title === 'カラー') {
        previewMiddle = '黒';
      } else if (title === 'サイズ') {
        previewMiddle = 'M';
      }

      const preview = `#${commonPrefix}${previewMiddle}${suffix}`;
      const previewDiv = item.querySelector('.hashtag-preview');
      if (previewDiv) {
        previewDiv.textContent = preview;
      }
    }

    /**
     * すべてのハッシュタグプレビューを更新
     */
    function updateAllHashtagPreviews() {
      const container = document.getElementById('hashtagItemsContainer');
      for (let i = 0; i < container.children.length; i++) {
        updateHashtagItemPreview(i);
      }
    }

    /**
     * ハッシュタグ項目のサフィックス変更処理
     */
    function handleHashtagItemSuffixChange(index) {
      const container = document.getElementById('hashtagItemsContainer');
      const item = container.children[index];
      if (!item) return;

      const suffixSelect = item.querySelector('.hashtag-suffix-select');
      const suffixCustom = item.querySelector('.hashtag-suffix-custom');

      if (suffixSelect.value === 'custom') {
        suffixCustom.style.display = 'block';
        suffixCustom.focus();
      } else {
        suffixCustom.style.display = 'none';
        suffixCustom.value = '';
      }

      updateHashtagItemPreview(index);
    }


    /**
     * ハッシュタグサフィックスのセットアップ（選択肢とカスタム値の処理）
     */
    function setupHashtagSuffix(type, value, options) {
      const selectId = type === '全商品' ? '全商品テキスト_select' : `${type}サフィックス_select`;
      const inputId = type === '全商品' ? '全商品テキスト' : `${type}サフィックス`;

      const select = document.getElementById(selectId);
      const input = document.getElementById(inputId);

      if (options.includes(value)) {
        // プリセット値の場合
        select.value = value;
        input.style.display = 'none';
        input.value = '';
      } else {
        // カスタム値の場合
        select.value = 'custom';
        input.style.display = 'block';
        input.value = value;
      }
    }

    /**
     * ハッシュタグプレビュー更新
     */
    function updateHashtagPreview(type) {
      const prefixId = type === '全商品' ? '全商品プレフィックス' : `${type}プレフィックス`;
      const selectId = type === '全商品' ? '全商品テキスト_select' : `${type}サフィックス_select`;
      const inputId = type === '全商品' ? '全商品テキスト' : `${type}サフィックス`;
      const previewId = `${type}プレビュー`;

      const prefix = document.getElementById(prefixId).value || '';
      const select = document.getElementById(selectId);
      const input = document.getElementById(inputId);

      let suffix = '';
      if (select.value === 'custom') {
        suffix = input.value || '';
      } else {
        suffix = select.value || '';
      }

      // ブランドの場合は例としてUNIQLOを表示
      const middlePart = type === 'ブランド' ? 'UNIQLO' : (type === 'カテゴリ' ? 'トップス' : '');

      const preview = `#${prefix}${middlePart}${suffix}`;
      document.getElementById(previewId).textContent = preview;
    }

    /**
     * ハッシュタグサフィックス変更処理
     */
    function handleHashtagSuffixChange(type) {
      const selectId = type === '全商品' ? '全商品テキスト_select' : `${type}サフィックス_select`;
      const inputId = type === '全商品' ? '全商品テキスト' : `${type}サフィックス`;

      const select = document.getElementById(selectId);
      const input = document.getElementById(inputId);

      if (select.value === 'custom') {
        input.style.display = 'block';
        input.focus();
      } else {
        input.style.display = 'none';
        input.value = '';
      }

      updateHashtagPreview(type);
    }

    // 割引タイプのアイコンマッピング
    const DISCOUNT_ICONS = {
      'フォロー割': '👥',
      'リピート割': '🔄',
      'まとめ割': '📦',
      '学割': '🎓',
      'セット割': '🎁',
      'クーポン割': '🎫',
      '新規会員割': '✨',
      '期間限定割': '⏰'
    };

    // デフォルトの割引タイプ
    const DEFAULT_DISCOUNT_TYPES = ['フォロー割', 'リピート割', 'まとめ割'];

    /**
     * 割引タイプを追加
     */
    function addDiscountType() {
      const typesList = document.getElementById('discountTypesList');

      // プリセット選択UI
      const selectorDiv = document.createElement('div');
      selectorDiv.style.cssText = 'background: white; padding: 12px; margin-bottom: 16px; border-radius: 8px; border: 2px solid #3b82f6;';
      selectorDiv.innerHTML = `
        <div style="margin-bottom: 8px; font-size: 13px; font-weight: 600; color: #374151;">割引タイプを選択</div>
        <select id="newDiscountTypeSelect" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 8px; font-size: 16px;">
          <option value="">-- 選択してください --</option>
          <option value="フォロー割">👥 フォロー割</option>
          <option value="リピート割">🔄 リピート割</option>
          <option value="まとめ割">📦 まとめ割</option>
          <option value="学割">🎓 学割</option>
          <option value="セット割">🎁 セット割</option>
          <option value="クーポン割">🎫 クーポン割</option>
          <option value="新規会員割">✨ 新規会員割</option>
          <option value="期間限定割">⏰ 期間限定割</option>
          <option value="custom">✏️ カスタム入力</option>
        </select>
        <input type="text" id="newDiscountTypeCustom" placeholder="カスタム割引名を入力（例: 誕生日割）" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 8px; font-size: 16px; display: none;">
        <input type="text" id="newDiscountTypeIcon" placeholder="アイコンを入力（例: 🎂）" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 8px; font-size: 16px; display: none;">
        <div style="display: flex; gap: 8px;">
          <button type="button" onclick="confirmAddDiscountType()" style="flex: 1; padding: 8px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">追加</button>
          <button type="button" onclick="cancelAddDiscountType()" style="flex: 1; padding: 8px; background: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 13px;">キャンセル</button>
        </div>
      `;

      typesList.appendChild(selectorDiv);

      // セレクト変更時のハンドラー
      document.getElementById('newDiscountTypeSelect').addEventListener('change', function() {
        const customInput = document.getElementById('newDiscountTypeCustom');
        const iconInput = document.getElementById('newDiscountTypeIcon');
        if (this.value === 'custom') {
          customInput.style.display = 'block';
          iconInput.style.display = 'block';
        } else {
          customInput.style.display = 'none';
          iconInput.style.display = 'none';
        }
      });
    }

    /**
     * 割引タイプ追加を確定
     */
    function confirmAddDiscountType() {
      const select = document.getElementById('newDiscountTypeSelect');
      const customInput = document.getElementById('newDiscountTypeCustom');
      const iconInput = document.getElementById('newDiscountTypeIcon');

      let typeName, icon;

      if (select.value === 'custom') {
        typeName = customInput.value.trim();
        icon = iconInput.value.trim() || '💰';
        if (!typeName) {
          alert('割引名を入力してください');
          return;
        }
      } else if (select.value) {
        typeName = select.value;
        icon = DISCOUNT_ICONS[typeName] || '💰';
      } else {
        alert('割引タイプを選択してください');
        return;
      }

      // 既存チェック
      if (document.getElementById(`${typeName}Group`)) {
        alert('同じ名前の割引が既に存在します');
        return;
      }

      // 選択UIを削除
      cancelAddDiscountType();

      // 新しい割引タイプを作成
      createDiscountTypeBlock(typeName, icon);

      updateDiscountPreview();
    }

    /**
     * 割引タイプ追加をキャンセル
     */
    function cancelAddDiscountType() {
      const typesList = document.getElementById('discountTypesList');
      const selector = typesList.querySelector('[id="newDiscountTypeSelect"]')?.closest('div');
      if (selector) {
        selector.remove();
      }
    }

    /**
     * 割引タイプブロックを作成
     */
    function createDiscountTypeBlock(typeName, icon, ranges = [], description = '') {
      const typesList = document.getElementById('discountTypesList');

      const groupDiv = document.createElement('div');
      groupDiv.id = `${typeName}Group`;
      groupDiv.className = 'discount-group';

      groupDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <strong style="font-size: 14px; color: #1f2937;">${icon} ${typeName}</strong>
          <button type="button" onclick="removeDiscountType('${typeName}')" style="padding: 4px 12px; background: white; color: #ef4444; border: 1px solid #ef4444; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">削除</button>
        </div>
        <div id="${typeName}Container">
          <!-- 動的に生成 -->
        </div>
        <button type="button" class="btn btn-sm btn-primary add-btn" onclick="addDiscountRange('${typeName}')" style="width: 100%; margin-bottom: 12px;">+ 範囲追加</button>
        <div>
          <label class="form-label" style="font-size: 12px;">説明文（任意）</label>
          <textarea class="form-control auto-resize" id="${typeName}_説明文" placeholder="説明文を入力" style="font-size: 13px; resize: none; overflow: hidden; min-height: 100px;" oninput="autoResizeTextarea(this); updateDiscountPreview();">${description}</textarea>
        </div>
      `;

      typesList.appendChild(groupDiv);

      const container = document.getElementById(`${typeName}Container`);
      ranges.forEach((range, idx) => {
        container.appendChild(createDiscountRangeItem(typeName, idx, range.範囲, range.割引額));
      });

      // 説明文textareaの初期サイズ調整
      setTimeout(() => {
        const textarea = document.getElementById(`${typeName}_説明文`);
        if (textarea && textarea.value) {
          autoResizeTextarea(textarea);
        }
      }, 0);
    }

    /**
     * 割引タイプを削除
     */
    function removeDiscountType(typeName) {
      if (!confirm(`「${typeName}」を削除しますか？`)) {
        return;
      }

      const group = document.getElementById(`${typeName}Group`);
      if (group) {
        group.remove();
      }

      updateDiscountPreview();
    }

    /**
     * 割引情報設定を表示
     */
    function renderDiscountConfig(config) {
      // タイトルを設定
      const select = document.getElementById('割引情報タイトル選択');
      const customInput = document.getElementById('割引情報タイトルカスタム');

      if (select) {
        const titleSelection = config['タイトル選択'] || config['タイトル'] || '【お得な割引情報】';

        // カスタム入力の場合
        if (titleSelection === 'custom') {
          select.value = 'custom';
          customInput.value = config['タイトル'] || '';
          customInput.style.display = 'block';
        } else {
          // プリセット選択の場合
          select.value = titleSelection;
          customInput.style.display = 'none';
        }
      }

      // 既存の割引タイプをクリア
      const typesList = document.getElementById('discountTypesList');
      typesList.innerHTML = '';

      // デフォルト説明文
      const defaultDescriptions = {
        'フォロー割': '',
        'リピート割': '「リピート割希望」とコメントにてお知らせください。',
        'まとめ割': '購入したい商品が複数ある場合、コメントにてお知らせください。'
      };

      // 設定から割引タイプを取得（保存されている順序を維持）
      const savedTypes = config['割引タイプ順序'] || DEFAULT_DISCOUNT_TYPES;

      savedTypes.forEach(typeName => {
        const ranges = config[typeName] || [];
        const description = config[`${typeName}_説明文`] || defaultDescriptions[typeName] || '';
        const icon = config[`${typeName}_アイコン`] || DISCOUNT_ICONS[typeName] || '💰';

        createDiscountTypeBlock(typeName, icon, ranges, description);
      });

      // 全ての割引タイプ作成後、説明文テキストエリアのサイズを調整
      setTimeout(() => {
        const textareas = typesList.querySelectorAll('textarea.auto-resize');
        textareas.forEach(textarea => {
          if (textarea.value) {
            autoResizeTextarea(textarea);
          }
        });
      }, 100);

      // プレビューを更新
      updateDiscountPreview();
    }

    /**
     * 割引範囲項目を作成
     */
    function createDiscountRangeItem(type, index, range, amount) {
      const div = document.createElement('div');
      div.className = 'discount-range-item';
      div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
          <strong style="font-size: 13px;">範囲 ${index + 1}</strong>
          <button type="button" class="btn btn-sm btn-outline-danger remove-btn" onclick="removeDiscountRange('${type}', ${index})">削除</button>
        </div>
        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
          <div style="writing-mode: vertical-rl; font-size: 9px; font-weight: 600; color: #6b7280; display: flex; align-items: center; justify-content: center; padding: 4px 2px; background: #f3f4f6; border-radius: 4px;">範囲</div>
          <input type="text" class="form-control" data-discount="${type}" data-index="${index}" data-field="range" value="${range}" placeholder="空欄可（例: 〜2,999円）" style="flex: 1;" oninput="updateDiscountPreview()">
        </div>
        <div style="display: flex; gap: 8px;">
          <div style="writing-mode: vertical-rl; font-size: 9px; font-weight: 600; color: #6b7280; display: flex; align-items: center; justify-content: center; padding: 4px 2px; background: #f3f4f6; border-radius: 4px;">割引</div>
          <input type="text" class="form-control" data-discount="${type}" data-index="${index}" data-field="amount" value="${amount}" placeholder="100円引" style="flex: 1;" oninput="updateDiscountPreview()">
        </div>
      `;
      return div;
    }

    /**
     * 割引範囲を追加
     */
    function addDiscountRange(type) {
      const container = document.getElementById(`${type}Container`);
      const index = container.children.length;
      container.appendChild(createDiscountRangeItem(type, index, '', ''));
      updateDiscountPreview();
    }

    /**
     * 割引範囲を削除
     */
    function removeDiscountRange(type, index) {
      const container = document.getElementById(`${type}Container`);
      if (container.children.length > 1) {
        container.children[index].remove();
        // インデックスを再計算
        Array.from(container.children).forEach((child, newIndex) => {
          const inputs = child.querySelectorAll('[data-index]');
          inputs.forEach(input => input.setAttribute('data-index', newIndex));
          child.querySelector('strong').textContent = `範囲 ${newIndex + 1}`;
          child.querySelector('.remove-btn').onclick = () => removeDiscountRange(type, newIndex);
        });
        updateDiscountPreview();
      } else {
        alert('最低1つの範囲は必要です');
      }
    }

    /**
     * 割引情報タイトルの変更を処理
     */
    function handleDiscountTitleChange() {
      const select = document.getElementById('割引情報タイトル選択');
      const customInput = document.getElementById('割引情報タイトルカスタム');

      if (select.value === 'custom') {
        customInput.style.display = 'block';
        customInput.focus();
      } else {
        customInput.style.display = 'none';
      }

      updateDiscountPreview();
    }

    /**
     * 割引情報プレビューを更新
     */
    function updateDiscountPreview() {
      const preview = document.getElementById('discountPreview');
      if (!preview) return;

      const select = document.getElementById('割引情報タイトル選択');
      const customInput = document.getElementById('割引情報タイトルカスタム');
      const title = select?.value === 'custom' ? customInput?.value : select?.value || '【お得な割引情報】';
      const discountConfig = collectDiscountConfig();
      let previewText = title ? title + '\n\n' : '';

      // 現在表示されている全ての割引タイプを処理
      const typesList = document.getElementById('discountTypesList');
      const discountGroups = typesList?.querySelectorAll('.discount-group') || [];

      discountGroups.forEach(group => {
        const typeName = group.id.replace('Group', '');
        const ranges = discountConfig[typeName] || [];

        if (ranges.length > 0) {
          previewText += `■ ${typeName}\n`;
          ranges.forEach(item => {
            // 範囲が空欄の場合は割引額のみ表示
            if (item.範囲) {
              previewText += `${item.範囲} ⇒ ${item.割引額}\n`;
            } else {
              previewText += `${item.割引額}\n`;
            }
          });
          const desc = document.getElementById(`${typeName}_説明文`)?.value;
          if (desc) previewText += desc + '\n';
          previewText += '\n';
        }
      });

      preview.textContent = previewText.trim() || '割引情報が設定されていません';
    }

    /**
     * 割引設定をすべてクリア
     */
    function clearAllDiscounts() {
      if (!confirm('すべての割引設定をクリアしますか？')) {
        return;
      }

      // タイトルをデフォルトに戻す
      const select = document.getElementById('割引情報タイトル選択');
      const customInput = document.getElementById('割引情報タイトルカスタム');
      if (select) {
        select.value = '【お得な割引情報】';
      }
      if (customInput) {
        customInput.value = '';
        customInput.style.display = 'none';
      }

      // すべての割引タイプを削除
      const typesList = document.getElementById('discountTypesList');
      if (typesList) {
        typesList.innerHTML = '';
      }

      // プレビュー更新
      updateDiscountPreview();
    }

    /**
     * 配送デフォルト設定をすべてクリア
     */
    function clearShippingDefaults() {
      if (!confirm('配送デフォルト設定をすべてクリアしますか？')) {
        return;
      }

      // すべてのフィールドを空欄に戻す
      document.getElementById('配送料の負担').value = '';
      document.getElementById('配送の方法').value = '';
      document.getElementById('発送元の地域').value = '';
      document.getElementById('発送までの日数').value = '';
      document.getElementById('梱包資材デフォルト').value = '';

      alert('配送デフォルト設定をクリアしました。\n変更を保存するには「設定を保存」ボタンをクリックしてください。');
    }

    /**
     * 配送デフォルト設定を表示
     */
    function renderShippingDefaults(config) {
      document.getElementById('配送料の負担').value = config.配送料の負担 || '送料込み(出品者負担)';
      document.getElementById('配送の方法').value = config.配送の方法 || 'ゆうゆうメルカリ便';
      document.getElementById('発送元の地域').value = config.発送元の地域 || '岡山県';
      document.getElementById('発送までの日数').value = config.発送までの日数 || '1~2日で発送';
      document.getElementById('梱包資材デフォルト').value = config.梱包資材デフォルト || '';
    }

    /**
     * 管理番号設定を表示
     */
    function renderManagementConfig(config) {
      // 新しい管理番号ビルダーにデータをセット
      if (typeof ManagementNumberBuilder !== 'undefined' && config.segments) {
        ManagementNumberBuilder.setData(config);
      }

      // 配置設定を商品登録画面用のlocalStorageから読み込み（優先）
      let placementConfig = {
        showInTitle: false,
        showInDescription: false,
        titleFormat: '【】',
        titlePosition: 'end'
      };

      // まず、商品登録画面用のmanagementNumberPlacementから読み込む
      try {
        const savedPlacement = localStorage.getItem('managementNumberPlacement');
        if (savedPlacement) {
          const parsed = JSON.parse(savedPlacement);
          placementConfig = {
            showInTitle: parsed.inTitle !== undefined ? parsed.inTitle : false,
            showInDescription: parsed.inDesc !== undefined ? parsed.inDesc : false,
            titleFormat: parsed.format || '【】',
            titlePosition: parsed.position || 'end'
          };
          console.log('📦 managementNumberPlacementから読み込み:', placementConfig);
        } else {
          // managementNumberPlacementがない場合、rebornConfig_managementNumberから読み込む
          const savedConfig = localStorage.getItem(CONFIG_STORAGE_KEYS.MANAGEMENT_NUMBER);
          if (savedConfig) {
            const parsedConfig = JSON.parse(savedConfig);
            placementConfig = {
              showInTitle: parsedConfig.showInTitle !== undefined ? parsedConfig.showInTitle : false,
              showInDescription: parsedConfig.showInDescription !== undefined ? parsedConfig.showInDescription : false,
              titleFormat: parsedConfig.titleFormat || '【】',
              titlePosition: parsedConfig.titlePosition || 'end'
            };
            console.log('📦 rebornConfig_managementNumberから読み込み:', placementConfig);
          }
        }
      } catch (e) {
        console.error('localStorage読み込みエラー:', e);
      }

      // PropertiesServiceから読み込まれた値があれば、それで上書き
      if (config.showInTitle !== undefined) {
        placementConfig.showInTitle = config.showInTitle;
      }
      if (config.showInDescription !== undefined) {
        placementConfig.showInDescription = config.showInDescription;
      }
      if (config.titleFormat !== undefined) {
        placementConfig.titleFormat = config.titleFormat;
      }
      if (config.titlePosition !== undefined) {
        placementConfig.titlePosition = config.titlePosition;
      }
      if (config.descFormat !== undefined) {
        placementConfig.descFormat = config.descFormat;
      }
      if (config.descPosition !== undefined) {
        placementConfig.descPosition = config.descPosition;
      }

      // 管理番号の配置設定を表示
      const showInTitleCheckbox = document.getElementById('商品名に管理番号配置');
      const showInDescriptionCheckbox = document.getElementById('説明文に管理番号配置');
      const formatSelect = document.getElementById('管理番号形式');
      const positionSelect = document.getElementById('管理番号配置位置');
      const descFormatSelect = document.getElementById('説明文管理番号形式');
      const descPositionSelect = document.getElementById('説明文管理番号配置位置');

      console.log('📋 管理番号配置設定を読み込み:', placementConfig);

      if (showInTitleCheckbox) {
        showInTitleCheckbox.checked = placementConfig.showInTitle || false;
        console.log('✅ 商品名チェックボックス設定:', showInTitleCheckbox.checked);
      }
      if (showInDescriptionCheckbox) {
        showInDescriptionCheckbox.checked = placementConfig.showInDescription || false;
        console.log('✅ 説明文チェックボックス設定:', showInDescriptionCheckbox.checked);
      }
      if (formatSelect) {
        formatSelect.value = placementConfig.titleFormat || '【】';
        console.log('✅ 形式選択設定:', formatSelect.value);
      }
      if (positionSelect) {
        positionSelect.value = placementConfig.titlePosition || 'end';
        console.log('✅ 配置位置選択設定:', positionSelect.value);
      }
      if (descFormatSelect) {
        descFormatSelect.value = placementConfig.descFormat || '【】';
        console.log('✅ 説明文形式選択設定:', descFormatSelect.value);
      }
      if (descPositionSelect) {
        descPositionSelect.value = placementConfig.descPosition || 'bottom';
        console.log('✅ 説明文配置位置選択設定:', descPositionSelect.value);
      }

      // 形式選択の表示/非表示を更新
      toggleManagementNumberFormat();
      // 説明文の形式選択の表示/非表示も更新
      if (typeof toggleManagementNumberDescriptionFormat === 'function') {
        toggleManagementNumberDescriptionFormat();
      }
    }


    /**
     * デザインテーマを画面に反映
     * @param {string} theme - 'casual' または 'modern'
     */
    function renderDesignTheme(theme) {
      console.log('デザインテーマを読み込み:', theme);
      selectTheme(theme || 'casual');
    }

    /**
     * テーマを選択
     * @param {string} theme - 'casual' または 'modern'
     */
    function selectTheme(theme) {
      console.log('テーマ選択:', theme);

      // 隠しフィールドを更新
      const hiddenField = document.getElementById('selected-design-theme');
      if (hiddenField) {
        hiddenField.value = theme;
      }

      // カジュアルカード
      const casualCard = document.getElementById('theme-casual-card');
      const casualCheck = document.getElementById('theme-casual-check');

      // モダンカード
      const modernCard = document.getElementById('theme-modern-card');
      const modernCheck = document.getElementById('theme-modern-check');

      if (theme === 'casual') {
        // カジュアルを選択状態に
        casualCard.style.border = '3px solid #40B4E5';
        casualCard.style.background = 'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)';
        casualCheck.style.display = 'block';

        // モダンを非選択状態に
        modernCard.style.border = '3px solid #d1d5db';
        modernCard.style.background = '#ffffff';
        modernCheck.style.display = 'none';
      } else if (theme === 'modern') {
        // カジュアルを非選択状態に
        casualCard.style.border = '3px solid #d1d5db';
        casualCard.style.background = '#ffffff';
        casualCheck.style.display = 'none';

        // モダンを選択状態に
        modernCard.style.border = '3px solid #C9A961';
        modernCard.style.background = 'linear-gradient(135deg, #fefce8 0%, #fef3c7 100%)';
        modernCheck.style.display = 'block';
      }

      console.log('テーマ選択完了:', theme);
    }

    // ================= 設定管理モジュール（localStorage + PropertiesService ハイブリッド） =================

    /**
     * localStorageキー定義
     */
    const CONFIG_STORAGE_KEYS = {
      CONDITION_BUTTONS: 'rebornConfig_conditionButtons',
      HASHTAG: 'rebornConfig_hashtag',
      DISCOUNT: 'rebornConfig_discount',
      SHIPPING_DEFAULT: 'rebornConfig_shippingDefault',
      PROCURE_LISTING_DEFAULT: 'rebornConfig_procureListingDefault',
      MANAGEMENT_NUMBER: 'rebornConfig_managementNumber',
      SALESWORD: 'rebornConfig_salesword',
      AI_SETTINGS: 'rebornConfig_aiSettings',
      DESIGN_THEME: 'rebornTheme', // 既存
      IMAGE_SAVE: 'enableProductImageSave' // 既存
    };

    /**
     * 全設定をlocalStorageに保存
     */
    function saveConfigToLocalStorage(config) {
      console.log('📍 [DEBUG] saveConfigToLocalStorage - 現在のURL:', window.location.href);
      console.log('📍 [DEBUG] saveConfigToLocalStorage - オリジン:', window.location.origin);
      console.log('📍 [DEBUG] saveConfigToLocalStorage - 保存するデータ:', config);
      
      try {
        localStorage.setItem(CONFIG_STORAGE_KEYS.CONDITION_BUTTONS, JSON.stringify(config['商品状態ボタン']));
        localStorage.setItem(CONFIG_STORAGE_KEYS.HASHTAG, JSON.stringify(config['ハッシュタグ']));
        localStorage.setItem(CONFIG_STORAGE_KEYS.DISCOUNT, JSON.stringify(config['割引情報']));
        localStorage.setItem(CONFIG_STORAGE_KEYS.SHIPPING_DEFAULT, JSON.stringify(config['配送デフォルト']));
        localStorage.setItem(CONFIG_STORAGE_KEYS.PROCURE_LISTING_DEFAULT, JSON.stringify(config['仕入出品デフォルト']));
        localStorage.setItem(CONFIG_STORAGE_KEYS.MANAGEMENT_NUMBER, JSON.stringify(config['管理番号設定']));
        localStorage.setItem(CONFIG_STORAGE_KEYS.SALESWORD, JSON.stringify(config['よく使うセールスワード']));
        localStorage.setItem(CONFIG_STORAGE_KEYS.AI_SETTINGS, JSON.stringify(config['AI生成設定']));
        localStorage.setItem(CONFIG_STORAGE_KEYS.DESIGN_THEME, config['デザインテーマ']);

        console.log('✅ 全設定をlocalStorageに保存しました');
        
        // 🔍 保存直後に読み込みテスト
        console.log('🔍 [DEBUG] 保存直後の読み込みテスト開始...');
        const testRead = localStorage.getItem(CONFIG_STORAGE_KEYS.SALESWORD);
        if (testRead) {
          console.log('✅ [DEBUG] 保存直後の読み込み成功:', JSON.parse(testRead));
        } else {
          console.error('❌ [DEBUG] 保存直後なのに読み込み失敗！ localStorageに問題がある可能性');
        }
        
        return true;
      } catch (e) {
        console.error('❌ localStorage保存エラー:', e);
        return false;
      }
    }

    /**
     * 全設定をFirestoreに保存（PWA版からアクセス可能）
     */
    /**
     * 全設定をFirestoreに保存（GASサーバー経由でCORS回避）
     */
    function saveConfigToFirestore(config) {
      if (!window.db) {
        console.warn('⚠️ Firestoreが初期化されていません（localStorage のみ保存）');
        return Promise.resolve(false);
      }

      console.log('📤 Firestoreに設定を保存中...');

      return window.db.collection('settings').doc('common').set({
        conditionButtons: config['商品状態ボタン'] || [],
        hashtag: config['ハッシュタグ'] || {},
        discount: config['割引情報'] || {},
        shippingDefault: config['配送デフォルト'] || {},
        procureListingDefault: config['仕入出品デフォルト'] || {},
        managementNumber: config['管理番号設定'] || {},
        salesword: config['よく使うセールスワード'] || {},
        aiSettings: config['AI生成設定'] || {},
        designTheme: config['デザインテーマ'] || 'modern',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
              return true;
      })
      .catch((e) => {
        console.error('❌ Firestore保存エラー:', e);
        return false;
      });
    }

    /**
     * 設定変更を商品登録画面に通知（postMessage）
     */
    function notifyConfigChange() {
      try {
        // 全てのwindowに通知（親、兄弟iframe含む）
        if (window.parent) {
          window.parent.postMessage({
            type: 'configChanged',
            timestamp: new Date().getTime()
          }, '*');
        }

        if (window.top && window.top !== window.parent) {
          window.top.postMessage({
            type: 'configChanged',
            timestamp: new Date().getTime()
          }, '*');
        }

        // ★ 別タブ間通信用：BroadcastChannel で全タブに通知
        if ('BroadcastChannel' in window) {
          const channel = new BroadcastChannel('reborn_config_updates');
          channel.postMessage({
            type: 'configChanged',
            timestamp: new Date().getTime()
          });
          channel.close();
          console.log('📤 BroadcastChannelで全タブに設定変更を通知しました');
        } else {
          console.warn('⚠️ BroadcastChannel非対応（古いブラウザ）');
        }

        console.log('📤 設定変更をpostMessageで通知しました');
      } catch (e) {
        console.warn('postMessage送信エラー（無視しても問題ありません）:', e);
      }
    }

    /**
     * PropertiesServiceへの保存をリトライ機能付きで実行
     * PWA版では PropertiesService 保存は不要（Firestore を使用）
     */

    /**
     * 設定を保存
     */
    window.saveConfig = async function() {
      try {
        console.log('=== saveConfig 開始 ===');
        const managementConfig = collectManagementConfig();
        console.log('管理番号設定:', managementConfig);

        // 基本設定を保存
        await saveBasicSettings();

        // アイコン画像をアップロード（選択されている場合）
        if (pendingUserIconData) {
          await uploadUserIcon();
        }

      // 画像管理設定をLocalStorageに保存
      const imageCheckbox = document.getElementById('enableProductImageSave');
      let imageSettingMessage = '';
      if (imageCheckbox) {
        const imageEnabled = imageCheckbox.checked;
        localStorage.setItem('enableProductImageSave', imageEnabled.toString());
        console.log('💾 画像管理設定をLocalStorageに保存:', imageEnabled);

        // ステータステキストを更新
        const statusText = document.getElementById('imageSettingStatusText');
        if (statusText) {
          statusText.textContent = imageEnabled
            ? 'ON（商品画像ブロックが表示されます）'
            : 'OFF（商品画像ブロックは非表示）';
        }

        // アラートメッセージに追加
        imageSettingMessage = imageEnabled
          ? '\n\n📷 商品画像ブロック: ON → 商品登録画面に表示されます'
          : '\n\n📷 商品画像ブロック: OFF → 非表示になります';
      }

        console.log('Step 1: 商品状態ボタンを収集中...');
        const conditionButtons = collectConditionButtons();
        console.log('Step 2: ハッシュタグを収集中...');
        const hashtags = collectHashtagConfig();
        console.log('Step 3: 割引情報を収集中...');
        const discountInfo = collectDiscountConfig();
        console.log('Step 4: 配送デフォルトを収集中...');
        const shippingDefaults = collectShippingDefaults();
        console.log('Step 5: 仕入出品デフォルトを収集中...');
        const procureListingDefaults = collectProcureListingDefaults();
        console.log('Step 6: セールスワードを収集中...');
        const saleswords = collectSaleswordConfig();
        console.log('💾 [セールスワード] 収集結果:', saleswords);
        console.log('💾 [セールスワード] よく使う:', saleswords?.よく使う);
        console.log('💾 [セールスワード] 表示形式:', saleswords?.表示形式);
        console.log('💾 [セールスワード] デフォルト:', saleswords?.デフォルト);
        console.log('Step 7: AI生成設定を収集中...');
        const aiSettings = collectAiSettings();
        console.log('Step 8: デザインテーマを取得中...');
        const designThemeElement = document.getElementById('selected-design-theme');
        const designTheme = designThemeElement ? designThemeElement.value : '';

        const newConfig = {
          商品状態ボタン: conditionButtons,
          ハッシュタグ: hashtags,
          割引情報: discountInfo,
          配送デフォルト: shippingDefaults,
          仕入出品デフォルト: procureListingDefaults,
          管理番号設定: managementConfig,
          よく使うセールスワード: saleswords,
          AI生成設定: aiSettings,
          デザインテーマ: designTheme
        };

        console.log('Step 9: 設定オブジェクト作成完了');
        console.log('保存する設定全体:', newConfig);

        // 1. 即座にlocalStorageに保存（リロード不要で反映）
        console.log('Step 10: localStorageに保存中...');
        const localStorageSaved = saveConfigToLocalStorage(newConfig);

        // 2. Firestoreに保存（PWA版からアクセス可能）
        console.log('Step 11: Firestoreに保存中...');
        saveConfigToFirestore(newConfig).catch(err => {
          console.warn('⚠️ Firestore保存は失敗しましたが、localStorageには保存されました:', err);
        });

        // 3. postMessageで商品登録画面に通知（リロード不要で反映）
        console.log('Step 12: postMessage通知中...');
        notifyConfigChange();

        // 4. PWA版では PropertiesService 保存不要（Firestore + localStorage で完結）
        console.log('Step 13: PWA版では PropertiesService 保存不要');
        if (localStorageSaved) {
          alert('✅ 設定完了しました');
        } else {
          alert('❌ 設定の保存に失敗しました');
        }
      } catch (error) {
        console.error('❌❌❌ saveConfig エラー発生 ❌❌❌');
        console.error('エラー詳細:', error);
        console.error('エラーメッセージ:', error.message);
        console.error('エラースタック:', error.stack);
        alert('❌ 設定保存中にエラーが発生しました:\n\n' + error.message + '\n\nブラウザのコンソールを確認してください');
      }
    }

    /**
     * 商品状態ボタン設定を収集
     */
    function collectConditionButtons() {
      const buttons = [];
      CONDITION_STATES.forEach(state => {
        const container = document.getElementById(`condition-${state}`);
        Array.from(container.children).forEach((item, index) => {
          const labelSelect = item.querySelector('[data-field="label-select"]');
          const labelInput = item.querySelector('[data-field="label"]');
          const text = item.querySelector('[data-field="text"]').value;

          // プルダウンがカスタムまたは未選択の場合はinputから、それ以外はselectから取得
          let label = '';
          if (labelSelect && labelSelect.value === 'custom') {
            label = labelInput.value;
          } else if (labelSelect && labelSelect.value) {
            label = labelSelect.value;
          } else {
            label = labelInput.value;
          }

          if (label || text) {
            buttons.push({
              商品の状態: state,
              ボタンラベル: label,
              ボタンテキスト: text
            });
          }
        });
      });
      return buttons;
    }

    /**
     * 商品状態ボタンをすべてクリア
     */
    function clearConditionButtons() {
      if (!confirm('商品状態ボタン設定をすべてクリアしますか？\n\n全カテゴリのカスタムボタンが削除されます。')) {
        return;
      }

      // すべてのカテゴリのコンテナをクリア
      CONDITION_STATES.forEach(state => {
        const container = document.getElementById(`condition-${state}`);
        if (container) {
          container.innerHTML = '';
        }
      });

      alert('商品状態ボタン設定をクリアしました。\n変更を保存するには「設定を保存」ボタンをクリックしてください。');
    }

    /**
     * ハッシュタグ設定を収集
     */
    function collectHashtagConfig() {
      const container = document.getElementById('hashtagItemsContainer');
      const hashtags = [];

      // 保存時に # を自動で付ける
      const addHash = (value) => {
        const trimmed = (value || '').trim();
        if (!trimmed) return '';
        return trimmed.startsWith('#') ? trimmed : '#' + trimmed;
      };

      // 共通プレフィックスを取得
      const commonPrefix = addHash(document.getElementById('commonHashtagPrefix').value || '');

      Array.from(container.children).forEach(item => {
        const title = item.querySelector('.hashtag-title').value || '';
        const icon = item.querySelector('.hashtag-icon').value || '🏷️';
        const suffixSelect = item.querySelector('.hashtag-suffix-select');
        const suffixCustom = item.querySelector('.hashtag-suffix-custom');

        let suffix = '';
        if (suffixSelect.value === 'custom') {
          suffix = suffixCustom.value || '';
        } else {
          suffix = suffixSelect.value || '';
        }

        // サフィックスオプションを収集
        const suffixOptions = Array.from(suffixSelect.options)
          .filter(opt => opt.value !== 'custom')
          .map(opt => opt.value);

        // カテゴリオプションを収集（カテゴリハッシュタグの場合のみ）
        let categoryOptions = null;
        if (title === 'カテゴリ') {
          categoryOptions = [];
          const checkboxes = item.querySelectorAll('.category-option');
          checkboxes.forEach(cb => {
            if (cb.checked) {
              categoryOptions.push(cb.getAttribute('data-option'));
            }
          });
        }

        // タイトルが入力されている場合のみ保存
        if (title) {
          const hashtagData = {
            title: title,
            icon: icon,
            suffix: suffix,
            suffixOptions: suffixOptions
          };
          if (categoryOptions) {
            hashtagData.categoryOptions = categoryOptions;
          }
          hashtags.push(hashtagData);
        }
      });

      return {
        commonPrefix: commonPrefix,
        hashtags: hashtags
      };
    }

    /**
     * 割引情報設定を収集
     */
    function collectDiscountConfig() {
      const config = {};

      // タイトルを収集
      const select = document.getElementById('割引情報タイトル選択');
      const customInput = document.getElementById('割引情報タイトルカスタム');
      if (select) {
        if (select.value === 'custom') {
          config['タイトル'] = customInput?.value || '';
          config['タイトル選択'] = 'custom';
        } else {
          config['タイトル'] = select.value;
          config['タイトル選択'] = select.value;
        }
      }

      // 現在表示されている全ての割引タイプを収集
      const typesList = document.getElementById('discountTypesList');
      const discountGroups = typesList?.querySelectorAll('.discount-group') || [];
      const discountTypes = [];

      discountGroups.forEach(group => {
        const typeName = group.id.replace('Group', '');
        discountTypes.push(typeName);

        // アイコンを取得
        const iconElement = group.querySelector('strong');
        const iconText = iconElement?.textContent || '';
        const icon = iconText.split(' ')[0] || '💰'; // アイコン部分を抽出
        config[`${typeName}_アイコン`] = icon;

        // 範囲を収集
        config[typeName] = [];
        const container = document.getElementById(`${typeName}Container`);
        if (container) {
          Array.from(container.children).forEach(item => {
            const range = item.querySelector('[data-field="range"]')?.value || '';
            const amount = item.querySelector('[data-field="amount"]')?.value || '';
            if (range || amount) {
              config[typeName].push({ 範囲: range, 割引額: amount });
            }
          });
        }

        // 説明文を収集
        const descField = document.getElementById(`${typeName}_説明文`);
        if (descField) {
          config[`${typeName}_説明文`] = descField.value;
        }
      });

      // 割引タイプの順序を保存
      config['割引タイプ順序'] = discountTypes;

      return config;
    }

    /**
     * テキストエリアを自動リサイズ
     */
    function autoResizeTextarea(textarea) {
      // 高さをリセット
      textarea.style.height = 'auto';
      // スクロール高さに合わせる
      textarea.style.height = textarea.scrollHeight + 'px';
    }

    /**
     * 配送デフォルト設定を収集
     */
    function collectShippingDefaults() {
      return {
        配送料の負担: document.getElementById('配送料の負担').value,
        配送の方法: document.getElementById('配送の方法').value,
        発送元の地域: document.getElementById('発送元の地域').value,
        発送までの日数: document.getElementById('発送までの日数').value,
        梱包資材デフォルト: document.getElementById('梱包資材デフォルト').value
      };
    }

    /**
     * 管理番号設定を収集
     */
    function collectManagementConfig() {
      // 新しい管理番号ビルダーからデータを取得
      try {
        if (typeof ManagementNumberBuilder !== 'undefined' && ManagementNumberBuilder) {
          const data = ManagementNumberBuilder.getData();
          console.log('ManagementNumberBuilderからデータ取得:', data);

          // 管理番号の配置設定も追加
          const showInTitle = document.getElementById('商品名に管理番号配置');
          const showInDescription = document.getElementById('説明文に管理番号配置');
          const format = document.getElementById('管理番号形式');
          const position = document.getElementById('管理番号配置位置');
          const descFormat = document.getElementById('説明文管理番号形式');
          const descPosition = document.getElementById('説明文管理番号配置位置');

          console.log('📝 管理番号配置設定を収集（保存前）:', {
            showInTitleElement: showInTitle,
            showInTitleChecked: showInTitle ? showInTitle.checked : null,
            showInDescriptionElement: showInDescription,
            showInDescriptionChecked: showInDescription ? showInDescription.checked : null,
            formatElement: format,
            formatValue: format ? format.value : null,
            positionElement: position,
            positionValue: position ? position.value : null,
            descFormatElement: descFormat,
            descFormatValue: descFormat ? descFormat.value : null,
            descPositionElement: descPosition,
            descPositionValue: descPosition ? descPosition.value : null
          });

          data.showInTitle = showInTitle ? showInTitle.checked : false;
          data.showInDescription = showInDescription ? showInDescription.checked : false;
          data.titleFormat = format ? format.value : '【】';
          data.titlePosition = position ? position.value : 'end';
          data.descFormat = descFormat ? descFormat.value : '【】';
          data.descPosition = descPosition ? descPosition.value : 'bottom';

          console.log('💾 管理番号の配置設定（保存データ）:', {
            showInTitle: data.showInTitle,
            showInDescription: data.showInDescription,
            titleFormat: data.titleFormat,
            titlePosition: data.titlePosition,
            descFormat: data.descFormat,
            descPosition: data.descPosition
          });

          // 商品登録画面用のlocalStorageにも保存（互換性のため）
          try {
            const placementSettings = {
              inTitle: data.showInTitle,
              inDesc: data.showInDescription,
              format: data.titleFormat,
              position: data.titlePosition,
              descFormat: data.descFormat,
              descPosition: data.descPosition
            };
            localStorage.setItem('managementNumberPlacement', JSON.stringify(placementSettings));
            console.log('✅ managementNumberPlacementにも保存:', placementSettings);
          } catch (e) {
            console.error('managementNumberPlacement保存エラー:', e);
          }

          return data;
        } else {
          console.warn('ManagementNumberBuilderが未定義です');
          return { segments: [] };
        }
      } catch (e) {
        console.error('collectManagementConfig エラー:', e);
        return { segments: [] };
      }
    }

    // ========================================
    // セールスワード設定
    // ========================================

    let SALESWORD_LIST = [];

    /**
     * セールスワードリストを表示（読み取り専用 + 削除ボタン）
     */
    function renderSaleswordList() {
      const container = document.getElementById('saleswordList');
      if (!container) return;

      container.innerHTML = '';

      // SALESWORD_LISTが配列であることを保証
      if (!Array.isArray(SALESWORD_LIST)) {
        console.warn('SALESWORD_LISTが配列ではありません。空配列に初期化します。', SALESWORD_LIST);
        SALESWORD_LIST = [];
      }

      if (SALESWORD_LIST.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 16px; font-size: 13px;">登録されているセールスワードはありません</div>';
        return;
      }

      SALESWORD_LIST.forEach((word, index) => {
        const item = document.createElement('div');
        item.style.display = 'flex';
        item.style.alignItems = 'center';
        item.style.gap = '8px';
        item.style.padding = '8px';
        item.style.background = 'white';
        item.style.border = '1px solid #e5e7eb';
        item.style.borderRadius = '6px';
        item.style.marginBottom = '8px';

        item.innerHTML = `
          <span style="color: #6c757d; font-size: 12px; min-width: 30px;">${index + 1}.</span>
          <span style="flex: 1; font-size: 13px; color: #374151;">${word}</span>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSalesword(${index})" style="font-size: 11px; padding: 4px 12px;">削除</button>
        `;

        container.appendChild(item);
      });
    }

    /**
     * セールスワードを削除
     */
    function removeSalesword(index) {
      SALESWORD_LIST.splice(index, 1);
      renderSaleswordList();
    }

    /**
     * セールスワードマスタデータ（グローバル変数）
     */
    let SALESWORD_MASTER = {};

    /**
     * セールスワードマスタデータを読み込み
     */
    async function loadSaleswordMasterData() {
      try {
        console.log('[Config] セールスワードマスタ読み込み開始');

        if (!window.db) {
          console.error('[Config] Firestoreが初期化されていません、空データで初期化');
          SALESWORD_MASTER = {};
          initSaleswordDropdowns();
          return;
        }

        const snapshot = await window.db.collection('saleswords').orderBy('order').get();

        if (snapshot.empty) {
          console.warn('[Config] セールスワードデータが存在しません、空データで初期化');
          SALESWORD_MASTER = {};
          initSaleswordDropdowns();
          return;
        }

        // カテゴリ → ワード配列の形式で格納
        const result = {};
        snapshot.forEach(doc => {
          const data = doc.data();
          result[data.category] = data.words || [];
        });

        SALESWORD_MASTER = result;
        console.log('[Config] セールスワードマスタ読み込み成功');
        console.log('カテゴリ数:', Object.keys(result).length);

        initSaleswordDropdowns();

      } catch (error) {
        console.error('[Config] セールスワード読み込みエラー:', error);
        SALESWORD_MASTER = {};
        initSaleswordDropdowns();
      }
    }

    /**
     * 2段式プルダウンを初期化
     */
    function initSaleswordDropdowns() {
      const categorySelect = document.getElementById('saleswordCategorySelect');
      if (!categorySelect || !SALESWORD_MASTER) return;

      categorySelect.innerHTML = '<option value="">--選択--</option>';

      // ⭐よく使うワードはFirestoreには無いので表示しない（3️⃣は「よく使う」リストに追加する機能）
      Object.keys(SALESWORD_MASTER).sort().forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
      });

      // デフォルトセールスワードのプルダウン初期化は loadSaleswordConfig() で実行
      // （window.CACHED_CONFIG が必要なため、ここでは呼ばない）
    }

    /**
     * カテゴリ選択時にセールスワードプルダウンを更新
     */
    function updateSaleswordOptions() {
      const categorySelect = document.getElementById('saleswordCategorySelect');
      const saleswordSelect = document.getElementById('saleswordSelect');

      if (!categorySelect || !saleswordSelect) return;

      const category = categorySelect.value;
      saleswordSelect.innerHTML = '<option value="">--選択--</option>';

      if (!category || !SALESWORD_MASTER[category]) {
        saleswordSelect.disabled = true;
        return;
      }

      SALESWORD_MASTER[category].forEach(word => {
        const option = document.createElement('option');
        option.value = word;
        option.textContent = word;
        saleswordSelect.appendChild(option);
      });

      saleswordSelect.disabled = false;
    }

    /**
     * プルダウンからセールスワードを追加
     */
    function addSaleswordFromDropdown() {
      const saleswordSelect = document.getElementById('saleswordSelect');
      if (!saleswordSelect) return;

      const word = saleswordSelect.value.trim();
      if (!word) {
        alert('セールスワードを選択してください');
        return;
      }

      // 重複チェック
      if (SALESWORD_LIST.includes(word)) {
        alert('このセールスワードは既に登録されています');
        return;
      }

      SALESWORD_LIST.push(word);  // 配列の末尾に追加（追加した順に表示される）
      renderSaleswordList();

      // プルダウンをリセット
      document.getElementById('saleswordCategorySelect').value = '';
      saleswordSelect.value = '';
      saleswordSelect.disabled = true;
    }

    /**
     * セールスワード設定を収集
     */
    function collectSaleswordConfig() {
      // SALESWORD_LISTが配列であることを保証
      const saleswordList = Array.isArray(SALESWORD_LIST) ? SALESWORD_LIST : [];

      const result = {
        よく使う: saleswordList.filter(word => word.trim() !== ''),
        表示形式: collectSaleswordFormat(),
        デフォルト: collectDefaultSalesword()
      };
      console.log('collectSaleswordConfig 結果:', result);
      return result;
    }

    /**
     * デフォルトセールスワード設定を収集
     */
    function collectDefaultSalesword() {
      const category = document.getElementById('defaultSaleswordCategory')?.value || '';
      const salesword = document.getElementById('defaultSalesword')?.value || '';

      console.log('[collectDefaultSalesword] カテゴリ:', category);
      console.log('[collectDefaultSalesword] セールスワード:', salesword);

      return {
        カテゴリ: category,
        セールスワード: salesword
      };
    }

    /**
     * デフォルトセールスワードのカテゴリプルダウンを初期化
     */
    function initDefaultSaleswordDropdowns() {
      const categorySelect = document.getElementById('defaultSaleswordCategory');
      if (!categorySelect || !SALESWORD_MASTER) return;

      categorySelect.innerHTML = '<option value="">--選択--</option>';

      // ⭐よく使うワードをCACHED_CONFIGから追加
      if (window.CACHED_CONFIG && window.CACHED_CONFIG['よく使うセールスワード']) {
        const saleswordConfig = window.CACHED_CONFIG['よく使うセールスワード'];
        const frequentWords = saleswordConfig.よく使う || [];

        if (frequentWords.length > 0) {
          const option = document.createElement('option');
          option.value = '⭐よく使うワード';
          option.textContent = '⭐よく使うワード';
          categorySelect.appendChild(option);

          // SALESWORD_MASTERにも追加
          SALESWORD_MASTER['⭐よく使うワード'] = frequentWords;
        }
      }

      Object.keys(SALESWORD_MASTER).sort().forEach(category => {
        // ⭐よく使うワードは既に追加済みなのでスキップ
        if (category === '⭐よく使うワード') return;

        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
      });
    }

    /**
     * デフォルトセールスワードのカテゴリ選択時にセールスワードプルダウンを更新
     */
    function updateDefaultSaleswordOptions() {
      const categorySelect = document.getElementById('defaultSaleswordCategory');
      const saleswordSelect = document.getElementById('defaultSalesword');

      if (!categorySelect || !saleswordSelect) return;

      const category = categorySelect.value;
      saleswordSelect.innerHTML = '<option value="">--選択--</option>';

      if (!category || !SALESWORD_MASTER[category]) {
        saleswordSelect.disabled = true;
        return;
      }

      SALESWORD_MASTER[category].forEach(word => {
        const option = document.createElement('option');
        option.value = word;
        option.textContent = word;
        saleswordSelect.appendChild(option);
      });

      saleswordSelect.disabled = false;
    }

    /**
     * デフォルトセールスワード設定を画面に反映
     */
    function renderDefaultSalesword(config) {
      console.log('[renderDefaultSalesword] 実行開始');
      console.log('[renderDefaultSalesword] config:', config);

      if (!config || !config.デフォルト) {
        console.warn('[renderDefaultSalesword] デフォルト設定が見つかりません');
        return;
      }

      const defaultConfig = config.デフォルト;
      console.log('[renderDefaultSalesword] デフォルト設定:', defaultConfig);

      const categorySelect = document.getElementById('defaultSaleswordCategory');
      const saleswordSelect = document.getElementById('defaultSalesword');

      if (!categorySelect || !saleswordSelect) {
        console.error('[renderDefaultSalesword] プルダウン要素が見つかりません');
        return;
      }

      // カテゴリを設定
      if (defaultConfig.カテゴリ) {
        categorySelect.value = defaultConfig.カテゴリ;
        console.log('[renderDefaultSalesword] カテゴリ設定:', defaultConfig.カテゴリ);
        // セールスワードプルダウンを更新
        updateDefaultSaleswordOptions();

        // セールスワードを設定（プルダウン更新後に設定）
        setTimeout(() => {
          if (defaultConfig.セールスワード) {
            saleswordSelect.value = defaultConfig.セールスワード;
            console.log('[renderDefaultSalesword] セールスワード設定:', defaultConfig.セールスワード);
            console.log('[renderDefaultSalesword] ✅ デフォルトセールスワード復元完了');
          }
        }, 100);
      }
    }

    // ========================================
    // セールスワード表示形式設定
    // ========================================

    let WORD_OVERRIDES = [];

    /**
     * 前に付ける文字のプルダウン変更時
     */
    function handlePrefixChange() {
      const select = document.getElementById('saleswordPrefixGlobalSelect');
      const customInput = document.getElementById('saleswordPrefixGlobalCustom');

      if (select.value === 'custom') {
        customInput.style.display = 'block';
      } else {
        customInput.style.display = 'none';
        customInput.value = '';
      }

      updateSaleswordFormatPreview();
    }

    /**
     * 後ろに付ける文字のプルダウン変更時
     */
    function handleSuffixChange() {
      const select = document.getElementById('saleswordSuffixGlobalSelect');
      const customInput = document.getElementById('saleswordSuffixGlobalCustom');

      if (select.value === 'custom') {
        customInput.style.display = 'block';
      } else {
        customInput.style.display = 'none';
        customInput.value = '';
      }

      updateSaleswordFormatPreview();
    }

    /**
     * プレビューを更新
     */
    function updateSaleswordFormatPreview() {
      const prefixSelect = document.getElementById('saleswordPrefixGlobalSelect');
      const prefixCustom = document.getElementById('saleswordPrefixGlobalCustom');
      const suffixSelect = document.getElementById('saleswordSuffixGlobalSelect');
      const suffixCustom = document.getElementById('saleswordSuffixGlobalCustom');

      let prefix = '';
      let suffix = '';

      if (prefixSelect.value === 'custom') {
        prefix = prefixCustom.value || '';
      } else {
        prefix = prefixSelect.value || '';
      }

      if (suffixSelect.value === 'custom') {
        suffix = suffixCustom.value || '';
      } else {
        suffix = suffixSelect.value || '';
      }

      const preview = document.getElementById('saleswordFormatPreview');
      if (preview) {
        preview.textContent = `${prefix}美品${suffix}`;
      }
    }

    /**
     * ワード別設定を追加
     */
    function addWordOverride() {
      WORD_OVERRIDES.push({
        word: '',
        prefix: '',
        suffix: ''
      });
      renderWordOverrides();
    }

    /**
     * ワード別設定を削除
     */
    function removeWordOverride(index) {
      WORD_OVERRIDES.splice(index, 1);
      renderWordOverrides();
    }

    /**
     * ワード別設定を更新
     */
    function updateWordOverride(index, field, value) {
      WORD_OVERRIDES[index][field] = value;
    }

    /**
     * ワード別設定の前に付ける文字プルダウン変更時
     */
    function handleWordPrefixChange(index) {
      const select = document.getElementById(`wordPrefixSelect_${index}`);
      const customInput = document.getElementById(`wordPrefixCustom_${index}`);

      if (select.value === 'custom') {
        customInput.style.display = 'block';
      } else {
        customInput.style.display = 'none';
        customInput.value = '';
      }

      updateWordOverrideFromInput(index);
    }

    /**
     * ワード別設定の後ろに付ける文字プルダウン変更時
     */
    function handleWordSuffixChange(index) {
      const select = document.getElementById(`wordSuffixSelect_${index}`);
      const customInput = document.getElementById(`wordSuffixCustom_${index}`);

      if (select.value === 'custom') {
        customInput.style.display = 'block';
      } else {
        customInput.style.display = 'none';
        customInput.value = '';
      }

      updateWordOverrideFromInput(index);
    }

    /**
     * ワード別設定の入力フィールドから値を更新
     */
    function updateWordOverrideFromInput(index) {
      const prefixSelect = document.getElementById(`wordPrefixSelect_${index}`);
      const prefixCustom = document.getElementById(`wordPrefixCustom_${index}`);
      const suffixSelect = document.getElementById(`wordSuffixSelect_${index}`);
      const suffixCustom = document.getElementById(`wordSuffixCustom_${index}`);

      let prefix = '';
      let suffix = '';

      if (prefixSelect && prefixSelect.value === 'custom') {
        prefix = prefixCustom ? (prefixCustom.value || '').trim() : '';
      } else if (prefixSelect) {
        prefix = (prefixSelect.value || '').trim();
      }

      if (suffixSelect && suffixSelect.value === 'custom') {
        suffix = suffixCustom ? (suffixCustom.value || '').trim() : '';
      } else if (suffixSelect) {
        suffix = (suffixSelect.value || '').trim();
      }

      WORD_OVERRIDES[index].prefix = prefix;
      WORD_OVERRIDES[index].suffix = suffix;
    }

    /**
     * ワード別設定をレンダリング
     */
    function renderWordOverrides() {
      const container = document.getElementById('wordOverrideList');
      if (!container) return;

      container.innerHTML = '';

      WORD_OVERRIDES.forEach((override, index) => {
        const item = document.createElement('div');
        item.style.background = '#f8f9fa';
        item.style.padding = '12px';
        item.style.borderRadius = '6px';
        item.style.marginBottom = '8px';
        item.style.border = '1px solid #dee2e6';

        // プルダウンの選択肢を作成（前と後ろで分ける）
        const prefixSelectOptions = `
          <option value="">なし</option>
          <option value="【">【</option>
          <option value="『">『</option>
          <option value="「">「</option>
          <option value="（">（</option>
          <option value="｜">｜</option>
          <option value="★">★</option>
          <option value="☆">☆</option>
          <option value="◆">◆</option>
          <option value="●">●</option>
          <option value="■">■</option>
          <option value="♡">♡</option>
          <option value="✨">✨</option>
          <option value="※">※</option>
          <option value="custom">カスタム入力</option>
        `;

        const suffixSelectOptions = `
          <option value="">なし</option>
          <option value="】">】</option>
          <option value="』">』</option>
          <option value="」">」</option>
          <option value="）">）</option>
          <option value="｜">｜</option>
          <option value="！">！</option>
          <option value="★">★</option>
          <option value="☆">☆</option>
          <option value="◆">◆</option>
          <option value="●">●</option>
          <option value="■">■</option>
          <option value="♡">♡</option>
          <option value="✨">✨</option>
          <option value="※">※</option>
          <option value="custom">カスタム入力</option>
        `;

        // 前に付ける文字の初期値を判定
        const prefixValue = override.prefix || '';
        const prefixIsCustom = prefixValue && !['', '【', '『', '「', '（', '｜', '★', '☆', '◆', '●', '■', '♡', '✨', '※'].includes(prefixValue);
        const prefixSelectValue = prefixIsCustom ? 'custom' : prefixValue;

        // 後ろに付ける文字の初期値を判定
        const suffixValue = override.suffix || '';
        const suffixIsCustom = suffixValue && !['', '】', '』', '」', '）', '｜', '！', '★', '☆', '◆', '●', '■', '♡', '✨', '※'].includes(suffixValue);
        const suffixSelectValue = suffixIsCustom ? 'custom' : suffixValue;

        item.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span style="font-size: 13px; font-weight: 500;">設定 ${index + 1}</span>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeWordOverride(${index})">削除</button>
          </div>
          <div style="margin-bottom: 8px;">
            <label style="font-size: 12px; margin-bottom: 4px; display: block;">セールスワード</label>
            <input type="text" class="form-control form-control-sm" value="${override.word || ''}"
                   onchange="updateWordOverride(${index}, 'word', this.value)"
                   placeholder="例: 匿名配送">
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <div>
              <label style="font-size: 12px; margin-bottom: 4px; display: block;">前に付ける文字</label>
              <select id="wordPrefixSelect_${index}" class="form-select form-select-sm" onchange="handleWordPrefixChange(${index})" style="margin-bottom: 4px;">
                ${prefixSelectOptions}
              </select>
              <input type="text" id="wordPrefixCustom_${index}" class="form-control form-control-sm"
                     value="${prefixIsCustom ? prefixValue : ''}"
                     onchange="updateWordOverrideFromInput(${index})"
                     placeholder="カスタム入力" maxlength="5"
                     style="display: ${prefixIsCustom ? 'block' : 'none'};">
            </div>
            <div>
              <label style="font-size: 12px; margin-bottom: 4px; display: block;">後ろに付ける文字</label>
              <select id="wordSuffixSelect_${index}" class="form-select form-select-sm" onchange="handleWordSuffixChange(${index})" style="margin-bottom: 4px;">
                ${suffixSelectOptions}
              </select>
              <input type="text" id="wordSuffixCustom_${index}" class="form-control form-control-sm"
                     value="${suffixIsCustom ? suffixValue : ''}"
                     onchange="updateWordOverrideFromInput(${index})"
                     placeholder="カスタム入力" maxlength="5"
                     style="display: ${suffixIsCustom ? 'block' : 'none'};">
            </div>
          </div>
        `;

        container.appendChild(item);

        // プルダウンの値を設定
        const prefixSelect = document.getElementById(`wordPrefixSelect_${index}`);
        const suffixSelect = document.getElementById(`wordSuffixSelect_${index}`);
        if (prefixSelect) prefixSelect.value = prefixSelectValue;
        if (suffixSelect) suffixSelect.value = suffixSelectValue;
      });
    }

    /**
     * セールスワード表示形式設定を収集
     */
    function collectSaleswordFormat() {
      const prefixSelect = document.getElementById('saleswordPrefixGlobalSelect');
      const prefixCustom = document.getElementById('saleswordPrefixGlobalCustom');
      const suffixSelect = document.getElementById('saleswordSuffixGlobalSelect');
      const suffixCustom = document.getElementById('saleswordSuffixGlobalCustom');

      let prefix = '';
      let suffix = '';

      if (prefixSelect && prefixSelect.value === 'custom') {
        prefix = prefixCustom ? (prefixCustom.value || '').trim() : '';
      } else if (prefixSelect) {
        prefix = (prefixSelect.value || '').trim();
      }

      if (suffixSelect && suffixSelect.value === 'custom') {
        suffix = suffixCustom ? (suffixCustom.value || '').trim() : '';
      } else if (suffixSelect) {
        suffix = (suffixSelect.value || '').trim();
      }

      // ワード別設定の最新値を収集
      WORD_OVERRIDES.forEach((override, index) => {
        updateWordOverrideFromInput(index);
      });

      const result = {
        globalPrefix: prefix,
        globalSuffix: suffix,
        wordOverrides: WORD_OVERRIDES.filter(o => o.word.trim() !== '')
      };

      console.log('collectSaleswordFormat 結果:', result);
      return result;
    }

    /**
     * セールスワード表示形式設定を読み込み
     */
    function renderSaleswordFormat(config) {
      console.log('renderSaleswordFormat 受信データ:', config);

      if (!config) config = { globalPrefix: '【', globalSuffix: '】', wordOverrides: [] };

      // 旧データ（categoryOverrides）から新データ（wordOverrides）への変換
      if (config.categoryOverrides && !config.wordOverrides) {
        config.wordOverrides = [];
      }

      const prefixSelect = document.getElementById('saleswordPrefixGlobalSelect');
      const prefixCustom = document.getElementById('saleswordPrefixGlobalCustom');
      const suffixSelect = document.getElementById('saleswordSuffixGlobalSelect');
      const suffixCustom = document.getElementById('saleswordSuffixGlobalCustom');

      console.log('prefix設定値:', config.globalPrefix, 'suffix設定値:', config.globalSuffix);

      // 前に付ける文字を設定
      const prefix = config.globalPrefix || '【';
      const prefixOption = Array.from(prefixSelect.options).find(opt => opt.value === prefix);

      console.log('prefix:', prefix, 'prefixOption:', prefixOption);

      if (prefixOption && prefix !== '') {
        prefixSelect.value = prefix;
        prefixCustom.style.display = 'none';
        prefixCustom.value = '';
        console.log('prefixをプルダウンに設定:', prefix);
      } else if (prefix === '') {
        prefixSelect.value = '';
        prefixCustom.style.display = 'none';
        prefixCustom.value = '';
        console.log('prefixを空に設定');
      } else {
        prefixSelect.value = 'custom';
        prefixCustom.style.display = 'block';
        prefixCustom.value = prefix;
        console.log('prefixをカスタム入力に設定:', prefix);
      }

      // 後ろに付ける文字を設定
      const suffix = config.globalSuffix || '】';
      const suffixOption = Array.from(suffixSelect.options).find(opt => opt.value === suffix);

      console.log('suffix:', suffix, 'suffixOption:', suffixOption);

      if (suffixOption && suffix !== '') {
        suffixSelect.value = suffix;
        suffixCustom.style.display = 'none';
        suffixCustom.value = '';
        console.log('suffixをプルダウンに設定:', suffix);
      } else if (suffix === '') {
        suffixSelect.value = '';
        suffixCustom.style.display = 'none';
        suffixCustom.value = '';
        console.log('suffixを空に設定');
      } else {
        suffixSelect.value = 'custom';
        suffixCustom.style.display = 'block';
        suffixCustom.value = suffix;
        console.log('suffixをカスタム入力に設定:', suffix);
      }

      // ワード別設定
      WORD_OVERRIDES = config.wordOverrides || [];
      renderWordOverrides();

      // プレビュー更新
      updateSaleswordFormatPreview();
    }

    /**
     * セールスワード設定を読み込み
     */
    function loadSaleswordConfig() {
      // PWA版では Firestore から読み込み
      // 暫定: localStorage から読み込み（個別キーから読み込み）
      const saleswordConfigStr = localStorage.getItem('rebornConfig_salesword');
      const saleswordConfig = saleswordConfigStr ? JSON.parse(saleswordConfigStr) : null;

      console.log('[loadSaleswordConfig] rebornConfig_salesword:', saleswordConfig);

      // CACHED_CONFIGをグローバルに設定（product-scripts.jsと同じ）
      if (!window.CACHED_CONFIG) {
        window.CACHED_CONFIG = {};
      }
      window.CACHED_CONFIG['よく使うセールスワード'] = saleswordConfig;

      // デフォルトセールスワードプルダウンを初期化（⭐よく使うワード追加のため）
      // ※ window.CACHED_CONFIG 設定後に必ず実行
      initDefaultSaleswordDropdowns();

      // よく使うセールスワード（リスト）
      if (saleswordConfig) {
        if (saleswordConfig.よく使う) {
          SALESWORD_LIST = saleswordConfig.よく使う;
          renderSaleswordList();
          console.log('[loadSaleswordConfig] よく使うワード読み込み:', SALESWORD_LIST);
        }

        // デフォルトセールスワード
        if (saleswordConfig.デフォルト) {
          renderDefaultSalesword(saleswordConfig);
          console.log('[loadSaleswordConfig] デフォルト読み込み:', saleswordConfig.デフォルト);
        }

        // 表示形式
        if (saleswordConfig.表示形式) {
          renderSaleswordFormat(saleswordConfig.表示形式);
          console.log('[loadSaleswordConfig] 表示形式読み込み:', saleswordConfig.表示形式);
        }
      }
    }

    /**
     * セールスワード設定をすべてクリア
     */
    function clearAllSaleswordSettings() {
      if (!confirm('セールスワード設定をすべてクリアしますか？\n\n・グローバル設定がデフォルト値（【】）に戻ります\n・ワード別設定がすべて削除されます')) {
        return;
      }

      // グローバル設定をデフォルト値に戻す
      const prefixSelect = document.getElementById('saleswordPrefixGlobalSelect');
      const prefixCustom = document.getElementById('saleswordPrefixGlobalCustom');
      const suffixSelect = document.getElementById('saleswordSuffixGlobalSelect');
      const suffixCustom = document.getElementById('saleswordSuffixGlobalCustom');

      if (prefixSelect) {
        prefixSelect.value = '【';
        prefixCustom.style.display = 'none';
        prefixCustom.value = '';
      }

      if (suffixSelect) {
        suffixSelect.value = '】';
        suffixCustom.style.display = 'none';
        suffixCustom.value = '';
      }

      // ワード別設定をすべて削除
      WORD_OVERRIDES = [];
      renderWordOverrides();

      // プレビュー更新
      updateSaleswordFormatPreview();

      console.log('セールスワード設定をクリアしました');
    }

    // ========================================
    // 仕入・出品デフォルト設定
    // ========================================

    /**
     * 仕入・出品のプルダウンを初期化（キャッシュ優先 → サーバー更新）
     */
    function initProcureListingDropdowns() {
      console.log('🚀 仕入・出品プルダウン初期化開始');
      
      // 仕入先プルダウンを初期化
      const procureSelect = document.getElementById('デフォルト仕入先');
      if (procureSelect) {
        // Step 1: キャッシュから即座に初期化
        try {
          const cached = localStorage.getItem('masterData_仕入先');
          if (cached) {
            const options = JSON.parse(cached);
            console.log('✅ 仕入先キャッシュから読み込み:', options.length, '件');
            populateSelect(procureSelect, options);
            
            // 設定値を適用
            const savedConfig = localStorage.getItem('rebornConfig_procureListingDefault');
            if (savedConfig) {
              const config = JSON.parse(savedConfig);
              if (config.デフォルト仕入先) {
                procureSelect.value = config.デフォルト仕入先;
                console.log('✅ デフォルト仕入先を設定しました（キャッシュ）:', config.デフォルト仕入先);
              }
            }
          } else {
            console.log('⚠️ 仕入先キャッシュなし、サーバーから取得します');
          }
        } catch (e) {
          console.error('❌ 仕入先キャッシュ読み込みエラー:', e);
        }
        
        // PWA版では Firestore から取得（未実装）
        // 暫定: localStorage のキャッシュのみ使用
      }

      // 出品先プルダウンを初期化
      const listingSelect = document.getElementById('デフォルト出品先');
      if (listingSelect) {
        // Step 1: キャッシュから即座に初期化
        try {
          const cached = localStorage.getItem('masterData_出品先');
          if (cached) {
            const options = JSON.parse(cached);
            console.log('✅ 出品先キャッシュから読み込み:', options.length, '件');
            populateSelect(listingSelect, options);
            
            // 設定値を適用
            const savedConfig = localStorage.getItem('rebornConfig_procureListingDefault');
            if (savedConfig) {
              const config = JSON.parse(savedConfig);
              if (config.デフォルト出品先) {
                listingSelect.value = config.デフォルト出品先;
                console.log('✅ デフォルト出品先を設定しました（キャッシュ）:', config.デフォルト出品先);
              }
            }
          } else {
            console.log('⚠️ 出品先キャッシュなし、サーバーから取得します');
          }
        } catch (e) {
          console.error('❌ 出品先キャッシュ読み込みエラー:', e);
        }
        
        // PWA版では Firestore から取得（未実装）
        // 暫定: localStorage のキャッシュのみ使用
      }
    }

    /**
     * selectタグにoptionを追加するヘルパー関数
     */
    function populateSelect(selectElement, options) {
      selectElement.innerHTML = '<option value="">-- 選択してください --</option>';
      options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        selectElement.appendChild(option);
      });
    }

    /**
     * 仕入日の「常に今日」チェックボックス切り替え時の処理
     */
    function toggleProcureDateField() {
      const checkbox = document.getElementById('仕入日_今日');
      const dateField = document.getElementById('デフォルト仕入日');
      if (checkbox && dateField) {
        dateField.disabled = checkbox.checked;
        if (checkbox.checked) {
          dateField.style.background = '#f3f4f6';
          dateField.style.cursor = 'not-allowed';
        } else {
          dateField.style.background = 'white';
          dateField.style.cursor = 'pointer';
        }
      }
    }

    /**
     * 出品日の「常に今日」チェックボックス切り替え時の処理
     */
    function toggleListingDateField() {
      const checkbox = document.getElementById('出品日_今日');
      const dateField = document.getElementById('デフォルト出品日');
      if (checkbox && dateField) {
        dateField.disabled = checkbox.checked;
        if (checkbox.checked) {
          dateField.style.background = '#f3f4f6';
          dateField.style.cursor = 'not-allowed';
        } else {
          dateField.style.background = 'white';
          dateField.style.cursor = 'pointer';
        }
      }
    }

    /**
     * 仕入・出品デフォルト設定を表示
     */
    function renderProcureListingDefaults(config) {
      console.log('仕入・出品デフォルト設定を表示:', config);

      // 仕入日_今日チェックボックス
      const procureTodayCheckbox = document.getElementById('仕入日_今日');
      if (procureTodayCheckbox) {
        procureTodayCheckbox.checked = config.仕入日_今日 === true;
      }

      // デフォルト仕入日
      const procureDate = document.getElementById('デフォルト仕入日');
      if (procureDate) {
        procureDate.value = config.デフォルト仕入日 || '';
      }

      // デフォルト仕入先（キャッシュがあれば即座に設定可能）
      const procureSource = document.getElementById('デフォルト仕入先');
      if (procureSource) {
        procureSource.value = config.デフォルト仕入先 || '';
        if (config.デフォルト仕入先) {
          console.log('✅ デフォルト仕入先を設定しました（renderProcureListingDefaults）:', config.デフォルト仕入先);
        }
      }

      // 出品日_今日チェックボックス
      const listingTodayCheckbox = document.getElementById('出品日_今日');
      if (listingTodayCheckbox) {
        listingTodayCheckbox.checked = config.出品日_今日 === true;
      }

      // デフォルト出品日
      const listingDate = document.getElementById('デフォルト出品日');
      if (listingDate) {
        listingDate.value = config.デフォルト出品日 || '';
      }

      // デフォルト出品先（キャッシュがあれば即座に設定可能）
      const listingDest = document.getElementById('デフォルト出品先');
      if (listingDest) {
        listingDest.value = config.デフォルト出品先 || '';
        if (config.デフォルト出品先) {
          console.log('✅ デフォルト出品先を設定しました（renderProcureListingDefaults）:', config.デフォルト出品先);
        }
      }

      // チェックボックスの状態に応じて日付フィールドを無効化
      toggleProcureDateField();
      toggleListingDateField();
    }

    /**
     * 仕入・出品デフォルト設定を収集
     */
    function collectProcureListingDefaults() {
      const result = {
        仕入日_今日: document.getElementById('仕入日_今日')?.checked || false,
        デフォルト仕入日: document.getElementById('デフォルト仕入日')?.value || '',
        デフォルト仕入先: document.getElementById('デフォルト仕入先')?.value || '',
        出品日_今日: document.getElementById('出品日_今日')?.checked || false,
        デフォルト出品日: document.getElementById('デフォルト出品日')?.value || '',
        デフォルト出品先: document.getElementById('デフォルト出品先')?.value || ''
      };
      console.log('仕入・出品デフォルト設定を収集:', result);
      return result;
    }

    /**
     * 仕入・出品デフォルト設定をすべてクリア
     */
    function clearProcureListingDefaults() {
      if (!confirm('仕入・出品デフォルト設定をすべてクリアしますか？')) {
        return;
      }

      document.getElementById('仕入日_今日').checked = false;
      document.getElementById('デフォルト仕入日').value = '';
      document.getElementById('デフォルト仕入先').value = '';
      document.getElementById('出品日_今日').checked = false;
      document.getElementById('デフォルト出品日').value = '';
      document.getElementById('デフォルト出品先').value = '';

      // チェックボックスをクリアしたので日付フィールドを有効化
      toggleProcureDateField();
      toggleListingDateField();

      alert('仕入・出品デフォルト設定をクリアしました。\n変更を保存するには「設定を保存」ボタンをクリックしてください。');
    }

    // ========================================
    // AI生成設定関連の関数
    // ========================================

    /**
     * Temperature表示を更新
     */
    function updateTempDisplay() {
      const slider = document.getElementById('aiTemperature');
      const display = document.getElementById('aiTempValue');
      if (slider && display) {
        const value = (parseInt(slider.value) / 10).toFixed(1);
        display.textContent = value;
      }
      updateAiConfigPreview();
    }

    /**
     * AI設定プレビューを更新
     */
    function updateAiConfigPreview() {
      const prompt = document.getElementById('aiPromptTemplate')?.value || '';
      const length = document.querySelector('input[name="aiLength"]:checked')?.value || 'medium';
      const tone = document.getElementById('aiTone')?.value || 'casual';
      const temperature = (parseInt(document.getElementById('aiTemperature')?.value || 7) / 10).toFixed(1);
      const maxTokens = document.getElementById('aiMaxTokens')?.value || '500';

      const lengthText = {
        'short': '150-200字',
        'medium': '200-300字',
        'long': '300-500字'
      }[length];

      const toneText = {
        'casual': 'カジュアル',
        'polite': '丁寧',
        'enthusiastic': '熱量高め'
      }[tone];

      // 含める要素をチェック
      const includes = [];
      if (document.getElementById('aiIncludeBrand')?.checked) includes.push('ブランド');
      if (document.getElementById('aiIncludeCategory')?.checked) includes.push('カテゴリ');
      if (document.getElementById('aiIncludeSize')?.checked) includes.push('サイズ');
      if (document.getElementById('aiIncludeMaterial')?.checked) includes.push('素材');
      if (document.getElementById('aiIncludeColor')?.checked) includes.push('カラー');
      if (document.getElementById('aiIncludeCondition')?.checked) includes.push('商品状態');
      if (document.getElementById('aiIncludeCoordinate')?.checked) includes.push('コーディネート');
      if (document.getElementById('aiIncludeScene')?.checked) includes.push('着用シーン');

      const preview = `
【現在の設定】

📏 文字数: ${lengthText}
🎭 トーン: ${toneText}
🌡️ Temperature: ${temperature}
📊 Max Tokens: ${maxTokens}

☑️ 含める要素:
${includes.join('、')}

📝 プロンプト:
${prompt || '（未設定）'}
      `.trim();

      const previewEl = document.getElementById('aiConfigPreview');
      if (previewEl) {
        previewEl.textContent = preview;
      }
    }

    /**
     * プリセットを適用
     */
    function applyAiPreset(presetName) {
      const presets = {
        casual: {
          prompt: `以下の商品情報から、メルカリ向けの魅力的な商品説明文を作成してください。

ブランド: {brand}
アイテム: {item}
カテゴリ: {category}
サイズ: {size}
状態: {condition}
素材: {material}
カラー: {color}

【指示】
・フレンドリーでカジュアルな文体で書いてください
・商品の特徴や魅力を具体的に伝えてください
・コーディネート提案や着用シーンを含めてください
・{length}文字程度で簡潔にまとめてください`,
          length: 'medium',
          tone: 'casual',
          headingStyle: 'emoji',
          temperature: 7,
          maxTokens: 500
        },
        standard: {
          prompt: `以下の商品情報から、メルカリ向けの商品説明文を作成してください。

ブランド: {brand}
アイテム: {item}
カテゴリ: {category}
サイズ: {size}
状態: {condition}
素材: {material}
カラー: {color}

【指示】
・丁寧で親しみやすい文体で書いてください
・プロフェッショナルだが堅苦しくない表現を心がけてください
・商品の魅力や特徴をわかりやすく伝えてください
・コーディネート提案や着用シーンを含めてください
・{length}文字程度でまとめてください`,
          length: 'medium',
          tone: 'standard',
          headingStyle: 'brackets',
          temperature: 6,
          maxTokens: 500
        },
        polite: {
          prompt: `以下の商品情報から、丁寧でビジネスライクな商品説明文を作成してください。

ブランド: {brand}
アイテム: {item}
カテゴリ: {category}
サイズ: {size}
状態: {condition}
素材: {material}
カラー: {color}

【指示】
・丁寧で格調高い文体で書いてください
・商品のクオリティや価値を強調してください
・プロフェッショナルな印象を与えてください
・{length}文字程度でまとめてください`,
          length: 'medium',
          tone: 'polite',
          headingStyle: 'none',
          temperature: 5,
          maxTokens: 500
        },
        enthusiastic: {
          prompt: `以下の商品情報から、熱量高めでおすすめ感の強い商品説明文を作成してください。

ブランド: {brand}
アイテム: {item}
カテゴリ: {category}
サイズ: {size}
状態: {condition}
素材: {material}
カラー: {color}

【指示】
・熱量高めで、おすすめ感を強調してください
・商品の魅力を全面的にアピールしてください
・「おすすめ」「イチオシ」などの言葉を効果的に使ってください
・購買意欲を高める表現を心がけてください
・{length}文字程度でまとめてください`,
          length: 'medium',
          tone: 'enthusiastic',
          headingStyle: 'emoji',
          temperature: 8,
          maxTokens: 500
        },
        concise: {
          prompt: `以下の商品情報から、簡潔な商品説明文を作成してください。

ブランド: {brand}
アイテム: {item}
カテゴリ: {category}
サイズ: {size}
状態: {condition}
素材: {material}
カラー: {color}

【指示】
・シンプルで分かりやすい文体で書いてください
・要点を絞って簡潔にまとめてください
・150-200文字程度の短文で書いてください`,
          length: 'short',
          tone: 'casual',
          headingStyle: 'none',
          temperature: 5,
          maxTokens: 300
        },
        detailed: {
          prompt: `以下の商品情報から、詳細な商品説明文を作成してください。

ブランド: {brand}
アイテム: {item}
カテゴリ: {category}
サイズ: {size}
状態: {condition}
素材: {material}
カラー: {color}

【指示】
・商品の細部まで丁寧に説明してください
・ブランドの特徴や歴史にも言及してください
・複数のコーディネート提案や着用シーンを含めてください
・300-500文字程度の詳細な説明文を作成してください`,
          length: 'long',
          tone: 'polite',
          headingStyle: 'brackets',
          temperature: 8,
          maxTokens: 1000
        }
      };

      const preset = presets[presetName];
      if (!preset) return;

      // プロンプトテンプレート
      document.getElementById('aiPromptTemplate').value = preset.prompt;

      // 文字数
      const lengthRadios = document.querySelectorAll('input[name="aiLength"]');
      lengthRadios.forEach(radio => {
        radio.checked = radio.value === preset.length;
      });

      // トーン
      document.getElementById('aiTone').value = preset.tone;

      // 見出しスタイル
      if (preset.headingStyle) {
        document.getElementById('aiHeadingStyle').value = preset.headingStyle;
      }

      // Temperature
      document.getElementById('aiTemperature').value = preset.temperature;
      updateTempDisplay();

      // Max Tokens
      document.getElementById('aiMaxTokens').value = preset.maxTokens;

      // すべての要素をチェック
      document.getElementById('aiIncludeBrand').checked = true;
      document.getElementById('aiIncludeCategory').checked = true;
      document.getElementById('aiIncludeSize').checked = true;
      document.getElementById('aiIncludeMaterial').checked = true;
      document.getElementById('aiIncludeColor').checked = true;
      document.getElementById('aiIncludeCondition').checked = true;
      document.getElementById('aiIncludeCoordinate').checked = true;
      document.getElementById('aiIncludeScene').checked = true;

      updateAiConfigPreview();

      const presetNames = {
        'casual': 'カジュアル（メルカリ向け）',
        'polite': '丁寧（ビジネス向け）',
        'concise': '簡潔（短文）',
        'detailed': '詳細（長文）'
      };

      alert(`✅ プリセット「${presetNames[presetName]}」を適用しました！\n\n内容を確認して、必要に応じてカスタマイズしてください。\n設定を保存するには「設定を保存」ボタンをクリックしてください。`);
    }

    /**
     * AI設定をレンダリング
     */
    function renderAiSettings(config) {
      console.log('AI生成設定を表示:', config);

      // プロンプトテンプレート
      const promptTemplate = document.getElementById('aiPromptTemplate');
      if (promptTemplate) {
        promptTemplate.value = config.promptTemplate || '';
      }

      // 文字数
      const lengthValue = config.length || 'medium';
      const lengthRadios = document.querySelectorAll('input[name="aiLength"]');
      lengthRadios.forEach(radio => {
        radio.checked = radio.value === lengthValue;
      });

      // トーン
      const tone = document.getElementById('aiTone');
      if (tone) {
        tone.value = config.tone || 'casual';
      }

      // 見出しスタイル
      const headingStyle = document.getElementById('aiHeadingStyle');
      if (headingStyle) {
        headingStyle.value = config.headingStyle || 'brackets';
      }

      // Temperature
      const temperature = document.getElementById('aiTemperature');
      if (temperature) {
        temperature.value = Math.round((config.temperature || 0.7) * 10);
        updateTempDisplay();
      }

      // Max Tokens
      const maxTokens = document.getElementById('aiMaxTokens');
      if (maxTokens) {
        maxTokens.value = config.maxTokens || 500;
      }

      // 含める要素
      document.getElementById('aiIncludeBrand').checked = config.includeBrand !== false;
      document.getElementById('aiIncludeCategory').checked = config.includeCategory !== false;
      document.getElementById('aiIncludeSize').checked = config.includeSize !== false;
      document.getElementById('aiIncludeMaterial').checked = config.includeMaterial !== false;
      document.getElementById('aiIncludeColor').checked = config.includeColor !== false;
      document.getElementById('aiIncludeAttributes').checked = config.includeAttributes !== false;
      document.getElementById('aiIncludeCondition').checked = config.includeCondition !== false;
      document.getElementById('aiIncludeCoordinate').checked = config.includeCoordinate !== false;
      document.getElementById('aiIncludeScene').checked = config.includeScene !== false;

      // 配置順序
      renderDescriptionOrder(config.descriptionOrder || DESCRIPTION_ELEMENTS);

      updateAiConfigPreview();
    }

    /**
     * AI設定を収集
     */
    function collectAiSettings() {
      const lengthRadio = document.querySelector('input[name="aiLength"]:checked');

      const result = {
        promptTemplate: document.getElementById('aiPromptTemplate')?.value || '',
        length: lengthRadio?.value || 'medium',
        tone: document.getElementById('aiTone')?.value || 'casual',
        headingStyle: document.getElementById('aiHeadingStyle')?.value || 'brackets',
        temperature: parseInt(document.getElementById('aiTemperature')?.value || 7) / 10,
        maxTokens: parseInt(document.getElementById('aiMaxTokens')?.value || 500),
        includeBrand: document.getElementById('aiIncludeBrand')?.checked || false,
        includeCategory: document.getElementById('aiIncludeCategory')?.checked || false,
        includeSize: document.getElementById('aiIncludeSize')?.checked || false,
        includeMaterial: document.getElementById('aiIncludeMaterial')?.checked || false,
        includeColor: document.getElementById('aiIncludeColor')?.checked || false,
        includeAttributes: document.getElementById('aiIncludeAttributes')?.checked || false,
        includeCondition: document.getElementById('aiIncludeCondition')?.checked || false,
        includeCoordinate: document.getElementById('aiIncludeCoordinate')?.checked || false,
        includeScene: document.getElementById('aiIncludeScene')?.checked || false,
        descriptionOrder: collectDescriptionOrder()
      };

      console.log('AI生成設定を収集:', result);
      return result;
    }

    /**
     * 配置順序の定義
     */
    const DESCRIPTION_ELEMENTS = [
      { id: 'brand', label: '🏢 ブランド情報', enabled: true },
      { id: 'color', label: '🎨 カラー(詳細)', enabled: true },
      { id: 'size', label: '📏 サイズ情報', enabled: true },
      { id: 'material', label: '🧵 素材情報', enabled: true },
      { id: 'condition', label: '📋 商品の状態', enabled: true },
      { id: 'ai', label: '✨ AI生成文', enabled: true },
      { id: 'management', label: '🔢 管理番号', enabled: true },
      { id: 'discount', label: '💰 割引情報', enabled: true },
      { id: 'hashtag', label: '🏷️ ハッシュタグ', enabled: true }
    ];

    /**
     * 配置順序リストを描画
     */
    let draggedElement = null;

    function renderDescriptionOrder(order) {
      console.log('配置順序を表示:', order);

      const container = document.getElementById('descriptionOrderList');
      if (!container) return;

      container.innerHTML = '';

      // 順序配列がない場合はデフォルトを使用
      const elements = order && order.length > 0 ? order : DESCRIPTION_ELEMENTS;

      elements.forEach((element, index) => {
        const item = document.createElement('div');
        item.draggable = true;
        item.dataset.elementId = element.id;
        item.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; cursor: move; transition: all 0.2s; user-select: none;';

        // ドラッグハンドル
        const handle = document.createElement('span');
        handle.textContent = '⋮⋮';
        handle.style.cssText = 'font-size: 16px; color: #9ca3af; cursor: move;';
        item.appendChild(handle);

        // チェックボックス
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = element.enabled !== false;
        checkbox.style.cssText = 'width: 18px; height: 18px; cursor: pointer;';
        checkbox.addEventListener('change', () => {
          updateDescriptionOrderPreview();
        });
        item.appendChild(checkbox);

        // ラベル
        const label = document.createElement('span');
        label.textContent = element.label;
        label.style.cssText = 'flex: 1; font-size: 13px; font-weight: 500; color: #374151;';
        item.appendChild(label);

        // ドラッグイベント
        item.addEventListener('dragstart', (e) => {
          draggedElement = item;
          e.dataTransfer.effectAllowed = 'move';
          item.style.opacity = '0.5';
        });

        item.addEventListener('dragend', (e) => {
          item.style.opacity = '1';
          draggedElement = null;
        });

        item.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';

          if (draggedElement && draggedElement !== item) {
            item.style.borderColor = '#3b82f6';
            item.style.background = '#eff6ff';
          }
        });

        item.addEventListener('dragleave', (e) => {
          item.style.borderColor = '#e5e7eb';
          item.style.background = 'white';
        });

        item.addEventListener('drop', (e) => {
          e.preventDefault();
          e.stopPropagation();

          item.style.borderColor = '#e5e7eb';
          item.style.background = 'white';

          if (draggedElement && draggedElement !== item) {
            // ドラッグしている要素の現在位置を取得
            const allItems = Array.from(container.children);
            const draggedIndex = allItems.indexOf(draggedElement);
            const targetIndex = allItems.indexOf(item);

            // ドロップ先の前に挿入
            if (draggedIndex < targetIndex) {
              // 下に移動する場合は、ターゲットの次に挿入
              container.insertBefore(draggedElement, item.nextSibling);
            } else {
              // 上に移動する場合は、ターゲットの前に挿入
              container.insertBefore(draggedElement, item);
            }

            updateDescriptionOrderPreview();
          }
        });

        container.appendChild(item);
      });

      updateDescriptionOrderPreview();
    }

    /**
     * 配置順序プレビューを更新
     */
    function updateDescriptionOrderPreview() {
      const container = document.getElementById('descriptionOrderList');
      const preview = document.getElementById('descriptionOrderPreview');

      if (!container || !preview) return;

      const items = Array.from(container.children);
      const enabledItems = items
        .map((item, index) => {
          const checkbox = item.querySelector('input[type="checkbox"]');
          const label = item.querySelector('span:last-child');
          return {
            index: index + 1,
            label: label.textContent,
            enabled: checkbox.checked
          };
        })
        .filter(item => item.enabled);

      if (enabledItems.length === 0) {
        preview.textContent = '（すべて非表示）';
        preview.style.color = '#ef4444';
      } else {
        preview.innerHTML = enabledItems
          .map(item => `${item.index}. ${item.label}`)
          .join('<br>');
        preview.style.color = '#374151';
      }
    }

    /**
     * 配置順序を収集
     */
    function collectDescriptionOrder() {
      const container = document.getElementById('descriptionOrderList');
      if (!container) return DESCRIPTION_ELEMENTS;

      const items = Array.from(container.children);
      return items.map(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        const elementId = item.dataset.elementId;
        const element = DESCRIPTION_ELEMENTS.find(e => e.id === elementId);

        return {
          id: elementId,
          label: element ? element.label : '',
          enabled: checkbox.checked
        };
      });
    }

    /**
     * 配置順序をデフォルトに戻す
     */
    function resetDescriptionOrder() {
      if (!confirm('配置順序をデフォルトに戻しますか？')) {
        return;
      }

      renderDescriptionOrder(DESCRIPTION_ELEMENTS);
      alert('配置順序をデフォルトに戻しました。\n変更を保存するには「設定を保存」ボタンをクリックしてください。');
    }

    /**
     * AI設定をすべてクリア
     */
    function clearAiSettings() {
      if (!confirm('AI生成設定をデフォルトに戻しますか？')) {
        return;
      }

      // デフォルトのプリセット（カジュアル）を適用
      applyAiPreset('casual');

      alert('AI生成設定をデフォルト（カジュアル）に戻しました。\n変更を保存するには「設定を保存」ボタンをクリックしてください。');
    }

    // ========================================
    // タブスワイプジェスチャー実装 (UI-014 Phase 2)
    // ========================================

    // 商品登録設定タブのスワイプジェスチャー
    (function() {
      const productTabContent = document.getElementById('productConfigTabContent');
      if (!productTabContent) return;

      const tabIds = ['product-salesword', 'product-condition', 'product-hashtag', 'product-discount', 'product-ai'];
      let touchStartX = 0;
      let touchStartY = 0;
      let touchEndX = 0;
      let touchEndY = 0;
      const minSwipeDistance = 50; // 最小スワイプ距離（px）

      productTabContent.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
      }, { passive: true });

      productTabContent.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleSwipe('product');
      }, { passive: true });

      function handleSwipe(prefix) {
        const diffX = touchStartX - touchEndX;
        const diffY = touchStartY - touchEndY;

        // 水平スワイプ判定: 横移動が縦移動より大きい場合のみ反応
        if (Math.abs(diffX) < minSwipeDistance) return; // スワイプ距離が短い場合は無視
        if (Math.abs(diffY) > Math.abs(diffX)) return; // 縦移動が大きい場合は無視

        // 現在アクティブなタブを取得
        const activeTab = document.querySelector(`#${prefix}ConfigTabs .nav-link.active`);
        if (!activeTab) return;

        const currentId = activeTab.id.replace('-tab', '');
        const currentIndex = tabIds.indexOf(currentId);
        if (currentIndex === -1) return;

        let nextIndex;
        if (diffX > 0) {
          // 左スワイプ = 次のタブへ
          nextIndex = currentIndex + 1;
          if (nextIndex >= tabIds.length) return; // 最後のタブの場合は無視
        } else {
          // 右スワイプ = 前のタブへ
          nextIndex = currentIndex - 1;
          if (nextIndex < 0) return; // 最初のタブの場合は無視
        }

        // 次のタブに切り替え
        const nextTabId = tabIds[nextIndex];
        const nextTabButton = document.getElementById(`${nextTabId}-tab`);
        if (nextTabButton) {
          const tab = new bootstrap.Tab(nextTabButton);
          tab.show();

          // タブ自体をスクロールして表示されるようにする
          const tabsContainer = document.getElementById(`${prefix}ConfigTabs`);
          if (tabsContainer) {
            nextTabButton.scrollIntoView({
              behavior: 'smooth',
              block: 'nearest',
              inline: 'center'
            });
          }
        }
      }
    })();

    // システム設定タブのスワイプジェスチャー
    (function() {
      const systemTabContent = document.getElementById('systemConfigTabContent');
      if (!systemTabContent) return;

      const tabIds = ['system-basic', 'system-management', 'system-shipping', 'system-procure', 'system-permission'];
      let touchStartX = 0;
      let touchStartY = 0;
      let touchEndX = 0;
      let touchEndY = 0;
      const minSwipeDistance = 50;

      systemTabContent.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
      }, { passive: true });

      systemTabContent.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleSwipe();
      }, { passive: true });

      function handleSwipe() {
        const diffX = touchStartX - touchEndX;
        const diffY = touchStartY - touchEndY;

        // 水平スワイプ判定: 横移動が縦移動より大きい場合のみ反応
        if (Math.abs(diffX) < minSwipeDistance) return;
        if (Math.abs(diffY) > Math.abs(diffX)) return; // 縦移動が大きい場合は無視

        const activeTab = document.querySelector('#systemConfigTabs .nav-link.active');
        if (!activeTab) return;

        const currentId = activeTab.id.replace('-tab', '');
        const currentIndex = tabIds.indexOf(currentId);
        if (currentIndex === -1) return;

        let nextIndex;
        if (diffX > 0) {
          nextIndex = currentIndex + 1;
          if (nextIndex >= tabIds.length) return;
        } else {
          nextIndex = currentIndex - 1;
          if (nextIndex < 0) return;
        }

        const nextTabId = tabIds[nextIndex];
        const nextTabButton = document.getElementById(`${nextTabId}-tab`);
        if (nextTabButton) {
          const tab = new bootstrap.Tab(nextTabButton);
          tab.show();

          // タブ自体をスクロールして表示されるようにする
          const tabsContainer = document.getElementById('systemConfigTabs');
          if (tabsContainer) {
            nextTabButton.scrollIntoView({
              behavior: 'smooth',
              block: 'nearest',
              inline: 'center'
            });
          }
        }
      }
    })();
  </script>

  <!-- Firebase SDK (compat版: UMD形式) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <!-- Firebase初期化（product.htmlと同じパターン：即座に実行） -->
  <script>
    // Firebase設定（reborn-chatプロジェクトに統一）
    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "reborn-chat.firebaseapp.com",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    // Firebase即座に初期化（product.htmlと同じパターン）
    try {
      if (typeof firebase !== 'undefined') {
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        window.db = db; // グローバルに公開
        window.firestoreReady = true;

        // 梱包資材一覧を読み込んでプルダウンに設定
        loadPackagingMaterials();
            } else {
        console.error('❌ Firebase SDKが読み込まれていません');
      }
    } catch (error) {
      console.error('❌ Firebase初期化エラー:', error);
    }

    /**
     * Firestoreから梱包資材一覧を取得してプルダウンに設定
     */
    async function loadPackagingMaterials() {
      if (!window.db) {
        console.warn('⚠️ Firestoreが初期化されていません（梱包資材読み込みスキップ）');
        return;
      }

      try {
        console.log('📦 Firestoreから梱包資材一覧を取得中...');
        const snapshot = await window.db.collection('packagingMaterials')
          .orderBy('name', 'asc')
          .get();

        const select = document.getElementById('梱包資材デフォルト');
        if (!select) {
          console.warn('⚠️ 梱包資材デフォルトselectが見つかりません');
          return;
        }

        // 既存のオプション（「-- 選択してください --」）は残して、データを追加
        snapshot.forEach(doc => {
          const data = doc.data();
          const option = document.createElement('option');
          option.value = data.name;
          option.textContent = data.name + (data.abbreviation ? ` (${data.abbreviation})` : '');
          select.appendChild(option);
        });

        console.log(`✅ 梱包資材 ${snapshot.size}件 を読み込みました`);
      } catch (error) {
        console.error('❌ 梱包資材読み込みエラー:', error);
      }
    }

    // ================= 権限チェック機能（PERM-001） =================

    /**
     * ユーザー権限をチェックしてUIを制御
     * オーナー以外の場合、基本設定以外のタブを非表示にする
     */
    async function checkUserPermissionAndUpdateUI() {
      try {
        // ユーザーのメールアドレスを取得（FirestoreのドキュメントIDはメールアドレス）
        const userEmail = localStorage.getItem('reborn_user_email');
        const userName = localStorage.getItem('reborn_user_name');
        if (!userEmail) {
          console.warn('⚠️ [権限チェック] ユーザーメールが見つかりません');
          return;
        }

        console.log('🔐 [権限チェック] ユーザー:', userName, '(', userEmail, ')');

        // Firestoreからユーザー情報を取得
        if (!window.db) {
          console.warn('⚠️ [権限チェック] Firestoreが初期化されていません');
          return;
        }

        const userDoc = await window.db.collection('users').doc(userEmail).get();

        if (!userDoc.exists) {
          console.warn('⚠️ [権限チェック] ユーザードキュメントが見つかりません');
          return;
        }

        const userData = userDoc.data();
        const permissionId = userData.permissionId || 'staff';
        const permissionDisplay = userData.permissionDisplay || 'スタッフ';

        console.log('🔐 [権限チェック] 権限:', permissionDisplay, '(ID:', permissionId + ')');

        // 権限をlocalStorageにキャッシュ（他の画面でも使えるように）
        localStorage.setItem('reborn_user_permission', permissionId);

        // オーナー以外の場合、特定のタブを非表示
        if (permissionId !== 'owner') {
          hideOwnerOnlyTabs();
          console.log('🔒 [権限チェック] オーナー専用タブを非表示にしました');
        } else {
          console.log('✅ [権限チェック] オーナー権限 - 全タブ表示');
        }

      } catch (error) {
        console.error('❌ [権限チェック] エラー:', error);
      }
    }

    /**
     * オーナー専用タブを非表示にする
     */
    function hideOwnerOnlyTabs() {
      // システム設定のサブタブ（基本設定以外）
      const systemOwnerOnlyTabs = [
        'system-management-tab',  // 管理番号設定
        'system-shipping-tab',    // 配送設定
        'system-procure-tab',     // 仕入・出品設定
        'system-permission-tab'   // 権限設定
      ];

      // 商品登録設定のサブタブ（全て）
      const productOwnerOnlyTabs = [
        'product-salesword-tab',  // セールスワード設定
        'product-condition-tab',  // 商品状態設定
        'product-hashtag-tab',    // ハッシュタグ設定
        'product-discount-tab',   // 割引設定
        'product-ai-tab'          // AI生成設定
      ];

      // システム設定のオーナー専用タブを非表示
      systemOwnerOnlyTabs.forEach(tabId => {
        const tab = document.getElementById(tabId);
        if (tab) {
          tab.closest('.nav-item').style.display = 'none';
        }
      });

      // 商品登録設定タブ全体を非表示（メインタブ）
      // 商品登録設定のサブタブコンテナを非表示
      const productConfigTabs = document.getElementById('productConfigTabs');
      if (productConfigTabs) {
        productConfigTabs.style.display = 'none';
      }

      // 商品登録設定の全サブタブを非表示
      productOwnerOnlyTabs.forEach(tabId => {
        const tab = document.getElementById(tabId);
        if (tab) {
          tab.closest('.nav-item').style.display = 'none';
        }
      });

      // 商品登録設定エリアにメッセージを表示
      const productPane = document.getElementById('product');
      if (productPane) {
        const sectionTitle = productPane.querySelector('.section-title');
        if (sectionTitle) {
          sectionTitle.innerHTML = '📝 商品登録設定 <span style="font-size: 12px; color: #6b7280; font-weight: normal;">(オーナーのみ編集可能)</span>';
        }
        // サブタブコンテンツを非表示にしてメッセージを表示
        const tabContent = productPane.querySelector('.tab-content');
        if (tabContent) {
          tabContent.innerHTML = '<div style="padding: 40px; text-align: center; color: #6b7280;"><i class="bi bi-lock" style="font-size: 48px; display: block; margin-bottom: 16px;"></i>この設定はオーナーのみ編集できます。<br>設定の変更が必要な場合はオーナーにお問い合わせください。</div>';
        }
      }

      // システム設定のオーナー専用タブコンテンツも非表示
      const systemOwnerOnlyPanes = [
        'system-management',
        'system-shipping',
        'system-procure'
      ];

      systemOwnerOnlyPanes.forEach(paneId => {
        const pane = document.getElementById(paneId);
        if (pane) {
          pane.style.display = 'none';
        }
      });
    }

    // Firebase初期化後に権限チェックを実行
    if (window.firestoreReady) {
      checkUserPermissionAndUpdateUI();
    }
  </script>

  <!-- 以下、他の初期化スクリプト -->
  <script>
    // この後の設定変数（firebaseConfigは上で定義済み）

    // ================= 画像管理設定 =================

    /**
     * 画像管理設定の初期化
     */
    window.initImageSettings = function() {
      const checkbox = document.getElementById('enableProductImageSave');
      const statusText = document.getElementById('imageSettingStatusText');

      // まずlocalStorageから読み込み（高速表示）
      const localStorageValue = localStorage.getItem('enableProductImageSave');
      let enabled = localStorageValue === 'true';

      console.log('🔍 [設定画面] 画像管理設定を初期化:');
      console.log('  - localStorage値:', localStorageValue);
      console.log('  - 有効:', enabled);

      // UIを即座に更新
      if (checkbox) {
        checkbox.checked = enabled;
      }

      if (statusText) {
        statusText.textContent = enabled
          ? 'ON（商品画像ブロックが表示されます）'
          : 'OFF（商品画像ブロックは非表示）';
      }

      // PWA版では Firestore から読み込み（未実装）
      // 暫定: localStorage のみ使用
    }

    /**
     * 商品画像保存設定の切り替え
     */
    window.toggleProductImageSave = function() {
      const checkbox = document.getElementById('enableProductImageSave');
      const statusText = document.getElementById('imageSettingStatusText');

      console.log('🔘 toggleProductImageSave呼び出し');
      console.log('  - チェックボックス:', checkbox);

      if (!checkbox || !statusText) {
        console.error('❌ チェックボックスまたはステータステキストが見つかりません');
        return;
      }

      const enabled = checkbox.checked;
      console.log('  - チェック状態:', enabled);

      // ステータステキストを更新
      statusText.textContent = enabled
        ? 'ON（商品画像ブロックが表示されます）'
        : 'OFF（商品画像ブロックは非表示）';

      // 1. localStorageに保存（PC/デスクトップ用・高速）
      try {
        localStorage.setItem('enableProductImageSave', enabled.toString());
        console.log('✅ localStorage保存:', enabled);

        // 保存確認
        const saved = localStorage.getItem('enableProductImageSave');
        console.log('  - 保存確認:', saved);
      } catch (e) {
        console.error('⚠️ localStorage保存エラー（iOS/スマホでは制限される場合があります）:', e);
      }

      // PWA版では Firestore に保存（未実装）
      // 暫定: localStorage のみ使用
    }

    /**
     * 画像管理設定を保存
     */
    window.saveImageSettings = function() {
      const checkbox = document.getElementById('enableProductImageSave');

      console.log('💾 saveImageSettings呼び出し');

      if (!checkbox) {
        alert('設定の読み込みに失敗しました');
        return;
      }

      const enabled = checkbox.checked;
      localStorage.setItem('enableProductImageSave', enabled.toString());

      alert('✅ 設定完了しました');

      console.log('✅ 画像管理設定を保存しました:', enabled);
    };

    // localStorage全体をコンソールに表示（デバッグ用）
    window.debugLocalStorage = function() {
      console.log('📦 localStorage全体:');
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        const value = localStorage.getItem(key);
        console.log(`  - ${key}:`, value);
      }
    };

    // DOMContentLoaded時に初期化
    document.addEventListener('DOMContentLoaded', function() {
      window.debugLocalStorage(); // デバッグ用
      window.initImageSettings();

      // URLパラメータからタブを取得（menu_homeからの遷移対応）
      const urlParams = new URLSearchParams(window.location.search);
      const tabParam = urlParams.get('tab'); // 例: ?tab=product or ?tab=system

      // メインタブの切り替え（商品登録設定/システム設定）+ ヘッダータイトル更新
      const headerTitle = document.getElementById('page-header-title');

      if (tabParam === 'product') {
        // 商品登録設定タブペインを直接表示
        const productPane = document.getElementById('product');
        const systemPane = document.getElementById('system');

        if (productPane && systemPane) {
          // システム設定を非表示
          systemPane.classList.remove('show', 'active');

          // 商品登録設定を表示
          productPane.classList.add('show', 'active');

          // ヘッダータイトルを更新
          if (headerTitle) {
            headerTitle.textContent = '📝 商品登録設定';
          }

          console.log('[config.html] 商品登録設定タブを表示');
        }
      } else if (tabParam === 'system') {
        // システム設定タブペインを表示（デフォルト）
        const productPane = document.getElementById('product');
        const systemPane = document.getElementById('system');

        if (productPane && systemPane) {
          // 商品登録設定を非表示
          productPane.classList.remove('show', 'active');

          // システム設定を表示
          systemPane.classList.add('show', 'active');

          // ヘッダータイトルを更新（デフォルト値だが明示的に設定）
          if (headerTitle) {
            headerTitle.textContent = '⚙️ システム設定';
          }

          console.log('[config.html] システム設定タブを表示');
        }
      }

      // activeTabパラメータに基づいてタブを切り替え
      const activeTab = '<?= typeof activeTab !== "undefined" ? activeTab : "basic" ?>';
      if (activeTab && activeTab !== 'basic') {
        // 該当するタブボタンとペインをアクティブ化
        const tabButton = document.getElementById(activeTab + '-tab');
        const tabPane = document.getElementById(activeTab);

        if (tabButton && tabPane) {
          // 現在アクティブなタブを非アクティブ化
          const activeButton = document.querySelector('.nav-link.active');
          const activePane = document.querySelector('.tab-pane.active.show');
          if (activeButton) {
            activeButton.classList.remove('active');
          }
          if (activePane) {
            activePane.classList.remove('active', 'show');
          }

          // 新しいタブをアクティブ化
          tabButton.classList.add('active');
          tabPane.classList.add('active', 'show');
        }
      }
    });

    // Firebase は上のスクリプトで既に初期化済み
    // window.db と window.firestoreReady は既に設定されている

    // バッジカウントを増やす（利用可能な場合）
    function incrementBadgeIfAvailable() {
      try {
        // localStorageから現在のカウントを取得
        const currentCount = parseInt(localStorage.getItem('badgeCount') || '0', 10);
        const newCount = currentCount + 1;

        // localStorageに保存
        localStorage.setItem('badgeCount', newCount.toString());
        console.log('📛 バッジカウント更新:', newCount);

        // Badge APIで更新（対応ブラウザのみ）
        if ('setAppBadge' in navigator) {
          navigator.setAppBadge(newCount)
            .then(() => console.log('✅ Badge API更新成功:', newCount))
            .catch(err => console.error('❌ Badge APIエラー:', err));
        }
      } catch (error) {
        console.error('❌ バッジ更新エラー:', error);
      }
    }

    // Firebase初期化は既にscriptタグで実行済み
    // ManagementNumberBuilderのloadSettings()を呼ぶ
    function initFirebaseAndLoadSettings() {
      // Firestore初期化完了後、ManagementNumberBuilderのloadSettings()を呼ぶ
      if (window.ManagementNumberBuilder && window.firestoreReady) {
        console.log('🔥 Firebase初期化完了 → ManagementNumberBuilder.loadSettings()を呼び出します');
        window.ManagementNumberBuilder.loadSettings();
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initFirebaseAndLoadSettings);
    } else {
      initFirebaseAndLoadSettings();
    }

    /**
     * 基本設定を読み込む（フォールバック方式）
     */
    function loadBasicSettings() {
      try {
        const config = JSON.parse(localStorage.getItem('config') || '{}');

        // 🔧 優先順位: config > reborn_user_* > デフォルト値
        const userName = config.userName || localStorage.getItem('reborn_user_name') || '';
        const userEmail = config.email || localStorage.getItem('reborn_user_email') || '';

        // ユーザー名を設定
        const userNameInput = document.getElementById('basicUserName');
        if (userNameInput) {
          userNameInput.value = userName;

          // クリアボタンの表示制御
          const clearBtn = document.getElementById('clearUserNameBtn');
          if (clearBtn) {
            clearBtn.style.display = userName ? 'block' : 'none';
          }
        }

        // メールアドレスを設定
        const emailInput = document.getElementById('basicUserEmail');
        if (emailInput) {
          emailInput.value = userEmail;
        }

        // 通知設定（デフォルトtrue）
        const notificationEnabled = config.notificationEnabled !== undefined ? config.notificationEnabled : true;
        const notificationSound = config.notificationSound !== undefined ? config.notificationSound : true;

        const notifCheckbox = document.getElementById('basicNotificationEnabled');
        if (notifCheckbox) {
          notifCheckbox.checked = notificationEnabled;
        }

        const soundCheckbox = document.getElementById('basicNotificationSound');
        if (soundCheckbox) {
          soundCheckbox.checked = notificationSound;
        }

        // 🔧 アイコン読み込み（localStorageから）
        const iconUrl = localStorage.getItem('user_icon_url');
        const iconPreview = document.getElementById('basicUserIconPreview');
        if (iconPreview && iconUrl) {
          iconPreview.innerHTML = '<img src="' + iconUrl + '" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">';
        }

        console.log('✅ 基本設定を読み込みました (フォールバック方式):', { userName, userEmail, notificationEnabled, notificationSound, iconUrl: iconUrl ? '設定済み' : '未設定' });
      } catch (e) {
        console.error('❌ 基本設定読み込みエラー:', e);
      }

      // ローディング非表示、コンテンツ表示
      document.getElementById('basicSettingsLoading').style.display = 'none';
      document.getElementById('basicSettingsContent').style.display = 'block';
    }

    /**
     * 基本設定を保存する（Firestore直接保存）
     */
    async function saveBasicSettings() {
      const userName = document.getElementById('basicUserName').value.trim();

      if (!userName) {
        alert('ユーザー名を入力してください');
        return;
      }

      const settings = {
        userName: userName,
        notificationEnabled: document.getElementById('basicNotificationEnabled').checked,
        notificationSound: document.getElementById('basicNotificationSound').checked
      };

      try {
        // 1. localStorageに保存（即時反映用）
        const config = JSON.parse(localStorage.getItem('config') || '{}');
        config.userName = settings.userName;
        config.notificationEnabled = settings.notificationEnabled;
        config.notificationSound = settings.notificationSound;
        localStorage.setItem('config', JSON.stringify(config));

        // 2. ユーザーメールアドレスを取得
        const userEmail = localStorage.getItem('reborn_user_email');
        if (!userEmail) {
          throw new Error('ユーザーメールアドレスが見つかりません。再ログインしてください。');
        }

        // 3. Firestoreに保存
        if (!window.db) {
          throw new Error('Firestoreが初期化されていません');
        }

        await window.db.collection('users').doc(userEmail).set({
          userName: settings.userName,
          notificationEnabled: settings.notificationEnabled,
          notificationSound: settings.notificationSound,
          lastUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        // 4. activeDevicesにも通知設定を同期
        await window.db.collection('activeDevices').doc(userEmail).set({
          notificationEnabled: settings.notificationEnabled,
          notificationSound: settings.notificationSound,
          lastUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        // クリアボタンの表示制御
        const clearBtn = document.getElementById('clearUserNameBtn');
        if (clearBtn) {
          clearBtn.style.display = settings.userName ? 'block' : 'none';
        }

        alert('✅ 基本設定を保存しました');
        console.log('✅ 基本設定を保存しました (localStorage + Firestore):', settings);

      } catch (e) {
        console.error('❌ 基本設定保存エラー:', e);
        alert('❌ 保存に失敗しました: ' + e.message);
      }
    }

    // 基本設定タブが表示されたら設定を読み込む
    // システム設定タブ内の基本設定タブを正しく参照（system-basic-tab）
    const basicTab = document.getElementById('system-basic-tab');
    if (basicTab) {
      basicTab.addEventListener('shown.bs.tab', function() {
        loadBasicSettings();
      });

      // 初回表示時も即座に読み込む
      if (basicTab.classList.contains('active')) {
        loadBasicSettings();
      }
    }

    // システム設定タブ（#system）が最初から表示されている場合の対応
    const systemPane = document.getElementById('system');
    if (systemPane && systemPane.classList.contains('active')) {
      // システム設定タブが表示されていて、基本設定タブも表示されている場合
      const basicPane = document.getElementById('system-basic');
      if (basicPane && (basicPane.classList.contains('active') || basicPane.classList.contains('show'))) {
        // 確実にloadBasicSettings()を呼ぶ
        setTimeout(function() {
          loadBasicSettings();
        }, 100);
      }
    }

    // ユーザー名入力のクリアボタン表示/非表示
    const userNameInput = document.getElementById('basicUserName');
    const clearUserNameBtn = document.getElementById('clearUserNameBtn');
    
    if (userNameInput && clearUserNameBtn) {
      userNameInput.addEventListener('input', function() {
        clearUserNameBtn.style.display = this.value ? 'block' : 'none';
      });
    }

    // ユーザー名クリア機能
    function clearUserName() {
      const input = document.getElementById('basicUserName');
      const clearBtn = document.getElementById('clearUserNameBtn');
      input.value = '';
      clearBtn.style.display = 'none';
      input.focus();
    }

    // アイコンファイル選択時のプレビュー（自動リサイズ対応）
    document.getElementById('basicUserIconInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        if (file.size > 2 * 1024 * 1024) {
          alert('ファイルサイズは2MB以下にしてください');
          return;
        }

        const reader = new FileReader();
        reader.onload = function(event) {
          const img = new Image();
          img.onload = function() {
            // 画像を200x200pxにリサイズ（スプレッドシート50000文字制限対策）
            const canvas = document.createElement('canvas');
            const maxSize = 200;
            let width = img.width;
            let height = img.height;

            // アスペクト比を保ちながら最大サイズに収める
            if (width > height) {
              if (width > maxSize) {
                height = Math.round((height * maxSize) / width);
                width = maxSize;
              }
            } else {
              if (height > maxSize) {
                width = Math.round((width * maxSize) / height);
                height = maxSize;
              }
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // JPEGで品質0.8で圧縮（Base64サイズを削減）
            const resizedBase64 = canvas.toDataURL('image/jpeg', 0.8);

            // Base64サイズチェック（スプレッドシート制限: 50000文字）
            if (resizedBase64.length > 45000) {
              alert('画像が大きすぎます。より小さい画像を選択してください。');
              return;
            }

            console.log('画像リサイズ完了:', width + 'x' + height, 'Base64サイズ:', resizedBase64.length, '文字');

            // プレビュー表示
            document.getElementById('basicUserIconPreview').innerHTML =
              '<img src="' + resizedBase64 + '" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">';

            // リサイズ後のBase64データを一時保存
            pendingUserIconData = resizedBase64;
            console.log('アイコン画像を選択しました（保存ボタンを押すとアップロードされます）');
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    /**
     * ユーザーアイコンをアップロード（Firestore直接保存）
     */
    async function uploadUserIcon() {
      if (!pendingUserIconData) {
        console.log('アップロードする画像データがありません');
        return;
      }

      try {
        // 1. ユーザーメールアドレスを取得
        const userEmail = localStorage.getItem('reborn_user_email');
        if (!userEmail) {
          throw new Error('ユーザーメールアドレスが見つかりません。再ログインしてください。');
        }

        // 2. Firestoreに保存
        if (!window.db) {
          throw new Error('Firestoreが初期化されていません');
        }

        await window.db.collection('users').doc(userEmail).set({
          userIconUrl: pendingUserIconData,
          lastUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        // 3. localStorageにも保存（即時反映用）
        localStorage.setItem('user_icon_url', pendingUserIconData);

        console.log('✅ アイコンを保存しました (localStorage + Firestore users)');

        // 4. 親ウィンドウにアイコン更新を通知（即時反映）
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({ type: 'updateUserIcon' }, '*');
          console.log('📤 親ウィンドウにアイコン更新を通知しました');
        }

        // プレビューをクリア
        pendingUserIconData = null;

      } catch (e) {
        console.error('❌ アイコンアップロードエラー:', e);
        throw e; // saveConfig()でキャッチされるようにthrow
      }
    }
  </script>

  <!-- 戻るボタン処理 -->
<script>
  console.log('[sidebar_config] ✅ Script loaded - Version @936-Placement-Fix');
  
  async function goBack() {
    console.log('[sidebar_config] >>> goBack() called at', new Date().toISOString());
    const isInIframe = window.self !== window.top;
    console.log('[sidebar_config] isInIframe:', isInIframe);
    
    if (isInIframe) {
      console.log('[sidebar_config] iframe内で開かれているため、postMessage送信');
      window.top.postMessage({ type: 'navigateToHome' }, '*');
      console.log('[sidebar_config] ✅ postMessage送信完了');
    } else {
      console.log('[sidebar_config] 直接開かれているため、google.script.host.close()');
      google.script.host.close();
    }
  }
  
  document.addEventListener('DOMContentLoaded', () => {
    console.log('[sidebar_config] DOMContentLoaded fired');
    const backButton = document.getElementById('back-button');
    console.log('[sidebar_config] backButton element:', backButton);

    if (backButton) {
      backButton.addEventListener('click', goBack);
      console.log('[sidebar_config] ✅ 戻るボタンにgoBack()イベントリスナーを設定しました');
    } else {
      console.error('[sidebar_config] ❌ 戻るボタンが見つかりません');
    }

    // 権限設定タブのクリックイベント
    const permissionTab = document.getElementById('system-permission-tab');
    if (permissionTab) {
      permissionTab.addEventListener('shown.bs.tab', loadPermissionSettings);
    }
  });

  // ================= 権限設定機能 (PERM-001 Phase 2) =================

  // メニュー定義（メニューIDとラベル）
  const MENU_DEFINITIONS = [
    { id: 'config-product', label: '📝 商品登録設定', defaultOwnerOnly: true },
    { id: 'master-product', label: '🗂️ マスタ管理（商品）', defaultOwnerOnly: false },
    { id: 'master-business', label: '🗂️ マスタ管理（業務）', defaultOwnerOnly: false },
    { id: 'inventory', label: '📦 在庫管理', defaultOwnerOnly: false },
    { id: 'inventory_history', label: '📋 入出庫履歴', defaultOwnerOnly: false },
    { id: 'chat', label: '💬 チャット', defaultOwnerOnly: false }
  ];

  let permissionSettingsLoaded = false;
  let usersData = [];
  let menuPermissions = {};

  /**
   * 権限設定を読み込む
   */
  async function loadPermissionSettings() {
    if (permissionSettingsLoaded) {
      console.log('[PERM] 権限設定は既に読み込み済み');
      return;
    }

    console.log('[PERM] 権限設定を読み込み中...');

    try {
      if (!window.db) {
        throw new Error('Firestoreが初期化されていません');
      }

      // 1. ユーザー一覧を取得
      const usersSnapshot = await window.db.collection('users').get();
      usersData = [];
      usersSnapshot.forEach(doc => {
        const data = doc.data();
        usersData.push({
          email: doc.id,
          userName: data.userName || doc.id,
          permissionId: data.permissionId || 'staff',
          permissionDisplay: data.permissionDisplay || '📋 スタッフ'
        });
      });
      console.log('[PERM] ユーザー数:', usersData.length);

      // 2. メニュー権限設定を取得
      const menuPermDoc = await window.db.collection('settings').doc('menuPermissions').get();
      if (menuPermDoc.exists) {
        menuPermissions = menuPermDoc.data();
      } else {
        // デフォルト設定を作成
        menuPermissions = {};
        MENU_DEFINITIONS.forEach(menu => {
          menuPermissions[menu.id] = {
            label: menu.label,
            visibleTo: menu.defaultOwnerOnly ? ['owner'] : ['owner', 'staff', 'contractor']
          };
        });
      }
      console.log('[PERM] メニュー権限設定:', menuPermissions);

      // 3. UIを描画
      renderUserPermissionList();
      renderMenuPermissionList();

      // ローディング非表示、コンテンツ表示
      document.getElementById('permissionSettingsLoading').style.display = 'none';
      document.getElementById('permissionSettingsContent').style.display = 'block';

      permissionSettingsLoaded = true;
      console.log('[PERM] ✅ 権限設定の読み込み完了');

    } catch (error) {
      console.error('[PERM] ❌ 権限設定読み込みエラー:', error);
      alert('権限設定の読み込みに失敗しました: ' + error.message);
    }
  }

  /**
   * ユーザー権限リストを描画
   */
  function renderUserPermissionList() {
    const container = document.getElementById('userPermissionList');
    if (!container) return;

    if (usersData.length === 0) {
      container.innerHTML = '<div style="color: #6b7280; font-size: 13px;">ユーザーが登録されていません</div>';
      return;
    }

    // 現在のユーザーのメールアドレス
    const currentUserEmail = localStorage.getItem('reborn_user_email');

    container.innerHTML = usersData.map(user => {
      const isCurrentUser = user.email === currentUserEmail;
      const isOwner = user.permissionId === 'owner';

      return `
        <div style="padding: 12px; background: ${isCurrentUser ? '#f0f9ff' : '#f9fafb'}; border-radius: 8px; border: 1px solid ${isCurrentUser ? '#bfdbfe' : '#e5e7eb'};">
          <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 2px;">${user.userName}</div>
          <div style="font-size: 12px; color: #6b7280; margin-bottom: 10px;">${user.email}</div>
          <select
            data-email="${user.email}"
            onchange="updateUserPermission(this)"
            style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 14px; background: white;"
            ${isCurrentUser && isOwner ? 'disabled title="自分自身の権限は変更できません"' : ''}
          >
            <option value="owner" ${user.permissionId === 'owner' ? 'selected' : ''}>🔑 オーナー</option>
            <option value="staff" ${user.permissionId === 'staff' ? 'selected' : ''}>📋 スタッフ</option>
            <option value="contractor" ${user.permissionId === 'contractor' ? 'selected' : ''}>🔧 外注</option>
          </select>
        </div>
      `;
    }).join('');
  }

  /**
   * メニュー権限リストを描画
   */
  function renderMenuPermissionList() {
    const container = document.getElementById('menuPermissionList');
    if (!container) return;

    container.innerHTML = MENU_DEFINITIONS.map(menu => {
      const perm = menuPermissions[menu.id] || { visibleTo: ['owner', 'staff', 'contractor'] };
      const staffChecked = perm.visibleTo.includes('staff') ? 'checked' : '';
      const contractorChecked = perm.visibleTo.includes('contractor') ? 'checked' : '';

      return `
        <div style="padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
          <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">${menu.label}</div>
          <div style="display: flex; gap: 16px; flex-wrap: wrap;">
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="checkbox" checked disabled style="width: 16px; height: 16px;">
              <span style="font-size: 12px; color: #6b7280;">🔑 オーナー（常時表示）</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="checkbox" data-menu="${menu.id}" data-role="staff" ${staffChecked} onchange="updateMenuPermission(this)" style="width: 16px; height: 16px; cursor: pointer;">
              <span style="font-size: 12px; color: #374151;">📋 スタッフ</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="checkbox" data-menu="${menu.id}" data-role="contractor" ${contractorChecked} onchange="updateMenuPermission(this)" style="width: 16px; height: 16px; cursor: pointer;">
              <span style="font-size: 12px; color: #374151;">🔧 外注</span>
            </label>
          </div>
        </div>
      `;
    }).join('');
  }

  /**
   * ユーザー権限を更新（メモリ上）
   */
  function updateUserPermission(selectElement) {
    const email = selectElement.dataset.email;
    const newPermissionId = selectElement.value;
    const permissionMap = {
      'owner': '🔑 オーナー',
      'staff': '📋 スタッフ',
      'contractor': '🔧 外注'
    };

    const user = usersData.find(u => u.email === email);
    if (user) {
      user.permissionId = newPermissionId;
      user.permissionDisplay = permissionMap[newPermissionId];
      console.log('[PERM] ユーザー権限を変更:', email, '->', newPermissionId);
    }
  }

  /**
   * メニュー権限を更新（メモリ上）
   */
  function updateMenuPermission(checkbox) {
    const menuId = checkbox.dataset.menu;
    const role = checkbox.dataset.role;
    const isChecked = checkbox.checked;

    if (!menuPermissions[menuId]) {
      menuPermissions[menuId] = { visibleTo: ['owner'] };
    }

    const visibleTo = menuPermissions[menuId].visibleTo;
    if (isChecked && !visibleTo.includes(role)) {
      visibleTo.push(role);
    } else if (!isChecked && visibleTo.includes(role)) {
      const index = visibleTo.indexOf(role);
      visibleTo.splice(index, 1);
    }

    console.log('[PERM] メニュー権限を変更:', menuId, '->', visibleTo);
  }

  /**
   * 権限設定を保存
   */
  async function savePermissionSettings() {
    const saveBtn = document.getElementById('savePermissionSettingsBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '保存中...';
    saveBtn.disabled = true;

    try {
      if (!window.db) {
        throw new Error('Firestoreが初期化されていません');
      }

      // 1. ユーザー権限を更新
      const batch = window.db.batch();
      usersData.forEach(user => {
        const userRef = window.db.collection('users').doc(user.email);
        batch.update(userRef, {
          permissionId: user.permissionId,
          permissionDisplay: user.permissionDisplay,
          lastUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      });

      // 2. メニュー権限設定を保存
      const menuPermRef = window.db.collection('settings').doc('menuPermissions');
      batch.set(menuPermRef, menuPermissions);

      await batch.commit();

      alert('✅ 権限設定を保存しました');
      console.log('[PERM] ✅ 権限設定を保存しました');

    } catch (error) {
      console.error('[PERM] ❌ 権限設定保存エラー:', error);
      alert('権限設定の保存に失敗しました: ' + error.message);
    } finally {
      saveBtn.innerHTML = originalText;
      saveBtn.disabled = false;
    }
  }
</script>

</body>
</html>
