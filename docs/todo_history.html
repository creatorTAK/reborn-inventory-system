<!DOCTYPE html>
<html>
<head>
  <!-- v284: ヘッダーUIをボトムナビスタイルに統一 -->
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>完了した履歴</title>
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- REBORN Brand Colors & Theme -->
  <link rel="stylesheet" href="/css/reborn-brand-colors.css?v=284">
  <link rel="stylesheet" href="/css/reborn-theme.css?v=284">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }
    /* 白いサブページヘッダー */
    .page-header {
      background: #ffffff;
      height: 56px;
      padding: 0 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid #f0f0f0;
    }
    .page-header h1 {
      font-size: 17px;
      font-weight: 600;
      color: #333;
      margin: 0;
    }
    .back-button {
      position: absolute;
      left: 8px;
      background: transparent;
      border: none;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #333;
      font-size: 22px;
      border-radius: 50%;
    }
    .back-button:active {
      background: #f2f2f2;
    }
    /* 月選択メニューボタン */
    .month-menu-button {
      position: absolute;
      right: 8px;
      background: transparent;
      border: none;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #333;
      font-size: 20px;
      border-radius: 50%;
    }
    .month-menu-button:active {
      background: #f2f2f2;
    }
    /* 月選択ドロップダウン */
    .month-dropdown {
      position: fixed;
      top: 56px;
      right: 8px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 180px;
      max-height: 400px;
      overflow-y: auto;
      padding: 8px 0;
      display: none;
      z-index: 1001;
    }
    .month-dropdown.active {
      display: block;
    }
    .month-dropdown-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      font-size: 14px;
      color: #333;
      cursor: pointer;
      transition: background 0.15s;
    }
    .month-dropdown-item:hover {
      background: #f5f5f5;
    }
    .month-dropdown-item.active {
      background: #e8f4fd;
      color: #40B4E5;
      font-weight: 600;
    }
    .month-dropdown-item i {
      margin-right: 10px;
      font-size: 16px;
    }
    .dropdown-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: transparent;
      z-index: 1000;
      display: none;
    }
    .dropdown-overlay.active {
      display: block;
    }
    /* 現在選択中の月表示 */
    .current-month-label {
      font-size: 13px;
      color: #666;
      text-align: center;
      padding: 8px 16px;
      background: #f9fafb;
      margin-bottom: 8px;
    }
    .tasks-container {
      padding: 16px;
      max-width: 600px;
      margin: 0 auto;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      padding-left: 4px;
    }
    .task-item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-left: 4px solid #9ca3af;
      opacity: 0.9;
    }
    .task-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .task-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: #d1fae5;
      color: #059669;
      font-size: 14px;
    }
    .task-content {
      flex: 1;
    }
    .task-title {
      font-size: 15px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 4px;
      text-decoration: line-through;
    }
    .task-description {
      font-size: 13px;
      color: #9ca3af;
      line-height: 1.4;
    }
    .task-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      font-size: 12px;
      color: #9ca3af;
    }
    .task-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #f3f4f6;
    }
    .delete-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      background: #fef2f2;
      color: #dc2626;
      border: none;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .delete-btn:hover {
      background: #fee2e2;
    }
    .delete-all-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #ef4444;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .delete-all-btn:hover {
      background: #dc2626;
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }
    .empty-state i {
      font-size: 48px;
      margin-bottom: 16px;
      display: block;
    }
    .empty-state p {
      font-size: 16px;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    .type-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    .type-badge.pending_user_approval {
      background: #fef3c7;
      color: #92400e;
    }
    .type-badge.inventory_alert {
      background: #fee2e2;
      color: #991b1b;
    }
    .type-badge.default {
      background: #e0e7ff;
      color: #3730a3;
    }
    .info-text {
      text-align: center;
      font-size: 12px;
      color: #9ca3af;
      margin-top: 16px;
      padding: 0 16px;
    }
  </style>
</head>
<body>
  <div class="page-header">
    <button class="back-button" onclick="goBack()" title="戻る">
      <i class="bi bi-chevron-left"></i>
    </button>
    <h1>完了した履歴</h1>
    <button class="month-menu-button" onclick="toggleMonthDropdown()" title="月を選択">
      <i class="bi bi-calendar3"></i>
    </button>
  </div>

  <!-- ドロップダウンオーバーレイ -->
  <div class="dropdown-overlay" id="dropdownOverlay" onclick="closeMonthDropdown()"></div>

  <!-- 月選択ドロップダウン -->
  <div class="month-dropdown" id="monthDropdown">
    <!-- JavaScriptで動的に生成 -->
  </div>

  <div class="tasks-container">
    <!-- 選択中の月ラベル -->
    <div class="current-month-label" id="currentMonthLabel"></div>
    <div id="loading" class="loading">
      <i class="bi bi-arrow-repeat"></i> 読み込み中...
    </div>

    <div id="completed-tasks" style="display: none;">
      <div class="section-header">
        <div class="section-title">完了したタスク</div>
        <button class="delete-all-btn" id="delete-all-btn" onclick="deleteAllTasks()">
          <i class="bi bi-trash3"></i>
          <span>全削除</span>
        </button>
      </div>
      <div id="completed-tasks-list"></div>
    </div>



    <div id="empty-state" class="empty-state" style="display: none;">
      <i class="bi bi-inbox"></i>
      <p>完了した履歴はありません</p>
    </div>

    <div class="info-text">
      完了したタスクは1年間保存されます
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    // URL パラメータを取得
    const urlParams = new URLSearchParams(window.location.search);
    const userEmail = urlParams.get('userEmail') || '';
    const parentOrigin = urlParams.get('parentOrigin') || window.location.origin;
    const pmToken = urlParams.get('pmToken') || '';

    // Firebase 初期化
    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "furira.jp",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    let completedTaskIds = [];
    let allCompletedTasks = [];
    let selectedMonth = null; // null = 今月、'YYYY-MM' = 特定月

    // 完了タスク一覧を読み込み
    async function loadCompletedTasks() {
      if (!userEmail) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('empty-state').style.display = 'block';
        return;
      }

      try {
        const tasksRef = db.collection('userTasks').doc(userEmail).collection('tasks');
        // インデックス不要のシンプルなクエリ（クライアント側でソート）
        const snapshot = await tasksRef
          .where('completed', '==', true)
          .get();

        const completedTasks = [];
        snapshot.forEach(doc => {
          const task = { id: doc.id, ...doc.data() };
          completedTasks.push(task);
        });

        // クライアント側で completedAt の降順にソート
        completedTasks.sort((a, b) => {
          const dateA = a.completedAt ? (a.completedAt.toDate ? a.completedAt.toDate() : new Date(a.completedAt)) : new Date(0);
          const dateB = b.completedAt ? (b.completedAt.toDate ? b.completedAt.toDate() : new Date(b.completedAt)) : new Date(0);
          return dateB - dateA;
        });

        allCompletedTasks = completedTasks;

        // 月リストを生成
        generateMonthList();

        // 表示を更新
        displayTasksForMonth(selectedMonth);

      } catch (error) {
        console.error('タスク読み込みエラー:', error);
        document.getElementById('loading').innerHTML = '<i class="bi bi-exclamation-circle"></i> 読み込みエラー';
      }
    }

    // 月リストを生成
    function generateMonthList() {
      const months = new Map();
      const now = new Date();
      const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

      // 今月は必ず含める
      months.set(currentMonthKey, formatMonthLabel(currentMonthKey));

      // タスクから月を抽出
      allCompletedTasks.forEach(task => {
        if (task.completedAt) {
          const date = task.completedAt.toDate ? task.completedAt.toDate() : new Date(task.completedAt);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          if (!months.has(monthKey)) {
            months.set(monthKey, formatMonthLabel(monthKey));
          }
        }
      });

      // 月キーでソート（新しい順）
      const sortedMonths = Array.from(months.entries()).sort((a, b) => b[0].localeCompare(a[0]));

      // ドロップダウンに月リストを表示
      const dropdown = document.getElementById('monthDropdown');
      dropdown.innerHTML = sortedMonths.map(([key, label]) => {
        const isActive = (selectedMonth === null && key === currentMonthKey) || selectedMonth === key;
        const isCurrent = key === currentMonthKey;
        return `
          <div class="month-dropdown-item ${isActive ? 'active' : ''}" onclick="selectMonth('${key}')">
            <i class="bi ${isCurrent ? 'bi-calendar-check' : 'bi-calendar3'}"></i>
            ${label}${isCurrent ? ' (今月)' : ''}
          </div>
        `;
      }).join('');
    }

    // 月ラベルをフォーマット
    function formatMonthLabel(monthKey) {
      const [year, month] = monthKey.split('-');
      return `${year}年${parseInt(month)}月`;
    }

    // 特定月のタスクを表示
    function displayTasksForMonth(monthKey) {
      document.getElementById('loading').style.display = 'none';

      const now = new Date();
      const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      const targetMonth = monthKey || currentMonthKey;

      // 月ラベルを更新
      const monthLabel = document.getElementById('currentMonthLabel');
      if (targetMonth === currentMonthKey) {
        monthLabel.textContent = `${formatMonthLabel(targetMonth)}（今月）の完了タスク`;
      } else {
        monthLabel.textContent = `${formatMonthLabel(targetMonth)} の完了タスク`;
      }

      // 該当月のタスクをフィルタ
      const filteredTasks = allCompletedTasks.filter(task => {
        if (!task.completedAt) return false;
        const date = task.completedAt.toDate ? task.completedAt.toDate() : new Date(task.completedAt);
        const taskMonthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        return taskMonthKey === targetMonth;
      });

      completedTaskIds = filteredTasks.map(t => t.id);

      if (filteredTasks.length === 0) {
        document.getElementById('completed-tasks').style.display = 'none';
        document.getElementById('empty-state').style.display = 'block';
        return;
      }

      document.getElementById('empty-state').style.display = 'none';
      document.getElementById('completed-tasks').style.display = 'block';
      document.getElementById('completed-tasks-list').innerHTML = filteredTasks.map(task => renderTask(task)).join('');
    }

    // 月を選択
    function selectMonth(monthKey) {
      selectedMonth = monthKey;
      closeMonthDropdown();
      displayTasksForMonth(monthKey);
      generateMonthList(); // アクティブ状態を更新
    }

    // ドロップダウンを開閉
    function toggleMonthDropdown() {
      const dropdown = document.getElementById('monthDropdown');
      const overlay = document.getElementById('dropdownOverlay');
      const isActive = dropdown.classList.contains('active');

      if (isActive) {
        closeMonthDropdown();
      } else {
        dropdown.classList.add('active');
        overlay.classList.add('active');
      }
    }

    // ドロップダウンを閉じる
    function closeMonthDropdown() {
      document.getElementById('monthDropdown').classList.remove('active');
      document.getElementById('dropdownOverlay').classList.remove('active');
    }

    // タスクをレンダリング
    function renderTask(task) {
      const typeLabel = getTypeLabel(task.type);
      const typeBadgeClass = task.type || 'default';
      const completedAt = task.completedAt ? formatDate(task.completedAt.toDate ? task.completedAt.toDate() : new Date(task.completedAt)) : '';

      return `
        <div class="task-item" data-task-id="${task.id}">
          <div class="task-header">
            <div class="task-icon"><i class="bi bi-check"></i></div>
            <div class="task-content">
              <div class="task-title">${escapeHtml(task.title)}</div>
              <div class="task-description">${escapeHtml(task.description)}</div>
              <div class="task-meta">
                <span class="type-badge ${typeBadgeClass}">${typeLabel}</span>
                <span>完了: ${completedAt}</span>
              </div>
            </div>
          </div>
          <div class="task-actions">
            <button class="delete-btn" onclick="deleteTask('${task.id}')">
              <i class="bi bi-trash3"></i> 削除
            </button>
          </div>
        </div>
      `;
    }

    // タスクタイプのラベルを取得
    function getTypeLabel(type) {
      const labels = {
        'pending_user_approval': 'ユーザー承認',
        'inventory_alert': '在庫アラート'
      };
      return labels[type] || 'タスク';
    }

    // 日付をフォーマット
    function formatDate(date) {
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return 'たった今';
      if (minutes < 60) return `${minutes}分前`;
      if (hours < 24) return `${hours}時間前`;
      if (days < 7) return `${days}日前`;

      return `${date.getMonth() + 1}/${date.getDate()}`;
    }

    // HTMLエスケープ
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // タスクを削除
    async function deleteTask(taskId) {
      if (!confirm('このタスクを削除しますか？')) return;

      try {
        await db.collection('userTasks').doc(userEmail).collection('tasks').doc(taskId).delete();
        console.log('タスク削除:', taskId);
        loadCompletedTasks(); // 再読み込み
      } catch (error) {
        console.error('タスク削除エラー:', error);
        alert('タスクの削除に失敗しました');
      }
    }

    // すべてのタスクを削除
    async function deleteAllTasks() {
      if (!confirm('すべての完了履歴を削除しますか？\nこの操作は取り消せません。')) return;

      try {
        const batch = db.batch();
        for (const taskId of completedTaskIds) {
          const taskRef = db.collection('userTasks').doc(userEmail).collection('tasks').doc(taskId);
          batch.delete(taskRef);
        }
        await batch.commit();
        console.log('すべてのタスクを削除');
        loadCompletedTasks(); // 再読み込み
      } catch (error) {
        console.error('一括削除エラー:', error);
        alert('削除に失敗しました');
      }
    }

    // 戻るボタン（二重発火防止付き）
    let isNavigatingBack = false;
    function goBack() {
      // 二重発火防止
      if (isNavigatingBack) {
        console.log('[todo_history] ⚠️ 二重発火を防止しました');
        return;
      }
      isNavigatingBack = true;

      if (window.parent && window.parent !== window) {
        // 親に「戻りたい」という要求を送る（チャットと同じgoBackタイプを使用）
        window.parent.postMessage({
          type: 'goBack',
          pmToken: pmToken
        }, parentOrigin);
        console.log('[todo_history] goBack sent to parent (v284)');
      } else {
        history.back();
      }

      // 500ms後にフラグをリセット（ページ遷移が完了しなかった場合のため）
      setTimeout(() => { isNavigatingBack = false; }, 500);
    }

    // 初期化
    loadCompletedTasks();
  </script>
</body>
</html>
