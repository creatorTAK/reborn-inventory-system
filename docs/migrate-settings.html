<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>設定マイグレーション - FURIRA</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
    .card { background: #f5f5f5; border-radius: 8px; padding: 20px; margin: 20px 0; }
    pre { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 12px; }
    button { background: #40B4E5; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
    button:hover { background: #1E8FBF; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .success { color: #22c55e; }
    .error { color: #ef4444; }
    .warning { color: #f59e0b; }
    #status { margin-top: 20px; padding: 15px; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>📦 設定マイグレーション</h1>

  <div class="card">
    <h2>現在のデフォルト値</h2>
    <p>以下の値をFirestoreに保存します：</p>

    <h3>🔘 商品状態ボタン</h3>
    <pre id="conditionButtonsPreview" style="max-height: 300px; overflow-y: auto;"></pre>

    <h3>💰 割引情報</h3>
    <pre id="discountPreview"></pre>

    <h3>🏷️ ハッシュタグ</h3>
    <pre id="hashtagPreview"></pre>
  </div>

  <div class="card">
    <h2>操作</h2>
    <button id="checkBtn">現在のFirestore設定を確認</button>
    <button id="migrateBtn">すべてFirestoreに保存</button>
    <button id="migrateConditionBtn" style="background: #22c55e;">商品状態ボタンのみ保存</button>
  </div>

  <div class="card">
    <h2>🔧 素材マスタ修正</h2>
    <p>素材(箇所)の重複項目「表地：」を削除します（「表地」は残ります）</p>
    <button id="fixMaterialLocationBtn" style="background: #f59e0b;">「表地：」重複を確認・削除</button>
  </div>

  <div id="status"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <script>
    // Firebase設定
    const firebaseConfig = {
      apiKey: "AIzaSyA4hNktMqmUBArzKRpMt_Q9f5EiL0xlegk",
      authDomain: "furira.jp",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "618498936498",
      appId: "1:618498936498:web:ccd51d56455cb34261c4ba",
      measurementId: "G-LT40ET0CXZ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 現在のデフォルト値
    const discountConfig = {
      'フォロー割': [
        { '範囲': '〜2,999円', '割引額': '100円引' },
        { '範囲': '〜5,999円', '割引額': '200円引' },
        { '範囲': '〜8,999円', '割引額': '300円引' },
        { '範囲': '9,000円〜', '割引額': '500円引' }
      ],
      'リピート割': [
        { '範囲': '', '割引額': '200円引' }
      ],
      'まとめ割': [
        { '範囲': '2点', '割引額': '300円' },
        { '範囲': '3点', '割引額': '500円' },
        { '範囲': '4点', '割引額': '1,000円' }
      ]
    };

    const hashtagConfig = {
      commonPrefix: '#REBORN_',
      hashtags: [
        {
          title: '全商品',
          suffix: '全商品',
          icon: '🏷️',
          defaultChecked: true
        }
      ]
    };

    // 商品状態ボタンのプリセット（配列形式に変換）
    // フィールド名: 商品の状態, ボタンラベル, ボタンテキスト
    const conditionButtonsConfig = [
      { '商品の状態': '新品、未使用', 'ボタンラベル': 'タグ付き未使用', 'ボタンテキスト': 'タグ付き未使用品です。' },
      { '商品の状態': '新品、未使用', 'ボタンラベル': '新品未開封', 'ボタンテキスト': '新品未開封です。' },
      { '商品の状態': '新品、未使用', 'ボタンラベル': '試着のみ', 'ボタンテキスト': '試着のみの未使用品です。' },
      { '商品の状態': '未使用に近い', 'ボタンラベル': '数回着用', 'ボタンテキスト': '数回のみ着用の美品です。' },
      { '商品の状態': '未使用に近い', 'ボタンラベル': 'ほぼ未使用', 'ボタンテキスト': 'ほぼ未使用に近い状態です。' },
      { '商品の状態': '未使用に近い', 'ボタンラベル': '室内試着のみ', 'ボタンテキスト': '室内で試着したのみです。' },
      { '商品の状態': '目立った傷や汚れなし', 'ボタンラベル': '美品', 'ボタンテキスト': 'ほとんど使用感がなく、とても綺麗な状態です。' },
      { '商品の状態': '目立った傷や汚れなし', 'ボタンラベル': '保管時のシワ', 'ボタンテキスト': '保管時の小さなシワがありますが、着用には問題ありません。' },
      { '商品の状態': '目立った傷や汚れなし', 'ボタンラベル': '着用感少ない', 'ボタンテキスト': '着用感が少なく、まだまだご使用いただけます。' },
      { '商品の状態': 'やや傷や汚れあり', 'ボタンラベル': '使用感あり', 'ボタンテキスト': '若干の使用感がありますが、着用に問題ありません。' },
      { '商品の状態': 'やや傷や汚れあり', 'ボタンラベル': '小さな汚れ', 'ボタンテキスト': '目立たない程度の小さな汚れがあります。' },
      { '商品の状態': 'やや傷や汚れあり', 'ボタンラベル': '毛玉あり', 'ボタンテキスト': '若干の毛玉がございますが、まだまだご使用いただけます。' },
      { '商品の状態': 'やや傷や汚れあり', 'ボタンラベル': '色褪せあり', 'ボタンテキスト': '若干の色褪せがありますが、着用には問題ありません。' },
      { '商品の状態': '傷や汚れあり', 'ボタンラベル': '使用感強い', 'ボタンテキスト': '使用感が強めですが、まだご使用いただけます。' },
      { '商品の状態': '傷や汚れあり', 'ボタンラベル': '汚れあり', 'ボタンテキスト': '汚れがございます。写真でご確認ください。' },
      { '商品の状態': '傷や汚れあり', 'ボタンラベル': '傷あり', 'ボタンテキスト': '傷がございます。写真でご確認ください。' },
      { '商品の状態': '全体的に状態が悪い', 'ボタンラベル': '全体的に傷あり', 'ボタンテキスト': '全体的に傷や汚れがあります。ご了承の上ご購入ください。' },
      { '商品の状態': '全体的に状態が悪い', 'ボタンラベル': '目立つ汚れ', 'ボタンテキスト': '目立つ汚れがあります。写真をよくご確認ください。' }
    ];

    // プレビュー表示
    document.getElementById('conditionButtonsPreview').textContent = JSON.stringify(conditionButtonsConfig, null, 2);
    document.getElementById('discountPreview').textContent = JSON.stringify(discountConfig, null, 2);
    document.getElementById('hashtagPreview').textContent = JSON.stringify(hashtagConfig, null, 2);

    const statusDiv = document.getElementById('status');

    function showStatus(message, type = 'info') {
      const color = type === 'success' ? '#dcfce7' : type === 'error' ? '#fee2e2' : type === 'warning' ? '#fef3c7' : '#e0f2fe';
      statusDiv.innerHTML = `<div style="background: ${color}; padding: 15px; border-radius: 8px;">${message}</div>`;
    }

    // 現在の設定を確認
    document.getElementById('checkBtn').addEventListener('click', async () => {
      showStatus('Firestoreを確認中...');
      try {
        const docRef = db.collection('settings').doc('common');
        const doc = await docRef.get();

        if (doc.exists) {
          const data = doc.data();
          let html = '<h3>現在のFirestore設定:</h3>';
          html += '<pre style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto;">';
          html += '🔘 conditionButtons: ' + (data.conditionButtons && data.conditionButtons.length > 0 ? data.conditionButtons.length + '件' : '(未設定)') + '\n\n';
          html += '💰 discount: ' + (data.discount ? '設定済み' : '(未設定)') + '\n\n';
          html += '🏷️ hashtag: ' + (data.hashtag ? '設定済み' : '(未設定)');
          html += '</pre>';

          if (data.conditionButtons && data.conditionButtons.length > 0) {
            html += '<p class="success">✅ 商品状態ボタンは既に設定されています（' + data.conditionButtons.length + '件）</p>';
          } else {
            html += '<p class="warning">⚠️ 商品状態ボタンが未設定です。「商品状態ボタンのみ保存」をクリックしてください。</p>';
          }

          statusDiv.innerHTML = html;
        } else {
          showStatus('⚠️ settings/common ドキュメントが存在しません。マイグレーションで作成されます。', 'warning');
        }
      } catch (error) {
        showStatus('❌ エラー: ' + error.message, 'error');
      }
    });

    // 全設定マイグレーション実行
    document.getElementById('migrateBtn').addEventListener('click', async () => {
      if (!confirm('Firestoreに全ての設定（商品状態ボタン・割引情報・ハッシュタグ）を保存しますか？')) {
        return;
      }

      showStatus('保存中...');
      try {
        const docRef = db.collection('settings').doc('common');

        await docRef.set({
          conditionButtons: conditionButtonsConfig,
          discount: discountConfig,
          hashtag: hashtagConfig
        }, { merge: true });

        // localStorageにも保存
        localStorage.setItem('rebornConfig_conditionButtons', JSON.stringify(conditionButtonsConfig));
        localStorage.setItem('rebornConfig_discount', JSON.stringify(discountConfig));
        localStorage.setItem('rebornConfig_hashtag', JSON.stringify(hashtagConfig));

        showStatus('✅ 保存完了！FirestoreとlocalStorageに設定が保存されました。<br><br>このページを閉じて、商品登録画面を再読み込みしてください。', 'success');
      } catch (error) {
        showStatus('❌ エラー: ' + error.message, 'error');
      }
    });

    // 商品状態ボタンのみマイグレーション
    document.getElementById('migrateConditionBtn').addEventListener('click', async () => {
      if (!confirm('商品状態ボタンのプリセット（18件）をFirestoreに保存しますか？')) {
        return;
      }

      showStatus('保存中...');
      try {
        const docRef = db.collection('settings').doc('common');

        await docRef.set({
          conditionButtons: conditionButtonsConfig
        }, { merge: true });

        // localStorageにも保存
        localStorage.setItem('rebornConfig_conditionButtons', JSON.stringify(conditionButtonsConfig));

        showStatus('✅ 商品状態ボタンを保存しました（18件）！<br><br>このページを閉じて、商品登録画面を再読み込みしてください。', 'success');
      } catch (error) {
        showStatus('❌ エラー: ' + error.message, 'error');
      }
    });

    // 素材(箇所)から重複「表地：」を削除
    document.getElementById('fixMaterialLocationBtn')?.addEventListener('click', async () => {
      showStatus('素材(箇所)マスタを確認中...');
      try {
        // masterOptionsコレクションから素材(箇所)ドキュメントを取得
        const snapshot = await db.collection('masterOptions').get();
        let targetDoc = null;
        let currentItems = [];

        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.fieldName === '素材(箇所)') {
            targetDoc = doc;
            currentItems = data.items || [];
          }
        });

        if (!targetDoc) {
          showStatus('⚠️ 素材(箇所)マスタが見つかりません', 'warning');
          return;
        }

        // 現在の項目を表示
        let html = '<h3>現在の素材(箇所):</h3><ul>';
        currentItems.forEach(item => {
          const isDuplicate = item === '表地：';
          html += `<li${isDuplicate ? ' style="color:red;font-weight:bold;"' : ''}>${item}${isDuplicate ? ' ← 削除対象' : ''}</li>`;
        });
        html += '</ul>';

        // 「表地：」が含まれているか確認
        const hasDuplicate = currentItems.includes('表地：');
        if (!hasDuplicate) {
          html += '<p class="success">✅ 重複「表地：」は存在しません（修正不要）</p>';
          statusDiv.innerHTML = html;
          return;
        }

        // 確認ダイアログ
        html += '<p class="warning">⚠️ 「表地：」を削除しますか？（「表地」は残ります）</p>';
        html += '<button id="confirmFixBtn" style="background:#dc2626;margin-top:10px;">削除を実行</button>';
        statusDiv.innerHTML = html;

        document.getElementById('confirmFixBtn').addEventListener('click', async () => {
          showStatus('削除中...');
          try {
            // 「表地：」を除外した新しい配列
            const newItems = currentItems.filter(item => item !== '表地：');

            // Firestoreを更新
            await db.collection('masterOptions').doc(targetDoc.id).update({
              items: newItems
            });

            showStatus('✅ 「表地：」を削除しました！<br><br>商品登録画面を再読み込みしてください。<br><br>更新後の項目数: ' + newItems.length + '件', 'success');
          } catch (error) {
            showStatus('❌ 削除エラー: ' + error.message, 'error');
          }
        });
      } catch (error) {
        showStatus('❌ エラー: ' + error.message, 'error');
      }
    });
  </script>
</body>
</html>
