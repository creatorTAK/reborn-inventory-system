<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<link rel="apple-touch-icon" sizes="180x180" href="https://creatortak.github.io/reborn-inventory-system/icon-180.png">
<base target="_top">

<!-- iOS PWA対応 -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="フリラ">

<!-- PWA対応 -->
<meta name="theme-color" content="#000000">

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<!-- Algolia Search SDK (Lite版) -->
<script src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<!-- REBORN Brand Colors & Theme -->
<link rel="stylesheet" href="https://www.reborn-inventory.com/css/reborn-brand-colors.css?v=0bd1a9b">
<link rel="stylesheet" href="https://www.reborn-inventory.com/css/reborn-theme.css?v=0bd1a9b">

<!-- 外部CSSファイルに移動（トークン削減、ブラウザキャッシュ活用）-->
<link rel="stylesheet" href="/css/product-styles.css?v=94">
<!-- Sortable.js - タッチ対応のドラッグ&ドロップライブラリ -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
</head>
<body class="">


<!-- 統一ヘッダー -->
<div class="header">
  <div class="header-content">
    <button class="back-button" id="back-button">
      <i class="bi bi-chevron-left"></i>
    </button>
    <div class="header-title">
      <span style="font-size: 20px;">📝</span>
      商品登録
    </div>
    <div style="width: 40px;"></div>
  </div>
  </div>
</div>

<!-- プラットフォーム切り替えタブ -->
<div class="platform-tabs-container">
  <div class="platform-tabs" id="platformTabs">
    <button class="platform-tab active" data-platform="mercari" onclick="selectPlatform('mercari')">
      <img src="/images/platform/mercari.png" alt="メルカリ" class="platform-logo" style="width:18px;height:18px;">
      <span>メルカリ</span>
    </button>
    <button class="platform-tab" data-platform="mercari-shops" onclick="selectPlatform('mercari-shops')">
      <img src="/images/platform/mercari-shops.png" alt="メルカリShops" class="platform-logo" style="width:18px;height:18px;">
      <span>メルカリShops</span>
    </button>
    <button class="platform-tab" data-platform="yahoo-fleamarket" onclick="selectPlatform('yahoo-fleamarket')">
      <img src="/images/platform/yahoo-fleamarket.png" alt="Yahoo!フリマ" class="platform-logo" style="width:18px;height:18px;">
      <span>Yahoo!フリマ</span>
    </button>
    <button class="platform-tab" data-platform="yahoo-auction" onclick="selectPlatform('yahoo-auction')">
      <img src="/images/platform/yahoo-auction.png" alt="Yahoo!オークション" class="platform-logo" style="width:18px;height:18px;">
      <span>Yahoo!オークション</span>
    </button>
    <button class="platform-tab" data-platform="rakuma" onclick="selectPlatform('rakuma')">
      <img src="/images/platform/rakuma.png" alt="ラクマ" class="platform-logo" style="width:18px;height:18px;">
      <span>ラクマ</span>
    </button>
    <button class="platform-tab" data-platform="base" onclick="selectPlatform('base')">
      <img src="/images/platform/base.png" alt="BASE" class="platform-logo" style="width:18px;height:18px;">
      <span>BASE</span>
    </button>
  </div>
</div>

<!-- プラットフォーム別コンテンツ -->

<!-- メルカリ用コンテンツ -->
<div id="platform-content-mercari" class="platform-content">
<div class="content-container">
<div class="group management-section">
  <div class="group-title"><span class="group-emoji">🏷️</span> 管理番号</div>

  <div class="form-section">
    <!-- 動的に生成されるセグメント入力フィールド -->
    <div id="managementNumberFields" style="display: none;"></div>

    <!-- 使用可能な管理番号 -->
    <div id="managementNumberPreview" style="margin-top: 8px; display: none;">
      <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">使用可能な管理番号</label>
      <div style="display: flex; gap: 4px; align-items: stretch;">
        <input id="管理番号" type="text" readonly placeholder="自動採番されます" class="mgmt-number-field" style="flex: 1; background: #f3f4f6; color: #1f2937; font-weight: 600; text-align: left; border: 1px solid #d1d5db; padding: 6px 8px;">
        <button type="button" onclick="adjustManagementNumber(1)" class="mgmt-adjust-btn" style="width: 32px; padding: 0; border: 1px solid #d1d5db; background: white; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; border-radius: 4px;">▲</button>
        <button type="button" onclick="adjustManagementNumber(-1)" class="mgmt-adjust-btn" style="width: 32px; padding: 0; border: 1px solid #d1d5db; background: white; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; border-radius: 4px;">▼</button>
      </div>
    </div>

    <!-- 担当者 -->
    <div style="margin-top: 12px;">
      <label>担当者</label>
      <input type="text" id="担当者" readonly style="background-color: #f3f4f6; cursor: not-allowed;">
    </div>
  </div>
</div>
<div class="group basic-section">
  <div class="group-title"><span class="group-emoji">📋</span> 基本情報</div>

  <div class="form-section">
    <div class="section-title">カテゴリー</div>
    <div style="margin-top: 4px;">
      <label>大分類</label>
      <select id="大分類(カテゴリ)">
        <option value="">--選択してください--</option>
      </select>
    </div>

    <div style="margin-top: 8px;">
      <label>中分類</label>
      <select id="中分類(カテゴリ)" disabled>
        <option value="">--選択してください--</option>
      </select>
    </div>

    <div style="margin-top: 8px;">
      <label>小分類</label>
      <select id="小分類(カテゴリ)" disabled>
        <option value="">--選択してください--</option>
      </select>
    </div>

    <div id="saibunruiRow" style="display: none; margin-top: 8px;">
      <label>細分類1</label>
      <select id="細分類(カテゴリ)" disabled>
        <option value="">--選択してください--</option>
      </select>
    </div>

    <div style="display: none; margin-top: 8px;" id="saibunrui2Container">
      <label>細分類2</label>
      <select id="細分類2" disabled>
        <option value="">--選択してください--</option>
      </select>
    </div>

    <div style="margin-top: 8px;">
      <label>アイテム名</label>
      <select id="アイテム名" class="full" disabled>
        <option value="">--選択してください--</option>
      </select>
    </div>

    <div style="margin-top: 8px;">
      <label>サイズ</label>
      <select id="サイズ">
        <option value="">--選択してください--</option>
      </select>
    </div>

    <div style="margin-top: 8px;">
      <label>商品の状態</label>
      <select id="商品の状態">
        <option value="">--選択してください--</option>
      </select>
    </div>

    <div class="brand-field" style="margin-top: 8px; position: relative;">
      <label>ブランド</label>
      <input id="ブランド(英語)" autocomplete="off" placeholder="入力すると候補が表示されます">
      <div class="suggest" id="suggest-ブランド(英語)" hidden></div>
      <!-- ブランド(カナ)を隠しフィールドとして保持 -->
      <input type="hidden" id="ブランド(カナ)">
    </div>
  </div>
</div><div class="group title-section">
    <div class="group-title">
      <span><span class="group-emoji">✏️</span> 商品名</span>
    </div>

    <!-- 商品名プレビュー（ブロック外） -->
    <div style="margin-bottom: 12px;">
      <label style="display: flex; justify-content: space-between; align-items: center;">
        <span>商品名プレビュー</span>
        <span class="counter" id="nameCounter">
          <span id="nameCount">0</span>/<span id="nameMax">40</span> 文字
        </span>
      </label>
      <textarea id="商品名プレビュー" rows="2"
                placeholder="選択した値をスペース区切りで自動表示されます"
                style="margin-top: 4px;"></textarea>
      <input id="商品名(タイトル)" type="hidden">
    </div>

    <!-- ボタン -->
    <div style="margin-bottom: 16px;">
      <button type="button" onclick="copyToClipboard('商品名プレビュー', 'copyNameBtn')" id="copyNameBtn" style="width: 100%;">
        <span class="button-emoji">📋</span> 商品名をコピー
      </button>
    </div>

    <!-- 並び替え可能なブロックコンテナ -->
    <div id="titleBlockContainer">

    <!-- セールスワードセクション -->
    <div class="form-section title-draggable-block" data-block-id="salesword" draggable="true">
      <h3 class="section-title" style="display: flex; align-items: center; gap: 8px;">
        <span class="drag-handle" style="cursor: move; font-size: 16px; color: #9ca3af;">⋮⋮</span>
        <span class="section-icon">🏷️</span>セールスワード
        <button type="button" class="collapse-btn" onclick="toggleTitleBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
      </h3>
      <div class="section-content">
        <!-- セールスワード検索 -->
        <div style="margin-bottom: 12px; position: relative;">
          <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">🔍 キーワード検索</label>
          <input type="text" id="saleswordSearch" class="full" placeholder="キーワードを入力して検索..." autocomplete="off" style="font-size: 16px;">
          <div id="saleswordSuggestList" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
        </div>
        <div class="row">
          <div>
            <label>カテゴリ</label>
            <select id="セールスワード(カテゴリ)" class="full">
              <option value="">--選択してください--</option>
            </select>
          </div>
          <div>
            <label>キーワード</label>
            <select id="セールスワード" class="full">
              <option value="">--選択してください--</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- ブランド情報セクション -->
    <div class="form-section title-draggable-block" data-block-id="brand" draggable="true">
      <h3 class="section-title" style="display: flex; align-items: center; gap: 8px;">
        <span class="drag-handle" style="cursor: move; font-size: 16px; color: #9ca3af;">⋮⋮</span>
        <span class="section-icon">🏢</span>ブランド情報
        <button type="button" class="collapse-btn" onclick="toggleTitleBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
      </h3>
      <div class="section-content">
        <div class="row">
          <div class="brand-field" style="position: relative;">
            <label>ブランド(英語)</label>
            <div style="display: flex; align-items: center; gap: 4px; width: 100%;">
              <input type="checkbox" id="商品名_ブランド(英語)_チェック" checked onchange="updateNamePreview()" style="width: 20px; flex-shrink: 0;">
              <input id="商品名_ブランド(英語)" autocomplete="off" placeholder="入力すると候補が表示されます" style="flex: 1; min-width: 0;">
            </div>
            <div class="suggest" id="suggest-商品名_ブランド(英語)" hidden></div>
          </div>
          <div class="brand-field" style="position: relative;">
            <label>ブランド(カナ)</label>
            <div style="display: flex; align-items: center; gap: 4px; width: 100%;">
              <input type="checkbox" id="商品名_ブランド(カナ)_チェック" checked onchange="updateNamePreview()" style="width: 20px; flex-shrink: 0;">
              <input id="商品名_ブランド(カナ)" autocomplete="off" placeholder="入力すると候補が表示されます" style="flex: 1; min-width: 0;">
            </div>
            <div class="suggest" id="suggest-商品名_ブランド(カナ)" hidden></div>
          </div>
        </div>
      </div>
    </div>

    <!-- アイテム名セクション -->
    <div class="form-section title-draggable-block" data-block-id="item" draggable="true">
      <h3 class="section-title" style="display: flex; align-items: center; gap: 8px;">
        <span class="drag-handle" style="cursor: move; font-size: 16px; color: #9ca3af;">⋮⋮</span>
        <span class="section-icon">📦</span>アイテム名
        <button type="button" class="collapse-btn" onclick="toggleTitleBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
      </h3>
      <div class="section-content">
        <input id="商品名_アイテム名" type="text" placeholder="基本情報のアイテム名を選択するか、ここに直接入力" onchange="updateNamePreview()" oninput="updateNamePreview()" style="width: 100%;">
      </div>
    </div>

    <!-- 商品属性セクション -->
    <div class="form-section title-draggable-block" data-block-id="attribute" draggable="true">
      <h3 class="section-title" style="display: flex; align-items: center; gap: 8px;">
        <span class="drag-handle" style="cursor: move; font-size: 16px; color: #9ca3af;">⋮⋮</span>
        <span class="section-icon">🎨</span>商品属性
        <button type="button" class="collapse-btn" onclick="toggleTitleBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
      </h3>
      <div class="section-content">
        <div id="attributeList">
          <!-- 初期表示は1セット -->
          <div class="attribute-item" data-index="1">
            <div class="attribute-header">
              <span>属性 1</span>
              <button type="button" class="remove-attribute-btn" onclick="removeProductAttribute(1)" style="display:none;">削除</button>
            </div>

            <div class="row" style="margin-top: 6px;">
              <div>
                <label>カテゴリ</label>
                <select id="商品属性1_カテゴリ">
                  <option value="">--選択してください--</option>
                </select>
              </div>
              <div>
                <label>値</label>
                <select id="商品属性1_値" disabled>
                  <option value="">--カテゴリを選択してください--</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <button type="button" id="addAttributeBtn" class="add-attribute-btn">+ 商品属性を追加</button>
      </div>
    </div>

    </div><!-- titleBlockContainer -->

  </div><div class="group description-section">
  <div class="group-title">
    <span><span class="group-emoji">📝</span> 商品の説明</span>
  </div>

  <!-- 商品の説明欄（プレビュー） -->
  <div style="margin-bottom: 12px;">
    <label style="display: flex; justify-content: space-between; align-items: center;">
      <span>商品の説明</span>
      <span class="counter" id="descCounter">
        <span id="descCount">0</span>/<span id="descMax">1000</span> 文字
      </span>
    </label>
    <textarea
      id="商品の説明"
      placeholder="商品の状態・素材・サイズ感・ディテール・注意点などを記入してください"
      style="margin-top: 4px; min-height: 120px; resize: none;"
    ></textarea>
  </div>

  <!-- コピーボタン -->
  <div style="margin-bottom: 16px;">
    <button type="button" onclick="copyToClipboard('商品の説明', 'copyDescBtn')" id="copyDescBtn" style="width: 100%;">
      <span class="button-emoji">📋</span> 商品の説明をコピー
    </button>
  </div>

  <!-- ドラッグ可能なブロックコンテナ -->
  <div id="descriptionBlocksContainer">

  <!-- ブランド名セクション（条件付き表示） -->
  <div id="brandNameSection" class="form-section desc-draggable-block" data-block-type="brandName" style="margin-bottom: 12px; display: none;">
    <h3 class="section-title" style="display: flex; align-items: center;">
      <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">⋮⋮</span>
      <span class="section-icon">🏷️</span>ブランド名
      <button type="button" class="collapse-btn" onclick="toggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
    </h3>
    <div class="section-content">
      <div style="font-size: 11px; color: #6b7280; padding: 8px; background: #f9fafb; border-radius: 4px;">
        💡 基本情報で選択したブランド名が自動的にプレビューに表示されます。<br>
        このブロックの位置を変更することで、プレビュー内の表示位置を調整できます。
      </div>
    </div>
  </div>

  <!-- サイズ情報セクション -->
  <div id="sizeSection" class="form-section desc-draggable-block" data-block-type="size" style="margin-bottom: 12px; display: none;">
    <h3 class="section-title" style="display: flex; align-items: center;">
      <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">⋮⋮</span>
      <span class="section-icon" id="sizeIconDisplay">👕</span><span id="sizeLabelDisplay">サイズ</span>
      <button type="button" class="collapse-btn" onclick="toggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
    </h3>
    <div class="section-content">
      <!-- トップス/アウター用サイズ -->
      <div id="topsSize" style="display: none;">
        <!-- サイズ(表記) -->
        <div style="margin-bottom: 12px;">
          <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">サイズ(表記)</label>
          <select id="サイズ(表記)_トップス" style="width: 100%;">
            <option value="">--</option>
          </select>
        </div>

        <!-- サイズ(実寸) -->
        <div style="margin-bottom: 8px;">
          <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">サイズ(実寸)</label>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 4px;">
          <div>
            <label class="small" id="shoulderWidthLabel">肩幅</label>
            <div style="display: flex; align-items: center; gap: 4px;">
              <select id="肩幅" style="flex: 1;">
                <option value="">--</option>
              </select>
              <span style="font-size: 12px; color: #6b7280;">cm</span>
            </div>
          </div>
          <div>
            <label class="small">身幅</label>
            <div style="display: flex; align-items: center; gap: 4px;">
              <select id="身幅" style="flex: 1;">
                <option value="">--</option>
              </select>
              <span style="font-size: 12px; color: #6b7280;">cm</span>
            </div>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
          <div>
            <label class="small">袖丈</label>
            <div style="display: flex; align-items: center; gap: 4px;">
              <select id="袖丈" style="flex: 1;">
                <option value="">--</option>
              </select>
              <span style="font-size: 12px; color: #6b7280;">cm</span>
            </div>
          </div>
          <div>
            <label class="small">着丈</label>
            <div style="display: flex; align-items: center; gap: 4px;">
              <select id="着丈" style="flex: 1;">
                <option value="">--</option>
              </select>
              <span style="font-size: 12px; color: #6b7280;">cm</span>
            </div>
          </div>
        </div>
      </div>

      <!-- パンツ用サイズ -->
      <div id="bottomsSize" style="display: none;">
        <!-- サイズ(表記) -->
        <div style="margin-bottom: 12px;">
          <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">サイズ(表記)</label>
          <select id="サイズ(表記)_ボトムス" style="width: 100%;">
            <option value="">--</option>
          </select>
        </div>

        <!-- サイズ(実寸) -->
        <div style="margin-bottom: 8px;">
          <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">サイズ(実寸)</label>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 4px;">
          <div>
            <label class="small">ウエスト</label>
            <div style="display: flex; align-items: center; gap: 4px;">
              <select id="ウエスト" style="flex: 1;">
                <option value="">--</option>
              </select>
              <span style="font-size: 12px; color: #6b7280;">cm</span>
            </div>
          </div>
          <div>
            <label class="small">ヒップ</label>
            <div style="display: flex; align-items: center; gap: 4px;">
              <select id="ヒップ" style="flex: 1;">
                <option value="">--</option>
              </select>
              <span style="font-size: 12px; color: #6b7280;">cm</span>
            </div>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
          <div>
            <label class="small">股上</label>
            <div style="display: flex; align-items: center; gap: 4px;">
              <select id="股上" style="flex: 1;">
                <option value="">--</option>
              </select>
              <span style="font-size: 12px; color: #6b7280;">cm</span>
            </div>
          </div>
          <div>
            <label class="small">股下</label>
            <div style="display: flex; align-items: center; gap: 4px;">
              <select id="股下" style="flex: 1;">
                <option value="">--</option>
              </select>
              <span style="font-size: 12px; color: #6b7280;">cm</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 靴用サイズ -->
      <div id="shoesSize" style="display: none;">
        <!-- サイズ(表記) -->
        <div style="margin-bottom: 12px;">
          <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">サイズ(表記)</label>
          <select id="サイズ(表記)_靴" style="width: 100%;">
            <option value="">--</option>
          </select>
        </div>

        <!-- その他のサイズ表記 -->
        <div style="margin-bottom: 12px;">
          <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">その他のサイズ表記</label>
          <input type="text" id="その他のサイズ表記_靴" placeholder="例: US8, EU38" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
        </div>

        <!-- 普段のサイズ -->
        <div style="margin-bottom: 12px;">
          <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">普段のサイズ</label>
          <input type="text" id="普段のサイズ_靴" placeholder="例: 普段は25.0cmを履いています" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
        </div>

        <!-- フィット感 -->
        <div style="margin-bottom: 12px;">
          <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">フィット感・注意点</label>
          <textarea id="フィット感_靴" placeholder="例: 細めの作りです。普段より0.5cm大きめをおすすめします" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; min-height: 60px; resize: vertical;"></textarea>
        </div>

        <div style="font-size: 11px; color: #6b7280; padding: 8px; background: #f9fafb; border-radius: 4px;">
          💡 サイズ(表記)は基本情報ブロックで選択したサイズが自動反映されます。<br>
          💡 その他のサイズ表記、普段のサイズ、フィット感は購入者がサイズ感を把握しやすくするための補足情報です。
        </div>
      </div>
    </div>
  </div>

  <!-- カラー(詳細)セクション -->
  <div class="form-section desc-draggable-block" data-block-type="color" style="margin-bottom: 12px;">
    <h3 class="section-title" style="display: flex; align-items: center;">
      <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">⋮⋮</span>
      <span class="section-icon">🎨</span>カラー(詳細)
      <button type="button" class="collapse-btn" onclick="toggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
    </h3>
    <div class="section-content">
      <div id="colorList">
        <!-- 初期表示は1セット -->
        <div class="color-item" data-index="1">
          <div class="color-header">
            <span>カラー 1</span>
            <button type="button" class="remove-color-btn" onclick="removeColor(1)" style="display:none;">削除</button>
          </div>

          <div class="color-fields">
            <label>色:
              <select id="カラー1" class="color-select">
                <option value="">--</option>
              </select>
            </label>
          </div>
        </div>
      </div>

      <button type="button" id="addColorBtn" class="add-color-btn">+ カラーを追加</button>
    </div>
  </div>

  <!-- 商品状態(詳細)セクション -->
  <div class="form-section desc-draggable-block" data-block-type="condition" style="margin-bottom: 12px;">
    <h3 class="section-title" style="display: flex; align-items: center;">
      <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">⋮⋮</span>
      <span class="section-icon">📋</span>商品状態(詳細)
      <button type="button" class="collapse-btn" onclick="toggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
    </h3>
    <div class="section-content">
      <!-- クイック挿入ボタン群 -->
      <div id="quickInsertButtonsContainer" class="quick-insert-buttons" style="margin-bottom: 8px;">
        <!-- ボタンは「商品の状態」に応じて動的に表示 -->
      </div>

      <!-- オートコンプリート対応のテキストエリア -->
      <div style="position: relative;">
        <textarea
          id="商品状態詳細"
          rows="3"
          placeholder="商品の詳細な状態を入力してください（傷、汚れ、使用感など）"
        ></textarea>
        <div id="suggest-商品状態詳細" class="suggest" hidden></div>
      </div>
    </div>
  </div>

  <!-- 素材入力セクション -->
  <div class="form-section desc-draggable-block" data-block-type="material" style="margin-bottom: 12px;">
    <h3 class="section-title" style="display: flex; align-items: center;">
      <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">⋮⋮</span>
      <span class="section-icon">🧵</span>素材
      <button type="button" class="collapse-btn" onclick="toggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
    </h3>
    <div class="section-content">
      <div id="materialList">
        <!-- 初期表示は1セット -->
        <div class="material-item" data-index="1">
          <div class="material-header">
            <span>素材 1</span>
            <button type="button" class="remove-material-btn" onclick="removeMaterial(1)"
style="display:none;">削除</button>
          </div>

          <div class="material-fields">
            <label>箇所:
              <select id="素材1_箇所" class="material-location">
                <option value="">--</option>
              </select>
            </label>

            <div class="material-composition">
              <div class="composition-row">
                <label>種類:
                  <select id="素材1_種類1" class="material-type">
                    <option value="">--</option>
                  </select>
                </label>
                <label>割合:
                  <select id="素材1_％1" class="material-percent">
                    <option value="">--%</option>
                  </select>
                </label>
              </div>

              <div class="composition-row">
                <label>種類:
                  <select id="素材1_種類2" class="material-type">
                    <option value="">--</option>
                  </select>
                </label>
                <label>割合:
                  <select id="素材1_％2" class="material-percent">
                    <option value="">--%</option>
                  </select>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <button type="button" id="addMaterialBtn" class="add-material-btn">+ 素材を追加</button>
    </div>
  </div>

  <!-- AI生成ブロック（親） -->
  <div class="form-section desc-draggable-block" data-block-type="aiGeneration" style="margin-bottom: 12px;">
    <h3 class="section-title" style="display: flex; align-items: center;">
      <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">⋮⋮</span>
      <span class="section-icon">✨</span>AI生成
      <button type="button" class="collapse-btn" onclick="toggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
    </h3>
    <div class="section-content">
      <!-- 説明文 -->
      <div style="font-size: 11px; color: #6b7280; margin-bottom: 12px; padding: 8px; background: #f9fafb; border-radius: 6px; border-left: 3px solid #d1d5db;">
        <span class="info-emoji">💡</span> 以下の情報を入力してAI生成ボタンを押すと、魅力的な商品説明文が自動生成されます。<br>
        <span style="color: #6b7280;">⚠️ 生成後は必ず内容をご確認ください。</span>
      </div>

      <!-- サブブロック1: 追加属性（任意） -->
      <div class="ai-sub-block" style="margin-bottom: 12px; padding: 12px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px;">
        <h4 style="display: flex; align-items: center; margin: 0 0 8px 0; font-size: 13px; font-weight: 600; color: #374151; cursor: pointer;" onclick="toggleAiSubBlock(this)">
          <span class="section-icon">🏷️</span>追加属性（任意）
          <button type="button" class="ai-sub-collapse-btn" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 12px; color: #6b7280; padding: 0 8px;">▶</button>
        </h4>
        <div class="ai-sub-content" style="display: none;">
          <div style="font-size: 11px; color: #6b7280; margin-bottom: 8px; padding: 6px 8px; background: #f9fafb; border-radius: 4px;">
            <span class="info-emoji">💡</span> 商品の詳細な属性を入力してください。AI生成時に活用されます。
          </div>
          <textarea
            id="AI用商品属性"
            rows="3"
            placeholder="商品の詳細な属性を入力してください（例: ヴィンテージ、90年代、USA製、希少、限定品、タグ付き、デッドストック）&#10;&#10;カンマ区切りで複数入力可能です。"
            style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 13px; font-family: inherit; resize: vertical;"
          ></textarea>
          <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
            例: ヴィンテージ、90年代、USA製、希少、限定品
          </div>
        </div>
      </div>

      <!-- サブブロック2: 品番・製番（任意） -->
      <div class="ai-sub-block" style="margin-bottom: 12px; padding: 12px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px;">
        <h4 style="display: flex; align-items: center; margin: 0 0 8px 0; font-size: 13px; font-weight: 600; color: #374151; cursor: pointer;" onclick="toggleAiSubBlock(this)">
          <span class="section-icon">🔢</span>品番・製番（任意）
          <button type="button" class="ai-sub-collapse-btn" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 12px; color: #6b7280; padding: 0 8px;">▶</button>
        </h4>
        <div class="ai-sub-content" style="display: none;">
          <div style="font-size: 11px; color: #6b7280; margin-bottom: 8px; padding: 6px 8px; background: #f9fafb; border-radius: 4px;">
            <span class="info-emoji">💡</span> 商品の品番・型番を入力してください。
          </div>
          <input
            type="text"
            id="品番型番"
            placeholder="例: 555088-101, DM0522-100, FW23-M001"
            style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 13px;"
          />
        </div>
      </div>

      <!-- サブブロック3: 商品画像（任意） -->
      <div class="ai-sub-block" style="margin-bottom: 12px; padding: 12px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px;">
        <h4 style="display: flex; align-items: center; margin: 0 0 8px 0; font-size: 13px; font-weight: 600; color: #374151; cursor: pointer;" onclick="toggleAiSubBlock(this)">
          <span class="section-icon">📷</span>商品画像（任意）
          <button type="button" class="ai-sub-collapse-btn" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 12px; color: #6b7280; padding: 0 8px;">▶</button>
        </h4>
        <div class="ai-sub-content" style="display: none;">
          <div style="font-size: 11px; color: #6b7280; margin-bottom: 8px; padding: 6px 8px; background: #f9fafb; border-radius: 4px;">
            <span class="info-emoji">💡</span> 画像をアップロードするとAIが解析してより詳細な説明文を生成します
          </div>

          <!-- 画像選択ボタン -->
          <input
            type="file"
            id="productImages"
            accept="image/*"
            multiple
            style="display: none;"
            onchange="handleImageUpload(event)"
          />
          <button
            type="button"
            onclick="document.getElementById('productImages').click()"
            style="padding: 10px 16px; background: #e0f2fe; border: 2px dashed #0ea5e9; border-radius: 6px; color: #0369a1; font-size: 13px; cursor: pointer; width: 100%; font-weight: 500; margin-bottom: 12px;"
          >
            <span class="button-emoji">📷</span> 画像を選択
          </button>

          <!-- 画像プレビューエリア -->
          <div id="imagePreviewContainer" style="display: none;">
            <div style="display: flex; justify-content: space-between; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 8px;">
              <span>選択した画像（<span id="imageCount">0</span>/20）</span>
              <span>AI生成用: <span id="aiImageCount">0</span>/3</span>
            </div>
            <div id="imagePreviewList" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
              <!-- プレビュー画像がここに追加される -->
            </div>
          </div>
        </div>
      </div>

      <!-- AI生成ボタン（親ブロックの最後） -->
      <div style="margin-top: 12px;">
        <button
          type="button"
          onclick="generateAiDescription()"
          id="aiGenBtn"
          style="width: 100%; padding: 12px 16px; background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%); border: none; border-radius: 6px; color: white; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 4px rgba(139, 92, 246, 0.3);"
        >
          <span class="button-emoji">✨</span> AI生成
        </button>
      </div>
    </div>
  </div>

  <!-- 割引情報選択（折りたたみ可能） -->
  <div class="form-section desc-draggable-block" data-block-type="discount" style="margin-bottom: 12px;">
    <h3 class="section-title" style="display: flex; align-items: center;">
      <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">⋮⋮</span>
      <span class="section-icon">💰</span>割引情報
      <button type="button" class="collapse-btn" onclick="toggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
    </h3>
    <div id="discountSection" class="section-content collapsible-content">
      <div id="discountCheckboxContainer" style="padding: 8px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
        <!-- 割引情報チェックボックスが動的に生成される -->
        <div style="font-size: 11px; color: #6b7280; text-align: center;">読み込み中...</div>
      </div>
    </div>
  </div>

  <!-- オリジナルハッシュタグ選択（折りたたみ可能） -->
  <div class="form-section desc-draggable-block" data-block-type="hashtag" style="margin-bottom: 12px;">
    <h3 class="section-title" style="display: flex; align-items: center;">
      <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">⋮⋮</span>
      <span class="section-icon">🏷️</span>オリジナルハッシュタグ
      <button type="button" class="collapse-btn" onclick="toggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
    </h3>
    <div id="hashtagSection" class="section-content collapsible-content">
      <div id="hashtagCheckboxContainer" style="padding: 8px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
        <!-- ハッシュタグチェックボックスが動的に生成される -->
        <div style="font-size: 11px; color: #6b7280; text-align: center;">読み込み中...</div>
      </div>
    </div>
  </div>

  </div><!-- /descriptionBlocksContainer -->

</div>
<div class="group product-images-section" id="productImagesBlock" style="display: none;">
  <div class="group-title">
    <span><span class="group-emoji">🖼️</span> 商品画像</span>
  </div>
  <div class="form-section">
    <!-- ヒント -->
    <div style="font-size: 11px; color: #6b7280; margin-bottom: 12px; padding: 10px 12px; background: #f9fafb; border-radius: 6px; border-left: 3px solid #d1d5db; line-height: 1.6;">
      <span class="info-emoji">💡</span> メルカリShopsなどに出品する画像をアップロードします（最大20枚）<br>
      画像はJSON形式でGoogle Driveに保存され、チーム間で共有したり、複数のプラットフォームで使い回すことができます
    </div>

    <!-- 画像アップロード -->
    <div style="margin-bottom: 16px;">
      <input
        type="file"
        id="productImagesForSave"
        accept="image/*"
        multiple
        style="display: none;"
        onchange="handleProductImageUpload(event)"
      />
      <button
        type="button"
        onclick="document.getElementById('productImagesForSave').click()"
        style="padding: 10px 16px; background: #e0f2fe; border: 2px dashed #0ea5e9; border-radius: 6px; color: #0369a1; font-size: 13px; cursor: pointer; width: 100%; font-weight: 500;"
      >
        <span class="button-emoji">📷</span> 画像を選択
      </button>
    </div>

    <!-- 画像プレビューエリア -->
    <div id="productImagesPreviewContainer" style="display: none;">
      <div style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
        <span>アップロード済み（<span id="productImageCount">0</span>/20）</span>
        <button
          type="button"
          onclick="clearAllProductImages()"
          style="padding: 4px 8px; background: white; border: 1px solid #ef4444; border-radius: 4px; color: #ef4444; font-size: 11px; cursor: pointer; font-weight: 500;"
          title="すべての画像を削除"
        >
          🗑️ すべて削除
        </button>
      </div>
      <div id="productImagesPreviewList" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
        <!-- プレビュー画像がここに追加される -->
      </div>
    </div>
  </div>
</div>
<div class="group shipping-section">
  <div class="group-title"><span class="group-emoji">🚛</span> 配送について</div>
  <div class="form-section">
    <div class="row">
      <div>
        <label>配送料の負担</label>
        <select id="配送料の負担">
          <option value="送料込み(出品者負担)">送料込み(出品者負担)</option>
        </select>
      </div>
      <div>
        <label>配送の方法</label>
        <select id="配送の方法">
          <option value="ゆうゆうメルカリ便">ゆうゆうメルカリ便</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:4px;">
      <div>
        <label>発送元の地域</label>
        <select id="発送元の地域">
          <option value="岡山県">岡山県</option>
        </select>
      </div>
      <div>
        <label>発送までの日数</label>
        <select id="発送までの日数">
          <option value="1~2日で発送">1~2日で発送</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:4px;">
      <div>
        <label>梱包資材</label>
        <select id="梱包資材">
          <option value="">-- 選択してください --</option>
          <!-- Firestoreから動的に読み込まれます -->
        </select>
      </div>
      <div>
        <!-- 右側は空（将来的に他のフィールドを追加可能） -->
      </div>
    </div>
  </div>
</div><div class="group purchase-section">
  <div class="group-title"><span class="group-emoji">💰</span> 仕入情報</div>
  <div class="form-section">
    <div class="row">
      <div>
        <label>仕入日</label>
        <input id="仕入日" type="date">
      </div>
      <div>
        <label>仕入先</label>
        <select id="仕入先">
          <option value="">--選択してください--</option>
        </select>
      </div>
    </div>
    
    <div style="margin-top: 4px;">
      <label>仕入金額</label>
      <input id="仕入金額" type="number" min="0" step="1" placeholder="0">
    </div>
  </div>
</div><div class="group listing-section">
  <div class="group-title"><span class="group-emoji">📤</span> 出品情報</div>
  <div class="form-section">
    <div class="row">
      <div>
        <label>出品日</label>
        <input id="出品日" type="date">
      </div>
      <div>
        <label>出品先</label>
        <select id="出品先">
          <option value="">--選択してください--</option>
        </select>
      </div>
    </div>
    
    <div style="margin-top: 4px;">
      <label>出品金額</label>
      <input id="出品金額" type="number" min="0" step="1" placeholder="0">
    </div>
  </div>
</div><div class="actions">
<button onclick="onSave()">保存</button>
<button onclick="onReset()">リセット</button>
</div>
<div class="msg" id="msg"></div>
</div> <!-- /content-container -->
</div> <!-- /platform-content-mercari -->

<!-- メルカリShops用コンテンツ（開発中） -->
<div id="platform-content-mercari-shops" class="platform-content" style="display: none;">
  <div class="content-container">
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; padding: 40px 20px; text-align: center;">
      <img src="/images/platform/mercari-shops.png" alt="メルカリShops" style="width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.6;">
      <h2 style="font-size: 20px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">メルカリShops</h2>
      <p style="font-size: 14px; color: #6b7280; margin: 0 0 24px 0;">このプラットフォームは現在開発中です</p>
      <span style="display: inline-block; background: #fef3c7; color: #b45309; font-size: 12px; font-weight: 600; padding: 6px 16px; border-radius: 20px;">🚧 Coming Soon</span>
    </div>
  </div>
</div>

<!-- Yahoo!フリマ用コンテンツ（開発中） -->
<div id="platform-content-yahoo-fleamarket" class="platform-content" style="display: none;">
  <div class="content-container">
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; padding: 40px 20px; text-align: center;">
      <img src="/images/platform/yahoo-fleamarket.png" alt="Yahoo!フリマ" style="width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.6;">
      <h2 style="font-size: 20px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">Yahoo!フリマ</h2>
      <p style="font-size: 14px; color: #6b7280; margin: 0 0 24px 0;">このプラットフォームは現在開発中です</p>
      <span style="display: inline-block; background: #fef3c7; color: #b45309; font-size: 12px; font-weight: 600; padding: 6px 16px; border-radius: 20px;">🚧 Coming Soon</span>
    </div>
  </div>
</div>

<!-- Yahoo!オークション用コンテンツ（開発中） -->
<div id="platform-content-yahoo-auction" class="platform-content" style="display: none;">
  <div class="content-container">
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; padding: 40px 20px; text-align: center;">
      <img src="/images/platform/yahoo-auction.png" alt="Yahoo!オークション" style="width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.6;">
      <h2 style="font-size: 20px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">Yahoo!オークション</h2>
      <p style="font-size: 14px; color: #6b7280; margin: 0 0 24px 0;">このプラットフォームは現在開発中です</p>
      <span style="display: inline-block; background: #fef3c7; color: #b45309; font-size: 12px; font-weight: 600; padding: 6px 16px; border-radius: 20px;">🚧 Coming Soon</span>
    </div>
  </div>
</div>

<!-- ラクマ用コンテンツ（開発中） -->
<div id="platform-content-rakuma" class="platform-content" style="display: none;">
  <div class="content-container">
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; padding: 40px 20px; text-align: center;">
      <img src="/images/platform/rakuma.png" alt="ラクマ" style="width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.6;">
      <h2 style="font-size: 20px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">ラクマ</h2>
      <p style="font-size: 14px; color: #6b7280; margin: 0 0 24px 0;">このプラットフォームは現在開発中です</p>
      <span style="display: inline-block; background: #fef3c7; color: #b45309; font-size: 12px; font-weight: 600; padding: 6px 16px; border-radius: 20px;">🚧 Coming Soon</span>
    </div>
  </div>
</div>

<!-- BASE用コンテンツ（開発中） -->
<div id="platform-content-base" class="platform-content" style="display: none;">
  <div class="content-container">
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; padding: 40px 20px; text-align: center;">
      <img src="/images/platform/base.png" alt="BASE" style="width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.6;">
      <h2 style="font-size: 20px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">BASE</h2>
      <p style="font-size: 14px; color: #6b7280; margin: 0 0 24px 0;">このプラットフォームは現在開発中です</p>
      <span style="display: inline-block; background: #fef3c7; color: #b45309; font-size: 12px; font-weight: 600; padding: 6px 16px; border-radius: 20px;">🚧 Coming Soon</span>
    </div>
  </div>
</div>

<!-- Firebase SDK (compat版: PWA用) -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
  // Firebase設定と初期化（PWA版）
  const firebaseConfig = {
    apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
    authDomain: "furira.jp",
    projectId: "reborn-chat",
    storageBucket: "reborn-chat.firebasestorage.app",
    messagingSenderId: "345706548795",
    appId: "1:345706548795:web:058a553da6b4b74db5161e"
  };

  // Firebase初期化（既存アプリがあれば再利用）
  try {
    if (typeof firebase !== 'undefined') {
      const app = firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // Firestore設定の最適化（WebChannelエラー対策）
      db.settings({
        cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED,
        experimentalForceLongPolling: true // WebSocketの代わりにlong pollingを使用
      });

      window.db = db; // グローバルに公開
      window.firestoreReady = true; // Firestore初期化完了フラグ
      console.log('✅ Firestore初期化完了');
      console.log('   firebase.apps.length:', firebase.apps.length);
    } else {
      console.error('❌ Firebase SDKが読み込まれていません');
    }
  } catch (error) {
    console.error('❌ Firebase初期化エラー:', error);
  }
</script>

<script>
  // FCMトークンをグローバル変数として定義（PWA版では空）
  var GLOBAL_FCM_TOKEN = '';
</script>

<script>
  // ===== プラットフォーム切り替え機能（将来拡張用基盤）=====

  // 現在選択中のプラットフォーム
  window.currentPlatform = 'mercari';

  // プラットフォーム設定マスタ（将来的にFirestoreから読み込み予定）
  window.platformConfig = {
    'mercari': {
      name: 'メルカリ',
      enabled: true,
      color: '#FF0211',
      features: ['standard']
    },
    'mercari-shops': {
      name: 'メルカリShops',
      enabled: false,
      color: '#FF5722',
      features: ['shops', 'business']
    },
    'yahoo-fleamarket': {
      name: 'Yahoo!フリマ',
      enabled: false,
      color: '#FF0033',
      features: ['yahoo']
    },
    'yahoo-auction': {
      name: 'ヤフオク!',
      enabled: false,
      color: '#FF6600',
      features: ['auction', 'bidding']
    },
    'rakuma': {
      name: 'ラクマ',
      enabled: false,
      color: '#E91E63',
      features: ['rakuten']
    },
    'base': {
      name: 'BASE',
      enabled: false,
      color: '#000000',
      features: ['ec', 'shop']
    }
  };

  // 登録モード（設定から読み込み）
  window.registrationMode = 'individual';

  // プラットフォームタブを設定に基づいて初期化
  function initPlatformTabs() {
    try {
      const config = JSON.parse(localStorage.getItem('config') || '{}');
      const platformSettings = config.プラットフォーム設定;

      if (!platformSettings) {
        console.log('[Platform] 設定なし。デフォルト表示（メルカリのみ）');
        // デフォルト：メルカリのみ表示
        hidePlatformTabsExcept(['mercari']);
        return;
      }

      console.log('[Platform] 設定を読み込み:', platformSettings);

      // 登録モードを設定
      window.registrationMode = platformSettings.registrationMode || 'individual';

      // 有効なプラットフォームのみ表示
      if (platformSettings.platforms && Array.isArray(platformSettings.platforms)) {
        const enabledPlatforms = platformSettings.platforms
          .filter(p => p.enabled)
          .map(p => p.id);

        console.log('[Platform] 有効なプラットフォーム:', enabledPlatforms);

        if (enabledPlatforms.length > 0) {
          hidePlatformTabsExcept(enabledPlatforms);

          // 最初の有効なプラットフォームを選択
          selectPlatform(enabledPlatforms[0]);
        } else {
          // 何も有効でない場合はメルカリをデフォルト表示
          hidePlatformTabsExcept(['mercari']);
        }
      }

      // 登録モードに応じてUIを調整
      updateRegistrationModeUI();

    } catch (e) {
      console.error('[Platform] 初期化エラー:', e);
      // エラー時はメルカリのみ表示
      hidePlatformTabsExcept(['mercari']);
    }
  }

  // 指定されたプラットフォーム以外を非表示
  function hidePlatformTabsExcept(enabledIds) {
    const tabs = document.querySelectorAll('.platform-tab');
    tabs.forEach(tab => {
      const platformId = tab.dataset.platform;
      if (enabledIds.includes(platformId)) {
        tab.style.display = '';
      } else {
        tab.style.display = 'none';
      }
    });

    // タブが1つだけなら、タブバー自体を非表示にする（シンプルに）
    const visibleTabs = document.querySelectorAll('.platform-tab:not([style*="display: none"])');
    const tabsContainer = document.querySelector('.platform-tabs-container');
    if (tabsContainer) {
      tabsContainer.style.display = visibleTabs.length <= 1 ? 'none' : '';
    }
  }

  // 登録モードに応じたUI調整
  function updateRegistrationModeUI() {
    // 将来実装: 一括登録モードの場合のUI変更
    if (window.registrationMode === 'batch') {
      console.log('[Platform] 一括登録モード - UI調整（将来実装）');
      // 例: 登録ボタンのテキスト変更、複数プラットフォーム同時選択UI等
    }
  }

  // プラットフォーム切り替え関数
  function selectPlatform(platformId) {
    const config = window.platformConfig[platformId];

    if (!config) {
      console.error('[Platform] 不明なプラットフォーム:', platformId);
      return;
    }

    // タブのアクティブ状態を更新
    const tabs = document.querySelectorAll('.platform-tab');
    tabs.forEach(tab => {
      if (tab.dataset.platform === platformId) {
        tab.classList.add('active');
      } else {
        tab.classList.remove('active');
      }
    });

    // プラットフォーム別コンテンツの表示切り替え
    const allContents = document.querySelectorAll('.platform-content');
    allContents.forEach(content => {
      content.style.display = 'none';
    });
    const targetContent = document.getElementById('platform-content-' + platformId);
    if (targetContent) {
      targetContent.style.display = 'block';
    }

    // グローバル変数を更新
    window.currentPlatform = platformId;
    console.log('[Platform] 切り替え:', config.name, config.enabled ? '(実装済)' : '(準備中)');
  }

  // プラットフォーム変更時のコールバック（将来実装用）
  function onPlatformChanged(platformId) {
    // プラットフォーム固有のUIを表示/非表示
    // フォームフィールドの必須/任意を切り替え
    // バリデーションルールを変更
    console.log('[Platform] フォーム更新:', platformId);
  }

  // ページ読み込み時にプラットフォームタブを初期化
  document.addEventListener('DOMContentLoaded', function() {
    initPlatformTabs();
  });
</script>

<!-- 外部JavaScriptファイル（トークン削減、ブラウザキャッシュ活用）-->
<!-- CACHED_CONFIG等のグローバル変数を定義するため、モジュールスクリプトより先に読み込む -->
<script src="/js/webhook-config.js"></script>
<script src="/js/product-scripts.js"></script>

<!-- Firestore版ブランド検索モジュール -->
<script type="module">
  // Cloudflare PagesからFirestore APIモジュールを読み込み
  import('https://reborn-inventory-system.pages.dev/js/firestore-api.js').then(module => {
      
    // グローバルにエクスポート
    window.searchBrands = module.searchBrands || module.default?.searchBrands;
    window.incrementBrandUsageCount = module.incrementBrandUsageCount || module.default?.incrementBrandUsageCount;
    window.preloadBrandsInBackground = module.preloadBrandsInBackground || module.default?.preloadBrandsInBackground;
    window.searchBrandsFromCache = module.searchBrandsFromCache || module.default?.searchBrandsFromCache;
    
    // ブランドサジェストモジュール読み込み（Algolia版）
    return import('https://reborn-inventory-system.pages.dev/js/brand-suggest-algolia.js?v=94');
  }).then(() => {
      // 読み込み完了フラグを設定
    window.algoliaBrandModulesLoaded = true;
  }).catch(error => {
    console.error('❌ Firestoreモジュール読み込みエラー:', error);
  });
</script>



<!-- Firebase Cloud Messaging - フォアグラウンド通知対応 -->
<script type="module">
  // Firebase設定
  const firebaseConfig = {
    apiKey: "AIzaSyAwJKTz1gm3CIz_R4YTlbQopgaBq1ULt1A",
    authDomain: "reborn-pwa.firebaseapp.com",
    projectId: "reborn-pwa",
    storageBucket: "reborn-pwa.firebasestorage.app",
    messagingSenderId: "345653439471",
    appId: "1:345653439471:web:7620819ce3f022d9cd241a",
    measurementId: "G-SX48K45X75"
  };

  // Firebase初期化
  async function initFirebaseMessaging() {
    // iframe内では初期化をスキップ（PWA版で既に動作しているため）
    const isInIframe = window.self !== window.top;
    if (isInIframe) {
      console.log('ℹ️ iframe内のため、Firebase Messaging初期化をスキップします');
      return;
    }
    
    try {
      // Firebase App と Messaging をインポート
      const { initializeApp, getApps, getApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
      const { getMessaging, onMessage } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js');

      // 既に初期化されているかチェック
      let app;
      if (getApps().length === 0) {
        app = initializeApp(firebaseConfig);
        console.log('✅ Firebase App初期化（商品登録ページ）');
      } else {
        app = getApp();
        console.log('✅ 既存のFirebase Appを使用（商品登録ページ）');
      }

      const messaging = getMessaging(app);
    
      // フォアグラウンドメッセージ受信（アプリが開いている時）
      onMessage(messaging, (payload) => {
        console.log('📨 フォアグラウンドメッセージ受信（商品登録ページ）:', payload);

        // 通知データを取得
        const notificationTitle = payload.data?.title || payload.notification?.title || 'REBORN';
        const notificationBody = payload.data?.body || payload.notification?.body || '新しい通知があります';

        // バッジを更新
        incrementBadgeIfAvailable();

        // ブラウザ通知を表示
        if (Notification.permission === 'granted') {
          new Notification(notificationTitle, {
            body: notificationBody,
            icon: '/reborn-inventory-system/icon-180.png',
            badge: '/reborn-inventory-system/icon-192.png',
            tag: 'reborn-notification-product-page',
            requireInteraction: false  // 自動で消える
          });
          console.log('🔔 ブラウザ通知を表示しました（商品登録ページ）');
        }
      });

    } catch (error) {
      // エラーが発生してもページの他の機能に影響しないようにする
      console.error('❌ Firebase Messaging初期化エラー:', error);
      console.log('⚠️ 通知機能は利用できませんが、他の機能は正常に動作します');
    }
  }

  // バッジカウントを増やす（利用可能な場合）
  function incrementBadgeIfAvailable() {
    try {
      // localStorageから現在のカウントを取得
      const currentCount = parseInt(localStorage.getItem('badgeCount') || '0', 10);
      const newCount = currentCount + 1;

      // localStorageに保存
      localStorage.setItem('badgeCount', newCount.toString());
      console.log('📛 バッジカウント更新:', newCount);

      // Badge APIで更新（対応ブラウザのみ）
      if ('setAppBadge' in navigator) {
        navigator.setAppBadge(newCount)
          .then(() => console.log('✅ Badge API更新成功:', newCount))
          .catch(err => console.error('❌ Badge APIエラー:', err));
      }
    } catch (error) {
      console.error('❌ バッジ更新エラー:', error);
    }
  }

  // ページ読み込み完了後、少し遅延させてからFirebase Messagingを初期化
  // （他のスクリプトが完全に読み込まれるのを待つ）
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initFirebaseMessaging, 2000);
    });
  } else {
    setTimeout(initFirebaseMessaging, 2000);
  }

  // ================= 設定変更リスナー（postMessage） =================

  /**
   * localStorageから設定を読み込んでwindow.CACHED_CONFIGを更新
   * CONFIG_STORAGE_KEYSはproduct-scripts.jsで定義済み（window.CONFIG_STORAGE_KEYS）
   */
  function reloadConfigFromLocalStorage() {
    try {
      console.log('🔄 localStorageから設定を再読み込み中...');

      // グローバルwindow.CACHED_CONFIG変数を更新
      if (!window.CACHED_CONFIG) {
        window.CACHED_CONFIG = {};
      }

      const conditionButtons = localStorage.getItem(window.CONFIG_STORAGE_KEYS.CONDITION_BUTTONS);
      const hashtag = localStorage.getItem(window.CONFIG_STORAGE_KEYS.HASHTAG);
      const discount = localStorage.getItem(window.CONFIG_STORAGE_KEYS.DISCOUNT);
      const shippingDefault = localStorage.getItem(window.CONFIG_STORAGE_KEYS.SHIPPING_DEFAULT);
      const procureListingDefault = localStorage.getItem(window.CONFIG_STORAGE_KEYS.PROCURE_LISTING_DEFAULT);
      const managementNumber = localStorage.getItem(window.CONFIG_STORAGE_KEYS.MANAGEMENT_NUMBER);
      const salesword = localStorage.getItem(window.CONFIG_STORAGE_KEYS.SALESWORD);
      const aiSettings = localStorage.getItem(window.CONFIG_STORAGE_KEYS.AI_SETTINGS);
      const theme = localStorage.getItem(window.CONFIG_STORAGE_KEYS.DESIGN_THEME);

      if (conditionButtons) window.CACHED_CONFIG['商品状態ボタン'] = JSON.parse(conditionButtons);
      if (hashtag) window.CACHED_CONFIG['ハッシュタグ'] = JSON.parse(hashtag);
      if (discount) window.CACHED_CONFIG['割引情報'] = JSON.parse(discount);
      if (shippingDefault) window.CACHED_CONFIG['配送デフォルト'] = JSON.parse(shippingDefault);
      if (procureListingDefault) window.CACHED_CONFIG['仕入出品デフォルト'] = JSON.parse(procureListingDefault);
      if (managementNumber) window.CACHED_CONFIG['管理番号設定'] = JSON.parse(managementNumber);
      if (salesword) window.CACHED_CONFIG['よく使うセールスワード'] = JSON.parse(salesword);
      if (aiSettings) window.CACHED_CONFIG['AI生成設定'] = JSON.parse(aiSettings);
      if (theme) window.CACHED_CONFIG['デザインテーマ'] = theme;

      console.log('✅ window.CACHED_CONFIGを更新しました:', window.CACHED_CONFIG);

      // 商品画像ブロックの表示/非表示を更新
      checkProductImageBlockVisibility();

      console.log('✅ 設定を再読み込みしました');
    } catch (e) {
      console.error('❌ localStorage読み込みエラー:', e);
    }
  }

  /**
   * postMessageリスナー（設定変更通知を受け取る）
   */
  window.addEventListener('message', function(event) {
    // configChangedメッセージを受け取ったら設定を再読み込み
    if (event.data && event.data.type === 'configChanged') {
      console.log('📥 設定変更通知を受信しました');
      reloadConfigFromLocalStorage();
    }
  });

  console.log('✅ 設定変更リスナーを登録しました');

  // DOMContentLoaded後にオーバーレイを初期化
  document.addEventListener('DOMContentLoaded', initLoadingOverlay);

  // デフォルトセールスワード適用はproduct-scripts.jsに統合（重複削除）

</script>

</body>
</html>