<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<link rel="apple-touch-icon" sizes="180x180" href="https://creatortak.github.io/reborn-inventory-system/icon-180.png">
<base target="_top">

<!-- iOS PWA対応 -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="フリラ">

<!-- PWA対応 -->
<meta name="theme-color" content="#000000">

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<!-- Algolia Search SDK (Lite版) -->
<script src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<!-- REBORN Brand Colors & Theme -->
<link rel="stylesheet" href="https://www.reborn-inventory.com/css/reborn-brand-colors.css?v=0bd1a9b">
<link rel="stylesheet" href="/css/reborn-theme.css?v=296">

<!-- 外部CSSファイルに移動（トークン削減、ブラウザキャッシュ活用）-->
<link rel="stylesheet" href="/css/product-styles.css?v=176-toast-light">
<!-- Sortable.js - タッチ対応のドラッグ&ドロップライブラリ -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
</head>
<body class="">


<!-- ミニマルヘッダー（タスクページと同じスタイル） -->
<style>
  .minimal-header {
    background: #ffffff;
    height: 56px;
    padding: 0 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 1000;
    border-bottom: 1px solid #f0f0f0;
  }
  .minimal-header-logo {
    width: 100px;
    height: auto;
    cursor: pointer;
  }
  .minimal-header-icons {
    display: flex;
    align-items: center;
    gap: 2px;
  }
  .minimal-header-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: none;
    background: transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #606060;
    font-size: 20px;
    transition: background 0.2s;
  }
  .minimal-header-icon:hover {
    background: #f2f2f2;
  }
  .minimal-header-icon:active {
    background: #e5e5e5;
  }
</style>
<div class="minimal-header" id="pageHeader" style="display: none;">
  <img src="/images/furira-square-logo.png?v=20251209" alt="フリラ" class="minimal-header-logo" onclick="window.parent.postMessage({type:'navigateToPage', page:'home'}, '*')" title="メニューに戻る">
  <div class="minimal-header-icons">
    <button class="minimal-header-icon" onclick="window.parent.postMessage({type:'openChatRooms'}, '*')" title="お知らせ">
      <i class="bi bi-bell"></i>
    </button>
    <button class="minimal-header-icon" onclick="window.parent.postMessage({type:'toggleDrawer'}, '*')" title="設定">
      <i class="bi bi-gear"></i>
    </button>
  </div>
</div>

<!-- メインフォームコンテンツ（QR自動表示時は最初非表示） -->
<div id="mainFormContent" style="display: none;">

<!-- プラットフォーム切り替えタブ -->
<div class="platform-tabs-container">
  <div class="platform-tabs" id="platformTabs">
    <button class="platform-tab active" data-platform="mercari" onclick="selectPlatform('mercari')">
      <img src="/images/platform/mercari.png" alt="メルカリ" class="platform-logo" style="width:18px;height:18px;">
      <span>メルカリ</span>
    </button>
    <button class="platform-tab" data-platform="mercari-shops" onclick="selectPlatform('mercari-shops')">
      <img src="/images/platform/mercari-shops.png" alt="メルカリShops" class="platform-logo" style="width:18px;height:18px;">
      <span>メルカリShops</span>
    </button>
    <button class="platform-tab" data-platform="yahoo-fleamarket" onclick="selectPlatform('yahoo-fleamarket')">
      <img src="/images/platform/yahoo-fleamarket.png" alt="Yahoo!フリマ" class="platform-logo" style="width:18px;height:18px;">
      <span>Yahoo!フリマ</span>
    </button>
    <button class="platform-tab" data-platform="yahoo-auction" onclick="selectPlatform('yahoo-auction')">
      <img src="/images/platform/yahoo-auction.png" alt="Yahoo!オークション" class="platform-logo" style="width:18px;height:18px;">
      <span>Yahoo!オークション</span>
    </button>
    <button class="platform-tab" data-platform="rakuma" onclick="selectPlatform('rakuma')">
      <img src="/images/platform/rakuma.png" alt="ラクマ" class="platform-logo" style="width:18px;height:18px;">
      <span>ラクマ</span>
    </button>
    <button class="platform-tab" data-platform="base" onclick="selectPlatform('base')">
      <img src="/images/platform/base.png" alt="BASE" class="platform-logo" style="width:18px;height:18px;">
      <span>BASE</span>
    </button>
  </div>
</div>

<!-- プラットフォーム別コンテンツ -->

<!-- メルカリ用コンテンツ -->
<div id="platform-content-mercari" class="platform-content">
<div class="content-container">

<!-- 仕入商品紐付けステータス（スキャン後に表示） -->
<div class="group qr-status-section" id="qrStatusSection" style="display: none;">
  <div id="qrScanStatus" style="padding: 12px; border-radius: 8px; background: #d1fae5; border: 1px solid #10b981;">
    <!-- スキャン状態が表示される -->
  </div>
  <!-- 仕入商品ID（非表示フィールド） -->
  <input type="hidden" id="invId" name="invId" value="">
</div>

<div class="group management-section">
  <div class="group-title">管理番号</div>

  <div class="form-section">
    <!-- 動的に生成されるセグメント入力フィールド -->
    <div id="managementNumberFields" style="display: none;"></div>

    <!-- 使用可能な管理番号 -->
    <div id="managementNumberPreview" style="margin-top: 8px; display: none;">
      <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">使用可能な管理番号</label>
      <div style="display: flex; gap: 4px; align-items: stretch;">
        <input id="管理番号" type="text" readonly placeholder="自動採番されます" class="mgmt-number-field" style="flex: 1; background: #f3f4f6; color: #1f2937; font-weight: 600; text-align: left; border: 1px solid #d1d5db; padding: 6px 8px;">
        <button type="button" onclick="adjustManagementNumber(1)" class="mgmt-adjust-btn" style="width: 32px; padding: 0; border: 1px solid #d1d5db; background: white; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; border-radius: 4px;">▲</button>
        <button type="button" onclick="adjustManagementNumber(-1)" class="mgmt-adjust-btn" style="width: 32px; padding: 0; border: 1px solid #d1d5db; background: white; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; border-radius: 4px;">▼</button>
      </div>
    </div>

    <!-- QRコード生成ボタン -->
    <div id="qrCodeSection" style="margin-top: 12px; display: none;">
      <button type="button" onclick="showQRCodeModal()" class="qr-code-btn" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
        <i class="bi bi-qr-code" style="font-size: 18px;"></i>
        QRコード表示・印刷
      </button>
    </div>

    <!-- 担当者 -->
    <div style="margin-top: 12px;">
      <label>担当者</label>
      <input type="text" id="担当者" readonly style="background-color: #f3f4f6; cursor: not-allowed;">
    </div>
  </div>
</div>
<div class="group basic-section">
  <div class="group-title">基本情報</div>

  <div class="form-section category-cascade-section">
    <div class="section-title">カテゴリー</div>
    <!-- 特大分類（メルカリのトップカテゴリー） -->
    <div style="margin-top: 4px;">
      <select id="特大分類" class="category-cascade-select">
        <option value="">--選択してください--</option>
        <option value="ファッション">ファッション</option>
        <option value="ベビー・キッズ">ベビー・キッズ</option>
        <option value="ゲーム・おもちゃ・グッズ">ゲーム・おもちゃ・グッズ</option>
        <option value="ホビー・楽器・アート">ホビー・楽器・アート</option>
        <option value="チケット">チケット</option>
        <option value="本・雑誌・漫画">本・雑誌・漫画</option>
        <option value="CD・DVD・ブルーレイ">CD・DVD・ブルーレイ</option>
        <option value="スマホ・タブレット・パソコン">スマホ・タブレット・パソコン</option>
        <option value="テレビ・オーディオ・カメラ">テレビ・オーディオ・カメラ</option>
        <option value="生活家電・空調">生活家電・空調</option>
        <option value="スポーツ">スポーツ</option>
        <option value="アウトドア・釣り・旅行用品">アウトドア・釣り・旅行用品</option>
        <option value="コスメ・美容">コスメ・美容</option>
        <option value="ダイエット・健康">ダイエット・健康</option>
        <option value="食品・飲料・酒">食品・飲料・酒</option>
        <option value="キッチン・日用品・その他">キッチン・日用品・その他</option>
        <option value="家具・インテリア">家具・インテリア</option>
        <option value="ペット用品">ペット用品</option>
        <option value="DIY・工具">DIY・工具</option>
        <option value="フラワー・ガーデニング">フラワー・ガーデニング</option>
        <option value="ハンドメイド・手芸">ハンドメイド・手芸</option>
        <option value="車・バイク・自転車">車・バイク・自転車</option>
      </select>
    </div>

    <!-- 大分類〜細分類2: ラベル非表示 -->
    <div style="margin-top: 8px;">
      <select id="大分類(カテゴリ)" class="category-cascade-select" disabled>
        <option value="">--選択してください--</option>
      </select>
    </div>

    <div style="margin-top: 8px;">
      <select id="中分類(カテゴリ)" class="category-cascade-select" disabled>
        <option value="">--選択してください--</option>
      </select>
    </div>

    <div style="margin-top: 8px;">
      <select id="小分類(カテゴリ)" class="category-cascade-select" disabled>
        <option value="">--選択してください--</option>
      </select>
    </div>

    <div id="saibunruiRow" style="display: none; margin-top: 8px;">
      <select id="細分類(カテゴリ)" class="category-cascade-select" disabled>
        <option value="">--選択してください--</option>
      </select>
    </div>

    <div style="display: none; margin-top: 8px;" id="saibunrui2Container">
      <select id="細分類2" class="category-cascade-select" disabled>
        <option value="">--選択してください--</option>
      </select>
    </div>

    <!-- アイテム名: ラベル表示 -->
    <div style="margin-top: 8px;">
      <label>アイテム名</label>
      <select id="アイテム名" class="full category-cascade-select" disabled>
        <option value="">--選択してください--</option>
      </select>
    </div>

    <div style="margin-top: 8px;">
      <label>サイズ</label>
      <select id="サイズ">
        <option value="">--選択してください--</option>
      </select>
    </div>

    <div style="margin-top: 8px;">
      <label>商品の状態</label>
      <select id="商品の状態">
        <option value="">--選択してください--</option>
      </select>
    </div>

    <div class="brand-field" style="margin-top: 8px; position: relative;">
      <label>ブランド</label>
      <input id="ブランド(英語)" autocomplete="off" placeholder="入力すると候補が表示されます">
      <div class="suggest" id="suggest-ブランド(英語)" hidden></div>
      <!-- ブランド(カナ)を隠しフィールドとして保持 -->
      <input type="hidden" id="ブランド(カナ)">
    </div>
  </div>
</div><div class="group title-section">
    <div class="group-title">商品名</div>

    <!-- 商品名プレビュー（ブロック外） -->
    <div style="margin-bottom: 12px;">
      <label style="display: flex; justify-content: space-between; align-items: center;">
        <span>商品名プレビュー</span>
        <span class="counter" id="nameCounter">
          <span id="nameCount">0</span>/<span id="nameMax">40</span> 文字
        </span>
      </label>
      <div class="preview-wrapper">
        <textarea id="商品名プレビュー" rows="2"
                  placeholder="選択した値をスペース区切りで自動表示されます"
                  style="margin-top: 4px;"></textarea>
        <button type="button" class="copy-icon-btn" onclick="copyToClipboard('商品名プレビュー', 'copyNameBtn')" id="copyNameBtn" title="コピー">
          <i class="bi bi-copy"></i>
        </button>
      </div>
      <input id="商品名(タイトル)" type="hidden">
    </div>

    <!-- 並び替え可能なブロックコンテナ -->
    <div id="titleBlockContainer">

    <!-- セールスワードセクション -->
    <div class="form-section title-draggable-block" data-block-id="salesword" draggable="true">
      <h3 class="section-title" style="display: flex; align-items: center; gap: 8px;">
        <span class="drag-handle" style="cursor: move; font-size: 16px; color: #9ca3af;">⋮⋮</span>
        <span class="section-icon">🏷️</span>セールスワード
        <button type="button" class="collapse-btn" onclick="toggleTitleBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
      </h3>
      <div class="section-content">
        <!-- セールスワード検索 -->
        <div style="margin-bottom: 12px; position: relative;">
          <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">🔍 キーワード検索</label>
          <input type="text" id="saleswordSearch" class="full" placeholder="キーワードを入力して検索..." autocomplete="off" style="font-size: 16px;">
          <div id="saleswordSuggestList" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
        </div>
        <div class="row">
          <div>
            <label>カテゴリ</label>
            <select id="セールスワード(カテゴリ)" class="full">
              <option value="">--選択してください--</option>
            </select>
          </div>
          <div>
            <label>キーワード</label>
            <select id="セールスワード" class="full">
              <option value="">--選択してください--</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- ブランド情報セクション -->
    <div class="form-section title-draggable-block" data-block-id="brand" draggable="true">
      <h3 class="section-title" style="display: flex; align-items: center; gap: 8px;">
        <span class="drag-handle" style="cursor: move; font-size: 16px; color: #9ca3af;">⋮⋮</span>
        <span class="section-icon">🏢</span>ブランド情報
        <button type="button" class="collapse-btn" onclick="toggleTitleBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
      </h3>
      <div class="section-content">
        <div class="row">
          <div class="brand-field" style="position: relative;">
            <label>ブランド(英語)</label>
            <div style="display: flex; align-items: center; gap: 4px; width: 100%;">
              <input type="checkbox" id="商品名_ブランド(英語)_チェック" checked onchange="updateNamePreview()" style="width: 20px; flex-shrink: 0;">
              <input id="商品名_ブランド(英語)" autocomplete="off" placeholder="入力すると候補が表示されます" style="flex: 1; min-width: 0;">
            </div>
            <div class="suggest" id="suggest-商品名_ブランド(英語)" hidden></div>
          </div>
          <div class="brand-field" style="position: relative;">
            <label>ブランド(カナ)</label>
            <div style="display: flex; align-items: center; gap: 4px; width: 100%;">
              <input type="checkbox" id="商品名_ブランド(カナ)_チェック" checked onchange="updateNamePreview()" style="width: 20px; flex-shrink: 0;">
              <input id="商品名_ブランド(カナ)" autocomplete="off" placeholder="入力すると候補が表示されます" style="flex: 1; min-width: 0;">
            </div>
            <div class="suggest" id="suggest-商品名_ブランド(カナ)" hidden></div>
          </div>
        </div>
      </div>
    </div>

    <!-- アイテム名セクション -->
    <div class="form-section title-draggable-block" data-block-id="item" draggable="true">
      <h3 class="section-title" style="display: flex; align-items: center; gap: 8px;">
        <span class="drag-handle" style="cursor: move; font-size: 16px; color: #9ca3af;">⋮⋮</span>
        <span class="section-icon">📦</span>アイテム名
        <button type="button" class="collapse-btn" onclick="toggleTitleBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
      </h3>
      <div class="section-content">
        <input id="商品名_アイテム名" type="text" placeholder="基本情報のアイテム名を選択するか、ここに直接入力" onchange="updateNamePreview()" oninput="updateNamePreview()" style="width: 100%;">
      </div>
    </div>

    <!-- 商品属性セクション -->
    <div class="form-section title-draggable-block" data-block-id="attribute" draggable="true">
      <h3 class="section-title" style="display: flex; align-items: center; gap: 8px;">
        <span class="drag-handle" style="cursor: move; font-size: 16px; color: #9ca3af;">⋮⋮</span>
        <span class="section-icon">🎨</span>商品属性
        <button type="button" class="collapse-btn" onclick="toggleTitleBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
      </h3>
      <div class="section-content">
        <div id="attributeList">
          <!-- 初期表示は1セット -->
          <div class="attribute-item" data-index="1">
            <div class="attribute-header">
              <span>属性 1</span>
              <button type="button" class="remove-attribute-btn" onclick="removeProductAttribute(1)" style="display:none;">削除</button>
            </div>

            <!-- 検索バー -->
            <div class="attribute-search-wrapper" style="margin-bottom: 8px; position: relative;">
              <input type="text" class="attribute-search-input" data-index="1" placeholder="属性を検索..." autocomplete="off" style="font-size: 16px; width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <div class="attribute-suggest-list" data-index="1" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
            </div>

            <div class="row" style="margin-top: 6px;">
              <div>
                <label>カテゴリ</label>
                <select id="商品属性1_カテゴリ">
                  <option value="">--選択してください--</option>
                </select>
              </div>
              <div>
                <label>値</label>
                <select id="商品属性1_値" disabled>
                  <option value="">--カテゴリを選択してください--</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <button type="button" id="addAttributeBtn" class="add-attribute-btn">+ 商品属性を追加</button>
      </div>
    </div>

    </div><!-- titleBlockContainer -->

  </div><div class="group description-section">
  <div class="group-title">商品の説明</div>

  <!-- 商品の説明欄（プレビュー） -->
  <div style="margin-bottom: 12px;">
    <label style="display: flex; justify-content: space-between; align-items: center;">
      <span>商品の説明</span>
      <span class="counter" id="descCounter">
        <span id="descCount">0</span>/<span id="descMax">1000</span> 文字
      </span>
    </label>
    <div class="preview-wrapper">
      <textarea
        id="商品の説明"
        placeholder="商品の状態・素材・サイズ感・ディテール・注意点などを記入してください"
        style="margin-top: 4px; min-height: 120px; resize: none;"
      ></textarea>
      <button type="button" class="copy-icon-btn" onclick="copyToClipboard('商品の説明', 'copyDescBtn')" id="copyDescBtn" title="コピー">
        <i class="bi bi-copy"></i>
      </button>
    </div>
  </div>

  <!-- ドラッグ可能なブロックコンテナ -->
  <div id="descriptionBlocksContainer">

  <!-- ブランド名セクション（条件付き表示） -->
  <div id="brandNameSection" class="form-section desc-draggable-block" data-block-type="brandName" style="margin-bottom: 12px; display: none;">
    <h3 class="section-title" style="display: flex; align-items: center;">
      <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">⋮⋮</span>
      <span class="section-icon">🏷️</span>ブランド名
      <button type="button" class="collapse-btn" onclick="toggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
    </h3>
    <div class="section-content">
      <div style="font-size: 11px; color: #6b7280; padding: 8px; background: #f9fafb; border-radius: 4px;">
        💡 基本情報で選択したブランド名が自動的にプレビューに表示されます。<br>
        このブロックの位置を変更することで、プレビュー内の表示位置を調整できます。
      </div>
    </div>
  </div>

  <!-- サイズ情報セクション -->
  <div id="sizeSection" class="form-section desc-draggable-block" data-block-type="size" style="margin-bottom: 12px; display: none;">
    <h3 class="section-title" style="display: flex; align-items: center;">
      <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">⋮⋮</span>
      <span class="section-icon" id="sizeIconDisplay">👕</span><span id="sizeLabelDisplay">サイズ</span>
      <button type="button" class="collapse-btn" onclick="toggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
    </h3>
    <div class="section-content">
      <!-- トップス/アウター用サイズ -->
      <div id="topsSize" style="display: none;">
        <!-- サイズ(表記) -->
        <div style="margin-bottom: 12px;">
          <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">サイズ(表記)</label>
          <select id="サイズ(表記)_トップス" style="width: 100%;">
            <option value="">--</option>
          </select>
        </div>

        <!-- サイズ(実寸) -->
        <div style="margin-bottom: 8px;">
          <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">サイズ(実寸)</label>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 4px;">
          <div>
            <label class="small" id="shoulderWidthLabel">肩幅</label>
            <div style="display: flex; align-items: center; gap: 4px;">
              <select id="肩幅" style="flex: 1;">
                <option value="">--</option>
              </select>
              <span style="font-size: 12px; color: #6b7280;">cm</span>
            </div>
          </div>
          <div>
            <label class="small">身幅</label>
            <div style="display: flex; align-items: center; gap: 4px;">
              <select id="身幅" style="flex: 1;">
                <option value="">--</option>
              </select>
              <span style="font-size: 12px; color: #6b7280;">cm</span>
            </div>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
          <div>
            <label class="small">袖丈</label>
            <div style="display: flex; align-items: center; gap: 4px;">
              <select id="袖丈" style="flex: 1;">
                <option value="">--</option>
              </select>
              <span style="font-size: 12px; color: #6b7280;">cm</span>
            </div>
          </div>
          <div>
            <label class="small">着丈</label>
            <div style="display: flex; align-items: center; gap: 4px;">
              <select id="着丈" style="flex: 1;">
                <option value="">--</option>
              </select>
              <span style="font-size: 12px; color: #6b7280;">cm</span>
            </div>
          </div>
        </div>
      </div>

      <!-- パンツ用サイズ -->
      <div id="bottomsSize" style="display: none;">
        <!-- サイズ(表記) -->
        <div style="margin-bottom: 12px;">
          <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">サイズ(表記)</label>
          <select id="サイズ(表記)_ボトムス" style="width: 100%;">
            <option value="">--</option>
          </select>
        </div>

        <!-- サイズ(実寸) -->
        <div style="margin-bottom: 8px;">
          <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">サイズ(実寸)</label>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 4px;">
          <div>
            <label class="small">ウエスト</label>
            <div style="display: flex; align-items: center; gap: 4px;">
              <select id="ウエスト" style="flex: 1;">
                <option value="">--</option>
              </select>
              <span style="font-size: 12px; color: #6b7280;">cm</span>
            </div>
          </div>
          <div>
            <label class="small">ヒップ</label>
            <div style="display: flex; align-items: center; gap: 4px;">
              <select id="ヒップ" style="flex: 1;">
                <option value="">--</option>
              </select>
              <span style="font-size: 12px; color: #6b7280;">cm</span>
            </div>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
          <div>
            <label class="small">股上</label>
            <div style="display: flex; align-items: center; gap: 4px;">
              <select id="股上" style="flex: 1;">
                <option value="">--</option>
              </select>
              <span style="font-size: 12px; color: #6b7280;">cm</span>
            </div>
          </div>
          <div>
            <label class="small">股下</label>
            <div style="display: flex; align-items: center; gap: 4px;">
              <select id="股下" style="flex: 1;">
                <option value="">--</option>
              </select>
              <span style="font-size: 12px; color: #6b7280;">cm</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 靴用サイズ -->
      <div id="shoesSize" style="display: none;">
        <!-- サイズ(表記) -->
        <div style="margin-bottom: 12px;">
          <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">サイズ(表記)</label>
          <select id="サイズ(表記)_靴" style="width: 100%;">
            <option value="">--</option>
          </select>
        </div>

        <!-- その他のサイズ表記 -->
        <div style="margin-bottom: 12px;">
          <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">その他のサイズ表記</label>
          <input type="text" id="その他のサイズ表記_靴" placeholder="例: US8, EU38" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
        </div>

        <!-- 普段のサイズ -->
        <div style="margin-bottom: 12px;">
          <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">普段のサイズ</label>
          <input type="text" id="普段のサイズ_靴" placeholder="例: 普段は25.0cmを履いています" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
        </div>

        <!-- フィット感 -->
        <div style="margin-bottom: 12px;">
          <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">フィット感・注意点</label>
          <textarea id="フィット感_靴" placeholder="例: 細めの作りです。普段より0.5cm大きめをおすすめします" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; min-height: 60px; resize: vertical;"></textarea>
        </div>

        <div style="font-size: 11px; color: #6b7280; padding: 8px; background: #f9fafb; border-radius: 4px;">
          💡 サイズ(表記)は基本情報ブロックで選択したサイズが自動反映されます。<br>
          💡 その他のサイズ表記、普段のサイズ、フィット感は購入者がサイズ感を把握しやすくするための補足情報です。
        </div>
      </div>
    </div>
  </div>

  <!-- カラー(詳細)セクション -->
  <div class="form-section desc-draggable-block" data-block-type="color" style="margin-bottom: 12px;">
    <h3 class="section-title" style="display: flex; align-items: center;">
      <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">⋮⋮</span>
      <span class="section-icon">🎨</span>カラー(詳細)
      <button type="button" class="collapse-btn" onclick="toggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
    </h3>
    <div class="section-content">
      <div id="colorList">
        <!-- 初期表示は1セット -->
        <div class="color-item" data-index="1">
          <div class="color-header">
            <span>カラー 1</span>
            <button type="button" class="remove-color-btn" onclick="removeColor(1)" style="display:none;">削除</button>
          </div>

          <!-- カラー検索入力欄 -->
          <div class="color-search-wrapper" style="margin-bottom: 8px; position: relative;">
            <input type="text" class="color-search-input" data-index="1" placeholder="カラーを検索..." autocomplete="off" style="font-size: 16px; width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
            <div class="color-suggest-list" data-index="1" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
          </div>

          <div class="color-fields">
            <label>色:
              <select id="カラー1" class="color-select">
                <option value="">--</option>
              </select>
            </label>
          </div>
        </div>
      </div>

      <button type="button" id="addColorBtn" class="add-color-btn">+ カラーを追加</button>
    </div>
  </div>

  <!-- 商品状態(詳細)セクション -->
  <div class="form-section desc-draggable-block" data-block-type="condition" style="margin-bottom: 12px;">
    <h3 class="section-title" style="display: flex; align-items: center;">
      <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">⋮⋮</span>
      <span class="section-icon">📋</span>商品状態(詳細)
      <button type="button" class="collapse-btn" onclick="toggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
    </h3>
    <div class="section-content">
      <!-- クイック挿入ボタン群 -->
      <div id="quickInsertButtonsContainer" class="quick-insert-buttons" style="margin-bottom: 8px;">
        <!-- ボタンは「商品の状態」に応じて動的に表示 -->
      </div>

      <!-- オートコンプリート対応のテキストエリア -->
      <div style="position: relative;">
        <textarea
          id="商品状態詳細"
          rows="3"
          placeholder="商品の詳細な状態を入力してください（傷、汚れ、使用感など）"
        ></textarea>
        <div id="suggest-商品状態詳細" class="suggest" hidden></div>
      </div>

      <!-- 傷・汚れマーキング画像（仕入QRスキャン時に表示） -->
      <div id="damageMarkerPreviewSection" style="display: none; margin-top: 12px; padding: 12px; background: #fffbeb; border: 1px solid #fcd34d; border-radius: 8px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
          <span style="font-size: 14px; font-weight: 600; color: #92400e;">📍 傷・汚れマーキング</span>
          <span id="damageMarkerTypeLabel" style="font-size: 12px; color: #78716c;"></span>
        </div>
        <img id="damageMarkerPreviewImg" src="" alt="傷・汚れマーキング" style="max-width: 100%; border-radius: 6px; border: 1px solid #e5e7eb;">
        <div id="damageMarkerNoteSection" style="display: none; margin-top: 8px; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e5e7eb;">
          <div style="font-size: 11px; color: #78716c; margin-bottom: 4px;">補足説明</div>
          <div id="damageMarkerNoteText" style="font-size: 13px; color: #374151; white-space: pre-wrap;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 素材入力セクション -->
  <div class="form-section desc-draggable-block" data-block-type="material" style="margin-bottom: 12px;">
    <h3 class="section-title" style="display: flex; align-items: center;">
      <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">⋮⋮</span>
      <span class="section-icon">🧵</span>素材
      <button type="button" class="collapse-btn" onclick="toggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
    </h3>
    <div class="section-content">
      <div id="materialList">
        <!-- 初期表示は1セット -->
        <div class="material-item" data-index="1">
          <div class="material-header">
            <span>素材 1</span>
            <button type="button" class="remove-material-btn" onclick="removeMaterial(1)"
style="display:none;">削除</button>
          </div>

          <div class="material-fields">
            <label>箇所:
              <select id="素材1_箇所" class="material-location">
                <option value="">--</option>
              </select>
            </label>

            <div class="material-composition" data-material-index="1">
              <div class="composition-row" data-row-index="1">
                <label>種類:
                  <select id="素材1_種類1" class="material-type">
                    <option value="">--</option>
                  </select>
                </label>
                <label>割合:
                  <select id="素材1_％1" class="material-percent">
                    <option value="">--%</option>
                  </select>
                </label>
                <button type="button" class="remove-composition-btn" onclick="removeCompositionRow(1, 1)" style="display:none;">×</button>
              </div>
            </div>
            <button type="button" class="add-composition-btn" onclick="addCompositionRow(1)">＋ 種類を追加</button>
          </div>
        </div>
      </div>

      <button type="button" id="addMaterialBtn" class="add-material-btn">+ 素材を追加</button>
    </div>
  </div>

  <!-- 付属品セクション -->
  <div class="form-section desc-draggable-block" data-block-type="accessories" style="margin-bottom: 12px;">
    <h3 class="section-title" style="display: flex; align-items: center;">
      <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">⋮⋮</span>
      <span class="section-icon">📦</span>付属品
      <button type="button" class="collapse-btn" onclick="toggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
    </h3>
    <div class="section-content">
      <div style="font-size: 11px; color: #6b7280; margin-bottom: 12px; padding: 8px; background: #f9fafb; border-radius: 6px; border-left: 3px solid #d1d5db;">
        <span class="info-emoji">💡</span> 商品に付属するものを選択してください。AI生成時に説明文に反映されます。
      </div>
      <div id="accessoriesCheckboxes" class="accessories-checkboxes" style="display: flex; flex-wrap: wrap; gap: 8px;">
        <!-- 付属品チェックボックスは動的に生成 -->
      </div>
      <!-- その他フリーテキスト入力 -->
      <div id="accessoryOtherInputContainer" style="display: none; margin-top: 12px;">
        <label style="font-size: 12px; color: #374151; font-weight: 500;">その他の付属品（自由入力）</label>
        <input type="text" id="accessoryOtherText" placeholder="例: オリジナルハンガー、購入レシート" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; margin-top: 4px;">
      </div>
    </div>
  </div>

  <!-- AI生成ブロック（親） -->
  <div class="form-section desc-draggable-block" data-block-type="aiGeneration" style="margin-bottom: 12px;">
    <h3 class="section-title" style="display: flex; align-items: center;">
      <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">⋮⋮</span>
      <span class="section-icon">✨</span>AI生成
      <button type="button" class="collapse-btn" onclick="toggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
    </h3>
    <div class="section-content">
      <!-- 説明文 -->
      <div style="font-size: 11px; color: #6b7280; margin-bottom: 12px; padding: 8px; background: #f9fafb; border-radius: 6px; border-left: 3px solid #d1d5db;">
        <span class="info-emoji">💡</span> 以下の情報を入力してAI生成ボタンを押すと、魅力的な商品説明文が自動生成されます。<br>
        <span style="color: #6b7280;">⚠️ 生成後は必ず内容をご確認ください。</span>
      </div>

      <!-- サブブロック1: 追加属性（任意） -->
      <div class="ai-sub-block" style="margin-bottom: 12px; padding: 12px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px;">
        <h4 style="display: flex; align-items: center; margin: 0 0 8px 0; font-size: 13px; font-weight: 600; color: #374151; cursor: pointer;" onclick="toggleAiSubBlock(this)">
          <span class="section-icon">🏷️</span>追加属性（任意）
          <button type="button" class="ai-sub-collapse-btn" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 12px; color: #6b7280; padding: 0 8px;">▶</button>
        </h4>
        <div class="ai-sub-content" style="display: none;">
          <div style="font-size: 11px; color: #6b7280; margin-bottom: 8px; padding: 6px 8px; background: #f9fafb; border-radius: 4px;">
            <span class="info-emoji">💡</span> 商品の詳細な属性を入力してください。AI生成時に活用されます。
          </div>
          <textarea
            id="AI用商品属性"
            rows="3"
            placeholder="商品の詳細な属性を入力してください（例: ヴィンテージ、90年代、USA製、希少、限定品、タグ付き、デッドストック）&#10;&#10;カンマ区切りで複数入力可能です。"
            style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 13px; font-family: inherit; resize: vertical;"
          ></textarea>
          <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
            例: ヴィンテージ、90年代、USA製、希少、限定品
          </div>
        </div>
      </div>

      <!-- サブブロック2: 品番・製番（任意） -->
      <div class="ai-sub-block" style="margin-bottom: 12px; padding: 12px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px;">
        <h4 style="display: flex; align-items: center; margin: 0 0 8px 0; font-size: 13px; font-weight: 600; color: #374151; cursor: pointer;" onclick="toggleAiSubBlock(this)">
          <span class="section-icon">🔢</span>品番・製番（任意）
          <button type="button" class="ai-sub-collapse-btn" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 12px; color: #6b7280; padding: 0 8px;">▶</button>
        </h4>
        <div class="ai-sub-content" style="display: none;">
          <div style="font-size: 11px; color: #6b7280; margin-bottom: 8px; padding: 6px 8px; background: #f9fafb; border-radius: 4px;">
            <span class="info-emoji">💡</span> 商品の品番・型番を入力してください。
          </div>
          <input
            type="text"
            id="品番型番"
            placeholder="例: 555088-101, DM0522-100, FW23-M001"
            style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 13px;"
          />
        </div>
      </div>

      <!-- サブブロック3: 商品画像（任意） -->
      <div class="ai-sub-block" style="margin-bottom: 12px; padding: 12px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px;">
        <h4 style="display: flex; align-items: center; margin: 0 0 8px 0; font-size: 13px; font-weight: 600; color: #374151; cursor: pointer;" onclick="toggleAiSubBlock(this)">
          <span class="section-icon">📷</span>商品画像（任意）
          <button type="button" class="ai-sub-collapse-btn" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 12px; color: #6b7280; padding: 0 8px;">▶</button>
        </h4>
        <div class="ai-sub-content" style="display: none;">
          <div style="font-size: 11px; color: #6b7280; margin-bottom: 8px; padding: 6px 8px; background: #f9fafb; border-radius: 4px;">
            <span class="info-emoji">💡</span> 画像をアップロードするとAIが解析してより詳細な説明文を生成します
          </div>

          <!-- 画像選択ボタン -->
          <input
            type="file"
            id="productImages"
            accept="image/*"
            multiple
            style="display: none;"
            onchange="handleImageUpload(event)"
          />
          <button
            type="button"
            onclick="document.getElementById('productImages').click()"
            style="padding: 10px 16px; background: #e0f2fe; border: 2px dashed #0ea5e9; border-radius: 6px; color: #0369a1; font-size: 13px; cursor: pointer; width: 100%; font-weight: 500; margin-bottom: 12px;"
          >
            <span class="button-emoji">📷</span> 画像を選択
          </button>

          <!-- 画像プレビューエリア -->
          <div id="imagePreviewContainer" style="display: none;">
            <div style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 8px;">
              <span>AI生成用: <span id="aiImageCount">0</span>/3</span>
            </div>
            <div id="imagePreviewList" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
              <!-- プレビュー画像がここに追加される -->
            </div>
          </div>
        </div>
      </div>

      <!-- AI生成ボタン（親ブロックの最後） -->
      <div style="margin-top: 12px; text-align: center;">
        <a href="javascript:void(0);" class="btn btn-gradient" id="aiGenBtn" onclick="generateAiDescription()"><span>AI生成</span></a>
      </div>
    </div>
  </div>

  <!-- 割引情報選択（折りたたみ可能） -->
  <div class="form-section desc-draggable-block" data-block-type="discount" style="margin-bottom: 12px;">
    <h3 class="section-title" style="display: flex; align-items: center;">
      <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">⋮⋮</span>
      <span class="section-icon">💰</span>割引情報
      <button type="button" class="collapse-btn" onclick="toggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
    </h3>
    <div id="discountSection" class="section-content collapsible-content">
      <div id="discountCheckboxContainer" style="padding: 8px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
        <!-- 割引情報チェックボックスが動的に生成される -->
        <div style="font-size: 11px; color: #6b7280; text-align: center;">読み込み中...</div>
      </div>
    </div>
  </div>

  <!-- オリジナルハッシュタグ選択（折りたたみ可能） -->
  <div class="form-section desc-draggable-block" data-block-type="hashtag" style="margin-bottom: 12px;">
    <h3 class="section-title" style="display: flex; align-items: center;">
      <span class="drag-handle" style="cursor: move; margin-right: 8px; color: #9ca3af; font-size: 14px;">⋮⋮</span>
      <span class="section-icon">🏷️</span>オリジナルハッシュタグ
      <button type="button" class="collapse-btn" onclick="toggleDescBlock(this)" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 0 8px;">▼</button>
    </h3>
    <div id="hashtagSection" class="section-content collapsible-content">
      <div id="hashtagCheckboxContainer" style="padding: 8px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
        <!-- ハッシュタグチェックボックスが動的に生成される -->
        <div style="font-size: 11px; color: #6b7280; text-align: center;">読み込み中...</div>
      </div>
    </div>
  </div>

  </div><!-- /descriptionBlocksContainer -->

</div>
<div class="group product-images-section" id="productImagesBlock" style="display: none;">
  <div class="group-title">商品画像</div>
  <div class="form-section">
    <!-- ヒント -->
    <div style="font-size: 11px; color: #6b7280; margin-bottom: 12px; padding: 10px 12px; background: #f9fafb; border-radius: 6px; border-left: 3px solid #d1d5db; line-height: 1.6;">
      <span class="info-emoji">💡</span> フリマ、ECサイトなどに出品する画像をアップロードします（最大20枚）<br>
      画像はクラウドに保存され、複数のプラットフォームへのAPI連携で自動出品に使用できます
    </div>

    <!-- 画像アップロード -->
    <div style="margin-bottom: 16px;">
      <input
        type="file"
        id="productImagesForSave"
        accept="image/*"
        multiple
        style="display: none;"
        onchange="handleProductImageUpload(event)"
      />
      <button
        type="button"
        onclick="document.getElementById('productImagesForSave').click()"
        style="padding: 10px 16px; background: #e0f2fe; border: 2px dashed #0ea5e9; border-radius: 6px; color: #0369a1; font-size: 13px; cursor: pointer; width: 100%; font-weight: 500;"
      >
        <span class="button-emoji">📷</span> 画像を選択
      </button>
    </div>

    <!-- 画像プレビューエリア -->
    <div id="productImagesPreviewContainer" style="display: none;">
      <div style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
        <span>アップロード済み（<span id="productImageCount">0</span>/20）</span>
        <button
          type="button"
          onclick="clearAllProductImages()"
          style="padding: 4px 8px; background: white; border: 1px solid #ef4444; border-radius: 4px; color: #ef4444; font-size: 11px; cursor: pointer; font-weight: 500;"
          title="すべての画像を削除"
        >
          🗑️ すべて削除
        </button>
      </div>
      <div id="productImagesPreviewList" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
        <!-- プレビュー画像がここに追加される -->
      </div>
    </div>
  </div>
</div>
<div class="group shipping-section">
  <div class="group-title">配送について</div>
  <div class="form-section">
    <div class="row">
      <div>
        <label>配送料の負担</label>
        <select id="配送料の負担">
          <option value="送料込み(出品者負担)">送料込み(出品者負担)</option>
        </select>
      </div>
      <div>
        <label>配送の方法</label>
        <select id="配送の方法">
          <option value="ゆうゆうメルカリ便">ゆうゆうメルカリ便</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:4px;">
      <div>
        <label>発送元の地域</label>
        <select id="発送元の地域">
          <option value="岡山県">岡山県</option>
        </select>
      </div>
      <div>
        <label>発送までの日数</label>
        <select id="発送までの日数">
          <option value="1~2日で発送">1~2日で発送</option>
        </select>
      </div>
    </div>
  </div>
</div><div class="group purchase-section">
  <div class="group-title">仕入情報</div>
  <div class="form-section">
    <div class="row">
      <div>
        <label>仕入日</label>
        <input id="仕入日" type="date">
      </div>
      <div>
        <label>仕入先</label>
        <select id="仕入先">
          <option value="">--選択してください--</option>
        </select>
      </div>
    </div>
    
    <div style="margin-top: 8px;">
      <label>仕入金額</label>
      <input id="仕入金額" type="number" min="0" step="1" placeholder="0">
    </div>
  </div>
</div><div class="group listing-section">
  <div class="group-title">出品情報</div>
  <div class="form-section">
    <div class="row">
      <div>
        <label>出品日</label>
        <input id="出品日" type="date">
      </div>
      <div>
        <label>出品先</label>
        <select id="出品先">
          <option value="">--選択してください--</option>
        </select>
      </div>
    </div>
    
    <!-- 販売タイプ（メルカリ選択時のみ表示） -->
    <div id="sales-type-container" style="margin-top: 8px; display: none;">
      <label style="font-size: 12px; color: #374151; margin-bottom: 4px; display: block;">販売タイプ</label>
      <select id="salesType" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background: white;">
        <option value="fixed" selected>価格を設定する</option>
        <option value="auction">オークション形式</option>
      </select>
    </div>

    <div style="margin-top: 8px;">
      <label id="listing-price-label">出品金額</label>
      <div style="position: relative;">
        <input id="出品金額" type="number" min="0" step="1" placeholder="0">
        <span id="auction-suffix" style="display: none; position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #6b7280; font-size: 14px;">〜</span>
      </div>
    </div>
  </div>
</div><div class="actions">
<button onclick="onSave()">保存</button>
<button id="resetButton" onclick="onReset()">リセット</button>
</div>
<div class="msg" id="msg"></div>
</div> <!-- /content-container -->
</div> <!-- /platform-content-mercari -->

<!-- メルカリShops用コンテンツ（開発中） -->
<div id="platform-content-mercari-shops" class="platform-content" style="display: none;">
  <div class="content-container">
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; padding: 40px 20px; text-align: center;">
      <img src="/images/platform/mercari-shops.png" alt="メルカリShops" style="width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.6;">
      <h2 style="font-size: 20px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">メルカリShops</h2>
      <p style="font-size: 14px; color: #6b7280; margin: 0 0 24px 0;">このプラットフォームは現在開発中です</p>
      <span style="display: inline-block; background: #fef3c7; color: #b45309; font-size: 12px; font-weight: 600; padding: 6px 16px; border-radius: 20px;">🚧 Coming Soon</span>
    </div>
  </div>
</div>

<!-- Yahoo!フリマ用コンテンツ（開発中） -->
<div id="platform-content-yahoo-fleamarket" class="platform-content" style="display: none;">
  <div class="content-container">
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; padding: 40px 20px; text-align: center;">
      <img src="/images/platform/yahoo-fleamarket.png" alt="Yahoo!フリマ" style="width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.6;">
      <h2 style="font-size: 20px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">Yahoo!フリマ</h2>
      <p style="font-size: 14px; color: #6b7280; margin: 0 0 24px 0;">このプラットフォームは現在開発中です</p>
      <span style="display: inline-block; background: #fef3c7; color: #b45309; font-size: 12px; font-weight: 600; padding: 6px 16px; border-radius: 20px;">🚧 Coming Soon</span>
    </div>
  </div>
</div>

<!-- Yahoo!オークション用コンテンツ（開発中） -->
<div id="platform-content-yahoo-auction" class="platform-content" style="display: none;">
  <div class="content-container">
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; padding: 40px 20px; text-align: center;">
      <img src="/images/platform/yahoo-auction.png" alt="Yahoo!オークション" style="width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.6;">
      <h2 style="font-size: 20px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">Yahoo!オークション</h2>
      <p style="font-size: 14px; color: #6b7280; margin: 0 0 24px 0;">このプラットフォームは現在開発中です</p>
      <span style="display: inline-block; background: #fef3c7; color: #b45309; font-size: 12px; font-weight: 600; padding: 6px 16px; border-radius: 20px;">🚧 Coming Soon</span>
    </div>
  </div>
</div>

<!-- ラクマ用コンテンツ（開発中） -->
<div id="platform-content-rakuma" class="platform-content" style="display: none;">
  <div class="content-container">
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; padding: 40px 20px; text-align: center;">
      <img src="/images/platform/rakuma.png" alt="ラクマ" style="width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.6;">
      <h2 style="font-size: 20px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">ラクマ</h2>
      <p style="font-size: 14px; color: #6b7280; margin: 0 0 24px 0;">このプラットフォームは現在開発中です</p>
      <span style="display: inline-block; background: #fef3c7; color: #b45309; font-size: 12px; font-weight: 600; padding: 6px 16px; border-radius: 20px;">🚧 Coming Soon</span>
    </div>
  </div>
</div>

<!-- BASE用コンテンツ（開発中） -->
<div id="platform-content-base" class="platform-content" style="display: none;">
  <div class="content-container">
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; padding: 40px 20px; text-align: center;">
      <img src="/images/platform/base.png" alt="BASE" style="width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.6;">
      <h2 style="font-size: 20px; font-weight: 600; color: #374151; margin: 0 0 12px 0;">BASE</h2>
      <p style="font-size: 14px; color: #6b7280; margin: 0 0 24px 0;">このプラットフォームは現在開発中です</p>
      <span style="display: inline-block; background: #fef3c7; color: #b45309; font-size: 12px; font-weight: 600; padding: 6px 16px; border-radius: 20px;">🚧 Coming Soon</span>
    </div>
  </div>
</div>

<!-- Firebase SDK (compat版: PWA用) -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

<script>
  // Firebase設定と初期化（PWA版）
  const firebaseConfig = {
    apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
    authDomain: "furira.jp",
    projectId: "reborn-chat",
    storageBucket: "reborn-chat.firebasestorage.app",
    messagingSenderId: "345706548795",
    appId: "1:345706548795:web:058a553da6b4b74db5161e"
  };

  // Firebase初期化（既存アプリがあれば再利用）
  try {
    if (typeof firebase !== 'undefined') {
      const app = firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // Firestore設定の最適化（WebChannelエラー対策）
      db.settings({
        cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED,
        experimentalForceLongPolling: true // WebSocketの代わりにlong pollingを使用
      });

      window.db = db; // グローバルに公開
      window.firestoreReady = true; // Firestore初期化完了フラグ
      console.log('✅ Firestore初期化完了');
      console.log('   firebase.apps.length:', firebase.apps.length);

      // Firebase Storage初期化（商品画像アップロード用）
      const storage = firebase.storage();
      window.firebaseStorage = storage;
      // compat版のStorage API関数をwindowに公開
      window.storageRef = (storage, path) => storage.ref(path);
      window.storageUploadBytes = async (ref, blob) => await ref.put(blob);
      window.storageGetDownloadURL = async (ref) => await ref.getDownloadURL();
      console.log('✅ Firebase Storage初期化完了');

    } else {
      console.error('❌ Firebase SDKが読み込まれていません');
    }
  } catch (error) {
    console.error('❌ Firebase初期化エラー:', error);
  }
</script>

<script>
  // FCMトークンをグローバル変数として定義（PWA版では空）
  var GLOBAL_FCM_TOKEN = '';
</script>

<script>
  // ===== プラットフォーム切り替え機能（将来拡張用基盤）=====

  // 現在選択中のプラットフォーム
  window.currentPlatform = 'mercari';

  // プラットフォーム設定マスタ（将来的にFirestoreから読み込み予定）
  window.platformConfig = {
    'mercari': {
      name: 'メルカリ',
      enabled: true,
      color: '#FF0211',
      features: ['standard']
    },
    'mercari-shops': {
      name: 'メルカリShops',
      enabled: false,
      color: '#FF5722',
      features: ['shops', 'business']
    },
    'yahoo-fleamarket': {
      name: 'Yahoo!フリマ',
      enabled: false,
      color: '#FF0033',
      features: ['yahoo']
    },
    'yahoo-auction': {
      name: 'ヤフオク!',
      enabled: false,
      color: '#FF6600',
      features: ['auction', 'bidding']
    },
    'rakuma': {
      name: 'ラクマ',
      enabled: false,
      color: '#E91E63',
      features: ['rakuten']
    },
    'base': {
      name: 'BASE',
      enabled: false,
      color: '#000000',
      features: ['ec', 'shop']
    }
  };

  // 登録モード（設定から読み込み）
  window.registrationMode = 'individual';

  // プラットフォームタブを設定に基づいて初期化
  function initPlatformTabs() {
    try {
      const config = JSON.parse(localStorage.getItem('config') || '{}');
      const platformSettings = config.プラットフォーム設定;

      if (!platformSettings) {
        console.log('[Platform] 設定なし。デフォルト表示（メルカリのみ）');
        // デフォルト：メルカリのみ表示
        hidePlatformTabsExcept(['mercari']);
        return;
      }

      console.log('[Platform] 設定を読み込み:', platformSettings);

      // 登録モードを設定
      window.registrationMode = platformSettings.registrationMode || 'individual';

      // 有効なプラットフォームのみ表示
      if (platformSettings.platforms && Array.isArray(platformSettings.platforms)) {
        const enabledPlatforms = platformSettings.platforms
          .filter(p => p.enabled)
          .map(p => p.id);

        console.log('[Platform] 有効なプラットフォーム:', enabledPlatforms);

        if (enabledPlatforms.length > 0) {
          hidePlatformTabsExcept(enabledPlatforms);

          // 最初の有効なプラットフォームを選択
          selectPlatform(enabledPlatforms[0]);
        } else {
          // 何も有効でない場合はメルカリをデフォルト表示
          hidePlatformTabsExcept(['mercari']);
        }
      }

      // 登録モードに応じてUIを調整
      updateRegistrationModeUI();

    } catch (e) {
      console.error('[Platform] 初期化エラー:', e);
      // エラー時はメルカリのみ表示
      hidePlatformTabsExcept(['mercari']);
    }
  }

  // 指定されたプラットフォーム以外を非表示
  function hidePlatformTabsExcept(enabledIds) {
    const tabs = document.querySelectorAll('.platform-tab');
    tabs.forEach(tab => {
      const platformId = tab.dataset.platform;
      if (enabledIds.includes(platformId)) {
        tab.style.display = '';
      } else {
        tab.style.display = 'none';
      }
    });

    // タブが1つだけなら、タブバー自体を非表示にする（シンプルに）
    const visibleTabs = document.querySelectorAll('.platform-tab:not([style*="display: none"])');
    const tabsContainer = document.querySelector('.platform-tabs-container');
    if (tabsContainer) {
      tabsContainer.style.display = visibleTabs.length <= 1 ? 'none' : '';
    }
  }

  // 登録モードに応じたUI調整
  function updateRegistrationModeUI() {
    // 将来実装: 一括登録モードの場合のUI変更
    if (window.registrationMode === 'batch') {
      console.log('[Platform] 一括登録モード - UI調整（将来実装）');
      // 例: 登録ボタンのテキスト変更、複数プラットフォーム同時選択UI等
    }
  }

  // プラットフォーム切り替え関数
  function selectPlatform(platformId) {
    const config = window.platformConfig[platformId];

    if (!config) {
      console.error('[Platform] 不明なプラットフォーム:', platformId);
      return;
    }

    // タブのアクティブ状態を更新
    const tabs = document.querySelectorAll('.platform-tab');
    tabs.forEach(tab => {
      if (tab.dataset.platform === platformId) {
        tab.classList.add('active');
      } else {
        tab.classList.remove('active');
      }
    });

    // プラットフォーム別コンテンツの表示切り替え
    const allContents = document.querySelectorAll('.platform-content');
    allContents.forEach(content => {
      content.style.display = 'none';
    });
    const targetContent = document.getElementById('platform-content-' + platformId);
    if (targetContent) {
      targetContent.style.display = 'block';
    }

    // グローバル変数を更新
    window.currentPlatform = platformId;
    console.log('[Platform] 切り替え:', config.name, config.enabled ? '(実装済)' : '(準備中)');
  }

  // プラットフォーム変更時のコールバック（将来実装用）
  function onPlatformChanged(platformId) {
    // プラットフォーム固有のUIを表示/非表示
    // フォームフィールドの必須/任意を切り替え
    // バリデーションルールを変更
    console.log('[Platform] フォーム更新:', platformId);
  }

  // ページ読み込み時にプラットフォームタブを初期化
  document.addEventListener('DOMContentLoaded', function() {
    initPlatformTabs();
  });
</script>

<!-- 外部JavaScriptファイル（トークン削減、ブラウザキャッシュ活用）-->
<!-- CACHED_CONFIG等のグローバル変数を定義するため、モジュールスクリプトより先に読み込む -->
<script src="/js/webhook-config.js"></script>
<script src="/js/product-scripts.js?v=174-copy-toast"></script>

<!-- Firestore版ブランド検索モジュール -->
<script type="module">
  // Cloudflare PagesからFirestore APIモジュールを読み込み
  import('https://reborn-inventory-system.pages.dev/js/firestore-api.js').then(module => {
      
    // グローバルにエクスポート
    window.searchBrands = module.searchBrands || module.default?.searchBrands;
    window.incrementBrandUsageCount = module.incrementBrandUsageCount || module.default?.incrementBrandUsageCount;
    window.preloadBrandsInBackground = module.preloadBrandsInBackground || module.default?.preloadBrandsInBackground;
    window.searchBrandsFromCache = module.searchBrandsFromCache || module.default?.searchBrandsFromCache;
    
    // ブランドサジェストモジュール読み込み（Algolia版）
    return import('https://reborn-inventory-system.pages.dev/js/brand-suggest-algolia.js?v=96-keyboard-auto-match');
  }).then(() => {
      // 読み込み完了フラグを設定
    window.algoliaBrandModulesLoaded = true;
  }).catch(error => {
    console.error('❌ Firestoreモジュール読み込みエラー:', error);
  });
</script>



<!-- Firebase Cloud Messaging - フォアグラウンド通知対応 -->
<script type="module">
  // Firebase設定
  const firebaseConfig = {
    apiKey: "AIzaSyAwJKTz1gm3CIz_R4YTlbQopgaBq1ULt1A",
    authDomain: "reborn-pwa.firebaseapp.com",
    projectId: "reborn-pwa",
    storageBucket: "reborn-pwa.firebasestorage.app",
    messagingSenderId: "345653439471",
    appId: "1:345653439471:web:7620819ce3f022d9cd241a",
    measurementId: "G-SX48K45X75"
  };

  // Firebase初期化
  async function initFirebaseMessaging() {
    // iframe内では初期化をスキップ（PWA版で既に動作しているため）
    const isInIframe = window.self !== window.top;
    if (isInIframe) {
      console.log('ℹ️ iframe内のため、Firebase Messaging初期化をスキップします');
      return;
    }
    
    try {
      // Firebase App と Messaging をインポート
      const { initializeApp, getApps, getApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
      const { getMessaging, onMessage } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js');

      // 既に初期化されているかチェック
      let app;
      if (getApps().length === 0) {
        app = initializeApp(firebaseConfig);
        console.log('✅ Firebase App初期化（商品登録ページ）');
      } else {
        app = getApp();
        console.log('✅ 既存のFirebase Appを使用（商品登録ページ）');
      }

      const messaging = getMessaging(app);
    
      // フォアグラウンドメッセージ受信（アプリが開いている時）
      onMessage(messaging, (payload) => {
        console.log('📨 フォアグラウンドメッセージ受信（商品登録ページ）:', payload);

        // 通知データを取得
        const notificationTitle = payload.data?.title || payload.notification?.title || 'REBORN';
        const notificationBody = payload.data?.body || payload.notification?.body || '新しい通知があります';

        // バッジを更新
        incrementBadgeIfAvailable();

        // ブラウザ通知を表示
        if (Notification.permission === 'granted') {
          new Notification(notificationTitle, {
            body: notificationBody,
            icon: '/reborn-inventory-system/icon-180.png',
            badge: '/reborn-inventory-system/icon-192.png',
            tag: 'reborn-notification-product-page',
            requireInteraction: false  // 自動で消える
          });
          console.log('🔔 ブラウザ通知を表示しました（商品登録ページ）');
        }
      });

    } catch (error) {
      // エラーが発生してもページの他の機能に影響しないようにする
      console.error('❌ Firebase Messaging初期化エラー:', error);
      console.log('⚠️ 通知機能は利用できませんが、他の機能は正常に動作します');
    }
  }

  // バッジカウントを増やす（利用可能な場合）
  function incrementBadgeIfAvailable() {
    try {
      // localStorageから現在のカウントを取得
      const currentCount = parseInt(localStorage.getItem('badgeCount') || '0', 10);
      const newCount = currentCount + 1;

      // localStorageに保存
      localStorage.setItem('badgeCount', newCount.toString());
      console.log('📛 バッジカウント更新:', newCount);

      // Badge APIで更新（対応ブラウザのみ）
      if ('setAppBadge' in navigator) {
        navigator.setAppBadge(newCount)
          .then(() => console.log('✅ Badge API更新成功:', newCount))
          .catch(err => console.error('❌ Badge APIエラー:', err));
      }
    } catch (error) {
      console.error('❌ バッジ更新エラー:', error);
    }
  }

  // ページ読み込み完了後、少し遅延させてからFirebase Messagingを初期化
  // （他のスクリプトが完全に読み込まれるのを待つ）
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initFirebaseMessaging, 2000);
    });
  } else {
    setTimeout(initFirebaseMessaging, 2000);
  }

  // ================= 設定変更リスナー（postMessage） =================

  /**
   * localStorageから設定を読み込んでwindow.CACHED_CONFIGを更新
   * CONFIG_STORAGE_KEYSはproduct-scripts.jsで定義済み（window.CONFIG_STORAGE_KEYS）
   */
  function reloadConfigFromLocalStorage() {
    try {
      console.log('🔄 localStorageから設定を再読み込み中...');

      // グローバルwindow.CACHED_CONFIG変数を更新
      if (!window.CACHED_CONFIG) {
        window.CACHED_CONFIG = {};
      }

      const conditionButtons = localStorage.getItem(window.CONFIG_STORAGE_KEYS.CONDITION_BUTTONS);
      const hashtag = localStorage.getItem(window.CONFIG_STORAGE_KEYS.HASHTAG);
      const discount = localStorage.getItem(window.CONFIG_STORAGE_KEYS.DISCOUNT);
      const shippingDefault = localStorage.getItem(window.CONFIG_STORAGE_KEYS.SHIPPING_DEFAULT);
      const procureListingDefault = localStorage.getItem(window.CONFIG_STORAGE_KEYS.PROCURE_LISTING_DEFAULT);
      const managementNumber = localStorage.getItem(window.CONFIG_STORAGE_KEYS.MANAGEMENT_NUMBER);
      const salesword = localStorage.getItem(window.CONFIG_STORAGE_KEYS.SALESWORD);
      const aiSettings = localStorage.getItem(window.CONFIG_STORAGE_KEYS.AI_SETTINGS);
      const theme = localStorage.getItem(window.CONFIG_STORAGE_KEYS.DESIGN_THEME);

      if (conditionButtons) window.CACHED_CONFIG['商品状態ボタン'] = JSON.parse(conditionButtons);
      if (hashtag) window.CACHED_CONFIG['ハッシュタグ'] = JSON.parse(hashtag);
      if (discount) window.CACHED_CONFIG['割引情報'] = JSON.parse(discount);
      if (shippingDefault) window.CACHED_CONFIG['配送デフォルト'] = JSON.parse(shippingDefault);
      if (procureListingDefault) window.CACHED_CONFIG['仕入出品デフォルト'] = JSON.parse(procureListingDefault);
      if (managementNumber) window.CACHED_CONFIG['管理番号設定'] = JSON.parse(managementNumber);
      if (salesword) window.CACHED_CONFIG['よく使うセールスワード'] = JSON.parse(salesword);
      if (aiSettings) window.CACHED_CONFIG['AI生成設定'] = JSON.parse(aiSettings);
      if (theme) window.CACHED_CONFIG['デザインテーマ'] = theme;

      console.log('✅ window.CACHED_CONFIGを更新しました:', window.CACHED_CONFIG);

      // 商品画像ブロックの表示/非表示を更新
      checkProductImageBlockVisibility();

      console.log('✅ 設定を再読み込みしました');
    } catch (e) {
      console.error('❌ localStorage読み込みエラー:', e);
    }
  }

  /**
   * postMessageリスナー（設定変更通知を受け取る）
   */
  window.addEventListener('message', function(event) {
    // configChangedメッセージを受け取ったら設定を再読み込み
    if (event.data && event.data.type === 'configChanged') {
      console.log('📥 設定変更通知を受信しました');
      reloadConfigFromLocalStorage();
    }
  });

  console.log('✅ 設定変更リスナーを登録しました');

  // DOMContentLoaded後にオーバーレイを初期化
  document.addEventListener('DOMContentLoaded', initLoadingOverlay);

  // デフォルトセールスワード適用はproduct-scripts.jsに統合（重複削除）

</script>

<!-- QRコード生成ライブラリ -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<!-- QRコードモーダル -->
<div id="qrCodeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
  <div style="background: white; border-radius: 16px; padding: 24px; max-width: 360px; width: 90%; text-align: center;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <h5 style="margin: 0; font-weight: 600;">QRコード</h5>
      <button onclick="closeQRCodeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">×</button>
    </div>

    <div id="qrCodeContainer" style="margin: 16px auto; padding: 16px; background: white; border: 2px solid #e5e7eb; border-radius: 12px;">
      <canvas id="qrCodeCanvas"></canvas>
    </div>

    <div id="qrCodeInfo" style="margin-bottom: 16px; text-align: left; background: #f9fafb; border-radius: 8px; padding: 12px;">
      <div style="font-size: 12px; color: #6b7280;">管理番号</div>
      <div id="qrMgmtNumber" style="font-weight: 700; font-size: 18px; color: #1f2937;"></div>
      <div id="qrProductName" style="font-size: 13px; color: #374151; margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></div>
    </div>

    <div style="display: flex; gap: 8px;">
      <button onclick="downloadQRCode()" style="flex: 1; padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
        <i class="bi bi-download"></i> 保存
      </button>
      <button onclick="printQRCode()" style="flex: 1; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
        <i class="bi bi-printer"></i> 印刷
      </button>
    </div>

    <div style="margin-top: 12px; font-size: 11px; color: #9ca3af;">
      棚卸時にスマホでスキャンすると<br>商品情報を素早く呼び出せます
    </div>
  </div>
</div>

<script>
  // QRコード表示セクションを管理番号が確定したら表示
  function updateQRCodeSectionVisibility() {
    const mgmtNumber = document.getElementById('管理番号')?.value;
    const qrSection = document.getElementById('qrCodeSection');
    if (qrSection) {
      qrSection.style.display = mgmtNumber ? 'block' : 'none';
    }
  }

  // 管理番号フィールドの変更を監視
  const mgmtNumberInput = document.getElementById('管理番号');
  if (mgmtNumberInput) {
    // MutationObserverでvalue変更を検知
    const observer = new MutationObserver(() => updateQRCodeSectionVisibility());
    observer.observe(mgmtNumberInput, { attributes: true, attributeFilter: ['value'] });

    // 入力イベントでも検知
    mgmtNumberInput.addEventListener('input', updateQRCodeSectionVisibility);
    mgmtNumberInput.addEventListener('change', updateQRCodeSectionVisibility);

    // 初期チェック（遅延実行）
    setTimeout(updateQRCodeSectionVisibility, 1000);
  }

  // QRコードモーダル表示
  function showQRCodeModal() {
    const mgmtNumber = document.getElementById('管理番号')?.value;
    if (!mgmtNumber) {
      alert('管理番号がありません');
      return;
    }

    const productName = document.getElementById('商品名')?.value ||
                       document.getElementById('productName')?.value ||
                       '';
    const brand = document.getElementById('ブランド')?.value || '';

    // QRコードデータ
    const qrData = JSON.stringify({
      type: 'product',
      managementNumber: mgmtNumber,
      name: (brand + ' ' + productName).trim().slice(0, 50)
    });

    // QRコード生成
    const canvas = document.getElementById('qrCodeCanvas');
    QRCode.toCanvas(canvas, qrData, {
      width: 200,
      margin: 2,
      errorCorrectionLevel: 'M',
      color: {
        dark: '#000000',
        light: '#ffffff'
      }
    }, function(error) {
      if (error) {
        console.error('QRコード生成エラー:', error);
        alert('QRコードの生成に失敗しました');
        return;
      }
    });

    // 情報表示
    document.getElementById('qrMgmtNumber').textContent = mgmtNumber;
    document.getElementById('qrProductName').textContent = (brand + ' ' + productName).trim() || '-';

    // モーダル表示
    document.getElementById('qrCodeModal').style.display = 'flex';
  }

  function closeQRCodeModal() {
    document.getElementById('qrCodeModal').style.display = 'none';
  }

  // QRコード画像ダウンロード
  function downloadQRCode() {
    const canvas = document.getElementById('qrCodeCanvas');
    const mgmtNumber = document.getElementById('qrMgmtNumber').textContent;

    const link = document.createElement('a');
    link.download = `QR_${mgmtNumber}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
  }

  // QRコード印刷 v307: iOS対応（閉じるボタン追加）
  function printQRCode() {
    const canvas = document.getElementById('qrCodeCanvas');
    const mgmtNumber = document.getElementById('qrMgmtNumber').textContent;
    const productName = document.getElementById('qrProductName').textContent;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>QRコード - ${mgmtNumber}</title>
        <style>
          @page { size: 62mm 29mm; margin: 0; }
          body {
            margin: 0;
            padding: 4mm;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            display: flex;
            align-items: center;
            gap: 4mm;
          }
          .qr-code { width: 20mm; height: 20mm; }
          .info { flex: 1; }
          .mgmt-number { font-size: 14pt; font-weight: bold; }
          .product-name { font-size: 8pt; color: #666; margin-top: 2mm; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 30mm; }
          /* v307: iOS用の閉じるボタン */
          .close-btn-container {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 9999;
          }
          .close-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
          }
          @media print {
            .close-btn-container { display: none !important; }
          }
        </style>
      </head>
      <body>
        <img src="${canvas.toDataURL('image/png')}" class="qr-code">
        <div class="info">
          <div class="mgmt-number">${mgmtNumber}</div>
          <div class="product-name">${productName}</div>
        </div>
        <!-- v307: iOS用の閉じるボタン -->
        <div class="close-btn-container">
          <button class="close-btn" onclick="window.close(); history.back();">印刷完了・閉じる</button>
        </div>
      </body>
      </html>
    `);
    printWindow.document.close();
    printWindow.onload = function() {
      printWindow.print();
      // v307: iOS Safariではwindow.close()が効かないため、ボタンで閉じる
      // PCブラウザでは自動で閉じる試行
      setTimeout(function() {
        try { printWindow.close(); } catch(e) {}
      }, 1000);
    };
  }

  // モーダル外クリックで閉じる
  document.getElementById('qrCodeModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeQRCodeModal();
  });

  // ========================================
  // QRコード読み取り機能（仕入商品紐付け）
  // ========================================
  let qrScanner = null;

  function openQRScanner() {
    const modal = document.getElementById('qrScannerModal');
    if (modal) {
      modal.style.display = 'flex';
      startQRScanner();
    }
  }

  function closeQRScanner() {
    const modal = document.getElementById('qrScannerModal');
    if (modal) {
      modal.style.display = 'none';
    }
    // オーバーレイテキストを非表示（次回オープン時のため）
    const overlay = document.getElementById('qrOverlayText');
    if (overlay) overlay.style.display = 'none';
    stopQRScanner();

    // ヘッダーとメインフォームコンテンツを表示
    const pageHeader = document.getElementById('pageHeader');
    if (pageHeader) {
      pageHeader.style.display = 'flex';  // flexboxレイアウトのため
    }
    const mainContent = document.getElementById('mainFormContent');
    if (mainContent) {
      mainContent.style.display = 'block';
    }
  }

  function startQRScanner() {
    const readerElement = document.getElementById('qrReader');
    if (!readerElement) return;

    // html5-qrcodeライブラリを動的に読み込み
    if (typeof Html5Qrcode === 'undefined') {
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js';
      script.onload = function() {
        initQRScanner();
      };
      document.head.appendChild(script);
    } else {
      initQRScanner();
    }
  }

  function initQRScanner() {
    qrScanner = new Html5Qrcode("qrReader");
    qrScanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: { width: 250, height: 250 } },
      onQRScanSuccess,
      onQRScanFailure
    ).then(() => {
      // カメラ起動成功時にオーバーレイテキストを表示
      const overlay = document.getElementById('qrOverlayText');
      if (overlay) overlay.style.display = 'block';
    }).catch(err => {
      console.error("カメラ起動失敗:", err);
      // エラー時はオーバーレイを非表示のまま
      const overlay = document.getElementById('qrOverlayText');
      if (overlay) overlay.style.display = 'none';
      document.getElementById('qrReader').innerHTML = `
        <div style="text-align: center; padding: 20px; color: #ef4444;">
          <i class="bi bi-camera-video-off" style="font-size: 48px;"></i>
          <p>カメラにアクセスできません</p>
          <button onclick="manualInvIdInput()" style="margin-top: 12px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">
            手動で入力
          </button>
        </div>
      `;
    });
  }

  function stopQRScanner() {
    if (qrScanner) {
      qrScanner.stop().catch(err => console.log("Scanner stop error:", err));
      qrScanner = null;
    }
  }

  async function onQRScanSuccess(decodedText) {
    console.log('📷 QRスキャン成功:', decodedText);

    // スキャナー停止
    stopQRScanner();
    closeQRScanner();

    // INV-010: slotId形式のQRコード対応（BATCH-で始まる）
    if (decodedText.startsWith('BATCH-')) {
      try {
        const db = firebase.firestore();
        const slotDoc = await db.collection('purchaseSlots').doc(decodedText).get();
        if (!slotDoc.exists) {
          alert('⚠️ このスロットは見つかりませんでした。');
          return;
        }
        const slotData = slotDoc.data();
        console.log('📦 slotId形式QRコード検出:', slotData);

        // INV-010: sku-based商品の場合は在庫追加モード対応
        if (slotData.itemType === 'sku-based' && slotData.skuId) {
          // 既存SKUで登録済み商品があるか確認
          const existingProduct = await findProductBySkuId(slotData.skuId);

          if (existingProduct) {
            // 既存SKU商品が見つかった場合：在庫追加モード
            const choice = confirm(
              `📦 既存SKU商品が見つかりました\n\n` +
              `商品名: ${existingProduct.商品名 || existingProduct.name || '未設定'}\n` +
              `現在庫: ${existingProduct.stockQuantity || 0}点\n` +
              `追加数: ${slotData.quantity}点\n\n` +
              `【OK】在庫を追加（${(existingProduct.stockQuantity || 0) + slotData.quantity}点になります）\n` +
              `【キャンセル】新規商品として登録`
            );

            if (choice) {
              // 在庫追加処理
              await addStockToExistingSku(slotData.skuId, slotData.quantity, slotData.slotId);
              alert(`✅ 在庫を追加しました\n\n商品: ${existingProduct.商品名 || existingProduct.name}\n新在庫数: ${(existingProduct.stockQuantity || 0) + slotData.quantity}点`);
              return;
            }
            // キャンセル：新規商品登録へ続行
          } else {
            // SKUはあるが商品未登録の場合
            const result = confirm(
              `📦 新品(複数)商品です\n\n` +
              `数量: ${slotData.quantity}点\n` +
              `仕入単価: ¥${slotData.unitPrice?.toLocaleString() || '-'}\n` +
              `SKU: ${slotData.skuId}\n\n` +
              `商品登録を続けますか？`
            );
            if (!result) return;
          }
        } else if (slotData.itemType === 'sku-based') {
          // SKU IDがない場合（旧データ互換）
          const result = confirm(
            `📦 新品(複数)商品です\n\n` +
            `数量: ${slotData.quantity}点\n` +
            `仕入単価: ¥${slotData.unitPrice?.toLocaleString() || '-'}\n\n` +
            `商品登録を続けますか？`
          );
          if (!result) return;
        }

        // qrDataフォーマットに変換
        const qrData = {
          s: slotData.slotId,
          n: slotData.slotNumber,
          d: slotData.purchaseDate,
          sup: slotData.supplier,
          amt: slotData.amount,
          asg: slotData.assignee,
          m: slotData.memo || '',
          cat: slotData.category || null,
          sz: slotData.size || '',
          br: slotData.brand || '',
          brk: slotData.brandKana || '',
          cnd: slotData.condition || '',
          acc: slotData.accessories || [],
          nt: slotData.note || '',
          // INV-010: 追加フィールド
          itemType: slotData.itemType || 'unique',
          quantity: slotData.quantity || 1,
          skuId: slotData.skuId || null,
          unitPrice: slotData.unitPrice || null
        };

        // 仕入商品IDをセット
        setInvId(slotData.slotId);

        // 仕入情報を自動反映
        applyPurchaseQRData(qrData);
        return;
      } catch (error) {
        console.error('slotId QRコード処理エラー:', error);
        alert('⚠️ データの取得に失敗しました。');
        return;
      }
    }

    // JSON形式の仕入QRコードかチェック
    let qrData = null;
    try {
      qrData = JSON.parse(decodedText);
    } catch (e) {
      // JSON形式でない場合は従来の処理
    }

    // 仕入QRコード（検品情報付き）の場合
    if (qrData && qrData.s && qrData.n) {
      console.log('📦 仕入QRコード検出（検品情報付き）:', qrData);

      // 仕入商品IDをセット
      setInvId(qrData.s);

      // 仕入情報を自動反映
      applyPurchaseQRData(qrData);
      return;
    }

    // 従来の処理（URLベースのinvId抽出）
    let invId = decodedText;
    try {
      const url = new URL(decodedText);
      invId = url.searchParams.get('inv') || decodedText;
    } catch (e) {
      // URLでない場合はそのまま使用
    }

    // 仕入商品IDをセット
    setInvId(invId);
  }

  // 仕入QRコードのデータを商品登録フォームに自動反映
  function applyPurchaseQRData(qrData) {
    console.log('🔄 検品情報を自動反映中...');
    
    // 仕入日
    if (qrData.d) {
      const purchaseDateEl = document.getElementById('仕入日');
      if (purchaseDateEl) purchaseDateEl.value = qrData.d;
    }
    
    // 仕入金額
    if (qrData.amt) {
      const purchaseAmountEl = document.getElementById('仕入金額');
      if (purchaseAmountEl) purchaseAmountEl.value = qrData.amt;
    }
    
    // 仕入先
    if (qrData.sup) {
      const supplierEl = document.getElementById('仕入先');
      if (supplierEl) {
        // selectの選択肢から一致するものを探す
        const options = supplierEl.options;
        for (let i = 0; i < options.length; i++) {
          if (options[i].value === qrData.sup || options[i].text.includes(qrData.sup)) {
            supplierEl.selectedIndex = i;
            break;
          }
        }
      }
    }
    
    // カテゴリ（7階層対応）
    if (qrData.cat) {
      const categoryObj = typeof qrData.cat === 'object' ? qrData.cat : { superCategory: qrData.cat };

      // 特大分類
      if (categoryObj.superCategory) {
        const l0El = document.getElementById('特大分類');
        if (l0El) {
          for (let i = 0; i < l0El.options.length; i++) {
            if (l0El.options[i].value === categoryObj.superCategory) {
              l0El.selectedIndex = i;
              l0El.dispatchEvent(new Event('change', { bubbles: true }));
              break;
            }
          }
        }
      }

      // 大分類〜アイテム名は連動プルダウンなので、少し遅延させて設定
      setTimeout(() => {
        // 大分類
        if (categoryObj.major) {
          const l1El = document.getElementById('大分類(カテゴリ)');
          if (l1El) {
            for (let i = 0; i < l1El.options.length; i++) {
              if (l1El.options[i].value === categoryObj.major) {
                l1El.selectedIndex = i;
                l1El.dispatchEvent(new Event('change', { bubbles: true }));
                break;
              }
            }
          }
        }

        setTimeout(() => {
          // 中分類
          if (categoryObj.middle) {
            const l2El = document.getElementById('中分類(カテゴリ)');
            if (l2El) {
              for (let i = 0; i < l2El.options.length; i++) {
                if (l2El.options[i].value === categoryObj.middle) {
                  l2El.selectedIndex = i;
                  l2El.dispatchEvent(new Event('change', { bubbles: true }));
                  break;
                }
              }
            }
          }

          setTimeout(() => {
            // 小分類
            if (categoryObj.small) {
              const l3El = document.getElementById('小分類(カテゴリ)');
              if (l3El) {
                for (let i = 0; i < l3El.options.length; i++) {
                  if (l3El.options[i].value === categoryObj.small) {
                    l3El.selectedIndex = i;
                    l3El.dispatchEvent(new Event('change', { bubbles: true }));
                    break;
                  }
                }
              }
            }

            setTimeout(() => {
              // 細分類
              if (categoryObj.fine) {
                const l4El = document.getElementById('細分類(カテゴリ)');
                if (l4El) {
                  for (let i = 0; i < l4El.options.length; i++) {
                    if (l4El.options[i].value === categoryObj.fine) {
                      l4El.selectedIndex = i;
                      l4El.dispatchEvent(new Event('change', { bubbles: true }));
                      break;
                    }
                  }
                }
              }

              setTimeout(() => {
                // 細分類2
                if (categoryObj.fine2) {
                  const l5El = document.getElementById('細分類2');
                  if (l5El) {
                    for (let i = 0; i < l5El.options.length; i++) {
                      if (l5El.options[i].value === categoryObj.fine2) {
                        l5El.selectedIndex = i;
                        l5El.dispatchEvent(new Event('change', { bubbles: true }));
                        break;
                      }
                    }
                  }
                }

                setTimeout(() => {
                  // アイテム名
                  if (categoryObj.itemName) {
                    const itemEl = document.getElementById('アイテム名');
                    if (itemEl) {
                      for (let i = 0; i < itemEl.options.length; i++) {
                        if (itemEl.options[i].value === categoryObj.itemName) {
                          itemEl.selectedIndex = i;
                          itemEl.dispatchEvent(new Event('change', { bubbles: true }));
                          break;
                        }
                      }
                    }
                  }
                }, 100);
              }, 100);
            }, 100);
          }, 100);
        }, 100);
      }, 100);
    }

    // サイズ
    if (qrData.sz) {
      const sizeEl = document.getElementById('サイズ');
      if (sizeEl) sizeEl.value = qrData.sz;
    }

    // ブランド
    if (qrData.br) {
      const brandEl = document.getElementById('ブランド(英語)');
      if (brandEl) brandEl.value = qrData.br;
      // 商品名用ブランドフィールドにも反映
      const brandNameEl = document.getElementById('商品名_ブランド(英語)');
      if (brandNameEl) brandNameEl.value = qrData.br;
      // ブランドカナも反映
      if (qrData.brk) {
        const brandKanaEl = document.getElementById('ブランド(カナ)');
        if (brandKanaEl) brandKanaEl.value = qrData.brk;
        const brandNameKanaEl = document.getElementById('商品名_ブランド(カナ)');
        if (brandNameKanaEl) brandNameKanaEl.value = qrData.brk;
      }
    }
    
    // 商品の状態
    if (qrData.cnd) {
      const conditionEl = document.getElementById('商品の状態');
      if (conditionEl) {
        const options = conditionEl.options;
        for (let i = 0; i < options.length; i++) {
          if (options[i].value === qrData.cnd || options[i].text === qrData.cnd) {
            conditionEl.selectedIndex = i;
            conditionEl.dispatchEvent(new Event('change', { bubbles: true }));
            break;
          }
        }
      }
    }
    
    // 付属品情報（チェックボックスに連動）
    if (qrData.acc && qrData.acc.length > 0) {
      // 付属品チェックボックスを設定（product-scripts.jsで定義）
      if (typeof window.setAccessoriesFromQR === 'function') {
        window.setAccessoriesFromQR(qrData.acc);
      } else {
        // フォールバック: 商品状態詳細に追加
        const accessoriesText = '【付属品】' + qrData.acc.join('、');
        const conditionDetailEl = document.getElementById('商品状態詳細');
        if (conditionDetailEl) {
          const current = conditionDetailEl.value;
          conditionDetailEl.value = current ? current + '\n' + accessoriesText : accessoriesText;
        }
      }
    }
    
    // 特記事項（検品メモ）
    if (qrData.nt) {
      const conditionDetailEl = document.getElementById('商品状態詳細');
      if (conditionDetailEl) {
        const current = conditionDetailEl.value;
        const noteText = '【検品メモ】' + qrData.nt;
        conditionDetailEl.value = current ? current + '\n' + noteText : noteText;
      }
    }
    
    // メモ
    if (qrData.m) {
      const conditionDetailEl = document.getElementById('商品状態詳細');
      if (conditionDetailEl && qrData.m) {
        const current = conditionDetailEl.value;
        const memoText = '【仕入メモ】' + qrData.m;
        conditionDetailEl.value = current ? current + '\n' + memoText : memoText;
      }
    }

    // 傷・汚れマーキング画像をFirestoreから取得
    if (qrData.s && window.db) {
      loadDamageMarkerFromFirestore(qrData.s);
    }

    // INV-010: SKU情報をグローバル変数に保持（商品登録時に使用）
    window.currentSkuInfo = {
      itemType: qrData.itemType || 'unique',
      quantity: qrData.quantity || 1,
      skuId: qrData.skuId || null,
      unitPrice: qrData.unitPrice || null
    };

    // INV-010: sku-based商品の場合は情報を表示
    if (qrData.itemType === 'sku-based') {
      showSkuInfoBanner(qrData);
    }

    // 反映完了通知
    showInspectionDataAppliedNotification(qrData);

    console.log('✅ 検品情報の自動反映完了');
  }

  // INV-010: SKU情報バナー表示
  function showSkuInfoBanner(qrData) {
    // 既存バナーがあれば削除
    const existingBanner = document.getElementById('skuInfoBanner');
    if (existingBanner) existingBanner.remove();

    const banner = document.createElement('div');
    banner.id = 'skuInfoBanner';
    banner.style.cssText = `
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border: 1px solid #3b82f6;
      border-radius: 8px;
      padding: 12px 16px;
      margin: 12px 0;
      display: flex;
      align-items: center;
      gap: 12px;
    `;
    banner.innerHTML = `
      <span style="font-size: 24px;">📦</span>
      <div style="flex: 1;">
        <div style="font-weight: 600; color: #1e40af; margin-bottom: 4px;">新品(複数)商品</div>
        <div style="font-size: 13px; color: #1e3a8a;">
          数量: <strong>${qrData.quantity}点</strong> ／
          仕入単価: <strong>¥${qrData.unitPrice?.toLocaleString() || '-'}</strong>
          ${qrData.skuId ? `／ SKU: <code style="background:#e0f2fe; padding:2px 6px; border-radius:4px;">${qrData.skuId}</code>` : ''}
        </div>
      </div>
    `;

    // 仕入商品ID入力欄の後に挿入
    const invIdEl = document.getElementById('invId');
    if (invIdEl && invIdEl.parentElement) {
      invIdEl.parentElement.insertAdjacentElement('afterend', banner);
    }
  }

  // マーキング画像のグローバル保持（商品登録時に使用）
  window.currentDamageMarker = {
    image: null,
    type: null,
    note: null
  };

  // Firestoreから傷・汚れマーキング画像を取得して表示
  async function loadDamageMarkerFromFirestore(slotId) {
    try {
      console.log('📍 マーキング画像取得中:', slotId);
      const slotDoc = await window.db.collection('purchaseSlots').doc(slotId).get();
      
      if (slotDoc.exists) {
        const slotData = slotDoc.data();
        
        if (slotData.damageMarkerImage) {
          console.log('✅ マーキング画像を検出');
          const previewSection = document.getElementById('damageMarkerPreviewSection');
          const previewImg = document.getElementById('damageMarkerPreviewImg');
          const typeLabel = document.getElementById('damageMarkerTypeLabel');
          const noteSection = document.getElementById('damageMarkerNoteSection');
          const noteText = document.getElementById('damageMarkerNoteText');

          previewImg.src = slotData.damageMarkerImage;
          typeLabel.textContent = slotData.damageMarkerType || '';
          previewSection.style.display = 'block';

          // 補足説明があれば表示
          if (slotData.damageMarkerNote) {
            noteText.textContent = slotData.damageMarkerNote;
            noteSection.style.display = 'block';
          } else {
            noteSection.style.display = 'none';
          }

          // グローバル変数に保持（商品登録時に使用）
          window.currentDamageMarker = {
            image: slotData.damageMarkerImage,
            type: slotData.damageMarkerType || null,
            note: slotData.damageMarkerNote || null
          };
        } else {
          console.log('ℹ️ マーキング画像なし');
          window.currentDamageMarker = { image: null, type: null, note: null };
        }
      } else {
        console.log('⚠️ スロットが見つかりません:', slotId);
        window.currentDamageMarker = { image: null, type: null, note: null };
      }
    } catch (error) {
      console.error('❌ マーキング画像取得エラー:', error);
      window.currentDamageMarker = { image: null, type: null, note: null };
    }
  }

  // 検品情報反映完了の通知表示
  function showInspectionDataAppliedNotification(qrData) {
    // 反映された項目をカウント
    const appliedItems = [];
    if (qrData.d) appliedItems.push('仕入日');
    if (qrData.amt) appliedItems.push('仕入金額');
    if (qrData.sup) appliedItems.push('仕入先');
    if (qrData.cat) appliedItems.push('カテゴリ');
    if (qrData.br) appliedItems.push('ブランド');
    if (qrData.cnd) appliedItems.push('商品状態');
    if (qrData.acc && qrData.acc.length > 0) appliedItems.push('付属品');
    if (qrData.nt) appliedItems.push('検品メモ');
    
    // 通知要素を作成
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 20000;
      font-weight: 600;
      text-align: center;
      max-width: 90%;
      animation: slideDown 0.3s ease-out;
    `;
    notification.innerHTML = `
      <div style="display: flex; align-items: center; gap: 12px;">
        <i class="bi bi-check-circle-fill" style="font-size: 24px;"></i>
        <div>
          <div>検品情報を自動反映しました</div>
          <div style="font-size: 12px; font-weight: 400; margin-top: 4px; opacity: 0.9;">
            ${appliedItems.join('、')}
          </div>
        </div>
      </div>
    `;
    
    // アニメーション用スタイルを追加
    if (!document.getElementById('inspection-notification-style')) {
      const style = document.createElement('style');
      style.id = 'inspection-notification-style';
      style.textContent = `
        @keyframes slideDown {
          from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
          to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
      `;
      document.head.appendChild(style);
    }
    
    document.body.appendChild(notification);
    
    // 3秒後に自動で消す
    setTimeout(() => {
      notification.style.transition = 'opacity 0.3s, transform 0.3s';
      notification.style.opacity = '0';
      notification.style.transform = 'translateX(-50%) translateY(-20px)';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  function onQRScanFailure(error) {
    // 継続してスキャン（エラーは無視）
  }

  // INV-010: SKUで既存商品を検索
  async function findProductBySkuId(skuId) {
    try {
      const db = firebase.firestore();
      const snapshot = await db.collection('products')
        .where('skuId', '==', skuId)
        .limit(1)
        .get();

      if (snapshot.empty) return null;
      return { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
    } catch (error) {
      console.error('SKU検索エラー:', error);
      return null;
    }
  }

  // INV-010: 既存SKU商品に在庫追加
  async function addStockToExistingSku(skuId, quantity, slotId) {
    try {
      const db = firebase.firestore();
      const batch = db.batch();

      // 1. productsの在庫数を更新
      const productSnapshot = await db.collection('products')
        .where('skuId', '==', skuId)
        .limit(1)
        .get();

      if (!productSnapshot.empty) {
        const productRef = productSnapshot.docs[0].ref;
        batch.update(productRef, {
          stockQuantity: firebase.firestore.FieldValue.increment(quantity),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }

      // 2. skusの在庫数を更新
      const skuRef = db.collection('skus').doc(skuId);
      batch.set(skuRef, {
        currentStock: firebase.firestore.FieldValue.increment(quantity),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });

      // 3. purchaseSlotsのステータスを更新
      const slotRef = db.collection('purchaseSlots').doc(slotId);
      batch.update(slotRef, {
        status: 'registered',
        registeredAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      await batch.commit();
      console.log('✅ 在庫追加完了:', { skuId, quantity, slotId });
    } catch (error) {
      console.error('在庫追加エラー:', error);
      throw error;
    }
  }

  function setInvId(invId) {
    document.getElementById('invId').value = invId;

    // ステータスセクションを表示
    const statusSection = document.getElementById('qrStatusSection');
    statusSection.style.display = 'block';

    // ステータス表示を更新（読み込み中）
    const statusDiv = document.getElementById('qrScanStatus');
    statusDiv.innerHTML = `
      <div style="display: flex; align-items: center; gap: 8px;">
        <i class="bi bi-hourglass-split" style="color: #f59e0b; font-size: 20px;"></i>
        <div style="flex: 1;">
          <div style="font-weight: 600; color: #92400e;">仕入情報を読み込み中...</div>
          <div style="font-size: 12px; color: #b45309;">${invId}</div>
        </div>
      </div>
    `;

    // フローティングボタンを非表示
    const floatingBtn = document.getElementById('qrFloatingBtn');
    floatingBtn.style.display = 'none';

    // Firestoreから仕入情報を取得して反映
    fetchAndApplyPurchaseSlotData(invId);
  }

  // Firestoreから仕入スロットデータを取得してフォームに反映
  async function fetchAndApplyPurchaseSlotData(slotId) {
    const statusDiv = document.getElementById('qrScanStatus');

    try {
      console.log('📦 仕入スロット取得開始:', slotId);

      const doc = await window.db.collection('purchaseSlots').doc(slotId).get();

      if (!doc.exists) {
        console.warn('仕入スロットが見つかりません:', slotId);
        statusDiv.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px;">
            <i class="bi bi-exclamation-triangle-fill" style="color: #f59e0b; font-size: 20px;"></i>
            <div style="flex: 1;">
              <div style="font-weight: 600; color: #92400e;">仕入情報が見つかりません</div>
              <div style="font-size: 12px; color: #b45309;">${slotId}</div>
            </div>
            <button onclick="clearInvId()" style="background: none; border: none; color: #6b7280; cursor: pointer; padding: 4px;">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
        `;
        return;
      }

      const slotData = doc.data();
      console.log('📦 仕入スロットデータ:', slotData);

      // ステータス表示を更新（紐付け完了）
      statusDiv.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px;">
          <i class="bi bi-check-circle-fill" style="color: #10b981; font-size: 20px;"></i>
          <div style="flex: 1;">
            <div style="font-weight: 600; color: #065f46;">仕入商品と紐付け済み</div>
            <div style="font-size: 12px; color: #047857;">${slotId}</div>
          </div>
          <button onclick="clearInvId()" style="background: none; border: none; color: #6b7280; cursor: pointer; padding: 4px;">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      `;

      // フォームにデータを反映
      applyPurchaseSlotDataToForm(slotData);

    } catch (error) {
      console.error('仕入スロット取得エラー:', error);
      statusDiv.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px;">
          <i class="bi bi-x-circle-fill" style="color: #ef4444; font-size: 20px;"></i>
          <div style="flex: 1;">
            <div style="font-weight: 600; color: #dc2626;">読み込みエラー</div>
            <div style="font-size: 12px; color: #b91c1c;">${slotId}</div>
          </div>
          <button onclick="clearInvId()" style="background: none; border: none; color: #6b7280; cursor: pointer; padding: 4px;">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      `;
    }
  }

  // 仕入スロットデータをフォームに反映
  function applyPurchaseSlotDataToForm(slotData) {
    console.log('🔄 仕入情報をフォームに反映中...');

    // 仕入日
    if (slotData.purchaseDate) {
      const purchaseDateEl = document.getElementById('仕入日');
      if (purchaseDateEl) purchaseDateEl.value = slotData.purchaseDate;
    }

    // 仕入金額
    if (slotData.amount) {
      const purchaseAmountEl = document.getElementById('仕入金額');
      if (purchaseAmountEl) purchaseAmountEl.value = slotData.amount;
    }

    // 仕入先
    if (slotData.supplier) {
      const supplierEl = document.getElementById('仕入先');
      if (supplierEl) {
        const options = supplierEl.options;
        for (let i = 0; i < options.length; i++) {
          if (options[i].value === slotData.supplier || options[i].text.includes(slotData.supplier)) {
            supplierEl.selectedIndex = i;
            break;
          }
        }
      }
    }

    // カテゴリ（7階層対応）
    if (slotData.category) {
      const categoryObj = slotData.category;

      // 特大分類
      if (categoryObj.superCategory) {
        const l0El = document.getElementById('特大分類');
        if (l0El) {
          for (let i = 0; i < l0El.options.length; i++) {
            if (l0El.options[i].value === categoryObj.superCategory) {
              l0El.selectedIndex = i;
              l0El.dispatchEvent(new Event('change', { bubbles: true }));
              break;
            }
          }
        }
      }

      // 大分類〜アイテム名は連動プルダウンなので、遅延させて設定
      setTimeout(() => {
        if (categoryObj.major) {
          const l1El = document.getElementById('大分類(カテゴリ)');
          if (l1El) {
            for (let i = 0; i < l1El.options.length; i++) {
              if (l1El.options[i].value === categoryObj.major) {
                l1El.selectedIndex = i;
                l1El.dispatchEvent(new Event('change', { bubbles: true }));
                break;
              }
            }
          }
        }

        setTimeout(() => {
          if (categoryObj.middle) {
            const l2El = document.getElementById('中分類(カテゴリ)');
            if (l2El) {
              for (let i = 0; i < l2El.options.length; i++) {
                if (l2El.options[i].value === categoryObj.middle) {
                  l2El.selectedIndex = i;
                  l2El.dispatchEvent(new Event('change', { bubbles: true }));
                  break;
                }
              }
            }
          }

          setTimeout(() => {
            if (categoryObj.small) {
              const l3El = document.getElementById('小分類(カテゴリ)');
              if (l3El) {
                for (let i = 0; i < l3El.options.length; i++) {
                  if (l3El.options[i].value === categoryObj.small) {
                    l3El.selectedIndex = i;
                    l3El.dispatchEvent(new Event('change', { bubbles: true }));
                    break;
                  }
                }
              }
            }

            setTimeout(() => {
              if (categoryObj.fine) {
                const l4El = document.getElementById('細分類(カテゴリ)');
                if (l4El) {
                  for (let i = 0; i < l4El.options.length; i++) {
                    if (l4El.options[i].value === categoryObj.fine) {
                      l4El.selectedIndex = i;
                      l4El.dispatchEvent(new Event('change', { bubbles: true }));
                      break;
                    }
                  }
                }
              }

              setTimeout(() => {
                if (categoryObj.fine2) {
                  const l5El = document.getElementById('細分類2');
                  if (l5El) {
                    for (let i = 0; i < l5El.options.length; i++) {
                      if (l5El.options[i].value === categoryObj.fine2) {
                        l5El.selectedIndex = i;
                        l5El.dispatchEvent(new Event('change', { bubbles: true }));
                        break;
                      }
                    }
                  }
                }

                setTimeout(() => {
                  if (categoryObj.itemName) {
                    const itemEl = document.getElementById('アイテム名');
                    if (itemEl) {
                      for (let i = 0; i < itemEl.options.length; i++) {
                        if (itemEl.options[i].value === categoryObj.itemName) {
                          itemEl.selectedIndex = i;
                          itemEl.dispatchEvent(new Event('change', { bubbles: true }));
                          break;
                        }
                      }
                    }
                  }
                }, 100);
              }, 100);
            }, 100);
          }, 100);
        }, 100);
      }, 100);
    }

    // サイズ
    if (slotData.size) {
      const sizeEl = document.getElementById('サイズ');
      if (sizeEl) sizeEl.value = slotData.size;
    }

    // ブランド
    if (slotData.brand) {
      const brandEl = document.getElementById('ブランド(英語)');
      if (brandEl) brandEl.value = slotData.brand;
      const brandNameEl = document.getElementById('商品名_ブランド(英語)');
      if (brandNameEl) brandNameEl.value = slotData.brand;
    }
    if (slotData.brandKana) {
      const brandKanaEl = document.getElementById('ブランド(カナ)');
      if (brandKanaEl) brandKanaEl.value = slotData.brandKana;
      const brandNameKanaEl = document.getElementById('商品名_ブランド(カナ)');
      if (brandNameKanaEl) brandNameKanaEl.value = slotData.brandKana;
    }

    // 商品の状態
    if (slotData.condition) {
      const conditionEl = document.getElementById('商品の状態');
      if (conditionEl) {
        const options = conditionEl.options;
        for (let i = 0; i < options.length; i++) {
          if (options[i].value === slotData.condition || options[i].text === slotData.condition) {
            conditionEl.selectedIndex = i;
            conditionEl.dispatchEvent(new Event('change', { bubbles: true }));
            break;
          }
        }
      }
    }

    // 付属品
    if (slotData.accessories && slotData.accessories.length > 0) {
      if (typeof window.setAccessoriesFromQR === 'function') {
        window.setAccessoriesFromQR(slotData.accessories);
      }
    }

    // マーキング画像（傷・ダメージ）
    if (slotData.damageMarkerImage) {
      console.log('📸 マーキング画像を反映:', slotData.damageMarkerImage);

      // プレビューセクションに表示
      const previewSection = document.getElementById('damageMarkerPreviewSection');
      const previewImg = document.getElementById('damageMarkerPreviewImg');
      const typeLabel = document.getElementById('damageMarkerTypeLabel');
      const noteSection = document.getElementById('damageMarkerNoteSection');
      const noteText = document.getElementById('damageMarkerNoteText');

      if (previewSection && previewImg) {
        previewImg.src = slotData.damageMarkerImage;
        if (typeLabel) typeLabel.textContent = slotData.damageMarkerType || '';
        previewSection.style.display = 'block';

        // 補足説明があれば表示
        if (slotData.damageMarkerNote && noteSection && noteText) {
          noteText.textContent = slotData.damageMarkerNote;
          noteSection.style.display = 'block';
        } else if (noteSection) {
          noteSection.style.display = 'none';
        }

        // グローバル変数に保持（商品登録時に使用）
        window.currentDamageMarker = {
          image: slotData.damageMarkerImage,
          type: slotData.damageMarkerType || null,
          note: slotData.damageMarkerNote || null
        };

        console.log('✅ マーキング画像をプレビューに表示');
      }
    }

    // メモ
    if (slotData.note || slotData.memo) {
      const noteText = slotData.note || slotData.memo;
      const conditionDetailEl = document.getElementById('商品状態詳細');
      if (conditionDetailEl && noteText) {
        const current = conditionDetailEl.value;
        conditionDetailEl.value = current ? current + '\n' + noteText : noteText;
      }
    }

    console.log('✅ 仕入情報の反映完了');
  }

  function manualInvIdInput() {
    const invId = prompt('仕入商品IDを入力してください\n例: INV-20251212-XXXX-001');
    if (invId && invId.trim()) {
      closeQRScanner();
      setInvId(invId.trim());
    }
  }

  function clearInvId() {
    document.getElementById('invId').value = '';
    document.getElementById('qrStatusSection').style.display = 'none';
    
    // フローティングボタンを再表示
    const floatingBtn = document.getElementById('qrFloatingBtn');
    floatingBtn.style.display = 'flex';
    floatingBtn.style.background = 'white';
    floatingBtn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.25)';
    floatingBtn.innerHTML = '<img src="/images/qr-scan-icon.png" alt="QRスキャン" style="width: 100%; height: 100%; object-fit: contain;">';
  }

  // 紐付けなしで保存しようとした時の警告チェック
  function checkInvIdBeforeSave() {
    const invId = document.getElementById('invId').value;
    if (!invId) {
      // 警告モーダルを表示
      const result = confirm('⚠️ 仕入商品との紐付けがされていません。\n\nQRコードをスキャンせずに登録すると、仕入情報との紐付けができなくなります。\n\n本当に登録しますか？');
      return result;
    }
    return true;
  }
</script>

<!-- QRスキャン フローティングボタン -->
<button id="qrFloatingBtn" onclick="openQRScanner()" style="
  position: fixed;
  bottom: 70px;
  right: 20px;
  width: 68px;
  height: 68px;
  border-radius: 50%;
  background: white;
  border: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  cursor: pointer;
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 14px;
  transition: transform 0.2s, box-shadow 0.2s;
" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.3)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.25)';">
  <img src="/images/qr-scan-icon.png" alt="QRスキャン" style="width: 100%; height: 100%; object-fit: contain;">
</button>

</div><!-- /mainFormContent -->

<!-- QRスキャナーモーダル -->
<div id="qrScannerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center;">
  <div style="background: white; border-radius: 16px; width: 90%; max-width: 400px; overflow: hidden;">
    <div style="padding: 16px; background: linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%); color: white; position: relative; text-align: center;">
      <span style="font-weight: 600; font-size: 18px;">QRスキャン</span>
      <button onclick="closeQRScanner()" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
    </div>
    <div style="position: relative; width: 100%;">
      <div id="qrReader" style="width: 100%;"></div>
      <!-- カメラビュー内オーバーレイテキスト（カメラ起動後に表示） -->
      <div id="qrOverlayText" style="display: none; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; white-space: nowrap; pointer-events: none;">
        枠内にQRコードを合わせてください
      </div>
    </div>
    <div style="padding: 16px; text-align: center;">
      <p style="font-size: 14px; color: #6b7280; margin-bottom: 12px;">商品タグのQRコードをカメラにかざしてください</p>
      <button onclick="manualInvIdInput()" style="padding: 10px 20px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer;">
        <i class="bi bi-keyboard"></i> 手動で入力
      </button>
      <!-- 自動表示設定トグル -->
      <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
        <label style="display: flex; align-items: center; justify-content: center; gap: 12px; cursor: pointer; font-size: 14px; color: #374151;">
          <span>商品登録時に自動表示</span>
          <!-- iOS風トグルスイッチ -->
          <div style="position: relative; width: 50px; height: 28px;">
            <input type="checkbox" id="qrAutoOpenToggle" onchange="toggleQrAutoOpen()" style="opacity: 0; width: 0; height: 0;">
            <span id="qrToggleTrack" style="
              position: absolute;
              cursor: pointer;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background-color: #e5e7eb;
              transition: 0.3s;
              border-radius: 28px;
            "></span>
            <span id="qrToggleThumb" style="
              position: absolute;
              content: '';
              height: 22px;
              width: 22px;
              left: 3px;
              bottom: 3px;
              background-color: white;
              transition: 0.3s;
              border-radius: 50%;
              box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            "></span>
          </div>
        </label>
        <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">オフにすると、右下のボタンから手動で開けます</p>
      </div>
    </div>
  </div>
</div>

<script>
  // QRスキャナー自動表示設定
  const QR_AUTO_OPEN_KEY = 'reborn_qr_auto_open';
  
  // 設定の初期化（デフォルトはtrue = 自動表示オン）
  function initQrAutoOpenSetting() {
    const saved = localStorage.getItem(QR_AUTO_OPEN_KEY);
    // 初回は設定がないのでtrue（自動表示オン）
    const isEnabled = saved === null ? true : saved === 'true';
    const toggle = document.getElementById('qrAutoOpenToggle');
    if (toggle) {
      toggle.checked = isEnabled;
      updateToggleVisual(isEnabled);
    }
    return isEnabled;
  }
  
  // トグルの見た目を更新
  function updateToggleVisual(isEnabled) {
    const track = document.getElementById('qrToggleTrack');
    const thumb = document.getElementById('qrToggleThumb');
    if (track && thumb) {
      if (isEnabled) {
        track.style.backgroundColor = '#3b82f6';
        thumb.style.transform = 'translateX(22px)';
      } else {
        track.style.backgroundColor = '#e5e7eb';
        thumb.style.transform = 'translateX(0)';
      }
    }
  }
  
  // トグル変更時
  function toggleQrAutoOpen() {
    const toggle = document.getElementById('qrAutoOpenToggle');
    const isEnabled = toggle.checked;
    localStorage.setItem(QR_AUTO_OPEN_KEY, isEnabled.toString());
    updateToggleVisual(isEnabled);
    console.log('[QR設定] 自動表示:', isEnabled ? 'オン' : 'オフ');
  }
  
  // ページ読み込み時に設定に基づいて自動表示
  function autoOpenQrScannerIfEnabled() {
    const isEnabled = initQrAutoOpenSetting();
    const pageHeader = document.getElementById('pageHeader');
    const mainContent = document.getElementById('mainFormContent');

    if (isEnabled) {
      console.log('[QR設定] 自動表示が有効 → QRスキャナーを開く');
      // 少し遅延させて、ページが完全に読み込まれてから開く
      setTimeout(() => {
        openQRScanner();
      }, 500);
    } else {
      console.log('[QR設定] 自動表示が無効 → ヘッダー・メインコンテンツを表示');
      // QR自動表示が無効の場合はヘッダーとメインコンテンツを即座に表示
      if (pageHeader) {
        pageHeader.style.display = 'flex';  // flexboxレイアウトのため
      }
      if (mainContent) {
        mainContent.style.display = 'block';
      }
    }
  }
  
  // ページ読み込み完了時に実行
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', autoOpenQrScannerIfEnabled);
  } else {
    // 少し遅延させて他の初期化処理が完了してから
    setTimeout(autoOpenQrScannerIfEnabled, 300);
  }
</script>

</body>
</html>