<!DOCTYPE html>
<html>
<head>
  <!-- Cache Bust: 2025-12-23 v379 - Firebase v9æ§‹æ–‡ä¿®æ­£ -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <!-- ğŸš¨ ç·Šæ€¥ãƒ‡ãƒãƒƒã‚°: å…¨consoleç„¡åŠ¹åŒ–ï¼ˆSafariå¯¾å¿œï¼‰ - ãƒ‡ãƒãƒƒã‚°ã®ãŸã‚ä¸€æ™‚è§£é™¤ -->
  <!--
  <script>
    window.console = {
      log: function() {},
      warn: function() {},
      error: function() {},
      info: function() {},
      debug: function() {}
    };
  </script>
  -->

  <base target="_top">
  <!-- Agora Web SDK for Voice Call -->
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.0.js"></script>
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- REBORN Brand Colors & Theme -->
  <link rel="stylesheet" href="/css/reborn-brand-colors.css?v=0bd1a9b">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/reborn-theme.css?v=0bd1a9b">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      margin: 0;
      padding: 0;
      padding-top: calc(env(safe-area-inset-top, 0px) + 56px); /* ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢ + ãƒ˜ãƒƒãƒ€ãƒ¼åˆ†ã®ã‚¹ãƒšãƒ¼ã‚¹ */
      height: 100vh;
      overflow: hidden;
      background-color: #f8f9fa;
      display: flex;
      flex-direction: column;
      /* é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºæ™‚ã®ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã‚’ç„¡åŠ¹åŒ– */
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .chat-header {
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      color: white;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      flex-shrink: 0;
      position: relative;
    }
    .chat-header h1 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
      padding-left: 40px; /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ */
    }
    .chat-header .channel-info {
      font-size: 0.875rem;
      opacity: 0.9;
      margin-top: 4px;
      padding-left: 40px; /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ */
    }
    .version-badge {
      font-size: 0.7rem;
      opacity: 0.6;
      margin-left: 8px;
      padding: 2px 6px;
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
    }
    /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆLINEé¢¨ï¼‰ */
    .back-btn {
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: white;
      font-size: 32px;
      padding: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      transition: opacity 0.2s;
      font-weight: 300;
    }
    .back-btn:hover {
      opacity: 0.8;
    }
    .back-btn:active {
      opacity: 0.6;
    }
    /* æˆ»ã‚‹ãƒœã‚¿ãƒ³æœªèª­æ•°ï¼ˆLINEé¢¨ï¼‰ */
    .back-unread-count {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-left: 2px;
    }

    /* æ¤œç´¢ãƒœã‚¿ãƒ³ï¼ˆç™½ãƒ˜ãƒƒãƒ€ãƒ¼ç”¨ï¼‰ */
    .search-button {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 20px;
      -webkit-tap-highlight-color: transparent;
      outline: none;
    }
    .call-button {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 18px;
      -webkit-tap-highlight-color: transparent;
      outline: none;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 56px;
      padding: 0 8px;
      position: relative;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¿ã‚¤ãƒˆãƒ« */
    .header-title {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 8px;
      color: #1f2937;
      font-size: 17px;
      font-weight: 600;
      pointer-events: auto;
    }
    /* ãƒ˜ãƒƒãƒ€ãƒ¼å³å´ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— */
    .header-right-buttons {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    /* è¨­å®šãƒœã‚¿ãƒ³ï¼ˆç™½ãƒ˜ãƒƒãƒ€ãƒ¼ç”¨ï¼‰ */
    .settings-button {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 20px;
      position: relative;
      -webkit-tap-highlight-color: transparent;
      outline: none;
    }

    /* ãƒãƒ£ãƒƒãƒˆè¨­å®šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ */
    .chat-settings-dropdown {
      position: absolute;
      top: 100%;
      right: 8px;
      margin-top: 4px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 180px;
      overflow: hidden;
      display: none;
      z-index: 1001;
    }
    .chat-settings-dropdown.active {
      display: block;
    }
    .chat-settings-item {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      padding: 14px 16px;
      border: none;
      background: transparent;
      font-size: 15px;
      color: #1f2937;
      cursor: pointer;
      text-align: left;
      transition: background 0.2s;
    }
    .chat-settings-item:hover {
      background: #f5f5f5;
    }
    .chat-settings-item:active {
      background: #e5e5e5;
    }
    .chat-settings-item i {
      font-size: 18px;
      color: #606060;
    }
    .chat-settings-item.danger {
      color: #ef4444;
    }
    .chat-settings-item.danger i {
      color: #ef4444;
    }
    .chat-settings-divider {
      height: 1px;
      background: #e5e7eb;
      margin: 4px 0;
    }

    /* ãƒˆãƒ¼ã‚¹ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
      15% { opacity: 1; transform: translateX(-50%) translateY(0); }
      85% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
    }

    /* æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ */
    .header-search-mode {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .search-input-container {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
    }
    .search-input {
      width: 100%;
      height: 36px;
      border: none;
      border-radius: 8px;
      padding: 0 36px 0 12px;
      font-size: 16px; /* iOS auto-zoomé˜²æ­¢ï¼ˆ16pxä»¥ä¸Šå¿…é ˆï¼‰ */
      background: #f3f4f6; /* è–„ã„ã‚°ãƒ¬ãƒ¼ */
      color: #1f2937;
    }
    .search-input:focus {
      outline: none;
    }
    .search-input::placeholder {
      color: #9ca3af;
    }
    .search-clear-btn {
      position: absolute;
      right: 8px;
      width: 24px;
      height: 24px;
      border: none;
      background: #e5e7eb;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #6b7280;
      font-size: 14px;
    }
    .search-nav-buttons {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .search-count {
      font-size: 12px;
      color: #6b7280;
      min-width: 40px;
      text-align: center;
    }
    .search-nav-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: white;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #374151;
      font-size: 14px;
    }
    .search-nav-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .search-close-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #6b7280;
      font-size: 20px;
      margin-left: 4px;
      flex-shrink: 0;
    }
    .search-close-btn:hover {
      color: #374151;
    }

    /* æ¤œç´¢ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
    .search-highlight {
      background: #fef08a;
      padding: 1px 2px;
      border-radius: 2px;
    }
    .search-highlight-current {
      background: #fef08a;
      padding: 1px 2px;
      border-radius: 2px;
      border: 2px solid #fb923c;
      box-shadow: 0 0 4px rgba(251, 146, 60, 0.5);
    }
    /* è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆé’èƒŒæ™¯ï¼‰ç”¨ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ - ç™½èƒŒæ™¯+é’æ–‡å­—ã§åè»¢ */
    .message-item-mine .search-highlight {
      background: rgba(255, 255, 255, 0.95);
      color: #1a73e8;
      padding: 1px 4px;
    }
    .message-item-mine .search-highlight-current {
      background: rgba(255, 255, 255, 0.95);
      color: #1a73e8;
      padding: 1px 4px;
      border: 2px solid #fb923c;
      box-shadow: 0 0 4px rgba(251, 146, 60, 0.5);
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      padding-bottom: 80px;
      background-color: #f8f9fa;
      /* ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã‚’ç„¡åŠ¹åŒ–ï¼ˆé•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¹²æ¸‰é˜²æ­¢ï¼‰ */
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    /* ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¡¨ç¤ºæ™‚ï¼šä¸‹éƒ¨ä½™ç™½ã‚’ç¸®å° */
    .messages-container.keyboard-visible {
      padding-bottom: 16px;
    }

    /* ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¡¨ç¤ºæ™‚ï¼šå…¥åŠ›ã‚¨ãƒªã‚¢ã®ä¸‹éƒ¨ä½™ç™½ã‚‚ç¸®å° */
    .input-container.keyboard-visible {
      padding-bottom: 8px;
    }

    /* æ—¥ä»˜ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³è¡¨ç¤ºç”¨ï¼‰ */
    .date-separator {
      text-align: center;
      padding: 8px 0;
    }
    .date-separator-badge {
      display: inline-block;
      background-color: rgba(0, 0, 0, 0.15);
      color: #555;
      font-size: 0.7rem;
      padding: 4px 12px;
      border-radius: 12px;
    }
    /* å›ºå®šæ—¥ä»˜ãƒãƒƒã‚¸ï¼ˆLINEé¢¨ï¼šãƒ˜ãƒƒãƒ€ãƒ¼ç›´ä¸‹ã«å›ºå®šï¼‰ */
    .sticky-date-badge {
      position: fixed;
      top: calc(env(safe-area-inset-top, 0px) + 68px); /* ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢ + ãƒ˜ãƒƒãƒ€ãƒ¼(56px) + ä½™ç™½(12px) */
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.15);
      color: #555;
      font-size: 0.7rem;
      padding: 4px 12px;
      border-radius: 12px;
      z-index: 101; /* ãƒ˜ãƒƒãƒ€ãƒ¼(100)ã‚ˆã‚Šä¸Šã«è¡¨ç¤º */
      pointer-events: none;
      transition: opacity 0.2s;
    }
    .sticky-date-badge.hidden {
      opacity: 0;
    }

    .message-item {
      margin-bottom: 16px;
      animation: fadeIn 0.3s ease-in;
      display: flex;
      /* iOSã®ãƒ†ã‚­ã‚¹ãƒˆé¸æŠãƒ»ã‚³ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆã‚’ç„¡åŠ¹åŒ– */
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
      15% { opacity: 1; transform: translateX(-50%) translateY(0); }
      85% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒ³ãƒˆï¼ˆã‚¢ã‚¤ã‚³ãƒ³ + ãƒãƒ–ãƒ« + æ™‚é–“ï¼‰ */
    .message-content {
      display: flex;
      align-items: flex-start;
      max-width: 80%;
      gap: 8px;
    }

    /* è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå³å¯„ã›ãƒ»é’ï¼‰ */
    .message-item-mine {
      justify-content: flex-end;
    }
    .message-item-mine .message-content {
      flex-direction: row;
    }
    .message-item-mine .message-bubble {
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      color: white;
      padding: 10px 14px;
      border-radius: 18px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    /* ä»–äººã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå·¦å¯„ã›ãƒ»ã‚°ãƒ¬ãƒ¼ï¼‰ */
    .message-item-other {
      justify-content: flex-start;
    }
    .message-item-other .message-content {
      flex-direction: row;
    }
    .message-item-other .message-bubble {
      background-color: white;
      color: #2d3748;
      padding: 10px 14px;
      border-radius: 18px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    /* ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆLINEé¢¨ã‚»ãƒ³ã‚¿ãƒ¼é…ç½®ï¼‰ */
    .message-item-system {
      justify-content: center;
      padding: 4px 16px;
    }
    .message-item-system .system-message-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }
    .message-item-system .system-time {
      font-size: 11px;
      color: #6b7280;
    }
    .message-item-system .system-bubble {
      background: rgba(0, 0, 0, 0.06);
      color: #4b5563;
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 14px;
      text-align: center;
      max-width: 100%;
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ–ãƒ«ï¼ˆæ¨ªå¹…ã¯è¦ªè¦ç´ ã«ä¾å­˜ã€LINEé¢¨ã®è‡ªç„¶ãªæ”¹è¡Œï¼‰ */
    .message-bubble {
      /* max-widthæŒ‡å®šãªã— - è¦ªè¦ç´ ã®å¹…ã§è‡ªç„¶ã«æ”¹è¡Œ */
    }

    /* å–ã‚Šæ¶ˆã—æ¸ˆã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .message-bubble.deleted {
      background: transparent !important;
      box-shadow: none !important;
      padding: 8px 0 !important;
    }
    .message-bubble.deleted .message-text {
      color: #9ca3af;
      font-style: italic;
      font-size: 13px;
    }
    .message-item-mine .message-bubble.deleted .message-text {
      color: #9ca3af;
    }

    .message-header {
      display: none; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã¯éè¡¨ç¤º */
    }

    /* ç”»åƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .message-image {
      max-width: 180px;
      max-height: 250px;
      width: 100%;
      height: auto;
      border-radius: 12px;
      display: block;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .message-image:hover {
      opacity: 0.9;
    }
    .message-image:active {
      opacity: 0.8;
    }

    /* ç”»åƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒãƒ–ãƒ«ã¯ä½™ç™½ã‚’èª¿æ•´ */
    .message-bubble:has(.message-image) {
      padding: 0;
      background: transparent;
      box-shadow: none;
    }

    /* ç”»åƒ + ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã®å ´åˆ */
    .message-bubble .message-image + .message-text {
      margin-top: 8px;
      padding: 0 10px 6px 10px;
    }

    /* ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ - ãƒãƒ–ãƒ«ã«æº¶ã‘è¾¼ã‚€ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .message-file-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 6px 2px;
      background: transparent;
      text-decoration: none;
      color: inherit;
      transition: opacity 0.2s;
    }
    .message-file-link:hover {
      opacity: 0.8;
    }
    .message-file-icon {
      font-size: 20px;
      flex-shrink: 0;
      color: #374151;
    }
    .message-file-info {
      flex: 1;
      min-width: 0;
    }
    .message-file-name {
      font-weight: 500;
      font-size: 14px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .message-file-size {
      font-size: 12px;
      color: #718096;
      margin-top: 2px;
    }
    /* è‡ªåˆ†ãŒé€ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .message-item-mine .message-file-icon {
      color: white;
    }
    .message-item-mine .message-file-name {
      color: white;
    }
    .message-item-mine .message-file-size {
      color: rgba(255, 255, 255, 0.8);
    }

    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆLINEé¢¨ï¼‰ */
    .user-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #e2e8f0;
      flex-shrink: 0;
      cursor: pointer;
    }
    .user-icon-placeholder {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 16px;
      border: 2px solid #e2e8f0;
      flex-shrink: 0;
      cursor: pointer;
    }

    /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
    .profile-popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    .profile-popup-overlay.active {
      display: flex;
    }
    .profile-popup {
      background: white;
      border-radius: 20px;
      width: 280px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: popupSlideIn 0.3s ease-out;
    }
    @keyframes popupSlideIn {
      from { opacity: 0; transform: translateY(20px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .profile-popup-header {
      background: linear-gradient(135deg, var(--reborn-primary), var(--reborn-primary-dark));
      padding: 30px 20px 20px;
      text-align: center;
      position: relative;
      background-size: cover;
      background-position: center;
    }
    .profile-popup-close {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .profile-popup-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    .profile-popup-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid white;
      object-fit: cover;
      margin-bottom: 12px;
    }
    .profile-popup-avatar-initial {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid white;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 32px;
      font-weight: 600;
      margin: 0 auto 12px;
    }
    .profile-popup-name {
      color: white;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .profile-popup-status {
      color: rgba(255, 255, 255, 0.8);
      font-size: 13px;
    }
    .profile-popup-actions {
      display: flex;
      justify-content: center;
      gap: 32px;
      padding: 24px 20px;
      background: white;
    }
    .profile-popup-action {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 12px;
      transition: background 0.2s;
    }
    .profile-popup-action:hover {
      background: #f3f4f6;
    }
    .profile-popup-action-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }
    .profile-popup-action-icon.chat {
      background: var(--reborn-primary);
      color: white;
    }
    .profile-popup-action-icon.call {
      background: #22c55e;
      color: white;
    }
    .profile-popup-action-label {
      font-size: 12px;
      color: #4b5563;
      font-weight: 500;
    }

    /* ãƒãƒ–ãƒ«ã‚³ãƒ³ãƒ†ãƒŠï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å + ãƒãƒ–ãƒ« ã‚’ç¸¦ã«é…ç½®ï¼‰ */
    .bubble-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .message-item-mine .bubble-container {
      align-items: flex-end;
    }

    /* ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆæ™‚ã®é€ä¿¡è€…åï¼ˆç›¸æ‰‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ï¼‰ */
    .message-sender {
      display: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯éè¡¨ç¤º */
    }
    .message-sender.show-in-group {
      display: block;
      font-size: 0.7rem;
      color: #666;
      margin-bottom: 2px;
      margin-left: 2px;
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆãƒãƒ–ãƒ« + æ™‚é–“ï¼‰ */
    .message-wrapper {
      display: flex;
      flex-direction: row;
      align-items: flex-end;
      gap: 6px;
    }
    /* è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ãƒãƒ–ãƒ«ãŒå³ã€ãƒ¡ã‚¿æƒ…å ±ï¼ˆæ—¢èª­+æ™‚é–“ï¼‰ãŒãƒãƒ–ãƒ«ã®å·¦ */
    .message-item-mine .message-wrapper {
      flex-direction: row;
      justify-content: flex-end;
    }

    /* æ—¢èª­+æ™‚é–“ã‚’ç¸¦ã«ä¸¦ã¹ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ */
    .message-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 1px;
      flex-shrink: 0;
    }

    .message-time {
      font-size: 0.65rem;
      color: #718096;
      opacity: 0.8;
      padding: 0;
    }
    .message-read-status {
      font-size: 0.6rem;
      color: #718096;
      opacity: 0.9;
      padding: 0;
    }
    .message-text {
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.5;
      font-size: 15px;
      /* ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã‚’å®Œå…¨ã«ç„¡åŠ¹åŒ– */
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    .delete-button {
      background: none;
      border: none;
      color: #ef4444;
      cursor: pointer;
      font-size: 0.875rem;
      padding: 4px 8px;
      margin-left: 8px;
      opacity: 0.6;
      transition: opacity 0.2s;
    }
    .delete-button:hover {
      opacity: 1;
    }

    /* ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ï¼ˆLINEé¢¨ï¼‰ */
    .image-preview-container {
      background-color: white;
      border-top: 1px solid #e2e8f0;
      padding: 8px 12px;
      max-height: 160px;
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;
    }
    .image-preview-list {
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }
    .image-preview-item {
      position: relative;
      display: inline-block;
      flex-shrink: 0;
    }
    .image-preview-item img {
      max-width: 100px;
      max-height: 100px;
      border-radius: 8px;
      object-fit: cover;
    }
    .image-preview-item .remove-btn {
      position: absolute;
      top: -6px;
      right: -6px;
      background: rgba(0, 0, 0, 0.7);
      border: none;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
    }
    .image-preview-item .remove-btn svg {
      width: 14px;
      height: 14px;
      stroke: white;
    }
    .image-preview-count {
      display: inline-flex;
      align-items: center;
      background: #06c755;
      color: white;
      padding: 4px 10px;
      border-radius: 16px;
      font-size: 13px;
      font-weight: 500;
      margin-left: 8px;
    }
    .image-preview-content {
      position: relative;
      display: inline-block;
      max-width: 100%;
    }
    .image-preview-close {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.6);
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
      z-index: 10;
    }
    .image-preview-close:hover {
      background: rgba(0, 0, 0, 0.8);
    }
    .image-preview-close svg {
      color: white;
      width: 18px;
      height: 18px;
    }
    #imagePreview {
      max-width: 100%;
      max-height: 120px;
      border-radius: 8px;
      display: block;
    }

    /* ãƒ–ãƒ­ãƒƒã‚¯ä¸­ãƒãƒŠãƒ¼ */
    .blocked-banner {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      background: #fef2f2;
      border-top: 1px solid #fecaca;
      color: #dc2626;
      font-size: 14px;
      font-weight: 500;
    }
    .blocked-banner i {
      font-size: 18px;
    }

    /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
    .input-container {
      padding: 12px 16px;
      padding-left: 8px; /* å·¦å´ã®ä½™ç™½ã‚’æ¸›ã‚‰ã™ */
      padding-bottom: 24px; /* ä¸‹ã®ä½™ç™½ã‚’èª¿æ•´ */
      background-color: white;
      border-top: 1px solid #e2e8f0;
      flex-shrink: 0;
      position: relative; /* ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å€™è£œãƒªã‚¹ãƒˆç”¨ */
    }
    .input-wrapper {
      display: flex;
      gap: 4px;
      align-items: center; /* ãƒœã‚¿ãƒ³ã¨å…¥åŠ›æ¬„ã‚’å‚ç›´ä¸­å¤®æƒãˆ */
    }
    .action-button {
      background: transparent;
      border: none;
      color: #606060;
      cursor: pointer;
      padding: 0;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      align-self: center;
      -webkit-tap-highlight-color: transparent;
      outline: none;
    }
    .action-button i {
      font-size: 22px;
    }
    .action-button.expand-button i {
      font-size: 24px;
    }
    .attachment-menu {
      position: absolute;
      bottom: 80px;
      left: 16px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      padding: 8px;
      z-index: 100;
    }
    .attachment-menu-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: transparent;
      border: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
      border-radius: 8px;
      transition: background-color 0.2s;
      color: #2d3748;
      font-size: 0.95rem;
    }
    .attachment-menu-item:hover {
      background-color: #f7fafc;
    }
    .attachment-menu-item i {
      font-size: 20px;
      color: #606060;
    }

    /* éŒ²éŸ³ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .voice-recording-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .voice-recording-content {
      text-align: center;
      color: white;
    }
    .voice-recording-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .voice-recording-dot {
      width: 16px;
      height: 16px;
      background: #ef4444;
      border-radius: 50%;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.1); }
    }
    .voice-recording-time {
      font-size: 48px;
      font-weight: 300;
      font-variant-numeric: tabular-nums;
    }
    .voice-recording-text {
      font-size: 16px;
      opacity: 0.8;
      margin-bottom: 32px;
    }
    .voice-recording-buttons {
      display: flex;
      justify-content: center;
      gap: 32px;
    }
    .voice-cancel-btn, .voice-send-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      background: transparent;
      border: none;
      color: white;
      cursor: pointer;
      padding: 12px;
      -webkit-tap-highlight-color: transparent;
    }
    .voice-cancel-btn i, .voice-send-btn i {
      font-size: 32px;
    }
    .voice-cancel-btn span, .voice-send-btn span {
      font-size: 14px;
      opacity: 0.8;
    }
    .voice-cancel-btn:active, .voice-send-btn:active {
      opacity: 0.7;
    }
    .voice-send-btn {
      color: var(--reborn-primary);
    }

    /* éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º - ãƒãƒ–ãƒ«ã«æº¶ã‘è¾¼ã‚€ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .voice-message {
      display: flex;
      align-items: center;
      gap: 10px;
      background: transparent;
      padding: 6px 2px;
      min-width: 160px;
    }
    .voice-play-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: white;
      color: var(--reborn-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      -webkit-tap-highlight-color: transparent;
    }
    .voice-play-btn i {
      font-size: 16px;
      margin-left: 2px;
    }
    .voice-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
    }
    .voice-waveform {
      height: 24px;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    .voice-waveform-bar {
      width: 3px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 2px;
    }
    .voice-duration {
      font-size: 12px;
      color: #666;
    }
    /* è‡ªåˆ†ãŒé€ã£ãŸéŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .message-item-mine .voice-play-btn {
      background: rgba(255, 255, 255, 0.9);
    }
    .message-item-mine .voice-waveform-bar {
      background: rgba(255, 255, 255, 0.6);
    }
    .message-item-mine .voice-duration {
      color: rgba(255, 255, 255, 0.85);
    }

    /* ãƒãƒ¼ãƒˆå…±æœ‰ã‚«ãƒ¼ãƒ‰ - ãƒãƒ–ãƒ«ã«æº¶ã‘è¾¼ã‚€ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .note-share-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 4px;
      background: transparent;
      cursor: pointer;
      transition: opacity 0.2s;
      min-width: 180px;
    }
    .note-share-card:hover {
      opacity: 0.8;
    }
    .note-share-card:active {
      opacity: 0.6;
    }
    .note-share-icon {
      font-size: 22px;
      flex-shrink: 0;
      color: #374151;
    }

    /* é€šè©±å±¥æ­´ã‚«ãƒ¼ãƒ‰ - ãƒãƒ–ãƒ«ã«æº¶ã‘è¾¼ã‚€ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .call-history-card {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 2px;
      background: transparent;
      min-width: 140px;
    }
    .call-history-icon {
      font-size: 18px;
      color: #374151;
      flex-shrink: 0;
    }
    .call-history-info {
      flex: 1;
      min-width: 0;
    }
    .call-history-label {
      font-size: 13px;
      color: #374151;
      font-weight: 500;
    }
    .call-history-duration {
      font-size: 12px;
      color: #6b7280;
    }
    /* è‡ªåˆ†ãŒé€ã£ãŸé€šè©±å±¥æ­´ã‚«ãƒ¼ãƒ‰ */
    .message-item-mine .call-history-icon {
      color: white;
    }
    .message-item-mine .call-history-label {
      color: white;
    }
    .message-item-mine .call-history-duration {
      color: rgba(255,255,255,0.85);
    }
    .note-share-info {
      flex: 1;
      min-width: 0;
    }
    .note-share-label {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 2px;
    }
    .note-share-title {
      font-size: 14px;
      font-weight: 600;
      color: #1e293b;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .note-share-arrow {
      color: #94a3b8;
      font-size: 16px;
      flex-shrink: 0;
    }
    /* è‡ªåˆ†ãŒé€ã£ãŸãƒãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .message-item-mine .note-share-label {
      color: rgba(255,255,255,0.8);
    }
    .message-item-mine .note-share-title {
      color: white;
    }
    .message-item-mine .note-share-arrow {
      color: rgba(255,255,255,0.7);
    }
    .message-item-mine .note-share-icon {
      color: white;
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ã‚¨ãƒªã‚¢ - ã‚·ãƒ³ãƒ—ãƒ«textareaï¼ˆiOSå¯¾å¿œï¼‰ */
    .message-input-wrapper {
      flex: 1;
      position: relative;
      margin-right: 4px;
    }

    /* ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚¿ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆå…¥åŠ›æ¬„ã®ä¸Šéƒ¨ï¼‰ */
    .mention-tags {
      display: none;
      flex-wrap: wrap;
      gap: 6px;
      padding: 8px 12px;
      background-color: #f5f5f5;
      border: 1px solid #cbd5e0;
      border-bottom: none;
      border-radius: 20px 20px 0 0;
    }

    .mention-tags.has-tags {
      display: flex;
    }

    .mention-tags + .message-input {
      border-radius: 0 0 20px 20px;
    }

    .mention-tags:not(.has-tags) + .message-input {
      border-radius: 20px;
    }

    /* ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚¿ã‚°ï¼ˆãƒãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ */
    .mention-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: linear-gradient(135deg, var(--reborn-primary), #0056cc);
      color: white;
      font-size: 0.85rem;
      font-weight: 500;
      border-radius: 16px;
      white-space: nowrap;
    }

    .mention-tag-remove {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      background: rgba(255, 255, 255, 0.3);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 12px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .mention-tag-remove:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    /* ãƒªãƒ—ãƒ©ã‚¤ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå…¥åŠ›æ¬„ã®ä¸Šéƒ¨ã€LINEé¢¨ï¼‰ */
    .reply-preview {
      display: none;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background-color: #f0f4f8;
      border: 1px solid #cbd5e0;
      border-bottom: none;
      border-radius: 16px 16px 0 0;
    }

    .reply-preview.active {
      display: flex;
    }

    .reply-preview.active + .mention-tags + .message-input,
    .reply-preview.active + .mention-tags:not(.has-tags) + .message-input {
      border-radius: 0 0 20px 20px;
    }

    .reply-preview-icon {
      width: 32px;
      height: 32px;
      min-width: 32px;
      border-radius: 50%;
      object-fit: cover;
      background-color: #e2e8f0;
    }

    .reply-preview-icon-placeholder {
      width: 32px;
      height: 32px;
      min-width: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--reborn-primary), #0056cc);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .reply-preview-content {
      flex: 1;
      min-width: 0;
    }

    .reply-preview-user {
      font-size: 0.75rem;
      font-weight: 600;
      color: #718096;
      margin-bottom: 2px;
    }

    .reply-preview-text {
      font-size: 0.85rem;
      color: #4a5568;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .reply-preview-close {
      width: 24px;
      height: 24px;
      min-width: 24px;
      border: none;
      background: #cbd5e0;
      border-radius: 50%;
      color: #4a5568;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .reply-preview-close:hover {
      background: #a0aec0;
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ–ãƒ«å†…ã®ãƒªãƒ—ãƒ©ã‚¤è¡¨ç¤ºï¼ˆLINEé¢¨ï¼‰ */
    .message-reply-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 0 8px 0;
      margin: 0 -12px 8px -12px;
      padding-left: 12px;
      padding-right: 12px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .message-item-mine .message-reply-header {
      border-bottom-color: rgba(255, 255, 255, 0.2);
    }

    .reply-header-icon {
      width: 20px;
      height: 20px;
      min-width: 20px;
      border-radius: 50%;
      object-fit: cover;
    }

    .reply-header-icon-placeholder {
      width: 20px;
      height: 20px;
      min-width: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, #718096, #4a5568);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      font-weight: 600;
    }

    .reply-header-content {
      flex: 1;
      min-width: 0;
    }

    .reply-header-user {
      font-size: 0.7rem;
      font-weight: 600;
      color: #1a202c;
    }

    .message-item-mine .reply-header-user {
      color: rgba(255, 255, 255, 1);
    }

    .reply-header-text {
      font-size: 0.75rem;
      color: #a0aec0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }

    .message-item-mine .reply-header-text {
      color: rgba(255, 255, 255, 0.7);
    }

    /* ãƒªãƒ—ãƒ©ã‚¤ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã‚¹ã‚¿ã‚¤ãƒ« */
    .message-reply-header {
      cursor: pointer;
    }

    .message-reply-header:active {
      opacity: 0.7;
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æºã‚Œã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒªãƒ—ãƒ©ã‚¤ã‚¸ãƒ£ãƒ³ãƒ—æ™‚ï¼‰ */
    @keyframes message-shake {
      0%, 100% { margin-left: 0; margin-right: 0; }
      10%, 30%, 50%, 70%, 90% { margin-left: -4px; margin-right: 4px; }
      20%, 40%, 60%, 80% { margin-left: 4px; margin-right: -4px; }
    }

    .message-item.highlight-shake {
      animation: message-shake 0.5s ease-in-out;
    }

    /* textareaï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªå…¥åŠ›æ¬„ï¼‰ */
    .message-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #cbd5e0;
      border-radius: 20px;
      font-size: 1rem;
      min-height: 44px;
      max-height: 120px;
      background-color: #f5f5f5;
      color: #1a202c;
      caret-color: var(--reborn-primary);
      resize: none;
      overflow-y: auto;
      /* iOSå¯¾ç­– */
      -webkit-appearance: none;
      appearance: none;
      font-family: inherit;
      line-height: 1.4;
    }

    .message-input:focus {
      outline: none;
      border-color: var(--reborn-primary);
    }

    .message-input::placeholder {
      color: #9ca3af;
    }

    /* ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å€™è£œãƒªã‚¹ãƒˆ */
    .mention-suggestions {
      display: none;
      position: absolute;
      bottom: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      margin-bottom: 8px;
    }
    .mention-suggestions.show {
      display: block;
    }
    .mention-suggestion-item {
      display: flex;
      align-items: center;
      padding: 10px 14px;
      cursor: pointer;
      transition: background-color 0.15s;
    }
    .mention-suggestion-item:hover,
    .mention-suggestion-item.selected {
      background-color: #f3f4f6;
    }
    .mention-suggestion-item:first-child {
      border-radius: 12px 12px 0 0;
    }
    .mention-suggestion-item:last-child {
      border-radius: 0 0 12px 12px;
    }
    .mention-suggestion-item:only-child {
      border-radius: 12px;
    }
    .mention-suggestion-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      margin-right: 10px;
      object-fit: cover;
    }
    .mention-suggestion-icon-placeholder {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
      margin-right: 10px;
    }
    .mention-all-icon {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
      font-size: 18px;
    }
    .mention-suggestion-name {
      font-size: 15px;
      color: #1f2937;
    }

    /* ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºæ™‚ï¼‰ */
    .mention-highlight {
      color: var(--reborn-primary);
      font-weight: 500;
    }
    .message-item-mine .mention-highlight {
      color: #1565c0; /* æ¿ƒã„é’ï¼ˆLINEé¢¨ï¼‰ */
      font-weight: 600;
    }

    .send-button {
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      color: white;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      font-size: 1.25rem;
      cursor: pointer;
      transition: transform 0.2s;
      flex-shrink: 0;
      align-self: center; /* å…¥åŠ›æ¬„ã¨å‚ç›´ä¸­å¤®æƒãˆ */
    }
    .send-button:hover {
      transform: scale(1.05);
    }
    .send-button:active {
      transform: scale(0.95);
    }
    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼åé¸æŠï¼ˆGASç‰ˆã®ã¿ï¼‰ */
    #userSelectContainer {
      margin-bottom: 8px;
    }

    /* é¸æŠå‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ï¼ˆLINEé¢¨ï¼‰ */
    .selection-mode-bar {
      display: none;
      background-color: #ffffff;
      padding: 12px 16px;
      border-bottom: 1px solid #e5e7eb;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .selection-mode-bar.active {
      display: flex;
    }
    .selection-mode-info {
      font-size: 0.9rem;
      color: #2d3748;
      font-weight: 500;
    }
    .selection-mode-buttons {
      display: flex;
      gap: 12px;
    }
    .selection-mode-buttons button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
      font-weight: 500;
    }
    .selection-mode-buttons button:active {
      transform: scale(0.95);
    }
    .btn-delete-selected {
      background-color: #ef4444;
      color: white;
    }
    .btn-delete-selected:hover {
      background-color: #dc2626;
    }
    .btn-cancel-selection {
      background-color: #f3f4f6;
      color: #4b5563;
    }
    .btn-cancel-selection:hover {
      background-color: #e5e7eb;
    }
    .message-checkbox {
      display: none;
      margin-right: 12px;
      width: 22px;
      height: 22px;
      cursor: pointer;
      flex-shrink: 0;
      align-self: center;
      accent-color: var(--reborn-primary);
      order: -1; /* å¸¸ã«å·¦ç«¯ã«é…ç½® */
    }
    .selection-mode .message-checkbox {
      display: block;
    }

    /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å·¦ç«¯ã«é…ç½®ã™ã‚‹ãŸã‚ã«contentã®orderã‚’èª¿æ•´ */
    .message-item .message-content {
      order: 0;
    }
    .toggle-selection-btn {
      background-color: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.4);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      margin-left: 12px;
    }
    .toggle-selection-btn:hover {
      background-color: rgba(255,255,255,0.3);
    }

    /* é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆLINEé¢¨ã‚°ãƒªãƒƒãƒ‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼‰ */
    #contextMenu {
      position: absolute;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.2);
      z-index: 3000;
      display: none;
      opacity: 0;
      transform: scale(0.9);
      transition: opacity 0.15s ease, transform 0.15s ease;
      padding: 0;
      min-width: 200px;
      overflow: hidden;
    }
    #contextMenu.active {
      display: block;
      opacity: 1;
      transform: scale(1);
    }
    .context-menu-items {
      display: flex;
      flex-wrap: nowrap;
    }
    .context-menu-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px 4px;
      background: transparent;
      cursor: pointer;
      transition: background 0.15s;
      border: none;
      border-right: 1px solid #e5e7eb;
      border-radius: 0;
      font-family: inherit;
      font-size: 10px;
      color: #6b7280;
      white-space: nowrap;
      min-width: 52px;
      flex: 1;
      aspect-ratio: 1 / 1;
    }
    .context-menu-item:last-child {
      border-right: none;
    }
    .context-menu-item i {
      font-size: 20px;
      color: #374151;
      margin-bottom: 1px;
    }
    .context-menu-item:active {
      background: #f3f4f6;
    }
    .context-menu-item.danger {
      color: #ef4444;
    }
    .context-menu-item.danger i {
      color: #ef4444;
    }
    #contextMenuOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.1);
      z-index: 2999;
      display: none;
    }
    #contextMenuOverlay.active {
      display: block;
    }

    /* è»¢é€å…ˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« */
    .forward-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 4000;
      display: none;
    }
    .forward-modal-overlay.active {
      display: block;
    }
    .forward-modal {
      position: fixed;
      bottom: -100%;
      left: 0;
      right: 0;
      max-height: 70vh;
      background: white;
      border-radius: 16px 16px 0 0;
      z-index: 4001;
      transition: bottom 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    .forward-modal.active {
      bottom: 0;
    }
    .forward-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      font-weight: 600;
      font-size: 16px;
    }
    .forward-modal-close {
      background: none;
      border: none;
      padding: 8px;
      cursor: pointer;
      color: #6b7280;
    }
    .forward-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }
    .forward-room-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .forward-room-item:hover {
      background: #f3f4f6;
    }
    .forward-room-item:active {
      background: #e5e7eb;
    }
    .forward-room-icon {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      color: white;
      font-size: 18px;
    }
    .forward-room-info {
      flex: 1;
    }
    .forward-room-name {
      font-weight: 500;
      font-size: 15px;
      color: #1f2937;
    }
    .forward-room-members {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 2px;
    }
    .forward-loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 32px;
      color: #9ca3af;
    }
    .forward-loading .spin {
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* ãƒãƒ¼ãƒˆä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .note-list-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 4000;
      display: none;
    }
    .note-list-modal-overlay.active {
      display: block;
    }
    .note-list-modal {
      position: fixed;
      bottom: -100%;
      left: 0;
      right: 0;
      max-height: 70vh;
      background: white;
      border-radius: 16px 16px 0 0;
      z-index: 4001;
      transition: bottom 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    .note-list-modal.active {
      bottom: 0;
    }
    .note-list-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      font-weight: 600;
      font-size: 16px;
    }
    .note-list-modal-close {
      background: none;
      border: none;
      padding: 8px;
      cursor: pointer;
      color: #6b7280;
    }
    .note-list-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }
    .note-list-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.15s;
      gap: 12px;
    }
    .note-list-item:hover {
      background: #f3f4f6;
    }
    .note-list-item:active {
      background: #e5e7eb;
    }
    .note-list-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #64748b;
      font-size: 20px;
      flex-shrink: 0;
    }
    .note-list-info {
      flex: 1;
      min-width: 0;
    }
    .note-list-title {
      font-weight: 500;
      font-size: 15px;
      color: #1f2937;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .note-list-meta {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 2px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .note-list-sender {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .note-list-sender-avatar {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .note-list-sender-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .note-list-sender-avatar i {
      font-size: 10px;
      color: #9ca3af;
    }
    .note-list-arrow {
      color: #9ca3af;
      font-size: 18px;
    }
    .note-list-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 48px 24px;
      color: #9ca3af;
      text-align: center;
    }
    .note-list-empty i {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    .note-list-empty p {
      font-size: 14px;
      margin: 0;
    }
    .note-list-loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 32px;
      color: #9ca3af;
    }
    .note-list-loading .spin {
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    /* Keepé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« */
    .keep-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 4000;
      display: none;
    }
    .keep-modal-overlay.active {
      display: block;
    }
    .keep-modal {
      position: fixed;
      bottom: -100%;
      left: 0;
      right: 0;
      max-height: 70vh;
      background: white;
      border-radius: 16px 16px 0 0;
      z-index: 4001;
      transition: bottom 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    .keep-modal.active {
      bottom: 0;
    }
    .keep-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      font-weight: 600;
      font-size: 16px;
    }
    .keep-modal-close {
      background: none;
      border: none;
      padding: 8px;
      cursor: pointer;
      color: #6b7280;
    }
    .keep-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
      max-height: calc(70vh - 60px);
    }
    .keep-item {
      display: flex;
      align-items: flex-start;
      padding: 12px 16px;
      cursor: pointer;
      transition: background-color 0.2s;
      border-bottom: 1px solid #f3f4f6;
    }
    .keep-item:hover {
      background: #f9fafb;
    }
    .keep-item:active {
      background: #f3f4f6;
    }
    .keep-item-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      color: white;
      font-size: 16px;
      flex-shrink: 0;
    }
    .keep-item-content {
      flex: 1;
      min-width: 0;
    }
    .keep-item-text {
      font-size: 14px;
      color: #1f2937;
      line-height: 1.4;
      word-break: break-word;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .keep-item-date {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }
    .keep-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 48px 24px;
      color: #9ca3af;
    }
    .keep-empty i {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    .keep-empty-text {
      font-size: 14px;
      text-align: center;
    }
    .keep-loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 32px;
      color: #9ca3af;
    }

    /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³åç´ç”¨ã®ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ */
    .collapsible-button {
      transition: width 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
      overflow: hidden;
    }
    .collapsible-button.collapsed {
      width: 0;
      opacity: 0;
      margin: 0;
      padding: 0;
      border: none;
    }
    .expand-button {
      transition: opacity 0.3s ease;
    }
    .expand-button svg {
      width: 32px;
      height: 32px;
    }

    /* ç”»åƒãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ï¼ˆLINEé¢¨ï¼‰ */
    .image-viewer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.95);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .image-viewer.active {
      opacity: 1;
    }
    .image-viewer-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
      z-index: 10000;
    }
    .image-viewer-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    .image-viewer-close svg {
      color: white;
    }
    #imageViewerImg {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
      border-radius: 0;
    }

    /* ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ï¼ˆLINEé¢¨ï¼‰ */
    .image-viewer-download {
      position: absolute;
      bottom: 24px;
      right: 24px;
      background: rgba(0, 0, 0, 0.6);
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
      z-index: 10000;
    }
    .image-viewer-download:active {
      background: rgba(0, 0, 0, 0.8);
    }
    .image-viewer-download svg {
      color: white;
    }

    /* ãƒ¡ãƒ³ãƒãƒ¼ã‚¢ã‚¤ã‚³ãƒ³è¡Œï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆç”¨ï¼‰- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: #ffffff;
      border-bottom: 1px solid #f0f0f0;
      padding-top: env(safe-area-inset-top, 0px); /* iOSãƒãƒƒãƒå¯¾å¿œ */
    }
    .header .back-button {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #606060;
      font-size: 20px;
      -webkit-tap-highlight-color: transparent;
      outline: none;
    }
    .member-icons-bar {
      display: none;
      background: white;
      padding: 2px 16px;
      align-items: center;
      gap: 8px;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      z-index: 999;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .member-icons-bar.show {
      display: flex;
    }
    .member-icons-bar .member-icons {
      display: flex;
      flex: 1;
      gap: 6px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .member-icons-bar .member-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      flex-shrink: 0;
      object-fit: cover;
      border: 2px solid white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .member-icons-bar .member-icon-placeholder {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
      flex-shrink: 0;
      border: 2px solid white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .member-icons-bar .member-more {
      color: #6b7280;
      font-size: 26px;
      padding: 0 4px;
      cursor: pointer;
    }

    /* ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .member-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 5000;
      display: none;
    }
    .member-modal-overlay.active {
      display: block;
    }
    .member-modal {
      position: fixed;
      top: 0;
      right: -100%;
      width: 100%;
      height: 100%;
      background: white;
      z-index: 5001;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    .member-modal.active {
      right: 0;
    }
    .member-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 16px;
      border-bottom: 1px solid #e5e7eb;
      background: white;
    }
    .member-modal-header .back-btn {
      position: static;
      transform: none;
      background: none;
      border: none;
      font-size: 20px;
      color: #374151;
      cursor: pointer;
      padding: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .member-modal-header .title {
      font-weight: 600;
      font-size: 17px;
      color: #1f2937;
    }
    .member-modal-header .edit-btn {
      background: none;
      border: none;
      font-size: 15px;
      color: var(--reborn-primary);
      cursor: pointer;
      padding: 4px 8px;
    }
    .member-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 0;
    }
    .member-count {
      padding: 12px 16px;
      font-size: 13px;
      color: #6b7280;
      background: white;
      border-bottom: 1px solid #e5e7eb;
    }
    .member-invite-btn {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      border: none;
      background: white;
      width: 100%;
      cursor: pointer;
      border-bottom: 1px solid #e5e7eb;
    }
    .member-invite-btn:active {
      background: #f3f4f6;
    }
    .member-invite-btn .icon {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      font-size: 22px;
      color: #374151;
    }
    .member-invite-btn .text {
      font-size: 15px;
      color: #1f2937;
    }
    .member-list-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid #f3f4f6;
    }
    .member-list-item .avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      margin-right: 12px;
      object-fit: cover;
    }
    .member-list-item .avatar-placeholder {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 18px;
      margin-right: 12px;
    }
    .member-list-item .info {
      flex: 1;
    }
    .member-list-item .name {
      font-size: 15px;
      font-weight: 500;
      color: #1f2937;
    }
    .member-list-item .email {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 2px;
    }
    .member-list-item .delete-btn {
      display: none;
      background: #ef4444;
      border: none;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      font-size: 16px;
      cursor: pointer;
    }
    .member-list-item.edit-mode .delete-btn {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* æ‹›å¾…ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .invite-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 6000;
      display: none;
    }
    .invite-modal-overlay.active {
      display: block;
    }
    .invite-modal {
      position: fixed;
      bottom: -100%;
      left: 0;
      right: 0;
      max-height: 80vh;
      background: white;
      border-radius: 16px 16px 0 0;
      z-index: 6001;
      transition: bottom 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    .invite-modal.active {
      bottom: 0;
    }
    .invite-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
    }
    .invite-modal-header .title {
      font-weight: 600;
      font-size: 16px;
    }
    .invite-modal-header .close-btn {
      background: none;
      border: none;
      font-size: 20px;
      color: #6b7280;
      cursor: pointer;
    }
    .invite-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }
    .invite-user-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      cursor: pointer;
    }
    .invite-user-item:active {
      background: #f3f4f6;
    }
    .invite-user-item.disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    .invite-user-item .avatar-placeholder {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 18px;
      margin-right: 12px;
    }
    .invite-user-item .info {
      flex: 1;
    }
    .invite-user-item .name {
      font-size: 15px;
      font-weight: 500;
      color: #1f2937;
    }
    .invite-user-item .already-member {
      font-size: 12px;
      color: #9ca3af;
    }
  </style>
</head>
<body>
  <!-- çµ±ä¸€ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <!-- é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ -->
    <div class="header-content" id="headerNormal">
      <button class="back-button" id="back-button">
        <i class="bi bi-chevron-left"></i><span class="back-unread-count" id="backUnreadCount"></span>
      </button>
      <div class="header-title" id="headerTitle" style="cursor: pointer;">
        <i class="bi bi-chat-dots" id="headerRoomIcon"></i>
        <span id="headerRoomName">ãƒãƒ£ãƒƒãƒˆ</span>
      </div>
      <div class="header-right-buttons">
        <button class="search-button" id="searchButton" onclick="openSearchMode()">
          <i class="bi bi-search"></i>
        </button>
        <button class="call-button" id="callButton" onclick="showCallPreparing()">
          <i class="bi bi-telephone"></i>
        </button>
        <button class="settings-button" id="chatSettingsButton" onclick="toggleChatSettings(event)">
          <i class="bi bi-list"></i>
        </button>
      </div>
      <!-- ãƒãƒ£ãƒƒãƒˆè¨­å®šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ -->
      <div class="chat-settings-dropdown" id="chatSettingsDropdown">
        <button class="chat-settings-item" id="blockUserBtn" onclick="toggleBlockUser()">
          <i class="bi bi-slash-circle"></i>
          <span id="blockUserText">ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹</span>
        </button>
        <button class="chat-settings-item" id="muteRoomBtn" onclick="toggleMuteRoom()">
          <i class="bi bi-bell-slash"></i>
          <span id="muteRoomText">é€šçŸ¥ã‚’ã‚ªãƒ•</span>
        </button>
        <button class="chat-settings-item" onclick="openNoteListModal()">
          <i class="bi bi-journal-text"></i>
          <span>ãƒãƒ¼ãƒˆä¸€è¦§</span>
        </button>
        <div class="chat-settings-divider"></div>
        <button class="chat-settings-item danger" id="leaveRoomBtn" onclick="confirmLeaveRoom()">
          <i class="bi bi-box-arrow-right"></i>
          <span>é€€å‡ºã™ã‚‹</span>
        </button>
      </div>
    </div>
    <!-- æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ -->
    <div class="header-content header-search-mode" id="headerSearch" style="display: none;">
      <button class="back-button" onclick="goBack()">
        <i class="bi bi-chevron-left"></i>
      </button>
      <div class="search-input-container">
        <input type="text" id="searchInput" class="search-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¤œç´¢..." oninput="searchMessages()">
        <button class="search-clear-btn" id="searchClearBtn" onclick="clearSearch()" style="display: none;">
          <i class="bi bi-x"></i>
        </button>
      </div>
      <div class="search-nav-buttons" id="searchNavButtons" style="display: none;">
        <span class="search-count" id="searchCount">0/0</span>
        <button class="search-nav-btn" onclick="navigateSearch('prev')"><i class="bi bi-chevron-up"></i></button>
        <button class="search-nav-btn" onclick="navigateSearch('next')"><i class="bi bi-chevron-down"></i></button>
      </div>
      <button class="search-close-btn" onclick="closeSearchMode()" title="æ¤œç´¢ã‚’é–‰ã˜ã‚‹">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <!-- ãƒ¡ãƒ³ãƒãƒ¼ã‚¢ã‚¤ã‚³ãƒ³è¡Œï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆã®ã¿ï¼‰- ãƒ˜ãƒƒãƒ€ãƒ¼å†…ã«é…ç½® -->
    <div class="member-icons-bar" id="memberIconsBar">
      <div class="member-icons" id="memberIcons"></div>
      <span class="member-more" id="memberMoreBtn">â€º</span>
    </div>
  </div>

  <!-- ãƒãƒ£ãƒ³ãƒãƒ«æƒ…å ±ãƒãƒ¼ -->
  <div style="background: #f8f9fa; padding: 8px 16px; border-bottom: 1px solid #e5e7eb; display: none;">
    <!-- é¸æŠå‰Šé™¤ãƒœã‚¿ãƒ³ã¯å‰Šé™¤ï¼ˆé•·æŠ¼ã—ã§é¸æŠãƒ¢ãƒ¼ãƒ‰é–‹å§‹ï¼‰ -->
  </div>

    <!-- GASç‰ˆï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼åé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ -->
    <div id="userSelectContainer" style="display: none; margin-top: 8px;">
      <label style="font-size: 12px; margin-right: 4px;">é€ä¿¡è€…:</label>
      <select id="userSelect" style="background: white; border: 1px solid #d1d5db; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      </select>
    </div>

    <!-- PWAç‰ˆï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼åå…¥åŠ› -->
    <div id="userNameInputContainer" style="display: none; margin-top: 8px;">
      <label style="font-size: 12px; margin-right: 4px;">ã‚ãªãŸã®åå‰:</label>
      <input type="text" id="userNameInput" placeholder="åå‰ã‚’å…¥åŠ›" style="background: white; border: 1px solid #d1d5db; padding: 4px 8px; border-radius: 4px; font-size: 12px; width: 150px;">
      <button id="saveUserNameBtn" style="background: white; border: 1px solid #d1d5db; padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-left: 4px;">ä¿å­˜</button>
    </div>
  </div>

  <!-- Keepé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="keep-modal-overlay" id="keepModalOverlay" onclick="closeKeepModal(event)">
    <div class="keep-modal" id="keepModal">
      <div class="keep-modal-header">
        <span><i class="bi bi-bookmark" style="color: #f59e0b; margin-right: 8px;"></i>Keepã‹ã‚‰é€ä¿¡</span>
        <button class="keep-modal-close" onclick="closeKeepModal()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      <div class="keep-modal-body" id="keepModalBody">
        <div class="keep-loading">
          <i class="bi bi-arrow-repeat spin"></i>
          èª­ã¿è¾¼ã¿ä¸­...
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="member-modal-overlay" id="memberModalOverlay"></div>
  <div class="member-modal" id="memberModal">
    <div class="member-modal-header">
      <button class="back-btn" id="memberModalBackBtn"><i class="bi bi-chevron-left"></i></button>
      <span class="title">ãƒ¡ãƒ³ãƒãƒ¼</span>
      <button class="edit-btn" id="memberEditBtn">ç·¨é›†</button>
    </div>
    <div class="member-modal-body">
      <div class="member-count" id="memberCount">ãƒ¡ãƒ³ãƒãƒ¼ 0</div>
      <button class="member-invite-btn" id="memberInviteBtn">
        <span class="icon">+</span>
        <span class="text">ãƒ¡ãƒ³ãƒãƒ¼ã‚’æ‹›å¾…</span>
      </button>
      <div id="memberList"></div>
    </div>
  </div>

  <!-- æ‹›å¾…ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="invite-modal-overlay" id="inviteModalOverlay"></div>
  <div class="invite-modal" id="inviteModal">
    <div class="invite-modal-header">
      <span class="title">ãƒ¡ãƒ³ãƒãƒ¼ã‚’æ‹›å¾…</span>
      <button class="close-btn" id="inviteModalCloseBtn">Ã—</button>
    </div>
    <div class="invite-modal-body" id="inviteUserList"></div>
  </div>

  <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
  <div class="profile-popup-overlay" id="profilePopupOverlay" onclick="closeProfilePopup(event)">
    <div class="profile-popup" onclick="event.stopPropagation()">
      <div class="profile-popup-header" id="profilePopupHeader">
        <button class="profile-popup-close" onclick="closeProfilePopup(event)">
          <i class="bi bi-x"></i>
        </button>
        <div id="profilePopupAvatar"></div>
        <div class="profile-popup-name" id="profilePopupName"></div>
        <div class="profile-popup-status" id="profilePopupStatus">ãƒ¡ãƒ³ãƒãƒ¼</div>
      </div>
      <div class="profile-popup-actions">
        <button class="profile-popup-action" id="profilePopupChatBtn">
          <div class="profile-popup-action-icon chat">
            <i class="bi bi-chat-dots-fill"></i>
          </div>
          <span class="profile-popup-action-label">ãƒˆãƒ¼ã‚¯</span>
        </button>
        <button class="profile-popup-action" id="profilePopupCallBtn">
          <div class="profile-popup-action-icon call">
            <i class="bi bi-telephone-fill"></i>
          </div>
          <span class="profile-popup-action-label">é€šè©±</span>
        </button>
      </div>
    </div>
  </div>

  <!-- é¸æŠå‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ãƒãƒ¼ -->
  <div class="selection-mode-bar" id="selectionModeBar">
    <div class="selection-mode-info">
      <span id="selectedCount">0</span> ä»¶é¸æŠä¸­
    </div>
    <div class="selection-mode-buttons">
      <button class="btn-delete-selected" onclick="deleteSelectedMessages()">å‰Šé™¤</button>
      <button class="btn-cancel-selection" onclick="toggleSelectionMode()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ï¼ˆå›ºå®šæ—¥ä»˜ãƒãƒƒã‚¸ä»˜ãï¼‰ -->
  <div class="messages-wrapper" style="position: relative; flex: 1; display: flex; flex-direction: column; overflow: hidden;">
    <div class="sticky-date-badge hidden" id="stickyDateBadge">ä»Šæ—¥</div>
    <div class="messages-container" id="messagesContainer"></div>
  </div>

  <!-- ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ï¼ˆè¤‡æ•°å¯¾å¿œï¼‰ -->
  <div class="image-preview-container" id="imagePreviewContainer" style="display: none;">
    <div class="image-preview-list" id="imagePreviewList">
      <!-- é¸æŠã•ã‚ŒãŸç”»åƒãŒã“ã“ã«è¿½åŠ ã•ã‚Œã‚‹ -->
    </div>
    <span class="image-preview-count" id="imagePreviewCount" style="display: none;">0æš</span>
  </div>

  <!-- ãƒ–ãƒ­ãƒƒã‚¯ä¸­ãƒãƒŠãƒ¼ -->
  <div class="blocked-banner" id="blockedBanner" style="display: none;">
    <i class="bi bi-slash-circle"></i>
    <span>ãƒ–ãƒ­ãƒƒã‚¯ä¸­ã®ãŸã‚ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã§ãã¾ã›ã‚“</span>
  </div>

  <div class="input-container">
    <!-- ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å€™è£œãƒªã‚¹ãƒˆ -->
    <div class="mention-suggestions" id="mentionSuggestions"></div>

    <!-- æ·»ä»˜ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆ+ãƒœã‚¿ãƒ³ã§å±•é–‹ï¼‰ -->
    <div class="attachment-menu" id="attachmentMenu" style="display: none;">
      <button class="attachment-menu-item" onclick="openKeepSelectModal()">
        <i class="bi bi-bookmark"></i>
        <span>Keepã‹ã‚‰é€ä¿¡</span>
      </button>
      <button class="attachment-menu-item" onclick="openMyNoteSelectModal()">
        <i class="bi bi-journal-text"></i>
        <span>ãƒãƒ¼ãƒˆã‚’é€ä¿¡</span>
      </button>
      <button class="attachment-menu-item" onclick="startVoiceRecording()">
        <i class="bi bi-mic"></i>
        <span>éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</span>
      </button>
    </div>

    <!-- éŒ²éŸ³ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="voice-recording-overlay" id="voiceRecordingOverlay" style="display: none;">
      <div class="voice-recording-content">
        <div class="voice-recording-indicator">
          <div class="voice-recording-dot"></div>
          <span class="voice-recording-time" id="voiceRecordingTime">0:00</span>
        </div>
        <p class="voice-recording-text">éŒ²éŸ³ä¸­...</p>
        <div class="voice-recording-buttons">
          <button class="voice-cancel-btn" onclick="cancelVoiceRecording()">
            <i class="bi bi-x-lg"></i>
            <span>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>
          </button>
          <button class="voice-send-btn" onclick="sendVoiceMessage()">
            <i class="bi bi-send-fill"></i>
            <span>é€ä¿¡</span>
          </button>
        </div>
      </div>
    </div>

    <div class="input-wrapper">
      <!-- å±•é–‹ãƒœã‚¿ãƒ³ï¼ˆåç´æ™‚ã«è¡¨ç¤ºï¼‰ -->
      <button class="action-button expand-button" id="expandButton" style="display: none;">
        <i class="bi bi-chevron-right"></i>
      </button>

      <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ç¾¤ -->
      <button class="action-button collapsible-button" id="toggleMenuBtn" onclick="toggleAttachmentMenu()" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
        <i class="bi bi-plus-lg"></i>
      </button>

      <button class="action-button collapsible-button" onclick="openCamera()" title="ã‚«ãƒ¡ãƒ©">
        <i class="bi bi-camera"></i>
      </button>

      <button class="action-button collapsible-button" onclick="selectImage()" title="ç”»åƒ">
        <i class="bi bi-image"></i>
      </button>

      <div class="message-input-wrapper">
        <!-- ãƒªãƒ—ãƒ©ã‚¤ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆLINEé¢¨ï¼‰ -->
        <div id="replyPreview" class="reply-preview">
          <div id="replyPreviewIcon"></div>
          <div class="reply-preview-content">
            <div id="replyPreviewUser" class="reply-preview-user"></div>
            <div id="replyPreviewText" class="reply-preview-text"></div>
          </div>
          <button class="reply-preview-close" onclick="cancelReply()">âœ•</button>
        </div>
        <!-- ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚¿ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="mentionTags" class="mention-tags"></div>
        <textarea
          id="messageInput"
          class="message-input"
          placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
          inputmode="text"
          autocapitalize="off"
          autocomplete="off"
          autocorrect="off"
          spellcheck="false"
          rows="1"></textarea>
      </div>

      <button class="send-button" id="sendButton" onclick="sendMessage()" disabled>
        <i class="bi bi-send-fill"></i>
      </button>
    </div>

    <!-- éš ã—ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› -->
    <input type="file" id="imageInput" accept="image/*" multiple style="display: none;" onchange="handleImageSelect(event)">
    <input type="file" id="fileInput" accept="*/*" style="display: none;" onchange="handleFileSelect(event)">
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" onchange="handleCameraCapture(event)">
  </div>

  <!-- é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆLINEãƒ©ã‚¤ã‚¯ãªãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼‰ -->
  <div id="contextMenuOverlay" onclick="closeContextMenu()"></div>
  <div id="contextMenu">
    <div class="context-menu-items">
      <button class="context-menu-item" id="contextMenuCopy">
        <i class="bi bi-clipboard"></i>
        <span>ã‚³ãƒ”ãƒ¼</span>
      </button>
      <button class="context-menu-item" id="contextMenuReply">
        <i class="bi bi-reply"></i>
        <span>ãƒªãƒ—ãƒ©ã‚¤</span>
      </button>
      <button class="context-menu-item" id="contextMenuForward">
        <i class="bi bi-box-arrow-up-right"></i>
        <span>è»¢é€</span>
      </button>
      <button class="context-menu-item" id="contextMenuKeep">
        <i class="bi bi-bookmark"></i>
        <span>Keep</span>
      </button>
      <button class="context-menu-item" id="contextMenuDelete">
        <i class="bi bi-trash"></i>
        <span>å‰Šé™¤</span>
      </button>
      <button class="context-menu-item danger" id="contextMenuUnsend" style="display: none;">
        <i class="bi bi-arrow-counterclockwise"></i>
        <span>é€ä¿¡å–æ¶ˆ</span>
      </button>
    </div>
  </div>

  <!-- è»¢é€å…ˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="forwardModalOverlay" class="forward-modal-overlay" onclick="closeForwardModal()"></div>
  <div id="forwardModal" class="forward-modal">
    <div class="forward-modal-header">
      <span>è»¢é€å…ˆã‚’é¸æŠ</span>
      <button class="forward-modal-close" onclick="closeForwardModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="forward-modal-body" id="forwardRoomList">
      <!-- ãƒ«ãƒ¼ãƒ ä¸€è¦§ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
    </div>
  </div>

  <!-- ãƒãƒ¼ãƒˆä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="noteListModalOverlay" class="note-list-modal-overlay" onclick="closeNoteListModal()"></div>
  <div id="noteListModal" class="note-list-modal">
    <div class="note-list-modal-header">
      <span>å…±æœ‰ãƒãƒ¼ãƒˆä¸€è¦§</span>
      <button class="note-list-modal-close" onclick="closeNoteListModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="note-list-modal-body" id="noteListContent">
      <!-- ãƒãƒ¼ãƒˆä¸€è¦§ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
    </div>
  </div>

  <!-- è‡ªåˆ†ã®ãƒãƒ¼ãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="myNoteSelectModalOverlay" class="note-list-modal-overlay" onclick="closeMyNoteSelectModal()"></div>
  <div id="myNoteSelectModal" class="note-list-modal">
    <div class="note-list-modal-header">
      <span>ãƒãƒ¼ãƒˆã‚’é¸æŠ</span>
      <button class="note-list-modal-close" onclick="closeMyNoteSelectModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="note-list-modal-body" id="myNoteSelectContent">
      <!-- è‡ªåˆ†ã®ãƒãƒ¼ãƒˆä¸€è¦§ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
    </div>
  </div>

  <!-- Firebase SDK: ç›´æ¥CDNã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆå¤–éƒ¨JSãƒ•ã‚¡ã‚¤ãƒ«ä¸è¦ï¼‰ -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, query, where, orderBy, limit, onSnapshot, serverTimestamp, doc, updateDoc, getDoc, setDoc, increment, getDocs, arrayUnion, arrayRemove, collectionGroup, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

    // Firebaseè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "furira.jp",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    // FirebaseåˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    console.log('[Firebase] Firestore & Storage åˆæœŸåŒ–å®Œäº†');

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function getQueryParam(key) {
      try {
        return new URLSearchParams(location.search).get(key) || '';
      } catch(e) {
        return '';
      }
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆJSON.stringifyã§å®‰å…¨ã«å—ã‘å–ã‚‹ï¼‰
    let currentUserName = '';
    let currentUserEmail = '';
    let currentRoomId = '';
    let currentRoomName = '';
    let currentRoomType = '';      // ãƒ«ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—ï¼ˆ'direct' or 'group'ï¼‰
    let currentRoomMemberCount = 0; // ãƒ«ãƒ¼ãƒ ã®ãƒ¡ãƒ³ãƒãƒ¼æ•°
    let currentRoomMembers = [];   // ãƒ«ãƒ¼ãƒ ã®ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆ
    let usersCache = []; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºç”¨ï¼‰
    let memberEditMode = false; // ãƒ¡ãƒ³ãƒãƒ¼ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
    let memberIconsBarExpanded = false; // ãƒ¡ãƒ³ãƒãƒ¼ã‚¢ã‚¤ã‚³ãƒ³è¡Œã®å±•é–‹çŠ¶æ…‹
    let currentProfileUser = null; // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ç”¨

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«èƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒªã‚»ãƒƒãƒˆ
    const GRADIENT_PRESETS = [
      { id: 'blue', gradient: 'linear-gradient(135deg, #40B4E5 0%, #1E8FBF 100%)' },
      { id: 'purple', gradient: 'linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%)' },
      { id: 'pink', gradient: 'linear-gradient(135deg, #EC4899 0%, #BE185D 100%)' },
      { id: 'orange', gradient: 'linear-gradient(135deg, #F97316 0%, #EA580C 100%)' },
      { id: 'green', gradient: 'linear-gradient(135deg, #22C55E 0%, #15803D 100%)' },
      { id: 'teal', gradient: 'linear-gradient(135deg, #14B8A6 0%, #0F766E 100%)' },
      { id: 'indigo', gradient: 'linear-gradient(135deg, #6366F1 0%, #4338CA 100%)' },
      { id: 'rose', gradient: 'linear-gradient(135deg, #F43F5E 0%, #BE123C 100%)' },
      { id: 'amber', gradient: 'linear-gradient(135deg, #F59E0B 0%, #D97706 100%)' },
      { id: 'cyan', gradient: 'linear-gradient(135deg, #06B6D4 0%, #0891B2 100%)' },
      { id: 'lime', gradient: 'linear-gradient(135deg, #84CC16 0%, #65A30D 100%)' },
      { id: 'slate', gradient: 'linear-gradient(135deg, #64748B 0%, #475569 100%)' },
    ];

    // ãƒªãƒ—ãƒ©ã‚¤æ©Ÿèƒ½ç”¨ï¼ˆLINEé¢¨ï¼‰
    let currentReplyTo = null; // { messageId, userName, text, userIcon }

    // ãƒ–ãƒ­ãƒƒã‚¯æ©Ÿèƒ½ç”¨ï¼ˆLINEé¢¨ï¼‰
    let isBlockedByMe = false;      // è‡ªåˆ†ãŒç›¸æ‰‹ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ã‚‹ã‹
    let isBlockedByOther = false;   // ç›¸æ‰‹ãŒè‡ªåˆ†ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ã‚‹ã‹
    let otherUserEmail = '';        // å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆã®ç›¸æ‰‹ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹

    // PWAç‰ˆï¼šURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼ˆGASãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ã¯ä½¿ç”¨ã—ãªã„ï¼‰
    const isPWAFlag        = true;  // PWAç‰ˆã¨ã—ã¦å‹•ä½œ
    const pwaUserNameParam = getQueryParam('userName') || '';
    const pwaUserEmailParam = getQueryParam('userEmail') || '';
    const pwaRoomIdParam   = getQueryParam('roomId') || '';
    const gasUserNameParam = '';
    const gasRoomIdParam   = '';
    const fcmTokenParam    = '';
    const gasBaseUrlParam  = '';
    const sessionIdParam   = getQueryParam('sessionId') || 'unknown';
    const searchQueryParam = getQueryParam('searchQuery') || '';  // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¼•ãç¶™ãç”¨

    // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼šPWAç‰ˆã¨ã—ã¦å‹•ä½œ
    const isEmbedded = (window.top !== window);
    const looksLikePWA = true;
    const isPWA = true;
    const isGAS = false;

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('[Chat UI] åˆæœŸåŒ–é–‹å§‹');

      // ãƒœãƒˆãƒ ãƒŠãƒ“ã‚’éè¡¨ç¤ºï¼ˆãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ è¡¨ç¤ºä¸­ã¯ä¸è¦ï¼‰
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'hideBottomNav' }, '*');
        console.log('[Chat UI] ãƒœãƒˆãƒ ãƒŠãƒ“éè¡¨ç¤ºè¦æ±‚ã‚’é€ä¿¡');
      }

      // ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†é–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      document.getElementById('headerTitle').addEventListener('click', function() {
        console.log('[HeaderTitle] ã‚¯ãƒªãƒƒã‚¯æ¤œå‡º');
        if (currentRoomType === 'direct') return;
        memberIconsBarExpanded = !memberIconsBarExpanded;
        console.log('[MemberIconsBar] ãƒˆã‚°ãƒ«:', memberIconsBarExpanded, 'ãƒ¡ãƒ³ãƒãƒ¼:', currentRoomMembers, 'usersCache:', usersCache);
        updateMemberIconsBar();
      });
      document.getElementById('memberMoreBtn').addEventListener('click', function() {
        console.log('[MemberMoreBtn] ã‚¯ãƒªãƒƒã‚¯æ¤œå‡º');
        openMemberModal();
      });
      document.getElementById('memberModalOverlay').addEventListener('click', function() { closeMemberModal(); });
      document.getElementById('memberModalBackBtn').addEventListener('click', function() { closeMemberModal(); });
      document.getElementById('memberEditBtn').addEventListener('click', function() { toggleMemberEditMode(); });
      document.getElementById('memberInviteBtn').addEventListener('click', function() { openInviteModal(); });
      document.getElementById('inviteModalOverlay').addEventListener('click', function() { closeInviteModal(); });
      document.getElementById('inviteModalCloseBtn').addEventListener('click', function() { closeInviteModal(); });

      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ãƒœã‚¿ãƒ³
      document.getElementById('profilePopupChatBtn').addEventListener('click', function() {
        if (currentProfileUser) {
          // æ—¢ã«ã“ã®ãƒ«ãƒ¼ãƒ ã«ã„ã‚‹å ´åˆã¯é–‰ã˜ã‚‹ã ã‘
          closeProfilePopup();
        }
      });
      document.getElementById('profilePopupCallBtn').addEventListener('click', function() {
        if (currentProfileUser) {
          // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‹ã‚‰é€šè©±ã‚’é–‹å§‹
          const userName = currentProfileUser.userName;
          const iconUrl = currentProfileUser.iconUrl;
          closeProfilePopup();
          showCallPreparing(userName, iconUrl);
        }
      });

      // roomIdè¨­å®š
      if (isGAS) {
        currentRoomId = gasRoomIdParam || 'room_all';
      } else {
        currentRoomId = pwaRoomIdParam || 'room_all';
      }
      console.log('[Room] roomIdè¨­å®š:', currentRoomId);

      // âš ï¸ é‡è¦: ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…ˆã«è¨­å®šã—ã¦ã‹ã‚‰ã€ãƒ«ãƒ¼ãƒ æƒ…å ±ã‚’å–å¾—ã™ã‚‹
      // ï¼ˆå€‹åˆ¥ãƒãƒ£ãƒƒãƒˆã§ç›¸æ‰‹ã®åå‰ã‚’åˆ¤å®šã™ã‚‹ãŸã‚ã€currentUserNameãŒå¿…è¦ï¼‰

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¨­å®š
      if (isGAS) {
        // GASç‰ˆï¼šFCMé€šçŸ¥ç™»éŒ²ã‚·ãƒ¼ãƒˆã‹ã‚‰è‡ªå‹•å–å¾—
        if (gasUserNameParam && gasUserNameParam.trim() !== '') {
          // JSON.parse()ã§ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
          try {
            currentUserName = JSON.parse(gasUserNameParam);
          } catch (e) {
            // ãƒ‘ãƒ¼ã‚¹ã§ããªã„å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
            currentUserName = gasUserNameParam;
          }
          console.log('[GAS] ãƒ¦ãƒ¼ã‚¶ãƒ¼åè‡ªå‹•è¨­å®š:', currentUserName);
          console.log('[GAS] currentUserName length:', currentUserName.length);
        } else {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒå–å¾—ã§ããªã‹ã£ãŸå ´åˆã€ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¡¨ç¤º
          console.log('[GAS] ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’è¡¨ç¤º');
          showUserSelect();
        }
      } else {
        // PWAç‰ˆï¼šURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼ˆè¦ªãƒšãƒ¼ã‚¸ã®localStorageã‹ã‚‰æ¸¡ã•ã‚Œã‚‹ï¼‰
        // JSON.parse()ã§ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
        try {
          currentUserName = JSON.parse(pwaUserNameParam);
        } catch (e) {
          // ãƒ‘ãƒ¼ã‚¹ã§ããªã„å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
          currentUserName = pwaUserNameParam;
        }

        try {
          currentUserEmail = JSON.parse(pwaUserEmailParam);
        } catch (e) {
          currentUserEmail = pwaUserEmailParam;
        }

        console.log('[PWA] pwaUserNameParamå—ä¿¡:', pwaUserNameParam);
        console.log('[PWA] pwaUserEmailParamå—ä¿¡:', pwaUserEmailParam);
        console.log('[PWA] currentUserNameè¨­å®š:', currentUserName);
        console.log('[PWA] currentUserEmailè¨­å®š:', currentUserEmail);
        console.log('[PWA] currentUserName length:', currentUserName.length);

        if (currentUserName && currentUserName.trim() !== '') {
          console.log('[PWA] ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤ºå®Œäº†:', currentUserName);
        } else {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒæœªè¨­å®šã®å ´åˆã€å…¥åŠ›UIã‚’è¡¨ç¤º
          console.log('[PWA] ãƒ¦ãƒ¼ã‚¶ãƒ¼åæœªè¨­å®š - å…¥åŠ›UIã‚’è¡¨ç¤º');
          const container = document.getElementById('userNameInputContainer');
          if (container) {
            container.style.display = 'block';
            console.log('[PWA] ãƒ¦ãƒ¼ã‚¶ãƒ¼åå…¥åŠ›UIè¡¨ç¤ºå®Œäº†');
          } else {
            console.error('[PWA] userNameInputContainer ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          }
        }
      }

      // ãƒ«ãƒ¼ãƒ æƒ…å ±ã‚’å–å¾—ã—ã¦ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¡¨ç¤º
      console.log('[Room] ãƒ«ãƒ¼ãƒ æƒ…å ±å–å¾—é–‹å§‹ - roomId:', currentRoomId);
      console.log('[Room] currentUserName:', currentUserName);
      try {
        const roomRef = doc(db, 'rooms', currentRoomId);
        console.log('[Room] roomRefä½œæˆå®Œäº†');
        const roomDoc = await getDoc(roomRef);
        console.log('[Room] getDocå®Œäº† - exists:', roomDoc.exists());

        if (roomDoc.exists()) {
          const roomData = roomDoc.data();
          console.log('[Room] roomDataå–å¾—:', roomData);

          // å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆï¼ˆtype: 'direct'ï¼‰ã®å ´åˆã¯ç›¸æ‰‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å‹•çš„ç”Ÿæˆ
          if (roomData.type === 'direct' && roomData.members && Array.isArray(roomData.members)) {
            console.log('[Room] å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆæ¤œå‡º - members:', roomData.members, 'currentUserName:', currentUserName);
            const otherMember = roomData.members.find(m => m !== currentUserName);
            currentRoomName = otherMember || 'ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼';
            console.log('[Room] ç›¸æ‰‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å:', currentRoomName);
          } else {
            // ãƒ«ãƒ¼ãƒ åã‹ã‚‰å…ˆé ­ã®çµµæ–‡å­—ã‚’å‰Šé™¤ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ã¯åˆ¥é€”è¡¨ç¤ºã™ã‚‹ãŸã‚é‡è¤‡å›é¿ï¼‰
            let rawName = roomData.name || 'ä¸æ˜ãªãƒ«ãƒ¼ãƒ ';
            currentRoomName = rawName.replace(/^[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]+\s*/u, '');
          }

          // ãƒ«ãƒ¼ãƒ ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆsystem-notificationsã¯ğŸ‘‘ã€ãã‚Œä»¥å¤–ã¯room.iconã¾ãŸã¯ğŸ’¬ï¼‰
          const roomIcon = (currentRoomId === 'system-notifications') ? 'ğŸ‘‘' : (roomData.icon || 'ğŸ’¬');

          // ãƒ«ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—ã¨ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’ä¿å­˜ï¼ˆæ—¢èª­æ©Ÿèƒ½ãƒ»ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ç”¨ï¼‰
          currentRoomType = roomData.type || 'group';
          currentRoomMembers = (roomData.members && Array.isArray(roomData.members)) ? roomData.members : [];
          currentRoomMemberCount = currentRoomMembers.length;
          console.log('[Room] ãƒ«ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—:', currentRoomType, 'ãƒ¡ãƒ³ãƒãƒ¼æ•°:', currentRoomMemberCount, 'ãƒ¡ãƒ³ãƒãƒ¼:', currentRoomMembers);

          // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ«ãƒ¼ãƒ åã‚’æ›´æ–°ï¼ˆå€‹åˆ¥ãƒãƒ£ãƒƒãƒˆãƒ»Keepã¯åå‰ã®ã¿ã€ãã‚Œä»¥å¤–ã¯ã‚¢ã‚¤ã‚³ãƒ³ä»˜ãï¼‰
          if (roomData.type === 'direct' || roomData.type === 'keep') {
            // å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆãƒ»Keepï¼šã‚¢ã‚¤ã‚³ãƒ³éè¡¨ç¤ºã€åå‰ã®ã¿ã€ãƒ¡ãƒ³ãƒãƒ¼ã‚¢ã‚¤ã‚³ãƒ³è¡Œéè¡¨ç¤º
            document.getElementById('headerRoomIcon').style.display = 'none';
            document.getElementById('headerRoomName').textContent = currentRoomName;
            document.getElementById('memberIconsBar').classList.remove('show');
            console.log('[Room] å€‹åˆ¥/Keepãƒãƒ£ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°ï¼ˆåå‰ã®ã¿ï¼‰:', currentRoomName);
          } else {
            // ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆï¼šã‚¢ã‚¤ã‚³ãƒ³+åå‰
            // ãƒ¡ãƒ³ãƒãƒ¼ã‚¢ã‚¤ã‚³ãƒ³è¡Œã¯æœ€åˆã¯éè¡¨ç¤ºï¼ˆã‚¿ãƒƒãƒ—ã§é–‹é–‰ï¼‰
            document.getElementById('headerRoomIcon').style.display = 'none'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã¯éè¡¨ç¤º
            document.getElementById('headerRoomName').textContent = `${roomIcon} ${currentRoomName}`;
            memberIconsBarExpanded = false; // ãƒ«ãƒ¼ãƒ åˆ‡ã‚Šæ›¿ãˆæ™‚ã¯é–‰ã˜ãŸçŠ¶æ…‹ã§ã‚¹ã‚¿ãƒ¼ãƒˆ
            updateMemberIconsBar();
            console.log('[Room] ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ä»˜ãï¼‰:', `${roomIcon} ${currentRoomName}`);
          }


          console.log('[Room] ãƒ«ãƒ¼ãƒ åè¡¨ç¤ºå®Œäº†:', currentRoomName);
        } else {
          console.error('[Room] ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', currentRoomId);
        }
      } catch (error) {
        console.error('[Room] ãƒ«ãƒ¼ãƒ æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¨­å®š
      if (isGAS) {
        // GASç‰ˆï¼šFCMé€šçŸ¥ç™»éŒ²ã‚·ãƒ¼ãƒˆã‹ã‚‰è‡ªå‹•å–å¾—
        if (gasUserNameParam && gasUserNameParam.trim() !== '') {
          // JSON.parse()ã§ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
          try {
            currentUserName = JSON.parse(gasUserNameParam);
          } catch (e) {
            // ãƒ‘ãƒ¼ã‚¹ã§ããªã„å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
            currentUserName = gasUserNameParam;
          }
          console.log('[GAS] ãƒ¦ãƒ¼ã‚¶ãƒ¼åè‡ªå‹•è¨­å®š:', currentUserName);
          console.log('[GAS] currentUserName length:', currentUserName.length);
        } else {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒå–å¾—ã§ããªã‹ã£ãŸå ´åˆã€ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¡¨ç¤º
          console.log('[GAS] ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’è¡¨ç¤º');
          showUserSelect();
        }
      } else {
        // PWAç‰ˆï¼šURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼ˆè¦ªãƒšãƒ¼ã‚¸ã®localStorageã‹ã‚‰æ¸¡ã•ã‚Œã‚‹ï¼‰
        // JSON.parse()ã§ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
        try {
          currentUserName = JSON.parse(pwaUserNameParam);
        } catch (e) {
          // ãƒ‘ãƒ¼ã‚¹ã§ããªã„å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
          currentUserName = pwaUserNameParam;
        }

        try {
          currentUserEmail = JSON.parse(pwaUserEmailParam);
        } catch (e) {
          currentUserEmail = pwaUserEmailParam;
        }

        console.log('[PWA] pwaUserNameParamå—ä¿¡:', pwaUserNameParam);
        console.log('[PWA] pwaUserEmailParamå—ä¿¡:', pwaUserEmailParam);
        console.log('[PWA] currentUserNameè¨­å®š:', currentUserName);
        console.log('[PWA] currentUserEmailè¨­å®š:', currentUserEmail);
        console.log('[PWA] currentUserName length:', currentUserName.length);

        if (currentUserName && currentUserName.trim() !== '') {
          console.log('[PWA] ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤ºå®Œäº†:', currentUserName);
        } else {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒæœªè¨­å®šã®å ´åˆã€å…¥åŠ›UIã‚’è¡¨ç¤º
          console.log('[PWA] ãƒ¦ãƒ¼ã‚¶ãƒ¼åæœªè¨­å®š - å…¥åŠ›UIã‚’è¡¨ç¤º');
          const container = document.getElementById('userNameInputContainer');
          if (container) {
            container.style.display = 'block';
            console.log('[PWA] ãƒ¦ãƒ¼ã‚¶ãƒ¼åå…¥åŠ›UIè¡¨ç¤ºå®Œäº†');
          } else {
            console.error('[PWA] userNameInputContainer ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          }
        }
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºç”¨ï¼‰
      if (isPWA) {
        // PWAç‰ˆï¼šgetUserList()ã¯api.jsã«ä¾å­˜ã—ã¦ã„ã‚‹ãŸã‚ã‚¹ã‚­ãƒƒãƒ—
        // ç›´æ¥Firestoreã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—
        console.log('[User Cache] Firestoreã‹ã‚‰ç›´æ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—é–‹å§‹');

        getDocs(collection(db, 'users'))
          .then(snapshot => {
            const users = [];
            snapshot.forEach(doc => {
              users.push({ id: doc.id, ...doc.data() });
            });

            console.log('[User Cache] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å—ä¿¡:', users);
            if (users.length > 0) {
              usersCache = users;
              console.log('[User Cache] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Œäº†:', usersCache.length + 'ä»¶');
            } else {
              console.warn('[User Cache] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãŒç©ºã§ã™');
            }

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            console.log('[User Cache] ã‚­ãƒ£ãƒƒã‚·ãƒ¥å–å¾—å®Œäº†ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒ‹ãƒ³ã‚°é–‹å§‹');
            startListening();
          })
          .catch(error => {
            console.error('[User Cache] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã§ã‚‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è¡¨ç¤ºã™ã‚‹
            startListening();
          });
      } else if (typeof google !== 'undefined' && google.script && google.script.run) {
        // GASç‰ˆï¼šgoogle.script.runã§å‘¼ã³å‡ºã—
        google.script.run
          .withSuccessHandler(function(users) {
            if (users && users.length > 0) {
              usersCache = users;
              console.log('[User Cache] GASç‰ˆ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Œäº†:', usersCache.length + 'ä»¶');
            }
          })
          .withFailureHandler(function(error) {
            console.error('[User Cache] GASç‰ˆ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          })
          .getUserListForUI();
      }

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ï¼ˆhidden textarea ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
      const messageInput = document.getElementById('messageInput'); // textarea

      // IMEå¤‰æ›çŠ¶æ…‹ã®ç›£è¦–
      messageInput.addEventListener('compositionstart', function() {
        isComposing = true;
        console.log('[IME] compositionstart - å¤‰æ›é–‹å§‹');
      });
      messageInput.addEventListener('compositionend', function() {
        isComposing = false;
        console.log('[IME] compositionend - å¤‰æ›çµ‚äº†');
        // IMEç¢ºå®šå¾Œã«ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
        checkMentionInput(this);
      });

      // å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆIMEå¤‰æ›ä¸­ã¯å€™è£œè¡¨ç¤ºã—ãªã„ï¼‰
      messageInput.addEventListener('input', function() {
        // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æŒ¿å…¥ç›´å¾Œãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆä»–ã®æ–‡å­—å…¥åŠ›ãŒã‚ã£ãŸå ´åˆï¼‰
        justInsertedMention = false;
        // IMEå¤‰æ›ä¸­ã§ãªã‘ã‚Œã°ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
        if (!isComposing) {
          checkMentionInput(this);
        }
        // é€ä¿¡ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’æ›´æ–°
        updateSendButtonState();
      });

      // Enterã‚­ãƒ¼ã§é€ä¿¡ï¼ˆãƒ¡ãƒ³ã‚·ãƒ§ãƒ³é¸æŠä¸­ã¯å€™è£œé¸æŠï¼‰
      messageInput.addEventListener('keydown', function(e) {
        // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å€™è£œãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆ
        if (isMentionSuggestionsVisible()) {
          if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectNextMentionSuggestion();
            return;
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectPrevMentionSuggestion();
            return;
          } else if (e.key === 'Enter') {
            e.preventDefault();
            insertSelectedMention();
            justInsertedMention = true;
            console.log('[Mention] ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æŒ¿å…¥å®Œäº†ã€æ”¹è¡Œãƒ•ãƒ©ã‚°ON');
            return;
          } else if (e.key === 'Escape') {
            e.preventDefault();
            hideMentionSuggestions();
            return;
          }
        }

        // Enterã‚­ãƒ¼ã®å‡¦ç†
        if (e.key === 'Enter') {
          // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æŒ¿å…¥ç›´å¾Œã®Enterã¯æ”¹è¡Œã¨ã—ã¦å‡¦ç†ï¼ˆé€ä¿¡ã—ãªã„ï¼‰
          if (justInsertedMention) {
            console.log('[Mention] ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ç›´å¾Œã®Enter â†’ æ”¹è¡Œã¨ã—ã¦å‡¦ç†');
            justInsertedMention = false;
            e.preventDefault();
            insertLineBreak();
            return;
          }

          // Shift+Enterã¯æ”¹è¡Œ
          if (e.shiftKey) {
            e.preventDefault();
            insertLineBreak();
            return;
          }

          // é€šå¸¸ã®Enterã¯é€ä¿¡
          e.preventDefault();
          sendMessage();
        }
      });

      // æœªèª­ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆï¼ˆã“ã®ãƒ«ãƒ¼ãƒ ã‚’é–‹ã„ãŸã®ã§æ—¢èª­ã«ã™ã‚‹ï¼‰
      try {
        if (currentRoomId && currentUserEmail) {
          const unreadRef = doc(db, `rooms/${currentRoomId}/unreadCounts/${currentUserEmail}`);
          await setDoc(unreadRef, {
            userId: currentUserEmail,
            unreadCount: 0,
            lastReadAt: serverTimestamp()
          }, { merge: true });

          console.log('[Firestore] æœªèª­ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆå®Œäº†:', currentUserEmail);

          // ã‚¢ãƒ—ãƒªãƒãƒƒã‚¸ã‚‚ã‚¯ãƒªã‚¢ï¼ˆãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã‚’é–‹ã„ãŸã®ã§æ—¢èª­ï¼‰
          clearAppBadge();
        }
      } catch (error) {
        console.error('[Firestore] æœªèª­ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
      }

      // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã«ä»–ã®ãƒ«ãƒ¼ãƒ ã®æœªèª­æ•°ã‚’è¡¨ç¤º
      loadOtherRoomsUnreadCount();

      // Service Workerã«é–²è¦§ä¸­ã§ã‚ã‚‹ã“ã¨ã‚’é€šçŸ¥ï¼ˆãƒãƒƒã‚¸åˆ¶å¾¡ç”¨ï¼‰
      notifySwViewingRoom(currentRoomId);

      // ğŸ¯ Firestoreã«é–²è¦§ä¸­çŠ¶æ…‹ã‚’æ›¸ãè¾¼ã¿ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã§é€šçŸ¥é™¤å¤–ã«ä½¿ç”¨ï¼‰
      setViewingStatus(currentRoomId);

      // ğŸ¯ ç€ä¿¡ãƒªã‚¹ãƒŠãƒ¼ã‚’é–‹å§‹
      if (typeof startIncomingCallListener === 'function') {
        startIncomingCallListener();
      }

      // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«SWã¸é€šçŸ¥ + Firestoreæ›´æ–°
      window.addEventListener('pagehide', () => {
        notifySwLeftRoom();
        clearViewingStatus();
      });
      window.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
          notifySwLeftRoom();
          clearViewingStatus();
        } else if (document.visibilityState === 'visible') {
          notifySwViewingRoom(currentRoomId);
          setViewingStatus(currentRoomId);
          // ç€ä¿¡ãƒªã‚¹ãƒŠãƒ¼å†é–‹
          if (typeof startIncomingCallListener === 'function') {
            startIncomingCallListener();
          }
        }
      });

      // beforeunload ã§ã‚‚é–²è¦§çµ‚äº†ã‚’è¨˜éŒ²ï¼ˆpagehideãŒç™ºç«ã—ãªã„å ´åˆã®ä¿é™ºï¼‰
      window.addEventListener('beforeunload', () => {
        clearViewingStatus();
      });

      // ãƒ«ãƒ¼ãƒ ã®membersã«è‡ªåˆ†ã‚’è¿½åŠ ï¼ˆæœªè¿½åŠ ã®å ´åˆï¼‰
      try {
        if (currentRoomId && currentUserName) {
          const roomRef = doc(db, 'rooms', currentRoomId);
          await updateDoc(roomRef, {
            members: arrayUnion(currentUserName)
          });

          console.log('[Firestore] ãƒ«ãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã«è¿½åŠ :', currentUserName);
        }
      } catch (error) {
        console.error('[Firestore] ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
      }

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥å–å¾—å¾Œã«é–‹å§‹
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå–å¾—ã§ããªã„å ´åˆã¯3ç§’å¾Œã«é–‹å§‹
      if (!isPWA) {
        // GASç‰ˆã¯å³åº§ã«startListening
        startListening();
      }
      // PWAç‰ˆã¯fetchå®Œäº†å¾Œã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¾Œã«startListeningã‚’å‘¼ã³å‡ºã™

      // LINEé¢¨ã‚¹ãƒ†ã‚£ãƒƒã‚­ãƒ¼æ—¥ä»˜ãƒãƒƒã‚¸ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç›£è¦–
      const messagesContainer = document.getElementById('messagesContainer');
      const stickyDateBadge = document.getElementById('stickyDateBadge');
      let stickyBadgeHideTimer = null; // ãƒãƒƒã‚¸è‡ªå‹•éè¡¨ç¤ºç”¨ã‚¿ã‚¤ãƒãƒ¼
      
      messagesContainer.addEventListener('scroll', function() {
        updateStickyDateBadge();
        
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸­ã¯ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
        if (stickyBadgeHideTimer) {
          clearTimeout(stickyBadgeHideTimer);
          stickyBadgeHideTimer = null;
        }
        
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãŒæ­¢ã¾ã£ãŸã‚‰1.5ç§’å¾Œã«ãƒãƒƒã‚¸ã‚’éè¡¨ç¤ºï¼ˆLINEé¢¨ï¼‰
        stickyBadgeHideTimer = setTimeout(() => {
          stickyDateBadge.classList.add('hidden');
        }, 1500);
      });

      function updateStickyDateBadge() {
        const container = document.getElementById('messagesContainer');
        const dateSeparators = container.querySelectorAll('.date-separator');
        
        if (dateSeparators.length === 0) {
          stickyDateBadge.classList.add('hidden');
          return;
        }

        // ã‚³ãƒ³ãƒ†ãƒŠã®ä¸Šç«¯ã‚’åŸºæº–
        const containerRect = container.getBoundingClientRect();
        const containerTop = containerRect.top;
        const containerBottom = containerRect.bottom;

        // ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹æ—¥ä»˜ã‚’æ¤œå‡º
        let currentDate = null;
        let isAnyDateSeparatorVisible = false;
        
        for (const sep of dateSeparators) {
          const sepRect = sep.getBoundingClientRect();
          
          // æ—¥ä»˜åŒºåˆ‡ã‚ŠãŒç”»é¢å†…ã«è¦‹ãˆã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if (sepRect.top >= containerTop && sepRect.bottom <= containerBottom) {
            isAnyDateSeparatorVisible = true;
          }
          
          // æ—¥ä»˜åŒºåˆ‡ã‚ŠãŒã‚³ãƒ³ãƒ†ãƒŠä¸Šç«¯ã‚ˆã‚Šä¸‹ã«ã‚ã‚‹å ´åˆã€ãã®å‰ã®æ—¥ä»˜ãŒç¾åœ¨ã®æ—¥ä»˜
          if (sepRect.top > containerTop + 10) {
            break;
          }
          currentDate = sep.dataset.date;
        }

        // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã®æ—¥ä»˜åŒºåˆ‡ã‚ŠãŒè¦‹ãˆã¦ã„ã‚‹å ´åˆã¯å›ºå®šãƒãƒƒã‚¸ã‚’éè¡¨ç¤º
        if (isAnyDateSeparatorVisible) {
          stickyDateBadge.classList.add('hidden');
        } else if (currentDate) {
          stickyDateBadge.textContent = currentDate;
          stickyDateBadge.classList.remove('hidden');
        } else {
          // æœ€åˆã®æ—¥ä»˜åŒºåˆ‡ã‚Šã‚ˆã‚Šä¸Šã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã„ã‚‹å ´åˆã¯éè¡¨ç¤º
          stickyDateBadge.classList.add('hidden');
        }
      }
    });

    // GASç‰ˆï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¡¨ç¤º
    function showUserSelect() {
      const container = document.getElementById('userSelectContainer');
      const select = document.getElementById('userSelect');

      container.style.display = 'block';

      // FCMé€šçŸ¥ç™»éŒ²ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆå–å¾—
      google.script.run
        .withSuccessHandler(function(users) {
          console.log('[GAS] ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—æˆåŠŸ:', users);

          if (!users || users.length === 0) {
            console.error('[GAS] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
          }

          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºç”¨ï¼‰
          usersCache = users;
          console.log('[User Cache] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Œäº†:', usersCache.length + 'ä»¶');

          // å‰å›é¸æŠã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
          const savedUserName = localStorage.getItem('reborn_chat_user_name');

          // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è¿½åŠ 
          select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
          users.forEach(function(user) {
            const option = document.createElement('option');
            option.value = user.userName;
            option.textContent = user.userName;

            if (savedUserName && user.userName === savedUserName) {
              option.selected = true;
              currentUserName = user.userName;
            }

            select.appendChild(option);
          });

          // é¸æŠå¤‰æ›´æ™‚
          select.addEventListener('change', function() {
            currentUserName = this.value;
            localStorage.setItem('reborn_chat_user_name', currentUserName);
            console.log('[GAS] ãƒ¦ãƒ¼ã‚¶ãƒ¼åé¸æŠ:', currentUserName);
          });
        })
        .withFailureHandler(function(error) {
          console.error('[GAS] ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getActiveUsers();
    }

    // PWAç‰ˆï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼åå…¥åŠ›UIè¡¨ç¤º
    function showUserNameInput() {
      const container = document.getElementById('userNameInputContainer');
      const input = document.getElementById('userNameInput');
      const saveBtn = document.getElementById('saveUserNameBtn');

      container.style.display = 'block';

      // æ—¢å­˜ã®å€¤ãŒã‚ã‚Œã° pre-fill
      if (currentUserName) {
        input.value = currentUserName;
      }

      // ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
      saveBtn.addEventListener('click', function() {
        const userName = input.value.trim();

        if (!userName) {
          alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }

        // localStorage ã«ä¿å­˜
        localStorage.setItem('reborn_user_name', userName);
        currentUserName = userName;

        // å…¥åŠ›UIã‚’éè¡¨ç¤º
        container.style.display = 'none';

        console.log('[PWA] ãƒ¦ãƒ¼ã‚¶ãƒ¼åä¿å­˜:', userName);
      });
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³URLã‚’å–å¾—
    function getUserIconUrl(userName) {
      if (!userName || !usersCache || usersCache.length === 0) return null;
      const user = usersCache.find(u => u.userName === userName);
      return (user && user.userIconUrl) ? user.userIconUrl : null;
    }

    // æ—¢èª­çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é–²è¦§ã—ãŸã“ã¨ã‚’Firestoreã«è¨˜éŒ²ï¼‰
    async function markMessagesAsRead(messageIds) {
      if (!currentUserEmail || !currentRoomId || messageIds.length === 0) return;

      console.log('[æ—¢èª­] æ—¢èª­æ›´æ–°é–‹å§‹:', messageIds.length, 'ä»¶');

      try {
        // ãƒãƒƒãƒæ›´æ–°ã§åŠ¹ç‡åŒ–
        const batch = writeBatch(db);

        for (const msgId of messageIds) {
          const msgRef = doc(db, `rooms/${currentRoomId}/messages/${msgId}`);
          // arrayUnion ã§é‡è¤‡ãªãè¿½åŠ 
          batch.update(msgRef, {
            readBy: arrayUnion(currentUserEmail)
          });
        }

        await batch.commit();
        console.log('[æ—¢èª­] æ—¢èª­æ›´æ–°å®Œäº†:', messageIds.length, 'ä»¶');
      } catch (error) {
        console.error('[æ—¢èª­] æ—¢èª­æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // Service Workerã«é–²è¦§ä¸­ã®ãƒ«ãƒ¼ãƒ ã‚’é€šçŸ¥
    function notifySwViewingRoom(roomId) {
      if (navigator.serviceWorker && navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({
          type: 'VIEWING_ROOM',
          roomId: roomId
        });
        console.log('[SWé€šçŸ¥] é–²è¦§ä¸­ãƒ«ãƒ¼ãƒ ã‚’é€šçŸ¥:', roomId);
      } else {
        console.log('[SWé€šçŸ¥] Service WorkerãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
      }
    }

    // Service Workerã«ãƒ«ãƒ¼ãƒ é–²è¦§çµ‚äº†ã‚’é€šçŸ¥
    function notifySwLeftRoom() {
      if (navigator.serviceWorker && navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({
          type: 'VIEWING_ROOM',
          roomId: null
        });
        console.log('[SWé€šçŸ¥] ãƒ«ãƒ¼ãƒ é–²è¦§çµ‚äº†ã‚’é€šçŸ¥');
      }
    }

    // ğŸ¯ ã‚¢ãƒ—ãƒªãƒãƒƒã‚¸ã‚’ã‚¯ãƒªã‚¢ï¼ˆService WorkerçµŒç”± + ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä¸¡æ–¹ï¼‰
    function clearAppBadge() {
      // 1. Service Workerã«ãƒãƒƒã‚¸ã‚¯ãƒªã‚¢å‘½ä»¤ã‚’é€ä¿¡ï¼ˆæœ€é‡è¦ï¼‰
      if (navigator.serviceWorker && navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({
          type: 'CLEAR_BADGE'
        });
        console.log('[Badge] SW ã¸ãƒãƒƒã‚¸ã‚¯ãƒªã‚¢å‘½ä»¤é€ä¿¡');
      }

      // 2. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã‚‚Navigator Badge APIã‚’å‘¼ã¶ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
      if ('clearAppBadge' in navigator) {
        navigator.clearAppBadge().catch(err => {
          console.error('[Badge] clearAppBadge ã‚¨ãƒ©ãƒ¼:', err);
        });
        console.log('[Badge] ã‚¢ãƒ—ãƒªãƒãƒƒã‚¸ã‚¯ãƒªã‚¢ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ï¼‰');
      }

      // 3. IndexedDBã®ãƒãƒƒã‚¸ã‚«ã‚¦ãƒ³ãƒˆã‚‚ãƒªã‚»ãƒƒãƒˆï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
      resetBadgeDB('RebornBadgeDB');
      resetBadgeDB('SystemNotificationDB');
    }

    // IndexedDBã®ãƒãƒƒã‚¸ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
    function resetBadgeDB(dbName) {
      try {
        const req = indexedDB.open(dbName, 1);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains('badge')) {
            db.createObjectStore('badge');
          }
        };
        req.onsuccess = () => {
          const db = req.result;
          if (db.objectStoreNames.contains('badge')) {
            const tx = db.transaction('badge', 'readwrite');
            const store = tx.objectStore('badge');
            store.put(0, 'count');
            tx.oncomplete = () => {
              db.close();
              console.log(`[Badge] ${dbName} ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆ`);
            };
          } else {
            db.close();
          }
        };
        req.onerror = () => {
          console.error(`[Badge] ${dbName} open ã‚¨ãƒ©ãƒ¼:`, req.error);
        };
      } catch (error) {
        console.error(`[Badge] ${dbName} ã‚¨ãƒ©ãƒ¼:`, error);
      }
    }

    // ğŸ¯ Firestoreã«é–²è¦§ä¸­çŠ¶æ…‹ã‚’æ›¸ãè¾¼ã¿ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã§é€šçŸ¥é™¤å¤–ã«ä½¿ç”¨ï¼‰
    async function setViewingStatus(roomId) {
      if (!currentUserEmail || !roomId) return;

      try {
        const viewingRef = doc(db, 'viewingStatus', currentUserEmail);
        await setDoc(viewingRef, {
          roomId: roomId,
          lastUpdated: serverTimestamp()
        });
        console.log('[é–²è¦§çŠ¶æ…‹] Firestoreæ›´æ–°: é–²è¦§ä¸­ -', roomId);
      } catch (error) {
        console.error('[é–²è¦§çŠ¶æ…‹] Firestoreæ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ğŸ¯ Firestoreã‹ã‚‰é–²è¦§ä¸­çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
    async function clearViewingStatus() {
      if (!currentUserEmail) return;

      try {
        const viewingRef = doc(db, 'viewingStatus', currentUserEmail);
        await setDoc(viewingRef, {
          roomId: null,
          lastUpdated: serverTimestamp()
        });
        console.log('[é–²è¦§çŠ¶æ…‹] Firestoreæ›´æ–°: é–²è¦§çµ‚äº†');
      } catch (error) {
        console.error('[é–²è¦§çŠ¶æ…‹] Firestoreã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã‚’é–‹ã„ã¦ã„ã‚‹é–“ï¼‰
    async function resetUnreadCountRealtime() {
      if (!currentUserEmail || !currentRoomId) return;

      try {
        const unreadRef = doc(db, `rooms/${currentRoomId}/unreadCounts/${currentUserEmail}`);
        await setDoc(unreadRef, {
          userId: currentUserEmail,
          unreadCount: 0,
          lastReadAt: serverTimestamp()
        }, { merge: true });

        console.log('[æœªèª­] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æœªèª­ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆå®Œäº†');

        // ã‚¢ãƒ—ãƒªãƒãƒƒã‚¸ã‚‚ã‚¯ãƒªã‚¢ï¼ˆãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã‚’é–‹ã„ã¦ã„ã‚‹é–“ã¯å¸¸ã«ã‚¯ãƒªã‚¢ï¼‰
        clearAppBadge();
      } catch (error) {
        console.error('[æœªèª­] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æœªèª­ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // æ—¢èª­æ•°ã‚’è¨ˆç®—ï¼ˆè‡ªåˆ†ã‚’é™¤ãï¼‰
    function getReadCount(readBy) {
      if (!readBy || !Array.isArray(readBy)) return 0;
      // è‡ªåˆ†ã‚’é™¤ã„ãŸæ—¢èª­è€…æ•°
      return readBy.filter(email => email !== currentUserEmail).length;
    }

    // ãƒ¡ãƒ³ãƒãƒ¼ã‚¢ã‚¤ã‚³ãƒ³è¡Œã‚’æ›´æ–°ï¼ˆå±•é–‹çŠ¶æ…‹ã«å¿œã˜ã¦è¡¨ç¤ºï¼‰
    function updateMemberIconsBar(forceShow = null) {
      const bar = document.getElementById('memberIconsBar');
      const iconsContainer = document.getElementById('memberIcons');

      // å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆã®å ´åˆã¯éè¡¨ç¤º
      if (currentRoomType === 'direct' || currentRoomMembers.length === 0) {
        bar.classList.remove('show');
        return;
      }

      // å±•é–‹çŠ¶æ…‹ã«å¿œã˜ã¦ãƒãƒ¼ã‚’è¡¨ç¤º/éè¡¨ç¤º
      if (forceShow !== null) {
        memberIconsBarExpanded = forceShow;
      }

      if (memberIconsBarExpanded) {
        bar.classList.add('show');
      } else {
        bar.classList.remove('show');
      }

      // ã‚¢ã‚¤ã‚³ãƒ³ã‚’æç”»
      iconsContainer.innerHTML = '';

      // æœ€å¤§5äººã¾ã§è¡¨ç¤º
      const displayMembers = currentRoomMembers.slice(0, 5);
      displayMembers.forEach(memberName => {
        // currentRoomMembersã«ã¯åå‰ãŒå…¥ã£ã¦ã„ã‚‹ã®ã§ã€userNameã§ãƒãƒƒãƒãƒ³ã‚°
        const user = usersCache.find(u => u.userName === memberName);
        const iconUrl = user ? user.userIconUrl : null;

        console.log('[MemberIcon] memberName:', memberName, 'user:', user, 'iconUrl:', iconUrl);

        if (iconUrl) {
          const img = document.createElement('img');
          img.className = 'member-icon';
          img.src = iconUrl;
          img.alt = memberName;
          iconsContainer.appendChild(img);
        } else {
          const placeholder = document.createElement('div');
          placeholder.className = 'member-icon-placeholder';
          placeholder.textContent = (memberName || '?').charAt(0);
          iconsContainer.appendChild(placeholder);
        }
      });
    }

    // ãƒ¡ãƒ³ãƒãƒ¼ã‚¢ã‚¤ã‚³ãƒ³è¡Œã®é–‹é–‰ãƒˆã‚°ãƒ«
    window.toggleMemberIconsBar = function() {
      if (currentRoomType === 'direct') return; // å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆã§ã¯ç„¡åŠ¹
      memberIconsBarExpanded = !memberIconsBarExpanded;
      console.log('[MemberIconsBar] ãƒˆã‚°ãƒ«:', memberIconsBarExpanded, 'ãƒ¡ãƒ³ãƒãƒ¼:', currentRoomMembers, 'usersCache:', usersCache);
      updateMemberIconsBar();
    };

    // ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.openMemberModal = function() {
      document.getElementById('memberModalOverlay').classList.add('active');
      document.getElementById('memberModal').classList.add('active');
      renderMemberList();
    };

    // ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeMemberModal = function() {
      document.getElementById('memberModalOverlay').classList.remove('active');
      document.getElementById('memberModal').classList.remove('active');
      memberEditMode = false;
      document.getElementById('memberEditBtn').textContent = 'ç·¨é›†';
      // ãƒ¡ãƒ³ãƒãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
      memberIconsBarExpanded = false;
      document.getElementById('memberIconsBar').classList.remove('show');
    };

    // ========================================
    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
    // ========================================

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ã
    window.openProfilePopup = async function(userName, iconUrl) {
      console.log('[Profile Popup] é–‹ã:', userName);
      currentProfileUser = { userName, iconUrl };

      // ã‚¢ãƒã‚¿ãƒ¼è¡¨ç¤º
      const avatarContainer = document.getElementById('profilePopupAvatar');
      const initial = userName.charAt(0).toUpperCase();

      if (iconUrl) {
        avatarContainer.innerHTML = `<img src="${iconUrl}" class="profile-popup-avatar" onerror="this.outerHTML='<div class=\\'profile-popup-avatar-initial\\'>${initial}</div>'">`;
      } else {
        avatarContainer.innerHTML = `<div class="profile-popup-avatar-initial">${initial}</div>`;
      }

      // åå‰è¡¨ç¤º
      document.getElementById('profilePopupName').textContent = userName;

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èƒŒæ™¯è¨­å®šã¨æ¨©é™ã‚’å–å¾—ã—ã¦é©ç”¨
      const header = document.getElementById('profilePopupHeader');
      const statusEl = document.getElementById('profilePopupStatus');
      try {
        // usersCacheã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚’å–å¾—
        const user = usersCache.find(u => u.userName === userName);
        if (user && user.id) {
          const userRef = doc(db, 'users', user.id);
          const userSnap = await getDoc(userRef);
          if (userSnap.exists()) {
            const userData = userSnap.data();

            // æ¨©é™è¡¨ç¤ºã‚’è¨­å®š
            statusEl.textContent = userData.permissionDisplay || 'ãƒ¡ãƒ³ãƒãƒ¼';

            if (userData.profileBackground) {
              const bg = userData.profileBackground;
              if (bg.type === 'image' && bg.value) {
                header.style.backgroundImage = `url('${bg.value}')`;
                header.style.backgroundSize = 'cover';
                header.style.backgroundPosition = 'center';
                header.style.background = '';
                header.style.backgroundImage = `url('${bg.value}')`;
              } else if (bg.type === 'gradient') {
                const preset = GRADIENT_PRESETS.find(p => p.id === bg.value) || GRADIENT_PRESETS[0];
                header.style.backgroundImage = '';
                header.style.background = preset.gradient;
              }
              console.log('[Profile Popup] èƒŒæ™¯è¨­å®šé©ç”¨:', bg);
            } else {
              // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèƒŒæ™¯
              header.style.backgroundImage = '';
              header.style.background = 'linear-gradient(135deg, var(--reborn-primary), var(--reborn-primary-dark))';
            }
          } else {
            statusEl.textContent = 'ãƒ¡ãƒ³ãƒãƒ¼';
          }
        } else {
          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèƒŒæ™¯ãƒ»æ¨©é™
          header.style.backgroundImage = '';
          header.style.background = 'linear-gradient(135deg, var(--reborn-primary), var(--reborn-primary-dark))';
          statusEl.textContent = 'ãƒ¡ãƒ³ãƒãƒ¼';
        }
      } catch (error) {
        console.error('[Profile Popup] èƒŒæ™¯è¨­å®šå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèƒŒæ™¯ãƒ»æ¨©é™
        header.style.backgroundImage = '';
        header.style.background = 'linear-gradient(135deg, var(--reborn-primary), var(--reborn-primary-dark))';
        statusEl.textContent = 'ãƒ¡ãƒ³ãƒãƒ¼';
      }

      // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
      document.getElementById('profilePopupOverlay').classList.add('active');
    };

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
    window.closeProfilePopup = function(event) {
      if (event) event.stopPropagation();
      document.getElementById('profilePopupOverlay').classList.remove('active');
      currentProfileUser = null;
    };

    // ========================================
    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ï¼ˆhidden textarea ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
    // ========================================
    // iOS Safari ã® IME å•é¡Œã‚’å›é¿ã™ã‚‹ãŸã‚ã€å®Ÿéš›ã®å…¥åŠ›ã¯ hidden textarea ã§è¡Œã„ã€
    // è¡¨ç¤ºç”¨ã® div (messageInputDisplay) ã«åŒæœŸã™ã‚‹æ–¹å¼
    
    let mentionStartIndex = -1;       // @ã®ä½ç½®ï¼ˆtextarea.valueå†…ï¼‰
    let mentionQuery = '';            // @ä»¥é™ã®æ¤œç´¢ã‚¯ã‚¨ãƒª
    let selectedMentionIndex = 0;     // é¸æŠä¸­ã®å€™è£œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    let filteredMentionUsers = [];    // ãƒ•ã‚£ãƒ«ã‚¿ã•ã‚ŒãŸå€™è£œãƒ¦ãƒ¼ã‚¶ãƒ¼
    let justInsertedMention = false;  // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æŒ¿å…¥ç›´å¾Œãƒ•ãƒ©ã‚°
    let isComposing = false;          // IMEå¤‰æ›ä¸­ãƒ•ãƒ©ã‚°

    // ä¿å­˜æ¸ˆã¿ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æƒ…å ±ï¼ˆè¡¨ç¤ºç”¨divã¨åŒæœŸã™ã‚‹ãŸã‚ã«ä½¿ç”¨ï¼‰
    // å½¢å¼: [{ start: number, end: number, userName: string }, ...]
    let insertedMentions = [];

    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å…¥åŠ›ã‚’æ¤œçŸ¥ï¼ˆtextareaç”¨ï¼‰
    function checkMentionInput(textarea) {
      const text = textarea.value;
      const cursorPos = textarea.selectionStart;

      // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚ˆã‚Šå‰ã®ãƒ†ã‚­ã‚¹ãƒˆã§æœ€å¾Œã®@ã‚’æ¢ã™ï¼ˆåŠè§’ãƒ»å…¨è§’ä¸¡å¯¾å¿œï¼‰
      const textBeforeCursor = text.substring(0, cursorPos);
      // å…¨è§’@ã‚’åŠè§’@ã«å¤‰æ›ã—ã¦æ¤œç´¢
      const normalizedText = textBeforeCursor.replace(/ï¼ /g, '@');
      const lastAtIndex = normalizedText.lastIndexOf('@');

      if (lastAtIndex === -1) {
        hideMentionSuggestions();
        return;
      }

      // @ã®å‰ãŒç©ºç™½ã‹å…ˆé ­ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆæ­£è¦åŒ–å‰ã®ãƒ†ã‚­ã‚¹ãƒˆã§ç¢ºèªï¼‰
      if (lastAtIndex > 0 && !/\s/.test(normalizedText[lastAtIndex - 1])) {
        hideMentionSuggestions();
        return;
      }

      // @ä»¥é™ã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚¹ãƒšãƒ¼ã‚¹ãŒå«ã¾ã‚Œã¦ã„ãŸã‚‰ç„¡åŠ¹ï¼‰
      const queryText = normalizedText.substring(lastAtIndex + 1);
      if (/\s/.test(queryText)) {
        hideMentionSuggestions();
        return;
      }

      mentionStartIndex = lastAtIndex;
      mentionQuery = queryText.toLowerCase();

      // ãƒ¡ãƒ³ãƒãƒ¼ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      filterAndShowMentionSuggestions();
    }

    // textareaç”¨ï¼šãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
    function getPlainText(element) {
      // textareaã®å ´åˆã¯valueã‚’è¿”ã™
      if (element.tagName === 'TEXTAREA') {
        return element.value || '';
      }
      // è¡¨ç¤ºç”¨divã®å ´åˆã¯textContentã‚’è¿”ã™
      return element.textContent || '';
    }

    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚¿ã‚°ã‚’è¿½åŠ ï¼ˆã‚¿ã‚°æ–¹å¼ï¼‰
    function addMentionTag(userName) {
      const tagsContainer = document.getElementById('mentionTags');
      if (!tagsContainer) return;

      // æ—¢ã«åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ã‚°ãŒã‚ã‚Œã°è¿½åŠ ã—ãªã„
      if (insertedMentions.some(m => m.userName === userName)) {
        console.log('[Mention] æ—¢ã«è¿½åŠ æ¸ˆã¿:', userName);
        return;
      }

      // ã‚¿ã‚°è¦ç´ ã‚’ä½œæˆ
      const tag = document.createElement('span');
      tag.className = 'mention-tag';
      tag.dataset.userName = userName;
      tag.innerHTML = '@' + userName + '<button class="mention-tag-remove" type="button">Ã—</button>';

      // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
      tag.querySelector('.mention-tag-remove').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        removeMentionTag(userName);
      });

      tagsContainer.appendChild(tag);
      tagsContainer.classList.add('has-tags');

      // æŒ¿å…¥æ¸ˆã¿ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’è¨˜éŒ²
      insertedMentions.push({ userName: userName });

      console.log('[Mention] ã‚¿ã‚°è¿½åŠ :', userName);
    }

    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚¿ã‚°ã‚’å‰Šé™¤
    function removeMentionTag(userName) {
      const tagsContainer = document.getElementById('mentionTags');
      if (!tagsContainer) return;

      const tag = tagsContainer.querySelector('[data-user-name="' + userName + '"]');
      if (tag) {
        tag.remove();
      }

      // æŒ¿å…¥æ¸ˆã¿ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‹ã‚‰å‰Šé™¤
      insertedMentions = insertedMentions.filter(m => m.userName !== userName);

      // ã‚¿ã‚°ãŒãªããªã£ãŸã‚‰ã‚³ãƒ³ãƒ†ãƒŠã‚’éè¡¨ç¤º
      if (insertedMentions.length === 0) {
        tagsContainer.classList.remove('has-tags');
      }

      console.log('[Mention] ã‚¿ã‚°å‰Šé™¤:', userName);
    }

    // å…¨ã¦ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚¿ã‚°ã‚’ã‚¯ãƒªã‚¢
    function clearMentionTags() {
      const tagsContainer = document.getElementById('mentionTags');
      if (!tagsContainer) return;

      tagsContainer.innerHTML = '';
      tagsContainer.classList.remove('has-tags');
      insertedMentions = [];
    }

    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’æŒ¿å…¥ï¼ˆã‚¿ã‚°æ–¹å¼ + textareaã®@ã‚’å‰Šé™¤ï¼‰
    function insertMentionViaTextarea(userName) {
      const textarea = document.getElementById('messageInput');
      if (!textarea) return;

      // IMEå¤‰æ›ä¸­ãªã‚‰çµ‚ã‚ã‚‹ã¾ã§å¾…ã¤
      if (isComposing) {
        const capturedUserName = userName;
        const retry = function() {
          if (!isComposing) {
            insertMentionViaTextarea(capturedUserName);
          } else {
            setTimeout(retry, 20);
          }
        };
        setTimeout(retry, 20);
        return;
      }

      // textareaã‹ã‚‰@ã¨å…¥åŠ›ä¸­ã®ã‚¯ã‚¨ãƒªã‚’å‰Šé™¤
      const start = textarea.selectionStart;
      const replaceStart = mentionStartIndex >= 0 ? mentionStartIndex : start;
      const replaceEnd = start;

      console.log('[Mention] æŒ¿å…¥:', userName, 'replaceStart:', replaceStart, 'replaceEnd:', replaceEnd);

      try {
        // @ã¨å…¥åŠ›ä¸­ãƒ†ã‚­ã‚¹ãƒˆã‚’å‰Šé™¤ï¼ˆç©ºæ–‡å­—ã§ç½®æ›ï¼‰
        if (typeof textarea.setRangeText === 'function') {
          textarea.setRangeText('', replaceStart, replaceEnd, 'end');
        } else {
          const val = textarea.value;
          textarea.value = val.slice(0, replaceStart) + val.slice(replaceEnd);
          textarea.setSelectionRange(replaceStart, replaceStart);
        }
      } catch (err) {
        console.error('[Mention] ãƒ†ã‚­ã‚¹ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', err);
      }

      // ã‚¿ã‚°ã¨ã—ã¦è¿½åŠ 
      addMentionTag(userName);

      // ãƒªã‚»ãƒƒãƒˆ
      mentionStartIndex = -1;
      mentionQuery = '';
      hideMentionSuggestions();

      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç¶­æŒ
      textarea.focus();

      justInsertedMention = true;
    }

    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å†…ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºï¼ˆé€ä¿¡å¾Œã®è¡¨ç¤ºæ™‚ã®ã¿ - å…¥åŠ›ä¸­ã¯ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‰
    function highlightMentionsInInput(element) {
      // ã‚·ãƒ³ãƒ—ãƒ«textareaã§ã¯ãƒã‚¤ãƒ©ã‚¤ãƒˆãªã—ï¼ˆé€ä¿¡å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã®ã¿ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰
    }

    // textareaç”¨ï¼šæ”¹è¡Œã‚’æŒ¿å…¥
    function insertLineBreak() {
      const textarea = document.getElementById('messageInput');
      if (!textarea) return;
      
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const value = textarea.value;
      
      // æ”¹è¡Œã‚’æŒ¿å…¥
      textarea.value = value.substring(0, start) + '\n' + value.substring(end);

      // ã‚«ãƒ¼ã‚½ãƒ«ã‚’æ”¹è¡Œã®å¾Œã‚ã«ç§»å‹•
      const newPos = start + 1;
      textarea.setSelectionRange(newPos, newPos);
    }

    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å€™è£œã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦è¡¨ç¤º
    function filterAndShowMentionSuggestions() {
      // ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã¾ãŸã¯å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const users = currentRoomMembers.length > 0 ? currentRoomMembers : Object.keys(usersCache);

      if (users.length === 0) {
        hideMentionSuggestions();
        return;
      }

      // è‡ªåˆ†ã‚’é™¤å¤–ã—ã€ã‚¯ã‚¨ãƒªã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      let filtered = users.filter(userName => {
        if (userName === currentUserName) return false;
        if (mentionQuery === '') return true;
        return userName.toLowerCase().includes(mentionQuery);
      });

      // @Allï¼ˆå…¨å“¡ï¼‰ã‚’å…ˆé ­ã«è¿½åŠ ï¼ˆã‚¯ã‚¨ãƒªãŒç©ºã¾ãŸã¯"all"ã‚’å«ã‚€å ´åˆï¼‰
      const allLabel = 'All';
      if (mentionQuery === '' || allLabel.toLowerCase().includes(mentionQuery)) {
        filtered = [allLabel, ...filtered];
      }

      filteredMentionUsers = filtered;

      if (filteredMentionUsers.length === 0) {
        hideMentionSuggestions();
        return;
      }

      selectedMentionIndex = 0;
      renderMentionSuggestions();
    }

    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³é¸æŠå‡¦ç†ï¼ˆã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯å…±é€šï¼‰- hidden textarea ãƒ‘ã‚¿ãƒ¼ãƒ³
    function processMentionSelection(capturedUserName) {
      console.log('[Mention] processMentionSelection:', capturedUserName);
      
      // hidden textarea ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã¯ insertMentionViaTextarea ã‚’ä½¿ç”¨
      insertMentionViaTextarea(capturedUserName);
    }

    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å€™è£œãƒªã‚¹ãƒˆã‚’æç”»
    function renderMentionSuggestions() {
      const container = document.getElementById('mentionSuggestions');
      container.innerHTML = '';

      filteredMentionUsers.forEach((userName, index) => {
        const item = document.createElement('div');
        item.className = 'mention-suggestion-item' + (index === selectedMentionIndex ? ' selected' : '');
        item.dataset.userName = userName;

        // ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆ@Allã®å ´åˆã¯ç‰¹åˆ¥ãªã‚¢ã‚¤ã‚³ãƒ³ï¼‰
        if (userName === 'All') {
          const allIcon = document.createElement('div');
          allIcon.className = 'mention-suggestion-icon-placeholder mention-all-icon';
          allIcon.innerHTML = 'ğŸ‘¥';
          item.appendChild(allIcon);
        } else {
          const iconUrl = getUserIconUrl(userName);
          if (iconUrl) {
            const icon = document.createElement('img');
            icon.className = 'mention-suggestion-icon';
            icon.src = iconUrl;
            icon.alt = userName;
            icon.onerror = function() {
              const placeholder = document.createElement('div');
              placeholder.className = 'mention-suggestion-icon-placeholder';
              placeholder.textContent = userName.charAt(0);
              this.replaceWith(placeholder);
            };
            item.appendChild(icon);
          } else {
            const placeholder = document.createElement('div');
            placeholder.className = 'mention-suggestion-icon-placeholder';
            placeholder.textContent = userName.charAt(0);
            item.appendChild(placeholder);
          }
        }

        // åå‰ï¼ˆ@Allã®å ´åˆã¯ã€Œå…¨å“¡ã€ã¨è¡¨ç¤ºï¼‰
        const name = document.createElement('span');
        name.className = 'mention-suggestion-name';
        name.textContent = userName === 'All' ? 'å…¨å“¡ (All)' : userName;
        item.appendChild(name);

        // ã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠï¼ˆhidden textarea ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
        // é‡è¦ï¼šã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã§userNameã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
        (function(capturedUserName) {
          let touchHandled = false;

          // iOS/ãƒ¢ãƒã‚¤ãƒ«: touchstartã§å³åº§ã«å‡¦ç†
          // hidden textarea ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã¯ blur() ä¸è¦ã€ç›´æ¥æŒ¿å…¥å¯èƒ½
          item.addEventListener('touchstart', function(e) {
            e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’é˜²ã
            e.stopPropagation(); // ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’æ­¢ã‚ã‚‹
            touchHandled = true;
            console.log('[Mention] touchstartç™ºç«:', capturedUserName);
            
            // IMEå¤‰æ›ä¸­ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
            isComposing = false;
            
            // hidden textarea ãƒ‘ã‚¿ãƒ¼ãƒ³: ç›´æ¥æŒ¿å…¥ï¼ˆblurä¸è¦ï¼‰
            processMentionSelection(capturedUserName);
          }, { passive: false });

          // PC: clickï¼ˆtouchstartã§å‡¦ç†æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—ï¼‰
          item.addEventListener('click', function(e) {
            if (touchHandled) {
              touchHandled = false;
              return;
            }
            console.log('[Mention] clickç™ºç«:', capturedUserName);
            processMentionSelection(capturedUserName);
          });
        })(userName);

        container.appendChild(item);
      });

      container.classList.add('show');
    }

    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å€™è£œãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹
    function isMentionSuggestionsVisible() {
      const container = document.getElementById('mentionSuggestions');
      return container && container.classList.contains('show');
    }

    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å€™è£œã‚’éè¡¨ç¤º
    function hideMentionSuggestions() {
      const container = document.getElementById('mentionSuggestions');
      if (container) {
        container.classList.remove('show');
      }
      mentionStartIndex = -1;
      mentionQuery = '';
      filteredMentionUsers = [];
      mentionRange = null; // Rangeã‚‚ãƒªã‚»ãƒƒãƒˆ
    }

    // æ¬¡ã®å€™è£œã‚’é¸æŠ
    function selectNextMentionSuggestion() {
      if (filteredMentionUsers.length === 0) return;
      selectedMentionIndex = (selectedMentionIndex + 1) % filteredMentionUsers.length;
      renderMentionSuggestions();
    }

    // å‰ã®å€™è£œã‚’é¸æŠ
    function selectPrevMentionSuggestion() {
      if (filteredMentionUsers.length === 0) return;
      selectedMentionIndex = (selectedMentionIndex - 1 + filteredMentionUsers.length) % filteredMentionUsers.length;
      renderMentionSuggestions();
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ç›´æ¥æŒ‡å®šã—ã¦ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’æŒ¿å…¥ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
    function insertSelectedMentionByName(userName) {
      insertMentionViaTextarea(userName);
    }

    // é¸æŠã•ã‚ŒãŸãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’æŒ¿å…¥ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œç”¨ï¼‰
    function insertSelectedMention() {
      if (filteredMentionUsers.length === 0) return;
      const userName = filteredMentionUsers[selectedMentionIndex];
      insertMentionViaTextarea(userName);
    }

    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’è§£æã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒªã‚¹ãƒˆã‚’è¿”ã™
    function parseMentions(text) {
      const mentionRegex = /@([^\s@]+)/g;
      const mentions = [];
      let match;

      while ((match = mentionRegex.exec(text)) !== null) {
        const userName = match[1];
        // @All ã¯ç‰¹åˆ¥æ‰±ã„
        if (userName === 'All') {
          mentions.push('All');
        }
        // å®Ÿåœ¨ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ãƒã‚§ãƒƒã‚¯
        else if (currentRoomMembers.includes(userName) || usersCache[userName]) {
          mentions.push(userName);
        }
      }

      return [...new Set(mentions)]; // é‡è¤‡æ’é™¤
    }

    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºç”¨HTMLã«å¤‰æ›
    function highlightMentions(text, mentions) {
      if (!text || !mentions || mentions.length === 0) {
        return escapeHtml(text);
      }

      let result = escapeHtml(text);

      // å„ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      mentions.forEach(userName => {
        const escapedUserName = escapeHtml(userName);
        const regex = new RegExp(`@${escapeRegExp(escapedUserName)}(?=\\s|$)`, 'g');
        result = result.replace(regex, `<span class="mention-highlight">@${escapedUserName}</span>`);
      });

      return result;
    }

    // HTMLç‰¹æ®Šæ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // æ­£è¦è¡¨ç¾ã®ç‰¹æ®Šæ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // ãƒ¡ãƒ³ãƒãƒ¼ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
    window.toggleMemberEditMode = function() {
      memberEditMode = !memberEditMode;
      document.getElementById('memberEditBtn').textContent = memberEditMode ? 'å®Œäº†' : 'ç·¨é›†';
      renderMemberList();
    };

    // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’æç”»
    function renderMemberList() {
      const container = document.getElementById('memberList');
      const countEl = document.getElementById('memberCount');

      countEl.textContent = `ãƒ¡ãƒ³ãƒãƒ¼ ${currentRoomMembers.length}`;
      container.innerHTML = '';

      currentRoomMembers.forEach(memberName => {
        // currentRoomMembersã«ã¯åå‰ãŒå…¥ã£ã¦ã„ã‚‹ã®ã§ã€userNameã§ãƒãƒƒãƒãƒ³ã‚°
        const user = usersCache.find(u => u.userName === memberName);
        const iconUrl = user ? user.userIconUrl : null;

        const item = document.createElement('div');
        item.className = 'member-list-item' + (memberEditMode ? ' edit-mode' : '');

        if (iconUrl) {
          const img = document.createElement('img');
          img.className = 'avatar';
          img.src = iconUrl;
          img.alt = memberName;
          item.appendChild(img);
        } else {
          const placeholder = document.createElement('div');
          placeholder.className = 'avatar-placeholder';
          placeholder.textContent = (memberName || '?').charAt(0);
          item.appendChild(placeholder);
        }

        const info = document.createElement('div');
        info.className = 'info';
        info.innerHTML = `<div class="name">${memberName}</div>`;
        item.appendChild(info);

        // å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿è¡¨ç¤ºã€è‡ªåˆ†ä»¥å¤–ã®ã¿å‰Šé™¤å¯èƒ½ï¼‰
        if (memberName !== currentUserName) {
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'delete-btn';
          deleteBtn.textContent = 'âˆ’';
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            removeMember(memberName);
          };
          item.appendChild(deleteBtn);
        }

        container.appendChild(item);
      });
    }

    // æ‹›å¾…ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.openInviteModal = function() {
      document.getElementById('inviteModalOverlay').classList.add('active');
      document.getElementById('inviteModal').classList.add('active');
      renderInviteList();
    };

    // æ‹›å¾…ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeInviteModal = function() {
      document.getElementById('inviteModalOverlay').classList.remove('active');
      document.getElementById('inviteModal').classList.remove('active');
    };

    // æ‹›å¾…å¯èƒ½ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’æç”»
    function renderInviteList() {
      const container = document.getElementById('inviteUserList');
      container.innerHTML = '';

      usersCache.forEach(user => {
        // currentRoomMembersã«ã¯åå‰ãŒå…¥ã£ã¦ã„ã‚‹ã®ã§ã€userNameã§ãƒãƒƒãƒãƒ³ã‚°
        const userName = user.userName;
        const userIconUrl = user.userIconUrl;
        const isMember = currentRoomMembers.includes(userName);

        const item = document.createElement('div');
        item.className = 'invite-user-item' + (isMember ? ' disabled' : '');

        if (userIconUrl) {
          const img = document.createElement('img');
          img.className = 'avatar';
          img.src = userIconUrl;
          img.alt = userName;
          img.style.cssText = 'width: 40px; height: 40px; border-radius: 50%; object-fit: cover;';
          item.appendChild(img);
        } else {
          const placeholder = document.createElement('div');
          placeholder.className = 'avatar-placeholder';
          placeholder.textContent = (userName || '?').charAt(0);
          item.appendChild(placeholder);
        }

        const info = document.createElement('div');
        info.className = 'info';
        if (isMember) {
          info.innerHTML = `<div class="name">${userName}</div><div class="already-member">ã™ã§ã«ãƒ¡ãƒ³ãƒãƒ¼ã§ã™</div>`;
        } else {
          info.innerHTML = `<div class="name">${userName}</div>`;
        }
        item.appendChild(info);

        if (!isMember) {
          item.onclick = () => addMember(userName);
        }

        container.appendChild(item);
      });
    }

    // ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ ï¼ˆåå‰ãƒ™ãƒ¼ã‚¹ï¼‰
    async function addMember(memberName) {
      if (!currentRoomId || currentRoomMembers.includes(memberName)) return;

      try {
        const roomRef = doc(db, 'rooms', currentRoomId);
        await updateDoc(roomRef, {
          members: arrayUnion(memberName)
        });

        // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
        await addDoc(collection(db, `rooms/${currentRoomId}/messages`), {
          text: `${currentUserName} ãŒ ${memberName} ã‚’ã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ ã—ã¾ã—ãŸã€‚`,
          userName: 'ã‚·ã‚¹ãƒ†ãƒ ',
          userEmail: 'system@furira.com',
          timestamp: serverTimestamp(),
          type: 'system'
        });

        // ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‚’æ›´æ–°
        currentRoomMembers.push(memberName);
        currentRoomMemberCount = currentRoomMembers.length;

        closeInviteModal();
        renderMemberList();
        updateMemberIconsBar();

        console.log('[Member] ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ å®Œäº†:', memberName);
      } catch (error) {
        console.error('[Member] ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ¡ãƒ³ãƒãƒ¼ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‰Šé™¤ï¼ˆåå‰ãƒ™ãƒ¼ã‚¹ï¼‰
    async function removeMember(memberName) {
      if (!currentRoomId || !currentRoomMembers.includes(memberName)) return;

      if (!confirm(`${memberName} ã‚’ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

      try {
        const roomRef = doc(db, 'rooms', currentRoomId);
        await updateDoc(roomRef, {
          members: arrayRemove(memberName)
        });

        // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
        await addDoc(collection(db, `rooms/${currentRoomId}/messages`), {
          text: `${currentUserName} ãŒ ${memberName} ã‚’ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸã€‚`,
          userName: 'ã‚·ã‚¹ãƒ†ãƒ ',
          userEmail: 'system@furira.com',
          timestamp: serverTimestamp(),
          type: 'system'
        });

        // ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‚’æ›´æ–°
        currentRoomMembers = currentRoomMembers.filter(name => name !== memberName);
        currentRoomMemberCount = currentRoomMembers.length;

        renderMemberList();
        updateMemberIconsBar();

        console.log('[Member] ãƒ¡ãƒ³ãƒãƒ¼å‰Šé™¤å®Œäº†:', memberName);
      } catch (error) {
        console.error('[Member] ãƒ¡ãƒ³ãƒãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ¡ãƒ³ãƒãƒ¼ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†ãƒ•ãƒ©ã‚°ï¼ˆæ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¼•ãç¶™ãç”¨ï¼‰
    let isFirstMessageLoad = true;
    // åˆå›èª­ã¿è¾¼ã¿ãƒ•ãƒ©ã‚°ï¼ˆå…¨ä½“æç”» vs å·®åˆ†æ›´æ–°ã®åˆ¤å®šç”¨ï¼‰
    let isInitialLoad = true;

    // æ—¢èª­ãƒ©ãƒ™ãƒ«ã ã‘ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚·ãƒ•ãƒˆé˜²æ­¢ï¼‰
    function updateReadStatusOnly(msgId, readBy) {
      const msgElement = document.querySelector(`[data-message-id="${msgId}"]`);
      if (!msgElement) return;
      
      const readStatusEl = msgElement.querySelector('.message-read-status');
      if (!readStatusEl) return;
      
      const readCount = getReadCount(readBy);
      if (readCount > 0) {
        if (currentRoomType === 'direct') {
          readStatusEl.textContent = 'æ—¢èª­';
        } else {
          readStatusEl.textContent = `æ—¢èª­ ${readCount}`;
        }
        readStatusEl.style.visibility = 'visible';
      }
    }

    // ãƒ–ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆLINEé¢¨ï¼‰
    async function checkBlockStatus() {
      // å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆä»¥å¤–ã¯ãƒ–ãƒ­ãƒƒã‚¯æ©Ÿèƒ½ãªã—
      if (currentRoomType !== 'direct' || !currentUserEmail) {
        isBlockedByMe = false;
        isBlockedByOther = false;
        return;
      }

      try {
        // ãƒ«ãƒ¼ãƒ æƒ…å ±ã‹ã‚‰ç›¸æ‰‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
        const roomRef = doc(db, 'rooms', currentRoomId);
        const roomDoc = await getDoc(roomRef);
        if (!roomDoc.exists()) return;

        const roomData = roomDoc.data();
        if (!roomData.members || !Array.isArray(roomData.members)) return;

        // ãƒ¡ãƒ³ãƒãƒ¼ã«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒå…¥ã£ã¦ã„ã‚‹ï¼ˆãƒ¡ãƒ¼ãƒ«ã§ã¯ãªã„ï¼‰
        // currentUserNameã¨æ¯”è¼ƒã—ã¦ç›¸æ‰‹ã‚’ç‰¹å®š
        otherUserEmail = roomData.members.find(m => m !== currentUserName) || '';
        console.log('[Block] ç›¸æ‰‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å:', otherUserEmail);

        if (!otherUserEmail) return;

        // è‡ªåˆ†ãŒç›¸æ‰‹ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        const myUserRef = doc(db, 'users', currentUserEmail);
        const myUserDoc = await getDoc(myUserRef);
        if (myUserDoc.exists()) {
          const myData = myUserDoc.data();
          let myBlockedList = myData.blockedUsers || [];

          // è‡ªåˆ†è‡ªèº«ãŒãƒ–ãƒ­ãƒƒã‚¯ãƒªã‚¹ãƒˆã«å…¥ã£ã¦ã„ã‚‹å ´åˆã¯ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          const selfInList = myBlockedList.some(u => u === currentUserName || u === currentUserEmail);
          if (selfInList) {
            console.log('[Block] âš ï¸ è‡ªåˆ†è‡ªèº«ãŒãƒ–ãƒ­ãƒƒã‚¯ãƒªã‚¹ãƒˆã«å…¥ã£ã¦ã„ã¾ã™ã€‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã™...');
            // Firestoreã‹ã‚‰è‡ªåˆ†ã‚’å‰Šé™¤
            await updateDoc(myUserRef, {
              blockedUsers: arrayRemove(currentUserName)
            });
            await updateDoc(myUserRef, {
              blockedUsers: arrayRemove(currentUserEmail)
            });
            // ãƒ­ãƒ¼ã‚«ãƒ«ãƒªã‚¹ãƒˆã‹ã‚‰ã‚‚é™¤å¤–
            myBlockedList = myBlockedList.filter(u => u !== currentUserName && u !== currentUserEmail);
            console.log('[Block] âœ… è‡ªåˆ†è‡ªèº«ã‚’ãƒ–ãƒ­ãƒƒã‚¯ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ');
          }

          isBlockedByMe = myBlockedList.includes(otherUserEmail);
          console.log('[Block] è‡ªåˆ†â†’ç›¸æ‰‹ãƒ–ãƒ­ãƒƒã‚¯:', isBlockedByMe);
        }

        // ç›¸æ‰‹ãŒè‡ªåˆ†ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        // æ³¨æ„: usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚­ãƒ¼ã«ã—ã¦ã„ã‚‹ãŸã‚ã€
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‹ã‚‰ã¯æ¤œç´¢ã§ããªã„ã€‚isBlockedByOtherã¯å¸¸ã«falseã€‚
        // LINEã¨åŒæ§˜ã€ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå´ã¯æ°—ã¥ã‹ãªã„ä»•æ§˜ã€‚
        isBlockedByOther = false;
        console.log('[Block] ç›¸æ‰‹â†’è‡ªåˆ†ãƒ–ãƒ­ãƒƒã‚¯: ãƒã‚§ãƒƒã‚¯çœç•¥ï¼ˆãƒ¡ãƒ¼ãƒ«ä¸æ˜ï¼‰');

        // UIã‚’æ›´æ–°
        updateBlockedUI();

      } catch (error) {
        console.error('[Block] ãƒ–ãƒ­ãƒƒã‚¯çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ãƒ–ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã«å¿œã˜ãŸUIæ›´æ–°
    function updateBlockedUI() {
      const inputContainer = document.querySelector('.input-container');
      const blockedBanner = document.getElementById('blockedBanner');

      if (isBlockedByMe) {
        // è‡ªåˆ†ãŒç›¸æ‰‹ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ã‚‹å ´åˆ
        // å…¥åŠ›æ¬„ã‚’éè¡¨ç¤ºã€ãƒãƒŠãƒ¼è¡¨ç¤º
        if (inputContainer) inputContainer.style.display = 'none';
        if (blockedBanner) {
          blockedBanner.textContent = 'ãƒ–ãƒ­ãƒƒã‚¯ä¸­ã®ãŸã‚ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã§ãã¾ã›ã‚“';
          blockedBanner.style.display = 'flex';
        }
        console.log('[Block] UIæ›´æ–°: ãƒ–ãƒ­ãƒƒã‚¯ä¸­è¡¨ç¤º');
      } else if (isBlockedByOther) {
        // ç›¸æ‰‹ãŒè‡ªåˆ†ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ã‚‹å ´åˆï¼ˆLINEã¨åŒæ§˜ã€æ˜ç¤ºçš„ã«ã¯è¡¨ç¤ºã—ãªã„ï¼‰
        // é€ä¿¡æ™‚ã«ã‚¨ãƒ©ãƒ¼ã«ã™ã‚‹
        console.log('[Block] UIæ›´æ–°: ç›¸æ‰‹ã«ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ï¼ˆé€ä¿¡æ™‚ã«ç„¡åŠ¹åŒ–ï¼‰');
      } else {
        // ãƒ–ãƒ­ãƒƒã‚¯ãªã— - CSSã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºã«æˆ»ã™
        if (inputContainer) inputContainer.style.display = '';
        if (blockedBanner) blockedBanner.style.display = 'none';
      }
    }

    // Firestoreãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒ‹ãƒ³ã‚°
    async function startListening() {
      // å…ˆã«ãƒ–ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
      await checkBlockStatus();

      const q = query(
        collection(db, `rooms/${currentRoomId}/messages`),
        orderBy('timestamp', 'desc'),
        limit(50)
      );

      onSnapshot(q, (snapshot) => {
        console.log('[Firestore] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°:', snapshot.size + 'ä»¶');

        const container = document.getElementById('messagesContainer');

        // å¤‰æ›´ã‚¿ã‚¤ãƒ—ã‚’åˆ†æï¼ˆæ—¢èª­æ›´æ–°ã®ã¿ã‹ã©ã†ã‹åˆ¤å®šï¼‰
        const changes = snapshot.docChanges();
        const isReadOnlyUpdate = !isInitialLoad && changes.length > 0 && changes.every(change => {
          // 'modified' ã§ã€ã‹ã¤ readBy ã®ã¿ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆ
          return change.type === 'modified';
        });

        // æ—¢èª­æ›´æ–°ã®ã¿ã®å ´åˆã¯å·®åˆ†æ›´æ–°ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚·ãƒ•ãƒˆé˜²æ­¢ï¼‰
        if (isReadOnlyUpdate) {
          console.log('[Firestore] æ—¢èª­æ›´æ–°ã®ã¿ - å·®åˆ†æ›´æ–°');
          changes.forEach(change => {
            if (change.type === 'modified') {
              const msgData = { id: change.doc.id, ...change.doc.data() };
              updateReadStatusOnly(msgData.id, msgData.readBy);
            }
          });
          return;
        }

        // åˆå›ã¾ãŸã¯æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚‹å ´åˆã¯å…¨ä½“ã‚’å†æç”»
        console.log('[Firestore] å…¨ä½“å†æç”»');
        isInitialLoad = false;
        container.innerHTML = '';

        // æ–°ã—ã„é †ã§å–å¾—ã—ãŸã®ã§ã€é€†é †ã§è¡¨ç¤º
        const messages = [];
        const unreadMessageIds = []; // æœªèª­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸IDã‚’åé›†
        snapshot.forEach((doc) => {
          const msgData = { id: doc.id, ...doc.data() };

          // ãƒ–ãƒ­ãƒƒã‚¯ä¸­ã®ç›¸æ‰‹ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆLINEé¢¨ï¼‰
          if (isBlockedByMe) {
            // ãƒ‡ãƒãƒƒã‚°ï¼šæ¯”è¼ƒå¯¾è±¡ã‚’è¡¨ç¤º
            console.log('[Block Debug] isBlockedByMe:', isBlockedByMe);
            console.log('[Block Debug] otherUserEmail (blocked target):', otherUserEmail);
            console.log('[Block Debug] msgData.userName:', msgData.userName);
            console.log('[Block Debug] msgData.userEmail:', msgData.userEmail);

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«ã§æ¯”è¼ƒï¼ˆå¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥ã—ãªã„ï¼‰
            const blockedName = (otherUserEmail || '').trim().toLowerCase();
            const msgUserName = (msgData.userName || '').trim().toLowerCase();
            const msgUserEmail = (msgData.userEmail || '').trim().toLowerCase();

            if (blockedName === msgUserName || blockedName === msgUserEmail) {
              console.log('[Block] âœ… ãƒ–ãƒ­ãƒƒã‚¯ä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¹ã‚­ãƒƒãƒ—:', msgData.id, msgData.userName);
              return; // ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è¡¨ç¤ºã—ãªã„
            } else {
              console.log('[Block] âš ï¸ æ¯”è¼ƒä¸ä¸€è‡´ - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è¡¨ç¤ºã•ã‚Œã‚‹');
            }
          }

          messages.unshift(msgData);

          // è‡ªåˆ†ä»¥å¤–ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã€ã¾ã è‡ªåˆ†ãŒæ—¢èª­ã«ã—ã¦ã„ãªã„ã‚‚ã®
          if (msgData.userEmail !== currentUserEmail) {
            const readBy = msgData.readBy || [];
            if (!readBy.includes(currentUserEmail)) {
              unreadMessageIds.push(doc.id);
            }
          }
        });

        // æ—¥ä»˜ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ã‚’æŒ¿å…¥ã—ãªãŒã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        let lastDateStr = null;
        messages.forEach((msg) => {
          // æ—¥ä»˜ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ã®æŒ¿å…¥
          if (msg.timestamp && msg.timestamp.toDate) {
            const msgDate = msg.timestamp.toDate();
            const dateStr = formatDateForSeparator(msgDate);
            if (dateStr !== lastDateStr) {
              appendDateSeparator(dateStr);
              lastDateStr = dateStr;
            }
          }
          appendMessage(msg);
        });

        // æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        container.scrollTop = container.scrollHeight;

        // å›ºå®šæ—¥ä»˜ãƒãƒƒã‚¸ã‚’æ›´æ–°ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ï¼‰
        setTimeout(() => {
          container.dispatchEvent(new Event('scroll'));
        }, 100);

        // æœªèª­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°æ—¢èª­ã«ã™ã‚‹
        if (unreadMessageIds.length > 0) {
          markMessagesAsRead(unreadMessageIds);
          
          // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚‚ãƒªã‚»ãƒƒãƒˆï¼ˆãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã‚’é–‹ã„ã¦ã„ã‚‹é–“ã¯å¸¸ã«0ï¼‰
          resetUnreadCountRealtime();
        }

        // ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã‚’é–‹ã„ã¦ã„ã‚‹é–“ã¯å¸¸ã«ãƒãƒƒã‚¸ã‚’ã‚¯ãƒªã‚¢ï¼ˆé€šçŸ¥ã§å¢—ãˆãŸåˆ†ã‚’ãƒªã‚»ãƒƒãƒˆï¼‰
        clearAppBadge();

        // åˆå›èª­ã¿è¾¼ã¿æ™‚ã€æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå¼•ãç¶™ãŒã‚Œã¦ã„ãŸã‚‰è‡ªå‹•æ¤œç´¢ã‚’å®Ÿè¡Œ
        if (isFirstMessageLoad && searchQueryParam) {
          isFirstMessageLoad = false;
          console.log('[Search] æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¼•ãç¶™ã:', searchQueryParam);
          setTimeout(() => {
            // æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹ã
            openSearchMode();
            // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚»ãƒƒãƒˆ
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
              searchInput.value = searchQueryParam;
              // æ¤œç´¢ã‚’å®Ÿè¡Œ
              searchMessages();
            }
          }, 300);  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æç”»å®Œäº†ã‚’å¾…ã¤
        } else if (isFirstMessageLoad) {
          isFirstMessageLoad = false;
        }
      }, (error) => {
        console.error('[Firestore] ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å—ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      });
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // æ—¥ä»˜ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ç”¨ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆLINEé¢¨: 11/26(ç«)ï¼‰
    function formatDateForSeparator(date) {
      const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const dow = dayOfWeek[date.getDay()];
      
      // ä»Šæ—¥ãƒ»æ˜¨æ—¥ã®åˆ¤å®š
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      
      const isToday = date.toDateString() === today.toDateString();
      const isYesterday = date.toDateString() === yesterday.toDateString();
      
      if (isToday) {
        return 'ä»Šæ—¥';
      } else if (isYesterday) {
        return 'æ˜¨æ—¥';
      } else {
        return `${month}/${day}(${dow})`;
      }
    }

    // æ—¥ä»˜ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ã‚’UIã«è¿½åŠ 
    function appendDateSeparator(dateStr) {
      const container = document.getElementById('messagesContainer');
      const separator = document.createElement('div');
      separator.className = 'date-separator';
      separator.dataset.date = dateStr; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç›£è¦–ç”¨
      
      const badge = document.createElement('span');
      badge.className = 'date-separator-badge';
      badge.textContent = dateStr;
      
      separator.appendChild(badge);
      container.appendChild(separator);
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’UIã«è¿½åŠ 
    function appendMessage(msg) {
      const container = document.getElementById('messagesContainer');

      const item = document.createElement('div');

      // msg.userNameã‚‚JSON.parseã—ã¦æ­£è¦åŒ–ï¼ˆå¤ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¯¾å¿œï¼‰
      // senderNameãŒã‚ã‚‹å ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆindex.htmlã®sendSystemChatMessageæ—§ä»•æ§˜å¯¾å¿œï¼‰
      let messageUserName = msg.userName || msg.senderName;
      try {
        // ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ãƒ‘ãƒ¼ã‚¹
        if (typeof messageUserName === 'string' && messageUserName.startsWith('"') && messageUserName.endsWith('"')) {
          messageUserName = JSON.parse(messageUserName);
        }
      } catch (e) {
        // ãƒ‘ãƒ¼ã‚¹ã§ããªã„å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
      }

      // è‡ªåˆ†ãŒå‰Šé™¤ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ­£è¦åŒ–ã—ãŸcurrentUserNameã§åˆ¤å®šï¼‰
      if (msg.deletedBy) {
        // deletedByé…åˆ—ã®å„è¦ç´ ã‚‚æ­£è¦åŒ–ã—ã¦æ¯”è¼ƒ
        const normalizedDeletedBy = msg.deletedBy.map(name => {
          try {
            if (typeof name === 'string' && name.startsWith('"') && name.endsWith('"')) {
              return JSON.parse(name);
            }
            return name;
          } catch (e) {
            return name;
          }
        });

        if (normalizedDeletedBy.includes(currentUserName)) {
          return;
        }
      }

      // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯ç‰¹åˆ¥ãªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆLINEé¢¨ã‚»ãƒ³ã‚¿ãƒ¼é…ç½®ï¼‰
      if (messageUserName === 'ã‚·ã‚¹ãƒ†ãƒ ') {
        item.className = 'message-item message-item-system';
        item.dataset.messageId = msg.id;

        const systemContainer = document.createElement('div');
        systemContainer.className = 'system-message-container';

        // æ™‚é–“
        const time = document.createElement('span');
        time.className = 'system-time';
        if (msg.timestamp && msg.timestamp.toDate) {
          const date = msg.timestamp.toDate();
          const hours = String(date.getHours()).padStart(2, '0');
          const minutes = String(date.getMinutes()).padStart(2, '0');
          time.textContent = `${hours}:${minutes}`;
        }
        systemContainer.appendChild(time);

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ–ãƒ«
        const bubble = document.createElement('div');
        bubble.className = 'system-bubble';
        bubble.textContent = msg.text || '';
        systemContainer.appendChild(bubble);

        item.appendChild(systemContainer);
        container.appendChild(item);
        return;
      }

      // è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ä»–äººã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã§åˆ†å²
      const isMine = messageUserName === currentUserName;

      item.className = isMine ? 'message-item message-item-mine' : 'message-item message-item-other';
      item.dataset.messageId = msg.id;

      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼ˆé¸æŠãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'message-checkbox';
      checkbox.dataset.messageId = msg.id;
      checkbox.addEventListener('change', updateSelectionCount);
      item.appendChild(checkbox);

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒ³ãƒˆï¼ˆã‚¢ã‚¤ã‚³ãƒ³ + ãƒ©ãƒƒãƒ‘ãƒ¼ï¼‰
      const content = document.createElement('div');
      content.className = 'message-content';

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆLINEé¢¨ï¼‰- ç›¸æ‰‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿è¡¨ç¤º
      if (!isMine) {
        const iconUrl = getUserIconUrl(messageUserName);
        if (iconUrl) {
          // ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒãŒã‚ã‚‹å ´åˆ
          const icon = document.createElement('img');
          icon.className = 'user-icon';
          icon.src = iconUrl;
          icon.alt = messageUserName || 'åŒ¿å';
          icon.onerror = function() {
            // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
            const placeholder = document.createElement('div');
            placeholder.className = 'user-icon-placeholder';
            placeholder.textContent = (messageUserName || 'åŒ¿').charAt(0);
            placeholder.onclick = () => openProfilePopup(messageUserName, null);
            this.replaceWith(placeholder);
          };
          // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ã
          icon.onclick = () => openProfilePopup(messageUserName, iconUrl);
          content.appendChild(icon);
        } else {
          // ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒãŒãªã„å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
          const placeholder = document.createElement('div');
          placeholder.className = 'user-icon-placeholder';
          placeholder.textContent = (messageUserName || 'åŒ¿').charAt(0);
          // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ã
          placeholder.onclick = () => openProfilePopup(messageUserName, null);
          content.appendChild(placeholder);
        }
      }

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆãƒãƒ–ãƒ« + æ™‚é–“ï¼‰
      const wrapper = document.createElement('div');
      wrapper.className = 'message-wrapper';

      // ãƒãƒ–ãƒ«ã‚³ãƒ³ãƒ†ãƒŠï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å + ãƒãƒ–ãƒ« ã‚’ç¸¦ã«é…ç½®ï¼‰
      const bubbleContainer = document.createElement('div');
      bubbleContainer.className = 'bubble-container';

      // ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆæ™‚ã€ç›¸æ‰‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¡¨ç¤º
      if (!isMine && currentRoomType !== 'direct') {
        const sender = document.createElement('div');
        sender.className = 'message-sender show-in-group';
        sender.textContent = messageUserName || 'åŒ¿å';
        bubbleContainer.appendChild(sender);
      }

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ–ãƒ«
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';

      // ãƒªãƒ—ãƒ©ã‚¤ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆLINEé¢¨ï¼‰
      if (msg.replyTo && msg.replyTo.userName) {
        const replyHeader = document.createElement('div');
        replyHeader.className = 'message-reply-header';

        // ãƒªãƒ—ãƒ©ã‚¤å…ˆã®ã‚¢ã‚¤ã‚³ãƒ³
        const replyIconUrl = msg.replyTo.userIcon || getUserIconUrl(msg.replyTo.userName);
        if (replyIconUrl) {
          const replyIcon = document.createElement('img');
          replyIcon.className = 'reply-header-icon';
          replyIcon.src = replyIconUrl;
          replyIcon.alt = msg.replyTo.userName;
          replyIcon.onerror = function() {
            const placeholder = document.createElement('div');
            placeholder.className = 'reply-header-icon-placeholder';
            placeholder.textContent = (msg.replyTo.userName || '?').charAt(0);
            this.replaceWith(placeholder);
          };
          replyHeader.appendChild(replyIcon);
        } else {
          const placeholder = document.createElement('div');
          placeholder.className = 'reply-header-icon-placeholder';
          placeholder.textContent = (msg.replyTo.userName || '?').charAt(0);
          replyHeader.appendChild(placeholder);
        }

        // ãƒªãƒ—ãƒ©ã‚¤å…ˆã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
        const replyContent = document.createElement('div');
        replyContent.className = 'reply-header-content';

        const replyUser = document.createElement('div');
        replyUser.className = 'reply-header-user';
        replyUser.textContent = msg.replyTo.userName;

        const replyText = document.createElement('div');
        replyText.className = 'reply-header-text';
        replyText.textContent = msg.replyTo.text || '';

        replyContent.appendChild(replyUser);
        replyContent.appendChild(replyText);
        replyHeader.appendChild(replyContent);

        // ãƒªãƒ—ãƒ©ã‚¤ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚¿ãƒƒãƒ—ã§ãƒªãƒ—ãƒ©ã‚¤å…ƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚¸ãƒ£ãƒ³ãƒ—
        replyHeader.addEventListener('click', function(e) {
          e.stopPropagation(); // é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé–‹ã‹ãªã„ã‚ˆã†ã«
          scrollToMessage(msg.replyTo.messageId);
        });

        bubble.appendChild(replyHeader);
      }

      // ãƒ‡ãƒãƒƒã‚°: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ã‚’ç¢ºèª
      console.log('[Message] id:', msg.id, 'type:', msg.type, 'voiceUrl:', msg.voiceUrl, 'text:', msg.text?.substring(0, 20));

      // å–ã‚Šæ¶ˆã—æ¸ˆã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆ
      if (msg.deleted === true) {
        bubble.classList.add('deleted');
        const text = document.createElement('div');
        text.className = 'message-text';
        text.textContent = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå–ã‚Šæ¶ˆã•ã‚Œã¾ã—ãŸ';
        bubble.appendChild(text);
      }
      // ç”»åƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆ
      else if (msg.type === 'image' && msg.fileUrl) {
        const img = document.createElement('img');
        img.className = 'message-image';
        img.src = msg.fileUrl;
        img.alt = msg.fileName || 'ç”»åƒ';
        img.loading = 'lazy';
        // ç”»åƒã‚¯ãƒªãƒƒã‚¯ã§ç”»åƒãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã‚’è¡¨ç¤º
        img.onclick = function() {
          openImageViewer(msg.fileUrl);
        };
        bubble.appendChild(img);

        // ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆï¼‰
        if (msg.text && msg.text.trim()) {
          const caption = document.createElement('div');
          caption.className = 'message-text';
          caption.textContent = msg.text;
          bubble.appendChild(caption);
        }
      }
      // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆ
      else if (msg.type === 'file' && msg.fileUrl) {
        const fileLink = document.createElement('a');
        fileLink.className = 'message-file-link';
        fileLink.href = msg.fileUrl;
        fileLink.target = '_blank';
        fileLink.download = msg.fileName || 'file';

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¤ã‚³ãƒ³
        const fileIcon = document.createElement('div');
        fileIcon.className = 'message-file-icon';
        fileIcon.innerHTML = '<i class="bi bi-file-earmark-fill"></i>';

        // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±
        const fileInfo = document.createElement('div');
        fileInfo.className = 'message-file-info';

        const fileName = document.createElement('div');
        fileName.className = 'message-file-name';
        fileName.textContent = msg.fileName || 'ãƒ•ã‚¡ã‚¤ãƒ«';

        const fileSize = document.createElement('div');
        fileSize.className = 'message-file-size';
        fileSize.textContent = formatFileSize(msg.fileSize || 0);

        fileInfo.appendChild(fileName);
        fileInfo.appendChild(fileSize);

        fileLink.appendChild(fileIcon);
        fileLink.appendChild(fileInfo);
        bubble.appendChild(fileLink);

        // ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆï¼‰
        if (msg.text && msg.text.trim()) {
          const caption = document.createElement('div');
          caption.className = 'message-text';
          caption.textContent = msg.text;
          bubble.appendChild(caption);
        }
      }
      // éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆ
      else if (msg.type === 'voice' && msg.voiceUrl) {
        console.log('[Voice] éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º:', msg.id, msg.voiceUrl, msg.voiceDuration);
        const voiceContainer = document.createElement('div');
        voiceContainer.className = 'voice-message' + (isMine ? ' sent' : '');
        
        // å†ç”Ÿãƒœã‚¿ãƒ³
        const playBtn = document.createElement('button');
        playBtn.className = 'voice-play-btn';
        playBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
        playBtn.dataset.voiceUrl = msg.voiceUrl;
        playBtn.dataset.msgId = msg.id;
        playBtn.onclick = function(e) {
          e.stopPropagation();
          toggleVoicePlayback(msg.voiceUrl, msg.id, playBtn);
        };
        
        // éŸ³å£°æƒ…å ±
        const voiceInfo = document.createElement('div');
        voiceInfo.className = 'voice-info';
        
        // æ³¢å½¢ï¼ˆç°¡æ˜“è¡¨ç¤ºï¼‰
        const waveform = document.createElement('div');
        waveform.className = 'voice-waveform';
        // ãƒ©ãƒ³ãƒ€ãƒ ãªé«˜ã•ã®æ³¢å½¢ãƒãƒ¼ã‚’ç”Ÿæˆ
        const barHeights = [12, 18, 24, 16, 20, 14, 22, 18, 12, 16, 20, 24, 18, 14];
        barHeights.forEach(h => {
          const bar = document.createElement('div');
          bar.className = 'voice-waveform-bar';
          bar.style.height = h + 'px';
          waveform.appendChild(bar);
        });
        
        // å†ç”Ÿæ™‚é–“
        const duration = document.createElement('span');
        duration.className = 'voice-duration';
        duration.id = 'voiceDuration_' + msg.id;
        const mins = Math.floor((msg.voiceDuration || 0) / 60);
        const secs = (msg.voiceDuration || 0) % 60;
        duration.textContent = mins + ':' + String(secs).padStart(2, '0');
        
        voiceInfo.appendChild(waveform);
        voiceInfo.appendChild(duration);
        
        voiceContainer.appendChild(playBtn);
        voiceContainer.appendChild(voiceInfo);
        bubble.appendChild(voiceContainer);
      }
      // ãƒãƒ¼ãƒˆå…±æœ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆ
      else if (msg.type === 'note-share' && msg.noteShareData) {
        const noteCard = document.createElement('div');
        noteCard.className = 'note-share-card';
        noteCard.onclick = function() {
          window.open(msg.noteShareData.url, '_blank');
        };

        // ãƒãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³
        const noteIcon = document.createElement('div');
        noteIcon.className = 'note-share-icon';
        noteIcon.innerHTML = '<i class="bi bi-journal-text"></i>';
        noteCard.appendChild(noteIcon);

        // ãƒãƒ¼ãƒˆæƒ…å ±
        const noteInfo = document.createElement('div');
        noteInfo.className = 'note-share-info';

        const noteLabel = document.createElement('div');
        noteLabel.className = 'note-share-label';
        noteLabel.textContent = 'ãƒãƒ¼ãƒˆã‚’å…±æœ‰ã—ã¾ã—ãŸ';

        const noteTitle = document.createElement('div');
        noteTitle.className = 'note-share-title';
        noteTitle.textContent = msg.noteShareData.title || 'ç„¡é¡Œã®ãƒãƒ¼ãƒˆ';

        noteInfo.appendChild(noteLabel);
        noteInfo.appendChild(noteTitle);
        noteCard.appendChild(noteInfo);

        // çŸ¢å°ã‚¢ã‚¤ã‚³ãƒ³
        const noteArrow = document.createElement('div');
        noteArrow.className = 'note-share-arrow';
        noteArrow.innerHTML = '<i class="bi bi-chevron-right"></i>';
        noteCard.appendChild(noteArrow);

        bubble.appendChild(noteCard);
      }
      // é€šè©±å±¥æ­´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆ
      else if (msg.type === 'call') {
        const callCard = document.createElement('div');
        callCard.className = 'call-history-card';

        // é€šè©±ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªé»’ï¼‰
        const callIcon = document.createElement('div');
        callIcon.className = 'call-history-icon';
        callIcon.innerHTML = '<i class="bi bi-telephone-fill"></i>';
        callCard.appendChild(callIcon);

        // é€šè©±æƒ…å ±
        const callInfo = document.createElement('div');
        callInfo.className = 'call-history-info';

        const callLabel = document.createElement('div');
        callLabel.className = 'call-history-label';
        callLabel.textContent = 'é€šè©±çµ‚äº†';

        const callDuration = document.createElement('div');
        callDuration.className = 'call-history-duration';
        // é€šè©±æ™‚é–“ã‚’è¡¨ç¤º
        if (msg.callDuration) {
          const minutes = Math.floor(msg.callDuration / 60);
          const seconds = msg.callDuration % 60;
          callDuration.textContent = minutes > 0 ? `${minutes}åˆ†${seconds}ç§’` : `${seconds}ç§’`;
        } else {
          // å¤ã„å½¢å¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ãƒ‘ãƒ¼ã‚¹
          const match = (msg.text || '').match(/\((.+)\)/);
          callDuration.textContent = match ? match[1] : '';
        }

        callInfo.appendChild(callLabel);
        callInfo.appendChild(callDuration);
        callCard.appendChild(callInfo);

        bubble.appendChild(callCard);
      }
      // ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆ
      else {
        const text = document.createElement('div');
        text.className = 'message-text';
        // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã¯ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º
        if (msg.mentions && msg.mentions.length > 0) {
          text.innerHTML = highlightMentions(msg.text || '', msg.mentions);
        } else {
          text.textContent = msg.text || '';
        }
        bubble.appendChild(text);
      }

      // æ™‚é–“ï¼ˆLINEé¢¨ï¼šæ™‚:åˆ†ã®ã¿ï¼‰
      const time = document.createElement('span');
      time.className = 'message-time';
      if (msg.timestamp && msg.timestamp.toDate) {
        const date = msg.timestamp.toDate();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        time.textContent = `${hours}:${minutes}`;
      } else {
        const date = new Date();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        time.textContent = `${hours}:${minutes}`;
      }

      // ãƒ¡ã‚¿æƒ…å ±ã‚³ãƒ³ãƒ†ãƒŠï¼ˆæ—¢èª­ + æ™‚é–“ï¼‰
      const meta = document.createElement('div');
      meta.className = 'message-meta';

      // æ—¢èª­è¡¨ç¤ºï¼ˆè‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ï¼‰- ãƒãƒ–ãƒ«ã®å·¦å´ã«é…ç½®
      // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚·ãƒ•ãƒˆé˜²æ­¢ã®ãŸã‚ã€å¸¸ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿
      if (isMine) {
        const readStatus = document.createElement('span');
        readStatus.className = 'message-read-status';
        const readCount = getReadCount(msg.readBy);
        if (readCount > 0) {
          // ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒãƒ£ãƒƒãƒˆã¯ã€Œæ—¢èª­ã€ã€ã‚°ãƒ«ãƒ¼ãƒ—ã¯ã€Œæ—¢èª­ Nã€
          if (currentRoomType === 'direct') {
            readStatus.textContent = 'æ—¢èª­';
          } else {
            readStatus.textContent = `æ—¢èª­ ${readCount}`;
          }
        } else {
          // æœªèª­æ™‚ã¯ç©ºç™½ã‚’è¡¨ç¤ºã—ã¦ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ï¼ˆvisibility: hiddenã§éè¡¨ç¤ºã ãŒé ˜åŸŸç¢ºä¿ï¼‰
          readStatus.textContent = 'æ—¢èª­';
          readStatus.style.visibility = 'hidden';
        }
        meta.appendChild(readStatus);
      }

      meta.appendChild(time);
      
      // ãƒãƒ–ãƒ«ã‚’ãƒãƒ–ãƒ«ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ 
      bubbleContainer.appendChild(bubble);
      
      // è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ãƒ¡ã‚¿æƒ…å ±â†’ãƒãƒ–ãƒ«ã‚³ãƒ³ãƒ†ãƒŠï¼ˆå·¦ã‹ã‚‰å³ï¼‰
      // ç›¸æ‰‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ãƒãƒ–ãƒ«ã‚³ãƒ³ãƒ†ãƒŠâ†’ãƒ¡ã‚¿æƒ…å ±ï¼ˆå·¦ã‹ã‚‰å³ï¼‰
      if (isMine) {
        wrapper.appendChild(meta);
        wrapper.appendChild(bubbleContainer);
      } else {
        wrapper.appendChild(bubbleContainer);
        wrapper.appendChild(meta);
      }

      content.appendChild(wrapper);
      item.appendChild(content);

      // é•·æŠ¼ã—ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      console.log('[Message] Adding long press listener for message:', msg.id);
      addLongPressListener(item, msg.id, msg.text || '', isMine, msg.fileUrl || null, msg.fileName || null, messageUserName || '');

      container.appendChild(item);
    }

    // é€ä¿¡ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’æ›´æ–°
    function updateSendButtonState() {
      const input = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendButton');
      if (!input || !sendBtn) return;

      const hasText = input.value.trim().length > 0;
      const hasImages = selectedImageFiles && selectedImageFiles.length > 0;
      sendBtn.disabled = !(hasText || hasImages);
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    window.sendMessage = async function() {
      console.log('[sendMessage] é–¢æ•°å‘¼ã³å‡ºã—é–‹å§‹');

      // ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯ï¼ˆLINEé¢¨ï¼šç›¸æ‰‹ã«ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç„¡è¨€ã§é€ä¿¡å¤±æ•—ï¼‰
      if (isBlockedByOther) {
        console.log('[sendMessage] ç›¸æ‰‹ã«ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ãŸã‚é€ä¿¡ã‚¹ã‚­ãƒƒãƒ—');
        // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢ã—ã¦é€ä¿¡ã—ãŸã‚ˆã†ã«è¦‹ã›ã‚‹ï¼ˆLINEé¢¨ï¼‰
        const input = document.getElementById('messageInput');
        if (input) {
          input.value = '';
          insertedMentions = [];
          clearMentionTags();
          updateSendButtonState();
        }
        return;
      }

      const input = document.getElementById('messageInput');
      const textMessage = getPlainText(input).trim();

      // ã‚¿ã‚°ã‹ã‚‰ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆã«çµåˆ
      const mentionTexts = insertedMentions.map(m => '@' + m.userName).join(' ');
      const message = mentionTexts ? (mentionTexts + ' ' + textMessage).trim() : textMessage;

      console.log('[sendMessage] textMessage:', textMessage);
      console.log('[sendMessage] mentionTexts:', mentionTexts);
      console.log('[sendMessage] message:', message);
      console.log('[sendMessage] selectedImageFiles:', selectedImageFiles.length, 'æš');
      console.log('[sendMessage] currentUserName:', currentUserName);
      console.log('[sendMessage] currentRoomId:', currentRoomId);

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒã‚§ãƒƒã‚¯
      if (!currentUserName) {
        console.error('[sendMessage] ãƒ¦ãƒ¼ã‚¶ãƒ¼åæœªè¨­å®š');
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      // roomIdãƒã‚§ãƒƒã‚¯
      if (!currentRoomId) {
        console.error('[sendMessage] ãƒ«ãƒ¼ãƒ IDæœªè¨­å®š');
        alert('ãƒ«ãƒ¼ãƒ IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }

      // ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç”»åƒé€ä¿¡ï¼ˆè¤‡æ•°å¯¾å¿œï¼‰
      if (selectedImageFiles.length > 0) {
        console.log('[Send] ç”»åƒé€ä¿¡ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ -', selectedImageFiles.length, 'æš');
        const sendButton = document.getElementById('sendButton');
        sendButton.disabled = true;

        try {
          // æœ€åˆã®ç”»åƒã«ã¯ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰ã‚’ä»˜ã‘ã‚‹
          // 2æšç›®ä»¥é™ã¯ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ãªã—
          for (let i = 0; i < selectedImageFiles.length; i++) {
            const file = selectedImageFiles[i];
            const caption = (i === 0) ? message : '';
            console.log('[Send] ç”»åƒé€ä¿¡ä¸­:', i + 1, '/', selectedImageFiles.length, file.name);
            await uploadAndSendFile(file, 'image', caption);
          }
          console.log('[Send] å…¨ç”»åƒé€ä¿¡å®Œäº†');
        } catch (error) {
          console.error('[Send] ç”»åƒé€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
          alert('ç”»åƒã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          sendButton.disabled = false;
          return;
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
        selectedImageFiles = [];
        updateImagePreview();

        // å…¥åŠ›æ¬„ã‚¯ãƒªã‚¢
        input.value = '';
        insertedMentions = []; // æŒ¿å…¥æ¸ˆã¿ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚‚ãƒªã‚»ãƒƒãƒˆ
        clearMentionTags(); // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚¿ã‚°ã‚‚ã‚¯ãƒªã‚¢
        updateSendButtonState(); // é€ä¿¡å¾Œã¯ç„¡åŠ¹åŒ–

        return;
      }

      // ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã®å ´åˆ
      if (!message) {
        return;
      }

      try {
        console.log('[Firestore] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ä¸­...');

        // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’è§£æ
        let mentions = parseMentions(message);
        console.log('[Mention] æ¤œå‡ºã•ã‚ŒãŸãƒ¡ãƒ³ã‚·ãƒ§ãƒ³:', mentions);

        // @AllãŒå«ã¾ã‚Œã‚‹å ´åˆã€å…¨ãƒ¡ãƒ³ãƒãƒ¼ã‚’é€šçŸ¥å¯¾è±¡ã«å±•é–‹
        if (mentions.includes('All')) {
          // è‡ªåˆ†ä»¥å¤–ã®å…¨ãƒ¡ãƒ³ãƒãƒ¼ã‚’mentionsã«è¿½åŠ 
          const allMembers = currentRoomMembers.filter(m => m !== currentUserName);
          // 'All'ã¯æ®‹ã—ã¤ã¤ã€å…¨ãƒ¡ãƒ³ãƒãƒ¼ã‚‚è¿½åŠ ï¼ˆé‡è¤‡æ’é™¤ï¼‰
          mentions = [...new Set([...mentions, ...allMembers])];
          console.log('[Mention] @Allå±•é–‹å¾Œ:', mentions);
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ï¼ˆã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
        const messageData = {
          text: message,
          userName: currentUserName,
          userEmail: currentUserEmail, // Firebase Functions é«˜é€ŸåŒ–ç”¨
          timestamp: serverTimestamp(),
          deleted: []
        };

        // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
        if (mentions.length > 0) {
          messageData.mentions = mentions;
        }

        // ãƒªãƒ—ãƒ©ã‚¤æƒ…å ±ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ ï¼ˆLINEé¢¨ï¼‰
        if (currentReplyTo) {
          messageData.replyTo = {
            messageId: currentReplyTo.messageId,
            userName: currentReplyTo.userName,
            text: currentReplyTo.text.length > 100 
              ? currentReplyTo.text.substring(0, 100) + '...' 
              : currentReplyTo.text,
            userIcon: currentReplyTo.userIcon || null
          };
          console.log('[Reply] ãƒªãƒ—ãƒ©ã‚¤æƒ…å ±ã‚’è¿½åŠ :', messageData.replyTo);
        }

        await addDoc(collection(db, `rooms/${currentRoomId}/messages`), messageData);

        console.log('[Firestore] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å®Œäº†');

        // roomsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®lastMessageã‚’æ›´æ–°
        const roomRef = doc(db, 'rooms', currentRoomId);
        await updateDoc(roomRef, {
          lastMessage: message,
          lastMessageAt: serverTimestamp(),
          lastMessageBy: currentUserName
        });

        console.log('[Firestore] ãƒ«ãƒ¼ãƒ æƒ…å ±æ›´æ–°å®Œäº†');

        // ğŸ”§ v297: æœªèª­ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°ã¨ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã¯Firebase Functions (onChatMessageCreated) ã«ä»»ã›ã‚‹
        // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã®æ›´æ–°ã¯å‰Šé™¤ï¼ˆFirebase Functionsã¨é‡è¤‡ã™ã‚‹ãŸã‚ï¼‰

        // å…¥åŠ›æ¬„ã‚¯ãƒªã‚¢
        input.value = '';
        insertedMentions = []; // æŒ¿å…¥æ¸ˆã¿ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚‚ãƒªã‚»ãƒƒãƒˆ
        clearMentionTags(); // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚¿ã‚°ã‚‚ã‚¯ãƒªã‚¢
        updateSendButtonState(); // é€ä¿¡å¾Œã¯ç„¡åŠ¹åŒ–

        // ãƒªãƒ—ãƒ©ã‚¤ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
        cancelReply();

      } catch (error) {
        console.error('[Firestore] é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };

    // æ·»ä»˜ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
    window.toggleAttachmentMenu = function() {
      const menu = document.getElementById('attachmentMenu');
      const btn = document.getElementById('toggleMenuBtn');

      if (menu.style.display === 'none') {
        menu.style.display = 'block';
        btn.classList.add('active');
      } else {
        menu.style.display = 'none';
        btn.classList.remove('active');
      }
    };

    // ç”»åƒé¸æŠ
    window.selectImage = function() {
      document.getElementById('imageInput').click();
    };

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠï¼ˆéŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ç½®ãæ›ãˆæ¸ˆã¿ã®ãŸã‚æœªä½¿ç”¨ï¼‰
    window.selectFile = function() {
      document.getElementById('fileInput').click();
      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      document.getElementById('attachmentMenu').style.display = 'none';
      document.getElementById('toggleMenuBtn').classList.remove('active');
    };

    // ========== éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ©Ÿèƒ½ ==========
    let voiceMediaRecorder = null;
    let voiceAudioChunks = [];
    let voiceRecordingStartTime = null;
    let voiceRecordingTimer = null;
    let voiceAudioStream = null;

    // éŒ²éŸ³é–‹å§‹
    window.startVoiceRecording = async function() {
      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      document.getElementById('attachmentMenu').style.display = 'none';
      document.getElementById('toggleMenuBtn').classList.remove('active');

      // iOSåˆ¤å®šï¼ˆPWAã§MediaRecorderãŒæ­£å¸¸å‹•ä½œã—ãªã„ãŸã‚ï¼‰
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
        (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      
      if (isIOS) {
        alert('ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ©Ÿèƒ½ã¯iOSã§ã¯ç¾åœ¨å¯¾å¿œã—ã¦ãŠã‚Šã¾ã›ã‚“ã€‚\n\nAndroidç«¯æœ«ã¾ãŸã¯PCã®Chromeãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã”åˆ©ç”¨ãã ã•ã„ã€‚');
        return;
      }

      try {
        // ãƒã‚¤ã‚¯ã®è¨±å¯ã‚’å–å¾—
        voiceAudioStream = await navigator.mediaDevices.getUserMedia({
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            sampleRate: 44100
          }
        });

        // MediaRecorderã‚’ä½œæˆ
        // iOS Safariã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã‚‹å½¢å¼ã‚’ç¢ºèª
        const testTypes = [
          'audio/mp4',
          'audio/aac',
          'audio/mpeg',
          'audio/mp4;codecs=mp4a.40.2',
          'audio/webm',
          'audio/webm;codecs=opus',
          'audio/ogg',
          'audio/ogg;codecs=opus',
          'audio/wav',
          ''  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        ];
        console.log('[Voice] MediaRecorder ã‚µãƒãƒ¼ãƒˆå½¢å¼ãƒã‚§ãƒƒã‚¯:');
        testTypes.forEach(type => {
          if (type) {
            console.log(`  ${type}: ${MediaRecorder.isTypeSupported(type)}`);
          }
        });
        
        // mimeTypeã‚’æŒ‡å®šã›ãšã«MediaRecorderã‚’ä½œæˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä½¿ç”¨ï¼‰
        // iOS Safariã§ã¯ã“ã®æ–¹æ³•ãŒæœ€ã‚‚äº’æ›æ€§ãŒé«˜ã„
        let recorderOptions = {};
        
        // å„ªå…ˆé †ä½ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã‚‹å½¢å¼ã‚’æ¢ã™
        const preferredTypes = [
          'audio/mp4',
          'audio/aac', 
          'audio/mp4;codecs=mp4a.40.2',
          'audio/webm;codecs=opus',
          'audio/webm'
        ];
        
        for (const type of preferredTypes) {
          if (MediaRecorder.isTypeSupported(type)) {
            recorderOptions.mimeType = type;
            break;
          }
        }
        
        // ã‚µãƒãƒ¼ãƒˆã•ã‚Œã‚‹å½¢å¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä½¿ç”¨
        if (recorderOptions.mimeType) {
          console.log('[Voice] é¸æŠã•ã‚ŒãŸéŒ²éŸ³å½¢å¼:', recorderOptions.mimeType);
          voiceMediaRecorder = new MediaRecorder(voiceAudioStream, recorderOptions);
        } else {
          console.log('[Voice] ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå½¢å¼ã‚’ä½¿ç”¨');
          voiceMediaRecorder = new MediaRecorder(voiceAudioStream);
        }
        console.log('[Voice] å®Ÿéš›ã®mimeType:', voiceMediaRecorder.mimeType);
        voiceAudioChunks = [];

        voiceMediaRecorder.ondataavailable = (event) => {
          console.log('[Voice] ondataavailable:', event.data.size, 'bytes');
          if (event.data.size > 0) {
            voiceAudioChunks.push(event.data);
          }
        };

        // éŒ²éŸ³é–‹å§‹ï¼ˆiOSã§ã¯timesliceã‚’æŒ‡å®šã—ãªã„æ–¹ãŒå®‰å®šï¼‰
        voiceMediaRecorder.start(); // stop()æ™‚ã«ã¾ã¨ã‚ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        voiceRecordingStartTime = Date.now();

        // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
        document.getElementById('voiceRecordingOverlay').style.display = 'flex';

        // ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°é–‹å§‹
        voiceRecordingTimer = setInterval(updateVoiceRecordingTime, 100);

      } catch (error) {
        console.error('[Voice] ãƒã‚¤ã‚¯è¨±å¯ã‚¨ãƒ©ãƒ¼:', error);
        if (error.name === 'NotAllowedError') {
          alert('ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šã‹ã‚‰ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
        } else {
          alert('éŒ²éŸ³ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸ: ' + error.message);
        }
      }
    };

    // éŒ²éŸ³æ™‚é–“æ›´æ–°
    function updateVoiceRecordingTime() {
      if (!voiceRecordingStartTime) return;
      const elapsed = Math.floor((Date.now() - voiceRecordingStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      document.getElementById('voiceRecordingTime').textContent =
        `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    // éŒ²éŸ³ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    window.cancelVoiceRecording = function() {
      if (voiceMediaRecorder && voiceMediaRecorder.state !== 'inactive') {
        voiceMediaRecorder.stop();
      }
      cleanupVoiceRecording();
      document.getElementById('voiceRecordingOverlay').style.display = 'none';
    };

    // éŒ²éŸ³ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    function cleanupVoiceRecording() {
      if (voiceRecordingTimer) {
        clearInterval(voiceRecordingTimer);
        voiceRecordingTimer = null;
      }
      if (voiceAudioStream) {
        voiceAudioStream.getTracks().forEach(track => track.stop());
        voiceAudioStream = null;
      }
      voiceMediaRecorder = null;
      voiceAudioChunks = [];
      voiceRecordingStartTime = null;
      document.getElementById('voiceRecordingTime').textContent = '0:00';
    }

    // éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    window.sendVoiceMessage = async function() {
      if (!voiceMediaRecorder || voiceMediaRecorder.state === 'inactive') {
        alert('éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      const duration = Math.floor((Date.now() - voiceRecordingStartTime) / 1000);

      // éŒ²éŸ³ã‚’åœæ­¢ã—ã¦Blobã‚’å–å¾—
      voiceMediaRecorder.stop();

      // onstopã‚¤ãƒ™ãƒ³ãƒˆã‚’å¾…ã¤
      voiceMediaRecorder.onstop = async () => {
        try {
          const mimeType = voiceMediaRecorder.mimeType;
          const audioBlob = new Blob(voiceAudioChunks, { type: mimeType });

          // æœ€å°éŒ²éŸ³æ™‚é–“ãƒã‚§ãƒƒã‚¯ï¼ˆ1ç§’æœªæº€ã¯é€ä¿¡ã—ãªã„ï¼‰
          if (duration < 1) {
            alert('éŒ²éŸ³æ™‚é–“ãŒçŸ­ã™ãã¾ã™');
            cleanupVoiceRecording();
            document.getElementById('voiceRecordingOverlay').style.display = 'none';
            return;
          }

          console.log('[Voice] éŒ²éŸ³å®Œäº†:', audioBlob.size, 'bytes, duration:', duration, 's');

          // Firebase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆæ‹¡å¼µå­ã‚’å½¢å¼ã‹ã‚‰æ±ºå®šï¼‰
          console.log('[Voice] ä¿å­˜ã™ã‚‹mimeType:', mimeType);
          let extension = 'm4a'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
          if (mimeType.includes('webm')) extension = 'webm';
          else if (mimeType.includes('ogg')) extension = 'ogg';
          else if (mimeType.includes('mp4') || mimeType.includes('m4a') || mimeType.includes('aac') || mimeType.includes('mpeg')) extension = 'm4a';
          const fileName = `voice_${Date.now()}.${extension}`;
          const storageRef = ref(storage, `chat/${currentRoomId}/voice/${fileName}`);

          const snapshot = await uploadBytes(storageRef, audioBlob);
          console.log('[Voice] ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†:', snapshot.metadata.fullPath);

          const downloadURL = await getDownloadURL(storageRef);
          console.log('[Voice] URLå–å¾—å®Œäº†:', downloadURL);

          // Firestoreã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜
          await addDoc(collection(db, 'rooms', currentRoomId, 'messages'), {
            type: 'voice',
            voiceUrl: downloadURL,
            voiceDuration: duration,
            voiceMimeType: mimeType,
            sender: currentUserEmail,
            senderName: currentUserName,
            timestamp: serverTimestamp(),
            readBy: [currentUserEmail]
          });

          console.log('[Voice] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¿å­˜å®Œäº†');

          // roomsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®lastMessageã‚’æ›´æ–°ï¼ˆãƒãƒ£ãƒƒãƒˆä¸€è¦§ã«åæ˜ ï¼‰
          const roomRef = doc(db, 'rooms', currentRoomId);
          await updateDoc(roomRef, {
            lastMessage: 'éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
            lastMessageAt: serverTimestamp(),
            lastMessageBy: currentUserName
          });

          console.log('[Voice] ãƒ«ãƒ¼ãƒ æƒ…å ±æ›´æ–°å®Œäº†');

        } catch (error) {
          console.error('[Voice] é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
          alert('éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        } finally {
          cleanupVoiceRecording();
          document.getElementById('voiceRecordingOverlay').style.display = 'none';
        }
      };
    };

    // éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†ç”Ÿç”¨ã®Audioã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†
    let currentVoiceAudio = null;
    let currentVoiceButton = null;
    let currentVoiceMsgId = null;

    // éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å†ç”Ÿ/ä¸€æ™‚åœæ­¢
    window.toggleVoicePlayback = function(voiceUrl, msgId, playBtn) {
      // åŒã˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å†åº¦ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯å†ç”Ÿ/ä¸€æ™‚åœæ­¢ã‚’åˆ‡ã‚Šæ›¿ãˆ
      if (currentVoiceMsgId === msgId && currentVoiceAudio) {
        if (currentVoiceAudio.paused) {
          currentVoiceAudio.play();
          playBtn.classList.add('playing');
          playBtn.innerHTML = '<i class="bi bi-pause-fill"></i>';
        } else {
          currentVoiceAudio.pause();
          playBtn.classList.remove('playing');
          playBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
        }
        return;
      }

      // åˆ¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®éŸ³å£°ãŒå†ç”Ÿä¸­ã®å ´åˆã¯åœæ­¢
      if (currentVoiceAudio) {
        currentVoiceAudio.pause();
        currentVoiceAudio = null;
        if (currentVoiceButton) {
          currentVoiceButton.classList.remove('playing');
          currentVoiceButton.innerHTML = '<i class="bi bi-play-fill"></i>';
        }
      }

      // æ–°ã—ã„éŸ³å£°ã‚’å†ç”Ÿ
      console.log('[Voice] å†ç”Ÿé–‹å§‹:', voiceUrl);
      
      const audio = new Audio();
      
      // å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼ˆwebmãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã‹ï¼‰
      const isWebm = voiceUrl.includes('.webm');
      if (isWebm) {
        const canPlayWebm = audio.canPlayType('audio/webm');
        console.log('[Voice] webmå¯¾å¿œ:', canPlayWebm);
        if (!canPlayWebm || canPlayWebm === '') {
          alert('ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã§ã¯webmå½¢å¼ã®éŸ³å£°ã‚’å†ç”Ÿã§ãã¾ã›ã‚“ã€‚éŒ²éŸ³ã—ãŸãƒ‡ãƒã‚¤ã‚¹ã§å†ç”Ÿã—ã¦ãã ã•ã„ã€‚');
          return;
        }
      }
      
      audio.src = voiceUrl;
      currentVoiceAudio = audio;
      currentVoiceButton = playBtn;
      currentVoiceMsgId = msgId;

      playBtn.classList.add('playing');
      playBtn.innerHTML = '<i class="bi bi-pause-fill"></i>';

      audio.play().catch(err => {
        console.error('[Voice] å†ç”Ÿã‚¨ãƒ©ãƒ¼:', err.name, err.message);
        alert('éŸ³å£°ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
        playBtn.classList.remove('playing');
        playBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
        currentVoiceAudio = null;
        currentVoiceButton = null;
        currentVoiceMsgId = null;
      });

      // å†ç”Ÿå®Œäº†æ™‚
      audio.onended = function() {
        playBtn.classList.remove('playing');
        playBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
        currentVoiceAudio = null;
        currentVoiceButton = null;
        currentVoiceMsgId = null;
      };

      // ã‚¨ãƒ©ãƒ¼æ™‚
      audio.onerror = function(e) {
        console.error('[Voice] éŸ³å£°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', audio.error?.code, audio.error?.message);
        playBtn.classList.remove('playing');
        playBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
        currentVoiceAudio = null;
        currentVoiceButton = null;
        currentVoiceMsgId = null;
      };
    };

    // ã‚«ãƒ¡ãƒ©èµ·å‹•
    window.openCamera = function() {
      document.getElementById('cameraInput').click();
    };

    // ç”»é¢å¤–ã‚¿ãƒƒãƒ—ã§æ·»ä»˜ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
    document.addEventListener('click', function(e) {
      const menu = document.getElementById('attachmentMenu');
      const btn = document.getElementById('toggleMenuBtn');
      if (menu && menu.style.display !== 'none') {
        if (!menu.contains(e.target) && !btn.contains(e.target)) {
          menu.style.display = 'none';
          btn.classList.remove('active');
        }
      }
    });

    // ç”»åƒé¸æŠæ™‚ã®å‡¦ç†
    // é¸æŠä¸­ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿æŒ
    // è¤‡æ•°ç”»åƒå¯¾å¿œ
    let selectedImageFiles = [];
    const MAX_IMAGES = 10; // æœ€å¤§10æšã¾ã§

    window.handleImageSelect = function(event) {
      const files = Array.from(event.target.files);
      if (!files.length) return;

      console.log('[Image] ç”»åƒé¸æŠ:', files.length, 'æš');

      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ10MBåˆ¶é™ï¼‰
      const maxSize = 10 * 1024 * 1024; // 10MB
      const validFiles = [];

      for (const file of files) {
        if (file.size > maxSize) {
          alert(`${file.name} ã¯10MBã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚`);
          continue;
        }
        validFiles.push(file);
      }

      if (!validFiles.length) {
        event.target.value = '';
        return;
      }

      // æœ€å¤§æšæ•°ãƒã‚§ãƒƒã‚¯
      const totalCount = selectedImageFiles.length + validFiles.length;
      if (totalCount > MAX_IMAGES) {
        alert(`ç”»åƒã¯æœ€å¤§${MAX_IMAGES}æšã¾ã§ã§ã™ã€‚ç¾åœ¨${selectedImageFiles.length}æšé¸æŠä¸­ã§ã™ã€‚`);
        const allowedCount = MAX_IMAGES - selectedImageFiles.length;
        validFiles.splice(allowedCount);
      }

      // é¸æŠã—ãŸç”»åƒã‚’è¿½åŠ 
      selectedImageFiles = [...selectedImageFiles, ...validFiles];
      console.log('[Image] åˆè¨ˆé¸æŠæšæ•°:', selectedImageFiles.length);

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã‚’æ›´æ–°
      updateImagePreview();

      // é€ä¿¡ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
      updateSendButtonState();

      // input ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠå¯èƒ½ã«ã™ã‚‹ï¼‰
      event.target.value = '';
    };

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateImagePreview() {
      const container = document.getElementById('imagePreviewContainer');
      const list = document.getElementById('imagePreviewList');
      const countBadge = document.getElementById('imagePreviewCount');

      // ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
      list.innerHTML = '';

      if (selectedImageFiles.length === 0) {
        container.style.display = 'none';
        return;
      }

      // å„ç”»åƒã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆ
      selectedImageFiles.forEach((file, index) => {
        const item = document.createElement('div');
        item.className = 'image-preview-item';
        item.dataset.index = index;

        const img = document.createElement('img');
        const reader = new FileReader();
        reader.onload = function(e) {
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);

        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
        removeBtn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          removeImageAtIndex(index);
        };

        item.appendChild(img);
        item.appendChild(removeBtn);
        list.appendChild(item);
      });

      // æšæ•°ãƒãƒƒã‚¸ã‚’æ›´æ–°
      countBadge.textContent = `${selectedImageFiles.length}æš`;
      countBadge.style.display = selectedImageFiles.length > 1 ? 'inline-flex' : 'none';

      container.style.display = 'block';
      console.log('[Image] ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºæ›´æ–°å®Œäº†');
    }

    // æŒ‡å®šã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ç”»åƒã‚’å‰Šé™¤
    function removeImageAtIndex(index) {
      console.log('[Image] ç”»åƒå‰Šé™¤:', index);
      selectedImageFiles.splice(index, 1);
      updateImagePreview();
      updateSendButtonState();
    }

    // ã™ã¹ã¦ã®ç”»åƒã‚’ã‚¯ãƒªã‚¢
    function clearAllImages() {
      selectedImageFiles = [];
      updateImagePreview();
      updateSendButtonState();
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
    window.handleFileSelect = async function(event) {
      const file = event.target.files[0];
      if (!file) return;

      console.log('[File] ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ:', file.name, file.size, 'bytes');
      await uploadAndSendFile(file, 'file');

      // input ã‚’ãƒªã‚»ãƒƒãƒˆ
      event.target.value = '';
    };

    // ã‚«ãƒ¡ãƒ©æ’®å½±æ™‚ã®å‡¦ç†
    window.handleCameraCapture = async function(event) {
      const file = event.target.files[0];
      if (!file) return;

      console.log('[Camera] æ’®å½±å®Œäº†:', file.name, file.size, 'bytes');
      await uploadAndSendFile(file, 'image');

      // input ã‚’ãƒªã‚»ãƒƒãƒˆ
      event.target.value = '';
    };

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼†é€ä¿¡ï¼ˆå…±é€šé–¢æ•°ï¼‰
    async function uploadAndSendFile(file, type, caption = '') {
      console.log('[uploadAndSendFile] é–¢æ•°å‘¼ã³å‡ºã—:', { file, type, caption });
      console.log('[uploadAndSendFile] storage:', storage);
      console.log('[uploadAndSendFile] currentRoomId:', currentRoomId);

      try {
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ10MBåˆ¶é™ï¼‰
        const maxSize = 10 * 1024 * 1024; // 10MB
        if (file.size > maxSize) {
          console.error('[uploadAndSendFile] ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºè¶…é:', file.size);
          alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
          return;
        }

        console.log('[Upload] ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹:', file.name, 'size:', file.size);

        // Firebase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        const storageRef = ref(storage, `chat/${currentRoomId}/${Date.now()}_${file.name}`);
        const snapshot = await uploadBytes(storageRef, file);
        console.log('[Upload] ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†:', snapshot.metadata.fullPath);

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã‚’å–å¾—
        const downloadURL = await getDownloadURL(storageRef);
        console.log('[Upload] URLå–å¾—å®Œäº†:', downloadURL);

        // Firestoreã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜
        const messageData = {
          text: caption || '', // ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰
          userName: currentUserName,
          userEmail: currentUserEmail, // Firebase Functions é«˜é€ŸåŒ–ç”¨
          timestamp: serverTimestamp(),
          deleted: [],
          type: type, // 'image' or 'file'
          fileUrl: downloadURL,
          fileName: file.name,
          fileSize: file.size,
          mimeType: file.type
        };

        await addDoc(collection(db, `rooms/${currentRoomId}/messages`), messageData);
        console.log('[Upload] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å®Œäº†');

        // roomsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®lastMessageã‚’æ›´æ–°
        const roomRef = doc(db, 'rooms', currentRoomId);
        await updateDoc(roomRef, {
          lastMessage: caption || 'ç”»åƒã‚’é€ä¿¡ã—ã¾ã—ãŸ',
          lastMessageAt: serverTimestamp(),
          lastMessageBy: currentUserName
        });
        console.log('[Upload] ãƒ«ãƒ¼ãƒ æƒ…å ±æ›´æ–°å®Œäº†');

        // ğŸ”§ v297: æœªèª­ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°ã¨ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã¯Firebase Functions (onChatMessageCreated) ã«ä»»ã›ã‚‹

      } catch (error) {
        console.error('[Upload] ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ğŸ”§ v297: ã“ã®é–¢æ•°ã¯Firebase Functionsã¨é‡è¤‡ã™ã‚‹ãŸã‚ä½¿ç”¨åœæ­¢
    // Firebase Functions (onChatMessageCreated) ãŒæœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°ã™ã‚‹
    async function updateUnreadCountsForOthers() {
      try {
        // ãƒ«ãƒ¼ãƒ æƒ…å ±ã‚’å–å¾—
        const roomRef = doc(db, `rooms/${currentRoomId}`);
        const roomSnap = await getDoc(roomRef);

        if (!roomSnap.exists()) return;

        const roomData = roomSnap.data();
        // memberEmailsã‚’ä½¿ç”¨ï¼ˆDM/ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆå¯¾å¿œï¼‰
        // memberEmailsãŒãªã„å ´åˆã¯membersã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆæ—§å½¢å¼äº’æ›ï¼‰
        const memberEmails = roomData.memberEmails || roomData.members || [];

        console.log('[Unread] ãƒ¡ãƒ³ãƒãƒ¼ãƒ¡ãƒ¼ãƒ«ä¸€è¦§:', memberEmails, 'è‡ªåˆ†:', currentUserEmail);

        // è‡ªåˆ†ä»¥å¤–ã®ãƒ¡ãƒ³ãƒãƒ¼ã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚’+1
        for (const memberEmail of memberEmails) {
          if (memberEmail !== currentUserEmail) {
            const unreadRef = doc(db, `rooms/${currentRoomId}/unreadCounts/${memberEmail}`);
            await setDoc(unreadRef, {
              userId: memberEmail,
              unreadCount: increment(1),
              lastUpdatedAt: serverTimestamp()
            }, { merge: true });
            console.log('[Unread] +1:', memberEmail);
          }
        }

        console.log('[Unread] æœªèª­ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°å®Œäº†');
      } catch (error) {
        console.error('[Unread] æœªèª­ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ğŸ”§ v296: Cloudflare WorkerçµŒç”±ã§ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’é€ä¿¡ï¼ˆFirebase Functionsä¸è¦ï¼‰
    async function sendChatPushNotification(message, roomName) {
      try {
        console.log('[Push] ãƒãƒ£ãƒƒãƒˆé€šçŸ¥é€ä¿¡é–‹å§‹');

        // ãƒ«ãƒ¼ãƒ æƒ…å ±ã‚’å–å¾—
        const roomRef = doc(db, `rooms/${currentRoomId}`);
        const roomSnap = await getDoc(roomRef);
        if (!roomSnap.exists()) {
          console.log('[Push] ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        const roomData = roomSnap.data();
        const memberEmails = roomData.memberEmails || [];

        if (memberEmails.length === 0) {
          console.log('[Push] ãƒ¡ãƒ³ãƒãƒ¼ãƒ¡ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“');
          return;
        }

        // è‡ªåˆ†ä»¥å¤–ã®ãƒ¡ãƒ³ãƒãƒ¼ã®FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
        const tokens = [];
        for (const memberEmail of memberEmails) {
          if (memberEmail === currentUserEmail) continue; // è‡ªåˆ†ã¯ã‚¹ã‚­ãƒƒãƒ—

          // é–²è¦§ä¸­ãƒã‚§ãƒƒã‚¯
          try {
            const viewingRef = doc(db, 'viewingStatus', memberEmail);
            const viewingSnap = await getDoc(viewingRef);
            if (viewingSnap.exists()) {
              const viewingData = viewingSnap.data();
              if (viewingData.roomId === currentRoomId) {
                const lastUpdated = viewingData.lastUpdated?.toMillis?.() || 0;
                const now = Date.now();
                if ((now - lastUpdated) < 5 * 60 * 1000) { // 5åˆ†ä»¥å†…
                  console.log('[Push] é–²è¦§ä¸­ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—:', memberEmail);
                  continue;
                }
              }
            }
          } catch (e) {
            // viewingStatuså–å¾—ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
          }

          // ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
          try {
            const devicesRef = collection(db, `users/${memberEmail}/devices`);
            const devicesQuery = query(devicesRef, where('active', '==', true));
            const devicesSnap = await getDocs(devicesQuery);

            devicesSnap.forEach(deviceDoc => {
              const deviceData = deviceDoc.data();
              if (deviceData.fcmToken) {
                tokens.push(deviceData.fcmToken);
                console.log('[Push] ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—:', memberEmail, deviceData.fcmToken.substring(0, 20) + '...');
              }
            });
          } catch (e) {
            console.error('[Push] ãƒ‡ãƒã‚¤ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼:', memberEmail, e);
          }
        }

        if (tokens.length === 0) {
          console.log('[Push] é€ä¿¡å…ˆãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“');
          return;
        }

        console.log('[Push] é€ä¿¡å…ˆãƒˆãƒ¼ã‚¯ãƒ³æ•°:', tokens.length);

        // Cloudflare WorkerçµŒç”±ã§ãƒ—ãƒƒã‚·ãƒ¥é€ä¿¡
        const displayRoomName = roomName || roomData.name || 'å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆ';
        const response = await fetch('https://reborn-fcm-worker.mercari-yasuhirotakuji.workers.dev/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tokens: tokens,
            title: `ğŸ’¬ ${displayRoomName}`,
            body: `${currentUserName}: ${message.substring(0, 100)}`,
            data: {
              type: 'chat_message',
              roomId: currentRoomId,
              senderName: currentUserName
            }
          })
        });

        const result = await response.json().catch(() => ({}));
        console.log('[Push] é€ä¿¡çµæœ:', result);

      } catch (error) {
        console.error('[Push] ãƒãƒ£ãƒƒãƒˆé€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        // é€šçŸ¥é€ä¿¡å¤±æ•—ã—ã¦ã‚‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡è‡ªä½“ã¯æˆåŠŸã•ã›ã‚‹
      }
    }

    // ä»–ã®ãƒ«ãƒ¼ãƒ ã®æœªèª­æ•°åˆè¨ˆã‚’å–å¾—ã—ã¦æˆ»ã‚‹ãƒœã‚¿ãƒ³ã«è¡¨ç¤º
    async function loadOtherRoomsUnreadCount() {
      if (!currentUserEmail) {
        console.log('[Back Unread] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«ãŒãªã„ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
        return;
      }

      try {
        console.log('[Back Unread] ä»–ã®ãƒ«ãƒ¼ãƒ ã®æœªèª­æ•°å–å¾—é–‹å§‹');

        // å…¨ãƒ«ãƒ¼ãƒ ã‚’å–å¾—
        const roomsSnapshot = await getDocs(collection(db, 'rooms'));
        let totalUnread = 0;

        // å„ãƒ«ãƒ¼ãƒ ã®æœªèª­æ•°ã‚’å–å¾—ï¼ˆç¾åœ¨ã®ãƒ«ãƒ¼ãƒ ã‚’é™¤ãï¼‰
        for (const roomDoc of roomsSnapshot.docs) {
          if (roomDoc.id === currentRoomId) continue; // ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ ã¯ã‚¹ã‚­ãƒƒãƒ—

          const unreadRef = doc(db, `rooms/${roomDoc.id}/unreadCounts/${currentUserEmail}`);
          const unreadDoc = await getDoc(unreadRef);

          if (unreadDoc.exists()) {
            const unreadData = unreadDoc.data();
            const count = unreadData.unreadCount || 0;
            if (count > 0) {
              totalUnread += count;
            }
          }
        }

        console.log('[Back Unread] åˆè¨ˆæœªèª­æ•°:', totalUnread);

        // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã«è¡¨ç¤º
        const backUnreadEl = document.getElementById('backUnreadCount');
        if (backUnreadEl) {
          if (totalUnread > 0) {
            backUnreadEl.textContent = totalUnread > 99 ? '99+' : totalUnread.toString();
          } else {
            backUnreadEl.textContent = '';
          }
        }
      } catch (error) {
        console.error('[Back Unread] ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ================================================================================
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¤œç´¢æ©Ÿèƒ½
    // ================================================================================
    let searchResults = [];
    let currentSearchIndex = -1;
    let originalMessages = new Map(); // å…ƒã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜

    // æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹ã
    window.openSearchMode = function() {
      document.getElementById('headerNormal').style.display = 'none';
      document.getElementById('headerSearch').style.display = 'flex';
      document.getElementById('searchInput').focus();
    };

    // æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ã‚’é–‰ã˜ã‚‹
    window.closeSearchMode = function() {
      document.getElementById('headerNormal').style.display = 'flex';
      document.getElementById('headerSearch').style.display = 'none';
      clearSearch();
    };

    // æ¤œç´¢ã‚’ã‚¯ãƒªã‚¢
    window.clearSearch = function() {
      document.getElementById('searchInput').value = '';
      document.getElementById('searchClearBtn').style.display = 'none';
      document.getElementById('searchNavButtons').style.display = 'none';

      // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤
      removeAllHighlights();
      searchResults = [];
      currentSearchIndex = -1;
    };

    // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å…¨ã¦å‰Šé™¤
    function removeAllHighlights() {
      const container = document.getElementById('messagesContainer');
      const highlights = container.querySelectorAll('.search-highlight, .search-highlight-current');
      highlights.forEach(el => {
        const parent = el.parentNode;
        parent.replaceChild(document.createTextNode(el.textContent), el);
        parent.normalize();
      });
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¤œç´¢
    window.searchMessages = function() {
      const query = document.getElementById('searchInput').value.trim().toLowerCase();

      // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ‡æ›¿
      document.getElementById('searchClearBtn').style.display = query ? 'flex' : 'none';

      // ä»¥å‰ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤
      removeAllHighlights();
      searchResults = [];
      currentSearchIndex = -1;

      if (!query) {
        document.getElementById('searchNavButtons').style.display = 'none';
        return;
      }

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã‚’æ¤œç´¢
      const container = document.getElementById('messagesContainer');
      const messageElements = container.querySelectorAll('.message-bubble');

      messageElements.forEach((msgEl, index) => {
        const textContent = msgEl.textContent.toLowerCase();
        if (textContent.includes(query)) {
          // ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
          highlightText(msgEl, query);
          searchResults.push(msgEl);
        }
      });

      // æ¤œç´¢çµæœã®è¡¨ç¤º
      const navButtons = document.getElementById('searchNavButtons');
      const countEl = document.getElementById('searchCount');

      if (searchResults.length > 0) {
        navButtons.style.display = 'flex';
        currentSearchIndex = 0;
        updateSearchNavigation();
        scrollToCurrentResult();
      } else {
        navButtons.style.display = 'flex';
        countEl.textContent = '0/0';
      }
    };

    // ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    function highlightText(element, query) {
      const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
      const textNodes = [];

      while (walker.nextNode()) {
        textNodes.push(walker.currentNode);
      }

      textNodes.forEach(node => {
        const text = node.textContent;
        const lowerText = text.toLowerCase();
        const index = lowerText.indexOf(query);

        if (index !== -1) {
          const before = text.substring(0, index);
          const match = text.substring(index, index + query.length);
          const after = text.substring(index + query.length);

          const span = document.createElement('span');
          span.className = 'search-highlight';
          span.textContent = match;

          const fragment = document.createDocumentFragment();
          if (before) fragment.appendChild(document.createTextNode(before));
          fragment.appendChild(span);
          if (after) fragment.appendChild(document.createTextNode(after));

          node.parentNode.replaceChild(fragment, node);
        }
      });
    }

    // æ¤œç´¢ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
    function updateSearchNavigation() {
      const countEl = document.getElementById('searchCount');
      countEl.textContent = `${currentSearchIndex + 1}/${searchResults.length}`;

      // å…¨ã¦ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
      document.querySelectorAll('.search-highlight-current').forEach(el => {
        el.className = 'search-highlight';
      });

      // ç¾åœ¨ã®çµæœã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      if (searchResults[currentSearchIndex]) {
        const currentHighlight = searchResults[currentSearchIndex].querySelector('.search-highlight');
        if (currentHighlight) {
          currentHighlight.className = 'search-highlight-current';
        }
      }
    }

    // ç¾åœ¨ã®æ¤œç´¢çµæœã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    function scrollToCurrentResult() {
      if (searchResults[currentSearchIndex]) {
        searchResults[currentSearchIndex].scrollIntoView({
          behavior: 'smooth',
          block: 'center'
        });
      }
    }

    // æ¤œç´¢çµæœã‚’ãƒŠãƒ“ã‚²ãƒ¼ãƒˆ
    window.navigateSearch = function(direction) {
      if (searchResults.length === 0) return;

      if (direction === 'next') {
        currentSearchIndex = (currentSearchIndex + 1) % searchResults.length;
      } else {
        currentSearchIndex = (currentSearchIndex - 1 + searchResults.length) % searchResults.length;
      }

      updateSearchNavigation();
      scrollToCurrentResult();
    };

    // ãƒãƒ£ãƒƒãƒˆä¸€è¦§ã«æˆ»ã‚‹ï¼ˆLINEé¢¨ï¼‰
    window.goBackToList = async function() {
      console.log('========================================');
      console.log('[Navigation] ğŸ”™ ãƒãƒ£ãƒƒãƒˆä¸€è¦§ã«æˆ»ã‚‹ - é–¢æ•°å®Ÿè¡Œé–‹å§‹');
      console.log('[Navigation] isPWA:', isPWA);
      console.log('========================================');

      if (isPWA) {
        // PWAç‰ˆ: Firestoreã§è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«é€šçŸ¥
        try {
          console.log('[Navigation] ========== goBackToListé–‹å§‹ ==========');
          console.log('[Navigation] æˆ»ã‚‹æ–¹å¼: Firestore');
          console.log('[Navigation] ğŸ” sessionIdParam:', sessionIdParam);

          // Firestoreã®navigationã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«æ›¸ãè¾¼ã¿
          await setDoc(doc(db, 'navigation', 'chatControl'), {
            action: 'goBackToList',
            sessionId: sessionIdParam,
            timestamp: serverTimestamp(),
            from: 'chat_iframe'
          });

          console.log('[Navigation] âœ… Firestoreæ›¸ãè¾¼ã¿æˆåŠŸ');
          console.log('[Navigation] ========== goBackToListå®Œäº† ==========');

        } catch (error) {
          console.error('[Navigation] âŒ Firestoreã‚¨ãƒ©ãƒ¼:', error);
          console.error('[Navigation] error.stack:', error.stack);

          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: history.back()
          console.warn('[Navigation] ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: history.back()');
          window.history.back();
        }
      } else {
        // GASç‰ˆ: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã«æˆ»ã‚‹
        console.log('[Navigation] GASç‰ˆ: google.script.run å‘¼ã³å‡ºã—');
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          google.script.run.showChatRoomsList();
        } else {
          console.error('[Navigation] google.script.run ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
        }
      }
    };

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤ï¼ˆè«–ç†å‰Šé™¤ - è‡ªåˆ†ã®ç”»é¢ã‹ã‚‰ã®ã¿å‰Šé™¤ï¼‰
    async function deleteMessage(messageId) {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒã‚§ãƒƒã‚¯
      if (!currentUserName) {
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      if (!confirm('ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      try {
        console.log('[Firestore] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤ä¸­...', messageId);
        console.log('[Firestore] å‰Šé™¤ãƒ¦ãƒ¼ã‚¶ãƒ¼:', currentUserName);

        const messageRef = doc(db, 'messages', messageId);
        const messageDoc = await getDoc(messageRef);

        if (!messageDoc.exists()) {
          console.error('[Firestore] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
          return;
        }

        const messageData = messageDoc.data();
        // deletedBy ãŒé…åˆ—ã§ãªã„å ´åˆã‚‚è€ƒæ…®ã—ã¦ã€ç¢ºå®Ÿã«é…åˆ—åŒ–
        let deletedByArray = messageData.deletedBy;
        if (!Array.isArray(deletedByArray)) {
          deletedByArray = [];
        }

        // è‡ªåˆ†ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ deletedBy é…åˆ—ã«è¿½åŠ 
        if (!deletedByArray.includes(currentUserName)) {
          deletedByArray.push(currentUserName);
        }

        await updateDoc(messageRef, {
          deletedBy: deletedByArray,
          lastDeletedAt: serverTimestamp()
        });

        console.log('[Firestore] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤å®Œäº†ï¼ˆè‡ªåˆ†ã®ç”»é¢ã‹ã‚‰ã®ã¿ï¼‰');

      } catch (error) {
        console.error('[Firestore] å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // é¸æŠå‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ
    window.toggleSelectionMode = function() {
      const container = document.getElementById('messagesContainer');
      const bar = document.getElementById('selectionModeBar');

      if (container.classList.contains('selection-mode')) {
        // é¸æŠãƒ¢ãƒ¼ãƒ‰çµ‚äº†
        container.classList.remove('selection-mode');
        bar.classList.remove('active');

        // ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
        const checkboxes = document.querySelectorAll('.message-checkbox');
        checkboxes.forEach(cb => cb.checked = false);
        updateSelectionCount();
      } else {
        // é¸æŠãƒ¢ãƒ¼ãƒ‰é–‹å§‹
        container.classList.add('selection-mode');
        bar.classList.add('active');
      }
    };

    // é¸æŠã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
    function updateSelectionCount() {
      const checkboxes = document.querySelectorAll('.message-checkbox:checked');
      const count = checkboxes.length;
      document.getElementById('selectedCount').textContent = count;
    }

    // é¸æŠã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸€æ‹¬å‰Šé™¤ï¼ˆè‡ªåˆ†ã®ç”»é¢ã‹ã‚‰ã®ã¿å‰Šé™¤ï¼‰
    window.deleteSelectedMessages = async function() {
      const checkboxes = document.querySelectorAll('.message-checkbox:checked');

      if (checkboxes.length === 0) {
        alert('å‰Šé™¤ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      if (!confirm(`${checkboxes.length}ä»¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }

      try {
        console.log('[Firestore] ä¸€æ‹¬å‰Šé™¤é–‹å§‹:', checkboxes.length + 'ä»¶');

        // ä¸¦åˆ—ã§å‰Šé™¤å‡¦ç†
        const deletePromises = Array.from(checkboxes).map(async (checkbox) => {
          const messageId = checkbox.dataset.messageId;
          const messageRef = doc(db, 'messages', messageId);
          const messageDoc = await getDoc(messageRef);

          if (messageDoc.exists()) {
            const messageData = messageDoc.data();
            // deletedBy ãŒé…åˆ—ã§ãªã„å ´åˆã‚‚è€ƒæ…®ã—ã¦ã€ç¢ºå®Ÿã«é…åˆ—åŒ–
            let deletedByArray = messageData.deletedBy;
            if (!Array.isArray(deletedByArray)) {
              deletedByArray = [];
            }

            // è‡ªåˆ†ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ deletedBy é…åˆ—ã«è¿½åŠ 
            if (!deletedByArray.includes(currentUserName)) {
              deletedByArray.push(currentUserName);
            }

            await updateDoc(messageRef, {
              deletedBy: deletedByArray,
              lastDeletedAt: serverTimestamp()
            });
          }
        });

        await Promise.all(deletePromises);

        console.log('[Firestore] ä¸€æ‹¬å‰Šé™¤å®Œäº†ï¼ˆè‡ªåˆ†ã®ç”»é¢ã‹ã‚‰ã®ã¿ï¼‰');

        // é¸æŠãƒ¢ãƒ¼ãƒ‰çµ‚äº†
        toggleSelectionMode();

      } catch (error) {
        console.error('[Firestore] ä¸€æ‹¬å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };

    // é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–¢é€£
    let contextMenuData = {
      messageId: null,
      messageText: null,
      isMine: false,
      item: null,
      fileUrl: null,
      fileName: null,
      senderName: null
    };
    let longPressTimer = null;
    const LONG_PRESS_DURATION = 500; // 500ms

    // é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ãï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¿‘ãã«è¡¨ç¤ºï¼‰
    function openContextMenu(messageId, messageText, targetElement, isMine = false, fileUrl = null, fileName = null, senderName = null) {
      console.log('[ContextMenu] Opening menu for message:', messageId, 'isMine:', isMine);
      contextMenuData.messageId = messageId;
      contextMenuData.messageText = messageText;
      contextMenuData.isMine = isMine;
      contextMenuData.item = targetElement;
      contextMenuData.fileUrl = fileUrl;
      contextMenuData.fileName = fileName;
      contextMenuData.senderName = senderName;

      // é€ä¿¡å–ã‚Šæ¶ˆã—ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºï¼ˆè‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿è¡¨ç¤ºï¼‰
      const unsendBtn = document.getElementById('contextMenuUnsend');
      const deleteBtn = document.getElementById('contextMenuDelete');
      unsendBtn.style.display = isMine ? 'flex' : 'none';
      // é€ä¿¡å–æ¶ˆãŒéè¡¨ç¤ºã®å ´åˆã€å‰Šé™¤ãƒœã‚¿ãƒ³ã®å³ãƒœãƒ¼ãƒ€ãƒ¼ã‚’æ¶ˆã™
      deleteBtn.style.borderRight = isMine ? '1px solid #e5e7eb' : 'none';

      const menu = document.getElementById('contextMenu');
      const overlay = document.getElementById('contextMenuOverlay');

      console.log('[ContextMenu] Menu element:', menu);
      console.log('[ContextMenu] Overlay element:', overlay);

      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆä½ç½®è¨ˆç®—ã®ãŸã‚ä¸€æ™‚çš„ã«è¡¨ç¤ºï¼‰
      menu.style.display = 'block';
      menu.style.opacity = '0';

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã®ä½ç½®ã‚’å–å¾—
      const rect = targetElement.getBoundingClientRect();
      const menuRect = menu.getBoundingClientRect();

      console.log('[ContextMenu] Target rect:', rect);
      console.log('[ContextMenu] Menu rect:', menuRect);

      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¸Šéƒ¨ä¸­å¤®ã«é…ç½®
      let top = rect.top - menuRect.height - 10; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¸Šã«10pxéš™é–“
      let left = rect.left + (rect.width / 2) - (menuRect.width / 2); // ä¸­å¤®æƒãˆ

      // ç”»é¢ä¸Šéƒ¨ã«ã¯ã¿å‡ºã™å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¸‹ã«è¡¨ç¤º
      if (top < 10) {
        top = rect.bottom + 10;
      }

      // ç”»é¢å·¦å³ã«ã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã«èª¿æ•´
      if (left < 10) {
        left = 10;
      } else if (left + menuRect.width > window.innerWidth - 10) {
        left = window.innerWidth - menuRect.width - 10;
      }

      // ä½ç½®ã‚’è¨­å®š
      menu.style.top = top + 'px';
      menu.style.left = left + 'px';

      console.log('[ContextMenu] Final position - top:', top, 'left:', left);

      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
      overlay.classList.add('active');
      menu.classList.add('active');

      // CSSã®transitionã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã€æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§opacityã‚’ãƒªã‚»ãƒƒãƒˆ
      setTimeout(() => {
        menu.style.opacity = '1';
      }, 10);

      console.log('[ContextMenu] Menu classes:', menu.className);
      console.log('[ContextMenu] Overlay classes:', overlay.className);
    }

    // é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
    window.closeContextMenu = function() {
      const menu = document.getElementById('contextMenu');
      const overlay = document.getElementById('contextMenuOverlay');

      overlay.classList.remove('active');
      menu.classList.remove('active');

      // æ¬¡å›ã®ãŸã‚ã« opacity ã‚’ 0 ã«æˆ»ã™
      setTimeout(() => {
        menu.style.opacity = '0';
      }, 200); // transitionã®æ™‚é–“ï¼ˆ0.2sï¼‰å¾Œã«å®Ÿè¡Œ

      contextMenuData = { messageId: null, messageText: null, item: null, fileUrl: null, fileName: null, senderName: null };
    };

    // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    // ã‚¿ãƒƒãƒç”¨
    document.getElementById('contextMenuCopy').addEventListener('touchend', function(e) {
      e.preventDefault();
      e.stopPropagation();
      copyMessage();
    });
    document.getElementById('contextMenuReply').addEventListener('touchend', function(e) {
      e.preventDefault();
      e.stopPropagation();
      replyMessage();
    });
    document.getElementById('contextMenuForward').addEventListener('touchend', function(e) {
      e.preventDefault();
      e.stopPropagation();
      forwardMessage();
    });
    document.getElementById('contextMenuDelete').addEventListener('touchend', function(e) {
      e.preventDefault();
      e.stopPropagation();
      deleteMessageFromMenu();
    });
    document.getElementById('contextMenuUnsend').addEventListener('touchend', function(e) {
      e.preventDefault();
      e.stopPropagation();
      unsendMessage();
    });
    document.getElementById('contextMenuKeep').addEventListener('touchend', function(e) {
      e.preventDefault();
      e.stopPropagation();
      saveToKeep();
    });

    // PCç”¨: ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚‚è¿½åŠ 
    document.getElementById('contextMenuCopy').addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      copyMessage();
    });
    document.getElementById('contextMenuReply').addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      replyMessage();
    });
    document.getElementById('contextMenuForward').addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      forwardMessage();
    });
    document.getElementById('contextMenuDelete').addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      deleteMessageFromMenu();
    });
    document.getElementById('contextMenuUnsend').addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      unsendMessage();
    });
    document.getElementById('contextMenuKeep').addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      saveToKeep();
    });

    // ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
    window.copyMessage = function() {
      if (!contextMenuData.messageText) return;

      // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
      navigator.clipboard.writeText(contextMenuData.messageText)
        .then(() => {
          console.log('[Copy] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
          closeContextMenu();
        })
        .catch(err => {
          console.error('[Copy] ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼:', err);
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: textareaã‚’ä½¿ã£ãŸå¤ã„æ–¹æ³•
          const textarea = document.createElement('textarea');
          textarea.value = contextMenuData.messageText;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          closeContextMenu();
        });
    };

    // Keepã«ä¿å­˜æ©Ÿèƒ½
    window.saveToKeep = async function() {
      if (!contextMenuData.messageText && !contextMenuData.fileUrl) {
        console.log('[Keep] ä¿å­˜ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      if (!currentUserName) {
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“');
        return;
      }

      // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ã‹ã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      const messageText = contextMenuData.messageText;
      const fileUrl = contextMenuData.fileUrl;
      const fileName = contextMenuData.fileName;
      const senderName = contextMenuData.senderName || 'ä¸æ˜';

      closeContextMenu();

      try {
        // æ—¢å­˜ã®Keepãƒ¡ãƒ¢ãƒ«ãƒ¼ãƒ ã‚’æ¤œç´¢
        const q = query(
          collection(db, 'rooms'),
          where('type', '==', 'keep'),
          where('createdBy', '==', currentUserName)
        );
        const snapshot = await getDocs(q);

        let keepRoomId;

        if (!snapshot.empty) {
          // æ—¢å­˜ã®Keepãƒ¡ãƒ¢ãƒ«ãƒ¼ãƒ ãŒã‚ã‚‹å ´åˆ
          keepRoomId = snapshot.docs[0].id;
          console.log('[Keep] æ—¢å­˜ã®Keepãƒ¡ãƒ¢ãƒ«ãƒ¼ãƒ ã‚’ä½¿ç”¨:', keepRoomId);
        } else {
          // Keepãƒ¡ãƒ¢ãƒ«ãƒ¼ãƒ ã‚’æ–°è¦ä½œæˆ
          console.log('[Keep] Keepãƒ¡ãƒ¢ãƒ«ãƒ¼ãƒ ã‚’æ–°è¦ä½œæˆ');
          const newRoom = await addDoc(collection(db, 'rooms'), {
            name: 'Keepãƒ¡ãƒ¢',
            icon: '',
            createdBy: currentUserName,
            createdAt: serverTimestamp(),
            lastMessageAt: serverTimestamp(),
            lastMessageText: '',
            lastMessageSender: '',
            members: [currentUserName],
            type: 'keep'
          });
          keepRoomId = newRoom.id;
          console.log('[Keep] Keepãƒ¡ãƒ¢ãƒ«ãƒ¼ãƒ ä½œæˆå®Œäº†:', keepRoomId);
        }

        // ä¿å­˜ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å†…å®¹ã‚’æ§‹ç¯‰
        let keepMessage = '';
        if (messageText) {
          keepMessage = `${senderName}ã•ã‚“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:\n${messageText}`;
        } else if (fileUrl) {
          keepMessage = `${senderName}ã•ã‚“ã®ãƒ•ã‚¡ã‚¤ãƒ«`;
        }

        // Keepãƒ¡ãƒ¢ãƒ«ãƒ¼ãƒ ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜
        const messageData = {
          text: keepMessage,
          userName: currentUserName,
          userEmail: currentUserEmail || '',
          timestamp: serverTimestamp(),
          deleted: []
        };

        // ç”»åƒ/ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯æ·»ä»˜
        if (fileUrl) {
          messageData.fileUrl = fileUrl;
          messageData.fileName = fileName || 'ãƒ•ã‚¡ã‚¤ãƒ«';
          messageData.type = 'file';
        }

        await addDoc(collection(db, 'rooms', keepRoomId, 'messages'), messageData);

        // Keepãƒ«ãƒ¼ãƒ ã®æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
        await updateDoc(doc(db, 'rooms', keepRoomId), {
          lastMessageAt: serverTimestamp(),
          lastMessageText: messageText || 'ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ï¼‰',
          lastMessageSender: currentUserName
        });

        console.log('[Keep] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’Keepã«ä¿å­˜ã—ã¾ã—ãŸ');

        // Keepãƒ‰ãƒƒãƒˆè¡¨ç¤ºã®ãŸã‚ã«localStorageã‚’æ›´æ–°
        localStorage.setItem('keepDotActive', 'true');

        // æˆåŠŸé€šçŸ¥ï¼ˆç°¡æ˜“ãƒˆãƒ¼ã‚¹ãƒˆï¼‰
        showKeepToast('Keepã«ä¿å­˜ã—ã¾ã—ãŸ');

      } catch (error) {
        console.error('[Keep] ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('Keepã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };

    // Keepä¿å­˜å®Œäº†ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
    function showKeepToast(message) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 24px;
        border-radius: 24px;
        font-size: 14px;
        z-index: 10000;
        animation: fadeInOut 2s ease-in-out;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 2000);
    }

    // ãƒªãƒ—ãƒ©ã‚¤æ©Ÿèƒ½ï¼ˆLINEé¢¨ï¼‰
    window.replyMessage = function() {
      if (!contextMenuData.messageText && !contextMenuData.fileUrl) return;

      // closeContextMenu()ã®å‰ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
      const messageId = contextMenuData.messageId;
      const messageText = contextMenuData.messageText || 'ï¼ˆç”»åƒï¼‰';
      const senderName = contextMenuData.senderName || 'ä¸æ˜';

      // é€ä¿¡è€…ã®ã‚¢ã‚¤ã‚³ãƒ³URLã‚’å–å¾—
      const senderIcon = getUserIconUrl(senderName);

      closeContextMenu();

      // ãƒªãƒ—ãƒ©ã‚¤æƒ…å ±ã‚’ä¿å­˜
      currentReplyTo = {
        messageId: messageId,
        userName: senderName,
        text: messageText,
        userIcon: senderIcon
      };

      // ãƒªãƒ—ãƒ©ã‚¤ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
      showReplyPreview();

      // å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      const messageInput = document.getElementById('messageInput');
      messageInput.focus();
    };

    // ãƒªãƒ—ãƒ©ã‚¤ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
    function showReplyPreview() {
      if (!currentReplyTo) return;

      const preview = document.getElementById('replyPreview');
      const iconContainer = document.getElementById('replyPreviewIcon');
      const userElement = document.getElementById('replyPreviewUser');
      const textElement = document.getElementById('replyPreviewText');

      // ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š
      iconContainer.innerHTML = '';
      if (currentReplyTo.userIcon) {
        const img = document.createElement('img');
        img.className = 'reply-preview-icon';
        img.src = currentReplyTo.userIcon;
        img.alt = currentReplyTo.userName;
        img.onerror = function() {
          const placeholder = document.createElement('div');
          placeholder.className = 'reply-preview-icon-placeholder';
          placeholder.textContent = (currentReplyTo.userName || '?').charAt(0);
          this.replaceWith(placeholder);
        };
        iconContainer.appendChild(img);
      } else {
        const placeholder = document.createElement('div');
        placeholder.className = 'reply-preview-icon-placeholder';
        placeholder.textContent = (currentReplyTo.userName || '?').charAt(0);
        iconContainer.appendChild(placeholder);
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š
      userElement.textContent = currentReplyTo.userName;
      textElement.textContent = currentReplyTo.text.length > 50
        ? currentReplyTo.text.substring(0, 50) + '...'
        : currentReplyTo.text;

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
      preview.classList.add('active');

      // å…¥åŠ›ã‚¨ãƒªã‚¢ã®border-radiusèª¿æ•´
      adjustInputBorderRadius();
    }

    // ãƒªãƒ—ãƒ©ã‚¤ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    window.cancelReply = function() {
      currentReplyTo = null;
      const preview = document.getElementById('replyPreview');
      preview.classList.remove('active');

      // å…¥åŠ›ã‚¨ãƒªã‚¢ã®border-radiusèª¿æ•´
      adjustInputBorderRadius();
    };

    // å…¥åŠ›ã‚¨ãƒªã‚¢ã®border-radiusèª¿æ•´
    function adjustInputBorderRadius() {
      const replyPreview = document.getElementById('replyPreview');
      const mentionTags = document.getElementById('mentionTags');
      const messageInput = document.getElementById('messageInput');

      const hasReply = replyPreview.classList.contains('active');
      const hasMentions = mentionTags.classList.contains('has-tags');

      if (hasReply && hasMentions) {
        messageInput.style.borderRadius = '0 0 20px 20px';
        mentionTags.style.borderRadius = '0';
      } else if (hasReply) {
        messageInput.style.borderRadius = '0 0 20px 20px';
      } else if (hasMentions) {
        messageInput.style.borderRadius = '0 0 20px 20px';
      } else {
        messageInput.style.borderRadius = '20px';
      }
    }

    // ãƒªãƒ—ãƒ©ã‚¤å…ƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚¸ãƒ£ãƒ³ãƒ—ï¼ˆæºã‚Œã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
    function scrollToMessage(messageId) {
      if (!messageId) return;

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã‚’æ¤œç´¢
      const targetMessage = document.querySelector(`.message-item[data-message-id="${messageId}"]`);
      
      if (targetMessage) {
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠã‚’å–å¾—
        const messagesContainer = document.getElementById('messagesContainer');
        
        // æ‰‹å‹•ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’è¨ˆç®—ï¼ˆscrollIntoViewã‚’ä½¿ã‚ãªã„ï¼‰
        const containerRect = messagesContainer.getBoundingClientRect();
        const targetRect = targetMessage.getBoundingClientRect();
        const currentScrollTop = messagesContainer.scrollTop;
        
        // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ä¸­å¤®ã«é…ç½®ã™ã‚‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’è¨ˆç®—
        const targetCenter = targetRect.top - containerRect.top + currentScrollTop - (containerRect.height / 2) + (targetRect.height / 2);
        
        // å³åº§ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        messagesContainer.scrollTop = targetCenter;

        // æºã‚Œã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        requestAnimationFrame(() => {
          targetMessage.classList.remove('highlight-shake');
          void targetMessage.offsetWidth;
          targetMessage.classList.add('highlight-shake');

          setTimeout(() => {
            targetMessage.classList.remove('highlight-shake');
          }, 600);
        });
      } else {
        console.log('[Reply Jump] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', messageId);
      }
    }

    // é€ä¿¡å–ã‚Šæ¶ˆã—æ©Ÿèƒ½ï¼ˆLINEæ–¹å¼ï¼‰
    window.unsendMessage = async function() {
      if (!contextMenuData.messageId) return;
      if (!contextMenuData.isMine) {
        alert('è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿å–ã‚Šæ¶ˆã—ã§ãã¾ã™');
        return;
      }

      // closeContextMenu()ã®å‰ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
      const messageId = contextMenuData.messageId;
      const messageItem = contextMenuData.item;

      closeContextMenu();

      // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
      if (!confirm('ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      try {
        console.log('[Unsend] é€ä¿¡å–ã‚Šæ¶ˆã—é–‹å§‹:', messageId);

        // Firestoreã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°ï¼ˆdeleted: trueãƒ•ãƒ©ã‚°ã‚’è¿½åŠ ï¼‰
        const messageRef = doc(db, 'rooms', currentRoomId, 'messages', messageId);
        await updateDoc(messageRef, {
          deleted: true,
          deletedAt: serverTimestamp(),
          originalText: contextMenuData.messageText || '', // å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿å­˜ï¼ˆç®¡ç†ç”¨ï¼‰
          text: null,
          type: 'deleted',
          fileUrl: null,
          fileName: null
        });

        console.log('[Unsend] é€ä¿¡å–ã‚Šæ¶ˆã—å®Œäº†');

        // UIã‚’å³åº§ã«æ›´æ–°ï¼ˆonSnapshotã§è‡ªå‹•æ›´æ–°ã•ã‚Œã‚‹ãŒã€å¿µã®ãŸã‚ï¼‰
        if (messageItem) {
          const bubble = messageItem.querySelector('.message-bubble');
          if (bubble) {
            bubble.classList.add('deleted');
            bubble.innerHTML = '<div class="message-text">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå–ã‚Šæ¶ˆã•ã‚Œã¾ã—ãŸ</div>';
          }
        }

      } catch (error) {
        console.error('[Unsend] é€ä¿¡å–ã‚Šæ¶ˆã—ã‚¨ãƒ©ãƒ¼:', error);
        alert('é€ä¿¡å–ã‚Šæ¶ˆã—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };

    // è»¢é€æ©Ÿèƒ½
    let forwardMessageData = null;

    window.forwardMessage = async function() {
      if (!contextMenuData.messageText && !contextMenuData.fileUrl) return;

      // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
      forwardMessageData = {
        text: contextMenuData.messageText,
        fileUrl: contextMenuData.fileUrl || null,
        fileName: contextMenuData.fileName || null,
        originalSender: contextMenuData.senderName || ''
      };

      closeContextMenu();
      openForwardModal();
    };

    async function openForwardModal() {
      const overlay = document.getElementById('forwardModalOverlay');
      const modal = document.getElementById('forwardModal');
      const roomList = document.getElementById('forwardRoomList');

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      roomList.innerHTML = '<div class="forward-loading"><i class="bi bi-arrow-repeat spin"></i> èª­ã¿è¾¼ã¿ä¸­...</div>';

      overlay.classList.add('active');
      setTimeout(() => modal.classList.add('active'), 10);

      try {
        // å…¨ãƒ«ãƒ¼ãƒ ã‚’å–å¾—
        const roomsSnapshot = await getDocs(collection(db, 'rooms'));
        const rooms = [];

        roomsSnapshot.forEach(roomDoc => {
          // ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ ã¯é™¤å¤–
          if (roomDoc.id === currentRoomId) return;

          const data = roomDoc.data();
          const members = data.members || [];
          const roomType = data.type || '';

          // ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒ«ãƒ¼ãƒ ã‹ãƒã‚§ãƒƒã‚¯
          // 1. ã‚·ã‚¹ãƒ†ãƒ ãƒ«ãƒ¼ãƒ ï¼ˆtypeæœªè¨­å®š or 'group'ï¼‰ã¯å…¨å“¡ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
          // 2. å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆï¼ˆtype='direct'ï¼‰ã¯è‡ªåˆ†ãŒãƒ¡ãƒ³ãƒãƒ¼ã®å ´åˆã®ã¿
          const isSystemRoom = !roomType || roomType === 'group' || roomType === 'system';
          const isMember = members.includes(currentUserEmail) || members.includes(currentUserName);

          if (!isSystemRoom && !isMember) return;

          // è¡¨ç¤ºåã‚’æ±ºå®šï¼ˆå€‹åˆ¥ãƒãƒ£ãƒƒãƒˆã¯ç›¸æ‰‹ã®åå‰ã‚’è¡¨ç¤ºï¼‰
          let displayName = data.name || 'ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ';
          if (roomType === 'direct' && members.length > 0) {
            // è‡ªåˆ†ä»¥å¤–ã®ãƒ¡ãƒ³ãƒãƒ¼åã‚’å–å¾—
            const otherMember = members.find(m => m !== currentUserName && m !== currentUserEmail);
            if (otherMember) {
              displayName = otherMember;
            }
          }

          rooms.push({
            id: roomDoc.id,
            name: displayName,
            members: members,
            type: roomType,
            icon: data.icon || null
          });
        });

        // ãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚’è¡¨ç¤º
        if (rooms.length === 0) {
          roomList.innerHTML = '<div class="forward-loading">è»¢é€å…ˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
          return;
        }

        roomList.innerHTML = rooms.map(room => {
          let iconHtml;

          if (room.type === 'direct') {
            // å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆã®å ´åˆã¯ç›¸æ‰‹ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—
            const iconUrl = getUserIconUrl(room.name);
            const initial = (room.name || '?').charAt(0);
            iconHtml = iconUrl
              ? `<img src="${iconUrl}" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`
              : `<span style="font-size:18px;font-weight:600;color:#fff;">${initial}</span>`;
          } else if (room.icon) {
            // ã‚·ã‚¹ãƒ†ãƒ ãƒ«ãƒ¼ãƒ ã§çµµæ–‡å­—ã‚¢ã‚¤ã‚³ãƒ³ãŒã‚ã‚‹å ´åˆ
            iconHtml = `<span style="font-size:24px;">${room.icon}</span>`;
          } else {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³
            iconHtml = `<i class="bi bi-chat-dots"></i>`;
          }

          return `
            <div class="forward-room-item" onclick="executeForward('${room.id}', '${room.name.replace(/'/g, "\\'")}')">
              <div class="forward-room-icon">
                ${iconHtml}
              </div>
              <div class="forward-room-info">
                <div class="forward-room-name">${room.name}</div>
              </div>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('[Forward] ãƒ«ãƒ¼ãƒ å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        roomList.innerHTML = '<div class="forward-loading">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
      }
    }

    window.closeForwardModal = function() {
      const overlay = document.getElementById('forwardModalOverlay');
      const modal = document.getElementById('forwardModal');

      modal.classList.remove('active');
      setTimeout(() => {
        overlay.classList.remove('active');
      }, 300);
    };

    // ========== ãƒãƒ¼ãƒˆä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« ==========
    window.openNoteListModal = async function() {
      console.log('[NoteList] ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã roomId:', currentRoomId);

      // è¨­å®šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
      document.getElementById('chatSettingsDropdown').classList.remove('active');

      const overlay = document.getElementById('noteListModalOverlay');
      const modal = document.getElementById('noteListModal');
      const content = document.getElementById('noteListContent');

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      content.innerHTML = `
        <div class="note-list-loading">
          <i class="bi bi-arrow-clockwise spin"></i>
          èª­ã¿è¾¼ã¿ä¸­...
        </div>
      `;

      // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
      overlay.classList.add('active');
      setTimeout(() => {
        modal.classList.add('active');
      }, 10);

      // ãƒãƒ¼ãƒˆä¸€è¦§ã‚’å–å¾—
      await loadSharedNotes();
    };

    window.closeNoteListModal = function() {
      const overlay = document.getElementById('noteListModalOverlay');
      const modal = document.getElementById('noteListModal');

      modal.classList.remove('active');
      setTimeout(() => {
        overlay.classList.remove('active');
      }, 300);
    };

    async function loadSharedNotes() {
      const content = document.getElementById('noteListContent');

      try {
        // ã“ã®ãƒ«ãƒ¼ãƒ ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰type='note-share'ã‚’æ¤œç´¢
        const messagesRef = collection(db, `rooms/${currentRoomId}/messages`);
        const q = query(
          messagesRef,
          where('type', '==', 'note-share'),
          orderBy('timestamp', 'desc'),
          limit(50)
        );

        const snapshot = await getDocs(q);

        if (snapshot.empty) {
          content.innerHTML = `
            <div class="note-list-empty">
              <i class="bi bi-journal-text"></i>
              <p>ã“ã®ãƒãƒ£ãƒƒãƒˆã§å…±æœ‰ã•ã‚ŒãŸãƒãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>
            </div>
          `;
          return;
        }

        // ãƒãƒ¼ãƒˆä¸€è¦§ã‚’è¡¨ç¤º
        let html = '';
        snapshot.forEach(docSnap => {
          const msg = docSnap.data();
          const noteData = msg.noteShareData || {};
          const title = noteData.title || 'ç„¡é¡Œã®ãƒãƒ¼ãƒˆ';
          const url = noteData.url || '#';
          const senderName = msg.userName || 'ä¸æ˜';
          const senderEmail = msg.userEmail || '';

          // é€ä¿¡æ—¥æ™‚
          let dateStr = '';
          if (msg.timestamp) {
            const date = msg.timestamp.toDate ? msg.timestamp.toDate() : new Date(msg.timestamp);
            dateStr = date.toLocaleDateString('ja-JP', {
              month: 'short',
              day: 'numeric'
            });
          }

          // é€ä¿¡è€…ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—
          const senderIconUrl = getUserIconUrl(senderName) || '';

          html += `
            <div class="note-list-item" onclick="window.open('${url}', '_blank')">
              <div class="note-list-icon">
                <i class="bi bi-journal-text"></i>
              </div>
              <div class="note-list-info">
                <div class="note-list-title">${escapeHtml(title)}</div>
                <div class="note-list-meta">
                  <div class="note-list-sender">
                    <div class="note-list-sender-avatar">
                      ${senderIconUrl
                        ? `<img src="${senderIconUrl}" alt="${escapeHtml(senderName)}" onerror="this.outerHTML='<i class=\\'bi bi-person\\'></i>'">`
                        : `<i class="bi bi-person"></i>`}
                    </div>
                    <span>${escapeHtml(senderName)}</span>
                  </div>
                  <span>${dateStr}</span>
                </div>
              </div>
              <div class="note-list-arrow">
                <i class="bi bi-chevron-right"></i>
              </div>
            </div>
          `;
        });

        content.innerHTML = html;

      } catch (error) {
        console.error('[NoteList] èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆãƒªãƒ³ã‚¯ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
        const errorMsg = error.message || '';
        let helpText = '';
        if (errorMsg.includes('index')) {
          helpText = '<br><small>ï¼ˆFirestoreã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä½œæˆãŒå¿…è¦ã§ã™ï¼‰</small>';
        }
        content.innerHTML = `
          <div class="note-list-empty">
            <i class="bi bi-exclamation-circle"></i>
            <p>ãƒãƒ¼ãƒˆä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ${helpText}</p>
            <p style="font-size: 11px; color: #9ca3af; margin-top: 8px; word-break: break-all;">${escapeHtml(errorMsg)}</p>
          </div>
        `;
      }
    }

    // ========== è‡ªåˆ†ã®ãƒãƒ¼ãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« ==========
    window.openMyNoteSelectModal = async function() {
      console.log('[MyNoteSelect] ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã userEmail:', currentUserEmail);

      // æ·»ä»˜ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      document.getElementById('attachmentMenu').style.display = 'none';
      document.getElementById('toggleMenuBtn').classList.remove('active');

      const overlay = document.getElementById('myNoteSelectModalOverlay');
      const modal = document.getElementById('myNoteSelectModal');
      const content = document.getElementById('myNoteSelectContent');

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      content.innerHTML = `
        <div class="note-list-loading">
          <i class="bi bi-arrow-clockwise spin"></i>
          èª­ã¿è¾¼ã¿ä¸­...
        </div>
      `;

      // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
      overlay.classList.add('active');
      setTimeout(() => {
        modal.classList.add('active');
      }, 10);

      // è‡ªåˆ†ã®ãƒãƒ¼ãƒˆä¸€è¦§ã‚’å–å¾—
      await loadMyNotes();
    };

    window.closeMyNoteSelectModal = function() {
      const overlay = document.getElementById('myNoteSelectModalOverlay');
      const modal = document.getElementById('myNoteSelectModal');

      modal.classList.remove('active');
      setTimeout(() => {
        overlay.classList.remove('active');
      }, 300);
    };

    async function loadMyNotes() {
      const content = document.getElementById('myNoteSelectContent');

      try {
        // è‡ªåˆ†ã®ãƒãƒ¼ãƒˆä¸€è¦§ã‚’å–å¾—
        const notesRef = collection(db, `users/${currentUserEmail}/notes`);
        const q = query(notesRef, orderBy('updatedAt', 'desc'), limit(50));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
          content.innerHTML = `
            <div class="note-list-empty">
              <i class="bi bi-journal-text"></i>
              <p>ãƒãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
              <p style="font-size: 12px; margin-top: 8px;">ãƒã‚¤ãƒšãƒ¼ã‚¸ã‹ã‚‰ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„</p>
            </div>
          `;
          return;
        }

        // ãƒãƒ¼ãƒˆä¸€è¦§ã‚’è¡¨ç¤º
        let html = '';
        snapshot.forEach(docSnap => {
          const note = docSnap.data();
          const noteId = docSnap.id;
          const title = note.title || 'ç„¡é¡Œã®ãƒãƒ¼ãƒˆ';

          // æ›´æ–°æ—¥æ™‚
          let dateStr = '';
          if (note.updatedAt) {
            const date = note.updatedAt.toDate ? note.updatedAt.toDate() : new Date(note.updatedAt);
            dateStr = date.toLocaleDateString('ja-JP', {
              month: 'short',
              day: 'numeric'
            });
          }

          // ãƒ–ãƒ­ãƒƒã‚¯æ•°
          const blockCount = note.blocks ? note.blocks.length : 0;

          html += `
            <div class="note-list-item" onclick="sendNoteToChat('${noteId}', '${escapeHtml(title).replace(/'/g, "\\'")}')">
              <div class="note-list-icon">
                <i class="bi bi-journal-text"></i>
              </div>
              <div class="note-list-info">
                <div class="note-list-title">${escapeHtml(title)}</div>
                <div class="note-list-meta">
                  <span>${blockCount}ãƒ–ãƒ­ãƒƒã‚¯</span>
                  <span>${dateStr}</span>
                </div>
              </div>
              <div class="note-list-arrow">
                <i class="bi bi-send"></i>
              </div>
            </div>
          `;
        });

        content.innerHTML = html;

      } catch (error) {
        console.error('[MyNoteSelect] èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        content.innerHTML = `
          <div class="note-list-empty">
            <i class="bi bi-exclamation-circle"></i>
            <p>ãƒãƒ¼ãƒˆä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
            <p style="font-size: 11px; color: #9ca3af; margin-top: 8px;">${escapeHtml(error.message || '')}</p>
          </div>
        `;
      }
    }

    // ãƒãƒ¼ãƒˆã‚’ãƒãƒ£ãƒƒãƒˆã«é€ä¿¡
    window.sendNoteToChat = async function(noteId, noteTitle) {
      console.log('[SendNote] ãƒãƒ¼ãƒˆé€ä¿¡é–‹å§‹:', noteId, noteTitle);

      closeMyNoteSelectModal();

      try {
        // å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆï¼ˆæ—¢å­˜ã®shareIdãŒã‚ã‚Œã°ä½¿ç”¨ã€ãªã‘ã‚Œã°æ–°è¦ä½œæˆï¼‰
        const noteRef = doc(db, `users/${currentUserEmail}/notes`, noteId);
        const noteSnap = await getDoc(noteRef);

        if (!noteSnap.exists()) {
          alert('ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        const noteData = noteSnap.data();
        let shareId = noteData.shareId;

        // shareIdãŒãªã„å ´åˆã¯æ–°è¦ä½œæˆ
        if (!shareId) {
          shareId = generateShareId();

          // ãƒãƒ¼ãƒˆã«shareIdã‚’ä¿å­˜
          await updateDoc(noteRef, {
            shareId: shareId,
            isPublic: true
          });

          // noteSharesã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ç™»éŒ²
          await setDoc(doc(db, 'noteShares', shareId), {
            noteId: noteId,
            ownerEmail: currentUserEmail,
            createdAt: serverTimestamp(),
            isActive: true
          });
        }

        const shareUrl = `${window.location.origin}/note-view.html?id=${shareId}`;

        // ãƒãƒ£ãƒƒãƒˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
        const messagesRef = collection(db, `rooms/${currentRoomId}/messages`);
        await addDoc(messagesRef, {
          text: `ãƒãƒ¼ãƒˆã‚’å…±æœ‰ã—ã¾ã—ãŸ\n\nã€Œ${noteTitle}ã€\n${shareUrl}`,
          userName: currentUserName,
          userEmail: currentUserEmail,
          timestamp: serverTimestamp(),
          type: 'note-share',
          noteShareData: {
            shareId: shareId,
            noteId: noteId,
            title: noteTitle,
            url: shareUrl
          }
        });

        // ãƒ«ãƒ¼ãƒ ã®lastMessageã‚’æ›´æ–°
        const roomRef = doc(db, 'rooms', currentRoomId);
        await updateDoc(roomRef, {
          lastMessage: 'ãƒãƒ¼ãƒˆã‚’å…±æœ‰ã—ã¾ã—ãŸ',
          lastMessageAt: serverTimestamp()
        });

        console.log('[SendNote] ãƒãƒ¼ãƒˆé€ä¿¡å®Œäº†');

      } catch (error) {
        console.error('[SendNote] é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒãƒ¼ãƒˆã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };

    // å…±æœ‰IDç”Ÿæˆï¼ˆãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—åˆ—ï¼‰
    function generateShareId() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      for (let i = 0; i < 16; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    window.executeForward = async function(targetRoomId, targetRoomName) {
      if (!forwardMessageData) return;

      closeForwardModal();

      try {
        console.log('[Forward] è»¢é€é–‹å§‹:', targetRoomId);

        // è»¢é€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆï¼ˆLINEæ–¹å¼ï¼šè»¢é€ãƒ©ãƒ™ãƒ«ãªã—ï¼‰
        const messageText = forwardMessageData.text || '';

        const messageData = {
          text: messageText,
          userName: currentUserName,      // è¡¨ç¤ºç”¨ï¼ˆappendMessageå‚ç…§ï¼‰
          userEmail: currentUserEmail,    // Firebase Functionsç”¨ï¼ˆé€šçŸ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼‰
          timestamp: serverTimestamp(),
          forwarded: true,
          originalSender: forwardMessageData.originalSender
        };

        // ç”»åƒã®å ´åˆã¯fileUrlã‚‚è¿½åŠ 
        if (forwardMessageData.fileUrl) {
          messageData.fileUrl = forwardMessageData.fileUrl;
          messageData.fileName = forwardMessageData.fileName;
          messageData.type = 'image';
        }

        // è»¢é€å…ˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
        await addDoc(collection(db, `rooms/${targetRoomId}/messages`), messageData);

        // è»¢é€å…ˆã®lastMessageã‚’æ›´æ–°
        const roomRef = doc(db, 'rooms', targetRoomId);
        const lastMessagePreview = messageText || 'ç”»åƒ';
        await updateDoc(roomRef, {
          lastMessage: lastMessagePreview.substring(0, 50),
          lastMessageAt: serverTimestamp()
        });

        console.log('[Forward] è»¢é€å®Œäº†');
        alert(`ã€Œ${targetRoomName}ã€ã«è»¢é€ã—ã¾ã—ãŸ`);

      } catch (error) {
        console.error('[Forward] è»¢é€ã‚¨ãƒ©ãƒ¼:', error);
        alert('è»¢é€ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }

      forwardMessageData = null;
    };

    // ========================================
    // Keepé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½
    // ========================================

    // Keepé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.openKeepSelectModal = async function() {
      console.log('[Keep] Keepé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã');

      // æ·»ä»˜ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      document.getElementById('attachmentMenu').style.display = 'none';
      document.getElementById('toggleMenuBtn').classList.remove('active');

      const overlay = document.getElementById('keepModalOverlay');
      const modal = document.getElementById('keepModal');
      const body = document.getElementById('keepModalBody');

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      body.innerHTML = '<div class="keep-loading"><i class="bi bi-arrow-repeat spin"></i> èª­ã¿è¾¼ã¿ä¸­...</div>';

      overlay.classList.add('active');
      setTimeout(() => modal.classList.add('active'), 10);

      try {
        // è‡ªåˆ†ã®Keepãƒ¡ãƒ¢ãƒ«ãƒ¼ãƒ ã‚’æ¤œç´¢
        const q = query(
          collection(db, 'rooms'),
          where('type', '==', 'keep'),
          where('createdBy', '==', currentUserName)
        );
        const roomSnapshot = await getDocs(q);

        if (roomSnapshot.empty) {
          // Keepãƒ¡ãƒ¢ãŒãªã„å ´åˆ
          body.innerHTML = `
            <div class="keep-empty">
              <i class="bi bi-bookmark"></i>
              <div class="keep-empty-text">
                Keepãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“<br>
                <small>ãƒˆãƒ¼ã‚¯ä¸€è¦§ã®<i class="bi bi-bookmark"></i>ã‹ã‚‰<br>ãƒ¡ãƒ¢ã‚’ä¿å­˜ã§ãã¾ã™</small>
              </div>
            </div>
          `;
          return;
        }

        // Keepãƒ¡ãƒ¢ãƒ«ãƒ¼ãƒ ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
        const keepRoomId = roomSnapshot.docs[0].id;
        const messagesQuery = query(
          collection(db, 'rooms', keepRoomId, 'messages'),
          orderBy('timestamp', 'desc'),
          limit(50)
        );
        const messagesSnapshot = await getDocs(messagesQuery);

        if (messagesSnapshot.empty) {
          body.innerHTML = `
            <div class="keep-empty">
              <i class="bi bi-bookmark"></i>
              <div class="keep-empty-text">
                Keepãƒ¡ãƒ¢ãŒç©ºã§ã™<br>
                <small>ãƒˆãƒ¼ã‚¯ä¸€è¦§ã®<i class="bi bi-bookmark"></i>ã‹ã‚‰<br>ãƒ¡ãƒ¢ã‚’ä¿å­˜ã§ãã¾ã™</small>
              </div>
            </div>
          `;
          return;
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§ã‚’è¡¨ç¤º
        body.innerHTML = '';
        messagesSnapshot.forEach(msgDoc => {
          const msg = msgDoc.data();

          // ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿è¡¨ç¤ºï¼ˆéŸ³å£°ãƒ»ç”»åƒã¯é™¤å¤–ï¼‰
          if (!msg.text) return;

          const item = document.createElement('div');
          item.className = 'keep-item';
          item.onclick = () => sendKeepMessage(msg.text);

          // æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
          let dateStr = '';
          if (msg.timestamp) {
            const date = msg.timestamp.toDate ? msg.timestamp.toDate() : new Date(msg.timestamp);
            const now = new Date();
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
            if (diffDays === 0) {
              dateStr = date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays === 1) {
              dateStr = 'æ˜¨æ—¥';
            } else if (diffDays < 7) {
              dateStr = diffDays + 'æ—¥å‰';
            } else {
              dateStr = date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
            }
          }

          item.innerHTML = `
            <div class="keep-item-icon">
              <i class="bi bi-bookmark-fill"></i>
            </div>
            <div class="keep-item-content">
              <div class="keep-item-text">${escapeHtml(msg.text)}</div>
              <div class="keep-item-date">${dateStr}</div>
            </div>
          `;
          body.appendChild(item);
        });

      } catch (error) {
        console.error('[Keep] ã‚¨ãƒ©ãƒ¼:', error);
        body.innerHTML = `
          <div class="keep-empty">
            <i class="bi bi-exclamation-circle"></i>
            <div class="keep-empty-text">
              Keepã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ<br>
              <small>${escapeHtml(error.message)}</small>
            </div>
          </div>
        `;
      }
    };

    // Keepé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeKeepModal = function(event) {
      // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç›´æ¥ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã¿é–‰ã˜ã‚‹
      if (event && event.target.id !== 'keepModalOverlay') return;

      const overlay = document.getElementById('keepModalOverlay');
      const modal = document.getElementById('keepModal');

      modal.classList.remove('active');
      setTimeout(() => {
        overlay.classList.remove('active');
      }, 300);
    };

    // Keepãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒãƒ£ãƒƒãƒˆã«Keepãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦é€ä¿¡
    window.sendKeepMessage = async function(text) {
      console.log('[Keep] Keepãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡:', text.substring(0, 50) + '...');

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      closeKeepModal();

      try {
        // Keepã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦é€ä¿¡
        await addDoc(collection(db, 'rooms', currentRoomId, 'messages'), {
          text: text,
          userName: currentUserName,
          userEmail: currentUserEmail,
          sender: currentUserEmail,
          senderName: currentUserName,
          timestamp: serverTimestamp(),
          readBy: [currentUserEmail],
          fromKeep: true  // Keepã‹ã‚‰ã®é€ä¿¡ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°
        });

        // ãƒ«ãƒ¼ãƒ ã®æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
        const roomRef = doc(db, 'rooms', currentRoomId);
        await updateDoc(roomRef, {
          lastMessage: text.length > 30 ? text.substring(0, 30) + '...' : text,
          lastMessageAt: serverTimestamp(),
          lastMessageBy: currentUserName
        });

        console.log('[Keep] é€ä¿¡å®Œäº†');
      } catch (error) {
        console.error('[Keep] é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };

    // å‰Šé™¤æ©Ÿèƒ½ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ï¼‰â†’ é¸æŠãƒ¢ãƒ¼ãƒ‰é–‹å§‹ã«å¤‰æ›´ï¼ˆç¾åœ¨ã¯æœªä½¿ç”¨ï¼‰
    window.deleteMessageFromMenu = function() {
      if (!contextMenuData.messageId) return;

      // closeContextMenu()ã§contextMenuDataãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹å‰ã«IDã¨itemã‚’ä¿å­˜
      const messageId = contextMenuData.messageId;
      const messageItem = contextMenuData.item;

      closeContextMenu();

      // é¸æŠãƒ¢ãƒ¼ãƒ‰é–‹å§‹
      const container = document.getElementById('messagesContainer');
      const bar = document.getElementById('selectionModeBar');

      if (!container.classList.contains('selection-mode')) {
        container.classList.add('selection-mode');
        bar.classList.add('active');
      }

      // é¸æŠã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è‡ªå‹•é¸æŠ
      if (messageItem) {
        const checkbox = messageItem.querySelector('.message-checkbox');
        if (checkbox) {
          checkbox.checked = true;
          updateSelectionCount();
        }
      }
    };

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¢ã‚¤ãƒ†ãƒ ã«é•·æŠ¼ã—ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
    function addLongPressListener(item, messageId, messageText, isMine = false, fileUrl = null, fileName = null, senderName = null) {
      let touchStartTime = 0;
      let touchMoved = false;

      // ã‚¿ãƒƒãƒé–‹å§‹
      item.addEventListener('touchstart', (e) => {
        console.log('[LongPress] touchstart');
        touchStartTime = Date.now();
        touchMoved = false;

        longPressTimer = setTimeout(() => {
          console.log('[LongPress] Timer fired, touchMoved:', touchMoved);
          if (!touchMoved) {
            console.log('[LongPress] Opening context menu, isMine:', isMine);
            openContextMenu(messageId, messageText, item, isMine, fileUrl, fileName, senderName);
            // æŒ¯å‹•ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿ï¼‰
            if ('vibrate' in navigator) {
              navigator.vibrate(50);
            }
          }
        }, LONG_PRESS_DURATION);
      });

      // ã‚¿ãƒƒãƒç§»å‹•ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ¤œå‡ºï¼‰
      item.addEventListener('touchmove', () => {
        console.log('[LongPress] touchmove - canceling');
        touchMoved = true;
        if (longPressTimer) {
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
      });

      // ã‚¿ãƒƒãƒçµ‚äº†
      item.addEventListener('touchend', () => {
        if (longPressTimer) {
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
      });

      // ã‚¿ãƒƒãƒã‚­ãƒ£ãƒ³ã‚»ãƒ«
      item.addEventListener('touchcancel', () => {
        if (longPressTimer) {
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
      });

      // PCç”¨: å³ã‚¯ãƒªãƒƒã‚¯
      item.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        openContextMenu(messageId, messageText, item, isMine, fileUrl, fileName, senderName);
      });
    }

    // ========================================
    // ç”»åƒãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼æ©Ÿèƒ½
    // ========================================

    // ç”»åƒãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã‚’é–‹ã
    function openImageViewer(imageUrl) {
      console.log('[ImageViewer] ç”»åƒãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã‚’é–‹ã:', imageUrl);
      const viewer = document.getElementById('imageViewer');
      const viewerImg = document.getElementById('imageViewerImg');

      viewerImg.src = imageUrl;
      viewer.style.display = 'flex';

      // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ç”¨ã®ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ï¼ˆå°‘ã—é…å»¶ã•ã›ã¦é©ç”¨ï¼‰
      setTimeout(() => {
        viewer.classList.add('active');
      }, 10);
    }

    // ç”»åƒãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã‚’é–‰ã˜ã‚‹
    function closeImageViewer() {
      console.log('[ImageViewer] ç”»åƒãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã‚’é–‰ã˜ã‚‹');
      const viewer = document.getElementById('imageViewer');
      const viewerImg = document.getElementById('imageViewerImg');

      // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
      viewer.classList.remove('active');

      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«éè¡¨ç¤º
      setTimeout(() => {
        viewer.style.display = 'none';
        viewerImg.src = ''; // ãƒ¡ãƒ¢ãƒªè§£æ”¾
      }, 300); // CSSã®transitionæ™‚é–“ã¨åˆã‚ã›ã‚‹
    }

    // ç”»åƒãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    document.addEventListener('DOMContentLoaded', () => {
      const viewer = document.getElementById('imageViewer');
      const closeButton = document.getElementById('imageViewerClose');
      const viewerImg = document.getElementById('imageViewerImg');

      // Ã—ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      if (closeButton) {
        closeButton.addEventListener('click', (e) => {
          e.stopPropagation();
          closeImageViewer();
        });
      }

      // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹ï¼ˆç”»åƒè‡ªä½“ã®ã‚¯ãƒªãƒƒã‚¯ã§ã¯é–‰ã˜ãªã„ï¼‰
      if (viewer) {
        viewer.addEventListener('click', (e) => {
          if (e.target === viewer) {
            closeImageViewer();
          }
        });
      }

      // ç”»åƒã‚¯ãƒªãƒƒã‚¯ã§ã¯é–‰ã˜ãªã„ï¼ˆæ‹¡å¤§è¡¨ç¤ºç¶­æŒï¼‰
      if (viewerImg) {
        viewerImg.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      }

      // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
      const downloadButton = document.getElementById('imageViewerDownload');
      if (downloadButton) {
        downloadButton.addEventListener('click', (e) => {
          e.stopPropagation();
          downloadImage();
        });
      }
    });

    // ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼šæ–°è¦ã‚¿ãƒ–ã§ç›´æ¥é–‹ãï¼‰
    function downloadImage() {
      const viewerImg = document.getElementById('imageViewerImg');
      const imageUrl = viewerImg.src;

      // æ–°è¦ã‚¿ãƒ–ã§ç”»åƒURLã‚’ç›´æ¥é–‹ãï¼ˆæœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ã§ç¢ºå®Ÿï¼‰
      window.open(imageUrl, '_blank');
      showToast('ç”»åƒã‚’é•·æŠ¼ã—ã§ä¿å­˜ã§ãã¾ã™');
    }

    // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤º
    function showToast(message) {
      // æ—¢å­˜ã®ãƒˆãƒ¼ã‚¹ãƒˆãŒã‚ã‚Œã°å‰Šé™¤
      const existingToast = document.getElementById('downloadToast');
      if (existingToast) {
        existingToast.remove();
      }

      // ãƒˆãƒ¼ã‚¹ãƒˆã‚’ä½œæˆ
      const toast = document.createElement('div');
      toast.id = 'downloadToast';
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        z-index: 10002;
        opacity: 0;
        transition: opacity 0.3s ease;
      `;
      document.body.appendChild(toast);

      // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
      setTimeout(() => {
        toast.style.opacity = '1';
      }, 10);

      // 1ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã—ã¦å‰Šé™¤
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
          toast.remove();
        }, 300);
      }, 1000);
    }

    // ========== Agoraé€šè©±æ©Ÿèƒ½ ==========
    // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆAPP IDã®ã¿ã€ãƒˆãƒ¼ã‚¯ãƒ³ä¸è¦ï¼‰
    const AGORA_APP_ID = '10d16f783ccd4c97867c92475fa3fbc2';

    // Agoraãƒãƒ£ãƒ³ãƒãƒ«åã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼ˆ64ãƒã‚¤ãƒˆä»¥å†…ã€è‹±æ•°å­—ã¨_ã®ã¿ï¼‰
    const sanitizeChannelName = (roomId) => {
      const safe = (roomId || '').replace(/[^a-zA-Z0-9_]/g, '');
      return 'room_' + safe.substring(0, 58);
    };

    let agoraClient = null;
    let localAudioTrack = null;
    let callTimerInterval = null;
    let callStartTime = null;
    let isMuted = false;
    let isSpeakerOn = true;

    // é€šè©±é–‹å§‹
    // targetUserName, targetIconUrl: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‹ã‚‰ã®é€šè©±æ™‚ã«æŒ‡å®š
    window.showCallPreparing = async function(targetUserName, targetIconUrl) {
      const callButton = document.getElementById('callButton');
      if (callButton) callButton.blur();

      // ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ãŒå¿…è¦
      if (!currentRoomId) {
        alert('ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      // ãƒã‚¤ã‚¯æ¨©é™ã‚’ç¢ºèª
      try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch (err) {
        alert('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„');
        return;
      }

      // é€šè©±ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      const modal = document.getElementById('callModal');
      modal.style.display = 'flex';

      // ç›¸æ‰‹ã®åå‰ã‚’è¨­å®šï¼ˆå¼•æ•°ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°ãƒ«ãƒ¼ãƒ åã‹ã‚‰å–å¾—ï¼‰
      const displayName = targetUserName || document.getElementById('headerRoomName').textContent;
      document.getElementById('callUserName').textContent = displayName;
      document.getElementById('callStatus').textContent = 'æ¥ç¶šä¸­...';

      // ç›¸æ‰‹ã®ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’è¨­å®š
      const avatarContainer = document.getElementById('callUserAvatar');
      const iconUrl = targetIconUrl || getUserIconUrl(displayName);
      if (iconUrl) {
        avatarContainer.innerHTML = `<img src="${iconUrl}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" onerror="this.outerHTML='<i class=\\'bi bi-person-fill\\'></i>'">`;
      } else {
        avatarContainer.innerHTML = '<i class="bi bi-person-fill"></i>';
      }
      document.getElementById('callTimer').style.display = 'none';

      // Agoraé€šè©±ã‚’é–‹å§‹
      try {
        await startAgoraCall();
      } catch (err) {
        console.error('é€šè©±é–‹å§‹ã‚¨ãƒ©ãƒ¼:', err);
        // ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰åˆ¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        let errorMsg = 'æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ';
        if (err.code === 'INVALID_OPERATION') {
          errorMsg = 'ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ã§ã™';
        } else if (err.code === 'UID_CONFLICT') {
          errorMsg = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®é‡è¤‡';
        } else if (err.code === 'INVALID_PARAMS') {
          errorMsg = 'ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼';
        } else if (err.message) {
          errorMsg = err.message.substring(0, 30);
        }
        document.getElementById('callStatus').textContent = errorMsg;
        alert('é€šè©±ã‚¨ãƒ©ãƒ¼: ' + (err.message || err.code || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        setTimeout(() => endCall(), 3000);
      }
    };

    // Agoraé€šè©±é–‹å§‹
    async function startAgoraCall() {
      // Agoraã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆ
      agoraClient = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‚åŠ ã‚¤ãƒ™ãƒ³ãƒˆ
      agoraClient.on('user-joined', (user) => {
        console.log('â˜…ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒãƒ£ãƒ³ãƒãƒ«ã«å‚åŠ :', user.uid);
        document.getElementById('callStatus').textContent = 'ç›¸æ‰‹ãŒå‚åŠ ã—ã¾ã—ãŸ...';
      });

      agoraClient.on('user-published', async (user, mediaType) => {
        console.log('â˜…ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¬é–‹:', user.uid, mediaType);
        await agoraClient.subscribe(user, mediaType);
        console.log('â˜…è³¼èª­å®Œäº†:', user.uid);

        if (mediaType === 'audio') {
          user.audioTrack.play();
          // é€šè©±é–‹å§‹
          document.getElementById('callStatus').textContent = 'é€šè©±ä¸­';
          document.getElementById('callStatus').style.animation = 'none';
          startCallTimer();
        }
      });

      agoraClient.on('user-unpublished', (user) => {
        console.log('ãƒªãƒ¢ãƒ¼ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼é€€å‡º:', user.uid);
      });

      agoraClient.on('user-left', (user) => {
        console.log('ãƒªãƒ¢ãƒ¼ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé€€å‡ºã—ã¾ã—ãŸ');
        document.getElementById('callStatus').textContent = 'ç›¸æ‰‹ãŒé€€å‡ºã—ã¾ã—ãŸ';
        setTimeout(() => endCall(), 2000);
      });

      // æ¥ç¶šçŠ¶æ…‹å¤‰åŒ–
      agoraClient.on('connection-state-change', (curState, prevState) => {
        console.log('â˜…æ¥ç¶šçŠ¶æ…‹:', prevState, '->', curState);
      });

      // ãƒãƒ£ãƒ³ãƒãƒ«ã«å‚åŠ ï¼ˆãƒãƒ£ãƒ³ãƒãƒ«å = ãƒ«ãƒ¼ãƒ IDã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼‰
      const channelName = sanitizeChannelName(currentRoomId);
      console.log('â˜…Agoraãƒãƒ£ãƒ³ãƒãƒ«å:', channelName, 'å…ƒRoomID:', currentRoomId);
      const uid = await agoraClient.join(AGORA_APP_ID, channelName, null, null);
      console.log('â˜…Agoraãƒãƒ£ãƒ³ãƒãƒ«å‚åŠ æˆåŠŸ! ãƒãƒ£ãƒ³ãƒãƒ«:', channelName, 'UID:', uid);

      // éŸ³å£°ãƒˆãƒ©ãƒƒã‚¯ä½œæˆãƒ»å…¬é–‹
      localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
      await agoraClient.publish([localAudioTrack]);
      console.log('â˜…éŸ³å£°ãƒˆãƒ©ãƒƒã‚¯å…¬é–‹å®Œäº†');

      // ãƒãƒ£ãƒ³ãƒãƒ«åã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
      document.getElementById('callStatus').textContent = 'å‘¼ã³å‡ºã—ä¸­...';

      // ç›¸æ‰‹ã¸ã®é€šçŸ¥ã‚’Firestoreã«é€ä¿¡
      sendCallNotification();
    }

    // é€šè©±é€šçŸ¥ã‚’Firestoreã«é€ä¿¡
    let currentCallDocId = null;  // ç¾åœ¨ã®é€šè©±ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID

    async function sendCallNotification() {
      if (!db || !currentRoomId || !currentUserEmail) return;

      try {
        // Firebase v9 modular syntax
        const callsRef = collection(db, 'rooms', currentRoomId, 'calls');
        const callerIconUrl = getUserIconUrl(currentUserName) || null;
        const docRef = await addDoc(callsRef, {
          callerId: currentUserEmail,
          callerName: currentUserName || currentUserEmail.split('@')[0],
          callerIcon: callerIconUrl,
          channelName: sanitizeChannelName(currentRoomId),
          roomId: currentRoomId,
          status: 'calling',
          createdAt: serverTimestamp()
        });
        currentCallDocId = docRef.id;
        console.log('â˜…é€šè©±é€šçŸ¥é€ä¿¡:', currentCallDocId);
      } catch (err) {
        console.error('é€šè©±é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼:', err);
      }
    }

    // ========== ç€ä¿¡æ¤œçŸ¥ ==========
    let incomingCallListener = null;
    let currentIncomingCall = null;  // ç€ä¿¡ä¸­ã®é€šè©±æƒ…å ±
    let ringtoneInterval = null;     // ç€ä¿¡éŸ³ç”¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«
    let ringtoneContext = null;      // Web Audio API ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

    // ç€ä¿¡éŸ³ã‚’å†ç”Ÿ
    function playRingtone() {
      stopRingtone(); // æ—¢å­˜ã®ç€ä¿¡éŸ³ã‚’åœæ­¢

      // ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆéŸ³ãŒé³´ã‚‰ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
      const vibratePattern = () => {
        if ('vibrate' in navigator) {
          navigator.vibrate([200, 100, 200, 100, 200]); // ãƒ–ãƒ«ãƒ–ãƒ«
        }
      };

      // ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç¹°ã‚Šè¿”ã—
      vibratePattern();
      ringtoneInterval = setInterval(vibratePattern, 2000);

      // Web Audio APIã§ç€ä¿¡éŸ³ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒªã‚·ãƒ¼ã§é³´ã‚‰ãªã„å ´åˆã‚ã‚Šï¼‰
      try {
        ringtoneContext = new (window.AudioContext || window.webkitAudioContext)();

        // SuspendedçŠ¶æ…‹ã®å ´åˆã¯resumeè©¦è¡Œ
        if (ringtoneContext.state === 'suspended') {
          ringtoneContext.resume();
        }

        const playTone = (frequency, duration) => {
          if (ringtoneContext.state !== 'running') return;
          const oscillator = ringtoneContext.createOscillator();
          const gainNode = ringtoneContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(ringtoneContext.destination);

          oscillator.frequency.value = frequency;
          oscillator.type = 'sine';

          gainNode.gain.setValueAtTime(0.3, ringtoneContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, ringtoneContext.currentTime + duration);

          oscillator.start(ringtoneContext.currentTime);
          oscillator.stop(ringtoneContext.currentTime + duration);
        };

        // ç€ä¿¡éŸ³ãƒ‘ã‚¿ãƒ¼ãƒ³
        const ringPattern = () => {
          playTone(880, 0.15);
          setTimeout(() => playTone(440, 0.15), 150);
          setTimeout(() => playTone(880, 0.15), 300);
        };

        setTimeout(ringPattern, 100); // å°‘ã—é…å»¶ã—ã¦å†ç”Ÿ
      } catch (err) {
        console.log('ç€ä¿¡éŸ³ã‚¨ãƒ©ãƒ¼:', err);
      }
    }

    // ç€ä¿¡éŸ³ã‚’åœæ­¢
    function stopRingtone() {
      if (ringtoneInterval) {
        clearInterval(ringtoneInterval);
        ringtoneInterval = null;
      }
      if (ringtoneContext) {
        ringtoneContext.close().catch(() => {});
        ringtoneContext = null;
      }
      // ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢
      if ('vibrate' in navigator) {
        navigator.vibrate(0);
      }
    }

    // ç€ä¿¡ãƒªã‚¹ãƒŠãƒ¼ã‚’é–‹å§‹
    function startIncomingCallListener() {
      if (!db || !currentRoomId || !currentUserEmail) return;

      // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
      if (incomingCallListener) {
        incomingCallListener();
      }

      console.log('â˜…ç€ä¿¡ãƒªã‚¹ãƒŠãƒ¼é–‹å§‹:', currentRoomId);

      // Firebase v9 modular syntax
      const callsRef = collection(db, 'rooms', currentRoomId, 'calls');
      const callsQuery = query(callsRef, where('status', '==', 'calling'));

      // ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ ã®é€šè©±ã‚’ç›£è¦–
      incomingCallListener = onSnapshot(callsQuery, (snapshot) => {
        snapshot.docChanges().forEach(change => {
          if (change.type === 'added') {
            const callData = change.doc.data();
            console.log('â˜…é€šè©±æ¤œçŸ¥:', callData);

            // è‡ªåˆ†ãŒç™ºä¿¡è€…ã§ãªã„å ´åˆã¯ç€ä¿¡ã¨ã—ã¦å‡¦ç†
            if (callData.callerId !== currentUserEmail) {
              showIncomingCall(change.doc.id, callData);
            }
          } else if (change.type === 'modified') {
            const callData = change.doc.data();
            // é€šè©±ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆ
            if (callData.status === 'cancelled' || callData.status === 'ended') {
              hideIncomingCall();
            }
          } else if (change.type === 'removed') {
            hideIncomingCall();
          }
        });
      });
    }

    // ç€ä¿¡ä¸­ã®é€šè©±ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç›£è¦–ç”¨ãƒªã‚¹ãƒŠãƒ¼
    let currentCallDocListener = null;

    // ç€ä¿¡ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    function showIncomingCall(callId, callData) {
      currentIncomingCall = { id: callId, ...callData };

      document.getElementById('incomingCallerName').textContent = callData.callerName || 'ä¸æ˜';
      document.getElementById('incomingCallStatus').textContent = 'ç€ä¿¡ä¸­...';

      // ç™ºä¿¡è€…ã®ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’è¨­å®š
      const avatarContainer = document.getElementById('incomingCallerAvatar');
      if (avatarContainer) {
        if (callData.callerIcon) {
          avatarContainer.innerHTML = `<img src="${callData.callerIcon}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" onerror="this.outerHTML='<i class=\\'bi bi-telephone-inbound-fill\\'></i>'">`;
        } else {
          avatarContainer.innerHTML = '<i class="bi bi-telephone-inbound-fill"></i>';
        }
      }

      document.getElementById('incomingCallModal').style.display = 'flex';

      // ç€ä¿¡éŸ³ã‚’å†ç”Ÿ
      playRingtone();

      // ã“ã®é€šè©±ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç›´æ¥ç›£è¦–ï¼ˆç™ºä¿¡è€…ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå ´åˆã‚’æ¤œå‡ºï¼‰
      if (currentCallDocListener) {
        currentCallDocListener();
      }
      const callDocRef = doc(db, 'rooms', currentRoomId, 'calls', callId);
      currentCallDocListener = onSnapshot(callDocRef, (docSnapshot) => {
        if (docSnapshot.exists()) {
          const data = docSnapshot.data();
          console.log('â˜…é€šè©±ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå¤‰æ›´:', data.status);
          if (data.status === 'cancelled' || data.status === 'ended' || data.status === 'declined') {
            console.log('â˜…ç™ºä¿¡è€…ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«/çµ‚äº†ã—ã¾ã—ãŸ');
            hideIncomingCall();
          }
        } else {
          // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚ŒãŸ
          console.log('â˜…é€šè©±ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‰Šé™¤');
          hideIncomingCall();
        }
      });

      console.log('â˜…ç€ä¿¡è¡¨ç¤º:', callData.callerName);
    }

    // ç€ä¿¡ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º
    function hideIncomingCall() {
      currentIncomingCall = null;
      document.getElementById('incomingCallModal').style.display = 'none';
      stopRingtone(); // ç€ä¿¡éŸ³ã‚’åœæ­¢

      // é€šè©±ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
      if (currentCallDocListener) {
        currentCallDocListener();
        currentCallDocListener = null;
      }
    }

    // ç€ä¿¡ã«å¿œç­”
    window.acceptCall = async function() {
      if (!currentIncomingCall) return;

      console.log('â˜…ç€ä¿¡å¿œç­”:', currentIncomingCall);

      // ç€ä¿¡ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ãƒ»ç€ä¿¡éŸ³åœæ­¢
      document.getElementById('incomingCallModal').style.display = 'none';
      stopRingtone();

      // é€šè©±ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      const modal = document.getElementById('callModal');
      modal.style.display = 'flex';
      document.getElementById('callUserName').textContent = currentIncomingCall.callerName;
      document.getElementById('callStatus').textContent = 'æ¥ç¶šä¸­...';

      // ç™ºä¿¡è€…ã®ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’è¨­å®š
      const avatarContainer = document.getElementById('callUserAvatar');
      if (currentIncomingCall.callerIcon) {
        avatarContainer.innerHTML = `<img src="${currentIncomingCall.callerIcon}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" onerror="this.outerHTML='<i class=\\'bi bi-person-fill\\'></i>'">`;
      } else {
        avatarContainer.innerHTML = '<i class="bi bi-person-fill"></i>';
      }

      // ãƒã‚¤ã‚¯æ¨©é™ã‚’ç¢ºèª
      try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch (err) {
        alert('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„');
        modal.style.display = 'none';
        return;
      }

      // Agoraé€šè©±ã«å‚åŠ 
      try {
        await joinAgoraCall(currentIncomingCall.channelName);

        // é€šè©±ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–° (Firebase v9)
        const callDocRef = doc(db, 'rooms', currentRoomId, 'calls', currentIncomingCall.id);
        await updateDoc(callDocRef, { status: 'answered' });

      } catch (err) {
        console.error('é€šè©±å‚åŠ ã‚¨ãƒ©ãƒ¼:', err);
        alert('é€šè©±ã¸ã®å‚åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
        modal.style.display = 'none';
      }

      currentIncomingCall = null;
    };

    // ç€ä¿¡ã‚’æ‹’å¦
    window.declineCall = async function() {
      if (!currentIncomingCall) return;

      console.log('â˜…ç€ä¿¡æ‹’å¦');

      try {
        // é€šè©±ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–° (Firebase v9)
        const callDocRef = doc(db, 'rooms', currentRoomId, 'calls', currentIncomingCall.id);
        await updateDoc(callDocRef, { status: 'declined' });
      } catch (err) {
        console.error('æ‹’å¦æ›´æ–°ã‚¨ãƒ©ãƒ¼:', err);
      }

      hideIncomingCall();
    };

    // Agoraãƒãƒ£ãƒ³ãƒãƒ«ã«å‚åŠ ï¼ˆå¿œç­”å´ç”¨ï¼‰
    async function joinAgoraCall(channelName) {
      // Agoraã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆ
      agoraClient = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      agoraClient.on('user-joined', (user) => {
        console.log('â˜…ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒãƒ£ãƒ³ãƒãƒ«ã«å‚åŠ :', user.uid);
      });

      agoraClient.on('user-published', async (user, mediaType) => {
        console.log('â˜…ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¬é–‹:', user.uid, mediaType);
        await agoraClient.subscribe(user, mediaType);

        if (mediaType === 'audio') {
          user.audioTrack.play();
          document.getElementById('callStatus').textContent = 'é€šè©±ä¸­';
          document.getElementById('callStatus').style.animation = 'none';
          startCallTimer();
        }
      });

      agoraClient.on('user-left', (user) => {
        console.log('â˜…ãƒ¦ãƒ¼ã‚¶ãƒ¼é€€å‡º');
        document.getElementById('callStatus').textContent = 'ç›¸æ‰‹ãŒé€€å‡ºã—ã¾ã—ãŸ';
        setTimeout(() => endCall(), 2000);
      });

      // ãƒãƒ£ãƒ³ãƒãƒ«ã«å‚åŠ 
      console.log('â˜…å¿œç­”å´: ãƒãƒ£ãƒ³ãƒãƒ«å‚åŠ :', channelName);
      const uid = await agoraClient.join(AGORA_APP_ID, channelName, null, null);
      console.log('â˜…å¿œç­”å´: å‚åŠ æˆåŠŸ, UID:', uid);

      // éŸ³å£°ãƒˆãƒ©ãƒƒã‚¯ä½œæˆãƒ»å…¬é–‹
      localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
      await agoraClient.publish([localAudioTrack]);
      console.log('â˜…å¿œç­”å´: éŸ³å£°å…¬é–‹å®Œäº†');

      document.getElementById('callStatus').textContent = 'é€šè©±ä¸­';

      // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ï¼ˆã¾ã é–‹å§‹ã•ã‚Œã¦ã„ãªã„å ´åˆï¼‰
      if (!callStartTime) {
        startCallTimer();
      }
    }

    // é€šè©±çµ‚äº†
    window.endCall = async function() {
      // é€šè©±æ™‚é–“ã‚’è¨ˆç®—
      let callDuration = 0;
      if (callStartTime) {
        callDuration = Math.floor((Date.now() - callStartTime) / 1000);
      }

      // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
      if (callTimerInterval) {
        clearInterval(callTimerInterval);
        callTimerInterval = null;
      }

      // éŸ³å£°ãƒˆãƒ©ãƒƒã‚¯åœæ­¢
      if (localAudioTrack) {
        localAudioTrack.stop();
        localAudioTrack.close();
        localAudioTrack = null;
      }

      // Agoraãƒãƒ£ãƒ³ãƒãƒ«é€€å‡º
      if (agoraClient) {
        await agoraClient.leave();
        agoraClient = null;
      }

      // Firestoreã®é€šè©±ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ï¼ˆç›¸æ‰‹ã«é€šçŸ¥ï¼‰
      if (currentCallDocId && db && currentRoomId) {
        try {
          const callDocRef = doc(db, 'rooms', currentRoomId, 'calls', currentCallDocId);
          await updateDoc(callDocRef, {
            status: callDuration > 0 ? 'ended' : 'cancelled',
            endedAt: serverTimestamp()
          });
          console.log('â˜…é€šè©±ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°:', callDuration > 0 ? 'ended' : 'cancelled');
        } catch (err) {
          console.error('é€šè©±ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', err);
        }
      }

      // é€šè©±å±¥æ­´ã‚’ãƒãƒ£ãƒƒãƒˆã«é€ä¿¡ï¼ˆé€šè©±ãŒæˆç«‹ã—ãŸå ´åˆã®ã¿ï¼‰
      if (callDuration > 0 && db && currentRoomId && currentUserName) {
        try {
          const minutes = Math.floor(callDuration / 60);
          const seconds = callDuration % 60;
          const durationText = minutes > 0
            ? `${minutes}åˆ†${seconds}ç§’`
            : `${seconds}ç§’`;

          await addDoc(collection(db, `rooms/${currentRoomId}/messages`), {
            text: `é€šè©±çµ‚äº† (${durationText})`,
            userName: currentUserName,
            userEmail: currentUserEmail,
            timestamp: serverTimestamp(),
            deleted: [],
            type: 'call',
            callDuration: callDuration
          });

          // lastMessageæ›´æ–°
          const roomRef = doc(db, 'rooms', currentRoomId);
          await updateDoc(roomRef, {
            lastMessage: `é€šè©± (${durationText})`,
            lastMessageAt: serverTimestamp(),
            lastMessageBy: currentUserName
          });

          console.log('â˜…é€šè©±å±¥æ­´é€ä¿¡:', durationText);
        } catch (err) {
          console.error('é€šè©±å±¥æ­´é€ä¿¡ã‚¨ãƒ©ãƒ¼:', err);
        }
      }

      // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
      isMuted = false;
      isSpeakerOn = true;
      callStartTime = null;
      currentCallDocId = null;
      document.getElementById('callMuteBtn').classList.remove('active');
      document.getElementById('callSpeakerBtn').classList.remove('active');
      document.getElementById('callMuteIcon').className = 'bi bi-mic-fill';

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      document.getElementById('callModal').style.display = 'none';
    };

    // ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆ
    window.toggleCallMute = function() {
      if (!localAudioTrack) return;

      isMuted = !isMuted;
      localAudioTrack.setEnabled(!isMuted);

      const btn = document.getElementById('callMuteBtn');
      const icon = document.getElementById('callMuteIcon');

      if (isMuted) {
        btn.classList.add('active');
        icon.className = 'bi bi-mic-mute-fill';
      } else {
        btn.classList.remove('active');
        icon.className = 'bi bi-mic-fill';
      }
    };

    // ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼åˆ‡ã‚Šæ›¿ãˆï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰
    window.toggleCallSpeaker = function() {
      isSpeakerOn = !isSpeakerOn;
      const btn = document.getElementById('callSpeakerBtn');
      const icon = document.getElementById('callSpeakerIcon');

      if (!isSpeakerOn) {
        btn.classList.add('active');
        icon.className = 'bi bi-volume-mute-fill';
      } else {
        btn.classList.remove('active');
        icon.className = 'bi bi-volume-up-fill';
      }
      // å®Ÿéš›ã®éŸ³é‡åˆ¶å¾¡ã¯ç«¯æœ«ä¾å­˜ã®ãŸã‚é™å®šçš„
    };

    // é€šè©±ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
    function startCallTimer() {
      callStartTime = Date.now();
      document.getElementById('callTimer').style.display = 'block';

      callTimerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const seconds = (elapsed % 60).toString().padStart(2, '0');
        document.getElementById('callTimer').textContent = `${minutes}:${seconds}`;
      }, 1000);
    }

    // ========== ãƒãƒ£ãƒƒãƒˆè¨­å®šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ ==========
    function toggleChatSettings(event) {
      event.stopPropagation();
      const dropdown = document.getElementById('chatSettingsDropdown');
      dropdown.classList.toggle('active');

      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‹ã„ãŸæ™‚ã«çŠ¶æ…‹ã‚’æ›´æ–°
      if (dropdown.classList.contains('active')) {
        updateSettingsMenuState();
      }
    }

    // è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®çŠ¶æ…‹ã‚’æ›´æ–°
    async function updateSettingsMenuState() {
      if (!currentRoomId || !currentUserEmail) return;

      try {
        // ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼APIä½¿ç”¨ï¼‰
        const roomRef = doc(db, 'rooms', currentRoomId);
        const roomDoc = await getDoc(roomRef);
        const roomData = roomDoc.data();

        // ãƒŸãƒ¥ãƒ¼ãƒˆçŠ¶æ…‹ã‚’ç¢ºèª
        const isMuted = roomData.mutedBy && roomData.mutedBy.includes(currentUserEmail);
        const muteText = document.getElementById('muteRoomText');
        const muteBtn = document.getElementById('muteRoomBtn');
        if (isMuted) {
          muteText.textContent = 'é€šçŸ¥ã‚’ã‚ªãƒ³';
          muteBtn.querySelector('i').className = 'bi bi-bell';
        } else {
          muteText.textContent = 'é€šçŸ¥ã‚’ã‚ªãƒ•';
          muteBtn.querySelector('i').className = 'bi bi-bell-slash';
        }

        // ãƒ–ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’ç¢ºèªï¼ˆå€‹åˆ¥ãƒãƒ£ãƒƒãƒˆã®ã¿ï¼‰
        const blockBtn = document.getElementById('blockUserBtn');
        const blockText = document.getElementById('blockUserText');

        if (roomData.type === 'direct') {
          // ç›¸æ‰‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ç‰¹å®šï¼ˆmembersã«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒå…¥ã£ã¦ã„ã‚‹ï¼‰
          const otherUserEmail = roomData.members.find(m => m !== currentUserName);

          // è‡ªåˆ†ã®ãƒ–ãƒ­ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ç¢ºèª
          const userRef = doc(db, 'users', currentUserEmail);
          const userDoc = await getDoc(userRef);
          const userData = userDoc.data() || {};
          // è‡ªåˆ†è‡ªèº«ã‚’é™¤å¤–ã—ãŸãƒ–ãƒ­ãƒƒã‚¯ãƒªã‚¹ãƒˆ
          const blockedUsers = (userData.blockedUsers || []).filter(
            u => u !== currentUserName && u !== currentUserEmail
          );

          const isBlocked = blockedUsers.includes(otherUserEmail);
          if (isBlocked) {
            blockText.textContent = 'ãƒ–ãƒ­ãƒƒã‚¯è§£é™¤';
            blockBtn.querySelector('i').className = 'bi bi-slash-circle-fill';
          } else {
            blockText.textContent = 'ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹';
            blockBtn.querySelector('i').className = 'bi bi-slash-circle';
          }
          blockBtn.style.display = 'flex';
          blockBtn.dataset.targetUser = otherUserEmail;
        } else {
          // ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆã§ã¯ãƒ–ãƒ­ãƒƒã‚¯ãƒœã‚¿ãƒ³éè¡¨ç¤º
          blockBtn.style.display = 'none';
        }

        // é€€å‡ºãƒœã‚¿ãƒ³ã®è¡¨ç¤ºï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆã®ã¿ï¼‰
        const leaveBtn = document.getElementById('leaveRoomBtn');
        if (roomData.type === 'group') {
          leaveBtn.style.display = 'flex';
        } else {
          leaveBtn.style.display = 'none';
        }

      } catch (error) {
        console.error('[Settings] çŠ¶æ…‹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ãƒ–ãƒ­ãƒƒã‚¯/ãƒ–ãƒ­ãƒƒã‚¯è§£é™¤
    async function toggleBlockUser() {
      const blockBtn = document.getElementById('blockUserBtn');
      const targetUser = blockBtn.dataset.targetUser;
      const blockText = document.getElementById('blockUserText');

      console.log('[Block] targetUser:', targetUser, 'currentUserEmail:', currentUserEmail);

      if (!targetUser) {
        showSettingsToast('ãƒ–ãƒ­ãƒƒã‚¯å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        console.error('[Block] targetUser is empty');
        return;
      }
      if (!currentUserEmail) {
        showSettingsToast('ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        console.error('[Block] currentUserEmail is empty');
        return;
      }

      // è‡ªåˆ†è‡ªèº«ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ã‚ˆã†ã«ã‚¬ãƒ¼ãƒ‰
      if (targetUser === currentUserName || targetUser === currentUserEmail) {
        showSettingsToast('è‡ªåˆ†è‡ªèº«ã¯ãƒ–ãƒ­ãƒƒã‚¯ã§ãã¾ã›ã‚“');
        console.error('[Block] è‡ªåˆ†è‡ªèº«ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã‚ˆã†ã¨ã—ã¾ã—ãŸ');
        closeChatSettings();
        return;
      }

      const isCurrentlyBlocked = blockText.textContent === 'ãƒ–ãƒ­ãƒƒã‚¯è§£é™¤';

      // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
      const action = isCurrentlyBlocked ? 'ãƒ–ãƒ­ãƒƒã‚¯ã‚’è§£é™¤' : 'ãƒ–ãƒ­ãƒƒã‚¯';
      if (!confirm(`ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’${action}ã—ã¾ã™ã‹ï¼Ÿ`)) {
        closeChatSettings();
        return;
      }

      try {
        const userRef = doc(db, 'users', currentUserEmail);

        if (isCurrentlyBlocked) {
          // ãƒ–ãƒ­ãƒƒã‚¯è§£é™¤
          await updateDoc(userRef, {
            blockedUsers: arrayRemove(targetUser)
          });

          // ãƒ«ãƒ¼ãƒ ã®éè¡¨ç¤ºã‚‚è§£é™¤ï¼ˆãƒ–ãƒ­ãƒƒã‚¯æ™‚ã«éè¡¨ç¤ºã«ãªã£ã¦ã„ãŸå ´åˆï¼‰
          console.log('[Block] éè¡¨ç¤ºè§£é™¤ãƒã‚§ãƒƒã‚¯ - currentRoomId:', currentRoomId, ', currentUserName:', currentUserName);
          if (currentRoomId && currentUserName) {
            try {
              const roomRef = doc(db, 'rooms', currentRoomId);
              // æ›´æ–°å‰ã®çŠ¶æ…‹ã‚’ç¢ºèª
              const roomSnap = await getDoc(roomRef);
              if (roomSnap.exists()) {
                const roomData = roomSnap.data();
                console.log('[Block] æ›´æ–°å‰ hiddenBy:', roomData.hiddenBy);
              }

              await updateDoc(roomRef, {
                hiddenBy: arrayRemove(currentUserName)
              });
              console.log('[Block] âœ… ãƒ«ãƒ¼ãƒ ã®éè¡¨ç¤ºã‚‚è§£é™¤å®Œäº†');
            } catch (unhideError) {
              console.error('[Block] âŒ éè¡¨ç¤ºè§£é™¤ã‚¨ãƒ©ãƒ¼:', unhideError);
            }
          } else {
            console.warn('[Block] âš ï¸ currentRoomId or currentUserName is empty, skipping unhide');
          }

          showSettingsToast('ãƒ–ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¾ã—ãŸ');
          blockText.textContent = 'ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹';
          blockBtn.querySelector('i').className = 'bi bi-slash-circle';
          isBlockedByMe = false; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ›´æ–°
        } else {
          // ãƒ–ãƒ­ãƒƒã‚¯
          await setDoc(userRef, {
            blockedUsers: arrayUnion(targetUser)
          }, { merge: true });
          showSettingsToast('ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸ');
          blockText.textContent = 'ãƒ–ãƒ­ãƒƒã‚¯è§£é™¤';
          blockBtn.querySelector('i').className = 'bi bi-slash-circle-fill';
          isBlockedByMe = true; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ›´æ–°
        }

        // UIã‚’æ›´æ–°ï¼ˆå…¥åŠ›æ¬„ã®è¡¨ç¤º/éè¡¨ç¤ºï¼‰
        updateBlockedUI();

        closeChatSettings();

        // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚’æ›´æ–°
        setTimeout(() => {
          location.reload();
        }, 500);

      } catch (error) {
        console.error('[Block] Firestoreã‚¨ãƒ©ãƒ¼:', error);
        showSettingsToast('ãƒ–ãƒ­ãƒƒã‚¯å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error.code || 'Unknown'));
      }
    }

    // ãƒŸãƒ¥ãƒ¼ãƒˆ/ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤
    async function toggleMuteRoom() {
      if (!currentRoomId || !currentUserEmail) return;

      const muteText = document.getElementById('muteRoomText');
      const isCurrentlyMuted = muteText.textContent === 'é€šçŸ¥ã‚’ã‚ªãƒ³';

      try {
        const roomRef = doc(db, 'rooms', currentRoomId);

        if (isCurrentlyMuted) {
          // ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤
          await updateDoc(roomRef, {
            mutedBy: arrayRemove(currentUserEmail)
          });
          showSettingsToast('é€šçŸ¥ã‚’ã‚ªãƒ³ã«ã—ã¾ã—ãŸ');
          muteText.textContent = 'é€šçŸ¥ã‚’ã‚ªãƒ•';
          document.getElementById('muteRoomBtn').querySelector('i').className = 'bi bi-bell-slash';
        } else {
          // ãƒŸãƒ¥ãƒ¼ãƒˆ
          await updateDoc(roomRef, {
            mutedBy: arrayUnion(currentUserEmail)
          });
          showSettingsToast('é€šçŸ¥ã‚’ã‚ªãƒ•ã«ã—ã¾ã—ãŸ');
          muteText.textContent = 'é€šçŸ¥ã‚’ã‚ªãƒ³';
          document.getElementById('muteRoomBtn').querySelector('i').className = 'bi bi-bell';
        }

        closeChatSettings();

      } catch (error) {
        console.error('[Mute] ã‚¨ãƒ©ãƒ¼:', error);
        showSettingsToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    }

    // ã‚°ãƒ«ãƒ¼ãƒ—é€€å‡ºç¢ºèª
    function confirmLeaveRoom() {
      if (!confirm('ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰é€€å‡ºã—ã¾ã™ã‹ï¼Ÿ')) {
        closeChatSettings();
        return;
      }
      leaveRoom();
    }

    // ã‚°ãƒ«ãƒ¼ãƒ—é€€å‡º
    async function leaveRoom() {
      if (!currentRoomId || !currentUserEmail) return;

      try {
        const roomRef = doc(db, 'rooms', currentRoomId);

        // ãƒ¡ãƒ³ãƒãƒ¼ã‹ã‚‰å‰Šé™¤
        await updateDoc(roomRef, {
          members: arrayRemove(currentUserEmail)
        });

        showSettingsToast('ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰é€€å‡ºã—ã¾ã—ãŸ');
        closeChatSettings();

        // ãƒãƒ£ãƒƒãƒˆä¸€è¦§ã«æˆ»ã‚‹
        setTimeout(() => {
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({ type: 'navigateToChat' }, '*');
          }
        }, 500);

      } catch (error) {
        console.error('[Leave] ã‚¨ãƒ©ãƒ¼:', error);
        showSettingsToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    }

    // è¨­å®šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
    function closeChatSettings() {
      document.getElementById('chatSettingsDropdown').classList.remove('active');
    }

    // ç”»é¢å¤–ã‚¯ãƒªãƒƒã‚¯ã§è¨­å®šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
    document.addEventListener('click', function(e) {
      const dropdown = document.getElementById('chatSettingsDropdown');
      const settingsBtn = document.getElementById('chatSettingsButton');
      if (dropdown && settingsBtn && !dropdown.contains(e.target) && !settingsBtn.contains(e.target)) {
        dropdown.classList.remove('active');
      }
    });

    // è¨­å®šç”¨ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
    function showSettingsToast(message) {
      const existingToast = document.getElementById('settingsToast');
      if (existingToast) existingToast.remove();

      const toast = document.createElement('div');
      toast.id = 'settingsToast';
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 24px;
        border-radius: 24px;
        font-size: 14px;
        z-index: 9999;
      `;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 2000);
    }

    // ========== ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«é–¢æ•°ã‚’ç™»éŒ²ï¼ˆonclickç”¨ï¼‰ ==========
    window.toggleChatSettings = toggleChatSettings;
    window.toggleBlockUser = toggleBlockUser;
    window.toggleMuteRoom = toggleMuteRoom;
    window.confirmLeaveRoom = confirmLeaveRoom;

  </script>

  <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³å‡¦ç† -->
<script>
  console.log('[chat_ui_firestore] âœ… Script loaded - Version @902-whisper');
  
  async function goBack() {
    console.log('[chat_ui_firestore] >>> goBack() called at', new Date().toISOString());
    const isInIframe = window.self !== window.top;
    console.log('[chat_ui_firestore] isInIframe:', isInIframe);

    if (isInIframe) {
      // ğŸ”§ v302: ãƒœãƒˆãƒ ãƒŠãƒ“è¡¨ç¤ºã¯index.htmlå´ã§è¡Œã†ï¼ˆã‚«ã‚¯ã¤ãé˜²æ­¢ï¼‰
      // showBottomNavã‚’å…ˆã«é€ã‚‹ã¨ã€ç”»é¢é·ç§»å‰ã«ãƒœãƒˆãƒ ãƒŠãƒ“ãŒè¡¨ç¤ºã•ã‚Œã¦ã‚«ã‚¯ã¤ã

      console.log('[chat_ui_firestore] iframeå†…ã§é–‹ã‹ã‚Œã¦ã„ã‚‹ãŸã‚ã€postMessageé€ä¿¡ï¼ˆãƒˆãƒ¼ã‚¯ä¸€è¦§ã¸æˆ»ã‚‹ï¼‰');
      window.top.postMessage({ type: 'navigateToChat' }, '*');
      console.log('[chat_ui_firestore] âœ… postMessageé€ä¿¡å®Œäº†');
    } else {
      console.log('[chat_ui_firestore] ç›´æ¥é–‹ã‹ã‚Œã¦ã„ã‚‹ãŸã‚ã€google.script.host.close()');
      google.script.host.close();
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    console.log('[chat_ui_firestore] DOMContentLoaded fired');
    const backButton = document.getElementById('back-button');
    console.log('[chat_ui_firestore] backButton element:', backButton);

    if (backButton) {
      backButton.addEventListener('click', goBack);
      console.log('[chat_ui_firestore] âœ… æˆ»ã‚‹ãƒœã‚¿ãƒ³ã«goBack()ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ');
    } else {
      console.error('[chat_ui_firestore] âŒ æˆ»ã‚‹ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }

    // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³åç´æ©Ÿèƒ½
    const messageInput = document.getElementById('messageInput');
    const expandButton = document.getElementById('expandButton');
    const collapsibleButtons = document.querySelectorAll('.collapsible-button');

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›æ¬„ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚: 3ã¤ã®ãƒœã‚¿ãƒ³ã‚’åç´ã€å±•é–‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    messageInput.addEventListener('focus', function() {
      console.log('[Accordion] Input focused - collapsing buttons');
      collapsibleButtons.forEach(btn => {
        btn.classList.add('collapsed');
      });
      expandButton.style.display = 'flex';
      // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¡¨ç¤ºæ™‚ï¼šä½™ç™½ã‚’ç¸®å°
      document.getElementById('messagesContainer').classList.add('keyboard-visible');
      document.querySelector('.input-container').classList.add('keyboard-visible');
    });

    messageInput.addEventListener('blur', function() {
      // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰éè¡¨ç¤ºæ™‚ï¼šä½™ç™½ã‚’å…ƒã«æˆ»ã™
      document.getElementById('messagesContainer').classList.remove('keyboard-visible');
      document.querySelector('.input-container').classList.remove('keyboard-visible');
      
      // ãƒœã‚¿ãƒ³ã‚’å†å±•é–‹ï¼ˆå±•é–‹ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã€3ã¤ã®ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼‰
      console.log('[Accordion] Input blurred - expanding buttons');
      collapsibleButtons.forEach(btn => {
        btn.classList.remove('collapsed');
      });
      expandButton.style.display = 'none';
    });

    // å±•é–‹ãƒœã‚¿ãƒ³ï¼šã‚¿ãƒƒãƒ/ã‚¯ãƒªãƒƒã‚¯ã§3ã¤ã®ãƒœã‚¿ãƒ³ã‚’å†è¡¨ç¤º
    let expandButtonProcessing = false;
    
    function handleExpandButton(e) {
      e.preventDefault();
      e.stopPropagation();
      
      // äºŒé‡å®Ÿè¡Œé˜²æ­¢
      if (expandButtonProcessing) return;
      expandButtonProcessing = true;
      
      console.log('[Accordion] Expand button activated - showing buttons');
      collapsibleButtons.forEach(btn => {
        btn.classList.remove('collapsed');
      });
      expandButton.style.display = 'none';
      messageInput.blur();
      
      // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
      setTimeout(() => {
        expandButtonProcessing = false;
      }, 300);
    }
    
    expandButton.addEventListener('click', handleExpandButton);
    expandButton.addEventListener('touchend', handleExpandButton);

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ã‚’ã‚¿ãƒƒãƒ—ã—ãŸæ™‚ã«ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’é–‰ã˜ã‚‹ï¼ˆLINEé¢¨ï¼‰
    const messagesContainer = document.getElementById('messagesContainer');
    messagesContainer.addEventListener('touchstart', function(e) {
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹å ´åˆã®ã¿
      if (document.activeElement === messageInput) {
        console.log('[Accordion] Messages area tapped - closing keyboard');
        messageInput.blur();
      }
    });

    // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯å„ã‚¢ã‚¤ãƒ†ãƒ ã®Ã—ãƒœã‚¿ãƒ³ã§å€‹åˆ¥å‰Šé™¤
    // clearAllImages()ã§å…¨å‰Šé™¤ã‚‚å¯èƒ½
  });
</script>

<!-- ç”»åƒãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ï¼ˆLINEé¢¨ï¼‰ -->
<div class="image-viewer" id="imageViewer" style="display: none;">
  <button class="image-viewer-close" id="imageViewerClose">
    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="18" y1="6" x2="6" y2="18"></line>
      <line x1="6" y1="6" x2="18" y2="18"></line>
    </svg>
  </button>
  <img id="imageViewerImg" src="" alt="ç”»åƒ">
  <!-- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ -->
  <button class="image-viewer-download" id="imageViewerDownload">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
      <polyline points="7 10 12 15 17 10"></polyline>
      <line x1="12" y1="15" x2="12" y2="3"></line>
    </svg>
  </button>
</div>

<!-- ========== é€šè©±ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç™ºä¿¡å´ï¼‰ ========== -->
<div class="call-modal" id="callModal" style="display: none;">
  <div class="call-modal-content">
    <!-- ç›¸æ‰‹æƒ…å ± -->
    <div class="call-user-info">
      <div class="call-user-avatar" id="callUserAvatar">
        <i class="bi bi-person-fill"></i>
      </div>
      <div class="call-user-name" id="callUserName">ç›¸æ‰‹ã®åå‰</div>
      <div class="call-status" id="callStatus">ç™ºä¿¡ä¸­...</div>
      <div class="call-timer" id="callTimer" style="display: none;">00:00</div>
    </div>

    <!-- é€šè©±ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
    <div class="call-controls">
      <button class="call-control-btn" id="callMuteBtn" onclick="toggleCallMute()">
        <i class="bi bi-mic-fill" id="callMuteIcon"></i>
        <span>ãƒŸãƒ¥ãƒ¼ãƒˆ</span>
      </button>
      <button class="call-control-btn call-end-btn" id="callEndBtn" onclick="endCall()">
        <i class="bi bi-telephone-x-fill"></i>
        <span>çµ‚äº†</span>
      </button>
      <button class="call-control-btn" id="callSpeakerBtn" onclick="toggleCallSpeaker()">
        <i class="bi bi-volume-up-fill" id="callSpeakerIcon"></i>
        <span>ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼</span>
      </button>
    </div>
  </div>
</div>

<!-- ========== ç€ä¿¡ãƒ¢ãƒ¼ãƒ€ãƒ« ========== -->
<div class="call-modal" id="incomingCallModal" style="display: none;">
  <div class="call-modal-content">
    <!-- ç™ºä¿¡è€…æƒ…å ± -->
    <div class="call-user-info">
      <div class="call-user-avatar incoming-pulse" id="incomingCallerAvatar">
        <i class="bi bi-telephone-inbound-fill"></i>
      </div>
      <div class="call-user-name" id="incomingCallerName">ç™ºä¿¡è€…</div>
      <div class="call-status" id="incomingCallStatus">ç€ä¿¡ä¸­...</div>
    </div>

    <!-- ç€ä¿¡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆå¿œç­”/æ‹’å¦ï¼‰ -->
    <div class="call-controls incoming-controls">
      <button class="call-control-btn call-decline-btn" onclick="declineCall()">
        <i class="bi bi-telephone-x-fill"></i>
        <span>æ‹’å¦</span>
      </button>
      <button class="call-control-btn call-accept-btn" onclick="acceptCall()">
        <i class="bi bi-telephone-fill"></i>
        <span>å¿œç­”</span>
      </button>
    </div>
  </div>
</div>

<!-- é€šè©±ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨CSS -->
<style>
.call-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
}

.call-modal-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  height: 100%;
  padding: 60px 20px 40px;
  box-sizing: border-box;
}

.call-user-info {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-top: 40px;
}

.call-user-avatar {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: rgba(255,255,255,0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 24px;
}

.call-user-avatar i {
  font-size: 60px;
  color: rgba(255,255,255,0.7);
}

.call-user-avatar img {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  object-fit: cover;
}

.call-user-name {
  font-size: 24px;
  font-weight: 600;
  color: white;
  margin-bottom: 8px;
}

.call-status {
  font-size: 16px;
  color: rgba(255,255,255,0.7);
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 0.7; }
  50% { opacity: 1; }
}

.call-timer {
  font-size: 20px;
  color: white;
  font-weight: 500;
  margin-top: 8px;
}

.call-controls {
  display: flex;
  gap: 32px;
  margin-bottom: 40px;
}

.call-control-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  background: none;
  border: none;
  cursor: pointer;
  padding: 12px;
}

.call-control-btn i {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: rgba(255,255,255,0.15);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
  transition: all 0.2s;
}

.call-control-btn span {
  font-size: 12px;
  color: rgba(255,255,255,0.8);
}

.call-control-btn:active i {
  transform: scale(0.95);
}

.call-control-btn.active i {
  background: white;
  color: #1a1a2e;
}

.call-end-btn i {
  background: #e53935 !important;
  color: white !important;
}

.call-end-btn:active i {
  background: #c62828 !important;
}

/* ç€ä¿¡ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨CSS */
.incoming-pulse {
  animation: incoming-ring 1s ease-in-out infinite;
}

@keyframes incoming-ring {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

.incoming-controls {
  gap: 60px !important;
}

.call-decline-btn i {
  background: #e53935 !important;
  color: white !important;
}

.call-accept-btn i {
  background: #4caf50 !important;
  color: white !important;
}

.call-accept-btn:active i {
  background: #388e3c !important;
}

.call-decline-btn:active i {
  background: #c62828 !important;
}
</style>

</body>
</html>
