<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- PERM-001: æ¨©é™ãƒã‚§ãƒƒã‚¯å®Ÿè£…æ¸ˆã¿ -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Furira ãƒ¡ãƒ‹ãƒ¥ãƒ¼</title>
  <link rel="stylesheet" href="https://www.reborn-inventory.com/css/reborn-brand-colors.css?v=9635">
  <link rel="stylesheet" href="https://www.reborn-inventory.com/css/reborn-theme.css?v=9635">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .menu-container {
      width: 100%;
      max-width: 500px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 30px 20px;
      margin: auto;
    }

    .menu-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .menu-logo {
      width: 280px;
      height: auto;
      margin: -35px auto -45px;
      display: block;
    }

    .menu-subtitle {
      font-size: 14px;
      color: #6b7280;
    }

    .menu-items {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .menu-item {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 18px 20px;
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: space-between;
      text-decoration: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .menu-item.full-width {
      grid-column: 1 / -1;
    }

    .menu-item:active {
      transform: scale(0.98);
      background: #f9fafb;
    }

    .menu-item:hover {
      border-color: var(--reborn-primary);
      background: var(--reborn-primary-lightest);
    }

    .menu-item.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f9fafb;
    }

    .menu-item.disabled:active {
      transform: none;
    }

    .menu-item-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .menu-item-icon {
      font-size: 24px;
    }

    .menu-item-arrow {
      font-size: 14px;
      color: #9ca3af;
      transition: transform 0.2s;
    }

    /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    .accordion-menu {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.2s;
      grid-column: 1 / -1;
    }

    .accordion-header {
      padding: 18px 20px;
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      transition: background 0.2s;
    }

    .accordion-header:active {
      background: #f9fafb;
    }

    .accordion-header:hover {
      background: #f9f5ff;
    }

    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
      background: #f9fafb;
    }

    .accordion-content.open {
      max-height: 1000px;
    }

    .accordion-item {
      padding: 14px 20px 14px 56px;
      font-size: 15px;
      color: #4b5563;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      transition: background 0.2s;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      border-top: 1px solid #e5e7eb;
    }

    .accordion-item:active {
      background: #f3f4f6;
    }

    .accordion-item:hover {
      background: #f3f4f6;
    }

    .accordion-item.coming-soon {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .accordion-item.coming-soon:active {
      background: transparent;
    }

    .accordion-arrow {
      transition: transform 0.3s;
      font-size: 14px;
      color: #9ca3af;
    }

    .accordion-arrow.open {
      transform: rotate(180deg);
    }

    .coming-soon-badge {
      font-size: 11px;
      background: #fbbf24;
      color: #78350f;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
      margin-left: auto;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 480px) {
      .menu-container {
        padding: 24px 16px;
      }

      .menu-title {
        font-size: 24px;
      }

      .menu-item {
        padding: 16px 18px;
        font-size: 15px;
      }

      .menu-item-icon {
        font-size: 22px;
      }
    }
  </style>
</head>
<body>
  <div class="menu-container">
    <div class="menu-header">
      <img src="https://reborn-inventory-system.pages.dev/images/furira-square-logo.png" alt="Furira" class="menu-logo">
      <div class="menu-subtitle">ãƒ•ãƒªãƒåœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </div>
    </div>

    <div class="menu-items">
      <!-- å•†å“ç™»éŒ² -->
      <a href="#" onclick="navigateToPage('product'); return false;" class="menu-item">
        <div class="menu-item-content">
          <span class="menu-item-icon">ğŸ“</span>
          <span>å•†å“ç™»éŒ²</span>
        </div>
      </a>

      <!-- åœ¨åº«ç®¡ç† -->
      <a href="#" onclick="navigateToPage('inventory'); return false;" class="menu-item">
        <div class="menu-item-content">
          <span class="menu-item-icon">ğŸ“¦</span>
          <span>åœ¨åº«ç®¡ç†</span>
        </div>
      </a>

      <!-- å…¥å‡ºåº«å±¥æ­´ -->
      <a href="#" onclick="navigateToPage('inventory_history'); return false;" class="menu-item">
        <div class="menu-item-content">
          <span class="menu-item-icon">ğŸ“Š</span>
          <span>å…¥å‡ºåº«å±¥æ­´</span>
        </div>
      </a>

      <!-- æ£šå¸ -->
      <a href="#" class="menu-item disabled">
        <div class="menu-item-content">
          <span class="menu-item-icon">ğŸ“‹</span>
          <span>æ£šå¸</span>
        </div>
      </a>

      <!-- ä»•å…¥ï¼è²·æ› -->
      <a href="#" class="menu-item disabled">
        <div class="menu-item-content">
          <span class="menu-item-icon">ğŸ’°</span>
          <span>ä»•å…¥ï¼è²·æ›</span>
        </div>
      </a>

      <!-- å£²ä¸Šï¼å£²æ› -->
      <a href="#" class="menu-item disabled">
        <div class="menu-item-content">
          <span class="menu-item-icon">ğŸ’µ</span>
          <span>å£²ä¸Šï¼å£²æ›</span>
        </div>
      </a>

      <!-- å£²ä¸Šåˆ†æ -->
      <a href="#" class="menu-item disabled">
        <div class="menu-item-content">
          <span class="menu-item-icon">ğŸ“ˆ</span>
          <span>å£²ä¸Šåˆ†æ</span>
        </div>
      </a>

      <!-- ãƒãƒ£ãƒƒãƒˆ -->
      <a href="#" onclick="navigateToPage('chat'); return false;" class="menu-item">
        <div class="menu-item-content">
          <span class="menu-item-icon">ğŸ’¬</span>
          <span>ãƒãƒ£ãƒƒãƒˆ</span>
        </div>
      </a>

      <!-- ãƒã‚¹ã‚¿ç®¡ç†ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ -->
      <div class="accordion-menu">
        <div class="accordion-header" onclick="toggleAccordion('master')">
          <div class="menu-item-content">
            <span class="menu-item-icon">ğŸ—‚ï¸</span>
            <span>ãƒã‚¹ã‚¿ç®¡ç†</span>
          </div>
          <span class="accordion-arrow" id="master-arrow">â–¼</span>
        </div>
        <div class="accordion-content" id="master-content">
          <a href="#" onclick="navigateToPage('master-product'); return false;" class="accordion-item">
            <span>ğŸ“¦ å•†å“é–¢é€£ãƒã‚¹ã‚¿ç®¡ç†</span>
          </a>
          <a href="#" onclick="navigateToPage('master-business'); return false;" class="accordion-item">
            <span>ğŸ¢ æ¥­å‹™é–¢é€£ãƒã‚¹ã‚¿ç®¡ç†</span>
          </a>
        </div>
      </div>

      <!-- è¨­å®šç®¡ç†ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ -->
      <div class="accordion-menu">
        <div class="accordion-header" onclick="toggleAccordion('config')">
          <div class="menu-item-content">
            <span class="menu-item-icon">âš™ï¸</span>
            <span>è¨­å®šç®¡ç†</span>
          </div>
          <span class="accordion-arrow" id="config-arrow">â–¼</span>
        </div>
        <div class="accordion-content" id="config-content">
          <a href="#" onclick="navigateToPage('config-system'); return false;" class="accordion-item">
            <span>âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</span>
          </a>
          <a href="#" onclick="navigateToPage('config-product'); return false;" class="accordion-item" id="menu-config-product">
            <span>ğŸ“ å•†å“ç™»éŒ²è¨­å®š</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- æ¨©é™ã«ã‚ˆã‚‹å³æ™‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¶å¾¡ï¼ˆPERM-001 v3ï¼‰ -->
  <script>
    (function() {
      // ä¸¡æ–¹ã®ã‚­ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆåˆæœŸè¨­å®šæ™‚ã¯_idã€ãã®å¾Œã¯ãªã—ï¼‰
      var permissionId = localStorage.getItem('reborn_user_permission_id')
                      || localStorage.getItem('reborn_user_permission');

      if (permissionId && permissionId !== 'owner') {
        var el = document.getElementById('menu-config-product');
        if (el) el.style.display = 'none';
      }
    })();
  </script>

  <!-- Firebase SDK (compatç‰ˆ: UMDå½¢å¼) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    console.log('[menu_home] ========== ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿é–‹å§‹ ==========');

    // Firebaseè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "reborn-chat.firebaseapp.com",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    let db = null;
    let firestoreReady = false;

    // FirebaseåˆæœŸåŒ–
    try {
      console.log('[menu_home] FirebaseåˆæœŸåŒ–é–‹å§‹');
      console.log('[menu_home] firebase:', typeof firebase);

      if (typeof firebase === 'undefined') {
        throw new Error('Firebase SDK ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
      }

      // FirebaseåˆæœŸåŒ–ï¼ˆæ—¢å­˜ã‚¢ãƒ—ãƒªãŒã‚ã‚Œã°å†åˆ©ç”¨ï¼‰
      const app = firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      firestoreReady = true;

      console.log('[menu_home] âœ… FirebaseåˆæœŸåŒ–å®Œäº†');
      console.log('[menu_home] firebase.apps.length:', firebase.apps.length);
      console.log('[menu_home] db:', db);

      // DOMãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', checkUserPermissionAndUpdateMenu);
      } else {
        // DOMãŒæ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯å³åº§ã«å®Ÿè¡Œ
        checkUserPermissionAndUpdateMenu();
      }

    } catch (error) {
      console.error('[menu_home] âŒ FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      console.error('[menu_home] error.message:', error.message);
      console.error('[menu_home] error.stack:', error.stack);
    }

    // ================= æ¨©é™ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ï¼ˆPERM-001ï¼‰ =================
    async function checkUserPermissionAndUpdateMenu() {
      try {
        const userEmail = localStorage.getItem('reborn_user_email');
        const userName = localStorage.getItem('reborn_user_name');

        if (!userEmail) {
          console.warn('[menu_home] âš ï¸ æ¨©é™ãƒã‚§ãƒƒã‚¯: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        console.log('[menu_home] ğŸ” æ¨©é™ãƒã‚§ãƒƒã‚¯é–‹å§‹:', userName, '(', userEmail, ')');

        if (!db) {
          console.warn('[menu_home] âš ï¸ æ¨©é™ãƒã‚§ãƒƒã‚¯: FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
          return;
        }

        const userDoc = await db.collection('users').doc(userEmail).get();

        if (!userDoc.exists) {
          console.warn('[menu_home] âš ï¸ æ¨©é™ãƒã‚§ãƒƒã‚¯: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        const userData = userDoc.data();
        const permissionId = userData.permissionId || 'staff';
        const permissionDisplay = userData.permissionDisplay || 'ã‚¹ã‚¿ãƒƒãƒ•';

        console.log('[menu_home] ğŸ” æ¨©é™:', permissionDisplay, '(ID:', permissionId + ')');

        // æ¨©é™ã‚’localStorageã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        localStorage.setItem('reborn_user_permission', permissionId);

        // ã‚ªãƒ¼ãƒŠãƒ¼ä»¥å¤–ã®å ´åˆã€å•†å“ç™»éŒ²è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’éè¡¨ç¤º
        if (permissionId !== 'owner') {
          const productConfigMenu = document.getElementById('menu-config-product');
          if (productConfigMenu) {
            productConfigMenu.style.display = 'none';
            console.log('[menu_home] ğŸ”’ å•†å“ç™»éŒ²è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
          }
        } else {
          console.log('[menu_home] âœ… ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ - å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º');
        }

      } catch (error) {
        console.error('[menu_home] âŒ æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®é–‹é–‰
    window.toggleAccordion = function(type) {
      const content = document.getElementById(type + '-content');
      const arrow = document.getElementById(type + '-arrow');

      if (!content || !arrow) {
        console.error('[menu_home] âŒ ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', type);
        return;
      }

      console.log('[menu_home] content.classList:', content.classList);
      console.log('[menu_home] arrow.classList:', arrow.classList);

      if (content.classList.contains('open')) {
        content.classList.remove('open');
        arrow.classList.remove('open');
        console.log('[menu_home] âœ… ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’é–‰ã˜ã¾ã—ãŸ');
      } else {
        content.classList.add('open');
        arrow.classList.add('open');
        console.log('[menu_home] âœ… ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’é–‹ãã¾ã—ãŸ');
      }
    };

    // å‰Šé™¤ï¼šopenPWAPage / openGASPage ã¯ä½¿ç”¨ã—ãªã„ï¼ˆnavigateToPageã‚’ä½¿ç”¨ï¼‰

    // ãƒšãƒ¼ã‚¸é·ç§»ï¼ˆFirestoreçµŒç”±ã§è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«é€šçŸ¥ï¼‰
    window.navigateToPage = async function(page) {
      console.log('[menu_home] ========== navigateToPageé–‹å§‹ ==========');
      console.log('[menu_home] é·ç§»å…ˆ:', page);

      console.log('[menu_home] firestoreReady:', firestoreReady);

      if (!firestoreReady || !db) {
        console.error('[menu_home] âŒ FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        alert('ã‚¨ãƒ©ãƒ¼: FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      try {
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼ˆPWAç‰ˆï¼‰
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('sessionId') || '';
        console.log('[menu_home] Firestoreæ›¸ãè¾¼ã¿é–‹å§‹...');
        console.log('[menu_home] sessionId:', sessionId);

        // Firestoreã®navigationã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«æ›¸ãè¾¼ã¿
        await db.collection('navigation').doc('menuControl').set({
          action: 'navigate',
          page: page,
          sessionId: sessionId,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          from: 'menu_home'
        });

        console.log('[menu_home] âœ… Firestoreæ›¸ãè¾¼ã¿æˆåŠŸ');
        console.log('[menu_home] ========== navigateToPageå®Œäº† ==========');

      } catch (error) {
        console.error('[menu_home] âŒ Firestoreã‚¨ãƒ©ãƒ¼:', error);
        console.error('[menu_home] error.message:', error.message);
        console.error('[menu_home] error.stack:', error.stack);
        alert('ã‚¨ãƒ©ãƒ¼: ãƒšãƒ¼ã‚¸é·ç§»ã«å¤±æ•—ã—ã¾ã—ãŸ - ' + error.message);
      }
    };

    console.log('[menu_home] ========== ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº† ==========');
  </script>
</body>
</html>
