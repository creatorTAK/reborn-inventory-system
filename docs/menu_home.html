<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- PERM-001: æ¨©é™ãƒã‚§ãƒƒã‚¯å®Ÿè£…æ¸ˆã¿ -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Furira ãƒ¡ãƒ‹ãƒ¥ãƒ¼</title>
  <link rel="stylesheet" href="https://www.reborn-inventory.com/css/reborn-brand-colors.css?v=9635">
  <link rel="stylesheet" href="https://www.reborn-inventory.com/css/reborn-theme.css?v=9635">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .menu-container {
      position: relative;
      width: 100%;
      max-width: 500px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 30px 20px;
      margin: auto;
    }

    .menu-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .menu-logo {
      width: 280px;
      height: auto;
      margin: -35px auto -45px;
      display: block;
    }

    .menu-subtitle {
      font-size: 14px;
      color: #6b7280;
    }

    .menu-items {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .menu-item {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 18px 20px;
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: space-between;
      text-decoration: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .menu-item.full-width {
      grid-column: 1 / -1;
    }

    .menu-item:active {
      transform: scale(0.98);
      background: #f9fafb;
    }

    .menu-item:hover {
      border-color: var(--reborn-primary);
      background: var(--reborn-primary-lightest);
    }

    .menu-item.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f9fafb;
    }

    .menu-item.disabled:active {
      transform: none;
    }

    .menu-item-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .menu-item-icon {
      font-size: 24px;
    }

    .menu-item-arrow {
      font-size: 14px;
      color: #9ca3af;
      transition: transform 0.2s;
    }

    /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    .accordion-menu {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.2s;
      grid-column: 1 / -1;
    }

    .accordion-header {
      padding: 18px 20px;
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      transition: background 0.2s;
    }

    .accordion-header:active {
      background: #f9fafb;
    }

    .accordion-header:hover {
      background: #f9f5ff;
    }

    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
      background: #f9fafb;
    }

    .accordion-content.open {
      max-height: 1000px;
    }

    .accordion-item {
      padding: 14px 20px 14px 56px;
      font-size: 15px;
      color: #4b5563;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      transition: background 0.2s;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      border-top: 1px solid #e5e7eb;
    }

    .accordion-item:active {
      background: #f3f4f6;
    }

    .accordion-item:hover {
      background: #f3f4f6;
    }

    .accordion-item.coming-soon {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .accordion-item.coming-soon:active {
      background: transparent;
    }

    .accordion-arrow {
      transition: transform 0.3s;
      font-size: 14px;
      color: #9ca3af;
    }

    .accordion-arrow.open {
      transform: rotate(180deg);
    }

    .coming-soon-badge {
      font-size: 11px;
      background: #fbbf24;
      color: #78350f;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
      margin-left: auto;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 480px) {
      .menu-container {
        padding: 24px 16px;
      }

      .menu-title {
        font-size: 24px;
      }

      .menu-item {
        padding: 16px 18px;
        font-size: 15px;
      }

      .menu-item-icon {
        font-size: 22px;
      }
    }

    .menu-footer {
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
      text-align: center;
    }

    .menu-footer-links {
      display: flex;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .menu-footer-links a {
      color: #6b7280;
      font-size: 12px;
      text-decoration: none;
    }

    .menu-footer-links a:hover {
      color: var(--reborn-primary);
      text-decoration: underline;
    }

    .menu-footer-copyright {
      color: #9ca3af;
      font-size: 11px;
      margin-top: 8px;
    }

    /* ãƒŸãƒ‹ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆå³ä¸Šã‚¢ã‚¤ã‚³ãƒ³ï¼‰ */
    .mini-header {
      position: absolute;
      top: 16px;
      right: 16px;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .mini-header-icon {
      position: relative;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .mini-header-icon:hover {
      background: rgba(0, 0, 0, 0.05);
    }

    .mini-header-icon:active {
      transform: scale(0.95);
    }

    .mini-header-icon .icon {
      font-size: 22px;
    }

    .mini-header-icon .user-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
    }

    /* ãƒŸãƒ‹ãƒ˜ãƒƒãƒ€ãƒ¼ç”¨ãƒãƒƒã‚¸ */
    .mini-badge {
      position: absolute;
      top: 0;
      right: 0;
      background: #ef4444;
      color: white;
      border-radius: 50%;
      min-width: 16px;
      height: 16px;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
      padding: 0 4px;
      line-height: 1;
    }

    .mini-badge.active {
      display: flex;
    }

    /* ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”¨ãƒãƒƒã‚¸ */
    .menu-item-badge {
      background: #ef4444;
      color: white;
      border-radius: 10px;
      min-width: 20px;
      height: 20px;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      padding: 0 6px;
      margin-left: 8px;
    }

    .menu-item-badge.active {
      display: flex;
    }
  </style>
</head>
<body>
  <div class="menu-container">
    <!-- ãƒŸãƒ‹ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆå³ä¸Šã‚¢ã‚¤ã‚³ãƒ³ï¼‰ -->
    <div class="mini-header">
      <div class="mini-header-icon" onclick="navigateToPage('todo')" title="ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆ">
        <span class="icon">âœ”ï¸</span>
        <span class="mini-badge" id="mini-todo-badge">0</span>
      </div>
      <div class="mini-header-icon" onclick="navigateToPage('config-system')" title="ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š" id="mini-user-icon">
        <span class="icon" id="user-icon-placeholder">ğŸ‘¤</span>
      </div>
    </div>

    <div class="menu-header">
      <img src="https://reborn-inventory-system.pages.dev/images/furira-square-logo.png" alt="Furira" class="menu-logo">
      <div class="menu-subtitle">ãƒ•ãƒªãƒåœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </div>
    </div>

    <div class="menu-items">
      <!-- å•†å“ç™»éŒ² -->
      <a href="#" onclick="navigateToPage('product'); return false;" class="menu-item" id="menu-product">
        <div class="menu-item-content">
          <span class="menu-item-icon">ğŸ“</span>
          <span>å•†å“ç™»éŒ²</span>
        </div>
      </a>

      <!-- åœ¨åº«ç®¡ç† -->
      <a href="#" onclick="navigateToPage('inventory'); return false;" class="menu-item" id="menu-inventory">
        <div class="menu-item-content">
          <span class="menu-item-icon">ğŸ“¦</span>
          <span>åœ¨åº«ç®¡ç†</span>
        </div>
      </a>

      <!-- å…¥å‡ºåº«å±¥æ­´ -->
      <a href="#" onclick="navigateToPage('inventory_history'); return false;" class="menu-item" id="menu-inventory_history">
        <div class="menu-item-content">
          <span class="menu-item-icon">ğŸ“Š</span>
          <span>å…¥å‡ºåº«å±¥æ­´</span>
        </div>
      </a>

      <!-- æ£šå¸ -->
      <a href="#" class="menu-item disabled" id="menu-stocktaking">
        <div class="menu-item-content">
          <span class="menu-item-icon">ğŸ“‹</span>
          <span>æ£šå¸</span>
        </div>
      </a>

      <!-- ä»•å…¥ï¼è²·æ› -->
      <a href="#" class="menu-item disabled" id="menu-purchase">
        <div class="menu-item-content">
          <span class="menu-item-icon">ğŸ’°</span>
          <span>ä»•å…¥ï¼è²·æ›</span>
        </div>
      </a>

      <!-- å£²ä¸Šï¼å£²æ› -->
      <a href="#" class="menu-item disabled" id="menu-sales">
        <div class="menu-item-content">
          <span class="menu-item-icon">ğŸ’µ</span>
          <span>å£²ä¸Šï¼å£²æ›</span>
        </div>
      </a>

      <!-- å£²ä¸Šåˆ†æ -->
      <a href="#" class="menu-item disabled" id="menu-sales-analysis">
        <div class="menu-item-content">
          <span class="menu-item-icon">ğŸ“ˆ</span>
          <span>å£²ä¸Šåˆ†æ</span>
        </div>
      </a>

      <!-- ãƒãƒ£ãƒƒãƒˆ -->
      <a href="#" onclick="navigateToPage('chat'); return false;" class="menu-item" id="menu-chat">
        <div class="menu-item-content">
          <span class="menu-item-icon">ğŸ’¬</span>
          <span>ãƒãƒ£ãƒƒãƒˆ</span>
          <span class="menu-item-badge" id="chat-menu-badge">0</span>
        </div>
      </a>

      <!-- ãƒã‚¹ã‚¿ç®¡ç†ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ -->
      <div class="accordion-menu">
        <div class="accordion-header" onclick="toggleAccordion('master')">
          <div class="menu-item-content">
            <span class="menu-item-icon">ğŸ—‚ï¸</span>
            <span>ãƒã‚¹ã‚¿ç®¡ç†</span>
          </div>
          <span class="accordion-arrow" id="master-arrow">â–¼</span>
        </div>
        <div class="accordion-content" id="master-content">
          <a href="#" onclick="navigateToPage('master-product'); return false;" class="accordion-item" id="menu-master-product">
            <span>ğŸ“¦ å•†å“é–¢é€£ãƒã‚¹ã‚¿ç®¡ç†</span>
          </a>
          <a href="#" onclick="navigateToPage('master-business'); return false;" class="accordion-item" id="menu-master-business">
            <span>ğŸ¢ æ¥­å‹™é–¢é€£ãƒã‚¹ã‚¿ç®¡ç†</span>
          </a>
        </div>
      </div>

      <!-- è¨­å®šç®¡ç†ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ -->
      <div class="accordion-menu">
        <div class="accordion-header" onclick="toggleAccordion('config')">
          <div class="menu-item-content">
            <span class="menu-item-icon">âš™ï¸</span>
            <span>è¨­å®šç®¡ç†</span>
          </div>
          <span class="accordion-arrow" id="config-arrow">â–¼</span>
        </div>
        <div class="accordion-content" id="config-content">
          <a href="#" onclick="navigateToPage('config-system'); return false;" class="accordion-item">
            <span>âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</span>
          </a>
          <a href="#" onclick="navigateToPage('config-product'); return false;" class="accordion-item" id="menu-config-product">
            <span>ğŸ“ å•†å“ç™»éŒ²è¨­å®š</span>
          </a>
        </div>
      </div>
    </div>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <div class="menu-footer">
      <div class="menu-footer-links">
        <a href="/privacy-policy.html" target="_blank">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
        <a href="/terms-of-service.html" target="_blank">åˆ©ç”¨è¦ç´„</a>
      </div>
      <div class="menu-footer-copyright">Â© 2025 ãƒ•ãƒªãƒ©</div>
    </div>
  </div>

  <!-- æ¨©é™ã«ã‚ˆã‚‹å³æ™‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¶å¾¡ï¼ˆPERM-001 v3ï¼‰ -->
  <script>
    (function() {
      // ä¸¡æ–¹ã®ã‚­ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆåˆæœŸè¨­å®šæ™‚ã¯_idã€ãã®å¾Œã¯ãªã—ï¼‰
      var permissionId = localStorage.getItem('reborn_user_permission_id')
                      || localStorage.getItem('reborn_user_permission');

      if (permissionId && permissionId !== 'owner') {
        var el = document.getElementById('menu-config-product');
        if (el) el.style.display = 'none';
      }
    })();
  </script>

  <!-- Firebase SDK (compatç‰ˆ: UMDå½¢å¼) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    console.log('[menu_home] ========== ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿é–‹å§‹ ==========');

    // Firebaseè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "furira.jp",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    let db = null;
    let firestoreReady = false;

    // FirebaseåˆæœŸåŒ–
    try {
      console.log('[menu_home] FirebaseåˆæœŸåŒ–é–‹å§‹');
      console.log('[menu_home] firebase:', typeof firebase);

      if (typeof firebase === 'undefined') {
        throw new Error('Firebase SDK ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
      }

      // FirebaseåˆæœŸåŒ–ï¼ˆæ—¢å­˜ã‚¢ãƒ—ãƒªãŒã‚ã‚Œã°å†åˆ©ç”¨ï¼‰
      const app = firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      firestoreReady = true;

      console.log('[menu_home] âœ… FirebaseåˆæœŸåŒ–å®Œäº†');
      console.log('[menu_home] firebase.apps.length:', firebase.apps.length);
      console.log('[menu_home] db:', db);

      // DOMãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', checkUserPermissionAndUpdateMenu);
      } else {
        // DOMãŒæ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯å³åº§ã«å®Ÿè¡Œ
        checkUserPermissionAndUpdateMenu();
      }

    } catch (error) {
      console.error('[menu_home] âŒ FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      console.error('[menu_home] error.message:', error.message);
      console.error('[menu_home] error.stack:', error.stack);
    }

    // ================= æ¨©é™ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ï¼ˆPERM-001 v4ï¼‰ =================
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼IDã¨è¦ç´ IDã®ãƒãƒƒãƒ”ãƒ³ã‚°
    const MENU_ID_MAP = {
      'product': 'menu-product',
      'inventory': 'menu-inventory',
      'inventory_history': 'menu-inventory_history',
      'stocktaking': 'menu-stocktaking',
      'purchase': 'menu-purchase',
      'sales': 'menu-sales',
      'sales-analysis': 'menu-sales-analysis',
      'chat': 'menu-chat',
      'master-product': 'menu-master-product',
      'master-business': 'menu-master-business',
      'config-product': 'menu-config-product',
      'config-system': 'menu-config-system'
    };

    async function checkUserPermissionAndUpdateMenu() {
      try {
        const userEmail = localStorage.getItem('reborn_user_email');
        const userName = localStorage.getItem('reborn_user_name');

        if (!userEmail) {
          console.warn('[menu_home] âš ï¸ æ¨©é™ãƒã‚§ãƒƒã‚¯: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        console.log('[menu_home] ğŸ” æ¨©é™ãƒã‚§ãƒƒã‚¯é–‹å§‹:', userName, '(', userEmail, ')');

        if (!db) {
          console.warn('[menu_home] âš ï¸ æ¨©é™ãƒã‚§ãƒƒã‚¯: FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
          return;
        }

        // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™IDã‚’å–å¾—
        const userDoc = await db.collection('users').doc(userEmail).get();

        if (!userDoc.exists) {
          console.warn('[menu_home] âš ï¸ æ¨©é™ãƒã‚§ãƒƒã‚¯: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        const userData = userDoc.data();
        const permissionId = userData.permissionId || 'staff';
        const permissionDisplay = userData.permissionDisplay || 'ã‚¹ã‚¿ãƒƒãƒ•';

        console.log('[menu_home] ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™:', permissionDisplay, '(ID:', permissionId + ')');

        // æ¨©é™ã‚’localStorageã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        localStorage.setItem('reborn_user_permission', permissionId);

        // ã‚ªãƒ¼ãƒŠãƒ¼ã¯å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º
        if (permissionId === 'owner') {
          console.log('[menu_home] âœ… ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ - å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º');
          return;
        }

        // 2. ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ¨©é™è¨­å®šã‚’å–å¾—
        const menuPermDoc = await db.collection('settings').doc('menuPermissions').get();

        if (!menuPermDoc.exists) {
          console.log('[menu_home] â„¹ï¸ ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ¨©é™è¨­å®šãªã— - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤º');
          return;
        }

        const menuPermissions = menuPermDoc.data();
        console.log('[menu_home] ğŸ“‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ¨©é™è¨­å®š:', menuPermissions);

        // 3. å„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ¶å¾¡
        let hiddenCount = 0;
        for (const [menuId, elementId] of Object.entries(MENU_ID_MAP)) {
          const menuPerm = menuPermissions[menuId];
          const element = document.getElementById(elementId);

          if (!element) continue;

          // visibleToã«æ¨©é™IDãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          const isVisible = !menuPerm || !menuPerm.visibleTo || menuPerm.visibleTo.includes(permissionId);

          if (!isVisible) {
            element.style.display = 'none';
            hiddenCount++;
            console.log('[menu_home] ğŸ”’ ãƒ¡ãƒ‹ãƒ¥ãƒ¼éè¡¨ç¤º:', menuId);
          }
        }

        console.log('[menu_home] âœ… æ¨©é™ãƒã‚§ãƒƒã‚¯å®Œäº† - éè¡¨ç¤ºãƒ¡ãƒ‹ãƒ¥ãƒ¼æ•°:', hiddenCount);

      } catch (error) {
        console.error('[menu_home] âŒ æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®é–‹é–‰
    window.toggleAccordion = function(type) {
      const content = document.getElementById(type + '-content');
      const arrow = document.getElementById(type + '-arrow');

      if (!content || !arrow) {
        console.error('[menu_home] âŒ ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', type);
        return;
      }

      console.log('[menu_home] content.classList:', content.classList);
      console.log('[menu_home] arrow.classList:', arrow.classList);

      if (content.classList.contains('open')) {
        content.classList.remove('open');
        arrow.classList.remove('open');
        console.log('[menu_home] âœ… ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’é–‰ã˜ã¾ã—ãŸ');
      } else {
        content.classList.add('open');
        arrow.classList.add('open');
        console.log('[menu_home] âœ… ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’é–‹ãã¾ã—ãŸ');
      }
    };

    // å‰Šé™¤ï¼šopenPWAPage / openGASPage ã¯ä½¿ç”¨ã—ãªã„ï¼ˆnavigateToPageã‚’ä½¿ç”¨ï¼‰

    // ãƒšãƒ¼ã‚¸é·ç§»ï¼ˆFirestoreçµŒç”±ã§è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«é€šçŸ¥ï¼‰
    window.navigateToPage = async function(page) {
      console.log('[menu_home] ========== navigateToPageé–‹å§‹ ==========');
      console.log('[menu_home] é·ç§»å…ˆ:', page);

      console.log('[menu_home] firestoreReady:', firestoreReady);

      if (!firestoreReady || !db) {
        console.error('[menu_home] âŒ FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        alert('ã‚¨ãƒ©ãƒ¼: FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      try {
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼ˆPWAç‰ˆï¼‰
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('sessionId') || '';
        console.log('[menu_home] Firestoreæ›¸ãè¾¼ã¿é–‹å§‹...');
        console.log('[menu_home] sessionId:', sessionId);

        // Firestoreã®navigationã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«æ›¸ãè¾¼ã¿
        await db.collection('navigation').doc('menuControl').set({
          action: 'navigate',
          page: page,
          sessionId: sessionId,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          from: 'menu_home'
        });

        console.log('[menu_home] âœ… Firestoreæ›¸ãè¾¼ã¿æˆåŠŸ');
        console.log('[menu_home] ========== navigateToPageå®Œäº† ==========');

      } catch (error) {
        console.error('[menu_home] âŒ Firestoreã‚¨ãƒ©ãƒ¼:', error);
        console.error('[menu_home] error.message:', error.message);
        console.error('[menu_home] error.stack:', error.stack);
        alert('ã‚¨ãƒ©ãƒ¼: ãƒšãƒ¼ã‚¸é·ç§»ã«å¤±æ•—ã—ã¾ã—ãŸ - ' + error.message);
      }
    };

    // ================= ãƒãƒƒã‚¸æ›´æ–°æ©Ÿèƒ½ =================

    // ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆãƒãƒƒã‚¸æ›´æ–°
    function updateTodoBadge(count) {
      console.log('[menu_home] Todo ãƒãƒƒã‚¸æ›´æ–°:', count);
      const badge = document.getElementById('mini-todo-badge');
      if (badge) {
        if (count > 0) {
          badge.textContent = count > 99 ? '99+' : count.toString();
          badge.classList.add('active');
        } else {
          badge.textContent = '0';
          badge.classList.remove('active');
        }
      }
    }

    // ãƒãƒ£ãƒƒãƒˆãƒãƒƒã‚¸æ›´æ–°
    function updateChatBadge(count) {
      console.log('[menu_home] Chat ãƒãƒƒã‚¸æ›´æ–°:', count);
      const badge = document.getElementById('chat-menu-badge');
      if (badge) {
        if (count > 0) {
          badge.textContent = count > 99 ? '99+' : count.toString();
          badge.classList.add('active');
        } else {
          badge.textContent = '0';
          badge.classList.remove('active');
        }
      }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š
    function setUserIcon() {
      // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¤ã‚³ãƒ³å„ªå…ˆã€ãªã‘ã‚Œã°å…ƒã®å†™çœŸURLã‚’ä½¿ç”¨
      const iconUrl = localStorage.getItem('reborn_user_icon_url') || localStorage.getItem('reborn_user_photo_url') || localStorage.getItem('reborn_user_photo');
      const iconContainer = document.getElementById('mini-user-icon');

      if (!iconContainer) return;

      if (iconUrl) {
        // æ—¢å­˜ã®imgãŒã‚ã‚Œã°æ›´æ–°ã€ãªã‘ã‚Œã°ä½œæˆ
        let existingImg = iconContainer.querySelector('img.user-avatar');
        const placeholder = document.getElementById('user-icon-placeholder');

        if (existingImg) {
          // æ—¢å­˜ã®imgã‚’æ›´æ–°
          existingImg.src = iconUrl;
          console.log('[menu_home] âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°:', iconUrl.substring(0, 50) + '...');
        } else if (placeholder) {
          // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ç½®ãæ›ãˆ
          const img = document.createElement('img');
          img.src = iconUrl;
          img.alt = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
          img.className = 'user-avatar';
          img.onerror = function() {
            console.log('[menu_home] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—');
          };
          placeholder.replaceWith(img);
          console.log('[menu_home] âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³è¨­å®šå®Œäº†:', iconUrl.substring(0, 50) + '...');
        } else {
          // ã©ã¡ã‚‰ã‚‚ãªã„å ´åˆã¯æ–°è¦ä½œæˆ
          iconContainer.innerHTML = '';
          const img = document.createElement('img');
          img.src = iconUrl;
          img.alt = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
          img.className = 'user-avatar';
          img.onerror = function() {
            console.log('[menu_home] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—');
          };
          iconContainer.appendChild(img);
          console.log('[menu_home] âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³æ–°è¦ä½œæˆ:', iconUrl.substring(0, 50) + '...');
        }
      }
    }

    // ãƒãƒƒã‚¸ãƒªã‚¹ãƒŠãƒ¼é–‹å§‹
    async function startBadgeListeners() {
      if (!db) {
        console.warn('[menu_home] âš ï¸ ãƒãƒƒã‚¸ãƒªã‚¹ãƒŠãƒ¼: FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }

      const userEmail = localStorage.getItem('reborn_user_email');
      if (!userEmail) {
        console.warn('[menu_home] âš ï¸ ãƒãƒƒã‚¸ãƒªã‚¹ãƒŠãƒ¼: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      console.log('[menu_home] ğŸ”” ãƒãƒƒã‚¸ãƒªã‚¹ãƒŠãƒ¼é–‹å§‹:', userEmail);

      try {
        // 1. ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆæœªå®Œäº†ã‚«ã‚¦ãƒ³ãƒˆ
        const todoQuery = db.collection('todos')
          .where('userEmail', '==', userEmail)
          .where('completed', '==', false);

        todoQuery.onSnapshot((snapshot) => {
          const count = snapshot.size;
          console.log('[menu_home] Todo æœªå®Œäº†æ•°:', count);
          updateTodoBadge(count);
        }, (error) => {
          console.error('[menu_home] Todo ãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
        });

        // 2. ãƒãƒ£ãƒƒãƒˆæœªèª­ã‚«ã‚¦ãƒ³ãƒˆï¼ˆå…¨ãƒ«ãƒ¼ãƒ åˆè¨ˆï¼‰
        window.chatUnreadByRoom = {};

        function updateTotalChatUnread() {
          const totalUnread = Object.values(window.chatUnreadByRoom).reduce((sum, count) => sum + count, 0);
          console.log('[menu_home] Chat æœªèª­åˆè¨ˆ:', totalUnread, window.chatUnreadByRoom);
          updateChatBadge(totalUnread);
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‚åŠ ã—ã¦ã„ã‚‹ãƒ«ãƒ¼ãƒ ã‚’å–å¾—
        const roomsQuery = db.collection('rooms').where('members', 'array-contains', userEmail);

        roomsQuery.onSnapshot((roomsSnapshot) => {
          console.log('[menu_home] ãƒ«ãƒ¼ãƒ æ•°:', roomsSnapshot.size);

          roomsSnapshot.forEach((roomDoc) => {
            const roomId = roomDoc.id;
            const unreadDocRef = db.collection('rooms').doc(roomId).collection('unreadCounts').doc(userEmail);

            unreadDocRef.onSnapshot((unreadDoc) => {
              const unreadData = unreadDoc.data();
              const unreadCount = unreadData?.unreadCount || 0;
              window.chatUnreadByRoom[roomId] = unreadCount;
              updateTotalChatUnread();
            }, (error) => {
              console.log('[menu_home] ãƒ«ãƒ¼ãƒ ', roomId, 'æœªèª­å–å¾—ã‚¨ãƒ©ãƒ¼:', error.message);
            });
          });
        }, (error) => {
          console.error('[menu_home] ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
        });

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒ ï¼ˆå…¨ä½“ãƒãƒ£ãƒƒãƒˆã€ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ï¼‰
        const defaultRoomIds = ['room_default_all', 'system'];
        defaultRoomIds.forEach((roomId) => {
          const unreadDocRef = db.collection('rooms').doc(roomId).collection('unreadCounts').doc(userEmail);

          unreadDocRef.onSnapshot((unreadDoc) => {
            const unreadData = unreadDoc.data();
            const unreadCount = unreadData?.unreadCount || 0;
            window.chatUnreadByRoom[roomId] = unreadCount;
            updateTotalChatUnread();
          }, (error) => {
            console.log('[menu_home] ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒ ', roomId, 'æœªèª­å–å¾—:', error.message);
          });
        });

        console.log('[menu_home] âœ… ãƒãƒƒã‚¸ãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');

      } catch (error) {
        console.error('[menu_home] âŒ ãƒãƒƒã‚¸ãƒªã‚¹ãƒŠãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // DOMãƒ­ãƒ¼ãƒ‰å¾Œã«ãƒãƒƒã‚¸ãƒªã‚¹ãƒŠãƒ¼ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³è¨­å®šã‚’é–‹å§‹
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setUserIcon();
        startBadgeListeners();
      });
    } else {
      setUserIcon();
      startBadgeListeners();
    }

    console.log('[menu_home] ========== ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº† ==========');
  </script>
</body>
</html>
