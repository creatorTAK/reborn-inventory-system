<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- PERM-001: æ¨©é™ãƒã‚§ãƒƒã‚¯å®Ÿè£…æ¸ˆã¿ -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Furira ãƒ¡ãƒ‹ãƒ¥ãƒ¼</title>
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://www.reborn-inventory.com/css/reborn-brand-colors.css?v=9635">
  <link rel="stylesheet" href="/css/reborn-theme.css?v=296">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* v318: ãƒãƒ©ãƒ³ã‚¹èª¿æ•´ç‰ˆï¼ˆé©åº¦ãªä½™ç™½ + ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒƒãƒˆï¼‰ */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, var(--reborn-primary) 0%, var(--reborn-primary-dark) 100%);
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      align-items: center; /* ä¸­å¤®é…ç½®ã«æˆ»ã™ */
      justify-content: center;
      padding: 12px; /* å‘¨å›²ã®ä½™ç™½ã‚’å°‘ã—ç¸®å° */
      padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .menu-container {
      position: relative;
      width: 100%;
      max-width: 500px;
      /* v318: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«åˆã‚ã›ãŸé«˜ã•ï¼ˆæœ€å¤§ã§ç”»é¢ã„ã£ã±ã„ï¼‰ */
      max-height: calc(100dvh - 24px - env(safe-area-inset-bottom, 0px));
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 24px 16px;
      margin: 0 auto;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .menu-items {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .menu-header {
      text-align: center;
      margin-bottom: 20px;
    }

    /* v316: ãƒ­ã‚´ã‚µã‚¤ã‚ºã‚’ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆç›¸å¯¾ã« */
    .menu-logo {
      width: min(280px, 70vw);
      height: auto;
      margin: -35px auto -45px;
      display: block;
    }

    .menu-subtitle {
      font-size: 14px;
      color: #6b7280;
    }

    .menu-item {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 6px 16px;
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: space-between;
      text-decoration: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .menu-item.full-width {
      grid-column: 1 / -1;
    }

    .menu-item:active {
      transform: scale(0.98);
      background: #f9fafb;
    }

    .menu-item:hover {
      border-color: var(--reborn-primary);
      background: var(--reborn-primary-lightest);
    }

    .menu-item.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f9fafb;
    }

    .menu-item.disabled:active {
      transform: none;
    }

    .menu-item-content {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: nowrap;
    }

    .menu-item-content > span {
      white-space: nowrap;
      flex-shrink: 0;
    }

    .menu-item-icon {
      font-size: 18px;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .menu-item-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .menu-item-arrow {
      font-size: 14px;
      color: #9ca3af;
      transition: transform 0.2s;
    }

    /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    .accordion-menu {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.2s;
      grid-column: 1 / -1;
    }

    .accordion-header {
      padding: 6px 20px;
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      transition: background 0.2s;
    }

    .accordion-header:active {
      background: #f9fafb;
    }

    .accordion-header:hover {
      background: #eff6ff;
    }

    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
      background: #f9fafb;
    }

    .accordion-content.open {
      max-height: 1000px;
    }

    .accordion-item {
      padding: 14px 20px 14px 56px;
      font-size: 15px;
      color: #4b5563;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      transition: background 0.2s;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      border-top: 1px solid #e5e7eb;
    }

    .accordion-item:active {
      background: #f3f4f6;
    }

    .accordion-item:hover {
      background: #f3f4f6;
    }

    .accordion-item.coming-soon {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .accordion-item.coming-soon:active {
      background: transparent;
    }

    .accordion-arrow {
      transition: transform 0.3s;
      font-size: 14px;
      color: #9ca3af;
    }

    .accordion-arrow.open {
      transform: rotate(180deg);
    }

    .coming-soon-badge {
      font-size: 11px;
      background: #fbbf24;
      color: #78350f;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
      margin-left: auto;
    }

    /* v316: ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ–¹å¼ï¼‰ */
    /* ä¸­å‹ç”»é¢: ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ç¸®å° */
    @media (max-width: 480px) {
      .menu-container {
        padding: 20px 14px;
      }

      .menu-header {
        margin-bottom: 16px;
      }

      .menu-logo {
        margin: -30px auto -40px;
      }

      .menu-items {
        gap: 8px;
      }

      .menu-item {
        padding: 5px 14px;
        font-size: 15px;
      }

      .menu-item-icon {
        width: 44px;
        height: 44px;
      }

      .accordion-header {
        padding: 5px 16px;
        font-size: 14px;
      }

      .accordion-item {
        padding: 12px 16px 12px 48px;
        font-size: 14px;
      }
    }

    /* å°å‹ç”»é¢: ã•ã‚‰ã«ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ–ï¼ˆiPhone SEã€å°å‹ç«¯æœ«ï¼‰ */
    @media (max-height: 700px) {
      .menu-container {
        padding: 16px 12px;
      }

      .menu-header {
        margin-bottom: 12px;
      }

      .menu-logo {
        width: min(240px, 62vw);
        margin: -25px auto -35px;
      }

      .menu-subtitle {
        font-size: 13px;
      }

      .menu-items {
        gap: 6px;
      }

      .menu-item {
        padding: 4px 12px;
        font-size: 14px;
        border-radius: 10px;
      }

      .menu-item-icon {
        width: 40px;
        height: 40px;
      }

      .accordion-menu {
        border-radius: 10px;
      }

      .accordion-header {
        padding: 4px 14px;
        font-size: 13px;
      }

      .accordion-item {
        padding: 10px 14px 10px 44px;
        font-size: 13px;
      }
    }

    /* è¶…å°å‹ç”»é¢: æœ€å°é™ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
    @media (max-height: 600px) {
      body {
        padding: 10px;
        padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
      }

      .menu-container {
        padding: 12px 10px;
        max-height: calc(100dvh - 20px - env(safe-area-inset-bottom, 0px));
      }

      .menu-header {
        margin-bottom: 8px;
      }

      .menu-logo {
        width: min(200px, 56vw);
        margin: -20px auto -28px;
      }

      .menu-items {
        gap: 5px;
      }

      .menu-item {
        padding: 3px 10px;
        font-size: 13px;
        border-width: 1px;
      }

      .menu-item-icon {
        width: 36px;
        height: 36px;
      }

      .accordion-header {
        padding: 3px 12px;
        font-size: 12px;
      }

      .accordion-item {
        padding: 8px 12px 8px 40px;
        font-size: 12px;
      }
    }

    /* v287: ãƒ•ãƒƒã‚¿ãƒ¼CSSã¯ãƒ˜ãƒ«ãƒ—ãƒšãƒ¼ã‚¸ã«ç§»å‹• */
    /* v289: ãƒŸãƒ‹ãƒ˜ãƒƒãƒ€ãƒ¼CSSã‚’å‰Šé™¤ï¼ˆãƒœãƒˆãƒ ãƒŠãƒ“ã«ç§»è¡Œï¼‰ */

    /* ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”¨ãƒãƒƒã‚¸ */
    .menu-item-badge {
      background: #ef4444;
      color: white;
      border-radius: 10px;
      min-width: 18px;
      height: 18px;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
      padding: 0 5px;
      margin-left: auto;
    }

    .menu-item-badge.active {
      display: flex;
    }
  </style>
</head>
<body>
  <div class="menu-container">
    <!-- v289: ãƒŸãƒ‹ãƒ˜ãƒƒãƒ€ãƒ¼å‰Šé™¤ï¼ˆãƒœãƒˆãƒ ãƒŠãƒ“ã«ç§»è¡Œï¼‰ -->

    <div class="menu-header">
      <img src="/images/furira-square-logo.png?v=20251209" alt="Furira" class="menu-logo" onerror="this.style.display='none';">
      <div class="menu-subtitle">ç‰©è²©ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </div>
    </div>

    <div class="menu-items">
      <!-- å•†å“ç™»éŒ² (v335: å•†å“ç™»éŒ²ç”»é¢ã«ç›´æ¥é·ç§») -->
      <a href="#" onclick="navigateToPage('product'); return false;" class="menu-item" id="menu-product">
        <div class="menu-item-content">
          <span class="menu-item-icon icon-product"><img src="/images/menu-icons/menu-product.png?v=3" alt=""></span>
          <span>å•†å“ç™»éŒ²</span>
        </div>
      </a>

      <!-- åœ¨åº«ç®¡ç† -->
      <a href="#" onclick="navigateToPage('inventory'); return false;" class="menu-item" id="menu-inventory">
        <div class="menu-item-content">
          <span class="menu-item-icon icon-product"><img src="/images/menu-icons/menu-inventory.png?v=3" alt=""></span>
          <span>åœ¨åº«ç®¡ç†</span>
        </div>
      </a>

      <!-- å…¥å‡ºåº«å±¥æ­´ -->
      <a href="#" onclick="navigateToPage('inventory_history'); return false;" class="menu-item" id="menu-inventory_history">
        <div class="menu-item-content">
          <span class="menu-item-icon icon-analysis"><img src="/images/menu-icons/menu-history.png?v=7" alt=""></span>
          <span>å…¥å‡ºåº«å±¥æ­´</span>
        </div>
      </a>

      <!-- æ£šå¸ -->
      <a href="#" onclick="navigateToPage('stocktaking'); return false;" class="menu-item" id="menu-stocktaking">
        <div class="menu-item-content">
          <span class="menu-item-icon icon-analysis"><img src="/images/menu-icons/menu-stocktaking.png?v=5" alt=""></span>
          <span>æ£šå¸</span>
        </div>
      </a>

      <!-- ä»•å…¥ç®¡ç† -->
      <a href="#" onclick="navigateToPage('purchase'); return false;" class="menu-item" id="menu-purchase">
        <div class="menu-item-content">
          <span class="menu-item-icon icon-finance"><img src="/images/menu-icons/menu-purchase.png?v=4" alt=""></span>
          <span>ä»•å…¥ç®¡ç†</span>
        </div>
      </a>

      <!-- å£²ä¸Šç®¡ç† -->
      <a href="#" onclick="navigateToPage('sales'); return false;" class="menu-item" id="menu-sales">
        <div class="menu-item-content">
          <span class="menu-item-icon icon-finance"><img src="/images/menu-icons/menu-sales.png?v=4" alt=""></span>
          <span>å£²ä¸Šç®¡ç†</span>
        </div>
      </a>

      <!-- ç¢ºå®šç”³å‘Š -->
      <a href="#" onclick="navigateToPage('accounting'); return false;" class="menu-item" id="menu-accounting">
        <div class="menu-item-content">
          <span class="menu-item-icon icon-finance"><img src="/images/menu-icons/menu-accounting.png?v=3" alt=""></span>
          <span>ç¢ºå®šç”³å‘Š</span>
        </div>
      </a>

      <!-- å ±é…¬ç®¡ç†ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰ -->
      <a href="#" onclick="navigateToPage('compensation'); return false;" class="menu-item" id="menu-compensation">
        <div class="menu-item-content">
          <span class="menu-item-icon icon-finance"><img src="/images/menu-icons/menu-compensation.png?v=3" alt=""></span>
          <span>å ±é…¬ç®¡ç†</span>
        </div>
      </a>

      <!-- ãƒã‚¹ã‚¿ç®¡ç†ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ -->
      <div class="accordion-menu">
        <div class="accordion-header" onclick="toggleAccordion('master')">
          <div class="menu-item-content">
            <span class="menu-item-icon icon-admin"><img src="/images/menu-icons/menu-master.png?v=3" alt=""></span>
            <span>ãƒã‚¹ã‚¿ç®¡ç†</span>
          </div>
          <span class="accordion-arrow" id="master-arrow">â–¼</span>
        </div>
        <div class="accordion-content" id="master-content">
          <a href="#" onclick="navigateToPage('master-product'); return false;" class="accordion-item" id="menu-master-product">
            <img src="/images/menu-icons/menu-master-product.png?v=3" alt="" style="width: 28px; height: 28px; margin-right: 8px; vertical-align: middle;">å•†å“ãƒã‚¹ã‚¿ç®¡ç†
          </a>
          <a href="#" onclick="navigateToPage('master-business'); return false;" class="accordion-item" id="menu-master-business">
            <img src="/images/menu-icons/menu-master-business.png?v=3" alt="" style="width: 28px; height: 28px; margin-right: 8px; vertical-align: middle;">æ¥­å‹™ãƒã‚¹ã‚¿ç®¡ç†
          </a>
        </div>
      </div>

      <!-- è¨­å®šç®¡ç†ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ -->
      <div class="accordion-menu">
        <div class="accordion-header" onclick="toggleAccordion('config')">
          <div class="menu-item-content">
            <span class="menu-item-icon icon-admin"><img src="/images/menu-icons/menu-config.png?v=3" alt=""></span>
            <span>è¨­å®šç®¡ç†</span>
          </div>
          <span class="accordion-arrow" id="config-arrow">â–¼</span>
        </div>
        <div class="accordion-content" id="config-content">
          <a href="#" onclick="navigateToPage('config-system'); return false;" class="accordion-item">
            <img src="/images/menu-icons/menu-config-system.png?v=3" alt="" style="width: 28px; height: 28px; margin-right: 8px; vertical-align: middle;">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
          </a>
          <a href="#" onclick="navigateToPage('config-product'); return false;" class="accordion-item" id="menu-config-product">
            <img src="/images/menu-icons/menu-config-product.png?v=3" alt="" style="width: 28px; height: 28px; margin-right: 8px; vertical-align: middle;">å•†å“ç™»éŒ²è¨­å®š
          </a>
        </div>
      </div>
    </div>

    <!-- v287: ãƒ•ãƒƒã‚¿ãƒ¼ã¯ãƒ˜ãƒ«ãƒ—ãƒšãƒ¼ã‚¸ã«ç§»å‹• -->
  </div>

  <!-- æ¨©é™ã«ã‚ˆã‚‹å³æ™‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¶å¾¡ï¼ˆPERM-001 v3ï¼‰ -->
  <script>
    (function() {
      // ä¸¡æ–¹ã®ã‚­ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆåˆæœŸè¨­å®šæ™‚ã¯_idã€ãã®å¾Œã¯ãªã—ï¼‰
      var permissionId = localStorage.getItem('reborn_user_permission_id')
                      || localStorage.getItem('reborn_user_permission');

      if (permissionId && permissionId !== 'owner') {
        var el = document.getElementById('menu-config-product');
        if (el) el.style.display = 'none';
      }
    })();
  </script>

  <!-- Firebase SDK (compatç‰ˆ: UMDå½¢å¼) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    console.log('[menu_home] ========== ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿é–‹å§‹ ==========');

    // Firebaseè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "furira.jp",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    let db = null;
    let firestoreReady = false;

    // FirebaseåˆæœŸåŒ–
    try {
      console.log('[menu_home] FirebaseåˆæœŸåŒ–é–‹å§‹');
      console.log('[menu_home] firebase:', typeof firebase);

      if (typeof firebase === 'undefined') {
        throw new Error('Firebase SDK ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
      }

      // FirebaseåˆæœŸåŒ–ï¼ˆæ—¢å­˜ã‚¢ãƒ—ãƒªãŒã‚ã‚Œã°å†åˆ©ç”¨ï¼‰
      const app = firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      firestoreReady = true;

      console.log('[menu_home] âœ… FirebaseåˆæœŸåŒ–å®Œäº†');
      console.log('[menu_home] firebase.apps.length:', firebase.apps.length);
      console.log('[menu_home] db:', db);

      // DOMãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', checkUserPermissionAndUpdateMenu);
      } else {
        // DOMãŒæ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯å³åº§ã«å®Ÿè¡Œ
        checkUserPermissionAndUpdateMenu();
      }

    } catch (error) {
      console.error('[menu_home] âŒ FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      console.error('[menu_home] error.message:', error.message);
      console.error('[menu_home] error.stack:', error.stack);
    }

    // ================= æ¨©é™ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ï¼ˆPERM-001 v4ï¼‰ =================
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼IDã¨è¦ç´ IDã®ãƒãƒƒãƒ”ãƒ³ã‚°
    const MENU_ID_MAP = {
      'product': 'menu-product',
      'inventory': 'menu-inventory',
      'inventory_history': 'menu-inventory_history',
      'stocktaking': 'menu-stocktaking',
      'purchase': 'menu-purchase',
      'sales': 'menu-sales',
      'accounting': 'menu-accounting',
      'compensation': 'menu-compensation',
      'master-product': 'menu-master-product',
      'master-business': 'menu-master-business',
      'config-product': 'menu-config-product',
      'config-system': 'menu-config-system'
    };

    // å¸¸ã«ç®¡ç†è€…ã®ã¿è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆFirestoreè¨­å®šã«é–¢ä¿‚ãªãéè¡¨ç¤ºï¼‰
    // æ³¨: compensationã¯æ¨©é™è¨­å®šã§åˆ¶å¾¡ã™ã‚‹ãŸã‚ã“ã“ã«ã¯å«ã‚ãªã„
    const ALWAYS_OWNER_ONLY_MENUS = [];

    async function checkUserPermissionAndUpdateMenu() {
      try {
        const userEmail = localStorage.getItem('reborn_user_email');
        const userName = localStorage.getItem('reborn_user_name');

        if (!userEmail) {
          console.warn('[menu_home] âš ï¸ æ¨©é™ãƒã‚§ãƒƒã‚¯: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        console.log('[menu_home] ğŸ” æ¨©é™ãƒã‚§ãƒƒã‚¯é–‹å§‹:', userName, '(', userEmail, ')');

        if (!db) {
          console.warn('[menu_home] âš ï¸ æ¨©é™ãƒã‚§ãƒƒã‚¯: FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
          return;
        }

        // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™IDã‚’å–å¾—
        const userDoc = await db.collection('users').doc(userEmail).get();

        if (!userDoc.exists) {
          console.warn('[menu_home] âš ï¸ æ¨©é™ãƒã‚§ãƒƒã‚¯: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        const userData = userDoc.data();
        const permissionId = userData.permissionId || 'staff';
        const permissionDisplay = userData.permissionDisplay || 'ã‚¹ã‚¿ãƒƒãƒ•';

        console.log('[menu_home] ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™:', permissionDisplay, '(ID:', permissionId + ')');

        // æ¨©é™ã‚’localStorageã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        localStorage.setItem('reborn_user_permission', permissionId);

        // ã‚ªãƒ¼ãƒŠãƒ¼ã¯å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º
        if (permissionId === 'owner') {
          console.log('[menu_home] âœ… ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ - å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º');
          return;
        }

        // 1.5. å¸¸ã«ç®¡ç†è€…ã®ã¿ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’éè¡¨ç¤ºï¼ˆFirestoreè¨­å®šã«é–¢ä¿‚ãªãï¼‰
        for (const menuId of ALWAYS_OWNER_ONLY_MENUS) {
          const elementId = MENU_ID_MAP[menuId];
          const element = document.getElementById(elementId);
          if (element) {
            element.style.display = 'none';
            console.log('[menu_home] ğŸ”’ ç®¡ç†è€…å°‚ç”¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼éè¡¨ç¤º:', menuId);
          }
        }

        // 2. ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ¨©é™è¨­å®šã‚’å–å¾—
        const menuPermDoc = await db.collection('settings').doc('menuPermissions').get();

        if (!menuPermDoc.exists) {
          console.log('[menu_home] â„¹ï¸ ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ¨©é™è¨­å®šãªã— - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤º');
          return;
        }

        const menuPermissions = menuPermDoc.data();
        console.log('[menu_home] ğŸ“‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ¨©é™è¨­å®š:', menuPermissions);

        // 3. å„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ¶å¾¡
        let hiddenCount = 0;
        for (const [menuId, elementId] of Object.entries(MENU_ID_MAP)) {
          const menuPerm = menuPermissions[menuId];
          const element = document.getElementById(elementId);

          if (!element) continue;

          // visibleToã«æ¨©é™IDãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          const isVisible = !menuPerm || !menuPerm.visibleTo || menuPerm.visibleTo.includes(permissionId);

          if (!isVisible) {
            element.style.display = 'none';
            hiddenCount++;
            console.log('[menu_home] ğŸ”’ ãƒ¡ãƒ‹ãƒ¥ãƒ¼éè¡¨ç¤º:', menuId);
          }
        }

        console.log('[menu_home] âœ… æ¨©é™ãƒã‚§ãƒƒã‚¯å®Œäº† - éè¡¨ç¤ºãƒ¡ãƒ‹ãƒ¥ãƒ¼æ•°:', hiddenCount);

      } catch (error) {
        console.error('[menu_home] âŒ æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®é–‹é–‰
    window.toggleAccordion = function(type) {
      const content = document.getElementById(type + '-content');
      const arrow = document.getElementById(type + '-arrow');

      if (!content || !arrow) {
        console.error('[menu_home] âŒ ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', type);
        return;
      }

      console.log('[menu_home] content.classList:', content.classList);
      console.log('[menu_home] arrow.classList:', arrow.classList);

      if (content.classList.contains('open')) {
        content.classList.remove('open');
        arrow.classList.remove('open');
        console.log('[menu_home] âœ… ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’é–‰ã˜ã¾ã—ãŸ');
      } else {
        content.classList.add('open');
        arrow.classList.add('open');
        console.log('[menu_home] âœ… ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’é–‹ãã¾ã—ãŸ');
      }
    };

    // å‰Šé™¤ï¼šopenPWAPage / openGASPage ã¯ä½¿ç”¨ã—ãªã„ï¼ˆnavigateToPageã‚’ä½¿ç”¨ï¼‰

    // postMessageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
    function navigateViaPostMessage(page) {
      console.log('[menu_home] ğŸ“¤ postMessageãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ:', page);
      try {
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({
            type: 'navigateToPage',
            page: page
          }, '*');
          console.log('[menu_home] âœ… postMessageé€ä¿¡æˆåŠŸ');
          return true;
        }
      } catch (e) {
        console.error('[menu_home] âŒ postMessageé€ä¿¡å¤±æ•—:', e);
      }
      return false;
    }

    // ãƒšãƒ¼ã‚¸é·ç§»ï¼ˆFirestoreçµŒç”±ã§è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«é€šçŸ¥ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãï¼‰
    window.navigateToPage = async function(page) {
      console.log('[menu_home] ========== navigateToPageé–‹å§‹ ==========');
      console.log('[menu_home] é·ç§»å…ˆ:', page);

      console.log('[menu_home] firestoreReady:', firestoreReady);

      // FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã¯postMessageã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      if (!firestoreReady || !db) {
        console.warn('[menu_home] âš ï¸ FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ - postMessageã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯');
        if (navigateViaPostMessage(page)) {
          return;
        }
        console.error('[menu_home] âŒ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—');
        alert('ã‚¨ãƒ©ãƒ¼: ãƒšãƒ¼ã‚¸é·ç§»ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      try {
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼ˆPWAç‰ˆï¼‰
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('sessionId') || '';
        console.log('[menu_home] Firestoreæ›¸ãè¾¼ã¿é–‹å§‹...');
        console.log('[menu_home] sessionId:', sessionId);

        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãã§Firestoreæ›¸ãè¾¼ã¿ï¼ˆ5ç§’ï¼‰
        const firestorePromise = db.collection('navigation').doc('menuControl').set({
          action: 'navigate',
          page: page,
          sessionId: sessionId,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          from: 'menu_home'
        });

        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('Firestore timeout (5s)')), 5000);
        });

        await Promise.race([firestorePromise, timeoutPromise]);

        console.log('[menu_home] âœ… Firestoreæ›¸ãè¾¼ã¿æˆåŠŸ');
        console.log('[menu_home] ========== navigateToPageå®Œäº† ==========');

      } catch (error) {
        console.error('[menu_home] âŒ Firestoreã‚¨ãƒ©ãƒ¼:', error);
        console.error('[menu_home] error.message:', error.message);

        // Firestoreã‚¨ãƒ©ãƒ¼æ™‚ã¯postMessageã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        console.log('[menu_home] ğŸ”„ postMessageã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯...');
        if (navigateViaPostMessage(page)) {
          return;
        }

        console.error('[menu_home] âŒ å…¨ã¦ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ‰‹æ®µãŒå¤±æ•—');
        alert('ã‚¨ãƒ©ãƒ¼: ãƒšãƒ¼ã‚¸é·ç§»ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„ã€‚');
      }
    };

    // ================= ãƒãƒƒã‚¸æ›´æ–°æ©Ÿèƒ½ =================

    // ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆãƒãƒƒã‚¸æ›´æ–°
    function updateTodoBadge(count) {
      console.log('[menu_home] Todo ãƒãƒƒã‚¸æ›´æ–°:', count);
      const badge = document.getElementById('mini-todo-badge');
      if (badge) {
        if (count > 0) {
          badge.textContent = count > 99 ? '99+' : count.toString();
          badge.classList.add('active');
        } else {
          badge.textContent = '0';
          badge.classList.remove('active');
        }
      }
    }

    // ãƒãƒ£ãƒƒãƒˆãƒãƒƒã‚¸æ›´æ–°ï¼ˆãƒŸãƒ‹ãƒ˜ãƒƒãƒ€ãƒ¼ç”¨ï¼‰
    function updateChatBadge(count) {
      console.log('[menu_home] Chat ãƒãƒƒã‚¸æ›´æ–°:', count);
      const badge = document.getElementById('mini-chat-badge');
      if (badge) {
        if (count > 0) {
          badge.textContent = count > 99 ? '99+' : count.toString();
          badge.classList.add('active');
        } else {
          badge.textContent = '0';
          badge.classList.remove('active');
        }
      }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š
    function setUserIcon() {
      // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¤ã‚³ãƒ³å„ªå…ˆã€ãªã‘ã‚Œã°å…ƒã®å†™çœŸURLã‚’ä½¿ç”¨
      const iconUrl = localStorage.getItem('reborn_user_icon_url') || localStorage.getItem('reborn_user_photo_url') || localStorage.getItem('reborn_user_photo');
      const iconContainer = document.getElementById('mini-user-icon');

      if (!iconContainer) return;

      if (iconUrl) {
        // æ—¢å­˜ã®imgãŒã‚ã‚Œã°æ›´æ–°ã€ãªã‘ã‚Œã°ä½œæˆ
        let existingImg = iconContainer.querySelector('img.user-avatar');
        const placeholder = document.getElementById('user-icon-placeholder');

        if (existingImg) {
          // æ—¢å­˜ã®imgã‚’æ›´æ–°
          existingImg.src = iconUrl;
          console.log('[menu_home] âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°:', iconUrl.substring(0, 50) + '...');
        } else if (placeholder) {
          // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ç½®ãæ›ãˆ
          const img = document.createElement('img');
          img.src = iconUrl;
          img.alt = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
          img.className = 'user-avatar';
          img.onerror = function() {
            console.log('[menu_home] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—');
          };
          placeholder.replaceWith(img);
          console.log('[menu_home] âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³è¨­å®šå®Œäº†:', iconUrl.substring(0, 50) + '...');
        } else {
          // ã©ã¡ã‚‰ã‚‚ãªã„å ´åˆã¯æ–°è¦ä½œæˆ
          iconContainer.innerHTML = '';
          const img = document.createElement('img');
          img.src = iconUrl;
          img.alt = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
          img.className = 'user-avatar';
          img.onerror = function() {
            console.log('[menu_home] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—');
          };
          iconContainer.appendChild(img);
          console.log('[menu_home] âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³æ–°è¦ä½œæˆ:', iconUrl.substring(0, 50) + '...');
        }
      }
    }

    // ãƒãƒƒã‚¸ãƒªã‚¹ãƒŠãƒ¼é–‹å§‹
    async function startBadgeListeners() {
      if (!db) {
        console.warn('[menu_home] âš ï¸ ãƒãƒƒã‚¸ãƒªã‚¹ãƒŠãƒ¼: FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }

      const userEmail = localStorage.getItem('reborn_user_email');
      if (!userEmail) {
        console.warn('[menu_home] âš ï¸ ãƒãƒƒã‚¸ãƒªã‚¹ãƒŠãƒ¼: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      console.log('[menu_home] ğŸ”” ãƒãƒƒã‚¸ãƒªã‚¹ãƒŠãƒ¼é–‹å§‹:', userEmail);

      try {
        // 1. ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆæœªå®Œäº†ã‚«ã‚¦ãƒ³ãƒˆï¼ˆuserTasks/{email}/tasks ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ï¼‰
        const tasksRef = db.collection('userTasks').doc(userEmail).collection('tasks');
        const todoQuery = tasksRef.where('completed', '==', false);

        todoQuery.onSnapshot((snapshot) => {
          const count = snapshot.size;
          console.log('[menu_home] Todo æœªå®Œäº†æ•°:', count);
          updateTodoBadge(count);
        }, (error) => {
          console.error('[menu_home] Todo ãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
        });

        // 2. ãƒãƒ£ãƒƒãƒˆæœªèª­ã‚«ã‚¦ãƒ³ãƒˆï¼ˆå…¨ãƒ«ãƒ¼ãƒ åˆè¨ˆï¼‰
        window.chatUnreadByRoom = {};
        // ãƒªã‚¹ãƒŠãƒ¼ç®¡ç†ç”¨Mapï¼ˆé‡è¤‡ãƒªã‚¹ãƒŠãƒ¼é˜²æ­¢ï¼‰
        const roomUnreadListeners = new Map();

        function updateTotalChatUnread() {
          const totalUnread = Object.values(window.chatUnreadByRoom).reduce((sum, count) => sum + count, 0);
          console.log('[menu_home] Chat æœªèª­åˆè¨ˆ:', totalUnread, window.chatUnreadByRoom);
          updateChatBadge(totalUnread);
        }

        // ãƒ«ãƒ¼ãƒ æœªèª­ãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
        function subscribeRoomUnread(roomId, userEmail) {
          // æ—¢ã«ãƒªã‚¹ãƒŠãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          if (roomUnreadListeners.has(roomId)) {
            console.log('[menu_home] ãƒ«ãƒ¼ãƒ ', roomId, 'ã®ãƒªã‚¹ãƒŠãƒ¼ã¯æ—¢ã«ç™»éŒ²æ¸ˆã¿');
            return;
          }

          const unreadDocRef = db.collection('rooms').doc(roomId).collection('unreadCounts').doc(userEmail);
          const unsubscribe = unreadDocRef.onSnapshot((unreadDoc) => {
            const unreadData = unreadDoc.data();
            const unreadCount = unreadData?.unreadCount || 0;
            window.chatUnreadByRoom[roomId] = unreadCount;
            updateTotalChatUnread();
          }, (error) => {
            console.log('[menu_home] ãƒ«ãƒ¼ãƒ ', roomId, 'æœªèª­å–å¾—ã‚¨ãƒ©ãƒ¼:', error.message);
          });

          // ãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²
          roomUnreadListeners.set(roomId, unsubscribe);
          console.log('[menu_home] ãƒ«ãƒ¼ãƒ ', roomId, 'ã®æœªèª­ãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²');
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‚åŠ ã—ã¦ã„ã‚‹ãƒ«ãƒ¼ãƒ ã‚’å–å¾—
        const roomsQuery = db.collection('rooms').where('members', 'array-contains', userEmail);

        roomsQuery.onSnapshot((roomsSnapshot) => {
          console.log('[menu_home] ãƒ«ãƒ¼ãƒ æ•°:', roomsSnapshot.size);

          roomsSnapshot.forEach((roomDoc) => {
            const roomId = roomDoc.id;
            subscribeRoomUnread(roomId, userEmail);
          });
        }, (error) => {
          console.error('[menu_home] ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
        });

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒ ï¼ˆå…¨ä½“ãƒãƒ£ãƒƒãƒˆã€ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ã€ã‚¢ãƒ©ãƒ¼ãƒˆï¼‰
        // å…±é€šã®subscribeRoomUnreadé–¢æ•°ã‚’ä½¿ç”¨ï¼ˆé‡è¤‡ãƒªã‚¹ãƒŠãƒ¼é˜²æ­¢ï¼‰
        const defaultRoomIds = ['room_default_all', 'system', 'system-notifications', 'room_inventory_alert'];
        defaultRoomIds.forEach((roomId) => {
          subscribeRoomUnread(roomId, userEmail);
        });

        console.log('[menu_home] âœ… ãƒãƒƒã‚¸ãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');

      } catch (error) {
        console.error('[menu_home] âŒ ãƒãƒƒã‚¸ãƒªã‚¹ãƒŠãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // DOMãƒ­ãƒ¼ãƒ‰å¾Œã«ãƒãƒƒã‚¸ãƒªã‚¹ãƒŠãƒ¼ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³è¨­å®šã‚’é–‹å§‹
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setUserIcon();
        startBadgeListeners();
      });
    } else {
      setUserIcon();
      startBadgeListeners();
    }

    console.log('[menu_home] ========== ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº† ==========');
  </script>
</body>
</html>
