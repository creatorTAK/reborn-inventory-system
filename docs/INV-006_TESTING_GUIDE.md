# INV-006 ユーザー権限管理システム テストガイド

## デプロイ情報
- **最終デプロイバージョン**: @600
- **デプロイ日**: 2025-11-03
- **PWA Deployment ID**: `AKfycbx6ybbRLDqKQJ8IR-NPoVP8981Gtozzz0N3880XanEGRS4--iZtset8PFrVcD_u9YAHMA`

## 実装された機能サマリー

### Phase 1: ユーザー権限管理の基礎 (@596)
**実装内容**:
- FCM通知登録シートに「権限」「備考」カラムを追加（L列、M列）
- ドロップダウンリスト設定（オーナー/スタッフ/外注）
- 安廣拓志をオーナーに自動設定
- その他のユーザーをスタッフに自動設定

**テストURL**: `test_user_migration.html`

### Phase 2: ユーザー管理UI (@597)
**実装内容**:
- ユーザー一覧表示と統計ダッシュボード
- 権限のリアルタイム編集機能
- Bootstrap 5ベースの直感的なUI

**アクセス方法**: メニュー → ユーザー権限管理

### Phase 3: 個別通知機能 (@598)
**実装内容**:
- `sendFCMNotificationToUser(title, body, targetUserName)` - 特定ユーザーへ通知
- `sendFCMNotificationToUsers(title, body, [userNames])` - 複数ユーザーへ通知
- `sendFCMNotificationByPermission(title, body, permissionLevel)` - 権限レベル別通知

**テスト方法**: Apps Scriptエディタから関数を直接実行

### Phase 4: 備品在庫リストに担当者カラム追加 (@599)
**実装内容**:
- 備品在庫リスト（M列）に「担当者」カラムを追加
- ユーザー名のドロップダウンリストを設定
- マイグレーション関数による自動追加

**テストURL**: `test_user_migration.html` (Phase 4ボタン)

### Phase 5: 在庫アラート通知先変更 (@600)
**実装内容**:
- 在庫アラート通知をオーナーのみに送信するよう変更
- `sendFCMNotificationByPermission(title, body, 'オーナー')` を使用

**テスト方法**: 在庫アラートを手動実行して確認

---

## テスト手順

### 1. Phase 1 マイグレーションテスト

**前提条件**:
- FCM通知登録シートが存在すること
- 2人以上のユーザーが登録されていること

**テスト手順**:
1. `test_user_migration.html` を開く
2. 「Phase 1 マイグレーション実行」ボタンをクリック
3. ログ出力を確認

**期待結果**:
```
✅ Phase 1 マイグレーション完了
カラム追加: 権限カラム（L列）と備考カラム（M列）を追加しました
権限設定: 安廣拓志をオーナーに設定しました
登録ユーザー数: N人
```

4. 自動的にユーザー一覧が表示される
5. 安廣拓志が「オーナー」、その他が「スタッフ」として表示される

**確認ポイント**:
- [ ] FCM通知登録シートにL列「権限」、M列「備考」が追加されている
- [ ] 安廣拓志の権限が「オーナー」になっている
- [ ] その他のユーザーの権限が「スタッフ」になっている
- [ ] ドロップダウンリストが機能している

---

### 2. ユーザー管理UIテスト

**テスト手順**:
1. REBORNシステムのメニューを開く
2. 「ユーザー権限管理」をクリック
3. UIが正しく表示されることを確認

**期待結果**:
- 統計カード（総ユーザー数、オーナー数、スタッフ数、外注数）が表示される
- ユーザー一覧テーブルが表示される
- 各ユーザーの権限が正しく表示される

**権限変更テスト**:
1. 任意のユーザーの権限ドロップダウンを変更
2. 「保存」ボタンが表示されることを確認
3. 「保存」ボタンをクリック
4. 成功トースト通知が表示される
5. 統計が自動更新される

**確認ポイント**:
- [ ] 統計カードの数値が正確
- [ ] ユーザー一覧が正しく表示される
- [ ] 権限変更が即座に反映される
- [ ] トースト通知が表示される
- [ ] FCM通知登録シートのデータが更新される

---

### 3. 個別通知機能テスト

**テスト手順**:

#### 3.1 特定ユーザーへの通知
1. Apps Scriptエディタを開く
2. `web_push.js` を選択
3. 以下のコードを実行:
```javascript
function testSendToUser() {
  const result = sendFCMNotificationToUser(
    'テスト通知',
    '特定ユーザーへのテスト通知です',
    '安廣拓志'
  );
  Logger.log(result);
}
```
4. 実行結果を確認

**期待結果**:
```json
{
  "status": "success",
  "targetUser": "安廣拓志",
  "successCount": N,
  "failCount": 0
}
```

#### 3.2 権限レベル別通知
1. 以下のコードを実行:
```javascript
function testSendToOwners() {
  const result = sendFCMNotificationByPermission(
    'オーナー通知',
    'オーナーのみに送信されるテスト通知です',
    'オーナー'
  );
  Logger.log(result);
}
```
2. オーナー権限のユーザーのみが通知を受信することを確認

**確認ポイント**:
- [ ] 指定したユーザーに通知が届く
- [ ] 他のユーザーには通知が届かない
- [ ] 複数デバイスに登録されているユーザーには全デバイスに通知が届く
- [ ] 最終送信日時が更新される

---

### 4. Phase 4 担当者カラム追加テスト

**テスト手順**:
1. `test_user_migration.html` を開く
2. 「Phase 4 マイグレーション実行」ボタンをクリック
3. ログ出力を確認

**期待結果**:
```
✅ 担当者カラム（M列）を追加しました
ユーザー名のドロップダウンリストを設定しました
=== Phase 4 マイグレーション完了 ===
```

4. 備品在庫リストシートを開く
5. M列「担当者」が追加されていることを確認
6. セルをクリックしてドロップダウンリストが表示されることを確認

**確認ポイント**:
- [ ] 備品在庫リストのM列に「担当者」カラムが追加されている
- [ ] ドロップダウンリストに登録ユーザー名が表示される
- [ ] 空白も選択可能（未設定可能）
- [ ] 2回実行しても「既に存在します」と表示され、エラーにならない

---

### 5. Phase 5 在庫アラート通知テスト

**前提条件**:
- 在庫アラート設定シートが存在すること
- テスト用の資材データが存在すること
- オーナー権限のユーザーが登録されていること

**テスト手順**:

#### 5.1 アラート設定の準備
1. 在庫アラート設定シートを開く
2. テスト用資材の閾値を現在の在庫数より高く設定
3. 通知有効にチェック

#### 5.2 手動アラート実行
1. Apps Scriptエディタを開く
2. `inventory_alert_manager.js` を選択
3. 以下の関数を実行:
```javascript
runInventoryAlertCheck()
```
4. 実行結果を確認

**期待結果**:
- オーナー権限のユーザーのみが通知を受信
- スタッフ/外注は通知を受信しない
- ログに以下のメッセージが表示される:
```
[在庫アラート] N件のアラート対象を検出
[在庫アラート] N件のアラート通知を送信しました
```

**通知内容の確認**:
```
タイトル: ⚠️ 在庫アラート
本文:
以下の梱包資材の在庫が不足しています:

1. [資材名]
   現在の在庫: N個 （閾値: N個）
```

**確認ポイント**:
- [ ] オーナーのみが通知を受信する
- [ ] 通知内容が正しく表示される
- [ ] 最終通知日時が更新される
- [ ] 24時間以内の重複通知が防止される

---

## トラブルシューティング

### 通知が届かない場合
1. FCM通知登録シートでユーザーのステータスが「アクティブ」になっているか確認
2. FCMトークンが有効か確認（古いトークンは削除）
3. Apps Scriptの実行ログでエラーメッセージを確認
4. `web_push.js` の `getAccessToken()` が正常に動作しているか確認

### Phase 4 マイグレーションが失敗する場合
1. 備品在庫リストシートが存在するか確認
2. シート名が「備品在庫リスト」であることを確認（全角スペースに注意）
3. ユーザー一覧が取得できているか確認（Phase 1が完了しているか）

### ユーザー管理UIが表示されない場合
1. デプロイIDが正しいか確認
2. `menu.js` に `user_management` のルーティングが追加されているか確認
3. ブラウザのキャッシュをクリアして再読み込み

---

## 完了チェックリスト

### Phase 1
- [ ] FCM通知登録シートに権限カラムが追加されている
- [ ] 安廣拓志がオーナーに設定されている
- [ ] その他のユーザーがスタッフに設定されている

### Phase 2
- [ ] ユーザー管理UIが正しく表示される
- [ ] 統計カードが正確
- [ ] 権限変更が正常に動作する

### Phase 3
- [ ] 特定ユーザーへの通知が正常に動作する
- [ ] 権限レベル別通知が正常に動作する

### Phase 4
- [ ] 備品在庫リストに担当者カラムが追加されている
- [ ] ドロップダウンリストが機能している

### Phase 5
- [ ] 在庫アラートがオーナーのみに送信される
- [ ] スタッフ/外注には通知が届かない

---

## 次のステップ

全テストが完了したら:
1. issues-summary.md を更新
2. INV-006を完了としてマーク
3. REBORN_ROADMAP.md を更新
4. リリースノートを作成

---

## 関連ファイル

- `user_permission_manager.js` - ユーザー権限管理ロジック
- `user_management_ui.html` - ユーザー管理UI
- `web_push.js` - 個別通知機能
- `packaging_materials_manager.js` - 備品在庫管理（担当者カラム追加）
- `inventory_alert_manager.js` - 在庫アラート管理
- `test_user_migration.html` - Phase 1, 4 テストUI
- `menu.js` - APIエンドポイント

---

**作成日**: 2025-11-03
**最終更新**: @600
**ステータス**: テスト準備完了
