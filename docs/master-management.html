<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>マスタ管理 - フリラ物販管理システム</title>

  <!-- Bootstrap 5.3 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <!-- REBORN Brand Colors & Theme -->
  <link rel="stylesheet" href="/css/reborn-brand-colors.css?v=2e88423">
  <link rel="stylesheet" href="/css/reborn-theme.css?v=2e88423">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      background: #f5f6fa;
      padding-bottom: 80px;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
    }

    /* ヘッダー - reborn-theme.cssの統一ヘッダーを使用 */

    /* マスタ種別選択 */
    .master-selector-container {
      max-width: 800px;
      margin: 16px auto;
      padding: 0 16px;
    }

    .master-selector {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .master-selector-label {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      display: block;
    }

    .master-selector-dropdown {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.2s;
      background: white;
      cursor: pointer;
    }

    .master-selector-dropdown:focus {
      border-color: #40B4E5;
    }

    /* 検索バー */
    .search-container {
      max-width: 800px;
      margin: 16px auto;
      padding: 0 16px;
    }

    .search-box {
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 12px 40px 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.2s;
      background: white;
    }

    .search-input:focus {
      border-color: #40B4E5;
    }

    .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
      font-size: 18px;
    }

    .search-result-count {
      position: absolute;
      right: 40px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      color: #666;
      background: #f0f0f0;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .search-result-count:empty {
      display: none;
    }

    /* 拡張機能バー */
    .action-bar {
      max-width: 800px;
      margin: 0 auto 16px;
      padding: 16px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      /* PC: 中央揃え、モバイル: 左右余白 */
      width: calc(100% - 32px);
      max-width: 800px;
    }

    .stats-info {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #666;
      font-weight: 600;
    }

    .stats-info i {
      color: #40B4E5;
      font-size: 18px;
    }

    .action-buttons {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-action {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-add {
      background: #40B4E5;
      color: white;
    }

    .btn-add:active {
      transform: scale(0.95);
      background: #3a9ae6;
    }

    .btn-select {
      background: #f5f5f5;
      color: #666;
    }

    .btn-select:active {
      background: #e0e0e0;
    }

    .btn-select.active {
      background: #40B4E5;
      color: white;
    }

    /* 登録件数テキスト */
    .total-count-text {
      font-size: 14px;
      font-weight: 600;
      color: #666;
      white-space: nowrap;
    }

    .total-count-text.hidden {
      display: none;
    }

    /* masterOptions専用UI */
    .master-options-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 16px;
    }

    .master-options-section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 16px;
      overflow: hidden;
    }

    .master-options-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #40B4E5;
      color: white;
      border-radius: 10px 10px 0 0;
    }

    .master-options-header h6 {
      margin: 0;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .master-options-header .badge {
      background: rgba(255,255,255,0.2) !important;
    }

    .master-options-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .master-options-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
    }

    .master-options-item:last-child {
      border-bottom: none;
    }

    .master-options-item:hover {
      background: #f8f9fa;
    }

    .master-options-item .item-text {
      flex: 1;
      font-size: 14px;
    }

    .master-options-item .item-actions {
      display: flex;
      gap: 4px;
    }

    .master-options-item .btn-icon {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    /* 編集ボタン: 常時青背景 */
    .master-options-item .btn-icon.btn-edit {
      background: #e3f2fd;
      color: #1976d2;
    }

    .master-options-item .btn-icon.btn-edit:hover {
      background: #bbdefb;
    }

    /* 削除ボタン: 常時赤背景 */
    .master-options-item .btn-icon.btn-delete {
      background: #ffebee;
      color: #c62828;
    }

    .master-options-item .btn-icon.btn-delete:hover {
      background: #ffcdd2;
    }

    .master-options-add {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      background: #f8f9fa;
      border-top: 1px solid #eee;
    }

    .master-options-add input[type="text"] {
      flex: 1;
      min-width: 0;
    }

    .master-options-add input[type="number"] {
      flex: none;
    }

    .master-options-add .btn {
      white-space: nowrap;
    }

    /* 商品属性ドロップダウンセレクター */
    .master-options-dropdown-selector {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .master-options-dropdown-selector label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .master-options-dropdown-selector .form-select {
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.2s;
    }

    .master-options-dropdown-selector .form-select:focus {
      border-color: #40B4E5;
      box-shadow: none;
    }

    /* 空状態 */
    .master-options-empty {
      padding: 24px 16px;
      text-align: center;
      color: #999;
    }

    .master-options-empty p {
      margin: 0;
      font-size: 14px;
    }

    /* マスタ検索フィルター */
    .master-filter-container {
      background: white;
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .master-filter-input {
      width: 100%;
      padding: 10px 40px 10px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      outline: none;
      transition: border-color 0.2s;
      background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23999' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E") no-repeat right 12px center;
    }

    .master-filter-input:focus {
      border-color: #40B4E5;
    }

    .master-filter-input::placeholder {
      color: #aaa;
    }

    /* フィルター結果カウント */
    .master-filter-count {
      font-size: 13px;
      color: #666;
      margin-top: 8px;
      text-align: right;
    }

    /* フィルターでハイライト */
    .master-options-item.hidden {
      display: none !important;
    }

    .filter-highlight {
      background: #fff3cd;
      padding: 0 2px;
      border-radius: 2px;
    }

    /* カテゴリツリービュー */
    .category-tree-wrapper {
      padding: 8px 0;
    }

    .category-tree-node {
      margin-bottom: 4px;
      position: relative;
    }

    /* 階層表示：最小限のインデント + 左ボーダーで階層を表現 */
    .category-tree-node.level-1 > .category-tree-header,
    .category-tree-node.level-1 > .category-tree-children { margin-left: 0; }
    .category-tree-node.level-2 > .category-tree-header,
    .category-tree-node.level-2 > .category-tree-children { margin-left: 4px; }
    .category-tree-node.level-3 > .category-tree-header,
    .category-tree-node.level-3 > .category-tree-children { margin-left: 4px; }
    .category-tree-node.level-4 > .category-tree-header,
    .category-tree-node.level-4 > .category-tree-children { margin-left: 4px; }
    .category-tree-node.level-5 > .category-tree-header,
    .category-tree-node.level-5 > .category-tree-children { margin-left: 4px; }
    .category-tree-node.level-6 > .category-tree-header,
    .category-tree-node.level-6 > .category-tree-children { margin-left: 4px; }
    .category-tree-node.level-7 > .category-tree-header,
    .category-tree-node.level-7 > .category-tree-children { margin-left: 4px; }

    /* 階層ボーダー色 */
    .category-tree-node.level-1 > .category-tree-header { border-left: 4px solid #40B4E5; }
    .category-tree-node.level-2 > .category-tree-header { border-left: 4px solid #5BC0DE; }
    .category-tree-node.level-3 > .category-tree-header { border-left: 4px solid #7FCCE8; }
    .category-tree-node.level-4 > .category-tree-header { border-left: 4px solid #A3D9F0; }
    .category-tree-node.level-5 > .category-tree-header { border-left: 4px solid #C7E7F7; }
    .category-tree-node.level-6 > .category-tree-header { border-left: 4px solid #E0F2FC; }
    .category-tree-node.level-7 > .category-tree-header { border-left: 4px solid #F0F9FF; }

    .category-tree-header {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      background: #f8f9fa;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }

    .category-tree-header:hover {
      background: #e9ecef;
    }

    .category-tree-header.expanded {
      background: #40B4E5;
      color: white;
      border-radius: 10px 10px 0 0;
    }

    .tree-node-content {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0; /* テキスト省略のため */
    }

    .tree-node-actions {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }

    .toggle-icon {
      font-size: 14px;
      transition: transform 0.2s;
      width: 16px;
      text-align: center;
    }

    .tree-spacer {
      width: 16px;
    }

    .tree-node-name {
      font-weight: 600;
      font-size: 15px;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .tree-node-count {
      font-size: 13px;
      opacity: 0.7;
      flex-shrink: 0;
    }

    .category-tree-children {
      display: grid;
      grid-template-rows: 0fr;
      overflow: hidden;
      transition: grid-template-rows 0.3s ease;
      background: transparent;
      margin-bottom: 4px;
    }

    .category-tree-children.expanded {
      grid-template-rows: 1fr;
    }

    .tree-children-inner {
      overflow: hidden;
      padding: 0;
    }

    .category-tree-children.expanded .tree-children-inner {
      padding: 4px 0;
    }

    /* ツリーアイテムカード */
    .tree-item-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: white;
      border-radius: 8px;
      margin-bottom: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .tree-item-card:last-child {
      margin-bottom: 0;
    }

    .tree-item-content {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .tree-item-name {
      font-size: 14px;
      font-weight: 500;
      color: #333;
      word-break: break-word;
    }

    .tree-item-actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .tree-item-actions .btn-icon {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tree-item-actions .btn-edit {
      background: #e3f2fd;
      color: #1976d2;
    }

    .tree-item-actions .btn-edit:hover {
      background: #bbdefb;
    }

    .tree-item-actions .btn-delete {
      background: #ffebee;
      color: #d32f2f;
    }

    .tree-item-actions .btn-delete:hover {
      background: #ffcdd2;
    }

    /* ツリー追加ボタン */
    .tree-add-btn {
      width: 24px;
      height: 24px;
      border: none;
      border-radius: 50%;
      background: #40B4E5;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s, transform 0.2s;
      margin-left: 8px;
      flex-shrink: 0;
    }

    .tree-add-btn:hover {
      background: #2196f3;
      transform: scale(1.1);
    }

    .category-tree-header:hover .tree-add-btn,
    .category-tree-header:hover .tree-kebab-btn {
      opacity: 1;
    }

    /* ケバブメニューボタン */
    .tree-kebab-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      color: #6c757d;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s, color 0.2s;
      margin-left: 2px;
      flex-shrink: 0;
      position: relative;
    }

    .tree-kebab-btn:hover {
      color: #333;
    }

    /* 展開時（青背景ヘッダー）のケバブ色 */
    .category-tree-header.expanded .tree-kebab-btn {
      color: white;
    }

    .category-tree-header.expanded .tree-kebab-btn:hover {
      color: white;
    }

    /* 展開時の件数テキストを白に */
    .category-tree-header.expanded .tree-node-count {
      color: white;
      opacity: 1;
    }

    /* 展開時の追加ボタンを反転（白背景＋青アイコン） */
    .category-tree-header.expanded .tree-add-btn {
      background: white;
      color: #40B4E5;
    }

    /* ケバブドロップダウンメニュー */
    .tree-kebab-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      min-width: 140px;
      z-index: 1000;
      overflow: hidden;
      display: none;
    }

    .tree-kebab-dropdown.show {
      display: block;
    }

    .tree-kebab-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      font-size: 14px;
      color: #333;
      cursor: pointer;
      transition: background 0.15s;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }

    .tree-kebab-item:hover {
      background: #f0f0f0;
    }

    .tree-kebab-item i {
      font-size: 15px;
      width: 18px;
      text-align: center;
    }

    .tree-kebab-item.danger {
      color: #dc3545;
    }

    .tree-kebab-item.danger:hover {
      background: #fff5f5;
    }

    /* モバイルでは常に表示 */
    @media (max-width: 768px) {
      .tree-add-btn,
      .tree-kebab-btn {
        opacity: 0.7;
      }
    }

    /* インライン追加フォーム */
    .tree-inline-add-form {
      background: #f0f9ff;
      border: 2px solid #40B4E5;
      border-radius: 10px;
      margin: 8px 0 8px 24px;
      overflow: hidden;
    }

    .inline-form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: #40B4E5;
      color: white;
    }

    .inline-form-path {
      font-size: 13px;
      font-weight: 500;
    }

    .inline-form-close {
      width: 24px;
      height: 24px;
      border: none;
      background: rgba(255,255,255,0.2);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .inline-form-close:hover {
      background: rgba(255,255,255,0.3);
    }

    .inline-form-body {
      padding: 12px;
    }

    .inline-form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px; /* iOS zoom防止 */
      resize: vertical;
      min-height: 60px;
    }

    .inline-form-input:focus {
      outline: none;
      border-color: #40B4E5;
      box-shadow: 0 0 0 3px rgba(64, 180, 229, 0.2);
    }

    .inline-form-hint {
      font-size: 11px;
      color: #888;
      margin-top: 6px;
    }

    .inline-form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    .inline-form-cancel {
      padding: 8px 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
      color: #666;
      font-size: 14px;
      cursor: pointer;
    }

    .inline-form-cancel:hover {
      background: #f5f5f5;
    }

    .inline-form-submit {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      background: #40B4E5;
      color: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    .inline-form-submit:hover {
      background: #2196f3;
    }

    /* 選択ツールバー */
    .selection-toolbar {
      max-width: 800px;
      margin: 0 auto 16px;
      padding: 12px 16px;
      background: #40B4E5;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(79, 172, 254, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-left: 16px;
      margin-right: 16px;
    }

    .btn-tool {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s;
    }

    .btn-tool:active {
      background: rgba(255, 255, 255, 0.3);
    }

    .btn-delete-selected {
      background: rgba(255, 59, 48, 0.9);
    }

    .btn-delete-selected:active {
      background: rgba(255, 59, 48, 1);
    }

    .selected-count {
      color: white;
      font-weight: 600;
      font-size: 14px;
      flex: 1;
      text-align: center;
    }

    /* データリスト */
    .brands-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 0 16px;
    }

    .master-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .master-card:active {
      transform: scale(0.98);
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }

    .master-info {
      flex: 1;
    }

    .master-field {
      margin-bottom: 4px;
    }

    .master-field-label {
      font-size: 12px;
      color: #999;
      margin-right: 4px;
    }

    .master-field-value {
      font-size: 14px;
      color: #333;
      font-weight: 600;
    }

    .master-field-primary {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }

    .master-field-secondary {
      font-size: 14px;
      color: #666;
    }

    .master-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 8px;
    }

    .usage-count {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: #999;
    }

    .master-actions {
      display: flex;
      gap: 8px;
    }

    /* 汎用削除ボタン: 淡い赤背景 */
    .btn-delete {
      background: #ffebee;
      color: #c62828;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-delete:hover {
      background: #ffcdd2;
    }

    .btn-delete:active {
      background: #ef9a9a;
    }

    /* 汎用編集ボタン: 淡い青背景 */
    .btn-edit {
      background: #e3f2fd;
      color: #1976d2;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
      margin-right: 8px;
    }

    .btn-edit:hover {
      background: #bbdefb;
    }

    .btn-edit:active {
      background: #90caf9;
    }

    .master-actions {
      display: flex;
      align-items: center;
    }

    /* アコーディオン表示 */
    .accordion-header {
      background: #40B4E5;
      color: white;
      padding: 14px 16px;
      border-radius: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s;
    }

    .accordion-header:active {
      transform: scale(0.98);
    }

    .accordion-header.expanded {
      border-radius: 10px 10px 0 0;
      margin-bottom: 0;
    }

    .accordion-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .accordion-toggle i {
      font-size: 18px;
      transition: transform 0.2s;
    }

    .accordion-title {
      font-size: 16px;
      font-weight: 600;
      flex: 1;
    }

    .accordion-count {
      font-size: 14px;
      opacity: 0.9;
    }

    .accordion-content {
      display: grid;
      grid-template-rows: 0fr;
      overflow: hidden;
      transition: grid-template-rows 0.3s ease;
      background: #f8f9fa;
      border-radius: 0 0 10px 10px;
      margin-bottom: 12px;
    }

    .accordion-content.expanded {
      grid-template-rows: 1fr;
    }

    .accordion-content > .accordion-inner {
      overflow: hidden;
      padding: 0 12px;
      transition: padding 0.3s ease;
    }

    .accordion-content.expanded > .accordion-inner {
      padding: 12px;
    }

    .accordion-content .master-card {
      margin-bottom: 10px;
      border-radius: 8px;
    }

    .accordion-content .master-card:last-child {
      margin-bottom: 0;
    }

    /* ラベル付きカード表示（縦配列） */
    .master-field-labeled {
      display: flex;
      flex-direction: column;
      margin-bottom: 10px;
      gap: 2px;
    }

    .master-field-labeled:last-child {
      margin-bottom: 0;
    }

    .master-field-labeled .field-label {
      font-size: 11px;
      color: #888;
    }

    .master-field-labeled .field-value {
      font-size: 15px;
      color: #333;
      font-weight: 600;
    }

    /* 価格表示のハイライト */
    .master-field-labeled .field-value.price-value {
      color: #e74c3c;
    }

    /* 選択モード用チェックボックス */
    .master-checkbox {
      width: 24px;
      height: 24px;
      margin-right: 12px;
      cursor: pointer;
      accent-color: #40B4E5;
    }

    .master-card.selection-mode {
      padding-left: 12px;
    }

    .master-card.selected {
      background: linear-gradient(135deg, rgba(79, 172, 254, 0.1) 0%, rgba(0, 242, 254, 0.1) 100%);
      border: 2px solid #40B4E5;
    }

    /* 空状態 */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state i {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .empty-state-text {
      font-size: 16px;
      margin-bottom: 8px;
    }

    .empty-state-hint {
      font-size: 14px;
      color: #bbb;
    }

    /* ローディング */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* モーダル */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      max-width: 400px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    /* コピーモーダル用スタイル */
    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      font-size: 20px;
      line-height: 1;
      color: #666;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    .modal-close:hover {
      background: rgba(0, 0, 0, 0.2);
      color: #333;
    }
    .copy-platform-btn:hover {
      background: #f8f9fa !important;
      border-color: #007AFF !important;
      transform: translateX(4px);
    }
    .copy-platform-btn:active {
      background: #e9ecef !important;
      transform: translateX(2px);
    }

    .modal-body {
      padding: 20px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.2s;
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      border-color: #40B4E5;
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-primary {
      background: #40B4E5;
      color: white;
    }

    .btn-primary:active {
      background: #3a9ae6;
    }

    .btn-secondary {
      background: #e0e0e0;
      color: #666;
    }

    .btn-secondary:active {
      background: #d0d0d0;
    }

    /* エラー表示 */
    .error-message {
      background: #fff3f3;
      border: 1px solid #ffcaca;
      color: #d00;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    /* 検索結果超過通知 */
    .more-results-notice {
      background: #40B4E5;
      color: white;
      padding: 16px;
      border-radius: 12px;
      margin-top: 16px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
    }

    .more-results-notice i {
      font-size: 20px;
      margin-bottom: 8px;
      display: block;
    }

    .more-results-notice span {
      display: block;
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 4px;
    }

    .more-results-notice small {
      display: block;
      font-size: 13px;
      opacity: 0.9;
    }

    /* タブナビゲーション（sidebar_config風） */
    /* サブグループ切替ボタン（2x2グリッド） */
    .sub-group-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      padding: 12px 8px;
      background: #f8f9fa;
      border-radius: 8px 8px 0 0;
      border-bottom: 1px solid #e9ecef;
    }

    .sub-group-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 500;
      color: #6c757d;
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .sub-group-btn:hover {
      background: #e9ecef;
      color: #495057;
    }

    .sub-group-btn.active {
      background: var(--reborn-primary, #40B4E5);
      color: white;
      border-color: var(--reborn-primary, #40B4E5);
      font-weight: 600;
    }

    .sub-group-btn i {
      font-size: 14px;
    }

    .nav-tabs {
      margin-bottom: 0;
      flex-wrap: nowrap;
      overflow-x: auto;
      overflow-y: hidden;
      border-bottom: none;
      background: #f8f9fa;
      padding: 8px 8px 0 8px;
      border-radius: 0;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
    }

    .nav-tabs::-webkit-scrollbar {
      height: 4px;
    }

    .nav-tabs::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 2px;
    }

    .nav-tabs .nav-link {
      font-size: 13px;
      padding: 10px 16px;
      white-space: nowrap;
      border: 1px solid transparent;
      border-radius: 6px 6px 0 0;
      color: #6c757d;
      background: transparent;
      margin-right: 4px;
      transition: all 0.2s;
    }

    .nav-tabs .nav-link:hover {
      background: #e9ecef;
      color: #495057;
    }

    .nav-tabs .nav-link.active {
      color: #212529;
      background: white;
      border-color: #dee2e6 #dee2e6 white;
      font-weight: 600;
    }

    .tab-content {
      background: white;
      padding: 20px;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* アコーディオンボディとの統合 */
    .accordion-body {
      background: #f8f9fa;
      border-radius: 0 0 8px 8px;
    }

    /* 非表示クラス */
    .hidden {
      display: none !important;
    }

    /* ルートカテゴリ追加ボタン（ツリー最上部） */
    .tree-root-add-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: #f0f9ff;
      border: 2px dashed #40B4E5;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 8px;
      color: #40B4E5;
      font-weight: 600;
      font-size: 14px;
    }

    .tree-root-add-btn:hover {
      background: #e0f2fe;
      border-color: #2196f3;
      color: #2196f3;
    }

    .tree-root-add-btn:active {
      transform: scale(0.98);
    }

    .tree-root-add-btn i {
      font-size: 18px;
    }
  </style>
</head>
<body>
  <!-- サブページヘッダー（白背景・シンプル） -->
  <style>
    .sub-header {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 56px;
      padding: 0 16px;
      background: #ffffff;
      border-bottom: 1px solid #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .sub-header-back {
      position: absolute;
      left: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: transparent;
      border: none;
      color: #374151;
      font-size: 20px;
      cursor: pointer;
    }
    .sub-header-back:hover {
      background: #f3f4f6;
    }
    .sub-header-back:active {
      background: #e5e7eb;
    }
    .sub-header-title {
      font-size: 17px;
      font-weight: 600;
      color: #111827;
      opacity: 0;
      transition: opacity 0.15s ease;
    }
    .sub-header-title.visible {
      opacity: 1;
    }
    .sub-header-icons {
      position: absolute;
      right: 8px;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    .sub-header-icon {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: transparent;
      border: none;
      color: #606060;
      font-size: 20px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .sub-header-icon:hover {
      background: #f3f4f6;
    }
    .sub-header-icon:active {
      background: #e5e7eb;
    }
  </style>
  <div class="sub-header">
    <button class="sub-header-back" id="back-button" title="戻る">
      <i class="bi bi-chevron-left"></i>
    </button>
    <span class="sub-header-title" id="headerTitle"></span>
    <div class="sub-header-icons">
      <button class="sub-header-icon" onclick="window.parent.postMessage({type:'openChatRooms'}, '*')" title="お知らせ">
        <i class="bi bi-bell"></i>
      </button>
      <button class="sub-header-icon" onclick="window.parent.postMessage({type:'toggleDrawer'}, '*')" title="メニュー">
        <i class="bi bi-list"></i>
      </button>
    </div>
  </div>

  <!-- マスタタブナビゲーション -->
  <div class="master-tabs-container" style="max-width: 800px; margin: 16px auto; padding: 0 16px;">
    <!-- 商品関連マスタタブ -->
    <div id="product-master-tabs" style="display: none;">
      <!-- サブグループ切替ボタン -->
      <div id="productSubGroupButtons" class="sub-group-buttons">
        <button class="sub-group-btn active" data-subgroup="listing" onclick="switchProductSubGroup('listing')">
          <i class="bi bi-tag"></i> 出品設定
        </button>
        <button class="sub-group-btn" data-subgroup="description" onclick="switchProductSubGroup('description')">
          <i class="bi bi-file-text"></i> 説明文生成
        </button>
      </div>
      
      <!-- 出品設定タブ -->
      <ul class="nav nav-tabs" id="productMasterTabs-listing" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="master-brand-tab" data-bs-toggle="tab" data-bs-target="#master-brand" type="button" role="tab" onclick="loadMaster('product', 'brand')"><i class="bi bi-tag"></i> ブランド</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-category-tab" data-bs-toggle="tab" data-bs-target="#master-category" type="button" role="tab" onclick="loadMaster('product', 'category')"><i class="bi bi-folder"></i> カテゴリ</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-size-tab" data-bs-toggle="tab" data-bs-target="#master-size" type="button" role="tab" onclick="loadMaster('product', 'size')"><i class="bi bi-rulers"></i> サイズ</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-condition-tab" data-bs-toggle="tab" data-bs-target="#master-condition" type="button" role="tab" onclick="loadMaster('product', 'condition')"><i class="bi bi-star"></i> 商品の状態</button>
        </li>
      </ul>
      
      <!-- 説明文生成タブ -->
      <ul class="nav nav-tabs" id="productMasterTabs-description" role="tablist" style="display: none;">
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-material-tab" data-bs-toggle="tab" data-bs-target="#master-material" type="button" role="tab" onclick="loadMaster('product', 'material')"><i class="bi bi-palette"></i> 素材</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-colorDetail-tab" data-bs-toggle="tab" data-bs-target="#master-colorDetail" type="button" role="tab" onclick="loadMaster('product', 'colorDetail')"><i class="bi bi-droplet-fill"></i> カラー(詳細)</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-accessory-tab" data-bs-toggle="tab" data-bs-target="#master-accessory" type="button" role="tab" onclick="loadMaster('product', 'accessory')"><i class="bi bi-box"></i> 付属品</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-sizeLabel-tab" data-bs-toggle="tab" data-bs-target="#master-sizeLabel" type="button" role="tab" onclick="loadMaster('product', 'sizeLabel')"><i class="bi bi-tag"></i> サイズ(表記)</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-salesword-tab" data-bs-toggle="tab" data-bs-target="#master-salesword" type="button" role="tab" onclick="loadMaster('product', 'salesword')"><i class="bi bi-chat-quote"></i> セールスワード</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-attribute-tab" data-bs-toggle="tab" data-bs-target="#master-attribute" type="button" role="tab" onclick="loadMaster('product', 'attribute')"><i class="bi bi-tags"></i> 商品属性</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-conditionRank-tab" data-bs-toggle="tab" data-bs-target="#master-conditionRank" type="button" role="tab" onclick="loadMaster('product', 'conditionRank')"><i class="bi bi-star-half"></i> ランク</button>
        </li>
      </ul>
    </div>

    <!-- 業務関連マスタタブ -->
    <div id="business-master-tabs" style="display: none;">
      <!-- サブグループ切替ボタン -->
      <div id="businessSubGroupButtons" class="sub-group-buttons">
        <button class="sub-group-btn active" data-subgroup="delivery" onclick="switchBusinessSubGroup('delivery')">
          <i class="bi bi-truck"></i> 配送設定
        </button>
        <button class="sub-group-btn" data-subgroup="material" onclick="switchBusinessSubGroup('material')">
          <i class="bi bi-box-seam"></i> 資材・在庫
        </button>
        <button class="sub-group-btn" data-subgroup="partner" onclick="switchBusinessSubGroup('partner')">
          <i class="bi bi-building"></i> 取引先
        </button>
        <button class="sub-group-btn" data-subgroup="system" onclick="switchBusinessSubGroup('system')">
          <i class="bi bi-gear"></i> システム設定
        </button>
      </div>
      
      <!-- 配送設定タブ -->
      <ul class="nav nav-tabs" id="businessMasterTabs-delivery" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="master-shipping-tab" data-bs-toggle="tab" data-bs-target="#master-shipping" type="button" role="tab" onclick="loadMaster('business', 'shipping')"><i class="bi bi-truck"></i> 発送方法</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-shippingBurden-tab" data-bs-toggle="tab" data-bs-target="#master-shippingBurden" type="button" role="tab" onclick="loadMaster('business', 'shippingBurden')"><i class="bi bi-cash-coin"></i> 配送料の負担</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-shippingRegion-tab" data-bs-toggle="tab" data-bs-target="#master-shippingRegion" type="button" role="tab" onclick="loadMaster('business', 'shippingRegion')"><i class="bi bi-geo-alt"></i> 発送元の地域</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-shippingDays-tab" data-bs-toggle="tab" data-bs-target="#master-shippingDays" type="button" role="tab" onclick="loadMaster('business', 'shippingDays')"><i class="bi bi-calendar-check"></i> 発送までの日数</button>
        </li>
      </ul>
      
      <!-- 資材・在庫タブ -->
      <ul class="nav nav-tabs" id="businessMasterTabs-material" role="tablist" style="display: none;">
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-packaging-tab" data-bs-toggle="tab" data-bs-target="#master-packaging" type="button" role="tab" onclick="loadMaster('business', 'packaging')"><i class="bi bi-box-seam"></i> 梱包資材</button>
        </li>
      </ul>
      
      <!-- 取引先タブ -->
      <ul class="nav nav-tabs" id="businessMasterTabs-partner" role="tablist" style="display: none;">
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-supplier-tab" data-bs-toggle="tab" data-bs-target="#master-supplier" type="button" role="tab" onclick="loadMaster('business', 'supplier')"><i class="bi bi-building"></i> 仕入先</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-marketplace-tab" data-bs-toggle="tab" data-bs-target="#master-marketplace" type="button" role="tab" onclick="loadMaster('business', 'marketplace')"><i class="bi bi-shop"></i> 出品先</button>
        </li>
      </ul>
      
      <!-- システム設定タブ -->
      <ul class="nav nav-tabs" id="businessMasterTabs-system" role="tablist" style="display: none;">
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="master-managementNumber-tab" data-bs-toggle="tab" data-bs-target="#master-managementNumber" type="button" role="tab" onclick="loadManagementNumberMaster()"><i class="bi bi-123"></i> 管理番号</button>
        </li>
      </ul>
    </div>
  </div>

  <!-- 検索バー（全タブ共通） -->
  <div id="searchContainer" class="search-container">
    <div class="search-box">
      <input type="text" id="searchInput" class="search-input" placeholder="絞り込み検索..." oninput="handleGlobalFilter(this.value)">
      <i class="bi bi-search search-icon"></i>
      <span id="searchResultCount" class="search-result-count"></span>
    </div>
  </div>

  <!-- GAS版マスタ管理iframe（発送方法・梱包資材用） -->
  <div class="gas-master-iframe-container hidden" id="gasMasterIframeContainer">
    <iframe id="gasMasterIframe" style="width: 100%; height: calc(100vh - 160px); border: none;"></iframe>
  </div>

  <!-- 拡張機能バー -->
  <div class="action-bar">
    <div class="action-buttons">
      <button class="btn-action btn-add" onclick="showAddModal()">
        <i class="bi bi-plus-circle"></i>
        <span>新規追加</span>
      </button>
      <button class="btn-action btn-add" id="categoryAddBtn" onclick="showRootCategoryAddForm()" style="display: none;">
        <i class="bi bi-plus-circle"></i>
        <span>カテゴリ追加</span>
      </button>
      <button class="btn-action btn-select" onclick="toggleSelectionMode()" id="selectModeBtn">
        <i class="bi bi-check-square"></i>
        <span>選択削除</span>
      </button>
    </div>
    <div class="stats-info">
      <span id="statsText"></span>
      <span id="totalCountBadge" class="hidden"></span>
    </div>
  </div>

  <!-- 選択モード時のツールバー -->
  <div class="selection-toolbar hidden" id="selectionToolbar">
    <button class="btn-tool" onclick="selectAll()">
      <i class="bi bi-check-all"></i>
      全選択
    </button>
    <span class="selected-count" id="selectedCount">0件選択中</span>
    <button class="btn-tool btn-delete-selected" onclick="deleteSelected()">
      <i class="bi bi-trash"></i>
      削除
    </button>
  </div>

  <!-- マスタリスト -->
  <div class="brands-container" id="masterListContainer">
    <!-- マスタカードがここに動的生成される -->
  </div>

  <!-- 空状態 -->
  <div class="empty-state hidden" id="emptyState">
    <i class="bi bi-inbox empty-state-icon"></i>
    <div class="empty-state-text" id="emptyStateText">マスタを選択してください</div>
    <div class="empty-state-hint" id="emptyStateHint"></div>
  </div>

  <!-- ローディングオーバーレイ -->
  <div class="loading-overlay hidden" id="loadingOverlay">
    <div class="loading-spinner"></div>
  </div>

  <!-- 追加モーダル -->
  <div class="modal-backdrop hidden" id="addModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="addModalTitle">新規追加</div>
      </div>
      <div class="modal-body">
        <div class="error-message hidden" id="addErrorMessage"></div>
        <div id="addModalBody">
          <!-- 動的にフィールドが生成される -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="addCancelBtn" onclick="hideAddModal()">キャンセル</button>
        <button class="btn btn-primary" id="addSubmitBtn" onclick="addMaster()">追加</button>
      </div>
    </div>
  </div>

  <!-- 削除確認モーダル -->
  <div class="modal-backdrop hidden" id="deleteModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="deleteModalTitle">削除確認</div>
      </div>
      <div class="modal-body">
        <p>以下のデータを削除してもよろしいですか？</p>
        <div style="margin-top: 16px; padding: 12px; background: #f5f5f5; border-radius: 8px;" id="deleteNameDisplay">
          <!-- 削除対象のデータプレビューが表示される -->
        </div>
        <p style="margin-top: 16px; color: #ff4757; font-size: 14px;">
          <i class="bi bi-exclamation-triangle"></i>
          この操作は取り消せません
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideDeleteModal()">キャンセル</button>
        <button class="btn btn-primary" style="background: #ff4757;" onclick="confirmDelete()">削除</button>
      </div>
    </div>
  </div>

  <!-- 編集モーダル（梱包資材・発送方法用） -->
  <div class="modal-backdrop hidden" id="editItemModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="editItemModalTitle">編集</div>
      </div>
      <div class="modal-body">
        <div id="editItemModalBody">
          <!-- 動的にフィールドが生成される -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideEditItemModal()">キャンセル</button>
        <button class="btn btn-primary" id="editItemSubmitBtn" onclick="submitEditItem()">保存</button>
      </div>
    </div>
  </div>

  <!-- コピー先選択モーダル -->
  <div class="modal-backdrop hidden" id="copyModal">
    <div class="modal-content" style="max-width: 360px;">
      <div class="modal-header">
        <div class="modal-title" id="copyModalTitle">コピー先を選択</div>
        <button type="button" class="modal-close" onclick="hideCopyModal()">&times;</button>
      </div>
      <div class="modal-body" style="padding: 16px;">
        <div id="copyModalInfo" style="margin-bottom: 16px; padding: 12px; background: #f8f9fa; border-radius: 8px; text-align: center;">
          <div style="font-weight: 600; color: #333;"></div>
          <div style="font-size: 13px; color: #666; margin-top: 4px;"></div>
        </div>
        <div id="copyPlatformList" style="display: flex; flex-direction: column; gap: 8px;">
          <!-- プラットフォームボタンがここに生成される -->
        </div>
      </div>
      <div class="modal-footer" style="justify-content: center; border-top: 1px solid #eee; padding-top: 12px;">
        <button class="btn btn-secondary" onclick="hideCopyModal()">キャンセル</button>
      </div>
    </div>
  </div>

  <!-- Bootstrap 5.3 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase SDK (compat版) - マスタ管理用 -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <!-- Firebase Modular SDK (count()クエリ用) -->
  <script type="module">
    import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getCountFromServer } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase設定（compat版と同じ）
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjKjwwtCorUZQ",
      authDomain: "furira.jp",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    // まだ初期化されていなければ初期化
    let app;
    if (getApps().length === 0) {
      app = initializeApp(FIREBASE_CONFIG);
      console.log('✅ [Modular SDK] Firebase App初期化完了');
    } else {
      app = getApps()[0];
      console.log('✅ [Modular SDK] 既存のFirebase Appを使用');
    }

    const db = getFirestore(app);

    // グローバルに公開（getMasterCountで使用）
    window.firestoreModular = {
      db,
      collection,
      getCountFromServer
    };
    console.log('✅ [Modular SDK] count()クエリ用モジュール読み込み完了');
  </script>

  <!-- マスタ定義設定読み込み -->
  <script src="./js/master-config.js?v=510"></script>

  <!-- マスタキャッシュシステム読み込み（ブランド＋カテゴリ） -->
  <script src="/js/master-cache.js?v=395"></script>

  <!-- Firestore API + マスタ管理ロジック読み込み -->
  <script type="module">
    // Firestore API読み込み
    import('./js/firestore-api.js?v=367').then(module => {
      console.log('✅ [Master Management] Firestore API読み込み完了');

      // グローバルスコープに代入
      window.getMasterData = module.getMasterData;
      window.createMaster = module.createMaster;
      window.updateMaster = module.updateMaster;
      window.deleteMaster = module.deleteMaster;
      window.searchMaster = module.searchMaster;
      window.incrementMasterUsageCount = module.incrementMasterUsageCount;
      window.initializeFirestore = module.initializeFirestore;
      window.getMasterCount = module.getMasterCount;

      console.log('✅ [Master Management] グローバル関数設定完了');

      // マスタ管理ロジック読み込み
      return import('./js/master-manager.js?v=510');
    }).then(() => {
      console.log('✅ [Master Management] master-manager.js読み込み完了');

      // 初期化関数呼び出し
      if (typeof window.initMasterManager === 'function') {
        console.log('🚀 [Master Management] 初期化開始...');
        window.initMasterManager();

        // URLパラメータから category と sessionId を取得
        const urlParams = new URLSearchParams(window.location.search);
        const category = urlParams.get('category') || 'product'; // デフォルトは product
        const sessionId = urlParams.get('sessionId');

        console.log('[Master Management] URLパラメータ category:', category);
        console.log('[Master Management] URLパラメータ sessionId:', sessionId);

        // sessionIdをsessionStorageに保存（iframe内でもアクセス可能にする）
        if (sessionId) {
          sessionStorage.setItem('device_session_id', sessionId);
          console.log('[Master Management] ✅ sessionIdをsessionStorageに保存しました');
        } else {
          console.warn('[Master Management] ⚠️ URLパラメータにsessionIdがありません');
        }

        // カテゴリに応じてタブを表示/非表示
        setTimeout(() => {
          const productTabs = document.getElementById('product-master-tabs');
          const businessTabs = document.getElementById('business-master-tabs');

          if (category === 'product') {
            productTabs.style.display = 'block';
            businessTabs.style.display = 'none';
            // ヘッダータイトルを変更
            document.getElementById('headerTitle').textContent = '商品マスタ管理';
            // 商品関連マスタの最初のタブ（ブランド）をロード
            if (typeof window.loadMaster === 'function') {
              window.loadMaster('product', 'brand');
            }
          } else if (category === 'business') {
            productTabs.style.display = 'none';
            businessTabs.style.display = 'block';
            // ヘッダータイトルを変更
            document.getElementById('headerTitle').textContent = '業務マスタ管理';
            // 業務関連マスタの最初のタブ（発送方法）をロード
            if (typeof window.loadMaster === 'function') {
              window.loadMaster('business', 'shipping');
            }
          }
        }, 100);
      } else {
        console.error('❌ [Master Management] initMasterManager が見つかりません');
      }
    }).catch(error => {
      console.error('❌ [Master Management] 初期化エラー:', error);
      alert('初期化エラーが発生しました。ページを再読み込みしてください。');
    });
  </script>

  <!-- 戻るボタン処理 -->
  <script>
    function goBack() {
      // 確実なログ（関数呼び出し確認用）
      console.log('[master-management] >>> goBack() called at', new Date().toISOString());

      // iframe内で開かれているか判定
      const isInIframe = window.self !== window.top;

      if (isInIframe) {
        // iframe内から親ページに戻る（postMessage方式 - config.htmlと同じ）
        console.log('[master-management] iframe内で開かれているため、postMessage送信（履歴ベースの戻る）');
        window.top.postMessage({ type: 'goBack' }, '*');
        console.log('[master-management] ✅ postMessage送信完了 (type: goBack)');
      } else {
        // 直接開かれている場合はトップメニューに遷移
        console.log('[master-management] 直接開かれているため、トップメニューに遷移');
        // referrerが同じドメインの場合はhistory.back()、そうでなければindex.htmlに遷移
        const referrer = document.referrer;
        const isSameDomain = referrer && referrer.includes(window.location.hostname);

        if (isSameDomain && window.history.length > 1) {
          console.log('[master-management] 同じドメインからの遷移 - history.back()');
          window.history.back();
        } else {
          console.log('[master-management] 直接アクセス - index.htmlに遷移');
          window.location.href = '/index.html';
        }
      }
    }

    // DOMContentLoaded後に戻るボタンにイベントリスナーを設定（推奨方式）
    document.addEventListener('DOMContentLoaded', () => {
      const backButton = document.getElementById('back-button');
      if (backButton) {
        backButton.addEventListener('click', goBack);
        console.log('[master-management] ✅ 戻るボタンにgoBack()イベントリスナーを設定しました');
      } else {
        console.error('[master-management] ❌ 戻るボタンが見つかりません');
      }
    });
  </script>

  <!-- スワイプジェスチャー -->
  <script>
    // 商品関連マスタタブのスワイプジェスチャー（サブグループ対応）
    (function() {
      const productAccordionBody = document.getElementById('productMasterCollapse');
      if (!productAccordionBody) return;

      // サブグループごとのタブ定義
      const subGroupTabs = {
        listing: {
          tabIds: ['master-brand', 'master-category', 'master-size', 'master-condition'],
          masterTypes: ['brand', 'category', 'size', 'condition']
        },
        description: {
          tabIds: ['master-material', 'master-accessory', 'master-sizeLabel', 'master-salesword', 'master-attribute'],
          masterTypes: ['material', 'accessory', 'sizeLabel', 'salesword', 'attribute']
        }
      };

      let touchStartX = 0;
      let touchStartY = 0;
      let touchEndX = 0;
      let touchEndY = 0;
      let isSwiping = false;
      const minSwipeDistance = 80;
      const maxVerticalDeviation = 40;

      productAccordionBody.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
        isSwiping = true;
      }, { passive: true });

      productAccordionBody.addEventListener('touchmove', (e) => {
        if (!isSwiping) return;

        const currentX = e.changedTouches[0].screenX;
        const currentY = e.changedTouches[0].screenY;
        const diffX = Math.abs(currentX - touchStartX);
        const diffY = Math.abs(currentY - touchStartY);

        if (diffY > maxVerticalDeviation || (diffY > 15 && diffY > diffX)) {
          isSwiping = false;
        }
      }, { passive: true });

      productAccordionBody.addEventListener('touchend', (e) => {
        if (!isSwiping) {
          isSwiping = false;
          return;
        }

        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleSwipe();
        isSwiping = false;
      }, { passive: true });

      function handleSwipe() {
        const diffX = touchStartX - touchEndX;
        const diffY = Math.abs(touchStartY - touchEndY);

        if (Math.abs(diffX) < minSwipeDistance || diffY > maxVerticalDeviation) return;
        if (Math.abs(diffX) < diffY * 2.5) return;

        // 現在のサブグループを取得
        const currentSubGroup = typeof currentProductSubGroup !== 'undefined' ? currentProductSubGroup : 'listing';
        const { tabIds, masterTypes } = subGroupTabs[currentSubGroup] || subGroupTabs.listing;

        // 現在のサブグループのタブセレクタを使用
        const tabContainer = document.getElementById(`productMasterTabs-${currentSubGroup}`);
        const activeTab = tabContainer?.querySelector('.nav-link.active');
        if (!activeTab) return;

        const currentId = activeTab.id.replace('-tab', '');
        const currentIndex = tabIds.indexOf(currentId);
        if (currentIndex === -1) return;

        let nextIndex;
        if (diffX > 0) {
          nextIndex = currentIndex + 1;
          if (nextIndex >= tabIds.length) return;
        } else {
          nextIndex = currentIndex - 1;
          if (nextIndex < 0) return;
        }

        const nextTabId = tabIds[nextIndex];
        const nextMasterType = masterTypes[nextIndex];
        const nextTabButton = document.getElementById(`${nextTabId}-tab`);
        if (nextTabButton) {
          const tab = new bootstrap.Tab(nextTabButton);
          tab.show();

          // タブナビゲーションを自動スクロール
          setTimeout(() => {
            nextTabButton.scrollIntoView({
              behavior: 'smooth',
              block: 'nearest',
              inline: 'center'
            });
          }, 50);

          // マスタデータをロード
          loadMaster('product', nextMasterType);
        }
      }
    })();

    // 業務関連マスタタブのスワイプジェスチャー
    (function() {
      const businessAccordionBody = document.getElementById('businessMasterCollapse');
      if (!businessAccordionBody) return;

      const tabIds = ['master-shipping', 'master-shippingBurden', 'master-shippingRegion', 'master-shippingDays', 'master-packaging', 'master-staff', 'master-supplier', 'master-marketplace', 'master-categoryCode'];
      const masterTypes = ['shipping', 'shippingBurden', 'shippingRegion', 'shippingDays', 'packaging', 'staff', 'supplier', 'marketplace', 'categoryCode'];
      let touchStartX = 0;
      let touchStartY = 0;
      let touchEndX = 0;
      let touchEndY = 0;
      let isSwiping = false;
      const minSwipeDistance = 80;
      const maxVerticalDeviation = 40;

      businessAccordionBody.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
        isSwiping = true;
      }, { passive: true });

      businessAccordionBody.addEventListener('touchmove', (e) => {
        if (!isSwiping) return;

        const currentX = e.changedTouches[0].screenX;
        const currentY = e.changedTouches[0].screenY;
        const diffX = Math.abs(currentX - touchStartX);
        const diffY = Math.abs(currentY - touchStartY);

        if (diffY > maxVerticalDeviation || (diffY > 15 && diffY > diffX)) {
          isSwiping = false;
        }
      }, { passive: true });

      businessAccordionBody.addEventListener('touchend', (e) => {
        if (!isSwiping) {
          isSwiping = false;
          return;
        }

        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleSwipe();
        isSwiping = false;
      }, { passive: true });

      function handleSwipe() {
        const diffX = touchStartX - touchEndX;
        const diffY = Math.abs(touchStartY - touchEndY);

        if (Math.abs(diffX) < minSwipeDistance || diffY > maxVerticalDeviation) return;
        if (Math.abs(diffX) < diffY * 2.5) return;

        const activeTab = document.querySelector('#businessMasterTabs .nav-link.active');
        if (!activeTab) return;

        const currentId = activeTab.id.replace('-tab', '');
        const currentIndex = tabIds.indexOf(currentId);
        if (currentIndex === -1) return;

        let nextIndex;
        if (diffX > 0) {
          nextIndex = currentIndex + 1;
          if (nextIndex >= tabIds.length) return;
        } else {
          nextIndex = currentIndex - 1;
          if (nextIndex < 0) return;
        }

        const nextTabId = tabIds[nextIndex];
        const nextMasterType = masterTypes[nextIndex];
        const nextTabButton = document.getElementById(`${nextTabId}-tab`);
        if (nextTabButton) {
          const tab = new bootstrap.Tab(nextTabButton);
          tab.show();

          // タブナビゲーションを自動スクロール
          setTimeout(() => {
            nextTabButton.scrollIntoView({
              behavior: 'smooth',
              block: 'nearest',
              inline: 'center'
            });
          }, 50);

          // マスタデータをロード
          loadMaster('business', nextMasterType);
        }
      }
    })();
  </script>
</body>
</html>
