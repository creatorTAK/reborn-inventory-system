<!-- ç®¡ç†ç•ªå·ãƒ“ãƒ«ãƒ€ãƒ¼ - ãƒ¬ã‚´ãƒ–ãƒ­ãƒƒã‚¯å¼ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ§‹ç¯‰ã‚·ã‚¹ãƒ†ãƒ  -->
<style>
  .mnb-container {
    padding: 0;
    background: white;
    border-radius: 8px;
  }

  .mnb-title {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 16px;
    color: #212529;
  }

  /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆ */
  .mnb-segments {
    background: white;
    border: none;
    border-radius: 8px;
    padding: 0;
    min-height: 100px;
    margin-bottom: 16px;
  }

  .mnb-segments.drag-over {
    background: #e3f2fd;
    border-color: #2196f3;
  }

  .mnb-segments-empty {
    text-align: center;
    color: #9ca3af;
    padding: 24px 16px;
    font-size: 13px;
    line-height: 1.6;
  }

  /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒ–ãƒ­ãƒƒã‚¯ */
  .mnb-segment {
    background: white;
    border: 1px solid #e5e7eb;
    color: #1f2937;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: move;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    transition: all 0.2s;
  }

  .mnb-segment:hover {
    border-color: #3b82f6;
    box-shadow: 0 2px 6px rgba(59,130,246,0.15);
  }

  .mnb-segment.dragging {
    opacity: 0.5;
  }

  .mnb-segment-header {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
  }

  .mnb-segment-drag-handle {
    font-size: 16px;
    color: #9ca3af;
    cursor: grab;
  }

  .mnb-segment-drag-handle:active {
    cursor: grabbing;
  }

  .mnb-segment-icon {
    font-size: 18px;
  }

  .mnb-segment-type {
    flex: 1;
    font-size: 12px;
    font-weight: 500;
    color: #6b7280;
  }

  .mnb-segment-value {
    font-size: 15px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 8px;
  }

  .mnb-segment-controls {
    display: flex;
    gap: 8px;
  }

  .mnb-segment-btn {
    flex: 1;
    background: white;
    border: 1px solid #d1d5db;
    color: #374151;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    transition: all 0.2s;
    font-weight: 500;
  }

  .mnb-segment-btn:hover {
    background: #f9fafb;
    border-color: #9ca3af;
  }

  .mnb-segment-btn.delete {
    color: #ef4444;
    border-color: #fecaca;
  }

  .mnb-segment-btn.delete:hover {
    background: #fef2f2;
    border-color: #ef4444;
  }

  /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¿½åŠ ãƒœã‚¿ãƒ³ */
  .mnb-add-segment {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    width: 100%;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-bottom: 16px;
  }

  .mnb-add-segment:hover {
    background: #2563eb;
  }

  /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
  .mnb-preview {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 12px;
  }

  .mnb-preview-label {
    font-size: 11px;
    color: #6b7280;
    margin-bottom: 8px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .mnb-preview-value {
    padding: 6px 10px;
    background: #eff6ff;
    border: 1px solid #bfdbfe;
    border-radius: 6px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    font-size: 11px;
    color: #1e40af;
    font-weight: 500;
  }

  .mnb-preview-parts {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .mnb-preview-part {
    background: #f3f4f6;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    color: #6b7280;
    font-weight: 500;
  }

  /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .mnb-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    align-items: center;
    justify-content: center;
  }

  .mnb-modal.active {
    display: flex;
  }

  .mnb-modal-content {
    background: white;
    border-radius: 12px;
    padding: 20px;
    max-width: 600px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
  }

  .mnb-modal-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 16px;
    color: #1f2937;
  }

  .mnb-form-group {
    margin-bottom: 12px;
  }

  .mnb-form-label {
    display: block;
    font-size: 12px;
    font-weight: 500;
    color: #374151;
    margin-bottom: 4px;
  }

  .mnb-form-input,
  .mnb-form-select {
    width: 100%;
    padding: 6px 10px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 13px;
  }

  .mnb-form-input:focus,
  .mnb-form-select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .mnb-modal-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
  }

  .mnb-modal-btn {
    flex: 1;
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
  }

  .mnb-modal-btn-primary {
    background: #3b82f6;
    color: white;
  }

  .mnb-modal-btn-primary:hover {
    background: #2563eb;
  }

  .mnb-modal-btn-secondary {
    background: #e5e7eb;
    color: #374151;
  }

  .mnb-modal-btn-secondary:hover {
    background: #d1d5db;
  }

  /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—é¸æŠ */
  .mnb-type-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-bottom: 12px;
  }

  .mnb-type-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    padding: 10px 12px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }

  .mnb-type-card:hover {
    border-color: #3b82f6;
    background: #f0f9ff;
  }

  .mnb-type-card.selected {
    border-color: #3b82f6;
    background: #dbeafe;
  }

  .mnb-type-card-icon {
    font-size: 30px;
    margin-bottom: 4px;
  }

  .mnb-type-card-name {
    font-size: 13px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 3px;
  }

  .mnb-type-card-desc {
    font-size: 11px;
    color: #6b7280;
    line-height: 1.3;
  }
</style>

<!-- ç®¡ç†ç•ªå·ãƒ“ãƒ«ãƒ€ãƒ¼UI -->
<div class="mnb-container">
  <div class="mnb-title">ğŸ”¢ ç®¡ç†ç•ªå·è¨­å®š</div>

  <!-- ãƒ’ãƒ³ãƒˆ -->
  <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
    <div onclick="toggleHintSection('mnb', 'overview')" style="cursor: pointer; user-select: none; display: flex; align-items: center; justify-content: space-between; color: #3b82f6; font-weight: 600; margin-bottom: 4px;">
      <span>ğŸ’¡ æ¦‚è¦</span>
      <span id="mnb-overview-icon">â–¶</span>
    </div>
    <div id="mnb-overview-content" style="display: none; padding-left: 12px; margin-bottom: 8px;">
      å•†å“ç™»éŒ²æ™‚ã«è‡ªå‹•ã§ç®¡ç†ç•ªå·ï¼ˆä¾‹: AA-1001ï¼‰ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸æŠã—ãŸã‚Šã€ã‚»ã‚°ãƒ¡ãƒ³ãƒˆï¼ˆã‚«ãƒ†ã‚´ãƒªã€æ—¥ä»˜ã€ãƒ©ãƒ³ã‚¯ã€ã‚µã‚¤ã‚ºã€ã‚«ãƒ©ãƒ¼ã€é€£ç•ªã€ã‚«ã‚¹ã‚¿ãƒ å€¤ï¼‰ã‚’è‡ªç”±ã«çµ„ã¿åˆã‚ã›ã¦ã€ç‹¬è‡ªã®ç®¡ç†ç•ªå·ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ä½œæˆã§ãã¾ã™
    </div>
    <div onclick="toggleHintSection('mnb', 'hint')" style="cursor: pointer; user-select: none; display: flex; align-items: center; justify-content: space-between; color: #3b82f6; font-weight: 600; margin-bottom: 4px;">
      <span>ğŸ“Œ ä½¿ã„æ–¹</span>
      <span id="mnb-hint-icon">â–¶</span>
    </div>
    <div id="mnb-hint-content" style="display: none; padding-left: 12px;">
      1. ğŸ“‹ ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸æŠ<br>
      2. ğŸ”§ ã€Œ+ ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ã§é …ç›®ã‚’è¿½åŠ ãƒ»ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º<br>
      3. â‹®â‹® ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå·¦å´ã®6ã¤ãƒœã‚¿ãƒ³ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é †ç•ªã‚’ä¸¦ã³æ›¿ãˆ<br>
      4. ã€Œå‰Šé™¤ã€ãƒœã‚¿ãƒ³ã§ä¸è¦ãªã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤<br>
      5. ğŸ—‘ï¸ ã€Œã™ã¹ã¦ã‚¯ãƒªã‚¢ã€ãƒœã‚¿ãƒ³ã§ãƒªã‚»ãƒƒãƒˆï¼ˆå…¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå‰Šé™¤ï¼‰
    </div>
  </div>

  <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠ -->
  <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
    <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px; display: block;">
      ğŸ“‹ ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰é¸æŠ
    </label>
    <select id="mnbPresetSelect" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 13px; background: #f9fafb; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='white';" onblur="this.style.borderColor='#d1d5db'; this.style.background='#f9fafb';">
      <option value="" style="padding: 8px;">-- ã‚«ã‚¹ã‚¿ãƒ è¨­å®š --</option>
      <option value="simple" style="padding: 8px;">ğŸ”¢ ã‚·ãƒ³ãƒ—ãƒ«é€£ç•ªã€€(ä¾‹: 1001, 1002, 1003...)</option>
      <option value="shelf" style="padding: 8px;">ğŸ“¦ æ£šç•ªå· + é€£ç•ªã€€(ä¾‹: AA-1001, BB-1001...)</option>
      <option value="category_date" style="padding: 8px;">ğŸ“… ã‚«ãƒ†ã‚´ãƒª + æ—¥ä»˜ + é€£ç•ªã€€(ä¾‹: K-251007-001...)</option>
      <option value="shelf_date" style="padding: 8px;">ğŸ—“ï¸ æ£šç•ªå· + æ—¥ä»˜ + é€£ç•ªã€€(ä¾‹: AA-251007-001...)</option>
      <option value="category_rank" style="padding: 8px;">â­ ã‚«ãƒ†ã‚´ãƒª + ãƒ©ãƒ³ã‚¯ + é€£ç•ªã€€(ä¾‹: K-A-001...)</option>
    </select>
  </div>

  <!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆ -->
  <div id="mnbSegmentsList" class="mnb-segments">
    <div class="mnb-segments-empty">
      ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„<br><small style="font-size: 12px;">ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆã§ãã¾ã™</small>
    </div>
  </div>

  <!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¿½åŠ ãƒœã‚¿ãƒ³ -->
  <button type="button" class="mnb-add-segment" onclick="openAddSegmentModal()">
    <span>â•</span>
    <span>ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ </span>
  </button>

  <!-- ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
  <button type="button" onclick="clearManagementNumberSettings()" style="width: 100%; padding: 10px; background: white; border: 2px solid #ef4444; border-radius: 8px; color: #ef4444; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 16px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
    ğŸ—‘ï¸ ã™ã¹ã¦ã‚¯ãƒªã‚¢
  </button>

  <!-- ç®¡ç†ç•ªå·ã®é…ç½®è¨­å®š -->
  <div style="margin-top: 24px; padding: 16px; background: white; border: 1px solid #e5e7eb; border-radius: 8px;">
    <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">
      ğŸ“Œ ç®¡ç†ç•ªå·ã®é…ç½®
    </div>
    <div style="font-size: 12px; color: #6b7280; margin-bottom: 12px; line-height: 1.5;">
      ç”Ÿæˆã•ã‚ŒãŸç®¡ç†ç•ªå·ã‚’ã©ã“ã«è¡¨ç¤ºã™ã‚‹ã‹è¨­å®šã§ãã¾ã™
    </div>

    <!-- é…ç½®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px;">
      <div style="display: flex; align-items: center; gap: 6px;">
        <input type="checkbox" id="å•†å“åã«ç®¡ç†ç•ªå·é…ç½®" style="width: 16px; height: 16px; cursor: pointer;" onchange="toggleManagementNumberFormat(); if (typeof onManagementNumberSettingChange === 'function') onManagementNumberSettingChange();">
        <label for="å•†å“åã«ç®¡ç†ç•ªå·é…ç½®" style="font-size: 13px; cursor: pointer; margin: 0;">å•†å“åã«è¡¨ç¤º</label>
      </div>
      <div style="display: flex; align-items: center; gap: 6px;">
        <input type="checkbox" id="èª¬æ˜æ–‡ã«ç®¡ç†ç•ªå·é…ç½®" style="width: 16px; height: 16px; cursor: pointer;" onchange="toggleManagementNumberDescriptionFormat(); if (typeof onManagementNumberSettingChange === 'function') onManagementNumberSettingChange();">
        <label for="èª¬æ˜æ–‡ã«ç®¡ç†ç•ªå·é…ç½®" style="font-size: 13px; cursor: pointer; margin: 0;">èª¬æ˜æ–‡ã«è¡¨ç¤º</label>
      </div>
    </div>

    <!-- å½¢å¼é¸æŠï¼ˆå•†å“åç”¨ï¼‰ -->
    <div id="ç®¡ç†ç•ªå·å½¢å¼é¸æŠ" style="display: none;">
      <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">å•†å“åã§ã®è¡¨ç¤ºå½¢å¼</label>
      <select id="ç®¡ç†ç•ªå·å½¢å¼" style="width: 100%; font-size: 13px; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; background: white; margin-bottom: 8px;" onchange="updateManagementNumberPreview(); if (typeof onManagementNumberSettingChange === 'function') onManagementNumberSettingChange();">
        <option value="ã€ã€‘">ã€AA-1001ã€‘</option>
        <option value="ï¼ˆï¼‰">ï¼ˆAA-1001ï¼‰</option>
        <option value="ã€ã€">ã€AA-1001ã€</option>
        <option value="ã€Œã€">ã€ŒAA-1001ã€</option>
        <option value="ï½œï½œ">ï½œAA-1001ï½œ</option>
        <option value="ï½œ">ï½œAA-1001</option>
        <option value="-">- AA-1001</option>
        <option value="none">AA-1001</option>
      </select>

      <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">é…ç½®ä½ç½®</label>
      <select id="ç®¡ç†ç•ªå·é…ç½®ä½ç½®" style="width: 100%; font-size: 13px; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; background: white;" onchange="updateManagementNumberPreview(); if (typeof onManagementNumberSettingChange === 'function') onManagementNumberSettingChange();">
        <option value="end">å¾Œã‚ï¼ˆNIKEã€AA-1001ã€‘ï¼‰</option>
        <option value="start">å…ˆé ­ï¼ˆã€AA-1001ã€‘NIKEï¼‰</option>
      </select>
    </div>

    <!-- å½¢å¼é¸æŠï¼ˆèª¬æ˜æ–‡ç”¨ï¼‰ -->
    <div id="èª¬æ˜æ–‡ç®¡ç†ç•ªå·å½¢å¼é¸æŠ" style="display: none; margin-top: 12px;">
      <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">èª¬æ˜æ–‡ã§ã®è¡¨ç¤ºå½¢å¼</label>
      <select id="èª¬æ˜æ–‡ç®¡ç†ç•ªå·å½¢å¼" style="width: 100%; font-size: 13px; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; background: white; margin-bottom: 8px;" onchange="updateManagementNumberPreview(); if (typeof onManagementNumberSettingChange === 'function') onManagementNumberSettingChange();">
        <option value="ã€ã€‘">ç®¡ç†ç•ªå·ï¼šã€AA-1001ã€‘</option>
        <option value="ï¼ˆï¼‰">ç®¡ç†ç•ªå·ï¼šï¼ˆAA-1001ï¼‰</option>
        <option value="ã€ã€">ç®¡ç†ç•ªå·ï¼šã€AA-1001ã€</option>
        <option value="ã€Œã€">ç®¡ç†ç•ªå·ï¼šã€ŒAA-1001ã€</option>
        <option value="ï½œï½œ">ç®¡ç†ç•ªå·ï¼šï½œAA-1001ï½œ</option>
        <option value="ï½œ">ç®¡ç†ç•ªå·ï¼šï½œAA-1001</option>
        <option value="-">ç®¡ç†ç•ªå·ï¼š- AA-1001</option>
        <option value="none">ç®¡ç†ç•ªå·ï¼šAA-1001</option>
      </select>

      <label style="font-size: 12px; color: #6b7280; margin-bottom: 4px; display: block;">é…ç½®ä½ç½®</label>
      <select id="èª¬æ˜æ–‡ç®¡ç†ç•ªå·é…ç½®ä½ç½®" style="width: 100%; font-size: 13px; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; background: white;" onchange="updateManagementNumberPreview(); if (typeof onManagementNumberSettingChange === 'function') onManagementNumberSettingChange();">
        <option value="top">å…ˆé ­ï¼ˆãƒ–ãƒ©ãƒ³ãƒ‰åã®ä¸Šï¼‰</option>
        <option value="middle">ä¸­ï¼ˆå•†å“æƒ…å ±ã®ä¸‹ï¼‰</option>
        <option value="bottom">æœ«å°¾ï¼ˆãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã®ä¸‹ï¼‰</option>
      </select>
    </div>

    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠï¼ˆã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå¼ï¼‰ -->
    <div id="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ" style="margin-top: 16px; display: none;">
      <!-- ã‚¿ãƒ–ãƒœã‚¿ãƒ³ -->
      <div style="display: flex; gap: 8px; margin-bottom: 12px;">
        <button id="ã‚¿ãƒ–_å•†å“å" onclick="switchPreviewTab('å•†å“å')" style="flex: 1; padding: 10px; border: 2px solid #3B82F6; background: #3B82F6; color: white; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
          ğŸ“ å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        </button>
        <button id="ã‚¿ãƒ–_èª¬æ˜æ–‡" onclick="switchPreviewTab('èª¬æ˜æ–‡')" style="flex: 1; padding: 10px; border: 2px solid #d1d5db; background: white; color: #6b7280; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
          ğŸ“„ èª¬æ˜æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        </button>
      </div>

      <!-- å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
      <div id="å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼_ã‚»ã‚¯ã‚·ãƒ§ãƒ³" style="padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; display: block;">
        <div id="å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼_ç®¡ç†ç•ªå·" style="font-size: 14px; color: #111827; line-height: 1.6; min-height: 24px; word-break: break-all;">
          NIKE ã‚¨ã‚¢ãƒãƒƒã‚¯ã‚¹
        </div>
        <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">
          â€» å®Ÿéš›ã®å•†å“åã§ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™
        </div>
      </div>

      <!-- èª¬æ˜æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
      <div id="èª¬æ˜æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼_ã‚»ã‚¯ã‚·ãƒ§ãƒ³" style="padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; display: none;">
        <div id="èª¬æ˜æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼_ç®¡ç†ç•ªå·" style="font-size: 13px; color: #111827; line-height: 1.8; min-height: 60px; word-break: break-all; white-space: pre-line;">
ã€å•†å“æƒ…å ±ã€‘
ãƒ–ãƒ©ãƒ³ãƒ‰ï¼šNIKE
ã‚¢ã‚¤ãƒ†ãƒ ï¼šã‚¨ã‚¢ãƒãƒƒã‚¯ã‚¹
ã‚«ãƒ©ãƒ¼ï¼šãƒ–ãƒ©ãƒƒã‚¯
ã‚µã‚¤ã‚ºï¼š27.0cm

ğŸ”¢ ç®¡ç†ç•ªå·ï¼šAA-1001
        </div>
        <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">
          â€» èª¬æ˜æ–‡ã§ã®ç®¡ç†ç•ªå·è¡¨ç¤ºã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="mnbModal" class="mnb-modal">
  <div class="mnb-modal-content">
    <div class="mnb-modal-title" id="mnbModalTitle">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ </div>

    <!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—é¸æŠ -->
    <div class="mnb-form-group">
      <label class="mnb-form-label">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—</label>
      <div class="mnb-type-grid" id="mnbTypeGrid">
        <!-- å‹•çš„ã«ç”Ÿæˆ -->
      </div>
    </div>

    <!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¨­å®šï¼ˆã‚¿ã‚¤ãƒ—ã«ã‚ˆã£ã¦å¤‰ã‚ã‚‹ï¼‰ -->
    <div id="mnbSegmentConfig">
      <!-- å‹•çš„ã«ç”Ÿæˆ -->
    </div>

    <!-- åŒºåˆ‡ã‚Šæ–‡å­— -->
    <div class="mnb-form-group">
      <label class="mnb-form-label">åŒºåˆ‡ã‚Šæ–‡å­—ï¼ˆã“ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®å¾Œï¼‰</label>
      <select class="mnb-form-select" id="mnbSeparator">
        <option value="-">- (ãƒã‚¤ãƒ•ãƒ³)</option>
        <option value="_">_ (ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢)</option>
        <option value="">ï¼ˆãªã—ï¼‰</option>
        <option value=".">. (ãƒ‰ãƒƒãƒˆ)</option>
        <option value=" ">ã€€(ã‚¹ãƒšãƒ¼ã‚¹)</option>
      </select>
    </div>

    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="mnb-modal-actions">
      <button type="button" class="mnb-modal-btn mnb-modal-btn-secondary" onclick="closeSegmentModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button type="button" class="mnb-modal-btn mnb-modal-btn-primary" onclick="saveSegment()">ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
  // ç®¡ç†ç•ªå·ãƒ“ãƒ«ãƒ€ãƒ¼ã‚·ã‚¹ãƒ†ãƒ 
  const ManagementNumberBuilder = {
    segments: [],
    currentEditingIndex: null,
    selectedType: null,

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—å®šç¾©
    segmentTypes: {
      shelf: {
        icon: 'ğŸ·ï¸',
        name: 'æ£šç•ªå·',
        desc: 'AA, BB ãªã©ã®æ£šç•ªå·',
        fields: [
          {
            id: 'format',
            label: 'æ£šç•ªå·å½¢å¼',
            type: 'select',
            options: [
              { value: 'AA', label: 'ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ2æ–‡å­— (AA)' },
              { value: 'A', label: 'ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ1æ–‡å­— (A)' },
              { value: '01', label: 'æ•°å­—2æ¡ (01)' },
              { value: '001', label: 'æ•°å­—3æ¡ (001)' },
              { value: 'custom', label: 'âœï¸ ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›' }
            ]
          },
          { id: 'code', label: 'æ£šç•ªå·', type: 'text', placeholder: 'AA', conditional: { field: 'format', value: 'custom' } }
        ],
        preview: (config) => {
          if (config.format === 'custom') {
            return config.code || 'AA';
          }
          return config.format || 'AA';
        }
      },
      sequence: {
        icon: 'ğŸ”¢',
        name: 'é€£ç•ª',
        desc: '001, 0001 ãªã©ã®é€£ç•ª',
        fields: [
          {
            id: 'digits',
            label: 'æ¡æ•°',
            type: 'select',
            options: [
              { value: '2', label: '2æ¡ (01)' },
              { value: '3', label: '3æ¡ (001)' },
              { value: '4', label: '4æ¡ (0001)' },
              { value: '5', label: '5æ¡ (00001)' },
              { value: '6', label: '6æ¡ (000001)' }
            ]
          },
          { id: 'start', label: 'é–‹å§‹ç•ªå·', type: 'number', placeholder: '1' }
        ],
        preview: (config) => {
          const num = config.start || 1;
          const digits = parseInt(config.digits) || 3;
          return String(num).padStart(digits, '0');
        }
      },
      category: {
        icon: 'ğŸ“',
        name: 'ã‚«ãƒ†ã‚´ãƒªã‚³ãƒ¼ãƒ‰',
        desc: 'å•†å“ã‚«ãƒ†ã‚´ãƒª (K, O ãªã©)',
        fields: [
          { id: 'code', label: 'ã‚³ãƒ¼ãƒ‰', type: 'text', placeholder: 'K' }
        ],
        preview: (config) => config.code || 'K'
      },
      date: {
        icon: 'ğŸ“…',
        name: 'ç™»éŒ²æ—¥',
        desc: 'æ—¥ä»˜å½¢å¼ã‚’é¸æŠ',
        fields: [
          {
            id: 'format',
            label: 'å½¢å¼',
            type: 'select',
            options: [
              { value: 'YYMMDD', label: 'YYMMDD (241007)' },
              { value: 'YYYYMMDD', label: 'YYYYMMDD (20241007)' },
              { value: 'YYMD', label: 'YYMD (24107)' },
              { value: 'YYMM', label: 'YYMM (2410)' }
            ]
          }
        ],
        preview: (config) => {
          const now = new Date();
          const y = now.getFullYear();
          const m = String(now.getMonth() + 1).padStart(2, '0');
          const d = String(now.getDate()).padStart(2, '0');

          switch(config.format) {
            case 'YYYYMMDD': return `${y}${m}${d}`;
            case 'YYMD': return `${String(y).slice(2)}${parseInt(m)}${parseInt(d)}`;
            case 'YYMM': return `${String(y).slice(2)}${m}`;
            default: return `${String(y).slice(2)}${m}${d}`;
          }
        }
      },
      rank: {
        icon: 'â­',
        name: 'å“è³ªãƒ©ãƒ³ã‚¯',
        desc: 'A, B, C ãªã©ã®ãƒ©ãƒ³ã‚¯',
        fields: [
          { id: 'value', label: 'ãƒ©ãƒ³ã‚¯å€¤', type: 'text', placeholder: 'A' }
        ],
        preview: (config) => config.value || 'A'
      },
      size: {
        icon: 'ğŸ“',
        name: 'ã‚µã‚¤ã‚ºã‚³ãƒ¼ãƒ‰',
        desc: 'S, M, L ãªã©ã®ã‚µã‚¤ã‚º',
        fields: [
          { id: 'code', label: 'ã‚µã‚¤ã‚ºã‚³ãƒ¼ãƒ‰', type: 'text', placeholder: 'M' }
        ],
        preview: (config) => config.code || 'M'
      },
      color: {
        icon: 'ğŸ¨',
        name: 'è‰²ã‚³ãƒ¼ãƒ‰',
        desc: 'DB, R ãªã©ã®è‰²ã‚³ãƒ¼ãƒ‰',
        fields: [
          { id: 'code', label: 'è‰²ã‚³ãƒ¼ãƒ‰', type: 'text', placeholder: 'DB' }
        ],
        preview: (config) => config.code || 'DB'
      },
      custom: {
        icon: 'âœï¸',
        name: 'ã‚«ã‚¹ã‚¿ãƒ å›ºå®šå€¤',
        desc: 'ä»»æ„ã®å›ºå®šæ–‡å­—åˆ—',
        fields: [
          { id: 'value', label: 'å›ºå®šå€¤', type: 'text', placeholder: 'XXX' }
        ],
        preview: (config) => config.value || 'XXX'
      }
    },

    // ãƒ—ãƒªã‚»ãƒƒãƒˆå®šç¾©
    presets: {
      simple: [
        { type: 'sequence', config: { digits: '4', start: '1001' }, separator: '' }
      ],
      shelf: [
        { type: 'shelf', config: { format: 'AA' }, separator: '-' },
        { type: 'sequence', config: { digits: '4', start: '1001' }, separator: '' }
      ],
      category_date: [
        { type: 'category', config: { code: 'K' }, separator: '-' },
        { type: 'date', config: { format: 'YYMMDD' }, separator: '-' },
        { type: 'sequence', config: { digits: '3', start: '1' }, separator: '' }
      ],
      shelf_date: [
        { type: 'shelf', config: { format: 'AA' }, separator: '-' },
        { type: 'date', config: { format: 'YYMMDD' }, separator: '-' },
        { type: 'sequence', config: { digits: '3', start: '1' }, separator: '' }
      ],
      category_rank: [
        { type: 'category', config: { code: 'K' }, separator: '-' },
        { type: 'rank', config: { value: 'A' }, separator: '-' },
        { type: 'sequence', config: { digits: '3', start: '1' }, separator: '' }
      ]
    },

    // åˆæœŸåŒ–
    init() {
      this.renderTypeGrid();
      this.updatePreview();
      this.setupDragAndDrop();
      this.loadSettings();
      this.setupPresetSelector();
    },

    // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼è¨­å®š
    setupPresetSelector() {
      const selector = document.getElementById('mnbPresetSelect');
      if (!selector) return;

      selector.addEventListener('change', (e) => {
        const presetKey = e.target.value;
        if (!presetKey) return;

        const preset = this.presets[presetKey];
        if (!preset) return;

        // æ—¢å­˜ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¦ã€ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é©ç”¨
        if (confirm('ç¾åœ¨ã®è¨­å®šã‚’å‰Šé™¤ã—ã¦ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é©ç”¨ã—ã¾ã™ã‹ï¼Ÿ')) {
          this.segments = JSON.parse(JSON.stringify(preset)); // ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼
          this.renderSegments();
          this.updatePreview();
        } else {
          // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆã¯é¸æŠã‚’æˆ»ã™
          selector.value = '';
        }
      });
    },

    // è¨­å®šã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰èª­ã¿è¾¼ã¿
    loadSettings() {
      if (google && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler((config) => {
            if (config && config.segments && config.segments.length > 0) {
              this.segments = config.segments;
              this.renderSegments();
              this.updatePreview();
              console.log('ç®¡ç†ç•ªå·è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', config.segments.length, 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ');
            }
          })
          .withFailureHandler((error) => {
            console.error('ç®¡ç†ç•ªå·è¨­å®šã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          })
          .getManagementNumberConfig();
      }
    },

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã‚°ãƒªãƒƒãƒ‰ã‚’æç”»
    renderTypeGrid() {
      const grid = document.getElementById('mnbTypeGrid');
      grid.innerHTML = '';

      Object.keys(this.segmentTypes).forEach(typeKey => {
        const type = this.segmentTypes[typeKey];
        const card = document.createElement('div');
        card.className = 'mnb-type-card';
        card.onclick = () => this.selectType(typeKey);
        card.innerHTML = `
          <div class="mnb-type-card-icon">${type.icon}</div>
          <div class="mnb-type-card-name">${type.name}</div>
          <div class="mnb-type-card-desc">${type.desc}</div>
        `;
        grid.appendChild(card);
      });
    },

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—é¸æŠ
    selectType(typeKey) {
      this.selectedType = typeKey;

      // ã‚«ãƒ¼ãƒ‰ã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
      document.querySelectorAll('.mnb-type-card').forEach((card, i) => {
        card.classList.remove('selected');
      });
      const typeKeys = Object.keys(this.segmentTypes);
      const index = typeKeys.indexOf(typeKey);
      document.querySelectorAll('.mnb-type-card')[index].classList.add('selected');

      // è¨­å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤º
      this.renderConfigFields(typeKey);
    },

    // è¨­å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æç”»
    renderConfigFields(typeKey) {
      const type = this.segmentTypes[typeKey];
      const container = document.getElementById('mnbSegmentConfig');
      container.innerHTML = '';

      type.fields.forEach(field => {
        const group = document.createElement('div');
        group.className = 'mnb-form-group';

        // æ¡ä»¶ä»˜ããƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§éè¡¨ç¤º
        if (field.conditional) {
          group.style.display = 'none';
          group.setAttribute('data-conditional-field', field.conditional.field);
          group.setAttribute('data-conditional-value', field.conditional.value);
        }

        const label = document.createElement('label');
        label.className = 'mnb-form-label';
        label.textContent = field.label;
        group.appendChild(label);

        if (field.type === 'select') {
          const select = document.createElement('select');
          select.className = 'mnb-form-select';
          select.id = `mnbField_${field.id}`;

          field.options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.value;
            option.textContent = opt.label;
            select.appendChild(option);
          });

          // ã‚»ãƒ¬ã‚¯ãƒˆå¤‰æ›´æ™‚ã«æ¡ä»¶ä»˜ããƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
          select.addEventListener('change', () => {
            this.updateConditionalFields(field.id, select.value);
          });

          group.appendChild(select);
        } else {
          const input = document.createElement('input');
          input.className = 'mnb-form-input';
          input.type = field.type;
          input.id = `mnbField_${field.id}`;
          input.placeholder = field.placeholder || '';
          group.appendChild(input);
        }

        container.appendChild(group);
      });
    },

    // æ¡ä»¶ä»˜ããƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°
    updateConditionalFields(fieldId, value) {
      const container = document.getElementById('mnbSegmentConfig');
      const conditionalFields = container.querySelectorAll(`[data-conditional-field="${fieldId}"]`);

      conditionalFields.forEach(field => {
        const conditionalValue = field.getAttribute('data-conditional-value');
        if (value === conditionalValue) {
          field.style.display = 'block';
        } else {
          field.style.display = 'none';
        }
      });
    },

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
    addSegment(segment) {
      this.segments.push(segment);
      this.renderSegments();
      this.updatePreview();
    },

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
    updateSegment(index, segment) {
      this.segments[index] = segment;
      this.renderSegments();
      this.updatePreview();
    },

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
    removeSegment(index) {
      this.segments.splice(index, 1);
      this.renderSegments();
      this.updatePreview();
    },

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ç§»å‹•
    moveSegment(fromIndex, toIndex) {
      const segment = this.segments.splice(fromIndex, 1)[0];
      this.segments.splice(toIndex, 0, segment);
      this.renderSegments();
      this.updatePreview();
    },

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆã‚’æç”»
    renderSegments() {
      const container = document.getElementById('mnbSegmentsList');

      if (this.segments.length === 0) {
        container.innerHTML = `
          <div class="mnb-segments-empty">
            ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„<br>
            <small>ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆã§ãã¾ã™</small>
          </div>
        `;
        return;
      }

      container.innerHTML = '';

      this.segments.forEach((segment, index) => {
        const type = this.segmentTypes[segment.type];
        const block = document.createElement('div');
        block.className = 'mnb-segment';
        block.draggable = true;
        block.setAttribute('data-index', index);

        const preview = type.preview(segment.config);

        block.innerHTML = `
          <div class="mnb-segment-header">
            <div class="mnb-segment-drag-handle">â‹®â‹®</div>
            <div class="mnb-segment-icon">${type.icon}</div>
            <div class="mnb-segment-type">${type.name}</div>
          </div>
          <div class="mnb-segment-value">${preview}</div>
          <div class="mnb-segment-controls">
            <button class="mnb-segment-btn" onclick="event.stopPropagation(); ManagementNumberBuilder.editSegment(${index})">ç·¨é›†</button>
            <button class="mnb-segment-btn delete" onclick="event.stopPropagation(); ManagementNumberBuilder.removeSegment(${index})">å‰Šé™¤</button>
          </div>
        `;

        container.appendChild(block);
      });
    },

    // ç®¡ç†ç•ªå·ã‚’ç”Ÿæˆï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ï¼‰
    generatePreview() {
      if (this.segments.length === 0) {
        return '';
      }

      let preview = '';
      this.segments.forEach((segment, index) => {
        const type = this.segmentTypes[segment.type];
        const value = type.preview(segment.config);

        preview += value;
        if (index < this.segments.length - 1 && segment.separator) {
          preview += segment.separator;
        }
      });

      return preview;
    },

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
    updatePreview() {
      // å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
      if (typeof updateManagementNumberPreview === 'function') {
        updateManagementNumberPreview();
      }
    },

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ç·¨é›†
    editSegment(index) {
      this.currentEditingIndex = index;
      const segment = this.segments[index];

      document.getElementById('mnbModalTitle').textContent = 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ç·¨é›†';
      this.selectType(segment.type);

      // è¨­å®šå€¤ã‚’å¾©å…ƒ
      const type = this.segmentTypes[segment.type];
      type.fields.forEach(field => {
        const elem = document.getElementById(`mnbField_${field.id}`);
        if (elem) {
          elem.value = segment.config[field.id] || '';

          // ã‚»ãƒ¬ã‚¯ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å ´åˆã€æ¡ä»¶ä»˜ããƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚è¡¨ç¤ºæ›´æ–°
          if (field.type === 'select') {
            this.updateConditionalFields(field.id, elem.value);
          }
        }
      });

      document.getElementById('mnbSeparator').value = segment.separator || '-';
      document.getElementById('mnbModal').classList.add('active');
    },

    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®šï¼ˆSortable.jsä½¿ç”¨ï¼‰
    // ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ï¼ˆã‚¹ãƒãƒ›ï¼‰ã§ã‚‚å‹•ä½œã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸ
    setupDragAndDrop() {
      const container = document.getElementById('mnbSegmentsList');

      // Sortable.jsã‚’ä½¿ç”¨ã—ã¦ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚’åˆæœŸåŒ–
      // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã«è‡ªå‹•å¯¾å¿œ
      Sortable.create(container, {
        animation: 150,                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é€Ÿåº¦ï¼ˆãƒŸãƒªç§’ï¼‰
        handle: '.mnb-drag-handle',        // â‹®â‹® ã‚¢ã‚¤ã‚³ãƒ³ã®ã¿ã§ãƒ‰ãƒ©ãƒƒã‚°
        ghostClass: 'sortable-ghost',      // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦ç´ ã«é©ç”¨ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹
        chosenClass: 'sortable-chosen',    // é¸æŠä¸­ã®è¦ç´ ã«é©ç”¨ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹
        dragClass: 'sortable-drag',        // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦ç´ ã«é©ç”¨ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹
        onEnd: (evt) => {
          // ãƒ‰ãƒ­ãƒƒãƒ—å¾Œã«ä¸¦ã³é †ã‚’æ›´æ–°
          const oldIndex = evt.oldIndex;
          const newIndex = evt.newIndex;

          if (oldIndex !== newIndex) {
            this.moveSegment(oldIndex, newIndex);
          }
        }
      });
    },

    // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    getData() {
      return {
        segments: this.segments
      };
    },

    // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
    setData(data) {
      this.segments = data.segments || [];
      this.renderSegments();
      this.updatePreview();
    }
  };

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
  function openAddSegmentModal() {
    ManagementNumberBuilder.currentEditingIndex = null;
    ManagementNumberBuilder.selectedType = null;
    document.getElementById('mnbModalTitle').textContent = 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ';
    document.getElementById('mnbSegmentConfig').innerHTML = '';
    document.getElementById('mnbSeparator').value = '-';

    // ã‚«ãƒ¼ãƒ‰ã®é¸æŠçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
    document.querySelectorAll('.mnb-type-card').forEach(card => {
      card.classList.remove('selected');
    });

    document.getElementById('mnbModal').classList.add('active');
  }

  function closeSegmentModal() {
    document.getElementById('mnbModal').classList.remove('active');
  }

  function saveSegment() {
    if (!ManagementNumberBuilder.selectedType) {
      alert('ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    const type = ManagementNumberBuilder.segmentTypes[ManagementNumberBuilder.selectedType];
    const config = {};

    // è¨­å®šå€¤ã‚’åé›†
    type.fields.forEach(field => {
      const elem = document.getElementById(`mnbField_${field.id}`);
      if (elem) {
        config[field.id] = elem.value;
      }
    });

    const segment = {
      type: ManagementNumberBuilder.selectedType,
      config: config,
      separator: document.getElementById('mnbSeparator').value
    };

    if (ManagementNumberBuilder.currentEditingIndex !== null) {
      ManagementNumberBuilder.updateSegment(ManagementNumberBuilder.currentEditingIndex, segment);
    } else {
      ManagementNumberBuilder.addSegment(segment);
    }

    closeSegmentModal();
  }

  /**
   * ç®¡ç†ç•ªå·å½¢å¼é¸æŠã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
   */
  function toggleManagementNumberFormat() {
    const checkbox = document.getElementById('å•†å“åã«ç®¡ç†ç•ªå·é…ç½®');
    const formatSection = document.getElementById('ç®¡ç†ç•ªå·å½¢å¼é¸æŠ');

    if (checkbox && formatSection) {
      formatSection.style.display = checkbox.checked ? 'block' : 'none';
      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
      updateManagementNumberPreview();
    }
  }

  /**
   * èª¬æ˜æ–‡ç®¡ç†ç•ªå·å½¢å¼é¸æŠã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
   */
  function toggleManagementNumberDescriptionFormat() {
    const checkbox = document.getElementById('èª¬æ˜æ–‡ã«ç®¡ç†ç•ªå·é…ç½®');
    const formatSection = document.getElementById('èª¬æ˜æ–‡ç®¡ç†ç•ªå·å½¢å¼é¸æŠ');

    if (checkbox && formatSection) {
      formatSection.style.display = checkbox.checked ? 'block' : 'none';
      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
      updateManagementNumberPreview();
    }
  }

  /**
   * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆ
   */
  function switchPreviewTab(tabName) {
    const titleTab = document.getElementById('ã‚¿ãƒ–_å•†å“å');
    const descTab = document.getElementById('ã‚¿ãƒ–_èª¬æ˜æ–‡');
    const titleSection = document.getElementById('å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼_ã‚»ã‚¯ã‚·ãƒ§ãƒ³');
    const descSection = document.getElementById('èª¬æ˜æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼_ã‚»ã‚¯ã‚·ãƒ§ãƒ³');

    if (tabName === 'å•†å“å') {
      // å•†å“åã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      titleTab.style.background = '#3B82F6';
      titleTab.style.color = 'white';
      titleTab.style.borderColor = '#3B82F6';

      descTab.style.background = 'white';
      descTab.style.color = '#6b7280';
      descTab.style.borderColor = '#d1d5db';

      titleSection.style.display = 'block';
      descSection.style.display = 'none';
    } else if (tabName === 'èª¬æ˜æ–‡') {
      // èª¬æ˜æ–‡ã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      descTab.style.background = '#3B82F6';
      descTab.style.color = 'white';
      descTab.style.borderColor = '#3B82F6';

      titleTab.style.background = 'white';
      titleTab.style.color = '#6b7280';
      titleTab.style.borderColor = '#d1d5db';

      titleSection.style.display = 'none';
      descSection.style.display = 'block';
    }
  }

  /**
   * ç®¡ç†ç•ªå·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°ï¼ˆå•†å“åã§ã®è¡¨ç¤ºã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰
   */
  function updateManagementNumberPreview() {
    console.log('ğŸ“ updateManagementNumberPreview å‘¼ã³å‡ºã—');

    const titleCheckbox = document.getElementById('å•†å“åã«ç®¡ç†ç•ªå·é…ç½®');
    const descCheckbox = document.getElementById('èª¬æ˜æ–‡ã«ç®¡ç†ç•ªå·é…ç½®');
    const formatSelect = document.getElementById('ç®¡ç†ç•ªå·å½¢å¼');
    const positionSelect = document.getElementById('ç®¡ç†ç•ªå·é…ç½®ä½ç½®');
    const titlePreviewElement = document.getElementById('å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼_ç®¡ç†ç•ªå·');
    const descPreviewElement = document.getElementById('èª¬æ˜æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼_ç®¡ç†ç•ªå·');
    const previewContainer = document.getElementById('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ');
    const titleTab = document.getElementById('ã‚¿ãƒ–_å•†å“å');
    const descTab = document.getElementById('ã‚¿ãƒ–_èª¬æ˜æ–‡');

    console.log('è¦ç´ ç¢ºèª:', {
      titleCheckbox: titleCheckbox ? 'OK' : 'NG',
      descCheckbox: descCheckbox ? 'OK' : 'NG',
      formatSelect: formatSelect ? 'OK' : 'NG',
      positionSelect: positionSelect ? 'OK' : 'NG',
      titlePreviewElement: titlePreviewElement ? 'OK' : 'NG',
      descPreviewElement: descPreviewElement ? 'OK' : 'NG'
    });

    if (!titlePreviewElement || !descPreviewElement) {
      console.warn('âš ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    // ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚­ã‚¹ãƒˆ
    const sampleText = 'NIKE ã‚¨ã‚¢ãƒãƒƒã‚¯ã‚¹';

    console.log('ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹çŠ¶æ…‹:', {
      title: titleCheckbox ? titleCheckbox.checked : 'null',
      desc: descCheckbox ? descCheckbox.checked : 'null'
    });

    const titleChecked = titleCheckbox && titleCheckbox.checked;
    const descChecked = descCheckbox && descCheckbox.checked;

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ¶å¾¡
    if (previewContainer) {
      if (!titleChecked && !descChecked) {
        // ä¸¡æ–¹OFFã®å ´åˆã¯å…¨ä½“ã‚’éè¡¨ç¤º
        previewContainer.style.display = 'none';
        console.log('âœ… ä¸¡æ–¹OFF - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼éè¡¨ç¤º');
        if (typeof saveManagementNumberPlacementSettings === 'function') {
          saveManagementNumberPlacementSettings();
        }
        return;
      } else {
        // ã©ã¡ã‚‰ã‹ONã®å ´åˆã¯è¡¨ç¤º
        previewContainer.style.display = 'block';
      }
    }

    // ã‚¿ãƒ–ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ¶å¾¡
    if (titleTab && descTab) {
      if (titleChecked && descChecked) {
        // ä¸¡æ–¹ONã®å ´åˆã¯ã‚¿ãƒ–ã‚’è¡¨ç¤º
        titleTab.style.display = 'block';
        descTab.style.display = 'block';
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å•†å“åã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
        switchPreviewTab('å•†å“å');
      } else if (titleChecked) {
        // å•†å“åã®ã¿ONã®å ´åˆã¯ã‚¿ãƒ–ã‚’éè¡¨ç¤ºã€å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã¿è¡¨ç¤º
        titleTab.style.display = 'none';
        descTab.style.display = 'none';
        document.getElementById('å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼_ã‚»ã‚¯ã‚·ãƒ§ãƒ³').style.display = 'block';
        document.getElementById('èª¬æ˜æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼_ã‚»ã‚¯ã‚·ãƒ§ãƒ³').style.display = 'none';
      } else if (descChecked) {
        // èª¬æ˜æ–‡ã®ã¿ONã®å ´åˆã¯ã‚¿ãƒ–ã‚’éè¡¨ç¤ºã€èª¬æ˜æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã¿è¡¨ç¤º
        titleTab.style.display = 'none';
        descTab.style.display = 'none';
        document.getElementById('å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼_ã‚»ã‚¯ã‚·ãƒ§ãƒ³').style.display = 'none';
        document.getElementById('èª¬æ˜æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼_ã‚»ã‚¯ã‚·ãƒ§ãƒ³').style.display = 'block';
      }
    }

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¨­å®šã‹ã‚‰ç®¡ç†ç•ªå·ã‚’ç”Ÿæˆ
    const generatedNumber = ManagementNumberBuilder.generatePreview();
    const sampleNumber = generatedNumber || 'AA-1001';

    console.log('ç”Ÿæˆã•ã‚ŒãŸç®¡ç†ç•ªå·:', sampleNumber);

    // å½¢å¼ã¨é…ç½®ä½ç½®ã‚’å–å¾—
    const format = formatSelect ? formatSelect.value : 'ã€ã€‘';
    const position = positionSelect ? positionSelect.value : 'end';

    console.log('é¸æŠå€¤:', { format, position });

    // ç®¡ç†ç•ªå·ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    let formattedNumber = '';
    switch (format) {
      case 'ã€ã€‘':
        formattedNumber = `ã€${sampleNumber}ã€‘`;
        break;
      case 'ï¼ˆï¼‰':
        formattedNumber = `ï¼ˆ${sampleNumber}ï¼‰`;
        break;
      case 'ã€ã€':
        formattedNumber = `ã€${sampleNumber}ã€`;
        break;
      case 'ã€Œã€':
        formattedNumber = `ã€Œ${sampleNumber}ã€`;
        break;
      case 'ï½œï½œ':
        formattedNumber = `ï½œ${sampleNumber}ï½œ`;
        break;
      case 'ï½œ':
        formattedNumber = `ï½œ${sampleNumber}`;
        break;
      case '-':
        formattedNumber = `- ${sampleNumber}`;
        break;
      case 'none':
        formattedNumber = sampleNumber;
        break;
      default:
        formattedNumber = `ã€${sampleNumber}ã€‘`;
    }

    // ä¸¡ç«¯é–‰ã˜ã¦ã„ã‚‹å ´åˆã¯ã‚¹ãƒšãƒ¼ã‚¹ãªã—ã€ãã‚Œä»¥å¤–ã¯ã‚¹ãƒšãƒ¼ã‚¹ã‚ã‚Š
    const pairs = [
      { start: 'ã€', end: 'ã€‘' },
      { start: 'ã€', end: 'ã€' },
      { start: 'ã€Œ', end: 'ã€' },
      { start: 'ï¼ˆ', end: 'ï¼‰' },
      { start: 'ï½œ', end: 'ï½œ' }
    ];
    const needsSpace = !pairs.some(pair => 
      formattedNumber.startsWith(pair.start) && formattedNumber.endsWith(pair.end)
    );

    // é…ç½®ä½ç½®ã«å¿œã˜ã¦çµåˆ
    let result;
    if (position === 'start') {
      result = needsSpace ? `${formattedNumber} ${sampleText}` : `${formattedNumber}${sampleText}`;
    } else {
      result = needsSpace ? `${sampleText} ${formattedNumber}` : `${sampleText}${formattedNumber}`;
    }

    console.log('âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°:', result);

    // å•†å“åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
    if (titleCheckbox && titleCheckbox.checked) {
      titlePreviewElement.textContent = result;
    }

    // èª¬æ˜æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
    if (descCheckbox && descCheckbox.checked) {
      const descFormatSelect = document.getElementById('èª¬æ˜æ–‡ç®¡ç†ç•ªå·å½¢å¼');
      const descPositionSelect = document.getElementById('èª¬æ˜æ–‡ç®¡ç†ç•ªå·é…ç½®ä½ç½®');
      
      const descFormat = descFormatSelect ? descFormatSelect.value : 'ã€ã€‘';
      const descPosition = descPositionSelect ? descPositionSelect.value : 'bottom';

      // èª¬æ˜æ–‡ç”¨ã®ç®¡ç†ç•ªå·ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆçµµæ–‡å­—ãªã—ï¼‰
      let descFormattedNumber = '';
      switch (descFormat) {
        case 'ã€ã€‘':
          descFormattedNumber = `ç®¡ç†ç•ªå·ï¼šã€${sampleNumber}ã€‘`;
          break;
        case 'ï¼ˆï¼‰':
          descFormattedNumber = `ç®¡ç†ç•ªå·ï¼šï¼ˆ${sampleNumber}ï¼‰`;
          break;
        case 'ã€ã€':
          descFormattedNumber = `ç®¡ç†ç•ªå·ï¼šã€${sampleNumber}ã€`;
          break;
        case 'ã€Œã€':
          descFormattedNumber = `ç®¡ç†ç•ªå·ï¼šã€Œ${sampleNumber}ã€`;
          break;
        case 'ï½œï½œ':
          descFormattedNumber = `ç®¡ç†ç•ªå·ï¼šï½œ${sampleNumber}ï½œ`;
          break;
        case 'ï½œ':
          descFormattedNumber = `ç®¡ç†ç•ªå·ï¼šï½œ${sampleNumber}`;
          break;
        case '-':
          descFormattedNumber = `ç®¡ç†ç•ªå·ï¼š- ${sampleNumber}`;
          break;
        case 'none':
          descFormattedNumber = `ç®¡ç†ç•ªå·ï¼š${sampleNumber}`;
          break;
        default:
          descFormattedNumber = `ç®¡ç†ç•ªå·ï¼šã€${sampleNumber}ã€‘`;
      }

      // é…ç½®ä½ç½®ã«å¿œã˜ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆï¼ˆå®Ÿéš›ã®å•†å“èª¬æ˜ã«è¿‘ã„å½¢å¼ï¼‰
      let descPreview = '';

      // ãƒ–ãƒ©ãƒ³ãƒ‰åãƒ»åŸºæœ¬æƒ…å ±ï¼ˆå…ˆé ­éƒ¨åˆ†ï¼‰
      const brandInfo = `ãƒ–ãƒ©ãƒ³ãƒ‰åï¼šUNIQLOï¼ˆãƒ¦ãƒ‹ã‚¯ãƒ­ï¼‰

ã‚«ãƒ©ãƒ¼ï¼ˆè©³ç´°ï¼‰ï¼šãƒ–ãƒ©ãƒƒã‚¯

ã‚µã‚¤ã‚ºï¼ˆè¡¨è¨˜ï¼‰ï¼šM`;

      // å•†å“æƒ…å ±ï¼ˆä¸­å¤®éƒ¨åˆ†ï¼‰
      const detailInfo = `ã€ã‚µã‚¤ã‚º(å®Ÿå¯¸)ã€‘
è‚©å¹…ï¼š47cm
èº«å¹…ï¼š55cm
è¢–ä¸ˆï¼š62cm
ç€ä¸ˆï¼š68cm

ã€ç´ æã€‘
è¡¨åœ°ï¼šãƒŠã‚¤ãƒ­ãƒ³ 100%
ä¸­ç¶¿ï¼šãƒ€ã‚¦ãƒ³ 90%ã€ãƒ•ã‚§ã‚¶ãƒ¼ 10%

å•†å“çŠ¶æ…‹ï¼ˆè©³ç´°ï¼‰ï¼š
ç›®ç«‹ã£ãŸå‚·ã‚„æ±šã‚Œãªã—ã€‚`;

      // å•†å“èª¬æ˜ãƒ»ãã®ä»–ï¼ˆä¸‹éƒ¨ï¼‰
      const descriptionPart = `ã€UNIQLO ã‚¦ãƒ«ãƒˆãƒ©ãƒ©ã‚¤ãƒˆãƒ€ã‚¦ãƒ³ã‚¸ãƒ£ã‚±ãƒƒãƒˆã€‘

UNIQLOï¼ˆãƒ¦ãƒ‹ã‚¯ãƒ­ï¼‰ã®å®šç•ªäººæ°—ã‚¢ã‚¤ãƒ†ãƒ ã€ã‚¦ãƒ«ãƒˆãƒ©ãƒ©ã‚¤ãƒˆãƒ€ã‚¦ãƒ³ã‚¸ãƒ£ã‚±ãƒƒãƒˆã§ã™ã€‚è»½é‡ã§æŒã¡é‹ã³ã‚‚ã—ã‚„ã™ãã€ç§‹å†¬ã®ã‚¢ã‚¦ã‚¿ãƒ¼ã¨ã—ã¦å¤§æ´»èºã—ã¾ã™ã€‚

ã€ãŠã™ã™ã‚ã‚·ãƒ¼ãƒ³ã€‘
æ™®æ®µä½¿ã„ã¯ã‚‚ã¡ã‚ã‚“ã€æ—…è¡Œã‚„é€šå‹¤ãƒ»é€šå­¦ã«ã‚‚ä¾¿åˆ©ã€‚ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«åç´ã§ãã‚‹ã®ã§ã€ãƒãƒƒã‚°ã«å…¥ã‚Œã¦ãŠãã¨å®‰å¿ƒã§ã™ã€‚`;

      // ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ï¼ˆæœ€ä¸‹éƒ¨ï¼‰- ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‹ã‚‰ç”Ÿæˆ
      let hashtags = '';
      try {
        const hashtagConfig = localStorage.getItem('rebornConfig_hashtag');
        if (hashtagConfig) {
          const config = JSON.parse(hashtagConfig);
          const commonPrefix = config.commonPrefix || '#REBORN_';

          // è¨­å®šã•ã‚ŒãŸãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ç”Ÿæˆï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã«ç°¡ç•¥åŒ–ï¼‰
          const previewTags = [];

          if (config.hashtags && Array.isArray(config.hashtags)) {
            config.hashtags.forEach(tag => {
              if (tag.title === 'å…¨å•†å“') {
                previewTags.push(`${commonPrefix}${tag.suffix || 'å…¨å•†å“'}`);
              } else if (tag.title === 'ãƒ–ãƒ©ãƒ³ãƒ‰') {
                previewTags.push(`${commonPrefix}UNIQLO${tag.suffix || 'ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§'}`);
              } else if (tag.title === 'ã‚«ãƒ†ã‚´ãƒª') {
                previewTags.push(`${commonPrefix}ãƒ¡ãƒ³ã‚ºãƒ»ãƒ¬ãƒ‡ã‚£ãƒ¼ã‚¹${tag.suffix || 'ä¸€è¦§'}`);
              }
            });
          }

          // ã‚¿ã‚°ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚Œã°ãã‚Œã‚’ä½¿ç”¨
          if (previewTags.length > 0) {
            hashtags = previewTags.join('\n');
          } else {
            // æ—§å½¢å¼ã¾ãŸã¯è¨­å®šãªã—ã®å ´åˆ
            hashtags = `${commonPrefix}å…¨å•†å“\n${commonPrefix}UNIQLOã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§\n${commonPrefix}ãƒ¡ãƒ³ã‚ºãƒ»ãƒ¬ãƒ‡ã‚£ãƒ¼ã‚¹ä¸€è¦§`;
          }
        } else {
          // è¨­å®šãŒãªã„å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
          hashtags = `#REBORN_å…¨å•†å“\n#REBORN_UNIQLOã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§\n#REBORN_ãƒ¡ãƒ³ã‚ºãƒ»ãƒ¬ãƒ‡ã‚£ãƒ¼ã‚¹ä¸€è¦§`;
        }
      } catch (e) {
        console.error('ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°è¨­å®šã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        hashtags = `#REBORN_å…¨å•†å“\n#REBORN_UNIQLOã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§\n#REBORN_ãƒ¡ãƒ³ã‚ºãƒ»ãƒ¬ãƒ‡ã‚£ãƒ¼ã‚¹ä¸€è¦§`;
      }

      if (descPosition === 'top') {
        // å…ˆé ­ï¼ˆãƒ–ãƒ©ãƒ³ãƒ‰åã®ä¸Šï¼‰
        descPreview = `${descFormattedNumber}

${brandInfo}

${detailInfo}

${descriptionPart}

${hashtags}`;
      } else if (descPosition === 'middle') {
        // ä¸­ï¼ˆå•†å“æƒ…å ±ã®ä¸‹ï¼‰
        descPreview = `${brandInfo}

${detailInfo}

${descFormattedNumber}

${descriptionPart}

${hashtags}`;
      } else {
        // æœ«å°¾ï¼ˆãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã®ä¸‹ã€ä¸€ç•ªç›®ç«‹ãŸãªã„ä½ç½®ï¼‰
        descPreview = `${brandInfo}

${detailInfo}

${descriptionPart}

${hashtags}

${descFormattedNumber}`;
      }

      descPreviewElement.textContent = descPreview;
    }

    // è¨­å®šã‚’ä¿å­˜
    if (typeof saveManagementNumberPlacementSettings === 'function') {
      saveManagementNumberPlacementSettings();
    }
  }



  /**
   * ãƒ’ãƒ³ãƒˆã®é–‹é–‰ã‚’åˆ‡ã‚Šæ›¿ãˆ
   */
  function toggleHint(id) {
    const content = document.getElementById(id + '-content');
    const icon = document.getElementById(id + '-icon');

    if (content.style.display === 'none') {
      content.style.display = 'block';
      icon.textContent = 'â–¼';
    } else {
      content.style.display = 'none';
      icon.textContent = 'â–¶';
    }
  }

  /**
   * ãƒ’ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®é–‹é–‰ã‚’åˆ‡ã‚Šæ›¿ãˆï¼ˆç›¸äº’æ’ä»–çš„ï¼‰
   * @param {string} prefix - ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼ˆä¾‹: 'mnb'ï¼‰
   * @param {string} section - ã‚»ã‚¯ã‚·ãƒ§ãƒ³åï¼ˆ'overview' ã¾ãŸã¯ 'hint'ï¼‰
   */
  function toggleHintSection(prefix, section) {
    const sections = ['overview', 'hint'];
    const currentContent = document.getElementById(prefix + '-' + section + '-content');
    const currentIcon = document.getElementById(prefix + '-' + section + '-icon');

    if (!currentContent || !currentIcon) return;

    const isCurrentlyOpen = currentContent.style.display !== 'none';

    // ã™ã¹ã¦ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‰ã˜ã‚‹
    sections.forEach(s => {
      const content = document.getElementById(prefix + '-' + s + '-content');
      const icon = document.getElementById(prefix + '-' + s + '-icon');
      if (content && icon) {
        content.style.display = 'none';
        icon.textContent = 'â–¶';
      }
    });

    // ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒé–‰ã˜ã¦ã„ãŸå ´åˆã®ã¿é–‹ã
    if (!isCurrentlyOpen) {
      currentContent.style.display = 'block';
      currentIcon.textContent = 'â–¼';
    }
  }

  /**
   * ç®¡ç†ç•ªå·è¨­å®šã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢
   */
  function clearManagementNumberSettings() {
    if (!confirm('ç®¡ç†ç•ªå·è¨­å®šã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ»ã™ã¹ã¦ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã™\nãƒ»ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠã‚‚ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™')) {
      return;
    }

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé…åˆ—ã‚’ã‚¯ãƒªã‚¢
    MANAGEMENT_NUMBER_CONFIG.segments = [];

    // ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
    const presetSelect = document.getElementById('mnbPresetSelect');
    if (presetSelect) {
      presetSelect.value = '';
    }

    // UIã‚’å†æç”»
    renderSegments();
    updatePreview();

    alert('ç®¡ç†ç•ªå·è¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚\nå¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã€Œè¨­å®šã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
  }

  // åˆæœŸåŒ–
  if (typeof window !== 'undefined') {
    window.ManagementNumberBuilder = ManagementNumberBuilder;

    // DOMContentLoadedã§åˆæœŸåŒ–
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        ManagementNumberBuilder.init();
      });
    } else {
      ManagementNumberBuilder.init();
    }
  }
</script>
