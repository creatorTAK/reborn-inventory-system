<!-- ç®¡ç†ç•ªå·ãƒ“ãƒ«ãƒ€ãƒ¼ - ãƒ¬ã‚´ãƒ–ãƒ­ãƒƒã‚¯å¼ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ§‹ç¯‰ã‚·ã‚¹ãƒ†ãƒ  -->
<style>
  .mnb-container {
    padding: 0;
    background: white;
    border-radius: 8px;
  }

  .mnb-title {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 16px;
    color: #212529;
  }

  /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆ */
  .mnb-segments {
    background: white;
    border: none;
    border-radius: 8px;
    padding: 0;
    min-height: 100px;
    margin-bottom: 16px;
  }

  .mnb-segments.drag-over {
    background: #e3f2fd;
    border-color: #2196f3;
  }

  .mnb-segments-empty {
    text-align: center;
    color: #9ca3af;
    padding: 24px 16px;
    font-size: 13px;
    line-height: 1.6;
  }

  /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒ–ãƒ­ãƒƒã‚¯ */
  .mnb-segment {
    background: white;
    border: 1px solid #e5e7eb;
    color: #1f2937;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 10px;
    cursor: move;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    transition: all 0.2s;
  }

  .mnb-segment:hover {
    border-color: #3b82f6;
    box-shadow: 0 2px 6px rgba(59,130,246,0.15);
  }

  .mnb-segment.dragging {
    opacity: 0.5;
  }

  .mnb-segment-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
  }

  .mnb-segment-drag-handle {
    font-size: 16px;
    color: #9ca3af;
    cursor: grab;
  }

  .mnb-segment-drag-handle:active {
    cursor: grabbing;
  }

  .mnb-segment-icon {
    font-size: 22px;
  }

  .mnb-segment-type {
    flex: 1;
    font-size: 12px;
    font-weight: 500;
    color: #6b7280;
  }

  .mnb-segment-value {
    font-size: 18px;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 10px;
  }

  .mnb-segment-controls {
    display: flex;
    gap: 8px;
  }

  .mnb-segment-btn {
    flex: 1;
    background: white;
    border: 1px solid #d1d5db;
    color: #374151;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
    font-weight: 500;
  }

  .mnb-segment-btn:hover {
    background: #f9fafb;
    border-color: #9ca3af;
  }

  .mnb-segment-btn.delete {
    color: #ef4444;
    border-color: #fecaca;
  }

  .mnb-segment-btn.delete:hover {
    background: #fef2f2;
    border-color: #ef4444;
  }

  /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¿½åŠ ãƒœã‚¿ãƒ³ */
  .mnb-add-segment {
    background: white;
    color: #3b82f6;
    border: 2px dashed #3b82f6;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    width: 100%;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-bottom: 16px;
  }

  .mnb-add-segment:hover {
    background: #eff6ff;
  }

  /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
  .mnb-preview {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 12px;
  }

  .mnb-preview-label {
    font-size: 10px;
    color: #6b7280;
    margin-bottom: 2px;
  }

  .mnb-preview-value {
    padding: 6px 10px;
    background: #eff6ff;
    border: 1px solid #bfdbfe;
    border-radius: 6px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    font-size: 11px;
    color: #1e40af;
    font-weight: 500;
  }

  .mnb-preview-parts {
    margin-top: 12px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .mnb-preview-part {
    background: #f3f4f6;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 11px;
    color: #6b7280;
    font-weight: 500;
  }

  /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .mnb-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    align-items: center;
    justify-content: center;
  }

  .mnb-modal.active {
    display: flex;
  }

  .mnb-modal-content {
    background: white;
    border-radius: 12px;
    padding: 20px;
    max-width: 600px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
  }

  .mnb-modal-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 16px;
    color: #1f2937;
  }

  .mnb-form-group {
    margin-bottom: 12px;
  }

  .mnb-form-label {
    display: block;
    font-size: 12px;
    font-weight: 500;
    color: #374151;
    margin-bottom: 4px;
  }

  .mnb-form-input,
  .mnb-form-select {
    width: 100%;
    padding: 6px 10px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 13px;
  }

  .mnb-form-input:focus,
  .mnb-form-select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .mnb-modal-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
  }

  .mnb-modal-btn {
    flex: 1;
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
  }

  .mnb-modal-btn-primary {
    background: #3b82f6;
    color: white;
  }

  .mnb-modal-btn-primary:hover {
    background: #2563eb;
  }

  .mnb-modal-btn-secondary {
    background: #e5e7eb;
    color: #374151;
  }

  .mnb-modal-btn-secondary:hover {
    background: #d1d5db;
  }

  /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—é¸æŠ */
  .mnb-type-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-bottom: 12px;
  }

  .mnb-type-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    padding: 10px 12px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }

  .mnb-type-card:hover {
    border-color: #3b82f6;
    background: #f0f9ff;
  }

  .mnb-type-card.selected {
    border-color: #3b82f6;
    background: #dbeafe;
  }

  .mnb-type-card-icon {
    font-size: 30px;
    margin-bottom: 4px;
  }

  .mnb-type-card-name {
    font-size: 13px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 3px;
  }

  .mnb-type-card-desc {
    font-size: 11px;
    color: #6b7280;
    line-height: 1.3;
  }
</style>

<!-- ç®¡ç†ç•ªå·ãƒ“ãƒ«ãƒ€ãƒ¼UI -->
<div class="mnb-container">
  <div class="mnb-title">ğŸ”¢ ç®¡ç†ç•ªå·è¨­å®š</div>

  <!-- ãƒ’ãƒ³ãƒˆ -->
  <div style="font-size: 11px; color: #6b7280; padding: 10px 12px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px; line-height: 1.6;">
    <div style="margin-bottom: 8px;">ğŸ’¡ å•†å“ç™»éŒ²æ™‚ã«è‡ªå‹•ã§ç®¡ç†ç•ªå·ï¼ˆä¾‹: AA-1001ï¼‰ãŒç”Ÿæˆã•ã‚Œã¾ã™</div>
    <div style="color: #3b82f6; font-weight: 600; margin-bottom: 4px;">ğŸ“Œ ä½¿ã„æ–¹:</div>
    <div style="padding-left: 12px;">
      1. ğŸ“‹ ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸æŠ<br>
      2. ğŸ”§ ã€Œ+ ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ã§é …ç›®ã‚’è¿½åŠ ãƒ»ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º<br>
      3. â‹®â‹® ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå·¦å´ã®6ã¤ãƒœã‚¿ãƒ³ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é †ç•ªã‚’ä¸¦ã³æ›¿ãˆ<br>
      4. ã€Œå‰Šé™¤ã€ãƒœã‚¿ãƒ³ã§ä¸è¦ãªã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤<br>
      5. ğŸ—‘ï¸ ã€Œã™ã¹ã¦ã‚¯ãƒªã‚¢ã€ãƒœã‚¿ãƒ³ã§ãƒªã‚»ãƒƒãƒˆï¼ˆå…¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå‰Šé™¤ï¼‰
    </div>
  </div>

  <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠ -->
  <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
    <label style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px; display: block;">
      ğŸ“‹ ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰é¸æŠ
    </label>
    <select id="mnbPresetSelect" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 13px; background: #f9fafb; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.background='white';" onblur="this.style.borderColor='#d1d5db'; this.style.background='#f9fafb';">
      <option value="" style="padding: 8px;">-- ã‚«ã‚¹ã‚¿ãƒ è¨­å®š --</option>
      <option value="simple" style="padding: 8px;">ğŸ”¢ ã‚·ãƒ³ãƒ—ãƒ«é€£ç•ªã€€(ä¾‹: 1001, 1002, 1003...)</option>
      <option value="shelf" style="padding: 8px;">ğŸ“¦ æ£šç•ªå· + é€£ç•ªã€€(ä¾‹: AA-1001, BB-1001...)</option>
      <option value="category_date" style="padding: 8px;">ğŸ“… ã‚«ãƒ†ã‚´ãƒª + æ—¥ä»˜ + é€£ç•ªã€€(ä¾‹: K-251007-001...)</option>
      <option value="shelf_date" style="padding: 8px;">ğŸ—“ï¸ æ£šç•ªå· + æ—¥ä»˜ + é€£ç•ªã€€(ä¾‹: AA-251007-001...)</option>
      <option value="category_rank" style="padding: 8px;">â­ ã‚«ãƒ†ã‚´ãƒª + ãƒ©ãƒ³ã‚¯ + é€£ç•ªã€€(ä¾‹: K-A-001...)</option>
    </select>
  </div>

  <!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆ -->
  <div id="mnbSegmentsList" class="mnb-segments">
    <div class="mnb-segments-empty">
      ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„<br><small style="font-size: 12px;">ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆã§ãã¾ã™</small>
    </div>
  </div>

  <!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¿½åŠ ãƒœã‚¿ãƒ³ -->
  <button type="button" class="mnb-add-segment" onclick="openAddSegmentModal()">
    <span>â•</span>
    <span>ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ </span>
  </button>

  <!-- ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
  <button type="button" onclick="clearManagementNumberSettings()" style="width: 100%; padding: 10px; background: white; border: 2px solid #ef4444; border-radius: 8px; color: #ef4444; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 16px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2';" onmouseout="this.style.background='white';">
    ğŸ—‘ï¸ ã™ã¹ã¦ã‚¯ãƒªã‚¢
  </button>

  <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
  <div class="mnb-preview">
    <div class="mnb-preview-label">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</div>
    <div id="mnbPreviewValue" class="mnb-preview-value">-</div>
    <div id="mnbPreviewParts" class="mnb-preview-parts"></div>
  </div>
</div>

<!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="mnbModal" class="mnb-modal">
  <div class="mnb-modal-content">
    <div class="mnb-modal-title" id="mnbModalTitle">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ </div>

    <!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—é¸æŠ -->
    <div class="mnb-form-group">
      <label class="mnb-form-label">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—</label>
      <div class="mnb-type-grid" id="mnbTypeGrid">
        <!-- å‹•çš„ã«ç”Ÿæˆ -->
      </div>
    </div>

    <!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¨­å®šï¼ˆã‚¿ã‚¤ãƒ—ã«ã‚ˆã£ã¦å¤‰ã‚ã‚‹ï¼‰ -->
    <div id="mnbSegmentConfig">
      <!-- å‹•çš„ã«ç”Ÿæˆ -->
    </div>

    <!-- åŒºåˆ‡ã‚Šæ–‡å­— -->
    <div class="mnb-form-group">
      <label class="mnb-form-label">åŒºåˆ‡ã‚Šæ–‡å­—ï¼ˆã“ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®å¾Œï¼‰</label>
      <select class="mnb-form-select" id="mnbSeparator">
        <option value="-">- (ãƒã‚¤ãƒ•ãƒ³)</option>
        <option value="_">_ (ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢)</option>
        <option value="">ï¼ˆãªã—ï¼‰</option>
        <option value=".">. (ãƒ‰ãƒƒãƒˆ)</option>
        <option value=" ">ã€€(ã‚¹ãƒšãƒ¼ã‚¹)</option>
      </select>
    </div>

    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="mnb-modal-actions">
      <button type="button" class="mnb-modal-btn mnb-modal-btn-secondary" onclick="closeSegmentModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button type="button" class="mnb-modal-btn mnb-modal-btn-primary" onclick="saveSegment()">ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
  // ç®¡ç†ç•ªå·ãƒ“ãƒ«ãƒ€ãƒ¼ã‚·ã‚¹ãƒ†ãƒ 
  const ManagementNumberBuilder = {
    segments: [],
    currentEditingIndex: null,
    selectedType: null,

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—å®šç¾©
    segmentTypes: {
      shelf: {
        icon: 'ğŸ·ï¸',
        name: 'æ£šç•ªå·',
        desc: 'AA, BB ãªã©ã®æ£šç•ªå·',
        fields: [
          {
            id: 'format',
            label: 'æ£šç•ªå·å½¢å¼',
            type: 'select',
            options: [
              { value: 'AA', label: 'ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ2æ–‡å­— (AA)' },
              { value: 'A', label: 'ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ1æ–‡å­— (A)' },
              { value: '01', label: 'æ•°å­—2æ¡ (01)' },
              { value: '001', label: 'æ•°å­—3æ¡ (001)' },
              { value: 'custom', label: 'âœï¸ ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›' }
            ]
          },
          { id: 'code', label: 'æ£šç•ªå·', type: 'text', placeholder: 'AA', conditional: { field: 'format', value: 'custom' } }
        ],
        preview: (config) => {
          if (config.format === 'custom') {
            return config.code || 'AA';
          }
          return config.format || 'AA';
        }
      },
      sequence: {
        icon: 'ğŸ”¢',
        name: 'é€£ç•ª',
        desc: '001, 0001 ãªã©ã®é€£ç•ª',
        fields: [
          {
            id: 'digits',
            label: 'æ¡æ•°',
            type: 'select',
            options: [
              { value: '2', label: '2æ¡ (01)' },
              { value: '3', label: '3æ¡ (001)' },
              { value: '4', label: '4æ¡ (0001)' },
              { value: '5', label: '5æ¡ (00001)' },
              { value: '6', label: '6æ¡ (000001)' }
            ]
          },
          { id: 'start', label: 'é–‹å§‹ç•ªå·', type: 'number', placeholder: '1' }
        ],
        preview: (config) => {
          const num = config.start || 1;
          const digits = parseInt(config.digits) || 3;
          return String(num).padStart(digits, '0');
        }
      },
      category: {
        icon: 'ğŸ“',
        name: 'ã‚«ãƒ†ã‚´ãƒªã‚³ãƒ¼ãƒ‰',
        desc: 'å•†å“ã‚«ãƒ†ã‚´ãƒª (K, O ãªã©)',
        fields: [
          { id: 'code', label: 'ã‚³ãƒ¼ãƒ‰', type: 'text', placeholder: 'K' }
        ],
        preview: (config) => config.code || 'K'
      },
      date: {
        icon: 'ğŸ“…',
        name: 'ç™»éŒ²æ—¥',
        desc: 'æ—¥ä»˜å½¢å¼ã‚’é¸æŠ',
        fields: [
          {
            id: 'format',
            label: 'å½¢å¼',
            type: 'select',
            options: [
              { value: 'YYMMDD', label: 'YYMMDD (241007)' },
              { value: 'YYYYMMDD', label: 'YYYYMMDD (20241007)' },
              { value: 'YYMD', label: 'YYMD (24107)' },
              { value: 'YYMM', label: 'YYMM (2410)' }
            ]
          }
        ],
        preview: (config) => {
          const now = new Date();
          const y = now.getFullYear();
          const m = String(now.getMonth() + 1).padStart(2, '0');
          const d = String(now.getDate()).padStart(2, '0');

          switch(config.format) {
            case 'YYYYMMDD': return `${y}${m}${d}`;
            case 'YYMD': return `${String(y).slice(2)}${parseInt(m)}${parseInt(d)}`;
            case 'YYMM': return `${String(y).slice(2)}${m}`;
            default: return `${String(y).slice(2)}${m}${d}`;
          }
        }
      },
      rank: {
        icon: 'â­',
        name: 'å“è³ªãƒ©ãƒ³ã‚¯',
        desc: 'A, B, C ãªã©ã®ãƒ©ãƒ³ã‚¯',
        fields: [
          { id: 'value', label: 'ãƒ©ãƒ³ã‚¯å€¤', type: 'text', placeholder: 'A' }
        ],
        preview: (config) => config.value || 'A'
      },
      size: {
        icon: 'ğŸ“',
        name: 'ã‚µã‚¤ã‚ºã‚³ãƒ¼ãƒ‰',
        desc: 'S, M, L ãªã©ã®ã‚µã‚¤ã‚º',
        fields: [
          { id: 'code', label: 'ã‚µã‚¤ã‚ºã‚³ãƒ¼ãƒ‰', type: 'text', placeholder: 'M' }
        ],
        preview: (config) => config.code || 'M'
      },
      color: {
        icon: 'ğŸ¨',
        name: 'è‰²ã‚³ãƒ¼ãƒ‰',
        desc: 'DB, R ãªã©ã®è‰²ã‚³ãƒ¼ãƒ‰',
        fields: [
          { id: 'code', label: 'è‰²ã‚³ãƒ¼ãƒ‰', type: 'text', placeholder: 'DB' }
        ],
        preview: (config) => config.code || 'DB'
      },
      custom: {
        icon: 'âœï¸',
        name: 'ã‚«ã‚¹ã‚¿ãƒ å›ºå®šå€¤',
        desc: 'ä»»æ„ã®å›ºå®šæ–‡å­—åˆ—',
        fields: [
          { id: 'value', label: 'å›ºå®šå€¤', type: 'text', placeholder: 'XXX' }
        ],
        preview: (config) => config.value || 'XXX'
      }
    },

    // ãƒ—ãƒªã‚»ãƒƒãƒˆå®šç¾©
    presets: {
      simple: [
        { type: 'sequence', config: { digits: '4', start: '1001' }, separator: '' }
      ],
      shelf: [
        { type: 'shelf', config: { format: 'AA' }, separator: '-' },
        { type: 'sequence', config: { digits: '4', start: '1001' }, separator: '' }
      ],
      category_date: [
        { type: 'category', config: { code: 'K' }, separator: '-' },
        { type: 'date', config: { format: 'YYMMDD' }, separator: '-' },
        { type: 'sequence', config: { digits: '3', start: '1' }, separator: '' }
      ],
      shelf_date: [
        { type: 'shelf', config: { format: 'AA' }, separator: '-' },
        { type: 'date', config: { format: 'YYMMDD' }, separator: '-' },
        { type: 'sequence', config: { digits: '3', start: '1' }, separator: '' }
      ],
      category_rank: [
        { type: 'category', config: { code: 'K' }, separator: '-' },
        { type: 'rank', config: { value: 'A' }, separator: '-' },
        { type: 'sequence', config: { digits: '3', start: '1' }, separator: '' }
      ]
    },

    // åˆæœŸåŒ–
    init() {
      this.renderTypeGrid();
      this.updatePreview();
      this.setupDragAndDrop();
      this.loadSettings();
      this.setupPresetSelector();
    },

    // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼è¨­å®š
    setupPresetSelector() {
      const selector = document.getElementById('mnbPresetSelect');
      if (!selector) return;

      selector.addEventListener('change', (e) => {
        const presetKey = e.target.value;
        if (!presetKey) return;

        const preset = this.presets[presetKey];
        if (!preset) return;

        // æ—¢å­˜ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¦ã€ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é©ç”¨
        if (confirm('ç¾åœ¨ã®è¨­å®šã‚’å‰Šé™¤ã—ã¦ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é©ç”¨ã—ã¾ã™ã‹ï¼Ÿ')) {
          this.segments = JSON.parse(JSON.stringify(preset)); // ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼
          this.renderSegments();
          this.updatePreview();
        } else {
          // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆã¯é¸æŠã‚’æˆ»ã™
          selector.value = '';
        }
      });
    },

    // è¨­å®šã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰èª­ã¿è¾¼ã¿
    loadSettings() {
      if (google && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler((config) => {
            if (config && config.segments && config.segments.length > 0) {
              this.segments = config.segments;
              this.renderSegments();
              this.updatePreview();
              console.log('ç®¡ç†ç•ªå·è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', config.segments.length, 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ');
            }
          })
          .withFailureHandler((error) => {
            console.error('ç®¡ç†ç•ªå·è¨­å®šã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          })
          .getManagementNumberConfig();
      }
    },

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã‚°ãƒªãƒƒãƒ‰ã‚’æç”»
    renderTypeGrid() {
      const grid = document.getElementById('mnbTypeGrid');
      grid.innerHTML = '';

      Object.keys(this.segmentTypes).forEach(typeKey => {
        const type = this.segmentTypes[typeKey];
        const card = document.createElement('div');
        card.className = 'mnb-type-card';
        card.onclick = () => this.selectType(typeKey);
        card.innerHTML = `
          <div class="mnb-type-card-icon">${type.icon}</div>
          <div class="mnb-type-card-name">${type.name}</div>
          <div class="mnb-type-card-desc">${type.desc}</div>
        `;
        grid.appendChild(card);
      });
    },

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—é¸æŠ
    selectType(typeKey) {
      this.selectedType = typeKey;

      // ã‚«ãƒ¼ãƒ‰ã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
      document.querySelectorAll('.mnb-type-card').forEach((card, i) => {
        card.classList.remove('selected');
      });
      const typeKeys = Object.keys(this.segmentTypes);
      const index = typeKeys.indexOf(typeKey);
      document.querySelectorAll('.mnb-type-card')[index].classList.add('selected');

      // è¨­å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤º
      this.renderConfigFields(typeKey);
    },

    // è¨­å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æç”»
    renderConfigFields(typeKey) {
      const type = this.segmentTypes[typeKey];
      const container = document.getElementById('mnbSegmentConfig');
      container.innerHTML = '';

      type.fields.forEach(field => {
        const group = document.createElement('div');
        group.className = 'mnb-form-group';

        // æ¡ä»¶ä»˜ããƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§éè¡¨ç¤º
        if (field.conditional) {
          group.style.display = 'none';
          group.setAttribute('data-conditional-field', field.conditional.field);
          group.setAttribute('data-conditional-value', field.conditional.value);
        }

        const label = document.createElement('label');
        label.className = 'mnb-form-label';
        label.textContent = field.label;
        group.appendChild(label);

        if (field.type === 'select') {
          const select = document.createElement('select');
          select.className = 'mnb-form-select';
          select.id = `mnbField_${field.id}`;

          field.options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.value;
            option.textContent = opt.label;
            select.appendChild(option);
          });

          // ã‚»ãƒ¬ã‚¯ãƒˆå¤‰æ›´æ™‚ã«æ¡ä»¶ä»˜ããƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
          select.addEventListener('change', () => {
            this.updateConditionalFields(field.id, select.value);
          });

          group.appendChild(select);
        } else {
          const input = document.createElement('input');
          input.className = 'mnb-form-input';
          input.type = field.type;
          input.id = `mnbField_${field.id}`;
          input.placeholder = field.placeholder || '';
          group.appendChild(input);
        }

        container.appendChild(group);
      });
    },

    // æ¡ä»¶ä»˜ããƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°
    updateConditionalFields(fieldId, value) {
      const container = document.getElementById('mnbSegmentConfig');
      const conditionalFields = container.querySelectorAll(`[data-conditional-field="${fieldId}"]`);

      conditionalFields.forEach(field => {
        const conditionalValue = field.getAttribute('data-conditional-value');
        if (value === conditionalValue) {
          field.style.display = 'block';
        } else {
          field.style.display = 'none';
        }
      });
    },

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
    addSegment(segment) {
      this.segments.push(segment);
      this.renderSegments();
      this.updatePreview();
    },

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
    updateSegment(index, segment) {
      this.segments[index] = segment;
      this.renderSegments();
      this.updatePreview();
    },

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
    removeSegment(index) {
      this.segments.splice(index, 1);
      this.renderSegments();
      this.updatePreview();
    },

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ç§»å‹•
    moveSegment(fromIndex, toIndex) {
      const segment = this.segments.splice(fromIndex, 1)[0];
      this.segments.splice(toIndex, 0, segment);
      this.renderSegments();
      this.updatePreview();
    },

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆã‚’æç”»
    renderSegments() {
      const container = document.getElementById('mnbSegmentsList');

      if (this.segments.length === 0) {
        container.innerHTML = `
          <div class="mnb-segments-empty">
            ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„<br>
            <small>ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆã§ãã¾ã™</small>
          </div>
        `;
        return;
      }

      container.innerHTML = '';

      this.segments.forEach((segment, index) => {
        const type = this.segmentTypes[segment.type];
        const block = document.createElement('div');
        block.className = 'mnb-segment';
        block.draggable = true;
        block.setAttribute('data-index', index);

        const preview = type.preview(segment.config);

        block.innerHTML = `
          <div class="mnb-segment-header">
            <div class="mnb-segment-drag-handle">â‹®â‹®</div>
            <div class="mnb-segment-icon">${type.icon}</div>
            <div class="mnb-segment-type">${type.name}</div>
          </div>
          <div class="mnb-segment-value">${preview}</div>
          <div class="mnb-segment-controls">
            <button class="mnb-segment-btn" onclick="event.stopPropagation(); ManagementNumberBuilder.editSegment(${index})">ç·¨é›†</button>
            <button class="mnb-segment-btn delete" onclick="event.stopPropagation(); ManagementNumberBuilder.removeSegment(${index})">å‰Šé™¤</button>
          </div>
        `;

        container.appendChild(block);
      });
    },

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
    updatePreview() {
      if (this.segments.length === 0) {
        document.getElementById('mnbPreviewValue').textContent = '-';
        document.getElementById('mnbPreviewParts').innerHTML = '';
        return;
      }

      let preview = '';
      const parts = [];

      this.segments.forEach((segment, index) => {
        const type = this.segmentTypes[segment.type];
        const value = type.preview(segment.config);

        preview += value;
        if (index < this.segments.length - 1 && segment.separator) {
          preview += segment.separator;
        }

        parts.push(`<div class="mnb-preview-part">${type.icon} ${value}</div>`);
      });

      document.getElementById('mnbPreviewValue').textContent = preview;
      document.getElementById('mnbPreviewParts').innerHTML = parts.join('');
    },

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ç·¨é›†
    editSegment(index) {
      this.currentEditingIndex = index;
      const segment = this.segments[index];

      document.getElementById('mnbModalTitle').textContent = 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ç·¨é›†';
      this.selectType(segment.type);

      // è¨­å®šå€¤ã‚’å¾©å…ƒ
      const type = this.segmentTypes[segment.type];
      type.fields.forEach(field => {
        const elem = document.getElementById(`mnbField_${field.id}`);
        if (elem) {
          elem.value = segment.config[field.id] || '';

          // ã‚»ãƒ¬ã‚¯ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å ´åˆã€æ¡ä»¶ä»˜ããƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚è¡¨ç¤ºæ›´æ–°
          if (field.type === 'select') {
            this.updateConditionalFields(field.id, elem.value);
          }
        }
      });

      document.getElementById('mnbSeparator').value = segment.separator || '-';
      document.getElementById('mnbModal').classList.add('active');
    },

    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š
    setupDragAndDrop() {
      const container = document.getElementById('mnbSegmentsList');

      let draggedElement = null;
      let draggedIndex = null;

      container.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('mnb-segment')) {
          draggedElement = e.target;
          draggedIndex = parseInt(e.target.getAttribute('data-index'));
          e.target.classList.add('dragging');
        }
      });

      container.addEventListener('dragend', (e) => {
        if (e.target.classList.contains('mnb-segment')) {
          e.target.classList.remove('dragging');
        }
      });

      container.addEventListener('dragover', (e) => {
        e.preventDefault();
        const afterElement = this.getDragAfterElement(container, e.clientY);

        if (afterElement == null) {
          container.appendChild(draggedElement);
        } else {
          container.insertBefore(draggedElement, afterElement);
        }
      });

      container.addEventListener('drop', (e) => {
        e.preventDefault();

        const blocks = Array.from(container.querySelectorAll('.mnb-segment'));
        const newIndex = blocks.indexOf(draggedElement);

        if (draggedIndex !== null && newIndex !== -1 && draggedIndex !== newIndex) {
          this.moveSegment(draggedIndex, newIndex);
        }
      });
    },

    getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.mnb-segment:not(.dragging)')];

      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;

        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    },

    // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    getData() {
      return {
        segments: this.segments
      };
    },

    // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
    setData(data) {
      this.segments = data.segments || [];
      this.renderSegments();
      this.updatePreview();
    }
  };

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
  function openAddSegmentModal() {
    ManagementNumberBuilder.currentEditingIndex = null;
    ManagementNumberBuilder.selectedType = null;
    document.getElementById('mnbModalTitle').textContent = 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ';
    document.getElementById('mnbSegmentConfig').innerHTML = '';
    document.getElementById('mnbSeparator').value = '-';

    // ã‚«ãƒ¼ãƒ‰ã®é¸æŠçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
    document.querySelectorAll('.mnb-type-card').forEach(card => {
      card.classList.remove('selected');
    });

    document.getElementById('mnbModal').classList.add('active');
  }

  function closeSegmentModal() {
    document.getElementById('mnbModal').classList.remove('active');
  }

  function saveSegment() {
    if (!ManagementNumberBuilder.selectedType) {
      alert('ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    const type = ManagementNumberBuilder.segmentTypes[ManagementNumberBuilder.selectedType];
    const config = {};

    // è¨­å®šå€¤ã‚’åé›†
    type.fields.forEach(field => {
      const elem = document.getElementById(`mnbField_${field.id}`);
      if (elem) {
        config[field.id] = elem.value;
      }
    });

    const segment = {
      type: ManagementNumberBuilder.selectedType,
      config: config,
      separator: document.getElementById('mnbSeparator').value
    };

    if (ManagementNumberBuilder.currentEditingIndex !== null) {
      ManagementNumberBuilder.updateSegment(ManagementNumberBuilder.currentEditingIndex, segment);
    } else {
      ManagementNumberBuilder.addSegment(segment);
    }

    closeSegmentModal();
  }

  /**
   * ç®¡ç†ç•ªå·è¨­å®šã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢
   */
  function clearManagementNumberSettings() {
    if (!confirm('ç®¡ç†ç•ªå·è¨­å®šã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ»ã™ã¹ã¦ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã™\nãƒ»ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠã‚‚ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™')) {
      return;
    }

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé…åˆ—ã‚’ã‚¯ãƒªã‚¢
    MANAGEMENT_NUMBER_CONFIG.segments = [];

    // ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
    const presetSelect = document.getElementById('mnbPresetSelect');
    if (presetSelect) {
      presetSelect.value = '';
    }

    // UIã‚’å†æç”»
    renderSegments();
    updatePreview();

    alert('ç®¡ç†ç•ªå·è¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚\nå¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã€Œè¨­å®šã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
  }

  // åˆæœŸåŒ–
  if (typeof window !== 'undefined') {
    window.ManagementNumberBuilder = ManagementNumberBuilder;

    // DOMContentLoadedã§åˆæœŸåŒ–
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        ManagementNumberBuilder.init();
      });
    } else {
      ManagementNumberBuilder.init();
    }
  }
</script>
