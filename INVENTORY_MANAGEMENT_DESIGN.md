# 在庫管理システム 設計書

**作成日**: 2025-10-24
**Phase**: Phase 1（在庫管理基本機能）
**ステータス**: 設計完了、実装準備中

---

## 📋 目次

1. [概要](#概要)
2. [スプレッドシート構造分析](#スプレッドシート構造分析)
3. [ステータスライフサイクル設計](#ステータスライフサイクル設計)
4. [複数プラットフォーム対応](#複数プラットフォーム対応)
5. [商品編集機能要件](#商品編集機能要件)
6. [Phase 1実装スコープ](#phase-1実装スコープ)
7. [Phase 2以降の拡張計画](#phase-2以降の拡張計画)

---

## 概要

### 目的

在庫管理システムは、商品の登録から販売までのライフサイクル全体を管理し、以下を実現します：

- **在庫状況の可視化**: 商品がどのステータスにあるか一目で把握
- **効率的な検索**: ブランド、カテゴリ、ステータス等で絞り込み
- **商品編集・複製**: メルカリ再出品、類似商品登録を効率化
- **将来の拡張**: 複数プラットフォーム対応、売上管理との連携

### Phase 1のゴール

**4つのメイン機能**:
1. ✅ 在庫を検索できる
2. ✅ 在庫を編集できる（出品前商品 + 商品複製機能）
3. ✅ 在庫状況を把握できる（ステータス別集計）
4. ✅ アラートが届く（Phase 2以降で本格実装、Phase 1では基盤のみ）

---

## スプレッドシート構造分析

### シート情報

- **シート名**: `在庫/売上管理表`
- **総列数**: 109列
- **データ行数**: 74行（ヘッダー除く）

### 列構造（109列の詳細）

#### 基本情報（14列）
| 列番号 | 列名 | 説明 | 重要度 |
|-------|------|------|-------|
| 1 | 担当者 | 商品担当者 | ★★★ |
| 2 | 管理番号 | 一意識別子 | ★★★ |
| 3 | 商品名(タイトル) | メルカリ等での表示名 | ★★★ |
| 4 | 文字数 | タイトル文字数 | ★ |
| 5 | 大分類 | メンズ/レディース等 | ★★★ |
| 6 | 中分類 | ジャケット・アウター等 | ★★★ |
| 7 | 小分類 | ダウンジャケット等 | ★★★ |
| 8 | 細分類1 | さらに細かい分類 | ★★ |
| 9 | 細分類2 | さらに細かい分類 | ★★ |
| 12 | ブランド(英語) | UNIQLO等 | ★★★ |
| 13 | ブランド(カナ) | ユニクロ等 | ★★ |
| 14 | アイテム名 | ダウンジャケット等 | ★★★ |

#### セールスワード・キーワード（13列）
| 列番号 | 列名 | 説明 |
|-------|------|------|
| 10 | セールスワード(カテゴリ) | 訴求カテゴリ |
| 11 | セールスワード | 新品、限定等 |
| 15 | 柄(種類) | 無地、ストライプ等 |
| 16-23 | 生地・素材・質感系 ～ 年代・テイスト・スタイル | 詳細な商品特徴 |

#### カラー・素材・サイズ（43列）
| 列番号 | 列名 | 説明 |
|-------|------|------|
| 24-32 | カラー/配色/トーン ～ 丈 | 商品詳細 |
| 33 | 生産国 | 製造国 |
| 34 | 商品詳細（年代/製/ポイント） | 詳しい説明文 |
| 35-37 | サイズ、表記サイズ、サイズ(詳細) | サイズ情報 |
| 38-39 | 商品の状態、商品状態(詳細) | コンディション |
| 40-42 | カラー(選択)、カラー(詳細)、汚れ・破れ・臭いなど | カラー・状態詳細 |
| 43-57 | 素材(箇所) ～ 素材(％) | 素材詳細（複数箇所対応） |
| 58-65 | 肩幅 ～ 股下 | 実寸サイズ |

#### 配送情報（4列）
| 列番号 | 列名 | 説明 |
|-------|------|------|
| 66 | 配送料の負担 | 送料込み等 |
| 67 | 配送の方法 | ゆうゆうメルカリ便等 |
| 68 | 発送元の地域 | 岡山県等 |
| 69 | 発送までの日数 | 1~2日で発送等 |

#### 販売タイプ・仕入・出品・販売情報（10列）
| 列番号 | 列名 | 説明 | 重要度 |
|-------|------|------|-------|
| 70 | 販売タイプ | 価格を設定する等 | ★★ |
| 71 | 仕入日 | 仕入れた日付 | ★★★ |
| 72 | 仕入先 | その他、ネット等 | ★★★ |
| 73 | 仕入金額 | 仕入れ価格 | ★★★ |
| 74 | 出品日 | プラットフォームに掲載した日 | ★★★ |
| 75 | 出品先 | メルカリ、ラクマ等 | ★★★ |
| 76 | 出品金額 | 出品価格 | ★★★ |
| 77 | 販売日 | 売れた日付 | ★★★ |
| 78 | 販売先 | メルカリ等 | ★★★ |
| 79 | 販売金額 | 売れた価格 | ★★★ |

#### 手数料・送料・梱包費（15列）
| 列番号 | 列名 | 説明 | Phase 1 |
|-------|------|------|---------|
| 80 | 手数料率 | 0.1（10%）等 | システム計算 |
| 81 | 決済手数料 | 決済手数料 | システム計算 |
| 82 | 手数料 | 販売手数料 | システム計算 |
| 83-84 | 発送方法1、発送方法2 | 配送方法 | 入力 |
| 85 | 送料 | 配送料金 | システム計算 |
| 86-91 | 梱包資材1～3、梱包費1～3 | 梱包詳細 | 入力 |
| 92 | 梱包費合計 | 梱包費の合計 | システム計算 |

#### 利益・在庫日数（3列）
| 列番号 | 列名 | 説明 | Phase 1 |
|-------|------|------|---------|
| 93 | 利益金額 | 販売金額 - (手数料 + 送料 + 梱包費 + 仕入金額) | システム計算 |
| 94 | 利益率 | 利益金額 / 販売金額 | システム計算 |
| 95 | 在庫日数 | 仕入日 ～ 販売日の日数 | システム計算 |

#### システム管理（14列）
| 列番号 | 列名 | 説明 | 重要度 |
|-------|------|------|-------|
| 96 | 登録者 | 商品を登録したユーザー | ★★★ |
| 97 | 登録日時 | 登録タイムスタンプ | ★★★ |
| 98 | 最終更新者 | 最後に編集したユーザー | ★★★ |
| 99 | 更新日時 | 更新タイムスタンプ | ★★★ |
| 100-102 | 画像URL1～3 | Cloudflare R2の画像URL | ★★★ |
| 103 | AI生成履歴 | Geminiによる生成履歴 | ★★ |
| 104 | メルカリURL | 出品ページURL | ★★ |
| 105 | 競合価格履歴 | 価格調査履歴 | ★ |
| 106 | AIタグ | AI生成タグ | ★★ |
| 107 | JSON_データ | 構造化データ保存 | ★★★ |
| 108 | Agent分析結果 | Agent SDK分析（Phase 3以降） | ★ |
| 109 | ステータス | 登録済み、出品中、販売済み等 | ★★★ |

### Phase 1での列の扱い

#### そのまま使用する列（約40列）
- 管理番号、商品名、ブランド、アイテム名、大分類、中分類、小分類
- サイズ、カラー(選択)
- 仕入日、仕入先、仕入金額
- 出品日、出品先、出品金額
- 販売日、販売先、販売金額
- 利益金額、利益率、在庫日数
- 登録者、登録日時、最終更新者、更新日時
- 画像URL1～3
- ステータス

#### Phase 2でJSON化する列（約60列）
- セールスワード詳細
- 商品詳細（素材、サイズ詳細等）
- 配送詳細
- 梱包費詳細
- 複数プラットフォーム情報

**重要**: Phase 1では列構造を変更せず、全109列をそのまま使用します。

---

## ステータスライフサイクル設計

### ステータス定義

| ステータス | 自動/手動 | トリガー | 説明 |
|----------|---------|---------|------|
| **登録済み** | 自動 | 商品登録フォーム送信時 | 商品データは登録されたが、まだ出品準備が完了していない |
| **出品準備中** | 自動 | 画像3枚以上アップロード完了時 | 出品に必要な情報が揃った状態 |
| **出品中** | 自動 | 「出品日」入力時 | プラットフォームに掲載中 |
| **販売済み** | 自動 | 「販売日」入力時 | 売れた商品 |
| **取り下げ** | 手動 | ユーザー操作 | 出品を取り下げた商品（再出品可能） |

### ステータス遷移図

```
┌─────────┐
│商品登録  │
└────┬────┘
     │ 自動
     ↓
┌──────────┐
│登録済み   │
└────┬─────┘
     │ 自動（画像3枚以上）
     ↓
┌──────────┐
│出品準備中 │
└────┬─────┘
     │ 自動（出品日入力）
     ↓
┌──────────┐     手動
│出品中     │←──────┐
└────┬─────┘       │
     │ 自動（販売日入力） │
     ↓               │
┌──────────┐       │
│販売済み   │       │
└──────────┘       │
                    │
     ┌──────────┐   │
     │取り下げ   │───┘
     └──────────┘
        ↑ 手動
        │
     （出品中から）
```

### Phase 1での実装

**自動変更のみ**:
- 商品登録時 → 「登録済み」
- 画像3枚以上アップロード → 「出品準備中」（Phase 2で実装）
- 出品日入力時 → 「出品中」
- 販売日入力時 → 「販売済み」

**手動変更**:
- 全ステータス間の手動変更を許可（ドロップダウン選択）
- 特に「出品中」→「取り下げ」、「取り下げ」→「出品準備中」が重要

---

## 複数プラットフォーム対応

### Phase 1: 単一プラットフォーム

**現在の列構造をそのまま使用**:
- 75列「出品先」: 単一値（例: メルカリ）
- 78列「販売先」: 単一値（例: メルカリ）

### Phase 2以降: 複数プラットフォーム（JSON方式）

**107列「JSON_データ」を活用**:

```json
{
  "platform_listings": {
    "mercari": {
      "status": "出品中",
      "url": "https://jp.mercari.com/item/xxx",
      "price": 2980,
      "published_at": "2024-12-05",
      "views": 120,
      "likes": 5
    },
    "rakuma": {
      "status": "出品中",
      "url": "https://fril.jp/shop/xxx",
      "price": 3200,
      "published_at": "2024-12-06",
      "views": 45,
      "likes": 2
    },
    "yahoo_auction": {
      "status": "出品準備中",
      "url": null,
      "price": 3500,
      "published_at": null
    }
  }
}
```

**メリット**:
- プラットフォームごとの価格、ステータス、URL、統計を管理
- 列構造の変更不要
- 柔軟な拡張が可能

**UI設計（Phase 2）**:
```
┌─────────────────────────────┐
│  商品: AA-1001              │
├─────────────────────────────┤
│  出品先管理                  │
│                             │
│  [メルカリ] 出品中           │
│    価格: 2,980円 | 👁120 ♡5 │
│    [編集] [削除]             │
│                             │
│  [ラクマ] 出品中             │
│    価格: 3,200円 | 👁45 ♡2  │
│    [編集] [削除]             │
│                             │
│  [+ プラットフォーム追加]     │
└─────────────────────────────┘
```

---

## 商品編集機能要件

### ユースケース分析

#### 高需要（Phase 1実装）

**1. 出品前の商品編集**
- **対象**: ステータスが「登録済み」「出品準備中」の商品
- **理由**: プラットフォームに出品していないため、REBORN内で編集するしかない
- **機能**: 商品登録フォームと同じUIで全項目編集可能

**2. 商品複製機能**
- **用途**:
  - メルカリ再出品（削除→複製→再出品で表示順位UP）
  - 類似商品の効率登録（同じブランドのTシャツ×10色）
  - 過去の売れた商品と同じフォーマットで新商品登録
- **機能**:
  - 「複製」ボタン → 管理番号だけ新規採番、他は全コピー → 修正して保存
  - 複製後、ステータスを「登録済み」にリセット
  - 出品日、販売日をクリア

**3. ステータス変更**
- **用途**:
  - 「出品中」→「取り下げ」（プラットフォームでは削除、REBORN内では記録保持）
  - 「取り下げ」→「出品準備中」（再出品準備）
- **重要**: プラットフォームのステータスとREBORN内部のステータスは別物

**4. 画像差し替え**
- **対象**: 全商品
- **用途**: より良い写真が撮れた時

#### 中需要（Phase 2以降）

**5. 複数プラットフォーム一括編集**
- メルカリ、ラクマ、ヤフオクに同時出品している商品の価格を一括変更

**6. 一括価格変更**
- セール時に複数商品の価格を10%オフなど

**7. チーム運用時の編集権限管理**
- メンバーAはステータス変更不可、メンバーBは全編集可能など

#### 低需要（実装不要）

**8. 出品後の商品詳細編集**
- 理由: プラットフォームで直接編集した方が早い
- 例外: 複数プラットフォーム出品時は必要（Phase 2）

---

## Phase 1実装スコープ

### 実装する機能

#### 1. 商品複製機能（最優先）

**UI**:
```
┌─────────────────────────┐
│ 在庫一覧                │
│ AA-1001 UNIQLOダウン    │ [複製] [削除]
│ AA-1002 GU セーター      │ [複製] [削除]
└─────────────────────────┘
```

**処理フロー**:
```javascript
1. 既存データを全コピー
2. 管理番号のみ新規採番（AA-1003）
3. ステータスを「登録済み」にリセット
4. 出品日、販売日、販売金額をクリア
5. 登録者、登録日時を新規設定
6. 商品登録フォームを開く（データ入力済み）
7. ユーザーが微調整して保存
```

#### 2. 出品前商品の編集

**対象**: ステータスが「登録済み」「出品準備中」の商品のみ
**UI**: 商品登録フォームと同じ
**制限**: 「出品中」「販売済み」は編集不可（Phase 2で対応）

#### 3. ステータス手動変更

**対象**: 全商品
**UI**: ドロップダウンで選択
- 登録済み
- 出品準備中
- 出品中
- 販売済み
- 取り下げ

#### 4. 画像差し替え

**対象**: 全商品
**UI**: 画像アップロード画面で差し替え可能

#### 5. 在庫検索・絞り込み

**検索条件**:
- ステータス（複数選択可）
- ブランド
- 大分類、中分類、小分類
- サイズ
- カラー
- 仕入日範囲
- 出品日範囲
- 販売日範囲
- 管理番号（部分一致）
- 商品名（部分一致）

**表示**:
- 一覧表示（カード形式）
- ページネーション（50件/ページ）
- ソート機能（登録日時、出品日、販売日、利益金額）

#### 6. 在庫状況ダッシュボード

**表示項目**:
- ステータス別件数
  - 登録済み: XX件
  - 出品準備中: XX件
  - 出品中: XX件
  - 販売済み: XX件
  - 取り下げ: XX件
- 総在庫金額（仕入金額合計）
- 総出品金額
- 総販売金額
- 総利益金額
- 平均在庫日数

### 実装しない機能（Phase 2以降）

- 出品後商品の全項目編集（プラットフォームで編集してもらう）
- 複数プラットフォーム管理
- 一括価格変更
- チーム権限管理
- 高度なアラート機能

---

## Phase 2以降の拡張計画

### Phase 2: 複数プラットフォーム対応

**実装内容**:
1. JSON方式での複数プラットフォーム管理
2. プラットフォームごとのステータス、価格、URL管理
3. 出品後商品の編集機能（プラットフォーム別）
4. 一括価格変更機能

**列整理**:
1. バックアップを取る
2. JSON移行スクリプトを作成
3. テスト環境で検証
4. 本番環境に適用
5. 不要な列を非表示化（削除はしない）

### Phase 3: 売上管理統合

**実装内容**:
1. 在庫管理と売上管理の完全連携
2. ダッシュボード強化（グラフ、チャート）
3. レポート自動生成
4. 予測分析（在庫回転率、利益予測）

### Phase 4: チーム管理・SaaS化

**実装内容**:
1. チーム権限管理
2. タスク管理統合
3. プッシュ通知フル活用
4. API連携（メルカリ、ラクマ等）

---

## 関連ドキュメント

- **[REBORN_INVENTORY_CLAUDE.md](REBORN_INVENTORY_CLAUDE.md)** - プロジェクト全体概要
- **[REBORN_ROADMAP.md](REBORN_ROADMAP.md)** - 開発ロードマップ
- **[docs/issues.md](docs/issues.md)** - 未完了Issue一覧
- **[docs/TDD_POLICY.md](docs/TDD_POLICY.md)** - TDD運用ルール

---

**最終更新**: 2025-10-24
**次のステップ**: Phase 1実装開始
