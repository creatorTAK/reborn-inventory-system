<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ¼ãƒ  ãƒãƒ£ãƒƒãƒˆ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      overflow: hidden;
    }
    .header {
      background: rgba(255, 255, 255, 0.95);
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-title {
      font-size: 18px;
      font-weight: 600;
      color: #2d3748;
    }
    .user-info {
      font-size: 14px;
      color: #718096;
    }
    .create-room-button {
      background: #667eea;
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      margin: 16px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .create-room-button:active {
      transform: scale(0.98);
      box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
    }
    .rooms-container {
      height: calc(100vh - 120px);
      overflow-y: auto;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.9);
      margin: 0 16px 16px 16px;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    .room-item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      gap: 12px;
      align-items: center;
      position: relative;
    }
    .room-item:active {
      transform: scale(0.98);
      background: #f7fafc;
    }
    .room-icon {
      font-size: 32px;
      flex-shrink: 0;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      color: white;
    }
    .room-content {
      flex: 1;
      min-width: 0;
    }
    .room-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .room-name {
      font-size: 16px;
      font-weight: 600;
      color: #2d3748;
    }
    .room-time {
      font-size: 12px;
      color: #a0aec0;
    }
    .room-preview {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .room-last-message {
      font-size: 14px;
      color: #718096;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
    }
    .unread-badge {
      background: #ef4444;
      color: white;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 12px;
      font-weight: 600;
      min-width: 20px;
      text-align: center;
      margin-left: 8px;
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #718096;
    }
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }
    .empty-state-text {
      font-size: 16px;
      margin-bottom: 8px;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #718096;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-title">ğŸ’¬ ãƒãƒ¼ãƒ  ãƒãƒ£ãƒƒãƒˆ</div>
    <div class="user-info" id="userInfo">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

  <button class="create-room-button" id="createRoomButton" onclick="createRoom()">
    â• æ–°ã—ã„ãƒ«ãƒ¼ãƒ ä½œæˆ
  </button>

  <div class="rooms-container" id="roomsContainer">
    <div class="loading">ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, query, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebaseè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjwwtCorUZQ",
      authDomain: "reborn-chat.firebaseapp.com",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    // FirebaseåˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    console.log('[Firestore] åˆæœŸåŒ–å®Œäº†');

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function getQueryParam(key) {
      try {
        return new URLSearchParams(location.search).get(key) || '';
      } catch(e) {
        return '';
      }
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let currentUserName = '';

    // GASãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ã‚’JavaScriptå¤‰æ•°ã«å¤‰æ›
    const isPWAFlag        = <?= JSON.stringify(!!isPWA) ?>;
    const pwaUserNameParam = <?= JSON.stringify(typeof pwaUserName !== 'undefined' ? pwaUserName : "") ?>;
    const gasUserNameParam = <?= JSON.stringify(typeof gasUserName !== 'undefined' ? gasUserName : "") ?>;
    const pwaParentOriginParam = <?= JSON.stringify(typeof pwaParentOrigin !== 'undefined' ? pwaParentOrigin : "") ?>;
    const pwaPmTokenParam = <?= JSON.stringify(typeof pwaPmToken !== 'undefined' ? pwaPmToken : "") ?>;

    // parentOrigin ã¨ pmToken ã‚’è¨­å®šï¼ˆURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ â†’ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•° â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®å„ªå…ˆé †ï¼‰
    const parentOrigin = getQueryParam('parentOrigin') || pwaParentOriginParam || 'https://www.reborn-inventory.com';
    const pmToken = getQueryParam('pmToken') || pwaPmTokenParam || '';

    // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
    const isEmbedded = (window.top !== window);
    const looksLikePWA = isEmbedded && pwaUserNameParam !== "";
    const isPWA = isPWAFlag || looksLikePWA;
    const isGAS = !isPWA;

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[Rooms List] åˆæœŸåŒ–é–‹å§‹');

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¨­å®š
      if (isGAS) {
        if (gasUserNameParam && gasUserNameParam.trim() !== '') {
          try {
            currentUserName = JSON.parse(gasUserNameParam);
          } catch (e) {
            currentUserName = gasUserNameParam;
          }
          document.getElementById('userInfo').textContent = `ğŸ‘¤ ${currentUserName}`;
          console.log('[GAS] ãƒ¦ãƒ¼ã‚¶ãƒ¼åè‡ªå‹•è¨­å®š:', currentUserName);
        }
      } else {
        try {
          currentUserName = JSON.parse(pwaUserNameParam);
        } catch (e) {
          currentUserName = pwaUserNameParam;
        }
        document.getElementById('userInfo').textContent = `ğŸ‘¤ ${currentUserName}`;
        console.log('[PWA] ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¨­å®š:', currentUserName);
      }

      // ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒ‹ãƒ³ã‚°
      startListening();
    });

    // ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒ‹ãƒ³ã‚°
    function startListening() {
      const q = query(
        collection(db, 'rooms'),
        orderBy('lastMessageAt', 'desc')
      );

      onSnapshot(q, (snapshot) => {
        console.log('[Firestore] ãƒ«ãƒ¼ãƒ æ›´æ–°:', snapshot.size + 'ä»¶');

        const container = document.getElementById('roomsContainer');
        container.innerHTML = '';

        if (snapshot.empty) {
          // ç©ºã®çŠ¶æ…‹
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ’¬</div>
              <div class="empty-state-text">ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</div>
              <div style="font-size: 14px; color: #a0aec0;">ã€Œæ–°ã—ã„ãƒ«ãƒ¼ãƒ ä½œæˆã€ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†</div>
            </div>
          `;
          return;
        }

        snapshot.forEach((doc) => {
          const room = { id: doc.id, ...doc.data() };
          appendRoom(room);
        });
      }, (error) => {
        console.error('[Firestore] ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
        const container = document.getElementById('roomsContainer');
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">âš ï¸</div>
            <div class="empty-state-text">ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>
            <div style="font-size: 14px; color: #a0aec0;">${error.message}</div>
          </div>
        `;
      });
    }

    // ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ã‚’UIã«è¿½åŠ 
    function appendRoom(room) {
      const container = document.getElementById('roomsContainer');

      const item = document.createElement('div');
      item.className = 'room-item';
      item.onclick = () => openRoom(room.id);

      // ã‚¢ã‚¤ã‚³ãƒ³
      const icon = document.createElement('div');
      icon.className = 'room-icon';
      icon.textContent = room.icon || 'ğŸ’¬';

      // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
      const content = document.createElement('div');
      content.className = 'room-content';

      // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒ«ãƒ¼ãƒ å + æ™‚åˆ»ï¼‰
      const header = document.createElement('div');
      header.className = 'room-header';

      const name = document.createElement('div');
      name.className = 'room-name';
      name.textContent = room.name || 'ç„¡é¡Œã®ãƒ«ãƒ¼ãƒ ';

      const time = document.createElement('div');
      time.className = 'room-time';
      if (room.lastMessageAt && room.lastMessageAt.toDate) {
        const date = room.lastMessageAt.toDate();
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) {
          time.textContent = 'ãŸã£ãŸä»Š';
        } else if (diffMins < 60) {
          time.textContent = `${diffMins}åˆ†å‰`;
        } else if (diffHours < 24) {
          time.textContent = `${diffHours}æ™‚é–“å‰`;
        } else if (diffDays < 7) {
          time.textContent = `${diffDays}æ—¥å‰`;
        } else {
          time.textContent = date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
        }
      }

      header.appendChild(name);
      header.appendChild(time);

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ + æœªèª­ãƒãƒƒã‚¸ï¼‰
      const preview = document.createElement('div');
      preview.className = 'room-preview';

      const lastMessage = document.createElement('div');
      lastMessage.className = 'room-last-message';
      if (room.lastMessage) {
        const sender = room.lastMessageBy || '';
        lastMessage.textContent = `${sender}: ${room.lastMessage}`;
      } else {
        lastMessage.textContent = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“';
      }

      preview.appendChild(lastMessage);

      // æœªèª­ãƒãƒƒã‚¸ï¼ˆä»®å®Ÿè£…ã€å¾Œã§å®Ÿè£…ï¼‰
      // TODO: unreadCounts ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰å–å¾—
      const unreadCount = 0; // ä»®
      if (unreadCount > 0) {
        const badge = document.createElement('div');
        badge.className = 'unread-badge';
        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
        preview.appendChild(badge);
      }

      content.appendChild(header);
      content.appendChild(preview);

      item.appendChild(icon);
      item.appendChild(content);

      container.appendChild(item);
    }

    // ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ã‚’é–‹ã
    window.openRoom = function(roomId) {
      console.log('[Rooms List] ãƒ«ãƒ¼ãƒ é¸æŠ:', roomId);

      // ãƒãƒ£ãƒƒãƒˆç”»é¢ã«é·ç§»ï¼ˆroomIdã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æ¸¡ã™ï¼‰
      if (isGAS) {
        // GASç‰ˆ: åŒã˜ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ã
        window.location.href = `<?= ScriptApp.getService().getUrl() ?>?page=chat&roomId=${roomId}`;
      } else {
        // PWAç‰ˆ: window.top.postMessageã§è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«é€ä¿¡
        console.log('[Rooms List] postMessageé€ä¿¡:', {
          page: 'chat',
          roomId: roomId,
          userName: currentUserName,
          parentOrigin: parentOrigin,
          pmToken: pmToken
        });

        window.top.postMessage({
          __reborn: true,
          type: 'navigate',
          page: 'chat',
          roomId: roomId,
          userName: currentUserName || '',
          pmToken: pmToken
        }, parentOrigin);
      }
    };

    // ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ä½œæˆ
    window.createRoom = function() {
      // TODO: ãƒ«ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å®Ÿè£…
      alert('ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ä½œæˆæ©Ÿèƒ½ã¯æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å®Ÿè£…ã—ã¾ã™');
    };
  </script>
</body>
</html>
