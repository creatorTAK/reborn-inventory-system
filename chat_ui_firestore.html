<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      background-color: #f8f9fa;
      display: flex;
      flex-direction: column;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .chat-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      flex-shrink: 0;
      position: relative;
    }
    .chat-header h1 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
      padding-left: 40px; /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ */
    }
    .chat-header .channel-info {
      font-size: 0.875rem;
      opacity: 0.9;
      margin-top: 4px;
      padding-left: 40px; /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ */
    }
    /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆLINEé¢¨ï¼‰ */
    .back-btn {
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: white;
      font-size: 32px;
      padding: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      transition: opacity 0.2s;
      font-weight: 300;
    }
    .back-btn:hover {
      opacity: 0.8;
    }
    .back-btn:active {
      opacity: 0.6;
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background-color: #f8f9fa;
    }

    .message-item {
      margin-bottom: 16px;
      animation: fadeIn 0.3s ease-in;
      display: flex;
      /* iOSã®ãƒ†ã‚­ã‚¹ãƒˆé¸æŠãƒ»ã‚³ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆã‚’ç„¡åŠ¹åŒ– */
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒ³ãƒˆï¼ˆã‚¢ã‚¤ã‚³ãƒ³ + ãƒãƒ–ãƒ« + æ™‚é–“ï¼‰ */
    .message-content {
      display: flex;
      align-items: flex-start;
      max-width: 80%;
      gap: 8px;
    }

    /* è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå³å¯„ã›ãƒ»é’ï¼‰ */
    .message-item-mine {
      justify-content: flex-end;
    }
    .message-item-mine .message-content {
      flex-direction: row;
    }
    .message-item-mine .message-bubble {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 10px 14px;
      border-radius: 18px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    /* ä»–äººã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå·¦å¯„ã›ãƒ»ã‚°ãƒ¬ãƒ¼ï¼‰ */
    .message-item-other {
      justify-content: flex-start;
    }
    .message-item-other .message-content {
      flex-direction: row;
    }
    .message-item-other .message-bubble {
      background-color: white;
      color: #2d3748;
      padding: 10px 14px;
      border-radius: 18px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ–ãƒ« */
    .message-bubble {
      max-width: 100%;
    }

    .message-header {
      display: none; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã¯éè¡¨ç¤º */
    }

    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆLINEé¢¨ï¼‰ */
    .user-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #e2e8f0;
      flex-shrink: 0;
    }
    .user-icon-placeholder {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 16px;
      border: 2px solid #e2e8f0;
      flex-shrink: 0;
    }

    .message-sender {
      display: none; /* LINEé¢¨ï¼šåå‰ã‚’éè¡¨ç¤º */
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆãƒãƒ–ãƒ« + æ™‚é–“ï¼‰ */
    .message-wrapper {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 2px;
    }
    .message-item-mine .message-wrapper {
      align-items: flex-end;
    }

    .message-time {
      font-size: 0.7rem;
      color: #718096;
      opacity: 0.8;
      padding: 0 4px;
    }
    .message-text {
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.5;
      /* ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã‚’å®Œå…¨ã«ç„¡åŠ¹åŒ– */
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    .delete-button {
      background: none;
      border: none;
      color: #ef4444;
      cursor: pointer;
      font-size: 0.875rem;
      padding: 4px 8px;
      margin-left: 8px;
      opacity: 0.6;
      transition: opacity 0.2s;
    }
    .delete-button:hover {
      opacity: 1;
    }

    /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
    .input-container {
      padding: 16px;
      background-color: white;
      border-top: 1px solid #e2e8f0;
      flex-shrink: 0;
    }
    .input-wrapper {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    #messageInput {
      flex: 1;
      padding: 12px;
      border: 1px solid #cbd5e0;
      border-radius: 20px;
      font-size: 1rem;
      resize: none;
      min-height: 44px;
      max-height: 120px;
    }
    #messageInput:focus {
      outline: none;
      border-color: #667eea;
    }
    .send-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      font-size: 1.25rem;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .send-button:hover {
      transform: scale(1.05);
    }
    .send-button:active {
      transform: scale(0.95);
    }
    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .char-counter {
      text-align: right;
      font-size: 0.75rem;
      color: #718096;
      margin-top: 4px;
    }
    .char-counter.warning {
      color: #f59e0b;
    }
    .char-counter.error {
      color: #ef4444;
    }

    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼åé¸æŠï¼ˆGASç‰ˆã®ã¿ï¼‰ */
    #userSelectContainer {
      margin-bottom: 8px;
    }

    /* é¸æŠå‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ */
    .selection-mode-bar {
      display: none;
      background-color: #fff3cd;
      padding: 12px 16px;
      border-bottom: 1px solid #ffeaa7;
      align-items: center;
      justify-content: space-between;
    }
    .selection-mode-bar.active {
      display: flex;
    }
    .selection-mode-info {
      font-size: 0.875rem;
      color: #856404;
    }
    .selection-mode-buttons {
      display: flex;
      gap: 8px;
    }
    .selection-mode-buttons button {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: transform 0.1s;
    }
    .selection-mode-buttons button:hover {
      transform: scale(1.05);
    }
    .btn-delete-selected {
      background-color: #ef4444;
      color: white;
    }
    .btn-cancel-selection {
      background-color: #6c757d;
      color: white;
    }
    .message-checkbox {
      display: none;
      margin-right: 8px;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    .selection-mode .message-checkbox {
      display: inline-block;
    }
    .toggle-selection-btn {
      background-color: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.4);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      margin-left: 12px;
    }
    .toggle-selection-btn:hover {
      background-color: rgba(255,255,255,0.3);
    }

    /* é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆLINEãƒ©ã‚¤ã‚¯ãªãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼‰ */
    #contextMenu {
      position: absolute;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.25);
      z-index: 3000;
      display: none;
      opacity: 0;
      transform: scale(0.9);
      transition: opacity 0.2s ease, transform 0.2s ease;
    }
    #contextMenu.active {
      display: block;
      opacity: 1;
      transform: scale(1);
    }
    .context-menu-items {
      display: flex;
      gap: 0;
      padding: 8px;
    }
    .context-menu-item {
      display: flex;
      padding: 10px 16px;
      background: white;
      cursor: pointer;
      transition: background 0.2s;
      border: none;
      font-family: inherit;
      font-size: 14px;
      color: #374151;
      border-right: 1px solid #e5e7eb;
      white-space: nowrap;
    }
    .context-menu-item:last-child {
      border-right: none;
    }
    .context-menu-item:active {
      background: #f3f4f6;
    }
    #contextMenuOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      z-index: 2999;
      display: none;
    }
    #contextMenuOverlay.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="chat-header">
    <button class="back-btn" onclick="goBackToList()" title="ãƒãƒ£ãƒƒãƒˆä¸€è¦§ã«æˆ»ã‚‹">â€¹</button>
    <h1>ğŸ’¬ ãƒãƒ¼ãƒ  ãƒãƒ£ãƒƒãƒˆ
      <button class="toggle-selection-btn" onclick="toggleSelectionMode()">ğŸ—‘ï¸ é¸æŠå‰Šé™¤</button>
    </h1>
    <div class="channel-info">
      <span id="channelName">èª­ã¿è¾¼ã¿ä¸­...</span>
      <span id="userInfo" style="margin-left: 12px;"></span>
    </div>

    <!-- GASç‰ˆï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼åé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ -->
    <div id="userSelectContainer" style="display: none; margin-top: 8px;">
      <label style="font-size: 12px; opacity: 0.9; margin-right: 4px;">é€ä¿¡è€…:</label>
      <select id="userSelect" style="background: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.5); padding: 4px 8px; border-radius: 4px; font-size: 12px;">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      </select>
    </div>

    <!-- PWAç‰ˆï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼åå…¥åŠ› -->
    <div id="userNameInputContainer" style="display: none; margin-top: 8px;">
      <label style="font-size: 12px; opacity: 0.9; margin-right: 4px;">ã‚ãªãŸã®åå‰:</label>
      <input type="text" id="userNameInput" placeholder="åå‰ã‚’å…¥åŠ›" style="background: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.5); padding: 4px 8px; border-radius: 4px; font-size: 12px; width: 150px;">
      <button id="saveUserNameBtn" style="background: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.5); padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-left: 4px;">ä¿å­˜</button>
    </div>
  </div>

  <!-- é¸æŠå‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ãƒãƒ¼ -->
  <div class="selection-mode-bar" id="selectionModeBar">
    <div class="selection-mode-info">
      <span id="selectedCount">0</span> ä»¶é¸æŠä¸­
    </div>
    <div class="selection-mode-buttons">
      <button class="btn-delete-selected" onclick="deleteSelectedMessages()">å‰Šé™¤</button>
      <button class="btn-cancel-selection" onclick="toggleSelectionMode()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <div class="messages-container" id="messagesContainer"></div>

  <div class="input-container">
    <div class="input-wrapper">
      <textarea
        id="messageInput"
        placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
        rows="1"
        maxlength="1000"></textarea>
      <button class="send-button" id="sendButton" onclick="sendMessage()">
        â¤
      </button>
    </div>
    <div class="char-counter" id="charCounter">0 / 1000</div>
  </div>

  <!-- é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆLINEãƒ©ã‚¤ã‚¯ãªãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼‰ -->
  <div id="contextMenuOverlay" onclick="closeContextMenu()"></div>
  <div id="contextMenu">
    <div class="context-menu-items">
      <button class="context-menu-item" onclick="copyMessage()">ã‚³ãƒ”ãƒ¼</button>
      <button class="context-menu-item" onclick="replyMessage()">ãƒªãƒ—ãƒ©ã‚¤</button>
      <button class="context-menu-item" onclick="deleteMessageFromMenu()">å‰Šé™¤</button>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, query, where, orderBy, limit, onSnapshot, serverTimestamp, doc, updateDoc, getDoc, setDoc, increment, getDocs, arrayUnion } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebaseè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjwwtCorUZQ",
      authDomain: "reborn-chat.firebaseapp.com",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    // FirebaseåˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    console.log('[Firestore] åˆæœŸåŒ–å®Œäº†');

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆJSON.stringifyã§å®‰å…¨ã«å—ã‘å–ã‚‹ï¼‰
    let currentUserName = '';
    let currentRoomId = '';
    let currentRoomName = '';
    let usersCache = []; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºç”¨ï¼‰

    // GASãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ã‚’JavaScriptå¤‰æ•°ã«å¤‰æ›ï¼ˆå¤‰æ•°åã®è¡çªã‚’é¿ã‘ã‚‹ï¼‰
    const isPWAFlag        = <?= JSON.stringify(!!isPWA) ?>;
    const pwaUserNameParam = <?= JSON.stringify(typeof pwaUserName !== 'undefined' ? pwaUserName : "") ?>;
    // roomId ã¯ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§ç›´æ¥å±•é–‹ï¼ˆJSON.stringifyä¸è¦ï¼‰
    const pwaRoomIdParam   = '<?= typeof pwaRoomId !== "undefined" ? pwaRoomId : "" ?>';
    const gasUserNameParam = <?= JSON.stringify(typeof gasUserName !== 'undefined' ? gasUserName : "") ?>;
    const gasRoomIdParam   = '<?= typeof gasRoomId !== "undefined" ? gasRoomId : "" ?>';
    const fcmTokenParam    = <?= JSON.stringify(typeof fcmToken !== 'undefined' ? fcmToken : "") ?>;
    const gasBaseUrlParam  = '<?= typeof gasBaseUrl !== "undefined" ? gasBaseUrl : "" ?>';  // âœ… APIå‘¼ã³å‡ºã—ç”¨URL

    // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼šæ˜ç¤ºãƒ•ãƒ©ã‚°å„ªå…ˆã€è£œåŠ©ã¨ã—ã¦ iframe å†…ã‹ã¤ userName/fcmToken ã®ã©ã¡ã‚‰ã‹ãŒéç©º
    const isEmbedded = (window.top !== window); // iframeå†…ãªã‚‰true
    const looksLikePWA = isEmbedded && (pwaUserNameParam !== "" || fcmTokenParam !== "");
    const isPWA = isPWAFlag || looksLikePWA;
    const isGAS = !isPWA;

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('[Chat UI] åˆæœŸåŒ–é–‹å§‹');

      // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›
      console.table({
        'isPWAFlag': isPWAFlag,
        'pwaUserNameParam': pwaUserNameParam,
        'pwaRoomIdParam': pwaRoomIdParam,
        'gasUserNameParam': gasUserNameParam,
        'gasRoomIdParam': gasRoomIdParam,
        'fcmTokenParam': fcmTokenParam ? fcmTokenParam.substring(0, 20) + '...' : '(empty)',
        'isEmbedded': isEmbedded,
        'looksLikePWA': looksLikePWA,
        'isPWA': isPWA,
        'isGAS': isGAS,
        'Mode': isGAS ? 'GAS' : 'PWA'
      });

      // roomIdè¨­å®š
      if (isGAS) {
        currentRoomId = gasRoomIdParam || 'room_all';
      } else {
        currentRoomId = pwaRoomIdParam || 'room_all';
      }
      console.log('[Room] roomIdè¨­å®š:', currentRoomId);

      // ãƒ«ãƒ¼ãƒ æƒ…å ±ã‚’å–å¾—ã—ã¦ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¡¨ç¤º
      try {
        const roomRef = doc(db, 'rooms', currentRoomId);
        const roomDoc = await getDoc(roomRef);

        if (roomDoc.exists()) {
          const roomData = roomDoc.data();
          currentRoomName = roomData.name || 'ä¸æ˜ãªãƒ«ãƒ¼ãƒ ';
          const roomIcon = roomData.icon || 'ğŸ’¬';
          document.getElementById('channelName').textContent = `${roomIcon} ${currentRoomName}`;
          console.log('[Room] ãƒ«ãƒ¼ãƒ åè¡¨ç¤ºå®Œäº†:', currentRoomName);
        } else {
          console.error('[Room] ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', currentRoomId);
          document.getElementById('channelName').textContent = 'âš ï¸ ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
        }
      } catch (error) {
        console.error('[Room] ãƒ«ãƒ¼ãƒ æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('channelName').textContent = 'âš ï¸ ã‚¨ãƒ©ãƒ¼';
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¨­å®š
      if (isGAS) {
        // GASç‰ˆï¼šFCMé€šçŸ¥ç™»éŒ²ã‚·ãƒ¼ãƒˆã‹ã‚‰è‡ªå‹•å–å¾—
        if (gasUserNameParam && gasUserNameParam.trim() !== '') {
          // JSON.parse()ã§ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
          try {
            currentUserName = JSON.parse(gasUserNameParam);
          } catch (e) {
            // ãƒ‘ãƒ¼ã‚¹ã§ããªã„å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
            currentUserName = gasUserNameParam;
          }
          document.getElementById('userInfo').textContent = `ğŸ‘¤ ${currentUserName}`;
          console.log('[GAS] ãƒ¦ãƒ¼ã‚¶ãƒ¼åè‡ªå‹•è¨­å®š:', currentUserName);
          console.log('[GAS] currentUserName length:', currentUserName.length);
        } else {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒå–å¾—ã§ããªã‹ã£ãŸå ´åˆã€ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¡¨ç¤º
          console.log('[GAS] ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’è¡¨ç¤º');
          showUserSelect();
        }
      } else {
        // PWAç‰ˆï¼šURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼ˆè¦ªãƒšãƒ¼ã‚¸ã®localStorageã‹ã‚‰æ¸¡ã•ã‚Œã‚‹ï¼‰
        // JSON.parse()ã§ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
        try {
          currentUserName = JSON.parse(pwaUserNameParam);
        } catch (e) {
          // ãƒ‘ãƒ¼ã‚¹ã§ããªã„å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
          currentUserName = pwaUserNameParam;
        }

        console.log('[PWA] pwaUserNameParamå—ä¿¡:', pwaUserNameParam);
        console.log('[PWA] currentUserNameè¨­å®š:', currentUserName);
        console.log('[PWA] currentUserName length:', currentUserName.length);

        if (currentUserName && currentUserName.trim() !== '') {
          document.getElementById('userInfo').textContent = `ğŸ‘¤ ${currentUserName}`;
          console.log('[PWA] ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤ºå®Œäº†:', currentUserName);
        } else {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒæœªè¨­å®šã®å ´åˆã€å…¥åŠ›UIã‚’è¡¨ç¤º
          console.log('[PWA] ãƒ¦ãƒ¼ã‚¶ãƒ¼åæœªè¨­å®š - å…¥åŠ›UIã‚’è¡¨ç¤º');
          const container = document.getElementById('userNameInputContainer');
          if (container) {
            container.style.display = 'block';
            console.log('[PWA] ãƒ¦ãƒ¼ã‚¶ãƒ¼åå…¥åŠ›UIè¡¨ç¤ºå®Œäº†');
          } else {
            console.error('[PWA] userNameInputContainer ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          }
        }
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºç”¨ï¼‰
      if (isPWA) {
        // PWAç‰ˆï¼šURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ã—ãŸGAS_BASE_URLã‚’ä½¿ç”¨
        const gasBaseUrl = gasBaseUrlParam;
        console.log('[User Cache] GAS_BASE_URL:', gasBaseUrl);

        if (gasBaseUrl) {
          console.log('[User Cache] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—é–‹å§‹:', gasBaseUrl + '?action=getUserListForUI');
          fetch(gasBaseUrl + '?action=getUserListForUI')
            .then(response => {
              console.log('[User Cache] Response status:', response.status);
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(users => {
              console.log('[User Cache] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å—ä¿¡:', users);
              if (users && users.length > 0) {
                usersCache = users;
                console.log('[User Cache] PWAç‰ˆ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Œäº†:', usersCache.length + 'ä»¶');
                console.log('[User Cache] ã‚­ãƒ£ãƒƒã‚·ãƒ¥å†…å®¹:', usersCache);

                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                console.log('[User Cache] ã‚­ãƒ£ãƒƒã‚·ãƒ¥å–å¾—å®Œäº†ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒ‹ãƒ³ã‚°é–‹å§‹');
                startListening();
              } else {
                console.warn('[User Cache] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãŒç©ºã§ã™');
                // ç©ºã®å ´åˆã§ã‚‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è¡¨ç¤ºã™ã‚‹
                startListening();
              }
            })
            .catch(error => {
              console.error('[User Cache] PWAç‰ˆ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
              console.error('[User Cache] ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.message, error.stack);
              // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã§ã‚‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è¡¨ç¤ºã™ã‚‹
              startListening();
            });
        } else {
          console.error('[User Cache] GAS_BASE_URL ãŒç©ºã§ã™');
          // GAS_BASE_URLãŒãªã„å ´åˆã§ã‚‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è¡¨ç¤ºã™ã‚‹
          startListening();
        }
      } else if (typeof google !== 'undefined' && google.script && google.script.run) {
        // GASç‰ˆï¼šgoogle.script.runã§å‘¼ã³å‡ºã—
        google.script.run
          .withSuccessHandler(function(users) {
            if (users && users.length > 0) {
              usersCache = users;
              console.log('[User Cache] GASç‰ˆ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Œäº†:', usersCache.length + 'ä»¶');
            }
          })
          .withFailureHandler(function(error) {
            console.error('[User Cache] GASç‰ˆ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          })
          .getUserListForUI();
      }

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ã®è‡ªå‹•ãƒªã‚µã‚¤ã‚º
      const messageInput = document.getElementById('messageInput');
      messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        updateCharCounter();
      });

      // Enterã‚­ãƒ¼ã§é€ä¿¡
      messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // æœªèª­ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆï¼ˆã“ã®ãƒ«ãƒ¼ãƒ ã‚’é–‹ã„ãŸã®ã§æ—¢èª­ã«ã™ã‚‹ï¼‰
      try {
        if (currentRoomId && currentUserName) {
          const unreadRef = doc(db, `rooms/${currentRoomId}/unreadCounts/${currentUserName}`);
          await setDoc(unreadRef, {
            userId: currentUserName,
            unreadCount: 0,
            lastReadAt: serverTimestamp()
          }, { merge: true });

          console.log('[Firestore] æœªèª­ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆå®Œäº†:', currentUserName);
        }
      } catch (error) {
        console.error('[Firestore] æœªèª­ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
      }

      // ãƒ«ãƒ¼ãƒ ã®membersã«è‡ªåˆ†ã‚’è¿½åŠ ï¼ˆæœªè¿½åŠ ã®å ´åˆï¼‰
      try {
        if (currentRoomId && currentUserName) {
          const roomRef = doc(db, 'rooms', currentRoomId);
          await updateDoc(roomRef, {
            members: arrayUnion(currentUserName)
          });

          console.log('[Firestore] ãƒ«ãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã«è¿½åŠ :', currentUserName);
        }
      } catch (error) {
        console.error('[Firestore] ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
      }

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥å–å¾—å¾Œã«é–‹å§‹
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå–å¾—ã§ããªã„å ´åˆã¯3ç§’å¾Œã«é–‹å§‹
      if (!isPWA) {
        // GASç‰ˆã¯å³åº§ã«startListening
        startListening();
      }
      // PWAç‰ˆã¯fetchå®Œäº†å¾Œã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¾Œã«startListeningã‚’å‘¼ã³å‡ºã™
    });

    // GASç‰ˆï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¡¨ç¤º
    function showUserSelect() {
      const container = document.getElementById('userSelectContainer');
      const select = document.getElementById('userSelect');

      container.style.display = 'block';

      // FCMé€šçŸ¥ç™»éŒ²ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆå–å¾—
      google.script.run
        .withSuccessHandler(function(users) {
          console.log('[GAS] ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—æˆåŠŸ:', users);

          if (!users || users.length === 0) {
            console.error('[GAS] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
          }

          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºç”¨ï¼‰
          usersCache = users;
          console.log('[User Cache] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Œäº†:', usersCache.length + 'ä»¶');

          // å‰å›é¸æŠã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
          const savedUserName = localStorage.getItem('reborn_chat_user_name');

          // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è¿½åŠ 
          select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
          users.forEach(function(user) {
            const option = document.createElement('option');
            option.value = user.userName;
            option.textContent = user.userName;

            if (savedUserName && user.userName === savedUserName) {
              option.selected = true;
              currentUserName = user.userName;
            }

            select.appendChild(option);
          });

          // é¸æŠå¤‰æ›´æ™‚
          select.addEventListener('change', function() {
            currentUserName = this.value;
            localStorage.setItem('reborn_chat_user_name', currentUserName);
            console.log('[GAS] ãƒ¦ãƒ¼ã‚¶ãƒ¼åé¸æŠ:', currentUserName);
          });
        })
        .withFailureHandler(function(error) {
          console.error('[GAS] ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getActiveUsers();
    }

    // PWAç‰ˆï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼åå…¥åŠ›UIè¡¨ç¤º
    function showUserNameInput() {
      const container = document.getElementById('userNameInputContainer');
      const input = document.getElementById('userNameInput');
      const saveBtn = document.getElementById('saveUserNameBtn');

      container.style.display = 'block';

      // æ—¢å­˜ã®å€¤ãŒã‚ã‚Œã° pre-fill
      if (currentUserName) {
        input.value = currentUserName;
      }

      // ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
      saveBtn.addEventListener('click', function() {
        const userName = input.value.trim();

        if (!userName) {
          alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }

        // localStorage ã«ä¿å­˜
        localStorage.setItem('reborn_user_name', userName);
        currentUserName = userName;

        // userInfo è¡¨ç¤ºã‚’æ›´æ–°
        document.getElementById('userInfo').textContent = `ğŸ‘¤ ${userName}`;

        // å…¥åŠ›UIã‚’éè¡¨ç¤º
        container.style.display = 'none';

        console.log('[PWA] ãƒ¦ãƒ¼ã‚¶ãƒ¼åä¿å­˜:', userName);
      });
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³URLã‚’å–å¾—
    function getUserIconUrl(userName) {
      console.log('[Icon] ã‚¢ã‚¤ã‚³ãƒ³URLå–å¾—:', { userName, cacheSize: usersCache?.length || 0 });

      if (!userName || !usersCache || usersCache.length === 0) {
        console.warn('[Icon] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒç©ºã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼åãªã—');
        return null;
      }

      const user = usersCache.find(u => u.userName === userName);
      console.log('[Icon] æ¤œç´¢çµæœ:', user);

      if (user && user.userIconUrl) {
        console.log('[Icon] ã‚¢ã‚¤ã‚³ãƒ³URLè¿”å´:', user.userIconUrl);
        return user.userIconUrl;
      } else {
        console.warn('[Icon] ã‚¢ã‚¤ã‚³ãƒ³URLãªã—:', userName);
        return null;
      }
    }

    // Firestoreãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒ‹ãƒ³ã‚°
    function startListening() {
      const q = query(
        collection(db, 'messages'),
        where('roomId', '==', currentRoomId),
        orderBy('timestamp', 'desc'),
        limit(50)
      );

      onSnapshot(q, (snapshot) => {
        console.log('[Firestore] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°:', snapshot.size + 'ä»¶');

        const container = document.getElementById('messagesContainer');
        container.innerHTML = '';

        // æ–°ã—ã„é †ã§å–å¾—ã—ãŸã®ã§ã€é€†é †ã§è¡¨ç¤º
        const messages = [];
        snapshot.forEach((doc) => {
          messages.unshift({ id: doc.id, ...doc.data() });
        });

        messages.forEach((msg) => {
          appendMessage(msg);
        });

        // æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        container.scrollTop = container.scrollHeight;
      }, (error) => {
        console.error('[Firestore] ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å—ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      });
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’UIã«è¿½åŠ 
    function appendMessage(msg) {
      const container = document.getElementById('messagesContainer');

      const item = document.createElement('div');

      // msg.userNameã‚‚JSON.parseã—ã¦æ­£è¦åŒ–ï¼ˆå¤ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¯¾å¿œï¼‰
      let messageUserName = msg.userName;
      try {
        // ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ãƒ‘ãƒ¼ã‚¹
        if (typeof messageUserName === 'string' && messageUserName.startsWith('"') && messageUserName.endsWith('"')) {
          messageUserName = JSON.parse(messageUserName);
        }
      } catch (e) {
        // ãƒ‘ãƒ¼ã‚¹ã§ããªã„å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
      }

      // è‡ªåˆ†ãŒå‰Šé™¤ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ­£è¦åŒ–ã—ãŸcurrentUserNameã§åˆ¤å®šï¼‰
      if (msg.deletedBy) {
        // deletedByé…åˆ—ã®å„è¦ç´ ã‚‚æ­£è¦åŒ–ã—ã¦æ¯”è¼ƒ
        const normalizedDeletedBy = msg.deletedBy.map(name => {
          try {
            if (typeof name === 'string' && name.startsWith('"') && name.endsWith('"')) {
              return JSON.parse(name);
            }
            return name;
          } catch (e) {
            return name;
          }
        });

        if (normalizedDeletedBy.includes(currentUserName)) {
          return;
        }
      }

      // è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ä»–äººã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã§åˆ†å²
      const isMine = messageUserName === currentUserName;

      // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
      console.log('[AppendMessage] msg.userName:', msg.userName, 'normalized:', messageUserName, 'currentUserName:', currentUserName, 'isMine:', isMine);

      item.className = isMine ? 'message-item message-item-mine' : 'message-item message-item-other';
      item.dataset.messageId = msg.id;

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒ³ãƒˆï¼ˆã‚¢ã‚¤ã‚³ãƒ³ + ãƒ©ãƒƒãƒ‘ãƒ¼ï¼‰
      const content = document.createElement('div');
      content.className = 'message-content';

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆLINEé¢¨ï¼‰- ç›¸æ‰‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿è¡¨ç¤º
      if (!isMine) {
        const iconUrl = getUserIconUrl(messageUserName);
        if (iconUrl) {
          // ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒãŒã‚ã‚‹å ´åˆ
          const icon = document.createElement('img');
          icon.className = 'user-icon';
          icon.src = iconUrl;
          icon.alt = messageUserName || 'åŒ¿å';
          icon.onerror = function() {
            // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
            const placeholder = document.createElement('div');
            placeholder.className = 'user-icon-placeholder';
            placeholder.textContent = (messageUserName || 'åŒ¿').charAt(0);
            this.replaceWith(placeholder);
          };
          content.appendChild(icon);
        } else {
          // ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒãŒãªã„å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
          const placeholder = document.createElement('div');
          placeholder.className = 'user-icon-placeholder';
          placeholder.textContent = (messageUserName || 'åŒ¿').charAt(0);
          content.appendChild(placeholder);
        }
      }

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆãƒãƒ–ãƒ« + æ™‚é–“ï¼‰
      const wrapper = document.createElement('div');
      wrapper.className = 'message-wrapper';

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ–ãƒ«
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡
      const text = document.createElement('div');
      text.className = 'message-text';
      text.textContent = msg.text || '';
      bubble.appendChild(text);

      // æ™‚é–“
      const time = document.createElement('span');
      time.className = 'message-time';
      if (msg.timestamp && msg.timestamp.toDate) {
        const date = msg.timestamp.toDate();
        // æ—¥ä»˜ã¨æ™‚é–“ã®ã¿è¡¨ç¤ºï¼ˆæœˆ/æ—¥ æ™‚:åˆ†ï¼‰
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        time.textContent = `${month}/${day} ${hours}:${minutes}`;
      } else {
        const date = new Date();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        time.textContent = `${month}/${day} ${hours}:${minutes}`;
      }

      wrapper.appendChild(bubble);
      wrapper.appendChild(time);
      content.appendChild(wrapper);
      item.appendChild(content);

      // é•·æŠ¼ã—ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      console.log('[Message] Adding long press listener for message:', msg.id);
      addLongPressListener(item, msg.id, msg.text || '');

      container.appendChild(item);
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    window.sendMessage = async function() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();

      if (!message) {
        return;
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒã‚§ãƒƒã‚¯
      if (!currentUserName) {
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      // roomIdãƒã‚§ãƒƒã‚¯
      if (!currentRoomId) {
        alert('ãƒ«ãƒ¼ãƒ IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }

      try {
        console.log('[Firestore] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ä¸­...');

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
        await addDoc(collection(db, 'messages'), {
          roomId: currentRoomId,
          text: message,
          userName: currentUserName,
          timestamp: serverTimestamp(),
          deletedBy: []
        });

        console.log('[Firestore] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å®Œäº†');

        // roomsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®lastMessageã‚’æ›´æ–°
        const roomRef = doc(db, 'rooms', currentRoomId);
        await updateDoc(roomRef, {
          lastMessage: message,
          lastMessageAt: serverTimestamp(),
          lastMessageBy: currentUserName
        });

        console.log('[Firestore] ãƒ«ãƒ¼ãƒ æƒ…å ±æ›´æ–°å®Œäº†');

        // æœªèª­ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°ï¼ˆé€ä¿¡è€…ä»¥å¤–ã®å…¨ãƒ¡ãƒ³ãƒãƒ¼ï¼‰
        try {
          // ãƒ«ãƒ¼ãƒ æƒ…å ±ã‚’å–å¾—ã—ã¦ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’ç¢ºèª
          const roomSnap = await getDoc(roomRef);
          if (roomSnap.exists()) {
            const roomData = roomSnap.data();
            const members = roomData.members || [];

            console.log('[Firestore] æœªèª­ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°é–‹å§‹:', {
              members: members,
              currentUser: currentUserName
            });

            // é€ä¿¡è€…ä»¥å¤–ã®å…¨ãƒ¡ãƒ³ãƒãƒ¼ã®æœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚’+1
            for (const member of members) {
              if (member !== currentUserName) {
                const unreadRef = doc(db, `rooms/${currentRoomId}/unreadCounts/${member}`);

                // æœªèª­ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°å‰ã«ç¾åœ¨ã®å€¤ã‚’å–å¾—
                const unreadSnap = await getDoc(unreadRef);
                const currentUnreadCount = unreadSnap.exists() ? (unreadSnap.data().unreadCount || 0) : 0;

                // æœªèª­ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
                await setDoc(unreadRef, {
                  userId: member,
                  unreadCount: increment(1),
                  lastUpdatedAt: serverTimestamp()
                }, { merge: true });

                // æ–°ã—ã„æœªèª­æ•°ï¼ˆã“ã®ãƒ«ãƒ¼ãƒ ã®ã¿ï¼‰
                const newUnreadCount = currentUnreadCount + 1;

                console.log('[Firestore] æœªèª­ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°:', member, newUnreadCount);

                // FCMé€šçŸ¥é€ä¿¡ï¼ˆGAS/PWAå…±é€š: google.script.runã‚’ä½¿ç”¨ï¼‰
                const notificationTitle = `ğŸ’¬ ${currentRoomName}`;
                const notificationBody = `${currentUserName}: ${message}`;

                if (typeof google !== 'undefined' && google.script && google.script.run) {
                  google.script.run
                    .withSuccessHandler(function(result) {
                      console.log('[FCMé€šçŸ¥] é€ä¿¡æˆåŠŸ:', member, result);
                    })
                    .withFailureHandler(function(error) {
                      console.error('[FCMé€šçŸ¥] é€ä¿¡ã‚¨ãƒ©ãƒ¼:', member, error);
                    })
                    .sendFCMNotificationToUser(notificationTitle, notificationBody, member, newUnreadCount);

                  console.log('[FCMé€šçŸ¥] é€ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:', member, 'ãƒãƒƒã‚¸:', newUnreadCount);
                } else {
                  console.error('[FCMé€šçŸ¥] google.script.run ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
              }
            }
          }
        } catch (error) {
          console.error('[Firestore] æœªèª­ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
          // ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã¯æˆåŠŸã—ã¦ã„ã‚‹ã®ã§ç¶šè¡Œ
        }

        // å…¥åŠ›æ¬„ã‚¯ãƒªã‚¢
        input.value = '';
        input.style.height = 'auto';
        updateCharCounter();

      } catch (error) {
        console.error('[Firestore] é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };

    // ãƒãƒ£ãƒƒãƒˆä¸€è¦§ã«æˆ»ã‚‹ï¼ˆLINEé¢¨ï¼‰
    window.goBackToList = function() {
      console.log('========================================');
      console.log('[Navigation] ğŸ”™ ãƒãƒ£ãƒƒãƒˆä¸€è¦§ã«æˆ»ã‚‹ - é–¢æ•°å®Ÿè¡Œé–‹å§‹');
      console.log('[Navigation] isPWA:', isPWA);
      console.log('[Navigation] window.parent:', window.parent);
      console.log('[Navigation] window.parent === window:', window.parent === window);
      console.log('========================================');

      if (isPWA) {
        // PWAç‰ˆ: è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
        try {
          console.log('[Navigation] ğŸ“¨ PWAç‰ˆ: è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«postMessageé€ä¿¡');
          const message = {
            type: 'showChatRoomsList'
          };
          console.log('[Navigation] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹:', message);
          window.parent.postMessage(message, '*');
          console.log('[Navigation] âœ… postMessageé€ä¿¡å®Œäº†');
        } catch (error) {
          console.error('[Navigation] âŒ postMessage ã‚¨ãƒ©ãƒ¼:', error);
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: history.back()
          console.log('[Navigation] ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: history.back()');
          window.history.back();
        }
      } else {
        // GASç‰ˆ: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã«æˆ»ã‚‹
        console.log('[Navigation] GASç‰ˆ: google.script.run å‘¼ã³å‡ºã—');
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          google.script.run.showChatRoomsList();
        } else {
          console.error('[Navigation] google.script.run ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
        }
      }
    };

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤ï¼ˆè«–ç†å‰Šé™¤ - è‡ªåˆ†ã®ç”»é¢ã‹ã‚‰ã®ã¿å‰Šé™¤ï¼‰
    async function deleteMessage(messageId) {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒã‚§ãƒƒã‚¯
      if (!currentUserName) {
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      if (!confirm('ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      try {
        console.log('[Firestore] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤ä¸­...', messageId);
        console.log('[Firestore] å‰Šé™¤ãƒ¦ãƒ¼ã‚¶ãƒ¼:', currentUserName);

        const messageRef = doc(db, 'messages', messageId);
        const messageDoc = await getDoc(messageRef);

        if (!messageDoc.exists()) {
          console.error('[Firestore] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
          return;
        }

        const messageData = messageDoc.data();
        // deletedBy ãŒé…åˆ—ã§ãªã„å ´åˆã‚‚è€ƒæ…®ã—ã¦ã€ç¢ºå®Ÿã«é…åˆ—åŒ–
        let deletedByArray = messageData.deletedBy;
        if (!Array.isArray(deletedByArray)) {
          deletedByArray = [];
        }

        // è‡ªåˆ†ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ deletedBy é…åˆ—ã«è¿½åŠ 
        if (!deletedByArray.includes(currentUserName)) {
          deletedByArray.push(currentUserName);
        }

        await updateDoc(messageRef, {
          deletedBy: deletedByArray,
          lastDeletedAt: serverTimestamp()
        });

        console.log('[Firestore] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤å®Œäº†ï¼ˆè‡ªåˆ†ã®ç”»é¢ã‹ã‚‰ã®ã¿ï¼‰');

      } catch (error) {
        console.error('[Firestore] å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°
    function updateCharCounter() {
      const input = document.getElementById('messageInput');
      const counter = document.getElementById('charCounter');
      const length = input.value.length;

      counter.textContent = `${length} / 1000`;

      if (length > 950) {
        counter.classList.add('error');
        counter.classList.remove('warning');
      } else if (length > 900) {
        counter.classList.add('warning');
        counter.classList.remove('error');
      } else {
        counter.classList.remove('warning', 'error');
      }
    }

    // é¸æŠå‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ
    window.toggleSelectionMode = function() {
      const container = document.getElementById('messagesContainer');
      const bar = document.getElementById('selectionModeBar');

      if (container.classList.contains('selection-mode')) {
        // é¸æŠãƒ¢ãƒ¼ãƒ‰çµ‚äº†
        container.classList.remove('selection-mode');
        bar.classList.remove('active');

        // ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
        const checkboxes = document.querySelectorAll('.message-checkbox');
        checkboxes.forEach(cb => cb.checked = false);
        updateSelectionCount();
      } else {
        // é¸æŠãƒ¢ãƒ¼ãƒ‰é–‹å§‹
        container.classList.add('selection-mode');
        bar.classList.add('active');
      }
    };

    // é¸æŠã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
    function updateSelectionCount() {
      const checkboxes = document.querySelectorAll('.message-checkbox:checked');
      const count = checkboxes.length;
      document.getElementById('selectedCount').textContent = count;
    }

    // é¸æŠã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸€æ‹¬å‰Šé™¤ï¼ˆè‡ªåˆ†ã®ç”»é¢ã‹ã‚‰ã®ã¿å‰Šé™¤ï¼‰
    window.deleteSelectedMessages = async function() {
      const checkboxes = document.querySelectorAll('.message-checkbox:checked');

      if (checkboxes.length === 0) {
        alert('å‰Šé™¤ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      if (!confirm(`${checkboxes.length}ä»¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }

      try {
        console.log('[Firestore] ä¸€æ‹¬å‰Šé™¤é–‹å§‹:', checkboxes.length + 'ä»¶');

        // ä¸¦åˆ—ã§å‰Šé™¤å‡¦ç†
        const deletePromises = Array.from(checkboxes).map(async (checkbox) => {
          const messageId = checkbox.dataset.messageId;
          const messageRef = doc(db, 'messages', messageId);
          const messageDoc = await getDoc(messageRef);

          if (messageDoc.exists()) {
            const messageData = messageDoc.data();
            // deletedBy ãŒé…åˆ—ã§ãªã„å ´åˆã‚‚è€ƒæ…®ã—ã¦ã€ç¢ºå®Ÿã«é…åˆ—åŒ–
            let deletedByArray = messageData.deletedBy;
            if (!Array.isArray(deletedByArray)) {
              deletedByArray = [];
            }

            // è‡ªåˆ†ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ deletedBy é…åˆ—ã«è¿½åŠ 
            if (!deletedByArray.includes(currentUserName)) {
              deletedByArray.push(currentUserName);
            }

            await updateDoc(messageRef, {
              deletedBy: deletedByArray,
              lastDeletedAt: serverTimestamp()
            });
          }
        });

        await Promise.all(deletePromises);

        console.log('[Firestore] ä¸€æ‹¬å‰Šé™¤å®Œäº†ï¼ˆè‡ªåˆ†ã®ç”»é¢ã‹ã‚‰ã®ã¿ï¼‰');

        // é¸æŠãƒ¢ãƒ¼ãƒ‰çµ‚äº†
        toggleSelectionMode();

      } catch (error) {
        console.error('[Firestore] ä¸€æ‹¬å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };

    // é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–¢é€£
    let contextMenuData = {
      messageId: null,
      messageText: null
    };
    let longPressTimer = null;
    const LONG_PRESS_DURATION = 500; // 500ms

    // é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ãï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¿‘ãã«è¡¨ç¤ºï¼‰
    function openContextMenu(messageId, messageText, targetElement) {
      console.log('[ContextMenu] Opening menu for message:', messageId);
      contextMenuData.messageId = messageId;
      contextMenuData.messageText = messageText;

      const menu = document.getElementById('contextMenu');
      const overlay = document.getElementById('contextMenuOverlay');

      console.log('[ContextMenu] Menu element:', menu);
      console.log('[ContextMenu] Overlay element:', overlay);

      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆä½ç½®è¨ˆç®—ã®ãŸã‚ä¸€æ™‚çš„ã«è¡¨ç¤ºï¼‰
      menu.style.display = 'block';
      menu.style.opacity = '0';

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã®ä½ç½®ã‚’å–å¾—
      const rect = targetElement.getBoundingClientRect();
      const menuRect = menu.getBoundingClientRect();

      console.log('[ContextMenu] Target rect:', rect);
      console.log('[ContextMenu] Menu rect:', menuRect);

      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¸Šéƒ¨ä¸­å¤®ã«é…ç½®
      let top = rect.top - menuRect.height - 10; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¸Šã«10pxéš™é–“
      let left = rect.left + (rect.width / 2) - (menuRect.width / 2); // ä¸­å¤®æƒãˆ

      // ç”»é¢ä¸Šéƒ¨ã«ã¯ã¿å‡ºã™å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¸‹ã«è¡¨ç¤º
      if (top < 10) {
        top = rect.bottom + 10;
      }

      // ç”»é¢å·¦å³ã«ã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã«èª¿æ•´
      if (left < 10) {
        left = 10;
      } else if (left + menuRect.width > window.innerWidth - 10) {
        left = window.innerWidth - menuRect.width - 10;
      }

      // ä½ç½®ã‚’è¨­å®š
      menu.style.top = top + 'px';
      menu.style.left = left + 'px';

      console.log('[ContextMenu] Final position - top:', top, 'left:', left);

      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
      overlay.classList.add('active');
      menu.classList.add('active');

      // CSSã®transitionã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã€æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§opacityã‚’ãƒªã‚»ãƒƒãƒˆ
      setTimeout(() => {
        menu.style.opacity = '1';
      }, 10);

      console.log('[ContextMenu] Menu classes:', menu.className);
      console.log('[ContextMenu] Overlay classes:', overlay.className);
    }

    // é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
    window.closeContextMenu = function() {
      const menu = document.getElementById('contextMenu');
      const overlay = document.getElementById('contextMenuOverlay');

      overlay.classList.remove('active');
      menu.classList.remove('active');

      // æ¬¡å›ã®ãŸã‚ã« opacity ã‚’ 0 ã«æˆ»ã™
      setTimeout(() => {
        menu.style.opacity = '0';
      }, 200); // transitionã®æ™‚é–“ï¼ˆ0.2sï¼‰å¾Œã«å®Ÿè¡Œ

      contextMenuData = { messageId: null, messageText: null };
    };

    // ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
    window.copyMessage = function() {
      if (!contextMenuData.messageText) return;

      // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
      navigator.clipboard.writeText(contextMenuData.messageText)
        .then(() => {
          console.log('[Copy] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
          closeContextMenu();
        })
        .catch(err => {
          console.error('[Copy] ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼:', err);
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: textareaã‚’ä½¿ã£ãŸå¤ã„æ–¹æ³•
          const textarea = document.createElement('textarea');
          textarea.value = contextMenuData.messageText;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          closeContextMenu();
        });
    };

    // ãƒªãƒ—ãƒ©ã‚¤æ©Ÿèƒ½
    window.replyMessage = function() {
      if (!contextMenuData.messageText) return;

      const messageInput = document.getElementById('messageInput');
      const replyText = `> ${contextMenuData.messageText}\n\n`;
      messageInput.value = replyText;
      messageInput.focus();

      // è‡ªå‹•ãƒªã‚µã‚¤ã‚º
      messageInput.style.height = 'auto';
      messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';

      closeContextMenu();
    };

    // å‰Šé™¤æ©Ÿèƒ½ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ï¼‰
    window.deleteMessageFromMenu = function() {
      if (!contextMenuData.messageId) return;

      // closeContextMenu()ã§contextMenuDataãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹å‰ã«IDã‚’ä¿å­˜
      const messageId = contextMenuData.messageId;

      closeContextMenu();
      deleteMessage(messageId);
    };

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¢ã‚¤ãƒ†ãƒ ã«é•·æŠ¼ã—ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
    function addLongPressListener(item, messageId, messageText) {
      let touchStartTime = 0;
      let touchMoved = false;

      // ã‚¿ãƒƒãƒé–‹å§‹
      item.addEventListener('touchstart', (e) => {
        console.log('[LongPress] touchstart');
        touchStartTime = Date.now();
        touchMoved = false;

        longPressTimer = setTimeout(() => {
          console.log('[LongPress] Timer fired, touchMoved:', touchMoved);
          if (!touchMoved) {
            console.log('[LongPress] Opening context menu');
            openContextMenu(messageId, messageText, item);
            // æŒ¯å‹•ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿ï¼‰
            if ('vibrate' in navigator) {
              navigator.vibrate(50);
            }
          }
        }, LONG_PRESS_DURATION);
      });

      // ã‚¿ãƒƒãƒç§»å‹•ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ¤œå‡ºï¼‰
      item.addEventListener('touchmove', () => {
        console.log('[LongPress] touchmove - canceling');
        touchMoved = true;
        if (longPressTimer) {
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
      });

      // ã‚¿ãƒƒãƒçµ‚äº†
      item.addEventListener('touchend', () => {
        if (longPressTimer) {
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
      });

      // ã‚¿ãƒƒãƒã‚­ãƒ£ãƒ³ã‚»ãƒ«
      item.addEventListener('touchcancel', () => {
        if (longPressTimer) {
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
      });

      // PCç”¨: å³ã‚¯ãƒªãƒƒã‚¯
      item.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        openContextMenu(messageId, messageText, item);
      });
    }
  </script>
</body>
</html>
