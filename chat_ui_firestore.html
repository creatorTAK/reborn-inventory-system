<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      background-color: #f8f9fa;
      display: flex;
      flex-direction: column;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .chat-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      flex-shrink: 0;
    }
    .chat-header h1 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
    }
    .chat-header .channel-info {
      font-size: 0.875rem;
      opacity: 0.9;
      margin-top: 4px;
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background-color: #f8f9fa;
    }

    .message-item {
      margin-bottom: 16px;
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .message-header {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
    .message-sender {
      font-weight: 600;
      margin-right: 8px;
      color: #2d3748;
    }
    .message-time {
      font-size: 0.75rem;
      color: #718096;
    }
    .message-text {
      background-color: white;
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
    .input-container {
      padding: 16px;
      background-color: white;
      border-top: 1px solid #e2e8f0;
      flex-shrink: 0;
    }
    .input-wrapper {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    #messageInput {
      flex: 1;
      padding: 12px;
      border: 1px solid #cbd5e0;
      border-radius: 20px;
      font-size: 1rem;
      resize: none;
      min-height: 44px;
      max-height: 120px;
    }
    #messageInput:focus {
      outline: none;
      border-color: #667eea;
    }
    .send-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      font-size: 1.25rem;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .send-button:hover {
      transform: scale(1.05);
    }
    .send-button:active {
      transform: scale(0.95);
    }
    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .char-counter {
      text-align: right;
      font-size: 0.75rem;
      color: #718096;
      margin-top: 4px;
    }
    .char-counter.warning {
      color: #f59e0b;
    }
    .char-counter.error {
      color: #ef4444;
    }

    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼åé¸æŠï¼ˆGASç‰ˆã®ã¿ï¼‰ */
    #userSelectContainer {
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div class="chat-header">
    <h1>ğŸ’¬ ãƒãƒ¼ãƒ  ãƒãƒ£ãƒƒãƒˆ</h1>
    <div class="channel-info">
      <span id="channelName">#å…¨ä½“</span>
      <span id="userInfo" style="margin-left: 12px;"></span>
    </div>

    <!-- GASç‰ˆï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼åé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ -->
    <div id="userSelectContainer" style="display: none; margin-top: 8px;">
      <label style="font-size: 12px; opacity: 0.9; margin-right: 4px;">é€ä¿¡è€…:</label>
      <select id="userSelect" style="background: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.5); padding: 4px 8px; border-radius: 4px; font-size: 12px;">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      </select>
    </div>

    <!-- PWAç‰ˆï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼åå…¥åŠ› -->
    <div id="userNameInputContainer" style="display: none; margin-top: 8px;">
      <label style="font-size: 12px; opacity: 0.9; margin-right: 4px;">ã‚ãªãŸã®åå‰:</label>
      <input type="text" id="userNameInput" placeholder="åå‰ã‚’å…¥åŠ›" style="background: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.5); padding: 4px 8px; border-radius: 4px; font-size: 12px; width: 150px;">
      <button id="saveUserNameBtn" style="background: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.5); padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-left: 4px;">ä¿å­˜</button>
    </div>
  </div>

  <div class="messages-container" id="messagesContainer"></div>

  <div class="input-container">
    <div class="input-wrapper">
      <textarea
        id="messageInput"
        placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
        rows="1"
        maxlength="1000"></textarea>
      <button class="send-button" id="sendButton" onclick="sendMessage()">
        â¤
      </button>
    </div>
    <div class="char-counter" id="charCounter">0 / 1000</div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebaseè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyCe-mj6xoV1HbHkIOVqeHCjwwtCorUZQ",
      authDomain: "reborn-chat.firebaseapp.com",
      projectId: "reborn-chat",
      storageBucket: "reborn-chat.firebasestorage.app",
      messagingSenderId: "345706548795",
      appId: "1:345706548795:web:058a553da6b4b74db5161e"
    };

    // FirebaseåˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    console.log('[Firestore] åˆæœŸåŒ–å®Œäº†');

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆJSON.stringifyã§å®‰å…¨ã«å—ã‘å–ã‚‹ï¼‰
    let currentUserName = '';
    const isPWAFlag   = <?= JSON.stringify(!!isPWA) ?>;
    const pwaUserName = <?= JSON.stringify(pwaUserName || "") ?>;
    const fcmToken    = <?= JSON.stringify(fcmToken || "") ?>;

    // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼šæ˜ç¤ºãƒ•ãƒ©ã‚°å„ªå…ˆã€è£œåŠ©ã¨ã—ã¦ iframe å†…ã‹ã¤ userName/fcmToken ã®ã©ã¡ã‚‰ã‹ãŒéç©º
    const isEmbedded = (window.top !== window); // iframeå†…ãªã‚‰true
    const looksLikePWA = isEmbedded && (pwaUserName !== "" || fcmToken !== "");
    const isPWA = isPWAFlag || looksLikePWA;
    const isGAS = !isPWA;

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[Chat UI] åˆæœŸåŒ–é–‹å§‹');

      // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›
      console.table({
        'isPWAFlag': isPWAFlag,
        'pwaUserName': pwaUserName,
        'fcmToken': fcmToken ? fcmToken.substring(0, 20) + '...' : '(empty)',
        'isEmbedded': isEmbedded,
        'looksLikePWA': looksLikePWA,
        'isPWA': isPWA,
        'isGAS': isGAS,
        'Mode': isGAS ? 'GAS' : 'PWA'
      });

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¨­å®š
      if (isGAS) {
        // GASç‰ˆï¼šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¡¨ç¤º
        showUserSelect();
      } else {
        // PWAç‰ˆï¼šURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼ˆè¦ªãƒšãƒ¼ã‚¸ã®localStorageã‹ã‚‰æ¸¡ã•ã‚Œã‚‹ï¼‰
        currentUserName = pwaUserName;

        if (currentUserName) {
          document.getElementById('userInfo').textContent = `ğŸ‘¤ ${currentUserName}`;
          console.log('[PWA] ãƒ¦ãƒ¼ã‚¶ãƒ¼åå–å¾—ï¼ˆURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰:', currentUserName);
        } else {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒæœªè¨­å®šã®å ´åˆã€å…¥åŠ›UIã‚’è¡¨ç¤º
          console.log('[PWA] ãƒ¦ãƒ¼ã‚¶ãƒ¼åæœªè¨­å®š - å…¥åŠ›UIã‚’è¡¨ç¤º');
          showUserNameInput();
        }
      }

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ã®è‡ªå‹•ãƒªã‚µã‚¤ã‚º
      const messageInput = document.getElementById('messageInput');
      messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        updateCharCounter();
      });

      // Enterã‚­ãƒ¼ã§é€ä¿¡
      messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒ‹ãƒ³ã‚°é–‹å§‹
      startListening();
    });

    // GASç‰ˆï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¡¨ç¤º
    function showUserSelect() {
      const container = document.getElementById('userSelectContainer');
      const select = document.getElementById('userSelect');

      container.style.display = 'block';

      // FCMé€šçŸ¥ç™»éŒ²ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆå–å¾—
      google.script.run
        .withSuccessHandler(function(users) {
          console.log('[GAS] ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—æˆåŠŸ:', users);

          if (!users || users.length === 0) {
            console.error('[GAS] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
          }

          // å‰å›é¸æŠã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
          const savedUserName = localStorage.getItem('reborn_chat_user_name');

          // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è¿½åŠ 
          select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
          users.forEach(function(user) {
            const option = document.createElement('option');
            option.value = user.userName;
            option.textContent = user.userName;

            if (savedUserName && user.userName === savedUserName) {
              option.selected = true;
              currentUserName = user.userName;
            }

            select.appendChild(option);
          });

          // é¸æŠå¤‰æ›´æ™‚
          select.addEventListener('change', function() {
            currentUserName = this.value;
            localStorage.setItem('reborn_chat_user_name', currentUserName);
            console.log('[GAS] ãƒ¦ãƒ¼ã‚¶ãƒ¼åé¸æŠ:', currentUserName);
          });
        })
        .withFailureHandler(function(error) {
          console.error('[GAS] ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getActiveUsers();
    }

    // PWAç‰ˆï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼åå…¥åŠ›UIè¡¨ç¤º
    function showUserNameInput() {
      const container = document.getElementById('userNameInputContainer');
      const input = document.getElementById('userNameInput');
      const saveBtn = document.getElementById('saveUserNameBtn');

      container.style.display = 'block';

      // æ—¢å­˜ã®å€¤ãŒã‚ã‚Œã° pre-fill
      if (currentUserName) {
        input.value = currentUserName;
      }

      // ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
      saveBtn.addEventListener('click', function() {
        const userName = input.value.trim();

        if (!userName) {
          alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }

        // localStorage ã«ä¿å­˜
        localStorage.setItem('reborn_user_name', userName);
        currentUserName = userName;

        // userInfo è¡¨ç¤ºã‚’æ›´æ–°
        document.getElementById('userInfo').textContent = `ğŸ‘¤ ${userName}`;

        // å…¥åŠ›UIã‚’éè¡¨ç¤º
        container.style.display = 'none';

        console.log('[PWA] ãƒ¦ãƒ¼ã‚¶ãƒ¼åä¿å­˜:', userName);
      });
    }

    // Firestoreãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒ‹ãƒ³ã‚°
    function startListening() {
      const q = query(
        collection(db, 'messages'),
        orderBy('timestamp', 'desc'),
        limit(50)
      );

      onSnapshot(q, (snapshot) => {
        console.log('[Firestore] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°:', snapshot.size + 'ä»¶');

        const container = document.getElementById('messagesContainer');
        container.innerHTML = '';

        // æ–°ã—ã„é †ã§å–å¾—ã—ãŸã®ã§ã€é€†é †ã§è¡¨ç¤º
        const messages = [];
        snapshot.forEach((doc) => {
          messages.unshift({ id: doc.id, ...doc.data() });
        });

        messages.forEach((msg) => {
          appendMessage(msg);
        });

        // æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        container.scrollTop = container.scrollHeight;
      }, (error) => {
        console.error('[Firestore] ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å—ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      });
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’UIã«è¿½åŠ 
    function appendMessage(msg) {
      const container = document.getElementById('messagesContainer');

      const item = document.createElement('div');
      item.className = 'message-item';

      const header = document.createElement('div');
      header.className = 'message-header';

      const sender = document.createElement('span');
      sender.className = 'message-sender';
      sender.textContent = msg.userName || 'åŒ¿å';

      const time = document.createElement('span');
      time.className = 'message-time';
      if (msg.timestamp && msg.timestamp.toDate) {
        time.textContent = msg.timestamp.toDate().toLocaleString('ja-JP');
      } else {
        time.textContent = new Date().toLocaleString('ja-JP');
      }

      header.appendChild(sender);
      header.appendChild(time);

      const text = document.createElement('div');
      text.className = 'message-text';
      text.textContent = msg.text || '';

      item.appendChild(header);
      item.appendChild(text);

      container.appendChild(item);
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    window.sendMessage = async function() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();

      if (!message) {
        return;
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒã‚§ãƒƒã‚¯
      if (!currentUserName) {
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      try {
        console.log('[Firestore] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ä¸­...');

        await addDoc(collection(db, 'messages'), {
          text: message,
          userName: currentUserName,
          channel: 'å…¨ä½“',
          timestamp: serverTimestamp()
        });

        console.log('[Firestore] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å®Œäº†');

        // å…¥åŠ›æ¬„ã‚¯ãƒªã‚¢
        input.value = '';
        input.style.height = 'auto';
        updateCharCounter();

      } catch (error) {
        console.error('[Firestore] é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };

    // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°
    function updateCharCounter() {
      const input = document.getElementById('messageInput');
      const counter = document.getElementById('charCounter');
      const length = input.value.length;

      counter.textContent = `${length} / 1000`;

      if (length > 950) {
        counter.classList.add('error');
        counter.classList.remove('warning');
      } else if (length > 900) {
        counter.classList.add('warning');
        counter.classList.remove('error');
      } else {
        counter.classList.remove('warning', 'error');
      }
    }
  </script>
</body>
</html>
